
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录日常工作、学习的一些文档，收藏看到好的资源等">
      
      
        <meta name="author" content="wgzhao">
      
      
        <link rel="canonical" href="https://wgzhao.github.io/notes/courses/pg9_high_performance_notes/">
      
      
        <link rel="prev" href="../linux-cfs-scheduler/">
      
      
        <link rel="next" href="../mysql-lecture/mysql-practices-lecture-45-1/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.1">
    
    
      
        <title>《PostgreSQL 9 High Performance》读书笔记 - 个人笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="个人笔记" class="md-header__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            个人笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              《PostgreSQL 9 High Performance》读书笔记
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  Tags

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bigdata/ambari-cli/" class="md-tabs__link">
          
  
    
  
  Bigdata

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../commands-in-sbin/" class="md-tabs__link">
          
  
    
  
  Courses

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../database/maridb-ax-setup/" class="md-tabs__link">
          
  
    
  
  Database

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../kubernetes/access-k8s-pod-from-outersider/" class="md-tabs__link">
          
  
    
  
  Kubernetes

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../misc/Latex%20Math%20Symbols/" class="md-tabs__link">
          
  
    
  
  Misc

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../programming/design-restful-api-with-python-and-flask/" class="md-tabs__link">
          
  
    
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tips/bash-tips/" class="md-tabs__link">
          
  
    
  
  Tips

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-tabs__link">
          
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="个人笔记" class="md-nav__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    个人笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bigdata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Bigdata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/ambari-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Ambari API 来操作 Hadoop 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/flink-cdc-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flink SQL CDC 实践以及一致性分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/integrating-hive-with-spark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating Apache Hive with Apache Spark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/integrating-phoenix-with-kerberos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phoenix 集成 HBase 并支持 Kerberos 认证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/ipa-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free IPA setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/kerberos-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MIT Kerberos  安装及维护手册
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/mafengwo-warehouse-design-and-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    马蜂窝数据仓库设计与实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/presto-with-ssl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Presto SSL 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/zookeeper-optimize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zookeeper集群应对万级并发的调优
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Courses
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Courses
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands-in-sbin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 命令学习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux-cfs-scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux CFS 调度器：原理、设计与内核实现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    《PostgreSQL 9 High Performance》读书笔记
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    《PostgreSQL 9 High Performance》读书笔记
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      数据库版本
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      硬件选型
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      硬件性能测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="硬件性能测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      内存性能测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu" class="md-nav__link">
    <span class="md-ellipsis">
      CPU 性能测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu_1" class="md-nav__link">
    <span class="md-ellipsis">
      内存和 CPU 慢的根源
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘性能
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘设置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="磁盘设置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      文件系统
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux_1" class="md-nav__link">
    <span class="md-ellipsis">
      通用 Linux 文件系统调优方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      文件系统方面的调优总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      针对 PostgreSQL 的磁盘布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘布局指南
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      用于数据库缓存的内存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="用于数据库缓存的内存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgresqlconf" class="md-nav__link">
    <span class="md-ellipsis">
      postgresql.conf 里的内存单元
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unix" class="md-nav__link">
    <span class="md-ellipsis">
      为大缓存增加 UNIX 共享内存参数值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      内核信号量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      评估共享内存分配
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      检验数据库缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pg_buffercache" class="md-nav__link">
    <span class="md-ellipsis">
      安装 pg_buffercache 模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      数据库缓存 vs 操作系统缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      重复的缓存数据
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared_buffers" class="md-nav__link">
    <span class="md-ellipsis">
      shared_buffers 的起点设置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      缓存查询检测
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      服务器配置调优
    </span>
  </a>
  
    <nav class="md-nav" aria-label="服务器配置调优">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      修改参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      服务端设置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      专用数据库服务器参数设置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      例行维护
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      数据库性能测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据库性能测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgbench" class="md-nav__link">
    <span class="md-ellipsis">
      pgbench 缺省测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      规模检测
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      查询脚本定义
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      数据库索引
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      查询优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="查询优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      填充样例数据
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      数据库活动和统计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据库活动和统计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      统计视图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      累积视图和实时视图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      表统计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      表 I/O
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      索引统计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_2" class="md-nav__link">
    <span class="md-ellipsis">
      索引 I/O
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      数据库统计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      连接和活动
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint" class="md-nav__link">
    <span class="md-ellipsis">
      缓存,后台写以及 checkpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pg_stat_bgwriter" class="md-nav__link">
    <span class="md-ellipsis">
      保存 pg_stat_bgwriter 快照
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      使用后台写统计调优
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      监控和趋势分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="监控和趋势分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unix_1" class="md-nav__link">
    <span class="md-ellipsis">
      unix 监控工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      超负荷的系统例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    <span class="md-ellipsis">
      windows 监控工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      趋势分析软件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      连接池和缓存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="连接池和缓存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      连接池
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      复制扩展
    </span>
  </a>
  
    <nav class="md-nav" aria-label="复制扩展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      热备
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      数据分区
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据分区">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      范围分区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      现场迁移到分区表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      分区查询
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      常见的分区误区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plproxy" class="md-nav__link">
    <span class="md-ellipsis">
      用 PL/Proxy 做水平分区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      散列生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      分片
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      避免常见问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="避免常见问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    <span class="md-ellipsis">
      灌数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    <span class="md-ellipsis">
      常见性能问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    <span class="md-ellipsis">
      数据库性能分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    <span class="md-ellipsis">
      与版本有关的性能特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mysql lecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Mysql lecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-lecture/mysql-practices-lecture-45-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第一部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-lecture/mysql-practices-lecture-45-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第二部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-lecture/mysql-practices-lecture-45-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第三部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-lecture/mysql-practices-lecture-45-4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第四部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-lecture/mysql-practices-lecture-45-5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第五部分
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Time series analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Time series analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time-series-analysis/01-basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time-series-analysis/02-primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    初级篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time-series-analysis/03-advance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进阶篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time-series-analysis/04-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time-series-analysis/05-complete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    补完篇
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/maridb-ax-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MariaDB AX 安装测试简记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql-cluster-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MySQL Cluster 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/oracle-11g-imp-and-exp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 11g 导入导出基本操作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/oracle-silent-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 静默安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/percona-cluster-with-haproxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HAProxy + Percona XtraDB Cluster 部署
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/setup-a-clickhouse-cluster-on-one-node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在一个节点上部署 ClickHouse 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/why-mysql8-slower-than-mysql57/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    默认配置下，为什么 MySQL 8.0 比 MySQL 5.7 慢
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/access-k8s-pod-from-outersider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    外部机器如何直接直接访问 kubernetes 集群内服务
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/calico-node-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calico Node 无法启动的排查
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/collect-k8s-log-with-filebeat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基于 ELK 的 日志收集与自动索引创建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/coredns-support-hosts-file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CoreDNS 支持解析宿主机的 hosts 文件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/deep-dive-into-k8s-internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用奇怪的方式构建简单 k8s 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/how-to-create-user-for-k8s-dashboard/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在 Kubernetes Dashboard 创建基于 RBAC 的授权用户
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/kubernetes-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 kubeadm 安装 kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/take-flannel-to-calico/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate kubernetes cluster from Flannel to Calico
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/Latex%20Math%20Symbols/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用于 LateX 的数学符号
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/git-from-zero-to-hero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git从入门到应付日常工作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/gitlab-ci-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gitlab-ci.yml 详解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/osint-introduce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    超级情报手机工具库：开源验证和调查工具及使用方法
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/design-restful-api-with-python-and-flask/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Python 和 Flask 设计 RESTful API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/programming-with-vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无插件Vim编程技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/pure-bash-bible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pure Bash Bible
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/understanding-awk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding AWK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tips
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Tips
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/bash-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BASH 的一些技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/batch-convert-word-to-pdf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 下批量转换 word 文档为 pdf 的方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/change-keyboard-layout-in-ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ubuntu 下修改键盘映射
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/git-internals-objects-branches-create-repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git 内部原理图解 -- 对象、分支以及如何从零开始建仓库
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/git-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git 不常见的操作技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/how-to-create-dummy-rpm-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速创建一个虚假 RPM 包
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-change-git-author/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to change git author name and email
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-delete-old-images-from-nexus-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何删除 nexus 私服上的 Docker 镜像
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-save-tmux-session/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to save tmux session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/learn-seaborn-with-10min/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十分钟掌握 Seaborn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/matplotlib-support-chinese/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Python 中 matplotlib 图支持中文
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/move-running-process-into-tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    把一个运行的进程放到 tmux 会话中
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/rpm-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rpm 包管理基本技能
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/sed-one-line-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SED 单行脚本快速参考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/setup-gitlab-ci-for-android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Gitlab CI For Android
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/ssh-three-key-features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ssh的三板斧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/ssh-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH examples, tips and tunnels
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/wechat-contacts-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    微信通讯录备份
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCPDump Capture HTTP GET/POST requests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/deep-in-tcp-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    详解 TCP 半连接队列与全连接队列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/docker-run-no-space-left/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker 运行容器报磁盘空间不足的错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/fix-ora-00227/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    修复 Oracle ORA-00227 错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/jdk1.6-support-tlsv1.2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Oracle JDK 1.6 TLSv1.2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags" >
    
      
      
      
        <a href="../../tags/#tag:performance" class="md-tag">performance</a>
      
    
      
      
      
        <a href="../../tags/#tag:postgresql" class="md-tag">postgresql</a>
      
    
  </nav>



  <h1>《PostgreSQL 9 High Performance》读书笔记</h1>

<p>这是很早前阅读 <a href="https://www.packtpub.com/product/postgresql-90-high-performance/9781849510301">《PostgreSQL 9 High Performance》</a> 做的一些笔记</p>
<p>分章节记录</p>
<h2 id="_1">数据库版本<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>这章主要介绍了 PostgreSQL 的历史，感兴趣的，可以看看，和技术关系不大</p>
<h2 id="_2">硬件选型<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>不用 SSD 硬盘的三个主要原因</p>
<ol>
<li>当前硬盘容量不大，而数据库一向都占用磁盘较多</li>
<li>存储这块的费用会相当高</li>
<li>大部分 SSD 设计时并没有很好的考虑写缓存(write-cache)</li>
</ol>
</li>
<li>
<p>write-back cache 方式并不是适合用于存储数据的文件系统</p>
</li>
<li>
<p>磁盘阵列一般都用 wirte-back cache，因为它配置了电池，一般称为
    battery-backed write cache(BBC or BBWC)</p>
</li>
<li>
<p>几条预防 write-back cache 出故障的基本法则</p>
<ol>
<li>
<p>确保你使用的文件系统完整实现了 fsync 调用或者类似机制的功能</p>
</li>
<li>
<p>监控磁盘控制器电池。有些控制卡自身会监控其状态，如果发现掉电或者工作不正常时，会从 write-back
    改成 write-through 模式，当然，其性能会下降</p>
</li>
<li>
<p>禁止任何磁盘的 write-cache 模式。大部分 RAID 卡会来做这点，他们会优先使用
    BBC 模式</p>
</li>
</ol>
</li>
<li>
<p>磁盘转速以及每秒提交的写速关系\</p>
<p>转速(RPM) 转时(ms) 最大提交数(/s)</p>
<hr />
<div class="highlight"><pre><span></span><code> 5400        11.1           90
 7200        8.3           120
 10000       6.0           166
 15000       4.0           250
</code></pre></div>
<p>上述图表关系意味着一个普通的 7200 转的硬盘，单个客户端提交的事务不可能超过 120/sec.</p>
</li>
</ol>
<h2 id="_3">硬件性能测试<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">内存性能测试<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>memtest86+</strong> 大部分 Linux 发型版本都自带了 memtest86+内存测试工具，如果没有，也可以从<a href="http://www.memtest.org">http://www.memtest.org</a>下载，然后创建一个包含 memtest86+引导 CD 进行测试</p>
</li>
<li>
<p><strong>STREAM 内存测试</strong> STEAM 是一个内存带宽测试程序，可以从<a href="http://www.cs.virginia.edu/stream">http://www.cs.virginia.edu/stream</a>下载，网站上也有很多测试报告事例.\</p>
</li>
</ul>
<h3 id="cpu">CPU 性能测试<a class="headerlink" href="#cpu" title="Permanent link">&para;</a></h3>
<p>直接使用数据库来做一些查询操作就是测试 CPU 性能的最好工具，在 psql 里开启\timing 功能，利用*generate_series*函数来创建巨量的数列，便能看出 CPU 的性能。比如类似下面的一些指令：</p>
<div class="highlight"><pre><span></span><code><span class="n">postgres</span><span class="o">=#</span><span class="err">\</span><span class="n">timing</span>
<span class="n">postgres</span><span class="o">=#</span><span class="k">SELECT</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">generate_series</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">);</span>
<span class="n">postgres</span><span class="o">=#</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">generate</span><span class="w"> </span><span class="n">series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100000</span><span class="p">));</span>
<span class="n">postgres</span><span class="o">=#</span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">test</span><span class="p">;</span>
</code></pre></div>
<h3 id="cpu_1">内存和 CPU 慢的根源<a class="headerlink" href="#cpu_1" title="Permanent link">&para;</a></h3>
<p>大部分内存设置为双通道模式，一对内存应该插入到特定的插槽内，如果安装不正确，内存将会运行在单通道模式。memtest86+程序有次提示，另外 BIOS 里也能侦测到这种情况\
劣质的内存颗粒会严重拖累系统性能，因为主板并不能充分利用内存所宣称的高速。大部分系统的缺省配置都是保守的，它一般会从内存提供的 SPD（Serial
Presence
Detect）信息中查询它应该运行的速度，但这往往不是其最高性能，因此需要人工调整内存时钟。\
高性能的内存使用了称为"Extreme Memory
Profile(XMP)\"协议，它可以在系统启动时向 BIOS 传递它可以运行的最高速率。但是 BIOS 缺省情况下并不进检查和使用 XMP，这就使得你的内存看上去没有并没有那么快。\
另外一个原因就是内存和处理器的时钟频率不能很好的合作，一方面需要注意主板和 BIOS 的设置，以保证 CPU 和内存的时钟频率能发挥最大功效。另外一个方面就是当前大部分操作系统为了节省，都有 CPU 调速的功能，在空闲时，会将 CPU 的主频调的很低，比如一个 2.4GHz 的 CPU，在空闲时调整为 1GHz 是很常见的事情，如果时 Linux 系统，可以查看/proc/cpuinfo 来获取当前 CPU 的运行频率。在测试性能时，应该关闭 CPU 调速的功能。</p>
<h3 id="_5">磁盘性能<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="iops">随机访问及 IOPS<a class="headerlink" href="#iops" title="Permanent link">&para;</a></h4>
<p>IOPS(Input/Outpu Per Second)
是衡量一个磁盘性能的重要参数，它综合衡量了磁盘随机读寻道时间，平均延迟时间等影响性能的因素。</p>
<p>根据磁盘常见对磁盘给出的参数，我们可以大致算出一个磁盘的 IOPS。比如 seagate 出品的 Momentus
7200.4 桌面型磁盘规格参数如下：</p>
<p>转速：7200 RPM</p>
<p>平均延迟：4.17ms</p>
<p>随机读寻道时间：11.0ms</p>
<p>实际上通过转速，我们就能大致计算出来平均延迟，比如 7200 转的磁盘，就意味着，转一圈需要<span class="arithmatex">\(1*60/7200 = 8.33ms\)</span>。
最差的情况就是你每次等待都需要磁盘转一圈，但这种几率不大，大部分等待都不想要等待一圈，因此我们取算术平均，每次等待传半圈的时间，也就是<span class="arithmatex">\(8.33/2 = 4.17ms\)</span>。
由此看出，所有 7200
RPM 的磁盘，其平均延迟都应该是一样的，但是随机读取寻道时间则依赖于磁盘的大小、质量以及其他因素了。</p>
<p>平均延迟时间 <span class="arithmatex">\(RL = 1/ RPM / 60 / 2 = 4.17 ms\)</span></p>
<p>寻道时间 <span class="arithmatex">\(S = 11.0 ms\)</span></p>
<p><span class="arithmatex">\(IOPS =  1 / (RL + S)  = 1 / (4.17ms + 11ms) = 65.9 IOPS\)</span>\</p>
<h4 id="zcav">顺序访问及 ZCAV<a class="headerlink" href="#zcav" title="Permanent link">&para;</a></h4>
<p>CAV(Constant Anular
Velocity)，就恒定角速度。指的是磁盘在任意时刻，转速是一致的，但是因为磁盘的盘面是一个圆形，这就意味着在相同时间内，越靠近磁盘外层，扫过的面积的也就越大。这也就是我们常说的，磁盘外道的读取速度要快于磁盘内道。</p>
<p>有关 CAV，以及相关工具的讨论，可以参考下面的链接：
<a href="http://www.coker.com.au/bonnie++/zcav/">http://www.coker.com.au/bonnie++/zcav/</a></p>
<h4 id="short-stroking">短冲程(short stroking)<a class="headerlink" href="#short-stroking" title="Permanent link">&para;</a></h4>
<p>我们知道磁盘的外道读写速度要快，因此有专门的技术来保证你的数据只存放在外道上，这就是成为 Short
stroking 的技术。</p>
<h4 id="_6">磁盘性能测试工具<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>Windows 下使用<a href="http://www.hdtune.com">hdtune</a>免费版即可\
Unix 下，系统再带的 dd 指令就可以作为磁盘性能测试的基本工具。一般 dd 测试读写的文件大小至少是物理内存的两倍，以保证系统不会把实际需要写入磁盘的数据缓存到内存上。考虑到 postgresql 默认的块大小是 8KB，因此 dd 测试需要的块大小为：</p>
<p><span class="arithmatex">\(blocks = 250,000 * (gigabytes of RAM)\)</span></p>
<p>测试方法一般如下：</p>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;dd if=/dev/zero of=bigfile bs=8k count=blocks &amp;&amp; sync&quot;</span>
<span class="nb">time</span><span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>bigfile<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/null<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>8k
</code></pre></div>
<p>Unix 下也可以使用开源的 bonnie++工具\
1）Bonnie++</p>
<p>当前最新的版本是 1.96，也就是所谓的 2.0 版本</p>
<div class="highlight"><pre><span></span><code>bonnie++<span class="w"> </span>-f<span class="w"> </span>-n<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span><span class="sb">`</span>hostname<span class="sb">`</span>.bonnie
cat<span class="w"> </span><span class="sb">`</span>hostname<span class="sb">`</span>.bonnie<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bon_csv2html<span class="w"> </span>&gt;<span class="sb">`</span>hostname<span class="sb">`</span>.htm
</code></pre></div>
<p>-n 0 表示跳过文件创建测试</p>
<p>-f 表示快速模式，跳过每字符的 I/0 测试</p>
<p>2）bonnie++ zcav</p>
<p>zcav 是 Bonnie 项目中独立出来的程序，用于跟踪整个磁盘的传输率，可以利用 gnuplot 来绘制出漂亮的图形，示例如下：</p>
<div class="highlight"><pre><span></span><code>zcav<span class="w"> </span>-lsda.zcav<span class="w"> </span>-f<span class="w"> </span>/dev/sda
zcav<span class="w"> </span>-lsdb.zcav<span class="w"> </span>-f<span class="w"> </span>/dev/sdb
</code></pre></div>
<p>上述指令需要 root 权限，将会产生两个日志文件 sda.zcav 和 sdb.zcav</p>
<p>而后，我们通过下面的指令生成图形</p>
<div class="highlight"><pre><span></span><code><span class="k">unset</span><span class="w"> </span><span class="nb">autoscale</span><span class="w"> </span><span class="err">x</span>
<span class="k">set</span><span class="w"> </span><span class="nb">autoscale</span><span class="w"> </span><span class="n">xmax</span>
<span class="k">unset</span><span class="w"> </span><span class="nb">autoscale</span><span class="w"> </span><span class="err">y</span>
<span class="k">set</span><span class="w"> </span><span class="nb">autoscale</span><span class="w"> </span><span class="n">ymax</span>
<span class="k">set</span><span class="w"> </span><span class="nb">xlabel</span><span class="w"> </span><span class="s">&quot;Position MB&quot;</span>
<span class="k">set</span><span class="w"> </span><span class="nb">ylabel</span><span class="w"> </span><span class="s">&quot;KB/s&quot;</span>
<span class="k">set</span><span class="w"> </span><span class="nb">key</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">bottom</span>
<span class="k">plot</span><span class="w"> </span><span class="s">&quot;sda.zcav&quot;</span><span class="w"> </span><span class="nb">title</span><span class="w"> </span><span class="s">&quot;Dell E6410 laptop&quot;</span><span class="o">,</span><span class="w"> </span><span class="s">&quot;sub&quot;</span><span class="w"> </span><span class="nb">title</span><span class="w"> </span><span class="s">&quot;Huawei SSD&quot;</span>
<span class="k">set</span><span class="w"> </span><span class="nb">terminal</span><span class="w"> </span><span class="n">png</span>
<span class="k">set</span><span class="w"> </span><span class="nb">output</span><span class="w"> </span><span class="s">&quot;disks.png&quot;</span>
<span class="k">replot</span>
</code></pre></div>
<p>sysbench 是一个开源的数据库测试工具，它不仅可以测试数据库本身的性能，也能通过数据库来做硬件测试，下面给出一些测试例子：\</p>
<p><code>sysbench --test=cpu run</code>\</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="nv">THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nv">GBSIZE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">MODE</span><span class="o">=</span>rndrd
sysbench<span class="w"> </span>--test<span class="o">=</span>fileio<span class="w"> </span>--num-threads<span class="o">=</span><span class="nv">$THREADS</span><span class="w"> </span>--file-num<span class="o">=</span><span class="nv">$GBSIZE</span><span class="w"> </span><span class="se">\</span>
--file-total-size<span class="o">=</span><span class="si">${</span><span class="nv">GBSIZE</span><span class="si">}</span>G<span class="w"> </span>--file-block-size<span class="o">=</span>8K<span class="w"> </span>--file-test-mode<span class="o">=</span><span class="si">${</span><span class="nv">MODE</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
--file-fsync-freq<span class="o">=</span><span class="m">0</span><span class="w"> </span>--file-fsync-end<span class="o">=</span>no<span class="w"> </span>prepare

sysbench<span class="w"> </span>--test<span class="o">=</span>fileio<span class="w"> </span>--num-threads<span class="o">=</span><span class="nv">$THREADS</span><span class="w"> </span>--file-num<span class="o">=</span><span class="nv">$GBSIZE</span><span class="w"> </span><span class="se">\</span>
--file-total-size<span class="o">=</span><span class="si">${</span><span class="nv">GBSIZE</span><span class="si">}</span>G<span class="w"> </span>--file-block-size<span class="o">=</span>8K<span class="w"> </span>--file-test-mode<span class="o">=</span><span class="si">${</span><span class="nv">MODE</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
--file-fsync-freq<span class="o">=</span><span class="m">0</span><span class="w"> </span>--file-fsync-end<span class="o">=</span>no<span class="w"> </span>run<span class="w"> </span>--max-time<span class="o">=</span><span class="m">60</span>

sysbench<span class="w"> </span>--test<span class="o">=</span>fileio<span class="w"> </span>--num-threads<span class="o">=</span><span class="nv">$THREADS</span><span class="w"> </span>--file-num<span class="o">=</span><span class="nv">$GBSIZE</span><span class="w"> </span><span class="se">\</span>
--file-total-size<span class="o">=</span><span class="si">${</span><span class="nv">GBSIZE</span><span class="si">}</span>G<span class="w"> </span>--file-block-size<span class="o">=</span>8K<span class="w"> </span>--file-test-mode<span class="o">=</span><span class="si">${</span><span class="nv">MODE</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
--file-fsync-freq<span class="o">=</span><span class="m">0</span><span class="w"> </span>--file-fsync-end<span class="o">=</span>no<span class="w"> </span>cleanup
</code></pre></div>
<p>测试分为 3 个步骤，首先创建测试文件，然后测试运行，最后清理测试文件。
测试中，我们可以调整测试文件的大小，测试运行的线程数以及采取何种读写模式。\</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="nv">DRIVE</span><span class="o">=</span><span class="s2">&quot;/dev/sda&quot;</span>
<span class="c1">## Disable write cache</span>
hdparm<span class="w"> </span>-W<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">$DRIVE</span>
<span class="nb">echo</span><span class="w"> </span>fsync<span class="w"> </span>with<span class="w"> </span>write<span class="w"> </span>cache<span class="w"> </span>disabled,<span class="w"> </span>look<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;Requests/sec&quot;</span>
sysbench<span class="w"> </span>--test<span class="o">=</span>fileio<span class="w"> </span>--file-fsync-freq<span class="o">=</span><span class="m">1</span><span class="w"> </span>--file-num<span class="o">=</span><span class="m">1</span><span class="w"> </span>--file-total-size<span class="o">=</span><span class="m">16384</span>
--file-test-mode<span class="o">=</span>rndwr<span class="w"> </span>run
<span class="c1">## Enable write cache (returning it to the usual default)</span>
hdparm<span class="w"> </span>-W<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">$DRIVE</span>
<span class="nb">echo</span><span class="w"> </span>fsync<span class="w"> </span>with<span class="w"> </span>write<span class="w"> </span>cache<span class="w"> </span>enabled,<span class="w"> </span>look<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;Requests/sec&quot;</span>
sysbench<span class="w"> </span>--test<span class="o">=</span>fileio<span class="w"> </span>--file-fsync-freq<span class="o">=</span><span class="m">1</span><span class="w"> </span>--file-num<span class="o">=</span><span class="m">1</span><span class="w"> </span>--file-total-size<span class="o">=</span><span class="m">16384</span>
--file-test-mode<span class="o">=</span>rndwr<span class="w"> </span>run
</code></pre></div>
<h4 id="_7">其他复杂的磁盘性能测试工具<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><a href="http://www.iozone.org">iozone</a> 可以测试各种磁盘使用场景</p>
</li>
<li>
<p><a href="http://freshmeat.net/projects/fio/">fio</a>
    通过脚本来构建和测试各种你想测试的场景，可以看这个例子：
    <a href="http://wiki.postgresql.org/wiki/HP_ProLiant_DL380_G5_Tuning_Guide">http://wiki.postgresql.org/wiki/HP_ProLiant_DL380_G5_Tuning_Guide</a></p>
</li>
<li>
<p><a href="http://pgfoundry.org/projects/pgiosim/">pgiosim</a></p>
</li>
</ol>
<h2 id="_8">磁盘设置<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="_9">文件系统<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<h4 id="ext2">ext2<a class="headerlink" href="#ext2" title="Permanent link">&para;</a></h4>
<p>Linux 上原生的最古老的文件系统，没有日志，因此大部分场景下都不适合用该文件系统。</p>
<p>不过因为没有日志，所得它的读写速度很快，有时，我们可以把 ext2 文件系统用在 PostgreSQL
WAL 上。</p>
<p>但是要注意系统重启后，自动执行 fsck 所带来的风险。因此只有明确 WAL 成为瓶颈时，可以考上使用更快但是有一定风险的 ext2 文件系统。</p>
<h4 id="ext3">ext3<a class="headerlink" href="#ext3" title="Permanent link">&para;</a></h4>
<p>ext3 在 ext2 的基础上增加了日志功能，它向后兼容 ext2。而且 ext2 和 ext3 两种文件系统之间可以互转。</p>
<p>目前，在 ext3 上，有三种写日志的方法，它可以通过挂载时传递 data 参数来指定使用哪种方式：</p>
<ul>
<li>
<p><strong>data=writeback</strong>
  数据改变不会记录在日志。元数据改变记录在日志，不保证数据块写入的相关顺序。当崩溃后，文件可以恢复，不过文件结尾可能有些无用的数据，另外，文件的内容可能是新旧数据混合.</p>
</li>
<li>
<p><strong>data=ordered</strong>
  元数据记录在日志，数据改变不进日志。只有当相关联的数据写入磁盘，才写元数据，也是\"ordered\"的由来。</p>
</li>
<li>
<p><strong>data=journal</strong> 数据和元数据的改变都写入日志</p>
</li>
</ul>
<p>相比 WAL 存储在 ext2 上获得性能的优势，ext3 +
data=writeback 是一个不错的替换选择，一来性能不会太差，而来有日志的保证，崩溃后恢复时间大大缩短。只是要考虑文件膨胀的问题。</p>
<h4 id="ext4">ext4<a class="headerlink" href="#ext4" title="Permanent link">&para;</a></h4>
<p>ext4 真正开始能在产品中使用是从 kernel2.6.28 开始，不过因为一些调用 fsync 处理的 bug，对于 PostgreSQL 而言，kernel
&gt; 2.6.32 的可以考虑使用 ext4。也就是 RedHat 6 和 Ubuntu 10.04 可以开始用了。</p>
<p>尽管理论上，ext4 不存在之前 ext3 文件系统 16TB 的大小限制，但是 mkfs 工具目前依然还是有这个限制。</p>
<p>从 PostgreSQL 的角度来看，ext4 相比 ext3 的主要提升在于能够更好的处理 write
barriers 和 fsync 操作。</p>
<h4 id="xfs">XFS<a class="headerlink" href="#xfs" title="Permanent link">&para;</a></h4>
<p>XFS 是 SGI 设计的一款高效率日志文件系统，它比 ext3 速度稍快，从原理上来讲，它更像是 ext3+data=writeback 运行模式。因此如果想使用 XFS,要记得设置 PostgreSQL 的*full_page_writes*参数</p>
<p>下面是一个 XFS 和 ext3 的速度比较表，可以大致看出 XFS 的优势</p>
<div class="highlight"><pre><span></span><code>  Filesystem       Sequential write(MB/s)   Sequential read(MB/s)
</code></pre></div>
<hr />
<p>ext3 data=ordered 39-58 44-72
ext3 data=journal 25-30 49067
XFS 68-72 72-77</p>
<p>RHEL5 初步开始支持 XFS，RHEL6 已经完全支持 XFS。因此在特别大的磁盘空间上，比如希望文件系统超过 16TB 的情况下，推荐使用 XFS，而且文件系统越大，XFS 相比 ext3/ext4 越有优势。</p>
<p>缺省情况下，XFS 使用 write barriers，XFS 也偏执的认为易失缓存(volatile
write
cache)的磁盘会丢失数据。为了防止这点，XFS 总是积极的给磁盘发送刷盘(flush)指令。因此，如果你有非易失缓存设备，比如带后备电池的写控制器，那么缓存刷盘就是浪费。在这种情况下，挂载 XFS 推荐使用 nobarriers 选项来确保禁止缓存刷盘。</p>
<h4 id="linux">其他 Linux 文件系统<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h4>
<dl>
<dt>JFS</dt>
<dd>
<p>和 XFS 类似，只是 CPU 使用更少，目前还没有得到主流发型版本的完整支持。</p>
</dd>
<dt>ReiserFS</dt>
<dd>
<p>作为第一个进入 Linux
kernel 的日志文件系统，而且 SuSE 还把它作为缺省的文件系统，但是随着作者的被捕，其前景堪忧。</p>
</dd>
<dt>Btrfs</dt>
<dd>
<p>Oracle 捐赠的文件系统，被认为是未来 Linux 的主要文件系统，目前还没有到稳定版，基于它的一些独一特性，比如快照，校验和。它将来很有可能是极具竞争力的文件系统。</p>
</dd>
</dl>
<h4 id="solaris-ufs">Solaris UFS<a class="headerlink" href="#solaris-ufs" title="Permanent link">&para;</a></h4>
<p>Solaris
UFS 用于 PostgreSQL 并不太好。一个主要的问题是它仅能缓存小文件，而数据库期望的是能缓存大文件。另外，能用于缓存的内存大小很小，对于 SPARC 系统而言，只能用到内存的 12%。而 Intel/AMD
x64 只只有可怜的 64MB。对于最后这个问题，我们可以调整参数来修复，一个是掉正类似预读取的大小，一个是类似读写到交换空间的大小</p>
<div class="highlight"><pre><span></span><code>set maxphys=1048576
set klustsize=1048576
</code></pre></div>
<p>在 SPARC Solaris 系统上，还可以调整下面的两个参数：</p>
<div class="highlight"><pre><span></span><code>set freebebind=0
set segmap_percent=60
</code></pre></div>
<p>对于 Intel/AMD x64 Solaris 系统，则设置下面的两个参数：</p>
<div class="highlight"><pre><span></span><code>set ufs:freebehind=0
set segmapsize=1073741824
</code></pre></div>
<h4 id="freebsd-ufs2">FreeBSD UFS2<a class="headerlink" href="#freebsd-ufs2" title="Permanent link">&para;</a></h4>
<p>和 Linux 类似，通过修改 read-ahead 能显著提升顺序读的速度。参数的单位是文件系统块大小，默认是 8KB。
这个参数我们可以设置在 32 到 256 之间，通过修改/etc/sysctl.conf 文件，增加类似下面的这行：\
vfs.read_max = 32\
然后通过下面的指令，使其生效：\
/etc/rc.d/sysctl start</p>
<h4 id="zfs">ZFS<a class="headerlink" href="#zfs" title="Permanent link">&para;</a></h4>
<p>很少有文件系统能像 ZFS 一样拥有众多的拥护者，当然它的很多先进特性，特别是自带的卷管理和实时快照功能我们在很多地方都能看到其介绍。
ZFS 默认情况下使用 128KB 大小的记录块，对 PostgreSQL 而言，这个数有点大，反而使得效率不高，我们可以通过下面的设置来使得文件系统的块大小和 PostgreSQL 的块大小一致：\
<code>zfs set recordsize=8K zp1/data</code>\
这个大小对 WAL 并不是优化值，相反，其缺省的 128KB 应该更好。ZFS 尽可能消耗掉所有的内存用于它的自适应可替换缓存(Adaptive
Replacement Cache aka
ARC)，对于 PostgreSQL 而言，需要降低该值，不同的 Soloris 发型版本，其调整 ARC 的方式有所不同，具体的可以参考<a href="http://www.solarisinternals.com/wiki/index.php/ZFS_Evil_Tuning_Guide">http://www.solarisinternals.com/wiki/index.php/ZFS_Evil_Tuning_Guide</a>文章里的\"Limiting
the ARC Cache\"章节。</p>
<p>对于 FreeBSD 系统而言，可以参考<a href="http://wiki.freebsd.org/ZFSTuningGuide">http://wiki.freebsd.org/ZFSTuningGuide</a>，这片文档里提到了一个*arc_summary.pl*的有用脚本，它可以在 FreeBSD 和 Solari 上运行。</p>
<p>ZFS 使用一种称为\"intent
log\"的结构来处理日志，在具有多个磁盘的高性能系统上，针对数据库磁盘，一般对分配出专门用来存储\"intent
log\"的存储池。而对于用于存储 WAL 的磁盘，就不需要专门的存储池来存储\"intent
log"。有关更具体的如何为数据库优化 ZFS 的指南，可以参考下面这个链接：\
<a href="http://www.solarisinternals.com/wiki/index.php/ZFS_for_Databases">http://www.solarisinternals.com/wiki/index.php/ZFS_for_Databases</a></p>
<p>和 XFS 相似，如果你的系统有非易失写缓存，ZFS 提供的缓存刷盘会影响性能，我们可以通过设置 zfs_nocacheflush 参数来禁止它。在/etc/system 里增加下面的这行：\
<code>set zfs:zfs_nocacheflush=1</code>\
因为 ZFS 的\"intent
log\"的健壮性以及块校验和的特性，当它用于 PostgreSQL 时，可以禁止 full_page_writes 参数来获得性能提升，且少有风险。</p>
<h4 id="fat32">FAT32<a class="headerlink" href="#fat32" title="Permanent link">&para;</a></h4>
<p>目前已经不推荐在数据库上使用 FAT32 文件系统上了，无日志、非正常关机需要执行 chkdsk 恢复。基于这些原因，PostgreSQL 安装程序不支持把数据库集群直接安装到 FAT32 系统上。当然，你手工执行 initdb 还是可行的。</p>
<h4 id="ntfs">NTFS<a class="headerlink" href="#ntfs" title="Permanent link">&para;</a></h4>
<p>NTFS 是微软的旗舰文件系统，它使用非有序元数据日志记录。有点类似 Linux 下的 writeback 日志模式。大部分情况下，它值得信赖，但在一些罕见的情况下，有可能必须对文件系统执行 chkdsk 指令才能挂载上来。就像较早的 PostgreSQL 安装程序所描述的那样，当使用 NTFS 是，偏向于使用下面的数据库配置参数：</p>
<p><code>open_datasync=fsync_writethrough</code>\
NTFS 使用称为"filesystem
junction\"的功能来允许在其上创建功能等价的符号链接，Junction 工具可以从<a href="http://technet.microsoft.com/en-us/sysinternals/bb896768">http://technet.microsoft.com/en-us/sysinternals/bb896768</a>下载。这就使得我们可以在 NTFS 卷上保留目录结构不变的情况下把 pg_xlog 存放到另外一个文件系统上。这个功能也可以使用在表空间上。</p>
<p>和类似 UNIX 的 noatime 参数相似，我们也可以在 NTFS 卷上关闭对应的功能。\
<code>fsutil behavior set disablelastaccess 1</code>\
因为历史原因，NTFS 最自动生成符合 8.3 格式的文件名，以便向后兼容，我们可以通过下面的参数禁止这个功能：\
<code>fsutil behavior set disable8dot3 1</code>\
要注意的是，如果你设置了 disable8to3 参数，可能有有些意外的情况发生，比如如果你的%TEMP%或%TMP%环境变量使用了短名来访问文件或目录，关闭这个参数后，会导致目录找不到，因此你需要更新所有使用短名的环境变量。</p>
<h4 id="write-barriers">Write barriers<a class="headerlink" href="#write-barriers" title="Permanent link">&para;</a></h4>
<p>绝大部分磁盘都有易失缓存，因此 PostgreSQL 的 WAL 写模式与此并不兼容，这里最重要的一个要求就是当一个文件同步操作发生时（fsync)，文件系统必须确保所有相关数据都写入非易失缓存或磁盘本身。
文件系统元数据写操作也有同样的要求，对数据更新的写操作要求日志更新首先按照正确的顺序写入安全区域。</p>
<p>Linux Kernel 为了支持这些场景，开发称之为写屏障(write
barrios)的功能。内核文档是如此描述 write barries 的：</p>
<blockquote>
<p>All requests queued before a barrier request must be finished (made it
to the physical medium) before the barrier request is started, and all
requests queued after the barrier request must be started only after
the barrier request is finished (again, made it to the physical
medium).</p>
</blockquote>
<p>意思是当一个 barrier 请求到来时，所有在这个之前的请求队列比如完成（写入物理介质），然后这个 barrier 请求才能响应，而 barries 之后的所有请求队列只有当这个 barries 完成后（写入物理介质）才能开始。</p>
<p>这相当于在一个较长的请求队列里强行插入一个栅栏，只有栅栏前的队列都完成，后面的才能发起。可以想象类似超市排队结账时的场景，当队列过长时，保安会过来干涉，它站在队伍的中间，然后说，"后面的稍微等一下，为了防止拥挤，等前面的都结算完后，你们再过去"。</p>
<h4 id="barriers">磁盘对 barriers 的支持<a class="headerlink" href="#barriers" title="Permanent link">&para;</a></h4>
<p>SCSI/SAS 磁盘允许读写操作指定强制单元访问(Force Unit Access aka
FUA)，它可以不通过缓存直接访问磁盘介质，也就是我们常说的写透(write-through)。同时也支持 SYNCHRONIZE
CACHE 调用来刷盘。</p>
<p>早期的 IDE 磁盘实现了称之为 FLUSH
CACHE 的系统调用，不过磁盘大小限制为 137GB。ATA-6 规范中增加了对大磁盘的支持，并增加了新的 FLUSH
CACHE EXT 系统调用。</p>
<p>支持原生命令队列（Native Command
Queuing)的 SATA 磁盘也能处理 FUA。Linux 从 2.6.19 内核开始对其 NCQ 的支持放在了 libata 驱动力，不过有一些发型版本（比如 RedHat）为了向后兼容，还是把对 NCQ 的支持驱动放在内核里。</p>
<h4 id="barriers_1">文件系统对 barriers 的支持<a class="headerlink" href="#barriers_1" title="Permanent link">&para;</a></h4>
<p>ext3 文件系统如果只使用简单卷，理论上是支持 barriers 的。如果使用软 RAID 或者 LVM，则 barriers 根本无效。</p>
<p>XFS 能够正确处理 write barriers，而且缺省情况下是启动这个功能的。</p>
<p>ext4 同样支持 barriers，缺省情况下，也是启动此功能的。</p>
<h3 id="linux_1">通用 Linux 文件系统调优方案<a class="headerlink" href="#linux_1" title="Permanent link">&para;</a></h3>
<h4 id="read-ahead">Read-ahead<a class="headerlink" href="#read-ahead" title="Permanent link">&para;</a></h4>
<p>将 read-ahead 可调范围一般为 4096 16384，缺省值一般是 256，可以通过下面的指令查看缺省值</p>
<p><code>blockdev--getra /dev/sda</code></p>
<p>设置 read-ahead 的指令如下：</p>
<p><code>blockdev --setra 4096 /dev/sda</code></p>
<h4 id="file-access-times">File access times<a class="headerlink" href="#file-access-times" title="Permanent link">&para;</a></h4>
<p>关闭 atime，在 fstab 里对应的设备挂载选项上加上 noatime，类似下面这样：</p>
<p><code>/dev/sda1     /     ext3     noatime,errors=remount-ro 0 1</code></p>
<h4 id="read-caching-and-swapping">Read caching and swapping<a class="headerlink" href="#read-caching-and-swapping" title="Permanent link">&para;</a></h4>
<p>设置 vm.swappiness=0，表示内核尽可能使用文件系统 cache 而不是 swap</p>
<p>关闭 overcommit 行为，也就是设置 vm.overcommit_memory=2</p>
<h4 id="write-caching-size">write caching size<a class="headerlink" href="#write-caching-size" title="Permanent link">&para;</a></h4>
<p>有两个参数可以调整上述行为</p>
<p><strong>/proc/sys/vm/dirty_background_ratio</strong>: 这
个参数控制文件系统的 pdflush 进程，在何时刷新磁盘。单位是百分比，表示系统内存的百分比，意思是当写缓冲使用到系统内存多少的时候，pdflush 开始向磁盘写出数据。增大之会使用更多系统内存用于磁盘写缓冲，也可以极大提高系统的写性能。但是，当你需要持续、恒定的写入场合时，应该降低其数值，一般启动上缺省是
5。</p>
<p><strong>/proc/sys/vm/dirty_ratio</strong>:
这个参数控制文件系统的文件系统写缓冲区的大小，单位是百分比，表示系统内存的百分比，表示当写缓冲使用到系统内存多少的时候，开始向磁盘写出数据。增大之会使用更多系统内存用于磁盘写缓冲，也可以极大提高系统的写性能。但是，当你需要持续、恒定的写入场合时，应该降低其数值，一般启动上缺省是
10</p>
<p>对于超过 8G 的内存服务器，可以考虑将 dirty_background_ratio
设置为 1，把 dirty_ratio 设置为 2</p>
<h4 id="io">I/O 调度算法<a class="headerlink" href="#io" title="Permanent link">&para;</a></h4>
<dl>
<dt>elevator=cfq</dt>
<dd>
<p>完全公平队列，它试图把 I/O 带宽平分给所有的请求。这是 Linux 默认调度算法</p>
</dd>
<dt>elevator=deadline</dt>
<dd>
<p>目的在于平衡 I/O 和请求时间，确保不会出现因等待时间太长而"饿死"的请求。</p>
</dd>
<dt>elevator=noop</dt>
<dd>
<p>不做任何复杂的调度，它只是简单的处理块请求合并，并依据底层设备顺序对请求排序。</p>
</dd>
<dt>elevator=as</dt>
<dd>
<p>Anticipatory 调度有意延迟 I/O 请求，以期能合并一些请求，而从可以批处理。</p>
</dd>
</dl>
<p>目前四种调度算法，其实对数据库的影响不如上述一些参数，比如如果你想提升读的性能，那么考虑调整 read
ahead 参数，如果想提升写的性能，调整 write chaching size。</p>
<p>下面描述一种调度算法影响系统效率的例子：</p>
<p>对于有大量磁盘读写的系统，比如 RAID 或者 SAN，使用 noop 调度算法可以快速的把请求数据转发给硬件，如果硬件有大 cache 的话，是可以提升性能</p>
<p>对于桌面系统，磁盘 I/O 能力有限，as 调度算法能够更好的排序读写请求到批处理里，不过很显然，不适合典型的数据库服务。</p>
<h3 id="_10">文件系统方面的调优总结<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>当前写日志是大部分文件系统用于崩溃后恢复的一种机制</p>
</li>
<li>
<p>对于 Linux，ext3 文件存在更多的可调优的可能性。XFS 和 ext4 目前还算是在产品早期阶段，但相信将来是 ext3 的一个很好的替代方案</p>
</li>
<li>
<p>Solaris 和 FreeBSD
    都有较老版本的 UFS 文件系统和较新的 ZFS 文件系统。ZFS 的一些特性使得它很适合大型数据库</p>
</li>
<li>
<p>Windows 的 NTFS 借鉴了很多 UNIX 上文件系统的特性</p>
</li>
<li>
<p>增加 read-ahead，停止 atime 的更新，调整用于写缓存的数值都是通用的调优技巧，而且通常都能提高数据库的性能</p>
</li>
<li>
<p>PostgreSQL 可以将数据迁移位置，方法是通过操作系统的符号链接或者创建表空间</p>
</li>
<li>
<p>是否需要将数据库的各组成部分分不到不同的磁盘上，很大程度上取决于应用程序和使用方式</p>
</li>
</ol>
<h3 id="postgresql">针对 PostgreSQL 的磁盘布局<a class="headerlink" href="#postgresql" title="Permanent link">&para;</a></h3>
<p>因为 PostgreSQL 对所有的文件都使用标准文件系统，数据库的有几部分我们可以重新分配路径，有一些通过直接移动相关文件，有些则通过创建符号链接来实现。</p>
<h4 id="_11">符号链接<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>我们可以把 WAL 存放到独立的特别为其优化一个文件系统上，然后通过符号链接来保持其数据库目录结构不变：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$PGDATA</span>
$<span class="w"> </span>mv<span class="w"> </span>pg_xlog<span class="w"> </span>/disk
$<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/disk/pg_xlog<span class="w"> </span>pg_xlog
</code></pre></div>
<p>从 PostgreSQL
8.3 以后，在执行 initdb 时，我们可以通过指定--xlogdir 参数来指定 xlog 的存放位置，不过其工作原来和上一致，也是创建符号链接。</p>
<h4 id="_12">表空间<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>我们可以通过创建表空间时设置 location 参数来指定其表空间内的数据文件和表存到到不同的位置：</p>
<div class="highlight"><pre><span></span><code>$ mkdir /disk/pgdata
$ psql
postgres=# CREATE TABLESPACE disk LOCATION &#39;/disk/pgdata&#39;;
postgres=# CREATE TABLE t(i int) TABLESPACE disk;
</code></pre></div>
<p>在数据库内部，这个功能也是通过符号链接来实现的，因此上述这些操作都需要文件系统的支持。</p>
<h4 id="_13">数据库目录树<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>通过 initdb 指令，PostgreSQL 创建了下面的主要目录结构，分别描述如下：</p>
<dl>
<dt>base</dt>
<dd>
<p>这是存储 pg_default 的位置，包括缺省的表空间、模板数据库以及任何不通过显示指定位置的表空间文件存放位置。</p>
</dd>
<dt>global</dt>
<dd>
<p>存放 pg_global 里设置的虚拟表空间，这里是在一个集群里能被所有数据库共享的系统表，比如数据库角色和其他系统条目</p>
</dd>
<dt>pg_clog</dt>
<dd>
<p>事务提交日志存放点。这些数据被 VACUUM 指令读取，因此这些文件不再需要，就被删除。如果 pg_clog 所在文件系统在挂载时绕过了文件系统缓存，则它会称为严重拖累数据库性能的罪魁祸首。</p>
</dd>
<dt>pg_stat_tmp</dt>
<dd>
<p>这个目录用于存储那些用于数据库统计的文件。这些文件都不会太大。</p>
</dd>
<dt>pg_tblspc</dt>
<dd>
<p>当创建一个新的表空间时，会在这个目录创建一个指向表空间目录的符号链接文件。删除表空间时，则删除对应的符号链接文件。</p>
</dd>
<dt>pg_xlog</dt>
<dd>
<p>存放 WAL 用于崩溃后回恢复的文件，也就是重做日志</p>
</dd>
<dt>pg_subtrans</dt>
<dd>
<p>存放与子事务相关的数据</p>
</dd>
<dt>pg_multixact</dt>
<dd>
<p>存放多事务状态数据。当你的应用程序大量使用共享行级锁时，这个目录就会被大量使用</p>
</dd>
<dt>pg_twophase</dt>
<dd>
<p>存放和两阶段提交相关的数据</p>
</dd>
</dl>
<h4 id="_14">临时文件<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>PostgreSQL 有几个需要保存临时文件的应用场景，一个是使用 create temporary
table 来创建表以及对应的索引；一个是当一个查询里包含排序操作时，其数据超过了 work_mem 设置的大小。
默认情况下，临时对象存放在 base/pgsql_tmp 目录，除非重新指定了位置。</p>
<h4 id="raid">磁盘组、RAID 以及磁盘布局<a class="headerlink" href="#raid" title="Permanent link">&para;</a></h4>
<p>如果你磁盘很多，而且磁盘空间利用不是问题，那么下面的一个布局对提升性能还是很有帮助的：\</p>
<div class="highlight"><pre><span></span><code>   Location       Disks   RAID Level       Purpose
</code></pre></div>
<hr />
<div class="highlight"><pre><span></span><code>   /(root)          2         1              OS
   \$PGDATA        6+         10          Database
</code></pre></div>
<p>$PGDATA/pg_xlog 2 1 WAL
Tablespace 1+ None Temporary files</p>
<p>\
针对上面的磁盘布局模式，然后考虑到不同组件对缓存刷盘的需求不同，我们可以考虑下面的 cache 设置方式：\</p>
<div class="highlight"><pre><span></span><code>  Function       Cache Flushes           Access Pattern
</code></pre></div>
<hr />
<div class="highlight"><pre><span></span><code>     OS              Rare         Mix of sequential and random
  Database         Regularly      Mix of sequential and random
     WAL           Constant                Sequential
</code></pre></div>
<p>Temporary files Never More random as client increases</p>
<h3 id="_15">磁盘布局指南<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>避免把 WAL 和操作系统放在一个磁盘上，他们是完全不同的访问模式</p>
</li>
<li>
<p>如果你能确保你的数据库不会有大数据量排序，你可以让临时文件存放在默认的位置</p>
</li>
<li>
<p>在使用 ext3 的 Linux 系统上，尽可能把 WAL 存放到另外的磁盘上，不要和数据库文件搅和在一个磁盘上</p>
</li>
<li>
<p>文件系统绝大部分都是通过写日志来保证崩溃后可以恢复，日志虽然增加了开销，但使得恢复时间可以在预期之内</p>
</li>
<li>
<p>对于 Linux 系统，虽然 ext3 可以满足各类场景，但并不是最佳选择。虽然 XFS 和 ext4 还没有达到产品级质量，但是他们应该很快可以替代 ext3(我觉得 ext4 已经很稳定了呀）</p>
</li>
<li>
<p>Solaris 和 FreeBSD 都拥有老的 UFS 文件系统和更新的 ZFS 文件系统。ZFS 的一些特性使得它称为大数据的唯一合适选择</p>
</li>
<li>
<p>Windows 平台的 NTFS 借鉴了很多基于 UNIX 系统上的文件系统的特性，使得其称为可信赖的文件系统</p>
</li>
<li>
<p>提高预读(read-ahead)值，禁止更新文件访问时间戳，调整用于 cache 的内存数量，这些技巧都可以获得更好的性能</p>
</li>
<li>
<p>PostgreSQL 允许通过符号链接和创建表空间来重新分配数据某些部件的路径。</p>
</li>
</ul>
<h2 id="_16">用于数据库缓存的内存<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>这章主要是讨论 shared_buffers 参数设置的内存是如何使用的，通过监控和优化来这部分内存来获得高性能，这也是 PostgreSQL 里最重要的性能参数。\</p>
<h3 id="postgresqlconf">postgresql.conf 里的内存单元<a class="headerlink" href="#postgresqlconf" title="Permanent link">&para;</a></h3>
<p>早期的 PostgreSQL 版本，postgresql.conf 文件里的关于内存的设置参数的设置，你需要知道每一个参数的单位。有的可能是 1KB，有的可能是 8KB。\
从 PostgreSQL
8.2 以后，关于内存数值的设置就简化了，你可以直接设置带单位的数值，比如假定你设置下面的参数：\
<code>wal_buffers = 64KB</code>\
你登陆数据库，通过 show 指令，可以看到 wal_buffers 的大小就是你所设置的参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">wgzhao</span><span class="o">=#</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">wal_buffers</span><span class="p">;</span>
<span class="w"> </span><span class="n">wal_buffers</span>
<span class="c1">-------------</span>
<span class="w"> </span><span class="mi">64</span><span class="n">kB</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>不过 PostgreSQL 内部还是会把参数值转化为它自己内部单位，比如 wal_buffers 的内部单位是块大小(8k)，因此，在 PostgreSQL 看来，wal_buffers 的值其实是 8。
我们可以通过下面的查询语句可以证实：</p>
<div class="highlight"><pre><span></span><code><span class="n">wgzhao</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">setting</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">current_setting</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_settings</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;wal_buffers&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">name</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">current_setting</span>
<span class="c1">-------------+---------+------+-----------------</span>
<span class="w"> </span><span class="n">wal_buffers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="n">kB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">64</span><span class="n">kB</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<h3 id="unix">为大缓存增加 UNIX 共享内存参数值<a class="headerlink" href="#unix" title="Permanent link">&para;</a></h3>
<p>initdb 默认设置的 shared_buffers 一般都很小，这是考虑到 initdb 需要在各种平台保证执行成功，而很多 UNIX 系统，默认情况下允许分配的内存都很小，一般不超过 32MB。
所以 initdb 所设置的 shared_buffers 不适合任何场景，它仅仅只是保证执行成功，以及数据库服务能够启动。\
<a href="http://www.postgresql.org/docs/current/static/server-start.html">这篇文章</a>里描述了各种于共享内存相关启动错误信息，其中一种可能的错误类似下面这样:</p>
<div class="highlight"><pre><span></span><code>FATAL: could not create shared memory segment: Invalid argument
DETAIL: Failed system call was shmget(key=5440001, size=4011376640, 03600)
</code></pre></div>
<p><a href="http://www.postgresql.org/ docs/current/static/kernel-resources.html">这篇文档</a>描述了绝大部分系统上如何调整和 shared_buffers 相关的内核参数.\
对于支持 getconf 指令的 UNIX 系统，我们可以通过下面的一个脚本（假设名为*shmsetup.sh*)来提高可分配内存的大小.\</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">## simple shmsetup script</span>
<span class="nv">page_size</span><span class="o">=</span><span class="sb">`</span>getconf<span class="w"> </span>PAGE_SIZE<span class="sb">`</span>
<span class="nv">phys_pages</span><span class="o">=</span><span class="sb">`</span>getconf<span class="w"> </span>_PHYS_PAGES<span class="sb">`</span>
<span class="nv">shmall</span><span class="o">=</span><span class="sb">`</span>expr<span class="w"> </span><span class="nv">$phys_pages</span><span class="w"> </span>/<span class="w"> </span><span class="m">2</span><span class="sb">`</span>
<span class="nv">shmmax</span><span class="o">=</span><span class="sb">`</span>expr<span class="w"> </span><span class="nv">$shmall</span><span class="w"> </span><span class="se">\*</span><span class="w"> </span><span class="nv">$page_size</span><span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span>kernel.shmmax<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$shmmax</span>
<span class="nb">echo</span><span class="w"> </span>kernel.shmall<span class="w"> </span><span class="o">=</span><span class="nv">$shmall</span>
</code></pre></div>
<p>该脚本设置最大共享块大小为物理内存的一半。对于 Linux 系统，我们把上述脚本的输出写入/etc/sysctl.conf\
<code>$ sudo ./shmsetup.sh &gt;&gt;/etc/sysctl.conf</code></p>
<h3 id="_17">内核信号量<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>除了共享内存外，另外一个需要调整的参数是系统可有效使用的信号量数。缺省的 Linux 系统看上去大概是这个样子：\</p>
<div class="highlight"><pre><span></span><code>$ ipcs -l
...
------ Semaphore Limits --------
max number of arrays = 128
max semaphores per array = 250
max semaphores system wide = 32000
max ops per semop call = 32
semaphore max value = 32767

...
</code></pre></div>
<p>通过查询 kernel.sem 参数也能获得上述值，比如：</p>
<div class="highlight"><pre><span></span><code><span class="c1">## sysctl kernel.sem</span>
kernel.sem<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">250</span><span class="w"> </span><span class="m">32000</span><span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="m">128</span>
</code></pre></div>
<h3 id="_18">评估共享内存分配<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>我们可以大致预测 PostgreSQL 需要使用多少内存，<a href="http://www.postgresql.org/docs/current/static/kernel-resources.html">这篇文档</a>
结尾处的一个表格给出了一个大致的内存消耗评估表，摘录如下：\</p>
<p>用途 大致需要的内存(v8.3)</p>
<hr />
<p>Connections (1800 + 270 * max_locks_per_transaction) * max_connections
Autovacuum workers (1800 + 270 * max_locks_per_transaction) * autovacuum_max_works
Prepared transactions (770 + 270 * max_locks_per_transaction) * max_prepared_transactions
Shared disk buffers (block_size + 208) * shared_buffers
WAL buffers (wal_block_size + 8) * wal_buffers
Fixed space requirements 770 KB</p>
<p>\
默认情况下，PostgreSQL 设置的上述参数大致是：\</p>
<p>参数 缺省值</p>
<hr />
<p>max_locks_per_transaction 64<br />
 max_connections 100<br />
 autovacuum_max_works 3<br />
 max_prepared_transactions 0<br />
 block_size 8192<br />
 wal_block_size 8192<br />
 wal_buffers 8</p>
<p>\
通过这些参数，我们就可以简化第一个表格的结果，类似下面这样：\</p>
<p>用途 大致内存</p>
<hr />
<p>Connections + AV workers 1.9MB<br />
 Shared disk buffers 8400 * shared_buffers<br />
 WAL buffers 64 KB<br />
 Fixed space requirements 770 KB</p>
<h3 id="_19">检验数据库缓存<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>我们可以通过 pg_buffercache 模块来检验 shared_buffers 设置的缓存里保存的内容。
有关 pg_buffercache 的介绍可以参考这个链接：<a href="http://www.postgresql.org/docs/current/static/pgbuffercache.html">http://www.postgresql.org/docs/current/static/pgbuffercache.html</a>\
一旦安装了 pg_buffercache 模块，我们就可以查看当数据库活动时，内存里的块是如何改变的。这是理解数据库相关工作原理的最佳方法。
在生产服务器上，也许 pg_buffercache 模块不会显得至关重要，但是对于我们学习数据库如何利用共享内存是有极大帮助的。</p>
<h3 id="pg_buffercache">安装 pg_buffercache 模块<a class="headerlink" href="#pg_buffercache" title="Permanent link">&para;</a></h3>
<p>pg_buffercache 由 C 语言编写的动态库和一组 sql 语句组成。对每个你需要观察的数据库，都需要安装该模块(导入其 sql 语句)。方法类似下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">createdb</span><span class="w"> </span><span class="n">pgbench</span>
<span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">pgbench</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">share</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">contrib</span><span class="o">/</span><span class="n">pg_buffercache</span><span class="p">.</span><span class="k">sql</span>
<span class="k">SET</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span>
<span class="k">REVOKE</span>
<span class="k">REVOKE</span>
</code></pre></div>
<p>我们可以通过查询 shared_buffers 值来验证 pg_buffercache 安装没有问题，就像下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">setting</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">current_setting</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_settings</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;shared_buffers&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="n">name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">current_setting</span>
<span class="c1">----------------+---------+------+-----------------</span>
<span class="w"> </span><span class="n">shared_buffers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">65536</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="n">kB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">512</span><span class="n">MB</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_buffercache</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w"> </span><span class="mi">65536</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>这一章的最后，我们还会利用该模块给出一些有用的报表</p>
<h3 id="vs">数据库缓存 vs 操作系统缓存<a class="headerlink" href="#vs" title="Permanent link">&para;</a></h3>
<p>和其他传统的数据库产品不同，PostgreSQL 不采取甚至不偏向将内存的大部分划为自己所用。数据库的大部分读写都使用了标准的系统条调用，因此它允许操作系统的缓存按照自己的方式来使用。在某些 WAL 的配置中，如果绕过了操作系统的缓存，那会是个问题。\
如果你以前使用的数据库是的配置策略是把绝大部分内存划给数据库，且数据库的读写操作通过同步(synchronouse)或直接 IO(direct-io)方式绕过操作系统缓存。那么这种策略不要用在 PostgreSQL 上。</p>
<h3 id="_20">重复的缓存数据<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>shared_buffers 不要设置得太大的其中一个原因是操作系统缓存也被用于读写操作，极端的情况下，两者的数据有可能重叠而导致浪费。\
比如，当你发起一个完全新的请求，那么数据库服务需要从磁盘读取数据块，这些块首先会进入操作系统缓存，然后拷贝到数据库缓存。虽然最终，这些缓存中的数据都会被刷出去，但在一段时间内，它在操作系统缓存和数据库缓存中都存在，因此设置 shared_buffers 一个恰当的值可以减少重复数据的数量。</p>
<h3 id="shared_buffers">shared_buffers 的起点设置<a class="headerlink" href="#shared_buffers" title="Permanent link">&para;</a></h3>
<p>设定一个好的 shared_buffers 值很难，通常我们都会说一个相对内存的比率。有部分人主张仅使用内存的 10-15%。论文<a href="http://www.cs.duke.edu/~shivnath/papers/ituned.pdf">Tuning
Database Configuration Parameters with
iTuned</a>非常详尽的给出了一个有关该值的学术解释。这片文档提到他们在一台 1G 内存的机器上，发现设置 shared_buffers 设置为内存的 40%为其最佳值，并据此进行了非常广泛的查询测试。\
一般来说，如果你服务器上 OS 对内存开销很小，那么 shared_buffers 设置为内存的 25%是一个不错的起点，虽然不是最佳设置，但是一方面它可以有效减少重复的缓存数据，另外一方面，它也比缺省设置值要高很高，相比效率也有较大提升。</p>
<h3 id="_21">缓存查询检测<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>下面用一个实例来说明如何利用 pg_buffercache 来模块来检测缓存的使用
我们设置 shared_buffers
为 512M，然后使用 pgbench 创建一个比例为 50 的数据库，其目的是数据库大小超过 shared_buffers 的值，以免所有的查询数据都能缓存到内存里。\</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="n">pgbench</span>
<span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">hlocalhost</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="k">c</span><span class="w"> </span><span class="ss">&quot;select pg_size_pretty(pg_database_size(&#39;pgbench&#39;)) as db_size&quot;</span>

<span class="o">-</span><span class="p">[</span><span class="w"> </span><span class="n">RECORD</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="c1">---</span>
<span class="n">db_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">754</span><span class="w"> </span><span class="n">MB</span>

<span class="n">pgbench</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="k">c</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">25000</span><span class="w"> </span><span class="n">pgbench</span>
<span class="n">starting</span><span class="w"> </span><span class="k">vacuum</span><span class="p">...</span><span class="k">end</span><span class="p">.</span>

<span class="k">transaction</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">only</span>
<span class="n">scaling</span><span class="w"> </span><span class="n">factor</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span>
<span class="n">query</span><span class="w"> </span><span class="k">mode</span><span class="p">:</span><span class="w"> </span><span class="k">simple</span>
<span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">clients</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span>
<span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">threads</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">transactions</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span>
<span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">transactions</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">processed</span><span class="p">:</span><span class="w"> </span><span class="mi">200000</span><span class="o">/</span><span class="mi">200000</span>
<span class="n">tps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">540</span><span class="p">.</span><span class="mi">590358</span><span class="w"> </span><span class="p">(</span><span class="k">including</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="n">establishing</span><span class="p">)</span>
<span class="n">tps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">540</span><span class="p">.</span><span class="mi">624004</span><span class="w"> </span><span class="p">(</span><span class="k">excluding</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="n">establishing</span><span class="p">)</span>
</code></pre></div>
<h4 id="_22">缓存里的最大表<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>我们可以通过下的 SQL 语句来查询在缓存中的前 10 个表是哪些</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_buffercache</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">relfilenode</span><span class="o">=</span><span class="k">c</span><span class="p">.</span><span class="n">relfilenode</span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_database</span><span class="w"> </span><span class="n">d</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">reldatabase</span><span class="o">=</span><span class="n">d</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">datname</span><span class="o">=</span><span class="n">current_database</span><span class="p">())</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">             </span><span class="n">relname</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">buffers</span>
<span class="c1">----------------------------------+---------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w">                 </span><span class="o">|</span><span class="w">   </span><span class="mi">51346</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w">            </span><span class="o">|</span><span class="w">   </span><span class="mi">13713</span>
<span class="w"> </span><span class="n">pg_depend_reference_index</span><span class="w">        </span><span class="o">|</span><span class="w">      </span><span class="mi">11</span>
<span class="w"> </span><span class="n">pg_depend</span><span class="w">                        </span><span class="o">|</span><span class="w">       </span><span class="mi">9</span>
<span class="w"> </span><span class="n">pg_rewrite</span><span class="w">                       </span><span class="o">|</span><span class="w">       </span><span class="mi">5</span>
<span class="w"> </span><span class="n">pg_extension</span><span class="w">                     </span><span class="o">|</span><span class="w">       </span><span class="mi">5</span>
<span class="w"> </span><span class="n">pg_depend_depender_index</span><span class="w">         </span><span class="o">|</span><span class="w">       </span><span class="mi">5</span>
<span class="w"> </span><span class="n">pg_description</span><span class="w">                   </span><span class="o">|</span><span class="w">       </span><span class="mi">5</span>
<span class="w"> </span><span class="n">pg_statistic</span><span class="w">                     </span><span class="o">|</span><span class="w">       </span><span class="mi">4</span>
<span class="w"> </span><span class="n">pg_statistic_relid_att_inh_index</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">4</span>
<span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>除掉系统表以后，我们可以看到缓存的绝大部分都用在了 pgbench_accounts 表以及它的主键索引上，这也应该是我们期望的。</p>
<h4 id="_23">缓存内容统计<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>下面的查询语句可以查看到，目前缓存里，数据量居前 10 位的对象是哪些，占用缓存比率是多少，以及相比对象大小的比率是多少</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">buffered</span><span class="p">,</span>
<span class="w">  </span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">/</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_settings</span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;shared_buffers&#39;</span><span class="p">)::</span><span class="nb">integer</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_pct</span><span class="p">,</span>
<span class="w">  </span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="o">/</span>
<span class="w">    </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">pct_of_rel</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_buffercache</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">relfilenode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relfilenode</span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_database</span><span class="w"> </span><span class="n">d</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">reldatabase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_database</span><span class="p">())</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="p">,</span><span class="k">c</span><span class="p">.</span><span class="n">relname</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">            </span><span class="n">relname</span><span class="w">              </span><span class="o">|</span><span class="w">  </span><span class="n">buffered</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">buffers_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pct_of_rel</span>
<span class="c1">----------------------------------+------------+------------+-------------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="mi">402</span><span class="w"> </span><span class="n">MB</span><span class="w">     </span><span class="o">|</span><span class="w">       </span><span class="mi">78</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">62</span><span class="p">.</span><span class="mi">8</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">107</span><span class="w"> </span><span class="n">MB</span><span class="w">     </span><span class="o">|</span><span class="w">       </span><span class="mi">20</span><span class="p">.</span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_operator_oid_index</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_opclass_oid_index</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_namespace</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_operator</span><span class="w">                      </span><span class="o">|</span><span class="w"> </span><span class="mi">88</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">78</span><span class="p">.</span><span class="mi">6</span>
<span class="w"> </span><span class="n">pg_amproc_fam_proc_index</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">75</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_index</span><span class="w">                         </span><span class="o">|</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_statistic_relid_att_inh_index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="w"> </span><span class="n">pg_index_indrelid_index</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span>
<span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>注意，函数 pg_relation_size()不包含存储在 TOAST 表中的数据。如果你的 PostgreSQL 是 9.0 以上版本，可以使用 pg_table_size()函数来代替，它包含了 TOAST 表数据。</p>
<h3 id="_24">总结<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>一个数据库服务可能会遇到各种工作模式，所以很难有一个死规则来说根据硬件条件就可以配置出优化的参数。\
有些应用程序偏向把大部分内存专用于数据库，并从中获得好处，而有些应用程序则会因为这样的配置遇到 checkpoint 峰值问题。\
PostgreSQL
8.3 以后的版本提供了一些工具帮我们监控缓存这部分区域是如何使用的，再联合包括 OS 如何使用缓存等技术手段，我们就可以配置出一个靠谱的优化参数来。\
下面是一个针对数据库内存使用的规则：\</p>
<ul>
<li>
<p>在服务启动时，PostgreSQL 分别一大块内存用户把数据库磁盘块导入内存，并进行读写操作</p>
</li>
<li>
<p>数据库缓存和操作系统缓存是协作关系而非替代关系，因此其大小应该是一个恰当的值而非一味的求大</p>
</li>
<li>
<p>默认情况下，分配给数据库的共享内存都很小，因此需要调整</p>
</li>
<li>
<p>崩溃后恢复是通过改变数据库文件之前将修改的内容先写入 WAL 来做到的</p>
</li>
<li>
<p>Checkpoint 需要小心调整，既要限制崩溃后恢复时间又要考虑不影响系统的性能</p>
</li>
<li>
<p>系统视图 pg_stat_bgwriter 跟踪所有缓存的刷入刷出情况</p>
</li>
<li>
<p>pg_buffercache
  模块用来查看缓存内有哪些内容，并据此判断缓存是太大还是太小</p>
</li>
</ul>
<h2 id="_25">服务器配置调优<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<p>这一章主要围绕$PGDATA/postgresql.conf
文件里的配置参数展开，基本上算是对<a href="http://www.postgresql.org/docs/current/static/runtime-config.html">http://www.postgresql.org/docs/current/static/runtime-config.html</a>
一文的拷贝，不过我们重点关注一些重要参数的配置指导大纲，而不是介绍每个参数的含义。</p>
<p>另外一个有关调优的在线资源是官方 wiki 上的一篇文章:<a href="http://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server">Tuning Your PostgreSQL
Server</a>，这篇文章一直在更新以保持和当前主流版本的配置参数一致。</p>
<h3 id="_26">修改参数<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>PostgreSQL 参数可以有几种修改方式，有的可以在运行时直接修改，有的参数修改后，需要发出 SIGHUP 信号以便重新加载 postgresql.conf 文件来来生效，
有的修改后则需要重启数据库服务才生效，还有一些根本就不能修改。</p>
<p>如果确定这些参数属于哪种类型呢，我们可以直接查询数据库的字典来获得相关信息，就像下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">context</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_settings</span><span class="p">;</span>
<span class="w">              </span><span class="n">name</span><span class="w">               </span><span class="o">|</span><span class="w">  </span><span class="n">context</span>
<span class="c1">---------------------------------+------------</span>
<span class="w"> </span><span class="n">application_name</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="k">user</span>
<span class="w"> </span><span class="n">archive_command</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="n">sighup</span>
<span class="w"> </span><span class="n">archive_mode</span><span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="n">postmaster</span>
<span class="w"> </span><span class="n">archive_timeout</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="n">sighup</span>
<span class="w"> </span><span class="n">block_size</span><span class="w">                      </span><span class="o">|</span><span class="w"> </span><span class="n">internal</span>
<span class="w"> </span><span class="n">dynamic_library_path</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">superuser</span>
</code></pre></div>
<p>context 字段所表示的具体含义，在官方文档里并没有详细给出，这里我们按照从难到易来介绍这些值的意思:\</p>
<dl>
<dt>internal</dt>
<dd>
<p>这种类型的参数都是编译时设置好的，你可以查看这些参数的值，但是除非重新编译，否则无法修改.</p>
</dd>
<dt>postmaster</dt>
<dd>
<p>这种类型的参数只有完全重启数据库服务才能生效，所有的共享内存设置参数都属于这类.</p>
</dd>
<dt>sighup</dt>
<dd>
<p>给服务发送 HUP 信号，使得服务可以重新加载 postgresql.conf 文件，从而使得这种类型的参数生效.</p>
</dd>
<dt>backend</dt>
<dd>
<p>这种类型的参数和 sighup 详细，只是它不对已经连接到服务器上的会话生效，只有新的会话才会启用修改后的参数，
属于这类的参数较少，log_connections 属于这类</p>
</dd>
<dt>superuser</dt>
<dd>
<p>顾名思义，这类参数只有数据库超级用户（默认一般是创建 postgres 数据库的用户）才能修改，这类参数大部分修改后即生效.</p>
</dd>
<dt>user</dt>
<dd>
<p>每个会话都可以修改的参数，且不互相影响，大部分的参数都属于这这种类型。</p>
</dd>
</dl>
<p>就我目前使用的 PostgreSQL 9.3 版本来说，各种类型的参数统计结果如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">count</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_settings</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">  </span><span class="n">context</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">count</span>
<span class="c1">------------+-------</span>
<span class="w"> </span><span class="n">backend</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="mi">5</span>
<span class="w"> </span><span class="k">user</span><span class="w">       </span><span class="o">|</span><span class="w">    </span><span class="mi">91</span>
<span class="w"> </span><span class="n">internal</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">14</span>
<span class="w"> </span><span class="n">postmaster</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">37</span>
<span class="w"> </span><span class="n">superuser</span><span class="w">  </span><span class="o">|</span><span class="w">    </span><span class="mi">25</span>
<span class="w"> </span><span class="n">sighup</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="mi">52</span>
<span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>有几种办法可以让数据库重新加载 postgresql.conf 文件，一种是使用数据库自带的函数，就像下面的例子：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">pg_reload_conf</span><span class="p">();</span>
<span class="w"> </span><span class="n">pg_reload_conf</span>
<span class="c1">----------------</span>
<span class="w"> </span><span class="n">t</span>
<span class="n">LOG</span><span class="p">:</span><span class="w">  </span><span class="n">received</span><span class="w"> </span><span class="n">SIGHUP</span><span class="p">,</span><span class="w"> </span><span class="n">reloading</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">files</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>一种是直接给数据库进程发送 HUP 信号</p>
<div class="highlight"><pre><span></span><code>lancy-imac:~<span class="w"> </span>wgzhao$<span class="w"> </span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>/usr/bin/postgres
<span class="w">  </span><span class="m">501</span><span class="w">  </span><span class="m">2827</span><span class="w">     </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="m">11</span>:08上午<span class="w"> </span>ttys000<span class="w">    </span><span class="m">0</span>:00.61<span class="w"> </span>/usr/bin/postgres
lancy-imac:~<span class="w"> </span>wgzhao$<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span><span class="m">2827</span>
</code></pre></div>
<p>从命令行来看不会有任何输出，不过查看你的日志，或者终端，应该有下面类似的记录：\
<code>LOG:  received SIGHUP, reloading configuration files</code></p>
<p>最后一种是通过 pg_ctl 指令来发送 SIGHUP 信号</p>
<div class="highlight"><pre><span></span><code>pg_ctl<span class="w"> </span>reload
server<span class="w"> </span>signaled
</code></pre></div>
<h3 id="_27">服务端设置<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>\</p>
<dl>
<dt>listen_addresses</dt>
<dd>
<p>默认是仅允许本地链接，一般通过设置为'*'来允许任何链接</p>
</dd>
<dt>max_connections</dt>
<dd>
<p>一般设置为 100，每进来一个链接，都需要占用一部分共享内存，因此其最大值和 shared_buffers 关系密切，
而且也有其他参数有关系，比如 work_mem</p>
</dd>
</dl>
<p>\</p>
<dl>
<dt>shared_buffers</dt>
<dd>
<p>这个参数在最后一章详细讲解，这是一个相当重要的参数</p>
</dd>
<dt>FSM</dt>
<dd>
<p>这里包括两个参数 max_fsm_pages 和 max_fsm_relations，在后面的章节会详细描述</p>
</dd>
</dl>
<p>\</p>
<dl>
<dt>log_line_prefix</dt>
<dd>
<p>默认设置为空，一个较好的建议值如下：\
 <code>log_line_prefix='%t:%r:%u@%d:[%p]: '</code>\
 其参数解释如下：</p>
<dl>
<dt>%t</dt>
<dd>
<p>时间戳</p>
</dd>
<dt>%u</dt>
<dd>
<p>数据库用户名</p>
</dd>
<dt>%r</dt>
<dd>
<p>链接的远程主机名</p>
</dd>
<dt>%d</dt>
<dd>
<p>链接的数据库名</p>
</dd>
<dt>%p</dt>
<dd>
<p>链接的进程ID</p>
</dd>
</dl>
</dd>
<dt>log_statement</dt>
<dd>
<p>有下面四个可选值来设置：\</p>
<dl>
<dt>none</dt>
<dd>
<p>不记录任何语句级信息</p>
</dd>
<dt>ddl</dt>
<dd>
<p>仅记录数据定义语言(Data Definition Language a.k.a
DDL),比如create,drop，在生产系统上也可以使用
这个参数，他记录的信息很少</p>
</dd>
<dt>mod</dt>
<dd>
<p>记录所有对值有修改的语句，基本上把除select语句以外的语句都记录了，量比较大</p>
</dd>
<dt>all</dt>
<dd>
<p>记录所有的语句，有相当大的开销，建议仅在调试时使用</p>
</dd>
</dl>
</dd>
<dt>log_min_duration_statement</dt>
<dd>
<p>记录那些执行时间超过该参数值的语句，单位是 ms，如果是 8.4 以后的版本，建议优先使用<a href="http://www.postgresql.org/docs/8.4/static/auto-explain.html">auto_explain
模块</a></p>
</dd>
</dl>
<h3 id="_28">专用数据库服务器参数设置<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>对于一台新的专用于数据库服务的设备，我们建议首先调整以下参数，然后运行一段时间，再根据实际情况调整：</p>
<ol>
<li>
<p>调整缺省的日志参数，以记录稍多一点信息</p>
</li>
<li>
<p>shared_buffers 设置为物理内存的 25%，往上调整需要考虑到 checkpoint 的额外开销</p>
</li>
<li>
<p>评估最大连接数，这是一个硬性限制，一旦超过最大连接数，则会被拒绝</p>
</li>
<li>
<p>用上述参数启动服务，注意看还有多少内存可用于文件系统缓存</p>
</li>
<li>
<p>调整 effective_cache_size 为 shared_buffers + OS cache</p>
</li>
<li>
<p>OS cache / max_connections / 2
    其结果设置为 work_mem 的上限，如果你的应用程序不依赖于排序性能，可设置得更小</p>
</li>
<li>
<p>maintenance_work_mem 设置为每 GB 内存 50MB</p>
</li>
<li>
<p>checkpoint_segments 不小于 10，如果你服务器硬件具有 BBWC(Battery-backed
    write cache)功能，设置为 32 会更好</p>
</li>
<li>
<p>如果你的系统对 wal_sync_method 的缺省设置方式不安全，更换安全的参数，一般都不需要修改</p>
</li>
<li>
<p>修改 wal_bufffers 为 16MB</p>
</li>
</ol>
<h3 id="_29">总结<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>PostgreSQL 里可以调整的参数差不多有 200 个，针对你的应用程序，想把这些参数都设置为最佳几乎是一件不可能的任务，这里给出的指南
也只是一个通常的考虑，以避免常见的瓶颈。</p>
<ul>
<li>
<p>服务器的缺省配置参数使用非常少的内存以及记录很少的信息，这两点是必须要调整的</p>
</li>
<li>
<p>与内存有关的调整主要是 shared_buffers 和 work_mem，仔细调整，主要不要出现 OOM(Out
  of memory)现象</p>
</li>
<li>
<p>查询计划需要知道内存状态，有好的表信息统计有助于查询计划做出正确的判断</p>
</li>
<li>
<p>autovacuum 进程很关键，它确保查询计划能获得正确的信息</p>
</li>
<li>
<p>大部分情况下，参数的调整都不需要重启服务，很多参数修改后直接生效</p>
</li>
</ul>
<h2 id="_30">例行维护<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<h2 id="_31">数据库性能测试<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h2>
<p>这一章主要讨论 PostgreSQL 自带的 pgbench 的使用</p>
<h3 id="pgbench">pgbench 缺省测试<a class="headerlink" href="#pgbench" title="Permanent link">&para;</a></h3>
<p>pgbench 最开始是面向 TPC 测试的工具，主要测试<a href="http://www.tpc.org/tpcb/">TPC-B</a>，1990 年开始开发，其模型是一个简单的银行
应用程序，包括支行、柜员和账户等信息。\
其主要的表的定义如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_branches</span><span class="p">(</span><span class="n">bid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">bbalance</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">filler</span>
<span class="nb">char</span><span class="p">(</span><span class="mi">88</span><span class="p">));</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">bid</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="n">bid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">tbalance</span>
<span class="nb">int</span><span class="p">,</span><span class="n">filler</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">84</span><span class="p">));</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_accounts</span><span class="p">(</span><span class="n">aid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="n">bid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">abalance</span>
<span class="nb">int</span><span class="p">,</span><span class="n">filler</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">84</span><span class="p">));</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pgbench_history</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="n">bid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="n">aid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="n">delta</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">mtime</span>
<span class="k">timestamp</span><span class="p">,</span><span class="n">filler</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">22</span><span class="p">));</span>
</code></pre></div>
<h3 id="_32">规模检测<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>模型中，支行的数量被称为数据库规模，每个支行包括 10 个柜员和 100,000 个账户，初始化数据库时，可以通过执行参数来设定数据库的规模，比如:</p>
<div class="highlight"><pre><span></span><code>    $ createdb pgbench
    $ pgbench -i -s 10 pgbench
</code></pre></div>
<p>上述指令表示用 10 个支行的数据库规模填充数据库 pgbench，运行测试时，如果执行-s 的参数，则 pgbench 采纳这个参数，如果没有提供，则通过下面的 SQL 指令猜测数据库规模:
/select count(*) from pgbench_branches;/</p>
<h3 id="_33">查询脚本定义<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>pgbench 内建的标准测试所需要的脚本和 SQL 语句直接编译进了程序中，当然我们也可以定制自己需要测试的脚本，其详细情况，可以参考<a href="http://www.postgresql.org/docs/current/static/pgbench.html">对应的文档</a>\
缺省的交易脚本，我们称之为"TPC-B"交易，大致类似下面的语句组成:</p>
<div class="highlight"><pre><span></span><code>\set nbranches :scale
\set ntellers 10 * :scale
\set naccounts 100000 * :scale
\setrandom aid 1 :naccounts
\setrandom bid 1 :nbranches
\setrandom tid 1 :ntellers
\setrandom delta -5000 5000
BEGIN;
UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;
SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;
UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;
INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);
END;
</code></pre></div>
<p>脚本的前 3 行依据:scale 变量计算有多少支行、柜员以及账户。接下来 4 行创建随机数，模拟银行交易。脚本的核心代码是由 5 个语句组成的事务，每个语句对数据库的影响都不同:\</p>
<dl>
<dt>update pgbench_accounts</dt>
<dd>
<p>作为数据库中最大的表，它最有可能引发磁盘 I/0 瓶颈</p>
</dd>
<dt>select abalance</dt>
<dd>
<p>因为之前的 update 语句已经把该语句需要查询的信息都缓存起来了，因此它增加的开销很小</p>
</dd>
<dt>update pgbench_tellers</dt>
<dd>
<p>相比 accounts 表，这个表小很多，能够在缓存到内存，因此它可能对引发锁的问题</p>
</dd>
<dt>update pgbench_branches</dt>
<dd>
<p>这个表相当小，整个内容都可以被缓存，所以访问速度不是问题，但是正因为小，锁有可能称为其访问瓶颈</p>
</dd>
<dt>insert into pgbench_history</dt>
<dd>
<p>历史表作为只追加表，表上无索引</p>
</dd>
</dl>
<p>这是缺省测试，还有两个别的参数可以稍微改变测试行为:</p>
<dl>
<dt>-N</dt>
<dd>
<p>和上面的测试相同，只是跳过两个小表(tellers,branches)的更新参数，这降级的锁的潜在问题</p>
</dd>
<dt>-S</dt>
<dd>
<p>只对 accounts 表做查询操作，因此它不需要把语句组成一个事务</p>
</dd>
</dl>
<p>仅做查询操作而跳过所有的更新操作对于检查缓存大小，测试最大 CPU 速度很有帮助。</p>
<h4 id="pgbench_1">为 pgbench 配置数据库<a class="headerlink" href="#pgbench_1" title="Permanent link">&para;</a></h4>
<p>内建的测试行为，其他语句都很简单：绝大部分是通过主键索引查询，没有表链接，也没用负责查询类型。\
但这些语句都会产生很重的写压力，需要缓存能跟得上\
基于此，我们可以把可以调整的参数分为三个主要类型:</p>
<ul>
<li>
<p>重点关注和调整的参数:
  shared_buffers,checkpoint_segments,autovacuum,wal_buffers,checkpoint_completion_target</p>
</li>
<li>
<p>显著影响测试结果的参数:
  wal_sync_method,synchronouse_commit,wal_writer_delay</p>
</li>
<li>
<p>无关的:
  effective_cache_size,default_statistics_target,work_mem,random_page_cost 等</p>
</li>
</ul>
<h2 id="_34">数据库索引<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h2>
<h2 id="_35">查询优化<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h2>
<h3 id="_36">填充样例数据<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>为了演示查询优化的过程，我们需要填充一些样例数据，PostgreSQL 的 wiki 上给出了一些常用的样例数据列表，可以参考这个链接：<a href="http://wiki.postgresql.org/wiki/ Sample_Databases">http://wiki.postgresql.org/wiki/
Sample_Databases</a>
这里选取 Dell Store 2 这个有 Dell 贡献的样例，安装步骤如下：</p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>http://pgfoundry.org/frs/download.php/543/dellstore2-normal-1.0.tar.gz
tar<span class="w"> </span>xvfz<span class="w"> </span>dellstore2-normal-1.0.tar.gz
<span class="nb">cd</span><span class="w"> </span>dellstore2-normal-1.0/
createdb<span class="w"> </span>dellstore2
createlang<span class="w"> </span>plpgsql<span class="w"> </span>dellstore2
psql<span class="w"> </span>-f<span class="w"> </span>dellstore2-normal-1.0.sql<span class="w"> </span>-d<span class="w"> </span>dellstore2
psql<span class="w"> </span>-d<span class="w"> </span>dellstore2<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;VACUUM VERBOSE ANALYZE&quot;</span>
</code></pre></div>
<p>该样例数据库大概 23MB</p>
<div class="highlight"><pre><span></span><code><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">hlocalhost</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">dellstore2</span><span class="w"> </span><span class="o">-</span><span class="k">c</span><span class="w"> </span><span class="ss">&quot;select pg_size_pretty(pg_database_size(&#39;dellstore2&#39;))&quot;</span>
<span class="w"> </span><span class="n">pg_size_pretty</span>
<span class="c1">----------------</span>
<span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="n">MB</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>其主要的表和索引如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">dt</span><span class="o">+</span>
<span class="w">        </span><span class="n">List</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">relations</span>
<span class="w"> </span><span class="k">Schema</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="n">Name</span><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="k">Size</span><span class="w">   </span><span class="o">|</span>
<span class="c1">--------+------------+---------+</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cust_hist</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">2648</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">customers</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">3944</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">inventory</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">472</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">orderlines</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">3112</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">orders</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">832</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">products</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">840</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">reorder</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span>
<span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>


<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">di</span><span class="o">+</span>
<span class="w">            </span><span class="n">List</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">relations</span>
<span class="w"> </span><span class="k">Schema</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="n">Name</span><span class="w">          </span><span class="o">|</span><span class="w">  </span><span class="k">Size</span><span class="w">   </span><span class="o">|</span>
<span class="c1">--------+------------------------+---------+</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">categories_pkey</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">customers_pkey</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">456</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">inventory_pkey</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_cust_hist_customerid</span><span class="o">|</span><span class="w"> </span><span class="mi">1336</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_cust_username</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">624</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_order_custid</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="mi">280</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_orderlines_orderid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">1336</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_prod_category</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ix_prod_special</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">orders_pkey</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">280</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">products_pkey</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="n">kB</span><span class="w">  </span><span class="o">|</span>
<span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<h2 id="_37">数据库活动和统计<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h2>
<p>PostgreSQL 有一个统计收集的子系统，它可以监控数据库内部各方面的信息。服务器的每个处理会发送统计消息给收集器，最后统计器汇总消息并发布。
缺省情况下，统计器没半秒(编译时指定的值)更新统计并发布，每一个统计值可以通过一套函数来返回，详细情况可以参考这个文档：<a href="http://www.postgresql.org/docs/current/static/monitoring-stats.html">http://www.postgresql.org/docs/current/static/monitoring-stats.html</a></p>
<h3 id="_38">统计视图<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>通过组织一系列的视图，以方便人们能够快速访问统计收集器的输出，阅读有关视图的源代码对于理解其是如何工作的非常有帮助，如果你有 PostgreSQL 的源代码，那么可以阅读
src/backend/catalog/system_views.sql 文件。如果你已经安装了数据库，可以阅读 share/system_views.sql，或者你也可以直接下载其源代码:<a href="http://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/catalog/system_views.sql">http://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/catalog/system_views.sql</a>
我们可以看一个简单的视图来理解它一般是如何组织的，下面是 8.3 版本中 pg_stat_bgwriter 视图源代码：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">pg_stat_bgwriter</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="n">pg_stat_get_bgwriter_timed_checkpoints</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_timed</span><span class="p">,</span>
<span class="n">pg_stat_get_bgwriter_requested_checkpoints</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">,</span>
<span class="n">pg_stat_get_bgwriter_buf_written_checkpoints</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_checkpoint</span><span class="p">,</span>
<span class="n">pg_stat_get_bgwriter_buf_written_clean</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_clean</span><span class="p">,</span>
<span class="n">pg_stat_get_bgwriter_maxwritten_clean</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">maxwritten_clean</span><span class="p">,</span>
<span class="n">pg_stat_get_buf_written_backend</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_backend</span><span class="p">,</span>
<span class="n">pg_stat_get_buf_alloc</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_alloc</span><span class="p">;</span>
</code></pre></div>
<p>这个视图其实只是把各种独立的统计函数组织在一起，从而输出一个完整的信息，其他统计视图结构上也和这类似。</p>
<h3 id="_39">累积视图和实时视图<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>有两种类型的信息可以从数据库获得监控信息。主要的统计信息保存在计数器里。当你创建一个新的数据库时，计数器设置为 0，随着和统计相关的活动增加而增加。
计数器包括 pg_stat_database,pg_stat_bgwriter 以及所有命名以 pg_stat 开头的视图。\
有确切的方法把计数器清零，不过 PostgreSQL 版本不同，方法不同：</p>
<dl>
<dt>Version 8.1</dt>
<dd>
<p>pg_stat_reset()重置所有统计，在 postgresql.conf 设置 stats_reset_on_server_start=on 会使得每次数据库服务重启都充值统计</p>
</dd>
<dt>Version 8.2</dt>
<dd>
<p>pg_stat_reset()仅重置块以及行级别统计，而 stats_reset_on_server_start=on 则重置所有统计,包括数据库端和集群端。</p>
</dd>
<dt>Version 8.3,8.4</dt>
<dd>
<p>pg_stat_reset()只重置当前数据库的所有统计，没法办法可以重置集群段的统计，比如 pg_stat_bgwriter。</p>
</dd>
<dt>Version 9.0</dt>
<dd>
<p>pg_stat_reset()仅重置当前数据库的所有统计。pg_stat_reset_shared('bgwriter')可以重置 pg_stat_bgwriter.
pg_stat_reset_single_table_counters() ，
pg_stat_reset_single_function_counters()可以重置单独的表、索引以及函数统计</p>
</dd>
</dl>
<p>知道统计视图里哪些是累加的，哪些是固定的（比如表名）很重要。为了搞清楚累加的字段，你可以用带时间戳的方式定期抓取数据，然后观察这些数据在这个时间段内是如何变化的，这章的最后会给出人工抓取 pg_stat_bgwriter 数据。\
除了这些直观的统计计数器外，还有一些数据库活动的实时视图，它给出了数据库此刻所发生的活动的快照。这些视图包括 pg_stat_activity,pg_locks,pg_prepared_xacts.</p>
<h3 id="_40">表统计<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>每个表的基本统计视图为 pg_stat_all_tables，这个视图为了方便有分成了两个，一个是和系统表有关的 pg_stat_sys_tables，一个是和用户表 pg_stat_user_tables。后者是我们重点关注的。\
视图的第一个用处是我们可以使用这些数据来监控 vacuum 在你数据库里运作得如何。\
我们可以使用这个视图来判断这些表是否通过顺序扫描或者索引扫描访问过</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">schemaname</span><span class="p">,</span><span class="n">relname</span><span class="p">,</span><span class="n">seq_scan</span><span class="p">,</span><span class="n">idx_scan</span><span class="p">,</span>
<span class="w">          </span><span class="k">cast</span><span class="p">(</span><span class="n">idx_scan</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">idx_scan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq_scan</span><span class="p">)</span>
<span class="w">          </span><span class="k">as</span><span class="w"> </span><span class="n">idx_scan_pct</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_user_tables</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">idx_scan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq_scan</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">idx_scan_pct</span><span class="p">;</span>

<span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">seq_scan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_scan_pct</span>
<span class="w"> </span><span class="c1">-----------+------------------+----------+----------+---------------</span>
<span class="w"> </span><span class="k">public</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000000</span>
<span class="w"> </span><span class="k">public</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000000</span>
<span class="w"> </span><span class="k">public</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">600000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">999998</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>在极小的 pgbench 数据库里，访问 pgbench_branches 和 pgbench_tellers 是通过顺序扫描访问的，因为他们都很小，可以载入到一个数据页内。而 pgbench_accounts 就很大了，因此 select 语句访问时，需要通过索引来查询数据。\
我们对表更感兴趣的是确切的知道这个表被这些扫面所处理过的元组,下面的视图查询可以获得这些信息：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span><span class="n">seq_tup_read</span><span class="p">,</span><span class="n">idx_tup_fetch</span><span class="p">,</span>
<span class="w">          </span><span class="k">cast</span><span class="p">(</span><span class="n">idx_tup_fetch</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">idx_tup_fetch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq_tup_read</span><span class="p">)</span>
<span class="w">          </span><span class="k">as</span><span class="w"> </span><span class="n">idx_tup_pct</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_user_tables</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">idx_tup_fetch</span><span class="w"> </span><span class="o">+</span><span class="n">seq_tup_read</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">idx_tup_pct</span><span class="p">;</span>

<span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">seq_tup_read</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_tup_fetch</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_tup_pct</span>
<span class="c1">------------------+--------------+---------------+--------------</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w">          </span><span class="mi">500</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000000</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="mi">200</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000000</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">600000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">107143</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>下面这个例子用来查询热(HOT)数据多长时间被用来更新:</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span><span class="n">n_tup_upd</span><span class="p">,</span><span class="n">n_tup_hot_upd</span><span class="p">,</span>
<span class="w">          </span><span class="k">cast</span><span class="p">(</span><span class="n">n_tup_hot_upd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hot_pct</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_user_tables</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hot_pct</span><span class="p">;</span>

<span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_tup_hot_upd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">hot_pct</span>
<span class="c1">------------------+-----------+---------------+-----------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">24681</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="mi">3431</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">139014</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="mi">24681</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">24428</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">989749</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">24680</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">24680</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">000000</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>从输出来看，pgbench_tellers 和 pgbench_branches 的数据更新几乎全部在热数据中完成，这有着很高的效率，但是对于大表 pgbench_accounts 而言，热数据的更新相比所有数据的更新，比率很低，从而性能不高，因此需要调整。\
最后一个好处是可以通过视图来思考在表上插入/更新/删除的特征:</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">n_tup_ins</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_tup_ins</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_del</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ins_pct</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">n_tup_upd</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_tup_ins</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_del</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">upd_pct</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">n_tup_del</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_tup_ins</span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_upd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_tup_del</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">del_pct</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_user_tables</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">relname</span><span class="p">;</span>

<span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">ins_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">upd_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">del_pct</span>
<span class="c1">------------------+---------+---------+---------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">97916</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">02084</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00052</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99948</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
<span class="w"> </span><span class="n">pgbench_history</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">00000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00516</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99484</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
<span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>这个输出证实了 pgbench_history 是我们之前称之为的只附加表，在这个表上只有插入，永远都不会有更新和删除。它也暗示了 pgbench_branches 和 pgbench_tellers 有大量的更新操作，而插入操作微乎其微，删除操作则根本就没有。
这些信息对于我们判断表是否需要周期性的执行 reindex 操作很有帮助。
同样的，对于删除操作的比率观察，也可以让我们思考如果这个比较较高，则可以执行诸如 CLUSTER 操作来清理空间。</p>
<h3 id="io_1">表 I/O<a class="headerlink" href="#io_1" title="Permanent link">&para;</a></h3>
<p>pg_statio_all_tables(pg_statio_user_tables/pg_statio_sys_tables)用来集中统计数据库上的物理 I/O。
第一对要监控的字段是用 shared_buffers 来缓存表数据的结构，在这个上下文里称为堆(heap)，当发生一个读操作时，数据判断是读取数据库缓存(heap
block hit)块还是要求执行操作系统读(heap block read)才能满足要求。</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">heap_blks_hit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">heap_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">heap_blks_read</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">,</span>
<span class="n">heap_blks_hit</span><span class="p">,</span><span class="n">heap_blks_read</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_statio_user_tables</span>
<span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">heap_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">heap_blks_read</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">;</span>

<span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">hit_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">heap_blks_hit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">heap_blks_read</span>
<span class="c1">------------------+---------+---------------+----------------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">59564</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">906335</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">615280</span>
<span class="w"> </span><span class="n">pgbench_history</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99316</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">109787</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">756</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99977</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">197282</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">46</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99988</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">280172</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">34</span>
<span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>要注意的是，并不是所有的 heap blocks
read 都会转化为物理磁盘 I/O，他们有可能是从操作系统缓存读取。当前，数据库没有办法知道到底是哪种读取方式。
不过我们可以通过类似\"<a href="http://en.wikipedia.org/wiki/DTrace">Dtrace</a>\"这样的工具来跟踪读操作，而从做出正确的判断。\
查询表上每个索引所用到的磁盘 I/O 语句如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx_blks_read</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">,</span>
<span class="n">idx_blks_hit</span><span class="p">,</span><span class="n">idx_blks_read</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_statio_user_tables</span>
<span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx_blks_read</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">;</span>

<span class="w">     </span><span class="n">relname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">hit_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_blks_read</span>
<span class="c1">------------------+---------+--------------+---------------</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">91667</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">77</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">7</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">97414</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">2555866</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">67839</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99990</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">194106</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">19</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>这里看不到 pgbench_history 表的信息，因为该表没有索引。\
表 I/O 统计也可以包括 TOAST 表的统计，查询方式如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span>
<span class="p">(</span><span class="n">heap_blks_read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toast_blks_read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tidx_blks_read</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_blks_read</span><span class="p">,</span>
<span class="p">(</span><span class="n">heap_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toast_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tidx_blks_hit</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_blks_hit</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_statio_user_tables</span><span class="p">;</span>
</code></pre></div>
<h3 id="_41">索引统计<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>pg_stat_all_indexes(pg_stat_user_indexes/pg_stat_sys_indexes)视图用于统计索引信息，它给出的包括包括有多少索引扫描被处理以及通过索引扫描返回了多少行数据。\
这个视图的字段名字很复杂，很难区分。比如下面两个字段名字差不多，差别也很细微：</p>
<dl>
<dt>idx_tup_read</dt>
<dd>
<p>通过索引扫描返回的索引条目数</p>
</dd>
<dt>idx_tup_fetch</dt>
<dd>
<p>通过该索引执行简单索引扫描后获取的表记录数。这个数通常比 idx_tup_read 小一点，因为它不包括死的或者还没有提交的行。
另外，这里的"简单"意思是说索引访问不是位图索引扫描(bitmap index
scan)</p>
</dd>
</dl>
<p>因为有太多的场景是 idx_tup_fetch 不记录的，因此如果你想追踪一个索引到底被系统使用的频率度有多少，idx_tup_read 会是更好的选择。\
通过这个视图，我们可以知道该索引扫墓所返回的行记录平均数以及索引是如何被使用的:</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">indexrelname</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">idx_tup_read</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">idx_scan</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_tuples</span><span class="p">,</span>
<span class="n">idx_scan</span><span class="p">,</span><span class="n">idx_tup_read</span>
<span class="k">from</span><span class="w"> </span><span class="n">pg_stat_user_indexes</span>
<span class="k">where</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span>

<span class="w">     </span><span class="n">indexrelname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">avg_tuples</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_tup_read</span>
<span class="c1">-----------------------+------------+----------+--------------</span>
<span class="w"> </span><span class="n">pgbench_tellers_pkey</span><span class="w">  </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="p">.</span><span class="mi">00280</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">96437</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">96707</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="p">.</span><span class="mi">07489</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">812874</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">873753</span>
<span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>输出显示基本上每次索引扫面返回一条记录，这对于主键索引而言并不奇怪。avg_tuples 比 1.0 稍大一点点，反映出索引扫描偶有扫描到无效行。\
pg_stat_user_indexes 所统计的信息最大的用处是用来判断一个所有是否被你的应用真正使用。因为索引会增加系统的而外开销，因此如果一个索引并不是被使用，那就应该删除。
查找这样的索引的最简单办法就是查询 idx_scan 值很小的所以你，比如像下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">schemaname</span><span class="p">,</span><span class="n">relname</span><span class="p">,</span><span class="n">indexrelname</span><span class="p">,</span><span class="n">idx_scan</span><span class="p">,</span>
<span class="w">          </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">idx_size</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_user_indexes</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">pg_index</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">indexrelid</span><span class="p">)</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="n">indisunique</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">idx_scan</span><span class="p">,</span><span class="n">relname</span><span class="p">;</span>

<span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">relname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">indexrelname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_size</span>
<span class="c1">------------+---------+--------------+----------+-----------</span>
<span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>这里特意排除了强制唯一约束，因为这些索引即便很少使用，也不应该删除。</p>
<h3 id="io_2">索引 I/O<a class="headerlink" href="#io_2" title="Permanent link">&para;</a></h3>
<p>和表 I/O 视图类似，也是分为三个视图,用法也差不多</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">indexrelname</span><span class="p">,</span>
<span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx_blks_read</span><span class="p">))::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">,</span>
<span class="n">idx_blks_hit</span><span class="p">,</span><span class="n">idx_blks_read</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_statio_user_indexes</span>
<span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx_blks_read</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hit_pct</span><span class="p">;</span>

<span class="w">     </span><span class="n">indexrelname</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">hit_pct</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_blks_read</span>
<span class="c1">-----------------------+---------+--------------+---------------</span>
<span class="w"> </span><span class="n">pgbench_branches_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">91667</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">77</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">7</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">97414</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">2555866</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">67839</span>
<span class="w"> </span><span class="n">pgbench_tellers_pkey</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99990</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">194106</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">19</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<h3 id="_42">数据库统计<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>视图 pg_stat_database 可以帮助我们获取有关数据库级别的统计信息：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">datname</span><span class="p">,</span><span class="n">blks_read</span><span class="p">,</span><span class="n">blks_hit</span><span class="p">,</span><span class="n">tup_returned</span><span class="p">,</span>
<span class="w">          </span><span class="n">tup_fetched</span><span class="p">,</span><span class="n">tup_inserted</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tup_ins</span><span class="p">,</span>
<span class="w">          </span><span class="n">tup_updated</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tup_upd</span><span class="p">,</span><span class="n">tup_deleted</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tup_del</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_database</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pgbench&#39;</span><span class="p">;</span>

<span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blks_read</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blks_hit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tup_returned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tup_fetched</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tup_ins</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tup_upd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tup_del</span>
<span class="c1">---------+-----------+----------+--------------+-------------+---------+---------+-------------</span>
<span class="w"> </span><span class="n">pgbench</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">689749</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">11227681</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">19441670</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">1515691</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">5319222</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">635663</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">100</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>除此之外，试图还有一些有用的事务提交统计信息。</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">datname</span><span class="p">,</span><span class="n">numbackends</span><span class="p">,</span><span class="n">xact_commit</span><span class="p">,</span><span class="n">xact_rollback</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_database</span><span class="p">;</span>
<span class="w">  </span><span class="n">datname</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">numbackends</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xact_commit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xact_rollback</span>
<span class="c1">------------+-------------+-------------+---------------</span>
<span class="w"> </span><span class="n">template1</span><span class="w">  </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">26616</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">2</span>
<span class="w"> </span><span class="n">template0</span><span class="w">  </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span>
<span class="w"> </span><span class="n">postgres</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">27441</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">337</span>
<span class="w"> </span><span class="n">wgzhao</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">31578</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">302</span>
<span class="w"> </span><span class="n">test</span><span class="w">       </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">27711</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">45</span>
<span class="w"> </span><span class="n">pgbench</span><span class="w">    </span><span class="o">|</span><span class="w">           </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">840155</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">25</span>
<span class="w"> </span><span class="n">db1</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span>
<span class="w"> </span><span class="n">db2</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span>
<span class="w"> </span><span class="n">dellstore2</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">1317</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">1</span>
<span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<h3 id="_43">连接和活动<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>pg_stat_activity 提供了每一个客户端当前在服务器上的活动快照。</p>
<p>我们可以使用这个视图来查看一个后台进程运行了多久已经此刻是否正在等待什么:</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="n">waiting</span><span class="p">,</span>
<span class="w">          </span><span class="k">current_timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">least</span><span class="p">(</span><span class="n">query_start</span><span class="p">,</span><span class="n">xact_start</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">runtime</span><span class="p">,</span>
<span class="w">          </span><span class="n">substr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">current_query</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_activity</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg_backend_pid</span><span class="p">();</span>

<span class="w">  </span><span class="n">pid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">runtime</span><span class="w">     </span><span class="o">|</span><span class="w">       </span><span class="n">current_query</span>
<span class="c1">-------+---------+-----------------+---------------------------</span>
<span class="w"> </span><span class="mi">11987</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">005063</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">END</span><span class="p">;</span>
<span class="w"> </span><span class="mi">11989</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00341</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="n">SE</span>
<span class="w"> </span><span class="mi">11988</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">017561</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">END</span><span class="p">;</span>
<span class="w"> </span><span class="mi">11991</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002855</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="n">SE</span>
<span class="w"> </span><span class="mi">11990</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002629</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="n">S</span>
<span class="w"> </span><span class="mi">11992</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002998</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="n">SE</span>
<span class="w"> </span><span class="mi">11993</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002823</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_accounts</span><span class="w"> </span><span class="n">S</span>
<span class="w"> </span><span class="mi">11994</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">003072</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_branches</span><span class="w"> </span><span class="n">S</span>
<span class="w"> </span><span class="mi">11995</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002469</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="n">SE</span>
<span class="w"> </span><span class="mi">11996</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">002852</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pgbench_tellers</span><span class="w"> </span><span class="n">SE</span>
<span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<h3 id="_44">磁盘使用<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>获得一个表或者索引使用了多少磁盘空间的最基本方法是运行 pg_relation_size()函数，它经常和 pg_size_pretty()函数联合，以便输出方便阅读的大小。</p>
<p>比如下的例子就是查询当前数据库下所有的表所使用的磁盘大小：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span>
<span class="w">       </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;size&quot;</span>
<span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">C</span>
<span class="w">       </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">relnamespace</span><span class="p">)</span>
<span class="w">       </span><span class="k">where</span><span class="w"> </span><span class="n">relnamespace</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span>
<span class="w">       </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pg_catalog&#39;</span>
<span class="w">            </span><span class="k">or</span><span class="w"> </span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;informantion_schema&#39;</span><span class="p">)</span>
<span class="w">       </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="w">        </span><span class="n">relname</span><span class="w">        </span><span class="o">|</span><span class="w">  </span><span class="k">size</span>
<span class="c1">-----------------------+---------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">650</span><span class="w"> </span><span class="n">MB</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">107</span><span class="w"> </span><span class="n">MB</span>
<span class="w"> </span><span class="n">pgbench_history</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">3088</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pg_toast_2618</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">320</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">sql_features</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_tellers_pkey</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pg_toast_2619</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_branches_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span>
<span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>这个查询语句的主要问题是表大小里没有包含 TOAST 表的大笑，虽然可以使用 pg_total_relation_size()，但是她又包含了索引大小。</p>
<p>PostgreSQL
9.0 以后，有一个名为 pg_table_size()的函数包括了除索引外的所有其他表信息。而 pg_indexes_size()则给出了一个表的所有索引大小。
这些函数所计算的大小关系如下：</p>
<div class="highlight"><pre><span></span><code>    pg_total_relation_size = pg_table_size + pg_indexes_size
    pg_table_size = pg_relation_size + toast table + toast indexes + FSM
</code></pre></div>
<p>下面的查询显示了 TOAST 和索引大小:</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span><span class="n">relkind</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;type&quot;</span><span class="p">,</span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_table_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span><span class="p">,</span>
<span class="w">          </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">idxsize</span><span class="p">,</span>
<span class="w">          </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;total&quot;</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">C</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="p">.</span><span class="n">oid</span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">relnamespace</span><span class="p">)</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">relnamespace</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">11728</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">relkind</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
<span class="w">          </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="k">C</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="w">        </span><span class="n">relname</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">size</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">idxsize</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">total</span>
<span class="c1">-----------------------+------+---------+---------+---------</span>
<span class="w"> </span><span class="n">pgbench_accounts</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">650</span><span class="w"> </span><span class="n">MB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">107</span><span class="w"> </span><span class="n">MB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">757</span><span class="w"> </span><span class="n">MB</span>
<span class="w"> </span><span class="n">pgbench_accounts_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">107</span><span class="w"> </span><span class="n">MB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">107</span><span class="w"> </span><span class="n">MB</span>
<span class="w"> </span><span class="n">pgbench_history</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">3112</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">3112</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_tellers</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">112</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_branches</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_tellers_pkey</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">kB</span>
<span class="w"> </span><span class="n">pgbench_branches_pkey</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">kB</span>
<span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<h3 id="checkpoint">缓存,后台写以及 checkpoint<a class="headerlink" href="#checkpoint" title="Permanent link">&para;</a></h3>
<p>pg_stat_bgwriter 可以让我们追踪每个数据页在缓存内外的流向，我们可以通过查询该视图回答下面的问题：</p>
<ul>
<li>
<p>执行 checkpoint 的时间中，基于活动的请求占比多少，基于时间间隔的比例又是多少？</p>
</li>
<li>
<p>平均 checkpoint 写出多少数据？</p>
</li>
<li>
<p>写出的数据中，checkpoint 和后台写分别占比多少？</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">#</span><span class="k">SELECT</span>
<span class="w">  </span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">)</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_req_pct</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span>
<span class="w">       </span><span class="n">checkpoints_req</span><span class="p">))</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_checkpoint_write</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">block_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">       </span><span class="n">buffers_backend</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_written</span><span class="p">,</span>
<span class="w">  </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">      </span><span class="n">buffers_backend</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoint_write_pct</span><span class="p">,</span>
<span class="w">  </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffers_backend</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="n">buffers_backend</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">backend_write_pct</span><span class="p">,</span>
<span class="w">  </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_bgwriter</span><span class="p">,(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;block_size&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span>
<span class="w">     </span><span class="k">AS</span><span class="w"> </span><span class="n">block_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bs</span><span class="p">;</span>

<span class="o">-</span><span class="p">[</span><span class="w"> </span><span class="n">RECORD</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="c1">---------+------------------------------</span>
<span class="n">checkpoints_req_pct</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span>
<span class="n">avg_checkpoint_write</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">742</span><span class="w"> </span><span class="n">kB</span>
<span class="n">total_written</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">4588</span><span class="w"> </span><span class="n">MB</span>
<span class="n">checkpoint_write_pct</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">43</span>
<span class="n">backend_write_pct</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">56</span>
<span class="n">checkpoints_timed</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">2713</span>
<span class="n">checkpoints_req</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">38</span>
<span class="n">checkpoint_write_time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2475096</span>
<span class="n">checkpoint_sync_time</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">253253</span>
<span class="n">buffers_checkpoint</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">255206</span>
<span class="n">buffers_clean</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span>
<span class="n">maxwritten_clean</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span>
<span class="n">buffers_backend</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">332040</span>
<span class="n">buffers_backend_fsync</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span>
<span class="n">buffers_alloc</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">503829</span>
<span class="n">stats_reset</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="mi">2012</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">14</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">19</span><span class="p">.</span><span class="mi">529427</span><span class="o">+</span><span class="mi">08</span>
<span class="n">block_size</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">8192</span>
</code></pre></div>
<p>从这个结果来看，只有 1%的 checkpoint 是因为达到了 WAL 达到了需要写出的要求，而绝大部分 checkpoint 都是因为 checkpoint_timeout 参数所设置的
间隔时间来临而执行的。</p>
<p>checkpoint 平均写出的数据是 742KB，相当小。</p>
<p>56%的数据写出是后台写进程，这暗示这系统的配置还不足够好，我们应该更多使用 checkpoint 来写出数据。发生这个情况的原因可能是 shared_buffers 配得小了点。</p>
<h3 id="pg_stat_bgwriter">保存 pg_stat_bgwriter 快照<a class="headerlink" href="#pg_stat_bgwriter" title="Permanent link">&para;</a></h3>
<p>为了使上述统计数据更有用，我们可以定期保存快照，我们只需要创建一个表，然后把快照写入表即可，类似如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">pg_stat_bgwriter_snapshot</span><span class="w"> </span><span class="k">as</span>
<span class="w">          </span><span class="k">select</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_bgwriter</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="n">pgbench</span><span class="o">=#</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">pg_stat_bgwriter_snapshot</span>
<span class="w">         </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_bgwriter</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>我们应该至少保存一个小时的快照信息，一天更好。这样我们才有可能通过这些快照获得一些更有用的信息，比如：</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">  </span><span class="k">cast</span><span class="p">(</span><span class="n">date_trunc</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span><span class="k">start</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">start</span><span class="p">,</span>
<span class="w">  </span><span class="n">date_trunc</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">elapsed</span><span class="p">,</span>
<span class="w">  </span><span class="n">date_trunc</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span><span class="n">elapsed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span>
<span class="w">    </span><span class="n">avg_checkpoint_interval</span><span class="p">,</span>
<span class="w">  </span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">)</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_req_pct</span><span class="p">,</span>
<span class="w">  </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">     </span><span class="n">buffers_backend</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoint_write_pct</span><span class="p">,</span>
<span class="w">  </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffers_backend</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">       </span><span class="n">buffers_backend</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">backend_write_pct</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span>
<span class="w">      </span><span class="n">checkpoints_req</span><span class="p">))</span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_checkpoint_write</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">block_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">      </span><span class="n">buffers_backend</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="n">epoch</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">int8</span><span class="p">))</span>
<span class="w">          </span><span class="k">AS</span><span class="w"> </span><span class="n">written_per_sec</span><span class="p">,</span>
<span class="w">  </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">block_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">buffers_alloc</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="n">epoch</span><span class="w"> </span><span class="k">FROM</span>
<span class="w">      </span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">int8</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">alloc_per_sec</span>
<span class="k">FROM</span>
<span class="p">(</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="n">one</span><span class="p">.</span><span class="n">now</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">start</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">now</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">elapsed</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_timed</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">checkpoints_req</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">checkpoints_req</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">buffers_checkpoint</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_checkpoint</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">buffers_clean</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">buffers_clean</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_clean</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">maxwritten_clean</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">maxwritten_clean</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">maxwritten_clean</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">buffers_backend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">buffers_backend</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_backend</span><span class="p">,</span>
<span class="w">  </span><span class="n">two</span><span class="p">.</span><span class="n">buffers_alloc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">buffers_alloc</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buffers_alloc</span><span class="p">,</span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;block_size&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">integer</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">block_size</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_bgwriter_snapshot</span><span class="w"> </span><span class="n">one</span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_stat_bgwriter_snapshot</span><span class="w"> </span><span class="n">two</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">two</span><span class="p">.</span><span class="n">now</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">one</span><span class="p">.</span><span class="n">now</span>
<span class="p">)</span><span class="w"> </span><span class="n">bgwriter_diff</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints_timed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">checkpoints_req</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">start</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="mi">2010</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">09</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">00</span>
<span class="n">elapsed</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">54</span>
<span class="n">avg_checkpoint_interval</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">34</span>
<span class="n">checkpoints_req_pct</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">80</span>
<span class="n">checkpoint_write_pct</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">85</span>
<span class="n">backend_write_pct</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">14</span>
<span class="n">avg_checkpoint_write</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="n">MB</span>
<span class="n">written_per_sec</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="n">kB</span>
<span class="n">alloc_per_sec</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">kB</span>
</code></pre></div>
<p>从输出来看，有 80%的 checkpoint 被调用，因为系统写满了 WAL,checkpoint 的调用平均间隔时间为 3.5 分钟，相当频繁。幸运的是，大部分缓存都被写出；
85%的缓存有 checkpoint 写出，这很好，因为 checkpoint 写算是最有效率的一种。每一个 checkpint 平均写出 17MB 数据。但是你计算所有的写操作，返现写到磁盘的速率
只有 94kB/s，这相当低。在读方面，缓存中 13kB/s 的速度被数据库分配用来满足查询要求。</p>
<p>对于一个持续 46 分钟的快照输出如下,这个阶段基本上处于空闲状态:</p>
<div class="highlight"><pre><span></span><code>start                   | 2010-04-09 20:10:00
elapsed                 | 00:46:26
avg_checkpoint_interval | 00:05:09
checkpoints_req_pct     | 0
checkpoint_write_pct    | 100
backend_write_pct       | 0
avg_checkpoint_write    | 910 bytes
written_per_sec         | 3 bytes
alloc_per_sec           | 0 bytes
</code></pre></div>
<p>注意到 checkpoint 的平均间隔是 5 分钟，而这恰好是 checkpoint_timeout 值，这说明这些 checkpoint 完全是由超时驱动。</p>
<p>这里的 alloc_per_sec 比率并不正好同等于从 OS 缓存的读取率，不过它暗示了内部缓存被重用的频率。</p>
<p>written_per_sec 值是把数据库表和索引写入到磁盘的平均值，它应该非常接近操作系统系统的平均写入磁盘的数值。</p>
<h3 id="_45">使用后台写统计调优<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>利用后台写统计信息来调整和 checkpoint 以及缓存的流程如下：</p>
<ol>
<li>
<p>定期收集 pg_stat_bgwriter 快照，这样就获得一个性能基线，此后，每次修改参数，重新产生快照，进行对比。依次循环，找到最优参数</p>
</li>
<li>
<p>增加 checkpoint_segments 值直到几乎所有的 checkpoints 都是按超时驱动的，而不是按 activity 驱动。最终，90%以上应该基于超时
    而 avg_checkpoint_interval 应该接近 5 分钟（或者是你设置的 checkpoint_timeout 值）</p>
</li>
<li>
<p>增加 shared_buffers 值在物理内存的 25%以上，而后参考快照，修改该参数</p>
</li>
<li>
<p>当你的系统有效的使用大缓存时，checkpoint(不是 backends 或 background
    writer)执行时，缓存的百分比也应该增加，而总的 I/O
    written_per_sec 参数应该下降。
    如果最后是通过修改 shared_buffers 来达到这个标准，则需要返回步骤 3，重复这些步骤，知道性能曲线趋平。</p>
</li>
<li>
<p>如果 shared_buffers 修改的值不是那么显著，则说明之前的值对目前的工作负荷足够了。</p>
</li>
<li>
<p>现在你有了较好的 checkpoint_segements 和 shared_buffers 值。如果写出数据的大部分都来自 buffers_checkpoint，且 written_per_sec 显示的平均 I/O 看上去比较高（或者是执行写操作时，系统明显显得慢），
    应考虑增加 checkpoint_timeout 值，如果增加了，则需要重复上述流程。</p>
</li>
</ol>
<h2 id="_46">监控和趋势分析<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h2>
<p>数据的性能直接和它底层的操作系统性有关联，而操作系统的性能又和底层的硬件有关联。因此只有这三者都处于工作良好的状态，才会有好的性能。</p>
<p>这就需要你有一个好的监控系统，用来获取所有层面的正确信息，然后做出正确的判断，并且可以预测什么系统系统会达到其负载极限，参数的改变是否对系统的提升长生了效果。</p>
<h3 id="unix_1">unix 监控工具<a class="headerlink" href="#unix_1" title="Permanent link">&para;</a></h3>
<p>这里主要介绍了 vmstat,iostat 工具的介绍和使用，这部分可以参考<a href="http://blog.wgzhao.com/2012/08/22/some-way-to-io-statistics-on-linux/">Linux 下的一些 I/O 统计工具</a>一文</p>
<h3 id="_47">超负荷的系统例子<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>下面给出的例子中，数据库目录对应的磁盘布局是:</p>
<ul>
<li>
<p>pg_xlog: /dev/sdf1</p>
</li>
<li>
<p>data: /dev/md0 Linux 软 RAID0，由 sdc1,sdd1 和 sde1 组成</p>
</li>
</ul>
<p>为了加大系统的负载，我们还是用 pgbench 做测试，把 scale 设到 1000，客户端数设置到 64:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pgbench<span class="w"> </span>-i<span class="w"> </span>-s<span class="w"> </span><span class="m">1000</span><span class="w"> </span>pgbench
$<span class="w"> </span>pgbench<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span><span class="w"> </span>-c<span class="w"> </span><span class="m">64</span><span class="w"> </span>-T<span class="w"> </span><span class="m">300</span><span class="w"> </span>pgbench
</code></pre></div>
<p>在测试过程中，我们抓取 vmstat 一段时间的输出:</p>
<div class="highlight"><pre><span></span><code>procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa
 2 45      0 128464   5608 2787264    0    0  1462 17739 1586 2984  4  4  0 93
 0 31      0 125356   5616 2789904    0    0  1232  1384 1591 3020  4  2  0 95
 0 44      0 121628   5616 2793660    0    0  1712  2152 1984 3953  4  3  0 93
 0 39      0 117164   5616 2797724    0    0  2144  1856 2270 4414  4  2  0 94
 0 43      0 112452   5616 2802036    0    0  2128  2224 2252 4514  4  3  0 93
 0 53      0 107376   5620 2806572    0    0  2576  2101 2060 4149  4  4  0 93
 0  1      0 119412   5520 2791864    0    0  1322 17266 2028 3780  4  3 13 81
 0  3      0 119048   5552 2789328    0    0    72  2426  801 1151  2  2 36 61
 0 26      0 103904   5628 2809296    0    0  1400  1396 2048 3909  5  3  0 93
 0 56      0 128208   5516 2785068    0    0  1808  1952 1546 3110  3  3 10 84
 0 59      0 124148   5516 2789132    0    0  2008  2240 2251 4595  3  2  0 95
</code></pre></div>
<p>从输出来看，cs 值的显著降低使得整个系统的吞吐也下来了。这里有点困惑的是，与此同时，wa 值也下来了也下来了，这是一个典型的场景，当系统负载太高时，它会因为
索资源竞争的原因而拒绝客户端的请求。我们从 cs 的最低点(1151)也能看出，其客户端进程非常少，仅有 1 个(对应行的 b 列显示)。这很有可能的原因是磁盘控制器的 cache 已经填满了，客户端都在等待
WAL 数据写回磁盘。</p>
<p>有时，系统慢有可能单纯是 I/O 吞吐原因，比如像下面的输出：</p>
<div class="highlight"><pre><span></span><code># iostat –x 5
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           5.21    0.00    2.80   91.74    0.25    0.00
Device rsec/s    wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sdc1  2625.60   2057.60    14.67    38.79  101.47   3.14 100.08
sdd1  2614.40   2000.00    14.90    57.96  162.95   3.23 100.08
sde1  2736.00   1963.20    14.64    48.50  135.26   3.12 100.00
md0   7916.80   7206.40    10.60     0.00    0.00   0.00   0.00
sdf1     0.00  22190.40    50.20     0.84    1.79   1.34  59.20
</code></pre></div>
<p>WAL 的写速大约 11MB/s。与此同时，数据库磁盘(md0)利用率达到 100%，然而读写速度只有 8MB/s(读+写)，这很可能此时数据库有很繁重随机 I/O，
而底层磁盘的随机 I/O 能力也就是 2MB/s 的样子。</p>
<p>这个数据库过程很有可能是 checkpoint 同步阶段，当大量的随机 I/O 写满磁盘缓存后，开始强制写入到磁盘。</p>
<p>我们还可以看下面更极端的例子，我们把 scale 设置到 4000</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pgbench<span class="w"> </span>-i<span class="w"> </span>-s<span class="w"> </span><span class="m">4000</span><span class="w"> </span>pgbench
$<span class="w"> </span>pgbench<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span><span class="w"> </span>-c<span class="w"> </span><span class="m">64</span><span class="w"> </span>-T<span class="w"> </span><span class="m">300</span><span class="w"> </span>pgbench
</code></pre></div>
<p>执行期间，抓取一段时间的 vmstat 输出如下：</p>
<div class="highlight"><pre><span></span><code># vmstat 1
procs ----io---- --system--- -----cpu-------
￼r  b   bi    bo    in    cs    us sy id  wa st
1  63  5444  9864   8576 18268  4   3  0   92  0
0  42  4784  13916  7969 16716  4   2  3   90  0
0  59  464   4704   1279  1695  0   0 25   75  0
0  54  304   4736   1396  2147  0   0 25   74  0
0  42  264   5000   1391  1796  0   0 10   90  0
0  42  296   4756   1444  1996  1   0 10   89  0
0  29  248   5112   1331  1720  0   0 25   75  0
0  47  368   4696   1359  2113  0   0 23   76  0
1  48  344   5352   1287  1875  0   0  0   100 0
0  64  2692  12084  5604  9474  8   2  0   90  0
1  63  5376  9944   8346 18003  4   3  20  74  0
0  64  5404  10128  8890 18847  4   3  25  67  0
</code></pre></div>
<p>这里有 8 秒的时间间隔内，系统性能严重下降。cpu 耗时中，几乎没有 user
time。这符合所有客户端整等待某些资源的场景。这个场景出现的原因
在这儿很显然，wa 值很高，甚至到 100%，这说明服务器无法跟上磁盘 I/O 加载。</p>
<p>我们可以通过 iostat 的扩展选项查询此时磁盘负载在做些什么：</p>
<div class="highlight"><pre><span></span><code># iostat –x 5
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.35    0.00    1.85   85.49    0.15   10.16
Device rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sdc1  2310.40  1169.60    14.63    39.85  147.59   4.21 100.00
sdd1  2326.40  1216.00    14.53    71.41  264.60   4.10 100.00
sde1  2438.40  1230.40    14.77    47.88  157.12   4.01  99.60
md0   7044.80  4820.80    11.12     0.00    0.00   0.00   0.00
sdf1     0.00 19040.00    70.31     4.20   15.31   2.10  56.88
</code></pre></div>
<p>输出显示读写速度很低，但是磁盘利用率达到了 100%，注意 await 指标，这么高的值表明磁盘等待时间过长，说明磁盘寻道时间占比很大，因而可以推断
随机读写占比很高。</p>
<h3 id="windows">windows 监控工具<a class="headerlink" href="#windows" title="Permanent link">&para;</a></h3>
<p>任务管理器是 Windows 系统下最简单和常用的系统监控工具，它提供了类似 UNIX
top 工具的输出视图。</p>
<p>如果需要功能强大一点的，可以从微软内部工具箱下载<a href="http://technet.microsoft.com/en-us/sysinternals/bb896653">进程浏览工具</a>以及
<a href="http://technet.microsoft.com/en-us/sysinternals/bb896645">进程监控工具</a>。相关用法可以参考工具自带的手册。</p>
<p>如果需要保存这些监控信息，类似 UNIX 的 sar 工具一样，微软也提供详细的指南，不同系统版本提供的方式不同，分列如下：</p>
<ul>
<li>
<p>Windows 2000,XP,Server 2003:
  <a href="http://support.microsoft.com/kb/248345">http://support.microsoft.com/kb/248345</a></p>
</li>
<li>
<p>Vista:
  <a href="http://technet.microsoft.com/en-us/library/cc722173(WS.10).aspx">http://technet.microsoft.com/en-us/library/cc722173(WS.10).aspx</a></p>
</li>
<li>
<p>Windows 7,Windows Server 2008 R2:
  <a href="http://technet.microsoft.com/en-us/library/dd744567(WS.10).aspx">http://technet.microsoft.com/en-us/library/dd744567(WS.10).aspx</a></p>
</li>
</ul>
<h3 id="_48">趋势分析软件<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>列举如下，具体的用法参考对应工具的问题：</p>
<ul>
<li>
<p>MRTG,RRDTool:
  这两个算是基础工具，用于数据的展现，可作为其他软件的附加组件</p>
</li>
<li>
<p>Nagios:
  最常用的监控 PostgreSQL 的工具，内置了对 PostgreSQL 的监控插件<a href="http://bucardo.org/wiki/Check_postgres">check_postgres</a></p>
</li>
<li>
<p>Cacti:
  也是非常流行的开源监控软件，它严重依赖 web 应用技术以及 RRDTool 工具，目前它内置的 PostgreSQL 监控工具还比较粗造，且还在开发中。详细的可以
  参考这个文档<a href="http://wiki.postgresql.org/wiki/Cacti">http://wiki.postgresql.org/wiki/Cacti</a></p>
</li>
<li>
<p>Munin:
  相比 Nagios 和 Cacti，Munin 更小而且更新，它采用了和 Cacti 相同的 RRDTool 数据分析结构，它还可以集成到 Nagios 的报警结构中。针对 PostgreSQL 的监控插件
  是<a href="http://muninpgplugins.projects.postgresql.org/">http://muninpgplugins.projects.postgresql.org/</a></p>
</li>
<li>
<p>pgstatspack:
  这算是针对 PostgreSQL 的一个组件包，它的功能类似 pg_stat_bgwriter 试图--用于保存 PostgreSQL 定期的统计嘻嘻到数据库表里--以便以后分析。它的设计来源于
  针对 Oracle 的一个非常流程的工具包 statspack。可以通过<a href="http://pgstatspack.projects.postgresql.org/">官方网站</a>了解更多，这里有一篇不错的<a href="http://www.fuzzy.cz/en/articles/db-tuning-using- pgstatspack/">介绍文章</a>。</p>
</li>
<li>
<p>Zenoss:
  Zenoss 相比上面提到的产品配置起来麻烦一点，它的核心是一套开源的监控解决方案，公司也提供了商业授权的企业版。它通过称为 Zenpack 的捆绑扩展组建来
  提供对服务提供监控和分析功能。最新发布的 PostgreSQL
  ZenPack 可以从下面的链接找到：<a href="http://community.zenoss.org/docs/DOC-3389">http://community.zenoss.org/docs/DOC-3389</a></p>
</li>
<li>
<p>Hyperic HQ:
  商业产品，集成了 PostgreSQL 监控,但支持的版本很低，目前仅支持到 8.3，具体可以参考这里<a href="http://www.hyperic.com/products/postgresql-monitoring">http://www.hyperic.com/products/postgresql-monitoring</a></p>
</li>
</ul>
<h3 id="_49">总结<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<h2 id="_50">连接池和缓存<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h2>
<h3 id="_51">连接池<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>连接池位于应用程序和数据库中间，连接到数据库的会话数固定，一般低于 100，运行期间，这些连接一直都保持。当应用程序有新的请求时，连接池的连接可以被重用。
PostgreSQL 里的 DISCARD
ALL 命令可以刷新一个新连接。当客户端断开时，连接池只是重置会话，并不实际从数据库断开。</p>
<p>连接池的数量在绝大部分场景下依赖于 CPU 的核数、数据库使用多少内存作为缓存以及底层磁盘的速度。</p>
<p>大部分用户认为最佳的连接池数量在 CPU 核数的 2 到 3 倍中间，如果你系统所带的磁盘很多，可以考虑比这个数大一点。</p>
<p>一般的一个迭代技术就是先把连接数设置为 100，然后根据系统的负载做调整。</p>
<h4 id="pgpool-ii">pgpool-II<a class="headerlink" href="#pgpool-ii" title="Permanent link">&para;</a></h4>
<p><a href="http://www.pgpool.net/mediawiki/index.php/Main_Page">pgpool</a>是 PostgreSQL 上最老的连接池组件，目前还在持续开发中。pgpool-II 相比原来的版本在各方面都有了改进。</p>
<p>它的主要目的不仅仅是做连接池，它还可以提供负载均衡以及复制相关的功能。它甚至还支持某些并行查询设置。以下是它提供的一些功能的描述：</p>
<dl>
<dt>连接池</dt>
<dd>
<p>pgpool-II 保持已经连接到 PostgreSQL 服务器的连接，
并在使用相同参数（例如：用户名，数据库，协议版本）
连接进来时重用它们。 它减少了连接开销，并增加了系统的总体吞吐量。</p>
</dd>
<dt>复制</dt>
<dd>
<p>pgpool-II 可以管理多个 PostgreSQL 服务器。
激活复制功能并使在 2 台或者更多 PostgreSQL
节点中建立一个实时备份成为可能，
这样，如果其中一台节点失效，服务可以不被中断继续运行。</p>
</dd>
<dt>负载均衡</dt>
<dd>
<p>如果数据库进行了复制（可能运行在复制模式或者主备模式下），
则在任何一台服务器中执行一个 SELECT 查询将返回相同的结果。 pgpool-II
利用了复制的功能以降低每台 PostgreSQL 服务器的负载。 它通过分发
SELECT 查询到所有可用的服务器中，增强了系统的整体吞吐量。
在理想的情况下，读性能应该和 PostgreSQL 服务器的数量成正比。
负载均很功能在有大量用户同时执行很多只读查询的场景中工作的效果最好。</p>
</dd>
<dt>限制超过限度的连接</dt>
<dd>
<p>PostgreSQL
会限制当前的最大连接数，当到达这个数量时，新的连接将被拒绝。
增加这个最大连接数会增加资源消耗并且对系统的全局性能有一定的负面影响。
pgpoo-II
也支持限制最大连接数，但它的做法是将连接放入队列，而不是立即返回一个错误。</p>
</dd>
<dt>并行查询</dt>
<dd>
<p>使用并行查询时，数据可以被分割到多台服务器上，
所以一个查询可以在多台服务器上同时执行，以减少总体执行时间。
并行查询在查询大规模数据的时候非常有效。</p>
</dd>
</dl>
<p>pgpool-II 使用 PostgreSQL
的前后台程序之间的协议，并且在前后台之间传递消息。
因此，一个（前端的）数据库应用程序认为 pgpool-II 就是实际的 PostgreSQL
数据库， 而后端的服务进程则认为 pgpool-II 是它的一个客户端。 因为
pgpool-II 对于服务器和客户端来说是透明的，
现有的数据库应用程序基本上可以不需要修改就可以使用 pgpool-II 了。</p>
<h4 id="pgbouncer">pgBouncer<a class="headerlink" href="#pgbouncer" title="Permanent link">&para;</a></h4>
<p><a href="http://pgfoundry.org/projects/pgbouncer/">p</a>gBouncer 是 PostgreSQL 里能提高最高效率的连接池组件，该组件最初是 Skype 作为数据库扩展功能开发的。</p>
<p>pgBouncer 是单进程程序，针对每个连接并不长生新进程，其底层架构上依赖 UNIX 平台的 libevent 动态库，其内部的队列管理可以配置，以避免出现超时现象。</p>
<p>pgBouncer 会创建 pgbouncer 数据库，可以使用标准的 pgsql 工具连接到该库，也可以使用 SHOW 命令来获得有关连接池的内部信息。其终端接口接受像 PAUSE，RESUME 这样的命令来控制连接池。</p>
<p>pgBouncer 的另外一个特性是它支持对多个数据库服务器的连接。这就使得你的系统负载有可能分散到多个数据库服务器节点上。</p>
<p>如果你的有几百或者上千的连接数，他们超过了你服务器上 CPU 的个数，那么 pgBouncer 是你的第一考虑。</p>
<h4 id="_52">应用服务器连接池<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<p>有的应用程序可能并不需要数据库层面的连接池，它偏向于使用自己的连接池，大部分流行的 Java 应用服务，包括 Tomcat,JBoss 等，都有自己的连接池组件。
比如 Tomcat 就使用称为 DBCP(Database Connection
Pool)的组件，另外，基于 Java 的开源连接池软件也很多，<a href="http://java-source.net/open-source/connection-pools">这个链接</a>你可以看到这些描述。</p>
<h2 id="_53">复制扩展<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h2>
<p>复制可以使得数据库数据存在多个节点上，提高查询性能，至于写，Postgres-XC 项目这致力于这点。</p>
<h3 id="_54">热备<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>PostgreSQL 从 8.2 版本开始就已经内置了备机(standby)特性，它允许创建主备(master/standby)节点,备机定期从主机接收数据库更新日志并应用这些日志。
如果主机因为各种原因失效，备机可以快速替代主机。</p>
<p>更深入理解热备，需要我们先了解下面的一些术语：</p>
<dl>
<dt>Write-ahead log(WAL)</dt>
<dd>
<p>:
预写日志，每个 WAL 大小为 16MB。如果有两台数据库开始都是一样，然后应用相同的 WAL 后，他们还是相同的，因为 WAL 包含了所有改变的数据。</p>
</dd>
<dt>Base backup</dt>
<dd>
<p>包括所有数据库崩溃后能够完整恢复的数据库备份。它一般使用 pg_start_backup 和 pg_stop_backup 指令来进行悲愤，它等于把整个数据库以及在备份期间有所改变而写入 WAL 文件全部备份一套。</p>
</dd>
<dt>Point-in-time recovery(PITR)</dt>
<dd>
<p>如果你有基本备份(base
backup)以及一系列 WAL 文件，那你就应用基础备份以及一部分 WAL 文件从而实现按时点恢复特性。</p>
</dd>
<dt>File-based log shipping</dt>
<dd>
<p>如果你数据库做一个基础备份(base
backup)，然后把所有的 WAL 文件传输到另外一个服务器上，那么新的服务器可以和原来那台保持同步</p>
</dd>
<dt>standby</dt>
<dd>
<p>有完整的基础备份(base
backup)以及机遇文件的日志流传输，这个系统称之为备机(standby),只要 WAL 可以持续传输，standby 可以和主机保持同步。</p>
</dd>
<dt>Failover</dt>
<dd>
<p>把备机从恢复模式切换到 active 状态，我们把这个过程称为失效切换。</p>
</dd>
</dl>
<h3 id="_55">总结<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p><strong>Program</strong> <strong>Relication Method</strong> <strong>Synchronization</strong></p>
<hr />
<p>WAL Shipping Master/Slave Async
Slony Master/Slave Async
Londiste Master/Slave Async
Mammoth Master/Slave Async
Bucardo Master/Slave or Master/Master Async
Rubyrep Master/Slave or Master/Master Async
PgCluster Master/Master Sync
Postgres-XC Master/Master Sync
pgpool-II Statement-based middleware Sync</p>
<p>上述这么多主/从复制解决方案中的主要不同在于数据库的修改数据如何传递</p>
<ul>
<li>
<p>PostgreSQL 9.0 的 Hot Standby 主要用于高可用失效切换</p>
</li>
<li>
<p>WAL 用于为备机数据库创建修改的日志块，它只能完整应用，不用应用 WAL 子集</p>
</li>
<li>
<p>使用日志传输复制会在主机和备机中产生归档延迟，虽然这点在 Postgresql
  9.0 里使用流复制(Stream Replication)特新得以优化，但还无法完全避免。</p>
</li>
<li>
<p>Hot
  Standby 系统可以针对快速失效切换，长时间查询执行以及对主机最小影响三个方面进行优化。但同一时刻只能优化这三种的两种。</p>
</li>
<li>
<p>基于语句的数据库复制反而更灵活，还能用来升级版本。但有些语句并不容易复制，而且相比 WAL 传输有更高的开销。</p>
</li>
<li>
<p>Slony 和 Londiste 都是使用触发器提取更新语句的成熟解决方案。</p>
</li>
<li>
<p>pgpool-II 可以用来做多从节点的只读负载均衡，同时也可以做某些同步复制</p>
</li>
<li>
<p>Bucardo 支持多主结构，不管这些节点是否一直都在线。</p>
</li>
</ul>
<h2 id="_56">数据分区<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h2>
<p>当表一个自身比物理内存还大时，即便索引很好，查询该表的时间也会显著增加。此时一个自然的办法是把这个表划分成几个小的相关表。应用程序不修改修改，还是查询原来的表。
但到数据库层，则只是查询该表的子集而不是全部。</p>
<h3 id="_57">范围分区<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>我们使用第<a href="#sec:query optimization">10</a>{reference-type="ref"
reference="sec:query optimization"}章里提到的 Dell Store 2
数据库做例子，考虑 orders 表的结构：</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">orders</span>
<span class="w"> </span><span class="k">Table</span><span class="w"> </span><span class="ss">&quot;public.orders&quot;</span>
<span class="w">   </span><span class="k">Column</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="k">Type</span><span class="w">      </span><span class="o">|</span><span class="w">                        </span><span class="n">Modifiers</span>
<span class="c1">-------------+---------------+----------------------------------------------------------</span>
<span class="w"> </span><span class="n">orderid</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;orders_orderid</span>
<span class="s1">                                _seq&#39;</span><span class="p">::</span><span class="n">regclass</span><span class="p">)</span>
<span class="w"> </span><span class="n">orderdate</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">date</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="w"> </span><span class="n">customerid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w">       </span><span class="o">|</span>
<span class="w"> </span><span class="n">netamount</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="w"> </span><span class="n">tax</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="w"> </span><span class="n">totalamount</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="n">Indexes</span><span class="p">:</span>
<span class="w">    </span><span class="ss">&quot;orders_pkey&quot;</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="p">)</span>
<span class="w">    </span><span class="ss">&quot;ix_order_custid&quot;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span>
<span class="k">Foreign</span><span class="o">-</span><span class="k">key</span><span class="w"> </span><span class="k">constraints</span><span class="p">:</span>
<span class="w">    </span><span class="ss">&quot;fk_customerid&quot;</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span>
<span class="n">Referenced</span><span class="w"> </span><span class="k">by</span><span class="p">:</span>
<span class="w">    </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;orderlines&quot;</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="ss">&quot;fk_orderid&quot;</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="p">)</span>
<span class="w">    </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">orderid</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span>
</code></pre></div>
<p>假设这个表随着时间推移，该表迅速膨胀，比如达到一亿条记录，或者说其大小超过了物理内存，此时我们要考虑对此表进行分区。
这里重点要考虑的是依据那个字段进行分区，比如这里有两个字段可以分区，一个是 orderid，一个是 orderdate。似乎两个都可行。
但是考虑到一个问题，订单只保留一段时间，比如 1，2 年。老的订单就需要删除。当大量的老订单删除时，必然就需要执行 vacuum。从而导致开销增加。
如果是依据 orderdate 分区，当需要删除老数据时，直接 DROP 掉包含老数据的分区就好了，这样效率就高很多。
因此这里选择 orderdate 作为分区字段更好。</p>
<p>接下来就要计算一个分区里应该包含多少数据，首先看看这个表的相关信息：</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">orderdate</span><span class="p">),</span><span class="k">max</span><span class="p">(</span><span class="n">orderdate</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w">    </span><span class="k">min</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="k">max</span>
<span class="c1">------------+------------</span>
<span class="w"> </span><span class="mi">2004</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2004</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>作为演示数据，这里的数据只有 1 年的，因此我们按照月来分区。</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">orderdate</span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-01-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-02-01&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">inherits</span><span class="p">(</span><span class="n">orders</span><span class="p">);</span>

<span class="p">...</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="p">(</span>
<span class="w">   </span><span class="k">check</span><span class="p">(</span><span class="n">orderdate</span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-12-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2005-01-01&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">inherits</span><span class="p">(</span><span class="n">orders</span><span class="p">);</span>
</code></pre></div>
<p>这些分区表只是继承了主表的字段，还需要增加索引，约束以及调整和主表相匹配的权限。</p>
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="n">orders_2004_01</span>
<span class="w">    </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">orders_2004_01_pkey</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="p">);</span>
<span class="p">...</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="n">orders_2004_12</span>
<span class="w">    </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">orders_2004_12_pkey</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_orders_2004_01_custid</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders_2004_01</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">);</span>

<span class="p">....</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_orders_2004_12_custid</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders_2004_12</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">);</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">fk_2004_01_customerid</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span>
<span class="w">    </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>

<span class="p">...</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">fk_2004_12_customerid</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span>
<span class="w">   </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">customerid</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</code></pre></div>
<p>到此为止，表结构都已经有了，下一步就是确保插入到主表的数据都插入到对应的分区表中，我们建议使用触发器来实现这个功能：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">orders_insert_trigger</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w">  </span><span class="err">$</span><span class="n">body$</span>
<span class="k">BEGIN</span>
<span class="k">IF</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-12-01&#39;</span><span class="w"> </span><span class="k">AND</span>
<span class="w">          </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2005-01-01&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">         </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>
<span class="w"> </span><span class="k">ELSIF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-11-01&#39;</span><span class="w"> </span><span class="k">AND</span>
<span class="w">          </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-12-01&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">         </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders_2004_11</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>

<span class="p">...</span>

<span class="w"> </span><span class="k">ELSIF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-00-01&#39;</span><span class="w"> </span><span class="k">AND</span>
<span class="w">         </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-01-01&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">         </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders_2004_11</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>

<span class="k">ELSE</span>
<span class="w">         </span><span class="n">RAISE</span><span class="w"> </span><span class="k">EXCEPTION</span><span class="w"> </span><span class="s1">&#39;Error in orders_insert_trigger():    date out of range&#39;</span><span class="p">;</span>
<span class="w">     </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">     </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="w"> </span><span class="k">END</span><span class="p">;</span>
<span class="w"> </span><span class="err">$</span><span class="n">body$</span>
<span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>
</code></pre></div>
<p>这个触发器是静态的，每次都会执行相同的语句，而且不容易扩展，我们可以改造为动态触发器，类似下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">orders_insert_trigger</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$</span><span class="n">body$</span>
<span class="k">DECLARE</span>
<span class="w">    </span><span class="n">ins_sql</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="n">ins_sql</span><span class="w"> </span><span class="p">:</span><span class="o">=</span>
<span class="w">        </span><span class="s1">&#39;INSERT INTO orders_&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">to_char</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;YYYY_MM&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="s1">&#39;(orderid,orderdate,customerid,netamount,tax,totalamount)</span>
<span class="s1">          VALUES &#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="s1">&#39;(&#39;</span><span class="o">||</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">orderid</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">quote_literal</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">orderdate</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;,&#39;</span>
<span class="w">           </span><span class="o">||</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">customerid</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;,&#39;</span><span class="o">||</span>
<span class="w">        </span><span class="k">NEW</span><span class="p">.</span><span class="n">netamount</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;,&#39;</span><span class="o">||</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">tax</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">totalamount</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">ins_sql</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$</span><span class="n">body$</span>
<span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>
</code></pre></div>
<p>而后把这个触发器应用到主表 orders 上:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">insert_orders_trigger</span>
<span class="w">    </span><span class="k">BEFORE</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">orders_insert_trigger</span><span class="p">();</span>
</code></pre></div>
<p>除了用触发器这种方法来重定向数据的插入外，我们还可以利用规则(rule)来做到这点，就像下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">RULE</span><span class="w"> </span><span class="n">orders_2004_01_insert</span><span class="w"> </span><span class="k">AS</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span>
<span class="w">         </span><span class="p">(</span><span class="w"> </span><span class="n">orderdate</span><span class="o">&gt;=</span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-01-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">orderdate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="s1">&#39;2004-02-01&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">DO</span><span class="w"> </span><span class="k">INSTEAD</span>
<span class="w">         </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>
</code></pre></div>
<p>在数据批量加载时，规则相比触发器更快。不过使用规则的是个弱点就是无法使用 COPY 指令来加载数据。</p>
<h3 id="_58">现场迁移到分区表<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>现在所有的分区表以及表上索引、约束以及主表上需要的触发器都已经创建好，但是目前所有的数据都还在主表上，如何把数据分布到分区表呢？</p>
<p>有两个办法，一个最容易也是最简单的办法是先把主表上的数据导出，而后清空主表，然后导入刚才导出的数据。这个做法需要一定的停服务时间。</p>
<p>另外一个办法是考虑使用更新触发器，通过更新主表上的所有数据，从而使得数据重新分配。这个方法的流程和使得插入数据重定向方法类似，首先创建一个主表更新函数。
而后在主表上针对更新创建触发器，类似下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">orders_update_trigger</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$</span><span class="n">body$</span>
<span class="k">BEGIN</span>
<span class="w">   </span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">orderid</span><span class="o">=</span><span class="n">orderid</span><span class="p">;</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$</span><span class="n">body$</span>
<span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">update_orders</span>
<span class="w">     </span><span class="k">BEFORE</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span>
<span class="w">     </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="w">     </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">orders_update_trigger</span><span class="p">();</span>
</code></pre></div>
<p>而后我们把对主表的更新语句放在一个事物里，就像下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w"> </span><span class="mi">12000</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">orders_2004_01</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w">     </span><span class="mi">0</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">orders_2004_12</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w">     </span><span class="mi">0</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">orderid</span><span class="o">=</span><span class="n">orderid</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w"> </span><span class="mi">12000</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w">  </span><span class="mi">1000</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="p">;</span>
<span class="w"> </span><span class="k">count</span>
<span class="c1">-------</span>
<span class="w">  </span><span class="mi">1000</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">COMMIT</span><span class="p">;</span>
<span class="k">COMMIT</span>
</code></pre></div>
<p>确保所有的数据都已经重新分布后，记得做善后工作</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">CLUSTER</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span><span class="w">  </span><span class="n">there</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">clustered</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="ss">&quot;orders&quot;</span>
<span class="k">STATEMENT</span><span class="p">:</span><span class="w">  </span><span class="k">CLUSTER</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span><span class="w">  </span><span class="n">there</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">clustered</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="ss">&quot;orders&quot;</span>
<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">update_orders</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span>
<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">orders_update_trigger</span><span class="p">();</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">FUNCTION</span>
</code></pre></div>
<h3 id="_59">分区查询<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>到此为止，数据都在分区表里了，此时应该更新攻击。同时也应该确认 constraint_exclusion 特性是否打开:</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="p">;</span>
<span class="k">ANALYZE</span>
<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="n">constraint_exclusion</span><span class="w"> </span><span class="p">;</span>
<span class="w"> </span><span class="n">constraint_exclusion</span>
<span class="c1">----------------------</span>
<span class="w"> </span><span class="n">partition</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>排他性约束可以让查询计划避免包含进并不满足查询要求行的分区表进来。PostgreSQL
8.4 及以后版本默认是打开的，之前则是关闭。</p>
<p>通过对主表的查询测试，我们可以看到查询计划已经在分区表上起作用了:</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w">  </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span>
<span class="c1">------------------</span>
<span class="w"> </span><span class="k">Result</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">228</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">12001</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">010</span><span class="p">..</span><span class="mi">4</span><span class="p">.</span><span class="mi">648</span>
<span class="w">                                                      </span><span class="k">rows</span><span class="o">=</span><span class="mi">12000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Append</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">228</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">12001</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">                            </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">009</span><span class="p">..</span><span class="mi">2</span><span class="p">.</span><span class="mi">464</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">12000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">                            </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">19</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">007</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">118</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_02</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">19</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">006</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">111</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_11</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">19</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">096</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">19</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">105</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">runtime</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">339</span><span class="w"> </span><span class="n">ms</span>
<span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>

<span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">orderdate</span><span class="o">=</span><span class="s1">&#39;2004-11-16&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span>
<span class="c1">---------------</span>
<span class="w"> </span><span class="k">Result</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">21</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">36</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">012</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">136</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">35</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Append</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">21</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">36</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">011</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">127</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">35</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">orderdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2004-11-16&#39;</span><span class="p">::</span><span class="nb">date</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_11</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">21</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">35</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">009</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">122</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">35</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">orderdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2004-11-16&#39;</span><span class="p">::</span><span class="nb">date</span><span class="p">)</span>
<span class="w">               </span><span class="k">Rows</span><span class="w"> </span><span class="n">Removed</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="mi">965</span>
<span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">runtime</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">165</span><span class="w"> </span><span class="n">ms</span>
<span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>我们再看看针对 orderid 字段查询的例子：</p>
<div class="highlight"><pre><span></span><code><span class="n">dellstore2</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">orderid</span><span class="o">&lt;</span><span class="mi">2000</span><span class="p">;</span>
<span class="w">  </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span>
<span class="c1">-----------------------</span>
<span class="w"> </span><span class="k">Result</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">258</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">2011</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">11</span><span class="p">.</span><span class="mi">433</span><span class="p">..</span><span class="mi">39</span><span class="p">.</span><span class="mi">440</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1999</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Append</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">258</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">2011</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">11</span><span class="p">.</span><span class="mi">431</span><span class="p">..</span><span class="mi">38</span><span class="p">.</span><span class="mi">878</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1999</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_01</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">21</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">11</span><span class="p">.</span><span class="mi">429</span><span class="p">..</span><span class="mi">14</span><span class="p">.</span><span class="mi">192</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<span class="w">       </span><span class="p">...</span>
<span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">orders_2004_12</span><span class="w"> </span><span class="n">orders</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">21</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="k">time</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mi">739</span><span class="p">..</span><span class="mi">1</span><span class="p">.</span><span class="mi">739</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">orderid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<span class="w">               </span><span class="k">Rows</span><span class="w"> </span><span class="n">Removed</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">runtime</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">.</span><span class="mi">880</span><span class="w"> </span><span class="n">ms</span>
<span class="p">(</span><span class="mi">40</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>从结果来看，针对 orderid 的查询并没有太多优化，所有的子表都在扫描范围内。</p>
<h3 id="_60">常见的分区误区<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>没有打开 constraint_exclustion，从而导致每次查询都包含所有的分区表</p>
</li>
<li>
<p>在每个分区表上增加主表上已经有的索引或者约束时会报错</p>
</li>
<li>
<p>忘记给每个分区表赋予和主表相同的权限</p>
</li>
<li>
<p>查询语句没有包括分区字段的过滤，WHERE 子句需要用常量来过滤，当参数的查询根本就不会优化。
  函数里通过使用类似 CURREN_DATE 这样的语句修改过滤值也不会获得好的优化效果。一般来说，WHERE 子句尽可能简单。</p>
</li>
<li>
<p>针对分区的查询开销和分区数量成正比，如果只有 10 ～ 20 个分区表，那开销不明显，如果上百个，那就很明显了，因此保持你的分区表数量在 2 位数之内时最好的性能。</p>
</li>
<li>
<p>如果你手工对主表执行 vacuum/analyze 操作，它并不会执行到分区表上，因此你需要针对每个分区表做同样的操作。</p>
</li>
<li>
<p>插入超过日期范围(比如 2005 年的)的数据会导致函数报错，类似 ERROR:
  relation \"orders_2013_03\" does not exist。</p>
</li>
</ul>
<h3 id="plproxy">用 PL/Proxy 做水平分区<a class="headerlink" href="#plproxy" title="Permanent link">&para;</a></h3>
<p><a href="http://pgfoundry.org/projects/plproxy/">PL/Proxy</a>的理论是认为把一个大表分成多个子表会比将大表分到相同的多个服务器上更有效率。</p>
<p>PL/Proxy 是 Skype 设计用来满足数据库扩展所需，它其中的一个目标是一次可以服务 10 个用户请求。它是用存储过程语言实现的数据库分区系统。</p>
<p>PL/Proxy 的一个基本假设是通过访问函数（也就是存储过程）来屏蔽直接访问数据库。比如，假定你需要抓取 username 字段来唯一标识一个用户，你可以调用
一个返回 username 字段的函数而不是查询表。这个设计方式流行的另外一个原因是，它使得当需要重构数据库时，对应用程序的影响最小。只要那些称之为"API"的函数是稳定的，
那么函数映射到重构后的数据库就要简单得多。</p>
<p>接下来要做的是判断用哪种方法把负载分片，从技术上来说，就是判断用哪个字段作为分区依据。</p>
<p>PL/Proxy 的配置安装有点复杂，感兴趣的可以看这个这个链接：<a href="http://plproxy.projects.postgresql.org/doc/tutorial.html">http://plproxy.projects.postgresql.org/doc/tutorial.html</a></p>
<h3 id="_61">散列生成<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>上面提到 PL/Proxy 的一个标准工作就是表分区，因为是水平分区，我们需要考虑记录和子表如何对应。一般我们采用对特定字段做 hash 算法的方式映射到子表中。
我们可以用 PostgreSQL 自带的 hashtext 函数来实现 hash 算法。它可以接受任何文本作为输入，而后产生一个整数作为 hash
code。如果你把 hash code 和一个数做位与操作，则可以产生最低的几位数字。
为了实现这点，分区表的数量必须是 2 的幂数(2,4,8,16 等)，然后把 hash
code 和比分区数少 1 的数进行位与。比如你有 2 个分区，则为\"&amp;
1\",4 个分区则是\"&amp; 3\"，以此类推。</p>
<p>我们举一个例子，把前 10 个自然数映射到 4 个分区表中：</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="n">hashtext</span><span class="p">(</span><span class="n">s</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w"> </span><span class="n">s</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">hash</span>
<span class="c1">----+------</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span>
<span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span>
<span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span>
<span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span>
<span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span>
<span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span>
<span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>从 hash 例可以看出，这个 10 个自然数被映射到(0,1,2,3)集合里。</p>
<p>hash 要考虑的另外一个情况是，对集合到子集的映射尽可能平均，因为我们可以看看前 10000 个自然数映射到 4 个分区里的统计情况：</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">hashtext</span><span class="p">(</span><span class="n">s</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span>
<span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">count</span>
<span class="c1">------+-------</span>
<span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2550</span>
<span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2411</span>
<span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2531</span>
<span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2508</span>
<span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<p>从这个结果来看，子集元素的数量还是很均等的。</p>
<p>要注意的是，PostgreSQL
8.3 版本的 hashtext 函数和 8.4 版本的 hashtext 输出结果不同，因此当你从 8.3 版本升级时，则需要考虑这点。</p>
<h3 id="_62">分片<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>分片(Sharding)是一种水平分区的形式，可以用 PL/Proxy 来实现。它在每个节点上都有分片数据结构，因此这些节点中的每个都可以独立操作。
这一般是 shared-nothing 架构所涉及到的方案，每个分片节点都可以独自响应一个查询请求--只要所查询的数据在其中。</p>
<p>分片设计的复杂处包括如何协同以及分片节点如何更新，它一般和特定的应用程序相关。比如 Skype 就使用了 Londiste 复制程序。</p>
<h3 id="_63">总结<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>PostgreSQL 里的每一种分区方案都都一定的手工配置工作要求。因此，做这些操作前，你需要获得足够的信息来判读使用哪种分区方案以及如何分区。</p>
<p>这里有些通用指导建议：</p>
<ul>
<li>
<p>只有数据库表或者表活跃部分超过服务器物理内存时，分区才有意义。</p>
</li>
<li>
<p>选择哪个字段作为分区依据需要仔细评估针对该表的所有查询，以确保他们针对该字段都有选择性。</p>
</li>
<li>
<p>每个分区表都需要手工创建，包括索引、约束以及(或)表权限。</p>
</li>
<li>
<p>重定向 INSERT，UPDATE，DELETE 语句到分区表的最容易办法是使用触发器。</p>
</li>
<li>
<p>从未分区表的数据现场迁移到分区表中是可能的，虽然会带来临时的磁盘使用空间翻倍的现象。</p>
</li>
<li>
<p>对于分区表，需要打开 constraint_exclustion 特性，查询才会正常工作</p>
</li>
<li>
<p>WHERE 子句需要简单值才能使 constraint exclustion 工作</p>
</li>
<li>
<p>通过分区可以改进某些数据库维护操作。对单个分区表执行 REINDEX 会更快，相比通过 DELETE 删除老的数据，通过 DROP 老的分区表来删除数据几乎时瞬时的，</p>
</li>
<li>
<p>使用前自动创建分区表需要慎重思考，需要考虑到条件竞争情况</p>
</li>
<li>
<p>可以有效使用的分区表数上限是两位数。超过 100 个分区表的情况下，查询会需要很明显的开销来评估这些分区约束条件</p>
</li>
<li>
<p>PL/Proxy 可以用来有效的把数据拆分到多个节点，且扩展节点无限制，它也可以用来部署 shared-nothing 架构</p>
</li>
</ul>
<h2 id="_64">避免常见问题<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h2>
<p>PostgreSQL 官方 wiki 上有一个<a href="http://wiki.postgresql.org/wiki/Category:FAQ">FAQ</a>列表，列出了一些常见的问题，有些我们会在下面提到。</p>
<h3 id="_65">灌数<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>数据灌入有两种不同的情形。第一种在一个空的数据库(表)里灌入。另外一种是数据库(表)里已经有数据了，然后再灌入。两种有一些细微的区别。
比如用于第一种灌数情形的删除索引和约束就不适合第二种情形。我们分别介绍。</p>
<h4 id="_66">加载方法<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<p>数据灌入的首选方法是用 PostgreSQL 特有的 COPY 指令，这是插入大量行记录的最快方法。
当然你也可以使用传统的 INSERT 指令，但即便用上 BEGIN/COMMIT 方式包裹多条 INSERT 语句，速度也不如 COPY 来的快。</p>
<p>下面是从慢到快的一个数据插入方法：</p>
<ol>
<li>
<p>一次插入单个记录</p>
</li>
<li>
<p>一次插入多条记录</p>
</li>
<li>
<p>一次使用单个 COPY 指令，这也是标准 pg_restore 所用方法</p>
</li>
<li>
<p>多条插入指令并行执行，每条插入指令包括多条记录</p>
</li>
<li>
<p>一次使用多个 COPY 指令。这是并行 pg_restore 所用方法</p>
</li>
</ol>
<h4 id="_67">外部灌数程序<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h4>
<p>使用 COPY 指令需要考虑的一点是，只要出现错误，它就会终端所有的工作。想象你一下就因为最后一条记录有问题，从而导致你前面大量的数据插入都失效，这是不能接受的。</p>
<p>假定你是从外部数据源倒入数据，那就应该考虑导入操作应该可以持续工作，然后把因为错误拒绝插入的数据另外保存起来。<a href="http://pgfoundry.org/projects/pgloader/">pgloader</a>就
可以做到这点，虽然它不如 COPY 来得快，但对于外部数据格式并不那么严格时，这是最好的方式。</p>
<p>另外一个用于某些特定场景下的灌数程序是<a href="http://pgbulkload. projects.postgresql.org/">pg_bulkload</a>，它有时甚至比 COPY 还要快，这得意于它采取积极的高性能特性，比如绕过 WAL。
它也可以处理坏的数据行。</p>
<h4 id="_68">为灌数调优<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h4>
<p>为灌输而关闭表上的所有索引以及约束只最需要做的事情，灌输后在创建索引会更快，更好的磁盘碎片。灌输后做约束检查要快很多。</p>
<p>postgresql.conf 里的几个参数也可以在灌数时做临时调整，可以加快灌数的速度：</p>
<ul>
<li>
<p>maintenance_work_mem:
  尽可能加大该值，对于超过 16G 内存的服务器，配置 1GB 的该参数就不合道理。CREATE
  INDEX ，ALTER TABLE ADD FOREIGN KEY 都需要它。</p>
</li>
<li>
<p>checkpoint_segments:
  要比正常使用时的值大很多，因为崩溃后恢复时间以及磁盘空间在这个时间段并不是需要关注的事情。通常设置为 128-256。同样可以加大 checkpoint_timeout
  的值，设置为 30m 是合理的</p>
</li>
<li>
<p>autovacuum: 灌数时关闭该特性</p>
</li>
<li>
<p>wal_buffers: 它很容易成为灌数的瓶颈，设置到其最大值 16MB。</p>
</li>
<li>
<p>synchronous_commit:
  关闭该参数，关闭后如果因为崩溃而导致丢失某些事务，简单清空崩溃前最后灌入的表，重新灌入就好了</p>
</li>
<li>
<p>fsync:
  该参数只有在灌数时可以考虑关闭。带来的主要问题是当数据库崩溃时，数据可能损坏，但不是致命错误。只需要完全重新灌数就好</p>
</li>
<li>
<p>vacuum_freeze_min_age: 设置为比 0 小的参数</p>
</li>
</ul>
<h4 id="wal">跳过 WAL 来加速<a class="headerlink" href="#wal" title="Permanent link">&para;</a></h4>
<p>假定一个灌数代码类似如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">...;</span>
<span class="k">COPY</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>
<p>缺省情况下，上述代码执行不会产生任何 WAL 记录，因此执行起来更快。同理，如果你用 TRUNCATE 而不是 DELETE 清空一个表也能获得提速。</p>
<p>但是，如果你设置了 archive_command 参数来获得 PITR 特性，那么上述优化就生效了。</p>
<h4 id="_69">重建索引和增加约束<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h4>
<p>索引重建很可能成为 CPU、内存以及磁盘密集型操作。如果你有个大磁盘阵列，那么并行运行两个或以上重建指令是非常合理的。
如前所述，增加 shared_buffers,checkpoint_segment,checkpoint_timeout,maintenance_work_mem 参数值可以提高性能。</p>
<h4 id="_70">并行恢复<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<p>PostgreSQL
8.4 引入了并行恢复机制，它允许你分配服务器上的多个 CPU 核来运行专门的数据加载进程。使用并行版本的 pg_restore，很简单你只需要指定你一次想运行
多少个"jobs"就好了，它对数据加载以及索引重建和增加约束都有提速效果。</p>
<h4 id="_71">灌数后清理工作<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<p>灌数完毕，索引重建完成，约束增加完毕。把服务器上线之前还有两个维护工作要做。
第一个必须要做是对每个数据库执行 ANALYZE 指令。确保统计信息有效可用。同时也可以考虑运行数据库级的 VACUUM。当然你直接运行 VACUUM
ANALYZE 会更好。
第二个要做的事情就是把 postgresql.conf 里修改过的参数恢复到正常设置。</p>
<h3 id="_72">常见性能问题<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>很多性能问题都是来自糟糕的设计或者实现，使得 PostgreSQL 无法从根本上很好的运行。下面我们列举一些 PostgreSQL 新手可能遇到的常见性能问题：</p>
<h4 id="_73">统计行数<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<p>应用程序里大部分都有类似下面的 SQL 语句来计算一个表里有多少行：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
</code></pre></div>
<p>有些数据库可能执行这个很快，通常他们把这个信息保存到一个索引里或者类似的结构里。
不幸的是，PostgreSQL 没这么干，它需要执行全表扫描才能获得结果，这就相当慢了。
对此，PostgreSQL 提供了两个替代方法。第一个方法是对于那些并不需要精确的表行数而言，我们可以从系统表里查询相关信息，比如：</p>
<p><code>SELECT reltuples FROM pg_class where relname='t'</code></p>
<p>如果运行该 SQL 语句之前刚好运行过 VACUUM 或者 ANALYZE，则这个结果是准确的，而不是估计值。</p>
<p>如果你有同名的表，那么就加上名字空间限定，类似下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">reltuples</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">C</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">relnamespace</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">relname</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">N</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">;</span>
</code></pre></div>
<p>第二办法是在表上创建一个触发器，跟踪表上数据的删除和增加操作，从而把统计行数记录下来。
具体的可以参考这个例子：<a href="http://wiki.postgresql.org/wiki/Slow_Counting">http://wiki.postgresql.org/wiki/Slow_Counting</a></p>
<h4 id="_74">外键开销高<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h4>
<p>当更新语句里涉及到外键，其时间开销很大，特别是每次只做一行更新时。对于批量更新，可能的一个性能提升办法时把外键约束标记为 DEFERRABLE，缺省是
NOT
DEFERRABLE。不过这种设置只对把外键和相似约束作为触发器实现时才有效，而对于 CHECK 以及 UNIQUE 限定则无能为力。后者要求立刻处理，不能延缓。</p>
<p>即便对于约束延缓，也有两种情况。如果检查标记为 INITIALLY
IMMEDIATE，那也会立刻处理，而不是在事务的最后来处理。此时你可以修改约束为 INITIALLY
DEFERRED，这样可以 确保检查在事务最后处理。</p>
<p>当检查标记为 DEFERRABLE，它同时为 INITIALLY IMMEDIATE 时，你可以使用 SET
CONSTRAINTS 指令修改部分会话。其标准做法是，把多条插入或更新语句放在
一个事务里，且事务开头标记所有约束为延缓，类似如下：</p>
<div class="highlight"><pre><span></span><code>BEGIN;
SET CONSTRAINTS ALL DEFERRED;
[ update or insert statements ]
COMMIT;
</code></pre></div>
<p>这种处理方式对批量更新/插入可以提升效率，但是如果量很大，则在做 COMMIT 时，有可能会阻塞服务一段时间，从而导致无法对外响应。</p>
<h4 id="_75">触发器内存使用<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h4>
<p>如果一个表上有 AFTER 类型触发器，那么每个插入语句都会在一个内存列表里，如果插入的数量很大，比如批量加载时，就有可能出现 OOM，或者达到系统设置的内存极限。
因此在批量倒入场景下，要注意 AFTER 类型触发器。</p>
<h3 id="_76">数据库性能分析<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>有时要找出你的代码为什么不能有效的工作的办法时深入到数据库本身，并查到有瓶颈的代码。我们通过一些工具来做到这点：</p>
<h4 id="gprof">gprof<a class="headerlink" href="#gprof" title="Permanent link">&para;</a></h4>
<p>gprof 是一个标准的 GNU 性能分析工具，可以在大部分类 UNIX 系统上运行，编译 PostgreSQL 时，增加--enable-profiling 选项，它会产生一个 gmon.out 文件，这根据可以用于 gprof 来做性能分析。</p>
<p>gprof 的主要问题时它在跟踪到可加载库的函数时会出现已知问题。另外，它也很能根据分析信息来获得下层操作系统正在做什么。因此，综合这两个限制，gprof 只适合做一些简单和单纯的数据库操作性能分析。</p>
<h4 id="oprofile">OProfile<a class="headerlink" href="#oprofile" title="Permanent link">&para;</a></h4>
<p>OProfile 可以分析任何在 Linux 服务器上运行的程序，是一个非常棒的工具。也是很多在 Linux 写的码农们的首选工具。<a href="http://wiki.postgresql.org/wiki/Profiling_with_OProfile">http://wiki.postgresql.org/wiki/Profiling_with_OProfile</a>介绍的很详细。</p>
<h4 id="visual-studio">Visual Studio<a class="headerlink" href="#visual-studio" title="Permanent link">&para;</a></h4>
<p>Windows 平台的最佳选择(或唯一选择？)，从 PostgreSQL 8.4 以后有效。</p>
<h4 id="dtrace">DTrace<a class="headerlink" href="#dtrace" title="Permanent link">&para;</a></h4>
<p>Sun 公司在 2004 年发布的 Solaris
10 中引入 DTrace，可能时最全面的性能分析工具。</p>
<p>PostgreSQL 编译时需要使用--enable-dtrace 选项才能使用 DTrace，对于如何使用 DTrace，恐怖可以用一本书的容量来介绍。我们可以参考下面的两个链接：</p>
<ul>
<li>
<p><a href="http://www.postgresql.org/docs/current/interactive/dynamic-trace.html">http://www.postgresql.org/docs/current/interactive/dynamic-trace.html</a></p>
</li>
<li>
<p><a href="http://wiki.postgresql.org/wiki/DTrace">http://wiki.postgresql.org/wiki/DTrace</a></p>
</li>
</ul>
<h4 id="linux-systemtap">Linux SystemTap<a class="headerlink" href="#linux-systemtap" title="Permanent link">&para;</a></h4>
<p>SystemTap 是 Linux 平台性能分析工具，其功能类似 DTrace。对使用了--enable-dtrace 编译的 PostgreSQL，SystemTap 可以使用。</p>
<p>目前 Fedora,RHEL 系统发型班办法都能支持 SystemTap,但 Debian/Ununtu 则可能会有些问题。</p>
<h3 id="_77">与版本有关的性能特性<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>书中描述了各种和版本有关的性能特性，这里时摘录于 9.0 有关的特性。</p>
<h4 id="_78">复制<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>异步主从复制已经内置，且不需要配置太多额外脚本</p>
</li>
<li>
<p>复制系统还可以配置为 HotStandby 用于只读查询</p>
</li>
<li>
<p>控制 WAL 归档参数分开，除了已经存在的 archive_mode 和 archive_command 以外，新增了 wal_level 参数用于设置允许写多少信息到 WAL 里</p>
</li>
<li>
<p>复制过程的监控可以通过 standby 服务器使用 pg_last_xlog_receive_location()和 pg_last_xlog_replay_location()函数实现</p>
</li>
<li>
<p>contrib/pg_archivecleanup 工具可以用于清除老的 WAL 归档文件。该程序可以被 archive_cleanup_command 参数调用</p>
</li>
</ul>
<h4 id="_79">查询和分析<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>EXPLAIN 可以输出为 XML，JSON 或 YAML 格式，方便外部工具分析</p>
</li>
<li>
<p>EXPLAIN （BUFFERS） 可以监控某个特定查询的实际 I/O,而不是显示成本</p>
</li>
<li>
<p>窗口函数新增了诸如 PRECEDING，FOLLOWING 选项，以及用 CURRENT
  ROWS 开始的选项</p>
</li>
<li>
<p>外联接所引用到的表如果并没用于满足查询要求，则会从查询计划中移去以提升性能
  。一般这类查询语句由 ORM 软件生成。</p>
</li>
<li>
<p>每个表空间可以通过 ALTER
  TABLESPACE 来分配自己的顺序和随机页查询代价，对于不同表空间分配在不同速度的存储介质上这种情况，可以获得更好的调整</p>
</li>
<li>
<p>可以通过使用 ALTER
  TABLE 来手工调整一个字段不同值的统计信息，当自动评估有问题时，这种方式可以提升效率</p>
</li>
<li>
<p>使用 IS NOT NULL 的查询语句可以使用索引</p>
</li>
<li>
<p>基因查询优化器(Genetic Query Optimizer a.k.a
  GEQO)现在可以强制使用固定的随机种子值</p>
</li>
<li>
<p>GIN 索引使用自平衡红黑树(self-balancing Red-Black trees)</p>
</li>
</ul>
<h4 id="_80">数据库开发<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>PL/pgSQL 语句现在缺省安装到所有数据库，可以删除</p>
</li>
<li>
<p>触发器可以附着在特定的字段上，以避免不必要的调用</p>
</li>
<li>
<p>LISTEN/NOTIFY 机制使得数据库客户端直接传递消息更快，而且可以发送"payload"字符串信息，这使得使用数据库自身创建跨客户端消息系统成为可能</p>
</li>
<li>
<p>应用程序能够使用 application_name 来设置，使得 pg_stat_activity 信息里显示出应用程序名字</p>
</li>
<li>
<p>唯一约束违例发生时给出的错误信息里包括的设计到的值，这使得定位到底时那里导致发生错误变得容易</p>
</li>
<li>
<p>约束检查可以标记为 DEFERRABLE</p>
</li>
<li>
<p>新引进排他性约束(exclusion constraints)，和唯一性约束类似</p>
</li>
<li>
<p>contrib/hstore 模块提供了一个低开销的键值对(key/value)存储类型</p>
</li>
</ul>
<h4 id="_81">配置和监控<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>服务器参数可以被用户/数据库组合调整</p>
</li>
<li>
<p>当 postgresql.conf 文件被被 pg_ctl
  reload 或发送 SIGHUP 信号给服务而重载时，服务器日志会注意到哪些参数被修改了</p>
</li>
<li>
<p>使用 pg_stat_reset_shared('bgwriter')函数可以重置后台写统计</p>
</li>
<li>
<p>使用 pg_stat_reset_single_table_counters()和 pg_stat_reset_single_function_counters()可以分别单独针对表和函数计数器进行重置</p>
</li>
<li>
<p>log_temp_files 参数可以用 KB 单位来指定</p>
</li>
<li>
<p>log_line_prefix 可以追踪诸如错误消息里设置的 SQLSTATE 值，这就使得日志可以更好的分析导致错误发生的确切代码</p>
</li>
</ul>
<h4 id="_82">工具<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>pgbench 可以运行多进程/多线程模式性能测试</p>
</li>
<li>
<p>contrib/auto_explain 模块可以输出查询语句以及它的执行计划</p>
</li>
<li>
<p>contrib/pg_stat_statements 可以手机查询日志数据包括每个语句所有的活动缓存信息</p>
</li>
</ul>
<h4 id="_83">内部<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>contrib/pg_upgrade 工具可以从早期的 8.&#8540;.4 版本平滑升级到 9.0,不需要导出导入数据，这中方式一般称为就地更新(\"in-place
  upgrade\")</p>
</li>
<li>
<p>VACUUM
  FULL 使用了早期版本中 CLUSTER 中使用的重建机制。它需要更多的磁盘空间，但更快而且可以避免索引膨胀</p>
</li>
<li>
<p>编译时默认使用--enable-thread-safety。该选项允许多线程客户端程序使用数据库客户端库来编译，从而安全运行。早起版本默认不开启该特性</p>
</li>
<li>
<p>数据库有自己更好的办法处理 OOM 的问题</p>
</li>
<li>
<p>有几个指令现在可以通过使用()包括的列表来传递选项，而不是传统的 SQL 语法。EXPLAIN，COPY，VACUUM 目前都可以使用这个特性</p>
</li>
</ul>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; wgzhao
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/01mlsx" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/wgzhao" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes", "navigation.expand", "content.code.annotate", "content.tabs.link", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "header.autohide", "announce.dismiss", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5090c770.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js"></script>
      
    
  </body>
</html>