
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="这篇摘要内容节选自 “丁奇” 在极客时间的 《MySQL实战45讲》的内容，这是第三部分">
      
      
        <meta name="author" content="wgzhao">
      
      
        <link rel="canonical" href="https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-3/">
      
      
        <link rel="prev" href="../mysql-practices-lecture-45-2/">
      
      
        <link rel="next" href="../mysql-practices-lecture-45-4/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.1">
    
    
      
        <title>《MySQL 实战45讲》节选第三部分 - 个人笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mysql-45" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="个人笔记" class="md-header__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            个人笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              《MySQL 实战45讲》节选第三部分
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../tags/" class="md-tabs__link">
        
  
    
  
  Tags

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../bigdata/ambari-cli/" class="md-tabs__link">
          
  
    
  
  Bigdata

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../commands-in-sbin/" class="md-tabs__link">
          
  
    
  
  Courses

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../database/maridb-ax-setup/" class="md-tabs__link">
          
  
    
  
  Database

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../kubernetes/access-k8s-pod-from-outersider/" class="md-tabs__link">
          
  
    
  
  Kubernetes

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../misc/Latex%20Math%20Symbols/" class="md-tabs__link">
          
  
    
  
  Misc

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../programming/design-restful-api-with-python-and-flask/" class="md-tabs__link">
          
  
    
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../tips/bash-tips/" class="md-tabs__link">
          
  
    
  
  Tips

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-tabs__link">
          
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="个人笔记" class="md-nav__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    个人笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bigdata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Bigdata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/ambari-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Ambari API 来操作 Hadoop 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/flink-cdc-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flink SQL CDC 实践以及一致性分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/integrating-hive-with-spark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating Apache Hive with Apache Spark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/integrating-phoenix-with-kerberos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phoenix 集成 HBase 并支持 Kerberos 认证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/ipa-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free IPA setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/kerberos-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MIT Kerberos  安装及维护手册
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/mafengwo-warehouse-design-and-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    马蜂窝数据仓库设计与实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/presto-with-ssl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Presto SSL 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bigdata/zookeeper-optimize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zookeeper集群应对万级并发的调优
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Courses
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Courses
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../commands-in-sbin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 命令学习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-cfs-scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux CFS 调度器：原理、设计与内核实现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pg9_high_performance_notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《PostgreSQL 9 High Performance》读书笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mysql lecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Mysql lecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-practices-lecture-45-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第一部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-practices-lecture-45-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第二部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第三部分
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第三部分
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#20" class="md-nav__link">
    <span class="md-ellipsis">
      20 幻读是什么，幻读有什么问题？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="20 幻读是什么，幻读有什么问题？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      幻读是什么？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      幻读有什么问题？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      如何解决幻读？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      21 为什么我只改一行的语句，锁这么多？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="21 为什么我只改一行的语句，锁这么多？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      案例一：等值查询间隙锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      案例二：非唯一索引等值锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      案例三：主键索引范围锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      案例四：非唯一索引范围锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bug" class="md-nav__link">
    <span class="md-ellipsis">
      案例五：唯一索引范围锁 bug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      案例六：非唯一索引上存在"等值"的例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit" class="md-nav__link">
    <span class="md-ellipsis">
      案例七：limit 语句加锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      案例八：一个死锁的例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      22 MySQL有哪些“饮鸩止渴”提高性能的方法？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="22 MySQL有哪些“饮鸩止渴”提高性能的方法？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      短连接风暴
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      慢查询性能问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qps" class="md-nav__link">
    <span class="md-ellipsis">
      QPS 突增问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      23 MySQL是怎么保证数据不丢的？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="23 MySQL是怎么保证数据不丢的？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binlog" class="md-nav__link">
    <span class="md-ellipsis">
      binlog 的写入机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redo-log" class="md-nav__link">
    <span class="md-ellipsis">
      redo log 的写入机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      24 MySQL是怎么保证主备一致的？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="24 MySQL是怎么保证主备一致的？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    <span class="md-ellipsis">
      MySQL 主备的基本原理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#binlog_1" class="md-nav__link">
    <span class="md-ellipsis">
      binlog 的三种格式对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixed-binlog" class="md-nav__link">
    <span class="md-ellipsis">
      为什么会有 mixed 格式的 binlog？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      循环复制问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      上期问题时间
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      25 MySQL是怎么保证高可用的？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="25 MySQL是怎么保证高可用的？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      主备延迟
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      主备延迟的来源
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      可靠性优先策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      可用性优先策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#26" class="md-nav__link">
    <span class="md-ellipsis">
      26 备库为什么会延迟好几个小时？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="26 备库为什么会延迟好几个小时？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mysql-56" class="md-nav__link">
    <span class="md-ellipsis">
      MySQL 5.6 版本的并行复制策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mariadb" class="md-nav__link">
    <span class="md-ellipsis">
      MariaDB 的并行复制策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql-57" class="md-nav__link">
    <span class="md-ellipsis">
      MySQL 5.7 的并行复制策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql-5722" class="md-nav__link">
    <span class="md-ellipsis">
      MySQL 5.7.22 的并行复制策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#27" class="md-nav__link">
    <span class="md-ellipsis">
      27 主库出问题了，从库怎么办？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27 主库出问题了，从库怎么办？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      基于位点的主备切换
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gtid" class="md-nav__link">
    <span class="md-ellipsis">
      GTID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gtid_1" class="md-nav__link">
    <span class="md-ellipsis">
      基于 GTID 的主备切换
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gtid-ddl" class="md-nav__link">
    <span class="md-ellipsis">
      GTID 和在线 DDL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#28" class="md-nav__link">
    <span class="md-ellipsis">
      28 读写分离有哪些坑？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28 读写分离有哪些坑？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      强制走主库方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sleep" class="md-nav__link">
    <span class="md-ellipsis">
      Sleep 方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      判断主备无延迟方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semi-sync" class="md-nav__link">
    <span class="md-ellipsis">
      配合 semi-sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      等主库位点方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gtid_2" class="md-nav__link">
    <span class="md-ellipsis">
      GTID 方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#29" class="md-nav__link">
    <span class="md-ellipsis">
      29 如何判断一个数据库是不是出问题了？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="29 如何判断一个数据库是不是出问题了？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#select-1" class="md-nav__link">
    <span class="md-ellipsis">
      select 1 判断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      查表判断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      更新判断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      内部统计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-practices-lecture-45-4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第四部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-practices-lecture-45-5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第五部分
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Time series analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Time series analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time-series-analysis/01-basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time-series-analysis/02-primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    初级篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time-series-analysis/03-advance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进阶篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time-series-analysis/04-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time-series-analysis/05-complete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    补完篇
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/maridb-ax-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MariaDB AX 安装测试简记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/mysql-cluster-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MySQL Cluster 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/oracle-11g-imp-and-exp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 11g 导入导出基本操作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/oracle-silent-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 静默安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/percona-cluster-with-haproxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HAProxy + Percona XtraDB Cluster 部署
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/setup-a-clickhouse-cluster-on-one-node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在一个节点上部署 ClickHouse 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../database/why-mysql8-slower-than-mysql57/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    默认配置下，为什么 MySQL 8.0 比 MySQL 5.7 慢
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/access-k8s-pod-from-outersider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    外部机器如何直接直接访问 kubernetes 集群内服务
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/calico-node-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calico Node 无法启动的排查
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/collect-k8s-log-with-filebeat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基于 ELK 的 日志收集与自动索引创建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/coredns-support-hosts-file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CoreDNS 支持解析宿主机的 hosts 文件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/deep-dive-into-k8s-internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用奇怪的方式构建简单 k8s 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/how-to-create-user-for-k8s-dashboard/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在 Kubernetes Dashboard 创建基于 RBAC 的授权用户
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/kubernetes-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 kubeadm 安装 kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/take-flannel-to-calico/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate kubernetes cluster from Flannel to Calico
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/Latex%20Math%20Symbols/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用于 LateX 的数学符号
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/git-from-zero-to-hero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git从入门到应付日常工作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/gitlab-ci-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gitlab-ci.yml 详解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/osint-introduce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    超级情报手机工具库：开源验证和调查工具及使用方法
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/design-restful-api-with-python-and-flask/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Python 和 Flask 设计 RESTful API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/programming-with-vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无插件Vim编程技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/pure-bash-bible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pure Bash Bible
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/understanding-awk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding AWK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tips
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Tips
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/bash-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BASH 的一些技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/batch-convert-word-to-pdf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 下批量转换 word 文档为 pdf 的方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/change-keyboard-layout-in-ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ubuntu 下修改键盘映射
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/git-internals-objects-branches-create-repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git 内部原理图解 -- 对象、分支以及如何从零开始建仓库
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/git-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git 不常见的操作技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/how-to-create-dummy-rpm-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速创建一个虚假 RPM 包
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/howto-change-git-author/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to change git author name and email
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/howto-delete-old-images-from-nexus-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何删除 nexus 私服上的 Docker 镜像
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/howto-save-tmux-session/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to save tmux session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/learn-seaborn-with-10min/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十分钟掌握 Seaborn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/matplotlib-support-chinese/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Python 中 matplotlib 图支持中文
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/move-running-process-into-tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    把一个运行的进程放到 tmux 会话中
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/rpm-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rpm 包管理基本技能
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/sed-one-line-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SED 单行脚本快速参考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/setup-gitlab-ci-for-android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Gitlab CI For Android
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/ssh-three-key-features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ssh的三板斧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/ssh-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH examples, tips and tunnels
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tips/wechat-contacts-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    微信通讯录备份
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCPDump Capture HTTP GET/POST requests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/deep-in-tcp-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    详解 TCP 半连接队列与全连接队列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/docker-run-no-space-left/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker 运行容器报磁盘空间不足的错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/fix-ora-00227/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    修复 Oracle ORA-00227 错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/jdk1.6-support-tlsv1.2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Oracle JDK 1.6 TLSv1.2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags" >
    
      
      
      
        <a href="../../../tags/#tag:mysql" class="md-tag">mysql</a>
      
    
      
      
      
        <a href="../../../tags/#tag:tuning" class="md-tag">tuning</a>
      
    
  </nav>



<h1 id="mysql-45">《MySQL 实战45讲》节选第三部分<a class="headerlink" href="#mysql-45" title="Permanent link">&para;</a></h1>
<p><a href="http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md" title="Permalink to MySQL实战45讲.md">Source</a></p>
<p>以下内容节选自 “丁奇” 在极客时间的 《MySQL实战45讲》的内容，这是第三部分</p>
<h2 id="20">20 幻读是什么，幻读有什么问题？<a class="headerlink" href="#20" title="Permanent link">&para;</a></h2>
<p>在上一篇文章最后，我给你留了一个关于加锁规则的问题。今天，我们就从这个问题说起吧。</p>
<p>为了便于说明问题，这一篇文章，我们就先使用一个小一点儿的表。建表和初始化语句如下（为了便于本期的例子说明，我把上篇文章中用到的表结构做了点儿修改）：</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">d</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),(</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">);</span>
</code></pre></div>
<p>这个表除了主键 id 外，还有一个索引 c，初始化语句在表中插入了 6 行数据。</p>
<p>上期我留给你的问题是，下面的语句序列，是怎么加锁的，加的锁又是什么时候释放的呢？</p>
<div class="highlight"><pre><span></span><code><span class="k">begin</span><span class="p">;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span>
<span class="k">commit</span><span class="p">;</span>
</code></pre></div>
<p>比较好理解的是，这个语句会命中 d=5 的这一行，对应的主键 id=5，因此在 select 语句执行完成后，id=5 这一行会加一个写锁，而且由于两阶段锁协议，这个写锁会在执行 commit 语句的时候释放。</p>
<p>由于字段 d 上没有索引，因此这条查询语句会做全表扫描。那么，其他被扫描到的，但是不满足条件的 5 行记录上，会不会被加锁呢？</p>
<p>我们知道，InnoDB 的默认事务隔离级别是可重复读，所以本文接下来没有特殊说明的部分，都是设定在可重复读隔离级别下。</p>
<h3 id="_1">幻读是什么？<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>现在，我们就来分析一下，如果只在 id=5 这一行加锁，而其他行的不加锁的话，会怎么样。</p>
<p>下面先来看一下这个场景（注意：这是我假设的一个场景）：</p>
<table>
<thead>
<tr>
<th></th>
<th>Session A</th>
<th>Session B</th>
<th>Session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />//result: (5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>update t set d=5 where id=0;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d=5 fro update; /<em>Q2</em>/<br />//result: (0,0,5), (5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>insert into t values(1,1,5);</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d=5 fro update; /<em>Q3</em>/<br />//result: (0,0,5),(1,1,5),(5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>可以看到，session A 里执行了三次查询，分别是 Q1、Q2 和 Q3。它们的 SQL 语句相同，都是 <code>select * from t where d=5 for update</code>。这个语句的意思你应该很清楚了，查所有 d=5 的行，而且使用的是当前读，并且加上写锁。现在，我们来看一下这三条 SQL 语句，分别会返回什么结果。</p>
<ol>
<li>Q1 只返回 id=5 这一行；</li>
<li>在 T2 时刻，session B 把 id=0 这一行的 d 值改成了 5，因此 T3 时刻 Q2 查出来的是 id=0 和 id=5 这两行；</li>
<li>在 T4 时刻，session C 又插入一行<code>（1,1,5）</code>，因此 T5 时刻 Q3 查出来的是 id=0、id=1 和 id=5 的这三行。</li>
</ol>
<p>其中，Q3 读到 id=1 这一行的现象，被称为“幻读”。也就是说，幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。</p>
<p>这里，我需要对“幻读”做一个说明：</p>
<ol>
<li>在可重复读隔离级别下，普通的查询是快照读，是不会看到别的事务插入的数据的。因此，幻读在“当前读”下才会出现。</li>
<li>上面 session B 的修改结果，被 session A 之后的 select 语句用“当前读”看到，不能称为幻读。幻读仅专指“新插入的行”。</li>
</ol>
<p>如果只从第 8 篇文章[《事务到底是隔离的还是不隔离的？》]我们学到的事务可见性规则来分析的话，上面这三条 SQL 语句的返回结果都没有问题。</p>
<p>因为这三个查询都是加了 for update，都是当前读。而当前读的规则，就是要能读到所有已经提交的记录的最新值。并且，session B 和 sessionC 的两条语句，执行后就会提交，所以 Q2 和 Q3 就是应该看到这两个事务的操作效果，而且也看到了，这跟事务的可见性规则并不矛盾。</p>
<p>但是，这是不是真的没问题呢？</p>
<p>不，这里还真就有问题。</p>
<h3 id="_2">幻读有什么问题？<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>**首先是语义上的。**session A 在 T1 时刻就声明了，“我要把所有 d=5 的行锁住，不准别的事务进行读写操作”。而实际上，这个语义被破坏了。</p>
<p>如果现在这样看感觉还不明显的话，我再往 session B 和 session C 里面分别加一条 SQL 语句，你再看看会出现什么现象。</p>
<table>
<thead>
<tr>
<th></th>
<th>Session A</th>
<th>Session B</th>
<th>Session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />//result: (5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>update t set d=5 where id=0;<br />update t set c=5 where id=0;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d=5 fro update; /<em>Q2</em>/<br />//result: (0,0,5), (5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d=5 fro update; /<em>Q3</em>/<br />//result: (0,0,5),(1,1,5),(5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>session B 的第二条语句 <code>update t set c=5 where id=0</code>，语义是“我把 id=0、d=5 这一行的 c 值，改成了 5”。</p>
<p>由于在 T1 时刻，session A 还只是给 id=5 这一行加了行锁， 并没有给 id=0 这行加上锁。因此，session B 在 T2 时刻，是可以执行这两条 update 语句的。这样，就破坏了 session A 里 Q1 语句要锁住所有 d=5 的行的加锁声明。</p>
<p>session C 也是一样的道理，对 id=1 这一行的修改，也是破坏了 Q1 的加锁声明。</p>
<p><strong>其次，是数据一致性的问题。</strong></p>
<p>我们知道，锁的设计是为了保证数据的一致性。而这个一致性，不止是数据库内部数据状态在此刻的一致性，还包含了数据和日志在逻辑上的一致性。</p>
<p>为了说明这个问题，我给 session A 在 T1 时刻再加一个更新语句，即：<code>update t set d=100 where d=5</code>。</p>
<table>
<thead>
<tr>
<th></th>
<th>Session A</th>
<th>Session B</th>
<th>Session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />update t set d=100 where d=5;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>update t set d=5 where id=0;<br />update t set c=5 where id=0;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d=5 fro update; /<em>Q2</em>/</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d=5 fro update; /<em>Q3</em>/</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>update 的加锁语义和 <code>select …for update</code> 是一致的，所以这时候加上这条 update 语句也很合理。session A 声明说“要给 d=5 的语句加上锁”，就是为了要更新数据，新加的这条 update 语句就是把它认为加上了锁的这一行的 d 值修改成了 100。</p>
<p>现在，我们来分析一下图 3 执行完成后，数据库里会是什么结果。</p>
<ol>
<li>经过 T1 时刻，id=5 这一行变成 (5,5,100)，当然这个结果最终是在 T6 时刻正式提交的 ;</li>
<li>经过 T2 时刻，id=0 这一行变成 (0,5,5);</li>
<li>经过 T4 时刻，表里面多了一行 (1,5,5);</li>
<li>其他行跟这个执行序列无关，保持不变。</li>
</ol>
<p>这样看，这些数据也没啥问题，但是我们再来看看这时候 binlog 里面的内容。</p>
<ol>
<li>T2 时刻，session B 事务提交，写入了两条语句；</li>
<li>T4 时刻，session C 事务提交，写入了两条语句；</li>
<li>T6 时刻，session A 事务提交，写入了 update t set d=100 where d=5 这条语句。</li>
</ol>
<p>我统一放到一起的话，就是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(0,0,5)*/</span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">c</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(0,5,5)*/</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="cm">/*(1,1,5)*/</span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">c</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(1,5,5)*/</span><span class="w"> </span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span><span class="cm">/* 所有 d=5 的行，d 改成 100*/</span>
</code></pre></div>
<p>好，你应该看出问题了。这个语句序列，不论是拿到备库去执行，还是以后用 binlog 来克隆一个库，这三行的结果，都变成了 (0,5,100)、(1,5,100) 和 (5,5,100)。</p>
<p>也就是说，id=0 和 id=1 这两行，发生了数据不一致。这个问题很严重，是不行的。</p>
<p>到这里，我们再回顾一下，<strong>这个数据不一致到底是怎么引入的？</strong></p>
<p>我们分析一下可以知道，这是我们假设 <code>select * from t where d=5 for update</code> 这条语句只给 d=5 这一行，也就是 id=5 的这一行加锁”导致的。</p>
<p>所以我们认为，上面的设定不合理，要改。</p>
<p>那怎么改呢？我们把扫描过程中碰到的行，也都加上写锁，再来看看执行效果。</p>
<table>
<thead>
<tr>
<th></th>
<th>Session A</th>
<th>Session B</th>
<th>Session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />update t set d=100 where d=5;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>update t set d=5 where id=0;<br />(blocked)<br />update t set c=5 where id=0;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d=5 fro update; /<em>Q2</em>/</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d=5 fro update; /<em>Q3</em>/</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>由于 session A 把所有的行都加了写锁，所以 session B 在执行第一个 update 语句的时候就被锁住了。需要等到 T6 时刻 session A 提交以后，session B 才能继续执行。</p>
<p>这样对于 id=0 这一行，在数据库里的最终结果还是 (0,5,5)。在 binlog 里面，执行序列是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="cm">/*(1,1,5)*/</span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">c</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(1,5,5)*/</span><span class="w"> </span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span><span class="cm">/* 所有 d=5 的行，d 改成 100*/</span><span class="w"> </span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(0,0,5)*/</span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">c</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/*(0,5,5)*/</span>
</code></pre></div>
<p>可以看到，按照日志顺序执行，id=0 这一行的最终结果也是 (0,5,5)。所以，id=0 这一行的问题解决了。</p>
<p>但同时你也可以看到，id=1 这一行，在数据库里面的结果是 (1,5,5)，而根据 binlog 的执行结果是 (1,5,100)，也就是说幻读的问题还是没有解决。为什么我们已经这么“凶残”地，把所有的记录都上了锁，还是阻止不了 id=1 这一行的插入和更新呢？</p>
<p>原因很简单。在 T3 时刻，我们给所有行加锁的时候，id=1 这一行还不存在，不存在也就加不上锁。</p>
<p>**也就是说，即使把所有的记录都加上锁，还是阻止不了新插入的记录，**这也是为什么“幻读”会被单独拿出来解决的原因。</p>
<p>到这里，其实我们刚说明完文章的标题 ：幻读的定义和幻读有什么问题。</p>
<p>接下来，我们再看看 InnoDB 怎么解决幻读的问题。</p>
<h3 id="_3">如何解决幻读？<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>现在你知道了，产生幻读的原因是，行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”。因此，为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。</p>
<p>顾名思义，间隙锁，锁的就是两个值之间的空隙。比如文章开头的表 t，初始化插入了 6 个记录，这就产生了 7 个间隙。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/e7f7ca0d3dab2f48c588d714ee3ac861.png" /></p>
<p>图 5 表 t 主键索引上的行锁和间隙锁</p>
<p>这样，当你执行 <code>select * from t where d=5 for update</code> 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。</p>
<p>也就是说这时候，在一行行扫描的过程中，不仅将给行加上了行锁，还给行两边的空隙，也加上了间隙锁。</p>
<p>现在你知道了，数据行是可以加上锁的实体，数据行之间的间隙，也是可以加上锁的实体。但是间隙锁跟我们之前碰到过的锁都不太一样。</p>
<p>比如行锁，分成读锁和写锁。下图就是这两种类型行锁的冲突关系。</p>
<table>
<thead>
<tr>
<th></th>
<th>读锁</th>
<th>写锁</th>
</tr>
</thead>
<tbody>
<tr>
<td>读锁</td>
<td><font color='green'>兼容</font></td>
<td><font color='red'>冲突</font></td>
</tr>
<tr>
<td>写锁</td>
<td><font color='red'>冲突</font></td>
<td><font color='red'>冲突</font></td>
</tr>
</tbody>
</table>
<p>也就是说，跟行锁有冲突关系的是“另外一个行锁”。</p>
<p>但是间隙锁不一样，**跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。**间隙锁之间都不存在冲突关系。</p>
<p>这句话不太好理解，我给你举个例子：</p>
<table>
<thead>
<tr>
<th>Session A</th>
<th>Session B</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where c=7 lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>begin;<br />select * from t where c = 7 for update;</td>
</tr>
</tbody>
</table>
<p>这里 session B 并不会被堵住。因为表 t 里并没有 c=7 这个记录，因此 session A 加的是间隙锁 (5,10)。而 session B 也是在这个间隙加的间隙锁。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的。</p>
<p>间隙锁和行锁合称 next-key lock，每个 next-key lock 是前开后闭区间。也就是说，我们的表 t 初始化以后，如果用 <code>select * from t for update</code> 要把整个表所有记录锁起来，就形成了 7 个 next-key lock，分别是 <code>(-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]</code>。</p>
<blockquote>
<p>备注：这篇文章中，如果没有特别说明，我们把间隙锁记为开区间，把 next-key lock 记为前开后闭区间。</p>
</blockquote>
<p>你可能会问说，这个 supremum 从哪儿来的呢？</p>
<p>这是因为 <code>+∞</code> 是开区间。实现上，InnoDB 给每个索引加了一个不存在的最大值 supremum，这样才符合我们前面说的“都是前开后闭区间”。</p>
<p><strong>间隙锁和 next-key lock 的引入，帮我们解决了幻读的问题，但同时也带来了一些“困扰”。</strong></p>
<p>在前面的文章中，就有同学提到了这个问题。我把他的问题转述一下，对应到我们这个例子的表来说，业务逻辑这样的：任意锁住一行，如果这一行不存在的话就插入，如果存在这一行就更新它的数据，代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">begin</span><span class="p">;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="n">N</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span><span class="w"> </span>
<span class="cm">/* 如果行不存在 */</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>
<span class="cm">/* 如果行存在 */</span>
<span class="k">update</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="n">N</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="n">N</span><span class="p">;</span><span class="w"> </span>
<span class="k">commit</span><span class="p">;</span>
</code></pre></div>
<p>可能你会说，这个不是 <code>insert … on duplicate key update</code> 就能解决吗？但其实在有多个唯一键的时候，这个方法是不能满足这位提问同学的需求的。至于为什么，我会在后面的文章中再展开说明。</p>
<p>现在，我们就只讨论这个逻辑。</p>
<p>这个同学碰到的现象是，这个逻辑一旦有并发，就会碰到死锁。你一定也觉得奇怪，这个逻辑每次操作前用 for update 锁起来，已经是最严格的模式了，怎么还会有死锁呢？</p>
<p>这里，我用两个 session 来模拟并发，并假设 N=9。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where id=9 for update;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>begin;<br />select * from t where id=9 for update;</td>
</tr>
<tr>
<td></td>
<td>insert into t values(9,9,9);<br /><font color='red'>(blocked)</font></td>
</tr>
<tr>
<td>insert into t values(9,9,9);<br /><font color='red'>(Error 1213(40001): Deadlock found)</font></td>
<td></td>
</tr>
</tbody>
</table>
<p>你看到了，其实都不需要用到后面的 update 语句，就已经形成死锁了。我们按语句执行顺序来分析一下：</p>
<ol>
<li>session A 执行 <code>select … for update</code> 语句，由于 id=9 这一行并不存在，因此会加上间隙锁 (5,10);</li>
<li>session B 执行 <code>select … for update</code> 语句，同样会加上间隙锁 (5,10)，间隙锁之间不会冲突，因此这个语句可以执行成功；</li>
<li>session B 试图插入一行 (9,9,9)，被 session A 的间隙锁挡住了，只好进入等待；</li>
<li>session A 试图插入一行 (9,9,9)，被 session B 的间隙锁挡住了。</li>
</ol>
<p>至此，两个 session 进入互相等待状态，形成死锁。当然，InnoDB 的死锁检测马上就发现了这对死锁关系，让 session A 的 insert 语句报错返回了。</p>
<p>你现在知道了，<strong>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的</strong>。其实，这还只是一个简单的例子，在下一篇文章中我们还会碰到更多、更复杂的例子。</p>
<p>你可能会说，为了解决幻读的问题，我们引入了这么一大串内容，有没有更简单一点的处理方法呢。</p>
<p>我在文章一开始就说过，如果没有特别说明，今天和你分析的问题都是在 <strong>可重复读</strong> 隔离级别下的，间隙锁是在可重复读隔离级别下才会生效的。所以，你如果把隔离级别设置为 **读已提交**的话，就没有间隙锁了。但同时，你要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row。这，也是现在不少公司使用的配置组合。</p>
<p>前面文章的评论区有同学留言说，他们公司就使用的是读提交隔离级别加 <code>binlog_format=row</code> 的组合。他曾问他们公司的 DBA 说，你为什么要这么配置。DBA 直接答复说，因为大家都这么用呀。</p>
<p>所以，这个同学在评论区就问说，这个配置到底合不合理。</p>
<p>关于这个问题本身的答案是，如果读提交隔离级别够用，也就是说，业务不需要可重复读的保证，这样考虑到读提交下操作数据的锁范围更小（没有间隙锁），这个选择是合理的。</p>
<p>但其实我想说的是，配置是否合理，跟业务场景有关，需要具体问题具体分析。</p>
<p>但是，如果 DBA 认为之所以这么用的原因是“大家都这么用”，那就有问题了，或者说，迟早会出问题。</p>
<p>比如说，大家都用读提交，可是逻辑备份的时候，mysqldump 为什么要把备份线程设置成可重复读呢？（这个我在前面的文章中已经解释过了，你可以再回顾下第 6 篇文章[《全局锁和表锁 ：给表加个字段怎么有这么多阻碍？》]的内容）</p>
<p>然后，在备份期间，备份线程用的是可重复读，而业务线程用的是读提交。同时存在两种事务隔离级别，会不会有问题？</p>
<p>进一步地，这两个不同的隔离级别现象有什么不一样的，关于我们的业务，“用读提交就够了”这个结论是怎么得到的？</p>
<p>如果业务开发和运维团队这些问题都没有弄清楚，那么“没问题”这个结论，本身就是有问题的。</p>
<h3 id="_4">小结<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>今天我们从上一篇文章的课后问题说起，提到了全表扫描的加锁方式。我们发现即使给所有的行都加上行锁，仍然无法解决幻读问题，因此引入了间隙锁的概念。</p>
<p>我碰到过很多对数据库有一定了解的业务开发人员，他们在设计数据表结构和业务 SQL 语句的时候，对行锁有很准确的认识，但却很少考虑到间隙锁。最后的结果，就是生产库上会经常出现由于间隙锁导致的死锁现象。</p>
<p>行锁确实比较直观，判断规则也相对简单，间隙锁的引入会影响系统的并发度，也增加了锁分析的复杂度，但也有章可循。下一篇文章，我就会为你讲解 InnoDB 的加锁规则，帮你理顺这其中的“章法”。</p>
<p>作为对下一篇文章的预习，我给你留下一个思考题。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where c&gt;=15 <br />and c&lt;=20 order by c desc for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(11,11,11)</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(6,6,6);</td>
</tr>
</tbody>
</table>
<p>如果你之前没有了解过本篇文章的相关内容，一定觉得这三个语句简直是风马牛不相及。但实际上，这里 session B 和 session C 的 insert 语句都会进入锁等待状态。</p>
<p>你可以试着分析一下，出现这种情况的原因是什么？</p>
<h2 id="21">21 为什么我只改一行的语句，锁这么多？<a class="headerlink" href="#21" title="Permanent link">&para;</a></h2>
<p>在上一篇文章中，我和你介绍了间隙锁和 next-key lock 的概念，但是并没有说明加锁规则。间隙锁的概念理解起来确实有点儿难，尤其在配合上行锁以后，很容易在判断是否会出现锁等待的问题上犯错。</p>
<p>所以今天，我们就先从这个加锁规则开始吧。</p>
<p>首先说明一下，这些加锁规则我没在别的地方看到过有类似的总结，以前我自己判断的时候都是想着代码里面的实现来脑补的。这次为了总结成不看代码的同学也能理解的规则，是我又重新刷了代码临时总结出来的。所以，<strong>这个规则有以下两条前提说明：</strong></p>
<ol>
<li>MySQL 后面的版本可能会改变加锁策略，所以这个规则只限于截止到现在的最新版本，即 5.x 系列 \&lt;=5.7.24，8.0 系列 \&lt;=8.0.13。</li>
<li>如果大家在验证中有发现 bad case 的话，请提出来，我会再补充进这篇文章，使得一起学习本专栏的所有同学都能受益。</li>
</ol>
<p>因为间隙锁在可重复读隔离级别下才有效，所以本篇文章接下来的描述，若没有特殊说明，默认是可重复读隔离级别。</p>
<p><strong>我总结的加锁规则里面，包含了两个“原则”、两个“优化”和一个“bug”。</strong></p>
<ol>
<li>原则 1：加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。</li>
<li>原则 2：查找过程中访问到的对象才会加锁。</li>
<li>优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。</li>
<li>优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。</li>
<li>一个 bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</li>
</ol>
<p>我还是以上篇文章的表 t 为例，和你解释一下这些规则。表 t 的建表语句和初始化语句如下。</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">d</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),(</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">);</span>
</code></pre></div>
<p>接下来的例子基本都是配合着图片说明的，所以我建议你可以对照着文稿看，有些例子可能会“毁三观”，也建议你读完文章后亲手实践一下。</p>
<h3 id="_5">案例一：等值查询间隙锁<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>第一个例子是关于等值条件操作间隙：</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />update t set d = d + 1 where id =7;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(8,8,8);<br /><font color='red'>(blocked)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d=d+1 where id=10;<br /><font color='green'>(Query OK)</font></td>
</tr>
</tbody>
</table>
<p>由于表 t 中没有 id=7 的记录，所以用我们上面提到的加锁规则判断一下的话：</p>
<ol>
<li>根据原则 1，加锁单位是 next-key lock，session A 加锁范围就是 (5,10]；</li>
<li>同时根据优化 2，这是一个等值查询 (id=7)，而 id=10 不满足查询条件，next-key lock 退化成间隙锁，因此最终加锁的范围是 (5,10)。</li>
</ol>
<p>所以，session B 要往这个间隙里面插入 id=8 的记录会被锁住，但是 session C 修改 id=10 这行是可以的。</p>
<h3 id="_6">案例二：非唯一索引等值锁<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>第二个例子是关于覆盖索引上的锁：</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select id from t where c=5 lock in share mode;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d=d+1 where id=5;<br /><font color='green'>(Query OK)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(7,7,7);<br /><font color='red'>(blocked)</font></td>
</tr>
</tbody>
</table>
<p>看到这个例子，你是不是有一种“该锁的不锁，不该锁的乱锁”的感觉？我们来分析一下吧。</p>
<p>这里 session A 要给索引 c 上 c=5 的这一行加上读锁。</p>
<ol>
<li>根据原则 1，加锁单位是 next-key lock，因此会给 (0,5] 加上 next-key lock。</li>
<li>要注意 c 是普通索引，因此仅访问 c=5 这一条记录是不能马上停下来的，需要向右遍历，查到 c=10 才放弃。根据原则 2，访问到的都要加锁，因此要给 (5,10] 加 next-key lock。</li>
<li>但是同时这个符合优化 2：等值判断，向右遍历，最后一个值不满足 c=5 这个等值条件，因此退化成间隙锁 (5,10)。</li>
<li>根据原则 2 ，<strong>只有访问到的对象才会加锁</strong>，这个查询使用覆盖索引，并不需要访问主键索引，所以主键索引上没有加任何锁，这就是为什么 session B 的 update 语句可以执行完成。</li>
</ol>
<p>但 session C 要插入一个 (7,7,7) 的记录，就会被 session A 的间隙锁 (5,10) 锁住。</p>
<p>需要注意，在这个例子中，lock in share mode 只锁覆盖索引，但是如果是 for update 就不一样了。 执行 for update 时，系统会认为你接下来要更新数据，因此会顺便给主键索引上满足条件的行加上行锁。</p>
<p>这个例子说明，锁是加在索引上的；同时，它给我们的指导是，如果你要用 lock in share mode 来给行加读锁避免数据被更新的话，就必须得绕过覆盖索引的优化，在查询字段中加入索引中不存在的字段。比如，将 session A 的查询语句改成 <code>select d from t where c=5 lock in share mode</code>。你可以自己验证一下效果。</p>
<h3 id="_7">案例三：主键索引范围锁<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>第三个例子是关于范围查询的。</p>
<p>举例之前，你可以先思考一下这个问题：对于我们这个表 t，下面这两条查询语句，加锁范围相同吗？</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">&gt;=</span><span class="mi">10</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">id</span><span class="o">&lt;</span><span class="mi">11</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span>
</code></pre></div>
<p>你可能会想，id 定义为 int 类型，这两个语句就是等价的吧？其实，它们并不完全等价。</p>
<p>在逻辑上，这两条查语句肯定是等价的，但是它们的加锁规则不太一样。现在，我们就让 session A 执行第二个查询语句，来看看加锁效果。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where id&gt;=10 and id&lt;11 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(8,8,8);<br /><font color='green'>(Query OK)</font><br />insert into t values(13,13,13);<br /><font color='red'>(blocked)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d =d+1 where id=15;<br /><font color='red'>(blocked)</font></td>
</tr>
</tbody>
</table>
<p>现在我们就用前面提到的加锁规则，来分析一下 session A 会加什么锁呢？</p>
<ol>
<li>开始执行的时候，要找到第一个 id=10 的行，因此本该是 next-key lock(5,10]。 根据优化 1， 主键 id 上的等值条件，退化成行锁，只加了 id=10 这一行的行锁。</li>
<li>范围查找就往后继续找，找到 id=15 这一行停下来，因此需要加 next-key lock(10,15]。</li>
</ol>
<p>所以，session A 这时候锁的范围就是主键索引上，行锁 id=10 和 next-key lock(10,15]。这样，session B 和 session C 的结果你就能理解了。</p>
<p>这里你需要注意一点，首次 session A 定位查找 id=10 的行的时候，是当做等值查询来判断的，而向右扫描到 id=15 的时候，用的是范围查询判断。</p>
<h3 id="_8">案例四：非唯一索引范围锁<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>接下来，我们再看两个范围查询加锁的例子，你可以对照着案例三来看。</p>
<p>需要注意的是，与案例三不同的是，案例四中查询语句的 where 部分用的是字段 c。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where c&gt;=10 and c&lt;11 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(8,8,8);<br /><font color='red'>(blocked)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d =d+1 where c=15;<br /><font color='red'>(blocked)</font></td>
</tr>
</tbody>
</table>
<p>这次 session A 用字段 c 来判断，加锁规则跟案例三唯一的不同是：在第一次用 c=10 定位记录的时候，索引 c 上加了 (5,10] 这个 next-key lock 后，由于索引 c 是非唯一索引，没有优化规则，也就是说不会蜕变为行锁，因此最终 sesion A 加的锁是，索引 c 上的 (5,10] 和 (10,15] 这两个 next-key lock。</p>
<p>所以从结果上来看，sesson B 要插入（8,8,8) 的这个 insert 语句时就被堵住了。</p>
<p>这里需要扫描到 c=15 才停止扫描，是合理的，因为 InnoDB 要扫到 c=15，才知道不需要继续往后找了。</p>
<h3 id="bug">案例五：唯一索引范围锁 bug<a class="headerlink" href="#bug" title="Permanent link">&para;</a></h3>
<p>前面的四个案例，我们已经用到了加锁规则中的两个原则和两个优化，接下来再看一个关于加锁规则中 bug 的案例。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select * from t where id&gt;10 and id&lt;=11 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d=d+1 where id=20;<br /><font color='red'>(blocked)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(16,16,16);<br /><font color='red'>(blocked)</font></td>
</tr>
</tbody>
</table>
<p>session A 是一个范围查询，按照原则 1 的话，应该是索引 id 上只加 (10,15] 这个 next-key lock，并且因为 id 是唯一键，所以循环判断到 id=15 这一行就应该停止了。</p>
<p>但是实现上，InnoDB 会往前扫描到第一个不满足条件的行为止，也就是 id=20。而且由于这是个范围扫描，因此索引 id 上的 (15,20] 这个 next-key lock 也会被锁上。</p>
<p>所以你看到了，session B 要更新 id=20 这一行，是会被锁住的。同样地，session C 要插入 id=16 的一行，也会被锁住。</p>
<p>照理说，这里锁住 id=20 这一行的行为，其实是没有必要的。因为扫描到 id=15，就可以确定不用往后再找了。但实现上还是这么做了，因此我认为这是个 bug。</p>
<p>我也曾找社区的专家讨论过，官方 bug 系统上也有提到，但是并未被 verified。所以，认为这是 bug 这个事儿，也只能算我的一家之言，如果你有其他见解的话，也欢迎你提出来。</p>
<h3 id="_9">案例六：非唯一索引上存在"等值"的例子<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>接下来的例子，是为了更好地说明“间隙”这个概念。这里，我给表 t 插入一条新记录。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span><span class="p">);</span>
</code></pre></div>
<p>新插入的这一行 c=10，也就是说现在表里有两个 c=10 的行。那么，这时候索引 c 上的间隙是什么状态了呢？你要知道，由于非唯一索引上包含主键的值，所以是不可能存在“相同”的两行的。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/c1fda36c1502606eb5be3908011ba159.png" /></p>
<p>图 6 非唯一索引等值的例子</p>
<p>可以看到，虽然有两个 c=10，但是它们的主键值 id 是不同的（分别是 10 和 30），因此这两个 c=10 的记录之间，也是有间隙的。</p>
<p>图中我画出了索引 c 上的主键 id。为了跟间隙锁的开区间形式进行区别，我用 <code>(c=10,id=30)</code> 这样的形式，来表示索引上的一行。</p>
<p>现在，我们来看一下案例六。</p>
<p>这次我们用 delete 语句来验证。注意，delete 语句加锁的逻辑，其实跟 <code>select ... for update</code> 是类似的，也就是我在文章开始总结的两个“原则”、两个“优化”和一个“bug”。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />delete from t where c=10;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(12,12,12);<br /><font color='red'>(blocked)</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d =d+1 where c=15;<br /><font color='green'>(Query OK)</font></td>
</tr>
</tbody>
</table>
<p>这时，session A 在遍历的时候，先访问第一个 c=10 的记录。同样地，根据原则 1，这里加的是 <code>(c=5,id=5)</code> 到 <code>(c=10,id=10)</code> 这个 next-key lock。</p>
<p>然后，session A 向右查找，直到碰到 <code>(c=15,id=15)</code> 这一行，循环才结束。根据优化 2，这是一个等值查询，向右查找到了不满足条件的行，所以会退化成 <code>(c=10,id=10)</code> 到 <code>(c=15,id=15)</code> 的间隙锁。</p>
<p>也就是说，这个 delete 语句在索引 c 上的加锁范围，就是下图中蓝色区域覆盖的部分。<img alt="img" src="../../../images/mysql-lecture-45/bb0ad92483d71f0dcaeeef278f89cb24.png" /></p>
<p>图 8 delete 加锁效果示例</p>
<p>这个蓝色区域左右两边都是虚线，表示开区间，即 (c=5,id=5) 和 (c=15,id=15) 这两行上都没有锁。</p>
<h3 id="limit">案例七：limit 语句加锁<a class="headerlink" href="#limit" title="Permanent link">&para;</a></h3>
<p>例子 6 也有一个对照案例，场景如下所示：</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />delete from t where c=10 limit 2;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values(12,12,12);<br /><font color='green'>(Query OK)</font></td>
</tr>
</tbody>
</table>
<p>这个例子里，session A 的 delete 语句加了 limit 2。你知道表 t 里 c=10 的记录其实只有两条，因此加不加 limit 2，删除的效果都是一样的，但是加锁的效果却不同。可以看到，session B 的 insert 语句执行通过了，跟案例六的结果不同。</p>
<p>这是因为，案例七里的 delete 语句明确加了 limit 2 的限制，因此在遍历到 (c=10, id=30) 这一行之后，满足条件的语句已经有两条，循环就结束了。</p>
<p>因此，索引 c 上的加锁范围就变成了从（c=5,id=5) 到（c=10,id=30) 这个前开后闭区间，如下图所示：<img alt="img" src="../../../images/mysql-lecture-45/e5408ed94b3d44985073255db63bd0d5.png" /></p>
<p>图 10 带 limit 2 的加锁效果</p>
<p>可以看到，(c=10,id=30）之后的这个间隙并没有在加锁范围里，因此 insert 语句插入 c=12 是可以执行成功的。</p>
<p>这个例子对我们实践的指导意义就是，<strong>在删除数据的时候尽量加 limit</strong>。这样不仅可以控制删除数据的条数，让操作更安全，还可以减小加锁的范围。</p>
<h3 id="_10">案例八：一个死锁的例子<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>前面的例子中，我们在分析的时候，是按照 next-key lock 的逻辑来分析的，因为这样分析比较方便。最后我们再看一个案例，目的是说明：next-key lock 实际上是间隙锁和行锁加起来的结果。</p>
<p>你一定会疑惑，这个概念不是一开始就说了吗？不要着急，我们先来看下面这个例子：</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;<br />select id from t where c=10 lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d=d+1 where c=10;<br /><font color='red'>(blocked)</font></td>
</tr>
<tr>
<td>insert into t values(8,8,8);</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ERROR 1213 (40001):<br />Deadlock found where trying to get lock;<br />try restarting transaction</td>
</tr>
</tbody>
</table>
<p>现在，我们按时间顺序来分析一下为什么是这样的结果。</p>
<ol>
<li>session A 启动事务后执行查询语句加 <code>lock in share mode</code>，在索引 c 上加了 next-key lock(5,10] 和间隙锁 (10,15)；</li>
<li>session B 的 update 语句也要在索引 c 上加 next-key lock(5,10] ，进入锁等待；</li>
<li>然后 session A 要再插入 <code>(8,8,8)</code> 这一行，被 session B 的间隙锁锁住。由于出现了死锁，InnoDB 让 session B 回滚。</li>
</ol>
<p>你可能会问，session B 的 next-key lock 不是还没申请成功吗？</p>
<p>其实是这样的，session B 的“加 next-key lock(5,10] ”操作，实际上分成了两步，先是加 (5,10) 的间隙锁，加锁成功；然后加 c=10 的行锁，这时候才被锁住的。</p>
<p>也就是说，我们在分析加锁规则的时候可以用 next-key lock 来分析。但是要知道，具体执行的时候，是要分成间隙锁和行锁两段来执行的。</p>
<h3 id="_11">小结<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>这里我再次说明一下，我们上面的所有案例都是在可重复读隔离级别 (repeatable-read) 下验证的。同时，可重复读隔离级别遵守两阶段锁协议，所有加锁的资源，都是在事务提交或者回滚的时候才释放的。</p>
<p>在最后的案例中，你可以清楚地知道 next-key lock 实际上是由间隙锁加行锁实现的。如果切换到读提交隔离级别 (read-committed) 的话，就好理解了，过程中去掉间隙锁的部分，也就是只剩下行锁的部分。</p>
<p>其实读提交隔离级别在外键场景下还是有间隙锁，相对比较复杂，我们今天先不展开。</p>
<p>另外，在读提交隔离级别下还有一个优化，即：语句执行过程中加上的行锁，在语句执行完成后，就要把“不满足条件的行”上的行锁直接释放了，不需要等到事务提交。</p>
<p>也就是说，读提交隔离级别下，锁的范围更小，锁的时间更短，这也是不少业务都默认使用读提交隔离级别的原因。</p>
<p>不过，我希望你学过今天的课程以后，可以对 next-key lock 的概念有更清晰的认识，并且会用加锁规则去判断语句的加锁范围。</p>
<p>在业务需要使用可重复读隔离级别的时候，能够更细致地设计操作数据库的语句，解决幻读问题的同时，最大限度地提升系统并行处理事务的能力。</p>
<h2 id="22-mysql">22 MySQL有哪些“饮鸩止渴”提高性能的方法？<a class="headerlink" href="#22-mysql" title="Permanent link">&para;</a></h2>
<p>不知道你在实际运维过程中有没有碰到这样的情景：业务高峰期，生产环境的 MySQL 压力太大，没法正常响应，需要短期内、临时性地提升一些性能。</p>
<p>我以前做业务护航的时候，就偶尔会碰上这种场景。用户的开发负责人说，不管你用什么方案，让业务先跑起来再说。</p>
<p>但，如果是无损方案的话，肯定不需要等到这个时候才上场。今天我们就来聊聊这些临时方案，并着重说一说它们可能存在的风险。</p>
<h3 id="_12">短连接风暴<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>正常的短连接模式就是连接到数据库后，执行很少的 SQL 语句就断开，下次需要的时候再重连。如果使用的是短连接，在业务高峰期的时候，就可能出现连接数突然暴涨的情况。</p>
<p>我在第 1 篇文章[《基础架构：一条 SQL 查询语句是如何执行的？》]中说过，MySQL 建立连接的过程，成本是很高的。除了正常的网络连接三次握手外，还需要做登录权限判断和获得这个连接的数据读写权限。</p>
<p>在数据库压力比较小的时候，这些额外的成本并不明显。</p>
<p>但是，短连接模型存在一个风险，就是一旦数据库处理得慢一些，连接数就会暴涨。<code>max_connections</code> 参数，用来控制一个 MySQL 实例同时存在的连接数的上限，超过这个值，系统就会拒绝接下来的连接请求，并报错提示 “Too many connections”。对于被拒绝连接的请求来说，从业务角度看就是数据库不可用。</p>
<p>在机器负载比较高的时候，处理现有请求的时间变长，每个连接保持的时间也更长。这时，再有新建连接的话，就可能会超过 <code>max_connections</code> 的限制。</p>
<p>碰到这种情况时，一个比较自然的想法，就是调高 <code>max_connections</code> 的值。但这样做是有风险的。因为设计 <code>max_connections</code> 这个参数的目的是想保护 MySQL，如果我们把它改得太大，让更多的连接都可以进来，那么系统的负载可能会进一步加大，大量的资源耗费在权限验证等逻辑上，结果可能是适得其反，已经连接的线程拿不到 CPU 资源去执行业务的 SQL 请求。</p>
<p>那么这种情况下，你还有没有别的建议呢？我这里还有两种方法，但要注意，这些方法都是有损的。</p>
<p><strong>第一种方法：先处理掉那些占着连接但是不工作的线程。</strong></p>
<p><code>max_connections</code> 的计算，不是看谁在 running，是只要连着就占用一个计数位置。对于那些不需要保持的连接，我们可以通过 <code>kill connection</code> 主动踢掉。这个行为跟事先设置 <code>wait_timeout</code> 的效果是一样的。设置 <code>wait_timeout</code> 参数表示的是，一个线程空闲 <code>wait_timeout</code> 这么多秒之后，就会被 MySQL 直接断开连接。</p>
<p>但是需要注意，在 show processlist 的结果里，踢掉显示为 sleep 的线程，可能是有损的。我们来看下面这个例子。</p>
<table>
<thead>
<tr>
<th></th>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody>
<tr>
<td>T</td>
<td>begin;<br />insert into t values(1,1);</td>
<td>select * from t where id=1;</td>
<td></td>
</tr>
<tr>
<td>T+30s</td>
<td></td>
<td></td>
<td>show processlist;</td>
</tr>
</tbody>
</table>
<p>在上面这个例子里，如果断开 session A 的连接，因为这时候 session A 还没有提交，所以 MySQL 只能按照回滚事务来处理；而断开 session B 的连接，就没什么大影响。所以，如果按照优先级来说，你应该优先断开像 session B 这样的事务外空闲的连接。</p>
<p>但是，怎么判断哪些是事务外空闲的呢？session C 在 T 时刻之后的 30 秒执行 show processlist，看到的结果是这样的。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">processlist</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">User</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Host</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">db</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Time</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">State</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">             </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>
<span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">event_scheduler</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Daemon</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">86184</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Waiting</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">             </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sleep</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">13</span><span class="w"> </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">             </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sleep</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">             </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">starting</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">processlist</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>
</code></pre></div>
<p>图中 id=20 和 id=22 的两个会话都是 Sleep 状态。而要看事务具体状态的话，你可以查 <code>information_schema</code> 库的 <code>innodb_trx</code> 表。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">innodb_trx</span><span class="w"> </span><span class="err">\</span><span class="k">G</span><span class="p">;</span>
<span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span>
<span class="w">                    </span><span class="n">trx_id</span><span class="p">:</span><span class="w"> </span><span class="mi">588510</span>
<span class="w">                 </span><span class="n">trx_state</span><span class="p">:</span><span class="w"> </span><span class="n">RUNNING</span>
<span class="w">               </span><span class="n">trx_started</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">57</span>
<span class="w">     </span><span class="n">trx_requested_lock_id</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">          </span><span class="n">trx_wait_started</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">                </span><span class="n">trx_weight</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">       </span><span class="n">trx_mysql_thread_id</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span>
<span class="w">                 </span><span class="n">trx_query</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">       </span><span class="n">trx_operation_state</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">         </span><span class="n">trx_tables_in_use</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="n">trx_tables_locked</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">          </span><span class="n">trx_lock_structs</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">     </span><span class="n">trx_lock_memory_bytes</span><span class="p">:</span><span class="w"> </span><span class="mi">1136</span>
<span class="w">           </span><span class="n">trx_rows_locked</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="n">trx_rows_modified</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">trx_concurrency_tickets</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">       </span><span class="n">trx_isolation_level</span><span class="p">:</span><span class="w"> </span><span class="k">REPEATABLE</span><span class="w"> </span><span class="k">READ</span>
<span class="w">         </span><span class="n">trx_unique_checks</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">trx_foreign_key_checks</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="n">trx_last_foreign_key_error</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span>
<span class="w"> </span><span class="n">trx_adaptive_hash_latched</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w"> </span><span class="n">trx_adaptive_hash_timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="n">trx_is_read_only</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">trx_autocommit_non_locking</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>这个结果里，<code>trx_mysql_thread_id=20</code>，表示 id=20 的线程还处在事务中。</p>
<p>因此，如果是连接数过多，你可以优先断开事务外空闲太久的连接；如果这样还不够，再考虑断开事务内空闲太久的连接。</p>
<p>从服务端断开连接使用的是 <code>kill connection + id</code> 的命令， 一个客户端处于 sleep 状态时，它的连接被服务端主动断开后，这个客户端并不会马上知道。直到客户端在发起下一个请求的时候，才会收到这样的报错 <code>ERROR 2013 (HY000): Lost connection to MySQL server during query</code>。</p>
<p>从数据库端主动断开连接可能是有损的，尤其是有的应用端收到这个错误后，不重新连接，而是直接用这个已经不能用的句柄重试查询。这会导致从应用端看上去，“MySQL 一直没恢复”。</p>
<p>你可能觉得这是一个冷笑话，但实际上我碰到过不下 10 次。</p>
<p>所以，如果你是一个支持业务的 DBA，不要假设所有的应用代码都会被正确地处理。即使只是一个断开连接的操作，也要确保通知到业务开发团队。</p>
<p><strong>第二种方法：减少连接过程的消耗。</strong></p>
<p>有的业务代码会在短时间内先大量申请数据库连接做备用，如果现在数据库确认是被连接行为打挂了，那么一种可能的做法，是让数据库跳过权限验证阶段。</p>
<p>跳过权限验证的方法是：重启数据库，并使用 <code>–-skip-grant-tables</code> 参数启动。这样，整个 MySQL 会跳过所有的权限验证阶段，包括连接过程和语句执行过程在内。</p>
<p>但是，这种方法特别符合我们标题里说的“饮鸩止渴”，风险极高，是我特别不建议使用的方案。尤其你的库外网可访问的话，就更不能这么做了。</p>
<p>在 MySQL 8.0 版本里，如果你启用 <code>-–skip-grant-tables</code> 参数，MySQL 会默认把 <code>--skip-networking</code> 参数打开，表示这时候数据库只能被本地的客户端连接。可见，MySQL 官方对 <code>--skip-grant-tables</code> 这个参数的安全问题也很重视。</p>
<p>除了短连接数暴增可能会带来性能问题外，实际上，我们在线上碰到更多的是查询或者更新语句导致的性能问题。其中，查询问题比较典型的有两类，一类是由新出现的慢查询导致的，一类是由 QPS（每秒查询数）突增导致的。而关于更新语句导致的性能问题，我会在下一篇文章和你展开说明。</p>
<h3 id="_13">慢查询性能问题<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在 MySQL 中，会引发性能问题的慢查询，大体有以下三种可能：</p>
<ol>
<li>索引没有设计好；</li>
<li>SQL 语句没写好；</li>
<li>MySQL 选错了索引。</li>
</ol>
<p>接下来，我们就具体分析一下这三种可能，以及对应的解决方案。</p>
<p><strong>导致慢查询的第一种可能是，索引没有设计好。</strong></p>
<p>这种场景一般就是通过紧急创建索引来解决。MySQL 5.6 版本以后，创建索引都支持 Online DDL 了，对于那种高峰期数据库已经被这个语句打挂了的情况，最高效的做法就是直接执行 alter table 语句。</p>
<p>比较理想的是能够在备库先执行。假设你现在的服务是一主一备，主库 A、备库 B，这个方案的大致流程是这样的：</p>
<ol>
<li>在备库 B 上执行 <code>set sql_log_bin=off</code>，也就是不写 binlog，然后执行 alter table 语句加上索引；</li>
<li>执行主备切换；</li>
<li>这时候主库是 B，备库是 A。在 A 上执行 <code>set sql_log_bin=off</code>，然后执行 alter table 语句加上索引。</li>
</ol>
<p>这是一个“古老”的 DDL 方案。平时在做变更的时候，你应该考虑类似 <a href="https://github.com/github/gh-ost">gh-ost</a> 这样的方案，更加稳妥。但是在需要紧急处理时，上面这个方案的效率是最高的。</p>
<p><strong>导致慢查询的第二种可能是，语句没写好。</strong></p>
<p>比如，我们犯了在第 18 篇文章[《为什么这些 SQL 语句逻辑相同，性能却差异巨大？》]中提到的那些错误，导致语句没有使用上索引。</p>
<p>这时，我们可以通过改写 SQL 语句来处理。MySQL 5.7 提供了 <code>query_rewrite</code> 功能，可以把输入的一种语句改写成另外一种模式。</p>
<p>比如，语句被错误地写成了 <code>select * from t where id + 1 = 10000</code>，你可以通过下面的方式，增加一个语句改写规则。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">query_rewrite</span><span class="p">.</span><span class="n">rewrite_rules</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">,</span><span class="w"> </span><span class="n">pattern_database</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;select * from t where id + 1 = ?&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;select * from t where id = ? - 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;test&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="k">call</span><span class="w"> </span><span class="n">query_rewrite</span><span class="p">.</span><span class="n">flush_rewrite_rules</span><span class="p">();</span>
</code></pre></div>
<p>这里，<code>call query_rewrite.flush_rewrite_rules()</code> 这个存储过程，是让插入的新规则生效，也就是我们说的“查询重写”。你可以用图 4 中的方法来确认改写规则是否生效。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----+------+------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">c</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="w">    </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----+------+------+</span>
<span class="o">|</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----+------+------+</span>
<span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">warnings</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="k">Level</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Message</span><span class="w">                                                                                                            </span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Note</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">1105</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="s1">&#39;select * from t where id + 1 = 1&#39;</span><span class="w"> </span><span class="n">rewritten</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;select * from t where id = 1 - 1&#39;</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">rewrite</span><span class="w"> </span><span class="n">plugin</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>
<span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>如果你在执行上述插入语句提示 <code>ERROR 1049 (42000): Unknown database 'query_rewrite'</code>，则说明你的数据库没有启用这个功能，启用方式如下，首先导入启用脚本</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">uroot</span><span class="w"> </span><span class="o">-</span><span class="n">h127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">share</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">install_rewriter</span><span class="p">.</span><span class="k">sql</span>
</code></pre></div>
<p>你可以通过下面的查询来确认已经启用了该功能</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="k">GLOBAL</span><span class="w"> </span><span class="n">VARIABLES</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;rewriter_enabled&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------+-------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">------------------+-------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">rewriter_enabled</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ON</span><span class="w">    </span><span class="o">|</span>
<span class="o">+</span><span class="c1">------------------+-------+</span>
</code></pre></div>
<p>如果你不需要这个功能了，则可以执行 <code>/usr/share/mysql/uninstall_rewriter.sql</code> 这个脚本来卸载</p>
<p><strong>导致慢查询的第三种可能是MySQL 选错了索引。</strong></p>
<p>这时候，应急方案就是给这个语句加上 <code>force index</code>。</p>
<p>同样地，使用查询重写功能，给原来的语句加上 <code>force index</code>，也可以解决这个问题。</p>
<p>上面我和你讨论的由慢查询导致性能问题的三种可能情况，实际上出现最多的是前两种，即：索引没设计好和语句没写好。而这两种情况，恰恰是完全可以避免的。比如，通过下面这个过程，我们就可以预先发现问题。</p>
<ol>
<li>上线前，在测试环境，把慢查询日志（slow log）打开，并且把 <code>long_query_time</code> 设置成 0，确保每个语句都会被记录入慢查询日志；</li>
<li>在测试表里插入模拟线上的数据，做一遍回归测试；</li>
<li>观察慢查询日志里每类语句的输出，特别留意 <code>Rows_examined</code> 字段是否与预期一致。</li>
</ol>
<p>不要吝啬这段花在上线前的“额外”时间，因为这会帮你省下很多故障复盘的时间。</p>
<p>如果新增的 SQL 语句不多，手动跑一下就可以。而如果是新项目的话，或者是修改了原有项目的 表结构设计，全量回归测试都是必要的。这时候，你需要工具帮你检查所有的 SQL 语句的返回结果。比如，你可以使用开源工具 <a href="https://docs.percona.com/percona-toolkit/pt-query-digest.html">pt-query-digest</a></p>
<h3 id="qps">QPS 突增问题<a class="headerlink" href="#qps" title="Permanent link">&para;</a></h3>
<p>有时候由于业务突然出现高峰，或者应用程序 bug，导致某个语句的 QPS 突然暴涨，也可能导致 MySQL 压力过大，影响服务。</p>
<p>我之前碰到过一类情况，是由一个新功能的 bug 导致的。当然，最理想的情况是让业务把这个功能下掉，服务自然就会恢复。</p>
<p>而下掉一个功能，如果从数据库端处理的话，对应于不同的背景，有不同的方法可用。</p>
<ol>
<li>一种是由全新业务的 bug 导致的。假设你的 DB 运维是比较规范的，也就是说白名单是一个个加的。这种情况下，如果你能够确定业务方会下掉这个功能，只是时间上没那么快，那么就可以从数据库端直接把白名单去掉。</li>
<li>如果这个新功能使用的是单独的数据库用户，可以用管理员账号把这个用户删掉，然后断开现有连接。这样，这个新功能的连接不成功，由它引发的 QPS 就会变成 0。</li>
<li>如果这个新增的功能跟主体功能是部署在一起的，那么我们只能通过处理语句来限制。这时，我们可以使用上面提到的查询重写功能，把压力最大的 SQL 语句直接重写成 <code>select 1</code> 返回。</li>
</ol>
<p>当然，这个操作的风险很高，需要你特别细致。它可能存在两个副作用：</p>
<ol>
<li>如果别的功能里面也用到了这个 SQL 语句模板，会有误伤；</li>
<li>很多业务并不是靠这一个语句就能完成逻辑的，所以如果单独把这一个语句以 <code>select 1</code> 的结果返回的话，可能会导致后面的业务逻辑一起失败。</li>
</ol>
<p>所以，方案 3 是用于止血的，跟前面提到的去掉权限验证一样，应该是你所有选项里优先级最低的一个方案。</p>
<p>同时你会发现，其实方案 1 和 2 都要依赖于规范的运维体系：虚拟化、白名单机制、业务账号分离。由此可见，更多的准备，往往意味着更稳定的系统。</p>
<h3 id="_14">小结<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>今天这篇文章，我以业务高峰期的性能问题为背景，和你介绍了一些紧急处理的手段。</p>
<p>这些处理手段中，既包括了粗暴地拒绝连接和断开连接，也有通过重写语句来绕过一些坑的方法；既有临时的高危方案，也有未雨绸缪的、相对安全的预案。</p>
<p>在实际开发中，我们也要尽量避免一些低效的方法，比如避免大量地使用短连接。同时，如果你做业务开发的话，要知道，连接异常断开是常有的事，你的代码里要有正确地重连并重试的机制。</p>
<p>DBA 虽然可以通过语句重写来暂时处理问题，但是这本身是一个风险高的操作，做好 SQL 审计可以减少需要这类操作的机会。</p>
<p>其实，你可以看得出来，在这篇文章中我提到的解决方法主要集中在 server 层。在下一篇文章中，我会继续和你讨论一些跟 InnoDB 有关的处理方法。</p>
<h2 id="23-mysql">23 MySQL是怎么保证数据不丢的？<a class="headerlink" href="#23-mysql" title="Permanent link">&para;</a></h2>
<p>今天这篇文章，我会继续和你介绍在业务高峰期临时提升性能的方法。从文章标题“MySQL 是怎么保证数据不丢的？”，你就可以看出来，今天我和你介绍的方法，跟数据的可靠性有关。</p>
<p>在专栏前面文章和答疑篇中，我都着重介绍了 WAL 机制，得到的结论是：只要 redo log 和 binlog 保证持久化到磁盘，就能确保 MySQL 异常重启后，数据可以恢复。</p>
<p>评论区有同学又继续追问，redo log 的写入流程是怎么样的，如何保证 redo log 真实地写入了磁盘。那么今天，我们就再一起看看 MySQL 写入 binlog 和 redo log 的流程。</p>
<h3 id="binlog">binlog 的写入机制<a class="headerlink" href="#binlog" title="Permanent link">&para;</a></h3>
<p>其实，binlog 的写入逻辑比较简单：事务执行过程中，先把日志写到 binlog cache，事务提交的时候，再把 binlog cache 写到 binlog 文件中。</p>
<p>一个事务的 binlog 是不能被拆开的，因此不论这个事务多大，也要确保一次性写入。这就涉及到了 binlog cache 的保存问题。</p>
<p>系统给 binlog cache 分配了一片内存，每个线程一个，参数 binlog_cache_size 用于控制单个线程内 binlog cache 所占内存的大小。如果超过了这个参数规定的大小，就要暂存到磁盘。</p>
<p>事务提交的时候，执行器把 binlog cache 里的完整事务写入到 binlog 中，并清空 binlog cache。状态如图 1 所示。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/9ed86644d5f39efb0efec595abb92e3e.png" /></p>
<p>图 1 binlog 写盘状态</p>
<p>可以看到，每个线程有自己 binlog cache，但是共用同一份 binlog 文件。</p>
<ul>
<li>图中的 write，指的就是指把日志写入到文件系统的 page cache，并没有把数据持久化到磁盘，所以速度比较快。</li>
<li>图中的 fsync，才是将数据持久化到磁盘的操作。一般情况下，我们认为 fsync 才占磁盘的 IOPS。</li>
</ul>
<p>write 和 fsync 的时机，是由参数 <code>sync_binlog</code> 控制的：</p>
<ol>
<li><code>sync_binlog=0</code> 的时候，表示每次提交事务都只 write，不 fsync；</li>
<li><code>sync_binlog=1</code> 的时候，表示每次提交事务都会执行 fsync；</li>
<li><code>sync_binlog=N</code>(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</li>
</ol>
<p>因此，在出现 IO 瓶颈的场景里，将 <code>sync_binlog</code> 设置成一个比较大的值，可以提升性能。在实际的业务场景中，考虑到丢失日志量的可控性，一般不建议将这个参数设成 0，比较常见的是将其设置为 100~1000 中的某个数值。</p>
<p>但是，将 <code>sync_binlog</code> 设置为 N，对应的风险是：如果主机发生异常重启，会丢失最近 N 个事务的 binlog 日志。</p>
<h3 id="redo-log">redo log 的写入机制<a class="headerlink" href="#redo-log" title="Permanent link">&para;</a></h3>
<p>接下来，我们再说说 redo log 的写入机制。</p>
<p>在专栏的[第 15 篇答疑文章]中，我给你介绍了 redo log buffer。事务在执行过程中，生成的 redo log 是要先写到 redo log buffer 的。</p>
<p>然后就有同学问了，redo log buffer 里面的内容，是不是每次生成后都要直接持久化到磁盘呢？</p>
<p>答案是，不需要。</p>
<p>如果事务执行期间 MySQL 发生异常重启，那这部分日志就丢了。由于事务并没有提交，所以这时日志丢了也不会有损失。</p>
<p>那么，另外一个问题是，事务还没提交的时候，redo log buffer 中的部分日志有没有可能被持久化到磁盘呢？</p>
<p>答案是，确实会有。</p>
<p>这个问题，要从 redo log 可能存在的三种状态说起。这三种状态，对应的就是图 2 中的三个颜色块。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/9d057f61d3962407f413deebc80526d4.png" /></p>
<p>图 2 MySQL redo log 存储状态</p>
<p>这三种状态分别是：</p>
<ol>
<li>存在 redo log buffer 中，物理上是在 MySQL 进程内存中，就是图中的红色部分；</li>
<li>写到磁盘 (write)，但是没有持久化（fsync)，物理上是在文件系统的 page cache 里面，也就是图中的黄色部分；</li>
<li>持久化到磁盘，对应的是 hard disk，也就是图中的绿色部分。</li>
</ol>
<p>日志写到 redo log buffer 是很快的，wirte 到 page cache 也差不多，但是持久化到磁盘的速度就慢多了。</p>
<p>为了控制 redo log 的写入策略，InnoDB 提供了 <code>innodb_flush_log_at_trx_commit</code> 参数，它有三种可能取值：</p>
<ol>
<li>设置为 0 的时候，表示每次事务提交时都只是把 redo log 留在 redo log buffer 中 ;</li>
<li>设置为 1 的时候，表示每次事务提交时都将 redo log 直接持久化到磁盘；</li>
<li>设置为 2 的时候，表示每次事务提交时都只是把 redo log 写到 page cache。</li>
</ol>
<p>InnoDB 有一个后台线程，每隔 1 秒，就会把 redo log buffer 中的日志，调用 write 写到文件系统的 page cache，然后调用 fsync 持久化到磁盘。</p>
<p>注意，事务执行中间过程的 redo log 也是直接写在 redo log buffer 中的，这些 redo log 也会被后台线程一起持久化到磁盘。也就是说，一个没有提交的事务的 redo log，也是可能已经持久化到磁盘的。</p>
<p>实际上，除了后台线程每秒一次的轮询操作外，还有两种场景会让一个没有提交的事务的 redo log 写入到磁盘中。</p>
<ol>
<li>**一种是，redo log buffer 占用的空间即将达到 innodb_log_buffer_size 一半的时候，后台线程会主动写盘。**注意，由于这个事务并没有提交，所以这个写盘动作只是 write，而没有调用 fsync，也就是只留在了文件系统的 page cache。</li>
<li>**另一种是，并行的事务提交的时候，顺带将这个事务的 redo log buffer 持久化到磁盘。**假设一个事务 A 执行到一半，已经写了一些 redo log 到 buffer 中，这时候有另外一个线程的事务 B 提交，如果 <code>innodb_flush_log_at_trx_commit</code> 设置的是 1，那么按照这个参数的逻辑，事务 B 要把 redo log buffer 里的日志全部持久化到磁盘。这时候，就会带上事务 A 在 redo log buffer 里的日志一起持久化到磁盘。</li>
</ol>
<p>这里需要说明的是，我们介绍两阶段提交的时候说过，时序上 redo log 先 prepare， 再写 binlog，最后再把 redo log commit。</p>
<p>如果把 <code>innodb_flush_log_at_trx_commit</code> 设置成 1，那么 redo log 在 prepare 阶段就要持久化一次，因为有一个崩溃恢复逻辑是要依赖于 prepare 的 redo log，再加上 binlog 来恢复的。</p>
<p>每秒一次后台轮询刷盘，再加上崩溃恢复这个逻辑，InnoDB 就认为 redo log 在 commit 的时候就不需要 fsync 了，只会 write 到文件系统的 page cache 中就够了。</p>
<p>通常我们说 MySQL 的“双 1”配置，指的就是 <code>sync_binlog</code> 和 <code>innodb_flush_log_at_trx_commit</code> 都设置成 1。也就是说，一个事务完整提交前，需要等待两次刷盘，一次是 redo log（prepare 阶段），一次是 binlog。</p>
<p>这时候，你可能有一个疑问，这意味着我从 MySQL 看到的 TPS 是每秒两万的话，每秒就会写四万次磁盘。但是，我用工具测试出来，磁盘能力也就两万左右，怎么能实现两万的 TPS？</p>
<p>解释这个问题，就要用到组提交（group commit）机制了。</p>
<p>这里，我需要先和你介绍日志逻辑序列号（log sequence number，LSN）的概念。LSN 是单调递增的，用来对应 redo log 的一个个写入点。每次写入长度为 length 的 redo log， LSN 的值就会加上 length。</p>
<p>LSN 也会写到 InnoDB 的数据页中，来确保数据页不会被多次执行重复的 redo log。关于 LSN 和 redo log、checkpoint 的关系，我会在后面的文章中详细展开。</p>
<p>如图 3 所示，是三个并发事务 (trx1, trx2, trx3) 在 prepare 阶段，都写完 redo log buffer，持久化到磁盘的过程，对应的 LSN 分别是 50、120 和 160。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/933fdc052c6339de2aa3bf3f65b188cc.png" /></p>
<p>图 3 redo log 组提交</p>
<p>从图中可以看到，</p>
<ol>
<li>trx1 是第一个到达的，会被选为这组的 leader；</li>
<li>等 trx1 要开始写盘的时候，这个组里面已经有了三个事务，这时候 LSN 也变成了 160；</li>
<li>trx1 去写盘的时候，带的就是 LSN=160，因此等 trx1 返回时，所有 LSN 小于等于 160 的 redo log，都已经被持久化到磁盘；</li>
<li>这时候 trx2 和 trx3 就可以直接返回了。</li>
</ol>
<p>所以，一次组提交里面，组员越多，节约磁盘 IOPS 的效果越好。但如果只有单线程压测，那就只能老老实实地一个事务对应一次持久化操作了。</p>
<p>在并发更新场景下，第一个事务写完 redo log buffer 以后，接下来这个 fsync 越晚调用，组员可能越多，节约 IOPS 的效果就越好。</p>
<p>为了让一次 fsync 带的组员更多，MySQL 有一个很有趣的优化：拖时间。在介绍两阶段提交的时候，我曾经给你画了一个图，现在我把它截过来。</p>
<pre class="mermaid"><code>graph TB
    A["写入redolog&lt;br/&gt;处于prepare阶段"]
    B["写 binlog"]
    C["提交事务&lt;br/&gt;处于 commit 状态"]

    A --&gt; B --&gt; C</code></pre>
<p>图 4 两阶段提交</p>
<p>图中，我把“写 binlog”当成一个动作。但实际上，写 binlog 是分成两步的：</p>
<ol>
<li>先把 binlog 从 binlog cache 中写到磁盘上的 binlog 文件；</li>
<li>调用 fsync 持久化。</li>
</ol>
<p>MySQL 为了让组提交的效果更好，把 redo log 做 fsync 的时间拖到了步骤 1 之后。也就是说，上面的图变成了这样：</p>
<pre class="mermaid"><code>graph TB
    A["1. redo log prepare: write"]
    B["2. binlog: write"]
    C["3. redo log preapre: fsync"]
    D["4. binlog: fsync"]
    E["5. redo log commit: write"]

    A --&gt; B --&gt; C 
    A .-&gt; C
    B .-&gt; D
    C --&gt; D 
    D --&gt; E</code></pre>
<p>图 5 两阶段提交细化</p>
<p>这么一来，binlog 也可以组提交了。在执行图 5 中第 4 步把 binlog fsync 到磁盘时，如果有多个事务的 binlog 已经写完了，也是一起持久化的，这样也可以减少 IOPS 的消耗。</p>
<p>不过通常情况下第 3 步执行得会很快，所以 binlog 的 write 和 fsync 间的间隔时间短，导致能集合到一起持久化的 binlog 比较少，因此 binlog 的组提交的效果通常不如 redo log 的效果那么好。</p>
<p>如果你想提升 binlog 组提交的效果，可以通过设置 <code>binlog_group_commit_sync_delay</code> 和 <code>binlog_group_commit_sync_no_delay_count</code> 来实现。</p>
<ol>
<li><code>binlog_group_commit_sync_delay</code> 参数，表示延迟多少微秒后才调用 fsync;</li>
<li><code>binlog_group_commit_sync_no_delay_count</code> 参数，表示累积多少次以后才调用 fsync。</li>
</ol>
<p>这两个条件是或的关系，也就是说只要有一个满足条件就会调用 fsync。</p>
<p>所以，当 <code>binlog_group_commit_sync_delay</code> 设置为 0 的时候，<code>binlog_group_commit_sync_no_delay_count</code> 也无效了。</p>
<p>之前有同学在评论区问到，WAL 机制是减少磁盘写，可是每次提交事务都要写 redo log 和 binlog，这磁盘读写次数也没变少呀？</p>
<p>现在你就能理解了，WAL 机制主要得益于两个方面：</p>
<ol>
<li>redo log 和 binlog 都是顺序写，磁盘的顺序写比随机写速度要快；</li>
<li>组提交机制，可以大幅度降低磁盘的 IOPS 消耗。</li>
</ol>
<p>分析到这里，我们再来回答这个问题：<strong>如果你的 MySQL 现在出现了性能瓶颈，而且瓶颈在 IO 上，可以通过哪些方法来提升性能呢？</strong></p>
<p>针对这个问题，可以考虑以下三种方法：</p>
<ol>
<li>设置 <code>binlog_group_commit_sync_delay</code> 和 <code>binlog_group_commit_sync_no_delay_count</code> 参数，减少 binlog 的写盘次数。这个方法是基于“额外的故意等待”来实现的，因此可能会增加语句的响应时间，但没有丢失数据的风险。</li>
<li>将 <code>sync_binlog</code> 设置为大于 1 的值（比较常见是 100~1000）。这样做的风险是，主机掉电时会丢 binlog 日志。</li>
<li>将 <code>innodb_flush_log_at_trx_commit</code> 设置为 2。这样做的风险是，主机掉电的时候会丢数据。</li>
</ol>
<p>我不建议你把 <code>innodb_flush_log_at_trx_commit</code> 设置成 0。因为把这个参数设置成 0，表示 redo log 只保存在内存中，这样的话 MySQL 本身异常重启也会丢数据，风险太大。而 redo log 写到文件系统的 page cache 的速度也是很快的，所以将这个参数设置成 2 跟设置成 0 其实性能差不多，但这样做 MySQL 异常重启时就不会丢数据了，相比之下风险会更小。</p>
<h3 id="_15">小结<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>在专栏的[第 2 篇]和[第 15 篇]文章中，我和你分析了，如果 redo log 和 binlog 是完整的，MySQL 是如何保证 crash-safe 的。今天这篇文章，我着重和你介绍的是 MySQL 是“怎么保证 redo log 和 binlog 是完整的”。</p>
<p>希望这三篇文章串起来的内容，能够让你对 crash-safe 这个概念有更清晰的理解。</p>
<p>之前的第 15 篇答疑文章发布之后，有同学继续留言问到了一些跟日志相关的问题，这里为了方便你回顾、学习，我再集中回答一次这些问题。</p>
<p>**问题 1：**执行一个 update 语句以后，我再去执行 hexdump 命令直接查看 ibd 文件内容，为什么没有看到数据有改变呢？</p>
<p>回答：这可能是因为 WAL 机制的原因。update 语句执行完成后，InnoDB 只保证写完了 redo log、内存，可能还没来得及将数据写到磁盘。</p>
<p>**问题 2：**为什么 binlog cache 是每个线程自己维护的，而 redo log buffer 是全局共用的？</p>
<p>回答：MySQL 这么设计的主要原因是，binlog 是不能“被打断的”。一个事务的 binlog 必须连续写，因此要整个事务完成后，再一起写到文件里。</p>
<p>而 redo log 并没有这个要求，中间有生成的日志可以写到 redo log buffer 中。redo log buffer 中的内容还能“搭便车”，其他事务提交的时候可以被一起写到磁盘中。</p>
<p>**问题 3：**事务执行期间，还没到提交阶段，如果发生 crash 的话，redo log 肯定丢了，这会不会导致主备不一致呢？</p>
<p>回答：不会。因为这时候 binlog 也还在 binlog cache 里，没发给备库。crash 以后 redo log 和 binlog 都没有了，从业务角度看这个事务也没有提交，所以数据是一致的。</p>
<p>**问题 4：**如果 binlog 写完盘以后发生 crash，这时候还没给客户端答复就重启了。等客户端再重连进来，发现事务已经提交成功了，这是不是 bug？</p>
<p>回答：不是。</p>
<p>你可以设想一下更极端的情况，整个事务都提交成功了，redo log commit 完成了，备库也收到 binlog 并执行了。但是主库和客户端网络断开了，导致事务成功的包返回不回去，这时候客户端也会收到“网络断开”的异常。这种也只能算是事务成功的，不能认为是 bug。</p>
<p>实际上数据库的 crash-safe 保证的是：</p>
<ol>
<li>如果客户端收到事务成功的消息，事务就一定持久化了；</li>
<li>如果客户端收到事务失败（比如主键冲突、回滚等）的消息，事务就一定失败了；</li>
<li>如果客户端收到“执行异常”的消息，应用需要重连后通过查询当前状态来继续后续的逻辑。此时数据库只需要保证内部（数据和日志之间，主库和备库之间）一致就可以了。</li>
</ol>
<h2 id="24-mysql">24 MySQL是怎么保证主备一致的？<a class="headerlink" href="#24-mysql" title="Permanent link">&para;</a></h2>
<p>在前面的文章中，我不止一次地和你提到了 binlog，大家知道 binlog 可以用来归档，也可以用来做主备同步，但它的内容是什么样的呢？为什么备库执行了 binlog 就可以跟主库保持一致了呢？今天我就正式地和你介绍一下它。</p>
<p>毫不夸张地说，MySQL 能够成为现下最流行的开源数据库，binlog 功不可没。</p>
<p>在最开始，MySQL 是以容易学习和方便的高可用架构，被开发人员青睐的。而它的几乎所有的高可用架构，都直接依赖于 binlog。虽然这些高可用架构已经呈现出越来越复杂的趋势，但都是从最基本的一主一备演化过来的。</p>
<p>今天这篇文章我主要为你介绍主备的基本原理。理解了背后的设计原理，你也可以从业务开发的角度，来借鉴这些设计思想。</p>
<h3 id="mysql">MySQL 主备的基本原理<a class="headerlink" href="#mysql" title="Permanent link">&para;</a></h3>
<p>如图 1 所示就是基本的主备切换流程。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/fd75a2b37ae6ca709b7f16fe060c2c10.png" /></p>
<p>图 1 MySQL 主备切换流程</p>
<p>在状态 1 中，客户端的读写都直接访问节点 A，而节点 B 是 A 的备库，只是将 A 的更新都同步过来，到本地执行。这样可以保持节点 B 和 A 的数据是相同的。</p>
<p>当需要切换的时候，就切成状态 2。这时候客户端读写访问的都是节点 B，而节点 A 是 B 的备库。</p>
<p>在状态 1 中，虽然节点 B 没有被直接访问，但是我依然建议你把节点 B（也就是备库）设置成只读（readonly）模式。这样做，有以下几个考虑：</p>
<ol>
<li>有时候一些运营类的查询语句会被放到备库上去查，设置为只读可以防止误操作；</li>
<li>防止切换逻辑有 bug，比如切换过程中出现双写，造成主备不一致；</li>
<li>可以用 readonly 状态，来判断节点的角色。</li>
</ol>
<p>你可能会问，我把备库设置成只读了，还怎么跟主库保持同步更新呢？</p>
<p>这个问题，你不用担心。因为 readonly 设置对超级 (super) 权限用户是无效的，而用于同步更新的线程，就拥有超级权限。</p>
<p>接下来，我们再看看**节点 A 到 B 这条线的内部流程是什么样的**。图 2 中画出的就是一个 update 语句在节点 A 执行，然后同步到节点 B 的完整流程图。</p>
<pre class="mermaid"><code>graph TB 
    subgraph A ["master A"]
    direction LR
    undo["undo log(mem)"] --&gt; data["data(mem)"] --&gt; redo["redo log(prepare)"] --&gt; binlog
    binlog --&gt; redo2["redo log (commit)"]
    binlog --&gt; dump["dump_thread"]

    bg_thread --&gt; undo2["undo log(disk)"] --&gt; data2["data(disk)"]
    end

    subgraph B ["slave B"]
        direction RL
        ioThread["io_thread"] --&gt; relay["relay log"] --&gt; sqlThread["sql_thread"] --&gt; dataB["DATA"] 
    end

    dump --&gt; ioThread
    start --&gt;undo
    redo2 --&gt; ack</code></pre>
<p>图 2 主备流程图</p>
<p>图 2 中，包含了我在上一篇文章中讲到的 binlog 和 redo log 的写入机制相关的内容，可以看到：主库接收到客户端的更新请求后，执行内部事务的更新逻辑，同时写 binlog。</p>
<p>备库 B 跟主库 A 之间维持了一个长连接。主库 A 内部有一个线程，专门用于服务备库 B 的这个长连接。一个事务日志同步的完整过程是这样的：</p>
<ol>
<li>在备库 B 上通过 change master 命令，设置主库 A 的 IP、端口、用户名、密码，以及要从哪个位置开始请求 binlog，这个位置包含文件名和日志偏移量。</li>
<li>在备库 B 上执行 start slave 命令，这时候备库会启动两个线程，就是图中的 <code>io_thread</code> 和 <code>sql_thread</code>。其中 <code>io_thread</code> 负责与主库建立连接。</li>
<li>主库 A 校验完用户名、密码后，开始按照备库 B 传过来的位置，从本地读取 binlog，发给 B。</li>
<li>备库 B 拿到 binlog 后，写到本地文件，称为中转日志（relay log）。</li>
<li><code>sql_thread</code> 读取中转日志，解析出日志里的命令，并执行。</li>
</ol>
<p>这里需要说明，后来由于多线程复制方案的引入，<code>sql_thread</code> 演化成为了多个线程，跟我们今天要介绍的原理没有直接关系，暂且不展开。</p>
<p>分析完了这个长连接的逻辑，我们再来看一个问题：binlog 里面到底是什么内容，为什么备库拿过去可以直接执行。</p>
<h3 id="binlog_1">binlog 的三种格式对比<a class="headerlink" href="#binlog_1" title="Permanent link">&para;</a></h3>
<p>我在[第 15 篇答疑文章]中，和你提到过 binlog 有两种格式，一种是 statement，一种是 row。可能你在其他资料上还会看到有第三种格式，叫作 mixed，其实它就是前两种格式的混合。</p>
<p>为了便于描述 binlog 的这三种格式间的区别，我创建了一个表，并初始化几行数据。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">t_modified</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">t_modified</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">t_modified</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;2018-11-13&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;2018-11-12&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;2018-11-11&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;2018-11-10&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;2018-11-09&#39;</span><span class="p">);</span>
</code></pre></div>
<p>如果要在表中删除一行数据的话，我们来看看这个 delete 语句的 binlog 是怎么记录的。</p>
<p>注意，下面这个语句包含注释，如果你用 MySQL 客户端来做这个实验的话，要记得加 -c 参数，否则客户端会自动去掉注释。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="cm">/*comment*/</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="o">&gt;=</span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">t_modified</span><span class="o">&lt;=</span><span class="s1">&#39;2018-11-10&#39;</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>当 binlog_format=statement 时，binlog 里面记录的就是 SQL 语句的原文。你可以用</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">binlog</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">&#39;binlog.000079&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">60602403</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Log_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Pos</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Event_type</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Server_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">End_log_pos</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">                                                                                   </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60602403</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Anonymous_Gtid</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60602482</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ANONYMOUS&#39;</span><span class="w">                                                   </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60602482</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60602572</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">BEGIN</span><span class="w">                                                                                  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60602572</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60602731</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">;</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="cm">/*comment*/</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="o">&gt;=</span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">t_modified</span><span class="o">&lt;=</span><span class="s1">&#39;2018-11-10&#39;</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60602731</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Xid</span><span class="w">            </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60602762</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">COMMIT</span><span class="w"> </span><span class="cm">/* xid=630521 */</span><span class="w">                                                                </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>
</code></pre></div>
<p>现在，我们来看一下输出结果。</p>
<ul>
<li>第一行 <code>SET @@SESSION.GTID_NEXT='ANONYMOUS'</code>你可以先忽略，后面文章我们会在介绍主备切换的时候再提到；</li>
<li>第二行是一个 BEGIN，跟第四行的 commit 对应，表示中间是一个事务；</li>
<li>第三行就是真实执行的语句了。可以看到，在真实执行的 delete 命令之前，还有一个 <code>use 'test'</code>命令。这条命令不是我们主动执行的，而是 MySQL 根据当前要操作的表所在的数据库，自行添加的。这样做可以保证日志传到备库去执行的时候，不论当前的工作线程在哪个库里，都能够正确地更新到 test 库的表 t。 <code>use 'test'</code> 命令之后的 delete 语句，就是我们输入的 SQL 原文了。可以看到，binlog“忠实”地记录了 SQL 命令，甚至连注释也一并记录了。</li>
<li>最后一行是一个 COMMIT。你可以看到里面写着 xid=630521。</li>
</ul>
<p>为了说明 statement 和 row 格式的区别，我们来看一下这条 delete 命令的执行效果图：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">warnings</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="k">Level</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Message</span><span class="w">                                                                                                                                                                                                                         </span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Note</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">1592</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Unsafe</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="n">written</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nb">binary</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">BINLOG_FORMAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">STATEMENT</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="n">clause</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">predicted</span><span class="p">.</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
</code></pre></div>
<p>可以看到，运行这条 delete 命令产生了一个 warning，原因是当前 binlog 设置的是 statement 格式，并且语句中有 limit，所以这个命令可能是 unsafe 的。</p>
<p>为什么这么说呢？这是因为 delete 带 limit，很可能会出现主备数据不一致的情况。比如上面这个例子：</p>
<ol>
<li>如果 delete 语句使用的是索引 a，那么会根据索引 a 找到第一个满足条件的行，也就是说删除的是 a=4 这一行；</li>
<li>但如果使用的是索引 <code>t_modified</code>，那么删除的就是 <code>t_modified='2018-11-09'</code>也就是 a=5 这一行。</li>
</ol>
<p>由于 statement 格式下，记录到 binlog 里的是语句原文，因此可能会出现这样一种情况：在主库执行这条 SQL 语句的时候，用的是索引 a；而在备库执行这条 SQL 语句的时候，却使用了索引 <code>t_modified</code>。因此，MySQL 认为这样写是有风险的。</p>
<p>那么，如果我把 binlog 的格式改为 <code>binlog_format=‘row’</code>， 是不是就没有这个问题了呢？我们先来看看这时候 binog 中的内容吧。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">binlog</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">&#39;binlog.000079&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">60603121</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Log_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Pos</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Event_type</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Server_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">End_log_pos</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">                                 </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603121</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Anonymous_Gtid</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603200</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ANONYMOUS&#39;</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603200</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603283</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">BEGIN</span><span class="w">                                </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603283</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Table_map</span><span class="w">      </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603333</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">table_id</span><span class="p">:</span><span class="w"> </span><span class="mi">154</span><span class="w"> </span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">t</span><span class="p">)</span><span class="w">               </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603333</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Delete_rows</span><span class="w">    </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603381</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">table_id</span><span class="p">:</span><span class="w"> </span><span class="mi">154</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="n">STMT_END_F</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603381</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Xid</span><span class="w">            </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603412</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">COMMIT</span><span class="w"> </span><span class="cm">/* xid=630541 */</span><span class="w">              </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>
</code></pre></div>
<p>可以看到，与 statement 格式的 binlog 相比，前后的 BEGIN 和 COMMIT 是一样的。但是，row 格式的 binlog 里没有了 SQL 语句的原文，而是替换成了两个 event: <code>Table_map</code> 和 <code>Delete_rows</code>。</p>
<ol>
<li><code>Table_map</code> event，用于说明接下来要操作的表是 test 库的表 t;</li>
<li><code>Delete_rows</code> event，用于定义删除的行为。</li>
</ol>
<p>其实，我们通过图 5 是看不到详细信息的，还需要借助 mysqlbinlog 工具，用下面这个命令解析和查看 binlog 中的内容。因为图 5 中的信息显示，这个事务的 binlog 是从 60603121这个位置开始的，所以可以用 <code>--start-position</code> 参数来指定从这个位置的日志开始解析。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mysqlbinlog<span class="w">  </span>-vv<span class="w"> </span>binlog.000079<span class="w"> </span>--start-position<span class="o">=</span><span class="m">60603121</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">54</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603283</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">x49b211b3</span><span class="w">     </span><span class="n">Query</span><span class="w">   </span><span class="n">thread_id</span><span class="o">=</span><span class="mi">28</span><span class="w">    </span><span class="n">exec_time</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">error_code</span><span class="o">=</span><span class="mi">0</span>
<span class="k">SET</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="o">=</span><span class="mi">1675237914</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">pseudo_thread_id</span><span class="o">=</span><span class="mi">28</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">foreign_key_checks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">sql_auto_is_null</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">unique_checks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">autocommit</span><span class="o">=</span><span class="mi">1</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">sql_mode</span><span class="o">=</span><span class="mi">1168113696</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">1</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="cm">/*!\C utf8mb4 *//*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">character_set_client</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">collation_connection</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">collation_server</span><span class="o">=</span><span class="mi">45</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">time_zone</span><span class="o">=</span><span class="s1">&#39;SYSTEM&#39;</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">lc_time_names</span><span class="o">=</span><span class="mi">0</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">collation_database</span><span class="o">=</span><span class="k">DEFAULT</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="cm">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="cm">/*!*/</span><span class="p">;</span>
<span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">60603283</span>
<span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">54</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603333</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">x261dd71a</span><span class="w">     </span><span class="n">Table_map</span><span class="p">:</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="n">mapped</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="mi">154</span>
<span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">60603333</span>
<span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">54</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603381</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">xbef257a2</span><span class="w">     </span><span class="n">Delete_rows</span><span class="p">:</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">154</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="n">STMT_END_F</span>

<span class="n">BINLOG</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">GhraYxMBAAAAMgAAAMW7nAMAAJoAAAAAAAEABHRlc3QAAXQAAwMDEQEAAgEBABrXHSY=</span>
<span class="s1">GhraYyABAAAAMAAAAPW7nAMAAJoAAAAAAAEAAgAD/wADAAAAAwAAAFvnAICiV/K+</span>
<span class="s1">&#39;</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="o">###</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">t</span><span class="o">`</span>
<span class="o">###</span><span class="w"> </span><span class="k">WHERE</span>
<span class="o">###</span><span class="w">   </span><span class="o">@</span><span class="mi">1</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="cm">/* INT meta=0 nullable=0 is_null=0 */</span>
<span class="o">###</span><span class="w">   </span><span class="o">@</span><span class="mi">2</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="cm">/* INT meta=0 nullable=1 is_null=0 */</span>
<span class="o">###</span><span class="w">   </span><span class="o">@</span><span class="mi">3</span><span class="o">=</span><span class="mi">1541865600</span><span class="w"> </span><span class="cm">/* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */</span>
<span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">60603381</span>
<span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">54</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603412</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">x1a408274</span><span class="w">     </span><span class="n">Xid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">630541</span>
<span class="k">COMMIT</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AUTOMATIC&#39;</span><span class="w"> </span><span class="cm">/* added by mysqlbinlog */</span><span class="w"> </span><span class="cm">/*!*/</span><span class="p">;</span>
</code></pre></div>
<p>从这个图中，我们可以看到以下几个信息：</p>
<ul>
<li>server id 1，表示这个事务是在 <code>server_id=1</code> 的这个库上执行的。</li>
<li>每个 event 都有 CRC32 的值，这是因为我把参数 <code>binlog_checksum</code> 设置成了 CRC32。</li>
<li><code>Table_map</code> event 跟之前看到的相同，显示了接下来要打开的表，map 到数字 154。现在我们这条 SQL 语句只操作了一张表，如果要操作多张表呢？每个表都有一个对应的 <code>Table_map</code> event、都会 map 到一个单独的数字，用于区分对不同表的操作。</li>
<li>在 mysqlbinlog 的命令中，使用了 <code>-vv</code> 参数是为了把内容都解析出来，所以从结果里面可以看到各个字段的值（比如，<code>@1=4</code>、 <code>@2=4</code> 这些值）。</li>
<li><code>binlog_row_image</code> 的默认配置是 FULL，因此 <code>Delete_event</code> 里面，包含了删掉的行的所有字段的值。如果把 <code>binlog_row_image</code> 设置为 MINIMAL，则只会记录必要的信息，在这个例子里，就是只会记录 <code>id=4</code> 这个信息。</li>
<li>最后的 Xid event，用于表示事务被正确地提交了。</li>
</ul>
<p>可以看到，当 <code>binlog_format</code> 使用 row 格式的时候，binlog 里面记录了真实删除行的主键 id，这样 binlog 传到备库去的时候，就肯定会删除 id=4 的行，不会有主备删除不同行的问题。</p>
<h3 id="mixed-binlog">为什么会有 mixed 格式的 binlog？<a class="headerlink" href="#mixed-binlog" title="Permanent link">&para;</a></h3>
<p>基于上面的信息，我们来讨论一个问题：**为什么会有 mixed 这种 binlog 格式的存在场景？**推论过程是这样的：</p>
<ul>
<li>因为有些 statement 格式的 binlog 可能会导致主备不一致，所以要使用 row 格式。</li>
<li>但 row 格式的缺点是，很占空间。比如你用一个 delete 语句删掉 10 万行数据，用 statement 的话就是一个 SQL 语句被记录到 binlog 中，占用几十个字节的空间。但如果用 row 格式的 binlog，就要把这 10 万条记录都写到 binlog 中。这样做，不仅会占用更大的空间，同时写 binlog 也要耗费 IO 资源，影响执行速度。</li>
<li>所以，MySQL 就取了个折中方案，也就是有了 mixed 格式的 binlog。mixed 格式的意思是，MySQL 自己会判断这条 SQL 语句是否可能引起主备不一致，如果有可能，就用 row 格式，否则就用 statement 格式。</li>
</ul>
<p>也就是说，mixed 格式可以利用 statment 格式的优点，同时又避免了数据不一致的风险。</p>
<p>因此，如果你的线上 MySQL 设置的 binlog 格式是 statement 的话，那基本上就可以认为这是一个不合理的设置。你至少应该把 binlog 的格式设置为 mixed。</p>
<p>比如我们这个例子，设置为 mixed 后，就会记录为 row 格式；而如果执行的语句去掉 limit 1，就会记录为 statement 格式。</p>
<p>当然我要说的是，现在越来越多的场景要求把 MySQL 的 binlog 格式设置成 row。这么做的理由有很多，我来给你举一个可以直接看出来的好处：<strong>恢复数据</strong>。</p>
<p>接下来，我们就分别从 delete、insert 和 update 这三种 SQL 语句的角度，来看看数据恢复的问题。</p>
<p>通过图 6 你可以看出来，即使我执行的是 delete 语句，row 格式的 binlog 也会把被删掉的行的整行信息保存起来。所以，如果你在执行完一条 delete 语句以后，发现删错数据了，可以直接把 binlog 中记录的 delete 语句转成 insert，把被错删的数据插入回去就可以恢复了。</p>
<p>如果你是执行错了 insert 语句呢？那就更直接了。row 格式下，insert 语句的 binlog 里会记录所有的字段信息，这些信息可以用来精确定位刚刚被插入的那一行。这时，你直接把 insert 语句转成 delete 语句，删除掉这被误插入的一行数据就可以了。</p>
<p>如果执行的是 update 语句的话，binlog 里面会记录修改前整行的数据和修改后的整行数据。所以，如果你误执行了 update 语句的话，只需要把这个 event 前后的两行信息对调一下，再去数据库里面执行，就能恢复这个更新操作了。</p>
<p>其实，由 delete、insert 或者 update 语句导致的数据操作错误，需要恢复到操作之前状态的情况，也时有发生。MariaDB 的<a href="https://mariadb.com/kb/en/library/flashback/">Flashback</a>工具就是基于上面介绍的原理来回滚数据的。</p>
<p>虽然 mixed 格式的 binlog 现在已经用得不多了，但这里我还是要再借用一下 mixed 格式来说明一个问题，来看一下这条 SQL 语句：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">());</span>
</code></pre></div>
<p>如果我们把 binlog 格式设置为 mixed，你觉得 MySQL 会把它记录为 row 格式还是 statement 格式呢？</p>
<p>先不要着急说结果，我们一起来看一下这条语句执行的效果。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">binlog</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">&#39;binlog.000079&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">60603412</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Log_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Pos</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Event_type</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Server_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">End_log_pos</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">                                           </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603412</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Anonymous_Gtid</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603491</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ANONYMOUS&#39;</span><span class="w">           </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603491</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">BEGIN</span><span class="w">                                          </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603700</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">())</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000079</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">60603700</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Xid</span><span class="w">            </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">60603731</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">COMMIT</span><span class="w"> </span><span class="cm">/* xid=630548 */</span><span class="w">                        </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>
</code></pre></div>
<p>可以看到，MySQL 用的居然是 statement 格式。你一定会奇怪，如果这个 binlog 过了 1 分钟才传给备库的话，那主备的数据不就不一致了吗？</p>
<p>接下来，我们再用 mysqlbinlog 工具来看看：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="cm">/*!*/</span><span class="p">;</span>
<span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">60603581</span>
<span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">36</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603700</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">xfc0bb7ba</span><span class="w">     </span><span class="n">Query</span><span class="w">   </span><span class="n">thread_id</span><span class="o">=</span><span class="mi">28</span><span class="w">    </span><span class="n">exec_time</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">error_code</span><span class="o">=</span><span class="mi">0</span>
<span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="o">=</span><span class="mi">1675240896</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">())</span>
<span class="cm">/*!*/</span><span class="p">;</span>
<span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">60603700</span>
<span class="o">#</span><span class="mi">230201</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">36</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">60603731</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">x554021b0</span><span class="w">     </span><span class="n">Xid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">630548</span>
<span class="k">COMMIT</span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AUTOMATIC&#39;</span><span class="w"> </span><span class="cm">/* added by mysqlbinlog */</span><span class="w"> </span><span class="cm">/*!*/</span><span class="p">;</span>
<span class="k">DELIMITER</span><span class="w"> </span><span class="p">;</span>
<span class="o">#</span><span class="w"> </span><span class="k">End</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">file</span>
<span class="cm">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span><span class="p">;</span>
<span class="cm">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span><span class="p">;</span>
</code></pre></div>
<p>从图中的结果可以看到，原来 binlog 在记录 event 的时候，多记了一条命令：<code>SET TIMESTAMP=1675240896</code>。它用 SET TIMESTAMP 命令约定了接下来的 now() 函数的返回时间。</p>
<p>因此，不论这个 binlog 是 1 分钟之后被备库执行，还是 3 天后用来恢复这个库的备份，这个 insert 语句插入的行，值都是固定的。也就是说，通过这条 SET TIMESTAMP 命令，MySQL 就确保了主备数据的一致性。</p>
<p>我之前看过有人在重放 binlog 数据的时候，是这么做的：用 mysqlbinlog 解析出日志，然后把里面的 statement 语句直接拷贝出来执行。</p>
<p>你现在知道了，这个方法是有风险的。因为有些语句的执行结果是依赖于上下文命令的，直接执行的结果很可能是错误的。</p>
<p>所以，用 binlog 来恢复数据的标准做法是，用 mysqlbinlog 工具解析出来，然后把解析结果整个发给 MySQL 执行。类似下面的命令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mysqlbinlog<span class="w"> </span>binlog.000079<span class="w"> </span>--start-position<span class="o">=</span><span class="m">60603412</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>mysql<span class="w"> </span>-h127.0.0.1<span class="w"> </span>-P13000<span class="w"> </span>-u<span class="nv">$user</span><span class="w"> </span>-p<span class="nv">$pwd</span><span class="p">;</span>
</code></pre></div>
<h3 id="_16">循环复制问题<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>通过上面对 MySQL 中 binlog 基本内容的理解，你现在可以知道，binlog 的特性确保了在备库执行相同的 binlog，可以得到与主库相同的状态。</p>
<p>因此，我们可以认为正常情况下主备的数据是一致的。也就是说，图 1 中 A、B 两个节点的内容是一致的。其实，图 1 中我画的是 M-S 结构，但实际生产上使用比较多的是双 M 结构，也就是图 9 所示的主备切换流程。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/20ad4e163115198dc6cf372d5116c956.png" /></p>
<p>图 9 MySQL 主备切换流程 -- 双 M 结构</p>
<p>对比图 9 和图 1，你可以发现，双 M 结构和 M-S 结构，其实区别只是多了一条线，即：节点 A 和 B 之间总是互为主备关系。这样在切换的时候就不用再修改主备关系。</p>
<p>但是，双 M 结构还有一个问题需要解决。</p>
<p>业务逻辑在节点 A 上更新了一条语句，然后再把生成的 binlog 发给节点 B，节点 B 执行完这条更新语句后也会生成 binlog。（建议把参数 <code>log_slave_updates</code> 设置为 on，表示备库执行 relay log 后生成 binlog）。</p>
<p>那么，如果节点 A 同时是节点 B 的备库，相当于又把节点 B 新生成的 binlog 拿过来执行了一次，然后节点 A 和 B 间，会不断地循环执行这个更新语句，也就是循环复制了。这个要怎么解决呢？</p>
<p>从上面的图 6 中可以看到，MySQL 在 binlog 中记录了这个命令第一次执行时所在实例的 server id。因此，我们可以用下面的逻辑，来解决两个节点间的循环复制的问题：</p>
<ol>
<li>规定两个库的 server id 必须不同，如果相同，则它们之间不能设定为主备关系；</li>
<li>一个备库接到 binlog 并在重放的过程中，生成与原 binlog 的 server id 相同的新的 binlog；</li>
<li>每个库在收到从自己的主库发过来的日志后，先判断 server id，如果跟自己的相同，表示这个日志是自己生成的，就直接丢弃这个日志。</li>
</ol>
<p>按照这个逻辑，如果我们设置了双 M 结构，日志的执行流就会变成这样：</p>
<ol>
<li>从节点 A 更新的事务，binlog 里面记的都是 A 的 server id；</li>
<li>传到节点 B 执行一次以后，节点 B 生成的 binlog 的 server id 也是 A 的 server id；</li>
<li>再传回给节点 A，A 判断到这个 server id 与自己的相同，就不会再处理这个日志。所以，死循环在这里就断掉了。</li>
</ol>
<h3 id="_17">小结<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>今天这篇文章，我给你介绍了 MySQL binlog 的格式和一些基本机制，是后面我要介绍的读写分离等系列文章的背景知识，希望你可以认真消化理解。</p>
<p>binlog 在 MySQL 的各种高可用方案上扮演了重要角色。今天介绍的可以说是所有 MySQL 高可用方案的基础。在这之上演化出了诸如多节点、半同步、MySQL group replication 等相对复杂的方案。</p>
<p>我也跟你介绍了 MySQL 不同格式 binlog 的优缺点，和设计者的思考。希望你在做系统开发时候，也能借鉴这些设计思想。</p>
<p>最后，我给你留下一个思考题吧。</p>
<p>说到循环复制问题的时候，我们说 MySQL 通过判断 server id 的方式，断掉死循环。但是，这个机制其实并不完备，在某些场景下，还是有可能出现死循环。</p>
<p>你能构造出一个这样的场景吗？又应该怎么解决呢？</p>
<p>你可以把你的设计和分析写在评论区，我会在下一篇文章跟你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p>
<h3 id="_18">上期问题时间<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>上期我留给你的问题是，你在什么时候会把线上生产库设置成“非双 1”。我目前知道的场景，有以下这些：</p>
<ol>
<li>业务高峰期。一般如果有预知的高峰期，DBA 会有预案，把主库设置成“非双 1”。</li>
<li>备库延迟，为了让备库尽快赶上主库。@永恒记忆和 <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/Second" title="GitHub User: Second">@Second</a> Sight 提到了这个场景。</li>
<li>用备份恢复主库的副本，应用 binlog 的过程，这个跟上一种场景类似。</li>
<li>批量导入数据的时候。</li>
</ol>
<p>一般情况下，把生产库改成“非双 1”配置，是设置 <code>innodb_flush_logs_at_trx_commit=2</code>、<code>sync_binlog=1000</code>。</p>
<h2 id="25-mysql">25 MySQL是怎么保证高可用的？<a class="headerlink" href="#25-mysql" title="Permanent link">&para;</a></h2>
<p>在上一篇文章中，我和你介绍了 binlog 的基本内容，在一个主备关系中，每个备库接收主库的 binlog 并执行。</p>
<p>正常情况下，只要主库执行更新生成的所有 binlog，都可以传到备库并被正确地执行，备库就能达到跟主库一致的状态，这就是最终一致性。</p>
<p>但是，MySQL 要提供高可用能力，只有最终一致性是不够的。为什么这么说呢？今天我就着重和你分析一下。</p>
<p>这里，我再放一次上一篇文章中讲到的双 M 结构的主备切换流程图。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/89290bbcf454ff9a3dc5de42a85a69cc.png" /></p>
<p>图 1 MySQL 主备切换流程 -- 双 M 结构</p>
<h3 id="_19">主备延迟<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>主备切换可能是一个主动运维动作，比如软件升级、主库所在机器按计划下线等，也可能是被动操作，比如主库所在机器掉电。</p>
<p>接下来，我们先一起看看主动切换的场景。</p>
<p>在介绍主动切换流程的详细步骤之前，我要先跟你说明一个概念，即“同步延迟”。与数据同步有关的时间点主要包括以下三个：</p>
<ol>
<li>主库 A 执行完成一个事务，写入 binlog，我们把这个时刻记为 T1;</li>
<li>之后传给备库 B，我们把备库 B 接收完这个 binlog 的时刻记为 T2;</li>
<li>备库 B 执行完成这个事务，我们把这个时刻记为 T3。</li>
</ol>
<p>所谓主备延迟，就是同一个事务，在备库执行完成的时间和主库执行完成的时间之间的差值，也就是 T3-T1。</p>
<p>你可以在备库上执行 <code>show slave status</code> 命令，它的返回结果里面会显示 <code>seconds_behind_master</code>，用于表示当前备库延迟了多少秒。</p>
<p><code>seconds_behind_master</code> 的计算方法是这样的：</p>
<ol>
<li>每个事务的 binlog 里面都有一个时间字段，用于记录主库上写入的时间；</li>
<li>备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值，得到 <code>seconds_behind_master</code>。</li>
</ol>
<p>可以看到，其实 <code>seconds_behind_master</code> 这个参数计算的就是 <code>T3-T1</code>。所以，我们可以用 <code>seconds_behind_master</code> 来作为主备延迟的值，这个值的时间精度是秒。</p>
<p>你可能会问，如果主备库机器的系统时间设置不一致，会不会导致主备延迟的值不准？</p>
<p>其实不会的。因为，备库连接到主库的时候，会通过执行 <code>SELECT UNIX_TIMESTAMP()</code> 函数来获得当前主库的系统时间。如果这时候发现主库的系统时间与自己不一致，备库在执行 <code>seconds_behind_master</code> 计算的时候会自动扣掉这个差值。</p>
<p>需要说明的是，在网络正常的时候，日志从主库传给备库所需的时间是很短的，即 T2-T1 的值是非常小的。也就是说，网络正常情况下，主备延迟的主要来源是备库接收完 binlog 和执行完这个事务之间的时间差。</p>
<p>所以说，主备延迟最直接的表现是，备库消费中转日志（relay log）的速度，比主库生产 binlog 的速度要慢。接下来，我就和你一起分析下，这可能是由哪些原因导致的。</p>
<h3 id="_20">主备延迟的来源<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p><strong>首先，有些部署条件下，备库所在机器的性能要比主库所在的机器性能差。</strong></p>
<p>一般情况下，有人这么部署时的想法是，反正备库没有请求，所以可以用差一点儿的机器。或者，他们会把 20 个主库放在 4 台机器上，而把备库集中在一台机器上。</p>
<p>其实我们都知道，更新请求对 IOPS 的压力，在主库和备库上是无差别的。所以，做这种部署时，一般都会将备库设置为“非双 1”的模式。</p>
<p>但实际上，更新过程中也会触发大量的读操作。所以，当备库主机上的多个备库都在争抢资源的时候，就可能会导致主备延迟了。</p>
<p>当然，这种部署现在比较少了。因为主备可能发生切换，备库随时可能变成主库，所以主备库选用相同规格的机器，并且做对称部署，是现在比较常见的情况。</p>
<p>追问 1：但是，做了对称部署以后，还可能会有延迟。这是为什么呢？</p>
<p>这就是**第二种常见的可能了，即备库的压力大**。一般的想法是，主库既然提供了写能力，那么备库可以提供一些读能力。或者一些运营后台需要的分析语句，不能影响正常业务，所以只能在备库上跑。</p>
<p>我真就见过不少这样的情况。由于主库直接影响业务，大家使用起来会比较克制，反而忽视了备库的压力控制。结果就是，备库上的查询耗费了大量的 CPU 资源，影响了同步速度，造成主备延迟。</p>
<p>这种情况，我们一般可以这么处理：</p>
<ol>
<li>一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。</li>
<li>通过 binlog 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类查询的能力。</li>
</ol>
<p>其中，一主多从的方式大都会被采用。因为作为数据库系统，还必须保证有定期全量备份的能力。而从库，就很适合用来做备份。</p>
<blockquote>
<p>备注：这里需要说明一下，从库和备库在概念上其实差不多。在我们这个专栏里，为了方便描述，我把会在 HA 过程中被选成新主库的，称为备库，其他的称为从库。</p>
</blockquote>
<p>追问 2：采用了一主多从，保证备库的压力不会超过主库，还有什么情况可能导致主备延迟吗？</p>
<p><strong>这就是第三种可能了，即大事务。</strong></p>
<p>大事务这种情况很好理解。因为主库上必须等事务执行完成才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟。</p>
<p>不知道你所在公司的 DBA 有没有跟你这么说过：不要**一次性地用 delete 语句删除太多数据**。其实，这就是一个典型的大事务场景。</p>
<p>比如，一些归档类的数据，平时没有注意删除历史数据，等到空间快满了，业务开发人员要一次性地删掉大量历史数据。同时，又因为要避免在高峰期操作会影响业务（至少有这个意识还是很不错的），所以会在晚上执行这些大量数据的删除操作。</p>
<p>结果，负责的 DBA 同学半夜就会收到延迟报警。然后，DBA 团队就要求你后续再删除数据的时候，要控制每个事务删除的数据量，分成多次删除。</p>
<p>**另一种典型的大事务场景，就是大表 DDL。**这个场景，我在前面的文章中介绍过。处理方案就是，计划内的 DDL，建议使用 gh-ost 方案.</p>
<p>追问 3：如果主库上也不做大事务了，还有什么原因会导致主备延迟吗？</p>
<p>造成主备延迟还有一个大方向的原因，就是**备库的并行复制能力**。这个话题，我会留在下一篇文章再和你详细介绍。</p>
<p>其实还是有不少其他情况会导致主备延迟，如果你还碰到过其他场景，欢迎你在评论区给我留言，我来和你一起分析、讨论。</p>
<p>由于主备延迟的存在，所以在主备切换的时候，就相应的有不同的策略。</p>
<h3 id="_21">可靠性优先策略<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>在图 1 的双 M 结构下，从状态 1 到状态 2 切换的详细过程是这样的：</p>
<ol>
<li>判断备库 B 现在的 <code>seconds_behind_master</code>，如果小于某个值（比如 5 秒）继续下一步，否则持续重试这一步；</li>
<li>把主库 A 改成只读状态，即把 readonly 设置为 true；</li>
<li>判断备库 B 的 <code>seconds_behind_master</code> 的值，直到这个值变成 0 为止；</li>
<li>把备库 B 改成可读写状态，也就是把 readonly 设置为 false；</li>
<li>把业务请求切到备库 B。</li>
</ol>
<p>这个切换流程，一般是由专门的 HA 系统来完成的，我们暂时称之为可靠性优先流程。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/54f4c7c31e6f0f807c2ab77f78c8844a.png" /></p>
<p>图 2 MySQL 可靠性优先主备切换流程</p>
<p>备注：图中的 SBM，是 <code>seconds_behind_master</code> 参数的简写。</p>
<p>可以看到，这个切换流程中是有不可用时间的。因为在步骤 2 之后，主库 A 和备库 B 都处于 readonly 状态，也就是说这时系统处于不可写状态，直到步骤 5 完成后才能恢复。</p>
<p>在这个不可用状态中，比较耗费时间的是步骤 3，可能需要耗费好几秒的时间。这也是为什么需要在步骤 1 先做判断，确保 <code>seconds_behind_master</code> 的值足够小。</p>
<p>试想如果一开始主备延迟就长达 30 分钟，而不先做判断直接切换的话，系统的不可用时间就会长达 30 分钟，这种情况一般业务都是不可接受的。</p>
<p>当然，系统的不可用时间，是由这个数据可靠性优先的策略决定的。你也可以选择可用性优先的策略，来把这个不可用时间几乎降为 0。</p>
<h3 id="_22">可用性优先策略<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>如果我强行把步骤 4、5 调整到最开始执行，也就是说不等主备数据同步，直接把连接切到备库 B，并且让备库 B 可以读写，那么系统几乎就没有不可用时间了。</p>
<p>我们把这个切换流程，暂时称作可用性优先流程。这个切换流程的代价，就是可能出现数据不一致的情况。</p>
<p>接下来，我就和你分享一个可用性优先流程产生数据不一致的例子。假设有一个表 t：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="k">c</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">),(</span><span class="mi">2</span><span class="p">),(</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div>
<p>这个表定义了一个自增主键 id，初始化数据后，主库和备库上都是 3 行数据。接下来，业务人员要继续在表 t 上执行两条插入语句的命令，依次是：</p>
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="k">c</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="k">c</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>假设，现在主库上其他的数据表有大量的更新，导致主备延迟达到 5 秒。在插入一条 c=4 的语句后，发起了主备切换。</p>
<p>图 3 是**可用性优先策略，且 binlog_format=mixed**时的切换流程和数据结果。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/3786bd6ad37faa34aca25bf1a1d8af3a.png" /></p>
<p>图 3 可用性优先策略，且 <code>binlog_format=mixed</code></p>
<p>现在，我们一起分析下这个切换流程：</p>
<ol>
<li>步骤 2 中，主库 A 执行完 insert 语句，插入了一行数据（4,4），之后开始进行主备切换。</li>
<li>步骤 3 中，由于主备之间有 5 秒的延迟，所以备库 B 还没来得及应用“插入 c=4”这个中转日志，就开始接收客户端“插入 c=5”的命令。</li>
<li>步骤 4 中，备库 B 插入了一行数据（4,5），并且把这个 binlog 发给主库 A。</li>
<li>步骤 5 中，备库 B 执行“插入 c=4”这个中转日志，插入了一行数据（5,4）。而直接在备库 B 执行的“插入 c=5”这个语句，传到主库 A，就插入了一行新数据（5,5）。</li>
</ol>
<p>最后的结果就是，主库 A 和备库 B 上出现了两行不一致的数据。可以看到，这个数据不一致，是由可用性优先流程导致的。</p>
<p>那么，如果我还是用**可用性优先策略，但设置 binlog_format=row**，情况又会怎样呢？</p>
<p>因为 row 格式在记录 binlog 的时候，会记录新插入的行的所有字段值，所以最后只会有一行不一致。而且，两边的主备同步的应用线程会报错 duplicate key error 并停止。也就是说，这种情况下，备库 B 的 (5,4) 和主库 A 的 (5,5) 这两行数据，都不会被对方执行。</p>
<p>图 4 中我画出了详细过程，你可以自己再分析一下。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/b8d2229b2b40dd087fd3b111d1bdda43.png" /></p>
<p>图 4 可用性优先策略，且 <code>binlog_format=row</code></p>
<p>从上面的分析中，你可以看到一些结论：</p>
<ol>
<li>使用 row 格式的 binlog 时，数据不一致的问题更容易被发现。而使用 mixed 或者 statement 格式的 binlog 时，数据很可能悄悄地就不一致了。如果你过了很久才发现数据不一致的问题，很可能这时的数据不一致已经不可查，或者连带造成了更多的数据逻辑不一致。</li>
<li>主备切换的可用性优先策略会导致数据不一致。因此，大多数情况下，我都建议你使用可靠性优先策略。毕竟对数据服务来说的话，数据的可靠性一般还是要优于可用性的。</li>
</ol>
<p>但事无绝对，<strong>有没有哪种情况数据的可用性优先级更高呢？</strong></p>
<p>答案是，有的。</p>
<p>我曾经碰到过这样的一个场景：</p>
<ul>
<li>有一个库的作用是记录操作日志。这时候，如果数据不一致可以通过 binlog 来修补，而这个短暂的不一致也不会引发业务问题。</li>
<li>同时，业务系统依赖于这个日志写入逻辑，如果这个库不可写，会导致线上的业务操作无法执行。</li>
</ul>
<p>这时候，你可能就需要选择先强行切换，事后再补数据的策略。</p>
<p>当然，事后复盘的时候，我们想到了一个改进措施就是，让业务逻辑不要依赖于这类日志的写入。也就是说，日志写入这个逻辑模块应该可以降级，比如写到本地文件，或者写到另外一个临时库里面。</p>
<p>这样的话，这种场景就又可以使用可靠性优先策略了。</p>
<p>接下来我们再看看，<strong>按照可靠性优先的思路，异常切换会是什么效果？</strong></p>
<p>假设，主库 A 和备库 B 间的主备延迟是 30 分钟，这时候主库 A 掉电了，HA 系统要切换 B 作为主库。我们在主动切换的时候，可以等到主备延迟小于 5 秒的时候再启动切换，但这时候已经别无选择了。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/553b7fc2d0dce3ec78bb595e1806eb8b.png" /></p>
<p>图 5 可靠性优先策略，主库不可用</p>
<p>采用可靠性优先策略的话，你就必须得等到备库 B 的 <code>seconds_behind_master</code>=0 之后，才能切换。但现在的情况比刚刚更严重，并不是系统只读、不可写的问题了，而是系统处于完全不可用的状态。因为，主库 A 掉电后，我们的连接还没有切到备库 B。</p>
<p>你可能会问，那能不能直接切换到备库 B，但是保持 B 只读呢？</p>
<p>这样也不行。</p>
<p>因为，这段时间内，中转日志还没有应用完成，如果直接发起主备切换，客户端查询看不到之前执行完成的事务，会认为有“数据丢失”。</p>
<p>虽然随着中转日志的继续应用，这些数据会恢复回来，但是对于一些业务来说，查询到“暂时丢失数据的状态”也是不能被接受的。</p>
<p>聊到这里你就知道了，在满足数据可靠性的前提下，MySQL 高可用系统的可用性，是依赖于主备延迟的。延迟的时间越小，在主库故障的时候，服务恢复需要的时间就越短，可用性就越高。</p>
<h3 id="_23">小结<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>今天这篇文章，我先和你介绍了 MySQL 高可用系统的基础，就是主备切换逻辑。紧接着，我又和你讨论了几种会导致主备延迟的情况，以及相应的改进方向。</p>
<p>然后，由于主备延迟的存在，切换策略就有不同的选择。所以，我又和你一起分析了可靠性优先和可用性优先策略的区别。</p>
<p>在实际的应用中，我更建议使用可靠性优先的策略。毕竟保证数据准确，应该是数据库服务的底线。在这个基础上，通过减少主备延迟，提升系统的可用性。</p>
<h2 id="26">26 备库为什么会延迟好几个小时？<a class="headerlink" href="#26" title="Permanent link">&para;</a></h2>
<p>在上一篇文章中，我和你介绍了几种可能导致备库延迟的原因。你会发现，这些场景里，不论是偶发性的查询压力，还是备份，对备库延迟的影响一般是分钟级的，而且在备库恢复正常以后都能够追上来。</p>
<p>但是，如果备库执行日志的速度持续低于主库生成日志的速度，那这个延迟就有可能成了小时级别。而且对于一个压力持续比较高的主库来说，备库很可能永远都追不上主库的节奏。</p>
<p>这就涉及到今天我要给你介绍的话题：备库并行复制能力。</p>
<p>为了便于你理解，我们再一起看一下第 24 篇文章[《MySQL 是怎么保证主备一致的？》]的主备流程图。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/1a85a3bac30a32438bfd8862e5a34eef.png" /></p>
<p>图 1 主备流程图</p>
<p>谈到主备的并行复制能力，我们要关注的是图中黑色的两个箭头。一个箭头代表了客户端写入主库，另一箭头代表的是备库上 <code>sql_thread</code> 执行中转日志（relay log）。如果用箭头的粗细来代表并行度的话，那么真实情况就如图 1 所示，第一个箭头要明显粗于第二个箭头。</p>
<p>在主库上，影响并发度的原因就是各种锁了。由于 InnoDB 引擎支持行锁，除了所有并发事务都在更新同一行（热点行）这种极端场景外，它对业务并发度的支持还是很友好的。所以，你在性能测试的时候会发现，并发压测线程 32 就比单线程时，总体吞吐量高。</p>
<p>而日志在备库上的执行，就是图中备库上 <code>sql_thread</code> 更新数据 (DATA) 的逻辑。如果是用单线程的话，就会导致备库应用日志不够快，造成主备延迟。</p>
<p>在官方的 5.6 版本之前，MySQL 只支持单线程复制，由此在主库并发高、TPS 高时就会出现严重的主备延迟问题。</p>
<p>从单线程复制到最新版本的多线程复制，中间的演化经历了好几个版本。接下来，我就跟你说说 MySQL 多线程复制的演进过程。</p>
<p>其实说到底，所有的多线程复制机制，都是要把图 1 中只有一个线程的 <code>sql_thread</code>，拆成多个线程，也就是都符合下面的这个模型：</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/bcf75aa3b0f496699fd7885426bc6245.png" /></p>
<p>图 2 多线程模型</p>
<p>图 2 中，coordinator 就是原来的 <code>sql_thread</code>, 不过现在它不再直接更新数据了，只负责读取中转日志和分发事务。真正更新日志的，变成了 worker 线程。而 work 线程的个数，就是由参数 <code>slave_parallel_workers</code> 决定的。根据我的经验，把这个值设置为 8~16 之间最好（32 核物理机的情况），毕竟备库还有可能要提供读查询，不能把 CPU 都吃光了。</p>
<p>接下来，你需要先思考一个问题：事务能不能按照轮询的方式分发给各个 worker，也就是第一个事务分给 <code>worker_1</code>，第二个事务发给 <code>worker_2</code> 呢？</p>
<p>其实是不行的。因为，事务被分发给 worker 以后，不同的 worker 就独立执行了。但是，由于 CPU 的调度策略，很可能第二个事务最终比第一个事务先执行。而如果这时候刚好这两个事务更新的是同一行，也就意味着，同一行上的两个事务，在主库和备库上的执行顺序相反，会导致主备不一致的问题。</p>
<p>接下来，请你再设想一下另外一个问题：同一个事务的多个更新语句，能不能分给不同的 worker 来执行呢？</p>
<p>答案是，也不行。举个例子，一个事务更新了表 t1 和表 t2 中的各一行，如果这两条更新语句被分到不同 worker 的话，虽然最终的结果是主备一致的，但如果表 t1 执行完成的瞬间，备库上有一个查询，就会看到这个事务“更新了一半的结果”，破坏了事务逻辑的隔离性。</p>
<p>所以，coordinator 在分发的时候，需要满足以下这两个基本要求：</p>
<ol>
<li>不能造成更新覆盖。这就要求更新同一行的两个事务，必须被分发到同一个 worker 中。</li>
<li>同一个事务不能被拆开，必须放到同一个 worker 中。</li>
</ol>
<p>各个版本的多线程复制，都遵循了这两条基本原则。接下来，我们就看看各个版本的并行复制策略。</p>
<h3 id="mysql-56">MySQL 5.6 版本的并行复制策略<a class="headerlink" href="#mysql-56" title="Permanent link">&para;</a></h3>
<p>官方 MySQL5.6 版本，支持了并行复制，只是支持的粒度是按库并行。理解了上面介绍的按表分发策略和按行分发策略，你就理解了，用于决定分发策略的 hash 表里，key 就是数据库名。</p>
<p>这个策略的并行效果，取决于压力模型。如果在主库上有多个 DB，并且各个 DB 的压力均衡，使用这个策略的效果会很好。</p>
<p>相比于按表和按行分发，这个策略有两个优势：</p>
<ol>
<li>构造 hash 值的时候很快，只需要库名；而且一个实例上 DB 数也不会很多，不会出现需要构造 100 万个项这种情况。</li>
<li>不要求 binlog 的格式。因为 statement 格式的 binlog 也可以很容易拿到库名。</li>
</ol>
<p>但是，如果你的主库上的表都放在同一个 DB 里面，这个策略就没有效果了；或者如果不同 DB 的热点不同，比如一个是业务逻辑库，一个是系统配置库，那也起不到并行的效果。</p>
<p>理论上你可以创建不同的 DB，把相同热度的表均匀分到这些不同的 DB 中，强行使用这个策略。不过据我所知，由于需要特地移动数据，这个策略用得并不多。</p>
<h3 id="mariadb">MariaDB 的并行复制策略<a class="headerlink" href="#mariadb" title="Permanent link">&para;</a></h3>
<p>在第 23 篇文章中，我给你介绍了 redo log 组提交 (group commit) 优化， 而 MariaDB 的并行复制策略利用的就是这个特性：</p>
<ol>
<li>能够在同一组里提交的事务，一定不会修改同一行；</li>
<li>主库上可以并行执行的事务，备库上也一定是可以并行执行的。</li>
</ol>
<p>在实现上，MariaDB 是这么做的：</p>
<ol>
<li>在一组里面一起提交的事务，有一个相同的 <code>commit_id</code>，下一组就是 <code>commit_id+1</code>；</li>
<li><code>commit_id</code> 直接写到 binlog 里面；</li>
<li>传到备库应用的时候，相同 <code>commit_id</code> 的事务分发到多个 worker 执行；</li>
<li>这一组全部执行完成后，coordinator 再去取下一批。</li>
</ol>
<p>当时，这个策略出来的时候是相当惊艳的。因为，之前业界的思路都是在“分析 binlog，并拆分到 worker”上。而 MariaDB 的这个策略，目标是“模拟主库的并行模式”。</p>
<p>但是，这个策略有一个问题，它并没有实现“真正的模拟主库并发度”这个目标。在主库上，一组事务在 commit 的时候，下一组事务是同时处于“执行中”状态的。</p>
<p>如图 5 所示，假设了三组事务在主库的执行情况，你可以看到在 trx1、trx2 和 trx3 提交的时候，trx4、trx5 和 trx6 是在执行的。这样，在第一组事务提交完成的时候，下一组事务很快就会进入 commit 状态。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/8fec5fb48d6095aecc80016826efbfc3.png" /></p>
<p>图 5 主库并行事务</p>
<p>而按照 MariaDB 的并行复制策略，备库上的执行效果如图 6 所示。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/8ac3799c1ff2f9833619a1624ca3e622.png" /></p>
<p>图 6 MariaDB 并行复制，备库并行效果</p>
<p>可以看到，在备库上执行的时候，要等第一组事务完全执行完成后，第二组事务才能开始执行，这样系统的吞吐量就不够。</p>
<p>另外，这个方案很容易被大事务拖后腿。假设 trx2 是一个超大事务，那么在备库应用的时候，trx1 和 trx3 执行完成后，就只能等 trx2 完全执行完成，下一组才能开始执行。这段时间，只有一个 worker 线程在工作，是对资源的浪费。</p>
<p>不过即使如此，这个策略仍然是一个很漂亮的创新。因为，它对原系统的改造非常少，实现也很优雅。</p>
<h3 id="mysql-57">MySQL 5.7 的并行复制策略<a class="headerlink" href="#mysql-57" title="Permanent link">&para;</a></h3>
<p>在 MariaDB 并行复制实现之后，官方的 MySQL5.7 版本也提供了类似的功能，由参数 slave-parallel-type 来控制并行复制策略：</p>
<ol>
<li>配置为 DATABASE，表示使用 MySQL 5.6 版本的按库并行策略；</li>
<li>配置为 <code>LOGICAL_CLOCK</code>，表示的就是类似 MariaDB 的策略。不过，MySQL 5.7 这个策略，针对并行度做了优化。这个优化的思路也很有趣儿。</li>
</ol>
<p>你可以先考虑这样一个问题：同时处于“执行状态”的所有事务，是不是可以并行？</p>
<p>答案是，不能。</p>
<p>因为，这里面可能有由于锁冲突而处于锁等待状态的事务。如果这些事务在备库上被分配到不同的 worker，就会出现备库跟主库不一致的情况。</p>
<p>而上面提到的 MariaDB 这个策略的核心，是“所有处于 commit”状态的事务可以并行。事务处于 commit 状态，表示已经通过了锁冲突的检验了。</p>
<p>这时候，你可以再回顾一下两阶段提交。</p>
<p>其实，不用等到 commit 阶段，只要能够到达 redo log prepare 阶段，就表示事务已经通过锁冲突的检验了。</p>
<p>因此，MySQL 5.7 并行复制策略的思想是：</p>
<ol>
<li>同时处于 prepare 状态的事务，在备库执行时是可以并行的；</li>
<li>处于 prepare 状态的事务，与处于 commit 状态的事务之间，在备库执行时也是可以并行的。</li>
</ol>
<p>我在第 23 篇文章，讲 binlog 的组提交的时候，介绍过两个参数：</p>
<ol>
<li><code>binlog_group_commit_sync_delay</code> 参数，表示延迟多少微秒后才调用 fsync;</li>
<li><code>binlog_group_commit_sync_no_delay_count</code> 参数，表示累积多少次以后才调用 fsync。</li>
</ol>
<p>这两个参数是用于故意拉长 binlog 从 write 到 fsync 的时间，以此减少 binlog 的写盘次数。在 MySQL 5.7 的并行复制策略里，它们可以用来制造更多的“同时处于 prepare 阶段的事务”。这样就增加了备库复制的并行度。</p>
<p>也就是说，这两个参数，既可以“故意”让主库提交得慢些，又可以让备库执行得快些。在 MySQL 5.7 处理备库延迟的时候，可以考虑调整这两个参数值，来达到提升备库复制并发度的目的。</p>
<h3 id="mysql-5722">MySQL 5.7.22 的并行复制策略<a class="headerlink" href="#mysql-5722" title="Permanent link">&para;</a></h3>
<p>在 2018 年 4 月份发布的 MySQL 5.7.22 版本里，MySQL 增加了一个新的并行复制策略，基于 WRITESET 的并行复制。</p>
<p>相应地，新增了一个参数 <code>binlog-transaction-dependency-tracking</code>，用来控制是否启用这个新策略。这个参数的可选值有以下三种。</p>
<ol>
<li><code>COMMIT_ORDER</code>，表示的就是前面介绍的，根据同时进入 prepare 和 commit 来判断是否可以并行的策略。</li>
<li><code>WRITESET</code>，表示的是对于事务涉及更新的每一行，计算出这一行的 hash 值，组成集合 writeset。如果两个事务没有操作相同的行，也就是说它们的 writeset 没有交集，就可以并行。</li>
<li><code>WRITESET_SESSION</code>，是在 WRITESET 的基础上多了一个约束，即在主库上同一个线程先后执行的两个事务，在备库执行的时候，要保证相同的先后顺序。</li>
</ol>
<p>当然为了唯一标识，这个 hash 值是通过“库名 + 表名 + 索引名 + 值”计算出来的。如果一个表上除了有主键索引外，还有其他唯一索引，那么对于每个唯一索引，insert 语句对应的 writeset 就要多增加一个 hash 值。</p>
<p>你可能看出来了，这跟我们前面介绍的基于 MySQL 5.5 版本的按行分发的策略是差不多的。不过，MySQL 官方的这个实现还是有很大的优势：</p>
<ol>
<li>writeset 是在主库生成后直接写入到 binlog 里面的，这样在备库执行的时候，不需要解析 binlog 内容（event 里的行数据），节省了很多计算量；</li>
<li>不需要把整个事务的 binlog 都扫一遍才能决定分发到哪个 worker，更省内存；</li>
<li>由于备库的分发策略不依赖于 binlog 内容，所以 binlog 是 statement 格式也是可以的。</li>
</ol>
<p>因此，MySQL 5.7.22 的并行复制策略在通用性上还是有保证的。</p>
<p>当然，对于“表上没主键”和“外键约束”的场景，WRITESET 策略也是没法并行的，也会暂时退化为单线程模型。</p>
<h3 id="_24">小结<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>在今天这篇文章中，我和你介绍了 MySQL 的各种多线程复制策略。</p>
<p>为什么要有多线程复制呢？这是因为单线程复制的能力全面低于多线程复制，对于更新压力较大的主库，备库是可能一直追不上主库的。从现象上看就是，备库上 <code>seconds_behind_master</code> 的值越来越大。</p>
<p>在介绍完每个并行复制策略后，我还和你分享了不同策略的优缺点：</p>
<ul>
<li>如果你是 DBA，就需要根据不同的业务场景，选择不同的策略；</li>
<li>如果是你业务开发人员，也希望你能从中获取灵感用到平时的开发工作中。</li>
</ul>
<p>从这些分析中，你也会发现大事务不仅会影响到主库，也是造成备库复制延迟的主要原因之一。因此，在平时的开发工作中，我建议你尽量减少大事务操作，把大事务拆成小事务。</p>
<p>官方 MySQL5.7 版本新增的备库并行策略，修改了 binlog 的内容，也就是说 binlog 协议并不是向上兼容的，在主备切换、版本升级的时候需要把这个因素也考虑进去。</p>
<p>最后，我给你留下一个思考题吧。</p>
<p>假设一个 MySQL 5.7.22 版本的主库，单线程插入了很多数据，过了 3 个小时后，我们要给这个主库搭建一个相同版本的备库。</p>
<p>这时候，你为了更快地让备库追上主库，要开并行复制。在 binlog-transaction-dependency-tracking 参数的 <code>COMMIT_ORDER</code>、<code>WRITESET</code> 和 <code>WRITE_SESSION</code> 这三个取值中，你会选择哪一个呢？</p>
<p>你选择的原因是什么？如果设置另外两个参数，你认为会出现什么现象呢？</p>
<p>回答：</p>
<p>这个问题的答案是，应该将这个参数设置为 WRITESET。</p>
<p>由于主库是单线程压力模式，所以每个事务的 <code>commit_id</code> 都不同，那么设置为 <code>COMMIT_ORDER</code> 模式的话，从库也只能单线程执行。</p>
<p>同样地，由于 <code>WRITESET_SESSION</code> 模式要求在备库应用日志的时候，同一个线程的日志必须与主库上执行的先后顺序相同，也会导致主库单线程压力模式下退化成单线程复制。</p>
<p>所以，应该将 binlog-transaction-dependency-tracking 设置为 WRITESET。</p>
<h2 id="27">27 主库出问题了，从库怎么办？<a class="headerlink" href="#27" title="Permanent link">&para;</a></h2>
<p>在前面的文章中，介绍了 MySQL 主备复制的基础结构，但这些都是一主一备的结构。</p>
<p>大多数的互联网应用场景都是读多写少，因此你负责的业务，在发展过程中很可能先会遇到读性能的问题。而在数据库层解决读性能问题，就要涉及到接下来两篇文章要讨论的架构：一主多从。</p>
<p>今天这篇文章，我们就先聊聊一主多从的切换正确性。然后，我们在下一篇文章中再聊聊解决一主多从的查询逻辑正确性的方法。</p>
<p>如图 1 所示，就是一个基本的一主多从结构。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/aadb3b956d1ffc13ac46515a7d619e79.png" /></p>
<p>图 1 一主多从基本结构</p>
<p>图中，虚线箭头表示的是主备关系，也就是 A 和 A’互为主备， 从库 B、C、D 指向的是主库 A。一主多从的设置，一般用于读写分离，主库负责所有的写入和一部分读，其他的读请求则由从库分担。</p>
<p>今天我们要讨论的就是，在一主多从架构下，主库故障后的主备切换问题。</p>
<p>如图 2 所示，就是主库发生故障，主备切换后的结果。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/0014f97423bd75235a9187f492fb2453.png" /></p>
<p>图 2 一主多从基本结构 -- 主备切换</p>
<p>相比于一主一备的切换流程，一主多从结构在切换完成后，A’会成为新的主库，从库 B、C、D 也要改接到 A’。正是由于多了从库 B、C、D 重新指向的这个过程，所以主备切换的复杂性也相应增加了。</p>
<p>接下来，我们再一起看看一个切换系统会怎么完成一主多从的主备切换过程。</p>
<h3 id="_25">基于位点的主备切换<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>这里，我们需要先来回顾一个知识点。</p>
<p>当我们把节点 B 设置成节点 A’的从库的时候，需要执行一条 change master 命令：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">CHANGE</span><span class="w"> </span><span class="n">MASTER</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">$</span><span class="n">host_name</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_PORT</span><span class="o">=</span><span class="err">$</span><span class="n">port</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_USER</span><span class="o">=</span><span class="err">$</span><span class="n">user_name</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">$</span><span class="n">password</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">$</span><span class="n">master_log_name</span><span class="w"> </span>
<span class="w">  </span><span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="err">$</span><span class="n">master_log_pos</span><span class="w">  </span>
</code></pre></div>
<p>这条命令有这么 6 个参数：</p>
<ul>
<li><code>MASTER_HOST</code>、<code>MASTER_PORT</code>、<code>MASTER_USER</code> 和 <code>MASTER_PASSWORD</code> 四个参数，分别代表了主库 A’的 IP、端口、用户名和密码。</li>
<li>最后两个参数 <code>MASTER_LOG_FILE</code> 和 <code>MASTER_LOG_POS</code> 表示，要从主库的 <code>master_log_name</code> 文件的 <code>master_log_pos</code> 这个位置的日志继续同步。而这个位置就是我们所说的同步位点，也就是主库对应的文件名和日志偏移量。</li>
</ul>
<p>那么，这里就有一个问题了，节点 B 要设置成 A’的从库，就要执行 change master 命令，就不可避免地要设置位点的这两个参数，但是这两个参数到底应该怎么设置呢？</p>
<p>原来节点 B 是 A 的从库，本地记录的也是 A 的位点。但是相同的日志，A 的位点和 A’的位点是不同的。因此，从库 B 要切换的时候，就需要先经过“找同步位点”这个逻辑。</p>
<p>这个位点很难精确取到，只能取一个大概位置。为什么这么说呢？</p>
<p>我来和你分析一下看看这个位点一般是怎么获取到的，你就清楚其中不精确的原因了。</p>
<p>考虑到切换过程中不能丢数据，所以我们找位点的时候，总是要找一个“稍微往前”的，然后再通过判断跳过那些在从库 B 上已经执行过的事务。</p>
<p>一种取同步位点的方法是这样的：</p>
<ol>
<li>
<p>等待新主库 A’把中转日志（relay log）全部同步完成；</p>
</li>
<li>
<p>在 A’上执行 <code>show master status</code> 命令，得到当前 A’上最新的 File 和 Position；</p>
</li>
<li>
<p>取原主库 A 故障的时刻 T；</p>
</li>
<li>
<p>用 mysqlbinlog 工具解析 A’的 File，得到 T 时刻的位点。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mysqlbinlog<span class="w">  </span>binlog.000079<span class="w"> </span>--start-datetime<span class="o">=</span><span class="s1">&#39;2023-02-01 16:41:36&#39;</span><span class="w"> </span>--stop-datetime<span class="o">=</span><span class="s1">&#39;2023-02-01 16:41:36&#39;</span>

/*!50530<span class="w"> </span>SET<span class="w"> </span>@@SESSION.PSEUDO_SLAVE_MODE<span class="o">=</span><span class="m">1</span>*/<span class="p">;</span>
/*!50003<span class="w"> </span>SET<span class="w"> </span>@OLD_COMPLETION_TYPE<span class="o">=</span>@@COMPLETION_TYPE,COMPLETION_TYPE<span class="o">=</span><span class="m">0</span>*/<span class="p">;</span>
DELIMITER<span class="w"> </span>/*!*/<span class="p">;</span>
<span class="c1"># at 4</span>
<span class="c1">#230131 14:56:46 server id 1  end_log_pos 124 CRC32 0x76c363e1  Start: binlog v 4, server v 8.0.18 created 230131 14:56:46 at startup</span>
</code></pre></div>
</li>
</ol>
<p>图中，<code>end_log_pos</code> 后面的值 124，表示的就是 A’ 这个实例，在 T 时刻写入新的 binlog 的位置。然后，我们就可以把 123 这个值作为 <code>$master_log_pos</code> ，用在节点 B 的 change master 命令里。</p>
<p>当然这个值并不精确。为什么呢？</p>
<p>你可以设想有这么一种情况，假设在 T 这个时刻，主库 A 已经执行完成了一个 insert 语句插入了一行数据 R，并且已经将 binlog 传给了 A’和 B，然后在传完的瞬间主库 A 的主机就掉电了。</p>
<p>那么，这时候系统的状态是这样的：</p>
<ol>
<li>在从库 B 上，由于同步了 binlog， R 这一行已经存在；</li>
<li>在新主库 A’上， R 这一行也已经存在，日志是写在 123 这个位置之后的；</li>
<li>我们在从库 B 上执行 change master 命令，指向 A’的 File 文件的 123 位置，就会把插入 R 这一行数据的 binlog 又同步到从库 B 去执行。</li>
</ol>
<p>这时候，从库 B 的同步线程就会报告 <code>Duplicate entry ‘id_of_R’ for key ‘PRIMARY’</code> 错误，提示出现了主键冲突，然后停止同步。</p>
<p>所以，<strong>通常情况下，我们在切换任务的时候，要先主动跳过这些错误，有两种常用的方法。</strong></p>
<p><strong>一种做法是</strong>，主动跳过一个事务。跳过命令的写法是：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">sql_slave_skip_counter</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
</code></pre></div>
<p>因为切换过程中，可能会不止重复执行一个事务，所以我们需要在从库 B 刚开始接到新主库 A’时，持续观察，每次碰到这些错误就停下来，执行一次跳过命令，直到不再出现停下来的情况，以此来跳过可能涉及的所有事务。</p>
<p>**另外一种方式是，**通过设置 <code>slave_skip_errors</code> 参数，直接设置跳过指定的错误。</p>
<p>在执行主备切换时，有这么两类错误，是经常会遇到的：</p>
<ul>
<li>1062 错误是插入数据时唯一键冲突；</li>
<li>1032 错误是删除数据时找不到行。</li>
</ul>
<p>因此，我们可以把 <code>slave_skip_errors</code> 设置为 <code>1032,1062</code>，这样中间碰到这两个错误时就直接跳过。</p>
<p>这里需要注意的是，这种直接跳过指定错误的方法，针对的是主备切换时，由于找不到精确的同步位点，所以只能采用这种方法来创建从库和新主库的主备关系。</p>
<p>这个背景是，我们很清楚在主备切换过程中，直接跳过 1032 和 1062 这两类错误是无损的，所以才可以这么设置 <code>slave_skip_errors</code> 参数。等到主备间的同步关系建立完成，并稳定执行一段时间之后，我们还需要把这个参数设置为空，以免之后真的出现了主从数据不一致，也跳过了。</p>
<h3 id="gtid">GTID<a class="headerlink" href="#gtid" title="Permanent link">&para;</a></h3>
<p>通过 <code>sql_slave_skip_counter</code> 跳过事务和通过 <code>slave_skip_errors</code> 忽略错误的方法，虽然都最终可以建立从库 B 和新主库 A’的主备关系，但这两种操作都很复杂，而且容易出错。所以，MySQL 5.6 版本引入了 GTID，彻底解决了这个困难。</p>
<p>那么，GTID 到底是什么意思，又是如何解决找同步位点这个问题呢？现在，我就和你简单介绍一下。</p>
<p>GTID 的全称是 Global Transaction Identifier，也就是全局事务 ID，是一个事务在提交的时候生成的，是这个事务的唯一标识。它由两部分组成，格式是：</p>
<div class="highlight"><pre><span></span><code><span class="na">GTID</span><span class="o">=</span><span class="s">server_uuid:gno</span>
</code></pre></div>
<p>其中：</p>
<ul>
<li><code>server_uuid</code> 是一个实例第一次启动时自动生成的，是一个全局唯一的值；</li>
<li>gno 是一个整数，初始值是 1，每次提交事务的时候分配给这个事务，并加 1。</li>
</ul>
<p>这里我需要和你说明一下，在 MySQL 的官方文档里，GTID 格式是这么定义的：</p>
<div class="highlight"><pre><span></span><code><span class="na">GTID</span><span class="o">=</span><span class="s">source_id:transaction_id</span>
</code></pre></div>
<p>这里的 source_id 就是 <code>server_uuid</code>；而后面的这个 <code>transaction_id</code>，我觉得容易造成误导，所以我改成了 gno。为什么说使用 <code>transaction_id</code> 容易造成误解呢？</p>
<p>因为，在 MySQL 里面我们说 <code>transaction_id</code> 就是指事务 id，事务 id 是在事务执行过程中分配的，如果这个事务回滚了，事务 id 也会递增，而 gno 是在事务提交的时候才会分配。</p>
<p>从效果上看，GTID 往往是连续的，因此我们用 gno 来表示更容易理解。</p>
<p>GTID 模式的启动也很简单，我们只需要在启动一个 MySQL 实例的时候，加上参数 <code>gtid_mode=on</code> 和 <code>enforce_gtid_consistency=on</code> 就可以了。</p>
<p>在 GTID 模式下，每个事务都会跟一个 GTID 一一对应。这个 GTID 有两种生成方式，而使用哪种方式取决于 session 变量 <code>gtid_next</code> 的值。</p>
<ol>
<li>如果 <code>gtid_next=automatic</code>，代表使用默认值。这时，MySQL 就会把 <code>server_uuid:gno</code> 分配给这个事务。</li>
<li>记录 binlog 的时候，先记录一行 <code>SET @@SESSION.GTID_NEXT=‘server_uuid:gno’;</code> </li>
<li>
<p>把这个 GTID 加入本实例的 GTID 集合。</p>
</li>
<li>
<p>如果 <code>gtid_next</code> 是一个指定的 GTID 的值，比如通过 <code>set gtid_next='current_gtid'</code>指定为 <code>current_gtid</code>，那么就有两种可能： </p>
</li>
<li>如果 <code>current_gtid</code> 已经存在于实例的 GTID 集合中，接下来执行的这个事务会直接被系统忽略； </li>
<li>如果 <code>current_gtid</code> 没有存在于实例的 GTID 集合中，就将这个 <code>current_gtid</code> 分配给接下来要执行的事务，也就是说系统不需要给这个事务生成新的 GTID，因此 gno 也不用加 1。</li>
</ol>
<p>注意，一个 <code>current_gtid</code> 只能给一个事务使用。这个事务提交后，如果要执行下一个事务，就要执行 set 命令，把 <code>gtid_next</code> 设置成另外一个 gtid 或者 automatic。</p>
<p>这样，每个 MySQL 实例都维护了一个 GTID 集合，用来对应“这个实例执行过的所有事务”。</p>
<p>这样看上去不太容易理解，接下来我就用一个简单的例子，来和你说明 GTID 的基本用法。</p>
<p>我们在实例 X 中创建一个表 t。</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">binlog</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">&#39;binlog.000082&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">155</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Log_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Pos</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Event_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Server_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">End_log_pos</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">                                                                                                                                      </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">155</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Gtid</span><span class="w">       </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">232</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;faddd5d4-9259-11e9-8971-868e345923a2:1&#39;</span><span class="w">                                                                         </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">232</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">      </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">358</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">;</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="cm">/* generated by server */</span><span class="w"> </span><span class="cm">/* xid=630565 */</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">358</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Gtid</span><span class="w">       </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">437</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;faddd5d4-9259-11e9-8971-868e345923a2:2&#39;</span><span class="w">                                                                         </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">437</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">      </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">633</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="cm">/* xid=630566 */</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">633</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Gtid</span><span class="w">       </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">712</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="k">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;faddd5d4-9259-11e9-8971-868e345923a2:3&#39;</span><span class="w">                                                                         </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">712</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">      </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">794</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">BEGIN</span><span class="w">                                                                                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">794</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">      </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">896</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">                                                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">896</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Xid</span><span class="w">        </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">927</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">COMMIT</span><span class="w"> </span><span class="cm">/* xid=630567 */</span><span class="w">                                                                                                                   </span><span class="o">|</span>
<span class="o">+</span><span class="c1">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="mi">8</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>可以看到，事务的 BEGIN 之前有一条 <code>SET @@SESSION.GTID_NEXT</code> 命令。这时，如果实例  有从库，那么将 CREATE TABLE 和 insert 语句的 binlog 同步过去执行的话，执行事务之前就会先执行这两个 SET 命令， 这样被加入从库的 GTID 集合的，就是图中的这两个 GTID。</p>
<p>假设，现在这个实例 X 是另外一个实例 Y 的从库，并且此时在实例 Y 上执行了下面这条插入语句：</p>
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<p>并且，这条语句在实例 Y 上的 GTID 是 <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code></p>
<p>那么，实例 X 作为 Y 的从库，就要同步这个事务过来执行，显然会出现主键冲突，导致实例 X 的同步线程停止。这时，我们应该怎么处理呢？</p>
<p>处理方法就是，你可以执行下面的这个语句序列：</p>
<div class="highlight"><pre><span></span><code><span class="k">set</span><span class="w"> </span><span class="n">gtid_next</span><span class="o">=</span><span class="s1">&#39;aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10&#39;</span><span class="p">;</span>
<span class="k">begin</span><span class="p">;</span>
<span class="k">commit</span><span class="p">;</span>
<span class="k">set</span><span class="w"> </span><span class="n">gtid_next</span><span class="o">=</span><span class="n">automatic</span><span class="p">;</span>
<span class="k">start</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
</code></pre></div>
<p>其中，前三条语句的作用，是通过提交一个空事务，把这个 GTID 加到实例 X 的 GTID 集合中。如图 5 所示，就是执行完这个空事务之后的 <code>show master status</code> 的结果。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="err">\</span><span class="k">G</span><span class="p">;</span>
<span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span>
<span class="w">             </span><span class="n">File</span><span class="p">:</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000082</span>
<span class="w">         </span><span class="k">Position</span><span class="p">:</span><span class="w"> </span><span class="mi">927</span>
<span class="w">     </span><span class="n">Binlog_Do_DB</span><span class="p">:</span>
<span class="w"> </span><span class="n">Binlog_Ignore_DB</span><span class="p">:</span>
<span class="n">Executed_Gtid_Set</span><span class="p">:</span><span class="w"> </span><span class="n">faddd5d4</span><span class="o">-</span><span class="mi">9259</span><span class="o">-</span><span class="mi">11</span><span class="n">e9</span><span class="o">-</span><span class="mi">8971</span><span class="o">-</span><span class="mi">868</span><span class="n">e345923a2</span><span class="p">:</span><span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">aaaaaaaa</span><span class="o">-</span><span class="n">cccc</span><span class="o">-</span><span class="n">dddd</span><span class="o">-</span><span class="n">eeee</span><span class="o">-</span><span class="n">ffffffffffff</span><span class="p">:</span><span class="mi">10</span>
<span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>可以看到实例 X 的 <code>Executed_Gtid_set</code> 里面，已经加入了这个 GTID。</p>
<p>这样，我再执行 start slave 命令让同步线程执行起来的时候，虽然实例 X 上还是会继续执行实例 Y 传过来的事务，但是由于 <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code> 已经存在于实例 X 的 GTID 集合中了，所以实例 X 就会直接跳过这个事务，也就不会再出现主键冲突的错误。</p>
<p>在上面的这个语句序列中，start slave 命令之前还有一句 <code>set gtid_next=automatic</code>。这句话的作用是“恢复 GTID 的默认分配行为”，也就是说如果之后有新的事务再执行，就还是按照原来的分配方式，继续分配 gno=3。</p>
<h3 id="gtid_1">基于 GTID 的主备切换<a class="headerlink" href="#gtid_1" title="Permanent link">&para;</a></h3>
<p>现在，我们已经理解 GTID 的概念，再一起来看看基于 GTID 的主备复制的用法。</p>
<p>在 GTID 模式下，备库 B 要设置为新主库 A’的从库的语法如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">CHANGE</span><span class="w"> </span><span class="n">MASTER</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span>
<span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">$</span><span class="n">host_name</span><span class="w"> </span>
<span class="n">MASTER_PORT</span><span class="o">=</span><span class="err">$</span><span class="n">port</span><span class="w"> </span>
<span class="n">MASTER_USER</span><span class="o">=</span><span class="err">$</span><span class="n">user_name</span><span class="w"> </span>
<span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">$</span><span class="n">password</span><span class="w"> </span>
<span class="n">master_auto_position</span><span class="o">=</span><span class="mi">1</span>
</code></pre></div>
<p>其中，<code>master_auto_position=1</code> 就表示这个主备关系使用的是 GTID 协议。可以看到，前面让我们头疼不已的 <code>MASTER_LOG_FILE</code> 和 <code>MASTER_LOG_POS</code> 参数，已经不需要指定了。</p>
<p>我们把现在这个时刻，实例 A’的 GTID 集合记为 <code>set_a</code>，实例 B 的 GTID 集合记为 <code>set_b</code>。接下来，我们就看看现在的主备切换逻辑。</p>
<p>我们在实例 B 上执行 start slave 命令，取 binlog 的逻辑是这样的：</p>
<ol>
<li>实例 B 指定主库 A’，基于主备协议建立连接。</li>
<li>实例 B 把 <code>set_b</code> 发给主库 A’。</li>
<li>实例 A’算出 <code>set_a</code> 与 <code>set_b</code> 的差集，也就是所有存在于 <code>set_a</code>，但是不存在于 <code>set_b</code> 的 GITD 的集合，判断 A’ 本地是否包含了这个差集需要的所有 binlog 事务。 </li>
<li>如果不包含，表示 A’ 已经把实例 B 需要的 binlog 给删掉了，直接返回错误；</li>
<li>
<p>如果确认全部包含，A’ 从自己的 binlog 文件里面，找出第一个不在 <code>set_b</code> 的事务，发给 B；</p>
</li>
<li>
<p>之后就从这个事务开始，往后读文件，按顺序取 binlog 发给 B 去执行。</p>
</li>
</ol>
<p>其实，这个逻辑里面包含了一个设计思想：在基于 GTID 的主备关系里，系统认为只要建立主备关系，就必须保证主库发给备库的日志是完整的。因此，如果实例 B 需要的日志已经不存在，A’ 就拒绝把日志发给 B。</p>
<p>这跟基于位点的主备协议不同。基于位点的协议，是由备库决定的，备库指定哪个位点，主库就发哪个位点，不做日志的完整性判断。</p>
<p>基于上面的介绍，我们再来看看引入 GTID 后，一主多从的切换场景下，主备切换是如何实现的。</p>
<p>由于不需要找位点了，所以从库 B、C、D 只需要分别执行 change master 命令指向实例 A’ 即可。</p>
<p>其实，严谨地说，主备切换不是不需要找位点了，而是找位点这个工作，在实例 A’ 内部就已经自动完成了。但由于这个工作是自动的，所以对 HA 系统的开发人员来说，非常友好。</p>
<p>之后这个系统就由新主库 A’ 写入，主库 A’ 的自己生成的 binlog 中的 GTID 集合格式是：<code>server_uuid_of_A’:1-M</code>。</p>
<p>如果之前从库 B 的 GTID 集合格式是 <code>server_uuid_of_A:1-N</code>， 那么切换之后 GTID 集合的格式就变成了 <code>server_uuid_of_A:1-N, server_uuid_of_A’:1-M</code>。</p>
<p>当然，主库 A’ 之前也是 A 的备库，因此主库 A’ 和从库 B 的 GTID 集合是一样的。这就达到了我们预期。</p>
<h3 id="gtid-ddl">GTID 和在线 DDL<a class="headerlink" href="#gtid-ddl" title="Permanent link">&para;</a></h3>
<p>接下来，我再举个例子帮你理解 GTID。</p>
<p>之前文章中，我和你提到业务高峰期的慢查询性能问题时，分析到如果是由于索引缺失引起的性能问题，我们可以通过在线加索引来解决。但是，考虑到要避免新增索引对主库性能造成的影响，我们可以先在备库加索引，然后再切换。</p>
<p>当时我说，在双 M 结构下，备库执行的 DDL 语句也会传给主库，为了避免传回后对主库造成影响，要通过 <code>set sql_log_bin=off</code> 关掉 binlog。</p>
<p>评论区有位同学提出了一个问题：这样操作的话，数据库里面是加了索引，但是 binlog 并没有记录下这一个更新，是不是会导致数据和日志不一致？</p>
<p>这个问题提得非常好。当时，我在留言的回复中就引用了 GTID 来说明。今天，我再和你展开说明一下。</p>
<p>假设，这两个互为主备关系的库还是实例 X 和实例 Y，且当前主库是 X，并且都打开了 GTID 模式。这时的主备切换流程可以变成下面这样：</p>
<ul>
<li>
<p>在实例 Y 上执行 <code>stop slave</code>。</p>
</li>
<li>
<p>在实例 Y 上执行 DDL 语句。注意，这里并不需要关闭 binlog。</p>
</li>
<li>
<p>执行完成后，查出这个 DDL 语句对应的 GTID，并记为 <code>server_uuid_of_Y:gno</code>。</p>
</li>
<li>
<p>到实例 X 上执行以下语句序列：</p>
<div class="highlight"><pre><span></span><code><span class="k">set</span><span class="w"> </span><span class="n">GTID_NEXT</span><span class="o">=</span><span class="ss">&quot;server_uuid_of_Y:gno&quot;</span><span class="p">;</span>
<span class="k">begin</span><span class="p">;</span>
<span class="k">commit</span><span class="p">;</span>
<span class="k">set</span><span class="w"> </span><span class="n">gtid_next</span><span class="o">=</span><span class="n">automatic</span><span class="p">;</span>
<span class="k">start</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
</code></pre></div>
</li>
</ul>
<p>​       这样做的目的在于，既可以让实例 Y 的更新有 binlog 记录，同时也可以确保不会在实例 X 上执行这条更新。</p>
<ul>
<li>接下来，执行完主备切换，然后照着上述流程再执行一遍即可。</li>
</ul>
<h3 id="_26">小结<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>在今天这篇文章中，我先和你介绍了一主多从的主备切换流程。在这个过程中，从库找新主库的位点是一个痛点。由此，我们引出了 MySQL 5.6 版本引入的 GTID 模式，介绍了 GTID 的基本概念和用法。</p>
<p>可以看到，在 GTID 模式下，一主多从切换就非常方便了。</p>
<p>因此，如果你使用的 MySQL 版本支持 GTID 的话，我都建议你尽量使用 GTID 模式来做一主多从的切换。</p>
<p>在下一篇文章中，我们还能看到 GTID 模式在读写分离场景的应用。</p>
<p>最后，又到了我们的思考题时间。</p>
<p>你在 GTID 模式下设置主从关系的时候，从库执行 start slave 命令后，主库发现需要的 binlog 已经被删除掉了，导致主备创建不成功。这种情况下，你觉得可以怎么处理呢？</p>
<p>参考处理方案：</p>
<ol>
<li>如果业务允许主从不一致的情况，那么可以在主库上先执行 <code>show global variables like 'gtid_purged'</code>，得到主库已经删除的 GTID 集合，假设是 <code>gtid_purged1</code>；然后先在从库上执行 <code>reset master</code>，再执行 <code>set global gtid_purged ='gtid_purged1'</code>；最后执行 <code>start slave</code>，就会从主库现存的 binlog 开始同步。binlog 缺失的那一部分，数据在从库上就可能会有丢失，造成主从不一致。</li>
<li>如果需要主从数据一致的话，最好还是通过重新搭建从库来做。</li>
<li>如果有其他的从库保留有全量的 binlog 的话，可以把新的从库先接到这个保留了全量 binlog 的从库，追上日志以后，如果有需要，再接回主库。</li>
<li>如果 binlog 有备份的情况，可以先在从库上应用缺失的 binlog，然后再执行 start slave。</li>
</ol>
<h2 id="28">28 读写分离有哪些坑？<a class="headerlink" href="#28" title="Permanent link">&para;</a></h2>
<p>在上一篇文章中，我和你介绍了一主多从的结构以及切换流程。今天我们就继续聊聊一主多从架构的应用场景：读写分离，以及怎么处理主备延迟导致的读写分离问题。</p>
<p>我们在上一篇文章中提到的一主多从的结构，其实就是读写分离的基本结构了。这里，我再把这张图贴过来，方便你理解。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/1334b9c08b8fd837832fdb2d82e6b0aa.png" /></p>
<p>图 1 读写分离基本结构</p>
<p>读写分离的主要目标就是分摊主库的压力。图 1 中的结构是客户端（client）主动做负载均衡，这种模式下一般会把数据库的连接信息放在客户端的连接层。也就是说，由客户端来选择后端数据库进行查询。</p>
<p>还有一种架构是，在 MySQL 和客户端之间有一个中间代理层 proxy，客户端只连接 proxy， 由 proxy 根据请求类型和上下文决定请求的分发路由。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/065ef246c59019effc8384967d774318.png" /></p>
<p>图 2 带 proxy 的读写分离架构</p>
<p>接下来，我们就看一下客户端直连和带 proxy 的读写分离架构，各有哪些特点。</p>
<ol>
<li>客户端直连方案，因为少了一层 proxy 转发，所以查询性能稍微好一点儿，并且整体架构简单，排查问题更方便。但是这种方案，由于要了解后端部署细节，所以在出现主备切换、库迁移等操作的时候，客户端都会感知到，并且需要调整数据库连接信息。 你可能会觉得这样客户端也太麻烦了，信息大量冗余，架构很丑。其实也未必，一般采用这样的架构，一定会伴随一个负责管理后端的组件，比如 Zookeeper，尽量让业务端只专注于业务逻辑开发。</li>
<li>带 proxy 的架构，对客户端比较友好。客户端不需要关注后端细节，连接维护、后端信息维护等工作，都是由 proxy 完成的。但这样的话，对后端维护团队的要求会更高。而且，proxy 也需要有高可用架构。因此，带 proxy 架构的整体就相对比较复杂。</li>
</ol>
<p>理解了这两种方案的优劣，具体选择哪个方案就取决于数据库团队提供的能力了。但目前看，趋势是往带 proxy 的架构方向发展的。</p>
<p>但是，不论使用哪种架构，你都会碰到我们今天要讨论的问题：由于主从可能存在延迟，客户端执行完一个更新事务后马上发起查询，如果查询选择的是从库的话，就有可能读到刚刚的事务更新之前的状态。</p>
<p><strong>这种“在从库上会读到系统的一个过期状态”的现象，在这篇文章里，我们暂且称之为“过期读”。</strong></p>
<p>前面我们说过了几种可能导致主备延迟的原因，以及对应的优化策略，但是主从延迟还是不能 100% 避免的。</p>
<p>不论哪种结构，客户端都希望查询从库的数据结果，跟查主库的数据结果是一样的。</p>
<p>接下来，我们就来讨论怎么处理过期读问题。</p>
<p>这里，我先把文章中涉及到的处理过期读的方案汇总在这里，以帮助你更好地理解和掌握全文的知识脉络。这些方案包括：</p>
<ul>
<li>强制走主库方案；</li>
<li>sleep 方案；</li>
<li>判断主备无延迟方案；</li>
<li>配合 semi-sync 方案；</li>
<li>等主库位点方案；</li>
<li>等 GTID 方案。</li>
</ul>
<h3 id="_27">强制走主库方案<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>强制走主库方案其实就是，将查询请求做分类。通常情况下，我们可以将查询请求分为这么两类：</p>
<ol>
<li>对于必须要拿到最新结果的请求，强制将其发到主库上。比如，在一个交易平台上，卖家发布商品以后，马上要返回主页面，看商品是否发布成功。那么，这个请求需要拿到最新的结果，就必须走主库。</li>
<li>对于可以读到旧数据的请求，才将其发到从库上。在这个交易平台上，买家来逛商铺页面，就算晚几秒看到最新发布的商品，也是可以接受的。那么，这类请求就可以走从库。</li>
</ol>
<p>你可能会说，这个方案是不是有点畏难和取巧的意思，但其实这个方案是用得最多的。</p>
<p>当然，这个方案最大的问题在于，有时候你会碰到“所有查询都不能是过期读”的需求，比如一些金融类的业务。这样的话，你就要放弃读写分离，所有读写压力都在主库，等同于放弃了扩展性。</p>
<p>因此接下来，我们来讨论的话题是：可以支持读写分离的场景下，有哪些解决过期读的方案，并分析各个方案的优缺点。</p>
<h3 id="sleep">Sleep 方案<a class="headerlink" href="#sleep" title="Permanent link">&para;</a></h3>
<p>主库更新后，读从库之前先 sleep 一下。具体的方案就是，类似于执行一条 <code>select sleep(1)</code> 命令。</p>
<p>这个方案的假设是，大多数情况下主备延迟在 1 秒之内，做一个 sleep 可以有很大概率拿到最新的数据。</p>
<p>这个方案给你的第一感觉，很可能是不靠谱儿，应该不会有人用吧？并且，你还可能会说，直接在发起查询时先执行一条 sleep 语句，用户体验很不友好啊。</p>
<p>但，这个思路确实可以在一定程度上解决问题。为了看起来更靠谱儿，我们可以换一种方式。</p>
<p>以卖家发布商品为例，商品发布后，用 Ajax 直接把客户端输入的内容作为“新的商品”显示在页面上，而不是真正地去数据库做查询。</p>
<p>这样，卖家就可以通过这个显示，来确认产品已经发布成功了。等到卖家再刷新页面，去查看商品的时候，其实已经过了一段时间，也就达到了 sleep 的目的，进而也就解决了过期读的问题。</p>
<p>也就是说，这个 sleep 方案确实解决了类似场景下的过期读问题。但，从严格意义上来说，这个方案存在的问题就是不精确。这个不精确包含了两层意思：</p>
<ol>
<li>如果这个查询请求本来 0.5 秒就可以在从库上拿到正确结果，也会等 1 秒；</li>
<li>如果延迟超过 1 秒，还是会出现过期读。</li>
</ol>
<p>看到这里，你是不是有一种“你是不是在逗我”的感觉，这个改进方案虽然可以解决类似 Ajax 场景下的过期读问题，但还是怎么看都不靠谱儿。别着急，接下来我就和你介绍一些更准确的方案。</p>
<h3 id="_28">判断主备无延迟方案<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>要确保备库无延迟，通常有三种做法。</p>
<p>通过前面的文章，我们知道 <code>show slave status</code> 结果里的 <code>seconds_behind_master</code> 参数的值，可以用来衡量主备延迟时间的长短。</p>
<p>所以**第一种确保主备无延迟的方法是，**每次从库执行查询请求前，先判断 <code>seconds_behind_master</code> 是否已经等于 0。如果还不等于 0 ，那就必须等到这个参数变为 0 才能执行查询请求。</p>
<p><code>seconds_behind_master</code> 的单位是秒，如果你觉得精度不够的话，还可以采用对比位点和 GTID 的方法来确保主备无延迟，也就是我们接下来要说的第二和第三种方法。</p>
<p>如下是一个 <code>show slave status</code> 结果的部分内容。</p>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="n">Master_Log_File</span><span class="p">:</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="mi">000012</span>
<span class="w">  </span><span class="n">Read_Master_log_Pos</span><span class="p">:</span><span class="w"> </span><span class="mi">1206067593</span>
<span class="p">.....</span>
<span class="n">Relay_Master_Log_File</span><span class="p">:</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="mi">000012</span>
<span class="p">....</span>
<span class="w">  </span><span class="n">Exec_Master_Log_Pos</span><span class="p">:</span><span class="w"> </span><span class="mi">126067593</span>
<span class="p">....</span>
<span class="w">   </span><span class="n">Retrieved_Gtid_Set</span><span class="p">:</span><span class="w"> </span><span class="mi">0000000</span><span class="o">-</span><span class="mi">1111</span><span class="o">-</span><span class="mi">000</span><span class="o">-</span><span class="mi">1111</span><span class="o">-</span><span class="mi">0000000000</span><span class="p">:</span><span class="mi">1</span><span class="o">-</span><span class="mi">10000</span>
<span class="w">    </span><span class="n">Executed_Gtid_Set</span><span class="p">:</span><span class="w"> </span><span class="mi">0000000</span><span class="o">-</span><span class="mi">1111</span><span class="o">-</span><span class="mi">000</span><span class="o">-</span><span class="mi">1111</span><span class="o">-</span><span class="mi">0000000000</span><span class="p">:</span><span class="mi">1</span><span class="o">-</span><span class="mi">10000</span>
<span class="w">        </span><span class="n">Auto_Position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>**第二种方法，**对比位点确保主备无延迟：</p>
<ul>
<li><code>Master_Log_File</code> 和 <code>Read_Master_Log_Pos</code>，表示的是读到的主库的最新位点；</li>
<li><code>Relay_Master_Log_File</code> 和 <code>Exec_Master_Log_Pos</code>，表示的是备库执行的最新位点。</li>
</ul>
<p>如果 <code>Master_Log_File</code> 和 <code>Relay_Master_Log_File</code>、<code>Read_Master_Log_Pos</code> 和 <code>Exec_Master_Log_Pos</code> 这两组值完全相同，就表示接收到的日志已经同步完成。</p>
<p>**第三种方法，**对比 GTID 集合确保主备无延迟：</p>
<ul>
<li><code>Auto_Position=1</code> ，表示这对主备关系使用了 GTID 协议。</li>
<li><code>Retrieved_Gtid_Set</code>，是备库收到的所有日志的 GTID 集合；</li>
<li><code>Executed_Gtid_Set</code>，是备库所有已经执行完成的 GTID 集合。</li>
</ul>
<p>如果这两个集合相同，也表示备库接收到的日志都已经同步完成。</p>
<p>可见，对比位点和对比 GTID 这两种方法，都要比判断 <code>seconds_behind_master</code> 是否为 0 更准确。</p>
<p>在执行查询请求之前，先判断从库是否同步完成的方法，相比于 sleep 方案，准确度确实提升了不少，但还是没有达到“精确”的程度。为什么这么说呢？</p>
<p>我们现在一起来回顾下，一个事务的 binlog 在主备库之间的状态：</p>
<ol>
<li>主库执行完成，写入 binlog，并反馈给客户端；</li>
<li>binlog 被从主库发送给备库，备库收到；</li>
<li>在备库执行 binlog 完成。</li>
</ol>
<p>我们上面判断主备无延迟的逻辑，是“备库收到的日志都执行完成了”。但是，从 binlog 在主备之间状态的分析中，不难看出还有一部分日志，处于客户端已经收到提交确认，而备库还没收到日志的状态。</p>
<p>如图 4 所示就是这样的一个状态。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/557445207b57d6c0f2747509d7d6619e.png" /></p>
<p>图 4 备库还没收到 trx3</p>
<p>这时，主库上执行完成了三个事务 trx1、trx2 和 trx3，其中：</p>
<ol>
<li>trx1 和 trx2 已经传到从库，并且已经执行完成了；</li>
<li>trx3 在主库执行完成，并且已经回复给客户端，但是还没有传到从库中。</li>
</ol>
<p>如果这时候你在从库 B 上执行查询请求，按照我们上面的逻辑，从库认为已经没有同步延迟，但还是查不到 trx3 的。严格地说，就是出现了过期读。</p>
<p>那么，这个问题有没有办法解决呢？</p>
<h3 id="semi-sync">配合 semi-sync<a class="headerlink" href="#semi-sync" title="Permanent link">&para;</a></h3>
<p>要解决这个问题，就要引入半同步复制，也就是 semi-sync replication。</p>
<p>semi-sync 做了这样的设计：</p>
<ol>
<li>事务提交的时候，主库把 binlog 发给从库；</li>
<li>从库收到 binlog 以后，发回给主库一个 ack，表示收到了；</li>
<li>主库收到这个 ack 以后，才能给客户端返回“事务完成”的确认。</li>
</ol>
<p>也就是说，如果启用了 semi-sync，就表示所有给客户端发送过确认的事务，都确保了备库已经收到了这个日志。</p>
<p>在[第 25 篇文章]的评论区，有同学问到：如果主库掉电的时候，有些 binlog 还来不及发给从库，会不会导致系统数据丢失？</p>
<p>答案是，如果使用的是普通的异步复制模式，就可能会丢失，但 semi-sync 就可以解决这个问题。</p>
<p>这样，semi-sync 配合前面关于位点的判断，就能够确定在从库上执行的查询请求，可以避免过期读。</p>
<p>但是，semi-sync+ 位点判断的方案，只对一主一备的场景是成立的。在一主多从场景中，主库只要等到一个从库的 ack，就开始给客户端返回确认。这时，在从库上执行查询请求，就有两种情况：</p>
<ol>
<li>如果查询是落在这个响应了 ack 的从库上，是能够确保读到最新数据；</li>
<li>但如果是查询落到其他从库上，它们可能还没有收到最新的日志，就会产生过期读的问题。</li>
</ol>
<p>其实，判断同步位点的方案还有另外一个潜在的问题，即：如果在业务更新的高峰期，主库的位点或者 GTID 集合更新很快，那么上面的两个位点等值判断就会一直不成立，很可能出现从库上迟迟无法响应查询请求的情况。</p>
<p>实际上，回到我们最初的业务逻辑里，当发起一个查询请求以后，我们要得到准确的结果，其实并不需要等到“主备完全同步”。</p>
<p>为什么这么说呢？我们来看一下这个时序图。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/9cf54f3e91dc8f7b8947d7d8e384aa09.png" /></p>
<p>图 5 主备持续延迟一个事务</p>
<p>图 5 所示，就是等待位点方案的一个 bad case。图中备库 B 下的虚线框，分别表示 relaylog 和 binlog 中的事务。可以看到，图 5 中从状态 1 到状态 4，一直处于延迟一个事务的状态。</p>
<p>备库 B 一直到状态 4 都和主库 A 存在延迟，如果用上面必须等到无延迟才能查询的方案，select 语句直到状态 4 都不能被执行。</p>
<p>但是，其实客户端是在发完 trx1 更新后发起的 select 语句，我们只需要确保 trx1 已经执行完成就可以执行 select 语句了。也就是说，如果在状态 3 执行查询请求，得到的就是预期结果了。</p>
<p>到这里，我们小结一下，semi-sync 配合判断主备无延迟的方案，存在两个问题：</p>
<ol>
<li>一主多从的时候，在某些从库执行查询请求会存在过期读的现象；</li>
<li>在持续延迟的情况下，可能出现过度等待的问题。</li>
</ol>
<p>接下来，我要和你介绍的等主库位点方案，就可以解决这两个问题。</p>
<h3 id="_29">等主库位点方案<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>要理解等主库位点方案，我需要先和你介绍一条命令：</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">master_pos_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">[,</span><span class="w"> </span><span class="n">timeout</span><span class="p">]);</span>
</code></pre></div>
<p>这条命令的逻辑如下：</p>
<ol>
<li>它是在从库执行的；</li>
<li>参数 file 和 pos 指的是主库上的文件名和位置；</li>
<li>timeout 可选，设置为正整数 N 表示这个函数最多等待 N 秒。</li>
</ol>
<p>这个命令正常返回的结果是一个正整数 M，表示从命令开始执行，到应用完 file 和 pos 表示的 binlog 位置，执行了多少事务。</p>
<p>当然，除了正常返回一个正整数 M 外，这条命令还会返回一些其他结果，包括：</p>
<ol>
<li>如果执行期间，备库同步线程发生异常，则返回 NULL；</li>
<li>如果等待超过 N 秒，就返回 -1；</li>
<li>如果刚开始执行的时候，就发现已经执行过这个位置了，则返回 0。</li>
</ol>
<p>对于图 5 中先执行 trx1，再执行一个查询请求的逻辑，要保证能够查到正确的数据，我们可以使用这个逻辑：</p>
<ol>
<li>trx1 事务更新完成后，马上执行 show master status 得到当前主库执行到的 File 和 Position；</li>
<li>选定一个从库执行查询语句；</li>
<li>在从库上执行 <code>select master_pos_wait(File, Position, 1)</code>；</li>
<li>如果返回值是 &gt;=0 的正整数，则在这个从库执行查询语句；</li>
<li>否则，到主库执行查询语句。</li>
</ol>
<p>我把上面这个流程画出来。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/b20ae91ea46803df1b63ed683e1de357.png" /></p>
<p>图 6 <code>master_pos_wait</code> 方案</p>
<p>这里我们假设，这条 select 查询最多在从库上等待 1 秒。那么，如果 1 秒内 <code>master_pos_wait</code> 返回一个大于等于 0 的整数，就确保了从库上执行的这个查询结果一定包含了 trx1 的数据。</p>
<p>步骤 5 到主库执行查询语句，是这类方案常用的退化机制。因为从库的延迟时间不可控，不能无限等待，所以如果等待超时，就应该放弃，然后到主库去查。</p>
<p>你可能会说，如果所有的从库都延迟超过 1 秒了，那查询压力不就都跑到主库上了吗？确实是这样。</p>
<p>但是，按照我们设定不允许过期读的要求，就只有两种选择，一种是超时放弃，一种是转到主库查询。具体怎么选择，就需要业务开发同学做好限流策略了。</p>
<h3 id="gtid_2">GTID 方案<a class="headerlink" href="#gtid_2" title="Permanent link">&para;</a></h3>
<p>如果你的数据库开启了 GTID 模式，对应的也有等待 GTID 的方案。</p>
<p>MySQL 中同样提供了一个类似的命令：</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">wait_for_executed_gtid_set</span><span class="p">(</span><span class="n">gtid_set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<p>这条命令的逻辑是：</p>
<ol>
<li>等待，直到这个库执行的事务中包含传入的 gtid_set，返回 0；</li>
<li>超时返回 1。</li>
</ol>
<p>在前面等位点的方案中，我们执行完事务后，还要主动去主库执行 <code>show master status</code>。</p>
<p>而 MySQL 5.7.6 版本开始，允许在执行完更新类事务后，把这个事务的 GTID 返回给客户端，这样等 GTID 的方案就可以减少一次查询。</p>
<p>这时，等 GTID 的执行流程就变成了：</p>
<ol>
<li>trx1 事务更新完成后，从返回包直接获取这个事务的 GTID，记为 gtid1；</li>
<li>选定一个从库执行查询语句；</li>
<li>在从库上执行 <code>select wait_for_executed_gtid_set(gtid1, 1)</code>；</li>
<li>如果返回值是 0，则在这个从库执行查询语句；</li>
<li>否则，到主库执行查询语句。</li>
</ol>
<p>跟等主库位点的方案一样，等待超时后是否直接到主库查询，需要业务开发同学来做限流考虑。</p>
<p>我把这个流程图画出来。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/d521de8017297aff59db2f68170ee739.png" /></p>
<p>图 7 <code>wait_for_executed_gtid_set</code> 方案</p>
<p>在上面的第一步中，trx1 事务更新完成后，从返回包直接获取这个事务的 GTID。</p>
<p>问题是，怎么能够让 MySQL 在执行事务后，返回包中带上 GTID 呢？</p>
<p>你只需要将参数 <code>session_track_gtids</code> 设置为 <code>OWN_GTID</code>，然后通过 API 接口 <code>mysql_session_track_get_first</code> 从返回包解析出 GTID 的值即可。</p>
<p>在第一篇文章中，我介绍 <code>mysql_reset_connection</code> 的时候，评论区有同学留言问这类接口应该怎么使用。</p>
<p>这里我再回答一下。其实，MySQL 并没有提供这类接口的 SQL 用法，是提供给程序的 API。</p>
<h3 id="_30">小结<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>在今天这篇文章中，我跟你介绍了一主多从做读写分离时，可能碰到过期读的原因，以及几种应对的方案。</p>
<p>这几种方案中，有的方案看上去是做了妥协，有的方案看上去不那么靠谱儿，但都是有实际应用场景的，你需要根据业务需求选择。</p>
<p>即使是最后等待位点和等待 GTID 这两个方案，虽然看上去比较靠谱儿，但仍然存在需要权衡的情况。如果所有的从库都延迟，那么请求就会全部落到主库上，这时候会不会由于压力突然增大，把主库打挂了呢？</p>
<p>其实，在实际应用中，这几个方案是可以混合使用的。</p>
<p>比如，先在客户端对请求做分类，区分哪些请求可以接受过期读，而哪些请求完全不能接受过期读；然后，对于不能接受过期读的语句，再使用等 GTID 或等位点的方案。</p>
<p>但话说回来，过期读在本质上是由一写多读导致的。在实际应用中，可能会有别的不需要等待就可以水平扩展的数据库方案，但这往往是用牺牲写性能换来的，也就是需要在读性能和写性能中取权衡。</p>
<h2 id="29">29 如何判断一个数据库是不是出问题了？<a class="headerlink" href="#29" title="Permanent link">&para;</a></h2>
<p>前面文章中，介绍了主备切换流程。通过这些内容的讲解，你应该已经很清楚了：在一主一备的双 M 架构里，主备切换只需要把客户端流量切到备库；而在一主多从架构里，主备切换除了要把客户端流量切到备库外，还需要把从库接到新主库上。</p>
<p>主备切换有两种场景，一种是主动切换，一种是被动切换。而其中被动切换，往往是因为主库出问题了，由 HA 系统发起的。</p>
<p>这也就引出了我们今天要讨论的问题：怎么判断一个主库出问题了？</p>
<p>你一定会说，这很简单啊，连上 MySQL，执行个 select 1 就好了。但是 select 1 成功返回了，就表示主库没问题吗？</p>
<h3 id="select-1">select 1 判断<a class="headerlink" href="#select-1" title="Permanent link">&para;</a></h3>
<p>实际上，select 1 成功返回，只能说明这个库的进程还在，并不能说明主库没问题。现在，我们来看一下这个场景。</p>
<div class="highlight"><pre><span></span><code><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">innodb_thread_concurrency</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
<th>session D</th>
</tr>
</thead>
<tbody>
<tr>
<td>select sleep(100) from t;</td>
<td>select sleep(100) from t;</td>
<td>select sleep(100) from t;</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>select 1;<br />(Query OK)<br />select * from t;<br />(blocked)</td>
</tr>
</tbody>
</table>
<p>我们设置 <code>innodb_thread_concurrency</code> 参数的目的是，控制 InnoDB 的并发线程上限。也就是说，一旦并发线程数达到这个值，InnoDB 在接收到新请求的时候，就会进入等待状态，直到有线程退出。</p>
<p>这里，我把 <code>innodb_thread_concurrency</code> 设置成 3，表示 InnoDB 只允许 3 个线程并行执行。而在我们的例子中，前三个 session 中的 sleep(100)，使得这三个语句都处于“执行”状态，以此来模拟大查询。</p>
<p>你看到了， session D 里面，select 1 是能执行成功的，但是查询表 t 的语句会被堵住。也就是说，如果这时候我们用 select 1 来检测实例是否正常的话，是检测不出问题的。</p>
<p>在 InnoDB 中，<code>innodb_thread_concurrency</code> 这个参数的默认值是 0，表示不限制并发线程数量。但是，不限制并发线程数肯定是不行的。因为，一个机器的 CPU 核数有限，线程全冲进来，上下文切换的成本就会太高。</p>
<p>所以，通常情况下，我们建议把 <code>innodb_thread_concurrency</code> 设置为 64~128 之间的值。这时，你一定会有疑问，并发线程上限数设置为 128 够干啥，线上的并发连接数动不动就上千了。</p>
<p>产生这个疑问的原因，是搞混了**并发连接和并发查询。**</p>
<p>并发连接和并发查询，并不是同一个概念。你在 <code>show processlist</code> 的结果里，看到的几千个连接，指的就是并发连接。而“当前正在执行”的语句，才是我们所说的并发查询。</p>
<p>并发连接数达到几千个影响并不大，就是多占一些内存而已。我们应该关注的是并发查询，因为并发查询太高才是 CPU 杀手。这也是为什么我们需要设置 <code>innodb_thread_concurrency</code> 参数的原因。</p>
<p>实际上，<strong>在线程进入锁等待以后，并发线程的计数会减一</strong>，也就是说等行锁（也包括间隙锁）的线程是不算在 128 里面的。</p>
<p>MySQL 这样设计是非常有意义的。因为，进入锁等待的线程已经不吃 CPU 了；更重要的是，必须这么设计，才能避免整个系统锁死。</p>
<p>为什么呢？假设处于锁等待的线程也占并发线程的计数，你可以设想一下这个场景：</p>
<ol>
<li>线程 1 执行 <code>begin; update t set c=c+1 where id=1</code>, 启动了事务 trx1， 然后保持这个状态。这时候，线程处于空闲状态，不算在并发线程里面。</li>
<li>线程 2 到线程 129 都执行 <code>update t set c=c+1 where id=1</code>; 由于等行锁，进入等待状态。这样就有 128 个线程处于等待状态；</li>
<li>如果处于锁等待状态的线程计数不减一，InnoDB 就会认为线程数用满了，会阻止其他语句进入引擎执行，这样线程 1 不能提交事务。而另外的 128 个线程又处于锁等待状态，整个系统就堵住了。</li>
</ol>
<p>下图 2 显示的就是这个状态。</p>
<p><img alt="img" src="../../../images/mysql-lecture-45/3206ea18b8a24b546515b1b95dc4a11d.png" /></p>
<p>图 2 系统锁死状态（假设等行锁的语句占用并发计数）</p>
<p>这时候 InnoDB 不能响应任何请求，整个系统被锁死。而且，由于所有线程都处于等待状态，此时占用的 CPU 却是 0，而这明显不合理。所以，我们说 InnoDB 在设计时，遇到进程进入锁等待的情况时，将并发线程的计数减 1 的设计，是合理而且是必要的。</p>
<p>虽然说等锁的线程不算在并发线程计数里，但如果它在真正地执行查询，就比如我们上面例子中前三个事务中的 <code>select sleep(100) from t</code>，还是要算进并发线程的计数的。</p>
<p>在这个例子中，同时在执行的语句超过了设置的 <code>innodb_thread_concurrency</code> 的值，这时候系统其实已经不行了，但是通过 select 1 来检测系统，会认为系统还是正常的。</p>
<p>因此，我们使用 select 1 的判断逻辑要修改一下。</p>
<h3 id="_31">查表判断<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>为了能够检测 InnoDB 并发线程数过多导致的系统不可用情况，我们需要找一个访问 InnoDB 的场景。一般的做法是，在系统库（mysql 库）里创建一个表，比如命名为 health_check，里面只放一行数据，然后定期执行：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">health_check</span><span class="p">;</span><span class="w"> </span>
</code></pre></div>
<p>使用这个方法，我们可以检测出由于并发线程过多导致的数据库不可用的情况。</p>
<p>但是，我们马上还会碰到下一个问题，即：空间满了以后，这种方法又会变得不好使。</p>
<p>我们知道，更新事务要写 binlog，而一旦 binlog 所在磁盘的空间占用率达到 100%，那么所有的更新语句和事务提交的 commit 语句就都会被堵住。但是，系统这时候还是可以正常读数据的。</p>
<p>因此，我们还是把这条监控语句再改进一下。接下来，我们就看看把查询语句改成更新语句后的效果。</p>
<h3 id="_32">更新判断<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>既然要更新，就要放个有意义的字段，常见做法是放一个 timestamp 字段，用来表示最后一次执行检测的时间。这条更新语句类似于：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">health_check</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">t_modified</span><span class="o">=</span><span class="n">now</span><span class="p">();</span>
</code></pre></div>
<p>节点可用性的检测都应该包含主库和备库。如果用更新来检测主库的话，那么备库也要进行更新检测。</p>
<p>但，备库的检测也是要写 binlog 的。由于我们一般会把数据库 A 和 B 的主备关系设计为双 M 结构，所以在备库 B 上执行的检测命令，也要发回给主库 A。</p>
<p>但是，如果主库 A 和备库 B 都用相同的更新命令，就可能出现行冲突，也就是可能会导致主备同步停止。所以，现在看来 <code>mysql.health_check</code> 这个表就不能只有一行数据了。</p>
<p>为了让主备之间的更新不产生冲突，我们可以在 mysql.health_check 表上存入多行数据，并用 A、B 的 server_id 做主键。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">health_check</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">t_modified</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w"> </span>
<span class="cm">/* 检测命令 */</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">health_check</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">t_modified</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="o">@@</span><span class="n">server_id</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">())</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">duplicate</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">t_modified</span><span class="o">=</span><span class="n">now</span><span class="p">();</span>
</code></pre></div>
<p>由于 MySQL 规定了主库和备库的 server_id 必须不同（否则创建主备关系的时候就会报错），这样就可以保证主、备库各自的检测命令不会发生冲突。</p>
<p>更新判断是一个相对比较常用的方案了，不过依然存在一些问题。其中，“判定慢”一直是让 DBA 头疼的问题。</p>
<p>你一定会疑惑，<strong>更新语句，如果失败或者超时，就可以发起主备切换了，为什么还会有判定慢的问题呢？</strong></p>
<p>其实，这里涉及到的是服务器 IO 资源分配的问题。</p>
<p>首先，所有的检测逻辑都需要一个超时时间 N。执行一条 update 语句，超过 N 秒后还不返回，就认为系统不可用。</p>
<p>你可以设想一个日志盘的 IO 利用率已经是 100% 的场景。这时候，整个系统响应非常慢，已经需要做主备切换了。</p>
<p>但是你要知道，IO 利用率 100% 表示系统的 IO 是在工作的，每个请求都有机会获得 IO 资源，执行自己的任务。而我们的检测使用的 update 命令，需要的资源很少，所以可能在拿到 IO 资源的时候就可以提交成功，并且在超时时间 N 秒未到达之前就返回给了检测系统。</p>
<p>检测系统一看，update 命令没有超时，于是就得到了“系统正常”的结论。</p>
<p>也就是说，这时候在业务系统上正常的 SQL 语句已经执行得很慢了，但是 DBA 上去一看，HA 系统还在正常工作，并且认为主库现在处于可用状态。</p>
<p>之所以会出现这个现象，根本原因是我们上面说的所有方法，都是基于外部检测的。外部检测天然有一个问题，就是随机性。</p>
<p>因为，外部检测都需要定时轮询，所以系统可能已经出问题了，但是却需要等到下一个检测发起执行语句的时候，我们才有可能发现问题。而且，如果你的运气不够好的话，可能第一次轮询还不能发现，这就会导致切换慢的问题。</p>
<p>所以，接下来我要再和你介绍一种在 MySQL 内部发现数据库问题的方法。</p>
<h3 id="_33">内部统计<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>针对磁盘利用率这个问题，如果 MySQL 可以告诉我们，内部每一次 IO 请求的时间，那我们判断数据库是否出问题的方法就可靠得多了。</p>
<p>其实，MySQL 5.6 版本以后提供的 <code>performance_schema</code> 库，就在 <code>file_summary_by_event_name</code> 表里统计了每次 IO 请求的时间。</p>
<p><code>file_summary_by_event_name</code> 表里有很多行数据，我们先来看看 <code>event_name='wait/io/file/innodb/innodb_log_file’</code>这一行。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">file_summary_by_event_name</span><span class="w"> </span>
<span class="w">      </span><span class="k">where</span><span class="w"> </span><span class="n">event_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class="w"> </span><span class="err">\</span><span class="k">G</span><span class="p">;</span>
<span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span>
<span class="w">               </span><span class="n">EVENT_NAME</span><span class="p">:</span><span class="w"> </span><span class="n">wait</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">innodb</span><span class="o">/</span><span class="n">innodb_log_file</span>
<span class="w">               </span><span class="n">COUNT_STAR</span><span class="p">:</span><span class="w"> </span><span class="mi">793403</span>
<span class="w">           </span><span class="n">SUM_TIMER_WAIT</span><span class="p">:</span><span class="w"> </span><span class="mi">95887122719672</span>
<span class="w">           </span><span class="n">MIN_TIMER_WAIT</span><span class="p">:</span><span class="w"> </span><span class="mi">871382</span>
<span class="w">           </span><span class="n">AVG_TIMER_WAIT</span><span class="p">:</span><span class="w"> </span><span class="mi">120855468</span>
<span class="w">           </span><span class="n">MAX_TIMER_WAIT</span><span class="p">:</span><span class="w"> </span><span class="mi">735743606690</span>
<span class="w">               </span><span class="n">COUNT_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span>
<span class="w">           </span><span class="n">SUM_TIMER_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">33772444588</span>
<span class="w">           </span><span class="n">MIN_TIMER_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">1012608</span>
<span class="w">           </span><span class="n">AVG_TIMER_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">4221555427</span>
<span class="w">           </span><span class="n">MAX_TIMER_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">24994999638</span>
<span class="w"> </span><span class="n">SUM_NUMBER_OF_BYTES_READ</span><span class="p">:</span><span class="w"> </span><span class="mi">70656</span>
<span class="w">              </span><span class="n">COUNT_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">415313</span>
<span class="w">          </span><span class="n">SUM_TIMER_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">26836729823736</span>
<span class="w">          </span><span class="n">MIN_TIMER_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">2974536</span>
<span class="w">          </span><span class="n">AVG_TIMER_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">64617927</span>
<span class="w">          </span><span class="n">MAX_TIMER_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">228565239606</span>
<span class="n">SUM_NUMBER_OF_BYTES_WRITE</span><span class="p">:</span><span class="w"> </span><span class="mi">345248256</span>
<span class="w">               </span><span class="n">COUNT_MISC</span><span class="p">:</span><span class="w"> </span><span class="mi">378082</span>
<span class="w">           </span><span class="n">SUM_TIMER_MISC</span><span class="p">:</span><span class="w"> </span><span class="mi">69016620451348</span>
<span class="w">           </span><span class="n">MIN_TIMER_MISC</span><span class="p">:</span><span class="w"> </span><span class="mi">871382</span>
<span class="w">           </span><span class="n">AVG_TIMER_MISC</span><span class="p">:</span><span class="w"> </span><span class="mi">182543981</span>
<span class="w">           </span><span class="n">MAX_TIMER_MISC</span><span class="p">:</span><span class="w"> </span><span class="mi">735743606690</span>
<span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>图中这一行表示统计的是 redo log 的写入时间，第一列 EVENT_NAME 表示统计的类型。</p>
<p>接下来的三组数据，显示的是 redo log 操作的时间统计。</p>
<p>第一组五列，是所有 IO 类型的统计。其中，<code>COUNT_STAR</code> 是所有 IO 的总次数，接下来四列是具体的统计项， 单位是皮秒；前缀 SUM、MIN、AVG、MAX，顾名思义指的就是总和、最小值、平均值和最大值。</p>
<p>第二组六列，是读操作的统计。最后一列 <code>SUM_NUMBER_OF_BYTES_READ</code> 统计的是，总共从 redo log 里读了多少个字节。</p>
<p>第三组六列，统计的是写操作。</p>
<p>最后的第四组数据，是对其他类型数据的统计。在 redo log 里，你可以认为它们就是对 fsync 的统计。</p>
<p>在 <code>performance_schema</code> 库的 <code>file_summary_by_event_name</code> 表里，binlog 对应的是 <code>event_name = 'wait/io/file/sql/binlog'</code>这一行。各个字段的统计逻辑，与 redo log 的各个字段完全相同。这里，我就不再赘述了。</p>
<p>因为我们每一次操作数据库，<code>performance_schema</code> 都需要额外地统计这些信息，所以我们打开这个统计功能是有性能损耗的。</p>
<p>我的测试结果是，如果打开所有的 <code>performance_schema</code> 项，性能大概会下降 10% 左右。所以，我建议你只打开自己需要的项进行统计。你可以通过下面的方法打开或者关闭某个具体项的统计。</p>
<p>如果要打开 redo log 的时间监控，你可以执行这个语句：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">setup_instruments</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">ENABLED</span><span class="o">=</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Timed</span><span class="o">=</span><span class="s1">&#39;YES&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%wait/io/file/innodb/innodb_log_file%&#39;</span><span class="p">;</span>
</code></pre></div>
<p>假设，现在你已经开启了 redo log 和 binlog 这两个统计信息，那要怎么把这个信息用在实例状态诊断上呢？</p>
<p>很简单，你可以通过 MAX_TIMER 的值来判断数据库是否出问题了。比如，你可以设定阈值，单次 IO 请求时间超过 200 毫秒属于异常，然后使用类似下面这条语句作为检测逻辑。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">event_name</span><span class="p">,</span><span class="n">MAX_TIMER_WAIT</span><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">file_summary_by_event_name</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">event_name</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class="p">,</span><span class="s1">&#39;wait/io/file/sql/binlog&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">MAX_TIMER_WAIT</span><span class="o">&gt;</span><span class="mi">200</span><span class="o">*</span><span class="mi">1000000000</span><span class="p">;</span>
</code></pre></div>
<p>发现异常后，取到你需要的信息，再通过下面这条语句：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">truncate</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">file_summary_by_event_name</span><span class="p">;</span>
</code></pre></div>
<p>把之前的统计信息清空。这样如果后面的监控中，再次出现这个异常，就可以加入监控累积值了。</p>
<h3 id="_34">小结<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>今天，我和你介绍了检测一个 MySQL 实例健康状态的几种方法，以及各种方法存在的问题和演进的逻辑。</p>
<p>你看完后可能会觉得，select 1 这样的方法是不是已经被淘汰了呢，但实际上使用非常广泛的 MHA（Master High Availability），默认使用的就是这个方法。</p>
<p>MHA 中的另一个可选方法是只做连接，就是 “如果连接成功就认为主库没问题”。不过据我所知，选择这个方法的很少。</p>
<p>其实，每个改进的方案，都会增加额外损耗，并不能用“对错”做直接判断，需要你根据业务实际情况去做权衡。</p>
<p>我个人比较倾向的方案，是优先考虑 update 系统表，然后再配合增加检测 <code>performance_schema</code> 的信息。</p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; wgzhao
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/01mlsx" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/wgzhao" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.indexes", "navigation.expand", "content.code.annotate", "content.tabs.link", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "header.autohide", "announce.dismiss", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.5090c770.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js"></script>
      
    
  </body>
</html>