{"version": "https://jsonfeed.org/version/1", "title": "\u4e2a\u4eba\u7b14\u8bb0", "home_page_url": "https://wgzhao.github.io/notes/", "feed_url": "https://wgzhao.github.io/notes/feed_json_updated.json", "description": "\u8bb0\u5f55\u65e5\u5e38\u5de5\u4f5c\u3001\u5b66\u4e60\u7684\u4e00\u4e9b\u6587\u6863\uff0c\u6536\u85cf\u770b\u5230\u597d\u7684\u8d44\u6e90\u7b49", "icon": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Feed-icon.svg/128px-Feed-icon.svg.png", "authors": [{"name": "wgzhao"}], "language": "zh", "items": [{"id": "https://wgzhao.github.io/notes/", "url": "https://wgzhao.github.io/notes/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Home", "content_html": "<h1 id=\"home\">Home<a class=\"headerlink\" href=\"#home\" title=\"Permanent link\">&para;</a></h1>\n<p>\u8ba1\u5212\u5728\u8fd9\u91cc\u8bb0\u5f55\u81ea\u5df1\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u9047\u5230\u95ee\u9898\u7684\u89e3\u51b3\u529e\u6cd5\uff0c\u64b0\u5199\u7684\u4e00\u4e9b\u53ef\u5f00\u653e\u7684\u6587\u6863\uff0c\u4ee5\u53ca\u5e73\u65e5\u5b66\u4e60\u7684\u6587\u6863\u3002\n\u6536\u85cf\u770b\u5230\u7684\u4e00\u4e9b\u597d\u7684\uff0c\u6709\u8da3\u3001\u6709\u7528\u7684\u8d44\u6e90\u3002</p>\n<h2 id=\"_1\">\u6761\u76ee<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>bigdata: \u4e00\u4e9b\u548c\u5927\u6570\u636e\u6709\u5173\u7684\u5185\u5bb9\uff0c\u5305\u62ec Hadoop, Spark, Flink, Hive \u7b49</li>\n<li>courses: \u4e00\u4e9b\u8bfe\u7a0b\u7b14\u8bb0\uff0c\u7cfb\u5217\u6587\u7ae0\u6216\u8005\u6458\u5f55\u7684\u4e13\u680f\u7b49</li>\n<li>database: RDBMS \u76f8\u5173\u7684\u4e00\u4e9b\u5185\u5bb9</li>\n<li>kubernetes: \u4e91\u539f\u751f\uff0ckubernetes \u751f\u6001\u7b49\u76f8\u5173\u5185\u5bb9</li>\n<li>programming: \u7f16\u7a0b\u8bed\u8a00\u76f8\u5173\u7684\u4e00\u4e9b\u6280\u5de7\uff0c\u7406\u8bba\u548c\u7b14\u8bb0</li>\n<li>troubleshooting: \u81ea\u5df1\u9047\u5230\u7684\u6216\u8005\u5728\u7f51\u7edc\u770b\u5230\u7684\u6709\u4e9b\u6709\u4ee3\u8868\u610f\u4e49\u7684\u6545\u969c\u6392\u67e5\u6848\u4f8b</li>\n<li>tips: \u5947\u6280\u6deb\u5de7\u4e4b\u7c7b\u7280\u5229\u800c\u65e0\u7528\u7684\u4e00\u4e9b\u5185\u5bb9</li>\n</ul>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": []}, {"id": "https://wgzhao.github.io/notes/tags/", "url": "https://wgzhao.github.io/notes/tags/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Tags", "content_html": "<h1 id=\"tags\">Tags<a class=\"headerlink\" href=\"#tags\" title=\"Permanent link\">&para;</a></h1>\n<p>Following is a list of relevant tags:</p>\n<h3 id=\"tags.md:47-69/slug\">tags.md:47-69/name<a class=\"headerlink\" href=\"#tags.md:47-69/slug\" title=\"Permanent link\">&para;</a></h3>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": []}, {"id": "https://wgzhao.github.io/notes/bigdata/ambari-cli/", "url": "https://wgzhao.github.io/notes/bigdata/ambari-cli/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u4f7f\u7528 Ambari API \u6765\u64cd\u4f5c Hadoop \u96c6\u7fa4", "content_html": "<p>Ambari \u7ba1\u7406\u7684hadoop\u96c6\u7fa4\uff0c\u5927\u90e8\u5206\u64cd\u4f5c\u90fd\u53ef\u4ee5\u5728\u5176\u7ba1\u7406\u9875\u9762\u4e0a\u5b8c\u6210\u60f3\u8981\u7684\u64cd\u4f5c\uff0c\u4f46\u662f\u6709\u4e9b\u64cd\u4f5c\u5374\u4e0d\u884c\uff0c\u6bd4\u5982\u4e00\u4e9b\u670d\u52a1\u5e76\u4e0d\u63d0\u4f9b\u5220\u9664\u64cd\u4f5c\uff0c\u53e6\u5916\u5f53\u4e00\u4e2a\u8282\u70b9\u5904\u4e8e\u5fc3\u8df3\u4e22\u5931\u60c5\u51b5\u4e0b\uff0c\u4e5f\u65e0\u6cd5\u5728\u9875\u9762\u4e0a\u5c06\u5176\u4ece\u96c6\u7fa4\u4e2d\u5265\u79bb\u51fa\u6765\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6709\u4e9b\u7279\u522b\u7684\u64cd\u4f5c\u8fd8\u662f\u9700\u8981\u76f4\u63a5\u4f7f\u7528Amabri \u63d0\u4f9b\u7684API \u63a5\u53e3\u3002</p>\n<p>\u8fd9\u91cc\u5047\u5b9a\u8bbf\u95eeAmbari API\u6240\u5fc5\u8981\u7684\u51e0\u4e2a\u53c2\u6570</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">AMBARI_URL</span><span class=\"o\">=</span>http://hadoop1.wgzhao.com:8080\n<span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">AMBARI_USER</span><span class=\"o\">=</span>admin\n<span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">AMBARI_PASS</span><span class=\"o\">=</span>admin\n<span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"o\">=</span>cluster\n</code></pre></div>\n<p>\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u5e38\u7528\u64cd\u4f5c</p>\n<h2 id=\"_1\">\u67e5\u770b\u67d0\u4e2a\u8282\u70b9\u4e0a\u6240\u5b89\u88c5\u7684\u670d\u52a1<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>GET<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop3.wgzhao.com\n</code></pre></div>\n<h2 id=\"_2\">\u5220\u9664\u67d0\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684\u6307\u5b9a\u670d\u52a1\u6216\u7ec4\u4ef6<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\">  </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>DELETE<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop3.wgzhao.com/host_components/JOURNALNODE\n</code></pre></div>\n<h2 id=\"_3\">\u5220\u9664\u67d0\u4e2a\u8282\u70b9<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6ce8\u610f\uff0c\u5220\u9664\u67d0\u4e00\u4e2a\u8282\u70b9\u4e4b\u524d\uff0c\u9700\u8981\u5148\u5220\u9664\u8282\u70b9\u4e0a\u7684\u6240\u6709\u670d\u52a1</p>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>DELETE<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop3.wgzhao.com\n</code></pre></div>\n<h2 id=\"_4\">\u589e\u52a0\u8282\u70b9\u5230\u96c6\u7fa4<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\">  </span>-X<span class=\"w\"> </span>GET<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop25.wgzhao.com\n</code></pre></div>\n<h2 id=\"_5\">\u65b0\u65b0\u589e\u7684\u8282\u70b9\u4e0a\u5b89\u88c5\u5236\u5b9a\u670d\u52a1<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h2>\n<p><div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\">  </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>PUT<span class=\"w\"> </span>-d<span class=\"w\"> </span><span class=\"s1\">&#39;{&quot;HostRoles&quot;: {&quot;state&quot;: &quot;INSTALLED&quot;}}&#39;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop25.wgzhao.com/host_components/DATANODE\n</code></pre></div>\n\u53d1\u51fa\u5b89\u88c5\u547d\u4ee4\u540e\uff0c\u4f1a\u7ed9\u51fa\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u53cd\u9988\u4fe1\u606f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;href&quot;</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot; ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/requests/9&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;Requests&quot;</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;id&quot;</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;status&quot;</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;InProgress&quot;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>\u6839\u636e\u8f93\u51fa\u7684ID\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u5b89\u88c5\u72b6\u6001</p>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\">  </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>GET<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/requests/9\ncurl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\">  </span>-X<span class=\"w\"> </span>GET<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/requests/9/tasks/101\n\n<span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;href&quot;</span><span class=\"w\"> </span>:<span class=\"w\"> </span><span class=\"s2\">&quot;</span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span><span class=\"s2\">/api/v1/clusters/</span><span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span><span class=\"s2\">/requests/9/tasks/101&quot;</span>,\n<span class=\"w\">  </span><span class=\"s2\">&quot;Tasks&quot;</span><span class=\"w\"> </span>:<span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span>...\n<span class=\"w\">    </span><span class=\"s2\">&quot;status&quot;</span><span class=\"w\"> </span>:<span class=\"w\"> </span><span class=\"s2\">&quot;COMPLETED&quot;</span>,\n<span class=\"w\">    </span>...\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<h2 id=\"_6\">\u542f\u52a8\u521a\u5b89\u88c5\u7684\u670d\u52a1<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s2\">&quot;X-Requested-By: ambari&quot;</span><span class=\"w\">  </span>-X<span class=\"w\"> </span>PUT<span class=\"w\"> </span>-d<span class=\"w\">  </span><span class=\"s1\">&#39;{&quot;HostRoles&quot;: {&quot;state&quot;: &quot;STARTED&quot;}}&#39;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/hosts/hadoop25.wgzhao.com/host_components/DATANODE\n</code></pre></div>\n<h2 id=\"hdfs\">\u505c\u6b62 HDFS \u670d\u52a1<a class=\"headerlink\" href=\"#hdfs\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-i<span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s1\">&#39;X-Requested-By: ambari&#39;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>PUT<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span>-d<span class=\"w\"> </span><span class=\"s1\">&#39;{&quot;RequestInfo&quot;: {&quot;context&quot; :&quot;Stop HDFS via REST&quot;}, &quot;Body&quot;: {&quot;ServiceInfo&quot;: {&quot;state&quot;: &quot;INSTALLED&quot;}}}&#39;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/services/HDFS\n</code></pre></div>\n<h2 id=\"hdfs_1\">\u542f\u52a8 HDFS \u670d\u52a1<a class=\"headerlink\" href=\"#hdfs_1\" title=\"Permanent link\">&para;</a></h2>\n<div class=\"highlight\"><pre><span></span><code>curl<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_USER</span><span class=\"si\">}</span>:<span class=\"si\">${</span><span class=\"nv\">AMBARI_PASS</span><span class=\"si\">}</span><span class=\"w\"> </span>-i<span class=\"w\"> </span>-H<span class=\"w\"> </span><span class=\"s1\">&#39;X-Requested-By: ambari&#39;</span><span class=\"w\"> </span>-X<span class=\"w\"> </span>PUT<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span>-d<span class=\"w\"> </span><span class=\"s1\">&#39;{&quot;RequestInfo&quot;: {&quot;context&quot; :&quot;Start HDFS via REST&quot;}, &quot;Body&quot;: {&quot;ServiceInfo&quot;: {&quot;state&quot;: &quot;STARTED&quot;}}}&#39;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">  </span><span class=\"si\">${</span><span class=\"nv\">AMBARI_URL</span><span class=\"si\">}</span>/api/v1/clusters/<span class=\"si\">${</span><span class=\"nv\">AMBARI_CLUSTER</span><span class=\"si\">}</span>/services/HDFS\n</code></pre></div>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["ambari", "cli"]}, {"id": "https://wgzhao.github.io/notes/bigdata/flink-cdc-practices/", "url": "https://wgzhao.github.io/notes/bigdata/flink-cdc-practices/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790", "content_html": "<p><a href=\"https://developer.aliyun.com/article/782653\" title=\"Permalink to Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790\">Source</a></p>\n<blockquote>\n<p>\u672c\u6587\u7531\u6c11\u751f\u94f6\u884c\u738b\u5065\u3001\u6587\u4e54\u5206\u4eab\uff0c\u4e3b\u8981\u4ecb\u7ecd\u6c11\u751f\u94f6\u884c Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790\u3002\u5185\u5bb9\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u80cc\u666f</li>\n<li>\u4ec0\u4e48\u662f Flink SQL CDC Connectors</li>\n<li>Flink SQL CDC \u539f\u7406\u4ecb\u7ecd</li>\n<li>\u4e09\u79cd\u6570\u636e\u540c\u6b65\u65b9\u6848</li>\n<li>Flink SQL CDC + JDBC Connector \u540c\u6b65\u65b9\u6848\u9a8c\u8bc1</li>\n<li>Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5206\u6790</li>\n<li>Flink SQL CDC \u76ee\u524d\u5b58\u5728\u7684\u7f3a\u9677</li>\n</ol>\n</blockquote>\n<h2 id=\"_1\">\u4e00. \u80cc\u666f<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6570\u636e\u51c6\u5b9e\u65f6\u590d\u5236\uff08CDC\uff09\u662f\u76ee\u524d\u884c\u5185\u5b9e\u65f6\u6570\u636e\u9700\u6c42\u5927\u91cf\u4f7f\u7528\u7684\u6280\u672f\uff0c\u968f\u7740\u56fd\u4ea7\u5316\u7684\u9700\u6c42\uff0c\u6211\u4eec\u4e5f\u9010\u6b65\u8003\u8651\u57fa\u4e8e\u5f00\u6e90\u4ea7\u54c1\u8fdb\u884c\u51c6\u5b9e\u65f6\u6570\u636e\u540c\u6b65\u5de5\u5177\u7684\u76f8\u5173\u5f00\u53d1\uff0c\u9010\u6b65\u5b9e\u73b0\u5bf9\u5546\u4e1a\u4ea7\u54c1\u7684\u66ff\u4ee3\u3002\u6211\u4eec\u8bc4\u4f30\u4e86\u51e0\u79cd\u5f00\u6e90\u4ea7\u54c1\uff0cCanal\u3001Debezium\u3001Flink CDC \u7b49\u4ea7\u54c1\u3002\u4f5c\u4e86\u5982\u4e0b\u7684\u5bf9\u6bd4\uff1a</p>\n<p><img alt=\"\" src=\"https://ucc.alicdn.com/pic/developer-ecology/8a4b3ffd92dc464bb083d9aaf226ca9b.png\" /></p>\n<h2 id=\"flink-sql-cdc-connectors\">\u4e8c.\u4ec0\u4e48\u662f Flink SQL CDC Connectors<a class=\"headerlink\" href=\"#flink-sql-cdc-connectors\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 Flink 1.11 \u5f15\u5165\u4e86 CDC \u673a\u5236\uff0cCDC \u7684\u5168\u79f0\u662f Change Data Capture\uff0c\u7528\u4e8e\u6355\u6349\u6570\u636e\u5e93\u8868\u7684\u589e\u5220\u6539\u67e5\u64cd\u4f5c\uff0c\u662f\u76ee\u524d\u975e\u5e38\u6210\u719f\u7684\u540c\u6b65\u6570\u636e\u5e93\u53d8\u66f4\u65b9\u6848\u3002</p>\n<p>Flink CDC Connectors \u662f Apache Flink \u7684\u4e00\u7ec4\u6e90\u8fde\u63a5\u5668\uff0c\u662f\u53ef\u4ee5\u4ece MySQL\u3001PostgreSQL \u6570\u636e\u76f4\u63a5\u8bfb\u53d6\u5168\u91cf\u6570\u636e\u548c\u589e\u91cf\u6570\u636e\u7684 Source Connectors\uff0c\u5f00\u6e90\u5730\u5740\uff1a<a href=\"https://github.com/ververica/flink-cdc-connectors\">https://github.com/ververica/flink-cdc-connectors</a>\u3002</p>\n<p>\u76ee\u524d(1.11\u7248\u672c)\u652f\u6301\u7684 Connectors \u5982\u4e0b\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/7b03799d4c0a460c8559ced225d3e5f1.png\" /></p>\n<p>\u53e6\u5916\u652f\u6301\u89e3\u6790 Kafka \u4e2d debezium-json \u548c canal-json \u683c\u5f0f\u7684 Change Log\uff0c\u901a\u8fc7Flink \u8fdb\u884c\u8ba1\u7b97\u6216\u8005\u76f4\u63a5\u5199\u5165\u5230\u5176\u4ed6\u5916\u90e8\u6570\u636e\u5b58\u50a8\u7cfb\u7edf(\u6bd4\u5982 Elasticsearch)\uff0c\u6216\u8005\u5c06 Changelog Json \u683c\u5f0f\u7684 Flink \u6570\u636e\u5199\u5165\u5230 Kafka:</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/a4bfad0d85bc4155a15f7e98e164b2e4.png\" /></p>\n<h2 id=\"flink-sql-cdc\">\u4e09. Flink SQL CDC \u539f\u7406\u4ecb\u7ecd<a class=\"headerlink\" href=\"#flink-sql-cdc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u516c\u5f00\u7684 CDC \u8c03\u7814\u62a5\u544a\u4e2d\uff0cDebezium \u548c Canal \u662f\u6700\u6d41\u884c\u4f7f\u7528\u7684 CDC \u5de5\u5177\uff0c\u8fd9\u4e9b CDC \u5de5\u5177\u7684\u6838\u5fc3\u539f\u7406\u662f\u62bd\u53d6\u6570\u636e\u5e93\u65e5\u5fd7\u83b7\u53d6\u53d8\u66f4\u3002\u5728\u7ecf\u8fc7\u4e00\u7cfb\u5217\u8c03\u7814\u540e\uff0c\u6211\u884c\u91c7\u7528\u7684\u662f Debezium (\u652f\u6301\u5168\u91cf\u3001\u589e\u91cf\u540c\u6b65\uff0c\u540c\u65f6\u652f\u6301 MySQL\u3001PostgreSQL\u3001Oracle \u7b49\u6570\u636e\u5e93)\u3002</p>\n<p><strong>Flink SQL CDC \u5185\u7f6e\u4e86 Debezium \u5f15\u64ce\uff0c\u5229\u7528\u5176\u62bd\u53d6\u65e5\u5fd7\u83b7\u53d6\u53d8\u66f4\u7684\u80fd\u529b\uff0c\u5c06 changelog \u8f6c\u6362\u4e3a Flink SQL \u8ba4\u8bc6\u7684 RowData \u6570\u636e\u3002</strong>\uff08\u4ee5\u4e0b\u53f3\u4fa7\u662f Debezium \u7684\u6570\u636e\u683c\u5f0f\uff0c\u5de6\u4fa7\u662f Flink \u7684 RowData \u6570\u636e\u683c\u5f0f\uff09\u3002</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/24e62942fba945b5b44212cd3b4b52a9.png\" /></p>\n<p>RowData \u4ee3\u8868\u4e86\u4e00\u884c\u7684\u6570\u636e\uff0c\u5728 RowData \u4e0a\u9762\u4f1a\u6709\u4e00\u4e2a\u5143\u6570\u636e\u7684\u4fe1\u606f RowKind\uff0cRowKind \u91cc\u9762\u5305\u62ec\u4e86\u63d2\u5165(+I)\u3001\u66f4\u65b0\u524d(-U)\u3001\u66f4\u65b0\u540e(+U)\u3001\u5220\u9664(-D)\uff0c\u8fd9\u6837\u548c\u6570\u636e\u5e93\u91cc\u9762\u7684 binlog \u6982\u5ff5\u5341\u5206\u7c7b\u4f3c\u3002\u901a\u8fc7 Debezium \u91c7\u96c6\u7684\u6570\u636e\uff0c\u5305\u542b\u4e86\u65e7\u6570\u636e(before)\u548c\u65b0\u6570\u636e\u884c(after)\u4ee5\u53ca\u539f\u6570\u636e\u4fe1\u606f(source)\uff0cop \u7684 u \u8868\u793a\u662f update \u66f4\u65b0\u64cd\u4f5c\u6807\u8bc6\u7b26\uff08op \u5b57\u6bb5\u7684\u503c c\uff0cu\uff0cd\uff0cr \u5206\u522b\u5bf9\u5e94 create\uff0cupdate\uff0cdelete\uff0creade\uff09\uff0cts_ms \u8868\u793a\u540c\u6b65\u7684\u65f6\u95f4\u6233\u3002</p>\n<h2 id=\"_2\">\u56db. \u4e09\u79cd\u6570\u636e\u540c\u6b65\u65b9\u6848<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"41-debeziumkafka\">4.1 \u65b9\u6848\u4e00\uff1aDebezium+Kafka+\u8ba1\u7b97\u7a0b\u5e8f+\u5b58\u50a8\u7cfb\u7edf<a class=\"headerlink\" href=\"#41-debeziumkafka\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76ee\u524d\u6211\u884c\u5728\u751f\u4ea7\u4e0a\u91c7\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u65b9\u6848\uff0c\u91c7\u7528 Debezium \u8ba2\u9605 MySQL \u7684 Binlog \u4f20\u8f93\u5230 Kafka\uff0c\u540e\u7aef\u662f\u7531\u8ba1\u7b97\u7a0b\u5e8f\u4ece Kafka \u91cc\u6d88\u8d39\uff0c\u6700\u540e\u5c06\u6570\u636e\u5199\u5165\u5230\u5176\u4ed6\u5b58\u50a8\uff0c\u67b6\u6784\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/73955350263447f488e47858035a04be.png\" /></p>\n<p>\u8fd9\u79cd\u65b9\u6848\u4e2d\u5229\u7528 Kafka \u6d88\u606f\u961f\u5217\u505a\u89e3\u8026\uff0cChange Log \u53ef\u4f9b\u4efb\u4f55\u5176\u4ed6\u4e1a\u52a1\u7cfb\u7edf\u4f7f\u7528\uff0c\u6d88\u8d39\u7aef\u53ef\u91c7\u7528 Kafka Sink Connector \u6216\u8005\u81ea\u5b9a\u4e49\u6d88\u8d39\u7a0b\u5e8f\uff0c\u4f46\u662f\u7531\u4e8e\u539f\u751f Debezium \u4e2d\u7684 Producer \u7aef\u672a\u91c7\u7528\u5e42\u7b49\u7279\u6027\uff0c\u56e0\u6b64\u6d88\u606f\u53ef\u80fd\u5b58\u5728\u91cd\u590d\uff0c\u53e6\u5916 Kafka Sink Connector(\u6bd4\u5982 JDBC Sink Connector \u53ea\u80fd\u4fdd\u8bc1 At least once)\u6216\u8005\u81ea\u5b9a\u4e49\u6d88\u8d39\u7a0b\u5e8f\u5728\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u4e0a\u4e5f\u6709\u96be\u5ea6\u3002</p>\n<h3 id=\"42-debeziumkafkaflink-sql\">4.2 \u65b9\u6848\u4e8c\uff1aDebezium+Kafka+Flink SQL+\u5b58\u50a8\u7cfb\u7edf<a class=\"headerlink\" href=\"#42-debeziumkafkaflink-sql\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u7b2c\u4e8c\u7ae0\u8282\u6211\u4eec\u77e5\u9053 Flink SQL \u5177\u5907\u89e3\u6790 Kafka \u4e2d debezium-json \u548c canal-json \u683c\u5f0f\u7684 Change Log \u80fd\u529b\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u7528\u5982\u4e0b\u540c\u6b65\u67b6\u6784\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/18691008be474b598efa9922dd07bb76.png\" /></p>\n<p>\u4e0e\u65b9\u6848\u4e00\u7684\u533a\u522b\u5c31\u662f\uff0c\u91c7\u7528 Flink \u901a\u8fc7\u521b\u5efa Kafka \u8868\uff0c\u6307\u5b9a format \u683c\u5f0f\u4e3a debezium-json\uff0c\u7136\u540e\u901a\u8fc7 Flink \u8fdb\u884c\u8ba1\u7b97\u540e\u6216\u8005\u76f4\u63a5\u63d2\u5165\u5230\u5176\u4ed6\u5916\u90e8\u6570\u636e\u5b58\u50a8\u7cfb\u7edf\u3002\u65b9\u6848\u4e8c\u548c\u65b9\u6848\u4e00\u7c7b\u4f3c\uff0c\u7ec4\u4ef6\u591a\u7ef4\u62a4\u7e41\u6742\uff0c\u800c\u524d\u8ff0\u6211\u4eec\u77e5\u9053 Flink 1.11 \u4e2d CDC Connectors \u5185\u7f6e\u4e86 Debezium \u5f15\u64ce\uff0c\u53ef\u4ee5\u66ff\u6362 Debezium+Kafka \u65b9\u6848\uff0c\u56e0\u6b64\u6709\u4e86\u66f4\u7b80\u5316\u7684\u65b9\u6848\u4e09\u3002</p>\n<h3 id=\"43-flink-sql-cdc-jdbc-connector\">4.3 \u65b9\u6848\u4e09\uff1aFlink SQL CDC + JDBC Connector<a class=\"headerlink\" href=\"#43-flink-sql-cdc-jdbc-connector\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5c06\u5982\u4e0b\u67b6\u6784\u865a\u7ebf\u90e8\u5206\u7528 Flink SQL \u66ff\u6362\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/6bb5fc35b549487588881803429616eb.png\" /></p>\n<p>\u6211\u4eec\u5f97\u5230\u5982\u4e0b\u6539\u8fdb\u7684\u540c\u6b65\u65b9\u6848\u67b6\u6784\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/63798450202547a8ad3c23c7e80e2299.png\" /></p>\n<p>\u4ece\u5b98\u65b9\u7684\u63cf\u8ff0\u4e2d\uff0c\u901a\u8fc7 Flink CDC connectors \u66ff\u6362 Debezium+Kafka \u7684\u6570\u636e\u91c7\u96c6\u6a21\u5757\uff0c\u5b9e\u73b0 Flink SQL \u91c7\u96c6+\u8ba1\u7b97+\u4f20\u8f93(ETL)\u4e00\u4f53\u5316\uff0c\u4f18\u70b9\u5f88\u591a\uff1a</p>\n<ul>\n<li>\u5f00\u7bb1\u5373\u7528\uff0c\u7b80\u5355\u6613\u4e0a\u624b</li>\n<li>\u51cf\u5c11\u7ef4\u62a4\u7684\u7ec4\u4ef6\uff0c\u7b80\u5316\u5b9e\u65f6\u94fe\u8def\uff0c\u51cf\u8f7b\u90e8\u7f72\u6210\u672c</li>\n<li>\u51cf\u5c0f\u7aef\u5230\u7aef\u5ef6\u8fdf</li>\n<li>Flink \u81ea\u8eab\u652f\u6301 Exactly Once \u7684\u8bfb\u53d6\u548c\u8ba1\u7b97</li>\n<li>\u6570\u636e\u4e0d\u843d\u5730\uff0c\u51cf\u5c11\u5b58\u50a8\u6210\u672c</li>\n<li>\u652f\u6301\u5168\u91cf\u548c\u589e\u91cf\u6d41\u5f0f\u8bfb\u53d6</li>\n<li>binlog \u91c7\u96c6\u4f4d\u70b9\u53ef\u56de\u6eaf</li>\n</ul>\n<h2 id=\"flink-sql-cdc-jdbc-connector\">\u4e94. Flink SQL CDC + JDBC Connector\u540c\u6b65\u65b9\u6848\u9a8c\u8bc1<a class=\"headerlink\" href=\"#flink-sql-cdc-jdbc-connector\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"51\">5.1 \u6d4b\u8bd5\u73af\u5883\u548c\u811a\u672c<a class=\"headerlink\" href=\"#51\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6d4b\u8bd5\u73af\u5883\u6d4b\u8bd5\u573a\u666f \u4f7f\u7528 Flink SQL CDC \u4ece MySQL \u6570\u636e\u5e93\u540c\u6b65\u6570\u636e\u5230\u76ee\u6807 MySQL\uff0cKafka\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>CREATE TABLE sbtest1 (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING\n) WITH (\n  &#39;connector&#39; = &#39;mysql-cdc&#39;,\n  &#39;hostname&#39; = &#39;197.XXX.XXX.XXX&#39;,\n  &#39;port&#39; = &#39;3306&#39;,\n  &#39;username&#39; = &#39;debezium&#39;,\n  &#39;password&#39; = &#39;PASSWORD&#39;,\n  &#39;database-name&#39; = &#39;cdcdb&#39;,\n  &#39;table-name&#39; = &#39;sbtest1&#39;,\n  &#39;debezium.snapshot.mode&#39; = &#39;initial&#39;\n);\n\n\u5230DB\uff1a\ncreate table printSinkTable (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING,\n  primary key (id) NOT ENFORCED\n) with (\n &#39;connector&#39; = &#39;jdbc&#39;,\n &#39;url&#39; = &#39;jdbc:mysql://197.XXX.XXX.XXX:3306/mydb?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=UTC&#39;,\n &#39;username&#39; = &#39;debezium&#39;,\n &#39;password&#39; = &#39;PASSWORD&#39;,\n &#39;table-name&#39; = &#39;sbtest&#39;,\n &#39;driver&#39; = &#39;com.mysql.cj.jdbc.Driver&#39;,\n &#39;sink.buffer-flush.interval&#39; = &#39;3s&#39;,\n &#39;sink.buffer-flush.max-rows&#39; = &#39;1&#39;,\n &#39;sink.max-retries&#39; = &#39;5&#39;);\n INSERT INTO printSinkTable SELECT * FROM sbtest1;\n\n \u5230KAFKA\uff1a\n CREATE TABLE kafka_gmv (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING\n) WITH (\n    &#39;connector&#39; = &#39;kafka-0.11&#39;,\n    &#39;topic&#39; = &#39;kafka_gmv&#39;,\n    &#39;scan.startup.mode&#39; = &#39;earliest-offset&#39;,\n    &#39;properties.bootstrap.servers&#39; = &#39;197.XXX.XXX.XXX:9092&#39;,\n    &#39;format&#39; = &#39;changelog-json&#39;\n);\n\nINSERT INTO kafka_gmv SELECT * FROM sbtest1;\n</code></pre></div>\n<h3 id=\"52\">5.2 \u6d4b\u8bd5\u7ed3\u8bba<a class=\"headerlink\" href=\"#52\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"521\">\u25a0 5.2.1 \u529f\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#521\" title=\"Permanent link\">&para;</a></h4>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/612631b909d543c3a1db24d91a6606bb.png\" /></p>\n<h4 id=\"522\">\u25a0 5.2.2 \u5f02\u5e38\u6d4b\u8bd5<a class=\"headerlink\" href=\"#522\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\u5e38\u89c4\u529f\u80fd\u6d4b\u8bd5</li>\n</ul>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/cd3a771503c046b2890d672fa82f6948.png\" /></p>\n<ul>\n<li>\u57fa\u4e8e DNS \u7684\u6570\u636e\u5e93\u5207\u6362\u6d4b\u8bd5</li>\n</ul>\n<p>\u6d4b\u8bd5\u793a\u610f\u56fe\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/62b06497b8b5458cb8936ce4744a1f3e.png\" /></p>\n<p>\u25cb <strong>Flink \u9700\u8981\u914d\u7f6e\u7684\u53c2\u6570</strong>\uff1a\u4efb\u52a1\u5931\u8d25\u540e\u5ef6\u8fdf 5 \u79d2\u91cd\u542f\uff0c\u91cd\u8bd5 10 \u6b21\u3002restart-strategy: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 5s\u3002\n\u25cb <strong>MySQL \u73af\u5883\u4fe1\u606f</strong>\uff1a\u4e00\u4e3b\u5e93\u4e24\u4e2a\u4ece\u5e93\u3002\n\u25cb <strong>DNS \u914d\u7f6e</strong>\uff1aDNS \u7533\u8bf7\u4e86\u4e00\u4e2a\u57df\u540d\uff1aXX.XX.cmbc.cn \u7b56\u7565\uff1a\u5f53\u524d\u57df\u540d\u6307\u5411\u5176\u4e2d\u4e00\u4e2a\u4ece\u5e93\uff0c\u63a2\u6d4b\u6570\u636e\u5e93\u670d\u52a1\u7aef\u53e3\uff0c\u6bcf\u4e2a 2 \u5206\u949f\u81ea\u52a8\u63a2\u6d4b\u4e00\u6b21\u3002\u5f53\u524d\u6570\u636e\u5e93\u5f02\u5e38\u540e DNS \u4fee\u6539\u6307\u5411\u5230\u7b2c\u4e8c\u4e2a\u4ece\u5e93\u3002\n\u25cb \u64cd\u4f5c\u7cfb\u7edf\u548c <strong>JVM \u7f13\u5b58\u914d\u7f6e</strong>\uff1aJVM \u7f13\u5b58\u914d\u7f6e 30 \u79d2\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58 30 \u79d2\u3002</p>\n<p><strong>\u6d4b\u8bd5\u7ed3\u679c\uff1a</strong></p>\n<ol>\n<li>\u5f53 Flink \u53c2\u6570\u672a\u8bbe\u7f6e\u4e0a\u8ff0\u53c2\u6570\u7684\u60c5\u51b5\u4e0b\uff0ckill \u5f53\u524d\u8bbf\u95ee\u6570\u636e\u5e93\uff0cFlink \u4efb\u52a1\u62a5\u9519\u9000\u51fa\uff0c\u67e5\u770b DNS \u6ca1\u6709\u8bbf\u95ee\u8bb0\u5f55\u3002</li>\n<li>\n<p>Flink \u914d\u7f6e\u4e0a\u8ff0\u53c2\u6570\u540e\uff0cFlink \u540e\u53f0\u5c1d\u8bd5\u8bbf\u95ee\u4e0a\u8ff0\u6570\u636e\u5e93\uff0c\u672c\u5730 DNS \u7f13\u5b58\u5728\u8bbf\u95ee\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u5931\u6548\uff0c\u91cd\u65b0\u8bf7\u6c42 DNS \u57df\u540d\u670d\u52a1\u5668\u83b7\u53d6\u65b0\u6570\u636e\u5e93\u8bbf\u95ee\u4fe1\u606f\uff0c\u4efb\u52a1\u7ee7\u7eed\u590d\u5236\u3002</p>\n</li>\n<li>\n<p>Flink \u9ad8\u53ef\u7528\u6d4b\u8bd5</p>\n</li>\n</ol>\n<p>\u5728 Flink \u9ad8\u53ef\u7528\u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 Standalone \u96c6\u7fa4\u9ad8\u53ef\u7528\u6027\u65b9\u6848\u8fdb\u884c\u6d4b\u8bd5\uff0c\u4e00\u4e2a\u4e3b JobManager\uff0c\u4e00\u4e2a\u4ece JobManager\uff0c\u5f53\u4e3b\u8282\u70b9\u5f02\u5e38\u4e4b\u540e\uff0c\u5907\u9009\u8282\u70b9\u6210\u4e3a\u65b0\u7684 leader\uff0c\u5e76\u63a5\u7ba1 Flink \u96c6\u7fa4\u3002\u65b0 JobManager \u6210\u4e3a\u65b0\u7684 leader \u540e\uff0c\u96c6\u7fa4\u6062\u590d\u6b63\u5e38\uff0c\u5e76\u53ef\u4ee5\u8fdb\u884c\u4efb\u52a1\u7684\u8c03\u5ea6\uff0c\u5f02\u5e38\u7684\u4efb\u52a1\u6062\u590d\u8fd0\u884c\u3002</p>\n<p>\u8fd9\u91cc\u5907\u9009\u548c\u4e3b\u8282\u70b9\u662f\u4e00\u6837\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a JobManager \u90fd\u53ef\u4ee5\u5145\u5f53\u5907\u9009\u548c\u4e3b\u8282\u70b9\u3002\u5b98\u7f51\u7684\u4e0b\u56fe\u5c55\u793a\u4e86\u8fd9\u4e00\u8fc7\u7a0b\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/8f4d1291c7184018a157319b54cf9d78.png\" /></p>\n<p>\u5f02\u5e38\u6d4b\u8bd5\u6b65\u9aa4\u548c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/7f1c8b81302d47d48322edd35293121b.png\" /></p>\n<h4 id=\"523\">\u25a0 5.2.3 \u6027\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#523\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6027\u80fd\u6d4b\u8bd5\u8fdb\u884c\u4e86\u7d2f\u8ba1\u6d4b\u8bd5\uff0c\u7528\u4ee5\u68c0\u6d4b Flink cdc \u7684\u6781\u9650\u6027\u80fd\uff0c\u5206\u522b\u6d4b\u8bd5\u4e86 kafka \u548c MySQL \u4f5c\u4e3a\u76ee\u6807\u7684\u573a\u666f\u3002</p>\n<ul>\n<li>\u6d4b\u8bd5\u63cf\u8ff0</li>\n</ul>\n<p>\u4f7f\u7528 sysbench \u8fdb\u884c\u538b\u6d4b\uff0c\u63d2\u5165 200 \u4f59\u4e07\u6570\u636e\uff0c\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>CREATE TABLE `sbtest1` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n  `k` int(10) unsigned NOT NULL DEFAULT &#39;0&#39;,\n  `c` char(120) NOT NULL DEFAULT &#39;&#39;,\n  `pad` char(60) NOT NULL DEFAULT &#39;&#39;,\n  PRIMARY KEY (`id`),\n  KEY `k_1` (`k`)\n)\uff1b\n</code></pre></div>\n<p>\u7d2f\u8ba1\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/bcb8d5545adb4750b31bf63513fcc7c2.png\" /></p>\n<h2 id=\"flink-sql-cdc-jdbc-connector_1\">\u516d. Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5206\u6790<a class=\"headerlink\" href=\"#flink-sql-cdc-jdbc-connector_1\" title=\"Permanent link\">&para;</a></h2>\n<p>Flink SQL CDC + JDBC Connector \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a Source \u548c Sink \u5e76\u884c\u5ea6\u4e3a 1 \u7684Flink Stream Application\uff0cSource \u548c Sink \u4e4b\u95f4\u65e0 Operator\uff0c\u4e0b\u9762\u6211\u4eec\u9010\u6b65\u5206\u6790 Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027\u3002</p>\n<h4 id=\"61\">6.1 \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5b9e\u73b0\u6761\u4ef6<a class=\"headerlink\" href=\"#61\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e00\u81f4\u6027\u5c31\u662f\u4e1a\u52a1\u6b63\u786e\u6027\uff0c\u5728\u201c\u6d41\u7cfb\u7edf\u4e2d\u95f4\u4ef6\u201d\u8fd9\u4e2a\u4e1a\u52a1\u9886\u57df\uff0c\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5c31\u4ee3\u8868 Exacly Once Msg Processing(\u7b80\u79f0 EOMP)\uff0c\u5373\u4e00\u4e2a\u6d88\u606f\u53ea\u88ab\u5904\u7406\u4e00\u6b21\uff0c\u9020\u6210\u4e00\u6b21\u6548\u679c\u3002\u5373\u4f7f\u673a\u5668\u6216\u8f6f\u4ef6\u51fa\u73b0\u6545\u969c\uff0c\u65e2\u6ca1\u6709\u91cd\u590d\u6570\u636e\uff0c\u4e5f\u4e0d\u4f1a\u4e22\u6570\u636e\u3002</p>\n<p>\u5e42\u7b49\u5c31\u662f\u4e00\u4e2a\u76f8\u540c\u7684\u64cd\u4f5c\uff0c\u65e0\u8bba\u91cd\u590d\u591a\u5c11\u6b21\uff0c\u9020\u6210\u7684\u6548\u679c\u548c\u53ea\u64cd\u4f5c\u4e00\u6b21\u76f8\u7b49\u3002\n\u6d41\u7cfb\u7edf\u7aef\u5230\u7aef\u94fe\u8def\u8f83\u957f\uff0c\u6d89\u53ca\u5230\u4e0a\u6e38 Source \u5c42\u3001\u4e2d\u95f4\u8ba1\u7b97\u5c42\u548c\u4e0b\u6e38 Sink \u5c42\u4e09\u90e8\u5206\uff0c\u8981\u5b9e\u73b0\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\uff0c\u9700\u8981\u5b9e\u73b0\u4ee5\u4e0b\u6761\u4ef6\uff1a</p>\n<ul>\n<li>\u4e0a\u6e38\u53ef\u4ee5 replay\uff0c\u5426\u5219\u4e2d\u95f4\u8ba1\u7b97\u5c42\u6536\u5230\u6d88\u606f\u540e\u672a\u8ba1\u7b97\uff0c\u5374\u53d1\u751f failure \u800c\u91cd\u542f\uff0c\u6d88\u606f\u5c31\u4f1a\u4e22\u5931\u3002</li>\n<li>\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751f failure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751f failure\uff0c\u5c31\u4f1a replay \u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002</li>\n<li>\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751f failure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684 DataStore\u91cc\u3002</li>\n<li>\u4e0b\u6e38\u53bb\u91cd\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</li>\n</ul>\n<p>\u5728 Flink SQL CDC + JDBC Connector \u65b9\u6848\u4e2d\uff0c\u4e0a\u6e38\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u65e5\u5fd7\uff0c\u662f\u53ef\u4ee5 replay \u7684\uff0c\u6ee1\u8db3\u6761\u4ef61\u201c\u4e0a\u6e38\u53ef replay\u201d\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5206\u522b\u5206\u6790 Flink SQL CDC \u5982\u4f55\u5b9e\u73b0\u6761\u4ef6 2 \u548c 3\uff0cJDBCConnector \u5982\u4f55\u5b9e\u73b0\u6761\u4ef6 4\uff0c\u6700\u7ec8\u5b9e\u73b0\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\u3002\u4ee5 MySQL-&gt;MySQL \u4e3a\u4f8b\uff0c\u67b6\u6784\u56fe\u5982\u4e0b\uff08\u76ee\u524d Flink SQL \u662f\u4e0d\u652f\u6301 Source/Sink \u5e76\u884c\u5ea6\u914d\u7f6e\u7684\uff0cFlink SQL \u4e2d\u5404\u7b97\u5b50\u5e76\u884c\u5ea6\u9ed8\u8ba4\u662f\u6839\u636e Source \u7684 Partition \u6570\u6216\u6587\u4ef6\u6570\u6765\u51b3\u5b9a\u7684\uff0c\u800c DebeziumSource \u7684\u5e76\u884c\u5ea6\u662f 1\uff0c\u56e0\u6b64\u6574\u4e2a Flink Task \u7684\u5e76\u884c\u5ea6\u4e3a 1\uff09\uff1a</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/7f9b6b0329124bdabdb63f2a39d49808.png\" /></p>\n<h3 id=\"62-flink-sql-cdc\">6.2 Flink SQL CDC \u7684\u4e00\u81f4\u6027\u4fdd\u8bc1<a class=\"headerlink\" href=\"#62-flink-sql-cdc\" title=\"Permanent link\">&para;</a></h3>\n<p>Flink SQL CDC \u7528\u4e8e\u83b7\u53d6\u6570\u636e\u5e93\u53d8\u66f4\u65e5\u5fd7\u7684 Source \u51fd\u6570\u662f DebeziumSourceFunction\uff0c\u4e14\u6700\u7ec8\u8fd4\u56de\u7684\u7c7b\u578b\u662f RowData\uff0c\u8be5\u51fd\u6570\u5b9e\u73b0\u4e86 CheckpointedFunction\uff0c\u5373\u901a\u8fc7 Checkpoint \u673a\u5236\u6765\u4fdd\u8bc1\u53d1\u751f failure \u65f6\u4e0d\u4f1a\u4e22\u6570\uff0c\u5b9e\u73b0 exactly once \u8bed\u4e49\uff0c\u8fd9\u90e8\u5206\u5728\u51fd\u6570\u7684\u6ce8\u91ca\u4e2d\u6709\u660e\u786e\u7684\u89e3\u91ca\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>/**\n * The {@link DebeziumSourceFunction} is a streaming data source that pulls captured change data\n * from databases into Flink.\n * \u901a\u8fc7Checkpoint\u673a\u5236\u6765\u4fdd\u8bc1\u53d1\u751ffailure\u65f6\u4e0d\u4f1a\u4e22\u6570\uff0c\u5b9e\u73b0exactly once\u8bed\u4e49\n * &lt;p&gt;The source function participates in checkpointing and guarantees that no data is lost\n * during a failure, and that the computation processes elements &quot;exactly once&quot;.\n * \u6ce8\u610f\uff1a\u8fd9\u4e2aSource Function\u4e0d\u80fd\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u5b9e\u4f8b\n * &lt;p&gt;Note: currently, the source function can&#39;t run in multiple parallel instances.\n *\n * &lt;p&gt;Please refer to Debezium&#39;s documentation for the available configuration properties:\n * https://debezium.io/documentation/reference/1.2/development/engine.html#engine-properties&lt;/p&gt;\n */\n@PublicEvolving\npublic class DebeziumSourceFunction&lt;T&gt; extends RichSourceFunction&lt;T&gt; implements\n  CheckpointedFunction,\n  ResultTypeQueryable&lt;T&gt; {\n</code></pre></div>\n<p>\u4e3a\u5b9e\u73b0 CheckpointedFunction\uff0c\u9700\u8981\u5b9e\u73b0\u4ee5\u4e0b\u4e24\u4e2a\u65b9\u6cd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>public interface CheckpointedFunction {\n  //\u505a\u5feb\u7167\uff0c\u628a\u5185\u5b58\u4e2d\u7684\u6570\u636e\u4fdd\u5b58\u5728checkpoint\u72b6\u6001\u4e2d\n  void snapshotState(FunctionSnapshotContext var1) throws Exception;\n\n  //\u7a0b\u5e8f\u5f02\u5e38\u6062\u590d\u540e\u4ececheckpoint\u72b6\u6001\u4e2d\u6062\u590d\u6570\u636e\n  void initializeState(FunctionInitializationContext var1) throws Exception;\n}\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770b DebeziumSourceFunction \u4e2d\u90fd\u8bb0\u5f55\u4e86\u54ea\u4e9b\u72b6\u6001\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>/** Accessor for state in the operator state backend. \n    offsetState\u4e2d\u8bb0\u5f55\u4e86\u8bfb\u53d6\u7684binlog\u6587\u4ef6\u548c\u4f4d\u79fb\u4fe1\u606f\u7b49\uff0c\u5bf9\u5e94Debezium\u4e2d\u7684\n*/\n private transient ListState&lt;byte[]&gt; offsetState;\n\n/**\n * State to store the history records, i.e. schema changes.\n * historyRecordsState\u8bb0\u5f55\u4e86schema\u7684\u53d8\u5316\u7b49\u4fe1\u606f\n * @see FlinkDatabaseHistory\n*/\n private transient ListState&lt;String&gt; historyRecordsState;\n</code></pre></div>\n<p>\u518d\u56de\u5230\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u7684\u6761\u4ef6 2 \u548c 3</p>\n<blockquote>\n<p>2.\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751ffailure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751ffailure\uff0c\u5c31\u4f1areplay\u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002 </p>\n<p>3.\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751ffailure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684DataStore\u91cc\u3002</p>\n</blockquote>\n<p>\u6211\u4eec\u53d1\u73b0\u5728 Flink SQL CDC \u662f\u4e00\u4e2a\u76f8\u5bf9\u7b80\u6613\u7684\u573a\u666f\uff0c\u6ca1\u6709\u4e2d\u95f4\u7b97\u5b50\uff0c\u662f\u901a\u8fc7 Checkpoint \u6301\u4e45\u5316 binglog \u6d88\u8d39\u4f4d\u79fb\u548c schema \u53d8\u5316\u4fe1\u606f\u7684\u5feb\u7167\uff0c\u6765\u5b9e\u73b0 Exactly Once\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5206\u6790 Sink \u7aef\u3002</p>\n<h4 id=\"621-jdbc-sink-connector\">\u25a0 6.2.1 JDBC Sink Connector \u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027<a class=\"headerlink\" href=\"#621-jdbc-sink-connector\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6211\u4eec\u5728\u5b98\u7f51\u4e0a\u53d1\u73b0\u5bf9\u4e8e JDBC Sink Connector \u7684\u5e42\u7b49\u6027\u4e2d\u6709\u5982\u4e0b\u89e3\u91ca\uff1a</p>\n<blockquote>\n<p>\u5982\u679c\u5b9a\u4e49\u4e86\u4e3b\u952e\uff0cJDBC \u5199\u5165\u65f6\u662f\u80fd\u591f\u4fdd\u8bc1 Upsert \u8bed\u4e49\u7684\uff0c \u5982\u679c DB \u4e0d\u652f\u6301 Upsert \u8bed\u6cd5\uff0c\u5219\u4f1a\u9000\u5316\u6210 DELETE + INSERT \u8bed\u4e49\u3002Upsert query \u662f\u539f\u5b50\u6267\u884c\u7684\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5e42\u7b49\u6027\u3002</p>\n</blockquote>\n<p>\u8fd9\u4e2a\u5728\u5b98\u65b9\u6587\u6863\u4e2d\u4e5f\u8be6\u7ec6\u63cf\u8ff0\u4e86\u66f4\u65b0\u5931\u8d25\u6216\u8005\u5b58\u5728\u6545\u969c\u65f6\u5019\u5982\u4f55\u505a\u51fa\u7684\u5904\u7406\uff0c\u4e0b\u9762\u7684\u8868\u683c\u662f\u4e0d\u540c\u7684 DB \u5bf9\u5e94\u4e0d\u540c\u7684 Upsert \u8bed\u6cd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>Database    Upsert Grammar\nMySQL    INSERT .. ON DUPLICATE KEY UPDATE ..\nPostgreSQL    INSERT .. ON CONFLICT .. DO UPDATE SET ..\n</code></pre></div>\n<p>\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5199\u5165\u65f6\u4fdd\u8bc1 Upsert \u8bed\u4e49\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e0b\u6e38 Sink \u7aef\u7684\u5e42\u7b49\u6027\uff0c\u518d Review \u4e00\u6b21\u5230\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5b9e\u73b0\u6761\u4ef6 4\uff0c\u4e0b\u6e38\u53bb\u91cd\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0\u5e42\u7b49\u4ece\u800c\u5b9e\u73b0\u4e0b\u6e38\u7684 Exactly Once \u8bed\u4e49\u3002</p>\n<blockquote>\n<p>4.\u4e0b\u6e38\u53bb\u91cd\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</p>\n</blockquote>\n<h4 id=\"622-flink-sql-cdc-jdbc-sink-connector\">\u25a0 6.2.2 Flink SQL CDC + JDBC Sink Connector \u7ec4\u5408\u540e\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027<a class=\"headerlink\" href=\"#622-flink-sql-cdc-jdbc-sink-connector\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728\u524d\u4e24\u5c0f\u8282\u6211\u4eec\u5206\u6790\u4e86\u7ec4\u4ef6\u5404\u81ea\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027\uff0c\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5206\u6790\u7ec4\u5408\u540e\u5728\u6e90\u5e93\u5f02\u5e38\u3001Flink \u4f5c\u4e1a\u5f02\u5e38\u3001\u76ee\u6807\u5e93\u5f02\u5e38\u4e09\u79cd\u5f02\u5e38\u573a\u666f\u4e0b\u5982\u4f55\u4fdd\u8bc1\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u3002</p>\n<p><img alt=\"image.png\" src=\"https://ucc.alicdn.com/pic/developer-ecology/bce901d1cbed4d3ea955e1ed9c0f545e.png\" /></p>\n<ul>\n<li>Debezium Source \u5bf9 MySQL \u8fdb\u884c Snapshot \u65f6\u53d1\u751f\u5f02\u5e38</li>\n</ul>\n<p>\u5728 Flink Task \u542f\u52a8\u540e\uff0c\u9996\u5148\u4f1a\u8fdb\u884c MySQL \u5168\u8868\u626b\u63cf\uff0c\u4e5f\u5c31\u662f\u505a Snapshot\uff0c\u8fd9\u91cc\u6709\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u5c31\u662f\uff0c\u5728 Snapshot \u9636\u6bb5\uff0c\u5728\u626b\u63cf\u5168\u8868\u6570\u636e\u65f6\uff0c\u6ca1\u6709\u53ef\u7528\u4e8e\u6062\u590d\u7684\u4f4d\u70b9\uff0c\u6240\u4ee5\u65e0\u6cd5\u5728\u5168\u8868\u626b\u63cf\u9636\u6bb5\u53bb\u6267\u884c Checkpoint\u3002\u4e3a\u4e86\u4e0d\u6267\u884c Checkpoint\uff0cMySQL \u7684 CDC \u6e90\u8868\u4f1a\u8ba9\u6267\u884c\u4e2d\u7684 Checkpoint \u4e00\u76f4\u7b49\u5f85\uff08\u901a\u8fc7\u6301\u6709 checkpoint \u9501\u5b9e\u73b0\uff09\uff0c\u751a\u81f3 Checkpoint \u8d85\u65f6\uff08\u5982\u679c\u8868\u8d85\u7ea7\u5927\uff0c\u626b\u63cf\u8017\u65f6\u975e\u5e38\u957f\uff09\u3002\u8fd9\u5757\u53ef\u4ee5\u4ece DebeziumChangeConsumer \u7684\u4ee3\u7801\u4e2d\u770b\u5230\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>@Override\n public void handleBatch(\n   List&lt;ChangeEvent&lt;SourceRecord, SourceRecord&gt;&gt; changeEvents,\n   DebeziumEngine.RecordCommitter&lt;ChangeEvent&lt;SourceRecord, SourceRecord&gt;&gt; committer) throws InterruptedException {\n  try {\n   for (ChangeEvent&lt;SourceRecord, SourceRecord&gt; event : changeEvents) {\n    SourceRecord record = event.value();\n    deserialization.deserialize(record, debeziumCollector);\n\n    if (isInDbSnapshotPhase) {\n     if (!lockHold) {\n      MemoryUtils.UNSAFE.monitorEnter(checkpointLock);\n      lockHold = true;\n            //\u5728snapshot\u9636\u6bb5\u4e0d\u505acheckpoint\n      LOG.info(&quot;Database snapshot phase can&#39;t perform checkpoint, acquired Checkpoint lock.&quot;);\n     }\n     if (!isSnapshotRecord(record)) {\n      MemoryUtils.UNSAFE.monitorExit(checkpointLock);\n      isInDbSnapshotPhase = false;\n      LOG.info(&quot;Received record from streaming binlog phase, released checkpoint lock.&quot;);\n     }\n    }\n\n    // emit the actual records. this also updates offset state atomically\n    emitRecordsUnderCheckpointLock(debeziumCollector.records, record.sourcePartition(), record.sourceOffset());\n   }\n      ...\n</code></pre></div>\n<p>\u5728\u505a Snapshot \u9636\u6bb5\uff0c\u53ef\u80fd\u4f1a\u78b0\u5230\u6e90\u5e93 MySQL \u5f02\u5e38\u6216\u8005 Flink \u4efb\u52a1\u672c\u8eab\u5f02\u5e38\uff0c\u90a3\u6211\u4eec\u5206\u522b\u5206\u6790\u4e0b\u5f02\u5e38\u540e\u5982\u4f55\u6062\u590d\uff1a</p>\n<ol>\n<li><strong>\u82e5\u9047\u5230\u6e90\u5e93 MySQL \u5f02\u5e38</strong>\uff0cFlink Task \u53d1\u73b0\u65e0\u6cd5\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u9000\u51fa\uff0c\u91cd\u65b0\u542f\u52a8 Flink Task\uff08\u6216\u8005 retry\uff09\uff0c\u56e0\u4e3a\u6ca1\u6709\u505a snapshot \u6ca1\u505a checkpoint\uff0c\u90a3\u4e48\u4f1a\u91cd\u65b0\u518d\u505a\u4e00\u6b21 Snapshot\uff0c\u8fd9\u4e9b\u5168\u91cf\u6570\u636e\u6700\u540e\u53d1\u9001\u5230\u76ee\u7684 MySQL\uff0c\u7531\u4e8e\u4e0b\u6e38 MySQL \u5b9e\u73b0\u4e86\u5199\u5e42\u7b49\uff0c\u56e0\u6b64\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li>\n<li><strong>\u82e5\u9047\u5230 Flink \u4efb\u52a1\u5f02\u5e38</strong>\uff0c\u91cd\u65b0\u542f\u52a8\uff08\u6216\u8005 retry\uff09\uff0c\u540c\u4e0a\u9762\u60c5\u51b5\u4e00\u6837\uff0c\u91cd\u65b0\u505a\u4e00\u6b21 Snapshot\uff0c\u6700\u7ec8\u4e5f\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li>\n<li>\n<p><strong>\u82e5\u9047\u5230\u76ee\u6807\u5e93 MySQL \u5f02\u5e38</strong>\uff0c\u540c\u573a\u666f\u4e00\u4e00\u81f4\uff0cFlink Task \u65e0\u6cd5\u5f80\u76ee\u6807\u6570\u636e\u5e93\u5199\u5165\u5f02\u5e38\u9000\u51fa\uff0c\u5728\u9700\u8981\u91cd\u65b0\u542f\u52a8\u6216 retry \u540e\uff0c\u91cd\u65b0\u505a\u4e00\u6b21 Snapshot\uff0c\u5168\u91cf\u6570\u636e\u6700\u540e\u53d1\u9001\u5230\u76ee\u7684 MySQL\uff0c\u7531\u4e8e\u76ee\u7684\u4e0b\u6e38 M \u6709 SQL \u5b9e\u73b0\u4e86\u5199\u5e42\u7b49\uff0c\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</p>\n</li>\n<li>\n<p>Snapshot \u5b8c\u6210\u540e\u8bfb\u53d6 binlog \u65f6\u53d1\u751f\u5f02\u5e38</p>\n</li>\n</ol>\n<p>\u5728\u5168\u91cf\u6570\u636e\u5b8c\u6210\u540c\u6b65\u540e\uff0c\u5f00\u59cb\u8fdb\u884c\u589e\u91cf\u83b7\u53d6\uff0c\u6b64\u65f6 Flink \u4f1a\u8fdb\u884c\u5b9a\u65f6 Checkpoint\uff0c\u5c06\u8bfb\u53d6 binlog \u7684\u4f4d\u79fb\u4fe1\u606f\u548c schema \u4fe1\u606f\u5b58\u5165\u5230 StateBackend\uff0c\u82e5\u6b64\u65f6\u53d1\u751f\u5f02\u5e38\uff0c\u90a3\u6211\u4eec\u5206\u6790\u4e0b\u5f02\u5e38\u540e\u5982\u4f55\u6062\u590d\uff1a</p>\n<ol>\n<li><strong>\u82e5\u6e90 MySQL \u5f02\u5e38</strong>\uff0cFlink Task \u53d1\u73b0\u65e0\u6cd5\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u9000\u51fa\uff0c\u91cd\u65b0\u542f\u52a8 Flink Task\uff08\u6216\u8005 retry\uff09\uff0c\u5c06\u4f1a\u4ece\u6700\u8fd1\u4e00\u6b21 Checkpoint \u7684\u6570\u636e\u8fdb\u884c\u6062\u590d\uff0c\u7531\u4e8e\u53ef\u4ee5\u8bfb\u53d6\u5230 mysql binlog \u4f4d\u79fb\u4fe1\u606f\uff0c\u5b9e\u73b0\u7ee7\u7eed\u540c\u6b65\uff0c\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u6700\u7ec8\u4e5f\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li>\n<li><strong>\u82e5 Flink \u4efb\u52a1\u5f02\u5e38</strong>\uff0c\u91cd\u65b0\u542f\u52a8\u6216 retry \u540e\uff0c\u540c\u573a\u666f 1 \u4e00\u81f4\uff0c\u7ee7\u7eed\u8bfb\u53d6 binlog\uff0c\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li>\n<li><strong>\u82e5\u76ee\u7684 MySQL \u5f02\u5e38</strong>\uff0cjdbc connector \u65e0\u6cd5\u5f80\u76ee\u6807\u6570\u636e\u5e93\u5199\u5165\uff0ccdc connector \u8bfb\u53d6\u5230\u7684 binlog \u4f4d\u79fb\u4fe1\u606f\u4e5f\u4e0d\u518d\u66f4\u65b0\uff0c\u4e24\u4e2a\u64cd\u4f5c\u662f\u4e00\u4e2a\u539f\u5b50\u6027\u64cd\u4f5c\uff0c\u5728 Flink Task \u6062\u590d\u540e\uff0c\u4ece\u6700\u8fd1\u4e00\u6b21 Checkpoint \u8fdb\u884c\u6062\u590d\uff0c\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li>\n</ol>\n<h3 id=\"63\">6.3 \u603b\u7ed3<a class=\"headerlink\" href=\"#63\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u9700\u8981\u5404\u4e2a\u7ec4\u4ef6\u53c2\u4e0e\u5b9e\u73b0\uff0cFlink SQL CDC + JDBC Connector \u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u6cd5\u4fdd\u8bc1\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\uff1a</p>\n<ul>\n<li>\u6e90\u7aef\u662f\u6570\u636e\u5e93\u7684 binlog \u65e5\u5fd7\uff0c\u5168\u91cf\u540c\u6b65\u505a Snapshot \u5f02\u5e38\u540e\u53ef\u4ee5\u518d\u6b21\u505a Snapshot\uff0c\u589e\u91cf\u540c\u6b65\u65f6\uff0cFlink SQL CDC \u4e2d\u4f1a\u8bb0\u5f55\u8bfb\u53d6\u7684\u65e5\u5fd7\u4f4d\u79fb\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5 replay</li>\n<li>Flink SQL CDC \u4f5c\u4e3a Source \u7ec4\u4ef6\uff0c\u662f\u901a\u8fc7 Flink Checkpoint \u673a\u5236\uff0c\u5468\u671f\u6027\u6301\u4e45\u5316\u5b58\u50a8\u6570\u636e\u5e93\u65e5\u5fd7\u6587\u4ef6\u6d88\u8d39\u4f4d\u79fb\u548c\u72b6\u6001\u7b49\u4fe1\u606f\uff08StateBackend \u5c06 checkpoint \u6301\u4e45\u5316\uff09\uff0c\u8bb0\u5f55\u6d88\u8d39\u4f4d\u79fb\u548c\u5199\u5165\u76ee\u6807\u5e93\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u4fdd\u8bc1\u53d1\u751f failure \u65f6\u4e0d\u4e22\u6570\u636e\uff0c\u5b9e\u73b0 Exactly Once</li>\n<li>JDBC Sink Connecotr \u662f\u901a\u8fc7\u5199\u5165\u65f6\u4fdd\u8bc1 Upsert \u8bed\u4e49\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e0b\u6e38\u7684\u5199\u5165\u5e42\u7b49\u6027\uff0c\u5b9e\u73b0 Exactly Once</li>\n</ul>\n<p>\u518d\u6765\u56de\u987e\u4e00\u4e0b\u7aef\u5230\u7aef\u4fdd\u6301\u4e00\u81f4\u6027\u7684\u6761\u4ef6\uff0c\u53d1\u73b0\u5168\u90fd\u80fd\u6ee1\u8db3\u3002</p>\n<p>1.<strong>\u4e0a\u6e38\u53ef\u4ee5 replay</strong>\uff0c\u5426\u5219\u4e2d\u95f4\u8ba1\u7b97\u5c42\u6536\u5230\u6d88\u606f\u540e\u672a\u8ba1\u7b97\uff0c\u5374\u53d1\u751f failure \u800c\u91cd\u542f\uff0c\u6d88\u606f\u5c31\u4f1a\u4e22\u5931\u3002</p>\n<p>2.<strong>\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6</strong>\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751f failure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751f failure\uff0c\u5c31\u4f1a replay \u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002</p>\n<p>3.<strong>\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528</strong>\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751f failure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684 DataStore \u91cc\u3002</p>\n<p>4.<strong>\u4e0b\u6e38\u53bb\u91cd</strong>\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</p>\n<h2 id=\"flink-sql-cdc_1\">\u4e03. Flink SQL CDC \u76ee\u524d\u5b58\u5728\u7684\u7f3a\u9677<a class=\"headerlink\" href=\"#flink-sql-cdc_1\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>\u4f7f\u7528\u6b63\u5219\u5339\u914d\u539f\u8868\u540e\uff08\u591a\u4e2a\u6e90\u7aef\u8868\uff09\uff0c\u5230\u76ee\u6807\u8868\u65e0\u6cd5\u8fdb\u884c\u4e00\u5bf9\u4e00\u7684\u6620\u5c04\u3002\u9700\u8981\u9010\u4e2a\u5339\u914d\u3002</li>\n<li>CDC source \u7aef\u5b9a\u4e49\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u6240\u6709\u5b57\u6bb5\uff0c\u76ee\u524d\u4e0d\u652f\u6301\u7701\u7565\u5b57\u6bb5\u5b9a\u4e49\u3002</li>\n<li>CDC \u5230 KAFKA \u65f6\u65e0\u6cd5\u6309\u7167\u4e3b\u952e\u8fdb\u884c\u81ea\u52a8\u5206\u533a\u5206\u53d1\u3001\u65e0\u6cd5\u6307\u5b9a\u5206\u533a\u952e\u5206\u53d1\u6570\u636e\u3002\u5230 KAFKA \u7684\u6570\u636e\u683c\u5f0f\u6307\u5b9a\uff08JSON\uff0cAVRO JSON\u7b49\uff09\u3002</li>\n<li>\u76ee\u6807\u7aef\u652f\u6301\u9700\u6c42\uff1aDB2\u3001ADB/GreenPlum\u3001Oracle \u6682\u4e0d\u652f\u6301\u3002\u4e0d\u652f\u6301 DDL\u540c\u6b65\uff0c\u4e0d\u652f\u6301\u8868\u7684\u521b\u5efa\u3002</li>\n<li>\u4efb\u52a1\u7ba1\u7406\u548c\u76d1\u63a7\u7684 REST API \u4e0d\u5b8c\u5584\u3002</li>\n</ul>\n<p>\u53c2\u8003\u8d44\u6599\uff1a</p>\n<p>\u7aef\u5230\u7aef\u4e00\u81f4\u6027\uff0c\u6d41\u7cfb\u7edf Spark/Flink/Kafka/DataFlow \u5bf9\u6bd4\u603b\u7ed3<a href=\"https://zhuanlan.zhihu.com/p/77677075\">https://zhuanlan.zhihu.com/p/77677075</a>\n\u57fa\u4e8e Flink SQL CDC \u7684\u5b9e\u65f6\u6570\u636e\u540c\u6b65\u65b9\u6848<a href=\"https://developer.aliyun.com/article/777502\">https://developer.aliyun.com/article/777502</a>\nFlink SQL 1.11 \u65b0\u529f\u80fd\u4e0e\u6700\u4f73\u5b9e\u8df5<a href=\"https://developer.aliyun.com/article/771773\">https://developer.aliyun.com/article/771773</a>\n\u5206\u5e03\u5f0f\u5feb\u7167\u7b97\u6cd5\n<a href=\"https://zhuanlan.zhihu.com/p/53482103\">https://zhuanlan.zhihu.com/p/53482103</a></p>\n<p>\u4f5c\u8005\u4ecb\u7ecd\uff1a</p>\n<p>\u6587\u4e54\uff1a2012 \u5e74\u7855\u58eb\u6bd5\u4e1a\u540e\u52a0\u5165\u6c11\u751f\u94f6\u884c\u751f\u4ea7\u8fd0\u8425\u90e8\u7cfb\u7edf\u7ba1\u7406\u4e2d\u5fc3\uff0c\u5929\u773c\u65e5\u5fd7\u5e73\u53f0\u4e3b\u8981\u53c2\u4e0e\u4eba\uff0c\u76ee\u524d\u5728\u5f00\u6e90\u5de5\u5177\u7ec4\u8d1f\u8d23 Flume\u3001Kafka \u7684\u6e90\u7801\u7814\u7a76\u548c\u5de5\u5177\u5f00\u53d1\u7b49\u76f8\u5173\u5de5\u4f5c\u3002</p>\n<p>\u738b\u5065\uff1a2011 \u5e74\u52a0\u5165\u6c11\u751f\u94f6\u884c\u79d1\u6280\u90e8\uff0c\u6570\u636e\u5e93\u7ba1\u7406\u5458\uff08\u8d1f\u8d23 DB2\uff0cOracle\uff0cMySQL \u7b49\u8fd0\u7ef4\u5de5\u4f5c\uff0c\u5bf9 MPP \u7b49\u6570\u636e\u5e93\u6709\u5f88\u957f\u7684\u7ef4\u62a4\u548c\u5b9e\u65bd\u7ecf\u9a8c\uff0c\u64c5\u957f\u6570\u636e\u8fc1\u79fb\u7b49\u7b49\uff09\uff0c\u540c\u65f6\u8d1f\u8d23\u884c\u5185 KAFKA \u96c6\u7fa4\u8fd0\u7ef4\u548c\u5b9e\u65bd\u5de5\u4f5c\uff0c\u8d1f\u8d23\u884c\u5185\u6570\u636e\u5e93\u5b9e\u65f6\u590d\u5236\u7b49\u5de5\u4f5c\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["cdc", "flink"]}, {"id": "https://wgzhao.github.io/notes/bigdata/integrating-hive-with-spark/", "url": "https://wgzhao.github.io/notes/bigdata/integrating-hive-with-spark/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Integrating Apache Hive with Apache Spark", "content_html": "<h1 id=\"integrating-apache-hive-with-apache-spark-hwar\">Integrating Apache Hive with Apache Spark - HWAR<a class=\"headerlink\" href=\"#integrating-apache-hive-with-apache-spark-hwar\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"https://community.hortonworks.com/content/kbentry/223626/integrating-apache-hive-with-apache-spark-hive-war.html\" title=\"Permalink to Integrating Apache Hive with Apache Spark - Hive Warehouse Connector - Hortonworks\">Source</a></p>\n<h4 id=\"article\">Article<a class=\"headerlink\" href=\"#article\" title=\"Permanent link\">&para;</a></h4>\n<p><strong>Short Description</strong>: This article targets to describe and demonstrate Apache Hive Warehouse Connector which is a newer generation to read and write data between Apache Spark and Apache Hive.</p>\n<h2 id=\"1-motivation\">1. Motivation<a class=\"headerlink\" href=\"#1-motivation\" title=\"Permanent link\">&para;</a></h2>\n<p>Apache Spark and Apache Hive integration has always been an important use case and continues to be so. Both provide their own efficient ways to process data by the use of SQL, and is used for data stored in distributed file systems. Both provide compatibilities for each other. As both systems evolve, it is critical to find a solution that provides the best of both worlds for data processing needs.</p>\n<p>In case of Apache Spark, it provides <a href=\"https://spark.apache.org/docs/latest/sql-programming-guide.html#compatibility-with-apache-hive\">a basic Hive compatibility</a>. It allows an access to tables in Apache Hive and some basic use cases can be achieved by this. However, not all the modern features from Apache Hive are supported, for instance, <a href=\"https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions\">ACID</a> table in Apache Hive, <a href=\"https://community.hortonworks.com/articles/148917/orc-improvements-for-apache-spark-22.html\">Ranger integration</a>, <a href=\"https://cwiki.apache.org/confluence/display/Hive/LLAP\">Live Long And Process (LLAP)</a>, etc. as of Spark 2.</p>\n<p>Apache Spark supports a pluggable approach for various data sources and Apache Hive itself can be also considered as one data source. Therefore, this library, Hive Warehouse Connector, was implemented as a data source to overcome the limitations and provide those modern functionalities in Apache Hive to Apache Spark users.</p>\n<p><strong>Note</strong>: From HDP 3.0, catalogs for Apache Hive and Apache Spark are separated, and they use their own catalog; namely, they are mutually exclusive - Apache Hive catalog can only be accessed by Apache Hive or this library, and Apache Spark catalog can only be accessed by existing APIs in Apache Spark . In other words, some features such as ACID tables or Apache Ranger with Apache Hive table are only available via this library in Apache Spark. Those tables in Hive should not directly be accessible within Apache Spark APIs themselves.</p>\n<h2 id=\"2-introduction\">2. Introduction<a class=\"headerlink\" href=\"#2-introduction\" title=\"Permanent link\">&para;</a></h2>\n<p>This library provides both Scala (Java compatible) and Python APIs for:</p>\n<ul>\n<li>SQL / DataFrame APIs interacting with both transactional and non-transactional tables in Apache Hive</li>\n<li>SQL / DataFrame read support</li>\n<li>SQL / DataFrame and Structured Streaming write support</li>\n</ul>\n<h3 id=\"21-sql-dataframe-read-support\">2.1. SQL / DataFrame Read Support<a class=\"headerlink\" href=\"#21-sql-dataframe-read-support\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://cwiki.apache.org/confluence/display/Hive/LLAP\">Live Long And Process (LLAP)</a> is fully utilized which Apache Hive introduced for faster performance</li>\n<li>Apache Spark's <a href=\"https://issues.apache.org/jira/browse/SPARK-21187\">Apache Arrow integration</a> is fully utilized for vectorized operations, faster and compact data interactions</li>\n<li>It is implemented by <a href=\"https://issues.apache.org/jira/browse/SPARK-15689\">Data Source V2</a> which has a columnar format support and various functionalities</li>\n</ul>\n<p><img alt=\"\" src=\"https://lh4.googleusercontent.com/-SNAWFl3QqG0xtYidk6ByT_hi6r7ypH4Z8OyFL4592yDfD6TU6_0kfFxmoKfyb_Sb5NT3x2zvSOVlYW3cvdUCaVnJ2xICMhUKa7ohzY0-KszX2H-Qjr6UvuIMxGyMpbs2q3S_uAT\" /></p>\n<p><strong>Note:</strong> This diagram shows read execution path to illustrate the key points.</p>\n<p>For instance, it is able to read an Apache Hive table in Apache Spark as below:</p>\n<div class=\"highlight\"><pre><span></span><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\nval df = hive.executeQuery(&quot;SELECT * FROM tableA&quot;)\n</code></pre></div>\n<p>It leverages Apache Hive LLAP and retrieves data from Hive table into Spark DataFrame.</p>\n<h3 id=\"22-sql-dataframe-structured-streaming-write-support\">2.2. SQL / DataFrame &amp; Structured Streaming Write Support<a class=\"headerlink\" href=\"#22-sql-dataframe-structured-streaming-write-support\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://cwiki.apache.org/confluence/display/Hive/Streaming+Data+Ingest+V2\">Hive Streaming API</a> is used in both batch and streaming write, which Apache Hive introduced to continuously digest data.</li>\n<li>Since it is implemented by <a href=\"https://issues.apache.org/jira/browse/SPARK-15689\">Data Source V2</a>, it supports a commit protocol and supports atomic write operation.</li>\n<li>Native Apache ORC writer is used instead, which has many important fixes in terms of performance and stability.</li>\n</ul>\n<p>The code below illustrate writing data from Apache Spark to Apache Hive table in Structured Streaming.</p>\n<div class=\"highlight\"><pre><span></span><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\ndf.writeStream\n  .format(HiveWarehouseSession.STREAM_TO_STREAM)\n  .option(&quot;table&quot;, &quot;hwx_table&quot;).start()\n</code></pre></div>\n<p>Internally this fully utilizes Apache Hive\u2019s Streaming API to write Apache\u2019s DataFrame out to Apache Hive\u2019s table.</p>\n<p>** Note**: This does not need Hive LLAP daemons to be running.</p>\n<h2 id=\"3-prerequisites\">3. Prerequisites<a class=\"headerlink\" href=\"#3-prerequisites\" title=\"Permanent link\">&para;</a></h2>\n<p>In Apache Hive:</p>\n<ul>\n<li>\u2018Interactive Query' (LLAP) should be enabled (see <strong>7. Appendix</strong> for Apache Ambari UI)</li>\n</ul>\n<p>In Apache Spark:</p>\n<ul>\n<li><code>spark.hadoop.hive.llap.daemon.service.hosts</code> should be set for the application name of the LLAP service since this library utilizes LLAP. For example, <code>@llap0</code>.</li>\n<li>HiveServer2's JDBC URL should be specified in <code>spark.sql.hive.hiveserver2.jdbc.url</code> as well as configured in the cluster. For example, <code>jdbc:hive2://localhost:10000</code>. Use the HiveServer2 Interactive JDBC URL, rather than the traditional HiveServer2's JDBC URL.</li>\n<li>Make sure <code>spark.datasource.hive.warehouse.load.staging.dir</code> is pointed into a suitable HDFS-compatible staging directory, e.g. <code>/tmp</code>.</li>\n<li>Also, ensure <code>spark.datasource.hive.warehouse.metastoreUri</code> is configured properly. For example, <code>thrift://localhost:9083</code> to indicate Metastore URI.</li>\n<li>Note that <code>spark.security.credentials.hiveserver2.enabled</code> should be set to <code>false</code> for YARN client deploy mode, and <code>true</code> for YARN cluster deploy mode (by default). This configuration is required for a Kerberized cluster.</li>\n<li>When <code>spark.security.credentials.hiveserver2.enabled</code> is set to <code>false</code>, <code>spark.sql.hive.hiveserver2.jdbc.url.principal</code> can be optionally set if <code>spark.sql.hive.hiveserver2.jdbc.url</code> does not contain <code>principal</code>, for example, <code>hive/_HOST@EXAMPLE.COM</code>.</li>\n<li>When <code>spark.security.credentials.hiveserver2.enabled</code> is set to <code>true</code>, <code>spark.sql.hive.hiveserver2.jdbc.url.principal</code> should be set, for example, <code>hive/_HOST@EXAMPLE.COM</code>. Also, <code>spark.sql.hive.hiveserver2.jdbc.url</code> should not contain <code>principal</code>.</li>\n</ul>\n<h2 id=\"4-user-scenarios\">4. User Scenarios<a class=\"headerlink\" href=\"#4-user-scenarios\" title=\"Permanent link\">&para;</a></h2>\n<p>In this chapter, HDP 3.0.1.0 with Spark2, Hive and Ranger on a Kerberized cluster is used. Note that If you are running the examples on Kerberized cluster, for instance in HDP, make sure to obtain (or renew) the Kerberos ticket-granting ticket by kinit with an appropriate keytab.</p>\n<p>The following scenarios are run by Spark shell as below. For other interaction paradigms, like spark-submit, Livy, Zeppelin etc. please see the subsequent sections for specific setup steps.</p>\n<p>In case of Scala:</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<p>In case of Python:</p>\n<div class=\"highlight\"><pre><span></span><code>$ pyspark --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<h3 id=\"41-sql-dataframe-read\">4.1. SQL / DataFrame Read<a class=\"headerlink\" href=\"#41-sql-dataframe-read\" title=\"Permanent link\">&para;</a></h3>\n<p>This scenario targets to demonstrate a bulk read operation, as a batch job, from Hive table to Spark DataFrame with SQL expression. For this scenario, data from FBI crime rate is used (see <strong>7. Appendix</strong> for <code>SQL INSERT</code> queries).</p>\n<p>Before we start, we should initialize <code>HiveWarehouseSession</code> instance.</p>\n<p>In case of Scala:</p>\n<div class=\"highlight\"><pre><span></span><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\n</code></pre></div>\n<p>In case of Python:</p>\n<div class=\"highlight\"><pre><span></span><code>from pyspark_llap.sql.session import HiveWarehouseSession\nhive = HiveWarehouseSession.session(spark).build()\n</code></pre></div>\n<p>In this scenarios, it uses hwc_db database. The code below shows the decreasing crime rate (per 100,000 Inhabitants) between 2000 and 2010 in USA:</p>\n<div class=\"highlight\"><pre><span></span><code>hive.setDatabase(&quot;hwc_db&quot;)\nhive.table(&quot;crimes&quot;).filter(&quot;year = 2000 OR year = 2010&quot;).show()\n+----+----------+\n|year|crime_rate|\n+----+----------+\n|2010|     404.5|\n|2000|     506.5|\n+----+----------+\n</code></pre></div>\n<p>SQL queries can be also directly executed via executeQuery API, which directly interacts with Hive LLAP daemons.</p>\n<div class=\"highlight\"><pre><span></span><code>hive.executeQuery(&quot;SELECT avg(crime_rate) AS average_crime_rate FROM crimes&quot;).show()\n+------------------+\n|average_crime_rate|\n+------------------+\n|456.33500000000004|\n+------------------+\n</code></pre></div>\n<h3 id=\"42-sql-dataframe-read-apache-ranger-integration\">4.2. SQL / DataFrame Read (Apache Ranger Integration)<a class=\"headerlink\" href=\"#42-sql-dataframe-read-apache-ranger-integration\" title=\"Permanent link\">&para;</a></h3>\n<p>As of HDP 2.6, Row/Column Level Access Control for Apache Spark is available that enables fine grained security control leveraged by Apache Ranger. This feature can also be leveraged by this library - Apache Spark APIs do not support this.</p>\n<p>For instance, the scenarios below demonstrate row level control with users, <code>billing</code>, and <code>datascience</code>. <code>billing</code> principal can access all rows and columns while <code>datascience</code> principal can access some of filtered and masked data.</p>\n<p>Firstly, we destroy existing ticket and obtains a ticket as <code>billing</code> principal. Then, it executes a Spark shell.</p>\n<div class=\"highlight\"><pre><span></span><code>$ kdestroy\n$ kinit billing/billing@EXAMPLE.COM\n$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<p>Since <code>billing</code> principal can access every row, it shows all data as are.</p>\n<div class=\"highlight\"><pre><span></span><code>sql(&quot;select * from db_spark.t_spark&quot;).show()\n+------+-------+\n|fruits|  color|\n+------+-------+\n| apple|    red|\n| grape| purple|\n|orange|scarlet|\n+------+-------+\n</code></pre></div>\n<p>Now, we try the same query as <code>datascience</code>, principal.</p>\n<div class=\"highlight\"><pre><span></span><code>$ kdestroy\n$ kinit datascience/datascience@EXAMPLE.COM\n$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<p>Since <code>datascience</code>, principal can only access to filtered and masked rows, it only shows partial values.</p>\n<div class=\"highlight\"><pre><span></span><code>sql(&quot;select * from db_spark.t_spark&quot;).show()\n+------+-----+\n|fruits|color|\n+------+-----+\n| apxxx|  red|\n+------+-----+\n</code></pre></div>\n<p>For more information, please see 'Introducing Row/ Column Level Access Control for Apache Spark' in <strong>7. Appendix</strong>. The Ranger security features previously available in the spark-llap connector are now covered by the Hive Warehouse Connector. Apache Hive and Apache Spark configurations should be followed as described in <strong>3. Prerequisites</strong>.</p>\n<h3 id=\"43-sql-dataframe-write\">4.3. SQL / DataFrame Write<a class=\"headerlink\" href=\"#43-sql-dataframe-write\" title=\"Permanent link\">&para;</a></h3>\n<p>This scenario targets to demonstrate a bulk write operation, as a batch job, between Apache Hive table and Apache Spark DataFrame with SQL expression.</p>\n<p>A table in Hive can be created as below:</p>\n<div class=\"highlight\"><pre><span></span><code>hive.createTable(&quot;crimes_2010&quot;)\n  .column(&quot;year&quot;, &quot;int&quot;)\n  .column(&quot;crime_rate&quot;, &quot;double&quot;)\n  .create()\n</code></pre></div>\n<p>Here, crimes table (from <strong>4.1 SQL / DataFrame Read</strong>) is written into a different Hive table after filtering the data in Spark. The code below writes the crime rate at 2010 into the table created above:</p>\n<div class=\"highlight\"><pre><span></span><code>hive.table(&quot;crimes&quot;).filter(&quot;year = 2010&quot;)\n  .write\n  .format(HiveWarehouseSession.HIVE_WAREHOUSE_CONNECTOR)\n  .option(&quot;table&quot;, &quot;crimes_2010&quot;)\n  .save()\n</code></pre></div>\n<p>The data can also be written in a stream manner as below:</p>\n<div class=\"highlight\"><pre><span></span><code>hive.table(&quot;crimes&quot;).filter(&quot;year = 2010&quot;)\n  .write\n  .format(HiveWarehouseSession.DATAFRAME_TO_STREAM)\n  .option(&quot;table&quot;, &quot;crimes_2010&quot;)\n  .save()\n</code></pre></div>\n<p><strong>Note</strong>: In this API, the job at Apache Spark side is a batch write job but it writes out data internally by Apache Hive Streaming API.</p>\n<p>Of course, we can write data from Apache Hive table via Apache Spark data sources:</p>\n<div class=\"highlight\"><pre><span></span><code>hive.table(&quot;crimes&quot;)\n  .write\n  .format(&quot;csv&quot;)\n  .option(&quot;header&quot;, &quot;true&quot;)\n  .save(&quot;/tmp/zoo&quot;)\n</code></pre></div>\n<p>Likewise, Apache Spark DataFrame can directly write out to Apache Hive table as well:</p>\n<div class=\"highlight\"><pre><span></span><code>spark.read.format(&quot;csv&quot;).option(&quot;inferSchema&quot;, &quot;true&quot;).option(&quot;header&quot;, &quot;true&quot;).load(&quot;/tmp/zoo&quot;)\n  .filter(&quot;year = 2010&quot;)\n  .write\n  .format(HiveWarehouseSession.HIVE_WAREHOUSE_CONNECTOR)\n  .option(&quot;table&quot;, &quot;crimes_2010&quot;)\n  .save()\n</code></pre></div>\n<h3 id=\"44-structured-streaming-write\">4.4. Structured Streaming Write<a class=\"headerlink\" href=\"#44-structured-streaming-write\" title=\"Permanent link\">&para;</a></h3>\n<p>This scenario demonstrates a streaming write operation, as a micro batch job, from Apache Spark DataFrame to Apache Hive table with SQL expression.</p>\n<p>In this scenario, socket structured streaming is used as test data.</p>\n<p>In case of Scala:</p>\n<div class=\"highlight\"><pre><span></span><code>val lines = spark.readStream\n  .format(&quot;socket&quot;)\n  .option(&quot;host&quot;, &quot;localhost&quot;)\n  .option(&quot;port&quot;, 9999)  .load()\n</code></pre></div>\n<p>In case of Python:</p>\n<div class=\"highlight\"><pre><span></span><code>lines = spark.readStream \\\n  .format(&quot;socket&quot;) \\\n  .option(&quot;host&quot;, &quot;localhost&quot;) \\\n  .option(&quot;port&quot;, 9999) \\\n  .load()\n</code></pre></div>\n<p>In another terminal, execute below command to insert test data:</p>\n<div class=\"highlight\"><pre><span></span><code>$ nc -lk 9999\n</code></pre></div>\n<p>We create a target table to store the stream data. Note that this table can be created in Hive side as well, for instance, <code>CREATE TABLE hwx_table(value STRING);</code></p>\n<div class=\"highlight\"><pre><span></span><code>hive.createTable(&quot;hwx_table&quot;).column(&quot;value&quot;, &quot;string&quot;).create()\n</code></pre></div>\n<p>Now, the stream data is ready. After that, import the library so that we can easily specify the format.</p>\n<p>Before we start, we should initialize <code>HiveWarehouseSession</code> instance.</p>\n<p>In case of Scala:</p>\n<div class=\"highlight\"><pre><span></span><code>import com.hortonworks.hwc.HiveWarehouseSession\n</code></pre></div>\n<p>In case of Python:</p>\n<div class=\"highlight\"><pre><span></span><code>from pyspark_llap.sql.session import HiveWarehouseSession\n</code></pre></div>\n<p>Next, it starts the structured streaming job. At the terminal which opened <code>nc -lk 9999</code> we can insert arbitrary data and when the terminal inserts Hortonworks, it saves the data into the <code>hwx_table</code> table.</p>\n<div class=\"highlight\"><pre><span></span><code>lines.filter(&quot;value = &#39;Hortonworks&#39;&quot;)\n  .writeStream\n  .format(HiveWarehouseSession.STREAM_TO_STREAM)\n  .option(&quot;database&quot;, &quot;hwc_db&quot;)\n  .option(&quot;table&quot;, &quot;hwx_table&quot;)\n  .option(\n    &quot;metastoreUri&quot;,\n    spark.conf.get(&quot;spark.datasource.hive.warehouse.metastoreUri&quot;))\n  .option(&quot;checkpointLocation&quot;, &quot;/tmp/checkpoint&quot;).start()\n</code></pre></div>\n<p><strong>Note</strong>: There is an issue about interpreting <code>spark.datasource.*</code> configurations into options internally in Apache Spark, which currently makes this library require to set <code>metastoreUri</code> and <code>database</code> options manually. See <a href=\"https://issues.apache.org/jira/browse/SPARK-25460\">SPARK-25460</a> for more details. As soon as this issue is resolved, both <code>metastoreUri</code> and <code>database</code> can be omitted likewise.</p>\n<p>After that, type Hortonworks and also arbitrary words in the terminal opening <code>nc -lk 9999</code></p>\n<div class=\"highlight\"><pre><span></span><code>Foo\nBar\nHortonworks\n</code></pre></div>\n<p>This continuously inserts the word Hortonworks into the table <code>hwx_table</code> .</p>\n<div class=\"highlight\"><pre><span></span><code>hive.table(&quot;hwx_table&quot;).show()\n+------------+\n|       value|\n+------------+\n| Hortonworks|\n+------------+\n</code></pre></div>\n<h2 id=\"5-interaction-paradigms\">5. Interaction Paradigms<a class=\"headerlink\" href=\"#5-interaction-paradigms\" title=\"Permanent link\">&para;</a></h2>\n<p>This library can be interacted with, of course, Apache Spark but also Apache Zeppelin and Apache Livy. This chapter demonstrates entry points of those interaction paradigms in order to leverage this library to utilize provided functionalities.</p>\n<h3 id=\"51-spark-shell\">5.1. Spark Shell:<a class=\"headerlink\" href=\"#51-spark-shell\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><pre><span></span><code>$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<h3 id=\"52-pyspark-shell\">5.2. PySpark Shell:<a class=\"headerlink\" href=\"#52-pyspark-shell\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><pre><span></span><code>$ pyspark --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<h3 id=\"53-scala-java-application-submission\">5.3. Scala / Java Application Submission:<a class=\"headerlink\" href=\"#53-scala-java-application-submission\" title=\"Permanent link\">&para;</a></h3>\n<p>** In case of client mode:**</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false [JAR_NAME]\n</code></pre></div>\n<p>If <strong>3. Prerequisites</strong> at Apache Spark side was not globally configured, use the command with specifying all configurations, for instance:</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.hadoop.hive.llap.daemon.service.hosts=@llap0 \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url=&quot;jdbc:hive2://ctr-e138-1518143905142-509736-01-000007.hwx.site:2181,ctr-e138-1518143905142-509736-01-000009.hwx.site:2181,ctr-e138-1518143905142-509736-01-000006.hwx.site:2181,ctr-e138-1518143905142-509736-01-000005.hwx.site:2181,ctr-e138-1518143905142-509736-01-000008.hwx.site:2181/default;principal=hive/_HOST@HWX.COM;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2-interactive&quot; \\\n  --conf spark.security.credentials.hiveserver2.enabled=false \\\n  --conf spark.datasource.hive.warehouse.load.staging.dir=/tmp \\\n  --conf spark.datasource.hive.warehouse.metastoreUri=thrift://ctr-e138-1518143905142-509736-01-000003.hwx.site:9083,thrift://ctr-e138-1518143905142-509736-01-000004.hwx.site:9083 [JAR_NAME]\n</code></pre></div>\n<p><strong>In case of cluster mode:</strong></p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar [JAR_NAME]\n</code></pre></div>\n<p>If <strong>3. Prerequisites</strong> at Apache Spark side was not globally configured with HWC, use the command with specifying all configurations, for instance:</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.hadoop.hive.llap.daemon.service.hosts=@llap0 \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url=&quot;jdbc:hive2://ctr-e138-1518143905142-509736-01-000007.hwx.site:2181,ctr-e138-1518143905142-509736-01-000009.hwx.site:2181,ctr-e138-1518143905142-509736-01-000006.hwx.site:2181,ctr-e138-1518143905142-509736-01-000005.hwx.site:2181,ctr-e138-1518143905142-509736-01-000008.hwx.site:2181/default;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2-interactive&quot; \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url.principal=&quot;hive/_HOST@EXAMPLE.COM&quot; \\\n  --conf spark.datasource.hive.warehouse.load.staging.dir=/tmp \\\n  --conf spark.datasource.hive.warehouse.metastoreUri=thrift://ctr-e138-1518143905142-509736-01-000003.hwx.site:9083,thrift://ctr-e138-1518143905142-509736-01-000004.hwx.site:9083 [JAR_NAME]\n</code></pre></div>\n<h3 id=\"54-python-application-submission\">5.4. Python Application Submission:<a class=\"headerlink\" href=\"#54-python-application-submission\" title=\"Permanent link\">&para;</a></h3>\n<p>** In case of client mode:**</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false [PY_FILE]\n</code></pre></div>\n<p>** In case of cluster mode:**</p>\n<div class=\"highlight\"><pre><span></span><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip [PY_FILE]\n</code></pre></div>\n<h3 id=\"55-apache-zeppelin\">5.5. Apache Zeppelin<a class=\"headerlink\" href=\"#55-apache-zeppelin\" title=\"Permanent link\">&para;</a></h3>\n<p>Go to <a href=\"https://zeppelin.apache.org/docs/0.8.0/usage/interpreter/overview.html\">the interpreter setting</a>.</p>\n<p><img alt=\"\" src=\"https://lh6.googleusercontent.com/-7HxlmdUWRT8A94q7MBV3olT5nFpcOqcEJfAZOB9Ldt-HK8bnFqlbJMaGKZuOVKrWLa0-wZAPtYvOCPDmvcglMhMABSBb36CtDqXBUAcaSlKodteuqE96sKOyJDS402JF80kImY3\" /></p>\n<p>Find the interpreter settings and set the configuration accordingly.</p>\n<p>** In case of Spark interpreter:**</p>\n<p><img alt=\"\" src=\"https://lh6.googleusercontent.com/nlRa4H7_CObc_tUGs0ggYRjYP7APLo6BB-KTNnqyYXwvTnxWNQYgE5O0MBdZaAJoUBKmhbCvzGLYR0l8VxYfL8FS5mOW59CsOgJceYCxBthmxrrm0xf-RXWJH0Obr3fZrpfIwur0\" /></p>\n<p>Add <code>spark.jars</code> for instance:</p>\n<div class=\"highlight\"><pre><span></span><code>spark.jars=/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar\n</code></pre></div>\n<p>For Python usage, the configuration below should also be added. For instance:</p>\n<div class=\"highlight\"><pre><span></span><code>spark.submit.pyFiles=/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip\n</code></pre></div>\n<p>If the interpreter is set to YARN client mode, <code>spark.security.credentials.hiveserver2.enabled</code> should be set to false as below:</p>\n<div class=\"highlight\"><pre><span></span><code>spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<p>If you use a Kerberized cluster, do not forget to set:</p>\n<div class=\"highlight\"><pre><span></span><code>spark.yarn.keytab\nspark.yarn.principal\n</code></pre></div>\n<p>** In case of Livy interpreter:**</p>\n<p><img alt=\"\" src=\"https://lh3.googleusercontent.com/3KpNt4bBdKy04XcyV8nGKiIHIsxEWTUZci8vBi2hE5j0ykoNoaN_RikgXbIuA8qqP7oMIUveTDWI6wn8MWaaSvLhQKVXJZUxdE4rwIzCLjkTqhqOxt20yBBFpREcnzdVIRbB9Idn\" /></p>\n<p>Add <code>livy.spark.jars</code> for instance:</p>\n<div class=\"highlight\"><pre><span></span><code>livy.spark.jars=file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar\n</code></pre></div>\n<p>For Python usage, the configuration below should also be added. For instance:</p>\n<div class=\"highlight\"><pre><span></span><code>livy.spark.submit.pyFiles=file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip\n</code></pre></div>\n<p><strong>Note</strong>: Local directories are disallowed by default for security reasons. Set the local directory to <code>livy.file.local-dir-whitelist</code> to allow a specific directory to allow to read. To avoid this setting, please use HDFS path after uploading the JAR and zipped file.</p>\n<p>If the interpreter is set to YARN client mode (see <code>livy.spark.master</code> and <code>livy.spark.submit.deployMode</code>), <code>livy.spark.security.credentials.hiveserver2.enabled</code> should be set to <code>false</code> as below:</p>\n<div class=\"highlight\"><pre><span></span><code>livy.spark.security.credentials.hiveserver2.enabled=false\n</code></pre></div>\n<p>If you use a Kerberized cluster, do not forget to set:</p>\n<div class=\"highlight\"><pre><span></span><code>zeppelin.livy.keytab\nzeppelin.livy.principal\n</code></pre></div>\n<p><strong>Note</strong>: To use HWC with Livy in a secure cluster please follow the documentation <a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/using-zeppelin/content/using_spark_hwc_and_shc_client_jar_files_with_livy.html\">here</a>.</p>\n<h3 id=\"56-apache-livy\">5.6. Apache Livy<a class=\"headerlink\" href=\"#56-apache-livy\" title=\"Permanent link\">&para;</a></h3>\n<p>The code below describes an example to submit Python application by Livy request with <code>curl</code> .</p>\n<div class=\"highlight\"><pre><span></span><code>$ curl -X POST -H &quot;Content-Type: application/json&quot; -H &quot;X-Requested-By: hive&quot; --negotiate  \\\n  -u : `hostname`:8999/batches --data &#39;{\n  &quot;conf&quot;: {\n    &quot;spark.master&quot;: &quot;yarn-cluster&quot;,\n    &quot;spark.jars&quot;: &quot;file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar&quot;, \n    &quot;spark.submit.pyFiles&quot;: &quot;file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip&quot;\n  }, \n  &quot;file&quot;: &quot;[PY_FILE]&quot;}&#39; | python -m json.tool\n</code></pre></div>\n<p>It shows the job information.</p>\n<div class=\"highlight\"><pre><span></span><code>{\n  &quot;appId&quot;: null,\n  &quot;appInfo&quot;: {\n    &quot;driverLogUrl&quot;: null,\n    &quot;sparkUiUrl&quot;: null\n  },\n  &quot;id&quot;: 1,\n  &quot;log&quot;: [\n    &quot;stdout: &quot;,\n    &quot;\\nstderr: &quot;,\n    &quot;\\nYARN Diagnostics: &quot;\n  ],\n  &quot;state&quot;: &quot;starting&quot;\n}\n</code></pre></div>\n<p>To patch job information, GET <code>batches/[ID]</code> is used.</p>\n<div class=\"highlight\"><pre><span></span><code>$ curl --negotiate -u : `hostname`:8999/batches/1 | python -m json.tool\n</code></pre></div>\n<p>This request shows an output, for example, as below. </p>\n<div class=\"highlight\"><pre><span></span><code>{\n  &quot;appId&quot;: &quot;application_1539107884019_0071&quot;,\n  &quot;appInfo&quot;: {\n    &quot;driverLogUrl&quot;: &quot;http://ctr-e138-1518143905142-512381-01-000003.hwx.site:8188/applicationhistory/logs/ctr-e138-1518143905142-512381-01-000006.hwx.site:25454/container_e02_1539107884019_0071_01_000001/container_e02_1539107884019_0071_01_000001/hive&quot;,\n    &quot;sparkUiUrl&quot;: &quot;http://ctr-e138-1518143905142-512381-01-000004.hwx.site:8088/proxy/application_1539107884019_0071/&quot;\n  },\n  &quot;id&quot;: 1,\n  &quot;log&quot;: [\n    &quot;\\t queue: default&quot;,\n    &quot;\\t start time: 1539151855183&quot;,\n    &quot;\\t final status: UNDEFINED&quot;,\n    &quot;\\t tracking URL: http://ctr-e138-1518143905142-512381-01-000004.hwx.site:8088/proxy/application_1539107884019_0071/&quot;,\n    &quot;\\t user: hive&quot;,\n    &quot;18/10/10 06:10:55 INFO ShutdownHookManager: Shutdown hook called&quot;,\n    &quot;18/10/10 06:10:55 INFO ShutdownHookManager: Deleting directory /tmp/spark-6e254b5c-50f9-40d0-af06-c37d8c1a6428&quot;,\n    &quot;18/10/10 06:10:55 INFO ShutdownHookManager: Deleting directory /tmp/spark-253eac26-e86e-4699-82e6-ad281702fb85&quot;,\n    &quot;\\nstderr: &quot;,\n    &quot;\\nYARN Diagnostics: &quot;\n  ],\n  &quot;state&quot;: &quot;success&quot;\n}\n</code></pre></div>\n<p><strong>Note</strong>: The example above used Kerberized cluster; therefore, <code>--negotiate</code> option is used in <code>curl</code>.</p>\n<p><strong>Note</strong>: Local directories are disallowed by default for security reasons. Set the local directory to <code>livy.file.local-dir-whitelist</code> to allow a specific directory to allow to read. To avoid this setting, please use HDFS path after uploading the JAR and zipped file.</p>\n<p><strong>Note</strong>: To use HWC with Livy in a secure cluster please follow the documentation <a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/using-zeppelin/content/using_spark_hwc_and_shc_client_jar_files_with_livy.html\">here</a>.</p>\n<h2 id=\"6-limitations\">6. Limitations<a class=\"headerlink\" href=\"#6-limitations\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>Missing SQL support including USING syntax: currently Data Source V2 implementation <a href=\"https://issues.apache.org/jira/browse/SPARK-25280\">does not support SQL syntax including USING syntax</a></li>\n<li>Missing R library support: this library currently supports only Scala, Java, and Python APIs.</li>\n<li>Limitations in Apache Arrow integration and Data Source V2 are inherited. See <a href=\"https://issues.apache.org/jira/browse/SPARK-22386\">SPARK-22386</a> for Data Source V2 and <a href=\"https://issues.apache.org/jira/browse/SPARK-21187\">SPARK-21187</a> for Apache Arrow integration in Apache Spark to track ongoing efforts and limitations.</li>\n<li>Supported/unsupported data types and their mapping between Apache Hive and Apache Spark can be found at this <a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/integrating-hive/content/hive_hivewarehouseconnector_supported_types.html\">link</a>.</li>\n</ul>\n<h2 id=\"7-appendix\">7. Appendix<a class=\"headerlink\" href=\"#7-appendix\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/integrating-hive/content/hive_hivewarehouseconnector_for_handling_apache_spark_data.html\">HDP 3.0.1 documentation</a></li>\n<li><a href=\"https://github.com/hortonworks/hive-warehouse-connector-release/tree/HDP-3.0.1.0-187-tag\">Hive Warehouse Connector Github</a></li>\n<li>Apache Ambari UI for enabling \u2018Interactive Query\u2019 in Hive<img alt=\"\" src=\"https://lh6.googleusercontent.com/MFBoV6fPIIWLfzo53mP7FUOkeeFk8fV5rWIAuRcHx5uhDgxG78-o688V71-CaNwQ5iARopLuwfkORisS-iYCLj1T-TMg_WPZf7XiBOeVwXdqcHir0_ADPjiGjILW9FqTWqgeg7Dv\" /></li>\n<li><a href=\"https://community.hortonworks.com/articles/101181/rowcolumn-level-security-in-sql-for-apache-spark-2.html\">Introducing Row/ Column Level Access Control for Apache Spark</a></li>\n<li>\n<p><code>SQL INSERT</code> queries to insert <a href=\"https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/topic-pages/tables/table-1\">https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/topic-pages/tables/table-1</a></p>\n<p>CREATE DATABASE hwc_db;\nUSE hwc_db;\nCREATE TABLE crimes(year INT, crime_rate DOUBLE);\nINSERT INTO crimes VALUES (1997, 611.0), (1998, 567.6), (1999, 523.0), (2000, 506.5), (2001, 504.5), (2002, 494.4), (2003, 475.8);\nINSERT INTO crimes VALUES (2004, 463.2), (2005, 469.0), (2006, 479.3), (2007, 471.8), (2008, 458.6), (2009, 431.9), (2010, 404.5);\nINSERT INTO crimes VALUES (2011, 387.1), (2012, 387.8), (2013, 369.1), (2014, 361.6), (2015, 373.7), (2016, 386.3);</p>\n</li>\n</ul>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["hive", "spark"]}, {"id": "https://wgzhao.github.io/notes/bigdata/integrating-phoenix-with-kerberos/", "url": "https://wgzhao.github.io/notes/bigdata/integrating-phoenix-with-kerberos/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1", "content_html": "<h2 id=\"_1\">\u964d\u7ea7<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<p>HDP \u81ea\u5e26\u7684hbase\u548cphoenix\u56e0\u4e3a\u4e0epresto \u4e0d\u517c\u5bb9\uff0c\u53ea\u80fd\u5168\u90e8\u964d\u7ea7\uff0c\u5176\u4e2d HBASE \u964d\u7ea7\u5230 1.4\u7248\u672c\u3002phoenix\u964d\u7ea7\u5230\u5bf9\u5e94\u7684 4.14.3 \u7248\u672c\u3002</p>\n<p>\u964d\u7ea7\u7684\u7b80\u5355\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6309\u6b63\u5e38\u65b9\u5f0f\u901a\u8fc7Ambari\u5b89\u88c5HBASE</li>\n<li>\u5220\u9664\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684 <code>/usr/hdp/&lt;version&gt;/hbase</code> \u548c <code>/usr/hdp/&lt;version&gt;/phoenix</code> \u76ee\u5f55</li>\n<li>\u4ece\u5b98\u65b9\u4e0b\u8f7d\u5bf9\u5e94\u7684\u8f6f\u4ef6\uff0c\u5e76\u590d\u5236\u5230\u4e0a\u8ff0\u4e24\u4e2a\u76ee\u5f55\u4e2d\uff08\u5148\u521b\u5efa\u76ee\u5f55\uff09</li>\n<li><code>/usr/hdp/&lt;version&gt;/phoenix</code> \u91cc\u9700\u8981\u521b\u5efa\u5982\u4e0b\u8f6f\u8fde\u63a5\uff1a\n    <div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ln -sf phoenix-hive-4.14.3-HBase-1.4.jar phoenix-hive.jar</span>\n<span class=\"c1\"># ln -sf phoenix-4.14.3-HBase-1.4-client.jar phoenix-client.jar</span>\n<span class=\"c1\"># ln -sf phoenix-4.14.3-HBase-1.4-thin-client.jar phoenix-thin-client.jar</span>\n<span class=\"c1\"># ln -sf phoenix-4.14.3-HBase-1.4-server.jar  phoenix-server.jar</span>\n</code></pre></div></li>\n<li><code>/usr/hdp/&lt;version&gt;/hbase</code> \u91cc\u521b\u5efa\u5982\u4e0b\u8f6f\u8fde\u63a5\n    <div class=\"highlight\"><pre><span></span><code>ln<span class=\"w\"> </span>-sf<span class=\"w\"> </span>/usr/hdp/&lt;version&gt;/phoenix/phoenix-server.jar<span class=\"w\"> </span>.\n</code></pre></div></li>\n<li>\u589e\u52a0 <code>/bin/hbase-config.sh</code> \u7684\u8f6f\u8fde\u63a5\n    <div class=\"highlight\"><pre><span></span><code>ln<span class=\"w\"> </span>-sf<span class=\"w\"> </span>/usr/hdp/current/hbase-client/bin/hbase-config<span class=\"w\"> </span>/bin/hbase-config.sh\n</code></pre></div></li>\n</ol>\n<h2 id=\"namespace\">\u589e\u52a0namespace\u7684\u6620\u5c04\u914d\u7f6e<a class=\"headerlink\" href=\"#namespace\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e3a\u4e86\u8ba9phoenix\u80fd\u770b\u5230hbase\u5df2\u7ecf\u5b58\u5728\u7684\u8868\uff0c\u9700\u8981\u5728hbase\u91cc\u589e\u52a0\u5982\u4e0b\u914d\u7f6e(Ambari-&gt;HBase-&gt;Config-&gt;Custom hbase-site.xml)\n<div class=\"highlight\"><pre><span></span><code>phoenix.schema.mapSystemTablesToNamespace=true\nphoenix.schema.isNamespaceMappingEnabled=true\n</code></pre></div>\n\u91cd\u542fhbase\uff0c\u8ba9\u65b0\u914d\u7f6e\u751f\u6548</p>\n<h2 id=\"_2\">\u8d4b\u6743<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u7a7a\u95f4\u53ea\u6709hbase\u8d26\u53f7\u624d\u6709\u6743\u9650\uff0c\u800c\u6211\u4eec\u5e0c\u671bhive\u8d26\u53f7\u4e5f\u6709\u6743\u9650\uff0c\u9700\u8981\u901a\u8fc7\u6267\u884c <code>hbase shell</code> \u547d\u4ee4\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4 </p>\n<div class=\"highlight\"><pre><span></span><code>hbase<span class=\"o\">(</span>main<span class=\"o\">)</span>:008:0&gt;<span class=\"w\"> </span>grant<span class=\"w\"> </span><span class=\"s1\">&#39;hive&#39;</span>,<span class=\"w\"> </span><span class=\"s1\">&#39;RWXCA&#39;</span>\n<span class=\"m\">0</span><span class=\"w\"> </span>row<span class=\"o\">(</span>s<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">1</span>.0180<span class=\"w\"> </span>seconds\n</code></pre></div>\n<h2 id=\"_3\">\u521d\u59cb\u5316<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5207\u6362\u5230 <code>hbase</code> \u6216 <code>hive</code> \u8d26\u53f7\uff0c\u6267\u884c <code>/usr/hdp/current/phoenix-client/bin/sqlline.py</code></p>\n<p>\u56e0\u4e3a\u7b2c\u4e00\u6b21\u8981\u521b\u5efa\u7cfb\u7edf\u8868\uff0c\u4f1a\u6bd4\u8f83\u6162\uff0c\u5176\u8f93\u51fa\u5982\u679c\u548c\u4e0b\u9762\u7c7b\u4f3c\uff0c\u5219\u8868\u793a\u521d\u59cb\u5316\u6210\u529f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>/usr/hdp/current/phoenix-client/bin/sqlline.py\nSetting<span class=\"w\"> </span>property:<span class=\"w\"> </span><span class=\"o\">[</span>incremental,<span class=\"w\"> </span>false<span class=\"o\">]</span>\nSetting<span class=\"w\"> </span>property:<span class=\"w\"> </span><span class=\"o\">[</span>isolation,<span class=\"w\"> </span>TRANSACTION_READ_COMMITTED<span class=\"o\">]</span>\nissuing:<span class=\"w\"> </span>!connect<span class=\"w\"> </span>jdbc:phoenix:<span class=\"w\"> </span>none<span class=\"w\"> </span>none<span class=\"w\"> </span>org.apache.phoenix.jdbc.PhoenixDriver\nConnecting<span class=\"w\"> </span>to<span class=\"w\"> </span>jdbc:phoenix:\nSLF4J:<span class=\"w\"> </span>Class<span class=\"w\"> </span>path<span class=\"w\"> </span>contains<span class=\"w\"> </span>multiple<span class=\"w\"> </span>SLF4J<span class=\"w\"> </span>bindings.\nSLF4J:<span class=\"w\"> </span>Found<span class=\"w\"> </span>binding<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span>jar:file:/usr/hdp/3.0.1.0-187/phoenix/phoenix-4.14.3-HBase-1.4-client.jar!/org/slf4j/impl/StaticLoggerBinder.class<span class=\"o\">]</span>\nSLF4J:<span class=\"w\"> </span>Found<span class=\"w\"> </span>binding<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span>jar:file:/usr/hdp/3.0.1.0-187/hadoop/lib/slf4j-log4j12-1.7.25.jar!/org/slf4j/impl/StaticLoggerBinder.class<span class=\"o\">]</span>\nSLF4J:<span class=\"w\"> </span>See<span class=\"w\"> </span>http://www.slf4j.org/codes.html#multiple_bindings<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>an<span class=\"w\"> </span>explanation.\nConnected<span class=\"w\"> </span>to:<span class=\"w\"> </span>Phoenix<span class=\"w\"> </span><span class=\"o\">(</span>version<span class=\"w\"> </span><span class=\"m\">4</span>.14<span class=\"o\">)</span>\nDriver:<span class=\"w\"> </span>PhoenixEmbeddedDriver<span class=\"w\"> </span><span class=\"o\">(</span>version<span class=\"w\"> </span><span class=\"m\">4</span>.14<span class=\"o\">)</span>\nAutocommit<span class=\"w\"> </span>status:<span class=\"w\"> </span><span class=\"nb\">true</span>\nTransaction<span class=\"w\"> </span>isolation:<span class=\"w\"> </span>TRANSACTION_READ_COMMITTED\nBuilding<span class=\"w\"> </span>list<span class=\"w\"> </span>of<span class=\"w\"> </span>tables<span class=\"w\"> </span>and<span class=\"w\"> </span>columns<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>tab-completion<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"nb\">set</span><span class=\"w\"> </span>fastconnect<span class=\"w\"> </span>to<span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"w\"> </span>to<span class=\"w\"> </span>skip<span class=\"o\">)</span>...\n<span class=\"m\">133</span>/133<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">100</span>%<span class=\"o\">)</span><span class=\"w\"> </span>Done\nDone\nsqlline<span class=\"w\"> </span>version<span class=\"w\"> </span><span class=\"m\">1</span>.2.0\n</code></pre></div>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["hbase", "phoenix", "prestodb", "trino"]}, {"id": "https://wgzhao.github.io/notes/bigdata/ipa-setup/", "url": "https://wgzhao.github.io/notes/bigdata/ipa-setup/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "free IPA setup", "content_html": "<h1 id=\"free-ipa-setup\">free IPA setup<a class=\"headerlink\" href=\"#free-ipa-setup\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"instuctions-for-ipa-lab\">Instuctions for IPA Lab<a class=\"headerlink\" href=\"#instuctions-for-ipa-lab\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"pre-reqs\">Pre-reqs<a class=\"headerlink\" href=\"#pre-reqs\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>HDP 3.x / Ambari 2.7.1 cluster<br></li>\n<li>Access to an IPA server that has been setup as descibed in <a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/authentication-with-kerberos/content/kerberos_optional_use_an_existing_ipa.html\">Hortonworks documentation</a>. See sample <a href=\"https://github.com/HortonworksUniversity/Security_Labs/blob/master/extras/ipa.md\">script</a> to set up</li>\n</ul>\n<p><strong>Lab Topics</strong><br>\n0. Accessing your Cluster\n1. <a href=\"#section-1\">Register cluster nodes as IPA Clients</a>\n2. <a href=\"#section-2\">Secure Ambari via ambari-server setup-security</a>\n3. <a href=\"#section-3\">Enable Kerberos for cluster services</a>\n4. <a href=\"#section-4\">Enable LDAP for ambari</a></p>\n<h1 id=\"lab-1\">Lab 1<a class=\"headerlink\" href=\"#lab-1\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"accessing-your-cluster\">Accessing your Cluster<a class=\"headerlink\" href=\"#accessing-your-cluster\" title=\"Permanent link\">&para;</a></h2>\n<p>Credentials will be provided for these services by the instructor:</p>\n<ul>\n<li>SSH</li>\n<li>Ambari</li>\n</ul>\n<h2 id=\"use-your-cluster\">Use your Cluster<a class=\"headerlink\" href=\"#use-your-cluster\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"to-connect-using-putty-from-windows-laptop\">To connect using Putty from Windows laptop<a class=\"headerlink\" href=\"#to-connect-using-putty-from-windows-laptop\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>Right click to download <a href=\"https://github.com/HortonworksUniversity/Security_Labs/raw/master/training-keypair.ppk\">this ppk key</a> &gt; Save link as &gt; save to Downloads folder</li>\n<li>Use putty to connect to your node using the ppk key:</li>\n<li>\n<p>Connection &gt; SSH &gt; Auth &gt; Private key for authentication &gt; Browse... &gt; Select training-keypair.ppk\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/putty.png\" /></p>\n</li>\n<li>\n<p>Make sure to click \"Save\" on the session page before logging in</p>\n</li>\n<li>When connecting, it will prompt you for username. Enter <code>centos</code></li>\n</ul>\n<h3 id=\"to-connect-from-linuxmacosx-laptop\">To connect from Linux/MacOSX laptop<a class=\"headerlink\" href=\"#to-connect-from-linuxmacosx-laptop\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>SSH into Ambari node of your cluster using below steps:</li>\n<li>Right click to download <a href=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/training-keypair.pem\">this pem key</a>  &gt; Save link as &gt; save to Downloads folder</li>\n<li>Copy pem key to ~/.ssh dir and correct permissions\n  <div class=\"highlight\"><pre><span></span><code>cp ~/Downloads/training-keypair.pem ~/.ssh/\nchmod 400 ~/.ssh/training-keypair.pem\n</code></pre></div></li>\n<li>Login to the Ambari node of the cluster you have been assigned by replacing IP_ADDRESS_OF_AMBARI_NODE below with Ambari node IP Address (your instructor will provide this) <br />\n  <div class=\"highlight\"><pre><span></span><code>ssh -i  ~/.ssh/training-keypair.pem centos@IP_ADDRESS_OF_AMBARI_NODE\n</code></pre></div></li>\n<li>\n<p>To change user to root you can:\n  <div class=\"highlight\"><pre><span></span><code>sudo su -\n</code></pre></div></p>\n</li>\n<li>\n<p>Similarly login via SSH to each of the other nodes in your cluster as you will need to run commands on each node in a future lab</p>\n</li>\n<li>\n<p>Tip: Since in the next labs you will be required to run <em>the same set of commands</em> on each of the cluster hosts, now would be a good time to setup your favorite tool to do so: examples <a href=\"https://www.reddit.com/r/sysadmin/comments/3d8aou/running_linux_commands_on_multiple_servers/\">here</a></p>\n</li>\n<li>On OSX, an easy way to do this is to use <a href=\"https://www.iterm2.com/\">iTerm</a>: open multiple tabs/splits and then use 'Broadcast input' feature (under Shell -&gt; Broadcast input)</li>\n<li>If you are not already familiar with such a tool, you can also just run the commands on the cluster, one host at a time</li>\n</ul>\n<h4 id=\"login-to-ambari\">Login to Ambari<a class=\"headerlink\" href=\"#login-to-ambari\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Login to Ambari web UI by opening <a href=\"http://AMBARI_PUBLIC_IP:8080\">http://AMBARI_PUBLIC_IP:8080</a> and log in with <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/admin/BadPass/issues/1\" title=\"GitHub Issue: admin/BadPass #1\">admin/BadPass#1</a></p>\n</li>\n<li>\n<p>You will see a list of Hadoop components running on your cluster on the left side of the page</p>\n</li>\n<li>They should all show green (ie started) status. If not, start them by Ambari via 'Service Actions' menu for that service</li>\n</ul>\n<h4 id=\"finding-internalexternal-hosts\">Finding internal/external hosts<a class=\"headerlink\" href=\"#finding-internalexternal-hosts\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Following are useful techniques you can use in future labs to find your cluster specific details:</p>\n</li>\n<li>\n<p>From SSH terminal, how can I find the cluster name?\n  <div class=\"highlight\"><pre><span></span><code>#run on ambari node to fetch cluster name via Ambari API\nPASSWORD=BadPass#1\noutput=`curl -u admin:$PASSWORD -i -H &#39;X-Requested-By: ambari&#39;  http://localhost:8080/api/v1/clusters`\ncluster=`echo $output | sed -n &#39;s/.*&quot;cluster_name&quot; : &quot;\\([^\\&quot;]*\\)&quot;.*/\\1/p&#39;`\necho $cluster\n</code></pre></div></p>\n</li>\n<li>\n<p>From SSH terminal, how can I find internal hostname (aka FQDN) of the node I'm logged into?\n  <div class=\"highlight\"><pre><span></span><code>$ hostname -f\nip-172-30-0-186.us-west-2.compute.internal  \n</code></pre></div></p>\n</li>\n<li>\n<p>From Ambari how do I check the cluster name?</p>\n<ul>\n<li>It is displayed on the top left of the Ambari dashboard, next to the Ambari logo. If the name appears truncated, you can hover over it to produce a helptext dialog with the full name\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/hdp3/hdp3-clustername.png\" /></li>\n</ul>\n</li>\n<li>\n<p>From Ambari how can I find external hostname of node where a component (e.g. Resource Manager or Hive) is installed?</p>\n<ul>\n<li>Click the parent service (e.g. YARN) and <em>hover over</em> the name of the component. The external hostname will appear.\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/hdp3/hdp3-hostname.png\" /></li>\n</ul>\n</li>\n<li>\n<p>From Ambari how can I find internal hostname of node where a component (e.g. Resource Manager or Hive) is installed?</p>\n<ul>\n<li>Click the parent service (e.g. YARN) and <em>click on</em> the name of the component. It will take you to hosts page of that node and display the internal hostname on the top.\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/hdp3/hdp3-internalhostname.png\" />  </li>\n</ul>\n</li>\n<li>\n<p>In future labs you may need to provide private or public hostname of nodes running a particular component (e.g. YARN RM or Mysql or HiveServer)</p>\n</li>\n</ul>\n<h4 id=\"import-sample-data-into-hive\">Import sample data into Hive<a class=\"headerlink\" href=\"#import-sample-data-into-hive\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>Run below <em>on the node where HiveServer2 is installed</em> to download data and import it into a Hive table for later labs</li>\n<li>You can either find the node using Ambari as outlined in Lab 1</li>\n<li>Download and import data\n  <div class=\"highlight\"><pre><span></span><code>cd /tmp\nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/sample_07.csv\nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/sample_08.csv\n</code></pre></div></li>\n<li>Create user dir for admin, sales1 and hr1\n  <div class=\"highlight\"><pre><span></span><code> sudo -u hdfs hdfs dfs  -mkdir /user/admin\n sudo -u hdfs hdfs dfs  -chown admin:hadoop /user/admin\n\n sudo -u hdfs hdfs dfs  -mkdir /user/sales1\n sudo -u hdfs hdfs dfs  -chown sales1:hadoop /user/sales1\n\n sudo -u hdfs hdfs dfs  -mkdir /user/hr1\n sudo -u hdfs hdfs dfs  -chown hr1:hadoop /user/hr1   \n</code></pre></div></li>\n<li>Copy csv's into HDFS\n  <div class=\"highlight\"><pre><span></span><code>sudo -u hdfs hdfs dfs -mkdir -p /hive_data/salary\nsudo -u hdfs hdfs dfs -put /tmp/sample*  /hive_data/salary\nsudo -u hdfs hdfs dfs -chown -R hive:hive /hive_data/\n</code></pre></div></li>\n<li>\n<p>Now create Hive table in default database by </p>\n<ul>\n<li>Start beeline shell from the node where Hive is installed: \n<div class=\"highlight\"><pre><span></span><code>beeline -n hive -u &quot;jdbc:hive2://localhost:10000/default&quot;\n</code></pre></div></li>\n</ul>\n</li>\n<li>\n<p>At beeline prompt, run below:</p>\n</li>\n</ul>\n<p><div class=\"highlight\"><pre><span></span><code>CREATE EXTERNAL TABLE sample_07 (\ncode string ,\ndescription string ,  \ntotal_emp int ,  \nsalary int )\nROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;\\t&#39; STORED AS TextFile\nLOCATION &#39;/hive_data/salary&#39;;\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code>CREATE EXTERNAL TABLE sample_08 (\ncode string ,\ndescription string ,  \ntotal_emp int ,  \nsalary int )\nROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;\\t&#39; STORED AS TextFile\nLOCATION &#39;/hive_data/salary&#39;;\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code>!q\n</code></pre></div></p>\n<ul>\n<li>Notice that in the JDBC connect string for connecting to an unsecured Hive while its running in default (ie binary) transport mode :</li>\n<li>port is 10000</li>\n<li>\n<p>no kerberos principal was needed </p>\n</li>\n<li>\n<p>This will change after we:</p>\n</li>\n<li>enable kerberos</li>\n<li>configure Hive for http transport mode (to go through Knox)</li>\n</ul>\n<h3 id=\"why-is-security-needed\">Why is security needed?<a class=\"headerlink\" href=\"#why-is-security-needed\" title=\"Permanent link\">&para;</a></h3>\n<h5 id=\"hdfs-access-on-unsecured-cluster\">HDFS access on unsecured cluster<a class=\"headerlink\" href=\"#hdfs-access-on-unsecured-cluster\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>\n<p>On your unsecured cluster try to access a restricted dir in HDFS\n<div class=\"highlight\"><pre><span></span><code>hdfs dfs -ls /tmp/hive   \n## this should fail with Permission Denied\n</code></pre></div></p>\n</li>\n<li>\n<p>Now try again after setting HADOOP_USER_NAME env var\n<div class=\"highlight\"><pre><span></span><code>export HADOOP_USER_NAME=hdfs\nhdfs dfs -ls /tmp/hive   \n## this shows the file listing!\n</code></pre></div></p>\n</li>\n<li>Unset the env var and it will fail again\n<div class=\"highlight\"><pre><span></span><code>unset HADOOP_USER_NAME\nhdfs dfs -ls /tmp/hive  \n</code></pre></div></li>\n</ul>\n<h5 id=\"webhdfs-access-on-unsecured-cluster\">WebHDFS access on unsecured cluster<a class=\"headerlink\" href=\"#webhdfs-access-on-unsecured-cluster\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>\n<p>From <em>node running NameNode</em>, make a WebHDFS request using below command:\n<div class=\"highlight\"><pre><span></span><code>curl -sk -L &quot;http://$(hostname -f):50070/webhdfs/v1/user/?op=LISTSTATUS&quot;\n</code></pre></div></p>\n</li>\n<li>\n<p>In the absence of Knox, notice it goes over HTTP (not HTTPS) on port 50070 and no credentials were needed</p>\n</li>\n</ul>\n<h5 id=\"web-ui-access-on-unsecured-cluster\">Web UI access on unsecured cluster<a class=\"headerlink\" href=\"#web-ui-access-on-unsecured-cluster\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>From Ambari notice you can open the WebUIs without any authentication</li>\n<li>HDFS &gt; Quicklinks &gt; NameNode UI</li>\n<li>Mapreduce &gt; Quicklinks &gt; JobHistory UI</li>\n<li>\n<p>YARN &gt; Quicklinks &gt; ResourceManager UI</p>\n</li>\n<li>\n<p>This should tell you why kerberos (and other security) is needed on Hadoop :)</p>\n</li>\n</ul>\n<hr />\n<h1 id=\"lab-2\">Lab 2<a class=\"headerlink\" href=\"#lab-2\" title=\"Permanent link\">&para;</a></h1>\n<h3 id=\"review-use-case\">Review use case<a class=\"headerlink\" href=\"#review-use-case\" title=\"Permanent link\">&para;</a></h3>\n<p>Use case: Customer has an existing cluster which they would like you to secure for them</p>\n<ul>\n<li>Current setup:</li>\n<li>The customer has multiple organizational groups (i.e. sales, hr, legal) which contain business users (sales1, hr1, legal1 etc) and hadoopadmin</li>\n<li>These groups and users are defined in Active Directory (AD) under its own Organizational Unit (OU) called CorpUsers </li>\n<li>There are empty OUs created in AD to store hadoop principals/hadoop nodes (HadoopServices, HadoopNodes)</li>\n<li>Hadoopadmin user has administrative credentials with delegated control of \"Create, delete, and manage user accounts\" on above OUs</li>\n<li>\n<p>Hadoop cluster running HDP has already been setup using Ambari (including HDFS, YARN, Hive, Hbase, Solr, Zookeeper)</p>\n</li>\n<li>\n<p>Goals:</p>\n</li>\n<li>Integrate Ambari with AD - so that hadoopadmin can administer the cluster</li>\n<li>Integrate Hadoop nodes OS with AD - so business users are recognized and can submit Hadoop jobs</li>\n<li>Enable kerberos - to secured the cluster and enable authentication</li>\n<li>Install Ranger and enable Hadoop plugins - to allow admin to setup authorization policies and review audits across Hadoop components</li>\n<li>Install Ranger KMS and enable HDFS encryption - to be able to create encryption zones</li>\n<li>Encrypt Hive backing dirs - to protect hive tables</li>\n<li>Configure Ranger policies to:<ul>\n<li>Protect /sales HDFS dir - so only sales group has access to it</li>\n<li>Protect sales hive table - so only sales group has access to it</li>\n<li>Fine grained access: sales users should only have access to code, description columns in default.sample_07, but only for rows where total_emp&lt;5000. Also total_emp column should be masked</li>\n<li>Protect sales HBase table - so only sales group has access to it</li>\n</ul>\n</li>\n<li>Install Knox and integrate with AD - for perimeter security and give clients access to APIs w/o dealing with kerberos</li>\n<li>Enable Ambari views to work on secured cluster</li>\n</ul>\n<p>We will run through a series of labs and step by step, achieve all of the above goals</p>\n<h2 id=\"1-register-cluster-nodes-as-ipa-clients\"><a name=\"section-1\"></a>1. Register cluster nodes as IPA clients<a class=\"headerlink\" href=\"#1-register-cluster-nodes-as-ipa-clients\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>Run below on <em>all nodes of HDP cluster</em> (replace $INTERNAL_IP_OF_IPA)</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code>echo &quot;$INTERNAL_IP_OF_IPA ipa.us-west-2.compute.internal ipa&quot; &gt;&gt; /etc/hosts\n</code></pre></div>\n<ul>\n<li>\n<p>Install yum packages\n<div class=\"highlight\"><pre><span></span><code>sudo yum install -y ipa-client\n</code></pre></div></p>\n</li>\n<li>\n<p>Update /etc/resolve.conf (replace INTERNAL_IP_OF_IPA)\n<div class=\"highlight\"><pre><span></span><code>mv /etc/resolv.conf /etc/resolv.conf.bak \necho &quot;search us-west-2.compute.internal&quot; &gt; /etc/resolv.conf\necho &quot;nameserver $INTERNAL_IP_OF_IPA&quot; &gt;&gt; /etc/resolv.conf\n</code></pre></div></p>\n</li>\n<li>Install IPA client</li>\n</ul>\n<p><div class=\"highlight\"><pre><span></span><code>  sudo ipa-client-install \\\n  --server=ipa.us-west-2.compute.internal \\\n  --realm=US-WEST-2.COMPUTE.INTERNAL \\\n  --domain=us-west-2.compute.internal \\\n  --mkhomedir \\\n  --principal=admin -w BadPass#1 \\\n  --unattended\n</code></pre></div>\nNote: restarting dbus seems to be required sometimes <code>service dbus restart</code></p>\n<ul>\n<li>\n<p>Make sure you don't see below message from the output of previous command\n<div class=\"highlight\"><pre><span></span><code>Missing A/AAAA record(s) for host xxxxxxxxx\n</code></pre></div></p>\n</li>\n<li>\n<p>If you do, uninstall and try again:\n<div class=\"highlight\"><pre><span></span><code>service dbus restart\nsudo ipa-client-install --uninstall\n</code></pre></div></p>\n</li>\n<li>\n<p>Note by changing the DNS, its possible the node may not be able to connect to public internet. When you need to do so (e.g. for yum install, you can temporarily revert back the /etc/resolv.conf.bak)</p>\n</li>\n</ul>\n<h3 id=\"verify\">Verify<a class=\"headerlink\" href=\"#verify\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p>By registering as a client of the IPA server, SSSD is automatically setup. So now the host recognizes users defined in IPA\n<div class=\"highlight\"><pre><span></span><code>id hadoopadmin\n</code></pre></div></p>\n</li>\n<li>\n<p>You can also authenticate and get a kerberos ticket (password is <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a>)\n<div class=\"highlight\"><pre><span></span><code>kinit -V hadoopadmin\n</code></pre></div></p>\n</li>\n</ul>\n<hr />\n<h1 id=\"2-secure-ambari-via-ambari-server-setup-security\"><a name=\"section-2\"></a> 2. Secure Ambari via ambari-server setup-security<a class=\"headerlink\" href=\"#2-secure-ambari-via-ambari-server-setup-security\" title=\"Permanent link\">&para;</a></h1>\n<p>Lets use FreeIPA Generated certificate for Options 1 and 4 in <code>ambari-server setup-security</code></p>\n<p><code>Security setup options...\n===========================================================================\nChoose one of the following options:\n  *[1] Enable HTTPS for Ambari server.\n  *[2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  *[4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================</code></p>\n<p><strong>Preparation:</strong> Create certificates on all ipa-client hosts (run this on each node)</p>\n<p>Ensure SELinux is not enforcing, else requesting a certificate as the root user with admin's kerberos ticket will be denied by the system and certificate will not be created. </p>\n<div class=\"highlight\"><pre><span></span><code>getenforce\n# If result is &quot;Enforcing&quot;, run the following\nsudo su\nsetenforce 0\n</code></pre></div>\n<p>Obtain kerberos ticket as <strong>admin</strong>(or an IPA Privileged User), and request a x509 certificate pair saved as \"host.key\" and \"host.crt\" on each host. </p>\n<div class=\"highlight\"><pre><span></span><code>echo BadPass#1 | kinit admin \nmkdir /etc/security/certificates/\ncd /etc/security/certificates/\nipa-getcert request -v -f /etc/security/certificates/host.crt -k /etc/security/certificates/host.key\n</code></pre></div>\n<p>List the directory to verify certificates are created. </p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo certificates]# ls -ltr /etc/security/certificates/\ntotal 8\n-rw------- 1 root root 1704 Sep 30 04:56 host.key\n-rw------- 1 root root 1724 Sep 30 04:56 host.crt\n</code></pre></div>\n<h3 id=\"21-enable-https-for-ambari-server\">2.1 Enable HTTPS for Ambari server<a class=\"headerlink\" href=\"#21-enable-https-for-ambari-server\" title=\"Permanent link\">&para;</a></h3>\n<p>If you are running Knox on this host (which is highly not recommended) changing the default port from 8443 will avoid the port conflict. </p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]$ambari-server setup-security\n\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\n\n# Enable SSL\nEnter choice, (1-5): 1\nDo you want to configure HTTPS [y/n] (y)? y\nSSL port [8443] ? 8444\nEnter path to Certificate: /etc/security/certificates/host.crt\nEnter path to Private Key: /etc/security/certificates/host.key\nPlease enter password for Private Key: changeit\n</code></pre></div>\n<h3 id=\"verify_1\">Verify<a class=\"headerlink\" href=\"#verify_1\" title=\"Permanent link\">&para;</a></h3>\n<p>Restart ambari-server. Curl Ambari on the new https port <strong>without</strong> specifying the \"-k\" flag.\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]$ curl -u admin:&quot;password&quot; https://`hostname -f`:8444/api/v1/clusters\n</code></pre></div></p>\n<h3 id=\"22-encrypt-passwords-stored-in-ambariproperties-file\">2.2 Encrypt passwords stored in ambari.properties file.<a class=\"headerlink\" href=\"#22-encrypt-passwords-stored-in-ambariproperties-file\" title=\"Permanent link\">&para;</a></h3>\n<p>This step is required for the kerberos wizard to persist the KDC credentials (<code>hadoopadmin</code>). It is also required for persisting the <code>ldapbind</code> password, without which, enabling ldaps in Ambari 2.7.1 seems to have some challenges.  </p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]# ambari-server setup-security\nUsing python  /usr/bin/python\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\nEnter choice, (1-5): 2\nPlease provide master key for locking the credential store:\nRe-enter master key:\nDo you want to persist master key. If you choose not to persist, you need to provide the Master Key while starting the ambari server as an env variable named AMBARI_SECURITY_MASTER_KEY or the start will prompt for the master key. Persist [y/n] (y)? y\nAdjusting ambari-server permissions and ownership...\nAmbari Server &#39;setup-security&#39; completed successfully.\n</code></pre></div>\n<h3 id=\"23-setup-truststore\">2.3 Setup truststore.<a class=\"headerlink\" href=\"#23-setup-truststore\" title=\"Permanent link\">&para;</a></h3>\n<p>Setting up the truststore ahead of time and restarting Ambari seems to make the ldap integration happier. \nAmbari can leverage the <code>/etc/pki/java/cacerts</code> truststore managed by IPA Clients on the hosts. This truststore contains the public CAs, along with the IPA CA, which should be the only certificates needed.    </p>\n<div class=\"highlight\"><pre><span></span><code># Example for ipa hostname: ipa.us-west-2.compute.internal\n\n[root@demo ~]# /usr/java/default/bin/keytool -list \\\n-keystore /etc/pki/java/cacerts \\\n-v -storepass changeit | grep ipa\n\nAlias name: hortonworks.comipaca\n   accessLocation: URIName: http://ipa-ca.us-west-2.compute.internal/ca/ocsp\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code>[root@demo certificates]# ambari-server setup-security\nUsing python  /usr/bin/python\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\nEnter choice, (1-5): 4\nDo you want to configure a truststore [y/n] (y)? y\nTrustStore type [jks/jceks/pkcs12] (jks):\nPath to TrustStore file :/etc/pki/java/cacerts\nPassword for TrustStore: changeit\nRe-enter password: changeit\nAmbari Server &#39;setup-security&#39; completed successfully.\n</code></pre></div>\n<h3 id=\"24-restart-ambari-for-changes-to-take-effect\">2.4 Restart Ambari for changes to take effect<a class=\"headerlink\" href=\"#24-restart-ambari-for-changes-to-take-effect\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><pre><span></span><code>ambari-server restart\n</code></pre></div>\n<p><br> </p>\n<hr />\n<h1 id=\"3-enable-kerberos-on-the-cluster\"><a name=\"section-3\"></a>3. Enable kerberos on the cluster<a class=\"headerlink\" href=\"#3-enable-kerberos-on-the-cluster\" title=\"Permanent link\">&para;</a></h1>\n<p>Enable Kerberos for cluster services via the wizard in Ambari, located in the Cluster Admin menu in the bottom left navigation panel. <a href=\"https://demo.us-west-2.compute.internal:8444/#/main/admin/kerberos\">https://demo.us-west-2.compute.internal:8444/#/main/admin/kerberos</a></p>\n<p><img alt=\"Ambari-IPA-kerberos-1\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-IPA-kerberos-1.png\" /></p>\n<p>At this point, requirements are met.The ambari-managed principals group is not required and password expiration policies should not affect the service keytabs as they have not been given passwords. The <code>hadoopadmin</code> and <code>ldapbind</code> user password will expire and need to be changed in 90 days (along with the rest of the users), but that's a good thing. See the docs for explanations <a href=\"https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/authentication-with-kerberos/content/kerberos_optional_use_an_existing_ipa.html\">https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/authentication-with-kerberos/content/kerberos_optional_use_an_existing_ipa.html</a> </p>\n<ul>\n<li>KDC host: <code>ipa.us-west-2.compute.internal</code></li>\n<li>Realm name: <code>US-WEST-2.COMPUTE.INTERNAL</code></li>\n<li>\n<p>Domain: <code>us-west-2.compute.internal</code></p>\n</li>\n<li>\n<p>Kadmin host: <code>ipa.us-west-2.compute.internal</code></p>\n</li>\n<li>Admin principal: <code>hadoopadmin</code></li>\n<li>Admin password: <code>BadPass#1</code></li>\n<li>Save Admin Credentials: true</li>\n</ul>\n<p><img alt=\"Ambari-IPA-kerberos-2\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-IPA-kerberos-2.png\" /></p>\n<p>If all goes well, go grab a beer. </p>\n<p><img alt=\"Ambari-IPA-kerberos-3\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-IPA-kerberos-3.png\" /></p>\n<p>Useful CLI for verifying the newly created Service Principals:</p>\n<div class=\"highlight\"><pre><span></span><code>#Usage: ipa service-show &lt;principal&gt;\n[root@demo ~]# ipa service-show spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Principal name: spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Principal alias: spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Keytab: True\n  Managed by: demo.us-west-2.compute.internal\n</code></pre></div>\n<hr />\n<h1 id=\"4-enable-ldap-for-ambari\"><a name=\"section-4\"></a>4. Enable LDAP For Ambari<a class=\"headerlink\" href=\"#4-enable-ldap-for-ambari\" title=\"Permanent link\">&para;</a></h1>\n<h4 id=\"freeipa-tips-for-determining-ldap-search-properties\">FreeIPA Tips for determining LDAP Search Properties<a class=\"headerlink\" href=\"#freeipa-tips-for-determining-ldap-search-properties\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>IPA Clients contain <code>/etc/ipa/default.conf</code> with various ldap server properties </p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]# cat /etc/ipa/default.conf \nbasedn = dc=us-west-2,dc=compute,dc=internal\nrealm = US-WEST-2.COMPUTE.INTERNAL\ndomain = us-west-2.compute.internal\nserver = ipa.us-west-2.compute.internal\n</code></pre></div>\n</li>\n<li>\n<p>Determining valid <strong>user</strong> attributes (posixaccount, uid, etc):</p>\n<div class=\"highlight\"><pre><span></span><code>ipa user-show hadoopadmin --raw --all\n</code></pre></div>\n</li>\n<li>\n<p>Determining valid <strong>group</strong> attributes (posixgroup, member, memberUid, etc)</p>\n<div class=\"highlight\"><pre><span></span><code>ipa group-show admins --raw --all\n</code></pre></div>\n</li>\n<li>\n<p>Verifying ldapbind account and search base via <code>ldapsearch</code></p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]# yum install -y openldap-clients\n\n# Test ldap bind properties\nAM_LDAP_SEARCHBASE=&quot;cn=accounts,dc=us-west-2,dc=compute,dc=internal&quot;\nAM_LDAP_BINDDN=&quot;uid=ldapbind,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal&quot;\nAM_LDAP_BINDDN_PW=&quot;BadPass#1&quot;\nAM_LDAP_URL=ldaps://ipa.us-west-2.compute.internal:636\n\n# Search for a valid uid and ensure the searchbase, bind dn, and ldapurl resolve properly\n[root@demo ~]# ldapsearch -D ${AM_LDAP_BINDDN} \\\n-w ${AM_LDAP_BINDDN_PW} \\\n-b ${AM_LDAP_SEARCHBASE} \\\n-H ${AM_LDAP_URL} uid=hadoopadmin\n\n# Tail results of a valid ldapsearch for a single uid:\nnumResponses: 2\nnumEntries: 1\n</code></pre></div>\n</li>\n</ul>\n<h3 id=\"41-enable-ldap-for-ambari-server\">4.1 Enable LDAP for Ambari Server<a class=\"headerlink\" href=\"#41-enable-ldap-for-ambari-server\" title=\"Permanent link\">&para;</a></h3>\n<p>Ambari 2.7.1 offers a CLI option in <code>ambari-server setup-ldap</code> for choosing ldap type as IPA, which attempts to set some of the defaults required for integration. It seems to still have a few challenges, so few of the defaults need to be change. </p>\n<p>On the ambari-server host:</p>\n<p><div class=\"highlight\"><pre><span></span><code>[root@demo certificates]# ambari-server setup-ldap\nCurrently &#39;no auth method&#39; is configured, do you wish to use LDAP instead [y/n] (y)?  \nPlease select the type of LDAP you want to use (AD, IPA, Generic LDAP):IPA\nPrimary LDAP Host (ipa.ambari.apache.org): ipa.us-west-2.compute.internal\nPrimary LDAP Port (636):\nSecondary LDAP Host &lt;Optional&gt;:\nSecondary LDAP Port &lt;Optional&gt;:\nUse SSL [true/false] (true):\nDo you want to provide custom TrustStore for Ambari [y/n] (y)?\nTrustStore type [jks/jceks/pkcs12] (jks):\nPath to TrustStore file (/etc/pki/java/cacerts):\nPassword for TrustStore: changeit\nRe-enter password: changeit\nUser object class (posixUser): posixaccount\nUser ID attribute (uid):\nGroup object class (posixGroup):\nGroup name attribute (cn):\nGroup member attribute (memberUid): member\nDistinguished name attribute (dn):\nSearch Base (dc=ambari,dc=apache,dc=org): cn=accounts,dc=us-west-2,dc=compute,dc=internal\nReferral method [follow/ignore] (follow):\nBind anonymously [true/false] (false):\nBind DN (uid=ldapbind,cn=users,cn=accounts,dc=ambari,dc=apache,dc=org): uid=ldapbind,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal\nEnter Bind DN Password: BadPass#1\nConfirm Bind DN Password: BadPass#1\nHandling behavior for username collisions [convert/skip] for LDAP sync (skip):\nForce lower-case user names [true/false]:\nResults from LDAP are paginated when requested [true/false]:\n</code></pre></div>\n- Then enter Ambari credentials (<a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/admin/BadPass/issues/1\" title=\"GitHub Issue: admin/BadPass #1\">admin/BadPass#1</a>)</p>\n<h3 id=\"42-sync-users\">4.2 Sync users<a class=\"headerlink\" href=\"#42-sync-users\" title=\"Permanent link\">&para;</a></h3>\n<p>LDAP Users must be synced by invoked a command on the Ambari Server host. User additions, and group associations made on the LDAP server will not propagate to Ambari automatically, only when this command is invoked. </p>\n<div class=\"highlight\"><pre><span></span><code>[root@demo ~]# ambari-server sync-ldap --all\nUsing python  /usr/bin/python\nSyncing with LDAP...\nEnter Ambari Admin login: admin\nEnter Ambari Admin password:\n\nFetching LDAP configuration from DB.\nSyncing all...\n\nCompleted LDAP Sync.\nSummary:\n  memberships:\n    removed = 0\n    created = 16\n  users:\n    skipped = 1\n    removed = 0\n    updated = 0\n    created = 15\n  groups:\n    updated = 0\n    removed = 0\n    created = 26\n\nAmbari Server &#39;sync-ldap&#39; completed successfully.\n</code></pre></div>\n<ul>\n<li>Now restart ambari-server</li>\n</ul>\n<h3 id=\"421-verify-user-group-associations-in-ambari\">4.2.1 Verify user group associations in Ambari<a class=\"headerlink\" href=\"#421-verify-user-group-associations-in-ambari\" title=\"Permanent link\">&para;</a></h3>\n<p>Log in to Ambari as an Admin and Navigate to Manage Ambari &gt; Users. Example user/groups from this lab:</p>\n<p><img alt=\"Ambari-IPA-usersync\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master//screenshots/Ambari-IPA-usersync.png\" /></p>\n<h3 id=\"enabling-spnego-authentication-for-hadoop\">Enabling SPNEGO Authentication for Hadoop<a class=\"headerlink\" href=\"#enabling-spnego-authentication-for-hadoop\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p>This is needed to secure the Hadoop components webUIs (e.g. Namenode UI, JobHistory UI, Yarn ResourceManager UI etc...)</p>\n</li>\n<li>\n<p>As of HDP 3.0, this is taken care of as part of setting up Kerberos via Ambari Security Wizard</p>\n</li>\n<li>\n<p>Now when you try to open any of the web UIs like below you will get <code>401: Authentication required</code></p>\n</li>\n<li>HDFS: Namenode UI</li>\n<li>Mapreduce: Job history UI</li>\n<li>YARN: Resource Manager UI</li>\n</ul>\n<hr />\n<h1 id=\"lab-5\">Lab 5<a class=\"headerlink\" href=\"#lab-5\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"ranger-install\">Ranger install<a class=\"headerlink\" href=\"#ranger-install\" title=\"Permanent link\">&para;</a></h2>\n<p>Goal: In this lab we will install Apache Ranger via Ambari and setup Ranger plugins for Hadoop components: HDFS, Hive, Hbase, YARN, Knox. We will also enable Ranger audits to Solr and HDFS</p>\n<h3 id=\"ranger-prereqs\">Ranger prereqs<a class=\"headerlink\" href=\"#ranger-prereqs\" title=\"Permanent link\">&para;</a></h3>\n<h5 id=\"create-confirm-mysql-user-root\">Create &amp; confirm MySQL user 'root'<a class=\"headerlink\" href=\"#create-confirm-mysql-user-root\" title=\"Permanent link\">&para;</a></h5>\n<p>Prepare MySQL DB for Ranger use.</p>\n<ul>\n<li>Run these steps on the node where MySQL/Hive is located. To find this, you can either:</li>\n<li>use Ambari UI or</li>\n<li>\n<p>Just run <code>mysql</code> on each node: if it returns <code>mysql: command not found</code>, move onto next node</p>\n</li>\n<li>\n<p><code>sudo mysql</code></p>\n</li>\n<li>\n<p>Execute following in the MySQL shell to create \"Ranger DB root User\" in MySQL. Ambari will use this user to create rangeradmin user.\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">USER</span><span class=\"w\"> </span><span class=\"s1\">&#39;root&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">GRANT</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\"> </span><span class=\"k\">PRIVILEGES</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;root&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"k\">WITH</span><span class=\"w\"> </span><span class=\"k\">GRANT</span><span class=\"w\"> </span><span class=\"k\">OPTION</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">PASSWORD</span><span class=\"w\"> </span><span class=\"k\">FOR</span><span class=\"w\"> </span><span class=\"s1\">&#39;root&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PASSWORD</span><span class=\"p\">(</span><span class=\"s1\">&#39;BadPass#1&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">PASSWORD</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PASSWORD</span><span class=\"p\">(</span><span class=\"s1\">&#39;BadPass#1&#39;</span><span class=\"p\">);</span>\n<span class=\"n\">FLUSH</span><span class=\"w\"> </span><span class=\"k\">PRIVILEGES</span><span class=\"p\">;</span>\n<span class=\"n\">exit</span>\n</code></pre></div></p>\n</li>\n<li>\n<p>Confirm MySQL user: <code>mysql -u root -h $(hostname -f) -p -e \"select count(user) from mysql.user;\"</code></p>\n</li>\n<li>Output should be a simple count. </li>\n<li>In case of errors, check the previous step for errors. </li>\n<li>If you encounter below error, modeify /etc/my.conf by removing <code>skip-grant-tables</code> and then restarting the service by <code>service mysqld restart</code></li>\n</ul>\n<p><code>ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement</code></p>\n<ul>\n<li>If it still does not work, try creating user admin instead. If you do this, make sure to enter admin insted of root when prompted for \"Ranger DB root User\" in Ambari</li>\n</ul>\n<h5 id=\"prepare-ambari-for-mysql\">Prepare Ambari for MySQL<a class=\"headerlink\" href=\"#prepare-ambari-for-mysql\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>Run this on Ambari node</li>\n<li>Add MySQL JAR to Ambari:</li>\n<li><code>sudo ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar</code><ul>\n<li>If the file is not present, it is available on RHEL/CentOS with: <code>sudo yum -y install mysql-connector-java</code></li>\n</ul>\n</li>\n</ul>\n<h6 id=\"setup-solr-for-ranger-audit\">Setup Solr for Ranger audit<a class=\"headerlink\" href=\"#setup-solr-for-ranger-audit\" title=\"Permanent link\">&para;</a></h6>\n<ul>\n<li>Starting HDP 2.5, if you have deployed Ambari Infra service installed, this can be used for Ranger audits.</li>\n<li>\n<p><strong>Make sure Ambari Infra service is installed and started before starting Ranger install</strong></p>\n</li>\n<li>\n<p><em>TODO</em>: add steps to install/configure Banana dashboard for Ranger Audits</p>\n</li>\n</ul>\n<h2 id=\"ranger-install_1\">Ranger install<a class=\"headerlink\" href=\"#ranger-install_1\" title=\"Permanent link\">&para;</a></h2>\n<h5 id=\"install-ranger\">Install Ranger<a class=\"headerlink\" href=\"#install-ranger\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>\n<p>Start the Ambari 'Add Service' wizard and select Ranger</p>\n</li>\n<li>\n<p>When prompted for where to install it, choose any node you like</p>\n</li>\n<li>\n<p>On the Ranger Requirements popup windows, you can check the box and continue as we have already completed the pre-requisite steps</p>\n</li>\n<li>\n<p>On the 'Customize Services' page of the wizard there are a number of tabs that need to be configured as below</p>\n</li>\n<li>\n<p>Go through each Ranger config tab, making below changes:</p>\n</li>\n<li>\n<p>Ranger Admin tab:</p>\n</li>\n<li>Ranger DB Host = FQDN of host where Mysql is running (e.g. ip-172-30-0-242.us-west-2.compute.internal)</li>\n<li>Enter passwords: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n<li>\n<p>Click 'Test Connection' button\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-1.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-2.png\" /></p>\n</li>\n<li>\n<p>Ranger User info tab</p>\n</li>\n<li>'Sync Source' = LDAP/AD </li>\n<li>\n<p>Common configs subtab</p>\n<ul>\n<li>Enter password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n</ul>\n</li>\n<li>\n<p>Ranger User info tab </p>\n</li>\n<li>\n<p>User configs subtab</p>\n<ul>\n<li>User Search Base = <code>cn=accounts,dc=us-west-2,dc=compute,dc=internal</code></li>\n<li>User Search Filter = <code>(objectcategory=posixaccount)</code></li>\n</ul>\n</li>\n<li>\n<p>Ranger User info tab </p>\n</li>\n<li>\n<p>Group configs subtab</p>\n<ul>\n<li>Make sure Group sync is disabled\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-6.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Ranger plugins tab</p>\n</li>\n<li>\n<p>Enable all plugins\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-7.png\" /></p>\n</li>\n<li>\n<p>Ranger Audits tab </p>\n</li>\n<li>SolrCloud = ON\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-8.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-9.png\" /></li>\n</ul>\n<p>7.Advanced tab\n  - No changes needed (skipping configuring Ranger authentication against AD for now)\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/ali/ranger-213-setup/ranger-213-10.png\" /></p>\n<ul>\n<li>\n<p>Click Next &gt; Proceed Anyway to proceed</p>\n</li>\n<li>\n<p>If prompted, on Configure Identities page, you may have to enter your AD admin credentials:</p>\n</li>\n<li>Admin principal: <code>hadoopadmin@LAB.HORTONWORKS.NET</code></li>\n<li>Admin password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n<li>\n<p>Notice that you can now save the admin credentials. Check this box too\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-configureidentities.png\" /></p>\n</li>\n<li>\n<p>Click Next &gt; Deploy to install Ranger</p>\n</li>\n<li>\n<p>Once installed, restart components that require restart (e.g. HDFS, YARN, Hive etc)</p>\n</li>\n<li>\n<p>(Optional) In case of failure (usually caused by incorrectly entering the Mysql nodes FQDN in the config above), delete Ranger service from Ambari and retry.</p>\n</li>\n</ul>\n<p>8 - (Optional) Enable Deny Conditions in Ranger </p>\n<p>The deny condition in policies is optional by default and must be enabled for use.</p>\n<ul>\n<li>\n<p>From Ambari&gt;Ranger&gt;Configs&gt;Advanced&gt;Custom ranger-admin-site, add : \n<code>ranger.servicedef.enableDenyAndExceptionsInPolicies=true</code></p>\n</li>\n<li>\n<p>Restart Ranger</p>\n</li>\n</ul>\n<p><a href=\"https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.1/bk_security/content/about_ranger_policies.html\">https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.1/bk_security/content/about_ranger_policies.html</a></p>\n<h5 id=\"check-ranger\">Check Ranger<a class=\"headerlink\" href=\"#check-ranger\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>Open Ranger UI at <a href=\"http://RANGERHOST_PUBLIC_IP:6080\">http://RANGERHOST_PUBLIC_IP:6080</a> using admin/admin</li>\n<li>\n<p>Confirm that repos for HDFS, YARN, Hive, HBase, Knox appear under 'Access Manager tab'\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-AccessManager.png\" /></p>\n</li>\n<li>\n<p>Confirm that audits appear under 'Audit' &gt; 'Access' tab\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audits.png\" /></p>\n</li>\n<li>\n<p>If audits do not show up here, you may need to restart Ambari Infra Solr from Ambari</p>\n</li>\n<li>\n<p>In case audits still don't show up and Ranger complains that audit collection not found: try <a href=\"https://community.hortonworks.com/articles/96618/how-to-clean-up-recreate-collections-on-ambari-inf.html\">these steps</a></p>\n</li>\n<li>\n<p>Confirm that plugins for HDFS, YARN, Hive etc appear under 'Audit' &gt; 'Plugins' tab \n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-plugins.png\" /></p>\n</li>\n<li>\n<p>Confirm users/group sync from AD into Ranger are working by clicking 'Settings' &gt; 'Users/Groups tab' in Ranger UI and noticing AD users/groups are present\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-user-groups.png\" /></p>\n</li>\n<li>\n<p>Confirm HDFS audits working by querying the audits dir in HDFS:</p>\n</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code>#### 1 authenticate\nexport PASSWORD=BadPass#1\n\n#detect name of cluster\noutput=`curl -u hadoopadmin:$PASSWORD -k -i -H &#39;X-Requested-By: ambari&#39;  https://localhost:8443/api/v1/clusters`\ncluster=`echo $output | sed -n &#39;s/.*&quot;cluster_name&quot; : &quot;\\([^\\&quot;]*\\)&quot;.*/\\1/p&#39;`\n\necho $cluster\n## this should show the name of your cluster\n\n## if not you can manully set this as below\n## cluster=Security-HWX-LabTesting-XXXX\n\n#then kinit as hdfs using the headless keytab and the principal name\nsudo -u hdfs kinit -kt /etc/security/keytabs/hdfs.headless.keytab &quot;hdfs-${cluster,,}&quot;\n\n#### 2 read audit dir in hdfs \nsudo -u hdfs hdfs dfs -cat /ranger/audit/hdfs/*/*\n</code></pre></div>\n<!---\n- Confirm Solr audits working by querying Solr REST API *from any solr node* - SKIP \n<div class=\"highlight\"><pre><span></span><code>curl &quot;http://localhost:6083/solr/ranger_audits/select?q=*%3A*&amp;df=id&amp;wt=csv&quot;\n</code></pre></div>\n\n- Confirm Banana dashboard has started to show HDFS audits - SKIP\nhttp://PUBLIC_IP_OF_SOLRLEADER_NODE:6083/solr/banana/index.html#/dashboard\n\n![Image](https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Banana-audits.png)\n--->\n<hr />\n<h1 id=\"lab-6a\">Lab 6a<a class=\"headerlink\" href=\"#lab-6a\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"ranger-kmsdata-encryption-setup\">Ranger KMS/Data encryption setup<a class=\"headerlink\" href=\"#ranger-kmsdata-encryption-setup\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>\n<p>Goal: In this lab we will install Ranger KMS via Ambari. Next we will create some encryption keys and use them to create encryption zones (EZs) and copy files into them. Reference: <a href=\"http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.4/bk_Ranger_KMS_Admin_Guide/content/ch_ranger_kms_overview.html\">docs</a></p>\n</li>\n<li>\n<p>In this section we will have to setup proxyusers. This is done to enable <em>impersonation</em> whereby a superuser can submit jobs or access hdfs on behalf of another user (e.g. because superuser has kerberos credentials but user joe doesn\u2019t have any)</p>\n</li>\n<li>\n<p>For more details on this, refer to the <a href=\"https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/Superusers.html\">doc</a></p>\n</li>\n<li>\n<p>Before starting KMS install, find and note down the below piece of information. These will be used during KMS install</p>\n</li>\n<li>\n<p>Find the internal hostname of host running <em>Mysql</em> and note it down</p>\n<ul>\n<li>From Ambari &gt; Hive &gt; Mysql &gt; click the 'Mysql Server' hyperlink. The internal hostname should appear in upper left of the page.</li>\n</ul>\n</li>\n<li>\n<p>Open Ambari &gt; start 'Add service' wizard &gt; select 'Ranger KMS'.</p>\n</li>\n<li>Pick any node to install on</li>\n<li>Keep the default configs except for </li>\n<li>\n<p>under Ambari &gt; Ranger KMS &gt; Settings tab :</p>\n<ul>\n<li>Ranger KMS DB host: <FQDN of Mysql></li>\n<li>Ranger KMS DB password: <code>BadPass#1</code> </li>\n<li>DBA password: <code>BadPass#1</code></li>\n<li>KMS master secret password: <code>BadPass#1</code>\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-KMS-enhancedconfig1.png\" /> \n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-KMS-enhancedconfig2.png\" /> </li>\n</ul>\n</li>\n<li>\n<p>Under Advanced &gt; Custom kms-site, enter below configs (Tip: to avoid adding one at a time, you can use 'bulk add' mode):</p>\n<ul>\n<li>hadoop.kms.proxyuser.oozie.users=*</li>\n<li>hadoop.kms.proxyuser.ambari.users=*</li>\n<li>hadoop.kms.proxyuser.oozie.hosts=*</li>\n<li>hadoop.kms.proxyuser.ambari.hosts=*</li>\n<li>hadoop.kms.proxyuser.keyadmin.groups=*</li>\n<li>hadoop.kms.proxyuser.keyadmin.hosts=*</li>\n<li>hadoop.kms.proxyuser.keyadmin.users=*   <br />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-KMS-proxy.png\" /> </li>\n</ul>\n</li>\n<li>\n<p>Click Next &gt; Proceed Anyway to proceed with the wizard</p>\n</li>\n<li>\n<p>If prompted, on Configure Identities page, you may have to enter your AD admin credentials:</p>\n</li>\n<li>Admin principal: <code>hadoopadmin@LAB.HORTONWORKS.NET</code></li>\n<li>Admin password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n<li>\n<p>Check the \"Save admin credentials\" checkbox</p>\n</li>\n<li>\n<p>Click Next &gt; Deploy to install RangerKMS</p>\n</li>\n<li>\n<p>Confirm these properties got populated to kms://http@(kmshostname):9292/kms</p>\n</li>\n<li>HDFS &gt; Configs &gt; Advanced core-site:<ul>\n<li>hadoop.security.key.provider.path</li>\n</ul>\n</li>\n<li>\n<p>HDFS &gt; Configs &gt; Advanced hdfs-site:</p>\n<ul>\n<li>dfs.encryption.key.provider.uri  </li>\n</ul>\n</li>\n<li>\n<p>Restart the services that require it e.g. HDFS, Mapreduce, YARN via Actions &gt; Restart All Required</p>\n</li>\n<li>\n<p>Restart Ranger and RangerKMS services.</p>\n</li>\n<li>\n<p>(Optional) Add another KMS:</p>\n</li>\n<li>Ambari &gt; Ranger KMS &gt; Service Actions &gt; Add Ranger KMS Server &gt; Pick any host\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-add-KMS.png\" /> </li>\n<li>\n<p>After it is installed, you can start it by:</p>\n<ul>\n<li>Ambari &gt; Ranger KMS &gt; Service Actions &gt; Start</li>\n</ul>\n</li>\n<li>\n<p>Once started you will see multiple KMS Servers running in Ambari:<br />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ambari-multiple-KMS.png\" /> </p>\n</li>\n</ul>\n<hr />\n<h1 id=\"lab-6b\">Lab 6b<a class=\"headerlink\" href=\"#lab-6b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"ranger-kmsdata-encryption-exercise\">Ranger KMS/Data encryption exercise<a class=\"headerlink\" href=\"#ranger-kmsdata-encryption-exercise\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>Before we can start exercising HDFS encryption, we will need to set:</li>\n<li>policy for hadoopadmin access to HDFS</li>\n<li>policy for hadoopadmin access to Hive  </li>\n<li>\n<p>policy for hadoopadmin access to the KMS keys we created</p>\n</li>\n<li>\n<p>Add the user hadoopadmin to the Ranger HDFS global policies. </p>\n<ul>\n<li>Access Manager &gt; HDFS &gt; (clustername)_hdfs   </li>\n<li>This will open the list of HDFS policies\n   <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HDFS-list.png\" /> </li>\n<li>Edit the 'all - path' global policy (the first one) and add hadoopadmin to global HDFS policy and Save \n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HDFS-add-hadoopadmin.png\" /> </li>\n<li>Your policy now includes hadoopadmin\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HDFS-list-after.png\" /> </li>\n</ul>\n</li>\n<li>\n<p>Add the user hadoopadmin to the Ranger Hive global policies. (Hive has two global policies: one on Hive tables, and one on Hive UDFs)</p>\n<ul>\n<li>Access Manager &gt; HIVE &gt; (clustername)_hive   </li>\n<li>This will open the list of HIVE policies\n<a href=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HIVE-list.png\">Image</a> </li>\n<li>Edit the 'all - database, table, column' global policy (the first one) and add hadoopadmin to global HIVE policy and Save<br />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HIVE-add-hadoopadmin-table.png\" /> </li>\n<li>Edit the 'all - database, udf' global policy (the second one) and add hadoopadmin to global HIVE policy and Save \n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HIVE-add-hadoopadmin-udf.png\" /> </li>\n<li>Your policies now includes hadoopadmin\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-HIVE-list-after.png\" /> </li>\n</ul>\n</li>\n<li>\n<p>Give keyadmin permission to view Audits screen in Ranger:</p>\n<ul>\n<li>Settings tab &gt; Permissions\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-user-permissions.png\" /></li>\n<li>Click 'Audit' to change users who have access to Audit screen</li>\n<li>Under 'Select User', add 'keyadmin' user\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-user-permissions-audits.png\" /></li>\n<li>Save</li>\n</ul>\n</li>\n<li>\n<p>Logout of Ranger</p>\n</li>\n<li>Top right &gt; admin &gt; Logout      </li>\n<li>Login to Ranger as keyadmin/keyadmin</li>\n<li>Confirm the KMS repo was setup correctly</li>\n<li>Under Service Manager &gt; KMS &gt; Click the Edit icon (next to the trash icon) to edit the KMS repo\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-edit-repo.png\" /> </li>\n<li>\n<p>Click 'Test connection' and confirm it works</p>\n</li>\n<li>\n<p>Create a key called testkey - for reference: see <a href=\"http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.5.0/bk_security/content/use_ranger_kms.html\">doc</a></p>\n</li>\n<li>Select Encryption &gt; Key Management</li>\n<li>Select KMS service &gt; pick your kms &gt; Add new Key<ul>\n<li>if an error is thrown, go back and test connection as described in previous step</li>\n</ul>\n</li>\n<li>\n<p>Create a key called <code>testkey</code> &gt; Save\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-createkey.png\" /></p>\n</li>\n<li>\n<p>Similarly, create another key called <code>testkey2</code></p>\n</li>\n<li>Select Encryption &gt; Key Management</li>\n<li>Select KMS service &gt; pick your kms &gt; Add new Key</li>\n<li>\n<p>Create a key called <code>testkey2</code> &gt; Save  </p>\n</li>\n<li>\n<p>Add user <code>hadoopadmin</code> to default KMS key policy</p>\n</li>\n<li>Click Access Manager tab</li>\n<li>\n<p>Click Service Manager &gt; KMS &gt; (clustername)_kms link\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-policy.png\" /></p>\n</li>\n<li>\n<p>Edit the default policy\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-edit-policy.png\" /></p>\n</li>\n<li>\n<p>Under 'Select User', Add <code>hadoopadmin</code> user and click Save\n   <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-policy-add-nn.png\" /></p>\n<ul>\n<li>Note that:</li>\n<li><code>hdfs</code> user  needs <code>GetMetaData</code> and <code>GenerateEEK</code> privilege - HDP 2.5</li>\n<li><code>nn</code> user  needs <code>GetMetaData</code> and <code>GenerateEEK</code> privilege - HDP 2.4</li>\n<li><code>hive</code> user needs <code>GetMetaData</code> and <code>DecryptEEK</code> privilege</li>\n</ul>\n</li>\n<li>\n<p>Run below to create a zone using the key and perform basic key and encryption zone (EZ) exercises </p>\n</li>\n<li>Create EZs using keys</li>\n<li>Copy file to EZs</li>\n<li>Delete file from EZ</li>\n<li>View contents for raw file</li>\n<li>Prevent access to raw file</li>\n<li>Copy file across EZs</li>\n<li>move hive warehouse dir to EZ</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code>#run below on Ambari node\n\nexport PASSWORD=BadPass#1\n\n#detect name of cluster\noutput=`curl -u hadoopadmin:$PASSWORD -k -i -H &#39;X-Requested-By: ambari&#39;  https://localhost:8443/api/v1/clusters`\ncluster=`echo $output | sed -n &#39;s/.*&quot;cluster_name&quot; : &quot;\\([^\\&quot;]*\\)&quot;.*/\\1/p&#39;`\n\necho $cluster\n## this should show the name of your cluster\n\n## if not you can manully set this as below\n## cluster=Security-HWX-LabTesting-XXXX\n\n#first we will run login 3 different users: hdfs, hadoopadmin, sales1\n\n#kinit as hadoopadmin and sales using BadPass#1 \nsudo -u hadoopadmin kinit\n## enter BadPass#1\nsudo -u sales1 kinit\n## enter BadPass#1\n\n#then kinit as hdfs using the headless keytab and the principal name\nsudo -u hdfs kinit -kt /etc/security/keytabs/hdfs.headless.keytab &quot;hdfs-${cluster,,}&quot;\n\n#as hadoopadmin list the keys and their metadata\nsudo -u hadoopadmin hadoop key list -metadata\n\n#as hadoopadmin create dirs for EZs\nsudo -u hadoopadmin hdfs dfs -mkdir /zone_encr\nsudo -u hadoopadmin hdfs dfs -mkdir /zone_encr2\n\n#as hdfs create 2 EZs using the 2 keys\nsudo -u hdfs hdfs crypto -createZone -keyName testkey -path /zone_encr\nsudo -u hdfs hdfs crypto -createZone -keyName testkey2 -path /zone_encr2\n# if you get &#39;RemoteException&#39; error it means you have not given namenode user permissions on testkey by creating a policy for KMS in Ranger\n\n#check EZs got created\nsudo -u hdfs hdfs crypto -listZones  \n\n#create test files\nsudo -u hadoopadmin echo &quot;My test file1&quot; &gt; /tmp/test1.log\nsudo -u hadoopadmin echo &quot;My test file2&quot; &gt; /tmp/test2.log\n\n#copy files to EZs\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test1.log /zone_encr\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test2.log /zone_encr\n\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test2.log /zone_encr2\n\n#Notice that hadoopadmin allowed to decrypt EEK but not sales user (since there is no Ranger policy allowing this)\nsudo -u hadoopadmin hdfs dfs -cat /zone_encr/test1.log\nsudo -u hadoopadmin hdfs dfs -cat /zone_encr2/test2.log\n#this should work\n\nsudo -u sales1      hdfs dfs -cat /zone_encr/test1.log\n## this should give you below error\n## cat: User:sales1 not allowed to do &#39;DECRYPT_EEK&#39; on &#39;testkey&#39;\n</code></pre></div>\n<ul>\n<li>\n<p>Check the Ranger &gt; Audit page and notice that the request from hadoopadmin was allowed but the request from sales1 was denied\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-audit.png\" /></p>\n</li>\n<li>\n<p>Now lets test deleting and copying files between EZs - (<a href=\"https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.4/bk_hdfs_admin_tools/content/copy-to-from-encr-zone.html\">Reference doc</a>)\n<div class=\"highlight\"><pre><span></span><code>#try to remove file from EZ using usual -rm command \nsudo -u hadoopadmin hdfs dfs -rm /zone_encr/test2.log\n## This works because as of HDP2.4.3 -skipTrash option no longer needs to be specified\n\n#confirm that test2.log was deleted and that zone_encr only contains test1.log\nsudo -u hadoopadmin hdfs dfs -ls  /zone_encr/\n\n#copy a file between EZs using distcp with -skipcrccheck option\nsudo -u hadoopadmin hadoop distcp -skipcrccheck -update /zone_encr2/test2.log /zone_encr/\n</code></pre></div></p>\n</li>\n<li>\n<p>Lets now look at the contents of the raw file\n<div class=\"highlight\"><pre><span></span><code>#View contents of raw file in encrypted zone as hdfs super user. This should show some encrypted characters\nsudo -u hdfs hdfs dfs -cat /.reserved/raw/zone_encr/test1.log\n\n#Prevent user hdfs from reading the file by setting security.hdfs.unreadable.by.superuser attribute. Note that this attribute can only be set on files and can never be removed.\nsudo -u hdfs hdfs dfs -setfattr -n security.hdfs.unreadable.by.superuser  /.reserved/raw/zone_encr/test1.log\n\n# Now as hdfs super user, try to read the files or the contents of the raw file\nsudo -u hdfs hdfs dfs -cat /.reserved/raw/zone_encr/test1.log\n\n## You should get below error\n##cat: Access is denied for hdfs since the superuser is not allowed to perform this operation.\n</code></pre></div></p>\n</li>\n<li>\n<p>Configure Hive for HDFS Encryption using testkey. <a href=\"http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.4/bk_hdfs_admin_tools/content/hive-access-encr.html\">Reference</a>\n<div class=\"highlight\"><pre><span></span><code>sudo -u hadoopadmin hdfs dfs -mv /apps/hive /apps/hive-old\nsudo -u hadoopadmin hdfs dfs -mkdir /apps/hive\nsudo -u hdfs hdfs crypto -createZone -keyName testkey -path /apps/hive\nsudo -u hadoopadmin hadoop distcp -skipcrccheck -update /apps/hive-old/warehouse /apps/hive/warehouse\n</code></pre></div></p>\n</li>\n<li>\n<p>To configure the Hive scratch directory (hive.exec.scratchdir) so that it resides inside the encryption zone:</p>\n</li>\n<li>Ambari &gt; Hive &gt; Configs &gt; Advanced <ul>\n<li>hive.exec.scratchdir = /apps/hive/tmp</li>\n</ul>\n</li>\n<li>\n<p>Restart Hive</p>\n</li>\n<li>\n<p>Make sure that the permissions for /apps/hive/tmp are set to 1777\n<div class=\"highlight\"><pre><span></span><code>sudo -u hdfs hdfs dfs -chmod -R 1777 /apps/hive/tmp\n</code></pre></div></p>\n</li>\n<li>\n<p>Confirm permissions by accessing the scratch dir as sales1\n<div class=\"highlight\"><pre><span></span><code>sudo -u sales1 hdfs dfs -ls /apps/hive/tmp\n## this should provide listing\n</code></pre></div></p>\n</li>\n<li>\n<p>Destroy ticket for sales1\n<div class=\"highlight\"><pre><span></span><code>sudo -u sales1 kdestroy\n</code></pre></div></p>\n</li>\n<li>\n<p>Logout of Ranger as keyadmin user</p>\n</li>\n</ul>\n<hr />\n<h1 id=\"lab-7a\">Lab 7a<a class=\"headerlink\" href=\"#lab-7a\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"secured-hadoop-exercises\">Secured Hadoop exercises<a class=\"headerlink\" href=\"#secured-hadoop-exercises\" title=\"Permanent link\">&para;</a></h2>\n<p>In this lab we will see how to interact with Hadoop components (HDFS, Hive, Hbase, Sqoop) running on a kerborized cluster and create Ranger appropriate authorization policies for access.</p>\n<ul>\n<li>We will Configure Ranger policies to:</li>\n<li>Protect /sales HDFS dir - so only sales group has access to it</li>\n<li>Protect sales hive table - so only sales group has access to it</li>\n<li>Protect sales HBase table - so only sales group has access to it</li>\n</ul>\n<h4 id=\"access-secured-hdfs\">Access secured HDFS<a class=\"headerlink\" href=\"#access-secured-hdfs\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Goal: Create a /sales dir in HDFS and ensure only users belonging to sales group (and admins) have access</p>\n</li>\n<li>\n<p>Login to Ranger (using admin/admin) and confirm the HDFS repo was setup correctly in Ranger</p>\n</li>\n<li>In Ranger &gt; Under Service Manager &gt; HDFS &gt; Click the Edit icon (next to the trash icon) to edit the HDFS repo</li>\n<li>Click 'Test connection' </li>\n<li>if it fails re-enter below fields and re-try:<ul>\n<li>Username: <code>rangeradmin@LAB.HORTONWORKS.NET</code></li>\n<li>Password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n<li>RPC Protection type: Authentication</li>\n</ul>\n</li>\n<li>\n<p>Once the test passes, click Save  </p>\n</li>\n<li>\n<p>Create /sales dir in HDFS as hadoopadmin\n<div class=\"highlight\"><pre><span></span><code>#authenticate\nsudo -u hadoopadmin kinit\n# enter password: BadPass#1\n\n#create dir and set permissions to 000\nsudo -u hadoopadmin hdfs dfs -mkdir /sales\nsudo -u hadoopadmin hdfs dfs -chmod 000 /sales\n</code></pre></div></p>\n</li>\n<li>\n<p>Now login as sales1 and attempt to access it before adding any Ranger HDFS policy\n<div class=\"highlight\"><pre><span></span><code>sudo su - sales1\n\nhdfs dfs -ls /sales\n</code></pre></div></p>\n</li>\n<li>\n<p>This fails with <code>GSSException: No valid credentials provided</code> because the cluster is kerberized and we have not authenticated yet</p>\n</li>\n<li>\n<p>Authenticate as sales1 user and check the ticket\n<div class=\"highlight\"><pre><span></span><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></div></p>\n</li>\n<li>Now try accessing the dir again as sales1\n<div class=\"highlight\"><pre><span></span><code>hdfs dfs -ls /sales\n</code></pre></div></li>\n<li>This time it fails with authorization error: </li>\n<li>\n<p><code>Permission denied: user=sales1, access=READ_EXECUTE, inode=\"/sales\":hadoopadmin:hdfs:d---------</code></p>\n</li>\n<li>\n<p>Login into Ranger UI e.g. at <a href=\"http://RANGER_HOST_PUBLIC_IP:6080/index.html\">http://RANGER_HOST_PUBLIC_IP:6080/index.html</a> as admin/admin</p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p>\n</li>\n<li>Service Type: <code>HDFS</code></li>\n<li>\n<p>User: <code>sales1</code></p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was \"Denied\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HDFS-denied.png\" /></p>\n</li>\n<li>\n<p>To create an HDFS Policy in Ranger, follow below steps:</p>\n</li>\n<li>On the 'Access Manager' tab click HDFS &gt; (clustername)_hadoop\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HDFS-policy.png\" /></li>\n<li>This will open the list of HDFS policies\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HDFS-edit-policy.png\" /></li>\n<li>\n<p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>/sales</code> dir:</p>\n<ul>\n<li>Policy Name: <code>sales dir</code></li>\n<li>Resource Path: <code>/sales</code></li>\n<li>Group: <code>sales</code></li>\n<li>Permissions : <code>Execute Read Write</code></li>\n<li>Add\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HDFS-create-policy.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30s for policy to take effect</p>\n</li>\n<li>\n<p>Now try accessing the dir again as sales1 and now there is no error seen\n<div class=\"highlight\"><pre><span></span><code>hdfs dfs -ls /sales\n</code></pre></div></p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p>\n</li>\n<li>Service Type: HDFS</li>\n<li>\n<p>User: sales1</p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HDFS-allowed.png\" />  </p>\n</li>\n<li>\n<p>You can also see the details that were captured for each request:</p>\n<ul>\n<li>Policy that allowed the access</li>\n<li>Time</li>\n<li>Requesting user</li>\n<li>Service type (e.g. hdfs, hive, hbase etc)</li>\n<li>Resource name </li>\n<li>Access type (e.g. read, write, execute)</li>\n<li>Result (e.g. allowed or denied)</li>\n<li>Access enforcer (i.e. whether native acl or ranger acls were used)</li>\n<li>Client IP</li>\n<li>Event count</li>\n</ul>\n</li>\n<li>\n<p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-policy-details.png\" />  </p>\n</li>\n<li>\n<p>Now let's check whether non-sales users can access the directory</p>\n</li>\n<li>\n<p>Logout as sales1 and log back in as hr1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></div></p>\n</li>\n<li>\n<p>Try to access the same dir as hr1 and notice it fails\n<div class=\"highlight\"><pre><span></span><code>hdfs dfs -ls /sales\n## ls: Permission denied: user=hr1, access=READ_EXECUTE, inode=&quot;/sales&quot;:hadoopadmin:hdfs:d---------\n</code></pre></div></p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and this time filter by 'Resource Name'</p>\n</li>\n<li>Service Type: <code>HDFS</code></li>\n<li>\n<p>Resource Name: <code>/sales</code></p>\n</li>\n<li>\n<p>Notice you can see the history/details of all the requests made for /sales directory:</p>\n</li>\n<li>created by hadoopadmin </li>\n<li>initial request by sales1 user was denied </li>\n<li>subsequent request by sales1 user was allowed (once the policy was created)</li>\n<li>\n<p>request by hr1 user was denied\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HDFS-summary.png\" />  </p>\n</li>\n<li>\n<p>Logout as hr1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\nlogout\n</code></pre></div></p>\n</li>\n<li>We have successfully setup an HDFS dir which is only accessible by sales group (and admins)</li>\n</ul>\n<h4 id=\"access-secured-hive\">Access secured Hive<a class=\"headerlink\" href=\"#access-secured-hive\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Goal: Setup Hive authorization policies to ensure sales users only have access to code, description columns in default.sample_07</p>\n</li>\n<li>\n<p>Enable Hive on tez by setting below and restarting Hive </p>\n</li>\n<li>\n<p>Ambari &gt; Hive &gt; Configs     </p>\n<ul>\n<li>Execution Engine = Tez</li>\n</ul>\n</li>\n<li>\n<p>Confirm the HIVE repo was setup correctly in Ranger</p>\n</li>\n<li>In Ranger &gt; Service Manager &gt; HIVE &gt; Click the Edit icon (next to the trash icon) to edit the HIVE repo</li>\n<li>Click 'Test connection' </li>\n<li>if it fails re-enter below fields and re-try:<ul>\n<li>Username: <code>rangeradmin@LAB.HORTONWORKS.NET</code></li>\n<li>Password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n</ul>\n</li>\n<li>\n<p>Once the test passes, click Save  </p>\n</li>\n<li>\n<p>Now run these steps from node where Hive (or client) is installed </p>\n</li>\n<li>\n<p>Login as sales1 and attempt to connect to default database in Hive via beeline and access sample_07 table</p>\n</li>\n<li>\n<p>Notice that in the JDBC connect string for connecting to an secured Hive while its running in default (ie binary) transport mode :</p>\n</li>\n<li>port remains 10000</li>\n<li>\n<p><em>now a kerberos principal needs to be passed in</em></p>\n</li>\n<li>\n<p>Login as sales1 without kerberos ticket and try to open beeline connection:\n<div class=\"highlight\"><pre><span></span><code>sudo su - sales1\nkdestroy\nbeeline -u &quot;jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET&quot;\n</code></pre></div></p>\n</li>\n<li>\n<p>This fails with <code>GSS initiate failed</code> because the cluster is kerberized and we have not authenticated yet</p>\n</li>\n<li>\n<p>To exit beeline:\n<div class=\"highlight\"><pre><span></span><code>!q\n</code></pre></div></p>\n</li>\n<li>Authenticate as sales1 user and check the ticket\n<div class=\"highlight\"><pre><span></span><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></div></li>\n<li>\n<p>Now try connect to Hive via beeline as sales1\n<div class=\"highlight\"><pre><span></span><code>beeline -u &quot;jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET&quot;\n</code></pre></div></p>\n</li>\n<li>\n<p>If you get the below error, it is because you did not add hive to the global KMS policy in an earlier step (along with nn, hadoopadmin). Go back and add it in.\n<div class=\"highlight\"><pre><span></span><code>org.apache.hadoop.security.authorize.AuthorizationException: User:hive not allowed to do &#39;GET_METADATA&#39; on &#39;testkey&#39;\n</code></pre></div></p>\n</li>\n<li>\n<p>This time it connects. Now try to run a query\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description from sample_07;\n</code></pre></div></p>\n</li>\n<li>Now it fails with authorization error: </li>\n<li>\n<p><code>HiveAccessControlException Permission denied: user [sales1] does not have [SELECT] privilege on [default/sample_07]</code></p>\n</li>\n<li>\n<p>Login into Ranger UI e.g. at <a href=\"http://RANGER_HOST_PUBLIC_IP:6080/index.html\">http://RANGER_HOST_PUBLIC_IP:6080/index.html</a> as admin/admin</p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p>\n</li>\n<li>Service Type: <code>Hive</code></li>\n<li>\n<p>User: <code>sales1</code></p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was <code>Denied</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HIVE-denied.png\" /></p>\n</li>\n<li>\n<p>To create an HIVE Policy in Ranger, follow below steps:</p>\n</li>\n<li>On the 'Access Manager' tab click HIVE &gt; (clustername)_hive\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-policy.png\" /></li>\n<li>This will open the list of HIVE policies\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-edit-policy.png\" /></li>\n<li>\n<p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>code</code>, <code>description</code> and <code>total_emp</code> columns in <code>sample_07</code> dir:</p>\n<ul>\n<li>Policy Name: <code>sample_07</code></li>\n<li>Hive Database: <code>default</code></li>\n<li>table: <code>sample_07</code></li>\n<li>Hive Column: <code>code</code> <code>description</code> <code>total_emp</code></li>\n<li>Group: <code>sales</code></li>\n<li>Permissions : <code>select</code></li>\n<li>Add\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-create-policy.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Notice that as you typed the name of the DB and table, Ranger was able to look these up and autocomplete them</p>\n</li>\n<li>\n<p>This was done using the rangeradmin principal we provided during Ranger install</p>\n</li>\n<li>\n<p>Also, notice that permissions are only configurable for allowing access, and you are not able to explicitly deny a user/group access to a resource unless you have enabled Deny Conditions during your Ranger install (step 8).</p>\n</li>\n<li>\n<p>Wait 30s for the new policy to be picked up</p>\n</li>\n<li>\n<p>Now try accessing the columns again and now the query works\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></div></p>\n</li>\n<li>\n<p>Note though, that if instead you try to describe the table or query all columns, it will be denied - because we only gave sales users access to two columns in the table</p>\n</li>\n<li><code>beeline&gt; desc sample_07;</code></li>\n<li>\n<p><code>beeline&gt; select * from sample_07;</code></p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p>\n</li>\n<li>Service Type: HIVE</li>\n<li>\n<p>User: sales1</p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HIVE-allowed.png\" />  </p>\n</li>\n<li>\n<p>You can also see the details that were captured for each request:</p>\n<ul>\n<li>Policy that allowed the access</li>\n<li>Time</li>\n<li>Requesting user</li>\n<li>Service type (e.g. hdfs, hive, hbase etc)</li>\n<li>Resource name </li>\n<li>Access type (e.g. read, write, execute)</li>\n<li>Result (e.g. allowed or denied)</li>\n<li>Access enforcer (i.e. whether native acl or ranger acls were used)</li>\n<li>Client IP</li>\n<li>Event count</li>\n</ul>\n</li>\n<li>\n<p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HIVE-policy-details.png\" />  </p>\n</li>\n<li>\n<p>We are also able to limit sales1's access to only subset of data by using row-level filter.  Suppose we only want to allow the sales group access to data where <code>total_emp</code> is less than 5000. </p>\n</li>\n<li>\n<p>On the Hive Policies page, select the 'Row Level Filter' tab and click on 'Add New Policy'\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-select-row-level-filter-tab.png\" />  </p>\n<ul>\n<li>Please note that in order to apply a row level filter policy the user/group must already have 'select' permissions on the table. </li>\n</ul>\n</li>\n<li>\n<p>Create a policy restricting access to only rows where <code>total_emp</code> is less than 5000:</p>\n<ul>\n<li>Policy Name: <code>sample_07_filter_total_emp</code></li>\n<li>Hive Database: <code>default</code></li>\n<li>table: <code>sample_07</code></li>\n<li>Group: <code>sales</code></li>\n<li>Permissions : <code>select</code></li>\n<li>Row Level Filter : <code>total_emp&lt;5000</code><ul>\n<li>The filter syntax is similar to what you would write after a 'WHERE' clause in a SQL query</li>\n</ul>\n</li>\n<li>Add\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-create-row-level-filter-policy.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30s for the new policy to be picked up</p>\n</li>\n<li>\n<p>Now try accessing the columns again and notice how only rows that match the filter criteria are shown\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></div></p>\n</li>\n<li>\n<p>Go back to the Ranger Audits page and notice how the filter policy was applied to the query</p>\n</li>\n<li>\n<p>Suppose we would now like to mask <code>total_emp</code> column from sales1.  This is different from denying/dis-allowing access in that the user can query the column but cannot see the actual data </p>\n</li>\n<li>\n<p>On the Hive Policies page, select the 'Masking' tab and click on 'Add New Policy'\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-select-masking-tab.png\" />  </p>\n<ul>\n<li>Please note that in order to mask a column, the user/group must already have 'select' permissions to that column.  Creating a masking policy on a column that a user does not have access to will deny the user access</li>\n</ul>\n</li>\n<li>\n<p>Create a policy masking the  <code>total_emp</code> column for <code>sales</code> group users:</p>\n<ul>\n<li>Policy Name: <code>sample_07_total_emp</code></li>\n<li>Hive Database: <code>default</code></li>\n<li>table: <code>sample_07</code></li>\n<li>Hive Column: <code>total_emp</code></li>\n<li>Group: <code>sales</code></li>\n<li>Permissions : <code>select</code></li>\n<li>\n<p>Masking Option : <code>redact</code></p>\n<ul>\n<li>Notice the different masking options available</li>\n<li>The 'Custom' masking option can use any Hive UDF as long as it returns the same data type as that of the column </li>\n</ul>\n</li>\n<li>\n<p>Add\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-create-masking-policy.png\" /></p>\n</li>\n</ul>\n</li>\n<li>\n<p>Wait 30s for the new policy to be picked up</p>\n</li>\n<li>\n<p>Now try accessing the columns again and notice how the results for the <code>total_emp</code> column is masked\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></div></p>\n</li>\n<li>\n<p>Go back to the Ranger Audits page and notice how the masking policy was applied to the query.</p>\n</li>\n<li>\n<p>Exit beeline\n<div class=\"highlight\"><pre><span></span><code>!q\n</code></pre></div></p>\n</li>\n<li>\n<p>Now let's check whether non-sales users can access the table</p>\n</li>\n<li>\n<p>Logout as sales1 and log back in as hr1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></div></p>\n</li>\n<li>Try to access the same table as hr1 and notice it fails\n<div class=\"highlight\"><pre><span></span><code>beeline -u &quot;jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET&quot;\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description from sample_07;\n</code></pre></div></li>\n<li>In Ranger, click on 'Audit' to open the Audits page and filter by 'Service Type' = 'Hive'</li>\n<li>\n<p>Service Type: <code>HIVE</code></p>\n</li>\n<li>\n<p>Here you can see the request by sales1 was allowed but hr1 was denied</p>\n</li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HIVE-summary.png\" />  </p>\n<ul>\n<li>Exit beeline\n<div class=\"highlight\"><pre><span></span><code>!q\n</code></pre></div></li>\n<li>\n<p>Logoff as hr1\n<div class=\"highlight\"><pre><span></span><code>logout\n</code></pre></div></p>\n</li>\n<li>\n<p>We have setup Hive authorization policies to ensure only sales users have access to code, description columns in default.sample_07</p>\n</li>\n</ul>\n<h4 id=\"access-secured-hbase\">Access secured HBase<a class=\"headerlink\" href=\"#access-secured-hbase\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Goal: Create a table called 'sales' in HBase and setup authorization policies to ensure only sales users have access to the table</p>\n</li>\n<li>\n<p>Run these steps from any node where Hbase Master or RegionServer services are installed </p>\n</li>\n<li>\n<p>Login as sales1\n<div class=\"highlight\"><pre><span></span><code>sudo su - sales1\n</code></pre></div></p>\n</li>\n<li>Start the hbase shell\n<div class=\"highlight\"><pre><span></span><code>hbase shell\n</code></pre></div></li>\n<li>List tables in default database\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; list &#39;default&#39;\n</code></pre></div></li>\n<li>\n<p>This fails with <code>GSSException: No valid credentials provided</code> because the cluster is kerberized and we have not authenticated yet</p>\n</li>\n<li>\n<p>To exit hbase shell:\n<div class=\"highlight\"><pre><span></span><code>exit\n</code></pre></div></p>\n</li>\n<li>Authenticate as sales1 user and check the ticket\n<div class=\"highlight\"><pre><span></span><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></div></li>\n<li>Now try connect to Hbase shell and list tables as sales1\n<div class=\"highlight\"><pre><span></span><code>hbase shell\nhbase&gt; list &#39;default&#39;\n</code></pre></div></li>\n<li>This time it works. Now try to create a table called <code>sales</code> with column family called <code>cf</code>\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; create &#39;sales&#39;, &#39;cf&#39;\n</code></pre></div></li>\n<li>Now it fails with authorization error: </li>\n<li><code>org.apache.hadoop.hbase.security.AccessDeniedException: Insufficient permissions for user 'sales1@LAB.HORTONWORKS.NET' (action=create)</code></li>\n<li>\n<p>Note: there will be a lot of output from above. The error will be on the line right after your create command</p>\n</li>\n<li>\n<p>Login into Ranger UI e.g. at <a href=\"http://RANGER_HOST_PUBLIC_IP:6080/index.html\">http://RANGER_HOST_PUBLIC_IP:6080/index.html</a> as admin/admin</p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p>\n</li>\n<li>Service Type: <code>Hbase</code></li>\n<li>\n<p>User: <code>sales1</code></p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was <code>Denied</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HBASE-denied.png\" /></p>\n</li>\n<li>\n<p>To create an HBASE Policy in Ranger, follow below steps:</p>\n</li>\n<li>On the 'Access Manager' tab click HBASE &gt; (clustername)_hbase\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HBASE-policy.png\" /></li>\n<li>This will open the list of HBASE policies\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HBASE-edit-policy.png\" /></li>\n<li>\n<p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>sales</code> table in HBase:</p>\n<ul>\n<li>Policy Name: <code>sales</code></li>\n<li>Hbase Table: <code>sales</code></li>\n<li>Hbase Column Family: <code>*</code></li>\n<li>Hbase Column: <code>*</code></li>\n<li>Group : <code>sales</code>    </li>\n<li>Permissions : <code>Admin</code> <code>Create</code> <code>Read</code> <code>Write</code></li>\n<li>Add\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HBASE-create-policy.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30s for policy to take effect</p>\n</li>\n<li>\n<p>Now try creating the table and now it works\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; create &#39;sales&#39;, &#39;cf&#39;\n</code></pre></div></p>\n</li>\n<li>\n<p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p>\n</li>\n<li>Service Type: HBASE</li>\n<li>\n<p>User: sales1</p>\n</li>\n<li>\n<p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HBASE-allowed.png\" />  </p>\n</li>\n<li>\n<p>You can also see the details that were captured for each request:</p>\n<ul>\n<li>Policy that allowed the access</li>\n<li>Time</li>\n<li>Requesting user</li>\n<li>Service type (e.g. hdfs, hive, hbase etc)</li>\n<li>Resource name </li>\n<li>Access type (e.g. read, write, execute)</li>\n<li>Result (e.g. allowed or denied)</li>\n<li>Access enforcer (i.e. whether native acl or ranger acls were used)</li>\n<li>Client IP</li>\n<li>Event count</li>\n</ul>\n</li>\n<li>\n<p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HBASE-policy-details.png\" />  </p>\n</li>\n<li>\n<p>Exit hbase shell\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; exit\n</code></pre></div></p>\n</li>\n<li>\n<p>Now let's check whether non-sales users can access the table</p>\n</li>\n<li>\n<p>Logout as sales1 and log back in as hr1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></div></p>\n</li>\n<li>Try to access the same dir as hr1 and notice this user does not even see the table\n<div class=\"highlight\"><pre><span></span><code>hbase shell\nhbase&gt; describe &#39;sales&#39;\nhbase&gt; list &#39;default&#39;\n</code></pre></div></li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-hbase-sales.png\" /></p>\n<ul>\n<li>Try to create a table as hr1 and it fails with <code>org.apache.hadoop.hbase.security.AccessDeniedException: Insufficient permissions</code>\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; create &#39;sales&#39;, &#39;cf&#39;\n</code></pre></div></li>\n<li>In Ranger, click on 'Audit' to open the Audits page and filter by:</li>\n<li>Service Type: <code>HBASE</code></li>\n<li>\n<p>Resource Name: <code>sales</code></p>\n</li>\n<li>\n<p>Here you can see the request by sales1 was allowed but hr1 was denied</p>\n</li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-HBASE-summary.png\" />  </p>\n<ul>\n<li>\n<p>Exit hbase shell\n<div class=\"highlight\"><pre><span></span><code>hbase&gt; exit\n</code></pre></div></p>\n</li>\n<li>\n<p>Logout as hr1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\nlogout\n</code></pre></div></p>\n</li>\n<li>\n<p>We have successfully created a table called 'sales' in HBase and setup authorization policies to ensure only sales users have access to the table</p>\n</li>\n<li>\n<p>This shows how you can interact with Hadoop components on kerberized cluster and use Ranger to manage authorization policies and audits</p>\n</li>\n</ul>\n<!---\n- **TODO: fix for 2.5. Skip for now** At this point your Silk/Banana audit dashboard should show audit data from multiple Hadoop components e.g. http://54.68.246.157:6083/solr/banana/index.html#/dashboard\n\n![Image](https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-banana.png)  \n--->\n\n<h4 id=\"optional-use-sqoop-to-import\">(Optional) Use Sqoop to import<a class=\"headerlink\" href=\"#optional-use-sqoop-to-import\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>If Sqoop is not already installed, install it via Ambari on same node where Mysql/Hive are installed:</li>\n<li>Admin &gt; Stacks and Versions &gt; Sqoop &gt; Add service &gt; select node where Mysql/Hive are installed and accept all defaults and finally click \"Proceed Anyway\"</li>\n<li>\n<p>You will be asked to enter admin principal/password:</p>\n<ul>\n<li><code>hadoopadmin@LAB.HORTONWORKS.NET</code></li>\n<li><a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a></li>\n</ul>\n</li>\n<li>\n<p><em>On the host running Mysql</em>: change user to root and download a sample csv and login to Mysql\n<div class=\"highlight\"><pre><span></span><code>sudo su - \nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/PII_data_small.csv\nmysql -u root -pBadPass#1\n</code></pre></div></p>\n</li>\n<li>\n<p>At the <code>mysql&gt;</code> prompt run below to: </p>\n</li>\n<li>create a table in Mysql</li>\n<li>give access to sales1</li>\n<li>import the data from csv</li>\n<li>\n<p>test that table was created\n<div class=\"highlight\"><pre><span></span><code>create database people;\nuse people;\ncreate table persons (people_id INT PRIMARY KEY, sex text, bdate DATE, firstname text, lastname text, addresslineone text, addresslinetwo text, city text, postalcode text, ssn text, id2 text, email text, id3 text);\nGRANT ALL PRIVILEGES ON people.* to &#39;sales1&#39;@&#39;%&#39; IDENTIFIED BY &#39;BadPass#1&#39;;\nLOAD DATA LOCAL INFILE &#39;~/PII_data_small.csv&#39; REPLACE INTO TABLE persons FIELDS TERMINATED BY &#39;,&#39; LINES TERMINATED BY &#39;\\n&#39;;\n\nselect people_id, firstname, lastname, city from persons where lastname=&#39;SMITH&#39;;\nexit\n</code></pre></div></p>\n</li>\n<li>\n<p>logoff as root\n<div class=\"highlight\"><pre><span></span><code>logout\n</code></pre></div></p>\n</li>\n<li>\n<p>Create Ranger policy to allow <code>sales</code> group <code>all permissions</code> on <code>persons</code> table in Hive</p>\n</li>\n<li>Access Manager &gt; Hive &gt; (cluster)_hive &gt; Add new policy</li>\n<li>\n<p>Create new policy as below and click Add:\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-create-policy-persons.png\" /> </p>\n</li>\n<li>\n<p>Create Ranger policy to allow <code>sales</code> group <code>all permissions</code> on <code>/ranger/audit/kms</code> dir in HDFS</p>\n</li>\n<li>Access Manager &gt; HDFS &gt; (cluster)_hdfs &gt; Add new policy</li>\n<li>\n<p>Create new policy as below and click Add:\n  <strong>TODO: add screenshot</strong></p>\n</li>\n<li>\n<p>Log out of Ranger</p>\n</li>\n<li>\n<p>Create Ranger policy to allow <code>sales</code> group <code>Get Metadata</code> <code>GenerateEEK</code> <code>DecryptEEK</code> permissions on <code>testkey</code> (i.e. the key used to encrypt Hive warehouse directories)</p>\n</li>\n<li>Login to Ranger <a href=\"http://RANGER_PUBLIC_IP:6080\">http://RANGER_PUBLIC_IP:6080</a> with keyadmin/keyadmin</li>\n<li>Access Manager &gt; KMS &gt; (cluster)_KMS &gt; Add new policy</li>\n<li>Create new policy as below and click Add:\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-KMS-create-policy-testkey.png\" />  </li>\n<li>\n<p>Log out of Ranger and re-login as admin/admin</p>\n</li>\n<li>\n<p>Login as sales1\n<div class=\"highlight\"><pre><span></span><code>sudo su - sales1\n</code></pre></div></p>\n</li>\n<li>\n<p>As sales1 user, kinit and run sqoop job to create persons table in Hive (in ORC format) and import data from MySQL. Below are the details of the arguments passed in:</p>\n</li>\n<li>Table: MySQL table name</li>\n<li>username: Mysql username</li>\n<li>password: Mysql password</li>\n<li>hcatalog-table: Hive table name</li>\n<li>create-hcatalog-table: hive table should be created first</li>\n<li>driver: classname for Mysql driver</li>\n<li>m: number of mappers</li>\n</ul>\n<p><div class=\"highlight\"><pre><span></span><code>kinit\n## enter BadPass#1 as password\n\nsqoop import --verbose --connect &quot;jdbc:mysql://$(hostname -f)/people&quot; --table persons --username sales1 --password BadPass#1 --hcatalog-table persons --hcatalog-storage-stanza &quot;stored as orc&quot; -m 1 --create-hcatalog-table  --driver com.mysql.jdbc.Driver\n</code></pre></div>\n- This will start a mapreduce job to import the data from Mysql to Hive in ORC format</p>\n<ul>\n<li>\n<p>Note: if the mapreduce job fails with below, most likely you have not given sales group all the permissions needed on the EK used to encrypt Hive directories \n<div class=\"highlight\"><pre><span></span><code> java.lang.RuntimeException: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure\n</code></pre></div></p>\n</li>\n<li>\n<p>Also note: if the mapreduce job fails saying sales user does not have write access to /apps/hive/warehouse, you will need to create HDFS policy allowing sales1 user and hive access on /apps/hive/warehouse dir </p>\n</li>\n<li>\n<p>Login to beeline\n<div class=\"highlight\"><pre><span></span><code>beeline -u &quot;jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET&quot;\n</code></pre></div></p>\n</li>\n<li>\n<p>Query persons table in beeline\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select * from persons;\n</code></pre></div></p>\n</li>\n<li>\n<p>Since the authorization policy is in place, the query should work</p>\n</li>\n<li>\n<p>Ranger audit should show the request was allowed:</p>\n</li>\n<li>Under Ranger &gt; Audit &gt; query for<ul>\n<li>Service type: HIVE\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-audit-persons.png\" /></li>\n</ul>\n</li>\n</ul>\n<h5 id=\"drop-encrypted-hive-tables\">Drop Encrypted Hive tables<a class=\"headerlink\" href=\"#drop-encrypted-hive-tables\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>From beeline, try to drop the persons table. \n<div class=\"highlight\"><pre><span></span><code>beeline&gt; drop table persons;\n</code></pre></div></li>\n<li>\n<p>You will get error similar to below\n<div class=\"highlight\"><pre><span></span><code>message:Unable to drop default.persons because it is in an encryption zone and trash is enabled.  Use PURGE option to skip trash.\n</code></pre></div></p>\n</li>\n<li>\n<p>To drop a Hive table (when Hive directories are located in EncryptionZone), you need to include <code>purge</code> as below:\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; drop table persons purge;\n</code></pre></div></p>\n</li>\n<li>\n<p>Destroy the ticket and logout as sales1\n<div class=\"highlight\"><pre><span></span><code>kdestroy\nlogout\n</code></pre></div></p>\n</li>\n<li>\n<p>This completes the lab. You have now interacted with Hadoop components in secured mode and used Ranger to manage authorization policies and audits</p>\n</li>\n</ul>\n<hr />\n<h1 id=\"lab-7b\">Lab 7b<a class=\"headerlink\" href=\"#lab-7b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"tag-based-policies-atlasranger-integration\">Tag-Based Policies (Atlas+Ranger Integration)<a class=\"headerlink\" href=\"#tag-based-policies-atlasranger-integration\" title=\"Permanent link\">&para;</a></h2>\n<p>Goal: In this lab we will explore how Atlas and Ranger integrate to enhance data access and authorization through tags </p>\n<h4 id=\"atlas-preparation\">Atlas Preparation<a class=\"headerlink\" href=\"#atlas-preparation\" title=\"Permanent link\">&para;</a></h4>\n<p>To create Tag-Based Policies, we will first need to create tags in Atlas and associate them to entities</p>\n<ul>\n<li>\n<p>Go to <a href=\"https://localhost:21000\">https://localhost:21000</a> and login to the Atlas UI using admin/admin for the username and pass\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-login-page.png\" /></p>\n</li>\n<li>\n<p>Select the \"TAGS\" tab and click on \"Create Tag\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-select-create-tag.png\" /></p>\n</li>\n<li>\n<p>Create a new tag by inputing</p>\n<ul>\n<li>Name: <code>Private</code></li>\n<li>Create\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-create-tag.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Repeat the tag creation process above and create an additional tag named \"Restricted\" </p>\n</li>\n<li>\n<p>Create a third tag named \"Sensitive\", however, during creation, click on \"Add New Attributes\" and input:</p>\n<ul>\n<li>Attribute Name: <code>level</code></li>\n<li>Type: <code>int</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-sensitive-tag-creation.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Create a fourth tag named \"EXPIRES_ON\", and during creation, click on \"Add New Attributes\" and input:</p>\n<ul>\n<li>Attribute Name: <code>expiry_date</code></li>\n<li>Type: <code>int</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-expires-on-tag-creation.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Under the \"Tags\" tab in the main screen you should see the list of newly created tags\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-created-tags.png\" /></p>\n</li>\n<li>\n<p>In the search tab search using the following:</p>\n<ul>\n<li>Search By Type: <code>hive_table</code></li>\n<li>Search By Text: <code>sample_08</code></li>\n<li>Search\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-search-table.png\" /></li>\n</ul>\n</li>\n<li>\n<p>To associate a tag to the \"sample_08\" table, click on the \"+\" under the Tags column in the search results for \"sample_08\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-search-result.png\" /></p>\n</li>\n<li>\n<p>From the dropdown select <code>Private</code> and click <code>Add</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-attach-tag.png\" /></p>\n</li>\n<li>\n<p>You should see that the \"Private\" tag has been associated to the \"sample_08\" table\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-associated-table-tags.png\" /></p>\n</li>\n<li>\n<p>Now, in the same manner, associate the \"EXPIRES_ON\" tag to the \"sample_08\" table\n    When prompted, select a date in the past for \"expiry_date\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-tag-item-expires-on.png\" /></p>\n</li>\n<li>\n<p>In the search results panel, click on the \"sample_08\" link\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-search-table.png\" /></p>\n</li>\n<li>\n<p>Scroll down and select the \"Schema\" tab\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-select-table-schema.png\" /></p>\n</li>\n<li>\n<p>Select the \"+\" button under the Tag column for \"salary\" and associate the <code>Restricted</code> tag to it</p>\n</li>\n<li>\n<p>Select the \"+\" button under the Tag column for \"total_emp\" and associate the <code>Sensitive</code> tag to it</p>\n<ul>\n<li>When prompted, input <code>5</code> for the \"level\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-tag-item-sensitive.png\" /></li>\n</ul>\n</li>\n<li>\n<p>On the \"sample_08\" table schema page you should see the table columns with the associated tags\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Atlas-associated-column-tags.png\" /></p>\n</li>\n</ul>\n<p>We have now completed our preparation work in Atlas and have created the following tags and associations:\n    - \"Private\" tag associated to \"sample_08\" table\n    - \"Sensitive\" tag with a \"level\" of '5', associated to \"sample_08.total_emp\" column\n    - \"Restricted\" tag associated to \"sample_08.salary\" column</p>\n<h4 id=\"ranger-preparation\">Ranger Preparation<a class=\"headerlink\" href=\"#ranger-preparation\" title=\"Permanent link\">&para;</a></h4>\n<p>To enable Ranger for Tag-Based Policies complete the following:</p>\n<ul>\n<li>\n<p>Select \"Access Manager\" and then \"Tag Based Policies\" from the upper left hand corner of the main Ranger UI page\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-navigate-to-tag-based-policies.png\" /></p>\n</li>\n<li>\n<p>Click on the \"+\" to create a new tag service\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-create-tag-service.png\" /></p>\n</li>\n<li>\n<p>In the tag service page input:</p>\n<ul>\n<li>Service Name: <code>tags</code></li>\n<li>Save\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-save-tag-service.png\" /></li>\n</ul>\n</li>\n<li>\n<p>On the Ranger UI main page, select the edit button next to your (clustername)_hive service\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-HIVE-policy.png\" /></p>\n</li>\n<li>\n<p>In the Edit Service page add the below and then click save</p>\n<ul>\n<li>Select Tag Service: <code>tags</code>\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-add-hive-tag-service.png\" /></li>\n</ul>\n</li>\n</ul>\n<p>We should now be able to create Tag-Based Policies for Hive</p>\n<h4 id=\"tag-based-access-control\">Tag-Based Access Control<a class=\"headerlink\" href=\"#tag-based-access-control\" title=\"Permanent link\">&para;</a></h4>\n<p>Goal: Create a Tag-Based policy for sales to access all entities tagged as \"Private\"</p>\n<ul>\n<li>\n<p>Select \"Access Manager\" and then \"Tag Based Policies\" from the upper left hand corner of the main Ranger UI page\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-navigate-to-tag-based-policies.png\" /></p>\n</li>\n<li>\n<p>Select the \"tags\" service that you had previously created</p>\n</li>\n<li>\n<p>On the \"tags Policies\" page, click on \"Add New Policy\"\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-policy-list-1.png\" /></p>\n</li>\n<li>\n<p>Input the following to create the new policy</p>\n<ul>\n<li>Policy Name: <code>Private Data Access</code></li>\n<li>TAG: <code>Private</code></li>\n<li>Under \"Allow Conditions\"<ul>\n<li>Select Group: <code>sales</code></li>\n<li>Component Permissions: (select <code>Hive</code> and enable all actions)</li>\n</ul>\n</li>\n<li>Add\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-tbac.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-component-permissions.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Run these steps from node where Hive (or client) is installed </p>\n</li>\n<li>\n<p>From node where Hive (or client) is installed, login as sales1 and connect to beeline:\n<div class=\"highlight\"><pre><span></span><code>su - sales1\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code>beeline -u &quot;jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET&quot;\n</code></pre></div></p>\n</li>\n<li>Now try accessing table \"sample_08\" and notice how you have access to all the contents of the table\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select * from sample_08;\n</code></pre></div></li>\n</ul>\n<h4 id=\"attribute-based-access-control\">Attribute-Based Access Control<a class=\"headerlink\" href=\"#attribute-based-access-control\" title=\"Permanent link\">&para;</a></h4>\n<p>Goal: Disallow everybody's access to data tagged as \"Sensitive\" and has an attribute \"level\" 5 or above</p>\n<ul>\n<li>\n<p>Return to the Ranger \"tags Policies\" page and \"Add New Policy\" with the below parameters</p>\n<ul>\n<li>Policy Name: <code>Sensitive Data Access</code></li>\n<li>TAG: <code>Sensitive</code></li>\n<li>Under \"Deny Conditions\" <ul>\n<li>Select Group: <code>public</code></li>\n<li>Policy Conditions/Enter boolean expression: <code>level&gt;=5</code><ul>\n<li>Note: Boolean expressions are written in Javascript</li>\n</ul>\n</li>\n<li>Component Permissions: (select <code>Hive</code> and enable all actions)</li>\n</ul>\n</li>\n<li>Add\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-abac-1.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-abac-2.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30 seconds before trying to access the \"total_emp\" column in table \"sample_08\" and notice how you are denied access\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select total_emp from sample_08;\n</code></pre></div></p>\n</li>\n<li>\n<p>Now try to access the other columns and notice how you are allowed access to them access\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></div></p>\n</li>\n</ul>\n<h4 id=\"tag-based-masking\">Tag-Based Masking<a class=\"headerlink\" href=\"#tag-based-masking\" title=\"Permanent link\">&para;</a></h4>\n<p>Goal: Mask data tagged as \"Restricted\"</p>\n<ul>\n<li>\n<p>Return to the Ranger \"tags Policies\" page, click on the \"Masking\" tab in the upper right hand \n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-tbm-tab.png\" /></p>\n</li>\n<li>\n<p>Click on \"Add New Policy\" and input the below parameters</p>\n<ul>\n<li>Policy Name: <code>Restricted Data Access</code></li>\n<li>TAG: <code>Restricted</code></li>\n<li>Under \"Mask Conditions\" <ul>\n<li>Select Group: <code>public</code></li>\n<li>Component Permissions: (select <code>Hive</code> and enable all actions)</li>\n<li>Select Masking Option: <code>Redact</code>   </li>\n</ul>\n</li>\n<li>Add</li>\n</ul>\n</li>\n<li>\n<p>Wait 30 seconds and try run the below query.  Notice how salary data has been masked\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></div></p>\n</li>\n</ul>\n<h4 id=\"location-based-access-control\">Location-Based Access Control<a class=\"headerlink\" href=\"#location-based-access-control\" title=\"Permanent link\">&para;</a></h4>\n<p>Goal: Restrict access to data based on a user's physical location at the time.</p>\n<ul>\n<li>\n<p>Return to the Ranger \"tags Policies\" page (\"Access\" tab) and \"Add New Policy\" with the below parameters</p>\n<ul>\n<li>Policy Name: <code>Geo-Location Access</code></li>\n<li>TAG: <code>Restricted</code></li>\n<li>Under \"Deny Conditions\" <ul>\n<li>Select Group: <code>public</code></li>\n<li>Policy Conditions/Enter boolean expression: <code>country_code=='USA'</code><ul>\n<li>If you are outside of USA use <code>country_code!='USA'</code> instead</li>\n</ul>\n</li>\n<li>Component Permissions: (select <code>Hive</code> and enable all actions)</li>\n</ul>\n</li>\n<li>Add\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-lba-1.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-lba-2.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30 seconds and try run the below query.  Notice how you are now denied access to the \"salary\" column because of your location\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></div></p>\n</li>\n</ul>\n<h4 id=\"time-based-policies\">Time-Based Policies<a class=\"headerlink\" href=\"#time-based-policies\" title=\"Permanent link\">&para;</a></h4>\n<p>Goal: To place an expiry date on sales' access policy to data tagged as \"Private\" after which access will be denied</p>\n<ul>\n<li>\n<p>Return to the Ranger \"tags Policies\" page (\"Access\" tab)and \"Add New Policy\" with the below parameters.  You may already have default policy named \"EXPIRES_ON\", if so, please delete it before clicking \"Add New Policy\" </p>\n<ul>\n<li>Policy Name: <code>EXPIRES_ON</code></li>\n<li>TAG: <code>EXPIRES_ON</code></li>\n<li>Under \"Deny Conditions\" <ul>\n<li>Select Group: <code>public</code></li>\n<li>Policy Conditions/Accessed after expiry_date: <code>yes</code></li>\n<li>Component Permissions: (select <code>Hive</code> and enable all actions)</li>\n</ul>\n</li>\n<li>Add\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-eo-1.png\" />\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Tags-create-eo-2.png\" /></li>\n</ul>\n</li>\n<li>\n<p>Wait 30 seconds and try run the below query.  Notice how you are now denied access to the entire \"sample_08\" table because it is accessed after the expiry date tagged in Atlas\n<div class=\"highlight\"><pre><span></span><code>beeline&gt; select code, description from sample_08;\n</code></pre></div></p>\n</li>\n<li>\n<p>Exit beeline\n<div class=\"highlight\"><pre><span></span><code>!q\n</code></pre></div></p>\n</li>\n<li>Logoff as sales1\n<div class=\"highlight\"><pre><span></span><code>logout\n</code></pre></div></li>\n</ul>\n<h2 id=\"policy-evaluation-and-precedence\">Policy Evaluation and Precedence<a class=\"headerlink\" href=\"#policy-evaluation-and-precedence\" title=\"Permanent link\">&para;</a></h2>\n<p>Notice how in the policies above, ones that deny access always take precedence over ones that allow access.  For example, even though sales had access to \"Private\" data in the Tag-Based Access Control section, they were gradually disallowed access over the following sections as we set up \"Deny\" policies.  This applies to both, Tag-Based as well as Resource-Based policies.  To understand better the sequence of policy evaluation, take a look at the following flow-chart.\n<img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-Policy-Evaluation-Flow-with-Tags.png\" /></p>\n<hr />\n<h1 id=\"lab-8\">Lab 8<a class=\"headerlink\" href=\"#lab-8\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"knox\">Knox<a class=\"headerlink\" href=\"#knox\" title=\"Permanent link\">&para;</a></h2>\n<p>Goal: In this lab we will configure Apache Knox for AD authentication and make WebHDFS, Hive requests over Knox (after setting the appropriate Ranger authorization polices for access)</p>\n<h3 id=\"knox-configuration\">Knox Configuration<a class=\"headerlink\" href=\"#knox-configuration\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"knox-configuration-for-ad-authentication\">Knox Configuration for AD authentication<a class=\"headerlink\" href=\"#knox-configuration-for-ad-authentication\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>Run these steps on the node where Knox was installed earlier</p>\n</li>\n<li>\n<p>To configure Knox for AD authentication we need to enter AD related properties in topology xml via Ambari</p>\n</li>\n<li>\n<p>The problem is it requires us to enter LDAP bind password, but we do not want it exposed as plain text in the Ambari configs</p>\n</li>\n<li>\n<p>The solution? Create keystore alias for the ldap manager user (which you will later pass in to the topology via the 'systemUsername' property)</p>\n</li>\n<li>Read password for use in following command (this will prompt you for a password and save it in knoxpass environment variable). Enter <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a>:\n   <div class=\"highlight\"><pre><span></span><code>read -s -p &quot;Password: &quot; knoxpass\n</code></pre></div></li>\n<li>\n<p>This is a handy way to set an env var without storing the command in your history</p>\n</li>\n<li>\n<p>Create password alias for Knox called knoxLdapSystemPassword\n   <div class=\"highlight\"><pre><span></span><code>sudo -u knox /usr/hdp/current/knox-server/bin/knoxcli.sh create-alias knoxLdapSystemPassword --cluster default --value ${knoxpass}\nunset knoxpass\n</code></pre></div></p>\n</li>\n<li>\n<p>Now lets configure Knox to use our AD for authentication. Replace below content in Ambari &gt; Knox &gt; Config &gt; Advanced topology. </p>\n</li>\n<li>\n<p>How to tell what configs were changed from defaults? </p>\n<ul>\n<li>Default configs remain indented below</li>\n<li>Configurations that were added/modified are not indented\n<div class=\"highlight\"><pre><span></span><code>&lt;topology&gt;\n\n            &lt;gateway&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;authentication&lt;/role&gt;\n                    &lt;name&gt;ShiroProvider&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;sessionTimeout&lt;/name&gt;\n                        &lt;value&gt;30&lt;/value&gt;\n                    &lt;/param&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;main.ldapRealm&lt;/name&gt;\n                        &lt;value&gt;org.apache.hadoop.gateway.shirorealm.KnoxLdapRealm&lt;/value&gt;\n                    &lt;/param&gt;\n\n&lt;!-- changes for AD/user sync --&gt;\n\n&lt;param&gt;\n    &lt;name&gt;main.ldapContextFactory&lt;/name&gt;\n    &lt;value&gt;org.apache.hadoop.gateway.shirorealm.KnoxLdapContextFactory&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- main.ldapRealm.contextFactory needs to be placed before other main.ldapRealm.contextFactory* entries  --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory&lt;/name&gt;\n    &lt;value&gt;$ldapContextFactory&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- IPA url --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.url&lt;/name&gt;\n    &lt;value&gt;ldap://ipa.us-west-2.compute.internal:389&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- system user --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.systemUsername&lt;/name&gt;\n    &lt;value&gt;uid=hadoopadmin,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- pass in the password using the alias created earlier --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.systemPassword&lt;/name&gt;\n    &lt;value&gt;${ALIAS=knoxLdapSystemPassword}&lt;/value&gt;\n&lt;/param&gt;\n\n                    &lt;param&gt;\n                        &lt;name&gt;main.ldapRealm.contextFactory.authenticationMechanism&lt;/name&gt;\n                        &lt;value&gt;simple&lt;/value&gt;\n                    &lt;/param&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;urls./**&lt;/name&gt;\n                        &lt;value&gt;authcBasic&lt;/value&gt;\n                    &lt;/param&gt;\n\n&lt;!--  AD groups of users to allow --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.searchBase&lt;/name&gt;\n    &lt;value&gt;cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.userObjectClass&lt;/name&gt;\n    &lt;value&gt;posixAccount&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.userSearchAttributeName&lt;/name&gt;\n    &lt;value&gt;uid&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- changes needed for group sync--&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.authorizationEnabled&lt;/name&gt;\n    &lt;value&gt;true&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupSearchBase&lt;/name&gt;\n    &lt;value&gt;cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupObjectClass&lt;/name&gt;\n    &lt;value&gt;posixGroup&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupIdAttribute&lt;/name&gt;\n    &lt;value&gt;cn&lt;/value&gt;\n&lt;/param&gt;\n\n\n                &lt;/provider&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;identity-assertion&lt;/role&gt;\n                    &lt;name&gt;Default&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                &lt;/provider&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;authorization&lt;/role&gt;\n                    &lt;name&gt;XASecurePDPKnox&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                &lt;/provider&gt;\n\n&lt;!--\n  Knox HaProvider for Hadoop services\n  --&gt;\n&lt;provider&gt;\n     &lt;role&gt;ha&lt;/role&gt;\n     &lt;name&gt;HaProvider&lt;/name&gt;\n     &lt;enabled&gt;true&lt;/enabled&gt;\n     &lt;param&gt;\n         &lt;name&gt;OOZIE&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;HBASE&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;WEBHCAT&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;WEBHDFS&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;maxRetryAttempts=300;retrySleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n        &lt;name&gt;HIVE&lt;/name&gt;\n        &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true;zookeeperEnsemble=machine1:2181,machine2:2181,machine3:2181;\n       zookeeperNamespace=hiveserver2&lt;/value&gt;\n     &lt;/param&gt;\n&lt;/provider&gt;\n&lt;!--\n  END Knox HaProvider for Hadoop services\n  --&gt;\n\n\n            &lt;/gateway&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;NAMENODE&lt;/role&gt;\n                &lt;url&gt;hdfs://{{namenode_host}}:{{namenode_rpc_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;JOBTRACKER&lt;/role&gt;\n                &lt;url&gt;rpc://{{rm_host}}:{{jt_rpc_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHDFS&lt;/role&gt;\n                &lt;url&gt;http://{{namenode_host}}:{{namenode_http_port}}/webhdfs&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHCAT&lt;/role&gt;\n                &lt;url&gt;http://{{webhcat_server_host}}:{{templeton_port}}/templeton&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;OOZIE&lt;/role&gt;\n                &lt;url&gt;http://{{oozie_server_host}}:{{oozie_server_port}}/oozie&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHBASE&lt;/role&gt;\n                &lt;url&gt;http://{{hbase_master_host}}:{{hbase_master_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;HIVE&lt;/role&gt;\n                &lt;url&gt;http://{{hive_server_host}}:{{hive_http_port}}/{{hive_http_path}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;RESOURCEMANAGER&lt;/role&gt;\n                &lt;url&gt;http://{{rm_host}}:{{rm_port}}/ws&lt;/url&gt;\n            &lt;/service&gt;\n        &lt;/topology&gt;\n</code></pre></div></li>\n</ul>\n</li>\n<li>\n<p>Then restart Knox via Ambari</p>\n</li>\n</ul>\n<h4 id=\"hdfs-configuration-for-knox\">HDFS Configuration for Knox<a class=\"headerlink\" href=\"#hdfs-configuration-for-knox\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>Tell Hadoop to allow our users to access Knox from any node of the cluster. Modify the below properties under Ambari &gt; HDFS &gt; Config &gt; Custom core-site  ('users' group should already part of the groups so just add the rest)</li>\n<li>hadoop.proxyuser.knox.groups=users,hadoop-admins,sales,hr,legal</li>\n<li>hadoop.proxyuser.knox.hosts=*<ul>\n<li>(better would be to put a comma separated list of the FQDNs of the hosts)</li>\n</ul>\n</li>\n<li>Now restart HDFS</li>\n<li>Without this step you will see an error like below when you run the WebHDFS request later on:\n  <div class=\"highlight\"><pre><span></span><code> org.apache.hadoop.security.authorize.AuthorizationException: User: knox is not allowed to impersonate sales1&quot;\n</code></pre></div></li>\n</ul>\n<h4 id=\"ranger-configuration-for-webhdfs-over-knox\">Ranger Configuration for WebHDFS over Knox<a class=\"headerlink\" href=\"#ranger-configuration-for-webhdfs-over-knox\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>Setup a Knox policy for sales group for WEBHDFS by:</li>\n<li>Login to Ranger &gt; Access Manager &gt; KNOX &gt; click the cluster name link &gt; Add new policy</li>\n<li>Policy name: webhdfs</li>\n<li>Topology name: default</li>\n<li>Service name: WEBHDFS</li>\n<li>Group permissions: sales </li>\n<li>Permission: check Allow</li>\n<li>Add</li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-knox-webhdfs-policy.png\" /></p>\n<h4 id=\"webhdfs-over-knox-exercises\">WebHDFS over Knox exercises<a class=\"headerlink\" href=\"#webhdfs-over-knox-exercises\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>Now we can post some requests to WebHDFS over Knox to check its working. We will use curl with following arguments:</li>\n<li>-i (aka \u2013include): used to output HTTP response header information. This will be important when the content of the HTTP Location header is required for subsequent requests.</li>\n<li>-k (aka \u2013insecure) is used to avoid any issues resulting from the use of demonstration SSL certificates.</li>\n<li>-u (aka \u2013user) is used to provide the credentials to be used when the client is challenged by the gateway.</li>\n<li>\n<p>Note that most of the samples do not use the cookie features of cURL for the sake of simplicity. Therefore we will pass in user credentials with each curl request to authenticate.</p>\n</li>\n<li>\n<p><em>From the host where Knox is running</em>, send the below curl request to 8443 port where Knox is running to run <code>ls</code> command on <code>/</code> dir in HDFS:\n<div class=\"highlight\"><pre><span></span><code>curl -ik -u sales1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></div></p>\n</li>\n<li>\n<p>This should return json object containing list of dirs/files located in root dir and their attributes</p>\n</li>\n<li>\n<p>To avoid passing password on command prompt you can pass in just the username (to avoid having the password captured in the shell history). In this case, you will be prompted for the password<br />\n<div class=\"highlight\"><pre><span></span><code>curl -ik -u sales1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n\n## enter BadPass#1\n</code></pre></div></p>\n</li>\n<li>\n<p>For the remaining examples below, for simplicity, we are passing in the password on the command line, but feel free to remove the password and enter it in manually when prompted</p>\n</li>\n<li>\n<p>Try the same request as hr1 and notice it fails with <code>Error 403 Forbidden</code> :</p>\n</li>\n<li>\n<p>This is expected since in the policy above, we only allowed sales group to access WebHDFS over Knox\n<div class=\"highlight\"><pre><span></span><code>curl -ik -u hr1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></div></p>\n</li>\n<li>\n<p>Notice that to make the requests over Knox, a kerberos ticket is not needed - the user authenticates by passing in AD/LDAP credentials</p>\n</li>\n<li>\n<p>Check in Ranger Audits to confirm the requests were audited:</p>\n</li>\n<li>Ranger &gt; Audit &gt; Service type: KNOX</li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-knox-webhdfs-audit.png\" /></p>\n<ul>\n<li>\n<p>Other things to access WebHDFS with Knox</p>\n</li>\n<li>\n<p>A. Use cookie to make request without passing in credentials</p>\n<ul>\n<li>When you ran the previous curl request it would have listed HTTP headers as part of output. One of the headers will be 'Set Cookie'</li>\n<li>e.g. <code>Set-Cookie: JSESSIONID=xxxxxxxxxxxxxxx;Path=/gateway/default;Secure;HttpOnly</code></li>\n<li>You can pass in the value from your setup and make the request without passing in credentials:</li>\n<li>Make sure you copy the JSESSIONID from a request that worked (i.e the one from sales1 not hr1)\n  <div class=\"highlight\"><pre><span></span><code>curl -ik --cookie &quot;JSESSIONID=xxxxxxxxxxxxxxx;Path=/gateway/default;Secure;HttpOnly&quot; -X GET https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></div></li>\n</ul>\n</li>\n<li>\n<p>B. Open file via WebHDFS</p>\n<ul>\n<li>Sample command to list files under /tmp:\n<div class=\"highlight\"><pre><span></span><code>curl -ik -u sales1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/tmp?op=LISTSTATUS\n</code></pre></div></li>\n<li>You can run below command to create a test file into /tmp</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code>echo &quot;Test file&quot; &gt; /tmp/testfile.txt\nsudo -u sales1 kinit\n## enter BadPass#1\nsudo -u sales1 hdfs dfs -put /tmp/testfile.txt /tmp\nsudo -u sales1 kdestroy\n</code></pre></div>\n<ul>\n<li>Open this file via WebHDFS \n<div class=\"highlight\"><pre><span></span><code>curl -ik -u sales1:BadPass#1 -X GET https://localhost:8443/gateway/default/webhdfs/v1/tmp/testfile.txt?op=OPEN\n</code></pre></div></li>\n<li>\n<p>Look at value of Location header. This will contain a long url \n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/knox-location.png\" /></p>\n</li>\n<li>\n<p>Access contents of file /tmp/testfile.txt by passing the value from the above Location header\n<div class=\"highlight\"><pre><span></span><code>curl -ik -u sales1:BadPass#1 -X GET &#39;{https://localhost:8443/gateway/default/webhdfs/data/v1/webhdfs/v1/tmp/testfile.txt?_=AAAACAAAABAAAAEwvyZNDLGGNwahMYZKvaHHaxymBy1YEoe4UCQOqLC7o8fg0z6845kTvMQN_uULGUYGoINYhH5qafY_HjozUseNfkxyrEo313-Fwq8ISt6MKEvLqas1VEwC07-ihmK65Uac8wT-Cmj2BDab5b7EZx9QXv29BONUuzStCGzBYCqD_OIgesHLkhAM6VNOlkgpumr6EBTuTnPTt2mYN6YqBSTX6cc6OhX73WWE6atHy-lv7aSCJ2I98z2btp8XLWWHQDmwKWSmEvtQW6Aj-JGInJQzoDAMnU2eNosdcXaiYH856zC16IfEucdb7SA_mqAymZuhm8lUCvL25hd-bd8p6mn1AZlOn92VySGp2TaaVYGwX-6L9by73bC6sIdi9iKPl3Iv13GEQZEKsTm1a96Bh6ilScmrctk3zmY4vBYp2SjHG9JRJvQgr2XzgA}&#39;\n</code></pre></div></p>\n</li>\n</ul>\n</li>\n<li>\n<p>C. Use groovy scripts to access WebHDFS</p>\n<ul>\n<li>Edit the groovy script to set:</li>\n<li>gateway = \"<a href=\"https://localhost:8443/gateway/default\">https://localhost:8443/gateway/default</a>\"\n<div class=\"highlight\"><pre><span></span><code>sudo vi /usr/hdp/current/knox-server/samples/ExampleWebHdfsLs.groovy\n</code></pre></div></li>\n<li>Run the script and enter credentials when prompted username: sales1 and password: <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/wgzhao/BadPass/issues/1\" title=\"GitHub Issue: wgzhao/BadPass #1\">BadPass#1</a>\n<div class=\"highlight\"><pre><span></span><code>sudo java -jar /usr/hdp/current/knox-server/bin/shell.jar /usr/hdp/current/knox-server/samples/ExampleWebHdfsLs.groovy\n</code></pre></div></li>\n<li>Notice output show list of dirs in HDFS\n<div class=\"highlight\"><pre><span></span><code>[app-logs, apps, ats, hdp, mapred, mr-history, ranger, tmp, user, zone_encr]\n</code></pre></div></li>\n</ul>\n</li>\n<li>\n<p>D. Access via browser </p>\n<ul>\n<li>Take the same url we have been hitting via curl and replace localhost with public IP of Knox node (remember to use https!) e.g. <strong>https</strong>://PUBLIC_IP_OF_KNOX_HOST:8443/gateway/default/webhdfs/v1?op=LISTSTATUS</li>\n<li>Open the URL via browser</li>\n<li>Login as <a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/sales1/BadPass/issues/1\" title=\"GitHub Issue: sales1/BadPass #1\">sales1/BadPass#1</a></li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/knox-webhdfs-browser1.png\" />\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/knox-webhdfs-browser2.png\" />\n <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/knox-webhdfs-browser3.png\" /></p>\n</li>\n<li>\n<p>We have shown how you can use Knox to avoid the end user from having to know about internal details of cluster</p>\n</li>\n<li>whether its kerberized or not</li>\n<li>what the cluster topology is (e.g. what node WebHDFS was running)</li>\n</ul>\n<h4 id=\"hive-over-knox\">Hive over Knox<a class=\"headerlink\" href=\"#hive-over-knox\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"configure-hive-for-knox\">Configure Hive for Knox<a class=\"headerlink\" href=\"#configure-hive-for-knox\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>In Ambari, under Hive &gt; Configs &gt; set the below and restart Hive component.</li>\n<li>hive.server2.transport.mode = http</li>\n<li>Give users access to jks file.</li>\n<li>This is only for testing since we are using a self-signed cert.</li>\n<li>This only exposes the truststore, not the keys.\n<div class=\"highlight\"><pre><span></span><code>sudo chmod o+x /usr/hdp/current/knox-server /usr/hdp/current/knox-server/data /usr/hdp/current/knox-server/data/security /usr/hdp/current/knox-server/data/security/keystores\nsudo chmod o+r /usr/hdp/current/knox-server/data/security/keystores/gateway.jks\n</code></pre></div></li>\n</ul>\n<h5 id=\"ranger-configuration-for-hive-over-knox\">Ranger Configuration for Hive over Knox<a class=\"headerlink\" href=\"#ranger-configuration-for-hive-over-knox\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>Setup a Knox policy for sales group for HIVE by:</li>\n<li>Login to Ranger &gt; Access Manager &gt; KNOX &gt; click the cluster name link &gt; Add new policy</li>\n<li>Policy name: hive</li>\n<li>Topology name: default</li>\n<li>Service name: HIVE</li>\n<li>Group permissions: sales </li>\n<li>Permission: check Allow</li>\n<li>Add</li>\n</ul>\n<p><img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-knox-hive-policy.png\" /></p>\n<h5 id=\"use-hive-for-knox\">Use Hive for Knox<a class=\"headerlink\" href=\"#use-hive-for-knox\" title=\"Permanent link\">&para;</a></h5>\n<ul>\n<li>\n<p>By default Knox will use a self-signed (untrusted) certificate. To trust the certificate:</p>\n<ul>\n<li>First on Knox node, create the /tmp/knox.crt certificate</li>\n</ul>\n</li>\n</ul>\n<p><div class=\"highlight\"><pre><span></span><code>knoxserver=$(hostname -f)\nopenssl s_client -connect ${knoxserver}:8443 &lt;&lt;&lt;&#39;&#39; | openssl x509 -out /tmp/knox.crt\n</code></pre></div>\n  - On node where beeline will be run from (e.g. Hive node):\n      - copy over the /tmp/knox.crt\n        - easiest option is to just open it in <code>vi</code> and copy/paste the contents over:\n        <code>vi /tmp/knox.crt</code>\n      - trust the certificate by running the command below      </p>\n<div class=\"highlight\"><pre><span></span><code>sudo keytool -import -trustcacerts -keystore /etc/pki/java/cacerts -storepass changeit -noprompt -alias knox -file /tmp/knox.crt\n</code></pre></div>\n<ul>\n<li>Now connect via beeline, making sure to replace KnoxserverInternalHostName first below:</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code>beeline -u &quot;jdbc:hive2://&lt;KnoxserverInternalHostName&gt;:8443/;ssl=true;transportMode=http;httpPath=gateway/default/hive&quot; -n sales1 -p BadPass#1\n</code></pre></div>\n<ul>\n<li>Notice that in the JDBC connect string for connecting to an secured Hive running in http transport mode:</li>\n<li><em>port changes to Knox's port 8443</em></li>\n<li><em>traffic between client and Knox is over HTTPS</em></li>\n<li>\n<p><em>a kerberos principal not longer needs to be passed in</em></p>\n</li>\n<li>\n<p>Test these users:</p>\n</li>\n<li><a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/sales1/BadPass/issues/1\" title=\"GitHub Issue: sales1/BadPass #1\">sales1/BadPass#1</a> should work</li>\n<li>\n<p><a class=\"magiclink magiclink-github magiclink-issue\" href=\"https://github.com/hr1/BadPass/issues/1\" title=\"GitHub Issue: hr1/BadPass #1\">hr1/BadPass#1</a> should <em>not</em> work</p>\n<ul>\n<li>Will fail with:\n<div class=\"highlight\"><pre><span></span><code>Could not create http connection to jdbc:hive2://&lt;hostname&gt;:8443/;ssl=true;transportMode=http;httpPath=gateway/default/hive. HTTP Response code: 403 (state=08S01,code=0)\n</code></pre></div></li>\n</ul>\n</li>\n<li>\n<p>Check in Ranger Audits to confirm the requests were audited:</p>\n</li>\n<li>\n<p>Ranger &gt; Audit &gt; Service type: KNOX\n  <img alt=\"Image\" src=\"https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/screenshots/Ranger-audit-KNOX-hive-summary.png\" /></p>\n</li>\n<li>\n<p>This shows how Knox helps end users access Hive securely over HTTPS using Ranger to set authorization policies and for audits</p>\n</li>\n</ul>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["hadoop", "hdp", "ipa", "kerberos"]}, {"id": "https://wgzhao.github.io/notes/bigdata/kerberos-setup/", "url": "https://wgzhao.github.io/notes/bigdata/kerberos-setup/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "MIT Kerberos  \u5b89\u88c5\u53ca\u7ef4\u62a4\u624b\u518c", "content_html": "<h2 id=\"_1\">\u6982\u8ff0<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7ef4\u62a4 Kerberos \u9700\u8981\u5bf9 Kerberos \u7684\u57fa\u672c\u6982\u5ff5\u548c\u5e38\u89c1\u7684\u51e0\u4e2a\u672f\u8bed\u6709\u6240\u4e86\u89e3\uff0c\u4ee5\u4e0b\u662f\u51e0\u4e2a\u91cd\u8981\u7684\u6982\u5ff5</p>\n<ul>\n<li>Principal\uff08\u5b89\u5168\u4e2a\u4f53\uff0c\u4e3b\u4f53\uff09\uff1a\u88ab\u8ba4\u8bc1\u7684\u4e2a\u4f53\uff0c\u6709\u4e00\u4e2a\u540d\u5b57(name)\u548c\u53e3\u4ee4(password)</li>\n<li>KDC(Key Distribution Center)\uff1a \u4e00\u4e2a\u7f51\u7edc\u670d\u52a1\uff0c\u63d0\u4f9b\u7968\u636e(ticket)\u548c\u4e34\u65f6\u4f1a\u8bdd\u5bc6\u94a5</li>\n<li>Ticket\uff08\u7968\u636e\uff09\uff1a\u4e00\u4e2a\u8bb0\u5f55\uff0c\u5ba2\u6237\u53ef\u4ee5\u7528\u5b83\u6765\u5411\u670d\u52a1\u5668\u8bc1\u660e\u81ea\u5df1\u7684\u8eab\u4efd\uff0c\u5305\u62ec\u5ba2\u6237\u6807\u8bc6\u3001\u4f1a\u8bdd\u5bc6\u94a5\u3001\u65f6\u95f4\u6233\u7b49</li>\n<li>Credentials\uff08\u51ed\u8bc1\uff09\uff1a \u4e00\u4e2a Ticket \u52a0\u4e0a\u4e00\u4e2a\u79d8\u5bc6\u7684\u4f1a\u8bdd\u5bc6\u94a5</li>\n</ul>\n<p>\u8ba4\u8bc1\u539f\u7406\u5982\u4e0b\uff1a</p>\n<p><img alt=\"IMAGE\" src=\"../../images/6A134438C03225BA6B02D43CB5BB77D9.jpg\" /></p>\n<h2 id=\"kdc-server\">\u90e8\u7f72 KDC Server<a class=\"headerlink\" href=\"#kdc-server\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_2\">\u5b89\u88c5\u8f6f\u4ef6\u5305<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528 root \u8d26\u53f7\u767b\u9646\u670d\u52a1\uff0c\u7136\u540e\u5b89\u88c5\u9700\u8981\u7684\u8f6f\u4ef6\u5305</p>\n<p><code>yum install krb5-server krb5-libs krb5-workstation</code></p>\n<p>\u7f16\u8f91 <code>/etc/krb5.conf</code> ,\u4fee\u6539 <code>[realms]</code> \u90e8\u5206\uff0c\u6539\u6210\u7b26\u5408\u81ea\u5df1\u73af\u5883\u7684\u914d\u7f6e\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>includedir /etc/krb5.conf.d/\n\n[libdefaults]\n  renew_lifetime = 7d\n  forwardable = true\n  default_realm = WGZHAO.COM\n  ticket_lifetime = 24h\n  dns_lookup_realm = false\n  dns_lookup_kdc = false\n  default_ccache_name = /tmp/krb5cc_%{uid}\n  #default_tgs_enctypes = aes des3-cbc-sha1 rc4 des-cbc-md5\n  #default_tkt_enctypes = aes des3-cbc-sha1 rc4 des-cbc-md5\n\n[domain_realm]\n  WGZHAO.com = WGZHAO.COM\n\n[logging]\n  default = FILE:/var/log/krb5kdc.log\n  admin_server = FILE:/var/log/kadmind.log\n  kdc = FILE:/var/log/krb5kdc.log\n\n[realms]\n  WGZHAO.COM = {\n    admin_server = hadoop2.WGZHAO.com\n    kdc = hadoop2.WGZHAO.com\n  }\n</code></pre></div>\n<h3 id=\"_3\">\u521b\u5efa\u6570\u636e\u5e93<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u670d\u52a1\u7aef\u670d\u52a1\u5668\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p>\n<p><code>kdb5_util create -s</code></p>\n<p>\u63d0\u793a\u8f93\u5165\u5bc6\u7801\u65f6\uff0c\u8f93\u5165\u5bc6\u7801\uff0c\u4e00\u5b9a\u8981\u7262\u7262\u8bb0\u4f4f\u8be5\u5bc6\u7801</p>\n<h3 id=\"kdc\">\u542f\u52a8 KDC<a class=\"headerlink\" href=\"#kdc\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><pre><span></span><code>systemctl<span class=\"w\"> </span>start<span class=\"w\"> </span>krb5kdc\nsystemctl<span class=\"w\"> </span>start<span class=\"w\"> </span>kadmin\n</code></pre></div>\n<h3 id=\"kerberos-admin\">\u914d\u7f6e Kerberos Admin \u8d26\u53f7<a class=\"headerlink\" href=\"#kerberos-admin\" title=\"Permanent link\">&para;</a></h3>\n<ol>\n<li>\u521b\u5efa KDC admin\u8d26\u53f7 <code>kadmin.local -q \"addprinc admin/admin\"</code></li>\n<li>\u7f16\u8f91 <code>/var/kerberos/krb5kdc/kadm5.acl</code> \u6587\u4ef6\uff0c\u589e\u52a0\u914d\u7f6e\u7684realms\u7684\u8ba4\u8bc1\uff0c\u7c7b\u4f3c\u5982\u4e0b <code>*/admin@WGZHAO.COM    *</code></li>\n<li>\u91cd\u542f kadmin <code>systemctl start kadmin</code></li>\n</ol>\n<h2 id=\"kadmin\">kadmin<a class=\"headerlink\" href=\"#kadmin\" title=\"Permanent link\">&para;</a></h2>\n<p>kadmin\u662f KDC\u7684\u7ba1\u7406\u547d\u4ee4\uff0c\u7528\u6765\u7ba1\u7406 Kerberos \u6570\u636e\u5e93\uff0c\u5177\u6709\u4ee5\u4e0b\u529f\u80fd\uff1a</p>\n<ul>\n<li>\u663e\u793a Principal \u7684\u5c5e\u6027</li>\n<li>\u83b7\u5f97 Principal \u5217\u8868</li>\n<li>\u589e\u52a0\u3001\u5220\u9664\u6216\u8005\u4fee\u6539 principal</li>\n<li>\u4fee\u6539\u53e3\u4ee4</li>\n<li>\u7b56\u7565\u7ba1\u7406</li>\n</ul>\n<p>\u4ee5\u4e0b\u662f kadmin \u7684\u4e00\u4e2a\u57fa\u672c\u8f93\u51fa</p>\n<div class=\"highlight\"><pre><span></span><code>%<span class=\"w\"> </span>kadmin\nkadmin:<span class=\"w\"> </span>getprinc<span class=\"w\"> </span>hive/hadoop1.WGZHAO.com\nPrincipal:<span class=\"w\"> </span>hive/hadoop1.WGZHAO.com@WGZHAO.COM\nKey<span class=\"w\"> </span>version:<span class=\"w\"> </span><span class=\"m\">3</span>\nMaximum<span class=\"w\"> </span>life:<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>day<span class=\"w\"> </span><span class=\"m\">00</span>:00:00\nMaximum<span class=\"w\"> </span>renewable<span class=\"w\"> </span>life:<span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span>days<span class=\"w\"> </span><span class=\"m\">00</span>:00:00\nMaster<span class=\"w\"> </span>key<span class=\"w\"> </span>version:<span class=\"w\"> </span><span class=\"m\">1</span>\nExpires:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"m\">22</span>:14:07<span class=\"w\"> </span>EDT<span class=\"w\"> </span><span class=\"m\">2038</span>\nPassword<span class=\"w\"> </span>expires:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>Sep<span class=\"w\"> </span><span class=\"m\">19</span><span class=\"w\"> </span><span class=\"m\">14</span>:40:00<span class=\"w\"> </span>EDT<span class=\"w\"> </span><span class=\"m\">1996</span>\nPassword<span class=\"w\"> </span>last<span class=\"w\"> </span>changed:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span><span class=\"m\">02</span>:06:40<span class=\"w\"> </span>EDT<span class=\"w\"> </span><span class=\"m\">1996</span>\nLast<span class=\"w\"> </span>modified:<span class=\"w\"> </span>by<span class=\"w\"> </span>joeadmin/admin@ATHENA.MIT.EDU\n<span class=\"w\">    </span>on<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jul<span class=\"w\"> </span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"m\">18</span>:27:08<span class=\"w\"> </span>EDT<span class=\"w\"> </span><span class=\"m\">1996</span>\nAttributes:<span class=\"w\"> </span>DISALLOW_FORWARDABLE,<span class=\"w\"> </span>DISALLOW_PROXIABLE,REQUIRES_HW_AUTH\nSalt<span class=\"w\"> </span>type:<span class=\"w\"> </span>DEFAULT\n</code></pre></div>\n<h2 id=\"_4\">\u65e5\u5e38\u7ef4\u62a4<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_5\">\u5217\u51fa\u51ed\u8bc1<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>klist \u547d\u4ee4\u53ef\u4ee5\u5217\u51fa\u4e00\u4e2a\u51ed\u8bc1\u7684\u65e5\u5e38\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\"> </span>klist<span class=\"w\">  </span>-kt<span class=\"w\"> </span>/etc/security/keytabs/hive.service.keytab<span class=\"w\"> </span>\nKeytab<span class=\"w\"> </span>name:<span class=\"w\"> </span>FILE:/etc/security/keytabs/hive.service.keytab\nKVNO<span class=\"w\"> </span>Timestamp<span class=\"w\">           </span>Principal\n----<span class=\"w\"> </span>-------------------<span class=\"w\"> </span>------------------------------------------------------\n<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>/04/2017<span class=\"w\"> </span><span class=\"m\">09</span>:12:48<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>/04/2017<span class=\"w\"> </span><span class=\"m\">09</span>:12:48<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>/04/2017<span class=\"w\"> </span><span class=\"m\">09</span>:12:48<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>/04/2017<span class=\"w\"> </span><span class=\"m\">09</span>:12:48<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>/04/2017<span class=\"w\"> </span><span class=\"m\">09</span>:12:48<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n</code></pre></div>\n<h3 id=\"_6\">\u83b7\u5f97\u51ed\u636e<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u83b7\u5f97\u51ed\u636e\u53ef\u4ee5\u901a\u8fc7\u8d26\u53f7\u5bc6\u7801\u65b9\u5f0f\u5411\u670d\u52a1\u5668\u83b7\u53d6\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u51ed\u8bc1\u6587\u4ef6\u83b7\u53d6\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># klist</span>\nklist:<span class=\"w\"> </span>Credentials<span class=\"w\"> </span>cache<span class=\"w\"> </span>file<span class=\"w\"> </span><span class=\"s1\">&#39;/tmp/krb5cc_0&#39;</span><span class=\"w\"> </span>not<span class=\"w\"> </span>found\n<span class=\"c1\"># kinit  -kt /etc/security/keytabs/hive.service.keytab hive/hadoop5.wgzhao.com@WGZHAO.COM</span>\n<span class=\"c1\"># klist</span>\nTicket<span class=\"w\"> </span>cache:<span class=\"w\"> </span>FILE:/tmp/krb5cc_0\nDefault<span class=\"w\"> </span>principal:<span class=\"w\"> </span>hive/hadoop5.wgzhao.com@WGZHAO.COM\n\nValid<span class=\"w\"> </span>starting<span class=\"w\">       </span>Expires<span class=\"w\">              </span>Service<span class=\"w\"> </span>principal\n<span class=\"m\">12</span>/20/2018<span class=\"w\"> </span><span class=\"m\">14</span>:32:17<span class=\"w\">  </span><span class=\"m\">12</span>/21/2018<span class=\"w\"> </span><span class=\"m\">14</span>:32:17<span class=\"w\">  </span>krbtgt/WGZHAO.COM@WGZHAO.COM\n</code></pre></div>\n<h3 id=\"_7\">\u521b\u5efa\u51ed\u8bc1<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h3>\n<p>\u521b\u5efa\u51ed\u8bc1\u9700\u8981\u7528 root \u8d26\u53f7\u767b\u9646\u5230 KDC \u670d\u52a1\u5668\uff0c\u7136\u540e\u4f7f\u7528kadmin.local\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff0c\u8be5\u547d\u4ee4\u53ef\u4ee5\u4ea4\u4e92\u5f0f\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u6279\u5904\u7406\u65b9\u5f0f\uff0c\u8fd9\u91cc\u7ed9\u51fa\u6279\u5904\u7406\u7684\u65b9\u5f0f\u3002\n\u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u51ed\u8bc1</p>\n<div class=\"highlight\"><pre><span></span><code>kadmin.local<span class=\"w\"> </span>-q<span class=\"w\"> </span><span class=\"s2\">&quot;addprinc -randkey gphdfs/bjzxsdw3@WGZHAO.COM&quot;</span>\n</code></pre></div>\n<p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u9700\u8981\u5bfc\u51fa\u51ed\u8bc1\u6587\u4ef6\u5e76\u62f7\u8d1d\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u5bfc\u51fa\uff1a</p>\n<p><code>kadmin.local -q \"xst -k gphdfs.service.keytab  gphdfs/bjzxsdw3@WGZHAO.COM\"</code></p>\n<h3 id=\"_8\">\u4fee\u6539\u51ed\u8bc1<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4fee\u6539\u51ed\u8bc1\u9700\u8981\u7528 root \u8d26\u53f7\u767b\u9646\u5230 KDC \u670d\u52a1\u5668\uff0c\u7136\u540e\u4f7f\u7528 <code>kadmin.local</code> \u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff0c\u8be5\u547d\u4ee4\u53ef\u4ee5\u4ea4\u4e92\u5f0f\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u6279\u5904\u7406\u65b9\u5f0f\uff0c\u8fd9\u91cc\u7ed9\u51fa\u6279\u5904\u7406\u7684\u65b9\u5f0f</p>\n<div class=\"highlight\"><pre><span></span><code>kadmin.local<span class=\"w\"> </span>-q<span class=\"w\"> </span><span class=\"s2\">&quot;modprinc -maxlife 7days -maxrenewlife 7days +allow_renewable infa/bjzx-etl-infa1@WGZHAO.COM&quot;</span>\n</code></pre></div>\n<h3 id=\"kdc_1\">\u589e\u52a0 KDC \u670d\u52a1\u5e76\u53d1<a class=\"headerlink\" href=\"#kdc_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\uff0c\u9ed8\u8ba4\u7684 KDC \u914d\u7f6e\u4f1a\u5bfc\u81f4\u8bf7\u6c42\u6ca1\u6709\u54cd\u5e94\uff0c\u4f1a\u51fa\u73b0\u8be1\u5f02\u7684 \"UnKnown Hostname\" \u5f02\u5e38\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u589e\u52a0 KDC \u7684\u670d\u52a1\u8fdb\u7a0b\u3002</p>\n<p>\u7528 root \u8d26\u53f7\u767b\u9646 KDC \u670d\u52a1\u5668\uff0c\u7f16\u8f91 <em>/etc/sysconfig/krb5kdc</em> \u6587\u4ef6\uff0c\u4fee\u6539 <code>KRB5KDC_ARGS</code> \u9009\u9879\uff0c\u589e\u52a0<code>-w 32</code>\u53c2\u6570\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<p><code>KRB5KDC_ARGS=-w 32</code></p>\n<p>\u7136\u540e\u91cd\u542f\u670d\u52a1</p>\n<div class=\"highlight\"><pre><span></span><code>systemctl<span class=\"w\"> </span>restart<span class=\"w\"> </span>kadmin\nsystemctl<span class=\"w\"> </span>restart<span class=\"w\"> </span>krb5kdc\n</code></pre></div>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["kerberos", "security"]}, {"id": "https://wgzhao.github.io/notes/bigdata/mafengwo-warehouse-design-and-practices/", "url": "https://wgzhao.github.io/notes/bigdata/mafengwo-warehouse-design-and-practices/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5", "content_html": "<h1 id=\"_1\">\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"https://mp.weixin.qq.com/s/r-cg-aXhp14FWgHcMY6Vdw\" title=\"Permalink to \u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5\">Source</a></p>\n<h2 id=\"part1\">Part.1 \u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u4e0e\u6570\u636e\u4e2d\u53f0<a class=\"headerlink\" href=\"#part1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u51e0\u5e74\uff0c\u6570\u636e\u4e2d\u53f0\u6982\u5ff5\u7684\u70ed\u5ea6\u4e00\u76f4\u4e0d\u51cf\u30022018 \u5e74\u8d77\uff0c\u9a6c\u8702\u7a9d\u4e5f\u5f00\u59cb\u4e86\u81ea\u5df1\u7684\u6570\u636e\u4e2d\u53f0\u63a2\u7d22\u4e4b\u8def\u3002</p>\n<p>\u6570\u636e\u4e2d\u53f0\u5230\u5e95\u662f\u4ec0\u4e48\uff1f\u8981\u4e0d\u8981\u5efa\uff1f\u548c\u6570\u636e\u4ed3\u5e93\u6709\u4ec0\u4e48\u672c\u8d28\u7684\u533a\u522b\uff1f\u76f8\u4fe1\u5f88\u591a\u4f01\u4e1a\u90fd\u5728\u5173\u6ce8\u8fd9\u4e9b\u95ee\u9898\u3002</p>\n<p>\u6211\u8ba4\u4e3a\u6570\u636e\u4e2d\u53f0\u7684\u6982\u5ff5\u975e\u5e38\u63a5\u8fd1\u4f20\u7edf\u6570\u636e\u4ed3\u5e93+\u5927\u6570\u636e\u5e73\u53f0\u7684\u7ed3\u5408\u4f53\u3002\u5b83\u662f\u5728\u4f01\u4e1a\u7684\u6570\u636e\u5efa\u8bbe\u7ecf\u5386\u4e86\u6570\u636e\u4e2d\u5fc3\u3001\u6570\u636e\u4ed3\u5e93\u7b49\u79ef\u7d2f\u4e4b\u540e\uff0c\u501f\u52a9\u5e73\u53f0\u5316\u7684\u601d\u8def\uff0c\u5c06\u6570\u636e\u66f4\u597d\u5730\u8fdb\u884c\u6574\u5408\u4e0e\u7edf\u4e00\uff0c\u4ee5\u7ec4\u4ef6\u5316\u7684\u65b9\u5f0f\u5b9e\u73b0\u7075\u6d3b\u7684\u6570\u636e\u52a0\u5de5\u4e0e\u5e94\u7528\uff0c\u4ee5\u66f4\u6e05\u6670\u7684\u6570\u636e\u804c\u80fd\u7ec4\u7ec7\u5e94\u5bf9\u4e1a\u52a1\u7684\u5feb\u901f\u53d8\u5316\uff0c\u4ee5\u670d\u52a1\u7684\u65b9\u5f0f\u66f4\u597d\u5730\u91ca\u653e\u6570\u636e\u4ef7\u503c\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6570\u636e\u4e2d\u53f0\u66f4\u591a\u7684\u662f\u4f53\u73b0\u4e00\u79cd\u7ba1\u7406\u601d\u8def\u548c\u67b6\u6784\u7ec4\u7ec7\u4e0a\u7684\u53d8\u9769\u3002\u5728\u8fd9\u6837\u7684\u601d\u60f3\u4e0b\uff0c\u6211\u4eec\u7ed3\u5408\u81ea\u8eab\u4e1a\u52a1\u7279\u70b9\u5efa\u8bbe\u4e86\u9a6c\u8702\u7a9d\u7684\u6570\u636e\u4e2d\u53f0\uff0c\u6838\u5fc3\u67b6\u6784\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKw4AAassQ0iaOLpWAlJ16zgHiaFW3PvlibgSKdiaaudf8iadIwpcWI7d7PgYA/640?wx_fmt=png\" /></p>\n<p>\u5728\u4e2d\u53f0\u5efa\u8bbe\u4e4b\u524d\uff0c\u9a6c\u8702\u7a9d\u5df2\u7ecf\u5efa\u7acb\u4e86\u81ea\u5df1\u7684\u5927\u6570\u636e\u5e73\u53f0\uff0c\u5e76\u79ef\u7d2f\u4e86\u4e00\u4e9b\u901a\u7528\u3001\u7ec4\u4ef6\u5316\u7684\u5de5\u5177\uff0c\u8fd9\u4e9b\u53ef\u4ee5\u652f\u6491\u6570\u636e\u4e2d\u53f0\u7684\u5feb\u901f\u642d\u5efa\u3002\u4f5c\u4e3a\u4e2d\u53f0\u7684\u53e6\u4e00\u5927\u6838\u5fc3\u90e8\u5206\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u4e3b\u8981\u627f\u62c5\u6570\u636e\u7edf\u4e00\u5316\u5efa\u8bbe\u7684\u5de5\u4f5c\uff0c\u5305\u62ec\u7edf\u4e00\u6570\u636e\u6a21\u578b\uff0c\u7edf\u4e00\u6307\u6807\u4f53\u7cfb\u7b49\u3002\u4e0b\u9762\u4ecb\u7ecd\u9a6c\u8702\u7a9d\u5728\u6570\u636e\u4ed3\u5e93\u5efa\u8bbe\u65b9\u9762\u7684\u5177\u4f53\u5b9e\u8df5\u3002</p>\n<h2 id=\"part2\">Part.2 \u6570\u636e\u4ed3\u5e93\u6838\u5fc3\u67b6\u6784<a class=\"headerlink\" href=\"#part2\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u9075\u5faa\u6807\u51c6\u7684\u4e09\u5c42\u67b6\u6784\uff0c\u5bf9\u6570\u636e\u5206\u5c42\u7684\u5b9a\u4f4d\u4e3b\u8981\u91c7\u53d6\u7ef4\u5ea6\u6a21\u578b\u8bbe\u8ba1\uff0c\u4e0d\u4f1a\u5bf9\u6570\u636e\u8fdb\u884c\u62bd\u8c61\u6253\u6563\u5904\u7406\uff0c\u66f4\u591a\u6ce8\u91cd\u4e1a\u52a1\u8fc7\u7a0b\u6570\u636e\u6574\u5408\u3002\u73b0\u6709\u6570\u4ed3\u4e3b\u8981\u4ee5\u79bb\u7ebf\u4e3a\u4e3b\uff0c\u6574\u4f53\u67b6\u6784\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwgbWC8cibnuPIibiatyYVpVHNC1r9HQQwj1GPCloMRIKrVlyIf3U5dRZxw/640?wx_fmt=png\" /></p>\n<p>\u5982\u56fe\u6240\u793a\uff0c\u5171\u5206\u4e3a 3 \u5c42\uff1a<strong>\u4e1a\u52a1\u6570\u636e\u5c42\u3001\u516c\u5171\u6570\u636e\u5c42\u4e0e\u5e94\u7528\u6570\u636e\u5c42</strong>\uff0c\u6bcf\u5c42\u5b9a\u4f4d\u3001\u76ee\u6807\u4ee5\u53ca\u5efa\u8bbe\u539f\u5219\u5404\u4e0d\u76f8\u540c\u3002</p>\n<p><strong>\uff081\uff09\u4e1a****\u52a1\u6570\u636e\u5c42</strong>\uff1a\u5305\u542b STG\uff08\u6570\u636e\u7f13\u51b2\u5c42\uff09\u4e0e ODS\uff08\u64cd\u4f5c\u6570\u636e\u5c42\uff09\u4e24\u5c42\uff0c\u8fd9\u4e24\u5c42\u6570\u636e\u7ed3\u6784\u4e0e\u4e1a\u52a1\u6570\u636e\u51e0\u4e4e\u4e00\u81f4\u3002</p>\n<ul>\n<li><strong>STG</strong>\uff1a\u4e5f\u53eb\u6570\u636e\u51c6\u5907\u533a\uff0c\u5b9a\u4f4d\u662f\u7f13\u5b58\u6765\u81ea DB \u62bd\u53d6\u3001\u6d88\u606f\u3001\u65e5\u5fd7\u89e3\u6790\u843d\u5730\u7684\u4e34\u65f6\u6570\u636e\uff0c\u7ed3\u6784\u4e0e\u4e1a\u52a1\u7cfb\u7edf\u4fdd\u6301\u4e00\u81f4\uff1b\u8d1f\u8d23\u5bf9\u5783\u573e\u6570\u636e\u3001\u4e0d\u89c4\u8303\u6570\u636e\u8fdb\u884c\u6e05\u6d17\u8f6c\u6362\uff1b\u8be5\u5c42\u53ea\u4e3a ODS \u5c42\u670d\u52a1\uff1b</li>\n<li><strong>ODS</strong>\uff1a\u64cd\u4f5c\u6570\u636e\u5c42\u5b9a\u4f4d\u4e8e\u4e1a\u52a1\u660e\u7ec6\u6570\u636e\u4fdd\u7559\u533a\uff0c\u8d1f\u8d23\u4fdd\u7559\u6570\u636e\u63a5\u5165\u65f6\u70b9\u540e\u5386\u53f2\u53d8\u66f4\u6570\u636e\uff0c\u6570\u636e\u539f\u5219\u4e0a\u5168\u91cf\u4fdd\u7559\u3002\u6a21\u578b\u8bbe\u8ba1\u4f9d\u636e\u4e1a\u52a1\u8868\u6570\u636e\u53d8\u66f4\u7279\u6027\u91c7\u53d6\u62c9\u94fe\u3001\u6d41\u6c34\u8868\u4e24\u79cd\u5f62\u5f0f\u3002</li>\n</ul>\n<p><strong>\uff082\uff09\u516c\u5171\u6570\u636e\u5c42</strong>\uff1a\u7ec6\u5206\u4e3a DWD\uff08\u660e\u7ec6\u6570\u636e\u5c42\uff09\u3001DWS\uff08\u6c47\u603b\u6570\u636e\u5c42\uff09\u3001DIM\uff08\u516c\u5171\u7ef4\u5ea6\u5c42\uff09 \u4e09\u5c42\uff0c\u4e3b\u8981\u7528\u4e8e\u52a0\u5de5\u5b58\u653e\u6574\u5408\u540e\u7684\u660e\u7ec6\u4e1a\u52a1\u8fc7\u7a0b\u6570\u636e\uff0c\u4ee5\u53ca\u7ecf\u8fc7\u8f7b\u5ea6\u6216\u91cd\u5ea6\u6c47\u603b\u7c92\u5ea6\u516c\u5171\u7ef4\u5ea6\u6307\u6807\u6570\u636e\u3002\u516c\u5171\u6570\u636e\u5c42\u4f5c\u4e3a\u4ed3\u5e93\u6838\u5fc3\u5c42\uff0c\u5b9a\u4f4d\u4e8e\u4e1a\u52a1\u89c6\u89d2\uff0c\u63d0\u70bc\u51fa\u5bf9\u6570\u636e\u4ed3\u5e93\u5177\u6709\u5171\u6027\u7684\u6570\u636e\u8bbf\u95ee\u3001\u7edf\u8ba1\u9700\u6c42\uff0c\u4ece\u800c\u6784\u5efa\u9762\u5411\u652f\u6301\u5e94\u7528\u3001\u63d0\u4f9b\u5171\u4eab\u6570\u636e\u8bbf\u95ee\u670d\u52a1\u7684\u516c\u5171\u6570\u636e\u3002</p>\n<ul>\n<li><strong>DWD</strong>\uff1a\u8fd9\u4e00\u5c42\u662f\u6574\u5408\u540e\u7684\u4e1a\u52a1\u8fc7\u7a0b\u660e\u7ec6\u6570\u636e\uff0c\u8d1f\u8d23\u5404\u4e1a\u52a1\u573a\u666f\u5782\u76f4\u4e0e\u6c34\u5e73\u6570\u636e\u6574\u5408\u3001\u5e38\u7528\u516c\u5171\u7ef4\u5ea6\u5197\u4f59\u52a0\u5de5\uff0c\u4ee5\u53ca\u660e\u7ec6\u4e1a\u52a1\u6807\u7b7e\u4fe1\u606f\u52a0\u5de5\uff1b</li>\n<li><strong>DWS</strong>\uff1a\u6c47\u603b\u6570\u636e\u5c42\u6309\u7167\u4e3b\u9898\u5bf9\u5171\u6027\u7ef4\u5ea6\u6307\u6807\u6570\u636e\u8fdb\u884c\u8f7b\u5ea6\u3001\u9ad8\u5ea6\u805a\u5408\uff1b</li>\n<li><strong>DIM</strong>\uff1a\u5bf9\u7ef4\u5ea6\u8fdb\u884c\u7edf\u4e00\u6807\u51c6\u5316\u5b9a\u4e49\uff0c\u5b9e\u73b0\u7ef4\u5ea6\u4fe1\u606f\u5171\u4eab\u3002</li>\n</ul>\n<p><strong>\uff083\uff09\u5e94\u7528\u6570\u636e\u5c42</strong>\uff1aDWA \u5c42\uff0c\u4e3b\u8981\u7528\u4e8e\u5404\u4ea7\u54c1\u6216\u5404\u4e1a\u52a1\u6761\u7ebf\u4e2a\u6027\u5316\u7684\u6570\u636e\u52a0\u5de5\uff0c\u4f8b\u5982\u5546\u4e1a\u5316\u4ea7\u54c1\u6570\u636e\u3001\u641c\u7d22\u63a8\u8350\uff0c\u98ce\u63a7\u7b49\u3002</p>\n<h2 id=\"part3\">Part.3 \u6570\u636e\u6a21\u578b\u8bbe\u8ba1<a class=\"headerlink\" href=\"#part3\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"31\">3.1 \u65b9\u6cd5\u9009\u62e9<a class=\"headerlink\" href=\"#31\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6570\u636e\u6a21\u578b\u662f\u5bf9\u73b0\u5b9e\u4e16\u754c\u6570\u636e\u7279\u5f81\u7684\u62bd\u8c61\uff0c\u6570\u636e\u6a21\u578b\u7684\u8bbe\u8ba1\u65b9\u6cd5\u5c31\u662f\u5bf9\u6570\u636e\u8fdb\u884c\u5f52\u7eb3\u548c\u6982\u62ec\u7684\u65b9\u6cd5\u3002\u76ee\u524d\u4e1a\u754c\u4e3b\u8981\u7684\u6a21\u578b\u8bbe\u8ba1\u65b9\u6cd5\u8bba\u6709\u4e24\u79cd\uff0c\u4e00\u662f\u6570\u636e\u4ed3\u5e93\u4e4b\u7236 Bill Inmon \u63d0\u51fa\u7684**\u8303\u5f0f\u5efa\u6a21**\u65b9\u6cd5\uff0c\u53c8\u53eb ER \u5efa\u6a21\uff0c\u4e3b\u5f20\u7ad9\u5728\u4f01\u4e1a\u89d2\u5ea6\u81ea\u4e0a\u800c\u4e0b\u8fdb\u884c\u6570\u636e\u6a21\u578b\u6784\u5efa\uff1b\u4e8c\u662f Ralph Kimball \u5927\u5e08\u5021\u5bfc\u7684**\u7ef4\u5ea6\u5efa\u6a21**\u65b9\u6cd5\uff0c\u4e3b\u5f20\u4ece\u4e1a\u52a1\u9700\u6c42\u51fa\u53d1\u81ea\u4e0b\u800c\u4e0a\u6784\u5efa\u6570\u636e\u6a21\u578b\u3002</p>\n<p>\u5927\u6570\u636e\u73af\u5883\u4e0b\uff0c\u4e1a\u52a1\u7cfb\u7edf\u6570\u636e\u4f53\u7cfb\u5e9e\u6742\uff0c\u6570\u636e\u7ed3\u6784\u591a\u6837\u3001\u53d8\u66f4\u9891\u7e41\uff0c\u5e76\u4e14\u9700\u8981\u5feb\u901f\u54cd\u5e94\u5404\u79cd\u590d\u6742\u7684\u4e1a\u52a1\u9700\u6c42\uff0c\u4ee5\u4e0a\u4e24\u79cd\u4f20\u7edf\u7684\u7406\u8bba\u90fd\u5df2\u65e0\u6cd5\u6ee1\u8db3\u4e92\u8054\u7f51\u6570\u4ed3\u9700\u6c42\u3002\u5728\u6b64\u80cc\u666f\u4e0b\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u91c7\u53d6\u4e86\u300c\u4ee5\u9700\u6c42\u9a71\u52a8\u4e3a\u4e3b\u3001\u6570\u636e\u9a71\u52a8\u4e3a\u8f85\u300d\u7684\u6df7\u5408\u6a21\u578b\u8bbe\u8ba1\u65b9\u5f0f\uff0c\u6765\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u5c42\u6b21\u9009\u62e9\u6a21\u578b\u3002\u4e3b\u8981\u4ece\u4ee5\u4e0b\u56db\u4e2a\u65b9\u9762\u7efc\u5408\u8003\u8651\uff1a</p>\n<p><strong>1. \u9762\u5411\u4e3b\u9898</strong>\uff1a\u91c7\u7528\u8303\u5f0f\u6a21\u578b\u7406\u8bba\u4e2d\u7684\u4e3b\u9898\u5212\u5206\u65b9\u6cd5\u5bf9\u4e1a\u52a1\u6570\u636e\u8fdb\u884c\u5206\u7c7b\u3002</p>\n<p>**2. \u4e00\u81f4\u6027\u4fdd\u8bc1\uff1a**\u91c7\u7528\u7ef4\u5ea6\u6a21\u578b\u7406\u8bba\u4e2d\u7684\u603b\u7ebf\u7ed3\u6784\u601d\u60f3\uff0c\u5efa\u7acb\u7edf\u4e00\u7684\u4e00\u81f4\u6027\u7ef4\u5ea6\u8868\u548c\u4e00\u81f4\u6027\u4e8b\u5b9e\u8868\u6765\u4fdd\u8bc1\u4e00\u81f4\u6027\u3002</p>\n<p><strong>3. \u6570\u636e\u8d28\u91cf\u4fdd\u8bc1</strong>\uff1a\u65e0\u8bba\u8303\u5f0f\u5efa\u6a21\u8fd8\u662f\u7ef4\u5ea6\u5efa\u6a21\u90fd\u975e\u5e38\u91cd\u89c6\u6570\u636e\u8d28\u91cf\u95ee\u9898\uff0c\u7efc\u5408\u4f7f\u7528\u4e24\u4e2a\u7406\u8bba\u4e2d\u7684\u65b9\u6cd5\u4fdd\u8bc1\u6570\u636e\u8d28\u91cf\u3002</p>\n<p><strong>4. \u6548\u7387\u4fdd\u8bc1</strong>\uff1a\u5408\u7406\u91c7\u53d6\u7ef4\u5ea6\u9000\u5316\u3001\u53d8\u5316\u7ef4\u3001\u589e\u52a0\u5197\u4f59\u7b49\u65b9\u6cd5\uff0c\u4fdd\u8bc1\u6570\u636e\u7684\u8ba1\u7b97\u548c\u67e5\u8be2\u6548\u7387\u3002</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwTwYHG0fQ7YzyTOu9XgAxzVBl9ToaBPqGKiccklgMlYlia3v1l0DdSnfw/640?wx_fmt=png\" /></p>\n<p>\u5176\u4e2d\uff0cODS \u9009\u62e9\u4fdd\u6301\u8d34\u6e90\u7684\u8303\u5f0f\u6a21\u578b\uff0c\u4e0d\u505a\u8fdb\u4e00\u6b65\u6a21\u578b\u62bd\u8c61\uff0c\u53ea\u662f\u4ece\u8282\u7701\u5b58\u50a8\u89d2\u5ea6\u8003\u8651\uff0c\u5bf9\u8be5\u5c42\u91c7\u53d6\u62c9\u94fe\u5904\u7406\u3002DWD \u4e0e DWS \u57fa\u4e8e\u5bf9\u6784\u5efa\u6210\u672c\u3001\u6027\u80fd\uff0c\u6613\u7528\u6027\u89d2\u5ea6\u7684\u8003\u8651\uff0c\u4e3b\u8981\u91c7\u53d6\u7ef4\u5ea6\u6a21\u578b\u548c\u4e00\u4e9b\u5bbd\u8868\u6a21\u578b\u3002\u5bbd\u8868\u6a21\u578b\u7684\u672c\u8d28\u662f\u57fa\u4e8e\u7ef4\u5ea6\u6a21\u578b\u7684\u6269\u5c55\uff0c\u5bf9\u6574\u4e2a\u4e1a\u52a1\u4ee5\u53ca\u5168\u8282\u70b9\u4fe1\u606f\u8fdb\u884c\u5782\u76f4\u4e0e\u6c34\u5e73\u65b9\u5f0f\u6574\u5408\uff1b\u540c\u65f6\u91c7\u7528\u9000\u5316\u7ef4\u5ea6\u7684\u65b9\u5f0f\uff0c\u5c06\u4e0d\u540c\u7ef4\u5ea6\u7684\u5ea6\u91cf\u653e\u5165\u6570\u636e\u8868\u7684\u4e0d\u540c\u5217\u4e2d\uff0c\u5b9e\u73b0\u4e1a\u52a1\u5168\u6d41\u7a0b\u89c6\u56fe\u7684\u6784\u5efa\uff0c\u6765\u63d0\u5347\u5bbd\u8868\u6a21\u578b\u7684\u6613\u7528\u6027\u3001\u67e5\u8be2\u6548\u7387\uff0c\u4e14\u6613\u4e8e\u6a21\u578b\u7684\u6269\u5c55\u3002</p>\n<ul>\n<li><strong>\u6c34\u5e73\u6574\u5408</strong>\uff1a\u6c34\u5e73\u6574\u5408\u5c31\u662f\u5c06\u540c\u4e00\u4e1a\u52a1\u591a\u6570\u636e\u6e90\u7684\u6570\u636e\u6574\u5408\u5230\u4e00\u4e2a\u6a21\u578b\u4e2d\uff0c\u5982\u679c\u591a\u6570\u636e\u6e90\u4e1a\u52a1\u6570\u636e\u5b58\u5728\u4ea4\u96c6\uff0c\u5219\u9700\u8981\u6309\u7167\u9884\u8bbe\u7684\u4e1a\u52a1\u89c4\u5219\u9009\u53d6\u4e00\u4efd\u4fdd\u7559\uff0c\u907f\u514d\u6574\u5408\u540e\u7684\u4e1a\u52a1\u6570\u636e\u4ea4\u53c9\u3002\u4f8b\u5982\u5546\u54c1\u6570\u636e\u5982\u679c\u672a\u8fdb\u884c\u4e3b\u6570\u636e\u7ba1\u7406\uff0c\u4e0d\u540c\u4e1a\u52a1\u7ebf\u7684\u5546\u54c1\u4fe1\u606f\u5c31\u4f1a\u6563\u843d\u5728\u5404\u4e1a\u52a1\u7cfb\u7edf\u8868\u4e2d\uff0c\u65e0\u6cd5\u6ee1\u8db3\u4f01\u4e1a\u7ea7\u7684\u6570\u636e\u5206\u6790\u9700\u6c42\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5c06\u8fd9\u4e9b\u5546\u54c1\u6570\u636e\u6309\u7167\u4e1a\u52a1\u4e3b\u9898\u8fdb\u884c\u6c34\u5e73\u6574\u5408\u3002</li>\n<li><strong>\u5782\u76f4\u6574\u5408</strong>\uff1a\u4e00\u6b21\u5b8c\u6574\u7684\u4e1a\u52a1\u6d41\u8f6c\u901a\u5e38\u8981\u7ecf\u5386\u591a\u4e2a\u73af\u8282\uff0c\u5404\u8282\u70b9\u4fe1\u606f\u4ea7\u751f\u7684\u65f6\u70b9\u4e0d\u540c\u3001\u50a8\u5b58\u7684\u6570\u636e\u8868\u4e0d\u540c\u3002\u5782\u76f4\u6574\u5408\u5c31\u662f\u5c06\u540c\u4e00\u4e1a\u52a1\u4e2d\u5404\u5173\u952e\u8282\u70b9\u4fe1\u606f\u6574\u5408\u81f3\u4e1a\u52a1\u5168\u6d41\u7a0b\u5bbd\u8868\u6a21\u578b\u4e2d\u3002\u9a6c\u8702\u7a9d\u8ba2\u5355\u4ea4\u6613\u6a21\u578b\u7684\u6784\u5efa\u5c31\u91c7\u7528\u4e86\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e0b\u6587\u5c06\u8fdb\u884c\u8be6\u7ec6\u4ecb\u7ecd\u3002</li>\n</ul>\n<h3 id=\"32\">3.2 \u8bbe\u8ba1\u76ee\u6807<a class=\"headerlink\" href=\"#32\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5728\u6a21\u578b\u8bbe\u8ba1\u4e0a\u4ee5\u51c6\u786e\u6027\u3001\u6613\u7528\u6027\u3001\u53ca\u65f6\u6027\u4e3a\u8bbe\u8ba1\u76ee\u6807\uff0c\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u4eba\u5458\u5bf9\u6570\u636e\u7684\u591a\u6837\u9700\u6c42\u3002</p>\n<ul>\n<li><strong>\u51c6\u786e\u6027</strong>\uff1a\u6570\u636e\u8d28\u91cf\u7ba1\u63a7\u8981\u5728\u5efa\u6a21\u8fc7\u7a0b\u4e2d\u843d\u5730\uff0c\u4e3a\u6570\u636e\u51c6\u786e\u6027\u4fdd\u9a7e\u62a4\u822a\u3002</li>\n<li><strong>\u6613\u7528\u6027</strong>\uff1a\u517c\u987e\u6a21\u578b\u7684\u53ef\u6269\u5c55\u6027\u548c\u53ef\u7406\u89e3\u6027\u3002</li>\n<li><strong>\u53ca\u65f6\u6027</strong>\uff1a\u5145\u5206\u8003\u8651\u6a21\u578b\u7684\u4f7f\u7528\u6548\u7387\uff0c\u63d0\u4f9b\u65b9\u4fbf\u5feb\u6377\u7684\u6570\u636e\u67e5\u8be2\u548c\u6570\u636e\u8ba1\u7b97\u670d\u52a1\u3002</li>\n</ul>\n<h3 id=\"33\">3.3 \u8bbe\u8ba1\u6d41\u7a0b<a class=\"headerlink\" href=\"#33\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9a6c\u8702\u7a9d\u6570\u4ed3\u6a21\u578b\u8bbe\u8ba1\u7684\u6574\u4f53\u6d41\u7a0b\u6d89\u53ca\u9700\u6c42\u8c03\u7814\u3001\u6a21\u578b\u8bbe\u8ba1\u3001\u5f00\u53d1\u6d4b\u8bd5\u3001\u6a21\u578b\u4e0a\u7ebf\u56db\u4e2a\u4e3b\u8981\u73af\u8282\uff0c\u4e14\u89c4\u8303\u8bbe\u8ba1\u4e86\u6bcf\u4e2a\u9636\u6bb5\u7684\u8f93\u51fa\u4e0e\u8f93\u5165\u6587\u6863\u3002</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwRNN99DYsv9PewPjpRhykkKOzQiagYBOzBoVhF1Y2Z5VjYrkMasVYicmg/640?wx_fmt=png\" /></p>\n<ol>\n<li><strong>\u9700\u6c42\u8c03\u7814</strong>\uff1a\u6536\u96c6\u548c\u7406\u89e3\u4e1a\u52a1\u65b9\u9700\u6c42\uff0c\u5c31\u7279\u5b9a\u9700\u6c42\u7684\u53e3\u5f84\u8fbe\u6210\u7edf\u4e00\uff0c\u5728\u5bf9\u9700\u6c42\u4e2d\u6d89\u53ca\u5230\u7684\u4e1a\u52a1\u7cfb\u7edf\u6216\u7cfb\u7edf\u6a21\u5757\u6240\u627f\u62c5\u7684\u529f\u80fd\u8fdb\u884c\u68b3\u7406\u540e\u8fdb\u884c\u8868\u5b57\u6bb5\u7ea7\u5206\u6790\uff0c\u5e76\u5bf9\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\uff0c\u786e\u4fdd\u73b0\u6709\u6570\u636e\u80fd\u591f\u652f\u6301\u4e1a\u52a1\u9700\u6c42\u3002</li>\n<li><strong>\u6a21\u578b\u8bbe\u8ba1</strong>\uff1a\u6839\u636e\u9700\u6c42\u548c\u4e1a\u52a1\u8c03\u7814\u7ed3\u679c\u5bf9\u6a21\u578b\u8fdb\u884c\u521d\u6b65\u5f52\u7c7b\uff0c\u9009\u62e9\u5408\u9002\u7684\u4e3b\u9898\u57df\u8fdb\u884c\u6a21\u578b\u5b58\u653e\uff1b\u786e\u5b9a\u4e3b\u9898\u540e\u8fdb\u5165\u6570\u636e\u6a21\u578b\u7684\u8bbe\u8ba1\u9636\u6bb5\uff0c\u903b\u8f91\u6a21\u578b\u8bbe\u8ba1\u8fc7\u7a0b\u8981\u8003\u8651\u603b\u7ebf\u7ed3\u6784\u6784\u5efa\u3001\u6a21\u578b\u89c4\u8303\u5b9a\u4e49\u7b49\u5173\u952e\u95ee\u9898\uff1b\u7269\u7406\u6a21\u578b\u8bbe\u8ba1\u4ee5\u903b\u8f91\u6a21\u578b\u4e3a\u57fa\u7840\uff0c\u517c\u987e\u5b58\u50a8\u6027\u80fd\u7b49\u56e0\u7d20\u5bf9\u903b\u8f91\u6a21\u578b\u505a\u7684\u7269\u7406\u5316\u7684\u8fc7\u7a0b\uff0c\u662f\u903b\u8f91\u6a21\u578b\u7684\u6700\u7ec8\u7269\u7406\u5b9e\u73b0.\u7269\u7406\u6a21\u578b\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u4e0e\u903b\u8f91\u6a21\u578b\u4fdd\u6301\u4e00\u81f4\uff0c\u6a21\u578b\u8bbe\u8ba1\u5b8c\u6210\u540e\u9700\u8981\u8fdb\u5165\u8bc4\u5ba1\u4e0e Mapping \u8bbe\u8ba1\u3002</li>\n<li><strong>\u6a21\u578b\u5f00\u53d1</strong>\uff1a\u5c31\u662f\u5bf9\u6a21\u578b\u8ba1\u7b97\u811a\u672c\u7684\u4ee3\u7801\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u6570\u636e\u6620\u5c04\u3001\u811a\u672c\u5b9e\u73b0\u3001\u6d4b\u8bd5\u9a8c\u8bc1\u7b49\u5f00\u53d1\u8fc7\u7a0b\u3002\u5355\u5143\u6d4b\u8bd5\u5b8c\u6210\u540e\u9700\u8981\u901a\u77e5\u4e1a\u52a1\u65b9\u4e00\u8d77\u5bf9\u6a21\u578b\u6570\u636e\u8fdb\u884c\u4e1a\u52a1\u9a8c\u8bc1\uff0c\u5bf9\u9a8c\u8bc1\u95ee\u9898\u505a\u6536\u96c6\uff0c\u8fd4\u56de\u9a8c\u8bc1\u6a21\u578b\u8bbe\u8ba1\u7684\u5408\u7406\u6027\u3002</li>\n<li><strong>\u6a21\u578b\u4e0a\u7ebf</strong>\uff1a\u5b8c\u6210\u9a8c\u8bc1\u540e\u7684\u6a21\u578b\u5c31\u53ef\u4ee5\u5728\u7ebf\u4e0a\u751f\u4ea7\u73af\u5883\u8fdb\u884c\u90e8\u7f72\u3002\u4e0a\u7ebf\u540e\u9700\u8981\u4e3a\u6a21\u578b\u914d\u7f6e\u76d1\u63a7\uff0c\u53ca\u65f6\u638c\u63e1\u4e3a\u4e1a\u52a1\u63d0\u4f9b\u6570\u636e\u670d\u52a1\u7684\u72b6\u51b5\u3002\u6211\u4eec\u8fd8\u5c06\u6a21\u578b\u7684\u5b9e\u4f53\u548c\u5c5e\u6027\u8bf4\u660e\u6587\u6863\u53d1\u5e03\u7ed9\u4ed3\u5e93\u6570\u636e\u7684\u4f7f\u7528\u8005\uff0c\u4f7f\u6a21\u578b\u5f97\u5230\u66f4\u597d\u5730\u5e94\u7528\u3002</li>\n</ol>\n<h3 id=\"34\">3.4 \u4e3b\u9898\u5206\u7c7b<a class=\"headerlink\" href=\"#34\" title=\"Permanent link\">&para;</a></h3>\n<p>\u57fa\u4e8e\u5bf9\u76ee\u524d\u5404\u4e2a\u90e8\u95e8\u548c\u4e1a\u52a1\u7cfb\u7edf\u7684\u68b3\u7406\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5171\u8bbe\u8ba1\u4e86 4 \u4e2a\u5927\u6570\u636e\u57df(\u4ea4\u6613\u3001\u6d41\u91cf\u3001\u5185\u5bb9\u3001\u53c2\u4e0e\u4eba)\uff0c\u7ec6\u5206\u4e3a 11 \u4e2a\u4e3b\u9898\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwEGjw5dBEAicnIZVbpRmUGUjGB5YONpWpKovulCEXTCPAOkOzy3hLy1w/640?wx_fmt=png\" /></p>\n<p>\u4ee5\u9a6c\u8702\u7a9d\u8ba2\u5355\u4ea4\u6613\u6a21\u578b\u7684\u5efa\u8bbe\u4e3a\u4f8b\uff0c\u57fa\u4e8e\u4e1a\u52a1\u751f\u4ea7\u603b\u7ebf\u7684\u8bbe\u8ba1\u662f\u5e38\u89c1\u7684\u6a21\u5f0f\uff0c\u5373\u9996\u5148\u8c03\u7814\u8ba2\u5355\u4ea4\u6613\u7684\u5b8c\u6574\u8fc7\u7a0b\uff0c\u5b9a\u4f4d\u8fc7\u7a0b\u4e2d\u7684\u5173\u952e\u8282\u70b9\uff0c\u786e\u8ba4\u5404\u8282\u70b9\u4e0a\u53d1\u751f\u7684\u6838\u5fc3\u4e8b\u5b9e\u4fe1\u606f\u3002\u6a21\u578b\u662f\u6570\u636e\u7684\u8f7d\u4f53\uff0c\u6211\u4eec\u8981\u505a\u7684\u5c31\u662f\u901a\u8fc7\u6a21\u578b\uff08\u6216\u8005\u8bf4\u6a21\u578b\u4f53\u7cfb\uff09\u5f52\u7eb3\u751f\u4ea7\u603b\u7ebf\u4e2d\u5404\u4e2a\u8282\u70b9\u53d1\u751f\u7684\u4e8b\u5b9e\u4fe1\u606f\u3002</p>\n<p>\u8ba2\u5355\u751f\u4ea7\u603b\u7ebf\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwuNLS6BkJYlHbibFp5f2qG9SlTCGxoMeYw3xurD1YU8BvLyaVWXpyz4g/640?wx_fmt=png\" /></p>\n<p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u6211\u4eec\u9700\u8981\u63d0\u70bc\u5404\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u4e3a\u4e86\u907f\u514d\u9057\u6f0f\u5173\u952e\u4fe1\u606f\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u62bd\u8c61\u8ba4\u4e3a\u8282\u70b9\u7684\u53c2\u4e0e\u4eba\u3001\u53d1\u751f\u65f6\u95f4\u3001\u53d1\u751f\u4e8b\u4ef6\u3001\u53d1\u751f\u534f\u8bae\u5c5e\u4e8e\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u9700\u8981\u91cd\u70b9\u83b7\u53d6\u3002\u4ee5\u4e0b\u5355\u8282\u70b9\u4e3a\u4f8b\uff0c\u53c2\u4e0e\u4eba\u5305\u62ec\u4e0b\u5355\u7528\u6237\u3001\u670d\u52a1\u5546\u5bb6\u3001\u5e73\u53f0\u8fd0\u8425\u4eba\u5458\u7b49\uff1b\u53d1\u751f\u65f6\u95f4\u5305\u62ec\u7528\u6237\u7684\u4e0b\u5355\u65f6\u95f4\u3001\u5546\u5bb6\u7684\u786e\u8ba4\u65f6\u95f4\u7b49\uff1b\u53d1\u751f\u7684\u4e8b\u4ef6\u5373\u7528\u6237\u8d2d\u4e70\u4e86\u5546\u54c1\uff0c\u9700\u8981\u8bb0\u5f55\u56f4\u7ed5\u8fd9\u4e00\u4e8b\u4ef6\u4ea7\u751f\u7684\u76f8\u5173\u4fe1\u606f\uff1b\u53d1\u751f\u534f\u8bae\u5373\u4ea7\u751f\u7684\u8ba2\u5355\uff0c\u8ba2\u5355\u91d1\u989d\u3001\u7ea6\u5b9a\u5185\u5bb9\u7b49\u90fd\u662f\u6211\u4eec\u9700\u8981\u8bb0\u5f55\u7684\u534f\u8bae\u4fe1\u606f\u3002</p>\n<p>\u5728\u8fd9\u6837\u7684\u601d\u8def\u4e0b\uff0c\u603b\u7ebf\u67b6\u6784\u53ef\u4ee5\u5728\u6a21\u578b\u4e2d\u4e0d\u65ad\u6dfb\u52a0\u5404\u4e2a\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u4f7f\u6a21\u578b\u652f\u6491\u7684\u5e94\u7528\u8303\u56f4\u9010\u6b65\u6269\u5c55\u3001\u8d8b\u4e8e\u5b8c\u5584\u3002\u56e0\u6b64\uff0c\u5bf9\u4e1a\u52a1\u6d41\u7a0b\u7684\u7406\u89e3\u7a0b\u5ea6\u5c06\u76f4\u63a5\u5f71\u54cd\u4ea7\u51fa\u6a21\u578b\u7684\u8d28\u91cf\u3002</p>\n<p>\u6d89\u53ca\u7684\u4e1a\u52a1\u8282\u70b9\u8d8a\u591a\uff0c\u4e1a\u52a1\u6d41\u7a0b\u4e5f\u5c31\u8d8a\u590d\u6742\u3002\u4ece\u6570\u636e\u7684\u89d2\u5ea6\u770b\uff0c\u8fd9\u4e9b\u4e1a\u52a1\u8fc7\u7a0b\u4f1a\u4ea7\u751f\u4e24\u79cd\u57fa\u672c\u7684\u573a\u666f\u5f62\u6001\uff0c\u5373\u6570\u636e\u7684\u62c6\u5206\u548c\u6c47\u805a\u3002\u968f\u7740\u6d41\u7a0b\u7684\u63a8\u8fdb\uff0c\u524d\u4e00\u8282\u70b9\u7684\u539f\u5b50\u4e1a\u52a1\u5355\u4f4d\u5728\u65b0\u8282\u70b9\u4e2d\u53ef\u80fd\u9700\u8981\u62c6\u5206\u51fa\u66f4\u591a\u4fe1\u606f\uff0c\u6216\u8005\u53c2\u4e0e\u5230\u65b0\u8282\u70b9\u7684\u591a\u5411\u6d41\u7a0b\u3002\u540c\u6837\uff0c\u4e5f\u53ef\u80fd\u53d1\u751f\u6570\u636e\u7684\u6c47\u805a\u3002\u4ee5\u67d0\u4e2a\u8ba2\u5355\u4e3a\u4f8b\uff0c\u4e0b\u5355\u8282\u70b9\u6570\u636e\u662f\u8ba2\u5355\u7c92\u5ea6\u7684\uff0c\u800c\u5230\u652f\u4ed8\u8282\u70b9\u5c31\u53d1\u751f\u4e86\u6570\u636e\u62c6\u5206\u3002\u6570\u636e\u7684\u62c6\u5206\u3001\u6c47\u805a\u4f34\u968f\u7740\u603b\u7ebf\u7684\u5404\u8282\u70b9\uff0c\u53ef\u80fd\u4f1a\u4e00\u76f4\u53d1\u6563\u4e0b\u53bb\u3002</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwL21ZGVfJJAAaSJ2G1lFFe9IlSEMwN2sMkazpqn2GjiavnwGcuHQBxiag/640?wx_fmt=png\" /></p>\n<p>\u9274\u4e8e\u4e0a\u8ff0\u60c5\u51b5\uff0c\u5728\u6a21\u578b\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u4e0d\u80fd\u628a\u5404\u8282\u70b9\u4e0d\u540c\u7c92\u5ea6\u7684\u6570\u636e\u4fe1\u606f\u90fd\u5806\u780c\u5728\u4e00\u8d77\uff0c\u90a3\u6837\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u5197\u4f59\u4fe1\u606f\uff0c\u4e5f\u4f1a\u4f7f\u6a21\u578b\u672c\u8eab\u7684\u5b9a\u4f4d\u4e0d\u6e05\u6670\uff0c\u5f71\u54cd\u4f7f\u7528\u3002\u56e0\u6b64\uff0c\u9700\u8981\u8f93\u51fa\u4e0d\u540c\u7c92\u5ea6\u7684\u6a21\u578b\u6765\u6ee1\u8db3\u5404\u7c7b\u5e94\u7528\u9700\u6c42\u3002\u4f8b\u5982\u65e2\u4f1a\u5b58\u5728\u8ba2\u5355\u7c92\u5ea6\u7684\u6570\u636e\u6a21\u578b\uff0c\u4e5f\u4f1a\u5b58\u5728\u5206\u6790\u5404\u4e2a\u8ba2\u5355\u5728\u4e0d\u540c\u65f6\u95f4\u8282\u70b9\u72b6\u6001\u4fe1\u606f\u7684\u6570\u636e\u6a21\u578b\u3002</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwF1bohjjbspvMFgibY61jq897GbFSBGJj0kiccaD1w9MYxH0VWxw58jkw/640?wx_fmt=png\" /></p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwKHAaNzKoYhM5eyTYkEMRXBmtlia1tp1p2Sq6Rn7npf2HOOlADcbdRtQ/640?wx_fmt=png\" /></p>\n<p>\u57fa\u4e8e\u7ef4\u5ea6\u5efa\u6a21\u7684\u601d\u8def\uff0c\u5728\u6a21\u578b\u6574\u5408\u751f\u4ea7\u603b\u7ebf\u5404\u8282\u70b9\u6838\u5fc3\u4fe1\u606f\u4e4b\u540e\uff0c\u4f1a\u6839\u636e\u8fd9\u4e9b\u8282\u70b9\u4fe1\u606f\u8fdb\u4e00\u6b65\u6269\u5c55\u5e38\u7528\u7684\u5206\u6790\u7ef4\u5ea6\uff0c\u4ee5\u51cf\u5c11\u5e94\u7528\u5c42\u9762\u9891\u7e41\u5173\u8054\u76f8\u5173\u5206\u6790\u7ef4\u5ea6\u5e26\u6765\u7684\u8d44\u6e90\u6d88\u8017\uff0c\u6a21\u578b\u4f1a\u53cd\u8303\u5f0f\u5197\u4f59\u76f8\u5173\u7ef4\u5ea6\u4fe1\u606f\uff0c\u4ee5\u83b7\u53d6\u5e94\u7528\u5c42\u7684\u4f7f\u7528\u4fbf\u6377\u3002\u6700\u7ec8\u5efa\u7acb\u4e00\u4e2a\u6574\u5408\u65c5\u6e38\u3001\u4ea4\u901a\u3001\u9152\u5e97\u7b49\u5404\u4e1a\u52a1\u7ebf\u4e0e\u5404\u4e1a\u52a1\u8282\u70b9\u4fe1\u606f\u7684\u9a6c\u8702\u7a9d\u5168\u6d41\u7a0b\u8ba2\u5355\u6a21\u578b\u3002</p>\n<h2 id=\"part4\">Part.4 \u6570\u636e\u4ed3\u5e93\u5de5\u5177\u94fe\u5efa\u8bbe<a class=\"headerlink\" href=\"#part4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e3a\u63d0\u5347\u6570\u636e\u751f\u4ea7\u529b\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5efa\u7acb\u4e86\u4e00\u5957\u5de5\u5177\u94fe\uff0c\u6765\u5b9e\u73b0\u91c7\u96c6\u3001\u7814\u53d1\u3001\u7ba1\u7406\u6d41\u7a0b\u7684\u81ea\u52a8\u5316\u3002\u73b0\u9636\u6bb5\u6bd4\u8f83\u91cd\u8981\u7684\u6709\u4ee5\u4e0b\u4e09\u5927\u5de5\u5177\uff1a</p>\n<h3 id=\"1\">1. \u6570\u636e\u540c\u6b65\u5de5\u5177<a class=\"headerlink\" href=\"#1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u540c\u6b65\u5de5\u5177\u4e3b\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a</p>\n<ul>\n<li>\u4ece\u6e90\u7cfb\u7edf\u540c\u6b65\u6570\u636e\u5230\u6570\u636e\u4ed3\u5e93</li>\n<li>\u5c06\u6570\u636e\u4ed3\u5e93\u7684\u6570\u636e\u540c\u6b65\u81f3\u5176\u4ed6\u73af\u5883</li>\n</ul>\n<p>\u4e0b\u9762\u91cd\u70b9\u4ecb\u7ecd\u4ece\u6e90\u7cfb\u7edf\u540c\u6b65\u6570\u636e\u5230\u6570\u636e\u4ed3\u5e93\u3002</p>\n<p>\u9a6c\u8702\u7a9d\u7684\u6570\u636e\u540c\u6b65\u8bbe\u8ba1\u652f\u6491\u7075\u6d3b\u7684\u6570\u636e\u63a5\u5165\u65b9\u5f0f\uff0c\u53ef\u4ee5\u9009\u62e9\u62bd\u53d6\u65b9\u5f0f\u4ee5\u53ca\u52a0\u5de5\u65b9\u5f0f\u3002\u62bd\u53d6\u65b9\u5f0f\u4e3b\u8981\u5305\u62ec\u589e\u91cf\u62bd\u53d6\u6216\u8005\u5168\u91cf\u62bd\u53d6\uff0c\u52a0\u5de5\u65b9\u5f0f\u9762\u5411\u6570\u636e\u7684\u5b58\u50a8\u65b9\u5f0f\uff0c\u662f\u9700\u8981\u5bf9\u6570\u636e\u8fdb\u884c\u62c9\u94fe\u5f0f\u4fdd\u5b58\uff0c\u6216\u8005\u4ee5\u6d41\u6c34\u65e5\u5fd7\u7684\u65b9\u5f0f\u8fdb\u884c\u5b58\u50a8\u3002</p>\n<p>\u63a5\u5165\u65f6\uff0c\u53ea\u9700\u8981\u586b\u5199\u6570\u636e\u8868\u4fe1\u606f\u914d\u7f6e\uff0c\u4ee5\u53ca\u5177\u4f53\u7684\u5b57\u6bb5\u914d\u7f6e\u4fe1\u606f\uff0c\u6570\u636e\u5c31\u53ef\u4ee5\u81ea\u52a8\u63a5\u5165\u5230\u6570\u636e\u4ed3\u5e93\uff0c\u5f62\u6210\u6570\u4ed3\u7684 ODS \u5c42\u6570\u636e\u6a21\u578b\uff0c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwLm8Iu11g176vbqiayibzfOqUeIzQRZYp83jZ8mhvyhZR5iakEGIHWVpog/640?wx_fmt=png\" /></p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwian28VwXH4baw0zeGF8asPATibibsyYWHbsqcBEdsicLmbIfZ0CrtVcPrQ/640?wx_fmt=png\" /></p>\n<h3 id=\"2\">2. \u4efb\u52a1\u8c03\u5ea6\u5e73\u53f0<a class=\"headerlink\" href=\"#2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u4f7f\u7528 Airflow \u914d\u5408\u81ea\u7814\u7684\u4efb\u52a1\u8c03\u5ea6\u7cfb\u7edf\uff0c\u4e0d\u4ec5\u80fd\u652f\u6301\u5e38\u89c4\u7684\u4efb\u52a1\u8c03\u5ea6\uff0c\u8fd8\u53ef\u4ee5\u652f\u6301\u4efb\u52a1\u8c03\u5ea6\u7cfb\u7edf\u5404\u7c7b\u6570\u636e\u91cd\u8dd1\uff0c\u5386\u53f2\u8865\u6570\u7b49\u9700\u6c42\u3002</p>\n<p>\u522b\u5c0f\u770b\u6570\u636e\u91cd\u8dd1\u3001\u5386\u53f2\u8865\u6570\uff0c\u8fd9\u4e24\u9879\u529f\u80fd\u662f\u5728\u9009\u62e9\u8c03\u5ea6\u5de5\u5177\u4e2d\u91cd\u8981\u7684\u53c2\u8003\u9879\u3002\u505a\u6570\u636e\u7684\u4eba\u90fd\u6e05\u695a\uff0c\u5728\u5b9e\u9645\u6570\u636e\u5904\u7406\u8fc7\u7a0b\u4e2d\u4f1a\u9762\u4e34\u8bf8\u591a\u7684\u6570\u636e\u53e3\u5f84\u53d8\u5316\u3001\u6570\u636e\u5f02\u5e38\u7b49\uff0c\u9700\u8981\u8fdb\u884c\u6570\u636e\u91cd\u8dd1\u3001\u5237\u65b0\u3001\u8865\u6570\u7b49\u64cd\u4f5c\u3002</p>\n<p>\u6211\u4eec\u8bbe\u8ba1\u7684\u300c\u4e00\u952e\u91cd\u8dd1\u300d\u529f\u80fd\uff0c\u53ef\u4ee5\u5c06\u76f8\u5173\u4efb\u52a1\u4f9d\u8d56\u7684\u540e\u7f6e\u4efb\u52a1\u5168\u90e8\u5e26\u51fa\uff0c\u5e76\u652f\u6301\u9009\u62e9\u6027\u5730\u5220\u9664\u6216\u865a\u62df\u6267\u884c\u4efb\u610f\u8282\u70b9\u7684\u4efb\u52a1\uff1a</p>\n<ul>\n<li>\u5982\u679c\u9009\u62e9\u5220\u9664\uff0c\u8fd9\u8be5\u4efb\u52a1\u4e4b\u540e\u6240\u4f9d\u8d56\u7684\u4efb\u52a1\u5747\u4e0d\u6267\u884c</li>\n<li>\u5982\u679c\u9009\u62e9\u865a\u62df\u6267\u884c\uff0c\u5219\u4f1a\u5ffd\u7565\uff08\u7a7a\u8dd1\uff09\u6389\u8be5\u4efb\u52a1\uff0c\u540e\u7f6e\u7684\u6240\u6709\u4f9d\u8d56\u4efb\u52a1\u8fd8\u662f\u4f1a\u6b63\u5e38\u6267\u884c\u3002</li>\n</ul>\n<p>\u5982\u4e0b\u662f\u57fa\u4e8e\u67d0\u4e00\u4e2a\u4efb\u52a1\u91cd\u8dd1\u4e0b\u6e38\u6240\u6709\u4efb\u52a1\u6240\u5217\u51fa\u7684\u5173\u7cfb\u56fe\uff0c\u9009\u4e2d\u5177\u4f53\u7684\u6267\u884c\u8282\u70b9\uff0c\u5c31\u53ef\u4ee5\u6267\u884c\u5ffd\u7565\u6216\u8005\u5220\u9664\u3002</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwn9CdHmlOcWsLfw2G7VZg7s0ic5VINTMEF3OetPAjyqwhImIzws4Sk2w/640?wx_fmt=png\" /></p>\n<h3 id=\"3\">3. \u5143\u6570\u636e\u7ba1\u7406\u5de5\u5177<a class=\"headerlink\" href=\"#3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5143\u6570\u636e\u8303\u7574\u5305\u62ec\u6280\u672f\u5143\u6570\u636e\u3001\u4e1a\u52a1\u5143\u6570\u636e\u3001\u7ba1\u7406\u5143\u6570\u636e\uff0c\u5728\u6982\u5ff5\u4e0a\u4e0d\u505a\u8fc7\u591a\u9610\u8ff0\u4e86\u3002\u5143\u6570\u636e\u7ba1\u7406\u5728\u6570\u636e\u5efa\u8bbe\u8d77\u7740\u4e3e\u8db3\u8f7b\u91cd\u7684\u4f5c\u7528\uff0c\u8fd9\u90e8\u5206\u5728\u6570\u4ed3\u5e94\u7528\u4e2d\u4e3b\u8981\u6709 2 \u4e2a\u70b9\uff1a</p>\n<p><strong>\uff081\uff09\u8840\u7f18\u7ba1\u7406</strong></p>\n<p>\u8840\u7f18\u7ba1\u7406\u53ef\u4ee5\u8ffd\u6eaf\u6570\u636e\u52a0\u5de5\u6574\u4f53\u94fe\u8def\uff0c\u89e3\u6790\u8868\u7684\u6765\u9f99\u53bb\u8109\uff0c\u7528\u4e8e\u652f\u6491\u5404\u7c7b\u573a\u666f\uff0c\u5982\uff1a</p>\n<ul>\n<li>\u652f\u6301\u4e0a\u6e38\u53d8\u66f4\u5bf9\u4e0b\u6e38\u5f71\u54cd\u7684\u5206\u6790\u4e0e\u8c03\u6574</li>\n<li>\u76d1\u63a7\u5404\u8282\u70b9\u3001\u5404\u94fe\u8def\u4efb\u52a1\u8fd0\u884c\u6210\u672c\uff0c\u6548\u7387</li>\n<li>\u76d1\u63a7\u6570\u636e\u6a21\u578b\u7684\u4f9d\u8d56\u6570\u91cf\uff0c\u786e\u8ba4\u54ea\u4e9b\u662f\u91cd\u70b9\u6a21\u578b</li>\n</ul>\n<p>\u5982\u4e0b\u662f\u67d0\u4e00\u4e2a\u6570\u636e\u6a21\u578b\u4e2d\u7684\u8840\u7f18\u56fe\uff0c\u4e0a\u4e0b\u6e38\u4ee5\u4e0d\u540c\u989c\u8272\u8fdb\u884c\u5448\u73b0\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwfM3MROS0rqZibN5B8kMcGqJ4BWuWtd8YNB9Hqas606044LG6DPeyX4g/640?wx_fmt=png\" /></p>\n<p><strong>\uff082\uff09\u6570\u636e\u77e5\u8bc6\u7ba1\u7406</strong></p>\n<p>\u901a\u8fc7\u5bf9\u6280\u672f\u3001\u4e1a\u52a1\u5143\u6570\u636e\u8fdb\u884c\u6e05\u6670\u3001\u8be6\u5c3d\u5730\u63cf\u8ff0\uff0c\u5f62\u6210\u6570\u636e\u77e5\u8bc6\uff0c\u7ed9\u6570\u636e\u4eba\u5458\u63d0\u4f9b\u66f4\u597d\u7684\u4f7f\u7528\u5411\u5bfc\u3002\u6211\u4eec\u7684\u6570\u636e\u77e5\u8bc6\u4e3b\u8981\u5305\u62ec\u5b9e\u4f53\u8bf4\u660e\u4e0e\u5c5e\u6027\u8bf4\u660e\uff0c\u5177\u4f53\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwyTSXYYOYU0pJY8HShia9rcqpeosxooiaic5jyt7xybvHZ7l6FMe64z7IQ/640?wx_fmt=png\" /></p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwXa13t5MdjMa8cianibGOreibricQ82qJEWeRQvm9ZGs9PLqPWJ0owSjiaiaA/640?wx_fmt=png\" /></p>\n<p>\u5f53\u7136\uff0c\u6570\u4ed3\u5de5\u5177\u94fe\u6761\u4e2d\u8fd8\u6709\u975e\u5e38\u591a\u5de5\u5177\uff0c\u4f8b\u5982\u81ea\u52a8\u5316\u5efa\u6a21\u5de5\u5177\uff0c\u6570\u636e\u8d28\u91cf\u7ba1\u7406\u5de5\u5177\uff0c\u6570\u636e\u5f00\u53d1\u5de5\u5177\u7b49\uff0c\u90fd\u5df2\u7ecf\u5f97\u5230\u4e86\u5f88\u597d\u5730\u5b9e\u73b0\u3002</p>\n<h2 id=\"part5\">Part.5 \u6570\u4ed3\u5e94\u7528\u2014\u2014\u6307\u6807\u5e73\u53f0<a class=\"headerlink\" href=\"#part5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6709\u4e86\u5408\u7406\u7684\u6570\u4ed3\u67b6\u6784\u3001\u5de5\u5177\u94fe\u6761\u652f\u6491\u6570\u636e\u7814\u53d1\uff0c\u63a5\u4e0b\u6765\uff0c\u5c31\u8981\u8003\u8651\u5982\u4f55\u628a\u4ea7\u51fa\u7684\u6570\u636e\u5bf9\u5916\u8d4b\u80fd\u3002\u4e0b\u9762\u4ee5\u9a6c\u8702\u7a9d\u6570\u636e\u5e94\u7528\u5229\u5668-\u6307\u6807\u5e73\u53f0\uff0c\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd\u3002</p>\n<p>\u51e0\u4e4e\u6240\u6709\u7684\u4f01\u4e1a\u90fd\u4f1a\u6784\u5efa\u81ea\u5df1\u7684\u6307\u6807\u5e73\u53f0\uff0c\u6bcf\u4e2a\u4f01\u4e1a\u5efa\u7acb\u7684\u6807\u51c6\u90fd\u4e0d\u4e00\u6837\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u4f1a\u9047\u5230\u6307\u6807\u7e41\u591a\u3001\u5b9a\u4e49\u4e0d\u6e05\u695a\u3001\u67e5\u8be2\u7f13\u6162\u7b49\u95ee\u9898\u3002\u4e3a\u5c3d\u91cf\u907f\u514d\u8fd9\u4e9b\u95ee\u9898\uff0c\u6307\u6807\u5e73\u53f0\u5728\u8bbe\u8ba1\u65f6\u9700\u8981\u9075\u5faa\u51e0\u5927\u539f\u5219\uff1a</p>\n<ol>\n<li>\u6307\u6807\u5b9a\u4e49\u6807\u51c6\uff0c\u6e05\u6670\uff0c\u5bb9\u6613\u7406\u89e3\uff0c\u4e14\u4e0d\u5b58\u5728\u4e8c\u4e49\u6027\uff0c\u5206\u7c7b\u660e\u786e</li>\n<li>\u6307\u6807\u751f\u4ea7\u8fc7\u7a0b\u7b80\u5355\u3001\u900f\u660e\u3001\u53ef\u914d\u7f6e\u5316</li>\n<li>\u6307\u6807\u67e5\u8be2\u6548\u7387\u9700\u8981\u6ee1\u8db3\u5feb\u901f\u54cd\u5e94</li>\n<li>\u6307\u6807\u6743\u9650\u7ba1\u7406\u7075\u6d3b\u53ef\u63a7</li>\n</ol>\n<p>\u57fa\u4e8e\u4ee5\u4e0a\u539f\u5219\uff0c\u9a6c\u8702\u7a9d\u7684\u6307\u6807\u5e73\u53f0\u6309\u7167\u7cbe\u7ec6\u5316\u7684\u8bbe\u8ba1\u8fdb\u884c\u6253\u9020\uff0c\u6307\u6807\u5e73\u53f0\u7ec4\u6210\u67b6\u6784\u5982\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"https://mmbiz.qpic.cn/mmbiz_png/69F4CS2PEMv2FMfNTDox8rdCj8ym7LKwFzksUUqGJvBAZWOG0gn8ckUb6Y5gaTTIj01cHBsMVJLiaVAgY8OcbTQ/640?wx_fmt=png\" /></p>\n<p>\u5176\u4e2d\uff1a</p>\n<ol>\n<li>\u6570\u636e\u4ed3\u5e93\u662f\u6307\u6807\u6570\u636e\u7684\u6765\u6e90\uff0c\u6240\u6709\u6307\u6807\u76ee\u524d\u90fd\u662f\u901a\u8fc7\u6570\u636e\u4ed3\u5e93\u7edf\u4e00\u52a0\u5de5\u7684</li>\n<li>\u6307\u6807\u7ba1\u7406\u5305\u62ec\u6307\u6807\u521b\u5efa\u4e0e\u6307\u6807\u5143\u6570\u636e\u7ba1\u7406\uff1a\u6570\u4ed3\u8d1f\u8d23\u751f\u4ea7\u5e76\u521b\u5efa\u6700\u6838\u5fc3\u3001\u6700\u57fa\u7840\u7684\u6307\u6807\uff1b\u5176\u4ed6\u4eba\u5458\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e9b\u6307\u6807\uff0c\u6309\u7167\u89c4\u5219\u8fdb\u884c\u6307\u6807\u7684\u6d3e\u751f\uff1b\u5143\u6570\u636e\u7ba1\u7406\u8bb0\u5f55\u6307\u6807\u7684\u5177\u4f53\u6765\u6e90\u8def\u5f84\uff0c\u8bf4\u660e\u6307\u6807\u7684\u6570\u636e\u6765\u6e90\u662f\u6570\u4ed3\u8868\uff0c\u6216\u8005\u662f Kylin\uff0cMySQL \u6216 ES</li>\n<li>\u6307\u6807\u5b57\u5178\u5bf9\u5916\u5448\u73b0\u6307\u6807\u7684\u5b9a\u4e49\u3001\u53e3\u5f84\u3001\u8bf4\u660e\u7b49\uff0c\u4fdd\u8bc1\u6307\u6807\u7684\u900f\u660e\u5316\u53ca\u53ef\u89e3\u91ca\u6027</li>\n<li>\u6570\u636e\u670d\u52a1\u63a5\u53d7\u6307\u6807\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u9488\u5bf9\u4e0d\u540c\u573a\u666f\u5224\u65ad\u67e5\u8be2\u7684\u6210\u672c\uff0c\u9009\u62e9\u6700\u4f18\u94fe\u8def\u8fdb\u884c\u6307\u6807\u67e5\u8be2\uff0c\u5e76\u8fd4\u56de\u6307\u6807\u67e5\u8be2\u7684\u7ed3\u679c</li>\n<li>\u591a\u7ef4\u67e5\u8be2\u5c06\u53ef\u4ee5\u63d0\u4f9b\u67e5\u8be2\u670d\u52a1\u7684\u6307\u6807\u4e0e\u7ef4\u5ea6\u901a\u8fc7\u754c\u9762\u5448\u73b0\uff0c\u7528\u6237\u53ef\u4ee5\u57fa\u4e8e\u7ef4\u5ea6\u9009\u62e9\u6307\u6807\u6216\u57fa\u4e8e\u6307\u6807\u9009\u62e9\u7ef4\u5ea6\uff0c\u67e5\u8be2\u5177\u4f53\u9700\u8981\u7684\u6570\u636e</li>\n<li>\u6743\u9650\u7ba1\u7406\u8d2f\u5f7b\u59cb\u7ec8\uff0c\u53ef\u4ee5\u652f\u6301\u8868\u7ea7\u3001\u6307\u6807\u7ea7\u3001\u7ef4\u503c\u7ea7\u522b\u7684\u6743\u9650\u7ba1\u7406</li>\n</ol>\n<h2 id=\"part6\">Part.6 \u603b\u7ed3<a class=\"headerlink\" href=\"#part6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4f01\u4e1a\u7684\u6570\u636e\u5efa\u8bbe\u9700\u8981\u7ecf\u5386\u51e0\u4e2a\u5927\u7684\u6b65\u9aa4\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u6b65\uff0c\u4e1a\u52a1\u6570\u636e\u5316\uff1a\u987e\u540d\u601d\u4e49\uff0c\u4e00\u5207\u4e1a\u52a1\u90fd\u80fd\u901a\u8fc7\u6570\u636e\u53cd\u6620\uff0c\u4e3b\u8981\u6307\u7684\u662f\u5c06\u4f20\u7edf\u7ebf\u4e0b\u6d41\u7a0b\u7ebf\u4e0a\u5316\uff1b</li>\n<li>\u7b2c\u4e8c\u6b65\uff0c\u6570\u636e\u667a\u80fd\u5316\uff1a\u5149\u6709\u6570\u636e\u8fd8\u4e0d\u884c\uff0c\u8fd8\u9700\u8981\u8db3\u591f\u7684\u667a\u80fd\uff0c\u5982\u4f55\u901a\u8fc7\u667a\u80fd\u5316\u7684\u6570\u636e\u652f\u6491\u8fd0\u8425\u3001\u8425\u9500\u53ca\u5404\u7c7b\u4e1a\u52a1\uff0c\u8fd9\u662f\u6570\u636e\u4e2d\u53f0\u5f53\u524d\u89e3\u51b3\u7684\u4e3b\u8981\u95ee\u9898\uff1b</li>\n<li>\u7b2c\u4e09\u6b65\uff0c\u6570\u636e\u4e1a\u52a1\u5316\uff1a\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u6570\u636e\u9a71\u52a8\u4e1a\u52a1\uff0c\u6570\u636e\u4e0d\u80fd\u53ea\u662f\u6570\u636e\uff0c\u6570\u636e\u4ef7\u503c\u6700\u5927\u5316\u5728\u4e8e\u53ef\u4ee5\u9a71\u52a8\u65b0\u7684\u4e1a\u52a1\u521b\u65b0\uff0c\u5e26\u52a8\u4f01\u4e1a\u589e\u957f\u3002</li>\n</ul>\n<p>\u76ee\u524d\u5927\u90e8\u4f01\u4e1a\u76ee\u524d\u90fd\u505c\u7559\u5728\u7b2c\u4e8c\u4e2a\u9636\u6bb5\uff0c\u56e0\u4e3a\u8fd9\u4e00\u6b65\u9700\u8981\u8db3\u591f\u592f\u5b9e\uff0c\u624d\u80fd\u4e3a\u7b2c\u4e09\u6b65\u6253\u597d\u57fa\u7840\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u5404\u5927\u4f01\u4e1a\u8981\u6295\u5165\u5f88\u5927\u6210\u672c\u5230\u5927\u6570\u636e\u5e73\u53f0\u3001\u6570\u636e\u4ed3\u5e93\u4e43\u81f3\u6570\u636e\u4e2d\u53f0\u7684\u5efa\u8bbe\u4e2d\u3002</p>\n<p>\u9a6c\u8702\u7a9d\u6570\u636e\u4e2d\u53f0\u7684\u5efa\u8bbe\u624d\u521a\u521a\u8d77\u6b65\u3002\u6211\u4eec\u8ba4\u4e3a\uff0c\u7406\u60f3\u7684\u6570\u636e\u4e2d\u53f0\u9700\u8981\u5177\u5907**\u6570\u636e\u6807\u51c6\u5316\u3001\u5de5\u5177\u7ec4\u4ef6\u5316\u3001\u7ec4\u7ec7\u6e05\u6670\u5316**\u8fd9\u4e09\u4e2a\u6838\u5fc3\u524d\u63d0\u3002\u4e3a\u4e86\u5411\u8fd9\u4e00\u76ee\u6807\u8fc8\u8fdb\uff0c\u6211\u4eec\u5c06\u5efa\u7acb\u7edf\u4e00\u3001\u6807\u51c6\u5316\u7684\u6570\u636e\u4ed3\u5e93\u4f5c\u4e3a\u5f53\u4e0b\u6570\u636e\u4e2d\u53f0\u7684\u91cd\u70b9\u5de5\u4f5c\u4e4b\u4e00\u3002</p>\n<p>\u6570\u636e\u6765\u6e90\u4e8e\u4e1a\u52a1\uff0c\u6700\u7ec8\u4e5f\u5c06\u5e94\u7528\u4e8e\u4e1a\u52a1\u3002\u53ea\u6709\u5bf9\u6570\u636e\u8db3\u591f\u91cd\u89c6\uff0c\u4e0e\u4e1a\u52a1\u5145\u5206\u8854\u63a5\uff0c\u624d\u80fd\u5b9e\u73b0\u6570\u636e\u4ef7\u503c\u7684\u6700\u5927\u5316\u3002\u5728\u9a6c\u8702\u7a9d\uff0c\u4ece\u7ba1\u7406\u5c42\uff0c\u5230\u516c\u53f8\u7814\u53d1\u3001\u4ea7\u54c1\u3001\u8fd0\u8425\u3001\u9500\u552e\u7b49\u5404\u89d2\u8272\uff0c\u5bf9\u6570\u636e\u975e\u5e38\u91cd\u89c6\uff0c\u6570\u636e\u4ea7\u54c1\u7684\u4f7f\u7528\u4eba\u6570\u5360\u516c\u53f8\u5458\u5de5\u6bd4\u4f8b\u9ad8\u8fbe 75%\u3002</p>\n<p>\u5927\u91cf\u7528\u6237\u7684\u4f7f\u7528\uff0c\u9a71\u52a8\u7740\u6211\u4eec\u5728\u6570\u636e\u4e2d\u53f0\u5efa\u8bbe\u7684\u8def\u4e0a\u4e0d\u65ad\u524d\u8fdb\u3002\u5982\u4f55\u5c06\u65b0\u5174\u6280\u672f\u80fd\u529b\u5e94\u7528\u5230\u6570\u636e\u4ed3\u5e93\u7684\u5efa\u8bbe\uff0c\u5982\u4f55\u4ee5\u6709\u9650\u7684\u6210\u672c\u9ad8\u6548\u89e3\u51b3\u4f01\u4e1a\u5728\u6570\u636e\u5efa\u8bbe\u4e2d\u9762\u4e34\u7684\u95ee\u9898\uff0c\u5c06\u662f\u9a6c\u8702\u7a9d\u6570\u4ed3\u5efa\u8bbe\u4e00\u76f4\u7684\u601d\u8003\u3002</p>\n<p><strong>\u672c\u6587\u4f5c\u8005\uff1a\u989c\u535a\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u7814\u53d1\u8d1f\u8d23\u4eba\u3002</strong></p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["edw", "warehouse"]}, {"id": "https://wgzhao.github.io/notes/bigdata/presto-with-ssl/", "url": "https://wgzhao.github.io/notes/bigdata/presto-with-ssl/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Presto SSL \u914d\u7f6e", "content_html": "<h1 id=\"presto-ssl\">Presto SSL \u914d\u7f6e<a class=\"headerlink\" href=\"#presto-ssl\" title=\"Permanent link\">&para;</a></h1>\n<p>\u8981\u542f\u7528Presto\u7684\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u524d\u63d0\u662f\u8981\u914d\u7f6ePresto\u8282\u70b9\u95f4\u7684\u901a\u8baf\u4e3a\u52a0\u5bc6\u6a21\u5f0f\u3002</p>\n<p>\u6709\u5173\u52a0\u5bc6\u901a\u8baf\u66f4\u8be6\u7ec6\u7684\u8bf4\u660e\u548c\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003<a href=\"https://prestosql.io/docs/current/security/internal-communication.html\">\u5b98\u65b9\u6587\u6863</a></p>\n<p>\u8fd9\u91cc\u4ec5\u8bb0\u5f55\u5728\u5b9e\u9645\u73af\u5883\u4e2d\u5982\u4f55\u914d\u7f6e\uff0c\u4ee5\u4e0b\u914d\u7f6e\u548c\u5206\u53d1\u4f7f\u7528<a href=\"https://github.com/prestodb/presto-admin\">prestoadmin</a>\u5de5\u5177</p>\n<p>\u6ce8\u610f\u4ee5\u4e0b\u64cd\u4f5c\u5747\u5728\u914d\u7f6e\u6709 <code>prestoadmin</code> \u8282\u70b9\u7684 <code>.prestoadmin</code> \u76ee\u5f55\u4e0b\u64cd\u4f5c</p>\n<h2 id=\"_1\">\u524d\u63d0\u8981\u6c42<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6240\u6709\u8282\u70b9\u4e3b\u673a\u540d\u9700\u8981\u6ee1\u8db3FQDN\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u4e3b\u673a\u540d\u52a0\u57df\u540d\uff0c\u6211\u4eec\u751f\u4ea7\u73af\u5883\u7684\u57df\u540d\u662f <code>bigdata.wgzhao.com</code>, \u9884\u53d1\u5e03\u73af\u5883\u4e3a <code>ds.wgzhao.com</code></p>\n<h2 id=\"java-keystore-file\">\u751f\u6210  Java Keystore File \u6587\u4ef6<a class=\"headerlink\" href=\"#java-keystore-file\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u751f\u4ea7</p>\n<div class=\"highlight\"><pre><span></span><code>keytool<span class=\"w\"> </span>-genkeypair<span class=\"w\"> </span>-keyalg<span class=\"w\"> </span>RSA<span class=\"w\"> </span>-keysize<span class=\"w\"> </span><span class=\"m\">2048</span><span class=\"w\"> </span>-validity<span class=\"w\"> </span><span class=\"m\">365</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n-dname<span class=\"w\"> </span><span class=\"s2\">&quot;CN=*.bigdata.wgzhao.com, OU=cfzq,O=com, L=Changsha, ST=Hunan, C=CN&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n-alias<span class=\"w\"> </span>presto_prod<span class=\"w\"> </span>-keypass<span class=\"w\"> </span>JksPassword<span class=\"w\"> </span>-keystore<span class=\"w\"> </span>presto.jks<span class=\"w\"> </span>-storepass<span class=\"w\"> </span>JksPassword\n</code></pre></div>\n<p>\u8fd9\u4e86\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f <code>CN</code> \u7684\u914d\u7f6e\uff0c\u5fc5\u987b\u662f\u6cdb\u57df\u540d\u65b9\u5f0f\uff0c\u800c\u4e14\u57df\u540d\u548c\u5f53\u524d\u8282\u70b9\u7684\u57df\u540d\u76f8\u5339\u914d\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u8bc1\u4e66\u6821\u9a8c\u65e0\u6cd5\u901a\u8fc7\u7684\u9519\u8bef\uff0c\u5bfc\u81f4\u8282\u70b9\u95f4\u901a\u8baf\u5931\u8d25</p>\n<h2 id=\"_2\">\u5c06\u6587\u4ef6\u53d1\u5e03\u5230\u6240\u6709\u8282\u70b9<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h2>\n<p><code>presto-admin file copy ./presto.jks /etc/presto/</code></p>\n<h2 id=\"worker\">\u914d\u7f6e worker \u8282\u70b9<a class=\"headerlink\" href=\"#worker\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u914d\u7f6e  <code>config.properties</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<p><div class=\"highlight\"><pre><span></span><code><span class=\"na\">coordinator</span><span class=\"o\">=</span><span class=\"s\">false</span>\n<span class=\"na\">http-server.http.port</span><span class=\"o\">=</span><span class=\"s\">59999</span>\n<span class=\"na\">discovery.uri</span><span class=\"o\">=</span><span class=\"s\">http://nn01.bigdata.wgzhao.com:59999</span>\n<span class=\"c1\">##SSL</span>\n<span class=\"na\">internal-communication.shared-secret</span><span class=\"o\">=</span><span class=\"s\">UcGm5mjqgDPZ8ojxQ0c9pB</span>\n<span class=\"na\">node.internal-address-source</span><span class=\"o\">=</span><span class=\"s\">FQDN</span>\n<span class=\"na\">http-server.https.enabled</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"na\">http-server.https.port</span><span class=\"o\">=</span><span class=\"s\">15999</span>\n<span class=\"na\">http-server.https.keystore.path</span><span class=\"o\">=</span><span class=\"s\">/etc/presto/presto.jks</span>\n<span class=\"na\">http-server.https.keystore.key</span><span class=\"o\">=</span><span class=\"s\">JksPassword</span>\n<span class=\"na\">discovery.uri</span><span class=\"o\">=</span><span class=\"s\">https://nn01.bigdata.wgzhao.com:15999</span>\n<span class=\"na\">internal-comunication.https.required</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"na\">internal-communication.https.keystore.path</span><span class=\"o\">=</span><span class=\"s\">/etc/presto/presto.jks</span>\n<span class=\"na\">internal-communication.https.keystore.key</span><span class=\"o\">=</span><span class=\"s\">JksPassword</span>\n<span class=\"na\">http-server.https.secure-random-algorithm</span><span class=\"o\">=</span><span class=\"s\">SHA1PRNG</span>\n</code></pre></div>\n\u7136\u540e\u914d\u7f6e <code>jvm.config</code> \u6587\u4ef6\uff0c\u5728\u6700\u540e\u589e\u52a0\u4e00\u884c</p>\n<p><code>-Djava.security.egd=file:/dev/urandom</code></p>\n<h2 id=\"coordinator\">\u914d\u7f6e Coordinator \u8282\u70b9<a class=\"headerlink\" href=\"#coordinator\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u914d\u7f6e  <code>config.properties</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"na\">node-scheduler.include-coordinator</span><span class=\"o\">=</span><span class=\"s\">false</span>\n<span class=\"na\">discovery.uri</span><span class=\"o\">=</span><span class=\"s\">http://nn01.bigdata.wgzhao.com:59999</span>\n<span class=\"na\">discovery-server.enabled</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"na\">http-server.http.port</span><span class=\"o\">=</span><span class=\"s\">59999</span>\n<span class=\"na\">coordinator</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"c1\">#query.max-memory-per-node=8GB</span>\n<span class=\"c1\"># auth setup</span>\n<span class=\"c1\">#http-server.authentication.type=PASSWORD</span>\n\n<span class=\"c1\">##SSL</span>\n<span class=\"na\">internal-communication.shared-secret</span><span class=\"o\">=</span><span class=\"s\">UcGm5mjqgDPZ8ojxQ0c9pB</span>\n<span class=\"na\">node.internal-address-source</span><span class=\"o\">=</span><span class=\"s\">FQDN</span>\n<span class=\"na\">http-server.https.enabled</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"na\">http-server.https.port</span><span class=\"o\">=</span><span class=\"s\">15999</span>\n<span class=\"na\">http-server.https.keystore.path</span><span class=\"o\">=</span><span class=\"s\">/etc/presto/presto.jks</span>\n<span class=\"na\">http-server.https.keystore.key</span><span class=\"o\">=</span><span class=\"s\">JksPassword</span>\n<span class=\"na\">discovery.uri</span><span class=\"o\">=</span><span class=\"s\">https://nn01.bigdata.wgzhao.com:15999</span>\n<span class=\"na\">internal-comunication.https.required</span><span class=\"o\">=</span><span class=\"s\">true</span>\n<span class=\"na\">internal-communication.https.keystore.path</span><span class=\"o\">=</span><span class=\"s\">/etc/presto/presto.jks</span>\n<span class=\"na\">internal-communication.https.keystore.key</span><span class=\"o\">=</span><span class=\"s\">JksPassword</span>\n<span class=\"na\">http-server.https.secure-random-algorithm</span><span class=\"o\">=</span><span class=\"s\">SHA1PRNG</span>\n</code></pre></div>\n<p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u6211\u4eec\u4f9d\u7136\u542f\u7528\u4e86http\u534f\u8bae\uff0c\u8fd9\u662f\u8003\u8651\u5230\u4e00\u4e9b\u5de5\u5177\u94fe\u63a5Presto\u5728SSL\u65b9\u5f0f\u4e0b\u51fa\u73b0\u95ee\u9898\uff0c\u540e\u9762\u4f1a\u7981\u6b62http\u534f\u8bae\uff0c\u4ec5\u542f\u7528https\u534f\u8bae\u3002</p>\n<h2 id=\"_3\">\u5206\u53d1\u914d\u7f6e\u6587\u4ef6<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u91cd\u65b0\u5206\u53d1\u914d\u7f6e\u6587\u4ef6</p>\n<p><code>presto-admin configuration deploy</code></p>\n<h2 id=\"_4\">\u91cd\u542f\u670d\u52a1<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u91cd\u542f\u670d\u52a1\u4f7f\u5f97\u914d\u7f6e\u751f\u6548</p>\n<p><code>presto-admin server restart</code></p>\n<h2 id=\"_5\">\u67e5\u770b<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bbf\u95ee <a href=\"https://nn01.bigdata.wgzhao.com:15999/ui\">https://nn01.bigdata.wgzhao.com:15999/ui</a> \u53ef\u4ee5\u770b\u5230\u901a\u8fc7HTTPS\u65b9\u5f0f\u94fe\u63a5\u7684Presto\u670d\u52a1\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["presto", "security", "ssl", "trino"]}, {"id": "https://wgzhao.github.io/notes/bigdata/zookeeper-optimize/", "url": "https://wgzhao.github.io/notes/bigdata/zookeeper-optimize/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18", "content_html": "<h1 id=\"zookeeper\">zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18<a class=\"headerlink\" href=\"#zookeeper\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"https://codeleading.com/article/77225589233/\" title=\"Permalink to zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18\">Source</a></p>\n<ul>\n<li>tickTime\uff0c\u8fd9\u4e2a\u53c2\u6570\u53eb\u5404\u8282\u70b9\u524d\u5fc3\u8df3\u4fdd\u6301\u7684\u9891\u7387\uff0c\u4f60\u5373\u4e0d\u80fd\u592a\u9ad8\u4e5f\u4e0d\u80fd\u592a\u4f4e\uff0c\u592a\u9ad8\u4e86\u5404zk\u8282\u70b9\u95f4\u4e07\u4e00\u6709\u4e00\u4e2a\u6302\u4e86\u90a3\u4e48\u6574\u4e2azk\u7684master\u7fa4\u6765\u4e0d\u53ca\u9009\u4e3e\u51fa\u6765\u4e86\u5c31\u4f1a\u5f71\u54cd\u5230\u6574\u4eba\u672c\u4e1a\u52a1\u3002\u5982\u679c\u592a\u4f4e\u4e86\uff0c\u90a3\u4e48zk\u7fa4\u95f4\u56e0\u4e3a\u9891\u7e41\u5fc3\u8df3\u800c\u5bfc\u81f4\u7f51\u7edc\u5f00\u9500\u8fc7\u5927\uff1b</li>\n<li>initLimit\uff0c\u8fd9\u4e2a\u503c\u662f\u8fd9\u6837\u7684\uff0c\u8981\u770b\u771f\u5b9e\u7684\u5e76\u53d1\u8fde\u63a5\u7684\u3002\u7c7b\u4f3c\u8fd9\u79cdinitXXX\u503c\u6709\u4e00\u4e2a\u901a\u5219\uff0c\u90a3\u5c31\u662f\u7406\u8bba\u4e0a\u8981\u628a\u5b83\u8bbe\u6210\u548cmaxXXX\u4e00\u6837\uff0c\u5927\u5bb6\u8bbe\u60f3\u4e00\u4e0b\uff0c\u4e00\u5f00\u59cb\u4f60\u8bbe\u62101\uff0c\u7136\u540e\u6574\u4e2aconnection pool\u53d1\u89c9\u4e0d\u591f\u4e86\u5f00\u59cb+1\uff0c+1\u64cd\u4f5c\uff0c\u8fd9\u79cd\u201c+1\u201d\u64cd\u4f5c\u662f\u6709\u7cfb\u7edf\u5f00\u9500\u7684\uff0c\u5b83\u4f1a\u5f71\u54cd\u6574\u4f53\u7cfb\u7edf\u7684\u6027\u80fd\u3001\u5410\u541e\u3001\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u3002\u4f46\u662f\u8fd9\u4e2a\u901a\u5219\u4e5f\u4e0d\u662f\u4e00\u6210\u4e0d\u53d8\uff0c\u5982\u679c\u4f60\u5f00\u4e86\u591a\u4f1a\u9020\u6210\u6d6a\u8d39\uff0c\u56e0\u6b64\u62ff\u8fd9\u8fb9\u7684\u6848\u4f8b\u6765\u8bf4\uff0c\u6211\u4eec\u7684pool\u670934\u4e2a\uff0c\u6bcf\u4e2a\u542f\u52a8\u90fd\u8981\u53bb\u8fdezk\uff0c\u90a3\u4e48\u6211\u4eec\u628a\u8fd9\u4e2a\u6700\u5c0f\u503c\u8bbe\u621050\u662f\u5408\u7406\u7684\uff0c\u5982\u679c\u201c\u5f39\u6027\u6269\u5145\u4e86pool\u201d\u540e\uff0c\u90a3\u4e48\u518d\u8ba9\u5b83\u81ea\u589e\u201c1\u201d\uff1b</li>\n<li>syncLimit\uff0c\u8be5\u53c2\u6570\u6709\u9ed8\u8ba4\u503c5\uff0c\u5373\u8868\u793a\u662f\u53c2\u6570tickTime\u503c\u76845\u500d\uff0c\u5fc5\u987b\u914d\u7f6e\uff0c\u4e14\u9700\u8981\u914d\u7f6e\u4e00\u4e2a\u6b63\u6574\u6570\uff0c\u4e0d\u652f\u6301\u7cfb\u7edf\u5c5e\u6027\u65b9\u5f0f\u914d\u7f6e\u3002 </li>\n</ul>\n<p>\u8be5\u53c2\u6570\u7528\u4e8e\u914d\u7f6eLeader\u670d\u52a1\u5668\u548cFollower\u4e4b\u95f4\u8fdb\u884c\u5fc3\u8df3\u68c0\u6d4b\u7684\u6700\u5927\u5ef6\u65f6\u65f6\u95f4\u3002\u5728ZooKeeper\u96c6\u7fa4\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0cLeader\u670d\u52a1\u5668\u4f1a\u4e0e\u6240\u6709\u7684Follower\u8fdb\u884c\u5fc3\u8df3\u68c0\u6d4b\u6765\u786e\u5b9a\u8be5\u670d\u52a1\u5668\u662f\u5426\u5b58\u6d3b\u3002\u5982\u679cLeader\u670d\u52a1\u5668\u5728syncLimit\u65f6\u95f4\u5185\u65e0\u6cd5\u83b7\u53d6\u5230Follower\u7684\u5fc3\u8df3\u68c0\u6d4b\u54cd\u5e94\uff0c\u90a3\u4e48Leader\u5c31\u4f1a\u8ba4\u4e3a\u8be5Follower\u5df2\u7ecf\u8131\u79bb\u4e86\u548c\u81ea\u5df1\u7684\u540c\u6b65\u3002\u56e0\u6b64\u8fd9\u8fb9\u6211\u4eec\u8ba4\u4e3a30\u79d2\u6ca1\u6709\u53cd\u9988\uff0c\u90a3\u4e48\u6211\u4eec\u8ba4\u4e3aLeader\u548cFollower\u95f4\u5df2\u7ecf\u201c\u6302\u201d\u4e86\uff1b\n* leaderServers=no\uff0c\u8fd9\u4e2a\u53c2\u6570\u662f\u76f8\u5f53\u6709\u7528\u7684\uff0c\u5728\u751f\u4ea7\u4e0a\u662f\u5fc5\u5f00\u542f\u7684\u3002\u5b83\u4ee3\u8868Leader\u7684\u4e3b\u673a\u8282\u70b9\u4e0d\u63a5\u53d7\u8fde\u63a5\uff0c\u56e0\u4e3aLeader\u662f\u4f5c\u4e3a\u534f\u8c03\u7528\u7684\uff0c\u800c\u4e0d\u662f\u4f9b\u5bf9\u5916\u670d\u52a1\u5b83\u53ea\u662f\u5bf9\u5185\u3002\u5b83\u7684\u8bbe\u7f6e\u4f1a\u76f4\u63a5\u63d0\u5347zk\u7fa4\u7684\u6027\u80fd\uff1b\n* maxClientCnxns\uff0c\u5728\u538b\u6d4b\u73af\u5883\u5efa\u8bae\u8bbe\u4e3a1000\uff0c\u751f\u4ea7\u4e0a\u4ee5\u538b\u6d4b\u5b9e\u9645\u7ed3\u679c\u4e3a\u51c6\u518d\u505a\u8c03\u6574\u6216\u8005\u4e5f\u4e0d\u8c03\u6574\uff1b\n* forceSync=no\uff0c\u8be5\u53c2\u6570\u6709\u9ed8\u8ba4\u503c\uff1ayes\uff0c\u53ef\u4ee5\u4e0d\u914d\u7f6e\uff0c\u53ef\u9009\u914d\u7f6e\u9879\u4e3a\u201cyes\u201d\u548c\u201cno\u201d\uff0c\u4ec5\u652f\u6301\u7cfb\u7edf\u5c5e\u6027\u65b9\u5f0f\u914d\u7f6e\uff1azookeeper.forceSync\u3002 </p>\n<p>\u8be5\u53c2\u6570\u7528\u4e8e\u914d\u7f6eZooKeeper\u670d\u52a1\u5668\u662f\u5426\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u5c06\u65e5\u5fd7\u5199\u5165\u64cd\u4f5c\u5f3a\u5236\u5237\u5165\u78c1\u76d8\uff08\u5373\u8c03\u7528java.nio.channels.FileChannel.force\u63a5\u53e3\uff09\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u201cyes\u201d\uff0c\u5373\u6bcf\u6b21\u4e8b\u52a1\u65e5\u5fd7\u5199\u5165\u64cd\u4f5c\u90fd\u4f1a\u5b9e\u65f6\u5237\u5165\u78c1\u76d8\u3002\u5982\u679c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u201cno\u201d\uff0c\u5219\u80fd\u4e00\u5b9a\u7a0b\u5ea6\u7684\u63d0\u9ad8ZooKeeper\u7684\u5199\u6027\u80fd\uff0c\u4f46\u540c\u65f6\u4e5f\u4f1a\u5b58\u5728\u7c7b\u4f3c\u4e8e\u673a\u5668\u65ad\u7535\u8fd9\u6837\u7684\u5b89\u5168\u98ce\u9669\u3002\u5728\u6b64\u5904\u6211\u662f\u5efa\u8bae\u8bbe\u6210no\uff0c\u5b83\u4f1a\u76f4\u63a5\u5e26\u6765zk\u7fa4\u7684\u6027\u80fd\u63d0\u5347\u3002\u6211\u4eec\u7684zk\u76ee\u524d\u770b\u6765\u6682\u65e0\u4e8b\u65e0\u63d0\u4ea4\uff0c\u6709\u4e00\u4e9b\u62ffzk\u505a\u201ctcc\u6216\u8005\u662f2pC\u63d0\u4ea4\u201d\u7684global transaction\u4e00\u7c7b\u7684\u662f\u4f1a\u7528\u5230zk\u4e8b\u52a1\u7684\uff0c\u6211\u4eec\u7684\u73af\u5883\u6682\u65e0\u56e0\u6b64\u6b64\u503c\u8bbe\u6210no\uff0c\u589e\u52a0\u5176\u8bfb\u5199\u901f\u5ea6\uff1b</p>\n<h1 id=\"zk1\">zk1<a class=\"headerlink\" href=\"#zk1\" title=\"Permanent link\">&para;</a></h1>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># The number of milliseconds of each tick</span>\n<span class=\"c1\">#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)</span>\n<span class=\"na\">tickTime</span><span class=\"o\">=</span><span class=\"s\">5000</span>\n<span class=\"c1\"># The number of ticks that the initial</span>\n<span class=\"c1\"># synchronization phase can take</span>\n<span class=\"c1\"># floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236</span>\n<span class=\"c1\">#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570</span>\n<span class=\"na\">initLimit</span><span class=\"o\">=</span><span class=\"s\">50</span>\n<span class=\"c1\"># The number of ticks that can pass between</span>\n<span class=\"c1\"># sending a request and getting an acknowledgement</span>\n<span class=\"na\">syncLimit</span><span class=\"o\">=</span><span class=\"s\">6</span>\n<span class=\"na\">dataDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/data/zk1</span>\n<span class=\"na\">dataLogDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/logs/zk1</span>\n<span class=\"na\">clientPort</span><span class=\"o\">=</span><span class=\"s\">2181</span>\n<span class=\"na\">server.1</span><span class=\"o\">=</span><span class=\"s\">localhost:2187:2887</span>\n<span class=\"na\">server.2</span><span class=\"o\">=</span><span class=\"s\">localhost:2188:2888</span>\n<span class=\"na\">server.3</span><span class=\"o\">=</span><span class=\"s\">localhost:2189:2889</span>\n<span class=\"c1\">#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49</span>\n<span class=\"na\">leaderServes</span><span class=\"o\">=</span><span class=\"s\">no</span>\n<span class=\"na\">maxClientCnxns</span><span class=\"o\">=</span><span class=\"s\">1000</span>\n<span class=\"na\">forceSync</span><span class=\"o\">=</span><span class=\"s\">no</span>\n</code></pre></div>\n<h1 id=\"zk2\">zk2<a class=\"headerlink\" href=\"#zk2\" title=\"Permanent link\">&para;</a></h1>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># The number of milliseconds of each tick</span>\n<span class=\"c1\">#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)</span>\n<span class=\"na\">tickTime</span><span class=\"o\">=</span><span class=\"s\">5000</span>\n<span class=\"c1\"># The number of ticks that the initial</span>\n<span class=\"c1\"># synchronization phase can take</span>\n<span class=\"c1\"># floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236</span>\n<span class=\"c1\">#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570</span>\n<span class=\"na\">initLimit</span><span class=\"o\">=</span><span class=\"s\">50</span>\n<span class=\"c1\"># The number of ticks that can pass between</span>\n<span class=\"c1\"># sending a request and getting an acknowledgement</span>\n<span class=\"na\">syncLimit</span><span class=\"o\">=</span><span class=\"s\">6</span>\n<span class=\"na\">dataDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/data/zk2</span>\n<span class=\"na\">dataLogDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/logs/zk2</span>\n<span class=\"na\">clientPort</span><span class=\"o\">=</span><span class=\"s\">2182</span>\n<span class=\"na\">server.1</span><span class=\"o\">=</span><span class=\"s\">localhost:2187:2887</span>\n<span class=\"na\">server.2</span><span class=\"o\">=</span><span class=\"s\">localhost:2188:2888</span>\n<span class=\"na\">server.3</span><span class=\"o\">=</span><span class=\"s\">localhost:2189:2889</span>\n<span class=\"c1\">#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49</span>\n<span class=\"na\">leaderServes</span><span class=\"o\">=</span><span class=\"s\">no</span>\n<span class=\"na\">maxClientCnxns</span><span class=\"o\">=</span><span class=\"s\">1000</span>\n<span class=\"na\">forceSync</span><span class=\"o\">=</span><span class=\"s\">no</span>\n</code></pre></div>\n<h1 id=\"zk3\">zk3<a class=\"headerlink\" href=\"#zk3\" title=\"Permanent link\">&para;</a></h1>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># The number of milliseconds of each tick</span>\n<span class=\"c1\">#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)</span>\n<span class=\"na\">tickTime</span><span class=\"o\">=</span><span class=\"s\">5000</span>\n<span class=\"c1\"># The number of ticks that the initial</span>\n<span class=\"c1\"># synchronization phase can take</span>\n<span class=\"c1\"># floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236</span>\n<span class=\"c1\">#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570</span>\n<span class=\"na\">initLimit</span><span class=\"o\">=</span><span class=\"s\">50</span>\n<span class=\"c1\"># The number of ticks that can pass between</span>\n<span class=\"c1\"># sending a request and getting an acknowledgement</span>\n<span class=\"na\">syncLimit</span><span class=\"o\">=</span><span class=\"s\">6</span>\n<span class=\"na\">dataDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/data/zk3</span>\n<span class=\"na\">dataLogDir</span><span class=\"o\">=</span><span class=\"s\">/Users/chrishu123126.com/opt/zookeeper/logs/zk3</span>\n<span class=\"na\">clientPort</span><span class=\"o\">=</span><span class=\"s\">2183</span>\n<span class=\"na\">server.1</span><span class=\"o\">=</span><span class=\"s\">localhost:2187:2887</span>\n<span class=\"na\">server.2</span><span class=\"o\">=</span><span class=\"s\">localhost:2188:2888</span>\n<span class=\"na\">server.3</span><span class=\"o\">=</span><span class=\"s\">localhost:2189:2889</span>\n<span class=\"c1\">#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49</span>\n<span class=\"na\">leaderServes</span><span class=\"o\">=</span><span class=\"s\">no</span>\n<span class=\"na\">maxClientCnxns</span><span class=\"o\">=</span><span class=\"s\">1000</span>\n<span class=\"na\">forceSync</span><span class=\"o\">=</span><span class=\"s\">no</span>\n</code></pre></div>\n<h3 id=\"zk\">zk\u7fa4\u201c\u56db\u5b57\u201d\u771f\u8a00<a class=\"headerlink\" href=\"#zk\" title=\"Permanent link\">&para;</a></h3>\n<ol>\n<li><code>echo stat|nc 127.0.0.1 2181</code> \u6765\u67e5\u770b\u54ea\u4e2a\u8282\u70b9\u88ab\u9009\u62e9\u4f5c\u4e3afollower\u6216\u8005leader</li>\n<li><code>echo ruok|nc 127.0.0.1 2181</code> \u6d4b\u8bd5\u662f\u5426\u542f\u52a8\u4e86\u8be5Server\uff0c\u82e5\u56de\u590dimok\u8868\u793a\u5df2\u7ecf\u542f\u52a8\u3002</li>\n<li><code>echo dump| nc 127.0.0.1 2181</code> ,\u5217\u51fa\u672a\u7ecf\u5904\u7406\u7684\u4f1a\u8bdd\u548c\u4e34\u65f6\u8282\u70b9\u3002</li>\n<li><code>echo kill | nc 127.0.0.1 2181</code> ,\u5173\u6389server</li>\n<li><code>echo conf | nc 127.0.0.1 2181</code> ,\u8f93\u51fa\u76f8\u5173\u670d\u52a1\u914d\u7f6e\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li>\n<li><code>echo cons | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u6240\u6709\u8fde\u63a5\u5230\u670d\u52a1\u5668\u7684\u5ba2\u6237\u7aef\u7684\u5b8c\u5168\u7684\u8fde\u63a5 / \u4f1a\u8bdd\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li>\n<li><code>echo envi |nc 127.0.0.1 2181</code> ,\u8f93\u51fa\u5173\u4e8e\u670d\u52a1\u73af\u5883\u7684\u8be6\u7ec6\u4fe1\u606f\uff08\u533a\u522b\u4e8e conf \u547d\u4ee4\uff09\u3002</li>\n<li><code>echo reqs | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u672a\u7ecf\u5904\u7406\u7684\u8bf7\u6c42\u3002</li>\n<li><code>echo wchs | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li>\n<li><code>echo wchc | nc 127.0.0.1 2181</code> ,\u901a\u8fc7 session \u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5b83\u7684\u8f93\u51fa\u662f\u4e00\u4e2a\u4e0e watch \u76f8\u5173\u7684\u4f1a\u8bdd\u7684\u5217\u8868\u3002</li>\n<li><code>echo wchp | nc 127.0.0.1 2181</code> ,\u901a\u8fc7\u8def\u5f84\u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u5b83\u8f93\u51fa\u4e00\u4e2a\u4e0e session \u76f8\u5173\u7684\u8def\u5f84\u3002</li>\n</ol>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["performance", "tuning", "zookeeper"]}, {"id": "https://wgzhao.github.io/notes/courses/commands-in-sbin/", "url": "https://wgzhao.github.io/notes/courses/commands-in-sbin/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Linux \u547d\u4ee4\u5b66\u4e60", "content_html": "<h1 id=\"linux\">Linux \u547d\u4ee4\u5b66\u4e60<a class=\"headerlink\" href=\"#linux\" title=\"Permanent link\">&para;</a></h1>\n<p>\u8fd9\u5176\u5b9e\u5f88\u65e9\u5f88\u65e9\u524d\u6211\u5728\u81ea\u5df1\u535a\u5ba2\u4e0a\u8d34\u7684\u5185\u5bb9\u4e86\uff0c\u662f\u6211 2007 \u5e74 1 \u6708\u5f00\u59cb\u5230\u5f53\u5e74 7 \u6708\uff0c\u534a\u5e74\u591a\u7684\u65f6\u95f4\u7cfb\u7edf\u5b66\u4e60 Linux \u4e0b <code>/sbin</code> \u4ee5\u53ca <code>/usr/sbin/</code> \u7684\u6bcf\u4e2a\u547d\u4ee4\uff0c\u8fd9\u4e2a\u7684\u7f18\u8d77\u8fd8\u662f\u4e4b\u524d\u5728 2007 \u5e74\u7684\u65f6\u5019\uff0c\u82e6\u4e8e\u81ea\u5df1\u5bf9 Linux \u6df1\u5165\u5b66\u4e60\u8fdb\u5165\u4e86\u4e00\u4e2a\u74f6\u9888\uff0c\u4e0d\u77e5\u9053\u4ece\u90a3\u4e2a\u65b9\u9762\u53ef\u4ee5\u5165\u624b\uff0c\u4e8e\u662f\u53bb\u8bf7\u6559\u5f53\u65f6\u516c\u53f8\u7684 Linux \u5185\u6838\u7814\u53d1\u7ecf\u7406\uff0c\u5e94\u8be5\u4ece\u54ea\u91cc\u65b9\u9762\u5165\u624b\uff0c\u4ed6\u56de\u7b54\u8bf4\uff0c\u4ed6\u4e4b\u524d\u5728 Linux \u4f0a\u7538\u56ed\uff08\u77e5\u9053\u8fd9\u4e2a\u8bba\u575b\u7684\u4f30\u8ba1\u5e74\u7ea7\u90fd\u4e0d\u5c0f\u4e86\uff09\u4e0a\u540d\u4e3a <code>nntp</code> \u7684\u7248\u4e3b\u8bf4\uff0c\u4e00\u4e2a\u4f18\u79c0\u7684 Linux \u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u90fd\u5e94\u8be5\u8ba4\u771f\u5b66\u4e60<code>/sbin/</code> <code>/usr/sbin</code> \u4e0b\u7684\u6240\u6709\u547d\u4ee4\uff0c\u4f60\u53ef\u4ee5\u4ece\u8fd9\u91cc\u5165\u624b\u3002</p>\n<p>\u4e4b\u524d\u662f\u5206\u7c7b\u8bb0\u5f55\u7684\uff0c\u73b0\u5728\u6211\u628a\u4ed6\u6574\u7406\u5728\u4e00\u5757\uff0c\u8fd9\u4e9b\u547d\u4ee4\u8fd8\u662f\u57fa\u4e8e RedHat Enterprise 5.0 \uff0c\u5df2\u7ecf\u5f88\u53e4\u8001\u4e86\uff0c\u4e0d\u8fc7\u5f88\u591a\u547d\u4ee4\u4e5f\u5f88\u4e45\u6ca1\u6709\u66f4\u65b0\u4e86\uff0c\u6240\u4ee5\u7528\u6cd5\u4e00\u76f4\u4fdd\u7559\u4e86\u4e0b\u6765\u3002</p>\n<h2 id=\"sbin-a\">/sbin \u4e0b a \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-a\" title=\"Permanent link\">&para;</a></h2>\n<p><code>/sbin</code> \u4e0b a \u5f00\u5934\u7684\u547d\u4ee4\u5e76\u4e0d\u591a\uff0c\u5927\u6982\u662f\u8fd9\u4e9b</p>\n<blockquote>\n<p>accton adsl-setup adsl-stop arping auditd\naddpart adsl-start agetty asianux-support-check\nadsl-connect adsl-status arp auditctl</p>\n</blockquote>\n<p>\u5176\u4e2d adsl \u5f00\u5934\u7684\u547d\u4ee4\u5360\u4e86\u4e00\u534a\u3002</p>\n<p>\u5206\u522b\u7b80\u5355\u4ecb\u7ecd\uff1a</p>\n<h3 id=\"accton\">accton<a class=\"headerlink\" href=\"#accton\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6253\u5f00\u6216\u8005\u5173\u95ed\u8fdb\u7a0b\u7edf\u8ba1\uff08account)\uff0c\u5982\u679c\u4e0d\u52a0\u4efb\u4f55\u53c2\u6570\uff0c\u7f3a\u7701\u7684\u60c5\u51b5\u4e0b\u662f\u5173\u95ed\u8fdb\u7a0b\u7edf\u8ba1\u3002</p>\n<p>\u8981\u7406\u89e3\u8fd9\u4e2a\u547d\u4ee4\uff0c\u5c31\u9700\u8981\u770b\u770b\u5176\u4ed6\u51e0\u4e2a\u547d\u4ee4\u4e86\u3002\n\u9996\u5148\u6211\u4eec\u770b\u770b accton \u5c5e\u4e8e\u54ea\u4e2a\u5305</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># rpm -qf accton</span>\npsacct-6.3.2-35.rhel4\n<span class=\"c1\"># rpm -qi psacct</span>\n....\nDescription<span class=\"w\"> </span>:\nThe<span class=\"w\"> </span>psacct<span class=\"w\"> </span>package<span class=\"w\"> </span>contains<span class=\"w\"> </span>several<span class=\"w\"> </span>utilities<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>monitoring<span class=\"w\"> </span>process\nactivities,<span class=\"w\"> </span>including<span class=\"w\"> </span>ac,<span class=\"w\"> </span>lastcomm,<span class=\"w\"> </span>accton<span class=\"w\"> </span>and<span class=\"w\"> </span>sa.<span class=\"w\"> </span>The<span class=\"w\"> </span>ac<span class=\"w\"> </span><span class=\"nb\">command</span>\ndisplays<span class=\"w\"> </span>statistics<span class=\"w\"> </span>about<span class=\"w\"> </span>how<span class=\"w\"> </span>long<span class=\"w\"> </span>users<span class=\"w\"> </span>have<span class=\"w\"> </span>been<span class=\"w\"> </span>logged<span class=\"w\"> </span>on.<span class=\"w\"> </span>The\nlastcomm<span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span>displays<span class=\"w\"> </span>information<span class=\"w\"> </span>about<span class=\"w\"> </span>previous<span class=\"w\"> </span>executed\ncommands.<span class=\"w\"> </span>The<span class=\"w\"> </span>accton<span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span>turns<span class=\"w\"> </span>process<span class=\"w\"> </span>accounting<span class=\"w\"> </span>on<span class=\"w\"> </span>or<span class=\"w\"> </span>off.<span class=\"w\"> </span>The\nsa<span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span>summarizes<span class=\"w\"> </span>information<span class=\"w\"> </span>about<span class=\"w\"> </span>previously<span class=\"w\"> </span>executed\ncommmands.\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u63cf\u8ff0\u6765\u770b\uff0c\u6211\u4eec\u77e5\u9053 accton \u4ee5\u53ca ac,lastcomm,sa \u90fd\u662f\u7528\u6765\u76d1\u63a7\u8fdb\u7a0b\u7684\u6d3b\u52a8\u6027\u7684\u3002</p>\n<p>\u5176\u4e2d ac \u547d\u4ee4\u663e\u793a\u67d0\u4e2a\u7528\u6237\u5df2\u7ecf\u767b\u5f55\u591a\u4e45\u4e86\uff08\u5355\u4f4d\u662f\u5c0f\u65f6\uff09\uff0c\u6bd4\u5982</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ac root</span>\n\ntotal<span class=\"w\"> </span><span class=\"m\">9</span>.13\n\n<span class=\"c1\"># ac mlsx</span>\n\ntotal<span class=\"w\"> </span><span class=\"m\">0</span>.00\n<span class=\"c1\"># ac -d</span>\nJan<span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">0</span>.98\nJan<span class=\"w\"> </span><span class=\"m\">12</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">0</span>.49\nJan<span class=\"w\"> </span><span class=\"m\">13</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">1</span>.79\nJan<span class=\"w\"> </span><span class=\"m\">15</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">3</span>.97\nJan<span class=\"w\"> </span><span class=\"m\">16</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">0</span>.03\nJan<span class=\"w\"> </span><span class=\"m\">22</span><span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">1</span>.60\nToday<span class=\"w\"> </span>total<span class=\"w\"> </span><span class=\"m\">0</span>.54\n\n<span class=\"c1\"># ac \u2013-reboots</span>\ntotal<span class=\"w\"> </span><span class=\"m\">28</span>.81\n</code></pre></div>\n<p>ac \u53ef\u4ee5\u63a5\u53d7\u7684\u53c2\u6570\u7684\u5e76\u4e0d\u662f\u5f88\u591a\uff0c\u800c\u4e14\u4e5f\u6bd4\u8f83\u5bb9\u6613\u7406\u89e3\u3002\u53ea\u662f\u8fd9\u4e2a <code>reboots</code> \u6211\u6709\u70b9\u4e0d\u597d\u7406\u89e3\u4ed6\uff0c\u6682\u65f6\u6211\u7684\u7406\u89e3\u662f\u672c\u6b21\u8fdb\u5165\u7cfb\u7edf\u4e8e\u4e0a\u6b21\u8fdb\u5165\u7cfb\u7edf\u7684\u65f6\u95f4\u5dee\uff08\u5c0f\u65f6\uff09\uff0c\u4e5f\u5c31\u662f\u6700\u8fd1\u4e24\u6b21\u8fdb\u5165\u7cfb\u7edf\u7684\u65f6\u95f4\u95f4\u9694\u3002\n\u800c <code>lastcomm</code> \u5219\u663e\u793a\u4e4b\u524d\u6267\u884c\u7684\u90a3\u4e9b\u547d\u4ee4\u7684\u4fe1\u606f\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># lastcomm | head</span>\nlastcomm<span class=\"w\"> </span>S<span class=\"w\"> </span>X<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/0<span class=\"w\"> </span><span class=\"m\">0</span>.29<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:38\nscim-helper-lau<span class=\"w\"> </span>SF<span class=\"w\"> </span>root<span class=\"w\"> </span>__<span class=\"w\"> </span><span class=\"m\">4</span>.26<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:37\nscim-helper-lau<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>__<span class=\"w\"> </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:37\nac<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\nac<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\nac<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\nac<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\ncrond<span class=\"w\"> </span>SF<span class=\"w\"> </span>root<span class=\"w\"> </span>__<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\nmrtg<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>__<span class=\"w\"> </span><span class=\"m\">0</span>.83<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:35\nac<span class=\"w\"> </span>S<span class=\"w\"> </span>root<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>secs<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"m\">21</span>:34\n</code></pre></div>\n<p>\u8fd9\u91cc\u4e9b\u5217\u5206\u522b\u8868\u793a\u547d\u4ee4\u7684\u540d\u79f0\uff0c\u6807\u8bc6\uff0c\u6267\u884c\u5e10\u53f7\uff0c\u6267\u884c\u7ec8\u7aef\uff0c\u5df2\u7ecf\u7a0b\u5e8f\u9000\u51fa\u7684\u65f6\u95f4\u3002\n\u5176\u4e2d\u8868\u793a\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<ul>\n<li>S: \u8be5\u547d\u4ee4\u7531\u8d85\u7ea7\u7528\u6237\u6267\u884c\u3002</li>\n<li>F: \u547d\u4ee4\u662f\u5728 fork \u540e\u6267\u884c\u7684\uff0c\u4f46\u662f\u63a5\u4e0b\u6765\u6ca1\u6709\u6267\u884c exec</li>\n<li>C: \u547d\u4ee4\u8fd0\u884c\u5728 PDP\uff0d11 \u517c\u5bb9\u6a21\u5f0f\u4e0b\uff08\u8fd9\u4e2a\u5411\u4e0b\u517c\u5bb9\u4e5f\u592a\u957f\u65f6\u95f4\u4e86\u5427\uff09</li>\n<li>D: \u547d\u4ee4\u4e2d\u65ad\uff0c\u4e14\u4ea7\u751f\u4e86 core \u6587\u4ef6\u3002</li>\n<li>X: \u547d\u4ee4\u53d7\u5230 SIGTERM \u4fe1\u53f7\u800c\u4e2d\u65ad</li>\n</ul>\n<p>\u800c\u4e0a\u9762\u7684\u8fd9\u4e9b\u4fe1\u606f\u662f\u5426\u5b58\u5728\u5c31\u770b accton \u7684\u547d\u4ee4\u64cd\u4f5c\u4e86\uff0c\u5982\u679c\u4ed6\u5173\u95ed\u8fdb\u7a0b\u4fe1\u606f\u7edf\u8ba1\uff0c\u90a3\u4e48\u8fd9\u4e9b\u547d\u4ee4\u5c31\u65e0\u6cd5\u5f97\u5230\u4e0a\u8ff0\u4fe1\u606f\u3002\n\u51fa\u4e86\u8fd0\u884c accton \u547d\u4ee4\u5916\uff0c\u4e5f\u4f7f\u7528\u4f7f\u7528</p>\n<p><code>/etc/init.d/psacct [start|stop]</code></p>\n<p>\u5f00\u542f\u6216\u8005\u505c\u6b62\u8fdb\u7a0b\u4fe1\u606f\u7edf\u8ba1\u3002</p>\n<h3 id=\"adsl-\">adsl-*<a class=\"headerlink\" href=\"#adsl-\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u4e9b\u547d\u4ee4\u4e00\u770b\u5c31\u77e5\u9053\u662f\u4e0e ADSL \u6709\u5173\u7684\u3002</p>\n<p><code>adsl-setup</code> \u7528\u6765\u8bbe\u7f6e\u5bf9\u5e94\u7684\u4fe1\u606f\uff0c\u91c7\u7528\u4ea4\u4e92\u6a21\u5f0f\uff0c\u975e\u5e38\u7684\u50bb\u74dc\u5316\u3002</p>\n<p><code>adsl-connect</code> \u662f\u7ba1\u7406\u4e00\u4e2a PPPoE \u8fde\u63a5\u7684\u547d\u4ee4\u3002</p>\n<p><code>adsl-start</code> \u5f00\u59cb\u62e8\u53f7\n<code>adsl-stop</code> \u65ad\u5f00\n<code>adsl-status</code> \u67e5\u770b\u72b6\u6001</p>\n<p>\u8fd9\u91cc ADSL \u7684\u8bbe\u7f6e\u548c windows \u4e0b\u6709\u4e00\u4e2a\u5c0f\u7684\u533a\u522b\uff0c\u90a3\u5c31\u662f windows \u662f\u81ea\u52a8\u83b7\u53d6 DNS \u7684\uff0c\u4f46\u662f\u5728 Linux \u5374\u4e0d\u662f\u8fd9\u6837\uff0c\u56e0\u6b64\u4f60\u8981\u5148\u586b\u5199 DNS \u5730\u5740\u624d\u80fd\u6b63\u5e38\u4e0a\u7f51\u3002</p>\n<p><code>agetty</code> alternative Linux getty\uff0c\u4e00\u4e2a Linux \u4e0b getty \u7a0b\u5e8f\u7684\u66ff\u6362\u8005\u3002\u4e00\u822c\u4e0d\u624b\u5de5\u6267\u884c\u3002</p>\n<p><code>arp</code>,<code>arping</code> \u4e0e ARP \u76f8\u5173\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u6e05\u7a7a ARP \u8868\uff0c\u5237\u65b0 ARP \u8868\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u5728\u9ad8\u53ef\u7528\u7684\u73af\u5883\u4e0b\u53ef\u4ee5\u5f97\u5230\u91cd\u7528\u3002</p>\n<p><code>auditctl</code>,<code>auditd</code> \u5ba1\u8ba1\u7a0b\u5e8f\uff0c\u6309\u7167 RPM \u5305\u7684\u8bf4\u660e\uff0c\u4ed6\u4eec\u7684\u4e3b\u8981\u7528\u5904\u662f\u5b58\u50a8\u548c\u5904\u7406\u6709\u5185\u6838\u5ba1\u8ba1\u5b50\u7cfb\u7edf\u4ea7\u751f\u7684\u5ba1\u8ba1\u8bb0\u5f55\u3002</p>\n<h2 id=\"sbin-b\">/sbin \u4e0b b \u5f00\u59cb\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-b\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"badblocks\">badblocks<a class=\"headerlink\" href=\"#badblocks\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bf9\u6307\u5b9a\u7684\u8bbe\u5907\u627e\u51fa\u574f\u5757,\u4ed6\u63a5\u53d7\u7684\u53c2\u6570\u4e0d\u662f\u592a\u591a\uff0c\u4f60\u53ef\u4ee5\u6307\u5b9a\u5f00\u59cb\u5757\u4e5f\u7ed3\u675f\u5757\u3002\u8fd8\u80fd\u7528 <code>-f</code> \u6765\u6307\u5b9a\u662f\u5426\u9700\u8981\u5bf9\u67e5\u627e\u7684\u5206\u533a\u8fdb\u884c\u4fee\u590d\uff0c\u4e0d\u8fc7\u5728 man \u4e2d\u5bf9 <code>-f</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u63cf\u8ff0\u662f\uff0c\n\u6c38\u8fdc\u90fd\u4e0d\u8981\u4f7f\u7528 <code>-f</code>\uff0c\u9664\u975e\u4f60\u6bd4\u8fd9\u4e2a\u547d\u4ee4\u66f4\u806a\u660e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"o\">]</span><span class=\"c1\"># badblocks /dev/hda5</span>\n</code></pre></div>\n<p>man \u624b\u518c\u4e2d\u63d0\u5230\u4e00\u822c\u4e0d\u8981\u76f4\u63a5\u6267\u884c badblocks \u547d\u4ee4\uff0c\u800c\u662f\u5e94\u8be5\u7528 <code>e2fsck</code> \u547d\u4ee4\u7684 <code>\uff0dc</code> \u53c2\u6570\u6765\u81ea\u52a8\u8c03\u7528 <code>badblocks</code> \u547d\u4ee4\uff0c\u4ed6\u4f1a\u67e5\u627e\u574f\u5757\u5e76\u6807\u8bb0\u8d77\u6765\uff0c\u4ee5\u4fbf\u4e0b\u6b21\u5b58\u50a8\u6570\u636e\u65f6\uff0c\u4e0d\u4f1a\u5b58\u50a8\u5728\u8fd9\u4e9b\u574f\u5757\u4e0a\u3002</p>\n<h3 id=\"blkid\">blkid<a class=\"headerlink\" href=\"#blkid\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528\u6765\u5b9a\u4f4d\u6216\u8005\u6253\u5370\u5757\u8bbe\u5907\u5c5e\u6027\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u4ed6\u4e00\u822c\u548c libuuid(3) \u7a0b\u5e8f\u5e93\u4e00\u8d77\u4f7f\u7528\u3002\u4ed6\u53ef\u4ee5\u63a8\u6d4b\u51fa\u4e00\u4e2a\u5757\u8bbe\u5907\u5185\u5bb9\u7684\u7c7b\u578b\uff08\u6bd4\u5982\u662f\u6587\u4ef6\u7cfb\u7edf\uff0c\u662f swap\uff09\u548c\u5176\u4ed6\u5c5e\u6027\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># blkid /dev/hda5</span>\n<span class=\"w\">     </span>/dev/hda5:<span class=\"w\"> </span><span class=\"nv\">LABEL</span><span class=\"o\">=</span><span class=\"s2\">&quot;/&quot;</span><span class=\"w\"> </span><span class=\"nv\">UUID</span><span class=\"o\">=</span><span class=\"s2\">&quot;74e3bf86-ce24-411d-ac35-c4bc49964f36&quot;</span><span class=\"w\"> </span><span class=\"nv\">SEC_TYPE</span><span class=\"o\">=</span><span class=\"s2\">&quot;ext3&quot;</span><span class=\"w\"> </span><span class=\"nv\">TYPE</span><span class=\"o\">=</span><span class=\"s2\">&quot;ext2&quot;</span>\n<span class=\"c1\"># blkid /dev/hda1 /dev/hda1: UUID=&quot;6C2B-F039&quot; TYPE=&quot;vfat&quot;</span>\n</code></pre></div>\n<p>UUID \u5728 RAID \u548c LVM \u4e2d\u6709\u6bd4\u8f83\u5e7f\u6cdb\u7684\u4f7f\u7528\uff0c\u5728 RAID \u4e2d\uff0c\u5bfb\u627e\u67d0\u4e00\u4e2a\u8bbe\u5907\u6216\u8005\u5206\u533a\u4e0d\u662f\u6839\u636e\u4f60\u7684\u8bbe\u5907\u53f7\uff08\u6bd4\u5982 hda3\uff09\uff0c\u4e5f\u4e0d\u662f\u6807\u7b7e\uff08\u6bd4\u5982 <code>/HOME</code>)\uff0c\u56e0\u4e3a\u624b\u5de5\u521b\u5efa\u7684\u5206\u533a\u9ed8\u8ba4\u6ca1\u6709\u6807\u7b7e\uff0c\u800c\u662f\u6839\u636e UUID \u53f7\uff0c\u6bd4\u5982\u4f60\u7684\u7b2c\u4e00\u4e2a SCSI \u8bbe\u5907\u56e0\u4e3a\u69fd\u4f4d\u7684\u53d8\u5316\uff0c\u90a3\u4e48\u5728 linux \u4e2d\u8bbe\u5907\u597d\u4e5f\u53d1\u751f\u4e86\u53d8\u5316\uff08\u6bd4\u5982\u4ece sda \u53d8\u6210 sdb)\uff0c\u4f46\u662f\u7cfb\u7edf\u4f9d\u7136\u80fd\u591f\u8bc6\u522b\u51fa\u6765\u3002</p>\n<p>\u800c\u69fd\u4f4d\u7684\u6539\u53d8\u5728\u670d\u52a1\u5668\u4e0a\u5f88\u5bb9\u6613\u53d1\u751f\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u90fd\u662f\u652f\u6301\u70ed\u63d2\u62d4\u7684\u3002\u5728 LVM \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u4f60\u66f4\u80fd\u975e\u5e38\u6e05\u695a\u7684\u770b\u5230 UUID \u53f7\u3002</p>\n<h3 id=\"blockdev\">blockdev<a class=\"headerlink\" href=\"#blockdev\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u547d\u4ee4\u884c\u8c03\u7528\u8bbe\u5907\u7684 <code>ioctl</code> \u51fd\u6570\u3002\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c\u4f3c\u4e4e\u5bf9\u8bbe\u5907\u7684\u76f4\u63a5\u64cd\u4f5c\u53ea\u6709 <code>ioctl</code> \u51fd\u6570\u4e86\u3002\u4ed6\u63a5\u53d7\u7684\u53c2\u6570\u4e0d\u662f\u592a\u591a\uff0c\u800c\u4e14\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>--setro<span class=\"w\"> </span>\u8bbe\u7f6e\u8bbe\u5907\u4e3a\u53ea\u8bfb\n--getro<span class=\"w\"> </span>\u8bfb\u53d6\u8bbe\u5907\u662f\u5426\u4e3a\u53ea\u8bfb\uff08\u6210\u529f\u4e3a<span class=\"w\"> </span><span class=\"m\">1</span>\uff0c0<span class=\"w\"> </span>\u5219\u4e3a\u53ef\u8bfb\u5199\uff09\n--setrw<span class=\"w\"> </span>\u8bbe\u7f6e\u8bbe\u522b\u4e3a\u53ef\u8bfb\u5199\n--getss<span class=\"w\"> </span>\u6253\u5370\u8bbe\u5907\u7684\u6247\u533a\u5927\u5c0f\uff0c\u901a\u5e38\u662f<span class=\"w\"> </span><span class=\"m\">512</span>\n--getsize<span class=\"w\"> </span>\u6253\u5370\u8bbe\u522b\u7684\u5bb9\u91cf\uff0c\u6309\u7167\u4e00\u4e2a\u6247\u533a<span class=\"w\"> </span><span class=\"m\">512</span><span class=\"w\"> </span>\u4e2a\u5b57\u8282\u8ba1\u7b97\n--setra<span class=\"w\"> </span>N<span class=\"w\"> </span>Set<span class=\"w\"> </span>readahead<span class=\"w\"> </span>to<span class=\"w\"> </span>N<span class=\"w\"> </span><span class=\"m\">512</span>-byte<span class=\"w\"> </span>sectors.\n--getra<span class=\"w\"> </span>\u6253\u5370<span class=\"w\"> </span>readahead\n--flushbufs<span class=\"w\"> </span>\u5237\u65b0\u7f13\u51b2\n--rereadpt<span class=\"w\"> </span>\u91cd\u8bfb\u5206\u533a\u8868\u3002\n</code></pre></div>\n<p>\u4e2a\u4eba\u89c9\u5f97 <code>--setro</code>, <code>--setrw</code> \u6bd4\u8f83\u6709\u7528\uff0c\u8fd9\u4e2a <code>mount -o ro(rw)</code>\u662f\u6709\u533a\u522b\u7684\uff0cmount \u662f\u5728\u6587\u4ef6\u7cfb\u7edf\u8fd9\u4e2a\u7ea7\u522b\u4e0a\u5bf9\u67d0\u4e2a\u5206\u533a\u6302\u8f7d\u4e3a\u53ea\u8bfb\u6216\u53ef\u8bfb\u5199\u3002</p>\n<p>\u800c blockdev \u5219\u662f\u5728\u8bbe\u522b\u8fd9\u4e2a\u7ea7\u522b\u4e0a\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u548c\u53ef\u8bfb\u5199\u3002</p>\n<p>\u770b\u4e0b\u9762\u7684\u547d\u4ee4\u8f93\u51fa\u7ed3\u679c\u5c31\u4e00\u76ee\u4e86\u7136\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># blockdev \u2013setro /dev/hda4</span>\n<span class=\"c1\"># blockdev \u2013getro /dev/hda4</span>\n<span class=\"w\">    </span><span class=\"m\">1</span>\n<span class=\"c1\"># mount /dev/hda4 /misc -o rw</span>\n<span class=\"w\">    </span>mount:<span class=\"w\"> </span>block<span class=\"w\"> </span>device<span class=\"w\"> </span>/dev/hda4<span class=\"w\"> </span>is<span class=\"w\"> </span>write-protected,<span class=\"w\"> </span>mounting<span class=\"w\"> </span>read-only\n<span class=\"c1\"># umount /dev/hda4</span>\n<span class=\"c1\"># blockdev \u2013setrw /dev/hda4</span>\n<span class=\"c1\"># blockdev \u2013getro /dev/hda4</span>\n<span class=\"w\">    </span><span class=\"m\">0</span>\n<span class=\"c1\"># mount /dev/hda4 /misc -o rw</span>\n<span class=\"c1\"># touch /misc/one</span>\n<span class=\"c1\"># umount /dev/hda4</span>\n<span class=\"c1\"># mount /dev/hda4 /misc -o ro</span>\n<span class=\"c1\"># rm -f /misc/one</span>\n<span class=\"w\">    </span>rm:<span class=\"w\"> </span>\u65e0\u6cd5\u5220\u9664\u2018/misc/one\u2019:<span class=\"w\"> </span>\u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf\n</code></pre></div>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u5728\u9ad8\u53ef\u7528\u73af\u5883\u6bd4\u8f83\u5b9e\u7528\u3002\u6bd4\u5982\u7ea2\u65d7\u7684 HA \u4ea7\u54c1\u5c31\u4f7f\u7528\u4e86\u7c7b\u4f3c\u7684\u547d\u4ee4\u6765\u9632\u6b62\uff0c\u7ea2\u65d7 HA \u505c\u6b62\u65f6\uff0c\u4f1a\u81ea\u52a8\u5c06\u4ed6\u76d1\u7ba1\u7684\u8bbe\u5907\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\uff0c\u9632\u6b62\u7528\u6237\u7684\u6539\u5199\uff0c\u9664\u975e\u4f60\u624b\u5de5\u8bbe\u7f6e\u4e3a\u53ef\u8bfb\u5199\uff08\u7ea2\u65d7 HA \u4f7f\u7528\u4e86 <code>clproset</code> \u547d\u4ee4\uff0c\u5176\u4f5c\u7528\u5e94\u8be5\u548c\u8fd9\u4e2a\u5dee\u4e0d\u591a\uff09</p>\n<h2 id=\"sbin-c\">/sbin \u4e0b c \u5f00\u59cb\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-c\" title=\"Permanent link\">&para;</a></h2>\n<p>/sbin \u76ee\u5f55\u4e0b c \u5f00\u5934\u7684\u547d\u4ee4\u4e5f\u6ca1\u6709\u591a\u5c11\uff0c\u5217\u51fa\u5982\u4e0b</p>\n<blockquote>\n<p>cardctl cardmgr change_console chkconfig clock consoletype cryptsetup ctrlaltdel</p>\n</blockquote>\n<p>\u5176\u4e2d <code>clock</code> \u8fd8\u662f\u8f6f\u8fde\u63a5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ls -l clock</span>\nlrwxrwxrwx<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span>9\u6708<span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"m\">12</span>:07<span class=\"w\"> </span>clock<span class=\"w\"> </span>-&gt;<span class=\"w\"> </span>hwclock\n</code></pre></div>\n<p><code>cardctl</code> \u548c <code>cardmgr</code> \u662f\u5bf9 PCMCIA \u8bbe\u5907\u7684\u64cd\u4f5c\uff0c\u4e0d\u8fc7\u4f3c\u4e4e\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e24\u4e2a\u547d\u4ee4\u6765\u7ba1\u7406 PCMCIA \u8bbe\u522b\u7684\u673a\u4f1a\u5e94\u8be5\u5f88\u5c11\u3002\u4e00\u6765 PCMCIA \u63d2\u69fd\u53ea\u5728\u7b14\u8bb0\u672c\u4e0a\u6709\uff0c\u4e8c\u6765\u76ee\u524d Linux \u4e0b\u80fd\u652f\u6301\u7684 PCMCIA \u8bbe\u5907\u8fd8\u771f\u4e0d\u591a\uff0c\u4f3c\u4e4e\u9664\u4e86\u4e00\u4e9b\u65e0\u7ebf\u7f51\u5361\u548c\u5f88\u5c11\u7684\u65e0\u7ebf\u4e0a\u7f51\u5361\u652f\u6301\u5916\uff0c\u5176\u4ed6\u7684\u6211\u5c31\u4e0d\u6e05\u695a\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a\u547d\u4ee4\u6211\u6ca1\u7528\u8fc7\uff0c\u770b\u4e86 man \u624b\u518c\uff0c\u4e5f\u6ca1\u6709\u770b\u51fa\u540d\u5802\uff0c\u5ffd\u7565\u4e4b\u3002</p>\n<h3 id=\"change_console\">change_console<a class=\"headerlink\" href=\"#change_console\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6539\u53d8\u7ec8\u7aef\uff0c\u8fd9\u4e2a\u547d\u4ee4\u662f init \u6765\u7528\u7684\uff0c\u6211\u600e\u4e48\u52a0\u53c2\u6570\u6765\u6267\u884c\uff0c\u4e5f\u6ca1\u6709\u770b\u51fa\u4ec0\u4e48\u53d8\u5316\uff0cman \u624b\u518c\u8bf4\u7684\u5f88\u5c11\uff0c\u5ffd\u7565\u4e4b\u3002</p>\n<h3 id=\"chkconfig\">chkconfig<a class=\"headerlink\" href=\"#chkconfig\" title=\"Permanent link\">&para;</a></h3>\n<p>\u66f4\u65b0\u548c\u67e5\u8be2\u7cfb\u7edf\u670d\u52a1\u7684\u8fd0\u884c\u7ea7\u522b\u4fe1\u606f\u3002\u6211\u4eec\u77e5\u9053\u5927\u90e8\u5206\u7684 Linux \u53d1\u884c\u7248\u672c\u90fd\u6709 0-6 \u5171 7 \u4e2a\u7ea7\u522b\u7684\u8fd0\u884c\u6a21\u5f0f\uff0c\u5148\u629b\u5f00\u5173\u673a\u7684 0 \u7ea7\u522b\u548c\u91cd\u542f\u7684 6 \u7ea7\u522b\uff0c\u90a3\u4e48\u5c31\u8fd8\u6709 1\uff0d5 \u5171 5 \u4e2a\u8fd0\u884c\u7ea7\u522b\uff0cLinux \u7cfb\u7edf\u5141\u8bb8\u4f60\u5b9a\u4e49\u5728\u4e0d\u52a8\u7684\u8fd0\u884c\u7ea7\u522b\u9ed8\u8ba4\u542f\u52a8\u4e0d\u52a8\u7684\u7cfb\u7edf\u670d\u52a1\u3002</p>\n<p>\u800c\u5b9e\u9645\u4e0a\u6240\u6709\u7684\u6267\u884c\u811a\u672c\u90fd\u662f\u5728<code>/etc/rc.d/init.d/</code>\u4e0b\u9762\u3002</p>\n<p>\u800c\u6bcf\u4e2a\u4e0d\u540c\u7ea7\u522b\u7684\u53ef\u4ee5\u8fd0\u884c\u7684\u7cfb\u7edf\u670d\u52a1\u5b9a\u4e49\u5728<code>/etc/rc.d/rc[0-6].d</code>\u91cc\uff0c\u91cc\u9762\u53ea\u6709\u8f6f\u8fde\u63a5\u3002\u8f6f\u8fde\u63a5\u5206\u6210\u4e86\u4e24\u79cd\u7c7b\u578b\uff0c\u4e00\u79cd\u662f K \u5f00\u59cb\u7684\u8f6f\u8fde\u63a5\uff0c\u4e00\u79cd\u662f S \u5f00\u5934\u7684\u8f6f\u8fde\u63a5\u3002\u5206\u522b\u8868\u793a\u9700\u8981\u505c\u6b62\u7684\u670d\u52a1\u548c\u542f\u52a8\u7684\u670d\u52a1\u3002</p>\n<p>\u5176\u4e2d\u542f\u52a8\u987a\u5e8f\u6709\u8fde\u63a5\u540d\u4e2d\u7684\u6570\u5b57\u51b3\u5b9a\uff0c\u6570\u5b57\u8d8a\u5c0f\uff0c\u542f\u52a8\u7684\u4f18\u5148\u7ea7\u5c31\u8d8a\u9ad8\u3002</p>\n<p>\u5f88\u663e\u7136\u5982\u679c\u8981\u6211\u4eec\u624b\u5de5\u6765\u7ba1\u7406\u8fd9\u4e9b\u8fde\u63a5\uff0c\u6050\u6015\u8868\u793a\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\u60c5\u3002\u4e5f\u662f <code>chkconfig</code> \u5c31\u51fa\u73b0\u4e86\u3002</p>\n<p>\u76ee\u524d Linux \u4e0b\u7684 <code>chkconfig</code> \u4e3b\u8981\u5b8c\u6210 5 \u4e2a\u65b9\u9762\u7684\u529f\u80fd\uff1a</p>\n<ol>\n<li>\u589e\u52a0\u53ef\u4ee5\u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1</li>\n<li>\u79fb\u8d70\u53ef\u4ee5\u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1</li>\n<li>\u5217\u51fa\u5f53\u524d\u670d\u52a1\u5668\u7684\u542f\u52a8\u4fe1\u606f</li>\n<li>\u6539\u53d8\u7cfb\u7edf\u670d\u52a1\u7684\u542f\u52a8\u4fe1\u606f</li>\n<li>\u68c0\u67e5\u7279\u5b9a\u670d\u52a1\u7684\u542f\u52a8\u72b6\u6001</li>\n</ol>\n<p>\u6211\u4eec\u4e3e\u4e00\u4e2a\u4f8b\u5b50\u9610\u8ff0\u4e0a\u9762\u7684 5 \u4e2a\u529f\u80fd</p>\n<p>\u5047\u8bbe\u6211\u4eec\u5199\u4e86\u4e00\u4e2a\u670d\u52a1\u7a0b\u5e8f\uff0c\u6211\u4eec\u5e0c\u671b\u50cf\u5176\u4ed6\u7cfb\u7edf\u670d\u52a1\u90a3\u6837\u53ef\u4ee5\u5b9a\u4e49\u4e0d\u540c\u7ea7\u522b\u7684\u542f\u52a8\u505c\u6b62\u65b9\u5f0f\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u7684\u52a0\u5165\u5230 <code>/etc/rc.d/rc.local</code> \u6587\u4ef6\u4e2d\u3002\u90a3\u4e48\u6211\u4eec\u9996\u5148\u8981\u521b\u5efa\u4e00\u4e2a\u8fd0\u884c\u811a\u672c\u653e\u5230 <code>/etc/rc.d/init.d</code> \u76ee\u5f55\u4e0b\uff0c\u5e76\u8bbe\u7f6e\u597d\u6743\u9650\u3002\u5982\u679c\u4f60\u4e0d\u77e5\u9053\u5982\u4f55\u4fee\u6539\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u8003\u53c2 <code>init.d</code> \u76ee\u5f55\u4e0b\u7684\u4efb\u4f55\u4e00\u4e2a\u8fd0\u884c\u811a\u672c\u3002\u4e0b\u9762\u7684\u662f\u6211\u7684\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u811a\u672c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># cat /etc/rc.d/init.d/test</span>\n<span class=\"c1\">#! /bin/sh</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># test simple test system service for management by chkconfig</span>\n<span class=\"c1\">#</span>\n\n<span class=\"c1\"># Source function library.</span>\n.<span class=\"w\"> </span>/etc/rc.d/init.d/functions\n\n<span class=\"c1\"># Set defaults</span>\n\nstart<span class=\"o\">(){</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201cStarting<span class=\"w\"> </span>test:<span class=\"w\"> </span>\u201d\n<span class=\"w\">    </span>/usr/local/bin/tmy<span class=\"w\"> </span>start\n<span class=\"w\">    </span><span class=\"nv\">RETAL</span><span class=\"o\">=</span><span class=\"nv\">$?</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span>\n<span class=\"o\">}</span>\n\nstop<span class=\"o\">(){</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201cStopping<span class=\"w\"> </span>test:<span class=\"w\"> </span>\u201d\n<span class=\"w\">    </span>/usr/local/bin/tmy<span class=\"w\"> </span>stop\n<span class=\"w\">    </span><span class=\"nv\">RETVAL</span><span class=\"o\">=</span><span class=\"nv\">$?</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span>\n<span class=\"o\">}</span>\n\nrestart<span class=\"o\">(){</span>\n<span class=\"w\">    </span>stop\n<span class=\"w\">    </span>start\n<span class=\"o\">}</span>\n\n<span class=\"c1\"># See how we were called.</span>\n<span class=\"k\">case</span><span class=\"w\"> </span>\u201c<span class=\"nv\">$1</span>\u2033<span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">    </span>start<span class=\"o\">)</span>\n<span class=\"w\">    </span>start\n<span class=\"w\">    </span><span class=\"p\">;;</span>\n<span class=\"w\">    </span>stop<span class=\"o\">)</span>\n<span class=\"w\">    </span>stop\n<span class=\"w\">    </span><span class=\"p\">;;</span>\n*<span class=\"o\">)</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>\u201cUsage:<span class=\"w\"> </span><span class=\"nb\">test</span><span class=\"w\"> </span><span class=\"o\">{</span>start<span class=\"p\">|</span>stop<span class=\"p\">|</span><span class=\"o\">}</span>\u201d\n<span class=\"nv\">RETVAL</span><span class=\"o\">=</span><span class=\"m\">1</span>\n<span class=\"k\">esac</span>\n\n<span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"nv\">$RETVAL</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># cat /usr/local/bin/tmy</span>\n<span class=\"c1\">#!/bin/bash</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"nv\">$1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>\u201cstart\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"k\">then</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>\u201chave<span class=\"w\"> </span>started<span class=\"w\"> </span>my<span class=\"w\"> </span>services\u201d\n<span class=\"k\">elif</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"nv\">$1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>\u201cstop\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>\u201chave<span class=\"w\"> </span>stoped<span class=\"w\"> </span>myservices\u201d\n<span class=\"k\">fi</span>\n<span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>\u73b0\u5728\u4f60\u53ef\u4ee5\u4f7f\u7528<code>/etc/init.d/test start|stop</code>\u7684\u65b9\u5f0f\u542f\u52a8\u8fd9\u4e2a\u670d\u52a1\u3002\u4f46\u662f</p>\n<p><code>chkconfig --list test test</code> \u670d\u52a1\u4e0d\u652f\u6301 chkconfig</p>\n<p>\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u628a\u8fd9\u4e2a\u670d\u52a1\u5668\u52a0\u5165\u5230\u53ef\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u5728\u6267\u884c\u811a\u672c\u4e2d\u52a0\u5165\u4e24\u884c\u8ba9 chkconfig \u8bc6\u522b\u7684\u6ce8\u91ca</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># chkconfig:2345 20 80</span>\n<span class=\"c1\"># description: test simple test system service for management by chkconfig</span>\n</code></pre></div>\n<p>\u8fd9\u4e24\u884c\u6ce8\u91ca\u662f\u544a\u8bc9 <code>chkconfig</code> \u547d\u4ee4\uff0c\u8fd9\u811a\u672c\u5e94\u8be5\u5728 2\uff0c3\uff0c4\uff0c5 \u8fd9 4 \u4e2a\u7ea7\u522b\u542f\u52a8\uff0c\u4e14\u542f\u52a8\u4f18\u5148\u7ea7\u662f 20\uff0c\u800c\u5bf9\u5e94\u7684\u505c\u6b62\u4f18\u5148\u7ea7\u662f 80\u3002\n\u52a0\u5165\u540e\uff0c\u6211\u4eec\u518d\u8bd5\u8bd5 chkconfig \u547d\u4ee4</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># chkconfig --list test</span>\n<span class=\"nb\">test</span><span class=\"w\"> </span>\u670d\u52a1\u652f\u6301<span class=\"w\"> </span>chkconfig\uff0c\u4f46\u5b83\u5728\u4efb\u4f55\u7ea7\u522b\u4e2d\u90fd\u6ca1\u6709\u88ab\u5f15\u7528<span class=\"o\">(</span>\u8fd0\u884c\u201cchkconfig<span class=\"w\"> </span>--add<span class=\"w\"> </span>test\u201d<span class=\"o\">)</span>\n</code></pre></div>\n<p>\u6069\uff0c\u81f3\u5c11 chkconfig \u8ba4\u8bc6\u51fa\u4e86 test\uff0c\u800c\u4e14\u4e5f\u8bf4\u4e86\u53ef\u4ee5\u88ab\u7ba1\u7406\uff0c\u53ea\u662f\u6ca1\u6709\u52a0\u5165\u3002</p>\n<p>\u6839\u636e\u63d0\u793a\uff0c\u6211\u4eec\u9700\u8981\u52a0\u5165\u4ed6</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># chkconfig --add test</span>\n<span class=\"c1\"># echo $?</span>\n<span class=\"m\">0</span>\n<span class=\"c1\"># chkconfig --list test test</span>\n<span class=\"w\">    </span><span class=\"m\">0</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">1</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">2</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">3</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">4</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">5</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">6</span>:\u5173\u95ed\n</code></pre></div>\n<p>\u8fd9\u548c\u6211\u4eec\u671f\u671b\u7684\u662f\u4e00\u6837\u7684\u3002\u7136\u540e\u6211\u4eec\u770b\u770b test \u8f6f\u8fde\u63a5</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ls -l /etc/rc.d/rc6.d/K80test</span>\nlrwxrwxrwx<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">20</span>:47<span class=\"w\"> </span>/etc/rc.d/rc6.d/K80test<span class=\"w\"> </span>-&gt;<span class=\"w\"> </span>../init.d/test\n<span class=\"c1\"># ls -l /etc/rc.d/rc3.d/S20test</span>\nlrwxrwxrwx<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">20</span>:47<span class=\"w\"> </span>/etc/rc.d/rc3.d/S20test<span class=\"w\"> </span>-&gt;<span class=\"w\"> </span>../init.d/test\n</code></pre></div>\n<p>\u5230\u6b64\uff0ctest \u670d\u52a1\u5df2\u7ecf\u52a0\u5165\u4e86\u53ef\u88ab chkconfig \u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1\u8303\u56f4\u5185\u3002\u90a3\u4e48\u6211\u4eec\u4e8b\u5b9e\u4fee\u6539\u548c\u5220\u9664\u770b\u770b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># chkconfig --list test test</span>\n<span class=\"m\">0</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">1</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">2</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">3</span>:\u542f\u7528\n<span class=\"m\">4</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">5</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">6</span>:\u5173\u95ed\n<span class=\"c1\"># chkconfig --level 3 test off</span>\n<span class=\"c1\"># chkconfig --list test test</span>\n<span class=\"m\">0</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">1</span>:\u5173\u95ed<span class=\"w\"> </span><span class=\"m\">2</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">3</span>:\u5173\u95ed<span class=\"w\">     </span><span class=\"m\">4</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">5</span>:\u542f\u7528<span class=\"w\"> </span><span class=\"m\">6</span>:\u5173\u95ed\n<span class=\"c1\"># ls -l /etc/rc.d/rc3.d/K80test</span>\nlrwxrwxrwx<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">20</span>:54<span class=\"w\"> </span>/etc/rc.d/rc3.d/K80test<span class=\"w\"> </span>-&gt;<span class=\"w\">    </span>../init.d/test\n<span class=\"c1\"># chkconfig --del test</span>\n<span class=\"c1\"># chkconfig --list test</span>\n<span class=\"nb\">test</span><span class=\"w\"> </span>\u670d\u52a1\u652f\u6301<span class=\"w\"> </span>chkconfig\uff0c\u4f46\u5b83\u5728\u4efb\u4f55\u7ea7\u522b\u4e2d\u90fd\u6ca1\u6709\u88ab\u5f15\u7528<span class=\"o\">(</span>\u8fd0\u884c\u201cchkconfig<span class=\"w\"> </span>--add<span class=\"w\"> </span>test\u201d<span class=\"o\">)</span>\n</code></pre></div>\n<p>\u5982\u679c\u8981\u5f7b\u5e95\u5220\u9664 test \u670d\u52a1\uff0c\u90a3\u4e48\u5c31\u53ea\u8981\u5220\u9664 test \u6267\u884c\u811a\u672c\u5c31\u884c\u4e86\u3002</p>\n<h3 id=\"consoletype\">consoletype<a class=\"headerlink\" href=\"#consoletype\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6253\u5370\u8fde\u63a5\u5230\u6807\u6ce8\u8f93\u5165\u7684\u7ec8\u7aef\u7c7b\u578b\uff1b\u8fd9\u662f Asianux \u7279\u6709\u7684\u547d\u4ee4\uff0c\u4ed6\u6839\u636e\u7ec8\u7aef\u7684\u4e0d\u540c\u7c7b\u578b\u6253\u5370\u51fa\u4e0d\u540c\u7684\u4fe1\u606f\u3002</p>\n<p>\u5982\u679c\u662f\u865a\u62df\u7ec8\u7aef(/dev/tty* \u6216\u8005\u4e0d\u662f\u4e32\u884c\u7ec8\u7aef\u7684<code>/dev/console</code>)\uff0c\u6253\u5370\u51fa vt</p>\n<p>\u5982\u679c\u6807\u51c6\u8f93\u5165\u662f\u4e32\u884c\u7ec8\u7aef(<code>/dev/console</code> \u548c\u6216\u8005<code>/dev/ttyS*</code>)\uff0c\u6253\u5370 serial</p>\n<p>\u5982\u679c\u6807\u51c6\u8f93\u5165\u662f\u4f2a\u7ec8\u7aef\uff08<code>/dev/pts/\\*</code>)\uff0c\u6253\u5370 pty</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># who</span>\nroot<span class=\"w\"> </span>pts/0<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">19</span>:41<span class=\"w\"> </span><span class=\"o\">(</span>:0.0<span class=\"o\">)</span>\n\n<span class=\"c1\"># consoletype</span>\npty\n\n<span class=\"c1\"># who</span>\nroot<span class=\"w\"> </span>tty1<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">21</span>:05\n\n<span class=\"c1\"># consoletype</span>\nvt\n\n<span class=\"c1\"># cat test.c</span>\n<span class=\"c1\">#include</span>\n<span class=\"c1\">#include</span>\nint<span class=\"w\"> </span>main<span class=\"o\">()</span>\n<span class=\"o\">{</span>\n<span class=\"w\">    </span>int<span class=\"w\"> </span>fd1,fd2<span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nv\">fd1</span><span class=\"o\">=</span>open<span class=\"o\">(</span>\u201ctest.sh\u201d,O_RDONLY<span class=\"o\">)</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span>!fd1<span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span>\n<span class=\"w\">    </span>perror<span class=\"o\">(</span>\u201cerror<span class=\"w\"> </span>open<span class=\"w\"> </span>test.sh\u201d<span class=\"o\">)</span><span class=\"p\">;</span>\n<span class=\"w\">    </span>exit<span class=\"o\">(</span><span class=\"m\">65</span><span class=\"o\">)</span><span class=\"p\">;</span>\n<span class=\"o\">}</span>\n<span class=\"nv\">fd2</span><span class=\"o\">=</span>dup2<span class=\"o\">(</span>fd1,0<span class=\"o\">)</span><span class=\"p\">;</span>\nsystem<span class=\"o\">(</span>\u201c/sbin/consoletype<span class=\"w\"> </span>&gt;/tmp/a\u201d<span class=\"o\">)</span><span class=\"p\">;</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">;</span>\n<span class=\"o\">}</span>\n<span class=\"c1\"># gcc test.c -o test</span>\n<span class=\"c1\"># ./test</span>\n<span class=\"c1\"># cat a</span>\nserial\n<span class=\"c1\"># consoletype</span>\npty\n</code></pre></div>\n<h3 id=\"cryptsetup\">cryptsetup<a class=\"headerlink\" href=\"#cryptsetup\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bf9\u6307\u5b9a\u7684\u8bbe\u522b\u8fdb\u884c\u52a0\u5bc6\uff0c\u8fd9\u91cc\u7684\u8bbe\u522b\u5fc5\u987b\u662f <code>/dev/mapper</code> \u4e0b\u7684\u8bbe\u5907\uff0c\u90a3\u8fd9\u6837\u770b\u6765 2.4 \u7684\u5185\u6838\u662f\u6ca1\u6709\u8fd9\u4e2a\u547d\u4ee4\u4e86\u3002\n\u4ed6\u5bf9\u5e94\u7684\u5e94\u8be5\u6709\u53e6\u5916\u4e00\u4e2a\u547d\u4ee4 <code>dm-crypt</code>\uff0c\u4f46\u662f\u6211\u7684\u7cfb\u7edf\u4e0a\u627e\u4e0d\u5230\u3002\n\u8be5\u547d\u4ee4\u6ca1\u6709 man \u624b\u518c\uff0c\u5176 help \u5e2e\u52a9\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code># cryptsetup \u2013help\nUsage: cryptsetup [OPTION\u2026] []\n-v, \u2013verbose Shows more detailed error messages\n-c, \u2013cipher=STRING The cipher used to encrypt the disk (see\n/proc/crypto) (default: \u201caes\u201d)\n-h, \u2013hash=STRING The hash used to create the encryption key from\nthe passphrase (default: \u201cripemd160\u2033)\n-y, \u2013verify-passphrase Verifies the passphrase by asking for it twice\n-d, \u2013key-file=STRING Read the key from a file (can be /dev/random)\n-s, \u2013key-size=BITS The size of the encryption key (default: 256)\n-b, \u2013size=SECTORS The size of the device\n-o, \u2013offset=SECTORS The start offset in the backend device\n-p, \u2013skip=SECTORS How many sectors of the encrypted data to skip\nat the beginning\n\nHelp options:\n-?, \u2013help Show this help message\n\u2013usage Show this help message\n\nis one of:\ncreate \u2013 create device\nremove \u2013 remove device\nreload \u2013 modify active device\nresize \u2013 resize active device\nstatus \u2013 show device status\nis the device to create under /dev/mapper\nis the encrypted device\n</code></pre></div>\n<p>\u8fd9\u4e2a help \u4f3c\u4e4e\u4e5f\u4e0d\u80fd\u5e2e\u6211\u4eec\u4e86\u89e3\u66f4\u591a\u7684\u5185\u5bb9\u3002\u53ea\u597d\u4f5c\u6d4b\u8bd5\u4e86\u3002</p>\n<p>\u6211\u7528\u4e86\u4e00\u4e2a U \u76d8\u6765\u521b\u5efa LVM\uff0c\u8fd9\u6837\u5728<code>/dev/mapper</code> \u4e0b\u9762\u5c31\u6709\u5bf9\u5e94\u7684\u8bbe\u5907\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ls -l /dev/mapper/vg0-lv0</span>\n<span class=\"w\">    </span>brw-rw\u2014-<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>disk<span class=\"w\"> </span><span class=\"m\">253</span>,<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:13<span class=\"w\"> </span>/dev/mapper/vg0-lv0\n\n<span class=\"c1\"># mount /dev/mapper/vg0-lv0 /misc</span>\n\n<span class=\"c1\"># ls -l /misc</span>\n<span class=\"w\">    </span>\u603b\u7528\u91cf<span class=\"w\"> </span><span class=\"m\">12</span>\n<span class=\"w\">    </span>drwx\u2014\u2014<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">12288</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:21<span class=\"w\"> </span>lost+found\n\n<span class=\"c1\"># touch /misc/one</span>\n\n<span class=\"c1\"># ls -l /misc</span>\n<span class=\"w\">    </span>\u603b\u7528\u91cf<span class=\"w\"> </span><span class=\"m\">12</span>\n<span class=\"w\">    </span>drwx\u2014\u2014<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">12288</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:21<span class=\"w\"> </span>lost+found\n<span class=\"w\">    </span>-rw-r\u2013r\u2013<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:22<span class=\"w\"> </span>one\n\n<span class=\"c1\"># umount /misc</span>\n\n<span class=\"c1\"># cryptsetup create cytest /dev/mapper/vg0-lv0</span>\n<span class=\"w\">    </span>Enter<span class=\"w\"> </span>passphrase:mypassword\n\n<span class=\"c1\"># ls -l /dev/mapper/vg0-lv0</span>\n<span class=\"w\">    </span>brw-rw\u2014-<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>disk<span class=\"w\"> </span><span class=\"m\">253</span>,<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:13<span class=\"w\"> </span>/dev/mapper/vg0-lv0\n\n<span class=\"c1\"># mount /dev/mapper/vg0-lv0 /misc</span>\n<span class=\"w\">    </span>mount:<span class=\"w\"> </span>/dev/mapper/vg0-lv0<span class=\"w\"> </span>already<span class=\"w\"> </span>mounted<span class=\"w\"> </span>or<span class=\"w\"> </span>/misc<span class=\"w\"> </span>busy\n\n<span class=\"c1\"># cryptsetup remove cytest</span>\n\n<span class=\"c1\"># mount /dev/mapper/vg0-lv0 /misc</span>\n\n<span class=\"c1\"># ls -l /misc</span>\n<span class=\"w\">    </span>\u603b\u7528\u91cf<span class=\"w\"> </span><span class=\"m\">12</span>\n<span class=\"w\">    </span>drwx\u2014\u2014<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">12288</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:21<span class=\"w\"> </span>lost+found\n<span class=\"w\">    </span>-rw-r\u2013r\u2013<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">22</span>:22<span class=\"w\"> </span>one\n</code></pre></div>\n<p>\u52a0\u5bc6\u524d\u7684\u8bbe\u5907\u548c\u52a0\u5bc6\u540e\u7684\u8bbe\u5907\u6211\u7528 <code>od</code> \u547d\u4ee4\u67e5\u770b\u4e86\u8f93\u51fa\u503c\uff0c\u53d1\u73b0\u6ca1\u6709\u4e0d\u540c\uff0c\u770b\u4e86\u4ed6\u4e0d\u662f\u6839\u636e\u5185\u5bb9\u52a0\u5bc6\u7684\uff0c\u5177\u4f53\u60c5\u51b5\u9700\u8981\u67e5<a href=\"http://www.saout.de/misc/dm-crypt/\">\u5b98\u65b9\u7f51\u7ad9</a>\u624d\u77e5\u9053\u4e86\u3002</p>\n<h3 id=\"ctrlaltdel\">ctrlaltdel<a class=\"headerlink\" href=\"#ctrlaltdel\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bbe\u7f6e <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u7684\u529f\u80fd\uff0c\u8fd9\u91cc\u6709\u4e24\u79cd\u65b9\u5f0f hard \u548c soft\u3002</p>\n<p>hard \u8868\u793a\u5f53\u63a5\u53d7 <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u65f6\uff0c\u7cfb\u7edf\u7acb\u523b\u91cd\u542f\u8ba1\u7b97\u673a\uff0c\u800c\u4e0d\u4f1a\u8c03\u7528 <code>sync(2)</code>\u547d\u4ee4\uff0c\u4e5f\u4e0d\u4f1a\u4f5c\u5176\u4ed6\u4e00\u4e9b\u51c6\u5907\uff0c\u8fd9\u6709\u70b9\u7c7b\u4f3c\u4e0d\u5ef6\u65f6\u7684 reset \u6309\u94ae\u3002</p>\n<p>\u800c soft \u5219\u8868\u793a <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u6309\u4e0b\u65f6\uff0c\u4ed6\u53d1\u9001 SIGINT \u4fe1\u53f7\u7ed9 init \u8fdb\u7a0b\uff0c\u90a3\u5269\u4e0b\u7684\u4e8b\u60c5\u5c31\u662f\u770b init \u5982\u4f55\u505a\u4e86\u3002</p>\n<h2 id=\"sbin-d\">/sbin \u4e0b d \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-d\" title=\"Permanent link\">&para;</a></h2>\n<p>\u547d\u4ee4\u5982\u4e0b</p>\n<blockquote>\n<p>debugfs delpart dhclient-script dmsetup dump dump.static\ndebugfs.ocfs2 depmod dhcp6c dmsetup.static dump_cis\ndebugreiserfs dhclient dmraid dosfsck dumpe2fs</p>\n</blockquote>\n<p>\u5176\u4e2d <code>dump.static</code> \u8f6f\u8fde\u63a5\u5230 dump \u547d\u4ee4\uff0c\u800c dump \u7a0b\u5e8f\u662f\u4e00\u4e2a\u9759\u6001\u7f16\u8bd1\u7684\u547d\u4ee4\u3002</p>\n<h3 id=\"debugfs\">debugfs<a class=\"headerlink\" href=\"#debugfs\" title=\"Permanent link\">&para;</a></h3>\n<p>debugfs, debufs.ocfs2, debugreiserfs \u662f\u6587\u4ef6\u7cfb\u7edf\u8c03\u8bd5\u5de5\u5177\uff0c\u5176\u4e2d debugfs \u6211\u4f7f\u7528\u8fc7\u4e00\u6b21\uff0c\u5176\u76ee\u7684\u662f\u5e0c\u671b\u6062\u590d\u5220\u9664\u7684\u67d0\u4e2a\u6587\u4ef6\u3002</p>\n<p>\u4f46\u662f\u5b9e\u9a8c\u8868\u660e\uff0cext2 \u7684\u6587\u4ef6\u7cfb\u7edf\u6709\u6062\u590d\u7684\u53ef\u80fd\u6027\uff0c\u4f46\u662f ext3 \u5374\u6ca1\u6709\u53ef\u80fd\u3002\u5728 ext3 \u6587\u4ef6\u7cfb\u7edf\u5b98\u65b9\u7ad9\u70b9\u7684 FAQ \u4e2d\uff0c\u5c31\u6709\u4e00\u4e2a\u8fd9\u6837\u7684\u95ee\u9898\uff0c\u5176\u4e2d\u7b54\u6848\u5c31\u662f\u544a\u8bc9\u4f60\uff0c\u91c7\u7528 <code>rm -f</code> \u65b9\u5f0f\u5220\u9664\u7684\u547d\u4ee4\u662f\u6ca1\u6709\u529e\u6cd5\u6062\u590d\u7684\uff0c\u56e0\u4e3a\u4ed6\u4e0d\u4ec5\u4ec5\u53ea\u662f\u4f5c\u5220\u9664\u7684\u6807\u8bb0\u3002</p>\n<p>\u800c <code>ocfs2</code> \u76ee\u524d\u5e76\u4e0d\u7a33\u5b9a\uff0c\u8fd9\u662f Oracle \u63a8\u51fa\u7684\u4e00\u79cd\u6587\u4ef6\u7cfb\u7edf\uff0c\u662f\u4e3a Oracle \u6570\u636e\u5e93\u7684\u9ad8\u53ef\u7528\u670d\u52a1\u7684\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u7684\u9879\u76ee\u4e2d\uff0cocfs \u8868\u73b0\u7684\u5e76\u5982\u4eba\u610f\u3002\u8d77\u6587\u4ef6\u7cfb\u7edf\u90fd\u7528\u5f97\u5c11\uff0c\u90a3\u4e48\u8c03\u8bd5\u5c31\u66f4\u5c11\u4e86\u3002</p>\n<p><code>reiserfs</code> \u662f SuSe \u53d1\u884c\u7248\u672c\u4e2d\u9ed8\u8ba4\u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\uff0cRedHat \u7f3a\u7701\u662f ext2/ext3 \u7684\u6587\u4ef6\u7cfb\u7edf\u3002 \u6240\u4ee5 debugreiserfs \u4e5f\u5c31\u6ca1\u6709\u7528\u8fc7\u4e86\uff0c\u52a0\u4e0a reiserfs \u7684\u5f00\u53d1\u8005\u56e0\u4e3a\u8c0b\u6740\u59bb\u5b50\u7684\u7f6a\u540d\u88ab\u902e\u6355\uff0c\u56e0\u6b64\u8fd9\u4e2d\u6587\u4ef6\u7cfb\u7edf\u524d\u9014\u8fd8\u4e0d\u77e5\u9053\u600e\u4e48\u6837\u3002</p>\n<h3 id=\"depart\">depart<a class=\"headerlink\" href=\"#depart\" title=\"Permanent link\">&para;</a></h3>\n<p><code>delpart</code> \u8fd9 \u4e2a\u547d\u4ee4\u5f88\u5947\u602a\uff0c\u6ca1\u6709 man \u624b\u518c\uff0c\u6ca1\u6709 info \u4fe1\u606f\uff0c\u5e2e\u52a9\u4e5f\u662f\u5c11\u5f97\u53ef\u601c\uff0c\u4f3c\u4e4e\u5f88\u4e0d\u7b26\u5408 <code>*nix</code> \u4e0b\u7a0b\u5e8f\u5f00\u53d1\u7684\u4e60\u60ef\u3002\u800c\u4ed6\u6240\u5c5e\u7684 rpm \u5305\u53c8\u662f <code>util-linux</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u5de5\u5177\u96c6\uff0c\u56e0\u6b64 <code>rpm -qi</code> \u4e5f\u4e0d\u80fd\u627e\u5230\u6709\u7528\u7684\u4fe1\u606f\u3002\u90a3\u5c31\u53ea\u80fd\u4ece\u5e2e\u52a9\u548c\u8d77\u7a0b\u5e8f\u547d\u4ee4\u6765\u770b\u4e86\u3002</p>\n<p>\u521a\u770b\u5230\u8fd9\u4e2a\u540d\u5b57\uff0c\u6211\u4ee5\u4e3a\u4ed6\u662f <code>parted</code> \u7a0b\u5e8f\u7684\u4e00\u90e8\u5206\uff0c\u7ed3\u679c\u4e0d\u662f\u3002\u770b\u5e2e\u52a9</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># delpart  \u2013help</span>\nusage:<span class=\"w\"> </span>delpart<span class=\"w\"> </span>diskdevice<span class=\"w\"> </span>partitionnr\n</code></pre></div>\n<p>\u4f3c\u4e4e\u4e5f\u5e94\u8be5\u662f\u548c\u5206\u533a\u6709\u5173\u7cfb\u3002\u6211\u7684\u731c\u60f3\u662f\u4ed6\u5e94\u8be5\u662f\u5220\u9664\u4e00\u4e2a\u6307\u5b9a\u7684\u5206\u533a\u3002\u4e0b\u9762\u662f\u6211\u7684\u5b9e\u9a8c\u8fc7\u7a0b</p>\n<p>\u9996\u5148\u628a\u6211\u7684 U \u76d8\u5206\u4e00\u4e2a\u5206\u533a\u51fa\u6765</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># fdisk -l /dev/sda</span>\n\nDisk<span class=\"w\"> </span>/dev/sda:<span class=\"w\"> </span><span class=\"m\">252</span><span class=\"w\"> </span>MB,<span class=\"w\"> </span><span class=\"m\">252968960</span><span class=\"w\"> </span>bytes\n<span class=\"m\">8</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">61</span><span class=\"w\"> </span>sectors/track,<span class=\"w\"> </span><span class=\"m\">1012</span><span class=\"w\"> </span>cylinders\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">488</span><span class=\"w\"> </span>*<span class=\"w\"> </span><span class=\"nv\">512</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">249856</span><span class=\"w\"> </span>bytes\n\nDevice<span class=\"w\"> </span>Boot<span class=\"w\"> </span>Start<span class=\"w\"> </span>End<span class=\"w\"> </span>Blocks<span class=\"w\"> </span>Id<span class=\"w\"> </span>System\n/dev/sda1<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span><span class=\"m\">19733</span>+<span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n\n<span class=\"c1\"># delpart /dev/sda 1</span>\n\n<span class=\"c1\"># fdisk -l /dev/sda</span>\n\nDisk<span class=\"w\"> </span>/dev/sda:<span class=\"w\"> </span><span class=\"m\">252</span><span class=\"w\"> </span>MB,<span class=\"w\"> </span><span class=\"m\">252968960</span><span class=\"w\"> </span>bytes\n<span class=\"m\">8</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">61</span><span class=\"w\"> </span>sectors/track,<span class=\"w\"> </span><span class=\"m\">1012</span><span class=\"w\"> </span>cylinders\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">488</span><span class=\"w\"> </span>*<span class=\"w\"> </span><span class=\"nv\">512</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">249856</span><span class=\"w\"> </span>bytes\n\nDevice<span class=\"w\"> </span>Boot<span class=\"w\"> </span>Start<span class=\"w\"> </span>End<span class=\"w\"> </span>Blocks<span class=\"w\"> </span>Id<span class=\"w\"> </span>System\n/dev/sda1<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span><span class=\"m\">19733</span>+<span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n\n<span class=\"c1\"># delpart /dev/sda 1</span>\nBLKPG:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>device<span class=\"w\"> </span>or<span class=\"w\"> </span>address\n</code></pre></div>\n<p>\u4ece\u5b9e\u9a8c\u6765\u770b\uff0c\u4ed6\u5e94\u8be5\u662f\u5220\u9664\u4e00\u4e2a\u5206\u533a\u7684\uff0c\u800c\u4e14\u6211\u4eec\u4ece delpart \u7a0b\u5e8f\u53cd\u9988\u4fe1\u606f\u6765\u770b\uff0c\u4ed6\u8ba4\u4e3a\u4ed6\u5220\u9664\u4e86 sda1\uff0c\u4f46\u662f fdisk \u547d\u4ee4\u5374\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u8fd8\u5728\u3002\n\u63a5\u4e0b\u6765\u6211\u6d4b\u8bd5\u8fd9\u4e2a\u5206\u533a\u662f\u5426\u80fd mkfs</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># mkfs.ext2 /dev/sda1</span>\nmke2fs<span class=\"w\"> </span><span class=\"m\">1</span>.35<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">28</span>-Feb-2004<span class=\"o\">)</span>\nCould<span class=\"w\"> </span>not<span class=\"w\"> </span>stat<span class=\"w\"> </span>/dev/sda1<span class=\"w\"> </span>\u2014<span class=\"w\"> </span>\u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n\nThe<span class=\"w\"> </span>device<span class=\"w\"> </span>apparently<span class=\"w\"> </span>does<span class=\"w\"> </span>not<span class=\"w\"> </span>exist<span class=\"p\">;</span><span class=\"w\"> </span>did<span class=\"w\"> </span>you<span class=\"w\"> </span>specify<span class=\"w\"> </span>it<span class=\"w\"> </span>correctly?\n</code></pre></div>\n<p>\u770b\u6765\u771f\u7684\u5df2\u7ecf\u5220\u9664\u4e86\uff0c\u4f46\u662f\u4e3a\u4ec0\u4e48 fdisk \u4e0d\u8fd9\u4e48\u8ba4\u4e3a\u5462\uff1f\u800c\u4e14 parted \u4e5f\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u662f\u5b58\u5728\u7684</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># parted /dev/sda</span>\nGNU<span class=\"w\"> </span>Parted<span class=\"w\"> </span><span class=\"m\">1</span>.6.19\nCopyright<span class=\"w\"> </span><span class=\"o\">(</span>C<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"m\">1998</span><span class=\"w\"> </span>\u2013<span class=\"w\"> </span><span class=\"m\">2004</span><span class=\"w\"> </span>Free<span class=\"w\"> </span>Software<span class=\"w\"> </span>Foundation,<span class=\"w\"> </span>Inc.\nThis<span class=\"w\"> </span>program<span class=\"w\"> </span>is<span class=\"w\"> </span>free<span class=\"w\"> </span>software,<span class=\"w\"> </span>covered<span class=\"w\"> </span>by<span class=\"w\"> </span>the<span class=\"w\"> </span>GNU<span class=\"w\"> </span>General<span class=\"w\"> </span>Public<span class=\"w\"> </span>License.\n\nThis<span class=\"w\"> </span>program<span class=\"w\"> </span>is<span class=\"w\"> </span>distributed<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>the<span class=\"w\"> </span>hope<span class=\"w\"> </span>that<span class=\"w\"> </span>it<span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>useful,<span class=\"w\"> </span>but<span class=\"w\"> </span>WITHOUT<span class=\"w\"> </span>ANY<span class=\"w\"> </span>WARRANTY<span class=\"p\">;</span><span class=\"w\"> </span>without\neven<span class=\"w\"> </span>the<span class=\"w\"> </span>implied<span class=\"w\"> </span>warranty<span class=\"w\"> </span>of<span class=\"w\"> </span>MERCHANTABILITY<span class=\"w\"> </span>or<span class=\"w\"> </span>FITNESS<span class=\"w\"> </span>FOR<span class=\"w\"> </span>A<span class=\"w\"> </span>PARTICULAR<span class=\"w\"> </span>PURPOSE.<span class=\"w\"> </span>See<span class=\"w\"> </span>the<span class=\"w\"> </span>GNU\nGeneral<span class=\"w\"> </span>Public<span class=\"w\"> </span>License<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>more<span class=\"w\"> </span>details.\n\n\u4f7f\u7528<span class=\"w\"> </span>/dev/sda\n<span class=\"o\">(</span>parted<span class=\"o\">)</span><span class=\"w\"> </span>print\n/dev/sda<span class=\"w\"> </span>\u7684\u78c1\u76d8\u51e0\u4f55\u7ed3\u6784\uff1a0.000-241.250<span class=\"w\"> </span>\u5146\u5b57\u8282\n\u78c1\u76d8\u6807\u7b7e\u7c7b\u578b\uff1amsdos\nMinor<span class=\"w\"> </span>\u8d77\u59cb\u70b9<span class=\"w\"> </span>\u7ec8\u6b62\u70b9<span class=\"w\"> </span>\u7c7b\u578b<span class=\"w\"> </span>\u6587\u4ef6\u7cfb\u7edf<span class=\"w\"> </span>\u6807\u5fd7\n<span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">0</span>.030<span class=\"w\"> </span><span class=\"m\">19</span>.300<span class=\"w\"> </span>\u4e3b\u5206\u533a\n</code></pre></div>\n<p>\u4f46\u662f\u5185\u6838\u5374\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># cat /proc/partitions</span>\nmajor<span class=\"w\"> </span>minor<span class=\"w\"> </span><span class=\"c1\">#blocks name</span>\n\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">29302560</span><span class=\"w\"> </span>hda\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">5246608</span><span class=\"w\"> </span>hda1\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"m\">5178600</span><span class=\"w\"> </span>hda2\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>hda3\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"m\">13267768</span><span class=\"w\"> </span>hda4\n<span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"m\">5606653</span><span class=\"w\"> </span>hda5\n<span class=\"m\">8</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">247040</span><span class=\"w\"> </span>sda\n</code></pre></div>\n<p>\u800c\u4f7f\u7528 sfdisk \u547d\u4ee4\u540c\u6837\u4e5f\u8ba4\u4e3a sda1 \u5b58\u5728\uff0c\u4f46\u662f\u5728\u626b\u63cf sda1 \u65f6\u505c\u6b62</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># sfdisk /dev/sda</span>\nChecking<span class=\"w\"> </span>that<span class=\"w\"> </span>no-one<span class=\"w\"> </span>is<span class=\"w\"> </span>using<span class=\"w\"> </span>this<span class=\"w\"> </span>disk<span class=\"w\"> </span>right<span class=\"w\"> </span>now<span class=\"w\"> </span>\u2026\nOK\n\nDisk<span class=\"w\"> </span>/dev/sda:<span class=\"w\"> </span><span class=\"m\">1012</span><span class=\"w\"> </span>cylinders,<span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">61</span><span class=\"w\"> </span>sectors/track\nOld<span class=\"w\"> </span>situation:\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">249856</span><span class=\"w\"> </span>bytes,<span class=\"w\"> </span>blocks<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">1024</span><span class=\"w\"> </span>bytes,<span class=\"w\"> </span>counting<span class=\"w\"> </span>from<span class=\"w\"> </span><span class=\"m\">0</span>\n\nDevice<span class=\"w\"> </span>Boot<span class=\"w\"> </span>Start<span class=\"w\"> </span>End<span class=\"w\"> </span><span class=\"c1\">#cyls #blocks Id System</span>\n/dev/sda1<span class=\"w\"> </span><span class=\"m\">0</span>+<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">81</span>-<span class=\"w\"> </span><span class=\"m\">19733</span>+<span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n/dev/sda2<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>\u2013<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>Empty\n/dev/sda3<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>\u2013<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>Empty\n/dev/sda4<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>\u2013<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>Empty\nInput<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>the<span class=\"w\"> </span>following<span class=\"w\"> </span>format<span class=\"p\">;</span><span class=\"w\"> </span>absent<span class=\"w\"> </span>fields<span class=\"w\"> </span>get<span class=\"w\"> </span>a<span class=\"w\"> </span>default<span class=\"w\"> </span>value.\n\nUsually<span class=\"w\"> </span>you<span class=\"w\"> </span>only<span class=\"w\"> </span>need<span class=\"w\"> </span>to<span class=\"w\"> </span>specify<span class=\"w\"> </span>and<span class=\"w\"> </span><span class=\"o\">(</span>and<span class=\"w\"> </span>perhaps<span class=\"w\"> </span><span class=\"o\">)</span>.\n\n/dev/sda1<span class=\"w\"> </span>:\n</code></pre></div>\n<p>\u540e\u9762\u662f <code>Ctrl+C</code> \u9000\u51fa\u7684\u3002</p>\n<p>strace \u4e86\u4e00\u4e0b fdisk \u7a0b\u5e8f\uff0c\u6ca1\u6709\u627e\u5230\u539f\u56e0\u3002\u8fd9\u4e2a\u95ee\u9898\u4e5f\u6682\u65f6\u7559\u4e0b\u4e86\u3002</p>\n<h3 id=\"depmod\">depmod<a class=\"headerlink\" href=\"#depmod\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a modprobe \u5de5\u5177\u63d0\u4f9b\u4e00\u4e2a\u6b63\u786e\u7684\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\uff08modules.dep)\u3002 \u8fd9\u4e2a\u547d\u4ee4\u5bf9\u4e8e\u65b0\u52a0\u5165\u7684\u6a21\u5757\u80fd\u591f\u50cf\u5df2\u7ecf\u6709\u7684\u6a21\u5757\u90a3\u6837\u6dfb\u52a0\u548c\u5220\u9664\u8d77\u5230\u4e86\u5f88\u597d\u7684\u4f5c\u7528\u3002</p>\n<p>\u6211\u4eec\u77e5\u9053\u5728 Linux \u4e2d\uff0c\u5185\u6838\u6a21\u5757\u662f\u662f\u5728<code>/lib/modules/</code>\u4e0b\u9762\u7684\u3002\u4f7f\u7528 <code>insmod/modprobe</code> \u9ed8\u8ba4\u4e5f\u662f\u4ece\u8fd9\u4e2a\u76ee\u5f55\u53bb\u627e\u4f60\u8981\u52a0\u8f7d\u7684\u6a21\u5757\uff0c\u9664\u975e\u4f60\u7528 <code>-f</code> \u6765\u6307\u5b9a\u6a21\u5757\u7684\u8def\u5f84\u3002</p>\n<p>\u800c\u5bf9\u4e8e\u7f16\u8bd1\u7684\u5185\u6838\u6a21\u5757\uff0c\u5982\u679c\u5e0c\u671b modprobe \u7a0b\u5e8f\u80fd\u591f\u4ec5\u4ec5\u63d0\u4f9b\u6a21\u5757\u540d\u5c31\u53ef\u4ee5\u52a0\u8f7d\u7684\u8bdd\uff0c\u90a3\u4e48\u81f3\u5c11\u8981\u505a\u4e24\u4ef6\u4e8b\u60c5\u3002</p>\n<ol>\n<li>\u5c06\u65b0\u7684\u6a21\u5757\u590d\u5236\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u3002</li>\n<li>\u4f7f\u7528<code>depmod -A</code> \u6216\u8005<code>depmod -a</code>\u6765\u751f\u4ea7\u6a21\u5757\u4f9d\u8d56\u6027\u6bd4\u5217\u8868\u3002</li>\n</ol>\n<p>\u5176\u4e2d <code>\uff0da</code> \u662f\u8868\u793a\u6240\u6709\u6a21\u5757\u90fd\u626b\u63cf\u4e00\u6b21\uff0c\u7136\u540e\u751f\u6210\u5217\u8868\uff0c\u800c <code>\uff0dA</code> \u8868\u793a\u8fdb\u626b\u63cf\u65b0\u589e\u7684\u6216\u8005\u66f4\u65b0\u7684\u6a21\u5757\uff0c\u7136\u540e\u66f4\u65b0\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\u3002</p>\n<p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u662f\u6700\u5e38\u7528\u7684\u4e86\u3002\u6211\u76ee\u524d\u4e5f\u5c31\u4ec5\u4ec5\u7528\u8fc7\u8fd9\u4e24\u4e2a\u53c2\u6570\u3002</p>\n<p>\u521a\u624d\u770b\u4e86 man \u624b\u518c\uff0c\u8fd8\u6709\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982 <code>\uff0db</code> \u8868\u793a\u6a21\u5757\u7684\u57fa\u672c\u8def\u5f84\u5728\u54ea\u91cc\uff0c\u5229\u7528\u8fd9\u4e2a\u53c2\u6570\u4f60\u53ef\u4ee5\u5c06\u6a21\u5757\u4ece <code>/lib/modules/</code> \u4e2d\u8fc1\u79fb\u51fa\u6765\u3002\u800c <code>-n</code> \u53c2\u6570\u8868\u793a\u4ec5\u4ec5\u53ea\u662f\u6253\u5370\u51fa\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\uff0c\u800c\u4e0d\u5199\u5165\uff0c\u76f8\u5f53\u4e8e\u4ec5\u4ec5\u662f\u6f14\u793a\uff0c\u800c\u4e0d\u4f1a\u4ea7\u751f\u5b9e\u9645\u6548\u679c\u3002</p>\n<h3 id=\"dhclient\">dhclient<a class=\"headerlink\" href=\"#dhclient\" title=\"Permanent link\">&para;</a></h3>\n<p>dhclient\uff0c dhclient-script, dhcp6 \u8fd9\u662f DHCP \u534f\u8bae\u4e2d\u7528\u7684\uff0c\u4e00\u822c\u6211\u4eec\u90fd\u4e0d\u4f1a\u76f4\u63a5\u53bb\u6267\u884c\u8fd9\u51e0\u4e2a\u547d\u4ee4\uff0c\u800c\u662f\u914d\u7f6e\u4ed6\u7684\u914d\u7f6e\u6587\u4ef6\u548c\u8fd0\u884c <code>/etc/rc.d/init.d/dhcpd</code> \u547d\u4ee4\u3002\u6240\u4ee5\u8fd9\u91cc\u4e5f\u4e0d\u6df1\u5165\u7814\u7a76\u4e86\u3002</p>\n<h3 id=\"dmraid\">dmraid<a class=\"headerlink\" href=\"#dmraid\" title=\"Permanent link\">&para;</a></h3>\n<p>device-Mapper \u8f6f RAID \u5de5\u5177\uff0c\u4ed6\u4e3b\u8981\u662f\u7528\u6765\u6267\u884c\u8bbe\u5907\u53d1\u73b0\uff0cRAID \u6fc0\u6d3b\u548c ATARAID \u5c5e\u6027\u663e\u793a\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u548c RAID \u5236\u4f5c\u5de5\u5177\u4e00\u8d77\u6765\u8bb2\u3002</p>\n<h3 id=\"dmsetup\">dmsetup<a class=\"headerlink\" href=\"#dmsetup\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5e95\u5c42\u903b\u8f91\u5377\u7ba1\u7406(LVM)\uff0c\u8fd9\u662f device-mapper \u5305\u4e2d\u5e26\u7684\u552f\u4e00\u4e00\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f\uff0c\u9664\u4e86\u90a3\u4e2a\u9759\u6001\u7248\u7684 <code>dmsetup.static</code>\u3002\u8fd9\u4e2a\u547d\u4ee4\u6211\u60f3\u7559\u5230\u548c <code>device-mapper-multipath</code> \u4e00\u8d77\u6765\u7814\u7a76\uff0c\u8fd9\u91cc\u5c31\u4e0d\u9610\u8ff0\u4e86\u3002</p>\n<h3 id=\"dosfsck\">dosfsck<a class=\"headerlink\" href=\"#dosfsck\" title=\"Permanent link\">&para;</a></h3>\n<p>\u68c0\u67e5\u548c\u4fee\u590d MSDOS \u6587\u4ef6\u7cfb\u7edf\uff0cLinux \u8fd8\u771f\u7684\u6709\u610f\u601d\uff0c\u5c45\u7136\u6765\u4e00\u4e2a\u8fd9\u6837\u7684\u5de5\u5177\uff0c\u4e0d\u8fc7\u6211\u4ece\u672a\u5728 Linux \u4e0b\u4fee\u590d\u8fc7 MS \u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u603b\u662f\u611f\u89c9\u6709\u70b9\u7384\u3002</p>\n<p>\u800c\u4e14\u6211\u89c9\u5f97\u4e5f\u6ca1\u6709\u673a\u4f1a\u3002\u670d\u52a1\u5668\u4e0a\u5427\uff0cMS \u7684\u6587\u4ef6\u7cfb\u7edf\u548c Linux \u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u4e0d\u4f1a\u5b58\u5728\u4e00\u4e2a\u786c\u76d8\u4e0a\u7684\uff0c\u670d\u52a1\u5668\u4e0a\u9700\u8981\u53cc\u7cfb\u7edf\u5417\uff1f\u81ea\u5df1\u7684\u673a\u5668\u4e0a\uff0c\u5982\u679c\u6709 MS \u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u90a3\u4e48\u5c31\u5e94\u8be5\u6709\u5176\u64cd\u4f5c\u7cfb\u7edf\uff0c\u90a3\u4e48\u81ea\u5df1\u7684\u5de5\u5177\u4fee\u590d\u81ea\u5df1\u7684\u4e1c\u897f\u5c31\u597d\u4e86\u3002\u5f53\u7136\u4e5f\u4e0d\u6392\u9664\u8fd9\u79cd\u53ef\u80fd\u6027\uff1a\u4ee5\u524d\u662f\u6709\u53cc\u7cfb\u7edf\uff0c\u800c\u4e00\u4e9b\u6570\u636e\u662f\u653e\u5728 MS \u7684\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\uff0c\u540e\u6765\u89c9\u5f97 MS \u7684\u7cfb\u7edf\u4e0d\u723d\uff0c\u4e8e\u662f\u5494\u5693\u6389\u4e86\u3002</p>\n<p>\u4f46\u662f\u56e0\u4e3a\u6570\u636e\u592a\u591a\uff0c\u5176\u4ed6\u5206\u533a\u4e5f\u5c31\u4e0d\u61c2\u4e86\uff0c\u4e8e\u662f\u5c31\u51fa\u73b0\u4e86\u6ca1\u6709 MS \u7684\u7cfb\u7edf\uff0c\u4f46\u662f\u6709 MS \u7684\u5206\u533a\u3002\u8fd9\u4e2a\u65f6\u5019\u662f\u4e0d\u662f dosfsck \u80fd\u6d3e\u4e0a\u7528\u573a\u5462\uff1f</p>\n<h3 id=\"dump\">dump<a class=\"headerlink\" href=\"#dump\" title=\"Permanent link\">&para;</a></h3>\n<p>ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u5907\u4efd\u3002dump \u7a0b\u5e8f\u68c0\u67e5 ext&#8532; \u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\uff0c\u7136\u540e\u731c\u6d4b\u90a3\u4e9b\u6587\u4ef6\u9700\u8981\u5907\u4efd\u3002\u8fd9\u4e9b\u6587\u4ef6\u88ab\u590d\u5236\u5230\u6307\u5b9a\u7684\u78c1\u76d8\uff0c\u78c1\u5e26\u6216\u8005\u5176\u4ed6\u5b58\u50a8\u4ecb\u8d28\u4e0a\u3002\u4ed6\u8fd8\u53ef\u4ee5\u4f5c\u8fdc\u7a0b\u7684\u5907\u4efd\u3002</p>\n<p>\u5982\u679c dump \u51fa\u6765\u7684\u6570\u636e\u5927\u4e8e\u6307\u5b9a\u7684\u5907\u4efd\u5b58\u50a8\u4ecb\u8d28\uff0c\u4ed6\u5c06\u5206\u5377\u3002dump \u652f\u6301\u7684\u53c2\u6570\u6bd4\u8f83\u591a\u3002</p>\n<ul>\n<li><code>-level#</code> dump \u7ea7\u522b\uff0c0 \u662f\u5168\u5907\u4efd\uff0c0 \u4ee5\u4e0a\u7684\u6570\u5b57\u662f\u589e\u91cf\u5907\u4efd\u3002\u5386\u53f2\u539f\u56e0\uff0cdump \u7a0b\u5e8f\u4e00\u822c\u53ea\u4f7f\u7528 0-9 \u8fd9\u51e0\u4e2a\u6570\u5b57\uff0c\u4e0d\u8fc7\u73b0\u5728\u7684 dump \u7248\u672c\u652f\u6301 9 \u4ee5\u4e0a\u7684\u6570\u5b57\uff08\u4f46\u662f\uff0c\u4e0d\u540c\u7684\u6570\u5b57\u610f\u5473\u7740\u4ec0\u4e48\uff0cman \u624b\u518c\u4e2d\u5e76\u6ca1\u6709\u8bf4\uff09</li>\n<li><code>-a</code> \u201c\u81ea\u52a8\u5927\u5c0f(auto-size)\u201d. \u5ffd\u7565\u6240\u6709\u78c1\u5e26\u7684\u957f\u5ea6\u8ba1\u7b97\u3002\u4ed6\u5c06\u4e00\u76f4\u5199\u5230\u78c1\u5e26\u7ed3\u675f\uff0c\u5bf9\u4e8e\u5927\u90e8\u5206\u73b0\u5728\u7684\u78c1\u5e26\u673a\uff0c\u8fd9\u4e2d\u5de5\u4f5c\u65b9\u5f0f\u662f\u6700\u4f73\u7684\uff0c\u4e5f\u662f\u7f3a\u7701\u6a21\u5f0f\u3002\u8fd9\u79cd\u65b9\u5f0f\u7279\u522b\u662f\u5728\u589e\u52a0\u6570\u636e\u5230\u4e00\u4e2a\u78c1\u5e26\u4e0a\u6216\u8005\u5177\u6709\u786c\u4ef6\u538b\u7f29\u529f\u80fd\u7684\u78c1\u5e26\u673a\u6548\u679c\u66f4\u597d\u3002</li>\n<li><code>-A</code> \u5f52\u6863\u6587\u4ef6\uff0c\u5728\u6307\u5b9a\u7684\u5f52\u6863\u6587\u4ef6\u4e0a\u521b\u5efa\u4e00\u4e2a dump \u5185\u5bb9\u8868(table-of-contents)\uff0c\u5c06\u6765\u53ef\u4ee5\u88ab restore(8)\u7a0b\u5e8f\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u6b63\u51c6\u5907\u56de\u590d\u7684\u6587\u4ef6\u662f\u5426\u5728 dump \u6587\u4ef6\u4e2d.</li>\n<li><code>-b</code> \u5757\u5927\u5c0f.\u6bcf\u4e2a dump \u8bb0\u5f55\u7684 KB \u6570.\u7f3a\u7701\u662f 10.\u6700\u5927\u503c\u662f 1024,\u4e0d\u8fc7\u4e0e\u4f60\u7684\u5185\u6838\u9650\u5236\u6709\u5173\u7cfb.</li>\n<li><code>-B</code> \u8bb0\u5f55\u6570,\u6bcf\u5377\u7684\u5feb\u6570(\u6bcf\u5757 1KB).\u5f53 dump \u7a0b\u5e8f\u53d1\u73b0\u5230\u4e86\u5b58\u50a8\u4ecb\u8d28\u7684\u7ed3\u5c3e\u65f6,\u4ed6\u4f1a\u8981\u6c42\u4f60\u66f4\u6362\u5377.</li>\n<li><code>-D</code> \u6587\u4ef6.\u8bbe\u7f6e\u5b58\u50a8\u4e4b\u524d\u5148\u524d\u5b8c\u5168\u6216\u8005\u589e\u91cf dump \u4fe1\u606f\u7684\u6587\u4ef6\u8def\u5f84.</li>\n<li><code>-e</code> inode \u5217\u8868,\u4e0d\u51c6\u5907 dump \u7684 inode \u5217\u8868,\u591a\u4e2a inode \u4e4b\u95f4\u7528\u9017\u53f7\u5206\u9694,\u4f60\u53ef\u4ee5\u4f7f\u7528 stat(1)\u547d\u4ee4\u6765\u627e\u5230\u6587\u4ef6\u6216\u8005\u76ee\u5f55\u7684 inode \u503c.</li>\n<li><code>-E</code> \u6587\u4ef6,\u4ece\u6587\u4ef6\u4e2d\u6392\u9664\u4e0d dump \u7684 inode,\u6587\u4ef6\u683c\u5f0f\u91c7\u7528\u4e00\u884c\u4e00\u4e2a inode,\u800c\u4e14\u5e94\u8be5\u662f\u6392\u5e8f\u7684.</li>\n<li><code>-f</code> \u6587\u4ef6.\u5199\u5907\u4efd\u5230\u6587\u4ef6;\u8fd9\u53ef\u4ee5\u662f\u7279\u5b9a\u7684\u8bbe\u5907\u6587\u4ef6,\u6bd4\u5982/dev/st0,/dev/fd0,/dev/sdc,\u6216\u8005\u662f\u4e00\u4e2a\u666e\u901a\u6587\u4ef6,\u6216\u8005\u662f\u6807\u51c6\u8f93\u51fa(<code>-</code>)\uff0c \u591a\u4e2a\u6587\u4ef6\u91c7\u7528\u9017\u53f7\u5206\u9694.\u6bcf\u4e00\u4e2a\u6587\u4ef6\u5c06\u5b58\u50a8\u4e00\u4e2a dump \u5377.\u5982\u679c\u6587\u4ef6\u547d\u91c7\u7528 host:file \u6216\u8005 user@host:file \u683c\u5f0f,dump \u5c06\u4f7f\u7528 rmt(8)\u7a0b\u5e8f\u5c06\u6570\u636e\u5199\u5165\u5230\u8fdc\u7a0b\u673a\u5668\u6307\u5b9a\u7684\u6587\u4ef6\u4e0a(\u6539\u6587\u4ef6\u5e94\u8be5\u5b58\u5728,dump \u4e0d\u4f1a\u4f7f\u7528\u521b\u5efa\u4e00\u4e2a\u8fdc\u7a0b- `\u6587\u4ef6).</li>\n<li><code>-F</code> \u811a\u672c,\u5728\u6bcf\u4e00\u4e2a\u78c1\u5e26\u7684\u6700\u540e\u6267\u884c\u8fd9\u4e2a\u811a\u672c(\u9664\u4e86\u6700\u540e\u4e00\u76d8\u78c1\u5e26)</li>\n<li><code>-L</code> \u6807\u7b7e,\u4f7f\u7528\u7528\u6237\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a\u6807\u7b7e\u5199\u5165\u5230 dump \u90fd,\u8fd9\u6837\u4e00\u6765,\u50cf restore(8)\u548c file(8)\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5b83.\u6807\u7b7e\u7684\u6700\u5927\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7 LBLSIZE(\u5f53\u524d\u662f 16)\u4e2a\u5b57\u7b26,\u800c\u4e14\u5b57\u7b26\u4e32\u5fc5\u987b\u662f <code>\\0</code> \u7ed3\u5c3e.</li>\n<li><code>-S</code> \u5927\u5c0f\u8bc4\u4f30\u3002\u7528\u6765\u8ba1\u7b97 dump \u9700\u8981\u7684\u7a7a\u95f4\uff0c\u4f46\u662f\u5e76\u4e0d\u771f\u6b63\u6267\u884c dump \u64cd\u4f5c\u3002\u8fd9\u5bf9\u589e\u91cf\u5907\u4efd\u6709\u597d\u5904\uff0c\u56e0\u4e3a\u53ef\u4ee5\u77e5\u9053\u9700\u8981\u591a\u5c11\u5b58\u50a8\u4ecb\u8d28\u3002</li>\n<li><code>-T</code> \u65f6\u95f4\u3002\u4f7f\u7528\u6307\u5b9a\u7684\u65f6\u95f4\u6765\u4f5c\u4e3a dump \u7684\u65f6\u95f4\uff0c\u800c\u4e0d\u662f\u4ece <code>/etc/dumpdates</code> \u91cc\u8bfb\u53d6\u3002\u8fd9\u91cc\u65f6\u95f4\u7684\u683c\u5f0f\u548c ctime(3) \u7684\u683c\u5f0f\u76f8\u540c\uff0c\u9075\u5b88 RFC822 \u65f6\u533a\u89c4\u8303\u3002\u4ed6\u4e0e <code>-u</code> \u53c2\u6570\u662f\u4e92\u65a5\u7684\u3002</li>\n<li><code>-u</code> \u6210\u529f dump \u540e\uff0c\u66f4\u65b0 <code>/etc/dumpdates</code> \u6587\u4ef6\u3002/etc/dumpdates \u6587\u4ef6\u683c\u5f0f\u662f\u4eba\u53ef\u4ee5\u9605\u8bfb\u7684\uff0c\u6bcf\u884c\u8bb0\u5f55\u4e00\u4e2a\u65f6\u95f4\uff0c\u91c7\u53d6\u4e86\u53eb\u5bbd\u677e\u7684\u683c\u5f0f\u3002</li>\n<li><code>-y</code> \u5199\u5165\u78c1\u5e26\u65f6\u538b\u7f29\u5757\uff0c\u91c7\u7528 lzo \u94fe\u63a5\u5e93\u3002</li>\n<li><code>-z</code> \u538b\u7f29\u7ea7\u522b\uff0c\u91c7\u7528 zlib \u5e93\uff0c\u8fd9\u4e2a\u53c2\u6570\u4ec5\u5728\u5c06\u6570\u636e dump \u5230\u6587\u4ef6\uff0c\u7ba1\u9053\u6216\u8005\u78c1\u5e26\u673a\u65f6\u624d\u6709\u7528\uff0c\u7f3a\u7701\u503c\u662f 2.\u6ce8\u610f\u6307\u5b9a\u8fd9\u4e2a\u503c\u7684\u65f6\u5019\uff0c\u53c2\u6570\u548c\u503c\u4e4b\u95f4\u5e94\u8be5\u6ca1\u6709\u53c2\u6570</li>\n</ul>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u538b\u7f29\u5230\u6587\u4ef6\u7684\u7b80\u5355\u4f8b\u5b50</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># dump -0 -f /tmp/rootdump /root</span>\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>level<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>dump:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:46<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Dumping<span class=\"w\"> </span>/dev/hda5<span class=\"w\"> </span><span class=\"o\">(</span>/<span class=\"w\"> </span><span class=\"o\">(</span>dir<span class=\"w\"> </span>root<span class=\"o\">))</span><span class=\"w\"> </span>to<span class=\"w\"> </span>/tmp/rootdump\nDUMP:<span class=\"w\"> </span>Label:<span class=\"w\"> </span>/\nDUMP:<span class=\"w\"> </span>Writing<span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span>Kilobyte<span class=\"w\"> </span>records\nDUMP:<span class=\"w\"> </span>mapping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>I<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>regular<span class=\"w\"> </span>files<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>mapping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>II<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>directories<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>estimated<span class=\"w\"> </span><span class=\"m\">15509</span><span class=\"w\"> </span>blocks.\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>started<span class=\"w\"> </span>with<span class=\"w\"> </span>block<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>at:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:48<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>dumping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>III<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>directories<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#2 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#187672 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#204060 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#674281 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>dumping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>IV<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>regular<span class=\"w\"> </span>files<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505922 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505923 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505924 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505925 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505926 won&#39;t be dumped</span>\nDUMP:<span class=\"w\"> </span>ACLs<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>inode<span class=\"w\"> </span><span class=\"c1\">#505927 won&#39;t be dumped</span>\n...\nDUMP:<span class=\"w\"> </span>Closing<span class=\"w\"> </span>/tmp/rootdump\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>completed<span class=\"w\"> </span>at:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:59<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">15340</span><span class=\"w\"> </span>blocks<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">14</span>.98MB<span class=\"o\">)</span>\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>took<span class=\"w\"> </span><span class=\"m\">0</span>:00:11\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>transfer<span class=\"w\"> </span>rate:<span class=\"w\"> </span><span class=\"m\">1394</span><span class=\"w\"> </span>kB/s\nDUMP:<span class=\"w\"> </span><span class=\"m\">15340</span><span class=\"w\"> </span>blocks<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">14</span>.98MB<span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>volume<span class=\"o\">(</span>s<span class=\"o\">)</span>\nDUMP:<span class=\"w\"> </span>finished<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\"> </span>seconds,<span class=\"w\"> </span>throughput<span class=\"w\"> </span><span class=\"m\">1394</span><span class=\"w\"> </span>kBytes/sec\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>level<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>dump:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:46<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>this<span class=\"w\"> </span>dump<span class=\"w\"> </span>completed:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:59<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Average<span class=\"w\"> </span>transfer<span class=\"w\"> </span>rate:<span class=\"w\"> </span><span class=\"m\">1394</span><span class=\"w\"> </span>kB/s\nDUMP:<span class=\"w\"> </span>DUMP<span class=\"w\"> </span>IS<span class=\"w\"> </span>DONE\n</code></pre></div>\n<p>\u6211\u4eec\u6765\u770b\u770b dump \u51fa\u6765\u7684\u6587\u4ef6\u662f\u6709\u4ec0\u4e48\u7279\u5f81</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># file /tmp/rootdump</span>\n/tmp/rootdump:<span class=\"w\"> </span>new-fs<span class=\"w\"> </span>dump<span class=\"w\"> </span>file<span class=\"w\"> </span><span class=\"o\">(</span>little<span class=\"w\"> </span>endian<span class=\"o\">)</span>,<span class=\"w\"> </span>This<span class=\"w\"> </span>dump<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">22</span>:06:46<span class=\"w\"> </span><span class=\"m\">2007</span>,<span class=\"w\"> </span>Previous<span class=\"w\"> </span>dump<span class=\"w\"> </span>Thu<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">08</span>:00:00<span class=\"w\"> </span><span class=\"m\">1970</span>,<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span>Level<span class=\"w\"> </span>zero,<span class=\"w\"> </span>type:<span class=\"w\"> </span>tape<span class=\"w\"> </span>header,<span class=\"w\"> </span>Label<span class=\"w\"> </span>/,<span class=\"w\"> </span>Filesystem<span class=\"w\"> </span>/<span class=\"w\"> </span><span class=\"o\">(</span>dir<span class=\"w\"> </span>root<span class=\"o\">)</span>,<span class=\"w\"> </span>Device<span class=\"w\"> </span>/dev/hda5,<span class=\"w\"> </span>Host<span class=\"w\"> </span>lancy,<span class=\"w\"> </span>Flags<span class=\"w\"> </span><span class=\"m\">3</span>\n\n<span class=\"c1\"># du -sh /tmp/rootdump</span>\n15M<span class=\"w\"> </span>/tmp/rootdump\n\n<span class=\"c1\"># du -sh /root</span>\n15M<span class=\"w\"> </span>/root\n</code></pre></div>\n<p>\u5728\u4e0d\u6307\u5b9a <code>-z</code> \u53c2\u6570\u65f6\uff0cdump \u662f\u6ca1\u6709\u538b\u7f29\u6548\u679c\u7684\u3002</p>\n<p>\u518d\u770b\u770b\u538b\u7f29\u6548\u679c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># dump -0 -z9 -f /tmp/rootdump.z9 /root</span>\n......\n<span class=\"c1\">#ls -h /tmp/rootdump.z9</span>\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">7</span>.4M\nJan<span class=\"w\"> </span><span class=\"m\">30</span><span class=\"w\"> </span><span class=\"m\">20</span>:56<span class=\"w\"> </span>/tmp/rootdump.z9\n</code></pre></div>\n<p>\u770b\u4e0a\u53bb\u6548\u679c\u8fd8\u4e0d\u9519</p>\n<h3 id=\"dump_cis\">dump_cis<a class=\"headerlink\" href=\"#dump_cis\" title=\"Permanent link\">&para;</a></h3>\n<p>\u663e\u793a PCMCIA \u8bbe\u522b\u7684\u4fe1\u606f\u3002\u56e0\u4e3a\u6211\u7684\u65e0\u7ebf\u4e0a\u7f51\u5361\u4e0d\u8fd9\u6b21\uff0c\u56e0\u6b64\u4ed6\u4ec5\u4ec5\u7ed9\u51fa\u4e86\u4e0b\u9762\u7684\u4fe1\u606f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># dump_cis no pcmcia driver in /proc/devices</span>\n</code></pre></div>\n<h3 id=\"dumpe2fs\">dumpe2fs<a class=\"headerlink\" href=\"#dumpe2fs\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bfc\u51fa ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u4fe1\u606f\uff0c\u663e\u7136\u8fd9\u4e5f\u662f\u4e00\u4e2a\u91cd\u91cf\u7ea7\u7684\u5de5\u5177\uff0c\u5728\u6587\u4ef6\u7cfb\u7edf\u51fa\u73b0\u635f\u574f\u7684\u60c5\u51b5\u4e0b\u7528\u5f97\u7740\u3002</p>\n<p>\u4ed6\u6253\u5370\u51fa\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757\u548c\u5757\u7ec4\u4fe1\u606f\u3002\u6211\u4eec\u5148\u770b\u4e00\u4e2a\u5177\u4f53\u7684\u4f8b\u5b50\uff0c\u4e0b\u9762\u662f\u5bf9\u6211\u521a\u521b\u5efa\u4e2a\u4e00\u4e2a\u5206\u533a\u7684 dump \u4fe1\u606f\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># dumpe2fs /dev/sda1</span>\ndumpe2fs<span class=\"w\"> </span><span class=\"m\">1</span>.35<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">28</span>-Feb-2004<span class=\"o\">)</span>\nFilesystem<span class=\"w\"> </span>volume<span class=\"w\"> </span>name:\nLast<span class=\"w\"> </span>mounted<span class=\"w\"> </span>on:\nFilesystem<span class=\"w\"> </span>UUID:<span class=\"w\"> </span>f74b41c6-637f-436f-ab9c-e1cbd532abf8\nFilesystem<span class=\"w\"> </span>magic<span class=\"w\"> </span>number:<span class=\"w\"> </span>0xEF53\nFilesystem<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"c1\">#: 1 (dynamic)</span>\nFilesystem<span class=\"w\"> </span>features:<span class=\"w\"> </span>has_journal<span class=\"w\"> </span>resize_inode<span class=\"w\"> </span>filetype<span class=\"w\"> </span>sparse_super\nDefault<span class=\"w\"> </span>mount<span class=\"w\"> </span>options:<span class=\"w\"> </span><span class=\"o\">(</span>none<span class=\"o\">)</span>\nFilesystem<span class=\"w\"> </span>state:<span class=\"w\"> </span>clean\nErrors<span class=\"w\"> </span>behavior:<span class=\"w\"> </span>Continue\nFilesystem<span class=\"w\"> </span>OS<span class=\"w\"> </span>type:<span class=\"w\"> </span>Linux\nInode<span class=\"w\"> </span>count:<span class=\"w\"> </span><span class=\"m\">4944</span>\nBlock<span class=\"w\"> </span>count:<span class=\"w\"> </span><span class=\"m\">19732</span>\nReserved<span class=\"w\"> </span>block<span class=\"w\"> </span>count:<span class=\"w\"> </span><span class=\"m\">986</span>\nFree<span class=\"w\"> </span>blocks:<span class=\"w\"> </span><span class=\"m\">17905</span>\nFree<span class=\"w\"> </span>inodes:<span class=\"w\"> </span><span class=\"m\">4933</span>\nFirst<span class=\"w\"> </span>block:<span class=\"w\"> </span><span class=\"m\">1</span>\nBlock<span class=\"w\"> </span>size:<span class=\"w\"> </span><span class=\"m\">1024</span>\nFragment<span class=\"w\"> </span>size:<span class=\"w\"> </span><span class=\"m\">1024</span>\nReserved<span class=\"w\"> </span>GDT<span class=\"w\"> </span>blocks:<span class=\"w\"> </span><span class=\"m\">77</span>\nBlocks<span class=\"w\"> </span>per<span class=\"w\"> </span>group:<span class=\"w\"> </span><span class=\"m\">8192</span>\nFragments<span class=\"w\"> </span>per<span class=\"w\"> </span>group:<span class=\"w\"> </span><span class=\"m\">8192</span>\nInodes<span class=\"w\"> </span>per<span class=\"w\"> </span>group:<span class=\"w\"> </span><span class=\"m\">1648</span>\nInode<span class=\"w\"> </span>blocks<span class=\"w\"> </span>per<span class=\"w\"> </span>group:<span class=\"w\"> </span><span class=\"m\">206</span>\nFilesystem<span class=\"w\"> </span>created:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">21</span>:43:19<span class=\"w\"> </span><span class=\"m\">2007</span>\nLast<span class=\"w\"> </span>mount<span class=\"w\"> </span>time:<span class=\"w\"> </span>n/a\nLast<span class=\"w\"> </span>write<span class=\"w\"> </span>time:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">21</span>:43:19<span class=\"w\"> </span><span class=\"m\">2007</span>\nMount<span class=\"w\"> </span>count:<span class=\"w\"> </span><span class=\"m\">0</span>\nMaximum<span class=\"w\"> </span>mount<span class=\"w\"> </span>count:<span class=\"w\"> </span><span class=\"m\">26</span>\nLast<span class=\"w\"> </span>checked:<span class=\"w\"> </span>Sun<span class=\"w\"> </span>Jan<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">21</span>:43:19<span class=\"w\"> </span><span class=\"m\">2007</span>\nCheck<span class=\"w\"> </span>interval:<span class=\"w\"> </span><span class=\"m\">15552000</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">6</span><span class=\"w\"> </span>months<span class=\"o\">)</span>\nNext<span class=\"w\"> </span>check<span class=\"w\"> </span>after:<span class=\"w\"> </span>Fri<span class=\"w\"> </span>Jul<span class=\"w\"> </span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"m\">21</span>:43:19<span class=\"w\"> </span><span class=\"m\">2007</span>\nReserved<span class=\"w\"> </span>blocks<span class=\"w\"> </span>uid:<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>user<span class=\"w\"> </span>root<span class=\"o\">)</span>\nReserved<span class=\"w\"> </span>blocks<span class=\"w\"> </span>gid:<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>group<span class=\"w\"> </span>root<span class=\"o\">)</span>\nFirst<span class=\"w\"> </span>inode:<span class=\"w\"> </span><span class=\"m\">11</span>\nInode<span class=\"w\"> </span>size:<span class=\"w\"> </span><span class=\"m\">128</span>\nJournal<span class=\"w\"> </span>inode:<span class=\"w\"> </span><span class=\"m\">8</span>\nDefault<span class=\"w\"> </span>directory<span class=\"w\"> </span>hash:<span class=\"w\"> </span>tea\nDirectory<span class=\"w\"> </span>Hash<span class=\"w\"> </span>Seed:<span class=\"w\"> </span>d1aef805-54e4-4d41-90f7-e509a85a7028\nJournal<span class=\"w\"> </span>backup:<span class=\"w\"> </span>inode<span class=\"w\"> </span>blocks\n\nGroup<span class=\"w\"> </span><span class=\"m\">0</span>:<span class=\"w\"> </span><span class=\"o\">(</span>Blocks<span class=\"w\"> </span><span class=\"m\">1</span>-8192<span class=\"o\">)</span>\nPrimary<span class=\"w\"> </span>superblock<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span>Group<span class=\"w\"> </span>descriptors<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">2</span>-2\nBlock<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"o\">(</span>+79<span class=\"o\">)</span>,<span class=\"w\"> </span>Inode<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span><span class=\"o\">(</span>+80<span class=\"o\">)</span>\nInode<span class=\"w\"> </span>table<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">82</span>-287<span class=\"w\"> </span><span class=\"o\">(</span>+81<span class=\"o\">)</span>\n<span class=\"m\">6861</span><span class=\"w\"> </span>free<span class=\"w\"> </span>blocks,<span class=\"w\"> </span><span class=\"m\">1637</span><span class=\"w\"> </span>free<span class=\"w\"> </span>inodes,<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>directories\nFree<span class=\"w\"> </span>blocks:<span class=\"w\"> </span><span class=\"m\">1332</span>-8192\nFree<span class=\"w\"> </span>inodes:<span class=\"w\"> </span><span class=\"m\">12</span>-1648\nGroup<span class=\"w\"> </span><span class=\"m\">1</span>:<span class=\"w\"> </span><span class=\"o\">(</span>Blocks<span class=\"w\"> </span><span class=\"m\">8193</span>-16384<span class=\"o\">)</span>\nBackup<span class=\"w\"> </span>superblock<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">8193</span>,<span class=\"w\"> </span>Group<span class=\"w\"> </span>descriptors<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">8194</span>-8194\nBlock<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">8272</span><span class=\"w\"> </span><span class=\"o\">(</span>+79<span class=\"o\">)</span>,<span class=\"w\"> </span>Inode<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">8273</span><span class=\"w\"> </span><span class=\"o\">(</span>+80<span class=\"o\">)</span>\nInode<span class=\"w\"> </span>table<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">8274</span>-8479<span class=\"w\"> </span><span class=\"o\">(</span>+81<span class=\"o\">)</span>\n<span class=\"m\">7905</span><span class=\"w\"> </span>free<span class=\"w\"> </span>blocks,<span class=\"w\"> </span><span class=\"m\">1648</span><span class=\"w\"> </span>free<span class=\"w\"> </span>inodes,<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>directories\nFree<span class=\"w\"> </span>blocks:<span class=\"w\"> </span><span class=\"m\">8480</span>-16384\nFree<span class=\"w\"> </span>inodes:<span class=\"w\"> </span><span class=\"m\">1649</span>-3296\nGroup<span class=\"w\"> </span><span class=\"m\">2</span>:<span class=\"w\"> </span><span class=\"o\">(</span>Blocks<span class=\"w\"> </span><span class=\"m\">16385</span>-19731<span class=\"o\">)</span>\nBlock<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">16385</span><span class=\"w\"> </span><span class=\"o\">(</span>+0<span class=\"o\">)</span>,<span class=\"w\"> </span>Inode<span class=\"w\"> </span>bitmap<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">16386</span><span class=\"w\"> </span><span class=\"o\">(</span>+1<span class=\"o\">)</span>\nInode<span class=\"w\"> </span>table<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">16387</span>-16592<span class=\"w\"> </span><span class=\"o\">(</span>+2<span class=\"o\">)</span>\n<span class=\"m\">3139</span><span class=\"w\"> </span>free<span class=\"w\"> </span>blocks,<span class=\"w\"> </span><span class=\"m\">1648</span><span class=\"w\"> </span>free<span class=\"w\"> </span>inodes,<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>directories\nFree<span class=\"w\"> </span>blocks:<span class=\"w\"> </span><span class=\"m\">16593</span>-19731\nFree<span class=\"w\"> </span>inodes:<span class=\"w\"> </span><span class=\"m\">3297</span>-4944\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a dump \u4fe1\u606f\u6211\u4eec\u80fd\u591f\u5f97\u5230\u51e0\u4e2a\u5f88\u91cd\u8981\u7684\u4fe1\u606f\uff0c\u65e0\u8bba\u5bf9\u4e8e\u4f60\u5c06\u6765\u7684\u6b63\u5728\u5907\u4efd\uff0c\u6062\u590d\u8fd8\u662f\u6587\u4ef6\u7cfb\u7edf\u4fee\u590d\u90fd\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>Free blocks: 17905 //\u80fd\u591f\u5b58\u50a8\u6570\u636e\u7684\u5757\u5927\u5c0f\nFree inodes: 4933 //\u80fd\u591f\u4f7f\u7528\u7684 i \u8282\u70b9 Block\nsize: 1024 //\u5757\u5927\u5c0f\nPrimary superblock at 1\uff0cBackup superblock at 8193 //\u4e3b\u8d85\u7ea7\u5757\u4ee5\u53ca\u5907\u4efd\u8d85\u7ea7\u5757\u7684\u4f4d\u7f6e\n</code></pre></div>\n<p>free blocks \u548c block size \u51b3\u5b9a\u4e86\u5b58\u50a8\u6570\u636e\u7684\u7a7a\u95f4\u5927\u5c0f\uff0c\u540c\u65f6 block size \u5728\u67d0\u4e9b\u5907\u4efd\u8f6f\u4ef6\u4e2d\u662f\u9700\u8981\u6307\u5b9a\u7684\u3002\n\u800c free inode \u8868\u8bf4\u660e\u80fd\u591f\u521b\u5efa\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u603b\u548c\u3002</p>\n<p>\u56e0\u4e3a\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u9700\u8981\u5360\u7528\u4e00\u4e2a inode \u8282\u70b9\u3002\u56e0\u6b64\u5373\u4f7f\u4f60\u7684\u7a7a\u95f4\u8fd8\u8db3\u591f\uff0c\u4f46\u662f\u4f60\u4f1a\u53d1\u73b0\u4f60\u65e0\u6cd5\u521b\u5efa\u6587\u4ef6\u6216\u8005\u76ee\u5f55\uff0c\u800c\u63d0\u793a\u5374\u662f\u7a7a\u95f4\u4e0d\u591f\uff0c\n\u8fd9\u4e2a\u65f6\u5019\u4f60\u53ef\u4ee5\u7528 dumpe2fs \u6765\u770b\u770b\u4f60\u8fd8\u6709\u591a\u5c11 free inode\u3002\u5f53\u7136\u4ec5\u4ec5\u4e3a\u4e86\u67e5\u770b inode \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u4e0d\u4ec5\u4ec5\u53ea\u6709 dumpe2fs \u80fd\u591f\n\u505a\u5f97\u5230\u3002</p>\n<p><code>df -i</code> \u547d\u4ee4\u4e5f\u53ef\u4ee5\u67e5\u770b\u5230 inode \u8282\u70b9\u7684\u4f7f\u7528\u4fe1\u606f\u3002</p>\n<p>\u800c\u9002\u5f53\u7684\u6539\u53d8 block size \u53ef\u4ee5\u5728\u540c\u6837\u7a7a\u95f4\u91cc\u83b7\u5f97\u66f4\u591a\u7684 inode\uff0c\u8fd9\u4e2a\u6211\u4eec\u5728\u8bf4 mkfs \u7684\u65f6\u5019\u518d\u8ba8\u8bba\u3002</p>\n<p>superblock \u65e0\u7591\u662f\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u6838\u5fc3\uff0c\u7c7b\u4f3c\u901a\u5f80\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8\u7a7a\u95f4\u7684\u94a5\u5319\uff0c\u6ca1\u6709\u4e86\u94a5\u5319\uff0c\u4f60\u65e2\u65e0\u6cd5\u7ee7\u7eed\u5b58\u50a8\u6570\u636e\uff0c\u4e5f\u65e0\u6cd5\u53d6\u51fa\u539f\u6765\u7684\u6570\u636e\u3002</p>\n<p>\u6b63\u662f\u56e0\u4e3a\u4ed6\u662f\u5982\u6b64\u7684\u91cd\u8981\uff0c\u6240\u4ee5\u6587\u4ef6\u7cfb\u7edf\u5728\u4e00\u521b\u5efa\u7684\u5c31\u505a\u4e86\u82e5\u5e72\u5907\u4efd\u3002\u800c\u4e14\u7a7a\u95f4\u8d8a\u5927\uff0c\u5907\u4efd\u7684\u6570\u76ee\u8d8a\u591a\uff0c\u4ee5\u6211\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u5927\u5c0f\u662f<code>5.3G</code>.</p>\n<p>\u5176\u4e2d\u8d85\u7ea7\u5757\u4e00\u5171 8 \u4e2a\u3002\u4e00\u65e6\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757\u635f\u574f\uff0c\u6211\u4eec\u7acb\u523b\u53ef\u4ee5\u4f7f\u7528 <code>e2fsck -b xxxx</code> \u7684\u65b9\u5f0f\u542f\u7528\u5907\u7528\u7684\u8d85\u7ea7\u5757\u3002</p>\n<p>\u8fd9\u91cc\u7684 xxx \u5c31\u662f\u4f60\u7684\u5907\u4efd\u8d85\u7ea7\u5757\u7684\u4f4d\u7f6e\uff0c\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u7b2c\u4e00\u4e2a\u8d85\u7ea7\u5757\u5907\u4efd\u4f4d\u7f6e\u662f 8193\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u4f7f\u7528</p>\n<p><code>e2fsck -b 8193 /dev/sda1</code></p>\n<p>\u6765\u6062\u590d\u8d85\u7ea7\u5757\u3002</p>\n<p>\u9664\u4e86\u8fd9\u4e9b\u91cd\u8981\u4fe1\u606f\u5916\uff0c\u5bf9 dumpe2fs \u7684\u6df1\u5165\u5206\u6790\uff0c\u751a\u81f3\u53ef\u4ee5\u5c06\u4e00\u4e2a\u4e00\u7ecf\u65e0\u6cd5\u901a\u8fc7\u6062\u590d\u8d85\u7ea7\u5757\u6765\u8bbf\u95ee\u7684\u6587\u4ef6\u7cfb\u7edf\u7684\u6570\u636e\u5bfc\u51fa\u6765\u3002</p>\n<h2 id=\"sbin-e\">/sbin/ \u4e0b e \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-e\" title=\"Permanent link\">&para;</a></h2>\n<p>/sbin/ \u4e0b e \u5f00\u5934\u7684\u547d\u4ee4\u6bd4\u8f83\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>e2fsck ela_remove elvtune evlfacility evlogmgr evSubagent\ne2image ela_remove_all ether-wake evlgentmpls evlogrmtd\ne2label ela_show ethtool evlnotify evlsend\nela_add ela_show_all evlactiond evlnotifyd evltc\nela_get_atts ela_sig_send evlconfig evlogd evlview\n</code></pre></div>\n<h3 id=\"e2fsck\">e2fsck<a class=\"headerlink\" href=\"#e2fsck\" title=\"Permanent link\">&para;</a></h3>\n<p>\u68c0\u67e5\u548c\u4fee\u590d ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd9\u4f3c\u4e4e\u662f\u76ee\u524d Linux \u4e0b\u552f\u4e00\u4e00\u4e2a\u5bf9\u6587\u4ef6\u7cfb\u7edf\u505a\u4fee\u590d\u7684\u5de5\u5177\u3002</p>\n<p>\u4ed6\u540c\u65f6\u4e5f\u662f\u4e00\u4e2a\u53cc\u5203\u5251\u3002\u5728\u5b9e\u9645\u7684\u6587\u4ef6\u7cfb\u7edf\u4fee\u590d\u7ecf\u9a8c\u4e2d\uff0c\u6211\u9047\u5230\u4e86\u4e24\u96be\u7684\u95ee\u9898\u3002\u6839\u6587\u4ef6\u7cfb\u7edf\u635f\u574f\u4e86\uff0c\u9700\u8981\u4fee\u590d\uff0c\u7cfb\u7edf\u4f1a\u63d0\u793a\u4f60\u8981\u7528 e2fsck \u6765\u4fee\u590d\u3002\n\u5f53\u7136\u4f60\u53ef\u4ee5\u6309\u7167\u4ed6\u7684\u63d0\u793a\u53bb\u505a\uff0c\u4f46\u662f\u5f88\u53ef\u80fd\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u7b49\u4f60\u4fee\u590d\u5b8c\u4e86\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e5f\u80fd\u6b63\u5e38\u5de5\u4f5c\u4e86\uff0c\u4f46\u662f\u5f80\u5f80\u6700\u91cd\u8981\u7684\u6587\u4ef6\u88ab\u4fee\u590d\u5f97\u4e0d\u52a0\u4e86\u3002\n\u8fd9\u4e0d\u662f\u5f00\u73a9\u7b11\uff0c\u800c\u662f\u6709\u5927\u91cf\u7684\u6848\u4f8b\u3002\u5982\u679c\u5728\u4fee\u590d\u548c\u635f\u574f\u4e4b\u95f4\u53d6\u5f97\u4e00\u79cd\u5e73\u8861\u9700\u8981\u6839\u636e\u5177\u4f53\u7684\u60c5\u51b5\u6765\u5b9a\u593a\u3002</p>\n<p>e2fsck \u63a5\u53d7\u7684\u53c2\u6570\u6bd4\u8f83\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p>\n<ul>\n<li><code>-a</code>: \u4e0d\u8be2\u95ee\u4f7f\u7528\u8005\u610f\u89c1\uff0c\u4fbf\u81ea\u52a8\u4fee\u590d\u6587\u4ef6\u7cfb\u7edf</li>\n<li><code>-b</code>: \u6307\u5b9a superblock\uff0c\u800c\u4e0d\u4f7f\u7528\u9884\u8bbe\u7684 superblock</li>\n<li><code>-B</code>: \u6307\u5b9a\u533a\u5757\u7684\u5927\u5c0f\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282</li>\n<li><code>-c</code>: \u4e00\u5e76\u6267\u884c badblocks\uff0c\u4ee5\u6807\u793a\u635f\u574f\u7684\u533a\u5757</li>\n<li><code>-C</code>: \u5c06\u68c0\u67e5\u8fc7\u7a0b\u7684\u4fe1\u606f\u5b8c\u6574\u8bb0\u5f55\u5728 file descriptor \u4e2d\uff0c\u4f7f\u5f97\u6574\u4e2a\u68c0\u67e5\u8fc7\u7a0b\u90fd\u80fd\u5b8c\u6574\u76d1\u63a7</li>\n<li><code>-d</code>: \u663e\u793a\u6392\u9519\u4fe1\u606f</li>\n<li><code>-f</code>: \u5373\u4f7f\u6587\u4ef6\u7cfb\u7edf\u6ca1\u6709\u9519\u8bef\u8ff9\u8c61\uff0c\u4ecd\u5f3a\u5236\u5730\u68c0\u67e5\u6b63\u786e\u6027</li>\n<li><code>-F</code>: \u6267\u884c\u524d\u5148\u6e05\u9664\u8bbe\u5907\u7684\u7f13\u51b2\u533a</li>\n<li><code>-l</code>: \u5c06\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u52a0\u5230\u635f\u574f\u533a\u5757\u5217\u8868</li>\n<li><code>-L</code>: \u5148\u6e05\u9664\u635f\u574f\u533a\u5757\u5217\u8868\uff0c\u518d\u5c06\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u52a0\u5230\u635f\u574f\u533a\u5757\u5217\u8868\u3002\u56e0\u6b64\u635f\u574f\u533a\u5757\u5217\u8868\u7684\u533a\u5757\u8ddf\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u662f\u4e00\u6837\u7684</li>\n<li><code>-n</code>: \u4ee5\u53ea\u8bfb\u6a21\u5f0f\u5f00\u542f\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u91c7\u53d6\u975e\u4e92\u52a8\u65b9\u5f0f\u6267\u884c\uff0c\u6240\u6709\u7684\u95ee\u9898\u5bf9\u8bdd\u5747\u8bbe\u7f6e\u4ee5\"no\"\u56de\u7b54</li>\n<li><code>-p</code>: \u4e0d\u8be2\u95ee\u4f7f\u7528\u8005\u610f\u89c1\uff0c\u4fbf\u81ea\u52a8\u4fee\u590d\u6587\u4ef6\u7cfb\u7edf</li>\n<li><code>-r</code>: \u6b64\u53c2\u6570\u53ea\u4e3a\u4e86\u517c\u5bb9\u6027\u800c\u5b58\u5728\uff0c\u5e76\u65e0\u5b9e\u9645\u4f5c\u7528</li>\n<li><code>-s</code>: \u5982\u679c\u6587\u4ef6\u7cfb\u7edf\u7684\u5b57\u8282\u987a\u5e8f\u4e0d\u9002\u5f53\uff0c\u5c31\u4ea4\u6362\u5b57\u8282\u987a\u5e8f\uff0c\u5426\u5219\u4e0d\u505a\u4efb\u4f55\u52a8\u4f5c</li>\n<li><code>-S</code>: \u4e0d\u7ba1\u6587\u4ef6\u7cfb\u7edf\u7684\u5b57\u8282\u987a\u5e8f\uff0c\u4e00\u5f8b\u4ea4\u6362\u5b57\u8282\u987a\u5e8f</li>\n<li><code>-t</code>: \u663e\u793a\u65f6\u95f4\u4fe1\u606f</li>\n<li><code>-v</code>: \u6267\u884c\u65f6\u663e\u793a\u8be6\u7ec6\u7684\u4fe1\u606f</li>\n<li><code>-V</code>: \u663e\u793a\u7248\u672c\u4fe1\u606f</li>\n<li><code>-y</code>: \u91c7\u53d6\u975e\u4e92\u52a8\u65b9\u5f0f\u6267\u884c\uff0c\u6240\u6709\u7684\u95ee\u9898\u5747\u8bbe\u7f6e\u4ee5\"yes\"\u56de\u7b54\u3002</li>\n</ul>\n<p>e2fsck \u6267\u884c\u540e\u7684\u4f20\u56de\u503c\u53ca\u4ee3\u8868\u610f\u4e49\u5982\u4e0b\uff1a</p>\n<ul>\n<li>0: \u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u53d1\u751f\u3002</li>\n<li>1: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u5e76\u4e14\u5df2\u7ecf\u4fee\u6b63\u3002</li>\n<li>2: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u5e76\u4e14\u5df2\u7ecf\u4fee\u6b63\u3002</li>\n<li>4: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u4f46\u6ca1\u6709\u4fee\u6b63\u3002</li>\n<li>8: \u8fd0\u4f5c\u65f6\u53d1\u751f\u9519\u8bef\u3002</li>\n<li>16: \u4f7f\u7528\u7684\u8bed\u6cd5\u53d1\u751f\u9519\u8bef\u3002</li>\n<li>128: \u5171\u4eab\u7684\u51fd\u6570\u5e93\u53d1\u751f\u9519\u8bef\u3002</li>\n</ul>\n<h3 id=\"e2image\">e2image<a class=\"headerlink\" href=\"#e2image\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4fdd\u5b58\u5173\u952e\u7684 ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u5230\u6587\u4ef6\u3002 e2image \u53ef\u4ee5\u7528\u6765\u521b\u5efa ext2 \u548c ext3 \u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002<br />\ne2image \u53ea\u89e3\u91ca\u9700\u8981\u88ab\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u800c\u4e0d\u662f\u4fdd\u5b58\u539f\u59cb bit\u3002<br />\ne2image \u53ef\u4ee5\u521b\u5efa <code>raw</code> \u548c <code>nomal</code> \u955c\u50cf\uff0c\u8fd9\u4e24\u79cd\u65b9\u6cd5\u90fd\u53ef\u4ee5\u8282\u7ea6\u7a7a\u95f4\u3002</p>\n<p>\u56e0\u6b64\uff0c\u7528 e2image \u521b\u5efa\u7684\u955c\u50cf\u540c\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u6709\u4e0d\u540c\u7684 hash\uff0c\u4ece\u8fd9\u70b9\u4e0a\u770b\uff0c\u4ed6\u662f\u548c dd \u547d\u4ee4\u4e0d\u540c\u7684\u3002</p>\n<p>\u4f46\u662f\u5982\u4f55\u5c06 e2image \u521b\u5efa\u7684\u5907\u4efd\u6062\u590d\u51fa\u6765\u5462\uff1f\u8fd9\u70b9\u5728 e2image \u7684 help \u548c man \u624b\u518c\u4e2d\u90fd\u6ca1\u6709\u63d0\u5230</p>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50\uff0c\u5206\u90e8\u521b\u5efa\u4e86 <code>raw</code> \u548c <code>normal</code> \u955c\u50cf</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># e2image /dev/sda1 /tmp/e2image.data</span>\ne2image<span class=\"w\"> </span><span class=\"m\">1</span>.35<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">28</span>-Feb-2004<span class=\"o\">)</span>\n\n<span class=\"c1\"># ls -lh /tmp/e2image.data</span>\n-rw\u2014\u2014-<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span>625K<span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span><span class=\"m\">21</span>:18<span class=\"w\"> </span>/tmp/e2image.data\n\n<span class=\"c1\"># file /tmp/e2image.data</span>\n/tmp/e2image.data:<span class=\"w\"> </span>Linux<span class=\"w\"> </span>rev<span class=\"w\"> </span><span class=\"m\">1</span>.0<span class=\"w\"> </span>ext3<span class=\"w\"> </span>filesystem<span class=\"w\"> </span>data\n\n<span class=\"c1\"># mount /tmp/e2image.data /misc -oloop</span>\nmount:<span class=\"w\"> </span>wrong<span class=\"w\"> </span>fs<span class=\"w\"> </span>type,<span class=\"w\"> </span>bad<span class=\"w\"> </span>option,<span class=\"w\"> </span>bad<span class=\"w\"> </span>superblock<span class=\"w\"> </span>on<span class=\"w\"> </span>/dev/loop0,\nor<span class=\"w\"> </span>too<span class=\"w\"> </span>many<span class=\"w\"> </span>mounted<span class=\"w\"> </span>file<span class=\"w\"> </span>systems\n<span class=\"o\">(</span>could<span class=\"w\"> </span>this<span class=\"w\"> </span>be<span class=\"w\"> </span>the<span class=\"w\"> </span>IDE<span class=\"w\"> </span>device<span class=\"w\"> </span>where<span class=\"w\"> </span>you<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>fact<span class=\"w\"> </span>use\nide-scsi<span class=\"w\"> </span>so<span class=\"w\"> </span>that<span class=\"w\"> </span>sr0<span class=\"w\"> </span>or<span class=\"w\"> </span>sda<span class=\"w\"> </span>or<span class=\"w\"> </span>so<span class=\"w\"> </span>is<span class=\"w\"> </span>needed?<span class=\"o\">)</span>\n\n<span class=\"c1\"># mount -r /tmp/e2image.data /tmp/e2image_raw_data</span>\nmount:<span class=\"w\"> </span>mount<span class=\"w\"> </span>point<span class=\"w\"> </span>/tmp/e2image_raw_data<span class=\"w\"> </span>does<span class=\"w\"> </span>not<span class=\"w\"> </span>exist\n\n<span class=\"c1\"># e2image -r /dev/sda1 /tmp/e2image_raw_data</span>\ne2image<span class=\"w\"> </span><span class=\"m\">1</span>.35<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">28</span>-Feb-2004<span class=\"o\">)</span>\n\n<span class=\"c1\"># ls -lh /tmp/e2image_raw_data</span>\n-rw\u2014\u2014-<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span>20M<span class=\"w\"> </span>1\u6708<span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span><span class=\"m\">21</span>:20<span class=\"w\"> </span>/tmp/e2image_raw_data\n\n<span class=\"c1\"># file /tmp/e2image_raw_data</span>\n/tmp/e2image_raw_data:<span class=\"w\"> </span>Linux<span class=\"w\"> </span>rev<span class=\"w\"> </span><span class=\"m\">1</span>.0<span class=\"w\"> </span>ext3<span class=\"w\"> </span>filesystem<span class=\"w\"> </span>data\n\n<span class=\"c1\"># mount /tmp/e2image_raw_data /misc -oloop</span>\n\n<span class=\"c1\"># df -h</span>\nFilesystem<span class=\"w\">            </span>\u5bb9\u91cf<span class=\"w\"> </span>\u5df2\u7528<span class=\"w\"> </span>\u53ef\u7528<span class=\"w\"> </span>\u5df2\u7528%<span class=\"w\"> </span>\u6302\u8f7d\u70b9\n/tmp/e2image_raw_data<span class=\"w\"> </span>19M<span class=\"w\"> </span><span class=\"m\">1</span>.2M<span class=\"w\"> </span>17M<span class=\"w\"> </span><span class=\"m\">7</span>%<span class=\"w\"> </span>/misc\n\n<span class=\"c1\"># mount /dev/sda1 /misc</span>\n\n<span class=\"c1\"># df -h</span>\nFilesystem<span class=\"w\"> </span>\u5bb9\u91cf<span class=\"w\"> </span>\u5df2\u7528<span class=\"w\"> </span>\u53ef\u7528<span class=\"w\"> </span>\u5df2\u7528%<span class=\"w\"> </span>\u6302\u8f7d\u70b9\n/dev/sda1<span class=\"w\"> </span>19M<span class=\"w\"> </span><span class=\"m\">1</span>.2M<span class=\"w\"> </span>17M<span class=\"w\"> </span><span class=\"m\">7</span>%<span class=\"w\"> </span>/misc\n</code></pre></div>\n<h3 id=\"e2label\">e2label<a class=\"headerlink\" href=\"#e2label\" title=\"Permanent link\">&para;</a></h3>\n<p>\u663e\u793a\u6216\u8005\u4fee\u6539 ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u7b7e\u3002\u6ca1\u6709\u6ce8\u610f\u8fc7\u4ece\u54ea\u4e2a\u7248\u672c\u5f00\u59cb\uff0c<code>/etc/fstab</code> \u6587\u4ef6\u91cc\u7684\u6302\u8f7d\u8bbe\u5907\u540d\u4e0d\u518d\u662f\u5b9e\u9645\u7684\u8bbe\u5907\u540d\u79f0\u4e86\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u5176\u6807\u7b7e\uff0c\u8fd9\u589e\u52a0\u4e86\u5176\u7075\u6d3b\u6027\uff0c\n\u7279\u522b\u662f\u5f53\u5220\u9664\u5e76\u4e0d\u662f\u6700\u540e\u4e00\u4e2a\u53bb\u5206\u533a\u65f6\uff0c\u5728\u6b64\u5206\u533a\u524d\u7684\u8bbe\u5907\u53f7\u90fd\u4f1a\u63d0\u524d\u4e00\u4f4d\uff0c\u5982\u679c <code>/etc/fstab</code> \u5199\u5165\u7684\u662f\u5b9e\u9645\u7684\u8bbe\u5907\u540d\u79f0\uff0c\u90a3\u663e\u7136\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\n\u7cfb\u7edf\u4e5f\u8bb8\u627e\u4e0d\u5230\u9700\u8981\u7684\u8bbe\u5907\u3002\u800c\u91c7\u7528\u6807\u7b7e\u7684\u8bdd\uff0c\u53ea\u8981\u6807\u7b7e\u4e0d\u91cd\u590d\uff0c\u5373\u4f7f\u8bbe\u5907\u6709 sda \u53d8\u6210\u4e86 sdb\uff0cLinux \u7cfb\u7edf\u4f9d\u7136\u80fd\u6b63\u5e38\u542f\u52a8\u3002</p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u975e\u5e38\u7b80\u5355\u3002\u770b\u4e0b\u9762\u7684\u5b9e\u4f8b\u5c31\u660e\u767d\u4e86</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># e2label /dev/sda1</span>\n\n<span class=\"c1\"># e2label /dev/sda1 newlabel</span>\n\n<span class=\"c1\"># e2label /dev/sda1</span>\nnewlabel\n</code></pre></div>\n<h3 id=\"elvtune\">elvtune<a class=\"headerlink\" href=\"#elvtune\" title=\"Permanent link\">&para;</a></h3>\n<p>I/O \u7535\u68af\u8c03\u8bd5\u5668\uff0c\u5141\u8bb8\u4f60\u8c03\u8bd5\u6bcf\u4e00\u4e2a\u5757\u8bbe\u5907\u7684 I\uff0fO \u7535\u68af\u7b97\u6cd5\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u5b9e\u73b0\u4e00\u8def\u548c\u4e8c\u8def\u7535\u68af\u7b97\u6cd5\u3002</p>\n<p>\u540c\u65f6\u5bf9\u4e8e LVM \u800c\u8a00\uff0c\u8c03\u8bd5\u5668\u4ec5\u4ec5\u5728\u7269\u7406\u5377(PV)\u4e0a\u6709\u6548\u679c\uff0c\u5bf9\u903b\u8f91\u5377\uff08LV\uff09\u6ca1\u6709\u7528\u3002</p>\n<p>\u4e0d\u8fc7\u8fd9\u4e2a\u547d\u4ee4\u8981\u6c42\u7684\u8bbe\u5907\u53c2\u6570\u662f/dev/blkdevX (X \u8868\u793a\u6570\u5b57\uff09\uff0c\u6211\u5c1d\u8bd5\u4f20\u9012 /dev/sda1,/dev/hda1\uff0c\u5747\u62a5\u544a\u65e0\u6548\u7684\u53c2\u6570\u3002</p>\n<p>\u6240\u4ee5\u6ca1\u6709\u89c9\u5f97\u8fd9\u4e2a\u547d\u4ee4\u5230\u5e95\u80fd\u7ed9\u6211\u4eec\u5e26\u6765\u4ec0\u4e48\uff0c\u7279\u522b\u662f\u5728 man \u624b\u518c\u7684\u5386\u53f2\u4e00\u9879\u4e2d\u8fd9\u6837\u5199\u9053\uff1a</p>\n<blockquote>\n<p>Ioctls for tuning elevator behaviour were added in Linux 2.3.99-pre1.</p>\n</blockquote>\n<p>\u611f\u89c9\u5e94\u8be5\u662f\u4e00\u4e2a\u4e34\u65f6\u5de5\u5177\uff0c\u4f46\u662f\u4ed6\u5c5e\u4e8e util-linux \u5de5\u5177\u5305\uff0c\u4e0d\u89e3\u3002</p>\n<h3 id=\"ether-wake\">ether-wake<a class=\"headerlink\" href=\"#ether-wake\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u7528\u6765\u4ea7\u751f\u548c\u53d1\u9001\u4e00\u4e2a Wake-On-LAN(WOL)\u6570\u636e\u5305(MagicPacker)\u5305\uff0c\u7528\u6765\u91cd\u542f\u8f6f\u5173\u673a\u7684\u673a\u5668\u3002\u8fd9\u4e2a\u73a9\u610f\u6ca1\u6709\u529e\u6cd5\u6d4b\u8bd5\uff0c\u4e5f\u4e0d\u77e5\u9053\u5b9e\u9645\u73af\u5883\u4e2d\u662f\u5426\u7528\u5f97\u591a\u3002</p>\n<h3 id=\"ethtool\">ethtool<a class=\"headerlink\" href=\"#ethtool\" title=\"Permanent link\">&para;</a></h3>\n<p>\u663e\u793a\u6216\u4fee\u6539\u4ee5\u592a\u7f51\u5361\u7684\u8bbe\u7f6e\uff0c\u8fd9\u91cc\u7684\u8bbe\u7f6e\u771f\u7684\u662f\u786c\u4ef6\u65b9\u9762\u7684\uff0c\u6bd4\u5982\u5f3a\u5236\u4e3a\u534a\u53cc\u5de5\u7b49\u3002</p>\n<p>\u6700\u5f00\u59cb\u6211\u7528\u8fd9\u4e2a\u547d\u4ee4\u662f\u6709\u4e00\u4e2a\u7528\u6237\u8bf4\u4ed6\u7684\u7f51\u5361\u660e\u660e\u662f\u5168\u53cc\u5de5\u7684\uff0c\u4e3a\u4ec0\u4e48\u7cfb\u7edf\u91cc\u770b\u5230\u7684\u662f\u534a\u53cc\u5de5\u5440\uff0c\u6709\u4ec0\u4e48\u529e\u6cd5\u6539\u5417\uff1fifconfig \u547d\u4ee4\u770b\u4e86\u534a\u5929\u540e\u6ca1\u6709\u627e\u5230\u597d\u7684\u8bbe\u7f6e\u65b9\u5f0f\uff0c\n\u540e\u6765\u627e\u5230\u4e86\u8fd9\u4e2a ethtool\uff0c\u89e3\u51b3\u4e86\u95ee\u9898\u3002\u5176\u5b9e mii-tool \u4e5f\u80fd\u505a\u5230\u8fd9\u70b9\uff0c\u4f46\u662f\u6709\u4e9b\u7f51\u5361\u9a71\u52a8\u76ee\u524d\u8fd8\u4e0e\u652f\u6301 mii-tool \u5de5\u5177\u3002</p>\n<p>ethtool \u7684\u547d\u4ee4\u6bd4\u8f83\u590d\u6742\uff0c\u53c2\u6570\u4e5f\u591a\uff0c\u6211\u4eec\u770b\u51e0\u4e2a\u4f8b\u5b50\uff0c\u7136\u540e\u5217\u51fa man \u624b\u518c\u3002</p>\n<p><strong>\u6253\u5370\u5f53\u524d\u7f51\u5361\u7684\u914d\u7f6e\u4fe1\u606f</strong></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ethtool eth0</span>\nSettings<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>eth0:\nSupported<span class=\"w\"> </span>ports:<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>TP<span class=\"w\"> </span>MII<span class=\"w\"> </span><span class=\"o\">]</span>\nSupported<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nSupports<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>Yes\nAdvertised<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nAdvertised<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>No<span class=\"w\"> </span>\u6ce8\uff1a\u81ea\u52a8\u534f\u5546\u5173\u95ed\nSpeed:<span class=\"w\"> </span>100Mb/s<span class=\"w\"> </span>//<span class=\"w\"> </span>100Mb\nDuplex:<span class=\"w\"> </span>Full<span class=\"w\"> </span>//\u5168\u53cc\u5de5\nPort:<span class=\"w\"> </span>MII<span class=\"w\"> </span>/\u652f\u6301mii\u6a21\u5f0f\nPHYAD:<span class=\"w\"> </span><span class=\"m\">32</span>\nTransceiver:<span class=\"w\"> </span>internal\nAuto-negotiation:<span class=\"w\"> </span>off\nSupports<span class=\"w\"> </span>Wake-on:<span class=\"w\"> </span>pumbg\nWake-on:<span class=\"w\"> </span>d\nCurrent<span class=\"w\"> </span>message<span class=\"w\"> </span>level:<span class=\"w\"> </span><span class=\"m\">0</span>\u00d700000007<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">7</span><span class=\"o\">)</span>\nLink<span class=\"w\"> </span>detected:<span class=\"w\"> </span>yes\n</code></pre></div>\n<p><strong>\u5c06\u7f51\u5361\u4fee\u6539\u6210 10Mbps\uff0c\u534a\u53cc\u5de5</strong></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ethtool -s eth1 speed 10 duplex half</span>\n<span class=\"c1\"># ethtool eth1</span>\nSettings<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>eth1:\nSupported<span class=\"w\"> </span>ports:<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>TP<span class=\"w\"> </span>MII<span class=\"w\"> </span><span class=\"o\">]</span>\nSupported<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nSupports<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>Yes\nAdvertised<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nAdvertised<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>No\nSpeed:<span class=\"w\"> </span>10Mb/s<span class=\"w\"> </span><span class=\"c1\"># 10Mbps</span>\nDuplex:<span class=\"w\"> </span>Half<span class=\"w\"> </span><span class=\"c1\">#\u5df2\u7ecf\u4fee\u6539\u4e3a\u534a\u53cc\u5de5\u4e86</span>\nPort:<span class=\"w\"> </span>MII\nPHYAD:<span class=\"w\"> </span><span class=\"m\">32</span>\nTransceiver:<span class=\"w\"> </span>internal\nAuto-negotiation:<span class=\"w\"> </span>off\nSupports<span class=\"w\"> </span>Wake-on:<span class=\"w\"> </span>pumbg\nWake-on:<span class=\"w\"> </span>d\nCurrent<span class=\"w\"> </span>message<span class=\"w\"> </span>level:<span class=\"w\"> </span><span class=\"m\">0</span>\u00d700000007<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">7</span><span class=\"o\">)</span>\nLink<span class=\"w\"> </span>detected:<span class=\"w\"> </span>no\n</code></pre></div>\n<p><strong>\u5c06\u7f51\u5361\u4fee\u6539\u4e3a 100M\uff0c\u5168\u53cc\u5de5</strong></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># ethtool -s eth1 speed 100 duplex full</span>\n<span class=\"c1\"># ethtool eth1</span>\nSettings<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>eth1:\nSupported<span class=\"w\"> </span>ports:<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>TP<span class=\"w\"> </span>MII<span class=\"w\"> </span><span class=\"o\">]</span>\nSupported<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nSupports<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>Yes\nAdvertised<span class=\"w\"> </span>link<span class=\"w\"> </span>modes:<span class=\"w\"> </span>10baseT/Half<span class=\"w\"> </span>10baseT/Full\n100baseT/Half<span class=\"w\"> </span>100baseT/Full\nAdvertised<span class=\"w\"> </span>auto-negotiation:<span class=\"w\"> </span>No\nSpeed:<span class=\"w\"> </span>100Mb/s<span class=\"w\"> </span><span class=\"c1\">#</span>\nDuplex:<span class=\"w\"> </span>Full<span class=\"w\"> </span><span class=\"c1\">#</span>\nPort:<span class=\"w\"> </span>MII\nPHYAD:<span class=\"w\"> </span><span class=\"m\">32</span>\nTransceiver:<span class=\"w\"> </span>internal\nAuto-negotiation:<span class=\"w\"> </span>off\nSupports<span class=\"w\"> </span>Wake-on:<span class=\"w\"> </span>pumbg\nWake-on:<span class=\"w\"> </span>d\nCurrent<span class=\"w\"> </span>message<span class=\"w\"> </span>level:<span class=\"w\"> </span><span class=\"m\">0</span>\u00d700000007<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">7</span><span class=\"o\">)</span>\nLink<span class=\"w\"> </span>detected:<span class=\"w\"> </span>no\n</code></pre></div>\n<p>\u6211\u4eec\u518d\u770b\u770b man \u624b\u518c</p>\n<div class=\"highlight\"><pre><span></span><code> ethtool ethX #\u663e\u793a\u7f51\u5361\u7684\n ethtool -h #\u6253\u5370\u5e2e\u52a9\n ethtool -a ethX #\u67e5\u8be2\u6307\u5b9a\u7f51\u5361\u7684\u6682\u505c(pause)\u53c2\u6570\u4fe1\u606f\n ethtool -A ethX [autoneg on|off] [rx on|off] [tx on|off] #\u8bbe\u7f6e\u6682\u505c\u53c2\u6570\n ethtool -c ethX #\u67e5\u8be2\u6307\u5b9a\u7f51\u5361\u7684\u8054\u5408(coalesc)\u4fe1\u606f\n\n ethtool -C ethX [adaptive-rx on|off] [adaptive-tx on|off] [rx-usecs N]\n [rx-frames N] [rx-usecs-irq N] [rx-frames-irq N] [tx-usecs N] [tx-\n frames N] [tx-usecs-irq N] [tx-frames-irq N] [stats-block-usecs N]\n [pkt-rate-low N] [rx-usecs-low N] [rx-frames-low N] [tx-usecs-low N]\n [tx-frames-low N] [pkt-rate-high N] [rx-usecs-high N] [rx-frames-high\n N] [tx-usecs-high N] [tx-frames-high N] [sample-interval N] #\u8bbe\u7f6e\u6307\u5b9a\u7f51\u5361\u7684\u8054\u5408\u4fe1\u606f\n\n ethtool -g ethX #\u67e5\u8be2\u7f51\u5361\u7684RX/TX\u53c2\u6570\u4fe1\u606f\n ethtool -G ethX [rx N] [rx-mini N] [rx-jumbo N] [tx N] #\u8bbe\u7f6e\u7f51\u5361\u7684RX/TX\u53c2\u6570\n ethtool -i ethX #\u67e5\u8be2\u4e0e\u7f51\u5361\u5173\u8054\u7684\u9a71\u52a8\u4fe1\u606f\n ethtool -d ethX #\u91cd\u65b0\u83b7\u53d6\u548c\u6253\u5370\u4e00\u4e2a\u7f51\u5361\u7684\u6ce8\u518cdump\u4fe1\u606f\n ethtool -e ethX [raw on|off] [offset N] [length N] #\u91cd\u65b0\u83b7\u53d6\u548c\u6253\u5370\u7f51\u5361\u7684EEPROMdump\u4fe1\u606f\n ethtool -E ethX [magic N] [offset N] [value N] #\u4fee\u6539\u7f51\u5361\u7684EEPROM\u5b57\u8282\n ethtool -k ethX #\u67e5\u8be2\u7f51\u5361\u7684\u5378\u8f7d(offload)\u4fe1\u606f\n ethtool -K ethX [rx on|off] [tx on|off] [sg on|off] [tso on|off] #\u4fee\u6539\u7f51\u5361\u7684\u5378\u8f7d\u53c2\u6570\n ethtool -r ethX #\u91cd\u542f\u7f51\u5361\u7684\u81ea\u52a8\u534f\u5546(auto-negotiation)\u529f\u80fd\uff0c\u5982\u679c\u8fd9\u4e2a\u529f\u80fd\u8bbe\u7f6e\u4f4d\u53ef\u7528\u7684\u8bdd\n ethtool -t ethX [offline|online] #\u6267\u884c\u7f51\u5361\u81ea\u68c0\u7a0b\u5e8f\n ethtool -s ethX [speed 10|100|1000] [duplex half|full]\n [port tp|aui|bnc|mii] [autoneg on|off] [phyad N] [xcvr internal|exter-\n nal] [wol p|u|m|b|a|g|s|d...] [sopass xx:yy:zz:aa:bb:cc] [msglvl N] #\u53ef\u4ee5\u4fee\u6539\u7684\u53c2\u6570\u503c\uff0c\u7528-s\u6765\u6807\u5fd7\n</code></pre></div>\n<p>\u8fd9\u4e9b\u8bbe\u7f6e\u4ec5\u4ec5\u5728\u5f53\u524d\u751f\u6548\uff0c\u4e00\u65e6\u91cd\u542f\u7f51\u7edc\u6216\u8005\u91cd\u542f\u7cfb\u7edf\uff0cethtool \u7684\u8bbe\u7f6e\u5c06\u4f1a\u5931\u6548\u3002\u6211\u4eec\u53ef\u4ee5\u628a ethtool \u7684\u8bbe\u7f6e\u547d\u4ee4\u52a0\u5165\u5230 ifcfg-ethX \u914d\u7f6e\u6587\u4ef6\u4e2d\u3002\n\u6bd4\u5982\uff0c\u4f60\u5e0c\u671b\u628a\u7b2c\u4e00\u5757\u7f51\u5361\u8bbe\u7f6e\u4e3a\u5168\u53cc\u5de5\uff0c\u81ea\u9002\u5e94\u548c 100M \u7684\u65b9\u5f0f\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u5728\u4f60\u7684 <code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> \u6587\u4ef6\u4e2d\u52a0\u5165\u4e0b\u9762\u4e00\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>ETHTOOL_OPTS=&quot;speed 100 duplex full autoneg off&quot;\n</code></pre></div>\n<h2 id=\"sbin-f\">/sbin \u4e0b f \u5f00\u5934\u7684\u547d\u4ee4\u5982\u4e0b<a class=\"headerlink\" href=\"#sbin-f\" title=\"Permanent link\">&para;</a></h2>\n<blockquote>\n<p>fdisk fixfiles fsck.cramfs fsck.ext3 fsck.ocfs2 fsck.vfat fuser findfs<br />\nfsck fsck.ext2 fsck.msdos fsck.reiserfs fsck.xfs fxload</p>\n</blockquote>\n<p>\u5176\u4e2d<code>fsck.reiserfs</code> \u662f <code>reiserfsck</code> \u547d\u4ee4\u7684\u8f6f\u8fde\u63a5\uff0cf \u5f00\u5934\u7684\u547d\u4ee4\u4e2d fsck \u547d\u4ee4\u5957\u4ef6\u5360\u4e86\u7edd\u5927\u90e8\u5206\u3002</p>\n<h3 id=\"findfs\">findfs<a class=\"headerlink\" href=\"#findfs\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6839\u636e\u6807\u7b7e(label)\u6216\u8005 UUID \u53f7\u6765\u67e5\u8be2\u6587\u4ef6\u7cfb\u7edf\u3002\u4ed6\u4f1a\u641c\u7d22\u6574\u4e2a\u78c1\u76d8\uff0c\u770b\u662f\u5426\u6709\u5339\u914d\u7684\u6807\u7b7e\u6216\u8005 UUID \u6ca1\u6709\uff0c\u5982\u679c\u6709\uff0c\u5219\u6253\u5370\u5230\u6807\u6ce8\u8f93\u51fa\u4e0a\u3002\u4ed6\u4e5f\u662f<a href=\"http://e2fsprogs.sf.net\">e2fsprogs</a>\u9879\u76ee\u7684\u4e00\u90e8\u5206\u3002</p>\n<p>\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># findfs \u2013help</span>\nUsage:<span class=\"w\"> </span>findfs<span class=\"w\"> </span><span class=\"nv\">LABEL</span><span class=\"o\">=</span><span class=\"p\">|</span><span class=\"nv\">UUID</span><span class=\"o\">=</span>\n\n<span class=\"c1\"># findfs LABEL=/</span>\n/dev/hda5\n\n<span class=\"c1\"># findfs LABEL=/home</span>\nfindfs:<span class=\"w\"> </span>Unable<span class=\"w\"> </span>to<span class=\"w\"> </span>resolve<span class=\"w\"> </span><span class=\"s1\">&#39;LABEL=/home&#39;</span>\n</code></pre></div>\n<p>\u6211\u6ca1\u6709\u641e\u6e05\u695a\u8fd9\u4e2a\u547d\u4ee4\u5230\u5e95\u6709\u4ec0\u4e48\u7528\u6216\u8005\u5e94\u8be5\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f7f\u7528\uff1f\u56e0\u4e3a\u77e5\u9053 LABEL \u6216\u8005 UUID \u5e76\u4e0d\u50cf\u5e73\u5e38\u77e5\u9053\u67d0\u4e00\u4e2a\u6587\u4ef6\u90a3\u6837\u5bb9\u6613\u8bb0\u4f4f\u3002\u6240\u4ee5\u4ed6\u548c find \u7684\u4f7f\u7528\u8303\u56f4\u76f8\u6bd4\uff0c\u5c31\u5c0f\u4e86\u5f88\u591a\u4e86\uff0c\u96be\u9053\u4ed6\u6709\u610f\u60f3\u4e0d\u5230\u7684\u7528\u9014\uff1f</p>\n<h3 id=\"fixfiles\">fixfiles<a class=\"headerlink\" href=\"#fixfiles\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4fee\u590d\u6587\u4ef6\u5b89\u5168\u4e0a\u4e0b\u6587(security contexts)\u3002\u8fd9\u662f\u4e00\u4e2a shell \u811a\u672c\uff0c\u4e3b\u8981\u662f\u7528\u6765\u6821\u6b63\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u5b89\u5168\u4e0a\u4e0b\u6587\u6570\u636e\u5e93\uff08\u6269\u5c55\u5c5e\u6027\uff09\u3002\n\u4ed4\u7ec6\u770b\u4e86\u5e2e\u52a9\uff0c\u4e5f\u4f5c\u4e86\u4e00\u4e9b\u6d4b\u8bd5\uff0c\u6ca1\u6709\u660e\u767d\u4ed6\u8981\u8868\u8fbe\u4ec0\u4e48\uff0c\u521a\u5f00\u59cb\u4ee5\u4e3a\u662f\u4ed6\u4f1a\u6062\u590d\u6211\u539f\u6765\u4fee\u6539\u8fc7\u67d0\u4e9b\u914d\u7f6e\u6587\u4ef6\u5230\u521d\u59cb\u72b6\u6001\uff0c\u5f53\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u4f3c\u4e4e\u4e0d\u662f\u8fd9\u56de\u4e8b\u3002\n\u6240\u5c5e\u4e8e policycoreutils RPM \u5305\uff0c\u8fd9\u662f SELinux \u7684\u4e00\u90e8\u5206\u3002</p>\n<h3 id=\"fuser\">fuser<a class=\"headerlink\" href=\"#fuser\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f7f\u7528\u6587\u4ef6\u6216\u8005\u5957\u8282\u5b57\u6765\u8868\u793a\u8bc6\u522b\u8fdb\u7a0b\u3002\u6211\u5e38\u7528\u7684\u4ed6\u7684\u4e24\u4e2a\u529f\u80fd\uff1a\u67e5\u770b\u6211\u9700\u8981\u7684\u8fdb\u7a0b\u548c\u6211\u8981\u6740\u6b7b\u6211\u67e5\u5230\u7684\u8fdb\u7a0b\u3002</p>\n<p>\u6bd4\u5982\u5f53\u4f60\u60f3 umount \u5149\u9a71\u7684\u65f6\u5019\uff0c\u7ed3\u679c\u7cfb\u7edf\u63d0\u793a\u4f60\u8bbe\u5907\u6b63\u5728\u4f7f\u7528\u6216\u8005\u6b63\u5fd9\uff0c\u53ef\u662f\u4f60\u53c8\u627e\u4e0d\u5230\u5230\u5e95\u8c01\u4f7f\u7528\u4e86\u4ed6\u3002\u8fd9\u4e2a\u65f6\u5019 fuser \u53ef\u6d3e\u4e0a\u7528\u573a\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># eject</span>\numount:<span class=\"w\"> </span>/media/cdrom:<span class=\"w\"> </span>device<span class=\"w\"> </span>is<span class=\"w\"> </span>busy\numount:<span class=\"w\"> </span>/media/cdrom:<span class=\"w\"> </span>device<span class=\"w\"> </span>is<span class=\"w\"> </span>busy\neject:<span class=\"w\"> </span>unmount<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"s1\">&#39;/media/cdrom&#39;</span><span class=\"w\"> </span>failed\n\n<span class=\"c1\"># fuser /mnt/cdrom</span>\n/mnt/cdrom:<span class=\"w\"> </span>4561c<span class=\"w\"> </span>5382c\n\n<span class=\"c1\"># ps -ef |egrep &#39;(4561|5382)&#39; |grep -v grep</span>\n\nroot<span class=\"w\"> </span><span class=\"m\">4561</span><span class=\"w\"> </span><span class=\"m\">4227</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">20</span>:13<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">00</span>:00:00<span class=\"w\"> </span>bash\nroot<span class=\"w\"> </span><span class=\"m\">5382</span><span class=\"w\"> </span><span class=\"m\">4561</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">21</span>:42<span class=\"w\"> </span>pts/1<span class=\"w\"> </span><span class=\"m\">00</span>:00:00<span class=\"w\"> </span>vim<span class=\"w\"> </span>Autorun.inf\n</code></pre></div>\n<p>\u793a\u4f8b\u4e2d\uff0c\u6211\u60f3\u5f39\u51fa\u5149\u9a71\uff0c\u7cfb\u7edf\u544a\u8bc9\u6211\u8bbe\u5907\u5fd9\u7740\uff0c\u4e8e\u662f\u91c7\u7528 fuser \u547d\u4ee4\uff0c\u53c2\u6570\u662f\u4f60\u6587\u4ef6\u6216 scoket\uff0cfuser \u5c06\u67e5\u51fa\u90a3\u4e9b\u4f7f\u7528\u4e86\u4ed6\u3002</p>\n<p><code>4561c,5382c</code> \u8868\u793a\u76ee\u524d\u7528\u4e24\u4e2a\u8fdb\u7a0b\u5728\u5360\u7528\u7740 <code>/mnt/cdrom</code>\uff0c\u5206\u522b\u662f 4561,5382,\u8fdb\u7a0b ID \u540e\u7684\u5b57\u6bcd\u8868\u793a\u5360\u7528\u8d44\u6e90\u7684\u65b9\u5f0f\uff0c\u6709\u4e0b\u9762\u51e0\u79cd\u8868\u793a\uff1a</p>\n<ul>\n<li>c \u5f53\u524d\u8def\u5f84(current directory.)\u6211\u7684\u7406\u89e3\u662f\u8868\u793a\u8fd9\u4e2a\u8d44\u6e90\u7684\u5360\u7528\u662f\u4ee5\u6587\u4ef6\u76ee\u5f55\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8fdb\u8fdb\u5165\u4e86\u9700\u8981\u91ca\u653e\u7684\u8d44\u6e90\u7684\u8def\u5f84\uff0c\u8fd9\u662f\u6700\u5e38\u7528\u7684\u8d44\u6e90\u5360\u7528\u65b9\u5f0f\u3002</li>\n<li>e \u6b63\u5728\u8fd0\u884c\u53ef\u6267\u884c\u6587\u4ef6\uff08executable being run.\uff09\uff0c\u6bd4\u5982\u8fd0\u884c\u4e86\u5149\u76d8\u4e0a\u7684\u67d0\u4e2a\u7a0b\u5e8f</li>\n<li>f \u6253\u5f00\u6587\u4ef6\uff08 open file\uff09\uff0c\u7f3a\u7701\u6a21\u5f0f\u4e0b f \u5ffd\u7565\u3002</li>\n<li>m mmap \u6587\u4ef6\u6216\u8005\u5171\u4eab\u5e93( mmap\u2019ed file or shared library)</li>\n<li>\u6240\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u867d\u7136\u662f\u5f00\u6253\u4e86\u5149\u76d8\u4e0a\u7684 Autorun.inf \u6587\u4ef6\uff0c\u4f46\u662f\u7ed9\u51fa\u7684\u6807\u8bc6\u662f c\uff0c\u800c\u4e0d\u662f f\u3002\n  root \u76ee\u5f55\uff08root directory\uff09.\u6ca1\u6709\u660e\u767d\u4ec0\u4e48\u610f\u601d\uff0c\u96be\u9053\u662f\u8bf4\u8fdb\u5165\u4e86/root \u8fd9\u4e2a\u7279\u5b9a\u76ee\u5f55\uff1f<br />\n  .\u8fd9\u5e94\u8be5\u662f\u8bf4\u67d0\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u4e86\u4f60\u8981\u91ca\u653e\u7684\u8d44\u6e90\u7684\u67d0\u4e2a\u5171\u4eab\u6587\u4ef6\u3002</li>\n</ul>\n<p>\u5728\u67e5\u627e\u7684\u540c\u65f6\uff0c\u4f60\u8fd8\u53ef\u5b9a\u6307\u5b9a\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982</p>\n<ul>\n<li><code>-k</code>: \u6740\u6b7b\u8fd9\u4e9b\u6b63\u5728\u8bbf\u95ee\u8fd9\u4e9b\u6587\u4ef6\u7684\u8fdb\u7a0b\u3002\u9664\u975e\u4f7f\u7528-signal \u4fee\u6539\u4fe1\u53f7\uff0c\u5426\u5219\u5c06\u53d1\u9001 SIGKILL \u4fe1\u53f7\u3002</li>\n<li><code>-i</code>: \u4ea4\u4e92\u6a21\u5f0f</li>\n<li><code>-l</code>: \u5217\u51fa\u6240\u6709\u5df2\u77e5\u7684\u4fe1\u53f7\u540d\u79f0\u3002</li>\n<li><code>-n</code>: \u7a7a\u95f4\uff0c\u9009\u62e9\u4e0d\u540c\u7684\u540d\u5b57\u7a7a\u95f4\uff0c\u53ef\u662f file,udp,tcp\u3002\u9ed8\u8ba4\u662f file\uff0c\u4e5f\u5c31\u662f\u6587\u4ef6\u3002</li>\n<li><code>-signal</code>: \u6307\u5b9a\u53d1\u9001\u7684\u4fe1\u53f7\uff0c\u800c\u4e0d\u662f\u7f3a\u7701\u7684 SIGKILL</li>\n<li><code>-4</code>: \u4ec5\u67e5\u8be2 IPV4 \u5957\u63a5\u5b57</li>\n<li><code>-6</code>: \u4ec5\u67e5\u8be2 IPV6 \u5957\u63a5\u5b57</li>\n</ul>\n<p>\u518d\u770b\u4e0b\u9762\u7684\u4f8b\u5b50</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># fuser -l</span>\nHUP<span class=\"w\"> </span>INT<span class=\"w\"> </span>QUIT<span class=\"w\"> </span>ILL<span class=\"w\"> </span>TRAP<span class=\"w\"> </span>ABRT<span class=\"w\"> </span>IOT<span class=\"w\"> </span>BUS<span class=\"w\"> </span>FPE<span class=\"w\"> </span>KILL<span class=\"w\"> </span>USR1<span class=\"w\"> </span>SEGV<span class=\"w\"> </span>USR2<span class=\"w\"> </span>PIPE<span class=\"w\"> </span>ALRM<span class=\"w\"> </span>TERM\nSTKFLT<span class=\"w\"> </span>CHLD<span class=\"w\"> </span>CONT<span class=\"w\"> </span>STOP<span class=\"w\"> </span>TSTP<span class=\"w\"> </span>TTIN<span class=\"w\"> </span>TTOU<span class=\"w\"> </span>URG<span class=\"w\"> </span>XCPU<span class=\"w\"> </span>XFSZ<span class=\"w\"> </span>VTALRM<span class=\"w\"> </span>PROF<span class=\"w\"> </span>WINCH<span class=\"w\"> </span>IO<span class=\"w\"> </span>PWR<span class=\"w\"> </span>SYS\nUNUSED\n</code></pre></div>\n<p>\u73b0\u5728\u6211\u4eec\u8bd5\u8bd5 fuser -k \u7684\u5a01\u529b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># fuser -k /mnt/cdrom</span>\n/mnt/cdrom:<span class=\"w\"> </span>4561c<span class=\"w\"> </span>5382c\n\n<span class=\"nb\">kill</span><span class=\"w\"> </span><span class=\"m\">5382</span>:<span class=\"w\"> </span>\u6ca1\u6709\u90a3\u4e2a\u8fdb\u7a0b\nNo<span class=\"w\"> </span>automatic<span class=\"w\"> </span>removal.<span class=\"w\"> </span>Please<span class=\"w\"> </span>use<span class=\"w\"> </span>umount<span class=\"w\"> </span>/media/cdrom\n\n<span class=\"c1\"># eject</span>\n</code></pre></div>\n<p>\u5957\u8282\u5b57\u65b9\u5f0f\u7684\u4f7f\u7528\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># fuser -4 -n tcp 3306</span>\nhere:<span class=\"w\"> </span><span class=\"m\">3306</span>\n<span class=\"m\">3306</span>/tcp:<span class=\"w\"> </span><span class=\"m\">5595</span>\n\n<span class=\"c1\"># ps -ef |grep 5595 |grep -v grep</span>\n\nmysql<span class=\"w\"> </span><span class=\"m\">5595</span><span class=\"w\"> </span><span class=\"m\">5563</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">22</span>:24<span class=\"w\"> </span>pts/0<span class=\"w\"> </span><span class=\"m\">00</span>:00:00<span class=\"w\"> </span>/usr/libexec/mysqld<span class=\"w\"> </span>\u2013defaults-file<span class=\"o\">=</span>/etc/my.cnf<span class=\"w\"> </span>\u2013basedir<span class=\"o\">=</span>/usr<span class=\"w\"> </span>\u2013datadir<span class=\"o\">=</span>/var/lib/mysql<span class=\"w\"> </span>\u2013user<span class=\"o\">=</span>mysql<span class=\"w\"> </span>\u2013pid-file<span class=\"o\">=</span>/var/run/mysqld/mysqld.pid<span class=\"w\"> </span>\u2013skip-locking<span class=\"w\"> </span>\u2013socket<span class=\"o\">=</span>/var/lib/mysql/mysql.sock\n\n\n<span class=\"c1\"># fuser -4 -n tcp 80</span>\nhere:<span class=\"w\"> </span><span class=\"m\">80</span>\n<span class=\"m\">80</span>/tcp:<span class=\"w\"> </span><span class=\"m\">5685</span><span class=\"w\"> </span><span class=\"m\">5688</span><span class=\"w\"> </span><span class=\"m\">5689</span><span class=\"w\"> </span><span class=\"m\">5690</span><span class=\"w\"> </span><span class=\"m\">5691</span><span class=\"w\"> </span><span class=\"m\">5692</span><span class=\"w\"> </span><span class=\"m\">5693</span><span class=\"w\"> </span><span class=\"m\">5694</span><span class=\"w\"> </span><span class=\"m\">5695</span>\n</code></pre></div>\n<h3 id=\"fxload\">fxload<a class=\"headerlink\" href=\"#fxload\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a EZ-USB \u8bbe\u522b\u4e0b\u8f7d firmware\u3002</p>\n<h2 id=\"sbin-g\">/sbin \u4e0b g \u5f00\u5934\u7684\u547d\u4ee4\uff1a<a class=\"headerlink\" href=\"#sbin-g\" title=\"Permanent link\">&para;</a></h2>\n<blockquote>\n<p>generate-modprobe.conf getkey grub grub-install grub-terminfo genhostid\ngetmd grubby grub-md5-crypt</p>\n</blockquote>\n<h3 id=\"generate-modprobeconf\">generate-modprobe.conf<a class=\"headerlink\" href=\"#generate-modprobeconf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5c06\u539f\u6765\u7684 module.conf \u6587\u4ef6\u8fc1\u79fb\u5230 modprobe.conf \u6587\u4ef6\u3002\u8fd9\u662f 2.4 \u5185\u6838\u5230 2.6 \u5185\u6838\u540e\u9a71\u52a8\u6a21\u5757\u914d\u7f6e\u7684\u4e00\u4e2a\u6539\u53d8\u3002</p>\n<h3 id=\"getkey\">getkey<a class=\"headerlink\" href=\"#getkey\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u5185\u7b49\u5f85\u6309\u952e\uff0c\u9ed8\u8ba4\u65f6\u95f4\u5355\u4f4d\u662f\u79d2\u3002\u6bd4\u5982\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># getkey -c 5 -m &quot;Please input a number within 5s[%d]:&quot;</span>\nPlease<span class=\"w\"> </span>input<span class=\"w\"> </span>a<span class=\"w\"> </span>number<span class=\"w\"> </span>within<span class=\"w\"> </span>5s<span class=\"o\">[</span><span class=\"m\">5</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>\u540e\u9762\u7684<code>[]</code>\u5185\u7684\u65f6\u95f4\u662f\u53d8\u5316\u7684\u3002</p>\n<h3 id=\"grub\">grub<a class=\"headerlink\" href=\"#grub\" title=\"Permanent link\">&para;</a></h3>\n<p>grub, grub-install ,grub-terminfo, grub-md5-crypt,grubby \u8fd9\u8fd9\u4e9b\u547d\u4ee4\u90fd\u662f\u548c grub \u6709\u5173\u7684\u3002</p>\n<h3 id=\"genhostid\">genhostid<a class=\"headerlink\" href=\"#genhostid\" title=\"Permanent link\">&para;</a></h3>\n<p>\u968f\u673a\u751f\u6210\u4e00\u4e2a hostid \u53f7\uff0c\u5982\u679c <code>/etc/hostid</code> \u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u4ed6\u548c\u6211\u4eec\u901a\u5e38\u4f7f\u7528\u7684 hostid(1)\u6709\u4e9b\u5fae\u5999\u7684\u5173\u7cfb\u3002</p>\n<p>\u5982\u679c <code>/etc/hostid</code> \u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219 hostid \u547d\u4ee4\u6253\u5370\u51fa\u5f53\u524d\u673a\u5668\u7684\u6807\u5fd7\u53f7\uff0c\u53ea\u8981\u4f60\u7684\u673a\u5668\u786c\u4ef6\u8bbe\u5907\u6ca1\u6709\u66f4\u6362\uff0c\u8fd9\u4e2a ID \u53f7\u5c31\u4e0d\u4f1a\u6539\u53d8\uff0c\u5f88\u591a\u60c5\u51b5\u4e0b\u8fd9\u4e2a\u53f7\u7801\u548c\u4f60\u7684\u7f51\u5361\u6709\u4e00\u5b9a\u7684\u5173\u7cfb\u3002  </p>\n<p>\u4e8e\u662f\u5728 Linux \u4e0b\uff0c\u5f88\u591a\u8f6f\u4ef6\u7684\u6388\u6743\u53f7\u7801\u5c31\u4e8e hostid \u6709\u5173\u7cfb\uff0c\u56e0\u4e3a\u4e0d\u540c\u7684\u673a\u5668 hostid \u4e0d\u540c\uff0c\u8fd9\u6837\u80fd\u4fdd\u8bc1\u53ea\u6709\u6388\u6743\u7684\u673a\u5668\u624d\u80fd\u5b89\u88c5\u5bf9\u5e94\u7684\u8f6f\u4ef6\u3002  </p>\n<p>\u4f46\u662f\u5982\u679c <code>/etc/hostid</code> \u6587\u4ef6\u5b58\u5728, hostid \u547d\u4ee4\u5219\u53ea\u662f\u6253\u5370\u51fa\u8be5\u53f7\u7801\uff0c\u800c <code>/etc/hostid</code> \u7684\u751f\u6210\u5c31\u662f\u4f9d\u8d56 genhostid \u547d\u4ee4\u3002  </p>\n<p>\u4f46\u662f\u6211\u521a\u624d\u8bf4\u4e86\uff0cgenhostid \u662f\u968f\u673a\u4ea7\u751f\u4e00\u4e2a hostid \u53f7\u3002\n\u56e0\u6b64\u5982\u679c\u4f60\u5e0c\u671b hostid \u547d\u4ee4\u6bcf\u6b21\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c\uff0c\u90a3\u4e48\u4f60\u5c31\u5e94\u8be5\u6bcf\u6b21\u90fd\u91cd\u65b0\u751f\u6210 /etc/hostid \u6587\u4ef6\u3002\u4e0d\u8fc7\u8981\u6ce8\u610f\u7684\u662f hostid \u547d\u4ee4\u751f\u6210\u7684 hostid \u53f7\u53ea\u6709 6 \u4f4d\uff0c\u800c genhostid \u4ea7\u751f\u7684\u662f 8 \u4f4d\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># hostid</span>\n7f0100\n\n<span class=\"c1\"># genhostid</span>\n<span class=\"c1\"># hostid</span>\n804937a4\n\n<span class=\"c1\"># rm -f /etc/hostid</span>\n<span class=\"c1\"># hostid</span>\n7f0100\n\n<span class=\"c1\"># genhostid</span>\n<span class=\"c1\"># hostid</span>\n106a8419\n\n<span class=\"c1\"># hexdump /etc/hostid</span>\n<span class=\"m\">0000000</span><span class=\"w\"> </span><span class=\"m\">8419</span><span class=\"w\"> </span>106a\n<span class=\"m\">0000004</span>\n</code></pre></div>\n<p>\u4ece hexdump \u547d\u4ee4\u7684\u7ed3\u679c\u6765\u770b\uff0c<code>/etc/hostid</code> \u6587\u4ef6\u7ed3\u6784\u4f3c\u4e4e\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u5c1d\u8bd5\u83b7\u5f97\u4e00\u4e2a\u6211\u4eec\u9700\u8981\u7684\u201c\u968f\u673a\u201dhostid \u53f7\u8bd5\u8bd5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// myhostid.c</span>\n<span class=\"cp\">#include</span>\n<span class=\"cp\">#include</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">fd1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"err\">\u00d7</span><span class=\"mi\">12345678</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">//my hostid</span>\n<span class=\"w\">    </span><span class=\"n\">fd1</span><span class=\"o\">=</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"err\">\u201c</span><span class=\"n\">hostid</span><span class=\"err\">\u201d</span><span class=\"p\">,</span><span class=\"n\">O_CREAT</span><span class=\"o\">|</span><span class=\"n\">O_WRONLY</span><span class=\"p\">,</span><span class=\"mo\">0220</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">fd1</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">perror</span><span class=\"p\">(</span><span class=\"err\">\u201c</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"w\"> </span><span class=\"err\">\u201c</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">exit</span><span class=\"p\">(</span><span class=\"mi\">65</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">fd1</span><span class=\"p\">,</span><span class=\"o\">&amp;</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">fd1</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># gcc myhostid.c -o myhostid</span>\n<span class=\"c1\"># ./myhostid</span>\n\n<span class=\"c1\"># #cp -f hostid /etc/hostid</span>\n<span class=\"c1\"># hostid</span>\nd2bdd8ed\n\n<span class=\"c1\"># cp -f hostid /etc/hostid</span>\n<span class=\"c1\"># hostid</span>\n<span class=\"m\">12345678</span>\n</code></pre></div>\n<h3 id=\"getmd\">getmd<a class=\"headerlink\" href=\"#getmd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5206\u6790<code>/etc/raidtab</code>\u6587\u4ef6\uff0c\u5b83\u662f scsirastools \u5305\u4e2d\u4e00\u4e2a\u547d\u4ee4\uff0c\u8fd9\u4e2a\u5305\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u589e\u52a0\u4e00\u4e9b\u7ba1\u7406 scsi \u8bbe\u5907\u7684\u547d\u4ee4\uff0c\u6709\u4e0b\u9762\u4e00\u4e9b\uff1a</p>\n<ul>\n<li><code>sgdskfl</code>:   to load disk firmware to disks under Linux  </li>\n<li><code>sgmode</code>:   to get and set SCSI mode pages  </li>\n<li><code>sgdefects</code>:   to read the primary and grown defect lists  </li>\n<li><code>sgdiag</code>:   to perform format &amp; other test functions  </li>\n<li><code>sgraidmon</code>:   to monitor software RAID disks for hot-insertion/removal  </li>\n<li><code>getmd</code>:   to parse /etc/raidtab for devices (used in mdmon only)  </li>\n<li><code>mdadm</code>:   to administer the md raid configuration  </li>\n<li><code>alarms</code>:   to set disk fault LEDs on mBMC platforms</li>\n</ul>\n<h2 id=\"sbin-h\">/sbin \u4e0b h \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-h\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"halt\">halt<a class=\"headerlink\" href=\"#halt\" title=\"Permanent link\">&para;</a></h3>\n<p>\u505c\u6b62\u7cfb\u7edf\uff0c\u4ed6\u548c reboot\uff0cpoweroff \u7b49\u547d\u4ee4\u5c5e\u4e8e\u540c\u4e00\u4e2a\u529f\u80fd\u96c6\u3002</p>\n<p>halt \u547d\u4ee4\u4e0d\u4e0d\u63a5\u53c2\u6570\uff0c\u4ec5\u4ec5\u6709\u51e0\u4e2a\u9009\u9879\u6765\u51b3\u5b9a\u5982\u4f55\u505c\u6b62\u7cfb\u7edf</p>\n<ul>\n<li><code>-n</code>: \u505c\u6b62\u7cfb\u7edf\u524d\u4e0d\u505a\u540c\u6b65(sync)\uff0c\u9002\u5408\u5feb\u901f\u5173\u673a\u548c\u90a3\u4e9b\u4ec5\u4ec5\u53ea\u6709\u53ea\u8bfb\u8bbf\u95ee\u7684\u7cfb\u7edf\u3002  </li>\n<li><code>-w</code>: \u4ec5\u5728 wtmp \u6587\u4ef6\u4e2d\u5199\u4e00\u6761 reboot \u8bb0\u5f55\uff0c\u7136\u540e\u9000\u51fa\uff0c\u4ed6\u7684\u7528\u5904\u662f\u4ec0\u4e48\uff1f  </li>\n<li><code>-d</code>: \u4e0d\u5199 reboot \u8bb0\u5f55\u5230 wtmp \u6587\u4ef6\u4e2d  </li>\n<li><code>-f</code>: \u5f3a\u5236\u505c\u673a/\u91cd\u542f\uff0c\u4f46\u4e0d\u8c03\u7528 shutdown.shutdown \u662f\u4e00\u79cd\u5b89\u5168\u7684\u5173\u95ed\u7cfb\u7edf\u7684\u65b9\u5f0f\u3002  </li>\n<li><code>-p</code>: \u5982\u679c\u652f\u6301\uff0c\u7cfb\u7edf\u5173\u95ed\u540e\u6389\u7535\u3002\u5426\u5219\u53ea\u662f\u505c\u6b62\u7cfb\u7edf.</li>\n</ul>\n<h3 id=\"hdparm\">hdparm<a class=\"headerlink\" href=\"#hdparm\" title=\"Permanent link\">&para;</a></h3>\n<p>\u83b7\u53d6\u548c\u8bbe\u7f6e\u786c\u76d8\u53c2\u6570\uff0c\u5f53\u6211\u4e00\u6b21\u770b\u5230 hdparm \u547d\u4ee4\u548c\u5176\u8bf4\u660e\u65f6\uff0c\u6211\u4ee5\u4e3a\u6211\u53d1\u73b0\u4e86\u4e00\u4e2a\u79d8\u7b08\uff0c\u56e0\u4e3a\u8bf4\u660e\u4e2d\u63d0\u5230\uff0c\u4ed6\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e9b\u5173\u952e\u7684\u53c2\u6570\uff0c\u8ba9\u4f60\u7684\u786c\u76d8\u63d0\u901f\u3002\n\u540c\u65f6\u5728\u7f51\u4e0a\u4e5f\u627e\u5230\u4e86\u4e0d\u5c11\u6709\u5173\u8fd9\u4e2a\u547d\u4ee4\u7684\u4ecb\u7ecd\uff0c\u5927\u591a\u6570\u90fd\u8bf4\u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u786c\u76d8\u54cd\u5e94\u901f\u5ea6\uff0c\u8fd8\u6709\u5f88\u591a\u4eba\u7684\u6807\u9898\u5e72\u8106\u662f\u201c\u77ac\u95f4\u63d0\u9ad8\u4f60\u7684 Linux \u7684\u901f\u5ea6\u201d\u3002\n\u5176\u5b9e\u5927\u90e8\u5206\u4ecb\u7ecd\u4e2d\uff0c\u4e3b\u8981\u662f\u4fee\u6539\u4e24\u4e2a\u53c2\u6570\uff0c\u4e00\u4e2a\u662f\u8bbe\u7f6e DMA \u4e3a enable\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u8bbe\u7f6e I/0 \u4e3a 32 \u4f4d\u3002<br />\n\u6211\u6d4b\u8bd5\u8fc7\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u5bf9\u786c\u76d8\u7684\u54cd\u5e94\u901f\u5ea6\u786e\u5b9e\u6709\u5f88\u5927\u7684\u5f71\u54cd\uff0c\u7279\u522b\u662f DMA \u7684\u8bbe\u7f6e\uff0c\u6709\u76f8\u5dee\u597d\u51e0\u500d\u7684\u6548\u679c\u3002  </p>\n<p>\u7136\u540e\u5b9e\u9645\u4e0a\uff0c\u540e\u6765\u7684 Linux \u5206\u53d1\u7248\u672c\uff0c\u5bf9\u4e8e\u786c\u76d8\u7684\u4f18\u5316\u65e9\u5728\u7cfb\u7edf\u542f\u52a8\u4e2d\u5c31\u5df2\u7ecf\u505a\u597d\u4e86\u3002  </p>\n<p>\u800c\u6211\u77e5\u9053\u7684\u662f\uff0c\u4ec5\u4ec5\u53ea\u6709 2.2 \u7684\u5185\u6838\u9ed8\u8ba4\u662f\u4e0d\u6253\u5f00 DMA \u6a21\u5f0f\u7684\uff0c\u56e0\u6b64\u5728 2.2 \u7684\u5185\u6838\uff0c\u5229\u7528<code>hdparm -c 1 /dev/hdx</code>\u7684\u65b9\u5f0f\u6765\u63d0\u9ad8\u786c\u76d8\u54cd\u5e94\u901f\u5ea6\u662f\u6709\u6548\u679c\u7684\uff0c\u4f46\u662f 2.2 \u7684\u5185\u6838\u6bd5\u7adf\u662f\u53e4\u8463\u4e86\u3002  </p>\n<p>\u53e6\u5916 hdparm \u7684 man \u63d0\u5230 hdparm \u4ec5\u4ec5\u53ea\u662f\u8bbe\u7f6e ATA/IDE \u786c\u76d8\u53c2\u6570\uff0c\u800c\u5bf9 SCSI \u786c\u76d8\u662f\u6ca1\u6709\u7528\u7684\uff0c\u5f53\u7136\u4e5f\u5bf9\u540e\u6765\u51fa\u73b0\u7684 SATA,SAS \u786c\u76d8\u65e0\u6548\u4e86\u3002 \n\u6211\u6ca1\u6709\u6d4b\u8bd5\u8fc7 SCSI \u786c\u76d8\uff0c\u4e5f\u6ca1\u6709\u6d4b\u8bd5\u8fc7 SATA,SAS \u786c\u76d8\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u4e0d\u80fd\u7ed9\u51fa\u4e00\u4e2a\u786e\u5207\u7684\u7b54\u6848\u3002</p>\n<p>\u6211\u4eec\u770b\u770b\u540e\u6765\u7684 linux \u7248\u672c\u662f\u5982\u4f55\u5728\u542f\u52a8\u662f\u9488\u5bf9\u4e0d\u540c\u786c\u76d8\u505a\u7684\u4f18\u5316\u7684\uff0c\u4e0b\u9762\u7684\u811a\u672c\u7247\u6bb5\u6765\u81ea <code>/etc/rc.d/rc.sysinit</code> \u6587\u4ef6</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># Turn on harddisk optimization</span>\n<span class=\"c1\"># There is only one file /etc/sysconfig/harddisks for all disks</span>\n<span class=\"c1\"># after installing the hdparm-RPM. If you need different hdparm parameters</span>\n<span class=\"c1\"># for each of your disks, copy /etc/sysconfig/harddisks to</span>\n<span class=\"c1\"># /etc/sysconfig/harddiskhda (hdb, hdc\u2026) and modify it.</span>\n<span class=\"c1\"># Each disk which has no special parameters will use the defaults.</span>\n<span class=\"c1\"># Each non-disk which has no special parameters will be ignored.</span>\n<span class=\"c1\">#</span>\n\ndisk<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]=</span>s<span class=\"p\">;</span>\ndisk<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]=</span>hda<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]=</span>hdb<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]=</span>hdc<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">4</span><span class=\"o\">]=</span>hdd<span class=\"p\">;</span>\ndisk<span class=\"o\">[</span><span class=\"m\">5</span><span class=\"o\">]=</span>hde<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">6</span><span class=\"o\">]=</span>hdf<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">7</span><span class=\"o\">]=</span>hdg<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">8</span><span class=\"o\">]=</span>hdh<span class=\"p\">;</span>\ndisk<span class=\"o\">[</span><span class=\"m\">9</span><span class=\"o\">]=</span>hdi<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">10</span><span class=\"o\">]=</span>hdj<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">11</span><span class=\"o\">]=</span>hdk<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">12</span><span class=\"o\">]=</span>hdl<span class=\"p\">;</span>\ndisk<span class=\"o\">[</span><span class=\"m\">13</span><span class=\"o\">]=</span>hdm<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">14</span><span class=\"o\">]=</span>hdn<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">15</span><span class=\"o\">]=</span>hdo<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">16</span><span class=\"o\">]=</span>hdp<span class=\"p\">;</span>\ndisk<span class=\"o\">[</span><span class=\"m\">17</span><span class=\"o\">]=</span>hdq<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">18</span><span class=\"o\">]=</span>hdr<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">19</span><span class=\"o\">]=</span>hds<span class=\"p\">;</span><span class=\"w\"> </span>disk<span class=\"o\">[</span><span class=\"m\">20</span><span class=\"o\">]=</span>hdt<span class=\"p\">;</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-x<span class=\"w\"> </span>/sbin/hdparm<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span>device<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"w\"> </span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"m\">19</span><span class=\"w\"> </span><span class=\"m\">20</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"nb\">unset</span><span class=\"w\"> </span>MULTIPLE_IO<span class=\"w\"> </span>USE_DMA<span class=\"w\"> </span>EIDE_32BIT<span class=\"w\"> </span>LOOKAHEAD<span class=\"w\"> </span>EXTRA_PARAMS\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-f<span class=\"w\"> </span>/etc/sysconfig/harddisk<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>.<span class=\"w\"> </span>/etc/sysconfig/harddisk<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"nv\">$MULTIPLE_IO</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d-q<span class=\"w\"> </span>-m<span class=\"nv\">$MULTIPLE_IO</span>\u201d\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"nv\">$USE_DMA</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span>-q<span class=\"w\"> </span>-d<span class=\"nv\">$USE_DMA</span>\u201d\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"nv\">$EIDE_32BIT</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span>-q<span class=\"w\"> </span>-c<span class=\"nv\">$EIDE_32BIT</span>\u201d\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"nv\">$LOOKAHEAD</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span>-q<span class=\"w\"> </span>-A<span class=\"nv\">$LOOKAHEAD</span>\u201d\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"nv\">$EXTRA_PARAMS</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"nv\">$EXTRA_PARAMS</span>\u201d\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">            </span>HDFLAGS<span class=\"o\">[</span><span class=\"nv\">$device</span><span class=\"o\">]=</span>\u201d<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[0]</span><span class=\"si\">}</span>\u201d\n<span class=\"w\">        </span><span class=\"k\">fi</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-e<span class=\"w\"> </span>\u201c/proc/ide/<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>/media\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"nv\">hdmedia</span><span class=\"o\">=</span><span class=\"sb\">`</span>cat<span class=\"w\"> </span>/proc/ide/<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>/media<span class=\"sb\">`</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>\u201c<span class=\"nv\">$hdmedia</span>\u201d<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>\u201cdisk\u201d<span class=\"w\"> </span>-o<span class=\"w\"> </span>-f<span class=\"w\"> </span>\u201c/etc/sysconfig/harddisk<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span>\u201c<span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>\u201d<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">                    </span>action<span class=\"w\"> </span>$\u201dSetting<span class=\"w\"> </span>hard<span class=\"w\"> </span>drive<span class=\"w\"> </span>parameters<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>:<span class=\"w\"> </span>\u201d<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">                        </span>/sbin/hdparm<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">HDFLAGS</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"w\"> </span>/dev/<span class=\"si\">${</span><span class=\"nv\">disk</span><span class=\"p\">[</span><span class=\"nv\">$device</span><span class=\"p\">]</span><span class=\"si\">}</span>\n<span class=\"w\">                </span><span class=\"k\">fi</span>\n<span class=\"w\">            </span><span class=\"k\">fi</span>\n<span class=\"w\">        </span><span class=\"k\">fi</span>\n<span class=\"w\">    </span><span class=\"k\">done</span>\n<span class=\"k\">fi</span>\n</code></pre></div>\n<p>\u8fd9\u6bb5\u811a\u672c\u662f\u6240\u6709\u7684 IDE \u786c\u76d8\uff0c\u6839\u636e <code>/etc/sysconfig/harddisks</code> \u6587\u4ef6\u7684\u7b56\u7565\u800c\u8bbe\u7f6e\u786c\u76d8\u7684\u53c2\u6570. \n\u4ece\u8fd9\u91cc\u6211\u4eec\u4f3c\u4e4e\u53ef\u4ee5\u770b\u51fa\uff0csdx \u8bbe\u5907\u5e76\u4e0d\u518d\u8bbe\u7f6e\u4e4b\u5185\uff0c\u7531\u6b64\u662f\u4e0d\u662f\u53ef\u4ee5\u80af\u5b9a hdparm \u5bf9 SCSI \u8bbe\u5907\u4e0d\u652f\u6301\u5462\uff1f\n\u6211\u4eec\u518d\u770b\u770b harddisks \u6587\u4ef6</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">#</span>\n<span class=\"c1\"># WARNING !!!</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># The kernel will autodetect the correct settings for most drives.</span>\n<span class=\"c1\"># Overriding these settings with hdparm can cause data corruption and/or</span>\n<span class=\"c1\"># data loss.</span>\n<span class=\"c1\"># Leave this file as it is unless you know exactly what you&#39;re doing !!</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># These options are used to tune the hard drives -</span>\n<span class=\"c1\"># read the hdparm man page for more information</span>\n\n<span class=\"c1\"># Set this to 1 to enable DMA. This might cause some</span>\n<span class=\"c1\"># data corruption on certain chipset / hard drive</span>\n<span class=\"c1\"># combinations. This is used with the \u201c-d\u201d option</span>\n\n<span class=\"c1\"># USE_DMA=1</span>\n\n<span class=\"c1\"># Multiple sector I/O. a feature of most modern IDE hard drives,</span>\n<span class=\"c1\"># permitting the transfer of multiple sectors per I/O interrupt,</span>\n<span class=\"c1\"># rather than the usual one sector per interrupt. When this feature</span>\n<span class=\"c1\"># is enabled, it typically reduces operating system overhead for disk</span>\n<span class=\"c1\"># I/O by 30-50%. On many systems, it also provides increased data</span>\n<span class=\"c1\"># throughput of anywhere from 5% to 50%. Some drives, however (most</span>\n<span class=\"c1\"># notably the WD Caviar series), seem to run slower with multiple mode</span>\n<span class=\"c1\"># enabled. Under rare circumstances, such failures can result in</span>\n<span class=\"c1\"># massive filesystem corruption. USE WITH CAUTION AND BACKUP.</span>\n<span class=\"c1\"># This is the sector count for multiple sector I/O \u2013 the \u201c-m\u201d option</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># MULTIPLE_IO=16</span>\n\n<span class=\"c1\"># (E)IDE 32-bit I/O support (to interface card)</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># EIDE_32BIT=3</span>\n\n<span class=\"c1\"># Enable drive read-lookahead</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># LOOKAHEAD=1</span>\n\n<span class=\"c1\"># Add extra parameters here if wanted</span>\n<span class=\"c1\"># On reasonably new hardware, you may want to try -X66, -X67 or -X68</span>\n<span class=\"c1\"># Other flags you might want to experiment with are -u1, -a and -m</span>\n<span class=\"c1\"># See the hdparm manpage (man hdparm) for details and more options.</span>\n<span class=\"c1\">#</span>\n<span class=\"na\">EXTRA_PARAMS</span><span class=\"o\">=</span>\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u6587\u4ef6\u7684\u6ce8\u91ca\u6211\u4eec\u80fd\u591f\u770b\u51fa\uff0c\u5b83\u5c06\u5f71\u54cd\u786c\u76d8\u6548\u679c\u6700\u660e\u663e\u7684\u53c2\u6570\u5355\u72ec\u5217\u4e86\u51fa\u6765\uff0c\u800c\u5c06\u5176\u4ed6\u53c2\u6570\u653e\u5230\u4e86 EXTRA_PARAMS \u91cc\u3002  </p>\n<p>\u56e0\u6b64\u5bf9\u4e8e hdparm \u547d\u4ee4\u7684\u4f17\u591a\u53c2\u6570\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u53bb\u4e86\u89e3\u7684\u4e0d\u592a\u591a\u3002  </p>\n<h3 id=\"hotplug\">hotplug<a class=\"headerlink\" href=\"#hotplug\" title=\"Permanent link\">&para;</a></h3>\n<p>Linux \u4e0b\u70ed\u63d2\u62d4\u652f\u6301\u811a\u672c\u3002  </p>\n<h3 id=\"hwclock\">hwclock<a class=\"headerlink\" href=\"#hwclock\" title=\"Permanent link\">&para;</a></h3>\n<p>\u67e5\u8be2\u548c\u8bbe\u7f6e\u786c\u4ef6\u65f6\u949f(RTC).\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u9700\u8981\u4ece\u786c\u4ef6\u65f6\u949f\u4e2d\u8bfb\u51fa\u65f6\u95f4\u6765\u8bbe\u7f6e\u7cfb\u7edf\u7cfb\u7edf\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5728<code>/etc/rc.d/rc.sysinit</code> \u811a\u672c\u4e2d\u91c7\u7528<code>hwclock $CLOCKFLAGS</code>\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u3002</p>\n<p>\u8fd9\u91cc\u7684\u53c2\u6570 <code>$CLOCKFLAGS</code> \u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f <code>--hctosys</code>,\u8868\u793a\u540c\u6b65\u7684\u65b9\u5f0f\u662f\u786c\u4ef6\u65f6\u949f\u5230\u7cfb\u7edf\u65f6\u949f\u3002\u53e6\u5916\u4e00\u90e8\u5206\u53c2\u6570\u662f\u65f6\u95f4\u8bbe\u7f6e\u7684\u6807\u51c6\uff0c\u662f\u6807\u51c6\u65f6\u95f4\uff08utc\uff09\uff0c\u8fd8\u662f\u672c\u5730\u65f6\u95f4(localtim). </p>\n<p>\u800c\u5173\u95ed\u7cfb\u7edf\u65f6\uff0c\u5219\u76f8\u53cd\uff0c\u4f3c\u4e4e\u7528 <code>-systohc</code> \u7684\u53c2\u6570\u6765\u5c06\u7cfb\u7edf\u65f6\u949f\u540c\u6b65\u5230\u786c\u4ef6\u65f6\u949f\u3002</p>\n<h2 id=\"sbin-l\">/sbin/\u4e0b l \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-l\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0d\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p>\n<blockquote>\n<p>ldconfig lilo logsave loopctrl losetup lsmod lspci lsusb lvm lvm.static</p>\n</blockquote>\n<p>\u5176\u4e2d lvm \u662f lvm.static \u7684\u8f6f\u8fde\u63a5\u3002</p>\n<h3 id=\"ldconfig\">ldconfig<a class=\"headerlink\" href=\"#ldconfig\" title=\"Permanent link\">&para;</a></h3>\n<p>\u914d\u7f6e\u52a8\u6001\u8fde\u63a5\u5e93\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u5728\u7f16\u8bd1\u548c\u8fd0\u884c\u4e2d\u52a8\u6001\u8fde\u63a5\u8fd9\u4e9b\u7a0b\u5e8f\u5e93\u3002\u4e0e\u6b64\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u4fbf\u662f <code>/etc/ld.so.conf</code>\uff0c\n\u540e\u6765\u7684 ldconfig \u7684\u914d\u7f6e\u6587\u4ef6\u91c7\u53d6\u4e86\u73b0\u5728\u6d41\u884c\u7684\u8bfb\u53d6\u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u6240\u4ee5 <code>/etc/ld.so.conf.d</code>\u76ee\u5f55\u4fbf\u662f\u540e\u6765\u589e\u52a0\u7684\u3002</p>\n<p>\u6211\u4ec5\u4ec5\u4f7f\u7528 ldconfig \u7684\u4e00\u4e2a\u53c2\u6570-f\uff0c\u5c31\u662f\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u6837\u7684\u597d\u5904\u662f\uff0c\u5f53\u6211\u9700\u8981\u589e\u52a0\u67d0\u4e00\u4e2a\u76ee\u5f55\u7684\u52a8\u6001\u5e93\u65f6\uff0c\u6211\u4e0d\u8981\u5168\u90e8\u91cd\u5efa\u52a8\u6001\u5e93\u7f13\u5b58\uff0c\u547d\u4ee4\u7a0b\u5e8f\u8fd0\u884c\u65f6\u95f4\u77ed\u4e86\u5f88\u591a\u3002</p>\n<h3 id=\"lilo\">lilo<a class=\"headerlink\" href=\"#lilo\" title=\"Permanent link\">&para;</a></h3>\n<p>grub \u4e4b\u524d\u7684\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u4e0d\u77e5\u9053\u73b0\u5728\u8fd8\u6709\u591a\u5c11\u53d1\u884c\u7248\u672c\u4f7f\u7528\u4ed6,\u7559\u7740\u4ed6\u7684\u4e00\u4e2a\u597d\u5904\u662f\uff0c\u5f53\u6211\u4e22\u5931\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u800c grub \u53c8\u5b89\u88c5\u4e0d\u4e0a\u65f6\uff0clilo \u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u51fa\u9a6c\u4e86\uff0c\u800c lilo \u6bcf\u6b21\u90fd\u6ca1\u6709\u8ba9\u6211\u5931\u671b\uff0c\u6240\u4ee5\u6211\u5bf9\u4ed6\u7684\u5370\u8c61\u4e0d\u9519\u3002</p>\n<h3 id=\"logsave\">logsave<a class=\"headerlink\" href=\"#logsave\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e5\u5fd7\u8bb0\u5f55\u7a0b\u5e8f\uff0c\u53c2\u6570\u65b9\u5f0f\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>logsave<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-asv<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>logfile<span class=\"w\"> </span>cmd_prog<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>...<span class=\"w\"> </span><span class=\"o\">]</span>\n</code></pre></div>\n<ul>\n<li><code>-a</code>: \u662f\u91c7\u7528\u9644\u52a0\u7684\u6a21\u5f0f\u5199\u5165\u65e5\u5fd7\u6587\u4ef6 logfile  </li>\n<li><code>-s</code>: \u5199\u65e5\u5fd7\u5230\u7528\u6237\u7ec8\u7aef  </li>\n<li><code>-v</code>: \u5c31\u662f\u5197\u4f59\u8f93\u51fa</li>\n</ul>\n<p>\u7ed9\u6211\u7684\u611f\u89c9\u4ed6\u7684\u4f5c\u7528\u7c7b\u4f3c\u91cd\u5b9a\u5411\uff0c\u6bd4\u5982</p>\n<div class=\"highlight\"><pre><span></span><code>cmd_prog<span class=\"w\"> </span>&gt;logfile<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span>\n</code></pre></div>\n<h3 id=\"loopctrl\">loopctrl<a class=\"headerlink\" href=\"#loopctrl\" title=\"Permanent link\">&para;</a></h3>\n<p>\u914d\u7f6e isdnloop ISDN \u9a71\u52a8\uff0c\u8fd9\u5e94\u8be5\u7b97\u662f\u4e00\u4e2a\u7528\u6237\u9057\u7559\u4ea7\u54c1\u3002</p>\n<h3 id=\"lsmod\">lsmod<a class=\"headerlink\" href=\"#lsmod\" title=\"Permanent link\">&para;</a></h3>\n<p>\u663e\u793a\u76ee\u524d\u52a0\u8f7d\u7684\u5185\u6838\u6a21\u5757\u72b6\u6001</p>\n<h3 id=\"lspci\">lspci<a class=\"headerlink\" href=\"#lspci\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5217\u51fa\u6240\u6709\u7684 PCI \u8bbe\u5907\uff0c\u8fd9\u4e2a\u547d\u4ee4\u6211\u7528\u5f97\u6bd4\u8f83\u5c11</p>\n<h3 id=\"lsusb\">lsusb<a class=\"headerlink\" href=\"#lsusb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5217\u51fa\u6240\u6709\u7684 usb \u9a71\u52a8</p>\n<h3 id=\"lvm\">lvm<a class=\"headerlink\" href=\"#lvm\" title=\"Permanent link\">&para;</a></h3>\n<p>lvm,lvm.static \u903b\u8f91\u5377\u7ba1\u7406\u7a0b\u5e8f\u7a0b\u5e8f, \u4ed6\u5176\u5b9e\u5305\u62ec\u4e86\u4e00\u7cfb\u5217\u7684\u5b50\u547d\u4ee4\uff0c\u6bd4\u5982 </p>\n<ul>\n<li>pvscan</li>\n<li>pvcreate</li>\n<li>pvdisplay</li>\n<li>vgscan</li>\n<li>vgcreate</li>\n<li>vgchange</li>\n<li>vgdisplay</li>\n<li>lvscan</li>\n<li>lvcreate</li>\n<li>lvdisplay </li>\n</ul>\n<p>\u7b49\uff0c\u8fd9\u4e9b\u5b50\u547d\u4ee4\u4e5f\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4ece\u4e00\u4e2a\u521d\u59cb\u7684\u786c\u76d8\u5f00\u59cb\u5230\u521b\u5efa\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u5e76\u6302\u8f7d\u7684\u7b80\u5355\u6b65\u9aa4\u662f:(\u6211\u8fd9\u91cc\u7528 /dev/ram0 \u6765\u66ff\u4ee3\u786c\u76d8)</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># pvcreate /dev/ram0</span>\nPhysical<span class=\"w\"> </span>volume<span class=\"w\"> </span>\u201c/dev/ram0\u2033<span class=\"w\"> </span>successfully<span class=\"w\"> </span>created\n\n<span class=\"c1\"># vgcreate vgname /dev/ram0</span>\nVolume<span class=\"w\"> </span>group<span class=\"w\"> </span>\u201cvgname\u201d<span class=\"w\"> </span>successfully<span class=\"w\"> </span>created\n\n<span class=\"c1\"># vgchange -a y vgname</span>\n<span class=\"m\">0</span><span class=\"w\"> </span>logical<span class=\"w\"> </span>volume<span class=\"o\">(</span>s<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>volume<span class=\"w\"> </span>group<span class=\"w\"> </span>\u201cvgname\u201d<span class=\"w\"> </span>now<span class=\"w\"> </span>active\n\n<span class=\"c1\"># lvcreate -L20M -n lvname vgname</span>\nLogical<span class=\"w\"> </span>volume<span class=\"w\"> </span>\u201clvname\u201d<span class=\"w\"> </span>created\n\n<span class=\"c1\"># mkfs.ext3 /dev/mapper/vgname-lvname</span>\nmke2fs<span class=\"w\"> </span><span class=\"m\">1</span>.39<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">29</span>-May-2006<span class=\"o\">)</span>\nFilesystem<span class=\"w\"> </span><span class=\"nv\">label</span><span class=\"o\">=</span>\nOS<span class=\"w\"> </span>type:<span class=\"w\"> </span>Linux\nBlock<span class=\"w\"> </span><span class=\"nv\">size</span><span class=\"o\">=</span><span class=\"m\">1024</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"nv\">log</span><span class=\"o\">=</span><span class=\"m\">0</span><span class=\"o\">)</span>\nFragment<span class=\"w\"> </span><span class=\"nv\">size</span><span class=\"o\">=</span><span class=\"m\">1024</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"nv\">log</span><span class=\"o\">=</span><span class=\"m\">0</span><span class=\"o\">)</span>\n<span class=\"m\">5136</span><span class=\"w\"> </span>inodes,<span class=\"w\"> </span><span class=\"m\">20480</span><span class=\"w\"> </span>blocks\n<span class=\"m\">1024</span><span class=\"w\"> </span>blocks<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">5</span>.00%<span class=\"o\">)</span><span class=\"w\"> </span>reserved<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>the<span class=\"w\"> </span>super<span class=\"w\"> </span>user\nFirst<span class=\"w\"> </span>data<span class=\"w\"> </span><span class=\"nv\">block</span><span class=\"o\">=</span><span class=\"m\">1</span>\nMaximum<span class=\"w\"> </span>filesystem<span class=\"w\"> </span><span class=\"nv\">blocks</span><span class=\"o\">=</span><span class=\"m\">20971520</span>\n<span class=\"m\">3</span><span class=\"w\"> </span>block<span class=\"w\"> </span>groups\n<span class=\"m\">8192</span><span class=\"w\"> </span>blocks<span class=\"w\"> </span>per<span class=\"w\"> </span>group,<span class=\"w\"> </span><span class=\"m\">8192</span><span class=\"w\"> </span>fragments<span class=\"w\"> </span>per<span class=\"w\"> </span>group\n<span class=\"m\">1712</span><span class=\"w\"> </span>inodes<span class=\"w\"> </span>per<span class=\"w\"> </span>group\nSuperblock<span class=\"w\"> </span>backups<span class=\"w\"> </span>stored<span class=\"w\"> </span>on<span class=\"w\"> </span>blocks:\n<span class=\"m\">8193</span>\n\nWriting<span class=\"w\"> </span>inode<span class=\"w\"> </span>tables:<span class=\"w\"> </span><span class=\"k\">done</span>\nCreating<span class=\"w\"> </span>journal<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">1024</span><span class=\"w\"> </span>blocks<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"k\">done</span>\nWriting<span class=\"w\"> </span>superblocks<span class=\"w\"> </span>and<span class=\"w\"> </span>filesystem<span class=\"w\"> </span>accounting<span class=\"w\"> </span>information:<span class=\"w\"> </span><span class=\"k\">done</span>\n\nThis<span class=\"w\"> </span>filesystem<span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>automatically<span class=\"w\"> </span>checked<span class=\"w\"> </span>every<span class=\"w\"> </span><span class=\"m\">39</span><span class=\"w\"> </span>mounts<span class=\"w\"> </span>or\n<span class=\"m\">180</span><span class=\"w\"> </span>days,<span class=\"w\"> </span>whichever<span class=\"w\"> </span>comes<span class=\"w\"> </span>first.<span class=\"w\"> </span>Use<span class=\"w\"> </span>tune2fs<span class=\"w\"> </span>-c<span class=\"w\"> </span>or<span class=\"w\"> </span>-i<span class=\"w\"> </span>to<span class=\"w\"> </span>override.\n\n<span class=\"c1\"># mount /dev/mapper/vgname-lvname /misc</span>\n\n<span class=\"c1\"># df -h</span>\n\u6587\u4ef6\u7cfb\u7edf<span class=\"w\"> </span>\u5bb9\u91cf<span class=\"w\"> </span>\u5df2\u7528<span class=\"w\"> </span>\u53ef\u7528<span class=\"w\"> </span>\u5df2\u7528%<span class=\"w\"> </span>\u6302\u8f7d\u70b9\n/dev/hda5<span class=\"w\"> </span><span class=\"m\">6</span>.7G<span class=\"w\"> </span><span class=\"m\">2</span>.2G<span class=\"w\"> </span><span class=\"m\">4</span>.2G<span class=\"w\"> </span><span class=\"m\">35</span>%<span class=\"w\"> </span>/\n/dev/hda1<span class=\"w\"> </span>99M<span class=\"w\"> </span>23M<span class=\"w\"> </span>71M<span class=\"w\"> </span><span class=\"m\">25</span>%<span class=\"w\"> </span>/boot\n/dev/shm<span class=\"w\"> </span>248M<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>248M<span class=\"w\"> </span><span class=\"m\">0</span>%<span class=\"w\"> </span>/dev/shm\n/dev/hda3<span class=\"w\"> </span><span class=\"m\">6</span>.8G<span class=\"w\"> </span><span class=\"m\">5</span>.3G<span class=\"w\"> </span><span class=\"m\">1</span>.2G<span class=\"w\"> </span><span class=\"m\">83</span>%<span class=\"w\"> </span>/dc50\n/dev/mapper/vgdata-data\n20G<span class=\"w\"> </span>831M<span class=\"w\"> </span>18G<span class=\"w\"> </span><span class=\"m\">5</span>%<span class=\"w\"> </span>/data\n/dev/mapper/vgname-lvname\n20M<span class=\"w\"> </span><span class=\"m\">1</span>.2M<span class=\"w\"> </span>18M<span class=\"w\"> </span><span class=\"m\">7</span>%<span class=\"w\"> </span>/misc\n</code></pre></div>\n<h2 id=\"sbin-m\">/sbin \u76ee\u5f55\u4e0b m \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-m\" title=\"Permanent link\">&para;</a></h2>\n<p>\u53ef\u4e0d\u5c11</p>\n<div class=\"highlight\"><pre><span></span><code>mdadm<span class=\"w\">          </span>mii-tool<span class=\"w\">    </span>mkfs.cramfs<span class=\"w\">    </span>mkfs.xfs<span class=\"w\">    </span>mounted.ocfs2<span class=\"w\">  </span>mpath_get_name<span class=\"w\">          </span>multipath.static\nmdadm.static<span class=\"w\">   </span>mingetty<span class=\"w\">    </span>mkfs.ext2<span class=\"w\">      </span>mkinitrd<span class=\"w\">    </span>mount.ncp<span class=\"w\">      </span>mpath_prio_alua\nmdassemble<span class=\"w\">     </span>minilogd<span class=\"w\">    </span>mkfs.ext3<span class=\"w\">      </span>mkreiserfs<span class=\"w\">  </span>mount.ncpfs<span class=\"w\">    </span>mpath_prio_emc\nmdevt<span class=\"w\">          </span>mkbootdisk<span class=\"w\">  </span>mkfs.msdos<span class=\"w\">     </span>mkswap<span class=\"w\">      </span>mount.ocfs2<span class=\"w\">    </span>mpath_prio_hds_modular\nmdmpd<span class=\"w\">          </span>mkdosfs<span class=\"w\">     </span>mkfs.ocfs2<span class=\"w\">     </span>mkzonedb<span class=\"w\">    </span>mount.smb<span class=\"w\">      </span>mpath_prio_netapp\nmgetty<span class=\"w\">         </span>mke2fs<span class=\"w\">      </span>mkfs.reiserfs<span class=\"w\">  </span>modinfo<span class=\"w\">     </span>mount.smbfs<span class=\"w\">    </span>multipath\nmicrocode_ctl<span class=\"w\">  </span>mkfs<span class=\"w\">        </span>mkfs.vfat<span class=\"w\">      </span>modprobe<span class=\"w\">    </span>mpath_ctl<span class=\"w\">      </span>multipathd\n</code></pre></div>\n<p>mkfs \u7cfb\u5217\u547d\u4ee4\u5360\u4e86\u5f88\u5927\u4e00\u90e8\u5206\u3002 </p>\n<h3 id=\"mdadm\">mdadm<a class=\"headerlink\" href=\"#mdadm\" title=\"Permanent link\">&para;</a></h3>\n<p>mdadm, mdadm.static \u8fd9\u662f\u548c RAID \u76f8\u5173\u7684\u7a0b\u5e8f\uff0c\u4ed6\u7528\u6765\u7ba1\u7406 Linux \u4e0b\u7684\u8f6f RAID\u3002</p>\n<p>\u5f53\u524d Linux \u63d0\u4f9b\u7684 RAID \u7ea7\u522b\u6709 </p>\n<ul>\n<li>LINEAR md \u8bbe\u5907</li>\n<li>RAID0 (striping)</li>\n<li>RAID1 (mirroring)</li>\n<li>RAID4</li>\n<li>RAID5</li>\n<li>RAID6</li>\n<li>MULTIPATH</li>\n<li>FAULTY</li>\n</ul>\n<p>\u8fd9\u91cc\u8bf4\u7684 multipath \u5176\u5b9e\u5e76\u4e0d\u662f\u8f6f RAID \u673a\u5236\u4e2d\u7684\u4e00\u90e8\u5206\uff0c\u4f46\u662f\u4ed6\u4f1a\u53bb\u8c03\u7528\u3002</p>\n<h3 id=\"mdmpd\">mdmpd<a class=\"headerlink\" href=\"#mdmpd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76d1\u63a7 MD multipath \u8bbe\u5907\u7684 daemon \u7a0b\u5e8f\u3002  </p>\n<h3 id=\"mii-tool\">mii-tool<a class=\"headerlink\" href=\"#mii-tool\" title=\"Permanent link\">&para;</a></h3>\n<p>\u67e5\u770b\uff0c\u7ba1\u7406\u72ec\u7acb\u4ecb\u8d28\u63a5\u53e3\u72b6\u6001\uff0c\u8fd9\u662f\u4e00\u4e2a\u8fc7\u65f6\u7684\u7a0b\u5e8f\u4e86\uff0c\u76ee\u524d\u4ee3\u66ff\u4ed6\u529f\u80fd\u7684\u7a0b\u5e8f\u662f eth-tool\u3002  </p>\n<h3 id=\"mkbootdisk\">mkbootdisk<a class=\"headerlink\" href=\"#mkbootdisk\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5236\u4f5c\u542f\u52a8\u78c1\u76d8\uff0c\u4e0d\u77e5\u9053\u73b0\u5728\u8fd8\u6709\u591a\u5c11\u4eba\u4f7f\u7528\u4ed6\uff0c\u73b0\u5728\u770b\u5230\u7684\u670d\u52a1\u5668\u4f3c\u4e4e\u90fd\u6ca1\u6709\u8f6f\u9a71\u4e86\u3002  </p>\n<h3 id=\"mkfs\">mkfs.*\uff1a<a class=\"headerlink\" href=\"#mkfs\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u662f\u5236\u4f5c\u6587\u4ef6\u7cfb\u7edf\u7684\u7a0b\u5e8f\u96c6\uff0c\u5982\u679c\u4ec0\u4e48\u90fd\u4e0d\u8003\u8651\uff0c\u4ec5\u4ec5\u662f\u5236\u4f5c\u6587\u4ef6\u7cfb\u7edf\u7684\u8bdd\uff0c\u90a3\u76f4\u63a5 mkfs \u4e86\u3002\u4f46\u662f\u5982\u679c\u4f60\u8981\u4ece\u5b58\u50a8\u6570\u636e\u7684\u6027\u8d28\uff0c\u8bfb\u5199\u901f\u5ea6\uff0c\u5b58\u653e\u6587\u4ef6\u4e2a\u6570\u7b49\u65b9\u9762\u7740\u60f3\uff0c\u90a3\u5c31\u4e0d\u5f97\u4e0d\u8003\u8651 mkfs \u547d\u4ee4\u96c6\u7684\u4e00\u4e9b\u53c2\u6570\u4e86\u3002</p>\n<h3 id=\"mkinitrd\">mkinitrd<a class=\"headerlink\" href=\"#mkinitrd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u91cd\u505a\u955c\u50cf\u6587\u4ef6\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5728\u66f4\u65b0\u4e86\u4e00\u4e9b\u6838\u5fc3\u9a71\u52a8\u6a21\u5757\u7684\u65f6\u5019\uff0c\u7528\u5f97\u7740\u3002\n\u6bd4\u5982\u66f4\u65b0\u4e86 SCSI \u5361\u7684\u9a71\u52a8\uff0c\u589e\u52a0\u9a71\u52a8\u6a21\u5757\u7684\u4e00\u4e9b\u53c2\u6570\u7b49\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4fee\u6539\u4e86<code>/etc/modprobe.conf</code> \u4e2d\u5757\u8bbe\u5907\u6587\u4ef6\u7684\u914d\u7f6e\u53c2\u6570\uff0c\u5c31\u5e94\u8be5\u91cd\u65b0\u5236\u4f5c\u955c\u50cf\u6587\u4ef6\uff0c</p>\n<p>\u65b9\u6cd5\u5012\u662f\u5f88\u7b80\u5355 </p>\n<div class=\"highlight\"><pre><span></span><code>mkinitrd<span class=\"w\"> </span>/boot/newinitrd.img<span class=\"w\"> </span><span class=\"sb\">`</span>uname<span class=\"w\"> </span>-r<span class=\"sb\">`</span>\n</code></pre></div>\n<h3 id=\"modinfo\">modinfo<a class=\"headerlink\" href=\"#modinfo\" title=\"Permanent link\">&para;</a></h3>\n<p>\u663e\u793a\u5185\u6838\u6a21\u5757\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5305\u62ec\u4f5c\u8005\uff0c\u63cf\u8ff0\uff0c\u6388\u6743\u65b9\u5f0f\uff0c\u6838\u5fc3\u53c2\u6570\u7b49\uff0c\u5176\u4e2d\u6709\u7684\u8fd8\u5305\u62ec\u4e86\u6a21\u5757\u4f9d\u8d56\u6027\u7684\u63cf\u8ff0\uff0c\u6bd4\u5982:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># modinfo e100.ko</span>\nfilename:<span class=\"w\">       </span>/lib/modules/2.6.9-42.7AX/kernel/drivers/net/e100.ko\ndescription:<span class=\"w\">    </span>Intel<span class=\"o\">(</span>R<span class=\"o\">)</span><span class=\"w\"> </span>PRO/100<span class=\"w\"> </span>Network<span class=\"w\"> </span>Driver\nauthor:<span class=\"w\">         </span>Copyright<span class=\"o\">(</span>c<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"m\">1999</span>-2005<span class=\"w\"> </span>Intel<span class=\"w\"> </span>Corporation\nlicense:<span class=\"w\">        </span>GPL\nversion:<span class=\"w\">        </span><span class=\"m\">3</span>.5.10-k2-NAPI<span class=\"w\"> </span>6481838CE42D9570A7D35AF\nparm:<span class=\"w\">           </span>debug:Debug<span class=\"w\"> </span>level<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"nv\">0</span><span class=\"o\">=</span>none,...,16<span class=\"o\">=</span>all<span class=\"o\">)</span>\nvermagic:<span class=\"w\">       </span><span class=\"m\">2</span>.6.9-42.7AX<span class=\"w\"> </span><span class=\"m\">686</span><span class=\"w\"> </span>REGPARM<span class=\"w\"> </span>4KSTACKS<span class=\"w\"> </span>gcc-3.4\ndepends:<span class=\"w\">        </span>mii\nalias:<span class=\"w\">          </span>pci:v00008086d00001029sv*sd*bc02sc00i*\nalias:<span class=\"w\">          </span>pci:v00008086d00001030sv*sd*bc02sc00i*\nalias:<span class=\"w\">          </span>pci:v00008086d00001031sv*sd*bc02sc00i*\nalias:<span class=\"w\">          </span>pci:v00008086d00001032sv*sd*bc02sc00i*\nalias:<span class=\"w\">          </span>pci:v00008086d00001033sv*sd*bc02sc00i*\nalias:<span class=\"w\">          </span>pci:v00008086d00001034sv*sd*bc02sc00i*\n.........................................\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u6211\u4eec\u53ef\u4ee5\u770b\u51fa <code>e100.ko</code> \u8fd9\u4e2a\u6a21\u5757\u76ee\u524d\u7684\u7248\u672c\u662f 3.5.10\uff0c\u4ed6\u4f9d\u8d56\u6a21\u5757 <code>mii.ko</code>\uff0c\u540c\u65f6\uff0c\u53ef\u4ee5\u4f20\u9012\u4e00\u4e2a\u53c2\u6570 debug\uff0c\u7528\u4e8e\u8c03\u8bd5\u3002</p>\n<h3 id=\"mount\">mount.*<a class=\"headerlink\" href=\"#mount\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u547d\u4ee4\uff0c\u8fd9\u4e9b\u547d\u4ee4\u7684\u524d\u7aef\u7a0b\u5e8f\u5c31\u662f mount,\u7c7b\u4f3c mkfs \u4e00\u6837\u3002  </p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u6050\u6015\u662f linux \u4e0b\u6700\u5e38\u7528\u7684\u547d\u4ee4\u4e4b\u4e00\u4e86\u3002\u6240\u4ee5\u5927\u5bb6\u90fd\u6bd4\u8f83\u719f\u6089\uff0c\u6211\u8fd9\u91cc\u4ec5\u4ec5\u8bb0\u5f55\u51e0\u4e2a\u5e73\u5e38\u4e0d\u600e\u4e48\u5e38\u7528\u7684\u51e0\u4e2a\u53c2\u6570</p>\n<p><strong>\u91cd\u65b0\u6302\u8f7d\u4e3a\u53ea\u8bfb(\u53ef\u5199)</strong></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># mount hd /misc -oloop</span>\n<span class=\"c1\"># touch /misc/one</span>\n<span class=\"c1\"># ls /misc</span>\nlost+found<span class=\"w\">  </span>one\n<span class=\"c1\"># mount -o remount,ro hd /misc -oloop</span>\n<span class=\"c1\"># touch /misc/two</span>\ntouch:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>touch<span class=\"w\"> </span><span class=\"sb\">`</span>/misc/two<span class=\"err\">&#39;</span>:<span class=\"w\"> </span>Read-only<span class=\"w\"> </span>file<span class=\"w\"> </span>system\n</code></pre></div>\n<p><strong>\u731c\u6d4b\u67d0\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u7c7b\u578b</strong></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># mount --guess-fs /dev/hda3</span>\next3\n</code></pre></div>\n<h2 id=\"sbin-n\">/sbin \u4e0b n \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-n\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0d\u591a\uff0c\u800c\u4e14\u57fa\u672c\u4e0a\u4e0d\u5e38\u7528</p>\n<blockquote>\n<p>nameif nash netplugd netreport new-kernel-pkg nologin</p>\n</blockquote>\n<h3 id=\"nameif\">nameif<a class=\"headerlink\" href=\"#nameif\" title=\"Permanent link\">&para;</a></h3>\n<p>\u57fa\u4e8e MAC \u5730\u5740\u547d\u540d\u7f51\u7edc\u63a5\u53e3\uff0c\u4ed6\u9700\u8981\u7684\u914d\u7f6e\u6587\u4ef6\u662f <code>/etc/mactab</code>\u3002</p>\n<h3 id=\"nash\">nash<a class=\"headerlink\" href=\"#nash\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53e6\u5916\u4e00\u79cd shell\uff0c\u4e3b\u8981\u7528\u5728\u5f15\u5bfc\u955c\u50cf\u4e2d\u7684\u811a\u672c\u4e2d\uff0c\u6bd4\u5982<code>initrd.img</code>\u3002</p>\n<h3 id=\"netplugd\">netplugd<a class=\"headerlink\" href=\"#netplugd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7f51\u7edc\u70ed\u63d2\u62d4\u7ba1\u7406\u540e\u53f0\u7a0b\u5e8f\u3002</p>\n<h3 id=\"new-kernel-pkg\">new-kernel-pkg<a class=\"headerlink\" href=\"#new-kernel-pkg\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b89\u88c5\u65b0\u5185\u6838\uff0c\u4ed6\u80fd\u5b8c\u6210\u7684\u529f\u80fd\u6709\uff1a  </p>\n<ol>\n<li>\u521b\u5efa\uff0c\u5220\u9664\u4e00\u4e2a initrd  </li>\n<li>\u8fd0\u884c depmod \u6216\u8005\u5220\u9664 depmod \u751f\u6210\u7684\u6587\u4ef6  </li>\n<li>\u4ece grub/lilo \u914d\u7f6e\u6587\u4ef6\u4e2d\u589e\u52a0\u6216\u8005\u5220\u9664\u4e00\u4e2a\u5185\u6838\u955c\u50cf\uff08\u901a\u8fc7 grubby\uff09\u3002</li>\n</ol>\n<h3 id=\"nolog\">nolog<a class=\"headerlink\" href=\"#nolog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u60f3\u62d2\u7edd\u4e00\u4e2a\u5e10\u53f7\u767b\u5f55\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u4ed6\u4e86\uff0cman \u624b\u518c\u4e2d\u63cf\u8ff0\u7684\u662f\u4f18\u96c5\u7684\u62d2\u7edd\u7528\u6237\u767b\u5f55\u3002</p>\n<p>\u8df3\u8fc7 o \u5f00\u5934\u7684\u547d\u4ee4\u662f\u56e0\u4e3a o \u5f00\u5934\u53ea\u6709\u4e09\u4e2a\u547d\u4ee4\uff0c\u800c\u4e14\u90fd\u662f\u548c Oracle \u7684 ocfs \u6709\u5173\uff0c\u6240\u4ee5\u8fd9\u91cc\u5c31\u4e0d\u7814\u7a76\u4e86\u3002</p>\n<h2 id=\"sbinp\">/sbin/p \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbinp\" title=\"Permanent link\">&para;</a></h2>\n<p>p \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u5c11\uff0c\u8fd1 20 \u4e2a\u3002</p>\n<h3 id=\"pack_cis\">pack_cis<a class=\"headerlink\" href=\"#pack_cis\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0e PCMCIA \u6709\u5173\uff0c\u7f16\u8bd1 PCMCIA \u5361\u4fe1\u606f\u7ed3\u6784\u3002</p>\n<h3 id=\"pam_cosonle_apply\">pam_cosonle_apply<a class=\"headerlink\" href=\"#pam_cosonle_apply\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u7cfb\u7edf\u7ec8\u7aef\u4e0a\uff0c\u9488\u5bf9\u7528\u6237\u8bbe\u7f6e\u6216\u8005\u6536\u56de\u6743\u9650\u3002\u4ed6\u662f PAM \u76f8\u5173\u7684\u5de5\u5177\u3002</p>\n<p>\u5982\u679c<code>/var/run/console.lock</code>\u5b58\u5728\uff0c\u5219\u9488\u5bf9\u8be5\u6587\u4ef6\u7684\u7528\u6237\u6388\u6743;\u5982\u679c\u6ca1\u6709\uff0c\u5219\u6839\u636e\u7f3a\u7701\u6587\u4ef6\n<code>/etc/security/console.perms</code>\u7684\u89c4\u5219\u6765\u6388\u6743\u3002  </p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u4ee5\u53ca<code>pam_timestamp_check</code>,<code>pam_tally</code>\u90fd\u5c5e\u4e8e PAM \u7a0b\u5e8f</p>\n<h3 id=\"pam_console_setowner\">pam_console_setowner<a class=\"headerlink\" href=\"#pam_console_setowner\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bbe\u7f6e console \u7684\u5c5e\u4e3b\uff0c\u4ed6\u5c5e\u4e8e UDEV \u5305.</p>\n<h3 id=\"parted\">parted<a class=\"headerlink\" href=\"#parted\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f3a\u5927\u7684\u78c1\u76d8\u7ba1\u7406\u5de5\u5177\uff0c\u7c7b\u4f3c fdisk \u529f\u80fd\uff0c\u4f46\u662f\u4e2a\u4eba\u89c9\u5f97\u5176\u529f\u80fd\u6bd4 fdisk \u5f3a\u5927\u3002\n\u5176\u4e2d\u503c\u5f97\u8bf4\u7684\u4e00\u70b9\u5c31\u662f\u5728\u5df2\u7ecf\u5360\u7528\u7684\u78c1\u76d8\u4e0a\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e0d\u9700\u8981\u91cd\u542f\u751f\u6548\uff0c\u8fd9\u70b9\u5c31\u6bd4 fdisk \u5f3a\u3002\u6bd4\u5982\u4f60\u7684 hda \u5df2\u7ecf\u5728\u4f7f\u7528\u4e86\uff08\u4f60\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u8fd9\u65f6\u4f60\u5e0c\u671b\u5728 hda \u4e0a\u518d\u521b\u5efa\u4e00\u4e2a\u5206\u533a\uff0c\u5982\u679c\u4f7f\u7528 fdisk \u5de5\u5177\uff0c\u4fdd\u5b58\u7684\u65f6\u5019\u80af\u5b9a\u4f1a\u63d0\u793a\u8981\u4f60\u91cd\u542f\u624d\u751f\u6548\uff0c\u56e0\u4e3a\u8bbe\u5907 busy\u3002\n\u4f46\u662f parted \u5374\u4e0d\u4f1a\u3002\n\u53e6\u5916\u4e00\u70b9\u662f fdisk \u7a0b\u5e8f\u53ea\u6709\u5728\u4f60\u8f93\u5165 <code>w</code> \u547d\u4ee4\u540e\uff0c\u6240\u6709\u7684\u547d\u4ee4\u624d\u771f\u5b9e\u751f\u6548\uff0c\u800c parted \u4e0d\u662f\u8fd9\u6837\uff0c\u6267\u884c\u540e\uff0c\u7acb\u523b\u751f\u6548\uff08\u4e5f\u8bb8\u6211\u8fd8\u6ca1\u6709\u627e\u5230 undo \u7684\u529f\u80fd\uff09\uff0c\u6240\u4ee5\u8fd9\u70b9\u8981\u6ce8\u610f\u3002</p>\n<p>\u53d1\u73b0\u4e00\u4e2a\u6709\u610f\u601d\u7684\u73b0\u8c61\uff1aaddpart\uff0cdelpart \u7684\u529f\u80fd\u662f\u5220\u9664\u5206\u533a\u548c\u589e\u52a0\u5206\u533a\uff0c\u90a3\u4e48\u5f88\u81ea\u7136\u7684\u5e94\u8be5\u5c5e\u4e8e parted \u7a0b\u5e8f\u7684\u529f\u80fd\uff0c\u56e0\u6b64\u6309\u7406\uff0c\u8fd9\u4e24\u4e2a\u547d\u4ee4\u8fde\u5e26 partprobe \u548c parted \u5c5e\u4e8e\u540c\u4e00\u4e2a\u5305\u3002\n\u4f46\u4e8b\u5b9e\u662f addpart,delpart \u5c5e\u4e8e util-linux \u5305\u3002\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u6765\u5f52\u7c7b\uff1f</p>\n<p>Linux \u4e0b\u6ca1\u6709\u56fe\u5f62\u5316\u7684\u78c1\u76d8\u7ba1\u7406\u5de5\u5177\u4e00\u76f4\u662f\u666e\u901a\u7528\u6237\u62b1\u6028\u7684\u5730\u65b9\uff0c\u56e0\u4e3a\u4e0d\u8981\u671f\u671b\u6240\u6709\u4eba\u90fd\u6765\u4f7f\u7528 fdisk\uff0cparted \u8fd9\u6837\u7684\u547d\u4ee4\u3002\u4e0d\u8fc7\u73b0\u5728\u597d\u4e86\uff0c\u7ed9\u4e88 parted \u7684<a href=\"http://qtparted.sf.net\">qtparted</a>\u5c31\u662f\u4e00\u4e2a GUI \u7684\u7a0b\u5e8f\u3002</p>\n<h3 id=\"partx\">partx<a class=\"headerlink\" href=\"#partx\" title=\"Permanent link\">&para;</a></h3>\n<p>partx \u540c\u6837\u5c5e\u4e8e parted \u7684\u5305\uff0c\u800c\u662f linux-util,\u867d\u7136\u957f\u50cf parted \u4e4b\u7c7b\u7684\u3002\u8fd9\u4e2a\u547d\u4ee4\u548c addpart\uff0cdelpart \u4e00\u6837\uff0c\u6ca1\u6709 man \u624b\u518c\uff0c\u6ca1\u6709 info \u4fe1\u606f\uff0c\u6ca1\u6709 <code>--help</code>\u3002</p>\n<p>\u53ea\u597d\u627e google\uff0c\u5f97\u5230\u8fd9\u4e2a\u8fd9\u4e48<a href=\"http://www.ussg.iu.edu/hypermail/linux/kernel/0003.2/1887.html\">\u4e00\u7bc7\u6587\u7ae0</a>\u3002\u53ef\u4ee5\u770b\u770b\u3002</p>\n<h3 id=\"pivot_root\">pivot_root<a class=\"headerlink\" href=\"#pivot_root\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6539\u53d8\u6839\u6587\u4ef6\u7cfb\u7edf\u3002\u4ed6\u7684\u57fa\u672c\u7528\u6cd5\u662f\uff1a<code>pivot_root new_root put_old</code>  </p>\n<p>\u8868\u793a\u628a\u5f53\u524d\u5904\u7406\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u79fb\u5230<code>put_old</code>\u76ee\u5f55\uff0c\u7136\u540e\u628a<code>new_root</code>\u4f5c\u4e3a\u5f53\u524d\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u3002  </p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u66f4\u591a\u7684\u65f6\u5019\u7528\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u3002\u6211\u4eec\u77e5\u9053\u73b0\u5728\u7684 Linux \u542f\u52a8\u65f6\uff0c\u90fd\u9700\u8981\u4e00\u4e2a initrd \u7684\u6838\u5fc3\u53c2\u6570\uff0c\u8fd9\u4e2a initrd \u540e\u9762\u63a5\u7740\u7684\u538b\u7f29\u6587\u4ef6\u5f88\u591a\u60c5\u51b5\u4e0b\u5c31\u662f\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002  </p>\n<p>\u5185\u6838\u5f15\u5bfc\u540e\uff0c\u4f1a\u9996\u5148\u628a initrd \u7684\u53c2\u6570\u6302\u8f7d\uff0c\u628a\u4ed6\u5f53\u6210\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u5904\u7406\u5b8c\u5fc5\u8981\u7684\u4e8b\u52a1\u540e\uff0c\u518d\u628a\u6838\u5fc3\u53c2\u6570 root \u7f6e\u9876\u7684\u8bbe\u5907\u6302\u8f7d\u4e0a\u6765\uff0c\u7136\u540e\u4f7f\u7528<code>pivot_root</code>\u547d\u4ee4\u5207\u6362\u6574\u4e2a\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\n\u63a5\u7740\u6267\u884c/sbin/init \u7a0b\u5e8f\u6765\u7ee7\u7eed\u5f15\u5bfc\u7cfb\u7edf\u3002</p>\n<p>LSB \u7684 linux \u53d1\u884c\u7248\u672c\uff0c\u5f15\u5bfc\u65f6\u4f1a\u628a initrd \u955c\u50cf\u6302\u8f7d\u5230 <code>/initrd</code> \u76ee\u5f55\u4e0b\u3002\u6240\u4ee5\u4f60\u4f1a\u53d1\u73b0\u6839\u76ee\u5f55\u4e0b\u6709\u4e00\u4e2a initrd \u76ee\u5f55\uff0c\u4f46\u662f\u4ed6\u662f\u7a7a\u7684\uff0c\u5982\u679c\u6211\u5220\u9664\u4ed6\uff0c\u7cfb\u7edf\u5f15\u5bfc\u7684\u65f6\u5019\u5c31\u4f1a\u62a5\u9519\uff0c\u6211\u600e\u4e48\u77e5\u9053\u7684\uff1f\u56e0\u4e3a\u6211\u5e72\u8fc7\u8fd9\u6837\u7684\u50bb\u4e8b\u3002</p>\n<p>man \u624b\u518c\u4e2d\u4e3e\u4e86\u51e0\u4e2a\u4f8b\u5b50\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u89e3\u91ca<code>pivot_root</code>\u7684\u4f5c\u7528\u3002\u4e0d\u8fc7\u5bf9\u4e8e\u6539\u53d8\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u6211\u4eec\u53ef\u80fd\u9996\u5148\u60f3\u5230\u7684\u662f chroot\uff0cchroot \u4f3c\u4e4e\u4e5f\u6709\u8fd9\u4e2a\u529f\u80fd\uff0c\u90a3\u4e48\u4ed6\u548c<code>pivot_root</code>\u6709\u4ec0\u4e48\u5dee\u522b\u5462\uff1f<br />\n\u4e3b\u8981\u7684\u5dee\u522b\u662f<code>pivot_root</code>\u6709\u610f\u8bc6\u7684\u5207\u6362\u4e00\u4e2a\u5b8c\u6574\u7684\u7cfb\u7edf\u5230\u65b0\u7684\u6839\u76ee\u5f55\uff0c\u7136\u540e\u53ef\u4ee5\u79fb\u8d70\u4e4b\u524d\u9700\u8981\u4f9d\u8d56\u7684\u8001\u7684\u7cfb\u7edf\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5 umount \u6389\u4e4b\u524d\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c31\u5f53\u505a\u4e4b\u524d\u6ca1\u6709\u53d1\u751f\u8fc7\u539f\u6765\u5b83\u662f\u8fd0\u884c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e00\u6837\u3002</p>\n<p>\u800c chroot \u5219\u6709\u610f\u8bc6\u7684\u7533\u8bf7\u4e00\u4e2a\u5355\u72ec\u8fdb\u7a0b\u7684\u5168\u90e8\u751f\u547d\u5468\u671f\uff0c\u4ed6\u548c\u7cfb\u7edf\u7684\u5176\u4ed6\u90e8\u5206\u4e00\u8d77\u5728\u8001\u7684\u6839\u76ee\u5f55\u4e0b\u4e00\u8d77\u8fd0\u884c\uff0c\u5f53 chrooted \u8fdb\u7a0b\u9000\u51fa\u540e\uff0c\u7cfb\u7edf\u4e0d\u4f1a\u53d1\u751f\u6539\u53d8\u3002</p>\n<p>\u6ce8\uff1a\u4e0d\u5efa\u8bae\u5927\u5bb6\u6d4b\u8bd5\u8fd9\u4e2a\u547d\u4ee4\uff0c\u8fd9\u65f6\u6211\u6d4b\u8bd5\u540e\u5f97\u51fa\u7684\u7ed3\u679c\u3002\u81f3\u5c11\u6211\u505a\u5b8c\u540e\uff0c\u6211\u662f\u9760\u91cd\u542f\u7cfb\u7edf\u6765\u6062\u590d\u539f\u72b6\u7684(\u771f\u5b9e\u539f\u56e0\u662f\u5bf9\u8fd9\u4e2a\u547d\u4ee4\u8fd8\u662f\u4e86\u89e3\u5f97\u4e0d\u592a\u591a\u3002)</p>\n<h3 id=\"portmap\">portmap<a class=\"headerlink\" href=\"#portmap\" title=\"Permanent link\">&para;</a></h3>\n<p>DARPA(\u7f8e\u56fd\u56fd\u9632\u90e8\u9ad8\u7ea7\u7814\u7a76\u8ba1\u5212\u5c40)\u7aef\u53e3\u5230 RPC \u7a0b\u5e8f\u53f7\u7684\u6620\u5c04\u3002\u4e5f\u5c31\u662f\u63d0\u4f9b\u628a RPC \u7a0b\u5e8f\u53f7\u8f6c\u6362\u6210 DARPA \u534f\u8bae\u7aef\u53e3\u7684\u670d\u52a1\u3002\u66f4\u7edf\u5c5e\u7684\u79f0\u547c\u5e94\u8be5\u5c31\u662f\u7aef\u53e3\u6620\u5c04(\u8c01\u5173\u5fc3\u5230\u5e95\u4ece\u4ec0\u4e48\u534f\u8bae\u8f6c\u4ec0\u4e48\u534f\u8bae\u5462\uff1f)\u3002 </p>\n<p>\u5f53\u4e00\u4e2a RPC \u670d\u52a1\u5f00\u59cb\u65f6\uff0c\u5b83\u544a\u8bc9 portmap \u5b83\u5c06\u4fa6\u542c\u54ea\u4e2a\u7aef\u53e3\u53f7\uff0c\u4ee5\u53ca\u5b83\u51c6\u5907\u4e3a\u4ec0\u4e48 RPC \u7a0b\u5e8f\u53f7\u63d0\u4f9b\u670d\u52a1\u3002<br />\n\u4f46\u4e00\u4e2a\u5ba2\u6237\u7aef\u5e0c\u671b\u5bf9\u6307\u5b9a\u7684\u7a0b\u5e8f\u53f7\u505a RPC \u8c03\u7528\u65f6\uff0c\u4ed6\u5c06\u9996\u5148\u94fe\u63a5\u670d\u52a1\u5668\u4e0a\u7684 portmap \u7a0b\u5e8f(\u670d\u52a1)\u6765\u51b3\u5b9a RPC \u5305\u5e94\u8be5\u53d1\u5f80\u54ea\u4e2a\u7aef\u53e3\u3002<br />\nportmap \u5e94\u8be5\u5728 RPC \u670d\u52a1\u8c03\u7528\u4e4b\u524d\u542f\u52a8\u3002  </p>\n<p>\u5178\u578b\u7684\u5e94\u7528\u5e94\u8be5\u662f NFS \u4e86\u3002\u8fd0\u884c\u4e00\u4e2a NFS \u670d\u52a1\u5f53\u524d\u9700\u8981\u542f\u52a8\u7684\u670d\u52a1\u6709\uff1aportmap\uff0cnfs \u548c nfslock\u3002\u4e0d\u542f\u52a8 portmap \u800c\u5355\u72ec\u542f\u52a8 nfs\uff0c fslock \u670d\u52a1\u63d0\u4f9b NFS \u670d\u52a1\u65f6\uff0c\u6211\u9047\u5230\u8fc7\u4e24\u79cd\u9519\u8bef\uff1a</p>\n<ol>\n<li>\u975e\u5e38\u957f\u7684\u65f6\u95f4\u624d\u80fd mount \u4e0a  </li>\n<li>\u76f4\u63a5\u62a5\u7ed9\u51fa\u7684\u670d\u52a1\u4e0d\u53ef\u7528\u3002</li>\n</ol>\n<h3 id=\"sbin-q\">/sbin \u4e0b\u7684 q \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-q\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53ea\u6709\u4e24\u4e2a\uff0cquotacheck \u548c quotaon\uff0c\u5176\u4e2d quotaoff \u662f quotaon \u7684\u8f6f\u8fde\u63a5\u3002</p>\n<p>\u8fd9\u662f\u548c\u78c1\u76d8\u914d\u989d\u6709\u5173\u7684\u547d\u4ee4\uff0c\u8be6\u7ec6\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003 Linux \u4e0b\u7684\u914d\u989d\u914d\u7f6e\u624b\u518c\u3002</p>\n<h3 id=\"sbin-r\">/sbin \u4e0b r \u5f00\u5934\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin-r\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7a0d\u5fae\u591a\u4e9b\uff0c\u6709 25 \u4e2a\uff0c\u4e0d\u8fc7\u6709 7 \u4e2a\u662f\u8f6f\u8fde\u63a5\u3002</p>\n<h3 id=\"restore\">restore<a class=\"headerlink\" href=\"#restore\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece dump \u51fa\u6765\u7684\u5907\u4efd\u6062\u590d\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6211\u4ec5\u6d4b\u8bd5\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u770b\u4e0a\u53bb\u4e00\u5207\u6b63\u5e38\uff0c\u4e0d\u8fc7\u4ece\u8fd9\u4e2a\u4f8b\u5b50\u3002\u5982\u679c\u4e0d\u8003\u8651\u4e00\u4e9b\u7279\u522b\u56e0\u7d20\uff0c\u90a3\u4e48 dump/restore \u7684\u4f7f\u7528\u65b9\u6cd5\u662f\u5f88\u7b80\u5355\u7684\uff0c\u4e0b\u9762\u662f\u6211\u6d4b\u8bd5\u7684\u4f8b\u5b50</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">#mount /dev/mapper/vgdata-lvtest /misc</span>\n\n<span class=\"c1\">#cp -a /boot/* /misc/</span>\n\n<span class=\"c1\">#umount /misc</span>\n\n<span class=\"c1\">#dump z9 -f /tmp/lvtest.dump /dev/mapper/vgdata-lvtest</span>\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>level<span class=\"w\"> </span>dump:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>May<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"m\">10</span>:34:31<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Dumping<span class=\"w\"> </span>/dev/mapper/vgdata-lvtest<span class=\"w\"> </span><span class=\"o\">(</span>an<span class=\"w\"> </span>unlisted<span class=\"w\"> </span>file<span class=\"w\"> </span>system<span class=\"o\">)</span><span class=\"w\"> </span>to<span class=\"w\"> </span>/tmp/lvtest.dump\nDUMP:<span class=\"w\"> </span>Label:<span class=\"w\"> </span>none\nDUMP:<span class=\"w\"> </span>Writing<span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span>Kilobyte<span class=\"w\"> </span>records\nDUMP:<span class=\"w\"> </span>Compressing<span class=\"w\"> </span>output<span class=\"w\"> </span>at<span class=\"w\"> </span>compression<span class=\"w\"> </span>level<span class=\"w\"> </span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"o\">(</span>zlib<span class=\"o\">)</span>\nDUMP:<span class=\"w\"> </span>mapping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>I<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>regular<span class=\"w\"> </span>files<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>mapping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>II<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>directories<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>estimated<span class=\"w\"> </span><span class=\"m\">40454</span><span class=\"w\"> </span>blocks.\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>started<span class=\"w\"> </span>with<span class=\"w\"> </span>block<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>at:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>May<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"m\">10</span>:34:33<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>dumping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>III<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>directories<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>dumping<span class=\"w\"> </span><span class=\"o\">(</span>Pass<span class=\"w\"> </span>IV<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>regular<span class=\"w\"> </span>files<span class=\"o\">]</span>\nDUMP:<span class=\"w\"> </span>Closing<span class=\"w\"> </span>/tmp/lvtest.dump\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>completed<span class=\"w\"> </span>at:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>May<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"m\">10</span>:34:44<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>took<span class=\"w\"> </span><span class=\"m\">0</span>:00:11\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>transfer<span class=\"w\"> </span>rate:<span class=\"w\"> </span><span class=\"m\">3056</span><span class=\"w\"> </span>kB/s\nDUMP:<span class=\"w\"> </span>Volume<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>40530kB<span class=\"w\"> </span>uncompressed,<span class=\"w\"> </span>33626kB<span class=\"w\"> </span>compressed,<span class=\"w\"> </span><span class=\"m\">1</span>.206:1\nDUMP:<span class=\"w\"> </span><span class=\"m\">40530</span><span class=\"w\"> </span>blocks<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">39</span>.58MB<span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>volume<span class=\"o\">(</span>s<span class=\"o\">)</span>\nDUMP:<span class=\"w\"> </span>finished<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\"> </span>seconds,<span class=\"w\"> </span>throughput<span class=\"w\"> </span><span class=\"m\">3684</span><span class=\"w\"> </span>kBytes/sec\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>level<span class=\"w\"> </span>dump:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>May<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"m\">10</span>:34:31<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Date<span class=\"w\"> </span>this<span class=\"w\"> </span>dump<span class=\"w\"> </span>completed:<span class=\"w\"> </span>Mon<span class=\"w\"> </span>May<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"m\">10</span>:34:44<span class=\"w\"> </span><span class=\"m\">2007</span>\nDUMP:<span class=\"w\"> </span>Average<span class=\"w\"> </span>transfer<span class=\"w\"> </span>rate:<span class=\"w\"> </span><span class=\"m\">3056</span><span class=\"w\"> </span>kB/s\nDUMP:<span class=\"w\"> </span>Wrote<span class=\"w\"> </span>40530kB<span class=\"w\"> </span>uncompressed,<span class=\"w\"> </span>33626kB<span class=\"w\"> </span>compressed,<span class=\"w\"> </span><span class=\"m\">1</span>.206:1\nDUMP:<span class=\"w\"> </span>DUMP<span class=\"w\"> </span>IS<span class=\"w\"> </span>DONE\n\n<span class=\"c1\"># ls -lh /tmp/lvtest.dump</span>\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span>33M<span class=\"w\"> </span><span class=\"m\">05</span>-21<span class=\"w\"> </span><span class=\"m\">10</span>:34<span class=\"w\"> </span>/tmp/lvtest.dump\n\n<span class=\"c1\"># mkfs.ext3 /dev/mapper/vgdata-lvtest</span>\n<span class=\"c1\"># mount /dev/mapper/vgdata-lvtest /misc</span>\n<span class=\"c1\"># cd /misc</span>\n\n<span class=\"c1\"># restore rf /tmp/lvtest.dump</span>\nDump<span class=\"w\"> </span>tape<span class=\"w\"> </span>is<span class=\"w\"> </span>compressed.\n/dc50/sbin/restore:<span class=\"w\"> </span>./lost+found:<span class=\"w\"> </span>File<span class=\"w\"> </span>exists\n<span class=\"o\">[</span>root@mlsx<span class=\"w\"> </span>misc<span class=\"o\">]</span><span class=\"c1\"># ls</span>\nboot.b<span class=\"w\"> </span>initrd-2.6.18.3-52.img<span class=\"w\"> </span>memtest86+-1.65<span class=\"w\"> </span>System.map-2.6.18.3-52smp\nvmlinuz-2.6.18.3-52smp\nchain.b<span class=\"w\"> </span>initrd-2.6.18.3-52smp.img<span class=\"w\"> </span>message<span class=\"w\"> </span>System.map-2.6.20.6-2\nvmlinuz-2.6.20.6-2\nconfig-2.6.18.3-52<span class=\"w\"> </span>initrd-2.6.20.6-2.img<span class=\"w\"> </span>module-info\nSystem.map-2.6.20-ovz005.1<span class=\"w\"> </span>vmlinuz-2.6.20-ovz005.1\nconfig-2.6.18.3-52smp<span class=\"w\"> </span>initrd-2.6.20-ovz005.1.img<span class=\"w\"> </span>newinitrd.img\nSystem.map-2.6.9-42.7AX<span class=\"w\"> </span>vmlinuz-2.6.9-42.7AX\nconfig-2.6.20.6-2<span class=\"w\"> </span>initrd-2.6.9-42.7AX.img<span class=\"w\"> </span>os2_d.b\nvmlinux-2.6.20-ovz005.1\nconfig-2.6.9-42.7AX<span class=\"w\"> </span>initrd.img<span class=\"w\"> </span>restoresymtable<span class=\"w\"> </span>vmlinuz\ngrub<span class=\"w\"> </span>lost+found<span class=\"w\"> </span>System.map-2.6.18.3-52<span class=\"w\"> </span>vmlinuz-2.6.18.3-52\n</code></pre></div>\n<p>\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u6765\u770b\uff0c\u4f3c\u4e4e dump/restore \u7684\u4f7f\u7528\u65b9\u5f0f\u548c tar \u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u6ca1\u6709 tar \u90a3\u4e48\u5177\u6709\u4eb2\u548c\u529b\uff0c\u6bd5\u7adf tar \u662f\u66f4\u52a0\u901a\u4fd7\u7684\u5907\u4efd\u5de5\u5177\u3002\n\u4f46\u662f\u4ece\u6280\u672f\u89d2\u5ea6\u6765\u8bf4\uff0cdump/restore \u548c tar \u5b58\u5728\u8d28\u7684\u533a\u522b\uff1adump/restore \u662f\u57fa\u4e8e\u5757\u8bbe\u5907\u7684\u5907\u4efd\u65b9\u5f0f\uff0c\u800c tar \u5219\u662f\u540c\u65f6\u6587\u4ef6\u7cfb\u7edf\u3002</p>\n<p>\u8fd9\u6837\u7684\u8bdd\uff0c\u7406\u8bba\u4e0adump \u7684\u901f\u5ea6\u5e94\u8be5\u6bd4 tar \u7684\u901f\u5ea6\u8981\u5757\u5199\u3002\u800c\u4e14\u56e0\u4e3a\u662f\u4ece\u5757\u8bbe\u5907\u5907\u4efd\uff0c\u56e0\u6b64\u4e5f\u66f4\u7075\u6d3b\uff0c\u63d0\u4f9b\u7684\u53c2\u6570\u4e5f\u7279\u522b\u591a\u3002</p>\n<p>\u5f53\u65f6\u8bf4\u5230\u5907\u4efd\u6062\u590d\uff0c\u5728 Unix \u548c Linux \u7cfb\u7edf\u4e2d\uff0c\u6709\u592a\u591a\u7684\u5de5\u5177\u4e86\u3002</p>\n<p>\u9664\u4e86\u8fd9\u4e24\u8005\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u4e0d\u592a\u5e38\u89c1\u7684\uff0c\u6bd4\u5982 cpio\uff0c\u8fd9\u4e2a\u6587\u4ef6\u683c\u5f0f\u5728 Oracle \u5b98\u65b9\u63d0\u4f9b\u7684\u4ecb\u8d28\u4e0b\u8f7d\u4e2d\u80fd\u770b\u5230\uff0c\u8fd8\u6709\u4e00\u4e2apax\uff0cPortable Archive eXchange \u7684\u7f29\u5199\u3002</p>\n<p>\u6709\u5173\u5907\u4efd\u7684\u5de5\u5177\uff0c\u6211\u627e\u5230\u4e00\u7bc7\u6587\u6863\uff0c\u5927\u5bb6\u53ef\u4ee5\u770b\u770b</p>\n<blockquote>\n<p>Unix \u7cfb\u7d71\u57fa\u672c\u7684\u5099\u4efd\u8207\u56de\u5fa9\u5de5\u5177\u2014dump \u53ca restorerunuser: \u7528\u6307\u5b9a\u7684\u8d26\u53f7\u6216\u8005\u7ec4\u6765\u8fd0\u884c\u4e00\u4e2a shell\uff0c\u7c7b\u4f3c su \u7a0b\u5e8f\uff0c\u4f46\u662f\u4ed6\u6ca1\u6709\u5bc6\u7801\u63d0\u793a\u3002\u4e0a\u9762\u7684\u89e3\u91ca\u662f man \u624b\u518c\u4e2d\u7684\u7ffb\u8bd1\uff0c\u540e\u9762\u7684\u54ea\u4e2a\u5bc6\u7801\u63d0\u793a\u4e0d\u600e\u4e48\u597d\u7406\u89e3\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u77e5\u9053 su \u7a0b\u5e8f\u4ece root \u8d26\u53f7\u5207\u6362\u5230\u5176\u4ed6\u8d26\u53f7\u662f\u4e0d\u9700\u8981\u5bc6\u7801\u7684\uff0c\u800c\u666e\u901a\u8d26\u53f7\u4e4b\u524d\u7684\u5207\u6362\u6216\u8005\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u5230 root \u8d26\u53f7\uff0c\u4f60\u9700\u8981\u63d0\u4f9b\u5bc6\u7801\u7684\u3002 \u56e0\u4e3a\u80fd\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u5230 root \u8d26\u53f7\uff0c\u56e0\u6b64\u610f\u5473\u7740 su \u547d\u4ee4\u662f\u5177\u6709 setuid \u7684\uff0c\u800c runuser \u5374\u6ca1\u6709\u3002\u6240\u4ee5\u5f53\u5728 root \u8d26\u53f7\u4e0b\u6267\u884c runuser test \u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u7acb\u523b\u5207\u6362\u5230\u8d26\u53f7 test \u73af\u5883\u4e0b\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u4f60\u662f\u65e0\u6cd5\u4ece test \u8d26\u53f7\u5207\u6362\u5207\u6362\u5230\u4efb\u4f55\u8d26\u53f7\u7684\uff0c\u4ed6\u4f1a\u7ed9\u4f60\u6743\u9650\u4e0d\u591f\u7684\u63d0\u793a\u3002\u5f53\u7136\u5373\u4fbf\u63d0\u4f9b\u8f93\u5165\u5bc6\u7801\uff0c\u4e5f\u6ca1\u620f\uff0c\u56e0\u4e3a runuser \u662f\u4e00\u4e2a\u666e\u901a\u547d\u4ee4\uff0c\u6ca1\u6709 setuid \u4f4d\uff0c\u90a3\u5c31\u65e0\u6cd5\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u4e86\u3002\u6240\u4ee5\u6211\u4e0d\u6e05\u695a\u4e86\u6709 su \u8fd9\u6837\u7684\u547d\u4ee4\u540e\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 runuser \u8fd9\u6837\u7684\u547d\u4ee4\uff0c\u5386\u53f2\u539f\u56e0\uff1f\u5411\u540e\u517c\u5bb9\uff1fUnix \u6709\uff1fr \u5f00\u5934\u7684\u5176\u4ed6\u547d\u4ee4\u8fd9\u91cc\u4e0d\u8bf4\u4e86\uff0c\u6709\u597d\u51e0\u4e2a\u662f\u4e8e reiser \u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u547d\u4ee4\uff0c\u81ea\u4ece reiser \u6587\u4ef6\u7cfb\u7edf\u7684\u4f5c\u8005\u80cc\u53db\u8c0b\u6740\u59bb\u5b50\u7f6a\u6210\u7acb\u540e\uff0creiser \u6587\u4ef6\u7cfb\u7edf\u7684\u547d\u8fd0\u5c31\u4e0d\u597d\u8bf4\u4e86\uff0c\u636e\u8bf4\u4f5c\u8005\u51c6\u5907\u51fa\u552e reiser \u6587\u4ef6\u7cfb\u7edf\u7684\u7248\u6743\u6765\u6253\u5b98\u53f8\u3002\u5509\uff0c\u8fd8\u662f\u7b49\u7b49\u770b\u5427\u3002\u53e6\u5916\u5c31\u662f rmmod \u547d\u4ee4\uff0c\u8fd9\u662f\u5185\u6838\u9a71\u52a8\u5378\u8f7d\u547d\u4ee4\uff0c\u6211\u8bb0\u5f97\u5f88\u65e9\u524d\u7684 rmmod \u662f insmod \u547d\u4ee4\u7684\u4e00\u4e2a\u8f6f\u8fde\u63a5\uff0c\u73b0\u5728\u4e0d\u662f\u4e86\uff0c\u770b\u6765\u4ed6\u4eec\u5206\u5bb6\u4e86\u3002\u4f46\u662f\u5206\u5bb6\u7684\u539f\u56e0\u672a\u77e5\u3002rfmond \u662f RedFlag \u7cfb\u7edf\u7279\u6709\u7684\uff0c\u662f\u7ea2\u65d7\u7cfb\u7edf\u65e5\u5fd7\u6536\u96c6\u540e\u53f0\u7a0b\u5e8f\uff0c\u524d\u53f0\u662f GUI \u754c\u9762\u7684\u3002rpc \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u5c11\uff0c\u8fd9\u4e9b\u547d\u4ee4\u66f4\u591a\u7684\u5e94\u8be5\u662f\u88ab\u5176\u4ed6 rpc \u5e94\u7528\u7a0b\u5e8f\u6765\u8c03\u7528\uff0c\u6bd4\u5982 smb\uff0c\u6bd4\u5982 nfs\u3002runlevel \u6bd4\u8f83\u719f\u6089\uff0c\u53c2\u6570\u4e5f\u4ec5\u6709\u4e00\u4e2a\uff0c\u5b83\u662f\u4ece/var/run/utmp \u6587\u4ef6\u4e2d\u731c\u7740\u5f53\u524d\u8fd0\u884c\u7684\u7ea7\u522b\u548c\u4e4b\u524d\u8fd0\u884c\u7684\u7ea7\u522b\u3002\u6bd4\u5982\u4f60\u662f\u5728 3 \u7ea7\u522b\u767b\u5f55\u7684\uff0c\u7136\u540e\u6267\u884c startx\uff0c\u7136\u540e\u4f60\u8fd0\u884c runlevel\uff0c\u90a3\u4e48\u4ed6\u7ed9\u51fa\u7684\u7b54\u6848\u662f 5 3 \u8868\u793a\u73b0\u5728\u662f 5 \u7ea7\u522b\uff0c\u4e4b\u524d\u662f 3 \u7ea7\u522b\u3002\u5176\u5b9e\u4ece 3 \u7ea7\u522b\u6267\u884c startx \u6765\u542f\u52a8\u56fe\u5f62\u7ea7\u522b\uff0c\u6211\u66f4\u613f\u610f\u8bf4\u662f\u5728 3 \u7ea7\u522b\u542f\u52a8\u4e86\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u662f\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6bd4\u8f83\u7279\u522b\uff0c\u662f\u4e00\u4e2a X-windows\uff0c\u4ece\u547d\u4ee4\u89d2\u5ea6\u6765\u8bf4\uff0c\u4ed6\u5e94\u8be5\u548c\u5728 3 \u7ea7\u522b\u6267\u884c ls \u7b49\u547d\u4ee4\u6ca1\u6709\u4ec0\u4e48\u5dee\u522b\u3002\u6240\u4ee5\u6211\u5012\u4e0d\u5e0c\u671b startx \u540e\uff0c\u8fd0\u884c runlevel \u7ed9\u51fa\u662f\u7b54\u6848\u662f 5 3,\u6211\u671f\u671b\u662f 3.\u8fd9\u6837 startx \u8fd9\u4e2a\u547d\u4ee4\u672c\u8eab\u5c31\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u6027\u4e86\u3002\u6211\u8fd9\u91cc\u6765\u8bf4\uff0c\u662f\u6bd4\u8f83\u597d\u5411 Linux \u65b0\u624b\u89e3\u91ca Linux \u7684 X-windows\u3002\u6211\u7406\u89e3\u7684\u4ece 3 \u7ea7\u522b\u5230 5 \u7ea7\u522b\u5e94\u8be5\u91c7\u7528\u6700\u539f\u59cb\uff0c\u6700\u4f20\u7edf\u7684 init 5 \u547d\u4ee4\u3002</p>\n</blockquote>\n<h3 id=\"sfdisk\">sfdisk<a class=\"headerlink\" href=\"#sfdisk\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6709\u56db\u4e2a\u4e3b\u8981\u7684\u529f\u80fd\uff1a\u5217\u51fa\u4e00\u4e2a\u5206\u533a\u7684\u5927\u5c0f\uff08\u5757\u4e3a\u5355\u4f4d\uff09\uff0c\u4e00\u4e2a\u8bbe\u5907\u7684\u6240\u6709\u5206\u533a\uff0c\u68c0\u67e5\u4e00\u4e2a\u8bbe\u5907\u7684\u5206\u533a\u8868\uff0c\u91cd\u65b0\u5206\u533a\u4e00\u4e2a\u8bbe\u5907\u3002</p>\n<p>\u5176\u5b9e\u6211\u5728\u5e73\u65f6\u7528\u7684\u6700\u591a\u7684\u662f\u7b2c\u4e8c\u4e2a--\u5217\u51fa\u4e00\u4e2a\u8bbe\u5907\u7684\u5206\u533a\u8868\u3002\u6709\u4e86 fdisk \u547d\u4ee4\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u6709 sfdisk \u547d\u4ee4\u5462\uff1f\u6211\u7b2c\u4e00\u6b21\u5177\u4f53\u4f7f\u7528 sfdisk \u547d\u4ee4\uff0c\u8fd8\u662f\u5728 HP DL \u7cfb\u5217\u673a\u5668\u4e0a\u3002\nHP \u673a\u5668\u4f7f\u7528\u4e86 Smart Array \u9635\u5217\u5361\uff0c\u5176\u94fe\u63a5\u7684 SCSI \u5728 linux \u4e2d\u8bc6\u522b\u51fa\u6765\u7684\u4e0d\u662f\u5e73\u5e38\u6211\u4eec\u5e38\u8ba4\u4e3a\u7684 sdx \u8bbe\u5907\uff0c\u800c\u662f <code>cciss/c0d0px</code> \u8fd9\u6837\u7684\u6837\u5b50\u3002</p>\n<p>\u800c\u8fd9\u6837\u7684\u5206\u533a\u4fe1\u606f\uff0c\u4f7f\u7528 fdisk -l \u662f\u6ca1\u6709\u529e\u6cd5\u6253\u5370\u51fa\u6765\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u4f7f\u7528<code>sfdisk -l</code>\u547d\u4ee4\u4e86\u3002\u8fd9\u5c31\u4f7f\u7528\u5230\u4e86 sfdisk \u7684\u7b2c\u4e8c\u4e2a\u529f\u80fd\u4e86\u3002</p>\n<p>\u4ed6\u7684\u7b2c\u4e09\u4e2a\u529f\u80fd\u548c\u7b2c\u56db\u4e2a\u6ca1\u6709\u4f7f\u7528\u8fc7\uff0c\u4e0d\u8fc7\u521a\u624d\u770b man \u624b\u518c\uff0c\u53d1\u73b0\u5176\u5907\u4efd\u548c\u6062\u590d\u5206\u533a\u8868\u7684\u65b9\u5f0f\u5012\u662f\u5f88\u7b80\u5355\u3002</p>\n<p>\u5907\u4efd\u5206\u533a\u8868\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>sfdisk<span class=\"w\"> </span>/dev/hdd<span class=\"w\"> </span>-O<span class=\"w\"> </span>hdd-partition-sectors.save\n</code></pre></div>\n<p>\u6062\u590d\u5206\u533a\u8868\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\">    </span>sfdisk<span class=\"w\"> </span>/dev/hdd<span class=\"w\"> </span>-I<span class=\"w\"> </span>hdd-partition-sectors.save\n</code></pre></div>\n<p>\u4e0b\u9762\u662f\u6211\u7684\u5177\u4f53\u6d4b\u8bd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>fdisk<span class=\"w\"> </span>-l<span class=\"w\"> </span>/dev/mdp0\n<span class=\"c1\"># fdisk -l /dev/mdp0</span>\n\nDisk<span class=\"w\"> </span>/dev/mdp0:<span class=\"w\"> </span><span class=\"m\">419</span><span class=\"w\"> </span>MB,<span class=\"w\"> </span><span class=\"m\">419299328</span><span class=\"w\"> </span>bytes\n<span class=\"m\">2</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>sectors/track,<span class=\"w\"> </span><span class=\"m\">102368</span><span class=\"w\"> </span>cylinders\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"> </span>*<span class=\"w\"> </span><span class=\"nv\">512</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4096</span><span class=\"w\"> </span>bytes\n\nDevice<span class=\"w\"> </span>Boot<span class=\"w\"> </span>Start<span class=\"w\"> </span>End<span class=\"w\"> </span>Blocks<span class=\"w\"> </span>Id<span class=\"w\"> </span>System\n/dev/mdp0p1<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">24415</span><span class=\"w\"> </span><span class=\"m\">97658</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n/dev/mdp0p2<span class=\"w\"> </span><span class=\"m\">24416</span><span class=\"w\"> </span><span class=\"m\">102368</span><span class=\"w\"> </span><span class=\"m\">311812</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n<span class=\"c1\"># ls /misc</span>\nboot.b\n<span class=\"c1\"># df</span>\n\u6587\u4ef6\u7cfb\u7edf<span class=\"w\">        </span>1K-\u5757<span class=\"w\"> </span>\u5df2\u7528<span class=\"w\"> </span>\u53ef\u7528<span class=\"w\"> </span>\u5df2\u7528%<span class=\"w\"> </span>\u6302\u8f7d\u70b9\n/dev/mdp0p2<span class=\"w\"> </span><span class=\"m\">301959</span><span class=\"w\"> </span><span class=\"m\">50763</span><span class=\"w\"> </span><span class=\"m\">235606</span><span class=\"w\"> </span><span class=\"m\">18</span>%<span class=\"w\"> </span>/misc\n\n<span class=\"c1\">#sfdisk /dev/mdp0 -O /tmp/mdp0-partition.save</span>\n\n<span class=\"c1\"># ls -l /tmp/mdp0-partition.save</span>\n-r\u2013r\u2013r\u2013<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\"> </span>root<span class=\"w\"> </span><span class=\"m\">516</span><span class=\"w\"> </span><span class=\"m\">05</span>-28<span class=\"w\"> </span><span class=\"m\">00</span>:06<span class=\"w\"> </span>/tmp/mdp0-partition.save\n\n<span class=\"c1\"># dd if=/dev/zero of=/dev/mdp0 bs=512 count=1</span>\n<span class=\"m\">1</span>+0<span class=\"w\"> </span>records<span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"m\">1</span>+0<span class=\"w\"> </span>records<span class=\"w\"> </span>out\n<span class=\"m\">512</span><span class=\"w\"> </span>bytes<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">512</span><span class=\"w\"> </span>B<span class=\"o\">)</span><span class=\"w\"> </span>copied,<span class=\"w\"> </span><span class=\"m\">7</span>.9619e-05<span class=\"w\"> </span>seconds,<span class=\"w\"> </span><span class=\"m\">6</span>.4<span class=\"w\"> </span>MB/s\n\n<span class=\"c1\"># fdisk -l /dev/mdp0</span>\n\nDisk<span class=\"w\"> </span>/dev/mdp0:<span class=\"w\"> </span><span class=\"m\">419</span><span class=\"w\"> </span>MB,<span class=\"w\"> </span><span class=\"m\">419299328</span><span class=\"w\"> </span>bytes\n<span class=\"m\">2</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>sectors/track,<span class=\"w\"> </span><span class=\"m\">102368</span><span class=\"w\"> </span>cylinders\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"> </span>*<span class=\"w\"> </span><span class=\"nv\">512</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4096</span><span class=\"w\"> </span>bytes\n\nDisk<span class=\"w\"> </span>/dev/mdp0<span class=\"w\"> </span>doesnt<span class=\"w\"> </span>contain<span class=\"w\"> </span>a<span class=\"w\"> </span>valid<span class=\"w\"> </span>partition<span class=\"w\"> </span>table\n<span class=\"c1\"># sfdisk /dev/mdp0 -I /tmp/mdp0-partition.save</span>\nRe-reading<span class=\"w\"> </span>the<span class=\"w\"> </span>partition<span class=\"w\"> </span>table<span class=\"w\"> </span>\u2026\n<span class=\"c1\"># fdisk -l /dev/mdp0</span>\n\nDisk<span class=\"w\"> </span>/dev/mdp0:<span class=\"w\"> </span><span class=\"m\">419</span><span class=\"w\"> </span>MB,<span class=\"w\"> </span><span class=\"m\">419299328</span><span class=\"w\"> </span>bytes\n<span class=\"m\">2</span><span class=\"w\"> </span>heads,<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>sectors/track,<span class=\"w\"> </span><span class=\"m\">102368</span><span class=\"w\"> </span>cylinders\n<span class=\"nv\">Units</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cylinders<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"> </span>*<span class=\"w\"> </span><span class=\"nv\">512</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4096</span><span class=\"w\"> </span>bytes\n\nDevice<span class=\"w\"> </span>Boot<span class=\"w\"> </span>Start<span class=\"w\"> </span>End<span class=\"w\"> </span>Blocks<span class=\"w\"> </span>Id<span class=\"w\"> </span>System\n/dev/mdp0p1<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">24415</span><span class=\"w\"> </span><span class=\"m\">97658</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n/dev/mdp0p2<span class=\"w\"> </span><span class=\"m\">24416</span><span class=\"w\"> </span><span class=\"m\">102368</span><span class=\"w\"> </span><span class=\"m\">311812</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>Linux\n\n<span class=\"c1\"># mount /dev/mdp0p2 /misc</span>\n<span class=\"c1\"># ls /misc</span>\nboot.b\n</code></pre></div>\n<p>\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\uff0csfdisk \u786e\u5b9e\u53ef\u4ee5\u505a\u5230\u5206\u533a\u7684\u5907\u4efd\u548c\u6062\u590d\uff0c\u800c\u4e14\u5206\u533a\u5df2\u6709\u6570\u636e\u5e76\u4e0d\u4f1a\u4e22\u5931\u3002  </p>\n<p>\u8fd9\u5176\u5b9e\u548c\u62ff\u7740\u4e00\u7247\u539f\u59cb\u94a5\u5319\u53bb\u914d\u94a5\u5319\u7684\u5730\u65b9\u590d\u5236\u4e00\u7247\u51fa\u6765\uff0c\u67d0\u5929\u539f\u59cb\u7684\u4e22\u4e86\uff0c\u7528\u8fd9\u7247\u590d\u5236\u7684\u6253\u5f00\u623f\u95e8\uff0c\u623f\u5b50\u7684\u6446\u8bbe\u5f53\u7136\u4ec0\u4e48\u90fd\u6ca1\u6709\u6539\u53d8\u3002</p>\n<h3 id=\"sbin\">/sbin \u4e0b\u5269\u4f59\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#sbin\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece t \u5230 z \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u592a\u591a\uff0c\u800c\u4e14\u5f88\u591a\u4e5f\u662f\u5e38\u7528\u7684\uff0c\u4e5f\u53ea\u6709\u90a3\u4e9b\u57fa\u672c\u7528\u6cd5\uff0c\u56e0\u6b64\u6211\u5c31\u4e0d\u8bb0\u5f55\u5230\u8fd9\u91cc\u3002</p>\n<h3 id=\"tune2fs\">tune2fs<a class=\"headerlink\" href=\"#tune2fs\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u65e0\u7591\u662f\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5f3a\u52b2\u7684\u547d\u4ee4\u4e86\uff0c\u867d\u7136\u6211\u6211\u6700\u5e38\u7528\u7684\u662f\u4fee\u6539\u9700\u8981\u505a fsck \u4e4b\u524d\u7684\u6700\u5927\u6302\u8f7d\u6b21\u6570\u3002\u521a\u770b\u4e86 man \u624b\u518c\uff0c\u5176\u5b9e\u4ed6\u7684\u53c2\u6570\u591a\u7740\u5462\uff0c\u5f88\u591a\u6587\u4ef6\u7cfb\u7edf\u5143\u6570\u636e\u90fd\u53ef\u4ee5\u4fee\u6539\uff0c\u6bd4\u5982\u4fdd\u7559\u5757\u5927\u5c0f\uff0c\u65e5\u5fd7\u5927\u5c0f\uff0c\u6302\u8f7d\u9009\u9879\u7b49\u3002</p>\n<p>\u8fd8\u53d1\u73b0\u4e00\u4e2a<code>-L</code>\u7684\u53c2\u6570\u662f\u7ed9\u6587\u4ef6\u7cfb\u7edf\u8bbe\u7f6e\u5377\u8868\uff0c\u4ee5\u524d\u6211\u90fd\u662f\u7528 e2lable \u6765\u5e72\u8fd9\u4e2a\u6d3b\u7684\uff0c\u6ca1\u6709\u60f3\u5230 tune2fs \u4e5f\u80fd\u505a\u3002\u770b\u6765\u4e0b\u6b21\u53ef\u4ee5\u4e0d\u7528\u9700\u8981 e2label \u4e86\u3002</p>\n<p><code>u</code> \u5f00\u5934\u7684\u57fa\u672c\u4e0a\u90fd\u662f\u548c udev \u76f8\u5173\u7684\uff0c\u8fd9\u65b9\u9762\uff0c\u6211\u8d34\u8fc7\u4e00\u4e2a\u7406\u89e3 udev \u7684\u6587\u7ae0\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d34\u4e86\u3002</p>\n<p><code>v</code> \u5f00\u5934\u6709\u4e24\u4e2a\u547d\u4ee4\uff0cvboxd\uff0cvchange\uff0c\u662f\u548c ISDN \u6709\u5173\u7684\uff0c\u8fd9\u5e94\u8be5\u7b97\u662f\u4e00\u6bb5\u5386\u53f2\u5427\u3002</p>\n<p><code>w</code> \u5f00\u5934\u53ea\u6709\u4e00\u4e2a\u547d\u4ee4: wait_for_sysfs\uff0c\u662f udev \u7684 rpm \u5305\u91cc\u7684\uff0c\u7528\u5728 udev \u89c4\u5219\u91cc\u3002</p>\n<p><code>x</code> \u5f00\u5934\u7684\u4e0e xfs \u6587\u4ef6\u7cfb\u7edf\u6709\u5173\u7684\uff0c\u53ef\u60dc\u76ee\u524d\u6211\u53d1\u73b0\u5728 DC \u4e0a xfs \u652f\u6301\u5f97\u5e76\u4e0d\u662f\u592a\u597d\u3002</p>\n<p><code>y</code> \u5f00\u5934\u53ea\u6709\u4e00\u4e2a\u547d\u4ee4\uff1aypbind\uff0c\u662f NIS \u7684\u76f8\u5173\u547d\u4ee4\uff0c\u8fd9\u4e2a\u4ece Solaris \u4e0a\u8fc1\u79fb\u8fc7\u6765\u7684\u4e1c\u897f\uff0c\u4e0d\u77e5\u9053\u6709\u6ca1\u6709\u5728 Linux \u8fd0\u884c\u7684\u6848\u4f8b\u3002</p>\n<p><code>z</code> \u5f00\u5934\u7684\u5c31\u6ca1\u6709\u4e86\u3002</p>\n<h2 id=\"usrsbin\">/usr/sbin \u4e0b\u7684\u547d\u4ee4<a class=\"headerlink\" href=\"#usrsbin\" title=\"Permanent link\">&para;</a></h2>\n<p><code>/usr/sbin</code>\u4e0b\u7684\u547d\u4ee4\u660e\u663e\u6bd4/sbin \u4e0b\u7684\u547d\u4ee4\u591a\u4e86\u5f88\u591a\uff0c\u56e0\u6b64<code>/usr/sbin</code>\u5e94\u8be5\u662f\u4e00\u4e2a\u6bd4\u8f83\u957f\u7684\u5b66\u4e60\u8fc7\u7a0b\u3002</p>\n<h3 id=\"alternatives\">alternatives<a class=\"headerlink\" href=\"#alternatives\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528\u6765\u5bf9\u7cfb\u7edf\u4e2d\u4e0d\u540c\u7248\u672c\u7684\u540c\u4e2a\u8f6f\u4ef6\u8fdb\u884c\u7ba1\u7406\u7684\u5de5\u5177\uff0c\u6bd4\u5982\u7cfb\u7edf\u91cc\u9ed8\u8ba4\u6709\u591a\u4e2a java \u7248\u672c\uff0c\u5230\u5e95\u4f7f\u7528\u90a3\u4e2a\u7248\u672c\u7684 java \u7a0b\u5e8f\uff0c\u8fd9\u65f6\u5c31\u9700\u8981 alternatives \u6765\u7ba1\u7406\u4e86\u3002</p>\n<p><code>etc/alternatives</code>\u76ee\u5f55\u5c31\u662f\u5b83\u7684\u5927\u672c\u8425\uff0c\u91cc\u9762\u5168\u662f\u94fe\u63a5\u6587\u4ef6\u3002  </p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u7f51\u4e0a\u6709\u5f88\u591a\u5e16\u5b50\u8be6\u7ec6\u8bf4\u660e\u4e86\u7528\u6cd5\uff0c\u90a3\u6211\u5c31\u4f7f\u7528\u62ff\u6765\u4e3b\u4e49\u4e86<a href=\"http://www.linuxquestions.org/linux/answers/Applications_GUI_Multimedia/LINUX_ALTERNATIVES_HOWTO\">LINUX alternatives howto</a>\u7528\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50\u63cf\u8ff0\u4e86 alternatives \u7684\u7528\u6cd5\u3002</p>\n<h3 id=\"am-eject\">am-eject<a class=\"headerlink\" href=\"#am-eject\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u662f am-utils \u5305\u7684\u4e00\u4e2a\u547d\u4ee4\uff0cam-utils \u662f\u4e00\u4e2a BSD \u7684 automount \u7a0b\u5e8f\uff0c\u7528\u6765\u81ea\u52a8\u6302\u8f7d\u4e00\u4e9b\u6587\u4ef6\u7cfb\u7edf\u3002\n\u4ece <code>amd.conf</code> \u7684 man \u624b\u518c\u6765\u770b\uff0c\u4f3c\u4e4e am-utils \u81ea\u80fd\u81ea\u52a8\u6302\u8f7d NFS \u7684\u6587\u4ef6\u7cfb\u7edf\u3002\n\u7cfb\u7edf\u540c\u65f6\u4e5f\u5e26\u4e86 autofs \u8fd9\u4e2a\u81ea\u52a8\u6302\u8f7d\u7a0b\u5e8f\uff0c\u4e0e am-utils \u4e0d\u540c\u7684\u662f\uff0cautofs \u662f\u5185\u6838\u7ea7\u522b\u7684\uff0c\u5b83\u9700\u8981\u5185\u6838\u7684\u652f\u6301\uff0c\u53e6\u5916\u5b83\u652f\u6301\u5404\u79cd\u6587\u4ef6\u7cfb\u7edf\u7684\u6302\u8f7d\u3002\n\u800c am-utils \u5219\u662f\u7528\u6237\u7a7a\u95f4\u7684\uff0c\u5185\u6838\u5e76\u4e0d\u77e5\u9053\u9700\u8981\u6302\u8f7d\u54ea\u4e9b\u6587\u4ef6\u7cfb\u7edf\u3002\u5206\u522b\u6709\u4e24\u7bc7\u6587\u7ae0\u8be6\u7ec6\u63cf\u8ff0\u4e86 autofs \u548c am-utils \u7684\u7528\u6cd5\uff0c\u5206\u522b\u662f\n<a href=\"http://www.am-utils.org/docs/am-utils/am-utils.html\">Am-utils (4.4BSD Automounter Utilities)</a>\u548c\n<a href=\"ftp://ftp.nrc.ca/pub/systems/linux/HOWTO/translations/zh/gb/mini/Automount.txt.gz\">autofs-HOWTO</a>\u3002</p>\n<h3 id=\"anaconda\">anaconda<a class=\"headerlink\" href=\"#anaconda\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76ee\u524d\u901a\u7528\u7684 linux \u7cfb\u7edf\u5b89\u88c5\u5411\u5bfc\u7a0b\u5e8f\uff0c\u5e94\u8be5\u7b97\u662f python \u7684\u4ee3\u8868\u4f5c\u5427\u3002\u5230\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u627e\u5230\u7684\u6587\u7ae0\u7adf\u7136\u662f\u73b0\u5728\u7684\u540c\u4e8b\u67cf\u751f\u5728 2005 \u5e74\u53d1\u8868\u5728 IBM \u5f00\u53d1\u7f51\u7ad9\u7684\u6587\u7ae0\uff0c\u56e0\u6b64\u5c31\u76f4\u63a5\u62ff\u8fc7\u6765\u4e86</p>\n<p><a href=\"http://www.ibm.com/developerworks/cn/linux/l-anaconda/index.html\">redhat \u5b89\u88c5\u7a0b\u5e8f anaconda\u5206\u6790</a>\u3002</p>\n<h3 id=\"anacron\">anacron<a class=\"headerlink\" href=\"#anacron\" title=\"Permanent link\">&para;</a></h3>\n<p>anacron \u662f\u548c cron \u76f8\u4f3c\u7684\u4efb\u52a1\u8c03\u5ea6\u5668\uff0c\u53ea\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u8981\u6c42\u7cfb\u7edf\u6301\u7eed\u8fd0\u884c\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u8fd0\u884c\u901a\u5e38\u7531 cron \u8fd0\u884c\u7684\u6bcf\u65e5\u3001\u6bcf\u5468\u3001\u548c\u6bcf\u6708\u7684\u4f5c\u4e1a\u3002</p>\n<p>\u7f51\u4e0a\u540c\u6837\u7684\u8be6\u7ec6\u7684\u5e16\u5b50\u4ecb\u7ecd\uff0c<a href=\"http://knit.ntsky.com/docs/redhat9/rhl-cg-zh_CN-9/s1-autotasks-anacron.html\">anacron</a></p>\n<h3 id=\"bgpd\">bgpd<a class=\"headerlink\" href=\"#bgpd\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"http://www.qugga.net\">Quagga</a>\u8f6f\u4ef6\u5305\u7684\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u7528\u6765\u5b9e\u73b0 BGPv4 \u7b49\u8def\u7531\u534f\u8bae\u7684\u7a0b\u5e8f\u3002\nQuagga \u662f\u4e00\u4e2a\u8def\u7531\u7a0b\u5e8f\u5957\u4ef6\uff0c\u5b83\u63d0\u4f9b\u4e86 OSPFv2, OSPFv3, RIP v1 and v2, RIPng and BGP-4 \u7b49\u534f\u8bae\u7684\u5b9e\u73b0\u3002\n\u7528\u5b83\uff0c\u5c31\u53ef\u4ee5\u628a\u4e00\u4e2a Linux \u7cfb\u7edf\u6539\u9020\u6210\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u8def\u7531\u5668\uff0c\u548c\u90a3\u4e9b\u52a8\u5219\u4e0a\u5341\u4e07\u767e\u4e07\u7684\u786c\u4ef6\u8def\u7531\u5668\u529f\u80fd\u76f8\u5f53\uff0c\u5bf9\u4e8e SMB(Small Middle Business)\u800c\u8a00,\u5e94\u8be5\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9\u3002</p>\n<p>Quagga \u8fd8\u5305\u62ec\u4e0b\u9762\u4e00\u4e9b\u547d\u4ee4\uff1a\n<code>bgpd ospf6d ospfclient ospfd ripd ripngd watchquagga zebra</code></p>\n<p>quagga \u7684\u4f7f\u7528\u65b9\u5f0f\u548c\u4f7f\u7528 cisco \u7b49\u7f51\u7edc\u8bbe\u5907\u5382\u5546\u7684\u8bbe\u5907\u5dee\u4e0d\u591a\uff0c\u53ef\u60dc\u6211\u5bf9\u8fd9\u4e9b\u4ea7\u54c1\u4e00\u7a8d\u4e0d\u901a\uff0c\u56e0\u6b64 quagga \u8fd9\u4e48\u597d\u7528\u7684\u8f6f\u4ef6\uff0c\u5bf9\u6211\u6765\u8bf4\uff0c\u4e5f\u5c31\u7528\u5904\u4e0d\u5927\u4e86\uff0c\u4e8e\u662f\u7565\u8fc7\u3002</p>\n<h3 id=\"bmc-config\">bmc-config<a class=\"headerlink\" href=\"#bmc-config\" title=\"Permanent link\">&para;</a></h3>\n<p>bmc-config, bmc-info IPMI BMC \u914d\u7f6e\u5de5\u5177\u7a0b\u5e8f\uff0cIPMI(Intelligent Platform Management Interface\uff09\u5373\u667a\u80fd\u5e73\u53f0\u7ba1\u7406\u63a5\u53e3\u662f\u4f7f\u786c\u4ef6\u7ba1\u7406\u5177\u5907\u201c\u667a\u80fd\u5316\u201d\u7684\u65b0\u4e00\u4ee3\u901a\u7528\u63a5\u53e3\u6807\u51c6\u3002</p>\n<p>\u7528\u6237\u53ef\u4ee5\u5229\u7528 IPMI\u76d1\u89c6\u670d\u52a1\u5668\u7684\u7269\u7406\u7279\u5f81\uff0c\u5982\u6e29\u5ea6\u3001\u7535\u538b\u3001\u7535\u6247\u5de5\u4f5c\u72b6\u6001\u3001\u7535\u6e90\u4f9b\u5e94\u4ee5\u53ca\u673a\u7bb1\u5165\u4fb5\u7b49\u3002Ipmi \u6700\u5927\u7684\u4f18\u52bf\u5728\u4e8e\u5b83\u662f\u72ec\u7acb\u4e8e CPU BIOS \u548c OS\u7684\uff0c\n\u6240\u4ee5\u7528\u6237\u65e0\u8bba\u5728\u5f00\u673a\u8fd8\u662f\u5173\u673a\u7684\u72b6\u6001\u4e0b\uff0c\u53ea\u8981\u63a5\u901a\u7535\u6e90\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u670d\u52a1\u5668\u7684\u76d1\u63a7\u3002Ipmi \u662f\u4e00\u79cd\u89c4\u8303\u7684\u6807\u51c6\uff0c\u5176\u4e2d\u6700\u91cd\u8981\u7684\u7269\u7406\u90e8\u4ef6\u5c31\u662f BMC(Baseboard Management Controller\n\u5982\u56fe 1)\uff0c\u4e00\u79cd\u5d4c\u5165\u5f0f\u7ba1\u7406\u5fae\u63a7\u5236\u5668\uff0c\u5b83\u76f8\u5f53\u4e8e\u6574\u4e2a\u5e73\u53f0\u7ba1\u7406\u7684\u201c\u5927\u8111\u201d\uff0c\u901a\u8fc7\u5b83 ipmi\u53ef\u4ee5\u76d1\u63a7\u5404\u4e2a\u4f20\u611f\u5668\u7684\u6570\u636e\u5e76\u8bb0\u5f55\u5404\u79cd\u4e8b\u4ef6\u7684\u65e5\u5fd7\u3002\n\u8be6\u7ec6\u7684\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003 IBM \u5f00\u53d1\u7f51\u7684\u4e00\u7bc7\u6587\u6863--<a href=\"http://www.ibm.com/developerworks/cn/linux/l-ipmi/index.html\">\u4f7f\u7528 ipmitool \u5b9e\u73b0 Linux\u7cfb\u7edf\u4e0b\u5bf9\u670d\u52a1\u5668\u7684 ipmi \u7ba1\u7406</a>\u3002</p>\n<h3 id=\"brctl\">brctl<a class=\"headerlink\" href=\"#brctl\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7f51\u6865\u7ba1\u7406\u7a0b\u5e8f\uff0c\u7528\u6765\u8bbe\u7f6e\uff0c\u7ef4\u62a4\u76d1\u63a7 linux \u5185\u6838\u7f51\u6865\u914d\u7f6e\u4fe1\u606f\u3002\n\u8bf4\u5b9e\u5728\u7684\u6211\u4e0d\u592a\u6e05\u695a\u7f51\u6865\u548c hub \u4e4b\u95f4\u5230\u5e95\u6709\u591a\u5c11\u533a\u522b\uff0c\u6240\u4ee5\u4e5f\u5c31\u4e0d\u77e5\u9053\u6865\u63a5\u662f\u4ec0\u4e48\u6982\u5ff5\u4e86\n\u3002\u4e8e\u662f\u6211\u4e5f\u6ca1\u6709\u4ece\u6765\u6ca1\u6709\u4f7f\u7528\u8fc7\u7f51\u6865\u7684\u529f\u80fd\u3002<a href=\"http://h50069.www5.hp.com/e-Delivery3/Forum/WebUI/Messages/ShowTopic.aspx?RID=6f770c6e-d7ee-4bc8-bb83-8345064ce11d\">\u8fd9\u91cc\u6709\u7bc7\u6587\u6863</a>\u8be6\u7ec6\u8bf4\u660e\u4e86\u7f51\u6865\u7684\u6982\u5ff5\uff0c\u7528\u9014\uff0c\u5c40\u9650\u6027\u3002</p>\n<p>\u6587\u7ae0\u63d0\u5230\u7f51\u6865\u9002\u5408\u5c0f\u578b\u8f83\u7b80\u5355\u7684\u7f51\u7edc\uff0c\u90a3\u6211\u76f4\u63a5\u7528\u4e00\u4e2a HUB \u5c31\u884c\u4e86\uff0c100 \u5757\u4e0d\u5230\u5c31\u641e\u5b9a\u4e86\u3002</p>\n<h3 id=\"chroot\">chroot<a class=\"headerlink\" href=\"#chroot\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6307\u5b9a\u6839\u6587\u4ef6\u7cfb\u7edf\uff08/\uff09\uff0c\u5f53\u6211\u7b2c\u4e00\u6b21\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u6211\u624d\u53d1\u73b0 Linux \u539f\u6765\u5982\u6b64\u5f3a\u5927\uff0c\u4ec5\u4ec5\u53ea\u9700\u8981\u8fd9\u6837\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u5df2\u7ecf\u5b58\u5728\u7684\u591a\u4e2a\u7cfb\u7edf\u3002\n\u6bd4\u5982\u6211\u5e73\u5e38\u4f7f\u7528\u7684\u7cfb\u7edf\u662f Everest\uff0c\u4ed6\u9002\u5408\u684c\u9762\u529e\u516c\uff0c\u4f46\u662f\u6211\u5728\u51fa\u53bb\u57f9\u8bad\u548c\u81ea\u5df1\u8054\u7cfb\u4e00\u4e9b\u6709\u5173\u4f01\u4e1a\u5e94\u7528\u7684\u65f6\u5019\uff0c\u6211\u9700\u8981 DC5 \u7684\u73af\u5883\uff0c\u8fd9\u4e2a\u65f6\u5019 chroot \u5c31\u5e2e\u4e0a\u6211\u7684\u5927\u5fd9\u4e86\uff0c\u4ec5\u4ec5\u53ea\u9700\u8981\u628a DC5 \u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u4e0a\u6765\uff0c\u7136\u540e chroot \u5230\u8fd9\u4e2a\u6302\u8f7d\u70b9\uff0cDC5 \u7684\u73af\u5883\u5c31\u6709\u4e86\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u548c\u76f4\u63a5\u4f7f\u7528 DC5 \u6ca1\u6709\u5dee\u522b\uff0c\u53ea\u662f\u8fd9\u4e2a\u7cfb\u7edf\u7cfb\u7edf\u4f7f\u7528\u8fd8\u662f Everest \u7684\u6838\u5fc3\uff0c\u56e0\u6b64\u5f53\u9700\u8981\u6267\u884c\u4e0e\u6838\u5fc3\u6709\u5173\u7684\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u6b64\u65f6 chroot \u5c31\u6709\u70b9\u65e0\u80fd\u4e3a\u529b\u4e86\uff0c\u4e0d\u8fc7\u597d\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0d\u592a\u591a\u3002Chroot\uff0c\u5f88\u4f1f\u5927\u7684\u521b\u9020\uff01</p>\n<h3 id=\"chpasswd\">chpasswd<a class=\"headerlink\" href=\"#chpasswd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6279\u91cf\u4fee\u6539\u5bc6\u7801\uff0c\u8fd9\u5bf9\u7ef4\u62a4\u62e5\u6709\u5927\u91cf\u7528\u6237\u8d26\u53f7\u7684\u7ba1\u7406\u5458\u800c\u8a00\uff0c\u65e0\u7591\u6709\u5e2e\u52a9\uff0c\u867d\u7136\u4f5c\u4e3a\u4e00\u4e2a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u5199\u4e00\u4e2a\u7a0b\u5e8f\u6765\u8fbe\u5230\u6279\u91cf\u4fee\u6539\u8d26\u53f7\u5bc6\u7801\u7684\u76ee\u7684\uff0c\u4f46\u662f\u65e2\u7136\u7cfb\u7edf\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u90a3\u6211\u4eec\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u4f7f\u7528\u5462\uff1f\n\u4ed6\u4ece\u6807\u6ce8\u8f93\u5165\u8bfb\u53d6\u6bcf\u884c\u7528\u6237\u4fe1\u606f\uff0c\u6bcf\u884c\u7531 <code>username:password</code> \u7ec4\u6210\u3002\n\u5bf9\u4e8e password \u7684\u683c\u5f0f\uff0cchpasswd \u7a0b\u5e8f\u7ed9\u51fa\u8d34\u5fc3\u7684\u4e00\u9762\uff0c\u53ef\u4ee5\u4f7f\u7528\u660e\u6587\u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u5c31\u514d\u9664\u4e86\u6211\u4eec\u81ea\u5df1\u53bb\u751f\u6210\u5bc6\u6587\u7684\u70e6\u6270\uff0c\u540c\u65f6\u65e5\u540e\u4e5f\u77e5\u9053\u7528\u6237\u7684\u521d\u59cb\u5bc6\u7801\u662f\u591a\u5c11\u3002\n\u53e6\u5916\u4e00\u4e2a\u65b9\u9762\uff0c\u5982\u679c\u4f60\u4ece\u5b8c\u5168\u8003\u8651\uff0c\u5e0c\u671b\u8fd9\u4e2a\u6587\u4ef6\u91cc\u4e0d\u8981\u51fa\u73b0\u660e\u6587\u7684\u5bc6\u7801\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u4f7f\u7528\u52a0\u5bc6\u7684\u5bc6\u7801\u586b\u5145 password \u8fd9\u4e2a\u5b57\u6bb5\uff0c\u53ea\u662f\u4f7f\u7528\u8fd9\u4e2a chpasswd \u547d\u4ee4\u7684\u65f6\u5019\uff0c\u9700\u8981\u4f7f\u7528 <code>-e</code> \u7684\u53c2\u6570\u3002  </p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># cat /tmp/chpwd.txt</span>\nwork:test<span class=\"w\"> </span>oracle:test\n<span class=\"c1\"># chpasswd  </span>\n</code></pre></div>\n<p>\u5e94\u8be5\u8bf4\u662f\u975e\u5e38\u65b9\u4fbf\u7684\u3002</p>\n<h3 id=\"dhcrelay\">dhcrelay<a class=\"headerlink\" href=\"#dhcrelay\" title=\"Permanent link\">&para;</a></h3>\n<p>DHCP \u670d\u52a1\u5668\u4e2d\u8f6c\u5668\u3002\u5f53\u4f60\u7684\u7f51\u7edc\u6709\u4e24\u4e2a VLAN\uff0c\u4f46\u662f\u53ea\u5728 VLAN A \u91cc\u653e\u7f6e\u4e86\u4e00\u4e2a DHCP \u670d\u52a1\u5668\uff0c\u90a3\u4e48\u5982\u4f55\u8ba9 VLAN B \u7684\u673a\u5668\u4e5f\u80fd\u81ea\u52a8\u83b7\u5f97 IP \u5730\u5740\u5462\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\n\u4f60\u9700\u8981 dhcrelay \u4e86\u3002\u8fd9\u65b9\u9762\u7684\u6587\u6863\uff0c\u7f51\u7edc\u4e0a\u6bd4\u8f83\u591a\uff0c\u7ed9\u51fa\u4e24\u7bc7\uff1a  </p>\n<ul>\n<li><a href=\"http://www.homeweb.idv.tw/index.php?pl=249\">DHCP relay agent</a>  </li>\n<li><a href=\"http://linux.chinaunix.net/bbs/viewthread.php?action=printable&amp;tid=904010\">dhcp server \u53ef\u4e0d\u53ef\u4ee5\u8de8\u7f51\u6bb5\u6765\u5de5\u4f5c</a>\u3002</li>\n</ul>\n<h3 id=\"dovecot\">dovecot<a class=\"headerlink\" href=\"#dovecot\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e00\u4e2a\u7b80\u5355\u4f46\u662f\u5b89\u5168\u7684 IMAP \u670d\u52a1\u5668\uff0c\u4e5f\u5305\u62ec\u4e86 POP3 \u670d\u52a1\uff0c\u652f\u6301 mbox \u548c maildir \u4e24\u79cd\u90ae\u4ef6\u5b58\u50a8\u683c\u5f0f\u3002 \n\u4ee5\u524d\u6211\u8fd8\u4e0d\u77e5\u9053\u7cfb\u7edf\u81ea\u5e26\u4e86\u8fd9\u4e48\u597d\u7684\u4e1c\u897f\uff0c\u4e5f\u8fd8\u7b80\u5355\u3002</p>\n<h3 id=\"dump-acct\">dump-acct<a class=\"headerlink\" href=\"#dump-acct\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bfc\u51fa\u8fdb\u7a0b\u8bb0\u8d26\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662f<code>/var/account/pacct</code>\uff0c\u4ed6\u548c accton \u547d\u4ee4\u662f\u914d\u5408\u8d77\u6765\u7528\u7684\u3002</p>\n<h3 id=\"dump-utmp\">dump-utmp<a class=\"headerlink\" href=\"#dump-utmp\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bfc\u51fa\u767b\u5f55\u8bb0\u8d26\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662f <code>/var/log/wtmp</code>\uff0c\u5176\u529f\u80fd\u548c last \u547d\u4ee4\u76f8\u4f3c\u3002</p>\n<h3 id=\"dumpcap\">dumpcap<a class=\"headerlink\" href=\"#dumpcap\" title=\"Permanent link\">&para;</a></h3>\n<p>dump \u7f51\u7edc\u5305\uff0c\u4ed6\u6293\u83b7\u7f51\u7edc\u6570\u636e\u5305\u5e76\u5199\u5165\u6587\u4ef6\uff0c\u6587\u4ef6\u683c\u5f0f\u53ef\u4ee5\u662f libcap \u7684\uff0c\u4e5f\u53ef\u4ee5\u662f ethereal \u7684\uff0c\u5f53\u7136\u4e5f\u80fd\u662f tcpdump \u7684\u3002\n\u4f46\u662f\u6211\u4e0d\u77e5\u9053\u4ed6\u548c tcpdump \u6709\u4ec0\u4e48\u4e0d\u540c,Google \u4e86\u4e00\u4e0b\uff0c\u4e5f\u6ca1\u6709\u53d1\u73b0\u4ec0\u4e48\uff0c\u6211\u89c9\u5f97\u8fd9\u4e0d\u91cd\u8981\uff0cLinux \u4e0b\u4e0d\u662f\u7ecf\u5e38\u5bf9\u67d0\u4e00\u4e2a\u529f\u80fd\uff0c\u6709\u4e00\u6253\u7684\u547d\u4ee4\u53ef\u4ee5\u5b9e\u73b0\u5417\uff1f</p>\n<p>man \u624b\u518c\u7ed9\u51fa\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">#dumpcap -i eth1 -a duration:60 -w output.pcap</span>\n</code></pre></div>\n<p>\u8868\u793a\u6293\u53d6\u901a\u8fc7 eth1,60 \u79d2\u5185\u7684\u6570\u636e\u5305\uff0c\u5e76\u5230\u6587\u4ef6<code>output.cap</code>\u3002\u6293\u51fa\u7684\u5305\u5185\u5bb9\u5927\u81f4\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># cat output.pcap |more</span>\nAccept:<span class=\"w\"> </span>*/*\nAccept-Language:<span class=\"w\"> </span>en-us\nUser-Agent:<span class=\"w\"> </span>MSMSGS\nHost:<span class=\"w\"> </span><span class=\"m\">207</span>.46.106.77\nProxy-Connection:<span class=\"w\"> </span>Keep-Alive\nConnection:<span class=\"w\"> </span>Keep-Alive\nPragma:<span class=\"w\"> </span>no-cache\nContent-Type:<span class=\"w\"> </span>application/x-msn-messenger\nContent-Length:<span class=\"w\"> </span><span class=\"m\">0</span>\n\n0F\ufffd\n<span class=\"m\">2</span>^<span class=\"w\"> </span>english<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span><span class=\"nv\">onclick</span><span class=\"o\">=</span><span class=\"s2\">&quot;return top.js.OpenExtLink(window,event,this)&quot;</span>&gt;\nother\n<span class=\"p\">&amp;</span>nbsp<span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"filefrag\">filefrag<a class=\"headerlink\" href=\"#filefrag\" title=\"Permanent link\">&para;</a></h3>\n<p>Linux \u4e0b\u7684\u6587\u4ef6\u7cfb\u7edf\u76f8\u6bd4 Windows \u7684\u6587\u4ef6\u7cfb\u7edf\u8981\u4f18\u8d8a\uff0c\u5176\u4e2d\u4e00\u70b9\u5c31\u662f\u4e0d\u7528\u505a\u78c1\u76d8\u788e\u7247\u6574\u7406\uff0c\u4f46\u662f\u8fd9\u5e76\u4e0d\u610f\u5473\u7740 Linux \u4e0b\u7684\u78c1\u76d8\u8bfb\u5199\u5c31\u4e0d\u4f1a\u4ea7\u751f\u788e\u7247\u3002</p>\n<p>filefrag \u8fd9\u4e2a\u547d\u4ee4\u5c31\u662f\u7528\u6765\u62a5\u544a\u4e00\u4e2a\u6587\u4ef6\u662f\u5426\u6709\u788e\u7247\u7684\u7a0b\u5e8f\u3002\u770b\u51e0\u4e2a\u4f8b\u5b50</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># filefrag /etc/passwd -v</span>\nChecking<span class=\"w\"> </span>/etc/passwd\nFilesystem<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>is:<span class=\"w\"> </span>ef53\nFilesystem<span class=\"w\"> </span>cylinder<span class=\"w\"> </span>groups<span class=\"w\"> </span>is<span class=\"w\"> </span>approximately<span class=\"w\"> </span><span class=\"m\">848</span>\nBlocksize<span class=\"w\"> </span>of<span class=\"w\"> </span>file<span class=\"w\"> </span>/etc/passwd<span class=\"w\"> </span>is<span class=\"w\"> </span><span class=\"m\">1024</span>\nFile<span class=\"w\"> </span>size<span class=\"w\"> </span>of<span class=\"w\"> </span>/etc/passwd<span class=\"w\"> </span>is<span class=\"w\"> </span><span class=\"m\">1534</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">2</span><span class=\"w\"> </span>blocks<span class=\"o\">)</span>\nFirst<span class=\"w\"> </span>block:<span class=\"w\"> </span><span class=\"m\">4245865</span>\nLast<span class=\"w\"> </span>block:<span class=\"w\"> </span><span class=\"m\">4245866</span>\n/etc/passwd:<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>extent<span class=\"w\"> </span>found\n\n<span class=\"c1\"># filefrag /data/tools/db2_v9.iso</span>\n/data/tools/db2_v9.iso:<span class=\"w\"> </span><span class=\"m\">73</span><span class=\"w\"> </span>extents<span class=\"w\"> </span>found,<span class=\"w\"> </span>perfection<span class=\"w\"> </span>would<span class=\"w\"> </span>be<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>extents\n\n<span class=\"c1\"># filefrag /data/tools/db2_v9.iso -v</span>\nChecking<span class=\"w\"> </span>/data/tools/db2_v9.iso\nFilesystem<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>is:<span class=\"w\"> </span>ef53\nFilesystem<span class=\"w\"> </span>cylinder<span class=\"w\"> </span>groups<span class=\"w\"> </span>is<span class=\"w\"> </span>approximately<span class=\"w\"> </span><span class=\"m\">245</span>\nBlocksize<span class=\"w\"> </span>of<span class=\"w\"> </span>file<span class=\"w\"> </span>/data/tools/db2_v9.iso<span class=\"w\"> </span>is<span class=\"w\"> </span><span class=\"m\">4096</span>\nFile<span class=\"w\"> </span>size<span class=\"w\"> </span>of<span class=\"w\"> </span>/data/tools/db2_v9.iso<span class=\"w\"> </span>is<span class=\"w\"> </span><span class=\"m\">330647552</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">80725</span><span class=\"w\"> </span>blocks<span class=\"o\">)</span>\nFirst<span class=\"w\"> </span>block:<span class=\"w\"> </span><span class=\"m\">3851518</span>\nLast<span class=\"w\"> </span>block:<span class=\"w\"> </span><span class=\"m\">3954148</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">769</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3852400</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3852287</span><span class=\"o\">)</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">811</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3852471</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3852441</span><span class=\"o\">)</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">844</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3852560</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3852503</span><span class=\"o\">)</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">2617</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3854368</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3854335</span><span class=\"o\">)</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">2636</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3854528</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3854386</span><span class=\"o\">)</span>\nDiscontinuity:<span class=\"w\"> </span>Block<span class=\"w\"> </span><span class=\"m\">2662</span><span class=\"w\"> </span>is<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"m\">3854610</span><span class=\"w\"> </span><span class=\"o\">(</span>was<span class=\"w\"> </span><span class=\"m\">3854553</span><span class=\"o\">)</span>\n......\n/data/tools/db2_v9.iso:<span class=\"w\"> </span><span class=\"m\">73</span><span class=\"w\"> </span>extents<span class=\"w\"> </span>found,<span class=\"w\"> </span>perfection<span class=\"w\"> </span>would<span class=\"w\"> </span>be<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>extents\n</code></pre></div>\n<p>\u7b2c\u4e00\u4e2a\u6587\u4ef6<code>/etc/passwd</code>\u6ca1\u6709\u4ea7\u751f\u788e\u7247\uff0c\u4f46\u662f\u7b2c\u4e8c\u4e2a\u6587\u4ef6\u5c31\u4e0d\u540c\u4e86\uff0c\u4e00\u5171\u6709 73 \u4e2a\u4e0d\u8fde\u8d2f\u7684\u5730\u65b9\uff08\u8f93\u51fa\u7701\u7565\u4e86\u4e00\u4e9b\uff09\u3002  </p>\n<p>\u65e2\u7136\u6709\u663e\u793a\u78c1\u76d8\u788e\u7247\u7684\u7a0b\u5e8f\uff0c\u90a3\u6211\u5c31\u60f3\u662f\u5426\u6709\u6574\u7406\u78c1\u76d8\u788e\u7247\u7684\u7a0b\u5e8f\u5462\uff0c\u5230\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\uff0c\u6709\u4eba\u8bf4\u7cfb\u7edf\u4e0a\u6709 defrag \u547d\u4ee4\uff0c\u4f46\u662f\u6211\u7684\u7cfb\u7edf\u663e\u7136\u6ca1\u6709\u3002</p>\n<p>\u8fd8\u6709\u4eba\u8bf4\uff0cLinux \u6839\u672c\u7528\u4e0d\u7740\u505a\u78c1\u76d8\u788e\u7247\u6574\u7406\u3002\u662f\u554a\uff0c\u8bb0\u5f97\u7b2c\u4e00\u6b21\u89e3\u9664 Linux \u7684\u65f6\u5019\uff0c\u5c31\u770b\u5230\u6709\u8fd9\u6837\u7684\u8bdd--Linux \u4e0d\u9700\u8981\u78c1\u76d8\u6574\u7406--\u4e0d\u8fc7\u5982\u679c\u4f60\u771f\u7684\u60f3\u89e3\u51b3\u8fd9\u4e2a\u5176\u5b9e\u4e0d\u662f\u95ee\u9898\u7684\u95ee\u9898\uff0c\u90a3\u4f60\u53ef\u4ee5\u5c1d\u8bd5 fsck\uff0c\n\u7f51\u4e0a\u8bf4\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u6587\u4ef6\u5e26\u6765\u7684\u78c1\u76d8\u788e\u7247\uff0c\u4f46\u662f\u6211\u73b0\u5728\u6ca1\u6709\u505a\u8fd9\u4e2a\u6d4b\u8bd5\u3002\u7b49\u6709\u673a\u4f1a\u5e94\u8be5\u8bd5\u8bd5\u3002</p>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u7684\u6700\u540e\u8f93\u51fa\u201cperfection would be 3 extents\u201d\u6ca1\u6709\u592a\u660e\u767d\u4ed6\u7684\u610f\u601d\uff0c\u662f\u4e0d\u662f\u8bf4\u5982\u679c\u6211\u91c7\u7528\u67d0\u4e2a\u65b9\u5f0f\uff0c\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e9b\u78c1\u76d8\u788e\u7247\u7684\u4e2a\u6570\u7531 73 \u4e2a\u964d\u4f4e\u5230 3 \u4e2a\u5462\uff1f\u7528\u4ec0\u4e48\u6837\u7684\u65b9\u6cd5\u5462\uff1f\u6ca1\u6709\u627e\u5230\u3002</p>\n<h3 id=\"wireshark\">wireshark<a class=\"headerlink\" href=\"#wireshark\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"http://www.wireshark.org/\">wireshark</a>\uff1a\u4e4d\u4e00\u770b\uff0c\u4e0d\u77e5\u9053\u8fd9\u4e2a\u547d\u4ee4\u505a\u4ec0\u4e48\u7528\u7684\uff0cman \u4e86\u4e00\u4e0b\u624b\u518c\uff0c\u5230\u7f51\u7edc\u4e0a\u641c\u5bfb\u4e86\u4e00\u628a\uff0c\u624d\u77e5\u9053\u539f\u6765\u5b83\u662f\u5927\u540d\u9f0e\u9f0e\u7684 Ethereal \u7684\u5316\u8eab\u5440\uff0cethereal \u4f30\u8ba1\u5f88\u591a\u7528\u8fc7 Linux \u7684\u4eba\u90fd\u77e5\u9053\uff0c\u5b83\u662f\u4e16\u754c\u4e0a\u6700\u6d41\u884c\u7684\u7f51\u7edc\u5206\u6790\u5de5\u5177\u4e4b\u4e00\uff0c\u8fd9\u4e2a\u5f3a\u5927\u7684\u5de5\u5177\u53ef\u4ee5\u6355\u6349\u7f51\u7edc\u4e2d\u7684\u6570\u636e\uff0c\u5e76\u672a\u7528\u6237\u63d0\u4f9b\u7f51\u7edc\u548c\u4e0a\u5c42\u534f\u8bae\u7684\u5404\u79cd\u4fe1\u606f\uff0c\u5b83\u5177\u6709\u5b89\u88c5\u7b80\u4fbf\uff0c\u7b80\u5355\u6613\u7528\uff0c\u529f\u80fd\u4e30\u5bcc\u7b49\u7279\u5f81\u3002</p>\n<p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5b83\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u5bb9\u6613\u64cd\u4f5c\u7684\u56fe\u5f62\u754c\u9762\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f CLI \u7684\u6b7b\u5fe0\u5206\u6790\uff0c\u4e5f\u8bb8 tshark \u4f1a\u6210\u4e3a\u4f60\u7684\u6700\u7231\uff0ctshark \u662f wireshark \u7684 CLI \u5b9e\u73b0\u3002</p>\n<h3 id=\"tripwire\">tripwire<a class=\"headerlink\" href=\"#tripwire\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"http://www.tripwire.org\">tripwire</a>\uff1a<code>*nix</code> \u7cfb\u7edf\u4e0b\u6700\u8457\u540d\u7684\u6587\u4ef6\u7cfb\u7edf\u5b8c\u6574\u6027\u68c0\u67e5\u5de5\u5177\uff0c\u8fd9\u4e2a\u8f6f\u4ef6\u91c7\u53d6\u7684\u6838\u5fc3\u6280\u672f\u5c31\u662f\u5bf9\u6bcf\u4e2a\u8981\u76d1\u63a7\u7684\u6587\u4ef6\u4ea7\u751f\u4e00\u4e2a\u6570\u5b57\u7b7e\u540d\u5e76\u4fdd\u7559\u4e0b\u6765\u3002</p>\n<p>\u5f53\u6570\u5b57\u7b7e\u540d\u4e0d\u4e00\u81f4\u65f6\uff0c\u5fc5\u5b9a\u6587\u4ef6\u88ab\u4fee\u6539\u8fc7\u3002\u5f53\u4f60\u8981\u4e3a\u4f60\u7684\u7cfb\u7edf\u5b89\u5168\u7740\u60f3\u7684\u65f6\u5019\uff0c\u4f60\u5e94\u8be5\u60f3\u8d77\u5b83\uff01</p>\n<h3 id=\"vipw\">vipw<a class=\"headerlink\" href=\"#vipw\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0d\u662f\u591a\u4e48\u795e\u5947\u548c\u9ad8\u6df1\u7684\u547d\u4ee4\uff0c\u4e0d\u5e26\u4efb\u4f55\u53c2\u6570\uff0c\u8fd0\u884c\u540e\uff0c\u76f4\u63a5\u6253\u5f00 <code>/etc/passwd</code>\uff0c\u4e8e\u662f\u6211\u77e5\u9053\u8fd9\u4e2a\u547d\u4ee4\u7684\u610f\u601d\u4e86<code>vipw = vi /etc/passwd</code>\uff0c\u4ee5\u4e3a\u662f\u4e00\u4e2a\u811a\u672c\uff0c\u7136\u540e vipw \u662f\u4e00\u4e2a\u5730\u5730\u9053\u9053\u7684 ELF \u6587\u4ef6\uff0c\u5b9e\u9645\u4e0a\u4ed6\u662f VIM \u7684 tiny \u7248\u7684\u5b9e\u73b0\u3002<br />\n\u4e0d\u6653\u5f97\u4f5c\u8005\u5199\u8fd9\u4e2a\u7a0b\u5e8f\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f\u4ec5\u4ec5\u662f\u4e3a\u4e86\u65b9\u4fbf\u7f16\u8f91<code>/etc/passwd</code>\uff1f\u8fd8\u662f\u8bf4\u4e07\u4e00\u7cfb\u7edf\u6ca1\u6709\u5b89\u88c5\u7f16\u8f91\u5668\uff0c\u6211\u8fd8\u7528\u5b83\u5f53\u505a\u7f16\u8f91\u5668\u7528\uff0c  </p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["commands", "linux"]}, {"id": "https://wgzhao.github.io/notes/courses/linux-cfs-scheduler/", "url": "https://wgzhao.github.io/notes/courses/linux-cfs-scheduler/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "Linux CFS \u8c03\u5ea6\u5668\uff1a\u539f\u7406\u3001\u8bbe\u8ba1\u4e0e\u5185\u6838\u5b9e\u73b0", "content_html": "<h1 id=\"linux-cfs\">Linux CFS \u8c03\u5ea6\u5668\uff1a\u539f\u7406\u3001\u8bbe\u8ba1\u4e0e\u5185\u6838\u5b9e\u73b0<a class=\"headerlink\" href=\"#linux-cfs\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://arthurchiao.art/blog/linux-cfs-design-and-implementation-zh/\" title=\"Permalink to Linux CFS \u8c03\u5ea6\u5668\uff1a\u539f\u7406\u3001\u8bbe\u8ba1\u4e0e\u5185\u6838\u5b9e\u73b0\uff082023\uff09\">Source</a></p>\n<p>\u6574\u7406\u4e00\u4e9b Linux \u9ed8\u8ba4\u8c03\u5ea6\u5668 CFS \u76f8\u5173\u7684\u4e1c\u897f\u3002CFS\u3001cgroup \u7b49\u5185\u6838\u6280\u672f\u5408\u529b\u5b9e\u73b0\u4e86\u8fdb\u7a0b\u7684 CPU \u8d44\u6e90\u9650\u989d\uff08<strong>CPU \u5e26\u5bbd\u63a7\u5236</strong>\uff09\uff0c\u8fd9\u662f\u5bb9\u5668\u7684\u57fa\u7840\u4e4b\u4e00\u3002</p>\n<h1 id=\"1\">1 \u6982\u5ff5\u53ca\u5173\u7cfb<a class=\"headerlink\" href=\"#1\" title=\"Permanent link\">&para;</a></h1>\n<p>\u9996\u5148\u7406\u6e05\u51e0\u4e2a\u6982\u5ff5\u548c\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p>\n<h2 id=\"11-cfstask\">1.1 CFS\uff1a\u8fdb\u7a0b\uff08task\uff09\u7684\u516c\u5e73\u8c03\u5ea6<a class=\"headerlink\" href=\"#11-cfstask\" title=\"Permanent link\">&para;</a></h2>\n<p>CFS\uff08Completely Fair Scheduler\uff09\u662f Linux \u5185\u7f6e\uff08\u4e5f\u662f\u76ee\u524d\u9ed8\u8ba4\uff09\u7684\u4e00\u4e2a**\u5185\u6838\u8c03\u5ea6\u5668**\uff0c \u5982\u540d\u5b57\u6240\u793a\uff0c\u5b83\u5b9e\u73b0\u4e86\u6240\u8c13\u7684\u201c\u5b8c\u5168\u516c\u5e73\u201d\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5c06 CPU \u8d44\u6e90\u5747\u5300\u5730\u5206\u914d\u7ed9\u5404\u8fdb\u7a0b\uff08 \u5728\u5185\u6838\u4ee3\u7801\u4e2d\u79f0\u4e3a\u201c\u4efb\u52a1\u201d\uff0ctask\uff09\u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u53f0\u673a\u5668\u6709\u4e00\u4e2a CPU \u591a\u4e2a\uff08\u8ba1\u7b97\u5bc6\u96c6\u578b\uff09\u8fdb\u7a0b\uff0c\u90a3\u91c7\u7528 CFS \u8c03\u5ea6\u5668\u65f6\uff0c</p>\n<p><img alt=\"\" src=\"../../images/cfs.png\" /></p>\n<ul>\n<li>\u4e24\u4e2a\u8fdb\u7a0b\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u4f1a\u5404\u5360 50% CPU \u65f6\u95f4\uff1b</li>\n<li>\u56db\u4e2a\u8fdb\u7a0b\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u4f1a\u5404\u5360 25% CPU \u65f6\u95f4\uff1b</li>\n</ul>\n<p>\u8fd9\u4e2a\u5f88\u597d\u7406\u89e3\u3002\u63a5\u4e0b\u6765\u770b\u7b2c\u4e8c\u4e2a\u6982\u5ff5\u3002</p>\n<h2 id=\"12-cfs\">1.2 CFS \u6269\u5c55<a class=\"headerlink\" href=\"#12-cfs\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u521d\u7684 CFS \u7ba1\u7406\u7684\u662f\u5355\u4e2a\u4efb\u52a1\uff08\u8fdb\u7a0b\uff09\u7684\u8c03\u5ea6\uff0c\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u914d\u516c\u5e73\u7684 CPU \u65f6\u95f4\u3002 \u4f46\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u4f1a\u7ec4\u7ec7\u6210\u8fdb\u7a0b\u7ec4\uff08task group\uff09\u7684\u5f62\u5f0f\uff0c \u7528\u6237\u5e0c\u671b\u5148\u5bf9\u8fdb\u7a0b\u7ec4\u5206\u914d CPU \u4efd\u989d\uff0c\u518d**\u5728\u6bcf\u4e2a\u8fdb\u7a0b\u7ec4\u91cc\u9762\u5b9e\u73b0\u516c\u5e73\u8c03\u5ea6**\u3002</p>\n<p>\u4e3e\u4e2a\u5177\u4f53\u4f8b\u5b50\uff0c\u591a\u4e2a\u7528\u6237\u4f7f\u7528\u540c\u4e00\u53f0\u673a\u5668\u65f6\uff0c\u53ef\u80fd\u5e0c\u671b\uff0c</p>\n<ul>\n<li>\u9996\u5148\u6309 user \u516c\u5e73\uff08\u4e5f\u53ef\u4ee5\u4e0d\u516c\u5e73\uff09\u5206\u914d CPU\uff1b</li>\n<li>\u9488\u5bf9\u6bcf\u4e2a user\uff0c\u518d\u5bf9\u5176\u6240\u6709\u8fdb\u7a0b\u516c\u5e73\u5206\u914d\u8fd9\u4e2a user \u7684\u603b CPU \u65f6\u95f4\u3002</li>\n</ul>\n<p>\u4e3a\u6b64\uff0c<strong>CFS \u5f15\u5165\u4e86\u51e0\u9879\u6269\u5c55</strong>\uff0c\u4f8b\u5982</p>\n<ul>\n<li>\u5b9e\u65f6\u4efb\u52a1\u7684\u7ec4\u8c03\u5ea6\uff08RT group\uff09</li>\n<li>\u5e38\u89c4\u8fdb\u7a0b\u7684\u7ec4\u8c03\u5ea6\uff08task group\uff09</li>\n</ul>\n<p>\u4f46\u5b9e\u73b0\u8fd9\u51e0\u4e2a\u6269\u5c55\u662f\u9700\u8981\u4e00\u4e9b\u524d\u63d0\u7684\u3002</p>\n<h3 id=\"121-config_cgroups\">1.2.1 \u524d\u63d0\uff1a<code>CONFIG_CGROUPS</code><a class=\"headerlink\" href=\"#121-config_cgroups\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8981\u5b9e\u73b0\u6309\u8fdb\u7a0b\u7ec4\u5206\u914d\u548c\u7ba1\u7406 CPU \u4efd\u989d\u7684\u529f\u80fd\uff0c\u9996\u5148\u8981\u80fd\u591f\u63a7\u5236\uff08<strong>control</strong>\uff09 \u8fdb\u7a0b\u7ec4\uff08task <strong>group</strong>\uff09\u7684\u8d44\u6e90\u9650\u989d\uff0c \u8fd9\u79cd\u6280\u672f\u5728 Linux \u5185\u6838\u4e2d\u5df2\u7ecf\u6709\u4e86\uff0c\u53eb**\u63a7\u5236\u7ec4\uff08control group\uff09<strong>\uff0c\u7f29\u5199\u662f cgroup\u3002 \uff08</strong><code>CONFIG_CGROUPS</code>**\uff09\u3002</p>\n<ul>\n<li>cgroup \u6709\u4e24\u4e2a\u7248\u672c\uff0c\u5206\u522b\u79f0\u4e3a cgroup v1 \u548c cgroup v2\u3002\u8fd9\u4e24\u4e2a\u7248\u672c**\u4e0d\u517c\u5bb9**\uff0c\u73b0\u5728\u9ed8\u8ba4\u90fd\u662f\u7528\u7684 v1\uff1b</li>\n<li>\u6709\u4e86 <code>cgroup</code>\uff0c\u8c03\u5ea6\u5668\u5c31\u80fd\u901a\u8fc7 <code>cgroup</code> \u4f2a\u6587\u4ef6\u7cfb\u7edf\u6765\u7ba1\u7406\u8fdb\u7a0b\u7ec4\u5360\u7528\u7684\u8d44\u6e90\uff08\u6211\u4eec\u8fd9\u91cc\u5173\u5fc3\u7684\u662fCPU \u8d44\u6e90\uff09\u4e86\uff1b</li>\n<li>\u66f4\u591a\u4fe1\u606f\u89c1 <a href=\"https://www.kernel.org/doc/Documentation/admin-guide/cgroup-v1/cgroups.rst\">Documentation/admin-guide/cgroup-v1/cgroups.rst</a>\u3002</li>\n</ul>\n<h3 id=\"122-config_cgroup_sched\">1.2.2 \u524d\u63d0\uff1a<code>CONFIG_CGROUP_SCHED</code><a class=\"headerlink\" href=\"#122-config_cgroup_sched\" title=\"Permanent link\">&para;</a></h3>\n<p>cgroup \u662f\u6309\u8d44\u6e90\u7c7b\u578b\uff08cpu/memory/device/hugetlb/\u2026\uff09\u6765\u505a\u8d44\u6e90\u9650\u989d\u7684\uff0c\u6bcf\u79cd\u8d44\u6e90 \u7c7b\u578b\u4f1a\u6709\u4e00\u79cd\u5bf9\u5e94\u7684\u63a7\u5236\u5668\uff08controller\uff09\uff0c\u6709\u72ec\u7acb\u7684\u5f00\u5173\u3002 \u63a7\u5236**\u8fdb\u7a0b\u6216\u8fdb\u7a0b\u7ec4\u80fd\u4f7f\u7528\u7684 CPU \u65f6\u95f4**\uff0c\u5bf9\u5e94\u7684\u5f00\u5173\u662f <code>CONFIG_CGROUP_SCHED</code>\u3002</p>\n<p>\u81f3\u6b64\uff0c\u652f\u6301\u8fdb\u7a0b\u7ec4\u7ea7\u522b\u8d44\u6e90\u63a7\u5236\u7684\u57fa\u7840\u5c31\u5177\u5907\u4e86\u3002\u63a5\u4e0b\u6765\u5c31\u662f CFS \u6269\u5c55\u4ee3\u7801\u7684\u5b9e\u73b0\uff0c \u6dfb\u52a0\u5bf9\u4e8e realtime/conventional task group \u7684\u652f\u6301\u3002\u4e0b\u9762\u5206\u522b\u6765\u770b\u4e0b\u3002</p>\n<h3 id=\"123-config_rt_group_sched\">1.2.3 \u6269\u5c55\uff1a\u652f\u6301\u5b9e\u65f6\u8fdb\u7a0b\u7ec4\uff08<code>CONFIG_RT_GROUP_SCHED</code>\uff09<a class=\"headerlink\" href=\"#123-config_rt_group_sched\" title=\"Permanent link\">&para;</a></h3>\n<p><code>CONFIG_RT_GROUP_SCHED</code> \u652f\u6301\u5bf9 real-time (SCHED_FIFO and SCHED_RR) \u4efb\u52a1\u8fdb\u884c\u5206\u7ec4 CFS\u3002</p>\n<p>\u5b9e\u65f6\u8fdb\u7a0b\u6709\u4e25\u683c\u7684\u54cd\u5e94\u65f6\u95f4\u9650\u5236\uff0c\u4e0d\u7ba1\u673a\u5668\u7684 load \u6709\u591a\u9ad8\uff0c\u90fd\u5e94\u8be5\u786e\u4fdd\u8fd9\u4e9b\u8fdb\u7a0b\u7684\u54cd\u5e94\u5b9e\u65f6\u6027\u3002 \u4f8b\u5b50\uff1a\u5185\u6838\u4e2d\u7684 <strong><code>migration</code></strong> \u8fdb\u7a0b\uff0c\u8d1f\u8d23\u5728\u4e0d\u540c CPU \u4e4b\u95f4\u5206\u53d1\u4efb\u52a1\uff08\u8fdb\u7a0b\u8d1f\u8f7d\u5747\u8861\uff09\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>ps<span class=\"w\"> </span>-ef<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>migration\nroot<span class=\"w\">          </span><span class=\"m\">12</span><span class=\"w\">       </span><span class=\"m\">2</span><span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">       </span><span class=\"m\">00</span>:00:01<span class=\"w\"> </span><span class=\"o\">[</span>migration/0<span class=\"o\">]</span>\n</code></pre></div>\n<h3 id=\"124-config_fair_group_sched\">1.2.4 \u6269\u5c55\uff1a\u652f\u6301\u5e38\u89c4\u8fdb\u7a0b\u7ec4\uff08<code>CONFIG_FAIR_GROUP_SCHED</code>\uff09<a class=\"headerlink\" href=\"#124-config_fair_group_sched\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b9e\u65f6\u8fdb\u7a0b\u4e4b\u5916\u7684\u8fdb\u7a0b\u5c31\u662f\u6240\u8c13\u7684**\u5e38\u89c4\u8fdb\u7a0b**\uff0c\u5b83\u4eec\u6ca1\u6709\u4e25\u683c\u7684\u54cd\u5e94\u65f6\u95f4\u9650\u5236\uff0c \u5f53\u7cfb\u7edf\u7e41\u5fd9\u65f6\uff0c\u54cd\u5e94\u5ef6\u8fdf\u5c31\u4f1a\u589e\u52a0\u3002</p>\n<p>\u5728 cgroup \u6280\u672f\u57fa\u7840\u4e0a\u4e0a\uff0c\u518d\u5bf9 CFS \u4ee3\u7801\u505a\u4e00\u4e9b\u589e\u5f3a\uff0c\u5c31\u80fd\u591f\u652f\u6301\u8fdb\u7a0b\u7ec4\u5185\u7684\u516c\u5e73\u8c03\u5ea6\u4e86\u3002 \u8fd9\u4e9b\u589e\u5f3a\u4ee3\u7801\u662f\u901a\u8fc7\u7f16\u8bd1\u9009\u9879 <strong><code>CONFIG_FAIR_GROUP_SCHED</code></strong> \u63a7\u5236\u7684\u3002 \u652f\u6301\u5bf9\u666e\u901a CFS (SCHED_NORMAL, SCHED_BATCH) \u4efb\u52a1\u8fdb\u884c\u5206\u7ec4\u3002</p>\n<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u5bf9\u8fdb\u7a0b\u548c\u8fdb\u7a0b\u7ec4\u8fdb\u884c CFS \u8c03\u5ea6\u3002</p>\n<h2 id=\"13-cfs-cpu\">1.3 \u5e38\u89c4\u8fdb\u7a0b\u7ec4 CFS \u518d\u6269\u5c55\uff1a\u652f\u6301 CPU \u5e26\u5bbd\u63a7\u5236\uff08\u9650\u989d\uff09<a class=\"headerlink\" href=\"#13-cfs-cpu\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"131-cfs\">1.3.1 CFS \u5b58\u5728\u7684\u95ee\u9898<a class=\"headerlink\" href=\"#131-cfs\" title=\"Permanent link\">&para;</a></h3>\n<p>CFS \u81ea\u5df1\u4e5f\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\u6216\u9650\u5236\uff1a</p>\n<ol>\n<li>\u67d0\u4e9b\u60c5\u51b5\u4e0b\u505a\u4e0d\u5230\u771f\u6b63\u7684\u516c\u5e73\u3002</li>\n</ol>\n<p>CFS \u672c\u8d28\u4e0a\u662f\u4f1a\u628a CPU \u7528\u6ee1\u7684\uff08work-conserving\uff09\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a CPU \u4e0a \u6709\u4e24\u4e2a\u4efb\u52a1\uff0c\u7406\u8bba\u4e0a\u5e94\u8be5\u5404\u5360\u7528 50% \u7684 CPU\uff1b\u4f46\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u4efb\u52a1\u6709\u5f88\u591a sleep/wait \u65f6\u95f4\uff0c CFS \u5c31\u4f1a\u628a\u591a\u4f59\u7684\u65f6\u95f4\u7ed9\u5230\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\uff0c\u5bfc\u81f4\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u95f4\u8d85\u8fc7\u4e00\u534a\u3002\n2. \u4f18\u5148\u7ea7\u9ad8\u7684\u8fdb\u7a0b\u4ecd\u7136\u53ef\u80fd\u83b7\u5f97\u66f4\u5927\u7684\u65f6\u95f4\u7247\u3002</p>\n<p>\u5185\u6838\u4e2d\u6709\u4e24\u4e2d\u8c03\u5ea6\u7c7b\uff08scheduling class\uff09\uff1aSCHED_RT \u548c SCHED_NORMAL\uff0c\u524d\u8005\u7684\u4f18\u5148\u7ea7\u66f4\u5927\u3002 \u5f53\u4e00\u4e2a CPU \u4e0a\u6709 RT \u7c7b\u578b\u4efb\u52a1\u65f6\uff0c\u6c38\u8fdc\u662f\u5b83\u4eec\u5148\u6267\u884c\u3002\u4f18\u5148\u7ea7\u53ef\u4ee5\u901a\u8fc7 <code>nice(2)</code> \u63a7\u5236\u3002\n3. \u65e0\u6cd5\u8bbe\u7f6e CPU \u4f7f\u7528\u4e0a\u9650\u3002</p>\n<p>CFS <strong>\u53ea\u5173\u6ce8 CPU \u5e73\u5747\u5206\u914d\uff0c\u5e76\u4e0d\u4fdd\u8bc1 CPU \u65f6\u95f4</strong>\uff08\u4e0a\u4e0b\u9650\uff09\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0cCPU share/quota \u53ea\u6709\u76f8\u5bf9\u610f\u4e49\uff0cshare \u5927\u7684\u4e00\u5b9a\u6bd4 share \u5c0f\u7684\u80fd\u5206\u5230\u66f4\u591a CPU\uff0c\u4ec5\u6b64\u800c\u5df2\u3002 \u8fdb\u7a0b\u8d8a\u591a\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u5230\u7684 CPU \u65f6\u95f4\u8d8a\u5c11\u3002 CPU \u9650\u989d\uff08\u4e0a\u9650\uff09\u5bf9**\u6309 CPU \u65f6\u95f4\u8ba1\u8d39**\u7684\u573a\u666f\u975e\u5e38\u5173\u952e\uff0c\u4f8b\u5982\u516c\u6709\u4e91\u3002</p>\n<pre class=\"mermaid\"><code>%%{ init: { 'flowchart': { 'curve': 'bumpX' } } }%%\ngraph TB\nrg([\"Root group/&lt;br&gt;(no tasks directrly under root)&lt;br/&gt; CPU:100%&lt;br/&gt;shares: 1024\"])\nprof[\"professor&lt;br&gt;CPU:50%&lt;br&gt;shares:1024\"]\nstu[\"students&lt;br&gt;CPU:25%&lt;br&gt;shares:1024\"]\nsys[\"system_tasks&lt;br&gt;CPU:25%&lt;br&gt;shares:1024\"]\ne1[\"Electronics Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne2[\"Electronics Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne3[\"Computers Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne4[\"Other Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\n\nrg ---&gt; prof &amp; stu &amp; sys\nstu ---&gt; e1 &amp; e2 &amp; e3 &amp; e</code></pre>\n<p>\u56fe\u7247\u6765\u81ea google paper [5]\u3002\u6ce8\u610f\uff1a\u4e25\u683c\u6765\u8bf4\uff0c\u8fd9\u91cc\u7684\u76f8\u5bf9\u65f6\u95f4\u8fd8\u53ea\u662f\u5728 SCHED_NORMAL \u91cc\u7684\u65f6\u95f4\uff0c\u4e0d\u5305\u62ec SCHED_RT \u8fdb\u7a0b\u5360\u6389\u7684 CPU \u65f6\u95f4\u3002</p>\n<h3 id=\"132-config_cfs_bandwidth\">1.3.2 <code>CONFIG_CFS_BANDWIDTH</code><a class=\"headerlink\" href=\"#132-config_cfs_bandwidth\" title=\"Permanent link\">&para;</a></h3>\n<blockquote>\n<p>\u4e25\u683c\u6765\u8bf4\uff0cLinux \u4e2d\u7684\u8c03\u5ea6\u5355\u4f4d\u662f\u7ebf\u7a0b\uff08thread\uff09\uff0c\u56e0\u6b64\u5728\u8c03\u5ea6\u4e0a\u4e0b\u6587\u4e2d\u5e76\u6ca1\u6709\u8fdb\u7a0b\uff08process\uff09\u7684\u6982\u5ff5\u3002</p>\n</blockquote>\n<p>\u57fa\u4e8e\u4ee5\u4e0a\u539f\u56e0\uff0cGoogle \u63d0\u51fa\u4e86 <strong>CFS CPU \u5e26\u5bbd\u63a7\u5236</strong>\uff08CFS bandwidth control\uff09\u65b9\u6848\uff0c\u5e76\u5408\u5e76\u5230\u4e86\u4e3b\u7ebf\u5185\u6838\u3002 \u8fd9\u91cc\u7684\u201cCPU \u5e26\u5bbd\u201d\u6307\u7684\u5c31\u662f CPU \u4efd\u989d\uff0c\u6216\u8005\u8bf4\u7684\u66f4\u6e05\u695a\u70b9\uff0cCPU \u6bd4\u4f8b\u3002 SCHED_RT \u4e2d\u5176\u5b9e\u5df2\u7ecf\u6709\u8fd9\u4e2a\u529f\u80fd\uff0c\u8fd9\u91cc\u6307\u7684\u662f SCHED_NORMAL \u652f\u6301\u8fd9\u4e2a\u529f\u80fd\u3002</p>\n<p>\u8fd9\u4e2a\u529f\u80fd\u7684\u597d\u5904\u4e3b\u8981\u662f\u7ed9\u670d\u52a1\u5668\uff0c\u4e0d\u662f\u7ed9\u684c\u9762\u7535\u8111\u3002 \u597d\u5904\uff1a</p>\n<ul>\n<li>\u80fd\u7cbe\u786e\u63a7\u5236\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684 CPU \u5e26\u5bbd\u4e0a\u9650\uff1b\u6bd4\u5982\u8bbe\u7f6e\u4e00\u4e2a\u5bb9\u5668\u53ea\u80fd\u4f7f\u7528 0.2 CPU\uff0c \u90a3\u5b83\u7684\u603b\u65f6\u95f4\u5c31\u4e0d\u80fd\u8d85\u8fc7\u8fd9\u4e2a\u6bd4\u4f8b\uff0c\u5373\u4f7f\u8fd9\u4e2a CPU \u975e\u5e38\u7a7a\u95f2\uff1b</li>\n<li>\u5bf9\u5bb9\u91cf\u89c4\u5212\u975e\u5e38\u6709\u7528\uff08\u4f8b\u5982 OpenStack \u8c03\u5ea6 VM\uff0ck8s \u8c03\u5ea6 pod\uff09\uff1b</li>\n<li>\u5ef6\u8fdf\u66f4\u6709\u4fdd\u8bc1\uff1b</li>\n</ul>\n<h2 id=\"14-cfs-bandwith\">1.4 CFS BANDWITH \u8fd1\u51e0\u5e74\u6539\u8fdb<a class=\"headerlink\" href=\"#14-cfs-bandwith\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>burst \u7279\u6027\uff1a\u5141\u8bb8\u501f\u7528\u524d\u4e00\u4e2a\u8fdb\u7a0b\u5269\u4e0b\u7684\u5e26\u5bbd\u3002</li>\n</ul>\n<h2 id=\"15-cfs\">1.5 \u5c0f\u7ed3\uff1aCFS \u76f8\u5173\u5185\u6838\u7f16\u8bd1\u9009\u9879\u7684\u5173\u7cfb<a class=\"headerlink\" href=\"#15-cfs\" title=\"Permanent link\">&para;</a></h2>\n<p>\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u63d0\u5230\u7684 CFS \u76f8\u5173\u529f\u80fd\uff0c\u5b83\u4eec\u7684\u914d\u7f6e\u9009\u9879\u6216\u4f9d\u8d56\u5173\u7cfb\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>CONFIG_CGROUPS                     # 1. \u662f\u5426\u652f\u6301 cgroup\uff0c\u4e0b\u9762\u8fdb\u4e00\u6b65\u533a\u5206 cpu/memory/hugetlb/...\n  |-CONFIG_MEMCG                   #   1.1 \u662f\u5426\u652f\u6301 memory cgroup\n  |-CONFIG_BLK_CGROUP              #   1.2 \u662f\u5426\u652f\u6301 blkio cgroup\n  |-CONFIG_CGROUP_SCHED            #   1.3 \u662f\u5426\u652f\u6301 cpu cgroup\n  |   |-CONFIG_RT_GROUP_SCHED      #     1.3.1 \u662f\u5426\u652f\u6301 realtime scheduler cpu cgroup\n  |   |-CONFIG_FAIR_GROUP_SCHED    #     1.3.2 \u662f\u5426\u652f\u6301 cfs for task cgroup\n  |       |-CONFIG_CFS_BANDWIDTH   #       1.3.2.1 \u662f\u5426\u652f\u6301 cfs cpu bandwidth\n  |\n  |-CONFIG_CGROUP_PIDS             #   1.4 \u662f\u5426\u652f\u6301 pid cgroup\n  |-CONFIG_CPUSETS                 #   1.5 \u662f\u5426\u652f\u6301 cpuset cgroup\n  |-CONFIG_CGROUP_DEVICE           #   1.6 \u662f\u5426\u652f\u6301 device cgroup\n  |-CONFIG_CGROUP_CPUACCT          #   1.7 \u662f\u5426\u652f\u6301 cpu,acc cgroup\n  |-...                            #   1.8 \u662f\u5426\u652f\u6301 ... cgroup\n</code></pre></div>\n<p>\u8fd9\u4e9b\u5b8f\u5b9a\u4e49\uff08\u7f16\u8bd1\u5f00\u5173\uff09\u7684\u5c42\u6b21\u5173\u7cfb\u5728 <code>init/Kconfig</code> \u4e2d\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5728\u7236\u4e00\u7ea7\u5f00\u5173\u4e3a yes \u7684\u6761\u4ef6\u4e0b\uff0c\u624d\u4f1a\u6709\u5b50\u4e00\u7ea7\u7684\u5f00\u5173\u3002 \u4f8b\u5982\uff0c\u8981\u542f\u7528 CFS CPU \u5e26\u5bbd\u63a7\u5236\u529f\u80fd\uff0c\u5c31\u5fc5\u987b\u8981\u6709\uff1a <code>CONFIG_CGROUPS=y &amp;&amp; CONFIG_CGROUP_SCHED=y &amp;&amp; CONFIG_FAIR_GROUP_SCHED=y &amp;&amp; CONFIG_CFS_BANDWIDTH=y</code> \u8fd9\u662f\u672c\u6587\u63a5\u4e0b\u6765\u5c06\u91cd\u70b9\u5173\u6ce8\u7684\u90e8\u5206\uff08<strong><code>1 -&gt; 1.3 -&gt; 1.3.2 -&gt; 1.3.2.1</code></strong>\uff09\u3002</p>\n<p>\u5404\u5f00\u5173\u7684\u8be6\u7ec6\u89e3\u91ca\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// init/Kconfig</span>\n\n<span class=\"n\">menuconfig</span><span class=\"w\"> </span><span class=\"n\">CGROUPS</span>\n<span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Control Group support&quot;</span>\n<span class=\"w\">    </span><span class=\"n\">help</span>\n<span class=\"w\">      </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">adds</span><span class=\"w\"> </span><span class=\"n\">support</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">grouping</span><span class=\"w\"> </span><span class=\"n\">sets</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">processes</span><span class=\"w\"> </span><span class=\"n\">together</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">for</span>\n<span class=\"w\">      </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"n\">subsystems</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">Cpusets</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">CFS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">controls</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"> </span><span class=\"n\">isolation</span><span class=\"p\">.</span>\n<span class=\"w\">      </span><span class=\"n\">See</span>\n<span class=\"w\">        </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">Documentation</span><span class=\"o\">/</span><span class=\"n\">scheduler</span><span class=\"o\">/</span><span class=\"n\">sched</span><span class=\"o\">-</span><span class=\"n\">design</span><span class=\"o\">-</span><span class=\"n\">CFS</span><span class=\"p\">.</span><span class=\"n\">rst</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">CFS</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">Documentation</span><span class=\"o\">/</span><span class=\"n\">admin</span><span class=\"o\">-</span><span class=\"n\">guide</span><span class=\"o\">/</span><span class=\"n\">cgroup</span><span class=\"o\">-</span><span class=\"n\">v1</span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">grouping</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">isolation</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">control</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">CGROUPS</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">MEMCG</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Memory controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">select</span><span class=\"w\"> </span><span class=\"n\">PAGE_COUNTER</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">Provides</span><span class=\"w\"> </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">footprint</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">cgroup</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">BLK_CGROUP</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;IO controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">depends</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">BLOCK</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">Generic</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">controller</span><span class=\"w\"> </span><span class=\"n\">cgroup</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">common</span>\n<span class=\"w\">          </span><span class=\"n\">cgroup</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">various</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">controlling</span><span class=\"w\"> </span><span class=\"n\">policies</span><span class=\"p\">.</span>\n\n<span class=\"w\">          </span><span class=\"n\">Currently</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">CFQ</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">scheduler</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">recognize</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"w\"> </span><span class=\"n\">and</span>\n<span class=\"w\">          </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"n\">disk</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">allocation</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">proportional</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"n\">allocation</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">It</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">bio</span><span class=\"w\"> </span><span class=\"n\">throttling</span><span class=\"w\"> </span><span class=\"n\">logic</span><span class=\"w\"> </span><span class=\"n\">in</span>\n<span class=\"w\">          </span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"n\">layer</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">implement</span><span class=\"w\"> </span><span class=\"n\">upper</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">rates</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">.</span>\n\n<span class=\"w\">          </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">enables</span><span class=\"w\"> </span><span class=\"n\">generic</span><span class=\"w\"> </span><span class=\"n\">Block</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">controller</span><span class=\"w\"> </span><span class=\"n\">infrastructure</span><span class=\"p\">.</span>\n<span class=\"w\">          </span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">needs</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">enable</span><span class=\"w\"> </span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">controlling</span><span class=\"w\"> </span><span class=\"n\">logic</span><span class=\"o\">/</span><span class=\"n\">policy</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">For</span>\n<span class=\"w\">          </span><span class=\"n\">enabling</span><span class=\"w\"> </span><span class=\"n\">proportional</span><span class=\"w\"> </span><span class=\"n\">weight</span><span class=\"w\"> </span><span class=\"n\">division</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">disk</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">CFQ</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span>\n<span class=\"w\">          </span><span class=\"n\">CONFIG_BFQ_GROUP_IOSCHED</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">enabling</span><span class=\"w\"> </span><span class=\"n\">throttling</span><span class=\"w\"> </span><span class=\"n\">policy</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span>\n<span class=\"w\">          </span><span class=\"n\">CONFIG_BLK_DEV_THROTTLING</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"p\">.</span>\n\n<span class=\"w\">          </span><span class=\"n\">See</span><span class=\"w\"> </span><span class=\"n\">Documentation</span><span class=\"o\">/</span><span class=\"n\">admin</span><span class=\"o\">-</span><span class=\"n\">guide</span><span class=\"o\">/</span><span class=\"n\">cgroup</span><span class=\"o\">-</span><span class=\"n\">v1</span><span class=\"o\">/</span><span class=\"n\">blkio</span><span class=\"o\">-</span><span class=\"n\">controller</span><span class=\"p\">.</span><span class=\"n\">rst</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"p\">.</span>\n\n<span class=\"w\">    </span><span class=\"n\">menuconfig</span><span class=\"w\"> </span><span class=\"n\">CGROUP_SCHED</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;CPU controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"n\">lets</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">scheduler</span><span class=\"w\"> </span><span class=\"n\">recognize</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"n\">CPU</span>\n<span class=\"w\">          </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">allocation</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">It</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">cgroups</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">CGROUP_SCHED</span>\n<span class=\"w\">        </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">FAIR_GROUP_SCHED</span>\n<span class=\"w\">            </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Group scheduling for SCHED_OTHER&quot;</span>\n<span class=\"w\">            </span><span class=\"n\">depends</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">CGROUP_SCHED</span>\n<span class=\"w\">            </span><span class=\"k\">default</span><span class=\"w\"> </span><span class=\"n\">CGROUP_SCHED</span>\n\n<span class=\"w\">            </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">CFS_BANDWIDTH</span>\n<span class=\"w\">                </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;CPU bandwidth provisioning for FAIR_GROUP_SCHED&quot;</span>\n<span class=\"w\">                </span><span class=\"n\">depends</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">FAIR_GROUP_SCHED</span>\n<span class=\"w\">                </span><span class=\"n\">help</span>\n<span class=\"w\">                  </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">allows</span><span class=\"w\"> </span><span class=\"n\">users</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">rates</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">limits</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">for</span>\n<span class=\"w\">                  </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">within</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">fair</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"n\">scheduler</span><span class=\"p\">.</span><span class=\"w\">  </span><span class=\"n\">Groups</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">limit</span>\n<span class=\"w\">                  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">considered</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">unconstrained</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">restriction</span><span class=\"p\">.</span>\n<span class=\"w\">                  </span><span class=\"n\">See</span><span class=\"w\"> </span><span class=\"n\">Documentation</span><span class=\"o\">/</span><span class=\"n\">scheduler</span><span class=\"o\">/</span><span class=\"n\">sched</span><span class=\"o\">-</span><span class=\"n\">bwc</span><span class=\"p\">.</span><span class=\"n\">rst</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"p\">.</span>\n<span class=\"w\">        </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">RT_GROUP_SCHED</span>\n<span class=\"w\">            </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Group scheduling for SCHED_RR/FIFO&quot;</span>\n<span class=\"w\">            </span><span class=\"n\">depends</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">CGROUP_SCHED</span>\n<span class=\"w\">            </span><span class=\"n\">help</span>\n<span class=\"w\">              </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"n\">lets</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">explicitly</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">real</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span>\n<span class=\"w\">              </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">groups</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">enabled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">impossible</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"w\">              </span><span class=\"n\">schedule</span><span class=\"w\"> </span><span class=\"n\">realtime</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">non</span><span class=\"o\">-</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">users</span><span class=\"w\"> </span><span class=\"n\">until</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">realtime</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">them</span><span class=\"p\">.</span>\n<span class=\"w\">              </span><span class=\"n\">See</span><span class=\"w\"> </span><span class=\"n\">Documentation</span><span class=\"o\">/</span><span class=\"n\">scheduler</span><span class=\"o\">/</span><span class=\"n\">sched</span><span class=\"o\">-</span><span class=\"n\">rt</span><span class=\"o\">-</span><span class=\"n\">group</span><span class=\"p\">.</span><span class=\"n\">rst</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"n\">endif</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"n\">CGROUP_SCHED</span>\n\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">CGROUP_PIDS</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;PIDs controller&quot;</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">CPUSETS</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Cpuset controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">let</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">manage</span><span class=\"w\"> </span><span class=\"n\">CPUSETs</span><span class=\"w\"> </span><span class=\"n\">which</span>\n<span class=\"w\">          </span><span class=\"n\">allow</span><span class=\"w\"> </span><span class=\"n\">dynamically</span><span class=\"w\"> </span><span class=\"n\">partitioning</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">sets</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">CPUs</span><span class=\"w\"> </span><span class=\"n\">and</span>\n<span class=\"w\">          </span><span class=\"n\">Memory</span><span class=\"w\"> </span><span class=\"n\">Nodes</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">assigning</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">within</span><span class=\"w\"> </span><span class=\"n\">those</span><span class=\"w\"> </span><span class=\"n\">sets</span><span class=\"p\">.</span>\n<span class=\"w\">          </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">primarily</span><span class=\"w\"> </span><span class=\"n\">useful</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">large</span><span class=\"w\"> </span><span class=\"n\">SMP</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">NUMA</span><span class=\"w\"> </span><span class=\"n\">systems</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">CGROUP_DEVICE</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Device controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">Provides</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">cgroup</span><span class=\"w\"> </span><span class=\"n\">controller</span><span class=\"w\"> </span><span class=\"n\">implementing</span><span class=\"w\"> </span><span class=\"n\">whitelists</span><span class=\"w\"> </span><span class=\"k\">for</span>\n<span class=\"w\">          </span><span class=\"n\">devices</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">cgroup</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">mknod</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">CGROUP_CPUACCT</span>\n<span class=\"w\">        </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"s\">&quot;Simple CPU accounting controller&quot;</span>\n<span class=\"w\">        </span><span class=\"n\">help</span>\n<span class=\"w\">          </span><span class=\"n\">Provides</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">simple</span><span class=\"w\"> </span><span class=\"n\">controller</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">monitoring</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">consumed</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">cgroup</span><span class=\"p\">.</span>\n<span class=\"n\">endif</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"w\"> </span><span class=\"n\">CGROUPS</span>\n</code></pre></div>\n<h1 id=\"2-cfs\">2 CFS \u76f8\u5173\u8bbe\u8ba1<a class=\"headerlink\" href=\"#2-cfs\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"21\">2.1 \u8bbe\u8ba1\u76ee\u6807\u548c\u57fa\u672c\u539f\u7406<a class=\"headerlink\" href=\"#21\" title=\"Permanent link\">&para;</a></h2>\n<p>CFS \u65e9\u5728 2007 \u5e74\u5c31\u5408\u5e76\u5230 Linux \u5185\u6838\uff08<code>2.6.23</code>\uff09 <a href=\"https://www.kernel.org/doc/Documentation/admin-guide/cgroup-v1/cgroups.rst\">1</a>\uff0c\u53d6\u4ee3\u4e86\u4e4b\u524d\u8c03\u5ea6\u5668\u4e2d\u7684 SCHED_OTHER \u5b9e\u73b0\u3002 CFS 80% \u7684\u8bbe\u8ba1\u90fd\u53ef\u4ee5\u603b\u7ed3\u4e3a\u4e00\u53e5\u8bdd\uff1a<strong>\u5c06\u771f\u5b9e CPU \u5efa\u6a21\u4e3a\u4e00\u4e2a\u201c\u7406\u60f3\u3001\u7cbe\u786e\u7684\u591a\u4efb\u52a1 CPU\u201d</strong>\u3002 \u201c\u7406\u60f3\u591a\u4efb\u52a1 CPU\u201d \u638c\u63a7 100% \u7269\u7406\u8d44\u6e90\uff0c\u80fd\u7cbe\u786e\u5730\u4ee5\u76f8\u540c\u901f\u5ea6\u5e76\u884c\u6267\u884c\u591a\u4e2a\u8fdb\u7a0b\uff0c \u6bcf\u4e2a\u4efb\u52a1\u7684\u901f\u5ea6\u90fd\u662f <code>1/nr_running</code>\u3002</p>\n<p>\u5185\u6838\u4e3a\u6bcf\u4e2a CPU \u7ef4\u62a4\u4e86\u4e00\u4e2a\u53ef\u8fd0\u884c\u8fdb\u7a0b\u7684\u961f\u5217\uff08runqueue\uff09\uff1b CFS \u6709\u4e00\u4e2a\u53ef\u914d\u7f6e\u7684\u8c03\u5ea6\u5468\u671f <code>sched_latency</code>\uff1b\u63a5\u4e0b\u6765\u7684\u57fa\u672c\u8c03\u5ea6\u8fc7\u7a0b\uff1a</p>\n<ul>\n<li>CFS \u6839\u636e\u5f53\u524d\u53ef\u8fd0\u884c\u8fdb\u7a0b\u7684\u6570\u91cf N\uff0c\u8ba1\u7b97\u5f97\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u5e94\u8be5\u6267\u884c\u7684\u65f6\u95f4 sched_latency/N\uff1b</li>\n<li>\u4f9d\u6b21\u53d6\u51fa\u8fdb\u7a0b\u6267\u884c\u4ee5\u4e0a\u8ba1\u7b97\u51fa\u7684\u65f6\u95f4\uff1b</li>\n<li>\u5982\u679c runqueue \u6709\u53d8\u5316\uff0c\u518d\u91cd\u65b0\u8ba1\u7b97\u53ef\u6267\u884c\u65f6\u95f4\u3002</li>\n</ul>\n<h2 id=\"22\">2.2 \u6838\u5fc3\u6982\u5ff5<a class=\"headerlink\" href=\"#22\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"221-vruntime\">2.2.1 <code>vruntime</code><a class=\"headerlink\" href=\"#221-vruntime\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u771f\u5b9e CPU \u4e0a\uff0c\u4efb\u610f\u65f6\u95f4\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2a\u4efb\u52a1\uff1b\u4e3a\u4e86\u5b9e\u73b0\u201c\u516c\u5e73\u201d\uff0cCFS \u5f15\u5165\u4e86 \u201cvirtual runtime\u201d\uff08\u865a\u62df\u8fd0\u884c\u65f6\u95f4\uff09\u7684\u6982\u5ff5\u3002</p>\n<ul>\n<li>vruntime \u8868\u793a\u8fdb\u7a0b\u771f\u6b63\u5728 CPU \u4e0a\u6267\u884c\u7684\u65f6\u95f4\uff0c\u4e0d\u5305\u62ec\u4efb\u4f55\u5f62\u5f0f\u7684\u7b49\u5f85\u65f6\u95f4\uff1b</li>\n<li>\u6ce8\u610f\u673a\u5668\u4e00\u822c\u90fd\u662f\u591a\u6838\u7684\uff0c\u56e0\u6b64 vruntime \u662f\u5728\u591a\u4e2a CPU \u4e0a\u6267\u884c\u65f6\u95f4\u7684\u7d2f\u52a0\u3002</li>\n</ul>\n<h3 id=\"222-runqueue\">2.2.2 <code>runqueue</code><a class=\"headerlink\" href=\"#222-runqueue\" title=\"Permanent link\">&para;</a></h3>\n<p>\u521a\u624d\u5176\u5b9e\u5df2\u7ecf\u63d0\u5230\u4e86\uff0c\u662f\u6bcf\u4e2a CPU \u4e0a\u7684\u53ef\u8fd0\u884c\u8fdb\u7a0b\u961f\u5217\uff0c\u4e4b\u524d\u5c31\u5df2\u7ecf\u5b58\u5728\uff0c\u5e76\u4e0d\u662f CFS \u5f15\u5165\u7684\u3002</p>\n<h3 id=\"223\">2.2.3 \u57fa\u4e8e\u65f6\u5e8f\u7684\u7ea2\u9ed1\u6811<a class=\"headerlink\" href=\"#223\" title=\"Permanent link\">&para;</a></h3>\n<p>\u54ea\u4e2a\u8fdb\u7a0b vruntime \u6700\u5c0f\uff0c\u8bf4\u660e\u7d2f\u8ba1\u6267\u884c\u65f6\u95f4\u6700\u5c11\uff0c\u4ece\u201c\u516c\u5e73\u201d\u7684\u89d2\u5ea6\u6765\u8bf4\uff0c\u5c31\u9700\u8981\u6267\u884c\u5b83\u3002</p>\n<ul>\n<li>CFS \u7528\u7ea2\u9ed1\u6811\u6765\u7ec4\u7ec7\u8fd9\u4e9b\u8fdb\u7a0b\uff08\u63cf\u8ff0 runqueue\uff09\uff0c\u7528 <strong>vruntime \u505a key</strong>\uff0c \u6240\u4ee5\u8fd9\u662f\u4e00\u4e2a**\u57fa\u4e8e\u65f6\u5e8f\u7684\u7ea2\u9ed1\u6811**\uff08time-ordered rbtree\uff09\uff0c \u6240\u6709 runnable \u7684\u8fdb\u7a0b\u90fd\u662f\u7528 <code>p-&gt;se.vruntime</code> \u4f5c\u4e3a key \u6765\u6392\u5e8f\u7684\u3002</li>\n<li>CFS \u6bcf\u6b21\u53d6\u51fa\u6700\u5de6\u8fb9\u7684\u8fdb\u7a0b\uff08\u7ea2\u9ed1\u6811\u7279\u6027\uff09\uff0c\u6267\u884c\u5b8c\u6210\u540e\u63d2\u5165\u8d8a\u6765\u8d8a\u53f3\u8fb9\uff0c\u8fd9\u6837\u6bcf\u4e2a\u4efb\u52a1\u90fd\u6709\u673a\u4f1a\u6210\u4e3a\u6700\u5de6\u8fb9\u7684\u8282\u70b9\uff0c \u5728\u4e00\u6bb5\u786e\u5b9a\u662f\u65f6\u95f4\u5185\u603b\u5f97\u5f97\u5230 CPU \u8d44\u6e90\u3002</li>\n</ul>\n<p>\u5b9e\u9645\u4e0a CFS \u8fd8\u7ef4\u62a4\u4e86 min/max vruntime\uff0c</p>\n<ul>\n<li>min vruntime \u7528\u9014\uff1a<strong>\u65b0\u8fdb\u7a0b\u6216\u91cd\u65b0\u56de\u5230 ready \u72b6\u6001\u7684\u8fdb\u7a0b</strong>\uff0c\u7528 vruntime=min_vruntime \u6765\u521d\u59cb\u5316\uff0c\u653e\u5230\u6700\u5de6\u8fb9\uff1b\u8fd9\u5bf9\u9632\u6b62\u8fdb\u7a0b\u9965\u997f\u975e\u5e38\u5173\u952e\uff1b</li>\n<li>max vruntime \u7528\u9014\uff1a\u9650\u989d\uff1f</li>\n</ul>\n<blockquote>\n<p>\u67e5\u8be2\u590d\u6742\u5ea6\uff1a<code>O(1)</code> \u63d2\u5165\u590d\u6742\u5ea6 <code>O(logN)</code></p>\n</blockquote>\n<h2 id=\"23-scheduling-policy\">2.3 \u8c03\u5ea6\u7b56\u7565\uff08scheduling policy\uff09<a class=\"headerlink\" href=\"#23-scheduling-policy\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"231\">2.3.1 \u5b9e\u65f6\u8fdb\u7a0b\u8c03\u5ea6\u7b56\u7565<a class=\"headerlink\" href=\"#231\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\u90fd\u653e\u5230\u4e86\u4e00\u4e2a runqueue\uff08\u8fd0\u884c\u961f\u5217\uff09\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u8c03\u5ea6\u5668\u6839\u636e\u8c03\u5ea6\u7b56\u7565\u4ece\u91cc\u9762\u53d6\u51fa\u8fdb\u7a0b\u653e\u5230 CPU \u4e0a\u6267\u884c\u3002 \u6709\u4e24\u79cd\u8c03\u5ea6\u7b56\u7565\uff1aSCHED_RR \u548c SCHED_FIFO\u3002</p>\n<h4 id=\"sched_fifo\"><code>SCHED_FIFO</code><a class=\"headerlink\" href=\"#sched_fifo\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5f88\u7b80\u5355\uff0c\u5148\u8fdb\u5148\u51fa\u3002</p>\n<p>\u8fdb\u7a0b\u5728\u4e0b\u9762\u7684\u6761\u4ef6\u4e0b\u4f1a\u653e\u5f03 CPU\uff1a</p>\n<ol>\n<li>\u8fdb\u7a0b\u5728\u7b49\u5f85\uff0c\u4f8b\u5982 IO \u64cd\u4f5c\u3002\u5f53\u8fdb\u7a0b**\u518d\u56de\u5230 ready \u72b6\u6001\u65f6**\uff0c\u5b83\u4f1a\u88ab\u653e\u5230 runqueue \u961f\u5c3e\u3002</li>\n<li>\u8fdb\u7a0b\u901a\u8fc7 <strong><code>sched_yield</code></strong> yield\uff08\u4e3b\u52a8\u8ba9\u51fa\uff09 CPU\u3002\u8fdb\u7a0b**\u7acb\u5373**\u8fdb\u5165 runqueue \u961f\u5c3e\u3002</li>\n</ol>\n<h4 id=\"sched_rr\"><code>SCHED_RR</code><a class=\"headerlink\" href=\"#sched_rr\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728\u8fd9\u79cd\u8c03\u5ea6\u7b56\u7565\u4e2d\uff0crunqueue \u4e2d\u7684\u6bcf\u4e2a\u8fdb\u7a0b\u8f6e\u6d41\u83b7\u5f97\u65f6\u95f4\u7247\uff08quantum\uff09\u3002</p>\n<p>\u8c03\u5ea6\u7b56\u7565\uff1a\u5f71\u54cd\u7684\u662f runqueue \u5982\u4f55\u5de5\u4f5c\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u80fd\u83b7\u5f97\u591a\u5c11\u6267\u884c\u65f6\u95f4\u3002</p>\n<h3 id=\"232\">2.3.2 \u5e38\u89c4\u8fdb\u7a0b\u8c03\u5ea6\u7b56\u7565<a class=\"headerlink\" href=\"#232\" title=\"Permanent link\">&para;</a></h3>\n<p>CFS \u5b9e\u73b0\u4e86\u4e09\u79cd\u8c03\u5ea6\u7b56\u7565\uff1a</p>\n<h4 id=\"sched_normal\"><code>SCHED_NORMAL</code><a class=\"headerlink\" href=\"#sched_normal\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5386\u53f2\u4e0a\u53eb <code>SCHED_OTHER</code>\uff0c\u9002\u7528\u4e8e\u666e\u901a\u4efb\u52a1\u7684\u8c03\u5ea6\u3002</p>\n<h4 id=\"sched_batch\"><code>SCHED_BATCH</code><a class=\"headerlink\" href=\"#sched_batch\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9002\u5408\u6279\u91cf\u4efb\u52a1\u3002\u4e0d\u50cf\u666e\u901a\u4efb\u52a1\u90a3\u6837\u5bb9\u6613\u88ab\u62a2\u5360\uff0c\u56e0\u6b64\u6bcf\u4e2a\u4efb\u52a1\u8fd0\u884c\u7684\u65f6\u95f4\u53ef\u4ee5\u66f4\u957f\uff0c\u7f13\u5b58\u6548\u7387\u66f4\u9ad8\uff0c\u4f46\u4ea4\u4e92\u6027\u53d8\u5dee\u3002</p>\n<h4 id=\"sched_idle\"><code>SCHED_IDLE</code><a class=\"headerlink\" href=\"#sched_idle\" title=\"Permanent link\">&para;</a></h4>\n<p>This is even weaker than nice 19, but its not a true idle timer scheduler in order to avoid to get into priority inversion problems which would deadlock the machine.</p>\n<h3 id=\"233-sched_normal-sched_rr\">2.3.3 \u5e38\u89c4\u8fdb\u7a0b <code>SCHED_NORMAL</code> \u548c\u5b9e\u65f6\u8fdb\u7a0b <code>SCHED_RR</code> \u8c03\u5ea6\u7b56\u7565\u7684\u533a\u522b<a class=\"headerlink\" href=\"#233-sched_normal-sched_rr\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e8c\u8005\u90fd\u662f\u6309\u8fdb\u7a0b\u516c\u5e73\u5206\u914d CPU\uff0c\u8ba1\u7b97\u597d\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u65f6\u95f4\uff08\u65f6\u957f\u90fd\u4e00\u6837\uff09\uff0c\u7136\u540e\u4f9d\u6b21\u53d6\u51fa\u8fdb\u7a0b\u6267\u884c\uff0c \u542c\u8d77\u6765\u6709\u70b9\u50cf\uff0c\u4f46\u4e0d\u4e00\u6837\uff1a</p>\n<p>SCHED_RRSCHED_NORMAL\u8c03\u5ea6\u7684\u8fdb\u7a0b\u7c7b\u578b\u5b9e\u65f6\u8fdb\u7a0b\u666e\u901a\u8fdb\u7a0b\u65f6\u95f4\u7247\u9759\u6001\uff0c\u4e0d\u4f9d\u8d56\u7cfb\u7edf\u4e2d\u7684\u8fdb\u7a0b\u6570\u91cf\u52a8\u6001\uff0c\u6839\u636e\u7cfb\u7edf\u4e2d\u8fdb\u7a0b\u7684\u6570\u91cf\u4f1a\u53d1\u751f\u53d8\u5316\u4e0b\u4e00\u4e2a\u8fdb\u7a0b\u7684\u9009\u62e9\u4ece runqueue \u4e2d\u6309 RR \u9009\u4e0b\u4e00\u4e2a\u4ece\u7ea2\u9ed1\u6811\u4e2d\u9009 vruntime \u6700\u5c0f\u7684\u4e00\u4e2a</p>\n<h3 id=\"234\">2.3.4 \u67e5\u770b\u6216\u4fee\u6539\u8fdb\u7a0b\u7684\u8c03\u5ea6\u5c5e\u6027<a class=\"headerlink\" href=\"#234\" title=\"Permanent link\">&para;</a></h3>\n<p><code>chrt</code> \u53ef**\u67e5\u770b\u6216\u4fee\u6539\u8fdb\u7a0b\u7684\u8c03\u5ea6\u5c5e\u6027**\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>chrt<span class=\"w\"> </span>--help\nShow<span class=\"w\"> </span>or<span class=\"w\"> </span>change<span class=\"w\"> </span>the<span class=\"w\"> </span>real-time<span class=\"w\"> </span>scheduling<span class=\"w\"> </span>attributes<span class=\"w\"> </span>of<span class=\"w\"> </span>a<span class=\"w\"> </span>process.\n...\n</code></pre></div>\n<p>\u67e5\u770b\u8c03\u5ea6\u5c5e\u6027\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>chrt<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"m\">219027</span>\npid<span class=\"w\"> </span><span class=\"m\">219027</span><span class=\"s1\">&#39;s current scheduling policy: SCHED_OTHER</span>\n<span class=\"s1\">pid 219027&#39;</span>s<span class=\"w\"> </span>current<span class=\"w\"> </span>scheduling<span class=\"w\"> </span>priority:<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<h2 id=\"24-scheduling-class\">2.4 \u8c03\u5ea6\u7c7b\uff08scheduling class\uff09<a class=\"headerlink\" href=\"#24-scheduling-class\" title=\"Permanent link\">&para;</a></h2>\n<p>CFS \u5f15\u5165\u4e86 \u201cScheduling Class\u201d \u6982\u5ff5\uff0c\u5c06\u8c03\u5ea6\u7b56\u7565\u5c01\u88c5\u5230\u4e00\u4e2a\u8c03\u5ea6\u7c7b\u578b\uff0c\u4f7f\u5f97 CFS \u8c03\u5ea6\u5668\u6838\u5fc3\u4ee3\u7801\u4e0d\u7528\u5904\u7406\u8c03\u5ea6\u7b56\u7565\u7ec6\u8282\u3002</p>\n<p>\u8fd9\u4e9b\u8c03\u5ea6\u7c7b\u7ec4\u6210\u4e00\u4e2a\u53ef\u6269\u5c55\u7684\u8c03\u5ea6\u6a21\u5757\u5c42\u7ea7\uff08an extensible hierarchy of scheduler modules\uff09\u3002</p>\n<h2 id=\"25-group-scheduler-extensions\">2.5 \u8fdb\u7a0b\u7ec4\u8c03\u5ea6\u5668\u6269\u5c55\uff08group scheduler extensions\uff09<a class=\"headerlink\" href=\"#25-group-scheduler-extensions\" title=\"Permanent link\">&para;</a></h2>\n<p><code>CONFIG_FAIR_GROUP_SCHED</code> \u542f\u7528\u540e\uff0c\u4f1a\u4e3a\u6bcf\u4e2a task group \u5728\u5bf9\u5e94\u7684 cgroup \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <strong><code>cpu.shares</code></strong> \u7684\u6587\u4ef6\u3002</p>\n<h2 id=\"26-cfs\">2.6 CFS \u914d\u7f6e\u9879<a class=\"headerlink\" href=\"#26-cfs\" title=\"Permanent link\">&para;</a></h2>\n<p>CFS \u7684\u65f6\u95f4\u7c92\u5ea6\u662f <strong><code>ns</code></strong>\uff0c\u5e76\u4e0d\u4f9d\u8d56\u4efb\u4f55 jiffies \u6216 HZ \u4fe1\u606f\u3002 \u6709\u4e00\u4e2a\u53ef\u8c03\u4f18\u7684\u914d\u7f6e\uff0c\uff08\u9700\u8981\u5728\u7f16\u8bd1\u5185\u6838\u65f6\u6253\u5f00 CONFIG_SCHED_DEBUG\uff09\uff1a</p>\n<ul>\n<li>kernel <code>&lt; 5.15</code>: <code>/proc/sys/kernel/sched_min_granularity_ns</code></li>\n<li>kernel <code>&gt;= 5.15</code>: <code>/sys/kernel/debug/sched/min_granularity_ns</code></li>\n</ul>\n<p>\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u8fd9\u4e2a\u53c2\u6570\u6765\u8ba9\u8c03\u5ea6\u5668\u4ece \u201cdesktop\u201d\uff08\u4f4e\u5ef6\u8fdf\uff09\u5230\u201cserver\u201d\uff08\u9ad8\u5e76\u53d1\uff09workloads\u3002 \u9ed8\u8ba4\u914d\u7f6e\u9002\u5408\u7684\u662f desktop workloads\u3002</p>\n<h3 id=\"_1\">\u4f8b\u5b50<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u662f\u4e2a\u4f8b\u5b50\uff0c\u521b\u5efa\u8fdb\u7a0b\u7ec4\uff0c\u901a\u8fc7 cgroup \u6587\u4ef6\u7cfb\u7edf\u8bbe\u7f6e CPU shares\uff0c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\"># 1. \u6302\u8f7d cgroup \u6587\u4ef6\u7cfb\u7edf</span>\n$<span class=\"w\"> </span>mount<span class=\"w\"> </span>-t<span class=\"w\"> </span>tmpfs<span class=\"w\"> </span>cgroup_root<span class=\"w\"> </span>/sys/fs/cgroup\n$<span class=\"w\"> </span>mkdir<span class=\"w\"> </span>/sys/fs/cgroup/cpu<span class=\"w\">                       </span><span class=\"c1\"># \u521b\u5efa cpu \u76ee\u5f55\uff0c\u7528\u4e8e\u63a7\u5236 cpu \u8d44\u6e90\u4efd\u989d</span>\n$<span class=\"w\"> </span>mount<span class=\"w\"> </span>-t<span class=\"w\"> </span>cgroup<span class=\"w\"> </span>-ocpu<span class=\"w\"> </span>none<span class=\"w\"> </span>/sys/fs/cgroup/cpu\n$<span class=\"w\"> </span><span class=\"nb\">cd</span><span class=\"w\"> </span>/sys/fs/cgroup/cpu\n\n<span class=\"c1\"># 2. \u521b\u5efa\u8fdb\u7a0b\u7ec4\u5bf9\u5e94\u7684 cgroup \u76ee\u5f55</span>\n$<span class=\"w\"> </span>mkdir<span class=\"w\"> </span>multimedia<span class=\"w\">     </span><span class=\"c1\"># create &quot;multimedia&quot; group of tasks</span>\n$<span class=\"w\"> </span>mkdir<span class=\"w\"> </span>browser<span class=\"w\">        </span><span class=\"c1\"># create &quot;browser&quot; group of tasks</span>\n\n<span class=\"c1\"># 3. \u8bbe\u7f6e\u8fdb\u7a0b\u7ec4\u7684 CPU \u4efd\u989d\uff1a multimedia \u53ef\u4ee5\u6bd4 browser \u591a\u7528\u4e00\u500d</span>\n$<span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"m\">2048</span><span class=\"w\"> </span>&gt;<span class=\"w\"> </span>multimedia/cpu.shares\n$<span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"m\">1024</span><span class=\"w\"> </span>&gt;<span class=\"w\"> </span>browser/cpu.shares\n\n<span class=\"c1\"># 4. \u542f\u52a8\u6d4f\u89c8\u5668\u8fdb\u7a0b firefox \u5e76\u653e\u5230 &quot;browser&quot; \u8fdb\u7a0b\u7ec4</span>\n$<span class=\"w\"> </span>firefox<span class=\"w\"> </span><span class=\"p\">&amp;</span>\n$<span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span>&lt;firefox_pid&gt;<span class=\"w\"> </span>&gt;<span class=\"w\"> </span>browser/tasks\n\n<span class=\"c1\"># \u542f\u52a8\u591a\u5a92\u4f53\u8fdb\u7a0b gmplayer \u5e76\u653e\u5230 &quot;multimedia&quot; \u8fdb\u7a0b\u7ec4</span>\n$<span class=\"w\"> </span>gmplayer<span class=\"w\"> </span><span class=\"p\">&amp;</span>\n$<span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span>&lt;movie_player_pid&gt;<span class=\"w\"> </span>&gt;<span class=\"w\"> </span>multimedia/tasks\n</code></pre></div>\n<h2 id=\"27-cpu-config_cfs_bandwidth\">2.7 CPU \u5e26\u5bbd\u63a7\u5236\u8bbe\u8ba1\uff08<code>CONFIG_CFS_BANDWIDTH</code>\uff09<a class=\"headerlink\" href=\"#27-cpu-config_cfs_bandwidth\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_2\">\u65b0\u914d\u7f6e\u9879<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ed9 cpu cgroup \u5f15\u5165\u4e86\u4e24\u4e2a\u65b0\u914d\u7f6e\u9879\uff1a</p>\n<ul>\n<li><strong><code>cpu.cfs_period_us</code></strong>: \u5468\u671f\uff08period\uff09\uff0c\u6bcf\u4e2a\u5468\u671f\u5355\u72ec\u8ba1\u7b97\uff0c\u5468\u671f\u7ed3\u675f\u4e4b\u540e\u72b6\u6001\uff08quota \u7b49\uff09\u6e05\u96f6\uff1b\u9ed8\u8ba4 100ms</li>\n<li><strong><code>cpu.cfs_quota_us</code></strong>: \u5728\u4e00\u4e2a\u5468\u671f\u91cc\u7684\u4efd\u989d\uff08quota\uff09\uff0c\u9ed8\u8ba4 5ms\u3002</li>\n</ul>\n<p>\u6700\u5927 1s\uff0c\u6700\u5c0f 1ms\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">u64</span><span class=\"w\"> </span><span class=\"n\">max_cfs_quota_period</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">NSEC_PER_SEC</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* 1s */</span>\n<span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">u64</span><span class=\"w\"> </span><span class=\"n\">min_cfs_quota_period</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">NSEC_PER_MSEC</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* 1ms */</span>\n</code></pre></div>\n<p>\u6b64\u5916\u8fd8\u6709\u4e00\u4e2a\u7edf\u8ba1\u8f93\u51fa\uff1a</p>\n<ul>\n<li><strong><code>cpu.stat</code></strong>\uff1a\u8f93\u51fa throttling statistics</li>\n</ul>\n<p>\u540e\u6765\u8fd8\u5f15\u5165\u4e86\u4e00\u4e2a\u4f18\u5316\u9879\uff1a</p>\n<ul>\n<li>cpu.cfs_burst_us: the maximum accumulated run-time\u3002\u4e0a\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u7528\u5b8c\u7684\u4efd\u989d\uff0c\u53ef\u4ee5\u7ed9\u4e0b\u4e00\u4e2a CPU \u7528\u3002</li>\n</ul>\n<p>\u9ed8\u8ba4\u503c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"na\">cpu.cfs_period_us</span><span class=\"o\">=</span><span class=\"s\">100ms</span>\n<span class=\"na\">cpu.cfs_quota_us</span><span class=\"o\">=</span><span class=\"s\">-1</span>\n<span class=\"na\">cpu.cfs_burst_us</span><span class=\"o\">=</span><span class=\"s\">0</span><span class=\"w\">  </span><span class=\"c1\"># 5.15+</span>\n</code></pre></div>\n<h3 id=\"k8s-pod-cpu-throttle\">\u67e5\u770b k8s pod \u7684 CPU throttle \u7edf\u8ba1<a class=\"headerlink\" href=\"#k8s-pod-cpu-throttle\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4e00\u4e2a k8s node \u4e0a\u67e5\u770b\u67d0\u4e2a pod \u7684 <strong>CPU throttle \u7edf\u8ba1</strong>\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/fs/cgroup/cpu/kubepods/pod&lt;pod_id&gt;/cpu.stat\nnr_periods<span class=\"w\"> </span><span class=\"m\">1312889</span>\nnr_throttled<span class=\"w\"> </span><span class=\"m\">100714</span>\nthrottled_time<span class=\"w\"> </span><span class=\"m\">22081774986248</span>\n</code></pre></div>\n<h3 id=\"_3\">\u66f4\u591a\u8bbe\u8ba1\u7ec6\u8282<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<blockquote>\n<p>The skeleton of our approach is as follows:</p>\n<ul>\n<li>We maintain a global pool (per-tg) pool of unassigned quota. Within it we track the bandwidth period, quota per period, and runtime remaining in the current period. As bandwidth is used within a period it is decremented from runtime. Runtime is currently synchronized using a spinlock, in the current implementation there\u2019s no reason this couldn\u2019t be done using atomic ops instead however the spinlock allows for a little more flexibility in experimentation with other schemes.</li>\n<li>When a cfs_rq participating in a bandwidth constrained task_group executes it acquires time in sysctl_sched_cfs_bandwidth_slice (default currently 10ms) size chunks from the global pool, this synchronizes under rq-&gt;lock and is part of the update_curr path.</li>\n<li>Throttled entities are dequeued, we protect against their re-introduction to the scheduling hierarchy via checking for a, per cfs_rq, throttled bit.</li>\n</ul>\n<p>After received a slice, sched_entities in cfs_rq would start running, and keep applying after every slice is used up. If there are no more slices, which means the cfs_rq used up all the allowable quota in this period, it will be throttled, at the meanwhile tasks couldn\u2019t run anymore. The throttling statistics could be checked with Cgroup cpu.stat. After this period, global quota pool will be refreshed and cfs_rq get out of throttled state, tasks continue running.</p>\n</blockquote>\n<h2 id=\"29\">2.9 \u95ee\u9898<a class=\"headerlink\" href=\"#29\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cpu-throttle\">CPU throttle \u662f\u600e\u4e48\u6765\u7684<a class=\"headerlink\" href=\"#cpu-throttle\" title=\"Permanent link\">&para;</a></h3>\n<p>\u591a\u6838\u60c5\u51b5\u4e0b\uff1a\u53ef\u4ee5\u5728\u4e00\u4e2a\u6838\u4e0a\u8fd0\u884c\u5f88\u957f\u65f6\u95f4\uff0c\u4e5f\u53ef\u4ee5\u5728\u591a\u4e2a\u6838\u4e0a\u8fd0\u884c\u5f88\u77ed\u65f6\u95f4\u3002 \u540e\u4e00\u79cd\u60c5\u51b5\u4f1a\u5bfc\u81f4\u8fdb\u7a0b\u5728\u5f88\u77ed\u7684\u65f6\u95f4\u5185\u7528\u5b8c\u4e86\u5168\u90e8 quota\uff0c\u5728\u8c03\u5ea6\u5468\u671f\u5185\u5269\u4e0b\u7684\u65f6\u95f4\u91cc\uff0c\u53ea\u80fd\u7b49\u5f85\u3002\u8fd9\u5c31\u662f throttle\uff08\u5173\u95ed\u9600\u95e8\uff0c\u8282\u6d41\uff09\u3002</p>\n<p>\u5178\u578b\u573a\u666f\uff1a\u591a\u6838\uff0c\u591a\u7ebf\u7a0b\uff08\u4f8b\u5982\u7ebf\u7a0b\u6c60\uff09\u8fdb\u7a0b\u3002</p>\n<h3 id=\"_4\">\u4e0a\u4e0b\u6587\u5207\u6362\u5f00\u9500<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fc7\u8f7d\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u80fd\u5206\u5230\u7684\u65f6\u95f4\u7247\u5f88\u77ed\uff0c\u4f8b\u5982 1ms\uff0c\u5bfc\u81f4\u5927\u90e8\u5206 CPU \u5f00\u9500\u90fd\u82b1\u5728\u4e86\u4e0a\u4e0b\u6587\u5207\u6362\u4e0a\u3002</p>\n<p>\u4e0a\u4e0b\u6587\u5207\u6362\u505a\u7684\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\u4fdd\u5b58\u5f53\u524d\u8fdb\u7a0b\u6216\u7ebf\u7a0b\u7684\u72b6\u6001\uff1b</li>\n<li>\u6062\u590d\u4e0b\u4e00\u4e2a\u8fdb\u7a0b\u6216\u7ebf\u7a0b\u7684\u72b6\u6001\uff1b</li>\n<li>\u6267\u884c\u540e\u4e00\u4e2a\u8fdb\u7a0b\u3002</li>\n</ol>\n<p>\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u7247\u662f 6ms\uff0c\u5207\u6362\u5360 1ms\uff0c\u90a3\u6211\u4eec\u8fd8\u67095ms \u53ef\u4ee5\u6267\u884c\uff1b \u5982\u679c 1.5ms\uff0c\u90a3\u53ea\u6709 0.5ms \u53ef\u4ee5\u6267\u884c\u3002</p>\n<p>\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0c\u5f15\u5165 <code>min_granularity</code>\uff1b\u53cd\u8fc7\u6765\uff0c\u8fd9\u4e5f\u4f1a\u5f71\u54cd sched_latency \u7684\u9009\u53d6\u3002</p>\n<h1 id=\"3\">3 \u5185\u6838\u5b9e\u73b0<a class=\"headerlink\" href=\"#3\" title=\"Permanent link\">&para;</a></h1>\n<blockquote>\n<p>SCHED_FIFO/_RR are implemented in sched/rt.c and are as specified by POSIX.</p>\n<p>sched/rt.c implements SCHED_FIFO and SCHED_RR semantics. It uses 100 runqueues (for all 100 RT priority levels, instead of 140 in the previous scheduler) and it needs no expired array.</p>\n</blockquote>\n<h2 id=\"31-cfs\">3.1 CFS \u7b2c\u4e00\u7248\u5b9e\u73b0<a class=\"headerlink\" href=\"#31-cfs\" title=\"Permanent link\">&para;</a></h2>\n<p>\u89c1 <a href=\"https://www.kernel.org/doc/Documentation/admin-guide/cgroup-v1/cgroups.rst\">1</a>\uff0c\u4ee3\u7801\u4e0d\u592a\u591a\u3002\u60f3\u5feb\u901f\u4e86\u89e3\u6574\u4f53\u5b9e\u73b0\u7684\u53ef\u4ee5\u6d4f\u89c8\u4e00\u4e0b\u3002</p>\n<h2 id=\"32\">3.2 \u6838\u5fc3\u6570\u636e\u7ed3\u6784<a class=\"headerlink\" href=\"#32\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u7684\u90e8\u5206\u90fd\u662f\u53c2\u8003 5.10 \u4ee3\u7801\u3002</p>\n<p>\u4ecb\u7ecd\u51e0\u4e2a\u6838\u5fc3\u7684\u6570\u636e\u7ed3\u6784\u3002</p>\n<h3 id=\"321-struct-task_struct\">3.2.1 <code>struct task_struct</code><a class=\"headerlink\" href=\"#321-struct-task_struct\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u7ed3\u6784\u4f53\u8868\u793a\u662f <code>struct task</code>\uff0c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// include/linux/sched.h</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">thread_info</span><span class=\"w\">        </span><span class=\"n\">thread_info</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">volatile</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">            </span><span class=\"n\">state</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* -1 unrunnable, 0 runnable, &gt;0 stopped: */</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\">                  </span><span class=\"o\">*</span><span class=\"n\">stack</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">refcount_t</span><span class=\"w\">             </span><span class=\"n\">usage</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">           </span><span class=\"n\">flags</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Per task flags (PF_*), defined further below: */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">           </span><span class=\"n\">ptrace</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">on_cpu</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">__call_single_node</span><span class=\"w\">    </span><span class=\"n\">wake_entry</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">cpu</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Current CPU: */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">wakee_flips</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">           </span><span class=\"n\">wakee_flip_decay_ts</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\">     </span><span class=\"o\">*</span><span class=\"n\">last_wakee</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">recent_used_cpu</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">wake_cpu</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">on_rq</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">prio</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">static_prio</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                </span><span class=\"n\">normal_prio</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_class</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">sched_class</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">          </span><span class=\"n\">se</span><span class=\"p\">;</span><span class=\"w\">             </span><span class=\"c1\">// schedule entity, including vruntime</span>\n<span class=\"cp\">#ifdef CONFIG_CGROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_group</span><span class=\"w\">           </span><span class=\"o\">*</span><span class=\"n\">sched_task_group</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif</span>\n<span class=\"w\">    </span><span class=\"p\">...</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>\u5176\u4e2d\u6709\u4e2a\u8c03\u5ea6\u76f8\u5173\u7684\u5b57\u6bb5\u662f <code>struct sched_entity se</code>\u3002\u53ef\u4ee5\u662f\u4e00\u4e2a\u8fdb\u7a0b\u3001\u4e00\u4e2a\u8fdb\u7a0b\u7ec4\u6216\u4e00\u4e2a\u7528\u6237\u3002</p>\n<h3 id=\"322-struct-task_group\">3.2.2 <code>struct task_group</code><a class=\"headerlink\" href=\"#322-struct-task_group\" title=\"Permanent link\">&para;</a></h3>\n<p>\u540c\u7406\uff0c\u8fdb\u7a0b\u7ec4\u4e2d\u4e5f\u6709\u4e00\u4e2a <code>struct sched_entity se</code> \u5b57\u6bb5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// https://github.com/torvalds/linux/blob/v5.10/kernel/sched/sched.h#L383</span>\n\n<span class=\"cm\">/* Task group related information */</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_group</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cgroup_subsys_state</span><span class=\"w\"> </span><span class=\"n\">css</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">  </span><span class=\"o\">**</span><span class=\"n\">se</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* schedulable entities of this group on each CPU */</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cfs_rq</span><span class=\"w\">        </span><span class=\"o\">**</span><span class=\"n\">cfs_rq</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* runqueue &quot;owned&quot; by this group on each CPU */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">          </span><span class=\"n\">shares</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">atomic_long_t</span><span class=\"w\">        </span><span class=\"n\">load_avg</span><span class=\"w\"> </span><span class=\"n\">____cacheline_aligned</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"cp\">#ifdef CONFIG_RT_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_rt_entity</span><span class=\"w\">    </span><span class=\"o\">**</span><span class=\"n\">rt_se</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rt_rq</span><span class=\"w\">        </span><span class=\"o\">**</span><span class=\"n\">rt_rq</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rt_bandwidth</span><span class=\"w\">    </span><span class=\"n\">rt_bandwidth</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rcu_head</span><span class=\"w\">        </span><span class=\"n\">rcu</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">    </span><span class=\"n\">list</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_group</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">parent</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">    </span><span class=\"n\">siblings</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">    </span><span class=\"n\">children</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#ifdef CONFIG_SCHED_AUTOGROUP</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">autogroup</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">autogroup</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cfs_bandwidth</span><span class=\"w\">    </span><span class=\"n\">cfs_bandwidth</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#ifdef CONFIG_UCLAMP_TASK_GROUP</span>\n<span class=\"w\">    </span><span class=\"cm\">/* The two decimal precision [%] value requested from user-space */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">        </span><span class=\"n\">uclamp_pct</span><span class=\"p\">[</span><span class=\"n\">UCLAMP_CNT</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"cm\">/* Clamp values requested for a task group */</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">uclamp_se</span><span class=\"w\">    </span><span class=\"n\">uclamp_req</span><span class=\"p\">[</span><span class=\"n\">UCLAMP_CNT</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"cm\">/* Effective clamp values used for a task group */</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">uclamp_se</span><span class=\"w\">    </span><span class=\"n\">uclamp</span><span class=\"p\">[</span><span class=\"n\">UCLAMP_CNT</span><span class=\"p\">];</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"p\">};</span>\n</code></pre></div>\n<h3 id=\"323-struct-sched_entity\">3.2.3 <code>struct sched_entity</code><a class=\"headerlink\" href=\"#323-struct-sched_entity\" title=\"Permanent link\">&para;</a></h3>\n<p>scheduling entities \u901a\u8fc7\u4e00\u4e2a\u7ea2\u9ed1\u6811\u7ec4\u7ec7\u5230\u4e00\u8d77\uff0c\u6839\u636e <code>vruntime</code> \u6392\u5e8f\uff0c\u901a\u8fc7 <code>cfs_rq</code> \u6765\u7ba1\u7406.</p>\n<p>\u6240\u4ee5 virtual runtime\uff08<code>vruntime</code>\uff09\u5c31\u5b9a\u4e49\u5728\u8fd9\u4e2a\u7ed3\u6784\u4f53\u91cc\u9762\uff0c\u5355\u4f4d\u662f <code>ns</code>\uff0c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// https://github.com/torvalds/linux/blob/v5.10/include/linux/sched.h#L451</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">load_weight</span><span class=\"w\">      </span><span class=\"n\">load</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// For load-balancing</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rb_node</span><span class=\"w\">          </span><span class=\"n\">run_node</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">        </span><span class=\"n\">group_node</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">on_rq</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">                </span><span class=\"n\">exec_start</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">                </span><span class=\"n\">sum_exec_runtime</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">                </span><span class=\"n\">vruntime</span><span class=\"p\">;</span><span class=\"w\">              </span><span class=\"c1\">// unit: ns</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">                </span><span class=\"n\">prev_sum_exec_runtime</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">                </span><span class=\"n\">nr_migrations</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_statistics</span><span class=\"w\">        </span><span class=\"n\">statistics</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">                   </span><span class=\"n\">depth</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"n\">parent</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cfs_rq</span><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">cfs_rq</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// rq on which this entity is (to be) queued</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cfs_rq</span><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">my_q</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"c1\">// rq &quot;owned&quot; by this entity/group</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">         </span><span class=\"n\">runnable_weight</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* cached value of my_q-&gt;h_nr_running */</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Per entity load average tracking.</span>\n<span class=\"w\">    </span><span class=\"c1\">// Put into separate cache line so it does not collide with read-mostly values above.</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_avg</span><span class=\"w\">        </span><span class=\"n\">avg</span><span class=\"p\">;</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>\u6709\u4e86\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5c31\u80fd\u7cbe\u786e\u5730\u901a\u8fc7\u65f6\u95f4\u6233\u6765\u4fdd\u8bc1\u4e00\u4e2a\u4efb\u52a1\u5e94\u8be5\u83b7\u5f97\u7684 \u201cexpected CPU time\u201d\u3002</p>\n<p>\u524d\u9762\u5df2\u7ecf\u63d0\u5230\uff0cCFS \u5c31\u662f\u57fa\u4e8e <code>p-&gt;se.vruntime</code> \u6765\u9009\u62e9\uff08\u8c03\u5ea6\uff09\u8fdb\u7a0b\u7684\uff0c\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff1a <strong>\u6c38\u8fdc\u9009\u62e9 <code>p-&gt;se.vruntime</code> \u6700\u5c0f</strong>\uff08\u8bf4\u660e\u8fd9\u4e2a\u8fdb\u7a0b\u5230\u76ee\u524d\u4e3a\u6b62\u7d2f\u79ef\u6267\u884c\u7684\u65f6\u95f4\u6700\u5c11\uff09<strong>\u7684\u8fdb\u7a0b\u6765\u8fd0\u884c</strong>\u3002 CFS \u4f1a\u4e0d\u65ad\u5c1d\u8bd5\u5747\u8861\u5404\u8fdb\u7a0b\u7684 CPU \u65f6\u95f4\uff0c\u5c3d\u91cf\u63a5\u8fd1\u201c\u7406\u60f3\u591a\u4efb\u52a1 CPU\u201d\u3002</p>\n<h3 id=\"324-struct-cfs_rq\">3.2.4 <code>struct cfs_rq</code><a class=\"headerlink\" href=\"#324-struct-cfs_rq\" title=\"Permanent link\">&para;</a></h3>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// https://github.com/torvalds/linux/blob/v5.10/kernel/sched/sched.h#L518</span>\n\n<span class=\"cm\">/* CFS-related fields in a runqueue (rq) */</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cfs_rq</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">load_weight</span><span class=\"w\">    </span><span class=\"n\">load</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">        </span><span class=\"n\">nr_running</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">        </span><span class=\"n\">h_nr_running</span><span class=\"p\">;</span><span class=\"w\">      </span><span class=\"cm\">/* SCHED_{NORMAL,BATCH,IDLE} */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\">        </span><span class=\"n\">idle_h_nr_running</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* SCHED_IDLE */</span>\n\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">exec_clock</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">min_vruntime</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">min_vruntime_copy</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rb_root_cached</span><span class=\"w\">    </span><span class=\"n\">tasks_timeline</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// rbtree</span>\n\n<span class=\"w\">    </span><span class=\"cm\">/*</span>\n<span class=\"cm\">     * &#39;curr&#39; points to currently running entity on this cfs_rq.</span>\n<span class=\"cm\">     * It is set to NULL otherwise (i.e when none are currently running).</span>\n<span class=\"cm\">     */</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">curr</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">last</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">skip</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"cm\">/*</span>\n<span class=\"cm\">     * CFS load tracking</span>\n<span class=\"cm\">     */</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_avg</span><span class=\"w\">    </span><span class=\"n\">avg</span><span class=\"p\">;</span>\n<span class=\"cp\">#ifndef CONFIG_64BIT</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">load_last_update_time_copy</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">raw_spinlock_t</span><span class=\"w\">    </span><span class=\"n\">lock</span><span class=\"w\"> </span><span class=\"n\">____cacheline_aligned</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">int</span><span class=\"w\">        </span><span class=\"n\">nr</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">    </span><span class=\"n\">load_avg</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">    </span><span class=\"n\">util_avg</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">    </span><span class=\"n\">runnable_avg</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">removed</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">        </span><span class=\"n\">tg_load_avg_contrib</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">long</span><span class=\"w\">            </span><span class=\"n\">propagate</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">long</span><span class=\"w\">            </span><span class=\"n\">prop_runnable_sum</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"cm\">/*</span>\n<span class=\"cm\">     *   h_load = weight * f(tg)</span>\n<span class=\"cm\">     *</span>\n<span class=\"cm\">     * Where f(tg) is the recursive weight fraction assigned to</span>\n<span class=\"cm\">     * this group.</span>\n<span class=\"cm\">     */</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"w\">        </span><span class=\"n\">h_load</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">last_h_load_update</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_entity</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">h_load_next</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif </span><span class=\"cm\">/* CONFIG_FAIR_GROUP_SCHED */</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"c1\">//  the main per-CPU runqueue structure, which cfs_rq would attached to</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">;</span><span class=\"w\">    </span><span class=\"cm\">/* CPU runqueue to which this cfs_rq is attached */</span>\n\n<span class=\"w\">    </span><span class=\"cm\">/*</span>\n<span class=\"cm\">     * leaf cfs_rqs are those that hold tasks (lowest schedulable entity in</span>\n<span class=\"cm\">     * a hierarchy). Non-leaf lrqs hold other higher schedulable entities</span>\n<span class=\"cm\">     * (like users, containers etc.)</span>\n<span class=\"cm\">     *</span>\n<span class=\"cm\">     * leaf_cfs_rq_list ties together list of leaf cfs_rq&#39;s in a CPU.</span>\n<span class=\"cm\">     * This list is used during load balance.</span>\n<span class=\"cm\">     */</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">on_list</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">    </span><span class=\"n\">leaf_cfs_rq_list</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_group</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">tg</span><span class=\"p\">;</span><span class=\"w\">    </span><span class=\"cm\">/* group that &quot;owns&quot; this runqueue */</span>\n\n<span class=\"cp\">#ifdef CONFIG_CFS_BANDWIDTH</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">runtime_enabled</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">s64</span><span class=\"w\">            </span><span class=\"n\">runtime_remaining</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">throttled_clock</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">throttled_clock_task</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">u64</span><span class=\"w\">            </span><span class=\"n\">throttled_clock_task_time</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">throttled</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">            </span><span class=\"n\">throttle_count</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">list_head</span><span class=\"w\">    </span><span class=\"n\">throttled_list</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif </span><span class=\"cm\">/* CONFIG_CFS_BANDWIDTH */</span>\n<span class=\"cp\">#endif </span><span class=\"cm\">/* CONFIG_FAIR_GROUP_SCHED */</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>\u5176\u4e2d\u7684 CFS \u7ea2\u9ed1\u6811\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// include/linux/rbtree.h</span>\n\n<span class=\"c1\">// Leftmost-cached rbtrees.</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rb_root_cached</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rb_root</span><span class=\"w\">  </span><span class=\"n\">rb_root</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rb_node</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rb_leftmost</span><span class=\"p\">;</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>\u5728 cfs_rq \u4e2d\u58f0\u660e\u4e86\u8fd9\u4e2a rbtree \u53d8\u91cf\uff1a</p>\n<p>CFS \u7ef4\u62a4\u4e86 <code>rq-&gt;cfs.min_vruntime</code> \u503c\uff0c\u8fd9\u662f\u4e00\u4e2a\u5355\u8c03\u9012\u589e\u503c\uff0c\u8ddf\u8e2a runqueue \u6240\u6709\u8fdb\u7a0b\u4e2d\u6700\u5c0f\u7684 vruntime\u3002</p>\n<ul>\n<li>\u7cfb\u7edf\u5b8c\u6210\u7684\u603b work \u91cf\u7528 <code>min_vruntime</code> \u8868\u793a\uff0c\u65b0\u6fc0\u6d3b\u7684\u8fdb\u7a0b\uff0c\u4f1a\u7528\u8fd9\u4e2a\u503c\u6765\u521d\u59cb\u5316\uff0c\u653e\u5230 rbtree \u5c3d\u91cf\u6700\u5de6\u8fb9\uff1b</li>\n<li>runqueue \u4e2d\u7684\u603b running \u8fdb\u7a0b\u6570\u91cf\u7528 <code>rq-&gt;cfs.load</code> \u8868\u793a\uff0c\u662f runqueue \u4e2d\u6240\u6709\u8fdb\u7a0b\u7684 weights \u603b\u548c\uff1b</li>\n</ul>\n<p>\u603b\u7ed3\u4e00\u4e0b CFS \u7684\u5de5\u4f5c\u539f\u7406\uff1a</p>\n<ul>\n<li>runs a task a bit, \u5f53\u8fdb\u7a0b\u88ab\u8c03\u5ea6\uff08\u6216 scheduler tick \u5230\u6765\u65f6\uff09\uff0c\u66f4\u65b0\u8fd9\u4e2a\u8fdb\u7a0b\u7684 CPU usage\uff1a \u8fd9\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684\u7269\u7406 CPU \u65f6\u95f4\u4f1a\u7d2f\u52a0\u5230 <code>p-&gt;se.vruntime</code>\uff1b</li>\n<li>\u5f53 <code>p-&gt;se.vruntime</code> \uff08\u52a0\u4e0a\u4e00\u4e2a\u5f88\u5c0f\u7684\u201dgranularity\u201d distance\uff0c\u4ee5\u907f\u514d\u8fc7\u5ea6\u8c03\u5ea6\u8fdb\u7a0b\uff0ctrash the cache\uff09\u5927\u5230\u5df2\u7ecf\u4e0d\u662f\u6700\u5de6\u4fa7\u8282\u70b9\u65f6\uff0c \u65b0\u7684\u6700\u5de6\u4fa7\u8282\u70b9\u5c31\u4f1a\u88ab\u9009\u4e2d\uff0c\u5f53\u524d\u8fdb\u7a0b\u88ab\u5f3a\u5360\uff08current task is preempted\uff09\u3002</li>\n</ul>\n<h3 id=\"325-struct-sched_class\">3.2.5 <code>struct sched_class</code><a class=\"headerlink\" href=\"#325-struct-sched_class\" title=\"Permanent link\">&para;</a></h3>\n<p>Scheduling class \u662f\u901a\u8fc7 <code>struct sched_class</code> \u5b9e\u73b0\u7684\uff0c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// kernel/sched/sched.h</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_class</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">uclamp_enabled</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">enqueue_task</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">dequeue_task</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">yield_task</span><span class=\"p\">)</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">yield_to_task</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">check_preempt_curr</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">pick_next_task</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">put_prev_task</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">set_next_task</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">balance</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">prev</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq_flags</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rf</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">select_task_rq</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">task_cpu</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">sd_flag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">migrate_task_rq</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">new_cpu</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">task_woken</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">this_rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">task</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">set_cpus_allowed</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cpumask</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">newmask</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">rq_online</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">rq_offline</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">task_tick</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">queued</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">task_fork</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">task_dead</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"cm\">/*</span>\n<span class=\"cm\">     * The switched_from() call is allowed to drop rq-&gt;lock, therefore we</span>\n<span class=\"cm\">     * cannot assume the switched_from/switched_to pair is serliazed by</span>\n<span class=\"cm\">     * rq-&gt;lock. They are however serialized by p-&gt;pi_lock.</span>\n<span class=\"cm\">     */</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">switched_from</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">this_rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">task</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">switched_to</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">this_rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">task</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">prio_changed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">this_rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">task</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">oldprio</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"nf\">int</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">get_rr_interval</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">task</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">update_curr</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">rq</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">rq</span><span class=\"p\">);</span>\n\n<span class=\"cp\">#define TASK_SET_GROUP        0</span>\n<span class=\"cp\">#define TASK_MOVE_GROUP        1</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">task_change_group</span><span class=\"p\">)(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">task_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">);</span>\n<span class=\"cp\">#endif</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">__aligned</span><span class=\"p\">(</span><span class=\"n\">STRUCT_ALIGNMENT</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/* STRUCT_ALIGN(), vmlinux.lds.h */</span>\n</code></pre></div>\n<p>\u521d\u59cb\u5316\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">// kernel/sched/fair.c</span>\n\n<span class=\"cm\">/*</span>\n<span class=\"cm\"> * All the scheduling class methods:</span>\n<span class=\"cm\"> */</span>\n<span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">sched_class</span><span class=\"w\"> </span><span class=\"n\">fair_sched_class</span>\n<span class=\"w\">    </span><span class=\"n\">__section</span><span class=\"p\">(</span><span class=\"s\">&quot;__fair_sched_class&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">enqueue_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">enqueue_task_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">dequeue_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dequeue_task_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">yield_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">yield_task_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">yield_to_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">yield_to_task_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">check_preempt_curr</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">check_preempt_wakeup</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">pick_next_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">__pick_next_task_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">put_prev_task</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">put_prev_task_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">set_next_task</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">set_next_task_fair</span><span class=\"p\">,</span>\n\n<span class=\"cp\">#ifdef CONFIG_SMP</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">balance</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">balance_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">select_task_rq</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">select_task_rq_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">migrate_task_rq</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">migrate_task_rq_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">rq_online</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rq_online_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">rq_offline</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rq_offline_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">task_dead</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">task_dead_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">set_cpus_allowed</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">set_cpus_allowed_common</span><span class=\"p\">,</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">task_tick</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">task_tick_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">task_fork</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">task_fork_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">prio_changed</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">prio_changed_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">switched_from</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">switched_from_fair</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">switched_to</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">switched_to_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">get_rr_interval</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_rr_interval_fair</span><span class=\"p\">,</span>\n\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">update_curr</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">update_curr_fair</span><span class=\"p\">,</span>\n\n<span class=\"cp\">#ifdef CONFIG_FAIR_GROUP_SCHED</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">task_change_group</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">task_change_group_fair</span><span class=\"p\">,</span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"cp\">#ifdef CONFIG_UCLAMP_TASK</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">uclamp_enabled</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<span class=\"cp\">#endif</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<h2 id=\"33-cfs-cpu\">3.3 CFS CPU \u5e26\u5bbd\u63a7\u5236\u5b9e\u73b0<a class=\"headerlink\" href=\"#33-cfs-cpu\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5185\u6838\u6587\u6863\uff1a<a href=\"https://docs.kernel.org/scheduler/sched-bwc.html\">CFS bandwidth control</a>\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/proc/sys/kernel/sched_cfs_bandwidth_slice_us\n<span class=\"m\">5000</span>\n\n$<span class=\"w\"> </span>sysctl<span class=\"w\"> </span>-a<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>cfs_\nkernel.sched_cfs_bandwidth_slice_us<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">5000</span>\n</code></pre></div>\n<p>\u7b2c\u4e00\u7248\u5b9e\u73b0\uff1a <a href=\"https://github.com/torvalds/linux/commit/ab84d31e15502fb626169ba2663381e34bf965b2\">https://github.com/torvalds/linux/commit/ab84d31e15502fb626169ba2663381e34bf965b2</a></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"nl\">sched</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Introduce</span><span class=\"w\"> </span><span class=\"n\">primitives</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">account</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">CFS</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">tracking</span>\n<span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">patch</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">introduce</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">notion</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">CFS</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">partitioned</span><span class=\"w\"> </span><span class=\"n\">into</span>\n<span class=\"n\">globally</span><span class=\"w\"> </span><span class=\"n\">unassigned</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">locally</span><span class=\"w\"> </span><span class=\"n\">claimed</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"p\">.</span>\n\n<span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">per</span><span class=\"w\"> </span><span class=\"n\">task_group</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">represents</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">pool</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">unclaimed</span>\n<span class=\"w\">   </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">cfs_rqs</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">.</span>\n<span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">tracked</span><span class=\"w\"> </span><span class=\"n\">per</span><span class=\"o\">-</span><span class=\"n\">cfs_rq</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">represents</span><span class=\"w\"> </span><span class=\"n\">allotments</span><span class=\"w\"> </span><span class=\"n\">from</span>\n<span class=\"w\">   </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"n\">pool</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">assigned</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">specific</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"p\">.</span>\n\n<span class=\"n\">Bandwidth</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">managed</span><span class=\"w\"> </span><span class=\"n\">via</span><span class=\"w\"> </span><span class=\"n\">cgroupfs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">adding</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">interfaces</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"w\"> </span><span class=\"n\">subsystem</span><span class=\"o\">:</span>\n<span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"p\">.</span><span class=\"n\">cfs_period_us</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">usecs</span>\n<span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"p\">.</span><span class=\"n\">cfs_quota_us</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"w\"> </span><span class=\"n\">bandwidth</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">usecs</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">tg</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">allowed</span>\n<span class=\"w\">   </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">consume</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"n\">above</span><span class=\"p\">.</span>\n</code></pre></div>\n<ul>\n<li>cpu.cfs_period_us: \u5468\u671f\uff08period\uff09\uff0c\u6bcf\u4e2a\u5468\u671f\u5355\u72ec\u8ba1\u7b97\uff0c\u5468\u671f\u7ed3\u675f\u4e4b\u540e\u72b6\u6001\uff08quota \u7b49\uff09\u6e05\u96f6\uff1b\u9ed8\u8ba4 100ms</li>\n<li>cpu.cfs_quota_us: \u5728\u4e00\u4e2a\u5468\u671f\u91cc\u7684\u4efd\u989d\uff08quota\uff09\uff0c\u9ed8\u8ba4 5ms\u3002</li>\n</ul>\n<p>\u6700\u5927 1s\uff0c\u6700\u5c0f 1ms\uff1a</p>\n<p>```c\n  const u64 max_cfs_quota_period = 1 * NSEC_PER_SEC; /* 1s <em>/\n  const u64 min_cfs_quota_period = 1 * NSEC_PER_MSEC; /</em> 1ms */\n  static int tg_set_cfs_bandwidth(struct task_group *tg, u64 period, u64 quota)\n    {\n        int i;\n        struct cfs_bandwidth *cfs_b = tg_cfs_bandwidth(tg);\n        static DEFINE_MUTEX(mutex);</p>\n<div class=\"highlight\"><pre><span></span><code>    if (tg == &amp;root_task_group)\n        return -EINVAL;\n\n    /*\n     * Ensure we have at some amount of bandwidth every period.  This is\n     * to prevent reaching a state of large arrears when throttled via\n     * entity_tick() resulting in prolonged exit starvation.\n     */\n    if (quota &lt; min_cfs_quota_period || period &lt; min_cfs_quota_period)\n        return -EINVAL;\n\n    /*\n     * Likewise, bound things on the otherside by preventing insane quota\n     * periods.  This also allows us to normalize in computing quota\n     * feasibility.\n     */\n    if (period &gt; max_cfs_quota_period)\n        return -EINVAL;\n\n    mutex_lock(&amp;mutex);\n    raw_spin_lock_irq(&amp;cfs_b-&gt;lock);\n    cfs_b-&gt;period = ns_to_ktime(period);\n    cfs_b-&gt;quota = quota;\n    raw_spin_unlock_irq(&amp;cfs_b-&gt;lock);\n\n    for_each_possible_cpu(i) {\n        struct cfs_rq *cfs_rq = tg-&gt;cfs_rq[i];\n        struct rq *rq = rq_of(cfs_rq);\n\n        raw_spin_lock_irq(&amp;rq-&gt;lock);\n        cfs_rq-&gt;runtime_enabled = quota != RUNTIME_INF;\n        cfs_rq-&gt;runtime_remaining = 0;\n        raw_spin_unlock_irq(&amp;rq-&gt;lock);\n    }\n    mutex_unlock(&amp;mutex);\n\n    return 0;\n}\n</code></pre></div>\n<h1 id=\"4\">4 \u4f7f\u7528<a class=\"headerlink\" href=\"#4\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"41-throttle\">4.1 \u6a21\u62df throttle \u573a\u666f<a class=\"headerlink\" href=\"#41-throttle\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7528 <a href=\"https://gist.github.com/bobrik/2030ff040fad360327a5fab7a09c4ff1#file-cfs-go\">Overly aggressive CFS</a> \u4e2d\u7684\u7a0b\u5e8f\u6d4b\u8bd5 CFS CPU throttle\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"kn\">package</span><span class=\"w\"> </span><span class=\"nx\">main</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s\">&quot;crypto/sha512&quot;</span>\n<span class=\"w\">    </span><span class=\"s\">&quot;flag&quot;</span>\n<span class=\"w\">    </span><span class=\"s\">&quot;log&quot;</span>\n<span class=\"w\">    </span><span class=\"s\">&quot;syscall&quot;</span>\n<span class=\"w\">    </span><span class=\"s\">&quot;time&quot;</span>\n<span class=\"p\">)</span>\n\n<span class=\"kd\">func</span><span class=\"w\"> </span><span class=\"nx\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">sleep</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">flag</span><span class=\"p\">.</span><span class=\"nx\">Duration</span><span class=\"p\">(</span><span class=\"s\">&quot;sleep&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Second</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;sleep between iterations&quot;</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nx\">interations</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">flag</span><span class=\"p\">.</span><span class=\"nx\">Int</span><span class=\"p\">(</span><span class=\"s\">&quot;iterations&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;number of iterations&quot;</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nx\">flag</span><span class=\"p\">.</span><span class=\"nx\">Parse</span><span class=\"p\">()</span>\n\n<span class=\"w\">    </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Sleep</span><span class=\"p\">(</span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Second</span><span class=\"p\">)</span>\n\n<span class=\"w\">    </span><span class=\"nx\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Now</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"nx\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"nx\">i</span><span class=\"w\"> </span><span class=\"p\">&lt;</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nx\">interations</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nx\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Now</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"nx\">burn</span><span class=\"p\">(</span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Millisecond</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nx\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Now</span><span class=\"p\">().</span><span class=\"nx\">Sub</span><span class=\"p\">(</span><span class=\"nx\">s</span><span class=\"p\">)</span>\n\n<span class=\"w\">        </span><span class=\"nx\">log</span><span class=\"p\">.</span><span class=\"nx\">Printf</span><span class=\"p\">(</span><span class=\"s\">&quot;[%d] burn took %dms, real time so far: %dms, cpu time so far: %dms&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">ms</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nx\">ms</span><span class=\"p\">(</span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Since</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"nx\">ms</span><span class=\"p\">(</span><span class=\"nx\">usage</span><span class=\"p\">()))</span>\n<span class=\"w\">        </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Sleep</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"nx\">sleep</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">func</span><span class=\"w\"> </span><span class=\"nx\">ms</span><span class=\"p\">(</span><span class=\"nx\">duration</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Duration</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"nx\">duration</span><span class=\"p\">.</span><span class=\"nx\">Nanoseconds</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">func</span><span class=\"w\"> </span><span class=\"nx\">burn</span><span class=\"p\">(</span><span class=\"nx\">duration</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Duration</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Now</span><span class=\"p\">()</span>\n\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nx\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">sha512</span><span class=\"p\">.</span><span class=\"nx\">New</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"nx\">sum</span><span class=\"p\">.</span><span class=\"nx\">Write</span><span class=\"p\">([]</span><span class=\"nb\">byte</span><span class=\"p\">(</span><span class=\"s\">&quot;banana&quot;</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"nx\">sum</span><span class=\"p\">.</span><span class=\"nx\">Sum</span><span class=\"p\">([]</span><span class=\"kt\">byte</span><span class=\"p\">{})</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Since</span><span class=\"p\">(</span><span class=\"nx\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">&gt;</span><span class=\"w\"> </span><span class=\"nx\">duration</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">break</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">func</span><span class=\"w\"> </span><span class=\"nx\">usage</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Duration</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nx\">syscall</span><span class=\"p\">.</span><span class=\"nx\">Rusage</span><span class=\"p\">{}</span>\n<span class=\"w\">    </span><span class=\"nx\">syscall</span><span class=\"p\">.</span><span class=\"nx\">Getrusage</span><span class=\"p\">(</span><span class=\"nx\">syscall</span><span class=\"p\">.</span><span class=\"nx\">RUSAGE_SELF</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"nx\">r</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nx\">time</span><span class=\"p\">.</span><span class=\"nx\">Duration</span><span class=\"p\">(</span><span class=\"nx\">r</span><span class=\"p\">.</span><span class=\"nx\">Stime</span><span class=\"p\">.</span><span class=\"nx\">Nano</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nx\">r</span><span class=\"p\">.</span><span class=\"nx\">Utime</span><span class=\"p\">.</span><span class=\"nx\">Nano</span><span class=\"p\">())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>\u7a0b\u5e8f\u6bcf\u4e2a iteration \u4f1a\u6267\u884c 5ms\uff0c\u7136\u540e sleep \u4e00\u6bb5\u65f6\u95f4\u3002</p>\n<p>\u7528 docker container \u6765\u6267\u884c\uff0c\u907f\u514d\u6c61\u67d3\u672c\u673a\u914d\u7f6e\u3002</p>\n<p><code>period=100ms,quota=5m,sleep=10ms</code> \u60c5\u51b5\u4e0b\uff0c\u4e0d\u4f1a\u4ea7\u751f throttle\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>dk<span class=\"w\"> </span>run<span class=\"w\"> </span>--rm<span class=\"w\"> </span>-it<span class=\"w\"> </span>-v<span class=\"w\"> </span><span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span>:<span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span><span class=\"w\"> </span>-w<span class=\"w\"> </span><span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span><span class=\"w\"> </span>golang:1.19.4<span class=\"w\"> </span>go<span class=\"w\"> </span>run<span class=\"w\"> </span>cfs.go<span class=\"w\"> </span>-iterations<span class=\"w\"> </span><span class=\"m\">20</span><span class=\"w\"> </span>-sleep<span class=\"w\"> </span>10ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:50:35<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>7ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:50:35<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>20ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>12ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:50:35<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>37ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>17ms\n...\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:50:35<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">18</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>338ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>102ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:50:35<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">19</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>355ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>108ms\n</code></pre></div>\n<p><code>period=100ms,quota=25m,sleep=10ms</code> \u60c5\u51b5\u4e0b\uff0c\u4f1a\u4ea7\u751f throttle\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>dk<span class=\"w\"> </span>run<span class=\"w\"> </span>--rm<span class=\"w\"> </span>-it<span class=\"w\"> </span>--cpu-quota<span class=\"w\"> </span><span class=\"m\">25000</span><span class=\"w\"> </span>--cpu-period<span class=\"w\"> </span><span class=\"m\">100000</span><span class=\"w\"> </span>-v<span class=\"w\"> </span><span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span>:<span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span><span class=\"w\"> </span>-w<span class=\"w\"> </span><span class=\"k\">$(</span><span class=\"nb\">pwd</span><span class=\"k\">)</span><span class=\"w\"> </span>golang:1.19.4<span class=\"w\"> </span>go<span class=\"w\"> </span>run<span class=\"w\"> </span>cfs.go<span class=\"w\"> </span>-iterations<span class=\"w\"> </span><span class=\"m\">20</span><span class=\"w\"> </span>-sleep<span class=\"w\"> </span>10ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>6ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>11ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>35ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>19ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>51ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>24ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>20ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>83ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>28ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>100ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>33ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>115ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>38ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>131ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>43ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>147ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>49ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>24ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>182ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>51ms\n<span class=\"m\">2023</span>/02/05<span class=\"w\"> </span><span class=\"m\">09</span>:48:38<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span>burn<span class=\"w\"> </span>took<span class=\"w\"> </span>5ms,<span class=\"w\"> </span>real<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>197ms,<span class=\"w\"> </span>cpu<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>so<span class=\"w\"> </span>far:<span class=\"w\"> </span>56ms\n...\n</code></pre></div>\n<h2 id=\"42-k8s\">4.2 k8s<a class=\"headerlink\" href=\"#42-k8s\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7814\u7a76\u8fd9\u4e9b\u4e1c\u897f\u662f\u4e3a\u4e86\u66f4\u597d\u7406\u89e3\u4e00\u4e9b\u5bb9\u5668\u95ee\u9898\u3002</p>\n<h1 id=\"_5\">\u53c2\u8003\u8d44\u6599<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h1>\n<ol>\n<li>CFS \u7b2c\u4e00\u7248\u5b9e\u73b0\uff0c <a href=\"https://github.com/torvalds/linux/blob/v2.6.23/kernel/sched_fair.c\">kernel/sched_fair.c</a>\uff0ckernel v2.6.23, 2007</li>\n<li><a href=\"https://github.com/torvalds/linux/blob/v5.10/Documentation/scheduler/sched-design-CFS.rst\">CFS scheduler design (kernel 5.10)</a>, kernel doc, 2023</li>\n<li><a href=\"https://lwn.net/Articles/844976/\">The burstable CFS bandwidth controller</a>, lwn.net, 2021</li>\n<li><a href=\"https://lwn.net/Articles/428230/\">CFS bandwidth control</a>, lwn.net, 2011</li>\n<li><a href=\"https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36669.pdf\">CPU bandwidth control for CFS</a>, google, 2009</li>\n<li><a href=\"https://medium.com/@maxwell9215/cfs-bandwidth-control-warmup-b03af4cc1cc4\">CPU bandwidth control warmup</a>, 2021</li>\n<li><a href=\"https://gist.github.com/bobrik/2030ff040fad360327a5fab7a09c4ff1#file-cfs-go\">Overly aggressive CFS</a>, 2018</li>\n<li><a href=\"https://medium.com/geekculture/process-scheduling-in-linux-592028a5d545\">Process Scheduling In Linux</a>, 2021</li>\n</ol>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": []}, {"id": "https://wgzhao.github.io/notes/courses/pg9_high_performance_notes/", "url": "https://wgzhao.github.io/notes/courses/pg9_high_performance_notes/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aPostgreSQL 9 High Performance\u300b\u8bfb\u4e66\u7b14\u8bb0", "content_html": "<p>\u8fd9\u662f\u5f88\u65e9\u524d\u9605\u8bfb <a href=\"https://www.packtpub.com/product/postgresql-90-high-performance/9781849510301\">\u300aPostgreSQL 9 High Performance\u300b</a> \u505a\u7684\u4e00\u4e9b\u7b14\u8bb0</p>\n<p>\u5206\u7ae0\u8282\u8bb0\u5f55</p>\n<h2 id=\"_1\">\u6570\u636e\u5e93\u7248\u672c<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u4e86 PostgreSQL \u7684\u5386\u53f2\uff0c\u611f\u5174\u8da3\u7684\uff0c\u53ef\u4ee5\u770b\u770b\uff0c\u548c\u6280\u672f\u5173\u7cfb\u4e0d\u5927</p>\n<h2 id=\"_2\">\u786c\u4ef6\u9009\u578b<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h2>\n<ol>\n<li>\n<p>\u4e0d\u7528 SSD \u786c\u76d8\u7684\u4e09\u4e2a\u4e3b\u8981\u539f\u56e0</p>\n<ol>\n<li>\u5f53\u524d\u786c\u76d8\u5bb9\u91cf\u4e0d\u5927\uff0c\u800c\u6570\u636e\u5e93\u4e00\u5411\u90fd\u5360\u7528\u78c1\u76d8\u8f83\u591a</li>\n<li>\u5b58\u50a8\u8fd9\u5757\u7684\u8d39\u7528\u4f1a\u76f8\u5f53\u9ad8</li>\n<li>\u5927\u90e8\u5206 SSD \u8bbe\u8ba1\u65f6\u5e76\u6ca1\u6709\u5f88\u597d\u7684\u8003\u8651\u5199\u7f13\u5b58(write-cache)</li>\n</ol>\n</li>\n<li>\n<p>write-back cache \u65b9\u5f0f\u5e76\u4e0d\u662f\u9002\u5408\u7528\u4e8e\u5b58\u50a8\u6570\u636e\u7684\u6587\u4ef6\u7cfb\u7edf</p>\n</li>\n<li>\n<p>\u78c1\u76d8\u9635\u5217\u4e00\u822c\u90fd\u7528 wirte-back cache\uff0c\u56e0\u4e3a\u5b83\u914d\u7f6e\u4e86\u7535\u6c60\uff0c\u4e00\u822c\u79f0\u4e3a\n    battery-backed write cache(BBC or BBWC)</p>\n</li>\n<li>\n<p>\u51e0\u6761\u9884\u9632 write-back cache \u51fa\u6545\u969c\u7684\u57fa\u672c\u6cd5\u5219</p>\n<ol>\n<li>\n<p>\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u5b8c\u6574\u5b9e\u73b0\u4e86 fsync \u8c03\u7528\u6216\u8005\u7c7b\u4f3c\u673a\u5236\u7684\u529f\u80fd</p>\n</li>\n<li>\n<p>\u76d1\u63a7\u78c1\u76d8\u63a7\u5236\u5668\u7535\u6c60\u3002\u6709\u4e9b\u63a7\u5236\u5361\u81ea\u8eab\u4f1a\u76d1\u63a7\u5176\u72b6\u6001\uff0c\u5982\u679c\u53d1\u73b0\u6389\u7535\u6216\u8005\u5de5\u4f5c\u4e0d\u6b63\u5e38\u65f6\uff0c\u4f1a\u4ece write-back\n    \u6539\u6210 write-through \u6a21\u5f0f\uff0c\u5f53\u7136\uff0c\u5176\u6027\u80fd\u4f1a\u4e0b\u964d</p>\n</li>\n<li>\n<p>\u7981\u6b62\u4efb\u4f55\u78c1\u76d8\u7684 write-cache \u6a21\u5f0f\u3002\u5927\u90e8\u5206 RAID \u5361\u4f1a\u6765\u505a\u8fd9\u70b9\uff0c\u4ed6\u4eec\u4f1a\u4f18\u5148\u4f7f\u7528\n    BBC \u6a21\u5f0f</p>\n</li>\n</ol>\n</li>\n<li>\n<p>\u78c1\u76d8\u8f6c\u901f\u4ee5\u53ca\u6bcf\u79d2\u63d0\u4ea4\u7684\u5199\u901f\u5173\u7cfb\\</p>\n<p>\u8f6c\u901f(RPM) \u8f6c\u65f6(ms) \u6700\u5927\u63d0\u4ea4\u6570(/s)</p>\n<hr />\n<div class=\"highlight\"><pre><span></span><code> 5400        11.1           90\n 7200        8.3           120\n 10000       6.0           166\n 15000       4.0           250\n</code></pre></div>\n<p>\u4e0a\u8ff0\u56fe\u8868\u5173\u7cfb\u610f\u5473\u7740\u4e00\u4e2a\u666e\u901a\u7684 7200 \u8f6c\u7684\u786c\u76d8\uff0c\u5355\u4e2a\u5ba2\u6237\u7aef\u63d0\u4ea4\u7684\u4e8b\u52a1\u4e0d\u53ef\u80fd\u8d85\u8fc7 120/sec.</p>\n</li>\n</ol>\n<h2 id=\"_3\">\u786c\u4ef6\u6027\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_4\">\u5185\u5b58\u6027\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p><strong>memtest86+</strong> \u5927\u90e8\u5206 Linux \u53d1\u578b\u7248\u672c\u90fd\u81ea\u5e26\u4e86 memtest86+\u5185\u5b58\u6d4b\u8bd5\u5de5\u5177\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4e5f\u53ef\u4ee5\u4ece<a href=\"http://www.memtest.org\">http://www.memtest.org</a>\u4e0b\u8f7d\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5305\u542b memtest86+\u5f15\u5bfc CD \u8fdb\u884c\u6d4b\u8bd5</p>\n</li>\n<li>\n<p><strong>STREAM \u5185\u5b58\u6d4b\u8bd5</strong> STEAM \u662f\u4e00\u4e2a\u5185\u5b58\u5e26\u5bbd\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u4ece<a href=\"http://www.cs.virginia.edu/stream\">http://www.cs.virginia.edu/stream</a>\u4e0b\u8f7d\uff0c\u7f51\u7ad9\u4e0a\u4e5f\u6709\u5f88\u591a\u6d4b\u8bd5\u62a5\u544a\u4e8b\u4f8b.\\</p>\n</li>\n</ul>\n<h3 id=\"cpu\">CPU \u6027\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#cpu\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76f4\u63a5\u4f7f\u7528\u6570\u636e\u5e93\u6765\u505a\u4e00\u4e9b\u67e5\u8be2\u64cd\u4f5c\u5c31\u662f\u6d4b\u8bd5 CPU \u6027\u80fd\u7684\u6700\u597d\u5de5\u5177\uff0c\u5728 psql \u91cc\u5f00\u542f\\timing \u529f\u80fd\uff0c\u5229\u7528*generate_series*\u51fd\u6570\u6765\u521b\u5efa\u5de8\u91cf\u7684\u6570\u5217\uff0c\u4fbf\u80fd\u770b\u51fa CPU \u7684\u6027\u80fd\u3002\u6bd4\u5982\u7c7b\u4f3c\u4e0b\u9762\u7684\u4e00\u4e9b\u6307\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">postgres</span><span class=\"o\">=#</span><span class=\"err\">\\</span><span class=\"n\">timing</span>\n<span class=\"n\">postgres</span><span class=\"o\">=#</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">sum</span><span class=\"p\">(</span><span class=\"n\">generate_series</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">generate_series</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1000000</span><span class=\"p\">);</span>\n<span class=\"n\">postgres</span><span class=\"o\">=#</span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">INTEGER</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"k\">VALUES</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">series</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">100000</span><span class=\"p\">));</span>\n<span class=\"n\">postgres</span><span class=\"o\">=#</span><span class=\"k\">EXPLAIN</span><span class=\"w\"> </span><span class=\"k\">ANALYZE</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"cpu_1\">\u5185\u5b58\u548c CPU \u6162\u7684\u6839\u6e90<a class=\"headerlink\" href=\"#cpu_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5927\u90e8\u5206\u5185\u5b58\u8bbe\u7f6e\u4e3a\u53cc\u901a\u9053\u6a21\u5f0f\uff0c\u4e00\u5bf9\u5185\u5b58\u5e94\u8be5\u63d2\u5165\u5230\u7279\u5b9a\u7684\u63d2\u69fd\u5185\uff0c\u5982\u679c\u5b89\u88c5\u4e0d\u6b63\u786e\uff0c\u5185\u5b58\u5c06\u4f1a\u8fd0\u884c\u5728\u5355\u901a\u9053\u6a21\u5f0f\u3002memtest86+\u7a0b\u5e8f\u6709\u6b21\u63d0\u793a\uff0c\u53e6\u5916 BIOS \u91cc\u4e5f\u80fd\u4fa6\u6d4b\u5230\u8fd9\u79cd\u60c5\u51b5\\\n\u52a3\u8d28\u7684\u5185\u5b58\u9897\u7c92\u4f1a\u4e25\u91cd\u62d6\u7d2f\u7cfb\u7edf\u6027\u80fd\uff0c\u56e0\u4e3a\u4e3b\u677f\u5e76\u4e0d\u80fd\u5145\u5206\u5229\u7528\u5185\u5b58\u6240\u5ba3\u79f0\u7684\u9ad8\u901f\u3002\u5927\u90e8\u5206\u7cfb\u7edf\u7684\u7f3a\u7701\u914d\u7f6e\u90fd\u662f\u4fdd\u5b88\u7684\uff0c\u5b83\u4e00\u822c\u4f1a\u4ece\u5185\u5b58\u63d0\u4f9b\u7684 SPD\uff08Serial\nPresence\nDetect\uff09\u4fe1\u606f\u4e2d\u67e5\u8be2\u5b83\u5e94\u8be5\u8fd0\u884c\u7684\u901f\u5ea6\uff0c\u4f46\u8fd9\u5f80\u5f80\u4e0d\u662f\u5176\u6700\u9ad8\u6027\u80fd\uff0c\u56e0\u6b64\u9700\u8981\u4eba\u5de5\u8c03\u6574\u5185\u5b58\u65f6\u949f\u3002\\\n\u9ad8\u6027\u80fd\u7684\u5185\u5b58\u4f7f\u7528\u4e86\u79f0\u4e3a\"Extreme Memory\nProfile(XMP)\\\"\u534f\u8bae\uff0c\u5b83\u53ef\u4ee5\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u5411 BIOS \u4f20\u9012\u5b83\u53ef\u4ee5\u8fd0\u884c\u7684\u6700\u9ad8\u901f\u7387\u3002\u4f46\u662f BIOS \u7f3a\u7701\u60c5\u51b5\u4e0b\u5e76\u4e0d\u8fdb\u68c0\u67e5\u548c\u4f7f\u7528 XMP\uff0c\u8fd9\u5c31\u4f7f\u5f97\u4f60\u7684\u5185\u5b58\u770b\u4e0a\u53bb\u6ca1\u6709\u5e76\u6ca1\u6709\u90a3\u4e48\u5feb\u3002\\\n\u53e6\u5916\u4e00\u4e2a\u539f\u56e0\u5c31\u662f\u5185\u5b58\u548c\u5904\u7406\u5668\u7684\u65f6\u949f\u9891\u7387\u4e0d\u80fd\u5f88\u597d\u7684\u5408\u4f5c\uff0c\u4e00\u65b9\u9762\u9700\u8981\u6ce8\u610f\u4e3b\u677f\u548c BIOS \u7684\u8bbe\u7f6e\uff0c\u4ee5\u4fdd\u8bc1 CPU \u548c\u5185\u5b58\u7684\u65f6\u949f\u9891\u7387\u80fd\u53d1\u6325\u6700\u5927\u529f\u6548\u3002\u53e6\u5916\u4e00\u4e2a\u65b9\u9762\u5c31\u662f\u5f53\u524d\u5927\u90e8\u5206\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4e86\u8282\u7701\uff0c\u90fd\u6709 CPU \u8c03\u901f\u7684\u529f\u80fd\uff0c\u5728\u7a7a\u95f2\u65f6\uff0c\u4f1a\u5c06 CPU \u7684\u4e3b\u9891\u8c03\u7684\u5f88\u4f4e\uff0c\u6bd4\u5982\u4e00\u4e2a 2.4GHz \u7684 CPU\uff0c\u5728\u7a7a\u95f2\u65f6\u8c03\u6574\u4e3a 1GHz \u662f\u5f88\u5e38\u89c1\u7684\u4e8b\u60c5\uff0c\u5982\u679c\u65f6 Linux \u7cfb\u7edf\uff0c\u53ef\u4ee5\u67e5\u770b/proc/cpuinfo \u6765\u83b7\u53d6\u5f53\u524d CPU \u7684\u8fd0\u884c\u9891\u7387\u3002\u5728\u6d4b\u8bd5\u6027\u80fd\u65f6\uff0c\u5e94\u8be5\u5173\u95ed CPU \u8c03\u901f\u7684\u529f\u80fd\u3002</p>\n<h3 id=\"_5\">\u78c1\u76d8\u6027\u80fd<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"iops\">\u968f\u673a\u8bbf\u95ee\u53ca IOPS<a class=\"headerlink\" href=\"#iops\" title=\"Permanent link\">&para;</a></h4>\n<p>IOPS(Input/Outpu Per Second)\n\u662f\u8861\u91cf\u4e00\u4e2a\u78c1\u76d8\u6027\u80fd\u7684\u91cd\u8981\u53c2\u6570\uff0c\u5b83\u7efc\u5408\u8861\u91cf\u4e86\u78c1\u76d8\u968f\u673a\u8bfb\u5bfb\u9053\u65f6\u95f4\uff0c\u5e73\u5747\u5ef6\u8fdf\u65f6\u95f4\u7b49\u5f71\u54cd\u6027\u80fd\u7684\u56e0\u7d20\u3002</p>\n<p>\u6839\u636e\u78c1\u76d8\u5e38\u89c1\u5bf9\u78c1\u76d8\u7ed9\u51fa\u7684\u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u7b97\u51fa\u4e00\u4e2a\u78c1\u76d8\u7684 IOPS\u3002\u6bd4\u5982 seagate \u51fa\u54c1\u7684 Momentus\n7200.4 \u684c\u9762\u578b\u78c1\u76d8\u89c4\u683c\u53c2\u6570\u5982\u4e0b\uff1a</p>\n<p>\u8f6c\u901f\uff1a7200 RPM</p>\n<p>\u5e73\u5747\u5ef6\u8fdf\uff1a4.17ms</p>\n<p>\u968f\u673a\u8bfb\u5bfb\u9053\u65f6\u95f4\uff1a11.0ms</p>\n<p>\u5b9e\u9645\u4e0a\u901a\u8fc7\u8f6c\u901f\uff0c\u6211\u4eec\u5c31\u80fd\u5927\u81f4\u8ba1\u7b97\u51fa\u6765\u5e73\u5747\u5ef6\u8fdf\uff0c\u6bd4\u5982 7200 \u8f6c\u7684\u78c1\u76d8\uff0c\u5c31\u610f\u5473\u7740\uff0c\u8f6c\u4e00\u5708\u9700\u8981<span class=\"arithmatex\">\\(1*60/7200 = 8.33ms\\)</span>\u3002\n\u6700\u5dee\u7684\u60c5\u51b5\u5c31\u662f\u4f60\u6bcf\u6b21\u7b49\u5f85\u90fd\u9700\u8981\u78c1\u76d8\u8f6c\u4e00\u5708\uff0c\u4f46\u8fd9\u79cd\u51e0\u7387\u4e0d\u5927\uff0c\u5927\u90e8\u5206\u7b49\u5f85\u90fd\u4e0d\u60f3\u8981\u7b49\u5f85\u4e00\u5708\uff0c\u56e0\u6b64\u6211\u4eec\u53d6\u7b97\u672f\u5e73\u5747\uff0c\u6bcf\u6b21\u7b49\u5f85\u4f20\u534a\u5708\u7684\u65f6\u95f4\uff0c\u4e5f\u5c31\u662f<span class=\"arithmatex\">\\(8.33/2 = 4.17ms\\)</span>\u3002\n\u7531\u6b64\u770b\u51fa\uff0c\u6240\u6709 7200\nRPM \u7684\u78c1\u76d8\uff0c\u5176\u5e73\u5747\u5ef6\u8fdf\u90fd\u5e94\u8be5\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u968f\u673a\u8bfb\u53d6\u5bfb\u9053\u65f6\u95f4\u5219\u4f9d\u8d56\u4e8e\u78c1\u76d8\u7684\u5927\u5c0f\u3001\u8d28\u91cf\u4ee5\u53ca\u5176\u4ed6\u56e0\u7d20\u4e86\u3002</p>\n<p>\u5e73\u5747\u5ef6\u8fdf\u65f6\u95f4 <span class=\"arithmatex\">\\(RL = 1/ RPM / 60 / 2 = 4.17 ms\\)</span></p>\n<p>\u5bfb\u9053\u65f6\u95f4 <span class=\"arithmatex\">\\(S = 11.0 ms\\)</span></p>\n<p><span class=\"arithmatex\">\\(IOPS =  1 / (RL + S)  = 1 / (4.17ms + 11ms) = 65.9 IOPS\\)</span>\\</p>\n<h4 id=\"zcav\">\u987a\u5e8f\u8bbf\u95ee\u53ca ZCAV<a class=\"headerlink\" href=\"#zcav\" title=\"Permanent link\">&para;</a></h4>\n<p>CAV(Constant Anular\nVelocity)\uff0c\u5c31\u6052\u5b9a\u89d2\u901f\u5ea6\u3002\u6307\u7684\u662f\u78c1\u76d8\u5728\u4efb\u610f\u65f6\u523b\uff0c\u8f6c\u901f\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u56e0\u4e3a\u78c1\u76d8\u7684\u76d8\u9762\u662f\u4e00\u4e2a\u5706\u5f62\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u5728\u76f8\u540c\u65f6\u95f4\u5185\uff0c\u8d8a\u9760\u8fd1\u78c1\u76d8\u5916\u5c42\uff0c\u626b\u8fc7\u7684\u9762\u79ef\u7684\u4e5f\u5c31\u8d8a\u5927\u3002\u8fd9\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\uff0c\u78c1\u76d8\u5916\u9053\u7684\u8bfb\u53d6\u901f\u5ea6\u8981\u5feb\u4e8e\u78c1\u76d8\u5185\u9053\u3002</p>\n<p>\u6709\u5173 CAV\uff0c\u4ee5\u53ca\u76f8\u5173\u5de5\u5177\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684\u94fe\u63a5\uff1a\n<a href=\"http://www.coker.com.au/bonnie++/zcav/\">http://www.coker.com.au/bonnie++/zcav/</a></p>\n<h4 id=\"short-stroking\">\u77ed\u51b2\u7a0b(short stroking)<a class=\"headerlink\" href=\"#short-stroking\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6211\u4eec\u77e5\u9053\u78c1\u76d8\u7684\u5916\u9053\u8bfb\u5199\u901f\u5ea6\u8981\u5feb\uff0c\u56e0\u6b64\u6709\u4e13\u95e8\u7684\u6280\u672f\u6765\u4fdd\u8bc1\u4f60\u7684\u6570\u636e\u53ea\u5b58\u653e\u5728\u5916\u9053\u4e0a\uff0c\u8fd9\u5c31\u662f\u6210\u4e3a Short\nstroking \u7684\u6280\u672f\u3002</p>\n<h4 id=\"_6\">\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h4>\n<p>Windows \u4e0b\u4f7f\u7528<a href=\"http://www.hdtune.com\">hdtune</a>\u514d\u8d39\u7248\u5373\u53ef\\\nUnix \u4e0b\uff0c\u7cfb\u7edf\u518d\u5e26\u7684 dd \u6307\u4ee4\u5c31\u53ef\u4ee5\u4f5c\u4e3a\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u7684\u57fa\u672c\u5de5\u5177\u3002\u4e00\u822c dd \u6d4b\u8bd5\u8bfb\u5199\u7684\u6587\u4ef6\u5927\u5c0f\u81f3\u5c11\u662f\u7269\u7406\u5185\u5b58\u7684\u4e24\u500d\uff0c\u4ee5\u4fdd\u8bc1\u7cfb\u7edf\u4e0d\u4f1a\u628a\u5b9e\u9645\u9700\u8981\u5199\u5165\u78c1\u76d8\u7684\u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58\u4e0a\u3002\u8003\u8651\u5230 postgresql \u9ed8\u8ba4\u7684\u5757\u5927\u5c0f\u662f 8KB\uff0c\u56e0\u6b64 dd \u6d4b\u8bd5\u9700\u8981\u7684\u5757\u5927\u5c0f\u4e3a\uff1a</p>\n<p><span class=\"arithmatex\">\\(blocks = 250,000 * (gigabytes of RAM)\\)</span></p>\n<p>\u6d4b\u8bd5\u65b9\u6cd5\u4e00\u822c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"nb\">time</span><span class=\"w\"> </span>sh<span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"s2\">&quot;dd if=/dev/zero of=bigfile bs=8k count=blocks &amp;&amp; sync&quot;</span>\n<span class=\"nb\">time</span><span class=\"w\"> </span>dd<span class=\"w\"> </span><span class=\"k\">if</span><span class=\"o\">=</span>bigfile<span class=\"w\"> </span><span class=\"nv\">of</span><span class=\"o\">=</span>/dev/null<span class=\"w\"> </span><span class=\"nv\">bs</span><span class=\"o\">=</span>8k\n</code></pre></div>\n<p>Unix \u4e0b\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5f00\u6e90\u7684 bonnie++\u5de5\u5177\\\n1\uff09Bonnie++</p>\n<p>\u5f53\u524d\u6700\u65b0\u7684\u7248\u672c\u662f 1.96\uff0c\u4e5f\u5c31\u662f\u6240\u8c13\u7684 2.0 \u7248\u672c</p>\n<div class=\"highlight\"><pre><span></span><code>bonnie++<span class=\"w\"> </span>-f<span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>tee<span class=\"w\"> </span><span class=\"sb\">`</span>hostname<span class=\"sb\">`</span>.bonnie\ncat<span class=\"w\"> </span><span class=\"sb\">`</span>hostname<span class=\"sb\">`</span>.bonnie<span class=\"w\"> </span><span class=\"p\">|</span>grep<span class=\"w\"> </span><span class=\"s2\">&quot;,&quot;</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>bon_csv2html<span class=\"w\"> </span>&gt;<span class=\"sb\">`</span>hostname<span class=\"sb\">`</span>.htm\n</code></pre></div>\n<p>-n 0 \u8868\u793a\u8df3\u8fc7\u6587\u4ef6\u521b\u5efa\u6d4b\u8bd5</p>\n<p>-f \u8868\u793a\u5feb\u901f\u6a21\u5f0f\uff0c\u8df3\u8fc7\u6bcf\u5b57\u7b26\u7684 I/0 \u6d4b\u8bd5</p>\n<p>2\uff09bonnie++ zcav</p>\n<p>zcav \u662f Bonnie \u9879\u76ee\u4e2d\u72ec\u7acb\u51fa\u6765\u7684\u7a0b\u5e8f\uff0c\u7528\u4e8e\u8ddf\u8e2a\u6574\u4e2a\u78c1\u76d8\u7684\u4f20\u8f93\u7387\uff0c\u53ef\u4ee5\u5229\u7528 gnuplot \u6765\u7ed8\u5236\u51fa\u6f02\u4eae\u7684\u56fe\u5f62\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>zcav<span class=\"w\"> </span>-lsda.zcav<span class=\"w\"> </span>-f<span class=\"w\"> </span>/dev/sda\nzcav<span class=\"w\"> </span>-lsdb.zcav<span class=\"w\"> </span>-f<span class=\"w\"> </span>/dev/sdb\n</code></pre></div>\n<p>\u4e0a\u8ff0\u6307\u4ee4\u9700\u8981 root \u6743\u9650\uff0c\u5c06\u4f1a\u4ea7\u751f\u4e24\u4e2a\u65e5\u5fd7\u6587\u4ef6 sda.zcav \u548c sdb.zcav</p>\n<p>\u800c\u540e\uff0c\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\u751f\u6210\u56fe\u5f62</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">unset</span><span class=\"w\"> </span><span class=\"nb\">autoscale</span><span class=\"w\"> </span><span class=\"err\">x</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">autoscale</span><span class=\"w\"> </span><span class=\"n\">xmax</span>\n<span class=\"k\">unset</span><span class=\"w\"> </span><span class=\"nb\">autoscale</span><span class=\"w\"> </span><span class=\"err\">y</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">autoscale</span><span class=\"w\"> </span><span class=\"n\">ymax</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">xlabel</span><span class=\"w\"> </span><span class=\"s\">&quot;Position MB&quot;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">ylabel</span><span class=\"w\"> </span><span class=\"s\">&quot;KB/s&quot;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">key</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">bottom</span>\n<span class=\"k\">plot</span><span class=\"w\"> </span><span class=\"s\">&quot;sda.zcav&quot;</span><span class=\"w\"> </span><span class=\"nb\">title</span><span class=\"w\"> </span><span class=\"s\">&quot;Dell E6410 laptop&quot;</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;sub&quot;</span><span class=\"w\"> </span><span class=\"nb\">title</span><span class=\"w\"> </span><span class=\"s\">&quot;Huawei SSD&quot;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">terminal</span><span class=\"w\"> </span><span class=\"n\">png</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"nb\">output</span><span class=\"w\"> </span><span class=\"s\">&quot;disks.png&quot;</span>\n<span class=\"k\">replot</span>\n</code></pre></div>\n<p>sysbench \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u5e93\u6d4b\u8bd5\u5de5\u5177\uff0c\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u6d4b\u8bd5\u6570\u636e\u5e93\u672c\u8eab\u7684\u6027\u80fd\uff0c\u4e5f\u80fd\u901a\u8fc7\u6570\u636e\u5e93\u6765\u505a\u786c\u4ef6\u6d4b\u8bd5\uff0c\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e9b\u6d4b\u8bd5\u4f8b\u5b50\uff1a\\</p>\n<p><code>sysbench --test=cpu run</code>\\</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"ch\">#!/bin/sh</span>\n<span class=\"nv\">THREADS</span><span class=\"o\">=</span><span class=\"m\">1</span>\n<span class=\"nv\">GBSIZE</span><span class=\"o\">=</span><span class=\"m\">4</span>\n<span class=\"nv\">MODE</span><span class=\"o\">=</span>rndrd\nsysbench<span class=\"w\"> </span>--test<span class=\"o\">=</span>fileio<span class=\"w\"> </span>--num-threads<span class=\"o\">=</span><span class=\"nv\">$THREADS</span><span class=\"w\"> </span>--file-num<span class=\"o\">=</span><span class=\"nv\">$GBSIZE</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-total-size<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">GBSIZE</span><span class=\"si\">}</span>G<span class=\"w\"> </span>--file-block-size<span class=\"o\">=</span>8K<span class=\"w\"> </span>--file-test-mode<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">MODE</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-fsync-freq<span class=\"o\">=</span><span class=\"m\">0</span><span class=\"w\"> </span>--file-fsync-end<span class=\"o\">=</span>no<span class=\"w\"> </span>prepare\n\nsysbench<span class=\"w\"> </span>--test<span class=\"o\">=</span>fileio<span class=\"w\"> </span>--num-threads<span class=\"o\">=</span><span class=\"nv\">$THREADS</span><span class=\"w\"> </span>--file-num<span class=\"o\">=</span><span class=\"nv\">$GBSIZE</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-total-size<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">GBSIZE</span><span class=\"si\">}</span>G<span class=\"w\"> </span>--file-block-size<span class=\"o\">=</span>8K<span class=\"w\"> </span>--file-test-mode<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">MODE</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-fsync-freq<span class=\"o\">=</span><span class=\"m\">0</span><span class=\"w\"> </span>--file-fsync-end<span class=\"o\">=</span>no<span class=\"w\"> </span>run<span class=\"w\"> </span>--max-time<span class=\"o\">=</span><span class=\"m\">60</span>\n\nsysbench<span class=\"w\"> </span>--test<span class=\"o\">=</span>fileio<span class=\"w\"> </span>--num-threads<span class=\"o\">=</span><span class=\"nv\">$THREADS</span><span class=\"w\"> </span>--file-num<span class=\"o\">=</span><span class=\"nv\">$GBSIZE</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-total-size<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">GBSIZE</span><span class=\"si\">}</span>G<span class=\"w\"> </span>--file-block-size<span class=\"o\">=</span>8K<span class=\"w\"> </span>--file-test-mode<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">MODE</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n--file-fsync-freq<span class=\"o\">=</span><span class=\"m\">0</span><span class=\"w\"> </span>--file-fsync-end<span class=\"o\">=</span>no<span class=\"w\"> </span>cleanup\n</code></pre></div>\n<p>\u6d4b\u8bd5\u5206\u4e3a 3 \u4e2a\u6b65\u9aa4\uff0c\u9996\u5148\u521b\u5efa\u6d4b\u8bd5\u6587\u4ef6\uff0c\u7136\u540e\u6d4b\u8bd5\u8fd0\u884c\uff0c\u6700\u540e\u6e05\u7406\u6d4b\u8bd5\u6587\u4ef6\u3002\n\u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u6574\u6d4b\u8bd5\u6587\u4ef6\u7684\u5927\u5c0f\uff0c\u6d4b\u8bd5\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u4ee5\u53ca\u91c7\u53d6\u4f55\u79cd\u8bfb\u5199\u6a21\u5f0f\u3002\\</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"ch\">#!/bin/sh</span>\n<span class=\"nv\">DRIVE</span><span class=\"o\">=</span><span class=\"s2\">&quot;/dev/sda&quot;</span>\n<span class=\"c1\">## Disable write cache</span>\nhdparm<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"nv\">$DRIVE</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>fsync<span class=\"w\"> </span>with<span class=\"w\"> </span>write<span class=\"w\"> </span>cache<span class=\"w\"> </span>disabled,<span class=\"w\"> </span>look<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"s2\">&quot;Requests/sec&quot;</span>\nsysbench<span class=\"w\"> </span>--test<span class=\"o\">=</span>fileio<span class=\"w\"> </span>--file-fsync-freq<span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span>--file-num<span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span>--file-total-size<span class=\"o\">=</span><span class=\"m\">16384</span>\n--file-test-mode<span class=\"o\">=</span>rndwr<span class=\"w\"> </span>run\n<span class=\"c1\">## Enable write cache (returning it to the usual default)</span>\nhdparm<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"nv\">$DRIVE</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>fsync<span class=\"w\"> </span>with<span class=\"w\"> </span>write<span class=\"w\"> </span>cache<span class=\"w\"> </span>enabled,<span class=\"w\"> </span>look<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"s2\">&quot;Requests/sec&quot;</span>\nsysbench<span class=\"w\"> </span>--test<span class=\"o\">=</span>fileio<span class=\"w\"> </span>--file-fsync-freq<span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span>--file-num<span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span>--file-total-size<span class=\"o\">=</span><span class=\"m\">16384</span>\n--file-test-mode<span class=\"o\">=</span>rndwr<span class=\"w\"> </span>run\n</code></pre></div>\n<h4 id=\"_7\">\u5176\u4ed6\u590d\u6742\u7684\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h4>\n<ol>\n<li>\n<p><a href=\"http://www.iozone.org\">iozone</a> \u53ef\u4ee5\u6d4b\u8bd5\u5404\u79cd\u78c1\u76d8\u4f7f\u7528\u573a\u666f</p>\n</li>\n<li>\n<p><a href=\"http://freshmeat.net/projects/fio/\">fio</a>\n    \u901a\u8fc7\u811a\u672c\u6765\u6784\u5efa\u548c\u6d4b\u8bd5\u5404\u79cd\u4f60\u60f3\u6d4b\u8bd5\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u770b\u8fd9\u4e2a\u4f8b\u5b50\uff1a\n    <a href=\"http://wiki.postgresql.org/wiki/HP_ProLiant_DL380_G5_Tuning_Guide\">http://wiki.postgresql.org/wiki/HP_ProLiant_DL380_G5_Tuning_Guide</a></p>\n</li>\n<li>\n<p><a href=\"http://pgfoundry.org/projects/pgiosim/\">pgiosim</a></p>\n</li>\n</ol>\n<h2 id=\"_8\">\u78c1\u76d8\u8bbe\u7f6e<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_9\">\u6587\u4ef6\u7cfb\u7edf<a class=\"headerlink\" href=\"#_9\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"ext2\">ext2<a class=\"headerlink\" href=\"#ext2\" title=\"Permanent link\">&para;</a></h4>\n<p>Linux \u4e0a\u539f\u751f\u7684\u6700\u53e4\u8001\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u6ca1\u6709\u65e5\u5fd7\uff0c\u56e0\u6b64\u5927\u90e8\u5206\u573a\u666f\u4e0b\u90fd\u4e0d\u9002\u5408\u7528\u8be5\u6587\u4ef6\u7cfb\u7edf\u3002</p>\n<p>\u4e0d\u8fc7\u56e0\u4e3a\u6ca1\u6709\u65e5\u5fd7\uff0c\u6240\u5f97\u5b83\u7684\u8bfb\u5199\u901f\u5ea6\u5f88\u5feb\uff0c\u6709\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u628a ext2 \u6587\u4ef6\u7cfb\u7edf\u7528\u5728 PostgreSQL\nWAL \u4e0a\u3002</p>\n<p>\u4f46\u662f\u8981\u6ce8\u610f\u7cfb\u7edf\u91cd\u542f\u540e\uff0c\u81ea\u52a8\u6267\u884c fsck \u6240\u5e26\u6765\u7684\u98ce\u9669\u3002\u56e0\u6b64\u53ea\u6709\u660e\u786e WAL \u6210\u4e3a\u74f6\u9888\u65f6\uff0c\u53ef\u4ee5\u8003\u4e0a\u4f7f\u7528\u66f4\u5feb\u4f46\u662f\u6709\u4e00\u5b9a\u98ce\u9669\u7684 ext2 \u6587\u4ef6\u7cfb\u7edf\u3002</p>\n<h4 id=\"ext3\">ext3<a class=\"headerlink\" href=\"#ext3\" title=\"Permanent link\">&para;</a></h4>\n<p>ext3 \u5728 ext2 \u7684\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u65e5\u5fd7\u529f\u80fd\uff0c\u5b83\u5411\u540e\u517c\u5bb9 ext2\u3002\u800c\u4e14 ext2 \u548c ext3 \u4e24\u79cd\u6587\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u53ef\u4ee5\u4e92\u8f6c\u3002</p>\n<p>\u76ee\u524d\uff0c\u5728 ext3 \u4e0a\uff0c\u6709\u4e09\u79cd\u5199\u65e5\u5fd7\u7684\u65b9\u6cd5\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7\u6302\u8f7d\u65f6\u4f20\u9012 data \u53c2\u6570\u6765\u6307\u5b9a\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\uff1a</p>\n<ul>\n<li>\n<p><strong>data=writeback</strong>\n  \u6570\u636e\u6539\u53d8\u4e0d\u4f1a\u8bb0\u5f55\u5728\u65e5\u5fd7\u3002\u5143\u6570\u636e\u6539\u53d8\u8bb0\u5f55\u5728\u65e5\u5fd7\uff0c\u4e0d\u4fdd\u8bc1\u6570\u636e\u5757\u5199\u5165\u7684\u76f8\u5173\u987a\u5e8f\u3002\u5f53\u5d29\u6e83\u540e\uff0c\u6587\u4ef6\u53ef\u4ee5\u6062\u590d\uff0c\u4e0d\u8fc7\u6587\u4ef6\u7ed3\u5c3e\u53ef\u80fd\u6709\u4e9b\u65e0\u7528\u7684\u6570\u636e\uff0c\u53e6\u5916\uff0c\u6587\u4ef6\u7684\u5185\u5bb9\u53ef\u80fd\u662f\u65b0\u65e7\u6570\u636e\u6df7\u5408.</p>\n</li>\n<li>\n<p><strong>data=ordered</strong>\n  \u5143\u6570\u636e\u8bb0\u5f55\u5728\u65e5\u5fd7\uff0c\u6570\u636e\u6539\u53d8\u4e0d\u8fdb\u65e5\u5fd7\u3002\u53ea\u6709\u5f53\u76f8\u5173\u8054\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\uff0c\u624d\u5199\u5143\u6570\u636e\uff0c\u4e5f\u662f\\\"ordered\\\"\u7684\u7531\u6765\u3002</p>\n</li>\n<li>\n<p><strong>data=journal</strong> \u6570\u636e\u548c\u5143\u6570\u636e\u7684\u6539\u53d8\u90fd\u5199\u5165\u65e5\u5fd7</p>\n</li>\n</ul>\n<p>\u76f8\u6bd4 WAL \u5b58\u50a8\u5728 ext2 \u4e0a\u83b7\u5f97\u6027\u80fd\u7684\u4f18\u52bf\uff0cext3 +\ndata=writeback \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u66ff\u6362\u9009\u62e9\uff0c\u4e00\u6765\u6027\u80fd\u4e0d\u4f1a\u592a\u5dee\uff0c\u800c\u6765\u6709\u65e5\u5fd7\u7684\u4fdd\u8bc1\uff0c\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u5927\u5927\u7f29\u77ed\u3002\u53ea\u662f\u8981\u8003\u8651\u6587\u4ef6\u81a8\u80c0\u7684\u95ee\u9898\u3002</p>\n<h4 id=\"ext4\">ext4<a class=\"headerlink\" href=\"#ext4\" title=\"Permanent link\">&para;</a></h4>\n<p>ext4 \u771f\u6b63\u5f00\u59cb\u80fd\u5728\u4ea7\u54c1\u4e2d\u4f7f\u7528\u662f\u4ece kernel2.6.28 \u5f00\u59cb\uff0c\u4e0d\u8fc7\u56e0\u4e3a\u4e00\u4e9b\u8c03\u7528 fsync \u5904\u7406\u7684 bug\uff0c\u5bf9\u4e8e PostgreSQL \u800c\u8a00\uff0ckernel\n&gt; 2.6.32 \u7684\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 ext4\u3002\u4e5f\u5c31\u662f RedHat 6 \u548c Ubuntu 10.04 \u53ef\u4ee5\u5f00\u59cb\u7528\u4e86\u3002</p>\n<p>\u5c3d\u7ba1\u7406\u8bba\u4e0a\uff0cext4 \u4e0d\u5b58\u5728\u4e4b\u524d ext3 \u6587\u4ef6\u7cfb\u7edf 16TB \u7684\u5927\u5c0f\u9650\u5236\uff0c\u4f46\u662f mkfs \u5de5\u5177\u76ee\u524d\u4f9d\u7136\u8fd8\u662f\u6709\u8fd9\u4e2a\u9650\u5236\u3002</p>\n<p>\u4ece PostgreSQL \u7684\u89d2\u5ea6\u6765\u770b\uff0cext4 \u76f8\u6bd4 ext3 \u7684\u4e3b\u8981\u63d0\u5347\u5728\u4e8e\u80fd\u591f\u66f4\u597d\u7684\u5904\u7406 write\nbarriers \u548c fsync \u64cd\u4f5c\u3002</p>\n<h4 id=\"xfs\">XFS<a class=\"headerlink\" href=\"#xfs\" title=\"Permanent link\">&para;</a></h4>\n<p>XFS \u662f SGI \u8bbe\u8ba1\u7684\u4e00\u6b3e\u9ad8\u6548\u7387\u65e5\u5fd7\u6587\u4ef6\u7cfb\u7edf\uff0c\u5b83\u6bd4 ext3 \u901f\u5ea6\u7a0d\u5feb\uff0c\u4ece\u539f\u7406\u4e0a\u6765\u8bb2\uff0c\u5b83\u66f4\u50cf\u662f ext3+data=writeback \u8fd0\u884c\u6a21\u5f0f\u3002\u56e0\u6b64\u5982\u679c\u60f3\u4f7f\u7528 XFS,\u8981\u8bb0\u5f97\u8bbe\u7f6e PostgreSQL \u7684*full_page_writes*\u53c2\u6570</p>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a XFS \u548c ext3 \u7684\u901f\u5ea6\u6bd4\u8f83\u8868\uff0c\u53ef\u4ee5\u5927\u81f4\u770b\u51fa XFS \u7684\u4f18\u52bf</p>\n<div class=\"highlight\"><pre><span></span><code>  Filesystem       Sequential write(MB/s)   Sequential read(MB/s)\n</code></pre></div>\n<hr />\n<p>ext3 data=ordered 39-58 44-72\next3 data=journal 25-30 49067\nXFS 68-72 72-77</p>\n<p>RHEL5 \u521d\u6b65\u5f00\u59cb\u652f\u6301 XFS\uff0cRHEL6 \u5df2\u7ecf\u5b8c\u5168\u652f\u6301 XFS\u3002\u56e0\u6b64\u5728\u7279\u522b\u5927\u7684\u78c1\u76d8\u7a7a\u95f4\u4e0a\uff0c\u6bd4\u5982\u5e0c\u671b\u6587\u4ef6\u7cfb\u7edf\u8d85\u8fc7 16TB \u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528 XFS\uff0c\u800c\u4e14\u6587\u4ef6\u7cfb\u7edf\u8d8a\u5927\uff0cXFS \u76f8\u6bd4 ext3/ext4 \u8d8a\u6709\u4f18\u52bf\u3002</p>\n<p>\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0cXFS \u4f7f\u7528 write barriers\uff0cXFS \u4e5f\u504f\u6267\u7684\u8ba4\u4e3a\u6613\u5931\u7f13\u5b58(volatile\nwrite\ncache)\u7684\u78c1\u76d8\u4f1a\u4e22\u5931\u6570\u636e\u3002\u4e3a\u4e86\u9632\u6b62\u8fd9\u70b9\uff0cXFS \u603b\u662f\u79ef\u6781\u7684\u7ed9\u78c1\u76d8\u53d1\u9001\u5237\u76d8(flush)\u6307\u4ee4\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u6709\u975e\u6613\u5931\u7f13\u5b58\u8bbe\u5907\uff0c\u6bd4\u5982\u5e26\u540e\u5907\u7535\u6c60\u7684\u5199\u63a7\u5236\u5668\uff0c\u90a3\u4e48\u7f13\u5b58\u5237\u76d8\u5c31\u662f\u6d6a\u8d39\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6302\u8f7d XFS \u63a8\u8350\u4f7f\u7528 nobarriers \u9009\u9879\u6765\u786e\u4fdd\u7981\u6b62\u7f13\u5b58\u5237\u76d8\u3002</p>\n<h4 id=\"linux\">\u5176\u4ed6 Linux \u6587\u4ef6\u7cfb\u7edf<a class=\"headerlink\" href=\"#linux\" title=\"Permanent link\">&para;</a></h4>\n<dl>\n<dt>JFS</dt>\n<dd>\n<p>\u548c XFS \u7c7b\u4f3c\uff0c\u53ea\u662f CPU \u4f7f\u7528\u66f4\u5c11\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u5f97\u5230\u4e3b\u6d41\u53d1\u578b\u7248\u672c\u7684\u5b8c\u6574\u652f\u6301\u3002</p>\n</dd>\n<dt>ReiserFS</dt>\n<dd>\n<p>\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u8fdb\u5165 Linux\nkernel \u7684\u65e5\u5fd7\u6587\u4ef6\u7cfb\u7edf\uff0c\u800c\u4e14 SuSE \u8fd8\u628a\u5b83\u4f5c\u4e3a\u7f3a\u7701\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f46\u662f\u968f\u7740\u4f5c\u8005\u7684\u88ab\u6355\uff0c\u5176\u524d\u666f\u582a\u5fe7\u3002</p>\n</dd>\n<dt>Btrfs</dt>\n<dd>\n<p>Oracle \u6350\u8d60\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u88ab\u8ba4\u4e3a\u662f\u672a\u6765 Linux \u7684\u4e3b\u8981\u6587\u4ef6\u7cfb\u7edf\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u5230\u7a33\u5b9a\u7248\uff0c\u57fa\u4e8e\u5b83\u7684\u4e00\u4e9b\u72ec\u4e00\u7279\u6027\uff0c\u6bd4\u5982\u5feb\u7167\uff0c\u6821\u9a8c\u548c\u3002\u5b83\u5c06\u6765\u5f88\u6709\u53ef\u80fd\u662f\u6781\u5177\u7ade\u4e89\u529b\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</p>\n</dd>\n</dl>\n<h4 id=\"solaris-ufs\">Solaris UFS<a class=\"headerlink\" href=\"#solaris-ufs\" title=\"Permanent link\">&para;</a></h4>\n<p>Solaris\nUFS \u7528\u4e8e PostgreSQL \u5e76\u4e0d\u592a\u597d\u3002\u4e00\u4e2a\u4e3b\u8981\u7684\u95ee\u9898\u662f\u5b83\u4ec5\u80fd\u7f13\u5b58\u5c0f\u6587\u4ef6\uff0c\u800c\u6570\u636e\u5e93\u671f\u671b\u7684\u662f\u80fd\u7f13\u5b58\u5927\u6587\u4ef6\u3002\u53e6\u5916\uff0c\u80fd\u7528\u4e8e\u7f13\u5b58\u7684\u5185\u5b58\u5927\u5c0f\u5f88\u5c0f\uff0c\u5bf9\u4e8e SPARC \u7cfb\u7edf\u800c\u8a00\uff0c\u53ea\u80fd\u7528\u5230\u5185\u5b58\u7684 12%\u3002\u800c Intel/AMD\nx64 \u53ea\u53ea\u6709\u53ef\u601c\u7684 64MB\u3002\u5bf9\u4e8e\u6700\u540e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u6574\u53c2\u6570\u6765\u4fee\u590d\uff0c\u4e00\u4e2a\u662f\u6389\u6b63\u7c7b\u4f3c\u9884\u8bfb\u53d6\u7684\u5927\u5c0f\uff0c\u4e00\u4e2a\u662f\u7c7b\u4f3c\u8bfb\u5199\u5230\u4ea4\u6362\u7a7a\u95f4\u7684\u5927\u5c0f</p>\n<div class=\"highlight\"><pre><span></span><code>set maxphys=1048576\nset klustsize=1048576\n</code></pre></div>\n<p>\u5728 SPARC Solaris \u7cfb\u7edf\u4e0a\uff0c\u8fd8\u53ef\u4ee5\u8c03\u6574\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>set freebebind=0\nset segmap_percent=60\n</code></pre></div>\n<p>\u5bf9\u4e8e Intel/AMD x64 Solaris \u7cfb\u7edf\uff0c\u5219\u8bbe\u7f6e\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>set ufs:freebehind=0\nset segmapsize=1073741824\n</code></pre></div>\n<h4 id=\"freebsd-ufs2\">FreeBSD UFS2<a class=\"headerlink\" href=\"#freebsd-ufs2\" title=\"Permanent link\">&para;</a></h4>\n<p>\u548c Linux \u7c7b\u4f3c\uff0c\u901a\u8fc7\u4fee\u6539 read-ahead \u80fd\u663e\u8457\u63d0\u5347\u987a\u5e8f\u8bfb\u7684\u901f\u5ea6\u3002\u53c2\u6570\u7684\u5355\u4f4d\u662f\u6587\u4ef6\u7cfb\u7edf\u5757\u5927\u5c0f\uff0c\u9ed8\u8ba4\u662f 8KB\u3002\n\u8fd9\u4e2a\u53c2\u6570\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u5728 32 \u5230 256 \u4e4b\u95f4\uff0c\u901a\u8fc7\u4fee\u6539/etc/sysctl.conf \u6587\u4ef6\uff0c\u589e\u52a0\u7c7b\u4f3c\u4e0b\u9762\u7684\u8fd9\u884c\uff1a\\\nvfs.read_max = 32\\\n\u7136\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\uff0c\u4f7f\u5176\u751f\u6548\uff1a\\\n/etc/rc.d/sysctl start</p>\n<h4 id=\"zfs\">ZFS<a class=\"headerlink\" href=\"#zfs\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5f88\u5c11\u6709\u6587\u4ef6\u7cfb\u7edf\u80fd\u50cf ZFS \u4e00\u6837\u62e5\u6709\u4f17\u591a\u7684\u62e5\u62a4\u8005\uff0c\u5f53\u7136\u5b83\u7684\u5f88\u591a\u5148\u8fdb\u7279\u6027\uff0c\u7279\u522b\u662f\u81ea\u5e26\u7684\u5377\u7ba1\u7406\u548c\u5b9e\u65f6\u5feb\u7167\u529f\u80fd\u6211\u4eec\u5728\u5f88\u591a\u5730\u65b9\u90fd\u80fd\u770b\u5230\u5176\u4ecb\u7ecd\u3002\nZFS \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528 128KB \u5927\u5c0f\u7684\u8bb0\u5f55\u5757\uff0c\u5bf9 PostgreSQL \u800c\u8a00\uff0c\u8fd9\u4e2a\u6570\u6709\u70b9\u5927\uff0c\u53cd\u800c\u4f7f\u5f97\u6548\u7387\u4e0d\u9ad8\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u8bbe\u7f6e\u6765\u4f7f\u5f97\u6587\u4ef6\u7cfb\u7edf\u7684\u5757\u5927\u5c0f\u548c PostgreSQL \u7684\u5757\u5927\u5c0f\u4e00\u81f4\uff1a\\\n<code>zfs set recordsize=8K zp1/data</code>\\\n\u8fd9\u4e2a\u5927\u5c0f\u5bf9 WAL \u5e76\u4e0d\u662f\u4f18\u5316\u503c\uff0c\u76f8\u53cd\uff0c\u5176\u7f3a\u7701\u7684 128KB \u5e94\u8be5\u66f4\u597d\u3002ZFS \u5c3d\u53ef\u80fd\u6d88\u8017\u6389\u6240\u6709\u7684\u5185\u5b58\u7528\u4e8e\u5b83\u7684\u81ea\u9002\u5e94\u53ef\u66ff\u6362\u7f13\u5b58(Adaptive\nReplacement Cache aka\nARC)\uff0c\u5bf9\u4e8e PostgreSQL \u800c\u8a00\uff0c\u9700\u8981\u964d\u4f4e\u8be5\u503c\uff0c\u4e0d\u540c\u7684 Soloris \u53d1\u578b\u7248\u672c\uff0c\u5176\u8c03\u6574 ARC \u7684\u65b9\u5f0f\u6709\u6240\u4e0d\u540c\uff0c\u5177\u4f53\u7684\u53ef\u4ee5\u53c2\u8003<a href=\"http://www.solarisinternals.com/wiki/index.php/ZFS_Evil_Tuning_Guide\">http://www.solarisinternals.com/wiki/index.php/ZFS_Evil_Tuning_Guide</a>\u6587\u7ae0\u91cc\u7684\\\"Limiting\nthe ARC Cache\\\"\u7ae0\u8282\u3002</p>\n<p>\u5bf9\u4e8e FreeBSD \u7cfb\u7edf\u800c\u8a00\uff0c\u53ef\u4ee5\u53c2\u8003<a href=\"http://wiki.freebsd.org/ZFSTuningGuide\">http://wiki.freebsd.org/ZFSTuningGuide</a>\uff0c\u8fd9\u7247\u6587\u6863\u91cc\u63d0\u5230\u4e86\u4e00\u4e2a*arc_summary.pl*\u7684\u6709\u7528\u811a\u672c\uff0c\u5b83\u53ef\u4ee5\u5728 FreeBSD \u548c Solari \u4e0a\u8fd0\u884c\u3002</p>\n<p>ZFS \u4f7f\u7528\u4e00\u79cd\u79f0\u4e3a\\\"intent\nlog\\\"\u7684\u7ed3\u6784\u6765\u5904\u7406\u65e5\u5fd7\uff0c\u5728\u5177\u6709\u591a\u4e2a\u78c1\u76d8\u7684\u9ad8\u6027\u80fd\u7cfb\u7edf\u4e0a\uff0c\u9488\u5bf9\u6570\u636e\u5e93\u78c1\u76d8\uff0c\u4e00\u822c\u5bf9\u5206\u914d\u51fa\u4e13\u95e8\u7528\u6765\u5b58\u50a8\\\"intent\nlog\\\"\u7684\u5b58\u50a8\u6c60\u3002\u800c\u5bf9\u4e8e\u7528\u4e8e\u5b58\u50a8 WAL \u7684\u78c1\u76d8\uff0c\u5c31\u4e0d\u9700\u8981\u4e13\u95e8\u7684\u5b58\u50a8\u6c60\u6765\u5b58\u50a8\\\"intent\nlog\"\u3002\u6709\u5173\u66f4\u5177\u4f53\u7684\u5982\u4f55\u4e3a\u6570\u636e\u5e93\u4f18\u5316 ZFS \u7684\u6307\u5357\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u8fd9\u4e2a\u94fe\u63a5\uff1a\\\n<a href=\"http://www.solarisinternals.com/wiki/index.php/ZFS_for_Databases\">http://www.solarisinternals.com/wiki/index.php/ZFS_for_Databases</a></p>\n<p>\u548c XFS \u76f8\u4f3c\uff0c\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u6709\u975e\u6613\u5931\u5199\u7f13\u5b58\uff0cZFS \u63d0\u4f9b\u7684\u7f13\u5b58\u5237\u76d8\u4f1a\u5f71\u54cd\u6027\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e zfs_nocacheflush \u53c2\u6570\u6765\u7981\u6b62\u5b83\u3002\u5728/etc/system \u91cc\u589e\u52a0\u4e0b\u9762\u7684\u8fd9\u884c\uff1a\\\n<code>set zfs:zfs_nocacheflush=1</code>\\\n\u56e0\u4e3a ZFS \u7684\\\"intent\nlog\\\"\u7684\u5065\u58ee\u6027\u4ee5\u53ca\u5757\u6821\u9a8c\u548c\u7684\u7279\u6027\uff0c\u5f53\u5b83\u7528\u4e8e PostgreSQL \u65f6\uff0c\u53ef\u4ee5\u7981\u6b62 full_page_writes \u53c2\u6570\u6765\u83b7\u5f97\u6027\u80fd\u63d0\u5347\uff0c\u4e14\u5c11\u6709\u98ce\u9669\u3002</p>\n<h4 id=\"fat32\">FAT32<a class=\"headerlink\" href=\"#fat32\" title=\"Permanent link\">&para;</a></h4>\n<p>\u76ee\u524d\u5df2\u7ecf\u4e0d\u63a8\u8350\u5728\u6570\u636e\u5e93\u4e0a\u4f7f\u7528 FAT32 \u6587\u4ef6\u7cfb\u7edf\u4e0a\u4e86\uff0c\u65e0\u65e5\u5fd7\u3001\u975e\u6b63\u5e38\u5173\u673a\u9700\u8981\u6267\u884c chkdsk \u6062\u590d\u3002\u57fa\u4e8e\u8fd9\u4e9b\u539f\u56e0\uff0cPostgreSQL \u5b89\u88c5\u7a0b\u5e8f\u4e0d\u652f\u6301\u628a\u6570\u636e\u5e93\u96c6\u7fa4\u76f4\u63a5\u5b89\u88c5\u5230 FAT32 \u7cfb\u7edf\u4e0a\u3002\u5f53\u7136\uff0c\u4f60\u624b\u5de5\u6267\u884c initdb \u8fd8\u662f\u53ef\u884c\u7684\u3002</p>\n<h4 id=\"ntfs\">NTFS<a class=\"headerlink\" href=\"#ntfs\" title=\"Permanent link\">&para;</a></h4>\n<p>NTFS \u662f\u5fae\u8f6f\u7684\u65d7\u8230\u6587\u4ef6\u7cfb\u7edf\uff0c\u5b83\u4f7f\u7528\u975e\u6709\u5e8f\u5143\u6570\u636e\u65e5\u5fd7\u8bb0\u5f55\u3002\u6709\u70b9\u7c7b\u4f3c Linux \u4e0b\u7684 writeback \u65e5\u5fd7\u6a21\u5f0f\u3002\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u5b83\u503c\u5f97\u4fe1\u8d56\uff0c\u4f46\u5728\u4e00\u4e9b\u7f55\u89c1\u7684\u60c5\u51b5\u4e0b\uff0c\u6709\u53ef\u80fd\u5fc5\u987b\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c chkdsk \u6307\u4ee4\u624d\u80fd\u6302\u8f7d\u4e0a\u6765\u3002\u5c31\u50cf\u8f83\u65e9\u7684 PostgreSQL \u5b89\u88c5\u7a0b\u5e8f\u6240\u63cf\u8ff0\u7684\u90a3\u6837\uff0c\u5f53\u4f7f\u7528 NTFS \u662f\uff0c\u504f\u5411\u4e8e\u4f7f\u7528\u4e0b\u9762\u7684\u6570\u636e\u5e93\u914d\u7f6e\u53c2\u6570\uff1a</p>\n<p><code>open_datasync=fsync_writethrough</code>\\\nNTFS \u4f7f\u7528\u79f0\u4e3a\"filesystem\njunction\\\"\u7684\u529f\u80fd\u6765\u5141\u8bb8\u5728\u5176\u4e0a\u521b\u5efa\u529f\u80fd\u7b49\u4ef7\u7684\u7b26\u53f7\u94fe\u63a5\uff0cJunction \u5de5\u5177\u53ef\u4ee5\u4ece<a href=\"http://technet.microsoft.com/en-us/sysinternals/bb896768\">http://technet.microsoft.com/en-us/sysinternals/bb896768</a>\u4e0b\u8f7d\u3002\u8fd9\u5c31\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u5728 NTFS \u5377\u4e0a\u4fdd\u7559\u76ee\u5f55\u7ed3\u6784\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\u628a pg_xlog \u5b58\u653e\u5230\u53e6\u5916\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0a\u3002\u8fd9\u4e2a\u529f\u80fd\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5728\u8868\u7a7a\u95f4\u4e0a\u3002</p>\n<p>\u548c\u7c7b\u4f3c UNIX \u7684 noatime \u53c2\u6570\u76f8\u4f3c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 NTFS \u5377\u4e0a\u5173\u95ed\u5bf9\u5e94\u7684\u529f\u80fd\u3002\\\n<code>fsutil behavior set disablelastaccess 1</code>\\\n\u56e0\u4e3a\u5386\u53f2\u539f\u56e0\uff0cNTFS \u6700\u81ea\u52a8\u751f\u6210\u7b26\u5408 8.3 \u683c\u5f0f\u7684\u6587\u4ef6\u540d\uff0c\u4ee5\u4fbf\u5411\u540e\u517c\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u53c2\u6570\u7981\u6b62\u8fd9\u4e2a\u529f\u80fd\uff1a\\\n<code>fsutil behavior set disable8dot3 1</code>\\\n\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u8bbe\u7f6e\u4e86 disable8to3 \u53c2\u6570\uff0c\u53ef\u80fd\u6709\u6709\u4e9b\u610f\u5916\u7684\u60c5\u51b5\u53d1\u751f\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u7684%TEMP%\u6216%TMP%\u73af\u5883\u53d8\u91cf\u4f7f\u7528\u4e86\u77ed\u540d\u6765\u8bbf\u95ee\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5173\u95ed\u8fd9\u4e2a\u53c2\u6570\u540e\uff0c\u4f1a\u5bfc\u81f4\u76ee\u5f55\u627e\u4e0d\u5230\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u66f4\u65b0\u6240\u6709\u4f7f\u7528\u77ed\u540d\u7684\u73af\u5883\u53d8\u91cf\u3002</p>\n<h4 id=\"write-barriers\">Write barriers<a class=\"headerlink\" href=\"#write-barriers\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7edd\u5927\u90e8\u5206\u78c1\u76d8\u90fd\u6709\u6613\u5931\u7f13\u5b58\uff0c\u56e0\u6b64 PostgreSQL \u7684 WAL \u5199\u6a21\u5f0f\u4e0e\u6b64\u5e76\u4e0d\u517c\u5bb9\uff0c\u8fd9\u91cc\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u8981\u6c42\u5c31\u662f\u5f53\u4e00\u4e2a\u6587\u4ef6\u540c\u6b65\u64cd\u4f5c\u53d1\u751f\u65f6\uff08fsync)\uff0c\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u786e\u4fdd\u6240\u6709\u76f8\u5173\u6570\u636e\u90fd\u5199\u5165\u975e\u6613\u5931\u7f13\u5b58\u6216\u78c1\u76d8\u672c\u8eab\u3002\n\u6587\u4ef6\u7cfb\u7edf\u5143\u6570\u636e\u5199\u64cd\u4f5c\u4e5f\u6709\u540c\u6837\u7684\u8981\u6c42\uff0c\u5bf9\u6570\u636e\u66f4\u65b0\u7684\u5199\u64cd\u4f5c\u8981\u6c42\u65e5\u5fd7\u66f4\u65b0\u9996\u5148\u6309\u7167\u6b63\u786e\u7684\u987a\u5e8f\u5199\u5165\u5b89\u5168\u533a\u57df\u3002</p>\n<p>Linux Kernel \u4e3a\u4e86\u652f\u6301\u8fd9\u4e9b\u573a\u666f\uff0c\u5f00\u53d1\u79f0\u4e4b\u4e3a\u5199\u5c4f\u969c(write\nbarrios)\u7684\u529f\u80fd\u3002\u5185\u6838\u6587\u6863\u662f\u5982\u6b64\u63cf\u8ff0 write barries \u7684\uff1a</p>\n<blockquote>\n<p>All requests queued before a barrier request must be finished (made it\nto the physical medium) before the barrier request is started, and all\nrequests queued after the barrier request must be started only after\nthe barrier request is finished (again, made it to the physical\nmedium).</p>\n</blockquote>\n<p>\u610f\u601d\u662f\u5f53\u4e00\u4e2a barrier \u8bf7\u6c42\u5230\u6765\u65f6\uff0c\u6240\u6709\u5728\u8fd9\u4e2a\u4e4b\u524d\u7684\u8bf7\u6c42\u961f\u5217\u6bd4\u5982\u5b8c\u6210\uff08\u5199\u5165\u7269\u7406\u4ecb\u8d28\uff09\uff0c\u7136\u540e\u8fd9\u4e2a barrier \u8bf7\u6c42\u624d\u80fd\u54cd\u5e94\uff0c\u800c barries \u4e4b\u540e\u7684\u6240\u6709\u8bf7\u6c42\u961f\u5217\u53ea\u6709\u5f53\u8fd9\u4e2a barries \u5b8c\u6210\u540e\uff08\u5199\u5165\u7269\u7406\u4ecb\u8d28\uff09\u624d\u80fd\u5f00\u59cb\u3002</p>\n<p>\u8fd9\u76f8\u5f53\u4e8e\u5728\u4e00\u4e2a\u8f83\u957f\u7684\u8bf7\u6c42\u961f\u5217\u91cc\u5f3a\u884c\u63d2\u5165\u4e00\u4e2a\u6805\u680f\uff0c\u53ea\u6709\u6805\u680f\u524d\u7684\u961f\u5217\u90fd\u5b8c\u6210\uff0c\u540e\u9762\u7684\u624d\u80fd\u53d1\u8d77\u3002\u53ef\u4ee5\u60f3\u8c61\u7c7b\u4f3c\u8d85\u5e02\u6392\u961f\u7ed3\u8d26\u65f6\u7684\u573a\u666f\uff0c\u5f53\u961f\u5217\u8fc7\u957f\u65f6\uff0c\u4fdd\u5b89\u4f1a\u8fc7\u6765\u5e72\u6d89\uff0c\u5b83\u7ad9\u5728\u961f\u4f0d\u7684\u4e2d\u95f4\uff0c\u7136\u540e\u8bf4\uff0c\"\u540e\u9762\u7684\u7a0d\u5fae\u7b49\u4e00\u4e0b\uff0c\u4e3a\u4e86\u9632\u6b62\u62e5\u6324\uff0c\u7b49\u524d\u9762\u7684\u90fd\u7ed3\u7b97\u5b8c\u540e\uff0c\u4f60\u4eec\u518d\u8fc7\u53bb\"\u3002</p>\n<h4 id=\"barriers\">\u78c1\u76d8\u5bf9 barriers \u7684\u652f\u6301<a class=\"headerlink\" href=\"#barriers\" title=\"Permanent link\">&para;</a></h4>\n<p>SCSI/SAS \u78c1\u76d8\u5141\u8bb8\u8bfb\u5199\u64cd\u4f5c\u6307\u5b9a\u5f3a\u5236\u5355\u5143\u8bbf\u95ee(Force Unit Access aka\nFUA)\uff0c\u5b83\u53ef\u4ee5\u4e0d\u901a\u8fc7\u7f13\u5b58\u76f4\u63a5\u8bbf\u95ee\u78c1\u76d8\u4ecb\u8d28\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u5199\u900f(write-through)\u3002\u540c\u65f6\u4e5f\u652f\u6301 SYNCHRONIZE\nCACHE \u8c03\u7528\u6765\u5237\u76d8\u3002</p>\n<p>\u65e9\u671f\u7684 IDE \u78c1\u76d8\u5b9e\u73b0\u4e86\u79f0\u4e4b\u4e3a FLUSH\nCACHE \u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u4e0d\u8fc7\u78c1\u76d8\u5927\u5c0f\u9650\u5236\u4e3a 137GB\u3002ATA-6 \u89c4\u8303\u4e2d\u589e\u52a0\u4e86\u5bf9\u5927\u78c1\u76d8\u7684\u652f\u6301\uff0c\u5e76\u589e\u52a0\u4e86\u65b0\u7684 FLUSH\nCACHE EXT \u7cfb\u7edf\u8c03\u7528\u3002</p>\n<p>\u652f\u6301\u539f\u751f\u547d\u4ee4\u961f\u5217\uff08Native Command\nQueuing)\u7684 SATA \u78c1\u76d8\u4e5f\u80fd\u5904\u7406 FUA\u3002Linux \u4ece 2.6.19 \u5185\u6838\u5f00\u59cb\u5bf9\u5176 NCQ \u7684\u652f\u6301\u653e\u5728\u4e86 libata \u9a71\u52a8\u529b\uff0c\u4e0d\u8fc7\u6709\u4e00\u4e9b\u53d1\u578b\u7248\u672c\uff08\u6bd4\u5982 RedHat\uff09\u4e3a\u4e86\u5411\u540e\u517c\u5bb9\uff0c\u8fd8\u662f\u628a\u5bf9 NCQ \u7684\u652f\u6301\u9a71\u52a8\u653e\u5728\u5185\u6838\u91cc\u3002</p>\n<h4 id=\"barriers_1\">\u6587\u4ef6\u7cfb\u7edf\u5bf9 barriers \u7684\u652f\u6301<a class=\"headerlink\" href=\"#barriers_1\" title=\"Permanent link\">&para;</a></h4>\n<p>ext3 \u6587\u4ef6\u7cfb\u7edf\u5982\u679c\u53ea\u4f7f\u7528\u7b80\u5355\u5377\uff0c\u7406\u8bba\u4e0a\u662f\u652f\u6301 barriers \u7684\u3002\u5982\u679c\u4f7f\u7528\u8f6f RAID \u6216\u8005 LVM\uff0c\u5219 barriers \u6839\u672c\u65e0\u6548\u3002</p>\n<p>XFS \u80fd\u591f\u6b63\u786e\u5904\u7406 write barriers\uff0c\u800c\u4e14\u7f3a\u7701\u60c5\u51b5\u4e0b\u662f\u542f\u52a8\u8fd9\u4e2a\u529f\u80fd\u7684\u3002</p>\n<p>ext4 \u540c\u6837\u652f\u6301 barriers\uff0c\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u4e5f\u662f\u542f\u52a8\u6b64\u529f\u80fd\u7684\u3002</p>\n<h3 id=\"linux_1\">\u901a\u7528 Linux \u6587\u4ef6\u7cfb\u7edf\u8c03\u4f18\u65b9\u6848<a class=\"headerlink\" href=\"#linux_1\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"read-ahead\">Read-ahead<a class=\"headerlink\" href=\"#read-ahead\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5c06 read-ahead \u53ef\u8c03\u8303\u56f4\u4e00\u822c\u4e3a 4096\u00a016384\uff0c\u7f3a\u7701\u503c\u4e00\u822c\u662f 256\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\u67e5\u770b\u7f3a\u7701\u503c</p>\n<p><code>blockdev--getra /dev/sda</code></p>\n<p>\u8bbe\u7f6e read-ahead \u7684\u6307\u4ee4\u5982\u4e0b\uff1a</p>\n<p><code>blockdev --setra 4096 /dev/sda</code></p>\n<h4 id=\"file-access-times\">File access times<a class=\"headerlink\" href=\"#file-access-times\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5173\u95ed atime\uff0c\u5728 fstab \u91cc\u5bf9\u5e94\u7684\u8bbe\u5907\u6302\u8f7d\u9009\u9879\u4e0a\u52a0\u4e0a noatime\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<p><code>/dev/sda1     /     ext3     noatime,errors=remount-ro 0 1</code></p>\n<h4 id=\"read-caching-and-swapping\">Read caching and swapping<a class=\"headerlink\" href=\"#read-caching-and-swapping\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8bbe\u7f6e vm.swappiness=0\uff0c\u8868\u793a\u5185\u6838\u5c3d\u53ef\u80fd\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf cache \u800c\u4e0d\u662f swap</p>\n<p>\u5173\u95ed overcommit \u884c\u4e3a\uff0c\u4e5f\u5c31\u662f\u8bbe\u7f6e vm.overcommit_memory=2</p>\n<h4 id=\"write-caching-size\">write caching size<a class=\"headerlink\" href=\"#write-caching-size\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6709\u4e24\u4e2a\u53c2\u6570\u53ef\u4ee5\u8c03\u6574\u4e0a\u8ff0\u884c\u4e3a</p>\n<p><strong>/proc/sys/vm/dirty_background_ratio</strong>: \u8fd9\n\u4e2a\u53c2\u6570\u63a7\u5236\u6587\u4ef6\u7cfb\u7edf\u7684 pdflush \u8fdb\u7a0b\uff0c\u5728\u4f55\u65f6\u5237\u65b0\u78c1\u76d8\u3002\u5355\u4f4d\u662f\u767e\u5206\u6bd4\uff0c\u8868\u793a\u7cfb\u7edf\u5185\u5b58\u7684\u767e\u5206\u6bd4\uff0c\u610f\u601d\u662f\u5f53\u5199\u7f13\u51b2\u4f7f\u7528\u5230\u7cfb\u7edf\u5185\u5b58\u591a\u5c11\u7684\u65f6\u5019\uff0cpdflush \u5f00\u59cb\u5411\u78c1\u76d8\u5199\u51fa\u6570\u636e\u3002\u589e\u5927\u4e4b\u4f1a\u4f7f\u7528\u66f4\u591a\u7cfb\u7edf\u5185\u5b58\u7528\u4e8e\u78c1\u76d8\u5199\u7f13\u51b2\uff0c\u4e5f\u53ef\u4ee5\u6781\u5927\u63d0\u9ad8\u7cfb\u7edf\u7684\u5199\u6027\u80fd\u3002\u4f46\u662f\uff0c\u5f53\u4f60\u9700\u8981\u6301\u7eed\u3001\u6052\u5b9a\u7684\u5199\u5165\u573a\u5408\u65f6\uff0c\u5e94\u8be5\u964d\u4f4e\u5176\u6570\u503c\uff0c\u4e00\u822c\u542f\u52a8\u4e0a\u7f3a\u7701\u662f\n5\u3002</p>\n<p><strong>/proc/sys/vm/dirty_ratio</strong>:\n\u8fd9\u4e2a\u53c2\u6570\u63a7\u5236\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u7cfb\u7edf\u5199\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff0c\u5355\u4f4d\u662f\u767e\u5206\u6bd4\uff0c\u8868\u793a\u7cfb\u7edf\u5185\u5b58\u7684\u767e\u5206\u6bd4\uff0c\u8868\u793a\u5f53\u5199\u7f13\u51b2\u4f7f\u7528\u5230\u7cfb\u7edf\u5185\u5b58\u591a\u5c11\u7684\u65f6\u5019\uff0c\u5f00\u59cb\u5411\u78c1\u76d8\u5199\u51fa\u6570\u636e\u3002\u589e\u5927\u4e4b\u4f1a\u4f7f\u7528\u66f4\u591a\u7cfb\u7edf\u5185\u5b58\u7528\u4e8e\u78c1\u76d8\u5199\u7f13\u51b2\uff0c\u4e5f\u53ef\u4ee5\u6781\u5927\u63d0\u9ad8\u7cfb\u7edf\u7684\u5199\u6027\u80fd\u3002\u4f46\u662f\uff0c\u5f53\u4f60\u9700\u8981\u6301\u7eed\u3001\u6052\u5b9a\u7684\u5199\u5165\u573a\u5408\u65f6\uff0c\u5e94\u8be5\u964d\u4f4e\u5176\u6570\u503c\uff0c\u4e00\u822c\u542f\u52a8\u4e0a\u7f3a\u7701\u662f\n10</p>\n<p>\u5bf9\u4e8e\u8d85\u8fc7 8G \u7684\u5185\u5b58\u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u8003\u8651\u5c06 dirty_background_ratio\n\u8bbe\u7f6e\u4e3a 1\uff0c\u628a dirty_ratio \u8bbe\u7f6e\u4e3a 2</p>\n<h4 id=\"io\">I/O \u8c03\u5ea6\u7b97\u6cd5<a class=\"headerlink\" href=\"#io\" title=\"Permanent link\">&para;</a></h4>\n<dl>\n<dt>elevator=cfq</dt>\n<dd>\n<p>\u5b8c\u5168\u516c\u5e73\u961f\u5217\uff0c\u5b83\u8bd5\u56fe\u628a I/O \u5e26\u5bbd\u5e73\u5206\u7ed9\u6240\u6709\u7684\u8bf7\u6c42\u3002\u8fd9\u662f Linux \u9ed8\u8ba4\u8c03\u5ea6\u7b97\u6cd5</p>\n</dd>\n<dt>elevator=deadline</dt>\n<dd>\n<p>\u76ee\u7684\u5728\u4e8e\u5e73\u8861 I/O \u548c\u8bf7\u6c42\u65f6\u95f4\uff0c\u786e\u4fdd\u4e0d\u4f1a\u51fa\u73b0\u56e0\u7b49\u5f85\u65f6\u95f4\u592a\u957f\u800c\"\u997f\u6b7b\"\u7684\u8bf7\u6c42\u3002</p>\n</dd>\n<dt>elevator=noop</dt>\n<dd>\n<p>\u4e0d\u505a\u4efb\u4f55\u590d\u6742\u7684\u8c03\u5ea6\uff0c\u5b83\u53ea\u662f\u7b80\u5355\u7684\u5904\u7406\u5757\u8bf7\u6c42\u5408\u5e76\uff0c\u5e76\u4f9d\u636e\u5e95\u5c42\u8bbe\u5907\u987a\u5e8f\u5bf9\u8bf7\u6c42\u6392\u5e8f\u3002</p>\n</dd>\n<dt>elevator=as</dt>\n<dd>\n<p>Anticipatory \u8c03\u5ea6\u6709\u610f\u5ef6\u8fdf I/O \u8bf7\u6c42\uff0c\u4ee5\u671f\u80fd\u5408\u5e76\u4e00\u4e9b\u8bf7\u6c42\uff0c\u800c\u4ece\u53ef\u4ee5\u6279\u5904\u7406\u3002</p>\n</dd>\n</dl>\n<p>\u76ee\u524d\u56db\u79cd\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5176\u5b9e\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u4e0d\u5982\u4e0a\u8ff0\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u60f3\u63d0\u5347\u8bfb\u7684\u6027\u80fd\uff0c\u90a3\u4e48\u8003\u8651\u8c03\u6574 read\nahead \u53c2\u6570\uff0c\u5982\u679c\u60f3\u63d0\u5347\u5199\u7684\u6027\u80fd\uff0c\u8c03\u6574 write chaching size\u3002</p>\n<p>\u4e0b\u9762\u63cf\u8ff0\u4e00\u79cd\u8c03\u5ea6\u7b97\u6cd5\u5f71\u54cd\u7cfb\u7edf\u6548\u7387\u7684\u4f8b\u5b50\uff1a</p>\n<p>\u5bf9\u4e8e\u6709\u5927\u91cf\u78c1\u76d8\u8bfb\u5199\u7684\u7cfb\u7edf\uff0c\u6bd4\u5982 RAID \u6216\u8005 SAN\uff0c\u4f7f\u7528 noop \u8c03\u5ea6\u7b97\u6cd5\u53ef\u4ee5\u5feb\u901f\u7684\u628a\u8bf7\u6c42\u6570\u636e\u8f6c\u53d1\u7ed9\u786c\u4ef6\uff0c\u5982\u679c\u786c\u4ef6\u6709\u5927 cache \u7684\u8bdd\uff0c\u662f\u53ef\u4ee5\u63d0\u5347\u6027\u80fd</p>\n<p>\u5bf9\u4e8e\u684c\u9762\u7cfb\u7edf\uff0c\u78c1\u76d8 I/O \u80fd\u529b\u6709\u9650\uff0cas \u8c03\u5ea6\u7b97\u6cd5\u80fd\u591f\u66f4\u597d\u7684\u6392\u5e8f\u8bfb\u5199\u8bf7\u6c42\u5230\u6279\u5904\u7406\u91cc\uff0c\u4e0d\u8fc7\u5f88\u663e\u7136\uff0c\u4e0d\u9002\u5408\u5178\u578b\u7684\u6570\u636e\u5e93\u670d\u52a1\u3002</p>\n<h3 id=\"_10\">\u6587\u4ef6\u7cfb\u7edf\u65b9\u9762\u7684\u8c03\u4f18\u603b\u7ed3<a class=\"headerlink\" href=\"#_10\" title=\"Permanent link\">&para;</a></h3>\n<ol>\n<li>\n<p>\u5f53\u524d\u5199\u65e5\u5fd7\u662f\u5927\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\u7528\u4e8e\u5d29\u6e83\u540e\u6062\u590d\u7684\u4e00\u79cd\u673a\u5236</p>\n</li>\n<li>\n<p>\u5bf9\u4e8e Linux\uff0cext3 \u6587\u4ef6\u5b58\u5728\u66f4\u591a\u7684\u53ef\u8c03\u4f18\u7684\u53ef\u80fd\u6027\u3002XFS \u548c ext4 \u76ee\u524d\u8fd8\u7b97\u662f\u5728\u4ea7\u54c1\u65e9\u671f\u9636\u6bb5\uff0c\u4f46\u76f8\u4fe1\u5c06\u6765\u662f ext3 \u7684\u4e00\u4e2a\u5f88\u597d\u7684\u66ff\u4ee3\u65b9\u6848</p>\n</li>\n<li>\n<p>Solaris \u548c FreeBSD\n    \u90fd\u6709\u8f83\u8001\u7248\u672c\u7684 UFS \u6587\u4ef6\u7cfb\u7edf\u548c\u8f83\u65b0\u7684 ZFS \u6587\u4ef6\u7cfb\u7edf\u3002ZFS \u7684\u4e00\u4e9b\u7279\u6027\u4f7f\u5f97\u5b83\u5f88\u9002\u5408\u5927\u578b\u6570\u636e\u5e93</p>\n</li>\n<li>\n<p>Windows \u7684 NTFS \u501f\u9274\u4e86\u5f88\u591a UNIX \u4e0a\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u6027</p>\n</li>\n<li>\n<p>\u589e\u52a0 read-ahead\uff0c\u505c\u6b62 atime \u7684\u66f4\u65b0\uff0c\u8c03\u6574\u7528\u4e8e\u5199\u7f13\u5b58\u7684\u6570\u503c\u90fd\u662f\u901a\u7528\u7684\u8c03\u4f18\u6280\u5de7\uff0c\u800c\u4e14\u901a\u5e38\u90fd\u80fd\u63d0\u9ad8\u6570\u636e\u5e93\u7684\u6027\u80fd</p>\n</li>\n<li>\n<p>PostgreSQL \u53ef\u4ee5\u5c06\u6570\u636e\u8fc1\u79fb\u4f4d\u7f6e\uff0c\u65b9\u6cd5\u662f\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u7b26\u53f7\u94fe\u63a5\u6216\u8005\u521b\u5efa\u8868\u7a7a\u95f4</p>\n</li>\n<li>\n<p>\u662f\u5426\u9700\u8981\u5c06\u6570\u636e\u5e93\u7684\u5404\u7ec4\u6210\u90e8\u5206\u5206\u4e0d\u5230\u4e0d\u540c\u7684\u78c1\u76d8\u4e0a\uff0c\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u51b3\u4e8e\u5e94\u7528\u7a0b\u5e8f\u548c\u4f7f\u7528\u65b9\u5f0f</p>\n</li>\n</ol>\n<h3 id=\"postgresql\">\u9488\u5bf9 PostgreSQL \u7684\u78c1\u76d8\u5e03\u5c40<a class=\"headerlink\" href=\"#postgresql\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56e0\u4e3a PostgreSQL \u5bf9\u6240\u6709\u7684\u6587\u4ef6\u90fd\u4f7f\u7528\u6807\u51c6\u6587\u4ef6\u7cfb\u7edf\uff0c\u6570\u636e\u5e93\u7684\u6709\u51e0\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u5206\u914d\u8def\u5f84\uff0c\u6709\u4e00\u4e9b\u901a\u8fc7\u76f4\u63a5\u79fb\u52a8\u76f8\u5173\u6587\u4ef6\uff0c\u6709\u4e9b\u5219\u901a\u8fc7\u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u6765\u5b9e\u73b0\u3002</p>\n<h4 id=\"_11\">\u7b26\u53f7\u94fe\u63a5<a class=\"headerlink\" href=\"#_11\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6211\u4eec\u53ef\u4ee5\u628a WAL \u5b58\u653e\u5230\u72ec\u7acb\u7684\u7279\u522b\u4e3a\u5176\u4f18\u5316\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u7136\u540e\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u6765\u4fdd\u6301\u5176\u6570\u636e\u5e93\u76ee\u5f55\u7ed3\u6784\u4e0d\u53d8\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span><span class=\"nb\">cd</span><span class=\"w\"> </span><span class=\"nv\">$PGDATA</span>\n$<span class=\"w\"> </span>mv<span class=\"w\"> </span>pg_xlog<span class=\"w\"> </span>/disk\n$<span class=\"w\"> </span>ln<span class=\"w\"> </span>-s<span class=\"w\"> </span>/disk/pg_xlog<span class=\"w\"> </span>pg_xlog\n</code></pre></div>\n<p>\u4ece PostgreSQL\n8.3 \u4ee5\u540e\uff0c\u5728\u6267\u884c initdb \u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a--xlogdir \u53c2\u6570\u6765\u6307\u5b9a xlog \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u4e0d\u8fc7\u5176\u5de5\u4f5c\u539f\u6765\u548c\u4e0a\u4e00\u81f4\uff0c\u4e5f\u662f\u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u3002</p>\n<h4 id=\"_12\">\u8868\u7a7a\u95f4<a class=\"headerlink\" href=\"#_12\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u8868\u7a7a\u95f4\u65f6\u8bbe\u7f6e location \u53c2\u6570\u6765\u6307\u5b9a\u5176\u8868\u7a7a\u95f4\u5185\u7684\u6570\u636e\u6587\u4ef6\u548c\u8868\u5b58\u5230\u5230\u4e0d\u540c\u7684\u4f4d\u7f6e\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$ mkdir /disk/pgdata\n$ psql\npostgres=# CREATE TABLESPACE disk LOCATION &#39;/disk/pgdata&#39;;\npostgres=# CREATE TABLE t(i int) TABLESPACE disk;\n</code></pre></div>\n<p>\u5728\u6570\u636e\u5e93\u5185\u90e8\uff0c\u8fd9\u4e2a\u529f\u80fd\u4e5f\u662f\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u6765\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u4e0a\u8ff0\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u9700\u8981\u6587\u4ef6\u7cfb\u7edf\u7684\u652f\u6301\u3002</p>\n<h4 id=\"_13\">\u6570\u636e\u5e93\u76ee\u5f55\u6811<a class=\"headerlink\" href=\"#_13\" title=\"Permanent link\">&para;</a></h4>\n<p>\u901a\u8fc7 initdb \u6307\u4ee4\uff0cPostgreSQL \u521b\u5efa\u4e86\u4e0b\u9762\u7684\u4e3b\u8981\u76ee\u5f55\u7ed3\u6784\uff0c\u5206\u522b\u63cf\u8ff0\u5982\u4e0b\uff1a</p>\n<dl>\n<dt>base</dt>\n<dd>\n<p>\u8fd9\u662f\u5b58\u50a8 pg_default \u7684\u4f4d\u7f6e\uff0c\u5305\u62ec\u7f3a\u7701\u7684\u8868\u7a7a\u95f4\u3001\u6a21\u677f\u6570\u636e\u5e93\u4ee5\u53ca\u4efb\u4f55\u4e0d\u901a\u8fc7\u663e\u793a\u6307\u5b9a\u4f4d\u7f6e\u7684\u8868\u7a7a\u95f4\u6587\u4ef6\u5b58\u653e\u4f4d\u7f6e\u3002</p>\n</dd>\n<dt>global</dt>\n<dd>\n<p>\u5b58\u653e pg_global \u91cc\u8bbe\u7f6e\u7684\u865a\u62df\u8868\u7a7a\u95f4\uff0c\u8fd9\u91cc\u662f\u5728\u4e00\u4e2a\u96c6\u7fa4\u91cc\u80fd\u88ab\u6240\u6709\u6570\u636e\u5e93\u5171\u4eab\u7684\u7cfb\u7edf\u8868\uff0c\u6bd4\u5982\u6570\u636e\u5e93\u89d2\u8272\u548c\u5176\u4ed6\u7cfb\u7edf\u6761\u76ee</p>\n</dd>\n<dt>pg_clog</dt>\n<dd>\n<p>\u4e8b\u52a1\u63d0\u4ea4\u65e5\u5fd7\u5b58\u653e\u70b9\u3002\u8fd9\u4e9b\u6570\u636e\u88ab VACUUM \u6307\u4ee4\u8bfb\u53d6\uff0c\u56e0\u6b64\u8fd9\u4e9b\u6587\u4ef6\u4e0d\u518d\u9700\u8981\uff0c\u5c31\u88ab\u5220\u9664\u3002\u5982\u679c pg_clog \u6240\u5728\u6587\u4ef6\u7cfb\u7edf\u5728\u6302\u8f7d\u65f6\u7ed5\u8fc7\u4e86\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\uff0c\u5219\u5b83\u4f1a\u79f0\u4e3a\u4e25\u91cd\u62d6\u7d2f\u6570\u636e\u5e93\u6027\u80fd\u7684\u7f6a\u9b41\u7978\u9996\u3002</p>\n</dd>\n<dt>pg_stat_tmp</dt>\n<dd>\n<p>\u8fd9\u4e2a\u76ee\u5f55\u7528\u4e8e\u5b58\u50a8\u90a3\u4e9b\u7528\u4e8e\u6570\u636e\u5e93\u7edf\u8ba1\u7684\u6587\u4ef6\u3002\u8fd9\u4e9b\u6587\u4ef6\u90fd\u4e0d\u4f1a\u592a\u5927\u3002</p>\n</dd>\n<dt>pg_tblspc</dt>\n<dd>\n<p>\u5f53\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8868\u7a7a\u95f4\u65f6\uff0c\u4f1a\u5728\u8fd9\u4e2a\u76ee\u5f55\u521b\u5efa\u4e00\u4e2a\u6307\u5411\u8868\u7a7a\u95f4\u76ee\u5f55\u7684\u7b26\u53f7\u94fe\u63a5\u6587\u4ef6\u3002\u5220\u9664\u8868\u7a7a\u95f4\u65f6\uff0c\u5219\u5220\u9664\u5bf9\u5e94\u7684\u7b26\u53f7\u94fe\u63a5\u6587\u4ef6\u3002</p>\n</dd>\n<dt>pg_xlog</dt>\n<dd>\n<p>\u5b58\u653e WAL \u7528\u4e8e\u5d29\u6e83\u540e\u56de\u6062\u590d\u7684\u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u91cd\u505a\u65e5\u5fd7</p>\n</dd>\n<dt>pg_subtrans</dt>\n<dd>\n<p>\u5b58\u653e\u4e0e\u5b50\u4e8b\u52a1\u76f8\u5173\u7684\u6570\u636e</p>\n</dd>\n<dt>pg_multixact</dt>\n<dd>\n<p>\u5b58\u653e\u591a\u4e8b\u52a1\u72b6\u6001\u6570\u636e\u3002\u5f53\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u5927\u91cf\u4f7f\u7528\u5171\u4eab\u884c\u7ea7\u9501\u65f6\uff0c\u8fd9\u4e2a\u76ee\u5f55\u5c31\u4f1a\u88ab\u5927\u91cf\u4f7f\u7528</p>\n</dd>\n<dt>pg_twophase</dt>\n<dd>\n<p>\u5b58\u653e\u548c\u4e24\u9636\u6bb5\u63d0\u4ea4\u76f8\u5173\u7684\u6570\u636e</p>\n</dd>\n</dl>\n<h4 id=\"_14\">\u4e34\u65f6\u6587\u4ef6<a class=\"headerlink\" href=\"#_14\" title=\"Permanent link\">&para;</a></h4>\n<p>PostgreSQL \u6709\u51e0\u4e2a\u9700\u8981\u4fdd\u5b58\u4e34\u65f6\u6587\u4ef6\u7684\u5e94\u7528\u573a\u666f\uff0c\u4e00\u4e2a\u662f\u4f7f\u7528 create temporary\ntable \u6765\u521b\u5efa\u8868\u4ee5\u53ca\u5bf9\u5e94\u7684\u7d22\u5f15\uff1b\u4e00\u4e2a\u662f\u5f53\u4e00\u4e2a\u67e5\u8be2\u91cc\u5305\u542b\u6392\u5e8f\u64cd\u4f5c\u65f6\uff0c\u5176\u6570\u636e\u8d85\u8fc7\u4e86 work_mem \u8bbe\u7f6e\u7684\u5927\u5c0f\u3002\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e34\u65f6\u5bf9\u8c61\u5b58\u653e\u5728 base/pgsql_tmp \u76ee\u5f55\uff0c\u9664\u975e\u91cd\u65b0\u6307\u5b9a\u4e86\u4f4d\u7f6e\u3002</p>\n<h4 id=\"raid\">\u78c1\u76d8\u7ec4\u3001RAID \u4ee5\u53ca\u78c1\u76d8\u5e03\u5c40<a class=\"headerlink\" href=\"#raid\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5982\u679c\u4f60\u78c1\u76d8\u5f88\u591a\uff0c\u800c\u4e14\u78c1\u76d8\u7a7a\u95f4\u5229\u7528\u4e0d\u662f\u95ee\u9898\uff0c\u90a3\u4e48\u4e0b\u9762\u7684\u4e00\u4e2a\u5e03\u5c40\u5bf9\u63d0\u5347\u6027\u80fd\u8fd8\u662f\u5f88\u6709\u5e2e\u52a9\u7684\uff1a\\</p>\n<div class=\"highlight\"><pre><span></span><code>   Location       Disks   RAID Level       Purpose\n</code></pre></div>\n<hr />\n<div class=\"highlight\"><pre><span></span><code>   /(root)          2         1              OS\n   \\$PGDATA        6+         10          Database\n</code></pre></div>\n<p>$PGDATA/pg_xlog 2 1 WAL\nTablespace 1+ None Temporary files</p>\n<p>\\\n\u9488\u5bf9\u4e0a\u9762\u7684\u78c1\u76d8\u5e03\u5c40\u6a21\u5f0f\uff0c\u7136\u540e\u8003\u8651\u5230\u4e0d\u540c\u7ec4\u4ef6\u5bf9\u7f13\u5b58\u5237\u76d8\u7684\u9700\u6c42\u4e0d\u540c\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4e0b\u9762\u7684 cache \u8bbe\u7f6e\u65b9\u5f0f\uff1a\\</p>\n<div class=\"highlight\"><pre><span></span><code>  Function       Cache Flushes           Access Pattern\n</code></pre></div>\n<hr />\n<div class=\"highlight\"><pre><span></span><code>     OS              Rare         Mix of sequential and random\n  Database         Regularly      Mix of sequential and random\n     WAL           Constant                Sequential\n</code></pre></div>\n<p>Temporary files Never More random as client increases</p>\n<h3 id=\"_15\">\u78c1\u76d8\u5e03\u5c40\u6307\u5357<a class=\"headerlink\" href=\"#_15\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p>\u907f\u514d\u628a WAL \u548c\u64cd\u4f5c\u7cfb\u7edf\u653e\u5728\u4e00\u4e2a\u78c1\u76d8\u4e0a\uff0c\u4ed6\u4eec\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u8bbf\u95ee\u6a21\u5f0f</p>\n</li>\n<li>\n<p>\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u4f60\u7684\u6570\u636e\u5e93\u4e0d\u4f1a\u6709\u5927\u6570\u636e\u91cf\u6392\u5e8f\uff0c\u4f60\u53ef\u4ee5\u8ba9\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u5728\u9ed8\u8ba4\u7684\u4f4d\u7f6e</p>\n</li>\n<li>\n<p>\u5728\u4f7f\u7528 ext3 \u7684 Linux \u7cfb\u7edf\u4e0a\uff0c\u5c3d\u53ef\u80fd\u628a WAL \u5b58\u653e\u5230\u53e6\u5916\u7684\u78c1\u76d8\u4e0a\uff0c\u4e0d\u8981\u548c\u6570\u636e\u5e93\u6587\u4ef6\u6405\u548c\u5728\u4e00\u4e2a\u78c1\u76d8\u4e0a</p>\n</li>\n<li>\n<p>\u6587\u4ef6\u7cfb\u7edf\u7edd\u5927\u90e8\u5206\u90fd\u662f\u901a\u8fc7\u5199\u65e5\u5fd7\u6765\u4fdd\u8bc1\u5d29\u6e83\u540e\u53ef\u4ee5\u6062\u590d\uff0c\u65e5\u5fd7\u867d\u7136\u589e\u52a0\u4e86\u5f00\u9500\uff0c\u4f46\u4f7f\u5f97\u6062\u590d\u65f6\u95f4\u53ef\u4ee5\u5728\u9884\u671f\u4e4b\u5185</p>\n</li>\n<li>\n<p>\u5bf9\u4e8e Linux \u7cfb\u7edf\uff0c\u867d\u7136 ext3 \u53ef\u4ee5\u6ee1\u8db3\u5404\u7c7b\u573a\u666f\uff0c\u4f46\u5e76\u4e0d\u662f\u6700\u4f73\u9009\u62e9\u3002\u867d\u7136 XFS \u548c ext4 \u8fd8\u6ca1\u6709\u8fbe\u5230\u4ea7\u54c1\u7ea7\u8d28\u91cf\uff0c\u4f46\u662f\u4ed6\u4eec\u5e94\u8be5\u5f88\u5feb\u53ef\u4ee5\u66ff\u4ee3 ext3(\u6211\u89c9\u5f97 ext4 \u5df2\u7ecf\u5f88\u7a33\u5b9a\u4e86\u5440\uff09</p>\n</li>\n<li>\n<p>Solaris \u548c FreeBSD \u90fd\u62e5\u6709\u8001\u7684 UFS \u6587\u4ef6\u7cfb\u7edf\u548c\u66f4\u65b0\u7684 ZFS \u6587\u4ef6\u7cfb\u7edf\u3002ZFS \u7684\u4e00\u4e9b\u7279\u6027\u4f7f\u5f97\u5b83\u79f0\u4e3a\u5927\u6570\u636e\u7684\u552f\u4e00\u5408\u9002\u9009\u62e9</p>\n</li>\n<li>\n<p>Windows \u5e73\u53f0\u7684 NTFS \u501f\u9274\u4e86\u5f88\u591a\u57fa\u4e8e UNIX \u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u6027\uff0c\u4f7f\u5f97\u5176\u79f0\u4e3a\u53ef\u4fe1\u8d56\u7684\u6587\u4ef6\u7cfb\u7edf</p>\n</li>\n<li>\n<p>\u63d0\u9ad8\u9884\u8bfb(read-ahead)\u503c\uff0c\u7981\u6b62\u66f4\u65b0\u6587\u4ef6\u8bbf\u95ee\u65f6\u95f4\u6233\uff0c\u8c03\u6574\u7528\u4e8e cache \u7684\u5185\u5b58\u6570\u91cf\uff0c\u8fd9\u4e9b\u6280\u5de7\u90fd\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd</p>\n</li>\n<li>\n<p>PostgreSQL \u5141\u8bb8\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u548c\u521b\u5efa\u8868\u7a7a\u95f4\u6765\u91cd\u65b0\u5206\u914d\u6570\u636e\u67d0\u4e9b\u90e8\u4ef6\u7684\u8def\u5f84\u3002</p>\n</li>\n</ul>\n<h2 id=\"_16\">\u7528\u4e8e\u6570\u636e\u5e93\u7f13\u5b58\u7684\u5185\u5b58<a class=\"headerlink\" href=\"#_16\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u7ae0\u4e3b\u8981\u662f\u8ba8\u8bba shared_buffers \u53c2\u6570\u8bbe\u7f6e\u7684\u5185\u5b58\u662f\u5982\u4f55\u4f7f\u7528\u7684\uff0c\u901a\u8fc7\u76d1\u63a7\u548c\u4f18\u5316\u6765\u8fd9\u90e8\u5206\u5185\u5b58\u6765\u83b7\u5f97\u9ad8\u6027\u80fd\uff0c\u8fd9\u4e5f\u662f PostgreSQL \u91cc\u6700\u91cd\u8981\u7684\u6027\u80fd\u53c2\u6570\u3002\\</p>\n<h3 id=\"postgresqlconf\">postgresql.conf \u91cc\u7684\u5185\u5b58\u5355\u5143<a class=\"headerlink\" href=\"#postgresqlconf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e9\u671f\u7684 PostgreSQL \u7248\u672c\uff0cpostgresql.conf \u6587\u4ef6\u91cc\u7684\u5173\u4e8e\u5185\u5b58\u7684\u8bbe\u7f6e\u53c2\u6570\u7684\u8bbe\u7f6e\uff0c\u4f60\u9700\u8981\u77e5\u9053\u6bcf\u4e00\u4e2a\u53c2\u6570\u7684\u5355\u4f4d\u3002\u6709\u7684\u53ef\u80fd\u662f 1KB\uff0c\u6709\u7684\u53ef\u80fd\u662f 8KB\u3002\\\n\u4ece PostgreSQL\n8.2 \u4ee5\u540e\uff0c\u5173\u4e8e\u5185\u5b58\u6570\u503c\u7684\u8bbe\u7f6e\u5c31\u7b80\u5316\u4e86\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u5e26\u5355\u4f4d\u7684\u6570\u503c\uff0c\u6bd4\u5982\u5047\u5b9a\u4f60\u8bbe\u7f6e\u4e0b\u9762\u7684\u53c2\u6570\uff1a\\\n<code>wal_buffers = 64KB</code>\\\n\u4f60\u767b\u9646\u6570\u636e\u5e93\uff0c\u901a\u8fc7 show \u6307\u4ee4\uff0c\u53ef\u4ee5\u770b\u5230 wal_buffers \u7684\u5927\u5c0f\u5c31\u662f\u4f60\u6240\u8bbe\u7f6e\u7684\u53c2\u6570\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">wgzhao</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">wal_buffers</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"n\">wal_buffers</span>\n<span class=\"c1\">-------------</span>\n<span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"n\">kB</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4e0d\u8fc7 PostgreSQL \u5185\u90e8\u8fd8\u662f\u4f1a\u628a\u53c2\u6570\u503c\u8f6c\u5316\u4e3a\u5b83\u81ea\u5df1\u5185\u90e8\u5355\u4f4d\uff0c\u6bd4\u5982 wal_buffers \u7684\u5185\u90e8\u5355\u4f4d\u662f\u5757\u5927\u5c0f(8k)\uff0c\u56e0\u6b64\uff0c\u5728 PostgreSQL \u770b\u6765\uff0cwal_buffers \u7684\u503c\u5176\u5b9e\u662f 8\u3002\n\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u8bc1\u5b9e\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">wgzhao</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">setting</span><span class=\"p\">,</span><span class=\"n\">unit</span><span class=\"p\">,</span><span class=\"n\">current_setting</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_settings</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;wal_buffers&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">setting</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">current_setting</span>\n<span class=\"c1\">-------------+---------+------+-----------------</span>\n<span class=\"w\"> </span><span class=\"n\">wal_buffers</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"n\">kB</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<h3 id=\"unix\">\u4e3a\u5927\u7f13\u5b58\u589e\u52a0 UNIX \u5171\u4eab\u5185\u5b58\u53c2\u6570\u503c<a class=\"headerlink\" href=\"#unix\" title=\"Permanent link\">&para;</a></h3>\n<p>initdb \u9ed8\u8ba4\u8bbe\u7f6e\u7684 shared_buffers \u4e00\u822c\u90fd\u5f88\u5c0f\uff0c\u8fd9\u662f\u8003\u8651\u5230 initdb \u9700\u8981\u5728\u5404\u79cd\u5e73\u53f0\u4fdd\u8bc1\u6267\u884c\u6210\u529f\uff0c\u800c\u5f88\u591a UNIX \u7cfb\u7edf\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5141\u8bb8\u5206\u914d\u7684\u5185\u5b58\u90fd\u5f88\u5c0f\uff0c\u4e00\u822c\u4e0d\u8d85\u8fc7 32MB\u3002\n\u6240\u4ee5 initdb \u6240\u8bbe\u7f6e\u7684 shared_buffers \u4e0d\u9002\u5408\u4efb\u4f55\u573a\u666f\uff0c\u5b83\u4ec5\u4ec5\u53ea\u662f\u4fdd\u8bc1\u6267\u884c\u6210\u529f\uff0c\u4ee5\u53ca\u6570\u636e\u5e93\u670d\u52a1\u80fd\u591f\u542f\u52a8\u3002\\\n<a href=\"http://www.postgresql.org/docs/current/static/server-start.html\">\u8fd9\u7bc7\u6587\u7ae0</a>\u91cc\u63cf\u8ff0\u4e86\u5404\u79cd\u4e8e\u5171\u4eab\u5185\u5b58\u76f8\u5173\u542f\u52a8\u9519\u8bef\u4fe1\u606f\uff0c\u5176\u4e2d\u4e00\u79cd\u53ef\u80fd\u7684\u9519\u8bef\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837:</p>\n<div class=\"highlight\"><pre><span></span><code>FATAL: could not create shared memory segment: Invalid argument\nDETAIL: Failed system call was shmget(key=5440001, size=4011376640, 03600)\n</code></pre></div>\n<p><a href=\"http://www.postgresql.org/ docs/current/static/kernel-resources.html\">\u8fd9\u7bc7\u6587\u6863</a>\u63cf\u8ff0\u4e86\u7edd\u5927\u90e8\u5206\u7cfb\u7edf\u4e0a\u5982\u4f55\u8c03\u6574\u548c shared_buffers \u76f8\u5173\u7684\u5185\u6838\u53c2\u6570.\\\n\u5bf9\u4e8e\u652f\u6301 getconf \u6307\u4ee4\u7684 UNIX \u7cfb\u7edf\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u4e00\u4e2a\u811a\u672c\uff08\u5047\u8bbe\u540d\u4e3a*shmsetup.sh*)\u6765\u63d0\u9ad8\u53ef\u5206\u914d\u5185\u5b58\u7684\u5927\u5c0f.\\</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"ch\">#!/bin/bash</span>\n<span class=\"c1\">## simple shmsetup script</span>\n<span class=\"nv\">page_size</span><span class=\"o\">=</span><span class=\"sb\">`</span>getconf<span class=\"w\"> </span>PAGE_SIZE<span class=\"sb\">`</span>\n<span class=\"nv\">phys_pages</span><span class=\"o\">=</span><span class=\"sb\">`</span>getconf<span class=\"w\"> </span>_PHYS_PAGES<span class=\"sb\">`</span>\n<span class=\"nv\">shmall</span><span class=\"o\">=</span><span class=\"sb\">`</span>expr<span class=\"w\"> </span><span class=\"nv\">$phys_pages</span><span class=\"w\"> </span>/<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"sb\">`</span>\n<span class=\"nv\">shmmax</span><span class=\"o\">=</span><span class=\"sb\">`</span>expr<span class=\"w\"> </span><span class=\"nv\">$shmall</span><span class=\"w\"> </span><span class=\"se\">\\*</span><span class=\"w\"> </span><span class=\"nv\">$page_size</span><span class=\"sb\">`</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>kernel.shmmax<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nv\">$shmmax</span>\n<span class=\"nb\">echo</span><span class=\"w\"> </span>kernel.shmall<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"nv\">$shmall</span>\n</code></pre></div>\n<p>\u8be5\u811a\u672c\u8bbe\u7f6e\u6700\u5927\u5171\u4eab\u5757\u5927\u5c0f\u4e3a\u7269\u7406\u5185\u5b58\u7684\u4e00\u534a\u3002\u5bf9\u4e8e Linux \u7cfb\u7edf\uff0c\u6211\u4eec\u628a\u4e0a\u8ff0\u811a\u672c\u7684\u8f93\u51fa\u5199\u5165/etc/sysctl.conf\\\n<code>$ sudo ./shmsetup.sh &gt;&gt;/etc/sysctl.conf</code></p>\n<h3 id=\"_17\">\u5185\u6838\u4fe1\u53f7\u91cf<a class=\"headerlink\" href=\"#_17\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86\u5171\u4eab\u5185\u5b58\u5916\uff0c\u53e6\u5916\u4e00\u4e2a\u9700\u8981\u8c03\u6574\u7684\u53c2\u6570\u662f\u7cfb\u7edf\u53ef\u6709\u6548\u4f7f\u7528\u7684\u4fe1\u53f7\u91cf\u6570\u3002\u7f3a\u7701\u7684 Linux \u7cfb\u7edf\u770b\u4e0a\u53bb\u5927\u6982\u662f\u8fd9\u4e2a\u6837\u5b50\uff1a\\</p>\n<div class=\"highlight\"><pre><span></span><code>$ ipcs -l\n...\n------ Semaphore Limits --------\nmax number of arrays = 128\nmax semaphores per array = 250\nmax semaphores system wide = 32000\nmax ops per semop call = 32\nsemaphore max value = 32767\n\n...\n</code></pre></div>\n<p>\u901a\u8fc7\u67e5\u8be2 kernel.sem \u53c2\u6570\u4e5f\u80fd\u83b7\u5f97\u4e0a\u8ff0\u503c\uff0c\u6bd4\u5982\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">## sysctl kernel.sem</span>\nkernel.sem<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">250</span><span class=\"w\"> </span><span class=\"m\">32000</span><span class=\"w\"> </span><span class=\"m\">32</span><span class=\"w\"> </span><span class=\"m\">128</span>\n</code></pre></div>\n<h3 id=\"_18\">\u8bc4\u4f30\u5171\u4eab\u5185\u5b58\u5206\u914d<a class=\"headerlink\" href=\"#_18\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u9884\u6d4b PostgreSQL \u9700\u8981\u4f7f\u7528\u591a\u5c11\u5185\u5b58\uff0c<a href=\"http://www.postgresql.org/docs/current/static/kernel-resources.html\">\u8fd9\u7bc7\u6587\u6863</a>\n\u7ed3\u5c3e\u5904\u7684\u4e00\u4e2a\u8868\u683c\u7ed9\u51fa\u4e86\u4e00\u4e2a\u5927\u81f4\u7684\u5185\u5b58\u6d88\u8017\u8bc4\u4f30\u8868\uff0c\u6458\u5f55\u5982\u4e0b\uff1a\\</p>\n<p>\u7528\u9014 \u5927\u81f4\u9700\u8981\u7684\u5185\u5b58(v8.3)</p>\n<hr />\n<p>Connections (1800 + 270 * max_locks_per_transaction) * max_connections\nAutovacuum workers (1800 + 270 * max_locks_per_transaction) * autovacuum_max_works\nPrepared transactions (770 + 270 * max_locks_per_transaction) * max_prepared_transactions\nShared disk buffers (block_size + 208) * shared_buffers\nWAL buffers (wal_block_size + 8) * wal_buffers\nFixed space requirements 770 KB</p>\n<p>\\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPostgreSQL \u8bbe\u7f6e\u7684\u4e0a\u8ff0\u53c2\u6570\u5927\u81f4\u662f\uff1a\\</p>\n<p>\u53c2\u6570 \u7f3a\u7701\u503c</p>\n<hr />\n<p>max_locks_per_transaction 64<br />\n max_connections 100<br />\n autovacuum_max_works 3<br />\n max_prepared_transactions 0<br />\n block_size 8192<br />\n wal_block_size 8192<br />\n wal_buffers 8</p>\n<p>\\\n\u901a\u8fc7\u8fd9\u4e9b\u53c2\u6570\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7b80\u5316\u7b2c\u4e00\u4e2a\u8868\u683c\u7684\u7ed3\u679c\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a\\</p>\n<p>\u7528\u9014 \u5927\u81f4\u5185\u5b58</p>\n<hr />\n<p>Connections + AV workers 1.9MB<br />\n Shared disk buffers 8400 * shared_buffers<br />\n WAL buffers 64 KB<br />\n Fixed space requirements 770 KB</p>\n<h3 id=\"_19\">\u68c0\u9a8c\u6570\u636e\u5e93\u7f13\u5b58<a class=\"headerlink\" href=\"#_19\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 pg_buffercache \u6a21\u5757\u6765\u68c0\u9a8c shared_buffers \u8bbe\u7f6e\u7684\u7f13\u5b58\u91cc\u4fdd\u5b58\u7684\u5185\u5bb9\u3002\n\u6709\u5173 pg_buffercache \u7684\u4ecb\u7ecd\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u94fe\u63a5\uff1a<a href=\"http://www.postgresql.org/docs/current/static/pgbuffercache.html\">http://www.postgresql.org/docs/current/static/pgbuffercache.html</a>\\\n\u4e00\u65e6\u5b89\u88c5\u4e86 pg_buffercache \u6a21\u5757\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u5f53\u6570\u636e\u5e93\u6d3b\u52a8\u65f6\uff0c\u5185\u5b58\u91cc\u7684\u5757\u662f\u5982\u4f55\u6539\u53d8\u7684\u3002\u8fd9\u662f\u7406\u89e3\u6570\u636e\u5e93\u76f8\u5173\u5de5\u4f5c\u539f\u7406\u7684\u6700\u4f73\u65b9\u6cd5\u3002\n\u5728\u751f\u4ea7\u670d\u52a1\u5668\u4e0a\uff0c\u4e5f\u8bb8 pg_buffercache \u6a21\u5757\u4e0d\u4f1a\u663e\u5f97\u81f3\u5173\u91cd\u8981\uff0c\u4f46\u662f\u5bf9\u4e8e\u6211\u4eec\u5b66\u4e60\u6570\u636e\u5e93\u5982\u4f55\u5229\u7528\u5171\u4eab\u5185\u5b58\u662f\u6709\u6781\u5927\u5e2e\u52a9\u7684\u3002</p>\n<h3 id=\"pg_buffercache\">\u5b89\u88c5 pg_buffercache \u6a21\u5757<a class=\"headerlink\" href=\"#pg_buffercache\" title=\"Permanent link\">&para;</a></h3>\n<p>pg_buffercache \u7531 C \u8bed\u8a00\u7f16\u5199\u7684\u52a8\u6001\u5e93\u548c\u4e00\u7ec4 sql \u8bed\u53e5\u7ec4\u6210\u3002\u5bf9\u6bcf\u4e2a\u4f60\u9700\u8981\u89c2\u5bdf\u7684\u6570\u636e\u5e93\uff0c\u90fd\u9700\u8981\u5b89\u88c5\u8be5\u6a21\u5757(\u5bfc\u5165\u5176 sql \u8bed\u53e5)\u3002\u65b9\u6cd5\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">createdb</span><span class=\"w\"> </span><span class=\"n\">pgbench</span>\n<span class=\"n\">psql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">pgbench</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"k\">share</span><span class=\"o\">/</span><span class=\"n\">postgresql</span><span class=\"o\">/</span><span class=\"n\">contrib</span><span class=\"o\">/</span><span class=\"n\">pg_buffercache</span><span class=\"p\">.</span><span class=\"k\">sql</span>\n<span class=\"k\">SET</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">VIEW</span>\n<span class=\"k\">REVOKE</span>\n<span class=\"k\">REVOKE</span>\n</code></pre></div>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2 shared_buffers \u503c\u6765\u9a8c\u8bc1 pg_buffercache \u5b89\u88c5\u6ca1\u6709\u95ee\u9898\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">setting</span><span class=\"p\">,</span><span class=\"n\">unit</span><span class=\"p\">,</span><span class=\"n\">current_setting</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_settings</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;shared_buffers&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"n\">name</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">setting</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">current_setting</span>\n<span class=\"c1\">----------------+---------+------+-----------------</span>\n<span class=\"w\"> </span><span class=\"n\">shared_buffers</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">65536</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"n\">MB</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_buffercache</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\"> </span><span class=\"mi\">65536</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u4e00\u7ae0\u7684\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u4f1a\u5229\u7528\u8be5\u6a21\u5757\u7ed9\u51fa\u4e00\u4e9b\u6709\u7528\u7684\u62a5\u8868</p>\n<h3 id=\"vs\">\u6570\u636e\u5e93\u7f13\u5b58 vs \u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58<a class=\"headerlink\" href=\"#vs\" title=\"Permanent link\">&para;</a></h3>\n<p>\u548c\u5176\u4ed6\u4f20\u7edf\u7684\u6570\u636e\u5e93\u4ea7\u54c1\u4e0d\u540c\uff0cPostgreSQL \u4e0d\u91c7\u53d6\u751a\u81f3\u4e0d\u504f\u5411\u5c06\u5185\u5b58\u7684\u5927\u90e8\u5206\u5212\u4e3a\u81ea\u5df1\u6240\u7528\u3002\u6570\u636e\u5e93\u7684\u5927\u90e8\u5206\u8bfb\u5199\u90fd\u4f7f\u7528\u4e86\u6807\u51c6\u7684\u7cfb\u7edf\u6761\u8c03\u7528\uff0c\u56e0\u6b64\u5b83\u5141\u8bb8\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f13\u5b58\u6309\u7167\u81ea\u5df1\u7684\u65b9\u5f0f\u6765\u4f7f\u7528\u3002\u5728\u67d0\u4e9b WAL \u7684\u914d\u7f6e\u4e2d\uff0c\u5982\u679c\u7ed5\u8fc7\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f13\u5b58\uff0c\u90a3\u4f1a\u662f\u4e2a\u95ee\u9898\u3002\\\n\u5982\u679c\u4f60\u4ee5\u524d\u4f7f\u7528\u7684\u6570\u636e\u5e93\u662f\u7684\u914d\u7f6e\u7b56\u7565\u662f\u628a\u7edd\u5927\u90e8\u5206\u5185\u5b58\u5212\u7ed9\u6570\u636e\u5e93\uff0c\u4e14\u6570\u636e\u5e93\u7684\u8bfb\u5199\u64cd\u4f5c\u901a\u8fc7\u540c\u6b65(synchronouse)\u6216\u76f4\u63a5 IO(direct-io)\u65b9\u5f0f\u7ed5\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u3002\u90a3\u4e48\u8fd9\u79cd\u7b56\u7565\u4e0d\u8981\u7528\u5728 PostgreSQL \u4e0a\u3002</p>\n<h3 id=\"_20\">\u91cd\u590d\u7684\u7f13\u5b58\u6570\u636e<a class=\"headerlink\" href=\"#_20\" title=\"Permanent link\">&para;</a></h3>\n<p>shared_buffers \u4e0d\u8981\u8bbe\u7f6e\u5f97\u592a\u5927\u7684\u5176\u4e2d\u4e00\u4e2a\u539f\u56e0\u662f\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u4e5f\u88ab\u7528\u4e8e\u8bfb\u5199\u64cd\u4f5c\uff0c\u6781\u7aef\u7684\u60c5\u51b5\u4e0b\uff0c\u4e24\u8005\u7684\u6570\u636e\u6709\u53ef\u80fd\u91cd\u53e0\u800c\u5bfc\u81f4\u6d6a\u8d39\u3002\\\n\u6bd4\u5982\uff0c\u5f53\u4f60\u53d1\u8d77\u4e00\u4e2a\u5b8c\u5168\u65b0\u7684\u8bf7\u6c42\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u670d\u52a1\u9700\u8981\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u5757\uff0c\u8fd9\u4e9b\u5757\u9996\u5148\u4f1a\u8fdb\u5165\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\uff0c\u7136\u540e\u62f7\u8d1d\u5230\u6570\u636e\u5e93\u7f13\u5b58\u3002\u867d\u7136\u6700\u7ec8\uff0c\u8fd9\u4e9b\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u90fd\u4f1a\u88ab\u5237\u51fa\u53bb\uff0c\u4f46\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\uff0c\u5b83\u5728\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u548c\u6570\u636e\u5e93\u7f13\u5b58\u4e2d\u90fd\u5b58\u5728\uff0c\u56e0\u6b64\u8bbe\u7f6e shared_buffers \u4e00\u4e2a\u6070\u5f53\u7684\u503c\u53ef\u4ee5\u51cf\u5c11\u91cd\u590d\u6570\u636e\u7684\u6570\u91cf\u3002</p>\n<h3 id=\"shared_buffers\">shared_buffers \u7684\u8d77\u70b9\u8bbe\u7f6e<a class=\"headerlink\" href=\"#shared_buffers\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bbe\u5b9a\u4e00\u4e2a\u597d\u7684 shared_buffers \u503c\u5f88\u96be\uff0c\u901a\u5e38\u6211\u4eec\u90fd\u4f1a\u8bf4\u4e00\u4e2a\u76f8\u5bf9\u5185\u5b58\u7684\u6bd4\u7387\u3002\u6709\u90e8\u5206\u4eba\u4e3b\u5f20\u4ec5\u4f7f\u7528\u5185\u5b58\u7684 10-15%\u3002\u8bba\u6587<a href=\"http://www.cs.duke.edu/~shivnath/papers/ituned.pdf\">Tuning\nDatabase Configuration Parameters with\niTuned</a>\u975e\u5e38\u8be6\u5c3d\u7684\u7ed9\u51fa\u4e86\u4e00\u4e2a\u6709\u5173\u8be5\u503c\u7684\u5b66\u672f\u89e3\u91ca\u3002\u8fd9\u7247\u6587\u6863\u63d0\u5230\u4ed6\u4eec\u5728\u4e00\u53f0 1G \u5185\u5b58\u7684\u673a\u5668\u4e0a\uff0c\u53d1\u73b0\u8bbe\u7f6e shared_buffers \u8bbe\u7f6e\u4e3a\u5185\u5b58\u7684 40%\u4e3a\u5176\u6700\u4f73\u503c\uff0c\u5e76\u636e\u6b64\u8fdb\u884c\u4e86\u975e\u5e38\u5e7f\u6cdb\u7684\u67e5\u8be2\u6d4b\u8bd5\u3002\\\n\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u670d\u52a1\u5668\u4e0a OS \u5bf9\u5185\u5b58\u5f00\u9500\u5f88\u5c0f\uff0c\u90a3\u4e48 shared_buffers \u8bbe\u7f6e\u4e3a\u5185\u5b58\u7684 25%\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u8d77\u70b9\uff0c\u867d\u7136\u4e0d\u662f\u6700\u4f73\u8bbe\u7f6e\uff0c\u4f46\u662f\u4e00\u65b9\u9762\u5b83\u53ef\u4ee5\u6709\u6548\u51cf\u5c11\u91cd\u590d\u7684\u7f13\u5b58\u6570\u636e\uff0c\u53e6\u5916\u4e00\u65b9\u9762\uff0c\u5b83\u4e5f\u6bd4\u7f3a\u7701\u8bbe\u7f6e\u503c\u8981\u9ad8\u5f88\u9ad8\uff0c\u76f8\u6bd4\u6548\u7387\u4e5f\u6709\u8f83\u5927\u63d0\u5347\u3002</p>\n<h3 id=\"_21\">\u7f13\u5b58\u67e5\u8be2\u68c0\u6d4b<a class=\"headerlink\" href=\"#_21\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u7528\u4e00\u4e2a\u5b9e\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u5229\u7528 pg_buffercache \u6765\u6a21\u5757\u6765\u68c0\u6d4b\u7f13\u5b58\u7684\u4f7f\u7528\n\u6211\u4eec\u8bbe\u7f6e shared_buffers\n\u4e3a 512M\uff0c\u7136\u540e\u4f7f\u7528 pgbench \u521b\u5efa\u4e00\u4e2a\u6bd4\u4f8b\u4e3a 50 \u7684\u6570\u636e\u5e93\uff0c\u5176\u76ee\u7684\u662f\u6570\u636e\u5e93\u5927\u5c0f\u8d85\u8fc7 shared_buffers \u7684\u503c\uff0c\u4ee5\u514d\u6240\u6709\u7684\u67e5\u8be2\u6570\u636e\u90fd\u80fd\u7f13\u5b58\u5230\u5185\u5b58\u91cc\u3002\\</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">pgbench</span>\n<span class=\"n\">psql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">hlocalhost</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"ss\">&quot;select pg_size_pretty(pg_database_size(&#39;pgbench&#39;)) as db_size&quot;</span>\n\n<span class=\"o\">-</span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">]</span><span class=\"c1\">---</span>\n<span class=\"n\">db_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">754</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n\n<span class=\"n\">pgbench</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"mi\">25000</span><span class=\"w\"> </span><span class=\"n\">pgbench</span>\n<span class=\"n\">starting</span><span class=\"w\"> </span><span class=\"k\">vacuum</span><span class=\"p\">...</span><span class=\"k\">end</span><span class=\"p\">.</span>\n\n<span class=\"k\">transaction</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">only</span>\n<span class=\"n\">scaling</span><span class=\"w\"> </span><span class=\"n\">factor</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">50</span>\n<span class=\"n\">query</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">simple</span>\n<span class=\"nb\">number</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">clients</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"nb\">number</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"nb\">number</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">transactions</span><span class=\"w\"> </span><span class=\"n\">per</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">25000</span>\n<span class=\"nb\">number</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">transactions</span><span class=\"w\"> </span><span class=\"n\">actually</span><span class=\"w\"> </span><span class=\"n\">processed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">200000</span><span class=\"o\">/</span><span class=\"mi\">200000</span>\n<span class=\"n\">tps</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">540</span><span class=\"p\">.</span><span class=\"mi\">590358</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">including</span><span class=\"w\"> </span><span class=\"n\">connections</span><span class=\"w\"> </span><span class=\"n\">establishing</span><span class=\"p\">)</span>\n<span class=\"n\">tps</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">540</span><span class=\"p\">.</span><span class=\"mi\">624004</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">excluding</span><span class=\"w\"> </span><span class=\"n\">connections</span><span class=\"w\"> </span><span class=\"n\">establishing</span><span class=\"p\">)</span>\n</code></pre></div>\n<h4 id=\"_22\">\u7f13\u5b58\u91cc\u7684\u6700\u5927\u8868<a class=\"headerlink\" href=\"#_22\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u7684 SQL \u8bed\u53e5\u6765\u67e5\u8be2\u5728\u7f13\u5b58\u4e2d\u7684\u524d 10 \u4e2a\u8868\u662f\u54ea\u4e9b</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span>\n<span class=\"w\">  </span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_class</span><span class=\"w\"> </span><span class=\"k\">c</span>\n<span class=\"w\">  </span><span class=\"k\">INNER</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_buffercache</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">.</span><span class=\"n\">relfilenode</span><span class=\"o\">=</span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relfilenode</span>\n<span class=\"w\">  </span><span class=\"k\">INNER</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_database</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">.</span><span class=\"n\">reldatabase</span><span class=\"o\">=</span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"w\"> </span><span class=\"k\">AND</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">datname</span><span class=\"o\">=</span><span class=\"n\">current_database</span><span class=\"p\">())</span>\n<span class=\"k\">GROUP</span><span class=\"w\"> </span><span class=\"k\">BY</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relname</span>\n<span class=\"k\">ORDER</span><span class=\"w\"> </span><span class=\"k\">BY</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">DESC</span>\n<span class=\"k\">LIMIT</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span>\n<span class=\"w\">             </span><span class=\"n\">relname</span><span class=\"w\">              </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">buffers</span>\n<span class=\"c1\">----------------------------------+---------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\">                 </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">51346</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">13713</span>\n<span class=\"w\"> </span><span class=\"n\">pg_depend_reference_index</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">11</span>\n<span class=\"w\"> </span><span class=\"n\">pg_depend</span><span class=\"w\">                        </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">9</span>\n<span class=\"w\"> </span><span class=\"n\">pg_rewrite</span><span class=\"w\">                       </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">5</span>\n<span class=\"w\"> </span><span class=\"n\">pg_extension</span><span class=\"w\">                     </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">5</span>\n<span class=\"w\"> </span><span class=\"n\">pg_depend_depender_index</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">5</span>\n<span class=\"w\"> </span><span class=\"n\">pg_description</span><span class=\"w\">                   </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">5</span>\n<span class=\"w\"> </span><span class=\"n\">pg_statistic</span><span class=\"w\">                     </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">4</span>\n<span class=\"w\"> </span><span class=\"n\">pg_statistic_relid_att_inh_index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">4</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u9664\u6389\u7cfb\u7edf\u8868\u4ee5\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u7f13\u5b58\u7684\u7edd\u5927\u90e8\u5206\u90fd\u7528\u5728\u4e86 pgbench_accounts \u8868\u4ee5\u53ca\u5b83\u7684\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u8fd9\u4e5f\u5e94\u8be5\u662f\u6211\u4eec\u671f\u671b\u7684\u3002</p>\n<h4 id=\"_23\">\u7f13\u5b58\u5185\u5bb9\u7edf\u8ba1<a class=\"headerlink\" href=\"#_23\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u67e5\u770b\u5230\uff0c\u76ee\u524d\u7f13\u5b58\u91cc\uff0c\u6570\u636e\u91cf\u5c45\u524d 10 \u4f4d\u7684\u5bf9\u8c61\u662f\u54ea\u4e9b\uff0c\u5360\u7528\u7f13\u5b58\u6bd4\u7387\u662f\u591a\u5c11\uff0c\u4ee5\u53ca\u76f8\u6bd4\u5bf9\u8c61\u5927\u5c0f\u7684\u6bd4\u7387\u662f\u591a\u5c11</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"k\">SELECT</span>\n<span class=\"w\">  </span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">8192</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">buffered</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">round</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">setting</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_settings</span>\n<span class=\"w\">      </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s1\">&#39;shared_buffers&#39;</span><span class=\"p\">)::</span><span class=\"nb\">integer</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">round</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">8192</span><span class=\"w\"> </span><span class=\"o\">/</span>\n<span class=\"w\">    </span><span class=\"n\">pg_relation_size</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">),</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">pct_of_rel</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_class</span><span class=\"w\"> </span><span class=\"k\">c</span>\n<span class=\"w\">  </span><span class=\"k\">INNER</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_buffercache</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">.</span><span class=\"n\">relfilenode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relfilenode</span>\n<span class=\"w\">  </span><span class=\"k\">INNER</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_database</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">.</span><span class=\"n\">reldatabase</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"w\"> </span><span class=\"k\">AND</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">datname</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">current_database</span><span class=\"p\">())</span>\n<span class=\"k\">GROUP</span><span class=\"w\"> </span><span class=\"k\">BY</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span><span class=\"k\">c</span><span class=\"p\">.</span><span class=\"n\">relname</span>\n<span class=\"k\">ORDER</span><span class=\"w\"> </span><span class=\"k\">BY</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">DESC</span>\n<span class=\"k\">LIMIT</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">relname</span><span class=\"w\">              </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"n\">buffered</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">buffers_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">pct_of_rel</span>\n<span class=\"c1\">----------------------------------+------------+------------+-------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\">                 </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">402</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">78</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">62</span><span class=\"p\">.</span><span class=\"mi\">8</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">20</span><span class=\"p\">.</span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_operator_oid_index</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_opclass_oid_index</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_namespace</span><span class=\"w\">                     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">8192</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_operator</span><span class=\"w\">                      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">78</span><span class=\"p\">.</span><span class=\"mi\">6</span>\n<span class=\"w\"> </span><span class=\"n\">pg_amproc_fam_proc_index</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">75</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_index</span><span class=\"w\">                         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_statistic_relid_att_inh_index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">pg_index_indrelid_index</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u6ce8\u610f\uff0c\u51fd\u6570 pg_relation_size()\u4e0d\u5305\u542b\u5b58\u50a8\u5728 TOAST \u8868\u4e2d\u7684\u6570\u636e\u3002\u5982\u679c\u4f60\u7684 PostgreSQL \u662f 9.0 \u4ee5\u4e0a\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 pg_table_size()\u51fd\u6570\u6765\u4ee3\u66ff\uff0c\u5b83\u5305\u542b\u4e86 TOAST \u8868\u6570\u636e\u3002</p>\n<h3 id=\"_24\">\u603b\u7ed3<a class=\"headerlink\" href=\"#_24\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e00\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u53ef\u80fd\u4f1a\u9047\u5230\u5404\u79cd\u5de5\u4f5c\u6a21\u5f0f\uff0c\u6240\u4ee5\u5f88\u96be\u6709\u4e00\u4e2a\u6b7b\u89c4\u5219\u6765\u8bf4\u6839\u636e\u786c\u4ef6\u6761\u4ef6\u5c31\u53ef\u4ee5\u914d\u7f6e\u51fa\u4f18\u5316\u7684\u53c2\u6570\u3002\\\n\u6709\u4e9b\u5e94\u7528\u7a0b\u5e8f\u504f\u5411\u628a\u5927\u90e8\u5206\u5185\u5b58\u4e13\u7528\u4e8e\u6570\u636e\u5e93\uff0c\u5e76\u4ece\u4e2d\u83b7\u5f97\u597d\u5904\uff0c\u800c\u6709\u4e9b\u5e94\u7528\u7a0b\u5e8f\u5219\u4f1a\u56e0\u4e3a\u8fd9\u6837\u7684\u914d\u7f6e\u9047\u5230 checkpoint \u5cf0\u503c\u95ee\u9898\u3002\\\nPostgreSQL\n8.3 \u4ee5\u540e\u7684\u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5de5\u5177\u5e2e\u6211\u4eec\u76d1\u63a7\u7f13\u5b58\u8fd9\u90e8\u5206\u533a\u57df\u662f\u5982\u4f55\u4f7f\u7528\u7684\uff0c\u518d\u8054\u5408\u5305\u62ec OS \u5982\u4f55\u4f7f\u7528\u7f13\u5b58\u7b49\u6280\u672f\u624b\u6bb5\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u914d\u7f6e\u51fa\u4e00\u4e2a\u9760\u8c31\u7684\u4f18\u5316\u53c2\u6570\u6765\u3002\\\n\u4e0b\u9762\u662f\u4e00\u4e2a\u9488\u5bf9\u6570\u636e\u5e93\u5185\u5b58\u4f7f\u7528\u7684\u89c4\u5219\uff1a\\</p>\n<ul>\n<li>\n<p>\u5728\u670d\u52a1\u542f\u52a8\u65f6\uff0cPostgreSQL \u5206\u522b\u4e00\u5927\u5757\u5185\u5b58\u7528\u6237\u628a\u6570\u636e\u5e93\u78c1\u76d8\u5757\u5bfc\u5165\u5185\u5b58\uff0c\u5e76\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c</p>\n</li>\n<li>\n<p>\u6570\u636e\u5e93\u7f13\u5b58\u548c\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u662f\u534f\u4f5c\u5173\u7cfb\u800c\u975e\u66ff\u4ee3\u5173\u7cfb\uff0c\u56e0\u6b64\u5176\u5927\u5c0f\u5e94\u8be5\u662f\u4e00\u4e2a\u6070\u5f53\u7684\u503c\u800c\u975e\u4e00\u5473\u7684\u6c42\u5927</p>\n</li>\n<li>\n<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5206\u914d\u7ed9\u6570\u636e\u5e93\u7684\u5171\u4eab\u5185\u5b58\u90fd\u5f88\u5c0f\uff0c\u56e0\u6b64\u9700\u8981\u8c03\u6574</p>\n</li>\n<li>\n<p>\u5d29\u6e83\u540e\u6062\u590d\u662f\u901a\u8fc7\u6539\u53d8\u6570\u636e\u5e93\u6587\u4ef6\u4e4b\u524d\u5c06\u4fee\u6539\u7684\u5185\u5bb9\u5148\u5199\u5165 WAL \u6765\u505a\u5230\u7684</p>\n</li>\n<li>\n<p>Checkpoint \u9700\u8981\u5c0f\u5fc3\u8c03\u6574\uff0c\u65e2\u8981\u9650\u5236\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u53c8\u8981\u8003\u8651\u4e0d\u5f71\u54cd\u7cfb\u7edf\u7684\u6027\u80fd</p>\n</li>\n<li>\n<p>\u7cfb\u7edf\u89c6\u56fe pg_stat_bgwriter \u8ddf\u8e2a\u6240\u6709\u7f13\u5b58\u7684\u5237\u5165\u5237\u51fa\u60c5\u51b5</p>\n</li>\n<li>\n<p>pg_buffercache\n  \u6a21\u5757\u7528\u6765\u67e5\u770b\u7f13\u5b58\u5185\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u5e76\u636e\u6b64\u5224\u65ad\u7f13\u5b58\u662f\u592a\u5927\u8fd8\u662f\u592a\u5c0f</p>\n</li>\n</ul>\n<h2 id=\"_25\">\u670d\u52a1\u5668\u914d\u7f6e\u8c03\u4f18<a class=\"headerlink\" href=\"#_25\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e00\u7ae0\u4e3b\u8981\u56f4\u7ed5$PGDATA/postgresql.conf\n\u6587\u4ef6\u91cc\u7684\u914d\u7f6e\u53c2\u6570\u5c55\u5f00\uff0c\u57fa\u672c\u4e0a\u7b97\u662f\u5bf9<a href=\"http://www.postgresql.org/docs/current/static/runtime-config.html\">http://www.postgresql.org/docs/current/static/runtime-config.html</a>\n\u4e00\u6587\u7684\u62f7\u8d1d\uff0c\u4e0d\u8fc7\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u4e00\u4e9b\u91cd\u8981\u53c2\u6570\u7684\u914d\u7f6e\u6307\u5bfc\u5927\u7eb2\uff0c\u800c\u4e0d\u662f\u4ecb\u7ecd\u6bcf\u4e2a\u53c2\u6570\u7684\u542b\u4e49\u3002</p>\n<p>\u53e6\u5916\u4e00\u4e2a\u6709\u5173\u8c03\u4f18\u7684\u5728\u7ebf\u8d44\u6e90\u662f\u5b98\u65b9 wiki \u4e0a\u7684\u4e00\u7bc7\u6587\u7ae0:<a href=\"http://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server\">Tuning Your PostgreSQL\nServer</a>\uff0c\u8fd9\u7bc7\u6587\u7ae0\u4e00\u76f4\u5728\u66f4\u65b0\u4ee5\u4fdd\u6301\u548c\u5f53\u524d\u4e3b\u6d41\u7248\u672c\u7684\u914d\u7f6e\u53c2\u6570\u4e00\u81f4\u3002</p>\n<h3 id=\"_26\">\u4fee\u6539\u53c2\u6570<a class=\"headerlink\" href=\"#_26\" title=\"Permanent link\">&para;</a></h3>\n<p>PostgreSQL \u53c2\u6570\u53ef\u4ee5\u6709\u51e0\u79cd\u4fee\u6539\u65b9\u5f0f\uff0c\u6709\u7684\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u76f4\u63a5\u4fee\u6539\uff0c\u6709\u7684\u53c2\u6570\u4fee\u6539\u540e\uff0c\u9700\u8981\u53d1\u51fa SIGHUP \u4fe1\u53f7\u4ee5\u4fbf\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\u6765\u6765\u751f\u6548\uff0c\n\u6709\u7684\u4fee\u6539\u540e\u5219\u9700\u8981\u91cd\u542f\u6570\u636e\u5e93\u670d\u52a1\u624d\u751f\u6548\uff0c\u8fd8\u6709\u4e00\u4e9b\u6839\u672c\u5c31\u4e0d\u80fd\u4fee\u6539\u3002</p>\n<p>\u5982\u679c\u786e\u5b9a\u8fd9\u4e9b\u53c2\u6570\u5c5e\u4e8e\u54ea\u79cd\u7c7b\u578b\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\u7684\u5b57\u5178\u6765\u83b7\u5f97\u76f8\u5173\u4fe1\u606f\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_settings</span><span class=\"p\">;</span>\n<span class=\"w\">              </span><span class=\"n\">name</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"n\">context</span>\n<span class=\"c1\">---------------------------------+------------</span>\n<span class=\"w\"> </span><span class=\"n\">application_name</span><span class=\"w\">                </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">user</span>\n<span class=\"w\"> </span><span class=\"n\">archive_command</span><span class=\"w\">                 </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">sighup</span>\n<span class=\"w\"> </span><span class=\"n\">archive_mode</span><span class=\"w\">                    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">postmaster</span>\n<span class=\"w\"> </span><span class=\"n\">archive_timeout</span><span class=\"w\">                 </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">sighup</span>\n<span class=\"w\"> </span><span class=\"n\">block_size</span><span class=\"w\">                      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">internal</span>\n<span class=\"w\"> </span><span class=\"n\">dynamic_library_path</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">superuser</span>\n</code></pre></div>\n<p>context \u5b57\u6bb5\u6240\u8868\u793a\u7684\u5177\u4f53\u542b\u4e49\uff0c\u5728\u5b98\u65b9\u6587\u6863\u91cc\u5e76\u6ca1\u6709\u8be6\u7ec6\u7ed9\u51fa\uff0c\u8fd9\u91cc\u6211\u4eec\u6309\u7167\u4ece\u96be\u5230\u6613\u6765\u4ecb\u7ecd\u8fd9\u4e9b\u503c\u7684\u610f\u601d:\\</p>\n<dl>\n<dt>internal</dt>\n<dd>\n<p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u90fd\u662f\u7f16\u8bd1\u65f6\u8bbe\u7f6e\u597d\u7684\uff0c\u4f60\u53ef\u4ee5\u67e5\u770b\u8fd9\u4e9b\u53c2\u6570\u7684\u503c\uff0c\u4f46\u662f\u9664\u975e\u91cd\u65b0\u7f16\u8bd1\uff0c\u5426\u5219\u65e0\u6cd5\u4fee\u6539.</p>\n</dd>\n<dt>postmaster</dt>\n<dd>\n<p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u53ea\u6709\u5b8c\u5168\u91cd\u542f\u6570\u636e\u5e93\u670d\u52a1\u624d\u80fd\u751f\u6548\uff0c\u6240\u6709\u7684\u5171\u4eab\u5185\u5b58\u8bbe\u7f6e\u53c2\u6570\u90fd\u5c5e\u4e8e\u8fd9\u7c7b.</p>\n</dd>\n<dt>sighup</dt>\n<dd>\n<p>\u7ed9\u670d\u52a1\u53d1\u9001 HUP \u4fe1\u53f7\uff0c\u4f7f\u5f97\u670d\u52a1\u53ef\u4ee5\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\uff0c\u4ece\u800c\u4f7f\u5f97\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u751f\u6548.</p>\n</dd>\n<dt>backend</dt>\n<dd>\n<p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u548c sighup \u8be6\u7ec6\uff0c\u53ea\u662f\u5b83\u4e0d\u5bf9\u5df2\u7ecf\u8fde\u63a5\u5230\u670d\u52a1\u5668\u4e0a\u7684\u4f1a\u8bdd\u751f\u6548\uff0c\u53ea\u6709\u65b0\u7684\u4f1a\u8bdd\u624d\u4f1a\u542f\u7528\u4fee\u6539\u540e\u7684\u53c2\u6570\uff0c\n\u5c5e\u4e8e\u8fd9\u7c7b\u7684\u53c2\u6570\u8f83\u5c11\uff0clog_connections \u5c5e\u4e8e\u8fd9\u7c7b</p>\n</dd>\n<dt>superuser</dt>\n<dd>\n<p>\u987e\u540d\u601d\u4e49\uff0c\u8fd9\u7c7b\u53c2\u6570\u53ea\u6709\u6570\u636e\u5e93\u8d85\u7ea7\u7528\u6237\uff08\u9ed8\u8ba4\u4e00\u822c\u662f\u521b\u5efa postgres \u6570\u636e\u5e93\u7684\u7528\u6237\uff09\u624d\u80fd\u4fee\u6539\uff0c\u8fd9\u7c7b\u53c2\u6570\u5927\u90e8\u5206\u4fee\u6539\u540e\u5373\u751f\u6548.</p>\n</dd>\n<dt>user</dt>\n<dd>\n<p>\u6bcf\u4e2a\u4f1a\u8bdd\u90fd\u53ef\u4ee5\u4fee\u6539\u7684\u53c2\u6570\uff0c\u4e14\u4e0d\u4e92\u76f8\u5f71\u54cd\uff0c\u5927\u90e8\u5206\u7684\u53c2\u6570\u90fd\u5c5e\u4e8e\u8fd9\u8fd9\u79cd\u7c7b\u578b\u3002</p>\n</dd>\n</dl>\n<p>\u5c31\u6211\u76ee\u524d\u4f7f\u7528\u7684 PostgreSQL 9.3 \u7248\u672c\u6765\u8bf4\uff0c\u5404\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u7edf\u8ba1\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_settings</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">context</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">------------+-------</span>\n<span class=\"w\"> </span><span class=\"n\">backend</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">5</span>\n<span class=\"w\"> </span><span class=\"k\">user</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">91</span>\n<span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">14</span>\n<span class=\"w\"> </span><span class=\"n\">postmaster</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">37</span>\n<span class=\"w\"> </span><span class=\"n\">superuser</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">25</span>\n<span class=\"w\"> </span><span class=\"n\">sighup</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">52</span>\n<span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u6709\u51e0\u79cd\u529e\u6cd5\u53ef\u4ee5\u8ba9\u6570\u636e\u5e93\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\uff0c\u4e00\u79cd\u662f\u4f7f\u7528\u6570\u636e\u5e93\u81ea\u5e26\u7684\u51fd\u6570\uff0c\u5c31\u50cf\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">pg_reload_conf</span><span class=\"p\">();</span>\n<span class=\"w\"> </span><span class=\"n\">pg_reload_conf</span>\n<span class=\"c1\">----------------</span>\n<span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"n\">LOG</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"n\">received</span><span class=\"w\"> </span><span class=\"n\">SIGHUP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">reloading</span><span class=\"w\"> </span><span class=\"n\">configuration</span><span class=\"w\"> </span><span class=\"n\">files</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4e00\u79cd\u662f\u76f4\u63a5\u7ed9\u6570\u636e\u5e93\u8fdb\u7a0b\u53d1\u9001 HUP \u4fe1\u53f7</p>\n<div class=\"highlight\"><pre><span></span><code>lancy-imac:~<span class=\"w\"> </span>wgzhao$<span class=\"w\"> </span>ps<span class=\"w\"> </span>-ef<span class=\"w\"> </span><span class=\"p\">|</span>grep<span class=\"w\"> </span>/usr/bin/postgres\n<span class=\"w\">  </span><span class=\"m\">501</span><span class=\"w\">  </span><span class=\"m\">2827</span><span class=\"w\">     </span><span class=\"m\">1</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">11</span>:08\u4e0a\u5348<span class=\"w\"> </span>ttys000<span class=\"w\">    </span><span class=\"m\">0</span>:00.61<span class=\"w\"> </span>/usr/bin/postgres\nlancy-imac:~<span class=\"w\"> </span>wgzhao$<span class=\"w\"> </span><span class=\"nb\">kill</span><span class=\"w\"> </span>-HUP<span class=\"w\"> </span><span class=\"m\">2827</span>\n</code></pre></div>\n<p>\u4ece\u547d\u4ee4\u884c\u6765\u770b\u4e0d\u4f1a\u6709\u4efb\u4f55\u8f93\u51fa\uff0c\u4e0d\u8fc7\u67e5\u770b\u4f60\u7684\u65e5\u5fd7\uff0c\u6216\u8005\u7ec8\u7aef\uff0c\u5e94\u8be5\u6709\u4e0b\u9762\u7c7b\u4f3c\u7684\u8bb0\u5f55\uff1a\\\n<code>LOG:  received SIGHUP, reloading configuration files</code></p>\n<p>\u6700\u540e\u4e00\u79cd\u662f\u901a\u8fc7 pg_ctl \u6307\u4ee4\u6765\u53d1\u9001 SIGHUP \u4fe1\u53f7</p>\n<div class=\"highlight\"><pre><span></span><code>pg_ctl<span class=\"w\"> </span>reload\nserver<span class=\"w\"> </span>signaled\n</code></pre></div>\n<h3 id=\"_27\">\u670d\u52a1\u7aef\u8bbe\u7f6e<a class=\"headerlink\" href=\"#_27\" title=\"Permanent link\">&para;</a></h3>\n<p>\\</p>\n<dl>\n<dt>listen_addresses</dt>\n<dd>\n<p>\u9ed8\u8ba4\u662f\u4ec5\u5141\u8bb8\u672c\u5730\u94fe\u63a5\uff0c\u4e00\u822c\u901a\u8fc7\u8bbe\u7f6e\u4e3a'*'\u6765\u5141\u8bb8\u4efb\u4f55\u94fe\u63a5</p>\n</dd>\n<dt>max_connections</dt>\n<dd>\n<p>\u4e00\u822c\u8bbe\u7f6e\u4e3a 100\uff0c\u6bcf\u8fdb\u6765\u4e00\u4e2a\u94fe\u63a5\uff0c\u90fd\u9700\u8981\u5360\u7528\u4e00\u90e8\u5206\u5171\u4eab\u5185\u5b58\uff0c\u56e0\u6b64\u5176\u6700\u5927\u503c\u548c shared_buffers \u5173\u7cfb\u5bc6\u5207\uff0c\n\u800c\u4e14\u4e5f\u6709\u5176\u4ed6\u53c2\u6570\u6709\u5173\u7cfb\uff0c\u6bd4\u5982 work_mem</p>\n</dd>\n</dl>\n<p>\\</p>\n<dl>\n<dt>shared_buffers</dt>\n<dd>\n<p>\u8fd9\u4e2a\u53c2\u6570\u5728\u6700\u540e\u4e00\u7ae0\u8be6\u7ec6\u8bb2\u89e3\uff0c\u8fd9\u662f\u4e00\u4e2a\u76f8\u5f53\u91cd\u8981\u7684\u53c2\u6570</p>\n</dd>\n<dt>FSM</dt>\n<dd>\n<p>\u8fd9\u91cc\u5305\u62ec\u4e24\u4e2a\u53c2\u6570 max_fsm_pages \u548c max_fsm_relations\uff0c\u5728\u540e\u9762\u7684\u7ae0\u8282\u4f1a\u8be6\u7ec6\u63cf\u8ff0</p>\n</dd>\n</dl>\n<p>\\</p>\n<dl>\n<dt>log_line_prefix</dt>\n<dd>\n<p>\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a\u7a7a\uff0c\u4e00\u4e2a\u8f83\u597d\u7684\u5efa\u8bae\u503c\u5982\u4e0b\uff1a\\\n <code>log_line_prefix='%t:%r:%u@%d:[%p]: '</code>\\\n \u5176\u53c2\u6570\u89e3\u91ca\u5982\u4e0b\uff1a</p>\n<dl>\n<dt>%t</dt>\n<dd>\n<p>\u65f6\u95f4\u6233</p>\n</dd>\n<dt>%u</dt>\n<dd>\n<p>\u6570\u636e\u5e93\u7528\u6237\u540d</p>\n</dd>\n<dt>%r</dt>\n<dd>\n<p>\u94fe\u63a5\u7684\u8fdc\u7a0b\u4e3b\u673a\u540d</p>\n</dd>\n<dt>%d</dt>\n<dd>\n<p>\u94fe\u63a5\u7684\u6570\u636e\u5e93\u540d</p>\n</dd>\n<dt>%p</dt>\n<dd>\n<p>\u94fe\u63a5\u7684\u8fdb\u7a0bID</p>\n</dd>\n</dl>\n</dd>\n<dt>log_statement</dt>\n<dd>\n<p>\u6709\u4e0b\u9762\u56db\u4e2a\u53ef\u9009\u503c\u6765\u8bbe\u7f6e\uff1a\\</p>\n<dl>\n<dt>none</dt>\n<dd>\n<p>\u4e0d\u8bb0\u5f55\u4efb\u4f55\u8bed\u53e5\u7ea7\u4fe1\u606f</p>\n</dd>\n<dt>ddl</dt>\n<dd>\n<p>\u4ec5\u8bb0\u5f55\u6570\u636e\u5b9a\u4e49\u8bed\u8a00(Data Definition Language a.k.a\nDDL),\u6bd4\u5982create,drop\uff0c\u5728\u751f\u4ea7\u7cfb\u7edf\u4e0a\u4e5f\u53ef\u4ee5\u4f7f\u7528\n\u8fd9\u4e2a\u53c2\u6570\uff0c\u4ed6\u8bb0\u5f55\u7684\u4fe1\u606f\u5f88\u5c11</p>\n</dd>\n<dt>mod</dt>\n<dd>\n<p>\u8bb0\u5f55\u6240\u6709\u5bf9\u503c\u6709\u4fee\u6539\u7684\u8bed\u53e5\uff0c\u57fa\u672c\u4e0a\u628a\u9664select\u8bed\u53e5\u4ee5\u5916\u7684\u8bed\u53e5\u90fd\u8bb0\u5f55\u4e86\uff0c\u91cf\u6bd4\u8f83\u5927</p>\n</dd>\n<dt>all</dt>\n<dd>\n<p>\u8bb0\u5f55\u6240\u6709\u7684\u8bed\u53e5\uff0c\u6709\u76f8\u5f53\u5927\u7684\u5f00\u9500\uff0c\u5efa\u8bae\u4ec5\u5728\u8c03\u8bd5\u65f6\u4f7f\u7528</p>\n</dd>\n</dl>\n</dd>\n<dt>log_min_duration_statement</dt>\n<dd>\n<p>\u8bb0\u5f55\u90a3\u4e9b\u6267\u884c\u65f6\u95f4\u8d85\u8fc7\u8be5\u53c2\u6570\u503c\u7684\u8bed\u53e5\uff0c\u5355\u4f4d\u662f ms\uff0c\u5982\u679c\u662f 8.4 \u4ee5\u540e\u7684\u7248\u672c\uff0c\u5efa\u8bae\u4f18\u5148\u4f7f\u7528<a href=\"http://www.postgresql.org/docs/8.4/static/auto-explain.html\">auto_explain\n\u6a21\u5757</a></p>\n</dd>\n</dl>\n<h3 id=\"_28\">\u4e13\u7528\u6570\u636e\u5e93\u670d\u52a1\u5668\u53c2\u6570\u8bbe\u7f6e<a class=\"headerlink\" href=\"#_28\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bf9\u4e8e\u4e00\u53f0\u65b0\u7684\u4e13\u7528\u4e8e\u6570\u636e\u5e93\u670d\u52a1\u7684\u8bbe\u5907\uff0c\u6211\u4eec\u5efa\u8bae\u9996\u5148\u8c03\u6574\u4ee5\u4e0b\u53c2\u6570\uff0c\u7136\u540e\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\uff0c\u518d\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8c03\u6574\uff1a</p>\n<ol>\n<li>\n<p>\u8c03\u6574\u7f3a\u7701\u7684\u65e5\u5fd7\u53c2\u6570\uff0c\u4ee5\u8bb0\u5f55\u7a0d\u591a\u4e00\u70b9\u4fe1\u606f</p>\n</li>\n<li>\n<p>shared_buffers \u8bbe\u7f6e\u4e3a\u7269\u7406\u5185\u5b58\u7684 25%\uff0c\u5f80\u4e0a\u8c03\u6574\u9700\u8981\u8003\u8651\u5230 checkpoint \u7684\u989d\u5916\u5f00\u9500</p>\n</li>\n<li>\n<p>\u8bc4\u4f30\u6700\u5927\u8fde\u63a5\u6570\uff0c\u8fd9\u662f\u4e00\u4e2a\u786c\u6027\u9650\u5236\uff0c\u4e00\u65e6\u8d85\u8fc7\u6700\u5927\u8fde\u63a5\u6570\uff0c\u5219\u4f1a\u88ab\u62d2\u7edd</p>\n</li>\n<li>\n<p>\u7528\u4e0a\u8ff0\u53c2\u6570\u542f\u52a8\u670d\u52a1\uff0c\u6ce8\u610f\u770b\u8fd8\u6709\u591a\u5c11\u5185\u5b58\u53ef\u7528\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58</p>\n</li>\n<li>\n<p>\u8c03\u6574 effective_cache_size \u4e3a shared_buffers + OS cache</p>\n</li>\n<li>\n<p>OS cache / max_connections / 2\n    \u5176\u7ed3\u679c\u8bbe\u7f6e\u4e3a work_mem \u7684\u4e0a\u9650\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4f9d\u8d56\u4e8e\u6392\u5e8f\u6027\u80fd\uff0c\u53ef\u8bbe\u7f6e\u5f97\u66f4\u5c0f</p>\n</li>\n<li>\n<p>maintenance_work_mem \u8bbe\u7f6e\u4e3a\u6bcf GB \u5185\u5b58 50MB</p>\n</li>\n<li>\n<p>checkpoint_segments \u4e0d\u5c0f\u4e8e 10\uff0c\u5982\u679c\u4f60\u670d\u52a1\u5668\u786c\u4ef6\u5177\u6709 BBWC(Battery-backed\n    write cache)\u529f\u80fd\uff0c\u8bbe\u7f6e\u4e3a 32 \u4f1a\u66f4\u597d</p>\n</li>\n<li>\n<p>\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u5bf9 wal_sync_method \u7684\u7f3a\u7701\u8bbe\u7f6e\u65b9\u5f0f\u4e0d\u5b89\u5168\uff0c\u66f4\u6362\u5b89\u5168\u7684\u53c2\u6570\uff0c\u4e00\u822c\u90fd\u4e0d\u9700\u8981\u4fee\u6539</p>\n</li>\n<li>\n<p>\u4fee\u6539 wal_bufffers \u4e3a 16MB</p>\n</li>\n</ol>\n<h3 id=\"_29\">\u603b\u7ed3<a class=\"headerlink\" href=\"#_29\" title=\"Permanent link\">&para;</a></h3>\n<p>PostgreSQL \u91cc\u53ef\u4ee5\u8c03\u6574\u7684\u53c2\u6570\u5dee\u4e0d\u591a\u6709 200 \u4e2a\uff0c\u9488\u5bf9\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u60f3\u628a\u8fd9\u4e9b\u53c2\u6570\u90fd\u8bbe\u7f6e\u4e3a\u6700\u4f73\u51e0\u4e4e\u662f\u4e00\u4ef6\u4e0d\u53ef\u80fd\u7684\u4efb\u52a1\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7684\u6307\u5357\n\u4e5f\u53ea\u662f\u4e00\u4e2a\u901a\u5e38\u7684\u8003\u8651\uff0c\u4ee5\u907f\u514d\u5e38\u89c1\u7684\u74f6\u9888\u3002</p>\n<ul>\n<li>\n<p>\u670d\u52a1\u5668\u7684\u7f3a\u7701\u914d\u7f6e\u53c2\u6570\u4f7f\u7528\u975e\u5e38\u5c11\u7684\u5185\u5b58\u4ee5\u53ca\u8bb0\u5f55\u5f88\u5c11\u7684\u4fe1\u606f\uff0c\u8fd9\u4e24\u70b9\u662f\u5fc5\u987b\u8981\u8c03\u6574\u7684</p>\n</li>\n<li>\n<p>\u4e0e\u5185\u5b58\u6709\u5173\u7684\u8c03\u6574\u4e3b\u8981\u662f shared_buffers \u548c work_mem\uff0c\u4ed4\u7ec6\u8c03\u6574\uff0c\u4e3b\u8981\u4e0d\u8981\u51fa\u73b0 OOM(Out\n  of memory)\u73b0\u8c61</p>\n</li>\n<li>\n<p>\u67e5\u8be2\u8ba1\u5212\u9700\u8981\u77e5\u9053\u5185\u5b58\u72b6\u6001\uff0c\u6709\u597d\u7684\u8868\u4fe1\u606f\u7edf\u8ba1\u6709\u52a9\u4e8e\u67e5\u8be2\u8ba1\u5212\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad</p>\n</li>\n<li>\n<p>autovacuum \u8fdb\u7a0b\u5f88\u5173\u952e\uff0c\u5b83\u786e\u4fdd\u67e5\u8be2\u8ba1\u5212\u80fd\u83b7\u5f97\u6b63\u786e\u7684\u4fe1\u606f</p>\n</li>\n<li>\n<p>\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u53c2\u6570\u7684\u8c03\u6574\u90fd\u4e0d\u9700\u8981\u91cd\u542f\u670d\u52a1\uff0c\u5f88\u591a\u53c2\u6570\u4fee\u6539\u540e\u76f4\u63a5\u751f\u6548</p>\n</li>\n</ul>\n<h2 id=\"_30\">\u4f8b\u884c\u7ef4\u62a4<a class=\"headerlink\" href=\"#_30\" title=\"Permanent link\">&para;</a></h2>\n<h2 id=\"_31\">\u6570\u636e\u5e93\u6027\u80fd\u6d4b\u8bd5<a class=\"headerlink\" href=\"#_31\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e00\u7ae0\u4e3b\u8981\u8ba8\u8bba PostgreSQL \u81ea\u5e26\u7684 pgbench \u7684\u4f7f\u7528</p>\n<h3 id=\"pgbench\">pgbench \u7f3a\u7701\u6d4b\u8bd5<a class=\"headerlink\" href=\"#pgbench\" title=\"Permanent link\">&para;</a></h3>\n<p>pgbench \u6700\u5f00\u59cb\u662f\u9762\u5411 TPC \u6d4b\u8bd5\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u6d4b\u8bd5<a href=\"http://www.tpc.org/tpcb/\">TPC-B</a>\uff0c1990 \u5e74\u5f00\u59cb\u5f00\u53d1\uff0c\u5176\u6a21\u578b\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u94f6\u884c\n\u5e94\u7528\u7a0b\u5e8f\uff0c\u5305\u62ec\u652f\u884c\u3001\u67dc\u5458\u548c\u8d26\u6237\u7b49\u4fe1\u606f\u3002\\\n\u5176\u4e3b\u8981\u7684\u8868\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"p\">(</span><span class=\"n\">bid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bbalance</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filler</span>\n<span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">88</span><span class=\"p\">));</span>\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bid</span><span class=\"p\">);</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"n\">bid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tbalance</span>\n<span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">filler</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">84</span><span class=\"p\">));</span>\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"p\">);</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"p\">(</span><span class=\"n\">aid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"n\">bid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">abalance</span>\n<span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">filler</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">84</span><span class=\"p\">));</span>\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">aid</span><span class=\"p\">);</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pgbench_history</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">bid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">aid</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">delta</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mtime</span>\n<span class=\"k\">timestamp</span><span class=\"p\">,</span><span class=\"n\">filler</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">22</span><span class=\"p\">));</span>\n</code></pre></div>\n<h3 id=\"_32\">\u89c4\u6a21\u68c0\u6d4b<a class=\"headerlink\" href=\"#_32\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6a21\u578b\u4e2d\uff0c\u652f\u884c\u7684\u6570\u91cf\u88ab\u79f0\u4e3a\u6570\u636e\u5e93\u89c4\u6a21\uff0c\u6bcf\u4e2a\u652f\u884c\u5305\u62ec 10 \u4e2a\u67dc\u5458\u548c 100,000 \u4e2a\u8d26\u6237\uff0c\u521d\u59cb\u5316\u6570\u636e\u5e93\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u53c2\u6570\u6765\u8bbe\u5b9a\u6570\u636e\u5e93\u7684\u89c4\u6a21\uff0c\u6bd4\u5982:</p>\n<div class=\"highlight\"><pre><span></span><code>    $ createdb pgbench\n    $ pgbench -i -s 10 pgbench\n</code></pre></div>\n<p>\u4e0a\u8ff0\u6307\u4ee4\u8868\u793a\u7528 10 \u4e2a\u652f\u884c\u7684\u6570\u636e\u5e93\u89c4\u6a21\u586b\u5145\u6570\u636e\u5e93 pgbench\uff0c\u8fd0\u884c\u6d4b\u8bd5\u65f6\uff0c\u5982\u679c\u6267\u884c-s \u7684\u53c2\u6570\uff0c\u5219 pgbench \u91c7\u7eb3\u8fd9\u4e2a\u53c2\u6570\uff0c\u5982\u679c\u6ca1\u6709\u63d0\u4f9b\uff0c\u5219\u901a\u8fc7\u4e0b\u9762\u7684 SQL \u6307\u4ee4\u731c\u6d4b\u6570\u636e\u5e93\u89c4\u6a21:\n/select count(*) from pgbench_branches;/</p>\n<h3 id=\"_33\">\u67e5\u8be2\u811a\u672c\u5b9a\u4e49<a class=\"headerlink\" href=\"#_33\" title=\"Permanent link\">&para;</a></h3>\n<p>pgbench \u5185\u5efa\u7684\u6807\u51c6\u6d4b\u8bd5\u6240\u9700\u8981\u7684\u811a\u672c\u548c SQL \u8bed\u53e5\u76f4\u63a5\u7f16\u8bd1\u8fdb\u4e86\u7a0b\u5e8f\u4e2d\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9a\u5236\u81ea\u5df1\u9700\u8981\u6d4b\u8bd5\u7684\u811a\u672c\uff0c\u5176\u8be6\u7ec6\u60c5\u51b5\uff0c\u53ef\u4ee5\u53c2\u8003<a href=\"http://www.postgresql.org/docs/current/static/pgbench.html\">\u5bf9\u5e94\u7684\u6587\u6863</a>\\\n\u7f3a\u7701\u7684\u4ea4\u6613\u811a\u672c\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\"TPC-B\"\u4ea4\u6613\uff0c\u5927\u81f4\u7c7b\u4f3c\u4e0b\u9762\u7684\u8bed\u53e5\u7ec4\u6210:</p>\n<div class=\"highlight\"><pre><span></span><code>\\set nbranches :scale\n\\set ntellers 10 * :scale\n\\set naccounts 100000 * :scale\n\\setrandom aid 1 :naccounts\n\\setrandom bid 1 :nbranches\n\\setrandom tid 1 :ntellers\n\\setrandom delta -5000 5000\nBEGIN;\nUPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;\nSELECT abalance FROM pgbench_accounts WHERE aid = :aid;\nUPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;\nUPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;\nINSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);\nEND;\n</code></pre></div>\n<p>\u811a\u672c\u7684\u524d 3 \u884c\u4f9d\u636e:scale \u53d8\u91cf\u8ba1\u7b97\u6709\u591a\u5c11\u652f\u884c\u3001\u67dc\u5458\u4ee5\u53ca\u8d26\u6237\u3002\u63a5\u4e0b\u6765 4 \u884c\u521b\u5efa\u968f\u673a\u6570\uff0c\u6a21\u62df\u94f6\u884c\u4ea4\u6613\u3002\u811a\u672c\u7684\u6838\u5fc3\u4ee3\u7801\u662f\u7531 5 \u4e2a\u8bed\u53e5\u7ec4\u6210\u7684\u4e8b\u52a1\uff0c\u6bcf\u4e2a\u8bed\u53e5\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u90fd\u4e0d\u540c:\\</p>\n<dl>\n<dt>update pgbench_accounts</dt>\n<dd>\n<p>\u4f5c\u4e3a\u6570\u636e\u5e93\u4e2d\u6700\u5927\u7684\u8868\uff0c\u5b83\u6700\u6709\u53ef\u80fd\u5f15\u53d1\u78c1\u76d8 I/0 \u74f6\u9888</p>\n</dd>\n<dt>select abalance</dt>\n<dd>\n<p>\u56e0\u4e3a\u4e4b\u524d\u7684 update \u8bed\u53e5\u5df2\u7ecf\u628a\u8be5\u8bed\u53e5\u9700\u8981\u67e5\u8be2\u7684\u4fe1\u606f\u90fd\u7f13\u5b58\u8d77\u6765\u4e86\uff0c\u56e0\u6b64\u5b83\u589e\u52a0\u7684\u5f00\u9500\u5f88\u5c0f</p>\n</dd>\n<dt>update pgbench_tellers</dt>\n<dd>\n<p>\u76f8\u6bd4 accounts \u8868\uff0c\u8fd9\u4e2a\u8868\u5c0f\u5f88\u591a\uff0c\u80fd\u591f\u5728\u7f13\u5b58\u5230\u5185\u5b58\uff0c\u56e0\u6b64\u5b83\u53ef\u80fd\u5bf9\u5f15\u53d1\u9501\u7684\u95ee\u9898</p>\n</dd>\n<dt>update pgbench_branches</dt>\n<dd>\n<p>\u8fd9\u4e2a\u8868\u76f8\u5f53\u5c0f\uff0c\u6574\u4e2a\u5185\u5bb9\u90fd\u53ef\u4ee5\u88ab\u7f13\u5b58\uff0c\u6240\u4ee5\u8bbf\u95ee\u901f\u5ea6\u4e0d\u662f\u95ee\u9898\uff0c\u4f46\u662f\u6b63\u56e0\u4e3a\u5c0f\uff0c\u9501\u6709\u53ef\u80fd\u79f0\u4e3a\u5176\u8bbf\u95ee\u74f6\u9888</p>\n</dd>\n<dt>insert into pgbench_history</dt>\n<dd>\n<p>\u5386\u53f2\u8868\u4f5c\u4e3a\u53ea\u8ffd\u52a0\u8868\uff0c\u8868\u4e0a\u65e0\u7d22\u5f15</p>\n</dd>\n</dl>\n<p>\u8fd9\u662f\u7f3a\u7701\u6d4b\u8bd5\uff0c\u8fd8\u6709\u4e24\u4e2a\u522b\u7684\u53c2\u6570\u53ef\u4ee5\u7a0d\u5fae\u6539\u53d8\u6d4b\u8bd5\u884c\u4e3a:</p>\n<dl>\n<dt>-N</dt>\n<dd>\n<p>\u548c\u4e0a\u9762\u7684\u6d4b\u8bd5\u76f8\u540c\uff0c\u53ea\u662f\u8df3\u8fc7\u4e24\u4e2a\u5c0f\u8868(tellers,branches)\u7684\u66f4\u65b0\u53c2\u6570\uff0c\u8fd9\u964d\u7ea7\u7684\u9501\u7684\u6f5c\u5728\u95ee\u9898</p>\n</dd>\n<dt>-S</dt>\n<dd>\n<p>\u53ea\u5bf9 accounts \u8868\u505a\u67e5\u8be2\u64cd\u4f5c\uff0c\u56e0\u6b64\u5b83\u4e0d\u9700\u8981\u628a\u8bed\u53e5\u7ec4\u6210\u4e00\u4e2a\u4e8b\u52a1</p>\n</dd>\n</dl>\n<p>\u4ec5\u505a\u67e5\u8be2\u64cd\u4f5c\u800c\u8df3\u8fc7\u6240\u6709\u7684\u66f4\u65b0\u64cd\u4f5c\u5bf9\u4e8e\u68c0\u67e5\u7f13\u5b58\u5927\u5c0f\uff0c\u6d4b\u8bd5\u6700\u5927 CPU \u901f\u5ea6\u5f88\u6709\u5e2e\u52a9\u3002</p>\n<h4 id=\"pgbench_1\">\u4e3a pgbench \u914d\u7f6e\u6570\u636e\u5e93<a class=\"headerlink\" href=\"#pgbench_1\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5185\u5efa\u7684\u6d4b\u8bd5\u884c\u4e3a\uff0c\u5176\u4ed6\u8bed\u53e5\u90fd\u5f88\u7b80\u5355\uff1a\u7edd\u5927\u90e8\u5206\u662f\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u67e5\u8be2\uff0c\u6ca1\u6709\u8868\u94fe\u63a5\uff0c\u4e5f\u6ca1\u7528\u8d1f\u8d23\u67e5\u8be2\u7c7b\u578b\u3002\\\n\u4f46\u8fd9\u4e9b\u8bed\u53e5\u90fd\u4f1a\u4ea7\u751f\u5f88\u91cd\u7684\u5199\u538b\u529b\uff0c\u9700\u8981\u7f13\u5b58\u80fd\u8ddf\u5f97\u4e0a\\\n\u57fa\u4e8e\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u53ef\u4ee5\u8c03\u6574\u7684\u53c2\u6570\u5206\u4e3a\u4e09\u4e2a\u4e3b\u8981\u7c7b\u578b:</p>\n<ul>\n<li>\n<p>\u91cd\u70b9\u5173\u6ce8\u548c\u8c03\u6574\u7684\u53c2\u6570:\n  shared_buffers,checkpoint_segments,autovacuum,wal_buffers,checkpoint_completion_target</p>\n</li>\n<li>\n<p>\u663e\u8457\u5f71\u54cd\u6d4b\u8bd5\u7ed3\u679c\u7684\u53c2\u6570:\n  wal_sync_method,synchronouse_commit,wal_writer_delay</p>\n</li>\n<li>\n<p>\u65e0\u5173\u7684:\n  effective_cache_size,default_statistics_target,work_mem,random_page_cost \u7b49</p>\n</li>\n</ul>\n<h2 id=\"_34\">\u6570\u636e\u5e93\u7d22\u5f15<a class=\"headerlink\" href=\"#_34\" title=\"Permanent link\">&para;</a></h2>\n<h2 id=\"_35\">\u67e5\u8be2\u4f18\u5316<a class=\"headerlink\" href=\"#_35\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_36\">\u586b\u5145\u6837\u4f8b\u6570\u636e<a class=\"headerlink\" href=\"#_36\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6f14\u793a\u67e5\u8be2\u4f18\u5316\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u9700\u8981\u586b\u5145\u4e00\u4e9b\u6837\u4f8b\u6570\u636e\uff0cPostgreSQL \u7684 wiki \u4e0a\u7ed9\u51fa\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u6837\u4f8b\u6570\u636e\u5217\u8868\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u94fe\u63a5\uff1a<a href=\"http://wiki.postgresql.org/wiki/ Sample_Databases\">http://wiki.postgresql.org/wiki/\nSample_Databases</a>\n\u8fd9\u91cc\u9009\u53d6 Dell Store 2 \u8fd9\u4e2a\u6709 Dell \u8d21\u732e\u7684\u6837\u4f8b\uff0c\u5b89\u88c5\u6b65\u9aa4\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>wget<span class=\"w\"> </span>http://pgfoundry.org/frs/download.php/543/dellstore2-normal-1.0.tar.gz\ntar<span class=\"w\"> </span>xvfz<span class=\"w\"> </span>dellstore2-normal-1.0.tar.gz\n<span class=\"nb\">cd</span><span class=\"w\"> </span>dellstore2-normal-1.0/\ncreatedb<span class=\"w\"> </span>dellstore2\ncreatelang<span class=\"w\"> </span>plpgsql<span class=\"w\"> </span>dellstore2\npsql<span class=\"w\"> </span>-f<span class=\"w\"> </span>dellstore2-normal-1.0.sql<span class=\"w\"> </span>-d<span class=\"w\"> </span>dellstore2\npsql<span class=\"w\"> </span>-d<span class=\"w\"> </span>dellstore2<span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"s2\">&quot;VACUUM VERBOSE ANALYZE&quot;</span>\n</code></pre></div>\n<p>\u8be5\u6837\u4f8b\u6570\u636e\u5e93\u5927\u6982 23MB</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">psql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">hlocalhost</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">dellstore2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"ss\">&quot;select pg_size_pretty(pg_database_size(&#39;dellstore2&#39;))&quot;</span>\n<span class=\"w\"> </span><span class=\"n\">pg_size_pretty</span>\n<span class=\"c1\">----------------</span>\n<span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u5176\u4e3b\u8981\u7684\u8868\u548c\u7d22\u5f15\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">dt</span><span class=\"o\">+</span>\n<span class=\"w\">        </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">relations</span>\n<span class=\"w\"> </span><span class=\"k\">Schema</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"n\">Name</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"k\">Size</span><span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"c1\">--------+------------+---------+</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">categories</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">cust_hist</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2648</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">customers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">3944</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">inventory</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">472</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">orderlines</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">3112</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">832</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">products</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">840</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">reorder</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"p\">(</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">di</span><span class=\"o\">+</span>\n<span class=\"w\">            </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">relations</span>\n<span class=\"w\"> </span><span class=\"k\">Schema</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"n\">Name</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"k\">Size</span><span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"c1\">--------+------------------------+---------+</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">categories_pkey</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">customers_pkey</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">456</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">inventory_pkey</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">240</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_cust_hist_customerid</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1336</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_cust_username</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">624</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_order_custid</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">280</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_orderlines_orderid</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1336</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_prod_category</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">240</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ix_prod_special</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">240</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">orders_pkey</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">280</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">products_pkey</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">240</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<h2 id=\"_37\">\u6570\u636e\u5e93\u6d3b\u52a8\u548c\u7edf\u8ba1<a class=\"headerlink\" href=\"#_37\" title=\"Permanent link\">&para;</a></h2>\n<p>PostgreSQL \u6709\u4e00\u4e2a\u7edf\u8ba1\u6536\u96c6\u7684\u5b50\u7cfb\u7edf\uff0c\u5b83\u53ef\u4ee5\u76d1\u63a7\u6570\u636e\u5e93\u5185\u90e8\u5404\u65b9\u9762\u7684\u4fe1\u606f\u3002\u670d\u52a1\u5668\u7684\u6bcf\u4e2a\u5904\u7406\u4f1a\u53d1\u9001\u7edf\u8ba1\u6d88\u606f\u7ed9\u6536\u96c6\u5668\uff0c\u6700\u540e\u7edf\u8ba1\u5668\u6c47\u603b\u6d88\u606f\u5e76\u53d1\u5e03\u3002\n\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u7edf\u8ba1\u5668\u6ca1\u534a\u79d2(\u7f16\u8bd1\u65f6\u6307\u5b9a\u7684\u503c)\u66f4\u65b0\u7edf\u8ba1\u5e76\u53d1\u5e03\uff0c\u6bcf\u4e00\u4e2a\u7edf\u8ba1\u503c\u53ef\u4ee5\u901a\u8fc7\u4e00\u5957\u51fd\u6570\u6765\u8fd4\u56de\uff0c\u8be6\u7ec6\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u6587\u6863\uff1a<a href=\"http://www.postgresql.org/docs/current/static/monitoring-stats.html\">http://www.postgresql.org/docs/current/static/monitoring-stats.html</a></p>\n<h3 id=\"_38\">\u7edf\u8ba1\u89c6\u56fe<a class=\"headerlink\" href=\"#_38\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u7ec4\u7ec7\u4e00\u7cfb\u5217\u7684\u89c6\u56fe\uff0c\u4ee5\u65b9\u4fbf\u4eba\u4eec\u80fd\u591f\u5feb\u901f\u8bbf\u95ee\u7edf\u8ba1\u6536\u96c6\u5668\u7684\u8f93\u51fa\uff0c\u9605\u8bfb\u6709\u5173\u89c6\u56fe\u7684\u6e90\u4ee3\u7801\u5bf9\u4e8e\u7406\u89e3\u5176\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u975e\u5e38\u6709\u5e2e\u52a9\uff0c\u5982\u679c\u4f60\u6709 PostgreSQL \u7684\u6e90\u4ee3\u7801\uff0c\u90a3\u4e48\u53ef\u4ee5\u9605\u8bfb\nsrc/backend/catalog/system_views.sql \u6587\u4ef6\u3002\u5982\u679c\u4f60\u5df2\u7ecf\u5b89\u88c5\u4e86\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u9605\u8bfb share/system_views.sql\uff0c\u6216\u8005\u4f60\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\u5176\u6e90\u4ee3\u7801:<a href=\"http://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/catalog/system_views.sql\">http://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/catalog/system_views.sql</a>\n\u6211\u4eec\u53ef\u4ee5\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u89c6\u56fe\u6765\u7406\u89e3\u5b83\u4e00\u822c\u662f\u5982\u4f55\u7ec4\u7ec7\u7684\uff0c\u4e0b\u9762\u662f 8.3 \u7248\u672c\u4e2d pg_stat_bgwriter \u89c6\u56fe\u6e90\u4ee3\u7801\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">VIEW</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"k\">SELECT</span>\n<span class=\"n\">pg_stat_get_bgwriter_timed_checkpoints</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_timed</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_bgwriter_requested_checkpoints</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_bgwriter_buf_written_checkpoints</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_checkpoint</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_bgwriter_buf_written_clean</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_bgwriter_maxwritten_clean</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">maxwritten_clean</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_buf_written_backend</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_backend</span><span class=\"p\">,</span>\n<span class=\"n\">pg_stat_get_buf_alloc</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_alloc</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u89c6\u56fe\u5176\u5b9e\u53ea\u662f\u628a\u5404\u79cd\u72ec\u7acb\u7684\u7edf\u8ba1\u51fd\u6570\u7ec4\u7ec7\u5728\u4e00\u8d77\uff0c\u4ece\u800c\u8f93\u51fa\u4e00\u4e2a\u5b8c\u6574\u7684\u4fe1\u606f\uff0c\u5176\u4ed6\u7edf\u8ba1\u89c6\u56fe\u7ed3\u6784\u4e0a\u4e5f\u548c\u8fd9\u7c7b\u4f3c\u3002</p>\n<h3 id=\"_39\">\u7d2f\u79ef\u89c6\u56fe\u548c\u5b9e\u65f6\u89c6\u56fe<a class=\"headerlink\" href=\"#_39\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u4fe1\u606f\u53ef\u4ee5\u4ece\u6570\u636e\u5e93\u83b7\u5f97\u76d1\u63a7\u4fe1\u606f\u3002\u4e3b\u8981\u7684\u7edf\u8ba1\u4fe1\u606f\u4fdd\u5b58\u5728\u8ba1\u6570\u5668\u91cc\u3002\u5f53\u4f60\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5e93\u65f6\uff0c\u8ba1\u6570\u5668\u8bbe\u7f6e\u4e3a 0\uff0c\u968f\u7740\u548c\u7edf\u8ba1\u76f8\u5173\u7684\u6d3b\u52a8\u589e\u52a0\u800c\u589e\u52a0\u3002\n\u8ba1\u6570\u5668\u5305\u62ec pg_stat_database,pg_stat_bgwriter \u4ee5\u53ca\u6240\u6709\u547d\u540d\u4ee5 pg_stat \u5f00\u5934\u7684\u89c6\u56fe\u3002\\\n\u6709\u786e\u5207\u7684\u65b9\u6cd5\u628a\u8ba1\u6570\u5668\u6e05\u96f6\uff0c\u4e0d\u8fc7 PostgreSQL \u7248\u672c\u4e0d\u540c\uff0c\u65b9\u6cd5\u4e0d\u540c\uff1a</p>\n<dl>\n<dt>Version 8.1</dt>\n<dd>\n<p>pg_stat_reset()\u91cd\u7f6e\u6240\u6709\u7edf\u8ba1\uff0c\u5728 postgresql.conf \u8bbe\u7f6e stats_reset_on_server_start=on \u4f1a\u4f7f\u5f97\u6bcf\u6b21\u6570\u636e\u5e93\u670d\u52a1\u91cd\u542f\u90fd\u5145\u503c\u7edf\u8ba1</p>\n</dd>\n<dt>Version 8.2</dt>\n<dd>\n<p>pg_stat_reset()\u4ec5\u91cd\u7f6e\u5757\u4ee5\u53ca\u884c\u7ea7\u522b\u7edf\u8ba1\uff0c\u800c stats_reset_on_server_start=on \u5219\u91cd\u7f6e\u6240\u6709\u7edf\u8ba1,\u5305\u62ec\u6570\u636e\u5e93\u7aef\u548c\u96c6\u7fa4\u7aef\u3002</p>\n</dd>\n<dt>Version 8.3,8.4</dt>\n<dd>\n<p>pg_stat_reset()\u53ea\u91cd\u7f6e\u5f53\u524d\u6570\u636e\u5e93\u7684\u6240\u6709\u7edf\u8ba1\uff0c\u6ca1\u6cd5\u529e\u6cd5\u53ef\u4ee5\u91cd\u7f6e\u96c6\u7fa4\u6bb5\u7684\u7edf\u8ba1\uff0c\u6bd4\u5982 pg_stat_bgwriter\u3002</p>\n</dd>\n<dt>Version 9.0</dt>\n<dd>\n<p>pg_stat_reset()\u4ec5\u91cd\u7f6e\u5f53\u524d\u6570\u636e\u5e93\u7684\u6240\u6709\u7edf\u8ba1\u3002pg_stat_reset_shared('bgwriter')\u53ef\u4ee5\u91cd\u7f6e pg_stat_bgwriter.\npg_stat_reset_single_table_counters() \uff0c\npg_stat_reset_single_function_counters()\u53ef\u4ee5\u91cd\u7f6e\u5355\u72ec\u7684\u8868\u3001\u7d22\u5f15\u4ee5\u53ca\u51fd\u6570\u7edf\u8ba1</p>\n</dd>\n</dl>\n<p>\u77e5\u9053\u7edf\u8ba1\u89c6\u56fe\u91cc\u54ea\u4e9b\u662f\u7d2f\u52a0\u7684\uff0c\u54ea\u4e9b\u662f\u56fa\u5b9a\u7684\uff08\u6bd4\u5982\u8868\u540d\uff09\u5f88\u91cd\u8981\u3002\u4e3a\u4e86\u641e\u6e05\u695a\u7d2f\u52a0\u7684\u5b57\u6bb5\uff0c\u4f60\u53ef\u4ee5\u7528\u5e26\u65f6\u95f4\u6233\u7684\u65b9\u5f0f\u5b9a\u671f\u6293\u53d6\u6570\u636e\uff0c\u7136\u540e\u89c2\u5bdf\u8fd9\u4e9b\u6570\u636e\u5728\u8fd9\u4e2a\u65f6\u95f4\u6bb5\u5185\u662f\u5982\u4f55\u53d8\u5316\u7684\uff0c\u8fd9\u7ae0\u7684\u6700\u540e\u4f1a\u7ed9\u51fa\u4eba\u5de5\u6293\u53d6 pg_stat_bgwriter \u6570\u636e\u3002\\\n\u9664\u4e86\u8fd9\u4e9b\u76f4\u89c2\u7684\u7edf\u8ba1\u8ba1\u6570\u5668\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u6570\u636e\u5e93\u6d3b\u52a8\u7684\u5b9e\u65f6\u89c6\u56fe\uff0c\u5b83\u7ed9\u51fa\u4e86\u6570\u636e\u5e93\u6b64\u523b\u6240\u53d1\u751f\u7684\u6d3b\u52a8\u7684\u5feb\u7167\u3002\u8fd9\u4e9b\u89c6\u56fe\u5305\u62ec pg_stat_activity,pg_locks,pg_prepared_xacts.</p>\n<h3 id=\"_40\">\u8868\u7edf\u8ba1<a class=\"headerlink\" href=\"#_40\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6bcf\u4e2a\u8868\u7684\u57fa\u672c\u7edf\u8ba1\u89c6\u56fe\u4e3a pg_stat_all_tables\uff0c\u8fd9\u4e2a\u89c6\u56fe\u4e3a\u4e86\u65b9\u4fbf\u6709\u5206\u6210\u4e86\u4e24\u4e2a\uff0c\u4e00\u4e2a\u662f\u548c\u7cfb\u7edf\u8868\u6709\u5173\u7684 pg_stat_sys_tables\uff0c\u4e00\u4e2a\u662f\u548c\u7528\u6237\u8868 pg_stat_user_tables\u3002\u540e\u8005\u662f\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u7684\u3002\\\n\u89c6\u56fe\u7684\u7b2c\u4e00\u4e2a\u7528\u5904\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6570\u636e\u6765\u76d1\u63a7 vacuum \u5728\u4f60\u6570\u636e\u5e93\u91cc\u8fd0\u4f5c\u5f97\u5982\u4f55\u3002\\\n\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89c6\u56fe\u6765\u5224\u65ad\u8fd9\u4e9b\u8868\u662f\u5426\u901a\u8fc7\u987a\u5e8f\u626b\u63cf\u6216\u8005\u7d22\u5f15\u626b\u63cf\u8bbf\u95ee\u8fc7</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">schemaname</span><span class=\"p\">,</span><span class=\"n\">relname</span><span class=\"p\">,</span><span class=\"n\">seq_scan</span><span class=\"p\">,</span><span class=\"n\">idx_scan</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seq_scan</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">idx_scan_pct</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_tables</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seq_scan</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">idx_scan_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\"> </span><span class=\"n\">schemaname</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">seq_scan</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_scan_pct</span>\n<span class=\"w\"> </span><span class=\"c1\">-----------+------------------+----------+----------+---------------</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000000</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000000</span>\n<span class=\"w\"> </span><span class=\"k\">public</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">600000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">999998</span>\n<span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u5728\u6781\u5c0f\u7684 pgbench \u6570\u636e\u5e93\u91cc\uff0c\u8bbf\u95ee pgbench_branches \u548c pgbench_tellers \u662f\u901a\u8fc7\u987a\u5e8f\u626b\u63cf\u8bbf\u95ee\u7684\uff0c\u56e0\u4e3a\u4ed6\u4eec\u90fd\u5f88\u5c0f\uff0c\u53ef\u4ee5\u8f7d\u5165\u5230\u4e00\u4e2a\u6570\u636e\u9875\u5185\u3002\u800c pgbench_accounts \u5c31\u5f88\u5927\u4e86\uff0c\u56e0\u6b64 select \u8bed\u53e5\u8bbf\u95ee\u65f6\uff0c\u9700\u8981\u901a\u8fc7\u7d22\u5f15\u6765\u67e5\u8be2\u6570\u636e\u3002\\\n\u6211\u4eec\u5bf9\u8868\u66f4\u611f\u5174\u8da3\u7684\u662f\u786e\u5207\u7684\u77e5\u9053\u8fd9\u4e2a\u8868\u88ab\u8fd9\u4e9b\u626b\u9762\u6240\u5904\u7406\u8fc7\u7684\u5143\u7ec4,\u4e0b\u9762\u7684\u89c6\u56fe\u67e5\u8be2\u53ef\u4ee5\u83b7\u5f97\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span><span class=\"n\">seq_tup_read</span><span class=\"p\">,</span><span class=\"n\">idx_tup_fetch</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">idx_tup_fetch</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_tup_fetch</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seq_tup_read</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">idx_tup_pct</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_tables</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_tup_fetch</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"n\">seq_tup_read</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">idx_tup_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">seq_tup_read</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_tup_fetch</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_tup_pct</span>\n<span class=\"c1\">------------------+--------------+---------------+--------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">500</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000000</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">200</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000000</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">5000000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">600000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">107143</span>\n<span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u7528\u6765\u67e5\u8be2\u70ed(HOT)\u6570\u636e\u591a\u957f\u65f6\u95f4\u88ab\u7528\u6765\u66f4\u65b0:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span><span class=\"n\">n_tup_upd</span><span class=\"p\">,</span><span class=\"n\">n_tup_hot_upd</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">n_tup_hot_upd</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hot_pct</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_tables</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">hot_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">n_tup_hot_upd</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">hot_pct</span>\n<span class=\"c1\">------------------+-----------+---------------+-----------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">24681</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">3431</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">139014</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">24681</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">24428</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">989749</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">24680</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">24680</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">000000</span>\n<span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece\u8f93\u51fa\u6765\u770b\uff0cpgbench_tellers \u548c pgbench_branches \u7684\u6570\u636e\u66f4\u65b0\u51e0\u4e4e\u5168\u90e8\u5728\u70ed\u6570\u636e\u4e2d\u5b8c\u6210\uff0c\u8fd9\u6709\u7740\u5f88\u9ad8\u7684\u6548\u7387\uff0c\u4f46\u662f\u5bf9\u4e8e\u5927\u8868 pgbench_accounts \u800c\u8a00\uff0c\u70ed\u6570\u636e\u7684\u66f4\u65b0\u76f8\u6bd4\u6240\u6709\u6570\u636e\u7684\u66f4\u65b0\uff0c\u6bd4\u7387\u5f88\u4f4e\uff0c\u4ece\u800c\u6027\u80fd\u4e0d\u9ad8\uff0c\u56e0\u6b64\u9700\u8981\u8c03\u6574\u3002\\\n\u6700\u540e\u4e00\u4e2a\u597d\u5904\u662f\u53ef\u4ee5\u901a\u8fc7\u89c6\u56fe\u6765\u601d\u8003\u5728\u8868\u4e0a\u63d2\u5165/\u66f4\u65b0/\u5220\u9664\u7684\u7279\u5f81:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">n_tup_ins</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">n_tup_ins</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_del</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">ins_pct</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">n_tup_ins</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_del</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">upd_pct</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">n_tup_del</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">n_tup_ins</span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_upd</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">n_tup_del</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">del_pct</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_tables</span><span class=\"w\"> </span><span class=\"k\">ORDER</span><span class=\"w\"> </span><span class=\"k\">BY</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ins_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">upd_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">del_pct</span>\n<span class=\"c1\">------------------+---------+---------+---------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">97916</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">02084</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00000</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00052</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99948</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00000</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_history</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">00000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00000</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00516</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99484</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00000</span>\n<span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8f93\u51fa\u8bc1\u5b9e\u4e86 pgbench_history \u662f\u6211\u4eec\u4e4b\u524d\u79f0\u4e4b\u4e3a\u7684\u53ea\u9644\u52a0\u8868\uff0c\u5728\u8fd9\u4e2a\u8868\u4e0a\u53ea\u6709\u63d2\u5165\uff0c\u6c38\u8fdc\u90fd\u4e0d\u4f1a\u6709\u66f4\u65b0\u548c\u5220\u9664\u3002\u5b83\u4e5f\u6697\u793a\u4e86 pgbench_branches \u548c pgbench_tellers \u6709\u5927\u91cf\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u800c\u63d2\u5165\u64cd\u4f5c\u5fae\u4e4e\u5176\u5fae\uff0c\u5220\u9664\u64cd\u4f5c\u5219\u6839\u672c\u5c31\u6ca1\u6709\u3002\n\u8fd9\u4e9b\u4fe1\u606f\u5bf9\u4e8e\u6211\u4eec\u5224\u65ad\u8868\u662f\u5426\u9700\u8981\u5468\u671f\u6027\u7684\u6267\u884c reindex \u64cd\u4f5c\u5f88\u6709\u5e2e\u52a9\u3002\n\u540c\u6837\u7684\uff0c\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\u7684\u6bd4\u7387\u89c2\u5bdf\uff0c\u4e5f\u53ef\u4ee5\u8ba9\u6211\u4eec\u601d\u8003\u5982\u679c\u8fd9\u4e2a\u6bd4\u8f83\u8f83\u9ad8\uff0c\u5219\u53ef\u4ee5\u6267\u884c\u8bf8\u5982 CLUSTER \u64cd\u4f5c\u6765\u6e05\u7406\u7a7a\u95f4\u3002</p>\n<h3 id=\"io_1\">\u8868 I/O<a class=\"headerlink\" href=\"#io_1\" title=\"Permanent link\">&para;</a></h3>\n<p>pg_statio_all_tables(pg_statio_user_tables/pg_statio_sys_tables)\u7528\u6765\u96c6\u4e2d\u7edf\u8ba1\u6570\u636e\u5e93\u4e0a\u7684\u7269\u7406 I/O\u3002\n\u7b2c\u4e00\u5bf9\u8981\u76d1\u63a7\u7684\u5b57\u6bb5\u662f\u7528 shared_buffers \u6765\u7f13\u5b58\u8868\u6570\u636e\u7684\u7ed3\u6784\uff0c\u5728\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u91cc\u79f0\u4e3a\u5806(heap)\uff0c\u5f53\u53d1\u751f\u4e00\u4e2a\u8bfb\u64cd\u4f5c\u65f6\uff0c\u6570\u636e\u5224\u65ad\u662f\u8bfb\u53d6\u6570\u636e\u5e93\u7f13\u5b58(heap\nblock hit)\u5757\u8fd8\u662f\u8981\u6c42\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u8bfb(heap block read)\u624d\u80fd\u6ee1\u8db3\u8981\u6c42\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">heap_blks_hit</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">heap_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">heap_blks_read</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">,</span>\n<span class=\"n\">heap_blks_hit</span><span class=\"p\">,</span><span class=\"n\">heap_blks_read</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_statio_user_tables</span>\n<span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">heap_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">heap_blks_read</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">heap_blks_hit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">heap_blks_read</span>\n<span class=\"c1\">------------------+---------+---------------+----------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">59564</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">906335</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">615280</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_history</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99316</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">109787</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">756</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99977</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">197282</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">46</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99988</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">280172</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">34</span>\n<span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684 heap blocks\nread \u90fd\u4f1a\u8f6c\u5316\u4e3a\u7269\u7406\u78c1\u76d8 I/O\uff0c\u4ed6\u4eec\u6709\u53ef\u80fd\u662f\u4ece\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u8bfb\u53d6\u3002\u5f53\u524d\uff0c\u6570\u636e\u5e93\u6ca1\u6709\u529e\u6cd5\u77e5\u9053\u5230\u5e95\u662f\u54ea\u79cd\u8bfb\u53d6\u65b9\u5f0f\u3002\n\u4e0d\u8fc7\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\\\"<a href=\"http://en.wikipedia.org/wiki/DTrace\">Dtrace</a>\\\"\u8fd9\u6837\u7684\u5de5\u5177\u6765\u8ddf\u8e2a\u8bfb\u64cd\u4f5c\uff0c\u800c\u4ece\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad\u3002\\\n\u67e5\u8be2\u8868\u4e0a\u6bcf\u4e2a\u7d22\u5f15\u6240\u7528\u5230\u7684\u78c1\u76d8 I/O \u8bed\u53e5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">,</span>\n<span class=\"n\">idx_blks_hit</span><span class=\"p\">,</span><span class=\"n\">idx_blks_read</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_statio_user_tables</span>\n<span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">relname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span>\n<span class=\"c1\">------------------+---------+--------------+---------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">91667</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">77</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">7</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">97414</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">2555866</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">67839</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99990</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">194106</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">19</span>\n<span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\u770b\u4e0d\u5230 pgbench_history \u8868\u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u8868\u6ca1\u6709\u7d22\u5f15\u3002\\\n\u8868 I/O \u7edf\u8ba1\u4e5f\u53ef\u4ee5\u5305\u62ec TOAST \u8868\u7684\u7edf\u8ba1\uff0c\u67e5\u8be2\u65b9\u5f0f\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"n\">heap_blks_read</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">toast_blks_read</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">tidx_blks_read</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">total_blks_read</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"n\">heap_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">toast_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">tidx_blks_hit</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">total_blks_hit</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_statio_user_tables</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_41\">\u7d22\u5f15\u7edf\u8ba1<a class=\"headerlink\" href=\"#_41\" title=\"Permanent link\">&para;</a></h3>\n<p>pg_stat_all_indexes(pg_stat_user_indexes/pg_stat_sys_indexes)\u89c6\u56fe\u7528\u4e8e\u7edf\u8ba1\u7d22\u5f15\u4fe1\u606f\uff0c\u5b83\u7ed9\u51fa\u7684\u5305\u62ec\u5305\u62ec\u6709\u591a\u5c11\u7d22\u5f15\u626b\u63cf\u88ab\u5904\u7406\u4ee5\u53ca\u901a\u8fc7\u7d22\u5f15\u626b\u63cf\u8fd4\u56de\u4e86\u591a\u5c11\u884c\u6570\u636e\u3002\\\n\u8fd9\u4e2a\u89c6\u56fe\u7684\u5b57\u6bb5\u540d\u5b57\u5f88\u590d\u6742\uff0c\u5f88\u96be\u533a\u5206\u3002\u6bd4\u5982\u4e0b\u9762\u4e24\u4e2a\u5b57\u6bb5\u540d\u5b57\u5dee\u4e0d\u591a\uff0c\u5dee\u522b\u4e5f\u5f88\u7ec6\u5fae\uff1a</p>\n<dl>\n<dt>idx_tup_read</dt>\n<dd>\n<p>\u901a\u8fc7\u7d22\u5f15\u626b\u63cf\u8fd4\u56de\u7684\u7d22\u5f15\u6761\u76ee\u6570</p>\n</dd>\n<dt>idx_tup_fetch</dt>\n<dd>\n<p>\u901a\u8fc7\u8be5\u7d22\u5f15\u6267\u884c\u7b80\u5355\u7d22\u5f15\u626b\u63cf\u540e\u83b7\u53d6\u7684\u8868\u8bb0\u5f55\u6570\u3002\u8fd9\u4e2a\u6570\u901a\u5e38\u6bd4 idx_tup_read \u5c0f\u4e00\u70b9\uff0c\u56e0\u4e3a\u5b83\u4e0d\u5305\u62ec\u6b7b\u7684\u6216\u8005\u8fd8\u6ca1\u6709\u63d0\u4ea4\u7684\u884c\u3002\n\u53e6\u5916\uff0c\u8fd9\u91cc\u7684\"\u7b80\u5355\"\u610f\u601d\u662f\u8bf4\u7d22\u5f15\u8bbf\u95ee\u4e0d\u662f\u4f4d\u56fe\u7d22\u5f15\u626b\u63cf(bitmap index\nscan)</p>\n</dd>\n</dl>\n<p>\u56e0\u4e3a\u6709\u592a\u591a\u7684\u573a\u666f\u662f idx_tup_fetch \u4e0d\u8bb0\u5f55\u7684\uff0c\u56e0\u6b64\u5982\u679c\u4f60\u60f3\u8ffd\u8e2a\u4e00\u4e2a\u7d22\u5f15\u5230\u5e95\u88ab\u7cfb\u7edf\u4f7f\u7528\u7684\u9891\u7387\u5ea6\u6709\u591a\u5c11\uff0cidx_tup_read \u4f1a\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002\\\n\u901a\u8fc7\u8fd9\u4e2a\u89c6\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u8be5\u7d22\u5f15\u626b\u5893\u6240\u8fd4\u56de\u7684\u884c\u8bb0\u5f55\u5e73\u5747\u6570\u4ee5\u53ca\u7d22\u5f15\u662f\u5982\u4f55\u88ab\u4f7f\u7528\u7684:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">indexrelname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">idx_tup_read</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"p\">)::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">avg_tuples</span><span class=\"p\">,</span>\n<span class=\"n\">idx_scan</span><span class=\"p\">,</span><span class=\"n\">idx_tup_read</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_indexes</span>\n<span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">indexrelname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">avg_tuples</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_tup_read</span>\n<span class=\"c1\">-----------------------+------------+----------+--------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers_pkey</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">00280</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">96437</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">96707</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">07489</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">812874</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">873753</span>\n<span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8f93\u51fa\u663e\u793a\u57fa\u672c\u4e0a\u6bcf\u6b21\u7d22\u5f15\u626b\u9762\u8fd4\u56de\u4e00\u6761\u8bb0\u5f55\uff0c\u8fd9\u5bf9\u4e8e\u4e3b\u952e\u7d22\u5f15\u800c\u8a00\u5e76\u4e0d\u5947\u602a\u3002avg_tuples \u6bd4 1.0 \u7a0d\u5927\u4e00\u70b9\u70b9\uff0c\u53cd\u6620\u51fa\u7d22\u5f15\u626b\u63cf\u5076\u6709\u626b\u63cf\u5230\u65e0\u6548\u884c\u3002\\\npg_stat_user_indexes \u6240\u7edf\u8ba1\u7684\u4fe1\u606f\u6700\u5927\u7684\u7528\u5904\u662f\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u6240\u6709\u662f\u5426\u88ab\u4f60\u7684\u5e94\u7528\u771f\u6b63\u4f7f\u7528\u3002\u56e0\u4e3a\u7d22\u5f15\u4f1a\u589e\u52a0\u7cfb\u7edf\u7684\u800c\u5916\u5f00\u9500\uff0c\u56e0\u6b64\u5982\u679c\u4e00\u4e2a\u7d22\u5f15\u5e76\u4e0d\u662f\u88ab\u4f7f\u7528\uff0c\u90a3\u5c31\u5e94\u8be5\u5220\u9664\u3002\n\u67e5\u627e\u8fd9\u6837\u7684\u7d22\u5f15\u7684\u6700\u7b80\u5355\u529e\u6cd5\u5c31\u662f\u67e5\u8be2 idx_scan \u503c\u5f88\u5c0f\u7684\u6240\u4ee5\u4f60\uff0c\u6bd4\u5982\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">schemaname</span><span class=\"p\">,</span><span class=\"n\">relname</span><span class=\"p\">,</span><span class=\"n\">indexrelname</span><span class=\"p\">,</span><span class=\"n\">idx_scan</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">pg_relation_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">indexrelid</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">idx_size</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_user_indexes</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">pg_index</span><span class=\"w\"> </span><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">indexrelid</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">indisunique</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"k\">false</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"p\">,</span><span class=\"n\">relname</span><span class=\"p\">;</span>\n\n<span class=\"w\"> </span><span class=\"n\">schemaname</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">indexrelname</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_scan</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_size</span>\n<span class=\"c1\">------------+---------+--------------+----------+-----------</span>\n<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\u7279\u610f\u6392\u9664\u4e86\u5f3a\u5236\u552f\u4e00\u7ea6\u675f\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u7d22\u5f15\u5373\u4fbf\u5f88\u5c11\u4f7f\u7528\uff0c\u4e5f\u4e0d\u5e94\u8be5\u5220\u9664\u3002</p>\n<h3 id=\"io_2\">\u7d22\u5f15 I/O<a class=\"headerlink\" href=\"#io_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u548c\u8868 I/O \u89c6\u56fe\u7c7b\u4f3c\uff0c\u4e5f\u662f\u5206\u4e3a\u4e09\u4e2a\u89c6\u56fe,\u7528\u6cd5\u4e5f\u5dee\u4e0d\u591a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">indexrelname</span><span class=\"p\">,</span>\n<span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span><span class=\"p\">))::</span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">,</span>\n<span class=\"n\">idx_blks_hit</span><span class=\"p\">,</span><span class=\"n\">idx_blks_read</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_statio_user_indexes</span>\n<span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"p\">;</span>\n\n<span class=\"w\">     </span><span class=\"n\">indexrelname</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">hit_pct</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_blks_hit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idx_blks_read</span>\n<span class=\"c1\">-----------------------+---------+--------------+---------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">91667</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">77</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">7</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">97414</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">2555866</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">67839</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers_pkey</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">99990</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">194106</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">19</span>\n<span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<h3 id=\"_42\">\u6570\u636e\u5e93\u7edf\u8ba1<a class=\"headerlink\" href=\"#_42\" title=\"Permanent link\">&para;</a></h3>\n<p>\u89c6\u56fe pg_stat_database \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u83b7\u53d6\u6709\u5173\u6570\u636e\u5e93\u7ea7\u522b\u7684\u7edf\u8ba1\u4fe1\u606f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">datname</span><span class=\"p\">,</span><span class=\"n\">blks_read</span><span class=\"p\">,</span><span class=\"n\">blks_hit</span><span class=\"p\">,</span><span class=\"n\">tup_returned</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">tup_fetched</span><span class=\"p\">,</span><span class=\"n\">tup_inserted</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">tup_ins</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">tup_updated</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">tup_upd</span><span class=\"p\">,</span><span class=\"n\">tup_deleted</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">tup_del</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_database</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">datname</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;pgbench&#39;</span><span class=\"p\">;</span>\n\n<span class=\"w\"> </span><span class=\"n\">datname</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">blks_read</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">blks_hit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tup_returned</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tup_fetched</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tup_ins</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tup_upd</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tup_del</span>\n<span class=\"c1\">---------+-----------+----------+--------------+-------------+---------+---------+-------------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">689749</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">11227681</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">19441670</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">1515691</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5319222</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">635663</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">100</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u9664\u6b64\u4e4b\u5916\uff0c\u8bd5\u56fe\u8fd8\u6709\u4e00\u4e9b\u6709\u7528\u7684\u4e8b\u52a1\u63d0\u4ea4\u7edf\u8ba1\u4fe1\u606f\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">datname</span><span class=\"p\">,</span><span class=\"n\">numbackends</span><span class=\"p\">,</span><span class=\"n\">xact_commit</span><span class=\"p\">,</span><span class=\"n\">xact_rollback</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_database</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">datname</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">numbackends</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">xact_commit</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">xact_rollback</span>\n<span class=\"c1\">------------+-------------+-------------+---------------</span>\n<span class=\"w\"> </span><span class=\"n\">template1</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">26616</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">2</span>\n<span class=\"w\"> </span><span class=\"n\">template0</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">postgres</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">27441</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">337</span>\n<span class=\"w\"> </span><span class=\"n\">wgzhao</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">31578</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">302</span>\n<span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">27711</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">45</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">840155</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">25</span>\n<span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">db2</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">dellstore2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">1317</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"mi\">1</span>\n<span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<h3 id=\"_43\">\u8fde\u63a5\u548c\u6d3b\u52a8<a class=\"headerlink\" href=\"#_43\" title=\"Permanent link\">&para;</a></h3>\n<p>pg_stat_activity \u63d0\u4f9b\u4e86\u6bcf\u4e00\u4e2a\u5ba2\u6237\u7aef\u5f53\u524d\u5728\u670d\u52a1\u5668\u4e0a\u7684\u6d3b\u52a8\u5feb\u7167\u3002</p>\n<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89c6\u56fe\u6765\u67e5\u770b\u4e00\u4e2a\u540e\u53f0\u8fdb\u7a0b\u8fd0\u884c\u4e86\u591a\u4e45\u5df2\u7ecf\u6b64\u523b\u662f\u5426\u6b63\u5728\u7b49\u5f85\u4ec0\u4e48:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">pid</span><span class=\"p\">,</span><span class=\"n\">waiting</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"k\">current_timestamp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">least</span><span class=\"p\">(</span><span class=\"n\">query_start</span><span class=\"p\">,</span><span class=\"n\">xact_start</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">substr</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">current_query</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_activity</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"n\">pid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pg_backend_pid</span><span class=\"p\">();</span>\n\n<span class=\"w\">  </span><span class=\"n\">pid</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">waiting</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">runtime</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"n\">current_query</span>\n<span class=\"c1\">-------+---------+-----------------+---------------------------</span>\n<span class=\"w\"> </span><span class=\"mi\">11987</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">005063</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">END</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"mi\">11989</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">00341</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"n\">SE</span>\n<span class=\"w\"> </span><span class=\"mi\">11988</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">017561</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">END</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"mi\">11991</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002855</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"n\">SE</span>\n<span class=\"w\"> </span><span class=\"mi\">11990</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002629</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"w\"> </span><span class=\"mi\">11992</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002998</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"n\">SE</span>\n<span class=\"w\"> </span><span class=\"mi\">11993</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002823</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"w\"> </span><span class=\"mi\">11994</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">003072</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"w\"> </span><span class=\"mi\">11995</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002469</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"n\">SE</span>\n<span class=\"w\"> </span><span class=\"mi\">11996</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">.</span><span class=\"mi\">002852</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\"> </span><span class=\"n\">SE</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<h3 id=\"_44\">\u78c1\u76d8\u4f7f\u7528<a class=\"headerlink\" href=\"#_44\" title=\"Permanent link\">&para;</a></h3>\n<p>\u83b7\u5f97\u4e00\u4e2a\u8868\u6216\u8005\u7d22\u5f15\u4f7f\u7528\u4e86\u591a\u5c11\u78c1\u76d8\u7a7a\u95f4\u7684\u6700\u57fa\u672c\u65b9\u6cd5\u662f\u8fd0\u884c pg_relation_size()\u51fd\u6570\uff0c\u5b83\u7ecf\u5e38\u548c pg_size_pretty()\u51fd\u6570\u8054\u5408\uff0c\u4ee5\u4fbf\u8f93\u51fa\u65b9\u4fbf\u9605\u8bfb\u7684\u5927\u5c0f\u3002</p>\n<p>\u6bd4\u5982\u4e0b\u7684\u4f8b\u5b50\u5c31\u662f\u67e5\u8be2\u5f53\u524d\u6570\u636e\u5e93\u4e0b\u6240\u6709\u7684\u8868\u6240\u4f7f\u7528\u7684\u78c1\u76d8\u5927\u5c0f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span>\n<span class=\"w\">       </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">pg_relation_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"ss\">&quot;size&quot;</span>\n<span class=\"w\">       </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_class</span><span class=\"w\"> </span><span class=\"k\">C</span>\n<span class=\"w\">       </span><span class=\"k\">left</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">pg_namespace</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">relnamespace</span><span class=\"p\">)</span>\n<span class=\"w\">       </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">relnamespace</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">       </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">oid</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_namespace</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">nspname</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;pg_catalog&#39;</span>\n<span class=\"w\">            </span><span class=\"k\">or</span><span class=\"w\"> </span><span class=\"n\">nspname</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;informantion_schema&#39;</span><span class=\"p\">)</span>\n<span class=\"w\">       </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">pg_relation_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">relname</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"k\">size</span>\n<span class=\"c1\">-----------------------+---------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">650</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_history</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">3088</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pg_toast_2618</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">320</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">sql_features</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers_pkey</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pg_toast_2619</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u4e3b\u8981\u95ee\u9898\u662f\u8868\u5927\u5c0f\u91cc\u6ca1\u6709\u5305\u542b TOAST \u8868\u7684\u5927\u7b11\uff0c\u867d\u7136\u53ef\u4ee5\u4f7f\u7528 pg_total_relation_size()\uff0c\u4f46\u662f\u5979\u53c8\u5305\u542b\u4e86\u7d22\u5f15\u5927\u5c0f\u3002</p>\n<p>PostgreSQL\n9.0 \u4ee5\u540e\uff0c\u6709\u4e00\u4e2a\u540d\u4e3a pg_table_size()\u7684\u51fd\u6570\u5305\u62ec\u4e86\u9664\u7d22\u5f15\u5916\u7684\u6240\u6709\u5176\u4ed6\u8868\u4fe1\u606f\u3002\u800c pg_indexes_size()\u5219\u7ed9\u51fa\u4e86\u4e00\u4e2a\u8868\u7684\u6240\u6709\u7d22\u5f15\u5927\u5c0f\u3002\n\u8fd9\u4e9b\u51fd\u6570\u6240\u8ba1\u7b97\u7684\u5927\u5c0f\u5173\u7cfb\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>    pg_total_relation_size = pg_table_size + pg_indexes_size\n    pg_table_size = pg_relation_size + toast table + toast indexes + FSM\n</code></pre></div>\n<p>\u4e0b\u9762\u7684\u67e5\u8be2\u663e\u793a\u4e86 TOAST \u548c\u7d22\u5f15\u5927\u5c0f:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relname</span><span class=\"p\">,</span><span class=\"n\">relkind</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"ss\">&quot;type&quot;</span><span class=\"p\">,</span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">pg_table_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">size</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">pg_indexes_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">idxsize</span><span class=\"p\">,</span>\n<span class=\"w\">          </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">pg_total_relation_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"ss\">&quot;total&quot;</span>\n<span class=\"w\">          </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_class</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"k\">left</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">pg_namespace</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">relnamespace</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">relnamespace</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"mi\">11728</span><span class=\"p\">,</span><span class=\"mi\">99</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">relkind</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s1\">&#39;r&#39;</span><span class=\"p\">,</span><span class=\"s1\">&#39;i&#39;</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">pg_total_relation_size</span><span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">relname</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"k\">size</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">idxsize</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"n\">total</span>\n<span class=\"c1\">-----------------------+------+---------+---------+---------</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">650</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">757</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_accounts_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_history</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">3112</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">3112</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">112</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_tellers_pkey</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"w\"> </span><span class=\"n\">pgbench_branches_pkey</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"p\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<h3 id=\"checkpoint\">\u7f13\u5b58,\u540e\u53f0\u5199\u4ee5\u53ca checkpoint<a class=\"headerlink\" href=\"#checkpoint\" title=\"Permanent link\">&para;</a></h3>\n<p>pg_stat_bgwriter \u53ef\u4ee5\u8ba9\u6211\u4eec\u8ffd\u8e2a\u6bcf\u4e2a\u6570\u636e\u9875\u5728\u7f13\u5b58\u5185\u5916\u7684\u6d41\u5411\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8be5\u89c6\u56fe\u56de\u7b54\u4e0b\u9762\u7684\u95ee\u9898\uff1a</p>\n<ul>\n<li>\n<p>\u6267\u884c checkpoint \u7684\u65f6\u95f4\u4e2d\uff0c\u57fa\u4e8e\u6d3b\u52a8\u7684\u8bf7\u6c42\u5360\u6bd4\u591a\u5c11\uff0c\u57fa\u4e8e\u65f6\u95f4\u95f4\u9694\u7684\u6bd4\u4f8b\u53c8\u662f\u591a\u5c11\uff1f</p>\n</li>\n<li>\n<p>\u5e73\u5747 checkpoint \u5199\u51fa\u591a\u5c11\u6570\u636e\uff1f</p>\n</li>\n<li>\n<p>\u5199\u51fa\u7684\u6570\u636e\u4e2d\uff0ccheckpoint \u548c\u540e\u53f0\u5199\u5206\u522b\u5360\u6bd4\u591a\u5c11\uff1f</p>\n</li>\n</ul>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">#</span><span class=\"k\">SELECT</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">block_size</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">       </span><span class=\"n\">checkpoints_req</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">avg_checkpoint_write</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">block_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">       </span><span class=\"n\">buffers_backend</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">total_written</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">      </span><span class=\"n\">buffers_backend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoint_write_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffers_backend</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">        </span><span class=\"n\">buffers_backend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">backend_write_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">*</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter</span><span class=\"p\">,(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">current_setting</span><span class=\"p\">(</span><span class=\"s1\">&#39;block_size&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">integer</span><span class=\"p\">)</span>\n<span class=\"w\">     </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">block_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"p\">;</span>\n\n<span class=\"o\">-</span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">]</span><span class=\"c1\">---------+------------------------------</span>\n<span class=\"n\">checkpoints_req_pct</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">avg_checkpoint_write</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">742</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"n\">total_written</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4588</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"n\">checkpoint_write_pct</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">43</span>\n<span class=\"n\">backend_write_pct</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">56</span>\n<span class=\"n\">checkpoints_timed</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2713</span>\n<span class=\"n\">checkpoints_req</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">38</span>\n<span class=\"n\">checkpoint_write_time</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2475096</span>\n<span class=\"n\">checkpoint_sync_time</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">253253</span>\n<span class=\"n\">buffers_checkpoint</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">255206</span>\n<span class=\"n\">buffers_clean</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">maxwritten_clean</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">buffers_backend</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">332040</span>\n<span class=\"n\">buffers_backend_fsync</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">buffers_alloc</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">503829</span>\n<span class=\"n\">stats_reset</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2012</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">19</span><span class=\"p\">.</span><span class=\"mi\">529427</span><span class=\"o\">+</span><span class=\"mi\">08</span>\n<span class=\"n\">block_size</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">8192</span>\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u6765\u770b\uff0c\u53ea\u6709 1%\u7684 checkpoint \u662f\u56e0\u4e3a\u8fbe\u5230\u4e86 WAL \u8fbe\u5230\u4e86\u9700\u8981\u5199\u51fa\u7684\u8981\u6c42\uff0c\u800c\u7edd\u5927\u90e8\u5206 checkpoint \u90fd\u662f\u56e0\u4e3a checkpoint_timeout \u53c2\u6570\u6240\u8bbe\u7f6e\u7684\n\u95f4\u9694\u65f6\u95f4\u6765\u4e34\u800c\u6267\u884c\u7684\u3002</p>\n<p>checkpoint \u5e73\u5747\u5199\u51fa\u7684\u6570\u636e\u662f 742KB\uff0c\u76f8\u5f53\u5c0f\u3002</p>\n<p>56%\u7684\u6570\u636e\u5199\u51fa\u662f\u540e\u53f0\u5199\u8fdb\u7a0b\uff0c\u8fd9\u6697\u793a\u8fd9\u7cfb\u7edf\u7684\u914d\u7f6e\u8fd8\u4e0d\u8db3\u591f\u597d\uff0c\u6211\u4eec\u5e94\u8be5\u66f4\u591a\u4f7f\u7528 checkpoint \u6765\u5199\u51fa\u6570\u636e\u3002\u53d1\u751f\u8fd9\u4e2a\u60c5\u51b5\u7684\u539f\u56e0\u53ef\u80fd\u662f shared_buffers \u914d\u5f97\u5c0f\u4e86\u70b9\u3002</p>\n<h3 id=\"pg_stat_bgwriter\">\u4fdd\u5b58 pg_stat_bgwriter \u5feb\u7167<a class=\"headerlink\" href=\"#pg_stat_bgwriter\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u4f7f\u4e0a\u8ff0\u7edf\u8ba1\u6570\u636e\u66f4\u6709\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u671f\u4fdd\u5b58\u5feb\u7167\uff0c\u6211\u4eec\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u8868\uff0c\u7136\u540e\u628a\u5feb\u7167\u5199\u5165\u8868\u5373\u53ef\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter_snapshot</span><span class=\"w\"> </span><span class=\"k\">as</span>\n<span class=\"w\">          </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">current_timestamp</span><span class=\"p\">,</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter</span><span class=\"p\">;</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">pgbench</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter_snapshot</span>\n<span class=\"w\">         </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">current_timestamp</span><span class=\"p\">,</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>\u6211\u4eec\u5e94\u8be5\u81f3\u5c11\u4fdd\u5b58\u4e00\u4e2a\u5c0f\u65f6\u7684\u5feb\u7167\u4fe1\u606f\uff0c\u4e00\u5929\u66f4\u597d\u3002\u8fd9\u6837\u6211\u4eec\u624d\u6709\u53ef\u80fd\u901a\u8fc7\u8fd9\u4e9b\u5feb\u7167\u83b7\u5f97\u4e00\u4e9b\u66f4\u6709\u7528\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">SELECT</span>\n<span class=\"w\">  </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">date_trunc</span><span class=\"p\">(</span><span class=\"s1\">&#39;minute&#39;</span><span class=\"p\">,</span><span class=\"k\">start</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"k\">start</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">date_trunc</span><span class=\"p\">(</span><span class=\"s1\">&#39;second&#39;</span><span class=\"p\">,</span><span class=\"n\">elapsed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">date_trunc</span><span class=\"p\">(</span><span class=\"s1\">&#39;second&#39;</span><span class=\"p\">,</span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"w\">    </span><span class=\"n\">avg_checkpoint_interval</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">     </span><span class=\"n\">buffers_backend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoint_write_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">buffers_backend</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">       </span><span class=\"n\">buffers_backend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">backend_write_pct</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">block_size</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">      </span><span class=\"n\">checkpoints_req</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">avg_checkpoint_write</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">block_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">+</span>\n<span class=\"w\">      </span><span class=\"n\">buffers_backend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">int8</span><span class=\"p\">))</span>\n<span class=\"w\">          </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">written_per_sec</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pg_size_pretty</span><span class=\"p\">(</span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">block_size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffers_alloc</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span><span class=\"w\"> </span><span class=\"k\">FROM</span>\n<span class=\"w\">      </span><span class=\"n\">elapsed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">int8</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">alloc_per_sec</span>\n<span class=\"k\">FROM</span>\n<span class=\"p\">(</span><span class=\"w\"> </span><span class=\"k\">SELECT</span>\n<span class=\"w\">  </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"k\">start</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_timed</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">checkpoints_req</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">checkpoints_req</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">buffers_checkpoint</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_checkpoint</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">buffers_clean</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_clean</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">maxwritten_clean</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">maxwritten_clean</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">maxwritten_clean</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">buffers_backend</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">buffers_backend</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_backend</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">buffers_alloc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">buffers_alloc</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">buffers_alloc</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">cast</span><span class=\"p\">(</span><span class=\"n\">current_setting</span><span class=\"p\">(</span><span class=\"s1\">&#39;block_size&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"nb\">integer</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">block_size</span>\n<span class=\"w\">  </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter_snapshot</span><span class=\"w\"> </span><span class=\"n\">one</span>\n<span class=\"w\">  </span><span class=\"k\">INNER</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_stat_bgwriter_snapshot</span><span class=\"w\"> </span><span class=\"n\">two</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"p\">.</span><span class=\"n\">now</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">bgwriter_diff</span>\n<span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">checkpoints_timed</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">checkpoints_req</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"k\">start</span><span class=\"w\">                   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2010</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"p\">:</span><span class=\"mi\">52</span><span class=\"p\">:</span><span class=\"mi\">00</span>\n<span class=\"n\">elapsed</span><span class=\"w\">                 </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">:</span><span class=\"mi\">54</span>\n<span class=\"n\">avg_checkpoint_interval</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">03</span><span class=\"p\">:</span><span class=\"mi\">34</span>\n<span class=\"n\">checkpoints_req_pct</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">80</span>\n<span class=\"n\">checkpoint_write_pct</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">85</span>\n<span class=\"n\">backend_write_pct</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">14</span>\n<span class=\"n\">avg_checkpoint_write</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"n\">MB</span>\n<span class=\"n\">written_per_sec</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">94</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n<span class=\"n\">alloc_per_sec</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"n\">kB</span>\n</code></pre></div>\n<p>\u4ece\u8f93\u51fa\u6765\u770b\uff0c\u6709 80%\u7684 checkpoint \u88ab\u8c03\u7528\uff0c\u56e0\u4e3a\u7cfb\u7edf\u5199\u6ee1\u4e86 WAL,checkpoint \u7684\u8c03\u7528\u5e73\u5747\u95f4\u9694\u65f6\u95f4\u4e3a 3.5 \u5206\u949f\uff0c\u76f8\u5f53\u9891\u7e41\u3002\u5e78\u8fd0\u7684\u662f\uff0c\u5927\u90e8\u5206\u7f13\u5b58\u90fd\u88ab\u5199\u51fa\uff1b\n85%\u7684\u7f13\u5b58\u6709 checkpoint \u5199\u51fa\uff0c\u8fd9\u5f88\u597d\uff0c\u56e0\u4e3a checkpoint \u5199\u7b97\u662f\u6700\u6709\u6548\u7387\u7684\u4e00\u79cd\u3002\u6bcf\u4e00\u4e2a checkpint \u5e73\u5747\u5199\u51fa 17MB \u6570\u636e\u3002\u4f46\u662f\u4f60\u8ba1\u7b97\u6240\u6709\u7684\u5199\u64cd\u4f5c\uff0c\u8fd4\u73b0\u5199\u5230\u78c1\u76d8\u7684\u901f\u7387\n\u53ea\u6709 94kB/s\uff0c\u8fd9\u76f8\u5f53\u4f4e\u3002\u5728\u8bfb\u65b9\u9762\uff0c\u7f13\u5b58\u4e2d 13kB/s \u7684\u901f\u5ea6\u88ab\u6570\u636e\u5e93\u5206\u914d\u7528\u6765\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\u3002</p>\n<p>\u5bf9\u4e8e\u4e00\u4e2a\u6301\u7eed 46 \u5206\u949f\u7684\u5feb\u7167\u8f93\u51fa\u5982\u4e0b,\u8fd9\u4e2a\u9636\u6bb5\u57fa\u672c\u4e0a\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001:</p>\n<div class=\"highlight\"><pre><span></span><code>start                   | 2010-04-09 20:10:00\nelapsed                 | 00:46:26\navg_checkpoint_interval | 00:05:09\ncheckpoints_req_pct     | 0\ncheckpoint_write_pct    | 100\nbackend_write_pct       | 0\navg_checkpoint_write    | 910 bytes\nwritten_per_sec         | 3 bytes\nalloc_per_sec           | 0 bytes\n</code></pre></div>\n<p>\u6ce8\u610f\u5230 checkpoint \u7684\u5e73\u5747\u95f4\u9694\u662f 5 \u5206\u949f\uff0c\u800c\u8fd9\u6070\u597d\u662f checkpoint_timeout \u503c\uff0c\u8fd9\u8bf4\u660e\u8fd9\u4e9b checkpoint \u5b8c\u5168\u662f\u7531\u8d85\u65f6\u9a71\u52a8\u3002</p>\n<p>\u8fd9\u91cc\u7684 alloc_per_sec \u6bd4\u7387\u5e76\u4e0d\u6b63\u597d\u540c\u7b49\u4e8e\u4ece OS \u7f13\u5b58\u7684\u8bfb\u53d6\u7387\uff0c\u4e0d\u8fc7\u5b83\u6697\u793a\u4e86\u5185\u90e8\u7f13\u5b58\u88ab\u91cd\u7528\u7684\u9891\u7387\u3002</p>\n<p>written_per_sec \u503c\u662f\u628a\u6570\u636e\u5e93\u8868\u548c\u7d22\u5f15\u5199\u5165\u5230\u78c1\u76d8\u7684\u5e73\u5747\u503c\uff0c\u5b83\u5e94\u8be5\u975e\u5e38\u63a5\u8fd1\u64cd\u4f5c\u7cfb\u7edf\u7cfb\u7edf\u7684\u5e73\u5747\u5199\u5165\u78c1\u76d8\u7684\u6570\u503c\u3002</p>\n<h3 id=\"_45\">\u4f7f\u7528\u540e\u53f0\u5199\u7edf\u8ba1\u8c03\u4f18<a class=\"headerlink\" href=\"#_45\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5229\u7528\u540e\u53f0\u5199\u7edf\u8ba1\u4fe1\u606f\u6765\u8c03\u6574\u548c checkpoint \u4ee5\u53ca\u7f13\u5b58\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\n<p>\u5b9a\u671f\u6536\u96c6 pg_stat_bgwriter \u5feb\u7167\uff0c\u8fd9\u6837\u5c31\u83b7\u5f97\u4e00\u4e2a\u6027\u80fd\u57fa\u7ebf\uff0c\u6b64\u540e\uff0c\u6bcf\u6b21\u4fee\u6539\u53c2\u6570\uff0c\u91cd\u65b0\u4ea7\u751f\u5feb\u7167\uff0c\u8fdb\u884c\u5bf9\u6bd4\u3002\u4f9d\u6b21\u5faa\u73af\uff0c\u627e\u5230\u6700\u4f18\u53c2\u6570</p>\n</li>\n<li>\n<p>\u589e\u52a0 checkpoint_segments \u503c\u76f4\u5230\u51e0\u4e4e\u6240\u6709\u7684 checkpoints \u90fd\u662f\u6309\u8d85\u65f6\u9a71\u52a8\u7684\uff0c\u800c\u4e0d\u662f\u6309 activity \u9a71\u52a8\u3002\u6700\u7ec8\uff0c90%\u4ee5\u4e0a\u5e94\u8be5\u57fa\u4e8e\u8d85\u65f6\n    \u800c avg_checkpoint_interval \u5e94\u8be5\u63a5\u8fd1 5 \u5206\u949f\uff08\u6216\u8005\u662f\u4f60\u8bbe\u7f6e\u7684 checkpoint_timeout \u503c\uff09</p>\n</li>\n<li>\n<p>\u589e\u52a0 shared_buffers \u503c\u5728\u7269\u7406\u5185\u5b58\u7684 25%\u4ee5\u4e0a\uff0c\u800c\u540e\u53c2\u8003\u5feb\u7167\uff0c\u4fee\u6539\u8be5\u53c2\u6570</p>\n</li>\n<li>\n<p>\u5f53\u4f60\u7684\u7cfb\u7edf\u6709\u6548\u7684\u4f7f\u7528\u5927\u7f13\u5b58\u65f6\uff0ccheckpoint(\u4e0d\u662f backends \u6216 background\n    writer)\u6267\u884c\u65f6\uff0c\u7f13\u5b58\u7684\u767e\u5206\u6bd4\u4e5f\u5e94\u8be5\u589e\u52a0\uff0c\u800c\u603b\u7684 I/O\n    written_per_sec \u53c2\u6570\u5e94\u8be5\u4e0b\u964d\u3002\n    \u5982\u679c\u6700\u540e\u662f\u901a\u8fc7\u4fee\u6539 shared_buffers \u6765\u8fbe\u5230\u8fd9\u4e2a\u6807\u51c6\uff0c\u5219\u9700\u8981\u8fd4\u56de\u6b65\u9aa4 3\uff0c\u91cd\u590d\u8fd9\u4e9b\u6b65\u9aa4\uff0c\u77e5\u9053\u6027\u80fd\u66f2\u7ebf\u8d8b\u5e73\u3002</p>\n</li>\n<li>\n<p>\u5982\u679c shared_buffers \u4fee\u6539\u7684\u503c\u4e0d\u662f\u90a3\u4e48\u663e\u8457\uff0c\u5219\u8bf4\u660e\u4e4b\u524d\u7684\u503c\u5bf9\u76ee\u524d\u7684\u5de5\u4f5c\u8d1f\u8377\u8db3\u591f\u4e86\u3002</p>\n</li>\n<li>\n<p>\u73b0\u5728\u4f60\u6709\u4e86\u8f83\u597d\u7684 checkpoint_segements \u548c shared_buffers \u503c\u3002\u5982\u679c\u5199\u51fa\u6570\u636e\u7684\u5927\u90e8\u5206\u90fd\u6765\u81ea buffers_checkpoint\uff0c\u4e14 written_per_sec \u663e\u793a\u7684\u5e73\u5747 I/O \u770b\u4e0a\u53bb\u6bd4\u8f83\u9ad8\uff08\u6216\u8005\u662f\u6267\u884c\u5199\u64cd\u4f5c\u65f6\uff0c\u7cfb\u7edf\u660e\u663e\u663e\u5f97\u6162\uff09\uff0c\n    \u5e94\u8003\u8651\u589e\u52a0 checkpoint_timeout \u503c\uff0c\u5982\u679c\u589e\u52a0\u4e86\uff0c\u5219\u9700\u8981\u91cd\u590d\u4e0a\u8ff0\u6d41\u7a0b\u3002</p>\n</li>\n</ol>\n<h2 id=\"_46\">\u76d1\u63a7\u548c\u8d8b\u52bf\u5206\u6790<a class=\"headerlink\" href=\"#_46\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6570\u636e\u7684\u6027\u80fd\u76f4\u63a5\u548c\u5b83\u5e95\u5c42\u7684\u64cd\u4f5c\u7cfb\u7edf\u6027\u6709\u5173\u8054\uff0c\u800c\u64cd\u4f5c\u7cfb\u7edf\u7684\u6027\u80fd\u53c8\u548c\u5e95\u5c42\u7684\u786c\u4ef6\u6709\u5173\u8054\u3002\u56e0\u6b64\u53ea\u6709\u8fd9\u4e09\u8005\u90fd\u5904\u4e8e\u5de5\u4f5c\u826f\u597d\u7684\u72b6\u6001\uff0c\u624d\u4f1a\u6709\u597d\u7684\u6027\u80fd\u3002</p>\n<p>\u8fd9\u5c31\u9700\u8981\u4f60\u6709\u4e00\u4e2a\u597d\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u7528\u6765\u83b7\u53d6\u6240\u6709\u5c42\u9762\u7684\u6b63\u786e\u4fe1\u606f\uff0c\u7136\u540e\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad\uff0c\u5e76\u4e14\u53ef\u4ee5\u9884\u6d4b\u4ec0\u4e48\u7cfb\u7edf\u7cfb\u7edf\u4f1a\u8fbe\u5230\u5176\u8d1f\u8f7d\u6781\u9650\uff0c\u53c2\u6570\u7684\u6539\u53d8\u662f\u5426\u5bf9\u7cfb\u7edf\u7684\u63d0\u5347\u957f\u751f\u4e86\u6548\u679c\u3002</p>\n<h3 id=\"unix_1\">unix \u76d1\u63a7\u5de5\u5177<a class=\"headerlink\" href=\"#unix_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u91cc\u4e3b\u8981\u4ecb\u7ecd\u4e86 vmstat,iostat \u5de5\u5177\u7684\u4ecb\u7ecd\u548c\u4f7f\u7528\uff0c\u8fd9\u90e8\u5206\u53ef\u4ee5\u53c2\u8003<a href=\"http://blog.wgzhao.com/2012/08/22/some-way-to-io-statistics-on-linux/\">Linux \u4e0b\u7684\u4e00\u4e9b I/O \u7edf\u8ba1\u5de5\u5177</a>\u4e00\u6587</p>\n<h3 id=\"_47\">\u8d85\u8d1f\u8377\u7684\u7cfb\u7edf\u4f8b\u5b50<a class=\"headerlink\" href=\"#_47\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u7ed9\u51fa\u7684\u4f8b\u5b50\u4e2d\uff0c\u6570\u636e\u5e93\u76ee\u5f55\u5bf9\u5e94\u7684\u78c1\u76d8\u5e03\u5c40\u662f:</p>\n<ul>\n<li>\n<p>pg_xlog: /dev/sdf1</p>\n</li>\n<li>\n<p>data: /dev/md0 Linux \u8f6f RAID0\uff0c\u7531 sdc1,sdd1 \u548c sde1 \u7ec4\u6210</p>\n</li>\n</ul>\n<p>\u4e3a\u4e86\u52a0\u5927\u7cfb\u7edf\u7684\u8d1f\u8f7d\uff0c\u6211\u4eec\u8fd8\u662f\u7528 pgbench \u505a\u6d4b\u8bd5\uff0c\u628a scale \u8bbe\u5230 1000\uff0c\u5ba2\u6237\u7aef\u6570\u8bbe\u7f6e\u5230 64:</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>pgbench<span class=\"w\"> </span>-i<span class=\"w\"> </span>-s<span class=\"w\"> </span><span class=\"m\">1000</span><span class=\"w\"> </span>pgbench\n$<span class=\"w\"> </span>pgbench<span class=\"w\"> </span>-j<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"m\">64</span><span class=\"w\"> </span>-T<span class=\"w\"> </span><span class=\"m\">300</span><span class=\"w\"> </span>pgbench\n</code></pre></div>\n<p>\u5728\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u6293\u53d6 vmstat \u4e00\u6bb5\u65f6\u95f4\u7684\u8f93\u51fa:</p>\n<div class=\"highlight\"><pre><span></span><code>procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa\n 2 45      0 128464   5608 2787264    0    0  1462 17739 1586 2984  4  4  0 93\n 0 31      0 125356   5616 2789904    0    0  1232  1384 1591 3020  4  2  0 95\n 0 44      0 121628   5616 2793660    0    0  1712  2152 1984 3953  4  3  0 93\n 0 39      0 117164   5616 2797724    0    0  2144  1856 2270 4414  4  2  0 94\n 0 43      0 112452   5616 2802036    0    0  2128  2224 2252 4514  4  3  0 93\n 0 53      0 107376   5620 2806572    0    0  2576  2101 2060 4149  4  4  0 93\n 0  1      0 119412   5520 2791864    0    0  1322 17266 2028 3780  4  3 13 81\n 0  3      0 119048   5552 2789328    0    0    72  2426  801 1151  2  2 36 61\n 0 26      0 103904   5628 2809296    0    0  1400  1396 2048 3909  5  3  0 93\n 0 56      0 128208   5516 2785068    0    0  1808  1952 1546 3110  3  3 10 84\n 0 59      0 124148   5516 2789132    0    0  2008  2240 2251 4595  3  2  0 95\n</code></pre></div>\n<p>\u4ece\u8f93\u51fa\u6765\u770b\uff0ccs \u503c\u7684\u663e\u8457\u964d\u4f4e\u4f7f\u5f97\u6574\u4e2a\u7cfb\u7edf\u7684\u541e\u5410\u4e5f\u4e0b\u6765\u4e86\u3002\u8fd9\u91cc\u6709\u70b9\u56f0\u60d1\u7684\u662f\uff0c\u4e0e\u6b64\u540c\u65f6\uff0cwa \u503c\u4e5f\u4e0b\u6765\u4e86\u4e5f\u4e0b\u6765\u4e86\uff0c\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u573a\u666f\uff0c\u5f53\u7cfb\u7edf\u8d1f\u8f7d\u592a\u9ad8\u65f6\uff0c\u5b83\u4f1a\u56e0\u4e3a\n\u7d22\u8d44\u6e90\u7ade\u4e89\u7684\u539f\u56e0\u800c\u62d2\u7edd\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u3002\u6211\u4eec\u4ece cs \u7684\u6700\u4f4e\u70b9(1151)\u4e5f\u80fd\u770b\u51fa\uff0c\u5176\u5ba2\u6237\u7aef\u8fdb\u7a0b\u975e\u5e38\u5c11\uff0c\u4ec5\u6709 1 \u4e2a(\u5bf9\u5e94\u884c\u7684 b \u5217\u663e\u793a)\u3002\u8fd9\u5f88\u6709\u53ef\u80fd\u7684\u539f\u56e0\u662f\u78c1\u76d8\u63a7\u5236\u5668\u7684 cache \u5df2\u7ecf\u586b\u6ee1\u4e86\uff0c\u5ba2\u6237\u7aef\u90fd\u5728\u7b49\u5f85\nWAL \u6570\u636e\u5199\u56de\u78c1\u76d8\u3002</p>\n<p>\u6709\u65f6\uff0c\u7cfb\u7edf\u6162\u6709\u53ef\u80fd\u5355\u7eaf\u662f I/O \u541e\u5410\u539f\u56e0\uff0c\u6bd4\u5982\u50cf\u4e0b\u9762\u7684\u8f93\u51fa\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code># iostat \u2013x 5\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           5.21    0.00    2.80   91.74    0.25    0.00\nDevice rsec/s    wsec/s avgrq-sz avgqu-sz   await  svctm  %util\nsdc1  2625.60   2057.60    14.67    38.79  101.47   3.14 100.08\nsdd1  2614.40   2000.00    14.90    57.96  162.95   3.23 100.08\nsde1  2736.00   1963.20    14.64    48.50  135.26   3.12 100.00\nmd0   7916.80   7206.40    10.60     0.00    0.00   0.00   0.00\nsdf1     0.00  22190.40    50.20     0.84    1.79   1.34  59.20\n</code></pre></div>\n<p>WAL \u7684\u5199\u901f\u5927\u7ea6 11MB/s\u3002\u4e0e\u6b64\u540c\u65f6\uff0c\u6570\u636e\u5e93\u78c1\u76d8(md0)\u5229\u7528\u7387\u8fbe\u5230 100%\uff0c\u7136\u800c\u8bfb\u5199\u901f\u5ea6\u53ea\u6709 8MB/s(\u8bfb+\u5199)\uff0c\u8fd9\u5f88\u53ef\u80fd\u6b64\u65f6\u6570\u636e\u5e93\u6709\u5f88\u7e41\u91cd\u968f\u673a I/O\uff0c\n\u800c\u5e95\u5c42\u78c1\u76d8\u7684\u968f\u673a I/O \u80fd\u529b\u4e5f\u5c31\u662f 2MB/s \u7684\u6837\u5b50\u3002</p>\n<p>\u8fd9\u4e2a\u6570\u636e\u5e93\u8fc7\u7a0b\u5f88\u6709\u53ef\u80fd\u662f checkpoint \u540c\u6b65\u9636\u6bb5\uff0c\u5f53\u5927\u91cf\u7684\u968f\u673a I/O \u5199\u6ee1\u78c1\u76d8\u7f13\u5b58\u540e\uff0c\u5f00\u59cb\u5f3a\u5236\u5199\u5165\u5230\u78c1\u76d8\u3002</p>\n<p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u770b\u4e0b\u9762\u66f4\u6781\u7aef\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u628a scale \u8bbe\u7f6e\u5230 4000</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>pgbench<span class=\"w\"> </span>-i<span class=\"w\"> </span>-s<span class=\"w\"> </span><span class=\"m\">4000</span><span class=\"w\"> </span>pgbench\n$<span class=\"w\"> </span>pgbench<span class=\"w\"> </span>-j<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"m\">64</span><span class=\"w\"> </span>-T<span class=\"w\"> </span><span class=\"m\">300</span><span class=\"w\"> </span>pgbench\n</code></pre></div>\n<p>\u6267\u884c\u671f\u95f4\uff0c\u6293\u53d6\u4e00\u6bb5\u65f6\u95f4\u7684 vmstat \u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code># vmstat 1\nprocs ----io---- --system--- -----cpu-------\n\ufffcr  b   bi    bo    in    cs    us sy id  wa st\n1  63  5444  9864   8576 18268  4   3  0   92  0\n0  42  4784  13916  7969 16716  4   2  3   90  0\n0  59  464   4704   1279  1695  0   0 25   75  0\n0  54  304   4736   1396  2147  0   0 25   74  0\n0  42  264   5000   1391  1796  0   0 10   90  0\n0  42  296   4756   1444  1996  1   0 10   89  0\n0  29  248   5112   1331  1720  0   0 25   75  0\n0  47  368   4696   1359  2113  0   0 23   76  0\n1  48  344   5352   1287  1875  0   0  0   100 0\n0  64  2692  12084  5604  9474  8   2  0   90  0\n1  63  5376  9944   8346 18003  4   3  20  74  0\n0  64  5404  10128  8890 18847  4   3  25  67  0\n</code></pre></div>\n<p>\u8fd9\u91cc\u6709 8 \u79d2\u7684\u65f6\u95f4\u95f4\u9694\u5185\uff0c\u7cfb\u7edf\u6027\u80fd\u4e25\u91cd\u4e0b\u964d\u3002cpu \u8017\u65f6\u4e2d\uff0c\u51e0\u4e4e\u6ca1\u6709 user\ntime\u3002\u8fd9\u7b26\u5408\u6240\u6709\u5ba2\u6237\u7aef\u6574\u7b49\u5f85\u67d0\u4e9b\u8d44\u6e90\u7684\u573a\u666f\u3002\u8fd9\u4e2a\u573a\u666f\u51fa\u73b0\u7684\u539f\u56e0\n\u5728\u8fd9\u513f\u5f88\u663e\u7136\uff0cwa \u503c\u5f88\u9ad8\uff0c\u751a\u81f3\u5230 100%\uff0c\u8fd9\u8bf4\u660e\u670d\u52a1\u5668\u65e0\u6cd5\u8ddf\u4e0a\u78c1\u76d8 I/O \u52a0\u8f7d\u3002</p>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 iostat \u7684\u6269\u5c55\u9009\u9879\u67e5\u8be2\u6b64\u65f6\u78c1\u76d8\u8d1f\u8f7d\u5728\u505a\u4e9b\u4ec0\u4e48\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code># iostat \u2013x 5\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           2.35    0.00    1.85   85.49    0.15   10.16\nDevice rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util\nsdc1  2310.40  1169.60    14.63    39.85  147.59   4.21 100.00\nsdd1  2326.40  1216.00    14.53    71.41  264.60   4.10 100.00\nsde1  2438.40  1230.40    14.77    47.88  157.12   4.01  99.60\nmd0   7044.80  4820.80    11.12     0.00    0.00   0.00   0.00\nsdf1     0.00 19040.00    70.31     4.20   15.31   2.10  56.88\n</code></pre></div>\n<p>\u8f93\u51fa\u663e\u793a\u8bfb\u5199\u901f\u5ea6\u5f88\u4f4e\uff0c\u4f46\u662f\u78c1\u76d8\u5229\u7528\u7387\u8fbe\u5230\u4e86 100%\uff0c\u6ce8\u610f await \u6307\u6807\uff0c\u8fd9\u4e48\u9ad8\u7684\u503c\u8868\u660e\u78c1\u76d8\u7b49\u5f85\u65f6\u95f4\u8fc7\u957f\uff0c\u8bf4\u660e\u78c1\u76d8\u5bfb\u9053\u65f6\u95f4\u5360\u6bd4\u5f88\u5927\uff0c\u56e0\u800c\u53ef\u4ee5\u63a8\u65ad\n\u968f\u673a\u8bfb\u5199\u5360\u6bd4\u5f88\u9ad8\u3002</p>\n<h3 id=\"windows\">windows \u76d1\u63a7\u5de5\u5177<a class=\"headerlink\" href=\"#windows\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4efb\u52a1\u7ba1\u7406\u5668\u662f Windows \u7cfb\u7edf\u4e0b\u6700\u7b80\u5355\u548c\u5e38\u7528\u7684\u7cfb\u7edf\u76d1\u63a7\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u7c7b\u4f3c UNIX\ntop \u5de5\u5177\u7684\u8f93\u51fa\u89c6\u56fe\u3002</p>\n<p>\u5982\u679c\u9700\u8981\u529f\u80fd\u5f3a\u5927\u4e00\u70b9\u7684\uff0c\u53ef\u4ee5\u4ece\u5fae\u8f6f\u5185\u90e8\u5de5\u5177\u7bb1\u4e0b\u8f7d<a href=\"http://technet.microsoft.com/en-us/sysinternals/bb896653\">\u8fdb\u7a0b\u6d4f\u89c8\u5de5\u5177</a>\u4ee5\u53ca\n<a href=\"http://technet.microsoft.com/en-us/sysinternals/bb896645\">\u8fdb\u7a0b\u76d1\u63a7\u5de5\u5177</a>\u3002\u76f8\u5173\u7528\u6cd5\u53ef\u4ee5\u53c2\u8003\u5de5\u5177\u81ea\u5e26\u7684\u624b\u518c\u3002</p>\n<p>\u5982\u679c\u9700\u8981\u4fdd\u5b58\u8fd9\u4e9b\u76d1\u63a7\u4fe1\u606f\uff0c\u7c7b\u4f3c UNIX \u7684 sar \u5de5\u5177\u4e00\u6837\uff0c\u5fae\u8f6f\u4e5f\u63d0\u4f9b\u8be6\u7ec6\u7684\u6307\u5357\uff0c\u4e0d\u540c\u7cfb\u7edf\u7248\u672c\u63d0\u4f9b\u7684\u65b9\u5f0f\u4e0d\u540c\uff0c\u5206\u5217\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\n<p>Windows 2000,XP,Server 2003:\n  <a href=\"http://support.microsoft.com/kb/248345\">http://support.microsoft.com/kb/248345</a></p>\n</li>\n<li>\n<p>Vista:\n  <a href=\"http://technet.microsoft.com/en-us/library/cc722173(WS.10).aspx\">http://technet.microsoft.com/en-us/library/cc722173(WS.10).aspx</a></p>\n</li>\n<li>\n<p>Windows 7,Windows Server 2008 R2:\n  <a href=\"http://technet.microsoft.com/en-us/library/dd744567(WS.10).aspx\">http://technet.microsoft.com/en-us/library/dd744567(WS.10).aspx</a></p>\n</li>\n</ul>\n<h3 id=\"_48\">\u8d8b\u52bf\u5206\u6790\u8f6f\u4ef6<a class=\"headerlink\" href=\"#_48\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5217\u4e3e\u5982\u4e0b\uff0c\u5177\u4f53\u7684\u7528\u6cd5\u53c2\u8003\u5bf9\u5e94\u5de5\u5177\u7684\u95ee\u9898\uff1a</p>\n<ul>\n<li>\n<p>MRTG,RRDTool:\n  \u8fd9\u4e24\u4e2a\u7b97\u662f\u57fa\u7840\u5de5\u5177\uff0c\u7528\u4e8e\u6570\u636e\u7684\u5c55\u73b0\uff0c\u53ef\u4f5c\u4e3a\u5176\u4ed6\u8f6f\u4ef6\u7684\u9644\u52a0\u7ec4\u4ef6</p>\n</li>\n<li>\n<p>Nagios:\n  \u6700\u5e38\u7528\u7684\u76d1\u63a7 PostgreSQL \u7684\u5de5\u5177\uff0c\u5185\u7f6e\u4e86\u5bf9 PostgreSQL \u7684\u76d1\u63a7\u63d2\u4ef6<a href=\"http://bucardo.org/wiki/Check_postgres\">check_postgres</a></p>\n</li>\n<li>\n<p>Cacti:\n  \u4e5f\u662f\u975e\u5e38\u6d41\u884c\u7684\u5f00\u6e90\u76d1\u63a7\u8f6f\u4ef6\uff0c\u5b83\u4e25\u91cd\u4f9d\u8d56 web \u5e94\u7528\u6280\u672f\u4ee5\u53ca RRDTool \u5de5\u5177\uff0c\u76ee\u524d\u5b83\u5185\u7f6e\u7684 PostgreSQL \u76d1\u63a7\u5de5\u5177\u8fd8\u6bd4\u8f83\u7c97\u9020\uff0c\u4e14\u8fd8\u5728\u5f00\u53d1\u4e2d\u3002\u8be6\u7ec6\u7684\u53ef\u4ee5\n  \u53c2\u8003\u8fd9\u4e2a\u6587\u6863<a href=\"http://wiki.postgresql.org/wiki/Cacti\">http://wiki.postgresql.org/wiki/Cacti</a></p>\n</li>\n<li>\n<p>Munin:\n  \u76f8\u6bd4 Nagios \u548c Cacti\uff0cMunin \u66f4\u5c0f\u800c\u4e14\u66f4\u65b0\uff0c\u5b83\u91c7\u7528\u4e86\u548c Cacti \u76f8\u540c\u7684 RRDTool \u6570\u636e\u5206\u6790\u7ed3\u6784\uff0c\u5b83\u8fd8\u53ef\u4ee5\u96c6\u6210\u5230 Nagios \u7684\u62a5\u8b66\u7ed3\u6784\u4e2d\u3002\u9488\u5bf9 PostgreSQL \u7684\u76d1\u63a7\u63d2\u4ef6\n  \u662f<a href=\"http://muninpgplugins.projects.postgresql.org/\">http://muninpgplugins.projects.postgresql.org/</a></p>\n</li>\n<li>\n<p>pgstatspack:\n  \u8fd9\u7b97\u662f\u9488\u5bf9 PostgreSQL \u7684\u4e00\u4e2a\u7ec4\u4ef6\u5305\uff0c\u5b83\u7684\u529f\u80fd\u7c7b\u4f3c pg_stat_bgwriter \u8bd5\u56fe--\u7528\u4e8e\u4fdd\u5b58 PostgreSQL \u5b9a\u671f\u7684\u7edf\u8ba1\u563b\u563b\u5230\u6570\u636e\u5e93\u8868\u91cc--\u4ee5\u4fbf\u4ee5\u540e\u5206\u6790\u3002\u5b83\u7684\u8bbe\u8ba1\u6765\u6e90\u4e8e\n  \u9488\u5bf9 Oracle \u7684\u4e00\u4e2a\u975e\u5e38\u6d41\u7a0b\u7684\u5de5\u5177\u5305 statspack\u3002\u53ef\u4ee5\u901a\u8fc7<a href=\"http://pgstatspack.projects.postgresql.org/\">\u5b98\u65b9\u7f51\u7ad9</a>\u4e86\u89e3\u66f4\u591a\uff0c\u8fd9\u91cc\u6709\u4e00\u7bc7\u4e0d\u9519\u7684<a href=\"http://www.fuzzy.cz/en/articles/db-tuning-using- pgstatspack/\">\u4ecb\u7ecd\u6587\u7ae0</a>\u3002</p>\n</li>\n<li>\n<p>Zenoss:\n  Zenoss \u76f8\u6bd4\u4e0a\u9762\u63d0\u5230\u7684\u4ea7\u54c1\u914d\u7f6e\u8d77\u6765\u9ebb\u70e6\u4e00\u70b9\uff0c\u5b83\u7684\u6838\u5fc3\u662f\u4e00\u5957\u5f00\u6e90\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u516c\u53f8\u4e5f\u63d0\u4f9b\u4e86\u5546\u4e1a\u6388\u6743\u7684\u4f01\u4e1a\u7248\u3002\u5b83\u901a\u8fc7\u79f0\u4e3a Zenpack \u7684\u6346\u7ed1\u6269\u5c55\u7ec4\u5efa\u6765\n  \u63d0\u4f9b\u5bf9\u670d\u52a1\u63d0\u4f9b\u76d1\u63a7\u548c\u5206\u6790\u529f\u80fd\u3002\u6700\u65b0\u53d1\u5e03\u7684 PostgreSQL\n  ZenPack \u53ef\u4ee5\u4ece\u4e0b\u9762\u7684\u94fe\u63a5\u627e\u5230\uff1a<a href=\"http://community.zenoss.org/docs/DOC-3389\">http://community.zenoss.org/docs/DOC-3389</a></p>\n</li>\n<li>\n<p>Hyperic HQ:\n  \u5546\u4e1a\u4ea7\u54c1\uff0c\u96c6\u6210\u4e86 PostgreSQL \u76d1\u63a7,\u4f46\u652f\u6301\u7684\u7248\u672c\u5f88\u4f4e\uff0c\u76ee\u524d\u4ec5\u652f\u6301\u5230 8.3\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc<a href=\"http://www.hyperic.com/products/postgresql-monitoring\">http://www.hyperic.com/products/postgresql-monitoring</a></p>\n</li>\n</ul>\n<h3 id=\"_49\">\u603b\u7ed3<a class=\"headerlink\" href=\"#_49\" title=\"Permanent link\">&para;</a></h3>\n<h2 id=\"_50\">\u8fde\u63a5\u6c60\u548c\u7f13\u5b58<a class=\"headerlink\" href=\"#_50\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"_51\">\u8fde\u63a5\u6c60<a class=\"headerlink\" href=\"#_51\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fde\u63a5\u6c60\u4f4d\u4e8e\u5e94\u7528\u7a0b\u5e8f\u548c\u6570\u636e\u5e93\u4e2d\u95f4\uff0c\u8fde\u63a5\u5230\u6570\u636e\u5e93\u7684\u4f1a\u8bdd\u6570\u56fa\u5b9a\uff0c\u4e00\u822c\u4f4e\u4e8e 100\uff0c\u8fd0\u884c\u671f\u95f4\uff0c\u8fd9\u4e9b\u8fde\u63a5\u4e00\u76f4\u90fd\u4fdd\u6301\u3002\u5f53\u5e94\u7528\u7a0b\u5e8f\u6709\u65b0\u7684\u8bf7\u6c42\u65f6\uff0c\u8fde\u63a5\u6c60\u7684\u8fde\u63a5\u53ef\u4ee5\u88ab\u91cd\u7528\u3002\nPostgreSQL \u91cc\u7684 DISCARD\nALL \u547d\u4ee4\u53ef\u4ee5\u5237\u65b0\u4e00\u4e2a\u65b0\u8fde\u63a5\u3002\u5f53\u5ba2\u6237\u7aef\u65ad\u5f00\u65f6\uff0c\u8fde\u63a5\u6c60\u53ea\u662f\u91cd\u7f6e\u4f1a\u8bdd\uff0c\u5e76\u4e0d\u5b9e\u9645\u4ece\u6570\u636e\u5e93\u65ad\u5f00\u3002</p>\n<p>\u8fde\u63a5\u6c60\u7684\u6570\u91cf\u5728\u7edd\u5927\u90e8\u5206\u573a\u666f\u4e0b\u4f9d\u8d56\u4e8e CPU \u7684\u6838\u6570\u3001\u6570\u636e\u5e93\u4f7f\u7528\u591a\u5c11\u5185\u5b58\u4f5c\u4e3a\u7f13\u5b58\u4ee5\u53ca\u5e95\u5c42\u78c1\u76d8\u7684\u901f\u5ea6\u3002</p>\n<p>\u5927\u90e8\u5206\u7528\u6237\u8ba4\u4e3a\u6700\u4f73\u7684\u8fde\u63a5\u6c60\u6570\u91cf\u5728 CPU \u6838\u6570\u7684 2 \u5230 3 \u500d\u4e2d\u95f4\uff0c\u5982\u679c\u4f60\u7cfb\u7edf\u6240\u5e26\u7684\u78c1\u76d8\u5f88\u591a\uff0c\u53ef\u4ee5\u8003\u8651\u6bd4\u8fd9\u4e2a\u6570\u5927\u4e00\u70b9\u3002</p>\n<p>\u4e00\u822c\u7684\u4e00\u4e2a\u8fed\u4ee3\u6280\u672f\u5c31\u662f\u5148\u628a\u8fde\u63a5\u6570\u8bbe\u7f6e\u4e3a 100\uff0c\u7136\u540e\u6839\u636e\u7cfb\u7edf\u7684\u8d1f\u8f7d\u505a\u8c03\u6574\u3002</p>\n<h4 id=\"pgpool-ii\">pgpool-II<a class=\"headerlink\" href=\"#pgpool-ii\" title=\"Permanent link\">&para;</a></h4>\n<p><a href=\"http://www.pgpool.net/mediawiki/index.php/Main_Page\">pgpool</a>\u662f PostgreSQL \u4e0a\u6700\u8001\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\uff0c\u76ee\u524d\u8fd8\u5728\u6301\u7eed\u5f00\u53d1\u4e2d\u3002pgpool-II \u76f8\u6bd4\u539f\u6765\u7684\u7248\u672c\u5728\u5404\u65b9\u9762\u90fd\u6709\u4e86\u6539\u8fdb\u3002</p>\n<p>\u5b83\u7684\u4e3b\u8981\u76ee\u7684\u4e0d\u4ec5\u4ec5\u662f\u505a\u8fde\u63a5\u6c60\uff0c\u5b83\u8fd8\u53ef\u4ee5\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u4ee5\u53ca\u590d\u5236\u76f8\u5173\u7684\u529f\u80fd\u3002\u5b83\u751a\u81f3\u8fd8\u652f\u6301\u67d0\u4e9b\u5e76\u884c\u67e5\u8be2\u8bbe\u7f6e\u3002\u4ee5\u4e0b\u662f\u5b83\u63d0\u4f9b\u7684\u4e00\u4e9b\u529f\u80fd\u7684\u63cf\u8ff0\uff1a</p>\n<dl>\n<dt>\u8fde\u63a5\u6c60</dt>\n<dd>\n<p>pgpool-II \u4fdd\u6301\u5df2\u7ecf\u8fde\u63a5\u5230 PostgreSQL \u670d\u52a1\u5668\u7684\u8fde\u63a5\uff0c\n\u5e76\u5728\u4f7f\u7528\u76f8\u540c\u53c2\u6570\uff08\u4f8b\u5982\uff1a\u7528\u6237\u540d\uff0c\u6570\u636e\u5e93\uff0c\u534f\u8bae\u7248\u672c\uff09\n\u8fde\u63a5\u8fdb\u6765\u65f6\u91cd\u7528\u5b83\u4eec\u3002 \u5b83\u51cf\u5c11\u4e86\u8fde\u63a5\u5f00\u9500\uff0c\u5e76\u589e\u52a0\u4e86\u7cfb\u7edf\u7684\u603b\u4f53\u541e\u5410\u91cf\u3002</p>\n</dd>\n<dt>\u590d\u5236</dt>\n<dd>\n<p>pgpool-II \u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a PostgreSQL \u670d\u52a1\u5668\u3002\n\u6fc0\u6d3b\u590d\u5236\u529f\u80fd\u5e76\u4f7f\u5728 2 \u53f0\u6216\u8005\u66f4\u591a PostgreSQL\n\u8282\u70b9\u4e2d\u5efa\u7acb\u4e00\u4e2a\u5b9e\u65f6\u5907\u4efd\u6210\u4e3a\u53ef\u80fd\uff0c\n\u8fd9\u6837\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u53f0\u8282\u70b9\u5931\u6548\uff0c\u670d\u52a1\u53ef\u4ee5\u4e0d\u88ab\u4e2d\u65ad\u7ee7\u7eed\u8fd0\u884c\u3002</p>\n</dd>\n<dt>\u8d1f\u8f7d\u5747\u8861</dt>\n<dd>\n<p>\u5982\u679c\u6570\u636e\u5e93\u8fdb\u884c\u4e86\u590d\u5236\uff08\u53ef\u80fd\u8fd0\u884c\u5728\u590d\u5236\u6a21\u5f0f\u6216\u8005\u4e3b\u5907\u6a21\u5f0f\u4e0b\uff09\uff0c\n\u5219\u5728\u4efb\u4f55\u4e00\u53f0\u670d\u52a1\u5668\u4e2d\u6267\u884c\u4e00\u4e2a SELECT \u67e5\u8be2\u5c06\u8fd4\u56de\u76f8\u540c\u7684\u7ed3\u679c\u3002 pgpool-II\n\u5229\u7528\u4e86\u590d\u5236\u7684\u529f\u80fd\u4ee5\u964d\u4f4e\u6bcf\u53f0 PostgreSQL \u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u3002 \u5b83\u901a\u8fc7\u5206\u53d1\nSELECT \u67e5\u8be2\u5230\u6240\u6709\u53ef\u7528\u7684\u670d\u52a1\u5668\u4e2d\uff0c\u589e\u5f3a\u4e86\u7cfb\u7edf\u7684\u6574\u4f53\u541e\u5410\u91cf\u3002\n\u5728\u7406\u60f3\u7684\u60c5\u51b5\u4e0b\uff0c\u8bfb\u6027\u80fd\u5e94\u8be5\u548c PostgreSQL \u670d\u52a1\u5668\u7684\u6570\u91cf\u6210\u6b63\u6bd4\u3002\n\u8d1f\u8f7d\u5747\u5f88\u529f\u80fd\u5728\u6709\u5927\u91cf\u7528\u6237\u540c\u65f6\u6267\u884c\u5f88\u591a\u53ea\u8bfb\u67e5\u8be2\u7684\u573a\u666f\u4e2d\u5de5\u4f5c\u7684\u6548\u679c\u6700\u597d\u3002</p>\n</dd>\n<dt>\u9650\u5236\u8d85\u8fc7\u9650\u5ea6\u7684\u8fde\u63a5</dt>\n<dd>\n<p>PostgreSQL\n\u4f1a\u9650\u5236\u5f53\u524d\u7684\u6700\u5927\u8fde\u63a5\u6570\uff0c\u5f53\u5230\u8fbe\u8fd9\u4e2a\u6570\u91cf\u65f6\uff0c\u65b0\u7684\u8fde\u63a5\u5c06\u88ab\u62d2\u7edd\u3002\n\u589e\u52a0\u8fd9\u4e2a\u6700\u5927\u8fde\u63a5\u6570\u4f1a\u589e\u52a0\u8d44\u6e90\u6d88\u8017\u5e76\u4e14\u5bf9\u7cfb\u7edf\u7684\u5168\u5c40\u6027\u80fd\u6709\u4e00\u5b9a\u7684\u8d1f\u9762\u5f71\u54cd\u3002\npgpoo-II\n\u4e5f\u652f\u6301\u9650\u5236\u6700\u5927\u8fde\u63a5\u6570\uff0c\u4f46\u5b83\u7684\u505a\u6cd5\u662f\u5c06\u8fde\u63a5\u653e\u5165\u961f\u5217\uff0c\u800c\u4e0d\u662f\u7acb\u5373\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002</p>\n</dd>\n<dt>\u5e76\u884c\u67e5\u8be2</dt>\n<dd>\n<p>\u4f7f\u7528\u5e76\u884c\u67e5\u8be2\u65f6\uff0c\u6570\u636e\u53ef\u4ee5\u88ab\u5206\u5272\u5230\u591a\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\n\u6240\u4ee5\u4e00\u4e2a\u67e5\u8be2\u53ef\u4ee5\u5728\u591a\u53f0\u670d\u52a1\u5668\u4e0a\u540c\u65f6\u6267\u884c\uff0c\u4ee5\u51cf\u5c11\u603b\u4f53\u6267\u884c\u65f6\u95f4\u3002\n\u5e76\u884c\u67e5\u8be2\u5728\u67e5\u8be2\u5927\u89c4\u6a21\u6570\u636e\u7684\u65f6\u5019\u975e\u5e38\u6709\u6548\u3002</p>\n</dd>\n</dl>\n<p>pgpool-II \u4f7f\u7528 PostgreSQL\n\u7684\u524d\u540e\u53f0\u7a0b\u5e8f\u4e4b\u95f4\u7684\u534f\u8bae\uff0c\u5e76\u4e14\u5728\u524d\u540e\u53f0\u4e4b\u95f4\u4f20\u9012\u6d88\u606f\u3002\n\u56e0\u6b64\uff0c\u4e00\u4e2a\uff08\u524d\u7aef\u7684\uff09\u6570\u636e\u5e93\u5e94\u7528\u7a0b\u5e8f\u8ba4\u4e3a pgpool-II \u5c31\u662f\u5b9e\u9645\u7684 PostgreSQL\n\u6570\u636e\u5e93\uff0c \u800c\u540e\u7aef\u7684\u670d\u52a1\u8fdb\u7a0b\u5219\u8ba4\u4e3a pgpool-II \u662f\u5b83\u7684\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002 \u56e0\u4e3a\npgpool-II \u5bf9\u4e8e\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u6765\u8bf4\u662f\u900f\u660e\u7684\uff0c\n\u73b0\u6709\u7684\u6570\u636e\u5e93\u5e94\u7528\u7a0b\u5e8f\u57fa\u672c\u4e0a\u53ef\u4ee5\u4e0d\u9700\u8981\u4fee\u6539\u5c31\u53ef\u4ee5\u4f7f\u7528 pgpool-II \u4e86\u3002</p>\n<h4 id=\"pgbouncer\">pgBouncer<a class=\"headerlink\" href=\"#pgbouncer\" title=\"Permanent link\">&para;</a></h4>\n<p><a href=\"http://pgfoundry.org/projects/pgbouncer/\">p</a>gBouncer \u662f PostgreSQL \u91cc\u80fd\u63d0\u9ad8\u6700\u9ad8\u6548\u7387\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u6700\u521d\u662f Skype \u4f5c\u4e3a\u6570\u636e\u5e93\u6269\u5c55\u529f\u80fd\u5f00\u53d1\u7684\u3002</p>\n<p>pgBouncer \u662f\u5355\u8fdb\u7a0b\u7a0b\u5e8f\uff0c\u9488\u5bf9\u6bcf\u4e2a\u8fde\u63a5\u5e76\u4e0d\u957f\u751f\u65b0\u8fdb\u7a0b\uff0c\u5176\u5e95\u5c42\u67b6\u6784\u4e0a\u4f9d\u8d56 UNIX \u5e73\u53f0\u7684 libevent \u52a8\u6001\u5e93\uff0c\u5176\u5185\u90e8\u7684\u961f\u5217\u7ba1\u7406\u53ef\u4ee5\u914d\u7f6e\uff0c\u4ee5\u907f\u514d\u51fa\u73b0\u8d85\u65f6\u73b0\u8c61\u3002</p>\n<p>pgBouncer \u4f1a\u521b\u5efa pgbouncer \u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u4f7f\u7528\u6807\u51c6\u7684 pgsql \u5de5\u5177\u8fde\u63a5\u5230\u8be5\u5e93\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 SHOW \u547d\u4ee4\u6765\u83b7\u5f97\u6709\u5173\u8fde\u63a5\u6c60\u7684\u5185\u90e8\u4fe1\u606f\u3002\u5176\u7ec8\u7aef\u63a5\u53e3\u63a5\u53d7\u50cf PAUSE\uff0cRESUME \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u63a7\u5236\u8fde\u63a5\u6c60\u3002</p>\n<p>pgBouncer \u7684\u53e6\u5916\u4e00\u4e2a\u7279\u6027\u662f\u5b83\u652f\u6301\u5bf9\u591a\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5668\u7684\u8fde\u63a5\u3002\u8fd9\u5c31\u4f7f\u5f97\u4f60\u7684\u7cfb\u7edf\u8d1f\u8f7d\u6709\u53ef\u80fd\u5206\u6563\u5230\u591a\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5668\u8282\u70b9\u4e0a\u3002</p>\n<p>\u5982\u679c\u4f60\u7684\u6709\u51e0\u767e\u6216\u8005\u4e0a\u5343\u7684\u8fde\u63a5\u6570\uff0c\u4ed6\u4eec\u8d85\u8fc7\u4e86\u4f60\u670d\u52a1\u5668\u4e0a CPU \u7684\u4e2a\u6570\uff0c\u90a3\u4e48 pgBouncer \u662f\u4f60\u7684\u7b2c\u4e00\u8003\u8651\u3002</p>\n<h4 id=\"_52\">\u5e94\u7528\u670d\u52a1\u5668\u8fde\u63a5\u6c60<a class=\"headerlink\" href=\"#_52\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6709\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u5e76\u4e0d\u9700\u8981\u6570\u636e\u5e93\u5c42\u9762\u7684\u8fde\u63a5\u6c60\uff0c\u5b83\u504f\u5411\u4e8e\u4f7f\u7528\u81ea\u5df1\u7684\u8fde\u63a5\u6c60\uff0c\u5927\u90e8\u5206\u6d41\u884c\u7684 Java \u5e94\u7528\u670d\u52a1\uff0c\u5305\u62ec Tomcat,JBoss \u7b49\uff0c\u90fd\u6709\u81ea\u5df1\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\u3002\n\u6bd4\u5982 Tomcat \u5c31\u4f7f\u7528\u79f0\u4e3a DBCP(Database Connection\nPool)\u7684\u7ec4\u4ef6\uff0c\u53e6\u5916\uff0c\u57fa\u4e8e Java \u7684\u5f00\u6e90\u8fde\u63a5\u6c60\u8f6f\u4ef6\u4e5f\u5f88\u591a\uff0c<a href=\"http://java-source.net/open-source/connection-pools\">\u8fd9\u4e2a\u94fe\u63a5</a>\u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u4e9b\u63cf\u8ff0\u3002</p>\n<h2 id=\"_53\">\u590d\u5236\u6269\u5c55<a class=\"headerlink\" href=\"#_53\" title=\"Permanent link\">&para;</a></h2>\n<p>\u590d\u5236\u53ef\u4ee5\u4f7f\u5f97\u6570\u636e\u5e93\u6570\u636e\u5b58\u5728\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff0c\u81f3\u4e8e\u5199\uff0cPostgres-XC \u9879\u76ee\u8fd9\u81f4\u529b\u4e8e\u8fd9\u70b9\u3002</p>\n<h3 id=\"_54\">\u70ed\u5907<a class=\"headerlink\" href=\"#_54\" title=\"Permanent link\">&para;</a></h3>\n<p>PostgreSQL \u4ece 8.2 \u7248\u672c\u5f00\u59cb\u5c31\u5df2\u7ecf\u5185\u7f6e\u4e86\u5907\u673a(standby)\u7279\u6027\uff0c\u5b83\u5141\u8bb8\u521b\u5efa\u4e3b\u5907(master/standby)\u8282\u70b9,\u5907\u673a\u5b9a\u671f\u4ece\u4e3b\u673a\u63a5\u6536\u6570\u636e\u5e93\u66f4\u65b0\u65e5\u5fd7\u5e76\u5e94\u7528\u8fd9\u4e9b\u65e5\u5fd7\u3002\n\u5982\u679c\u4e3b\u673a\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u5931\u6548\uff0c\u5907\u673a\u53ef\u4ee5\u5feb\u901f\u66ff\u4ee3\u4e3b\u673a\u3002</p>\n<p>\u66f4\u6df1\u5165\u7406\u89e3\u70ed\u5907\uff0c\u9700\u8981\u6211\u4eec\u5148\u4e86\u89e3\u4e0b\u9762\u7684\u4e00\u4e9b\u672f\u8bed\uff1a</p>\n<dl>\n<dt>Write-ahead log(WAL)</dt>\n<dd>\n<p>:\n\u9884\u5199\u65e5\u5fd7\uff0c\u6bcf\u4e2a WAL \u5927\u5c0f\u4e3a 16MB\u3002\u5982\u679c\u6709\u4e24\u53f0\u6570\u636e\u5e93\u5f00\u59cb\u90fd\u662f\u4e00\u6837\uff0c\u7136\u540e\u5e94\u7528\u76f8\u540c\u7684 WAL \u540e\uff0c\u4ed6\u4eec\u8fd8\u662f\u76f8\u540c\u7684\uff0c\u56e0\u4e3a WAL \u5305\u542b\u4e86\u6240\u6709\u6539\u53d8\u7684\u6570\u636e\u3002</p>\n</dd>\n<dt>Base backup</dt>\n<dd>\n<p>\u5305\u62ec\u6240\u6709\u6570\u636e\u5e93\u5d29\u6e83\u540e\u80fd\u591f\u5b8c\u6574\u6062\u590d\u7684\u6570\u636e\u5e93\u5907\u4efd\u3002\u5b83\u4e00\u822c\u4f7f\u7528 pg_start_backup \u548c pg_stop_backup \u6307\u4ee4\u6765\u8fdb\u884c\u60b2\u6124\uff0c\u5b83\u7b49\u4e8e\u628a\u6574\u4e2a\u6570\u636e\u5e93\u4ee5\u53ca\u5728\u5907\u4efd\u671f\u95f4\u6709\u6240\u6539\u53d8\u800c\u5199\u5165 WAL \u6587\u4ef6\u5168\u90e8\u5907\u4efd\u4e00\u5957\u3002</p>\n</dd>\n<dt>Point-in-time recovery(PITR)</dt>\n<dd>\n<p>\u5982\u679c\u4f60\u6709\u57fa\u672c\u5907\u4efd(base\nbackup)\u4ee5\u53ca\u4e00\u7cfb\u5217 WAL \u6587\u4ef6\uff0c\u90a3\u4f60\u5c31\u5e94\u7528\u57fa\u7840\u5907\u4efd\u4ee5\u53ca\u4e00\u90e8\u5206 WAL \u6587\u4ef6\u4ece\u800c\u5b9e\u73b0\u6309\u65f6\u70b9\u6062\u590d\u7279\u6027\u3002</p>\n</dd>\n<dt>File-based log shipping</dt>\n<dd>\n<p>\u5982\u679c\u4f60\u6570\u636e\u5e93\u505a\u4e00\u4e2a\u57fa\u7840\u5907\u4efd(base\nbackup)\uff0c\u7136\u540e\u628a\u6240\u6709\u7684 WAL \u6587\u4ef6\u4f20\u8f93\u5230\u53e6\u5916\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\uff0c\u90a3\u4e48\u65b0\u7684\u670d\u52a1\u5668\u53ef\u4ee5\u548c\u539f\u6765\u90a3\u53f0\u4fdd\u6301\u540c\u6b65</p>\n</dd>\n<dt>standby</dt>\n<dd>\n<p>\u6709\u5b8c\u6574\u7684\u57fa\u7840\u5907\u4efd(base\nbackup)\u4ee5\u53ca\u673a\u9047\u6587\u4ef6\u7684\u65e5\u5fd7\u6d41\u4f20\u8f93\uff0c\u8fd9\u4e2a\u7cfb\u7edf\u79f0\u4e4b\u4e3a\u5907\u673a(standby),\u53ea\u8981 WAL \u53ef\u4ee5\u6301\u7eed\u4f20\u8f93\uff0cstandby \u53ef\u4ee5\u548c\u4e3b\u673a\u4fdd\u6301\u540c\u6b65\u3002</p>\n</dd>\n<dt>Failover</dt>\n<dd>\n<p>\u628a\u5907\u673a\u4ece\u6062\u590d\u6a21\u5f0f\u5207\u6362\u5230 active \u72b6\u6001\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u5931\u6548\u5207\u6362\u3002</p>\n</dd>\n</dl>\n<h3 id=\"_55\">\u603b\u7ed3<a class=\"headerlink\" href=\"#_55\" title=\"Permanent link\">&para;</a></h3>\n<p><strong>Program</strong> <strong>Relication Method</strong> <strong>Synchronization</strong></p>\n<hr />\n<p>WAL Shipping Master/Slave Async\nSlony Master/Slave Async\nLondiste Master/Slave Async\nMammoth Master/Slave Async\nBucardo Master/Slave or Master/Master Async\nRubyrep Master/Slave or Master/Master Async\nPgCluster Master/Master Sync\nPostgres-XC Master/Master Sync\npgpool-II Statement-based middleware Sync</p>\n<p>\u4e0a\u8ff0\u8fd9\u4e48\u591a\u4e3b/\u4ece\u590d\u5236\u89e3\u51b3\u65b9\u6848\u4e2d\u7684\u4e3b\u8981\u4e0d\u540c\u5728\u4e8e\u6570\u636e\u5e93\u7684\u4fee\u6539\u6570\u636e\u5982\u4f55\u4f20\u9012</p>\n<ul>\n<li>\n<p>PostgreSQL 9.0 \u7684 Hot Standby \u4e3b\u8981\u7528\u4e8e\u9ad8\u53ef\u7528\u5931\u6548\u5207\u6362</p>\n</li>\n<li>\n<p>WAL \u7528\u4e8e\u4e3a\u5907\u673a\u6570\u636e\u5e93\u521b\u5efa\u4fee\u6539\u7684\u65e5\u5fd7\u5757\uff0c\u5b83\u53ea\u80fd\u5b8c\u6574\u5e94\u7528\uff0c\u4e0d\u7528\u5e94\u7528 WAL \u5b50\u96c6</p>\n</li>\n<li>\n<p>\u4f7f\u7528\u65e5\u5fd7\u4f20\u8f93\u590d\u5236\u4f1a\u5728\u4e3b\u673a\u548c\u5907\u673a\u4e2d\u4ea7\u751f\u5f52\u6863\u5ef6\u8fdf\uff0c\u867d\u7136\u8fd9\u70b9\u5728 Postgresql\n  9.0 \u91cc\u4f7f\u7528\u6d41\u590d\u5236(Stream Replication)\u7279\u65b0\u5f97\u4ee5\u4f18\u5316\uff0c\u4f46\u8fd8\u65e0\u6cd5\u5b8c\u5168\u907f\u514d\u3002</p>\n</li>\n<li>\n<p>Hot\n  Standby \u7cfb\u7edf\u53ef\u4ee5\u9488\u5bf9\u5feb\u901f\u5931\u6548\u5207\u6362\uff0c\u957f\u65f6\u95f4\u67e5\u8be2\u6267\u884c\u4ee5\u53ca\u5bf9\u4e3b\u673a\u6700\u5c0f\u5f71\u54cd\u4e09\u4e2a\u65b9\u9762\u8fdb\u884c\u4f18\u5316\u3002\u4f46\u540c\u4e00\u65f6\u523b\u53ea\u80fd\u4f18\u5316\u8fd9\u4e09\u79cd\u7684\u4e24\u79cd\u3002</p>\n</li>\n<li>\n<p>\u57fa\u4e8e\u8bed\u53e5\u7684\u6570\u636e\u5e93\u590d\u5236\u53cd\u800c\u66f4\u7075\u6d3b\uff0c\u8fd8\u80fd\u7528\u6765\u5347\u7ea7\u7248\u672c\u3002\u4f46\u6709\u4e9b\u8bed\u53e5\u5e76\u4e0d\u5bb9\u6613\u590d\u5236\uff0c\u800c\u4e14\u76f8\u6bd4 WAL \u4f20\u8f93\u6709\u66f4\u9ad8\u7684\u5f00\u9500\u3002</p>\n</li>\n<li>\n<p>Slony \u548c Londiste \u90fd\u662f\u4f7f\u7528\u89e6\u53d1\u5668\u63d0\u53d6\u66f4\u65b0\u8bed\u53e5\u7684\u6210\u719f\u89e3\u51b3\u65b9\u6848\u3002</p>\n</li>\n<li>\n<p>pgpool-II \u53ef\u4ee5\u7528\u6765\u505a\u591a\u4ece\u8282\u70b9\u7684\u53ea\u8bfb\u8d1f\u8f7d\u5747\u8861\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u505a\u67d0\u4e9b\u540c\u6b65\u590d\u5236</p>\n</li>\n<li>\n<p>Bucardo \u652f\u6301\u591a\u4e3b\u7ed3\u6784\uff0c\u4e0d\u7ba1\u8fd9\u4e9b\u8282\u70b9\u662f\u5426\u4e00\u76f4\u90fd\u5728\u7ebf\u3002</p>\n</li>\n</ul>\n<h2 id=\"_56\">\u6570\u636e\u5206\u533a<a class=\"headerlink\" href=\"#_56\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5f53\u8868\u4e00\u4e2a\u81ea\u8eab\u6bd4\u7269\u7406\u5185\u5b58\u8fd8\u5927\u65f6\uff0c\u5373\u4fbf\u7d22\u5f15\u5f88\u597d\uff0c\u67e5\u8be2\u8be5\u8868\u7684\u65f6\u95f4\u4e5f\u4f1a\u663e\u8457\u589e\u52a0\u3002\u6b64\u65f6\u4e00\u4e2a\u81ea\u7136\u7684\u529e\u6cd5\u662f\u628a\u8fd9\u4e2a\u8868\u5212\u5206\u6210\u51e0\u4e2a\u5c0f\u7684\u76f8\u5173\u8868\u3002\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4fee\u6539\u4fee\u6539\uff0c\u8fd8\u662f\u67e5\u8be2\u539f\u6765\u7684\u8868\u3002\n\u4f46\u5230\u6570\u636e\u5e93\u5c42\uff0c\u5219\u53ea\u662f\u67e5\u8be2\u8be5\u8868\u7684\u5b50\u96c6\u800c\u4e0d\u662f\u5168\u90e8\u3002</p>\n<h3 id=\"_57\">\u8303\u56f4\u5206\u533a<a class=\"headerlink\" href=\"#_57\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u4f7f\u7528\u7b2c<a href=\"#sec:query optimization\">10</a>{reference-type=\"ref\"\nreference=\"sec:query optimization\"}\u7ae0\u91cc\u63d0\u5230\u7684 Dell Store 2\n\u6570\u636e\u5e93\u505a\u4f8b\u5b50\uff0c\u8003\u8651 orders \u8868\u7684\u7ed3\u6784\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">orders</span>\n<span class=\"w\"> </span><span class=\"k\">Table</span><span class=\"w\"> </span><span class=\"ss\">&quot;public.orders&quot;</span>\n<span class=\"w\">   </span><span class=\"k\">Column</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">Type</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">                        </span><span class=\"n\">Modifiers</span>\n<span class=\"c1\">-------------+---------------+----------------------------------------------------------</span>\n<span class=\"w\"> </span><span class=\"n\">orderid</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">integer</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"w\"> </span><span class=\"k\">default</span><span class=\"w\"> </span><span class=\"n\">nextval</span><span class=\"p\">(</span><span class=\"s1\">&#39;orders_orderid</span>\n<span class=\"s1\">                                _seq&#39;</span><span class=\"p\">::</span><span class=\"n\">regclass</span><span class=\"p\">)</span>\n<span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">date</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span>\n<span class=\"w\"> </span><span class=\"n\">customerid</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">integer</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"w\"> </span><span class=\"n\">netamount</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span>\n<span class=\"w\"> </span><span class=\"n\">tax</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span>\n<span class=\"w\"> </span><span class=\"n\">totalamount</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nb\">numeric</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span>\n<span class=\"n\">Indexes</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"ss\">&quot;orders_pkey&quot;</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">btree</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"ss\">&quot;ix_order_custid&quot;</span><span class=\"w\"> </span><span class=\"n\">btree</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span>\n<span class=\"k\">Foreign</span><span class=\"o\">-</span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"k\">constraints</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"ss\">&quot;fk_customerid&quot;</span><span class=\"w\"> </span><span class=\"k\">FOREIGN</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">customers</span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"n\">Referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"ss\">&quot;orderlines&quot;</span><span class=\"w\"> </span><span class=\"k\">CONSTRAINT</span><span class=\"w\"> </span><span class=\"ss\">&quot;fk_orderid&quot;</span><span class=\"w\"> </span><span class=\"k\">FOREIGN</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">CASCADE</span>\n</code></pre></div>\n<p>\u5047\u8bbe\u8fd9\u4e2a\u8868\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u8be5\u8868\u8fc5\u901f\u81a8\u80c0\uff0c\u6bd4\u5982\u8fbe\u5230\u4e00\u4ebf\u6761\u8bb0\u5f55\uff0c\u6216\u8005\u8bf4\u5176\u5927\u5c0f\u8d85\u8fc7\u4e86\u7269\u7406\u5185\u5b58\uff0c\u6b64\u65f6\u6211\u4eec\u8981\u8003\u8651\u5bf9\u6b64\u8868\u8fdb\u884c\u5206\u533a\u3002\n\u8fd9\u91cc\u91cd\u70b9\u8981\u8003\u8651\u7684\u662f\u4f9d\u636e\u90a3\u4e2a\u5b57\u6bb5\u8fdb\u884c\u5206\u533a\uff0c\u6bd4\u5982\u8fd9\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5\u53ef\u4ee5\u5206\u533a\uff0c\u4e00\u4e2a\u662f orderid\uff0c\u4e00\u4e2a\u662f orderdate\u3002\u4f3c\u4e4e\u4e24\u4e2a\u90fd\u53ef\u884c\u3002\n\u4f46\u662f\u8003\u8651\u5230\u4e00\u4e2a\u95ee\u9898\uff0c\u8ba2\u5355\u53ea\u4fdd\u7559\u4e00\u6bb5\u65f6\u95f4\uff0c\u6bd4\u5982 1\uff0c2 \u5e74\u3002\u8001\u7684\u8ba2\u5355\u5c31\u9700\u8981\u5220\u9664\u3002\u5f53\u5927\u91cf\u7684\u8001\u8ba2\u5355\u5220\u9664\u65f6\uff0c\u5fc5\u7136\u5c31\u9700\u8981\u6267\u884c vacuum\u3002\u4ece\u800c\u5bfc\u81f4\u5f00\u9500\u589e\u52a0\u3002\n\u5982\u679c\u662f\u4f9d\u636e orderdate \u5206\u533a\uff0c\u5f53\u9700\u8981\u5220\u9664\u8001\u6570\u636e\u65f6\uff0c\u76f4\u63a5 DROP \u6389\u5305\u542b\u8001\u6570\u636e\u7684\u5206\u533a\u5c31\u597d\u4e86\uff0c\u8fd9\u6837\u6548\u7387\u5c31\u9ad8\u5f88\u591a\u3002\n\u56e0\u6b64\u8fd9\u91cc\u9009\u62e9 orderdate \u4f5c\u4e3a\u5206\u533a\u5b57\u6bb5\u66f4\u597d\u3002</p>\n<p>\u63a5\u4e0b\u6765\u5c31\u8981\u8ba1\u7b97\u4e00\u4e2a\u5206\u533a\u91cc\u5e94\u8be5\u5305\u542b\u591a\u5c11\u6570\u636e\uff0c\u9996\u5148\u770b\u770b\u8fd9\u4e2a\u8868\u7684\u76f8\u5173\u4fe1\u606f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">min</span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"p\">),</span><span class=\"k\">max</span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">min</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"k\">max</span>\n<span class=\"c1\">------------+------------</span>\n<span class=\"w\"> </span><span class=\"mi\">2004</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2004</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">31</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4f5c\u4e3a\u6f14\u793a\u6570\u636e\uff0c\u8fd9\u91cc\u7684\u6570\u636e\u53ea\u6709 1 \u5e74\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u6309\u7167\u6708\u6765\u5206\u533a\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">   </span><span class=\"k\">check</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-01-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span><span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-02-01&#39;</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">inherits</span><span class=\"p\">(</span><span class=\"n\">orders</span><span class=\"p\">);</span>\n\n<span class=\"p\">...</span>\n\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"p\">(</span>\n<span class=\"w\">   </span><span class=\"k\">check</span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-12-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span><span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2005-01-01&#39;</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">inherits</span><span class=\"p\">(</span><span class=\"n\">orders</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u4e9b\u5206\u533a\u8868\u53ea\u662f\u7ee7\u627f\u4e86\u4e3b\u8868\u7684\u5b57\u6bb5\uff0c\u8fd8\u9700\u8981\u589e\u52a0\u7d22\u5f15\uff0c\u7ea6\u675f\u4ee5\u53ca\u8c03\u6574\u548c\u4e3b\u8868\u76f8\u5339\u914d\u7684\u6743\u9650\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"k\">ONLY</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span>\n<span class=\"w\">    </span><span class=\"k\">ADD</span><span class=\"w\"> </span><span class=\"k\">CONSTRAINT</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01_pkey</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"p\">);</span>\n<span class=\"p\">...</span>\n\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"k\">ONLY</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span>\n<span class=\"w\">    </span><span class=\"k\">ADD</span><span class=\"w\"> </span><span class=\"k\">CONSTRAINT</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12_pkey</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">INDEX</span><span class=\"w\"> </span><span class=\"n\">idx_orders_2004_01_custid</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span>\n<span class=\"w\">    </span><span class=\"k\">USING</span><span class=\"w\"> </span><span class=\"n\">btree</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">);</span>\n\n<span class=\"p\">....</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">INDEX</span><span class=\"w\"> </span><span class=\"n\">idx_orders_2004_12_custid</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span>\n<span class=\"w\">    </span><span class=\"k\">USING</span><span class=\"w\"> </span><span class=\"n\">btree</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">);</span>\n\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"k\">ONLY</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"w\"> </span><span class=\"k\">ADD</span><span class=\"w\"> </span><span class=\"k\">CONSTRAINT</span><span class=\"w\"> </span><span class=\"n\">fk_2004_01_customerid</span><span class=\"w\"> </span><span class=\"k\">FOREIGN</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">customers</span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">;</span>\n\n<span class=\"p\">...</span>\n\n<span class=\"k\">ALTER</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"k\">ONLY</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"w\"> </span><span class=\"k\">ADD</span><span class=\"w\"> </span><span class=\"k\">CONSTRAINT</span><span class=\"w\"> </span><span class=\"n\">fk_2004_12_customerid</span><span class=\"w\"> </span><span class=\"k\">FOREIGN</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">customers</span><span class=\"p\">(</span><span class=\"n\">customerid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5230\u6b64\u4e3a\u6b62\uff0c\u8868\u7ed3\u6784\u90fd\u5df2\u7ecf\u6709\u4e86\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u786e\u4fdd\u63d2\u5165\u5230\u4e3b\u8868\u7684\u6570\u636e\u90fd\u63d2\u5165\u5230\u5bf9\u5e94\u7684\u5206\u533a\u8868\u4e2d\uff0c\u6211\u4eec\u5efa\u8bae\u4f7f\u7528\u89e6\u53d1\u5668\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span><span class=\"w\"> </span><span class=\"n\">orders_insert_trigger</span><span class=\"p\">()</span>\n<span class=\"k\">RETURNS</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\">  </span><span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"k\">IF</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-12-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span>\n<span class=\"w\">          </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2005-01-01&#39;</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">THEN</span>\n<span class=\"w\">         </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"w\"> </span><span class=\"k\">VALUES</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"p\">);</span>\n<span class=\"w\"> </span><span class=\"k\">ELSIF</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-11-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span>\n<span class=\"w\">          </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-12-01&#39;</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">THEN</span>\n<span class=\"w\">         </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">orders_2004_11</span><span class=\"w\"> </span><span class=\"k\">VALUES</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"p\">);</span>\n\n<span class=\"p\">...</span>\n\n<span class=\"w\"> </span><span class=\"k\">ELSIF</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-00-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span>\n<span class=\"w\">         </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-01-01&#39;</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">THEN</span>\n<span class=\"w\">         </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">orders_2004_11</span><span class=\"w\"> </span><span class=\"k\">VALUES</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"p\">);</span>\n\n<span class=\"k\">ELSE</span>\n<span class=\"w\">         </span><span class=\"n\">RAISE</span><span class=\"w\"> </span><span class=\"k\">EXCEPTION</span><span class=\"w\"> </span><span class=\"s1\">&#39;Error in orders_insert_trigger():    date out of range&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">     </span><span class=\"k\">END</span><span class=\"w\"> </span><span class=\"k\">IF</span><span class=\"p\">;</span>\n<span class=\"w\">     </span><span class=\"k\">RETURN</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">END</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"w\"> </span><span class=\"k\">LANGUAGE</span><span class=\"w\"> </span><span class=\"n\">plpgsql</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u89e6\u53d1\u5668\u662f\u9759\u6001\u7684\uff0c\u6bcf\u6b21\u90fd\u4f1a\u6267\u884c\u76f8\u540c\u7684\u8bed\u53e5\uff0c\u800c\u4e14\u4e0d\u5bb9\u6613\u6269\u5c55\uff0c\u6211\u4eec\u53ef\u4ee5\u6539\u9020\u4e3a\u52a8\u6001\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span><span class=\"w\"> </span><span class=\"n\">orders_insert_trigger</span><span class=\"p\">()</span>\n<span class=\"k\">RETURNS</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"k\">DECLARE</span>\n<span class=\"w\">    </span><span class=\"n\">ins_sql</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">;</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"n\">ins_sql</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"o\">=</span>\n<span class=\"w\">        </span><span class=\"s1\">&#39;INSERT INTO orders_&#39;</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">to_char</span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;YYYY_MM&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span>\n<span class=\"w\">        </span><span class=\"s1\">&#39;(orderid,orderdate,customerid,netamount,tax,totalamount)</span>\n<span class=\"s1\">          VALUES &#39;</span><span class=\"w\"> </span><span class=\"o\">||</span>\n<span class=\"w\">        </span><span class=\"s1\">&#39;(&#39;</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderid</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"s1\">&#39;,&#39;</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">quote_literal</span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">orderdate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"s1\">&#39;,&#39;</span>\n<span class=\"w\">           </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">customerid</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"s1\">&#39;,&#39;</span><span class=\"o\">||</span>\n<span class=\"w\">        </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">netamount</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"s1\">&#39;,&#39;</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">tax</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"s1\">&#39;,&#39;</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"n\">totalamount</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"s1\">&#39;)&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">EXECUTE</span><span class=\"w\"> </span><span class=\"n\">ins_sql</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">RETURN</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">;</span>\n<span class=\"k\">END</span>\n<span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"k\">LANGUAGE</span><span class=\"w\"> </span><span class=\"n\">plpgsql</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u800c\u540e\u628a\u8fd9\u4e2a\u89e6\u53d1\u5668\u5e94\u7528\u5230\u4e3b\u8868 orders \u4e0a:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"n\">insert_orders_trigger</span>\n<span class=\"w\">    </span><span class=\"k\">BEFORE</span><span class=\"w\"> </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">orders</span>\n<span class=\"w\">    </span><span class=\"k\">FOR</span><span class=\"w\"> </span><span class=\"k\">EACH</span><span class=\"w\"> </span><span class=\"k\">ROW</span><span class=\"w\"> </span><span class=\"k\">EXECUTE</span><span class=\"w\"> </span><span class=\"k\">PROCEDURE</span><span class=\"w\"> </span><span class=\"n\">orders_insert_trigger</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u9664\u4e86\u7528\u89e6\u53d1\u5668\u8fd9\u79cd\u65b9\u6cd5\u6765\u91cd\u5b9a\u5411\u6570\u636e\u7684\u63d2\u5165\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5229\u7528\u89c4\u5219(rule)\u6765\u505a\u5230\u8fd9\u70b9\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">RULE</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01_insert</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"w\">  </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">WHERE</span>\n<span class=\"w\">         </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"o\">&gt;=</span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-01-01&#39;</span><span class=\"w\"> </span><span class=\"k\">AND</span><span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"nb\">DATE</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-02-01&#39;</span><span class=\"w\"> </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">DO</span><span class=\"w\"> </span><span class=\"k\">INSTEAD</span>\n<span class=\"w\">         </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"w\"> </span><span class=\"k\">VALUES</span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5728\u6570\u636e\u6279\u91cf\u52a0\u8f7d\u65f6\uff0c\u89c4\u5219\u76f8\u6bd4\u89e6\u53d1\u5668\u66f4\u5feb\u3002\u4e0d\u8fc7\u4f7f\u7528\u89c4\u5219\u7684\u662f\u4e2a\u5f31\u70b9\u5c31\u662f\u65e0\u6cd5\u4f7f\u7528 COPY \u6307\u4ee4\u6765\u52a0\u8f7d\u6570\u636e\u3002</p>\n<h3 id=\"_58\">\u73b0\u573a\u8fc1\u79fb\u5230\u5206\u533a\u8868<a class=\"headerlink\" href=\"#_58\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\u6240\u6709\u7684\u5206\u533a\u8868\u4ee5\u53ca\u8868\u4e0a\u7d22\u5f15\u3001\u7ea6\u675f\u4ee5\u53ca\u4e3b\u8868\u4e0a\u9700\u8981\u7684\u89e6\u53d1\u5668\u90fd\u5df2\u7ecf\u521b\u5efa\u597d\uff0c\u4f46\u662f\u76ee\u524d\u6240\u6709\u7684\u6570\u636e\u90fd\u8fd8\u5728\u4e3b\u8868\u4e0a\uff0c\u5982\u4f55\u628a\u6570\u636e\u5206\u5e03\u5230\u5206\u533a\u8868\u5462\uff1f</p>\n<p>\u6709\u4e24\u4e2a\u529e\u6cd5\uff0c\u4e00\u4e2a\u6700\u5bb9\u6613\u4e5f\u662f\u6700\u7b80\u5355\u7684\u529e\u6cd5\u662f\u5148\u628a\u4e3b\u8868\u4e0a\u7684\u6570\u636e\u5bfc\u51fa\uff0c\u800c\u540e\u6e05\u7a7a\u4e3b\u8868\uff0c\u7136\u540e\u5bfc\u5165\u521a\u624d\u5bfc\u51fa\u7684\u6570\u636e\u3002\u8fd9\u4e2a\u505a\u6cd5\u9700\u8981\u4e00\u5b9a\u7684\u505c\u670d\u52a1\u65f6\u95f4\u3002</p>\n<p>\u53e6\u5916\u4e00\u4e2a\u529e\u6cd5\u662f\u8003\u8651\u4f7f\u7528\u66f4\u65b0\u89e6\u53d1\u5668\uff0c\u901a\u8fc7\u66f4\u65b0\u4e3b\u8868\u4e0a\u7684\u6240\u6709\u6570\u636e\uff0c\u4ece\u800c\u4f7f\u5f97\u6570\u636e\u91cd\u65b0\u5206\u914d\u3002\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6d41\u7a0b\u548c\u4f7f\u5f97\u63d2\u5165\u6570\u636e\u91cd\u5b9a\u5411\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u4e3b\u8868\u66f4\u65b0\u51fd\u6570\u3002\n\u800c\u540e\u5728\u4e3b\u8868\u4e0a\u9488\u5bf9\u66f4\u65b0\u521b\u5efa\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span><span class=\"w\"> </span><span class=\"n\">orders_update_trigger</span><span class=\"p\">()</span>\n<span class=\"k\">RETURNS</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"w\">   </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"k\">OLD</span><span class=\"p\">.</span><span class=\"n\">orderid</span><span class=\"o\">=</span><span class=\"n\">orderid</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">NEW</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">RETURN</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">;</span>\n<span class=\"k\">END</span><span class=\"p\">;</span>\n<span class=\"err\">$</span><span class=\"n\">body$</span>\n<span class=\"k\">LANGUAGE</span><span class=\"w\"> </span><span class=\"n\">plpgsql</span><span class=\"p\">;</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"n\">update_orders</span>\n<span class=\"w\">     </span><span class=\"k\">BEFORE</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">orders</span>\n<span class=\"w\">     </span><span class=\"k\">FOR</span><span class=\"w\"> </span><span class=\"k\">EACH</span><span class=\"w\"> </span><span class=\"k\">ROW</span>\n<span class=\"w\">     </span><span class=\"k\">EXECUTE</span><span class=\"w\"> </span><span class=\"k\">PROCEDURE</span><span class=\"w\"> </span><span class=\"n\">orders_update_trigger</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u800c\u540e\u6211\u4eec\u628a\u5bf9\u4e3b\u8868\u7684\u66f4\u65b0\u8bed\u53e5\u653e\u5728\u4e00\u4e2a\u4e8b\u7269\u91cc\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">BEGIN</span><span class=\"p\">;</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\"> </span><span class=\"mi\">12000</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\">  </span><span class=\"n\">orders_2004_01</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\">     </span><span class=\"mi\">0</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\">  </span><span class=\"n\">orders_2004_12</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\">     </span><span class=\"mi\">0</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">orderid</span><span class=\"o\">=</span><span class=\"n\">orderid</span><span class=\"p\">;</span>\n<span class=\"k\">UPDATE</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\"> </span><span class=\"mi\">12000</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\">  </span><span class=\"mi\">1000</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">-------</span>\n<span class=\"w\">  </span><span class=\"mi\">1000</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">COMMIT</span><span class=\"p\">;</span>\n<span class=\"k\">COMMIT</span>\n</code></pre></div>\n<p>\u786e\u4fdd\u6240\u6709\u7684\u6570\u636e\u90fd\u5df2\u7ecf\u91cd\u65b0\u5206\u5e03\u540e\uff0c\u8bb0\u5f97\u505a\u5584\u540e\u5de5\u4f5c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">CLUSTER</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"n\">ERROR</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"n\">there</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"n\">previously</span><span class=\"w\"> </span><span class=\"n\">clustered</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"ss\">&quot;orders&quot;</span>\n<span class=\"k\">STATEMENT</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"k\">CLUSTER</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"n\">ERROR</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"n\">there</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"n\">previously</span><span class=\"w\"> </span><span class=\"n\">clustered</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"ss\">&quot;orders&quot;</span>\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span><span class=\"w\"> </span><span class=\"n\">update_orders</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">TRIGGER</span>\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span><span class=\"w\"> </span><span class=\"n\">orders_update_trigger</span><span class=\"p\">();</span>\n<span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">FUNCTION</span>\n</code></pre></div>\n<h3 id=\"_59\">\u5206\u533a\u67e5\u8be2<a class=\"headerlink\" href=\"#_59\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5230\u6b64\u4e3a\u6b62\uff0c\u6570\u636e\u90fd\u5728\u5206\u533a\u8868\u91cc\u4e86\uff0c\u6b64\u65f6\u5e94\u8be5\u66f4\u65b0\u653b\u51fb\u3002\u540c\u65f6\u4e5f\u5e94\u8be5\u786e\u8ba4 constraint_exclusion \u7279\u6027\u662f\u5426\u6253\u5f00:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">ANALYZE</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">ANALYZE</span>\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">SHOW</span><span class=\"w\"> </span><span class=\"n\">constraint_exclusion</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"n\">constraint_exclusion</span>\n<span class=\"c1\">----------------------</span>\n<span class=\"w\"> </span><span class=\"n\">partition</span>\n<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u6392\u4ed6\u6027\u7ea6\u675f\u53ef\u4ee5\u8ba9\u67e5\u8be2\u8ba1\u5212\u907f\u514d\u5305\u542b\u8fdb\u5e76\u4e0d\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\u884c\u7684\u5206\u533a\u8868\u8fdb\u6765\u3002PostgreSQL\n8.4 \u53ca\u4ee5\u540e\u7248\u672c\u9ed8\u8ba4\u662f\u6253\u5f00\u7684\uff0c\u4e4b\u524d\u5219\u662f\u5173\u95ed\u3002</p>\n<p>\u901a\u8fc7\u5bf9\u4e3b\u8868\u7684\u67e5\u8be2\u6d4b\u8bd5\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u8ba1\u5212\u5df2\u7ecf\u5728\u5206\u533a\u8868\u4e0a\u8d77\u4f5c\u7528\u4e86:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">EXPLAIN</span><span class=\"w\"> </span><span class=\"k\">ANALYZE</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">QUERY</span><span class=\"w\"> </span><span class=\"n\">PLAN</span>\n<span class=\"c1\">------------------</span>\n<span class=\"w\"> </span><span class=\"k\">Result</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">228</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">12001</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">010</span><span class=\"p\">..</span><span class=\"mi\">4</span><span class=\"p\">.</span><span class=\"mi\">648</span>\n<span class=\"w\">                                                      </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">12000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Append</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">228</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">12001</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">                            </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">009</span><span class=\"p\">..</span><span class=\"mi\">2</span><span class=\"p\">.</span><span class=\"mi\">464</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">12000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">                            </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">002</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">002</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">19</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">007</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">118</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_02</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">19</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">006</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">111</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">...</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_11</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">19</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">             </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">003</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">096</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">19</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">             </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">003</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">105</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\"> </span><span class=\"n\">Total</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">.</span><span class=\"mi\">339</span><span class=\"w\"> </span><span class=\"n\">ms</span>\n<span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n\n<span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">EXPLAIN</span><span class=\"w\"> </span><span class=\"k\">ANALYZE</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">orderdate</span><span class=\"o\">=</span><span class=\"s1\">&#39;2004-11-16&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">QUERY</span><span class=\"w\"> </span><span class=\"n\">PLAN</span>\n<span class=\"c1\">---------------</span>\n<span class=\"w\"> </span><span class=\"k\">Result</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">21</span><span class=\"p\">.</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">012</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">136</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Append</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">21</span><span class=\"p\">.</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">011</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">127</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">001</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">001</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-11-16&#39;</span><span class=\"p\">::</span><span class=\"nb\">date</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_11</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">21</span><span class=\"p\">.</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">009</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">122</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderdate</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;2004-11-16&#39;</span><span class=\"p\">::</span><span class=\"nb\">date</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"k\">Rows</span><span class=\"w\"> </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">965</span>\n<span class=\"w\"> </span><span class=\"n\">Total</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">165</span><span class=\"w\"> </span><span class=\"n\">ms</span>\n<span class=\"p\">(</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u6211\u4eec\u518d\u770b\u770b\u9488\u5bf9 orderid \u5b57\u6bb5\u67e5\u8be2\u7684\u4f8b\u5b50\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">dellstore2</span><span class=\"o\">=#</span><span class=\"w\"> </span><span class=\"k\">EXPLAIN</span><span class=\"w\"> </span><span class=\"k\">ANALYZE</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">orderid</span><span class=\"o\">&lt;</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">QUERY</span><span class=\"w\"> </span><span class=\"n\">PLAN</span>\n<span class=\"c1\">-----------------------</span>\n<span class=\"w\"> </span><span class=\"k\">Result</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">258</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">2011</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">11</span><span class=\"p\">.</span><span class=\"mi\">433</span><span class=\"p\">..</span><span class=\"mi\">39</span><span class=\"p\">.</span><span class=\"mi\">440</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1999</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Append</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">258</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">2011</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">11</span><span class=\"p\">.</span><span class=\"mi\">431</span><span class=\"p\">..</span><span class=\"mi\">38</span><span class=\"p\">.</span><span class=\"mi\">878</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1999</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">001</span><span class=\"p\">..</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">001</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"p\">)</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_01</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">21</span><span class=\"p\">.</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">11</span><span class=\"p\">.</span><span class=\"mi\">429</span><span class=\"p\">..</span><span class=\"mi\">14</span><span class=\"p\">.</span><span class=\"mi\">192</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"p\">)</span>\n<span class=\"w\">       </span><span class=\"p\">...</span>\n<span class=\"w\">         </span><span class=\"o\">-&gt;</span><span class=\"w\">  </span><span class=\"n\">Seq</span><span class=\"w\"> </span><span class=\"n\">Scan</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">orders_2004_12</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">cost</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"p\">..</span><span class=\"mi\">21</span><span class=\"p\">.</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"k\">time</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">739</span><span class=\"p\">..</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">739</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">loops</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">orderid</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"k\">Rows</span><span class=\"w\"> </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n<span class=\"w\"> </span><span class=\"n\">Total</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"p\">.</span><span class=\"mi\">880</span><span class=\"w\"> </span><span class=\"n\">ms</span>\n<span class=\"p\">(</span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece\u7ed3\u679c\u6765\u770b\uff0c\u9488\u5bf9 orderid \u7684\u67e5\u8be2\u5e76\u6ca1\u6709\u592a\u591a\u4f18\u5316\uff0c\u6240\u6709\u7684\u5b50\u8868\u90fd\u5728\u626b\u63cf\u8303\u56f4\u5185\u3002</p>\n<h3 id=\"_60\">\u5e38\u89c1\u7684\u5206\u533a\u8bef\u533a<a class=\"headerlink\" href=\"#_60\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li>\n<p>\u6ca1\u6709\u6253\u5f00 constraint_exclustion\uff0c\u4ece\u800c\u5bfc\u81f4\u6bcf\u6b21\u67e5\u8be2\u90fd\u5305\u542b\u6240\u6709\u7684\u5206\u533a\u8868</p>\n</li>\n<li>\n<p>\u5728\u6bcf\u4e2a\u5206\u533a\u8868\u4e0a\u589e\u52a0\u4e3b\u8868\u4e0a\u5df2\u7ecf\u6709\u7684\u7d22\u5f15\u6216\u8005\u7ea6\u675f\u65f6\u4f1a\u62a5\u9519</p>\n</li>\n<li>\n<p>\u5fd8\u8bb0\u7ed9\u6bcf\u4e2a\u5206\u533a\u8868\u8d4b\u4e88\u548c\u4e3b\u8868\u76f8\u540c\u7684\u6743\u9650</p>\n</li>\n<li>\n<p>\u67e5\u8be2\u8bed\u53e5\u6ca1\u6709\u5305\u62ec\u5206\u533a\u5b57\u6bb5\u7684\u8fc7\u6ee4\uff0cWHERE \u5b50\u53e5\u9700\u8981\u7528\u5e38\u91cf\u6765\u8fc7\u6ee4\uff0c\u5f53\u53c2\u6570\u7684\u67e5\u8be2\u6839\u672c\u5c31\u4e0d\u4f1a\u4f18\u5316\u3002\n  \u51fd\u6570\u91cc\u901a\u8fc7\u4f7f\u7528\u7c7b\u4f3c CURREN_DATE \u8fd9\u6837\u7684\u8bed\u53e5\u4fee\u6539\u8fc7\u6ee4\u503c\u4e5f\u4e0d\u4f1a\u83b7\u5f97\u597d\u7684\u4f18\u5316\u6548\u679c\u3002\u4e00\u822c\u6765\u8bf4\uff0cWHERE \u5b50\u53e5\u5c3d\u53ef\u80fd\u7b80\u5355\u3002</p>\n</li>\n<li>\n<p>\u9488\u5bf9\u5206\u533a\u7684\u67e5\u8be2\u5f00\u9500\u548c\u5206\u533a\u6570\u91cf\u6210\u6b63\u6bd4\uff0c\u5982\u679c\u53ea\u6709 10 \uff5e 20 \u4e2a\u5206\u533a\u8868\uff0c\u90a3\u5f00\u9500\u4e0d\u660e\u663e\uff0c\u5982\u679c\u4e0a\u767e\u4e2a\uff0c\u90a3\u5c31\u5f88\u660e\u663e\u4e86\uff0c\u56e0\u6b64\u4fdd\u6301\u4f60\u7684\u5206\u533a\u8868\u6570\u91cf\u5728 2 \u4f4d\u6570\u4e4b\u5185\u65f6\u6700\u597d\u7684\u6027\u80fd\u3002</p>\n</li>\n<li>\n<p>\u5982\u679c\u4f60\u624b\u5de5\u5bf9\u4e3b\u8868\u6267\u884c vacuum/analyze \u64cd\u4f5c\uff0c\u5b83\u5e76\u4e0d\u4f1a\u6267\u884c\u5230\u5206\u533a\u8868\u4e0a\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u9488\u5bf9\u6bcf\u4e2a\u5206\u533a\u8868\u505a\u540c\u6837\u7684\u64cd\u4f5c\u3002</p>\n</li>\n<li>\n<p>\u63d2\u5165\u8d85\u8fc7\u65e5\u671f\u8303\u56f4(\u6bd4\u5982 2005 \u5e74\u7684)\u7684\u6570\u636e\u4f1a\u5bfc\u81f4\u51fd\u6570\u62a5\u9519\uff0c\u7c7b\u4f3c ERROR:\n  relation \\\"orders_2013_03\\\" does not exist\u3002</p>\n</li>\n</ul>\n<h3 id=\"plproxy\">\u7528 PL/Proxy \u505a\u6c34\u5e73\u5206\u533a<a class=\"headerlink\" href=\"#plproxy\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"http://pgfoundry.org/projects/plproxy/\">PL/Proxy</a>\u7684\u7406\u8bba\u662f\u8ba4\u4e3a\u628a\u4e00\u4e2a\u5927\u8868\u5206\u6210\u591a\u4e2a\u5b50\u8868\u4f1a\u6bd4\u5c06\u5927\u8868\u5206\u5230\u76f8\u540c\u7684\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\u66f4\u6709\u6548\u7387\u3002</p>\n<p>PL/Proxy \u662f Skype \u8bbe\u8ba1\u7528\u6765\u6ee1\u8db3\u6570\u636e\u5e93\u6269\u5c55\u6240\u9700\uff0c\u5b83\u5176\u4e2d\u7684\u4e00\u4e2a\u76ee\u6807\u662f\u4e00\u6b21\u53ef\u4ee5\u670d\u52a1 10 \u4e2a\u7528\u6237\u8bf7\u6c42\u3002\u5b83\u662f\u7528\u5b58\u50a8\u8fc7\u7a0b\u8bed\u8a00\u5b9e\u73b0\u7684\u6570\u636e\u5e93\u5206\u533a\u7cfb\u7edf\u3002</p>\n<p>PL/Proxy \u7684\u4e00\u4e2a\u57fa\u672c\u5047\u8bbe\u662f\u901a\u8fc7\u8bbf\u95ee\u51fd\u6570\uff08\u4e5f\u5c31\u662f\u5b58\u50a8\u8fc7\u7a0b\uff09\u6765\u5c4f\u853d\u76f4\u63a5\u8bbf\u95ee\u6570\u636e\u5e93\u3002\u6bd4\u5982\uff0c\u5047\u5b9a\u4f60\u9700\u8981\u6293\u53d6 username \u5b57\u6bb5\u6765\u552f\u4e00\u6807\u8bc6\u4e00\u4e2a\u7528\u6237\uff0c\u4f60\u53ef\u4ee5\u8c03\u7528\n\u4e00\u4e2a\u8fd4\u56de username \u5b57\u6bb5\u7684\u51fd\u6570\u800c\u4e0d\u662f\u67e5\u8be2\u8868\u3002\u8fd9\u4e2a\u8bbe\u8ba1\u65b9\u5f0f\u6d41\u884c\u7684\u53e6\u5916\u4e00\u4e2a\u539f\u56e0\u662f\uff0c\u5b83\u4f7f\u5f97\u5f53\u9700\u8981\u91cd\u6784\u6570\u636e\u5e93\u65f6\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7684\u5f71\u54cd\u6700\u5c0f\u3002\u53ea\u8981\u90a3\u4e9b\u79f0\u4e4b\u4e3a\"API\"\u7684\u51fd\u6570\u662f\u7a33\u5b9a\u7684\uff0c\n\u90a3\u4e48\u51fd\u6570\u6620\u5c04\u5230\u91cd\u6784\u540e\u7684\u6570\u636e\u5e93\u5c31\u8981\u7b80\u5355\u5f97\u591a\u3002</p>\n<p>\u63a5\u4e0b\u6765\u8981\u505a\u7684\u662f\u5224\u65ad\u7528\u54ea\u79cd\u65b9\u6cd5\u628a\u8d1f\u8f7d\u5206\u7247\uff0c\u4ece\u6280\u672f\u4e0a\u6765\u8bf4\uff0c\u5c31\u662f\u5224\u65ad\u7528\u54ea\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u5206\u533a\u4f9d\u636e\u3002</p>\n<p>PL/Proxy \u7684\u914d\u7f6e\u5b89\u88c5\u6709\u70b9\u590d\u6742\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u770b\u8fd9\u4e2a\u8fd9\u4e2a\u94fe\u63a5\uff1a<a href=\"http://plproxy.projects.postgresql.org/doc/tutorial.html\">http://plproxy.projects.postgresql.org/doc/tutorial.html</a></p>\n<h3 id=\"_61\">\u6563\u5217\u751f\u6210<a class=\"headerlink\" href=\"#_61\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0a\u9762\u63d0\u5230 PL/Proxy \u7684\u4e00\u4e2a\u6807\u51c6\u5de5\u4f5c\u5c31\u662f\u8868\u5206\u533a\uff0c\u56e0\u4e3a\u662f\u6c34\u5e73\u5206\u533a\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u8bb0\u5f55\u548c\u5b50\u8868\u5982\u4f55\u5bf9\u5e94\u3002\u4e00\u822c\u6211\u4eec\u91c7\u7528\u5bf9\u7279\u5b9a\u5b57\u6bb5\u505a hash \u7b97\u6cd5\u7684\u65b9\u5f0f\u6620\u5c04\u5230\u5b50\u8868\u4e2d\u3002\n\u6211\u4eec\u53ef\u4ee5\u7528 PostgreSQL \u81ea\u5e26\u7684 hashtext \u51fd\u6570\u6765\u5b9e\u73b0 hash \u7b97\u6cd5\u3002\u5b83\u53ef\u4ee5\u63a5\u53d7\u4efb\u4f55\u6587\u672c\u4f5c\u4e3a\u8f93\u5165\uff0c\u800c\u540e\u4ea7\u751f\u4e00\u4e2a\u6574\u6570\u4f5c\u4e3a hash\ncode\u3002\u5982\u679c\u4f60\u628a hash code \u548c\u4e00\u4e2a\u6570\u505a\u4f4d\u4e0e\u64cd\u4f5c\uff0c\u5219\u53ef\u4ee5\u4ea7\u751f\u6700\u4f4e\u7684\u51e0\u4f4d\u6570\u5b57\u3002\n\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u70b9\uff0c\u5206\u533a\u8868\u7684\u6570\u91cf\u5fc5\u987b\u662f 2 \u7684\u5e42\u6570(2,4,8,16 \u7b49)\uff0c\u7136\u540e\u628a hash\ncode \u548c\u6bd4\u5206\u533a\u6570\u5c11 1 \u7684\u6570\u8fdb\u884c\u4f4d\u4e0e\u3002\u6bd4\u5982\u4f60\u6709 2 \u4e2a\u5206\u533a\uff0c\u5219\u4e3a\\\"&amp;\n1\\\",4 \u4e2a\u5206\u533a\u5219\u662f\\\"&amp; 3\\\"\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p>\n<p>\u6211\u4eec\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u628a\u524d 10 \u4e2a\u81ea\u7136\u6570\u6620\u5c04\u5230 4 \u4e2a\u5206\u533a\u8868\u4e2d\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"n\">hashtext</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">::</span><span class=\"nb\">text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">generate_series</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">;</span>\n<span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">hash</span>\n<span class=\"c1\">----+------</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece hash \u4f8b\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e2a 10 \u4e2a\u81ea\u7136\u6570\u88ab\u6620\u5c04\u5230(0,1,2,3)\u96c6\u5408\u91cc\u3002</p>\n<p>hash \u8981\u8003\u8651\u7684\u53e6\u5916\u4e00\u4e2a\u60c5\u51b5\u662f\uff0c\u5bf9\u96c6\u5408\u5230\u5b50\u96c6\u7684\u6620\u5c04\u5c3d\u53ef\u80fd\u5e73\u5747\uff0c\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u524d 10000 \u4e2a\u81ea\u7136\u6570\u6620\u5c04\u5230 4 \u4e2a\u5206\u533a\u91cc\u7684\u7edf\u8ba1\u60c5\u51b5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">hashtext</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">::</span><span class=\"nb\">text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"p\">,</span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">generate_series</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">2000</span><span class=\"p\">)</span>\n<span class=\"w\"> </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">count</span>\n<span class=\"c1\">------+-------</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2550</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2411</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2531</span>\n<span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2508</span>\n<span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u6765\u770b\uff0c\u5b50\u96c6\u5143\u7d20\u7684\u6570\u91cf\u8fd8\u662f\u5f88\u5747\u7b49\u7684\u3002</p>\n<p>\u8981\u6ce8\u610f\u7684\u662f\uff0cPostgreSQL\n8.3 \u7248\u672c\u7684 hashtext \u51fd\u6570\u548c 8.4 \u7248\u672c\u7684 hashtext \u8f93\u51fa\u7ed3\u679c\u4e0d\u540c\uff0c\u56e0\u6b64\u5f53\u4f60\u4ece 8.3 \u7248\u672c\u5347\u7ea7\u65f6\uff0c\u5219\u9700\u8981\u8003\u8651\u8fd9\u70b9\u3002</p>\n<h3 id=\"_62\">\u5206\u7247<a class=\"headerlink\" href=\"#_62\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5206\u7247(Sharding)\u662f\u4e00\u79cd\u6c34\u5e73\u5206\u533a\u7684\u5f62\u5f0f\uff0c\u53ef\u4ee5\u7528 PL/Proxy \u6765\u5b9e\u73b0\u3002\u5b83\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u6709\u5206\u7247\u6570\u636e\u7ed3\u6784\uff0c\u56e0\u6b64\u8fd9\u4e9b\u8282\u70b9\u4e2d\u7684\u6bcf\u4e2a\u90fd\u53ef\u4ee5\u72ec\u7acb\u64cd\u4f5c\u3002\n\u8fd9\u4e00\u822c\u662f shared-nothing \u67b6\u6784\u6240\u6d89\u53ca\u5230\u7684\u65b9\u6848\uff0c\u6bcf\u4e2a\u5206\u7247\u8282\u70b9\u90fd\u53ef\u4ee5\u72ec\u81ea\u54cd\u5e94\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42--\u53ea\u8981\u6240\u67e5\u8be2\u7684\u6570\u636e\u5728\u5176\u4e2d\u3002</p>\n<p>\u5206\u7247\u8bbe\u8ba1\u7684\u590d\u6742\u5904\u5305\u62ec\u5982\u4f55\u534f\u540c\u4ee5\u53ca\u5206\u7247\u8282\u70b9\u5982\u4f55\u66f4\u65b0\uff0c\u5b83\u4e00\u822c\u548c\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u76f8\u5173\u3002\u6bd4\u5982 Skype \u5c31\u4f7f\u7528\u4e86 Londiste \u590d\u5236\u7a0b\u5e8f\u3002</p>\n<h3 id=\"_63\">\u603b\u7ed3<a class=\"headerlink\" href=\"#_63\" title=\"Permanent link\">&para;</a></h3>\n<p>PostgreSQL \u91cc\u7684\u6bcf\u4e00\u79cd\u5206\u533a\u65b9\u6848\u90fd\u90fd\u4e00\u5b9a\u7684\u624b\u5de5\u914d\u7f6e\u5de5\u4f5c\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u505a\u8fd9\u4e9b\u64cd\u4f5c\u524d\uff0c\u4f60\u9700\u8981\u83b7\u5f97\u8db3\u591f\u7684\u4fe1\u606f\u6765\u5224\u8bfb\u4f7f\u7528\u54ea\u79cd\u5206\u533a\u65b9\u6848\u4ee5\u53ca\u5982\u4f55\u5206\u533a\u3002</p>\n<p>\u8fd9\u91cc\u6709\u4e9b\u901a\u7528\u6307\u5bfc\u5efa\u8bae\uff1a</p>\n<ul>\n<li>\n<p>\u53ea\u6709\u6570\u636e\u5e93\u8868\u6216\u8005\u8868\u6d3b\u8dc3\u90e8\u5206\u8d85\u8fc7\u670d\u52a1\u5668\u7269\u7406\u5185\u5b58\u65f6\uff0c\u5206\u533a\u624d\u6709\u610f\u4e49\u3002</p>\n</li>\n<li>\n<p>\u9009\u62e9\u54ea\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u5206\u533a\u4f9d\u636e\u9700\u8981\u4ed4\u7ec6\u8bc4\u4f30\u9488\u5bf9\u8be5\u8868\u7684\u6240\u6709\u67e5\u8be2\uff0c\u4ee5\u786e\u4fdd\u4ed6\u4eec\u9488\u5bf9\u8be5\u5b57\u6bb5\u90fd\u6709\u9009\u62e9\u6027\u3002</p>\n</li>\n<li>\n<p>\u6bcf\u4e2a\u5206\u533a\u8868\u90fd\u9700\u8981\u624b\u5de5\u521b\u5efa\uff0c\u5305\u62ec\u7d22\u5f15\u3001\u7ea6\u675f\u4ee5\u53ca(\u6216)\u8868\u6743\u9650\u3002</p>\n</li>\n<li>\n<p>\u91cd\u5b9a\u5411 INSERT\uff0cUPDATE\uff0cDELETE \u8bed\u53e5\u5230\u5206\u533a\u8868\u7684\u6700\u5bb9\u6613\u529e\u6cd5\u662f\u4f7f\u7528\u89e6\u53d1\u5668\u3002</p>\n</li>\n<li>\n<p>\u4ece\u672a\u5206\u533a\u8868\u7684\u6570\u636e\u73b0\u573a\u8fc1\u79fb\u5230\u5206\u533a\u8868\u4e2d\u662f\u53ef\u80fd\u7684\uff0c\u867d\u7136\u4f1a\u5e26\u6765\u4e34\u65f6\u7684\u78c1\u76d8\u4f7f\u7528\u7a7a\u95f4\u7ffb\u500d\u7684\u73b0\u8c61\u3002</p>\n</li>\n<li>\n<p>\u5bf9\u4e8e\u5206\u533a\u8868\uff0c\u9700\u8981\u6253\u5f00 constraint_exclustion \u7279\u6027\uff0c\u67e5\u8be2\u624d\u4f1a\u6b63\u5e38\u5de5\u4f5c</p>\n</li>\n<li>\n<p>WHERE \u5b50\u53e5\u9700\u8981\u7b80\u5355\u503c\u624d\u80fd\u4f7f constraint exclustion \u5de5\u4f5c</p>\n</li>\n<li>\n<p>\u901a\u8fc7\u5206\u533a\u53ef\u4ee5\u6539\u8fdb\u67d0\u4e9b\u6570\u636e\u5e93\u7ef4\u62a4\u64cd\u4f5c\u3002\u5bf9\u5355\u4e2a\u5206\u533a\u8868\u6267\u884c REINDEX \u4f1a\u66f4\u5feb\uff0c\u76f8\u6bd4\u901a\u8fc7 DELETE \u5220\u9664\u8001\u7684\u6570\u636e\uff0c\u901a\u8fc7 DROP \u8001\u7684\u5206\u533a\u8868\u6765\u5220\u9664\u6570\u636e\u51e0\u4e4e\u65f6\u77ac\u65f6\u7684\uff0c</p>\n</li>\n<li>\n<p>\u4f7f\u7528\u524d\u81ea\u52a8\u521b\u5efa\u5206\u533a\u8868\u9700\u8981\u614e\u91cd\u601d\u8003\uff0c\u9700\u8981\u8003\u8651\u5230\u6761\u4ef6\u7ade\u4e89\u60c5\u51b5</p>\n</li>\n<li>\n<p>\u53ef\u4ee5\u6709\u6548\u4f7f\u7528\u7684\u5206\u533a\u8868\u6570\u4e0a\u9650\u662f\u4e24\u4f4d\u6570\u3002\u8d85\u8fc7 100 \u4e2a\u5206\u533a\u8868\u7684\u60c5\u51b5\u4e0b\uff0c\u67e5\u8be2\u4f1a\u9700\u8981\u5f88\u660e\u663e\u7684\u5f00\u9500\u6765\u8bc4\u4f30\u8fd9\u4e9b\u5206\u533a\u7ea6\u675f\u6761\u4ef6</p>\n</li>\n<li>\n<p>PL/Proxy \u53ef\u4ee5\u7528\u6765\u6709\u6548\u7684\u628a\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a\u8282\u70b9\uff0c\u4e14\u6269\u5c55\u8282\u70b9\u65e0\u9650\u5236\uff0c\u5b83\u4e5f\u53ef\u4ee5\u7528\u6765\u90e8\u7f72 shared-nothing \u67b6\u6784</p>\n</li>\n</ul>\n<h2 id=\"_64\">\u907f\u514d\u5e38\u89c1\u95ee\u9898<a class=\"headerlink\" href=\"#_64\" title=\"Permanent link\">&para;</a></h2>\n<p>PostgreSQL \u5b98\u65b9 wiki \u4e0a\u6709\u4e00\u4e2a<a href=\"http://wiki.postgresql.org/wiki/Category:FAQ\">FAQ</a>\u5217\u8868\uff0c\u5217\u51fa\u4e86\u4e00\u4e9b\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u6709\u4e9b\u6211\u4eec\u4f1a\u5728\u4e0b\u9762\u63d0\u5230\u3002</p>\n<h3 id=\"_65\">\u704c\u6570<a class=\"headerlink\" href=\"#_65\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6570\u636e\u704c\u5165\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u60c5\u5f62\u3002\u7b2c\u4e00\u79cd\u5728\u4e00\u4e2a\u7a7a\u7684\u6570\u636e\u5e93(\u8868)\u91cc\u704c\u5165\u3002\u53e6\u5916\u4e00\u79cd\u662f\u6570\u636e\u5e93(\u8868)\u91cc\u5df2\u7ecf\u6709\u6570\u636e\u4e86\uff0c\u7136\u540e\u518d\u704c\u5165\u3002\u4e24\u79cd\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u533a\u522b\u3002\n\u6bd4\u5982\u7528\u4e8e\u7b2c\u4e00\u79cd\u704c\u6570\u60c5\u5f62\u7684\u5220\u9664\u7d22\u5f15\u548c\u7ea6\u675f\u5c31\u4e0d\u9002\u5408\u7b2c\u4e8c\u79cd\u60c5\u5f62\u3002\u6211\u4eec\u5206\u522b\u4ecb\u7ecd\u3002</p>\n<h4 id=\"_66\">\u52a0\u8f7d\u65b9\u6cd5<a class=\"headerlink\" href=\"#_66\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6570\u636e\u704c\u5165\u7684\u9996\u9009\u65b9\u6cd5\u662f\u7528 PostgreSQL \u7279\u6709\u7684 COPY \u6307\u4ee4\uff0c\u8fd9\u662f\u63d2\u5165\u5927\u91cf\u884c\u8bb0\u5f55\u7684\u6700\u5feb\u65b9\u6cd5\u3002\n\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4f20\u7edf\u7684 INSERT \u6307\u4ee4\uff0c\u4f46\u5373\u4fbf\u7528\u4e0a BEGIN/COMMIT \u65b9\u5f0f\u5305\u88f9\u591a\u6761 INSERT \u8bed\u53e5\uff0c\u901f\u5ea6\u4e5f\u4e0d\u5982 COPY \u6765\u7684\u5feb\u3002</p>\n<p>\u4e0b\u9762\u662f\u4ece\u6162\u5230\u5feb\u7684\u4e00\u4e2a\u6570\u636e\u63d2\u5165\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\n<p>\u4e00\u6b21\u63d2\u5165\u5355\u4e2a\u8bb0\u5f55</p>\n</li>\n<li>\n<p>\u4e00\u6b21\u63d2\u5165\u591a\u6761\u8bb0\u5f55</p>\n</li>\n<li>\n<p>\u4e00\u6b21\u4f7f\u7528\u5355\u4e2a COPY \u6307\u4ee4\uff0c\u8fd9\u4e5f\u662f\u6807\u51c6 pg_restore \u6240\u7528\u65b9\u6cd5</p>\n</li>\n<li>\n<p>\u591a\u6761\u63d2\u5165\u6307\u4ee4\u5e76\u884c\u6267\u884c\uff0c\u6bcf\u6761\u63d2\u5165\u6307\u4ee4\u5305\u62ec\u591a\u6761\u8bb0\u5f55</p>\n</li>\n<li>\n<p>\u4e00\u6b21\u4f7f\u7528\u591a\u4e2a COPY \u6307\u4ee4\u3002\u8fd9\u662f\u5e76\u884c pg_restore \u6240\u7528\u65b9\u6cd5</p>\n</li>\n</ol>\n<h4 id=\"_67\">\u5916\u90e8\u704c\u6570\u7a0b\u5e8f<a class=\"headerlink\" href=\"#_67\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4f7f\u7528 COPY \u6307\u4ee4\u9700\u8981\u8003\u8651\u7684\u4e00\u70b9\u662f\uff0c\u53ea\u8981\u51fa\u73b0\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u7ec8\u7aef\u6240\u6709\u7684\u5de5\u4f5c\u3002\u60f3\u8c61\u4f60\u4e00\u4e0b\u5c31\u56e0\u4e3a\u6700\u540e\u4e00\u6761\u8bb0\u5f55\u6709\u95ee\u9898\uff0c\u4ece\u800c\u5bfc\u81f4\u4f60\u524d\u9762\u5927\u91cf\u7684\u6570\u636e\u63d2\u5165\u90fd\u5931\u6548\uff0c\u8fd9\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002</p>\n<p>\u5047\u5b9a\u4f60\u662f\u4ece\u5916\u90e8\u6570\u636e\u6e90\u5012\u5165\u6570\u636e\uff0c\u90a3\u5c31\u5e94\u8be5\u8003\u8651\u5bfc\u5165\u64cd\u4f5c\u5e94\u8be5\u53ef\u4ee5\u6301\u7eed\u5de5\u4f5c\uff0c\u7136\u540e\u628a\u56e0\u4e3a\u9519\u8bef\u62d2\u7edd\u63d2\u5165\u7684\u6570\u636e\u53e6\u5916\u4fdd\u5b58\u8d77\u6765\u3002<a href=\"http://pgfoundry.org/projects/pgloader/\">pgloader</a>\u5c31\n\u53ef\u4ee5\u505a\u5230\u8fd9\u70b9\uff0c\u867d\u7136\u5b83\u4e0d\u5982 COPY \u6765\u5f97\u5feb\uff0c\u4f46\u5bf9\u4e8e\u5916\u90e8\u6570\u636e\u683c\u5f0f\u5e76\u4e0d\u90a3\u4e48\u4e25\u683c\u65f6\uff0c\u8fd9\u662f\u6700\u597d\u7684\u65b9\u5f0f\u3002</p>\n<p>\u53e6\u5916\u4e00\u4e2a\u7528\u4e8e\u67d0\u4e9b\u7279\u5b9a\u573a\u666f\u4e0b\u7684\u704c\u6570\u7a0b\u5e8f\u662f<a href=\"http://pgbulkload. projects.postgresql.org/\">pg_bulkload</a>\uff0c\u5b83\u6709\u65f6\u751a\u81f3\u6bd4 COPY \u8fd8\u8981\u5feb\uff0c\u8fd9\u5f97\u610f\u4e8e\u5b83\u91c7\u53d6\u79ef\u6781\u7684\u9ad8\u6027\u80fd\u7279\u6027\uff0c\u6bd4\u5982\u7ed5\u8fc7 WAL\u3002\n\u5b83\u4e5f\u53ef\u4ee5\u5904\u7406\u574f\u7684\u6570\u636e\u884c\u3002</p>\n<h4 id=\"_68\">\u4e3a\u704c\u6570\u8c03\u4f18<a class=\"headerlink\" href=\"#_68\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u704c\u8f93\u800c\u5173\u95ed\u8868\u4e0a\u7684\u6240\u6709\u7d22\u5f15\u4ee5\u53ca\u7ea6\u675f\u53ea\u6700\u9700\u8981\u505a\u7684\u4e8b\u60c5\uff0c\u704c\u8f93\u540e\u5728\u521b\u5efa\u7d22\u5f15\u4f1a\u66f4\u5feb\uff0c\u66f4\u597d\u7684\u78c1\u76d8\u788e\u7247\u3002\u704c\u8f93\u540e\u505a\u7ea6\u675f\u68c0\u67e5\u8981\u5feb\u5f88\u591a\u3002</p>\n<p>postgresql.conf \u91cc\u7684\u51e0\u4e2a\u53c2\u6570\u4e5f\u53ef\u4ee5\u5728\u704c\u6570\u65f6\u505a\u4e34\u65f6\u8c03\u6574\uff0c\u53ef\u4ee5\u52a0\u5feb\u704c\u6570\u7684\u901f\u5ea6\uff1a</p>\n<ul>\n<li>\n<p>maintenance_work_mem:\n  \u5c3d\u53ef\u80fd\u52a0\u5927\u8be5\u503c\uff0c\u5bf9\u4e8e\u8d85\u8fc7 16G \u5185\u5b58\u7684\u670d\u52a1\u5668\uff0c\u914d\u7f6e 1GB \u7684\u8be5\u53c2\u6570\u5c31\u4e0d\u5408\u9053\u7406\u3002CREATE\n  INDEX \uff0cALTER TABLE ADD FOREIGN KEY \u90fd\u9700\u8981\u5b83\u3002</p>\n</li>\n<li>\n<p>checkpoint_segments:\n  \u8981\u6bd4\u6b63\u5e38\u4f7f\u7528\u65f6\u7684\u503c\u5927\u5f88\u591a\uff0c\u56e0\u4e3a\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u4ee5\u53ca\u78c1\u76d8\u7a7a\u95f4\u5728\u8fd9\u4e2a\u65f6\u95f4\u6bb5\u5e76\u4e0d\u662f\u9700\u8981\u5173\u6ce8\u7684\u4e8b\u60c5\u3002\u901a\u5e38\u8bbe\u7f6e\u4e3a 128-256\u3002\u540c\u6837\u53ef\u4ee5\u52a0\u5927 checkpoint_timeout\n  \u7684\u503c\uff0c\u8bbe\u7f6e\u4e3a 30m \u662f\u5408\u7406\u7684</p>\n</li>\n<li>\n<p>autovacuum: \u704c\u6570\u65f6\u5173\u95ed\u8be5\u7279\u6027</p>\n</li>\n<li>\n<p>wal_buffers: \u5b83\u5f88\u5bb9\u6613\u6210\u4e3a\u704c\u6570\u7684\u74f6\u9888\uff0c\u8bbe\u7f6e\u5230\u5176\u6700\u5927\u503c 16MB\u3002</p>\n</li>\n<li>\n<p>synchronous_commit:\n  \u5173\u95ed\u8be5\u53c2\u6570\uff0c\u5173\u95ed\u540e\u5982\u679c\u56e0\u4e3a\u5d29\u6e83\u800c\u5bfc\u81f4\u4e22\u5931\u67d0\u4e9b\u4e8b\u52a1\uff0c\u7b80\u5355\u6e05\u7a7a\u5d29\u6e83\u524d\u6700\u540e\u704c\u5165\u7684\u8868\uff0c\u91cd\u65b0\u704c\u5165\u5c31\u597d\u4e86</p>\n</li>\n<li>\n<p>fsync:\n  \u8be5\u53c2\u6570\u53ea\u6709\u5728\u704c\u6570\u65f6\u53ef\u4ee5\u8003\u8651\u5173\u95ed\u3002\u5e26\u6765\u7684\u4e3b\u8981\u95ee\u9898\u662f\u5f53\u6570\u636e\u5e93\u5d29\u6e83\u65f6\uff0c\u6570\u636e\u53ef\u80fd\u635f\u574f\uff0c\u4f46\u4e0d\u662f\u81f4\u547d\u9519\u8bef\u3002\u53ea\u9700\u8981\u5b8c\u5168\u91cd\u65b0\u704c\u6570\u5c31\u597d</p>\n</li>\n<li>\n<p>vacuum_freeze_min_age: \u8bbe\u7f6e\u4e3a\u6bd4 0 \u5c0f\u7684\u53c2\u6570</p>\n</li>\n</ul>\n<h4 id=\"wal\">\u8df3\u8fc7 WAL \u6765\u52a0\u901f<a class=\"headerlink\" href=\"#wal\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5047\u5b9a\u4e00\u4e2a\u704c\u6570\u4ee3\u7801\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">BEGIN</span><span class=\"p\">;</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"p\">...;</span>\n<span class=\"k\">COPY</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"p\">...;</span>\n<span class=\"k\">COMMIT</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u4e0a\u8ff0\u4ee3\u7801\u6267\u884c\u4e0d\u4f1a\u4ea7\u751f\u4efb\u4f55 WAL \u8bb0\u5f55\uff0c\u56e0\u6b64\u6267\u884c\u8d77\u6765\u66f4\u5feb\u3002\u540c\u7406\uff0c\u5982\u679c\u4f60\u7528 TRUNCATE \u800c\u4e0d\u662f DELETE \u6e05\u7a7a\u4e00\u4e2a\u8868\u4e5f\u80fd\u83b7\u5f97\u63d0\u901f\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u8bbe\u7f6e\u4e86 archive_command \u53c2\u6570\u6765\u83b7\u5f97 PITR \u7279\u6027\uff0c\u90a3\u4e48\u4e0a\u8ff0\u4f18\u5316\u5c31\u751f\u6548\u4e86\u3002</p>\n<h4 id=\"_69\">\u91cd\u5efa\u7d22\u5f15\u548c\u589e\u52a0\u7ea6\u675f<a class=\"headerlink\" href=\"#_69\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7d22\u5f15\u91cd\u5efa\u5f88\u53ef\u80fd\u6210\u4e3a CPU\u3001\u5185\u5b58\u4ee5\u53ca\u78c1\u76d8\u5bc6\u96c6\u578b\u64cd\u4f5c\u3002\u5982\u679c\u4f60\u6709\u4e2a\u5927\u78c1\u76d8\u9635\u5217\uff0c\u90a3\u4e48\u5e76\u884c\u8fd0\u884c\u4e24\u4e2a\u6216\u4ee5\u4e0a\u91cd\u5efa\u6307\u4ee4\u662f\u975e\u5e38\u5408\u7406\u7684\u3002\n\u5982\u524d\u6240\u8ff0\uff0c\u589e\u52a0 shared_buffers,checkpoint_segment,checkpoint_timeout,maintenance_work_mem \u53c2\u6570\u503c\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p>\n<h4 id=\"_70\">\u5e76\u884c\u6062\u590d<a class=\"headerlink\" href=\"#_70\" title=\"Permanent link\">&para;</a></h4>\n<p>PostgreSQL\n8.4 \u5f15\u5165\u4e86\u5e76\u884c\u6062\u590d\u673a\u5236\uff0c\u5b83\u5141\u8bb8\u4f60\u5206\u914d\u670d\u52a1\u5668\u4e0a\u7684\u591a\u4e2a CPU \u6838\u6765\u8fd0\u884c\u4e13\u95e8\u7684\u6570\u636e\u52a0\u8f7d\u8fdb\u7a0b\u3002\u4f7f\u7528\u5e76\u884c\u7248\u672c\u7684 pg_restore\uff0c\u5f88\u7b80\u5355\u4f60\u53ea\u9700\u8981\u6307\u5b9a\u4f60\u4e00\u6b21\u60f3\u8fd0\u884c\n\u591a\u5c11\u4e2a\"jobs\"\u5c31\u597d\u4e86\uff0c\u5b83\u5bf9\u6570\u636e\u52a0\u8f7d\u4ee5\u53ca\u7d22\u5f15\u91cd\u5efa\u548c\u589e\u52a0\u7ea6\u675f\u90fd\u6709\u63d0\u901f\u6548\u679c\u3002</p>\n<h4 id=\"_71\">\u704c\u6570\u540e\u6e05\u7406\u5de5\u4f5c<a class=\"headerlink\" href=\"#_71\" title=\"Permanent link\">&para;</a></h4>\n<p>\u704c\u6570\u5b8c\u6bd5\uff0c\u7d22\u5f15\u91cd\u5efa\u5b8c\u6210\uff0c\u7ea6\u675f\u589e\u52a0\u5b8c\u6bd5\u3002\u628a\u670d\u52a1\u5668\u4e0a\u7ebf\u4e4b\u524d\u8fd8\u6709\u4e24\u4e2a\u7ef4\u62a4\u5de5\u4f5c\u8981\u505a\u3002\n\u7b2c\u4e00\u4e2a\u5fc5\u987b\u8981\u505a\u662f\u5bf9\u6bcf\u4e2a\u6570\u636e\u5e93\u6267\u884c ANALYZE \u6307\u4ee4\u3002\u786e\u4fdd\u7edf\u8ba1\u4fe1\u606f\u6709\u6548\u53ef\u7528\u3002\u540c\u65f6\u4e5f\u53ef\u4ee5\u8003\u8651\u8fd0\u884c\u6570\u636e\u5e93\u7ea7\u7684 VACUUM\u3002\u5f53\u7136\u4f60\u76f4\u63a5\u8fd0\u884c VACUUM\nANALYZE \u4f1a\u66f4\u597d\u3002\n\u7b2c\u4e8c\u4e2a\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u628a postgresql.conf \u91cc\u4fee\u6539\u8fc7\u7684\u53c2\u6570\u6062\u590d\u5230\u6b63\u5e38\u8bbe\u7f6e\u3002</p>\n<h3 id=\"_72\">\u5e38\u89c1\u6027\u80fd\u95ee\u9898<a class=\"headerlink\" href=\"#_72\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f88\u591a\u6027\u80fd\u95ee\u9898\u90fd\u662f\u6765\u81ea\u7cdf\u7cd5\u7684\u8bbe\u8ba1\u6216\u8005\u5b9e\u73b0\uff0c\u4f7f\u5f97 PostgreSQL \u65e0\u6cd5\u4ece\u6839\u672c\u4e0a\u5f88\u597d\u7684\u8fd0\u884c\u3002\u4e0b\u9762\u6211\u4eec\u5217\u4e3e\u4e00\u4e9b PostgreSQL \u65b0\u624b\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u6027\u80fd\u95ee\u9898\uff1a</p>\n<h4 id=\"_73\">\u7edf\u8ba1\u884c\u6570<a class=\"headerlink\" href=\"#_73\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5e94\u7528\u7a0b\u5e8f\u91cc\u5927\u90e8\u5206\u90fd\u6709\u7c7b\u4f3c\u4e0b\u9762\u7684 SQL \u8bed\u53e5\u6765\u8ba1\u7b97\u4e00\u4e2a\u8868\u91cc\u6709\u591a\u5c11\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6709\u4e9b\u6570\u636e\u5e93\u53ef\u80fd\u6267\u884c\u8fd9\u4e2a\u5f88\u5feb\uff0c\u901a\u5e38\u4ed6\u4eec\u628a\u8fd9\u4e2a\u4fe1\u606f\u4fdd\u5b58\u5230\u4e00\u4e2a\u7d22\u5f15\u91cc\u6216\u8005\u7c7b\u4f3c\u7684\u7ed3\u6784\u91cc\u3002\n\u4e0d\u5e78\u7684\u662f\uff0cPostgreSQL \u6ca1\u8fd9\u4e48\u5e72\uff0c\u5b83\u9700\u8981\u6267\u884c\u5168\u8868\u626b\u63cf\u624d\u80fd\u83b7\u5f97\u7ed3\u679c\uff0c\u8fd9\u5c31\u76f8\u5f53\u6162\u4e86\u3002\n\u5bf9\u6b64\uff0cPostgreSQL \u63d0\u4f9b\u4e86\u4e24\u4e2a\u66ff\u4ee3\u65b9\u6cd5\u3002\u7b2c\u4e00\u4e2a\u65b9\u6cd5\u662f\u5bf9\u4e8e\u90a3\u4e9b\u5e76\u4e0d\u9700\u8981\u7cbe\u786e\u7684\u8868\u884c\u6570\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u7cfb\u7edf\u8868\u91cc\u67e5\u8be2\u76f8\u5173\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a</p>\n<p><code>SELECT reltuples FROM pg_class where relname='t'</code></p>\n<p>\u5982\u679c\u8fd0\u884c\u8be5 SQL \u8bed\u53e5\u4e4b\u524d\u521a\u597d\u8fd0\u884c\u8fc7 VACUUM \u6216\u8005 ANALYZE\uff0c\u5219\u8fd9\u4e2a\u7ed3\u679c\u662f\u51c6\u786e\u7684\uff0c\u800c\u4e0d\u662f\u4f30\u8ba1\u503c\u3002</p>\n<p>\u5982\u679c\u4f60\u6709\u540c\u540d\u7684\u8868\uff0c\u90a3\u4e48\u5c31\u52a0\u4e0a\u540d\u5b57\u7a7a\u95f4\u9650\u5b9a\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">reltuples</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">pg_class</span><span class=\"w\"> </span><span class=\"k\">C</span>\n<span class=\"k\">LEFT</span><span class=\"w\"> </span><span class=\"k\">JOIN</span><span class=\"w\"> </span><span class=\"n\">pg_namespace</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">.</span><span class=\"n\">oid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">relnamespace</span><span class=\"p\">)</span>\n<span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">.</span><span class=\"n\">relname</span><span class=\"o\">=</span><span class=\"s1\">&#39;t&#39;</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"p\">.</span><span class=\"n\">nspname</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;public&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7b2c\u4e8c\u529e\u6cd5\u662f\u5728\u8868\u4e0a\u521b\u5efa\u4e00\u4e2a\u89e6\u53d1\u5668\uff0c\u8ddf\u8e2a\u8868\u4e0a\u6570\u636e\u7684\u5220\u9664\u548c\u589e\u52a0\u64cd\u4f5c\uff0c\u4ece\u800c\u628a\u7edf\u8ba1\u884c\u6570\u8bb0\u5f55\u4e0b\u6765\u3002\n\u5177\u4f53\u7684\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u4f8b\u5b50\uff1a<a href=\"http://wiki.postgresql.org/wiki/Slow_Counting\">http://wiki.postgresql.org/wiki/Slow_Counting</a></p>\n<h4 id=\"_74\">\u5916\u952e\u5f00\u9500\u9ad8<a class=\"headerlink\" href=\"#_74\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5f53\u66f4\u65b0\u8bed\u53e5\u91cc\u6d89\u53ca\u5230\u5916\u952e\uff0c\u5176\u65f6\u95f4\u5f00\u9500\u5f88\u5927\uff0c\u7279\u522b\u662f\u6bcf\u6b21\u53ea\u505a\u4e00\u884c\u66f4\u65b0\u65f6\u3002\u5bf9\u4e8e\u6279\u91cf\u66f4\u65b0\uff0c\u53ef\u80fd\u7684\u4e00\u4e2a\u6027\u80fd\u63d0\u5347\u529e\u6cd5\u65f6\u628a\u5916\u952e\u7ea6\u675f\u6807\u8bb0\u4e3a DEFERRABLE\uff0c\u7f3a\u7701\u662f\nNOT\nDEFERRABLE\u3002\u4e0d\u8fc7\u8fd9\u79cd\u8bbe\u7f6e\u53ea\u5bf9\u628a\u5916\u952e\u548c\u76f8\u4f3c\u7ea6\u675f\u4f5c\u4e3a\u89e6\u53d1\u5668\u5b9e\u73b0\u65f6\u624d\u6709\u6548\uff0c\u800c\u5bf9\u4e8e CHECK \u4ee5\u53ca UNIQUE \u9650\u5b9a\u5219\u65e0\u80fd\u4e3a\u529b\u3002\u540e\u8005\u8981\u6c42\u7acb\u523b\u5904\u7406\uff0c\u4e0d\u80fd\u5ef6\u7f13\u3002</p>\n<p>\u5373\u4fbf\u5bf9\u4e8e\u7ea6\u675f\u5ef6\u7f13\uff0c\u4e5f\u6709\u4e24\u79cd\u60c5\u51b5\u3002\u5982\u679c\u68c0\u67e5\u6807\u8bb0\u4e3a INITIALLY\nIMMEDIATE\uff0c\u90a3\u4e5f\u4f1a\u7acb\u523b\u5904\u7406\uff0c\u800c\u4e0d\u662f\u5728\u4e8b\u52a1\u7684\u6700\u540e\u6765\u5904\u7406\u3002\u6b64\u65f6\u4f60\u53ef\u4ee5\u4fee\u6539\u7ea6\u675f\u4e3a INITIALLY\nDEFERRED\uff0c\u8fd9\u6837\u53ef\u4ee5 \u786e\u4fdd\u68c0\u67e5\u5728\u4e8b\u52a1\u6700\u540e\u5904\u7406\u3002</p>\n<p>\u5f53\u68c0\u67e5\u6807\u8bb0\u4e3a DEFERRABLE\uff0c\u5b83\u540c\u65f6\u4e3a INITIALLY IMMEDIATE \u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 SET\nCONSTRAINTS \u6307\u4ee4\u4fee\u6539\u90e8\u5206\u4f1a\u8bdd\u3002\u5176\u6807\u51c6\u505a\u6cd5\u662f\uff0c\u628a\u591a\u6761\u63d2\u5165\u6216\u66f4\u65b0\u8bed\u53e5\u653e\u5728\n\u4e00\u4e2a\u4e8b\u52a1\u91cc\uff0c\u4e14\u4e8b\u52a1\u5f00\u5934\u6807\u8bb0\u6240\u6709\u7ea6\u675f\u4e3a\u5ef6\u7f13\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>BEGIN;\nSET CONSTRAINTS ALL DEFERRED;\n[ update or insert statements ]\nCOMMIT;\n</code></pre></div>\n<p>\u8fd9\u79cd\u5904\u7406\u65b9\u5f0f\u5bf9\u6279\u91cf\u66f4\u65b0/\u63d2\u5165\u53ef\u4ee5\u63d0\u5347\u6548\u7387\uff0c\u4f46\u662f\u5982\u679c\u91cf\u5f88\u5927\uff0c\u5219\u5728\u505a COMMIT \u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u963b\u585e\u670d\u52a1\u4e00\u6bb5\u65f6\u95f4\uff0c\u4ece\u800c\u5bfc\u81f4\u65e0\u6cd5\u5bf9\u5916\u54cd\u5e94\u3002</p>\n<h4 id=\"_75\">\u89e6\u53d1\u5668\u5185\u5b58\u4f7f\u7528<a class=\"headerlink\" href=\"#_75\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5982\u679c\u4e00\u4e2a\u8868\u4e0a\u6709 AFTER \u7c7b\u578b\u89e6\u53d1\u5668\uff0c\u90a3\u4e48\u6bcf\u4e2a\u63d2\u5165\u8bed\u53e5\u90fd\u4f1a\u5728\u4e00\u4e2a\u5185\u5b58\u5217\u8868\u91cc\uff0c\u5982\u679c\u63d2\u5165\u7684\u6570\u91cf\u5f88\u5927\uff0c\u6bd4\u5982\u6279\u91cf\u52a0\u8f7d\u65f6\uff0c\u5c31\u6709\u53ef\u80fd\u51fa\u73b0 OOM\uff0c\u6216\u8005\u8fbe\u5230\u7cfb\u7edf\u8bbe\u7f6e\u7684\u5185\u5b58\u6781\u9650\u3002\n\u56e0\u6b64\u5728\u6279\u91cf\u5012\u5165\u573a\u666f\u4e0b\uff0c\u8981\u6ce8\u610f AFTER \u7c7b\u578b\u89e6\u53d1\u5668\u3002</p>\n<h3 id=\"_76\">\u6570\u636e\u5e93\u6027\u80fd\u5206\u6790<a class=\"headerlink\" href=\"#_76\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6709\u65f6\u8981\u627e\u51fa\u4f60\u7684\u4ee3\u7801\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u6709\u6548\u7684\u5de5\u4f5c\u7684\u529e\u6cd5\u65f6\u6df1\u5165\u5230\u6570\u636e\u5e93\u672c\u8eab\uff0c\u5e76\u67e5\u5230\u6709\u74f6\u9888\u7684\u4ee3\u7801\u3002\u6211\u4eec\u901a\u8fc7\u4e00\u4e9b\u5de5\u5177\u6765\u505a\u5230\u8fd9\u70b9\uff1a</p>\n<h4 id=\"gprof\">gprof<a class=\"headerlink\" href=\"#gprof\" title=\"Permanent link\">&para;</a></h4>\n<p>gprof \u662f\u4e00\u4e2a\u6807\u51c6\u7684 GNU \u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u53ef\u4ee5\u5728\u5927\u90e8\u5206\u7c7b UNIX \u7cfb\u7edf\u4e0a\u8fd0\u884c\uff0c\u7f16\u8bd1 PostgreSQL \u65f6\uff0c\u589e\u52a0--enable-profiling \u9009\u9879\uff0c\u5b83\u4f1a\u4ea7\u751f\u4e00\u4e2a gmon.out \u6587\u4ef6\uff0c\u8fd9\u6839\u636e\u53ef\u4ee5\u7528\u4e8e gprof \u6765\u505a\u6027\u80fd\u5206\u6790\u3002</p>\n<p>gprof \u7684\u4e3b\u8981\u95ee\u9898\u65f6\u5b83\u5728\u8ddf\u8e2a\u5230\u53ef\u52a0\u8f7d\u5e93\u7684\u51fd\u6570\u65f6\u4f1a\u51fa\u73b0\u5df2\u77e5\u95ee\u9898\u3002\u53e6\u5916\uff0c\u5b83\u4e5f\u5f88\u80fd\u6839\u636e\u5206\u6790\u4fe1\u606f\u6765\u83b7\u5f97\u4e0b\u5c42\u64cd\u4f5c\u7cfb\u7edf\u6b63\u5728\u505a\u4ec0\u4e48\u3002\u56e0\u6b64\uff0c\u7efc\u5408\u8fd9\u4e24\u4e2a\u9650\u5236\uff0cgprof \u53ea\u9002\u5408\u505a\u4e00\u4e9b\u7b80\u5355\u548c\u5355\u7eaf\u7684\u6570\u636e\u5e93\u64cd\u4f5c\u6027\u80fd\u5206\u6790\u3002</p>\n<h4 id=\"oprofile\">OProfile<a class=\"headerlink\" href=\"#oprofile\" title=\"Permanent link\">&para;</a></h4>\n<p>OProfile \u53ef\u4ee5\u5206\u6790\u4efb\u4f55\u5728 Linux \u670d\u52a1\u5668\u4e0a\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u68d2\u7684\u5de5\u5177\u3002\u4e5f\u662f\u5f88\u591a\u5728 Linux \u5199\u7684\u7801\u519c\u4eec\u7684\u9996\u9009\u5de5\u5177\u3002<a href=\"http://wiki.postgresql.org/wiki/Profiling_with_OProfile\">http://wiki.postgresql.org/wiki/Profiling_with_OProfile</a>\u4ecb\u7ecd\u7684\u5f88\u8be6\u7ec6\u3002</p>\n<h4 id=\"visual-studio\">Visual Studio<a class=\"headerlink\" href=\"#visual-studio\" title=\"Permanent link\">&para;</a></h4>\n<p>Windows \u5e73\u53f0\u7684\u6700\u4f73\u9009\u62e9(\u6216\u552f\u4e00\u9009\u62e9\uff1f)\uff0c\u4ece PostgreSQL 8.4 \u4ee5\u540e\u6709\u6548\u3002</p>\n<h4 id=\"dtrace\">DTrace<a class=\"headerlink\" href=\"#dtrace\" title=\"Permanent link\">&para;</a></h4>\n<p>Sun \u516c\u53f8\u5728 2004 \u5e74\u53d1\u5e03\u7684 Solaris\n10 \u4e2d\u5f15\u5165 DTrace\uff0c\u53ef\u80fd\u65f6\u6700\u5168\u9762\u7684\u6027\u80fd\u5206\u6790\u5de5\u5177\u3002</p>\n<p>PostgreSQL \u7f16\u8bd1\u65f6\u9700\u8981\u4f7f\u7528--enable-dtrace \u9009\u9879\u624d\u80fd\u4f7f\u7528 DTrace\uff0c\u5bf9\u4e8e\u5982\u4f55\u4f7f\u7528 DTrace\uff0c\u6050\u6016\u53ef\u4ee5\u7528\u4e00\u672c\u4e66\u7684\u5bb9\u91cf\u6765\u4ecb\u7ecd\u3002\u6211\u4eec\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684\u4e24\u4e2a\u94fe\u63a5\uff1a</p>\n<ul>\n<li>\n<p><a href=\"http://www.postgresql.org/docs/current/interactive/dynamic-trace.html\">http://www.postgresql.org/docs/current/interactive/dynamic-trace.html</a></p>\n</li>\n<li>\n<p><a href=\"http://wiki.postgresql.org/wiki/DTrace\">http://wiki.postgresql.org/wiki/DTrace</a></p>\n</li>\n</ul>\n<h4 id=\"linux-systemtap\">Linux SystemTap<a class=\"headerlink\" href=\"#linux-systemtap\" title=\"Permanent link\">&para;</a></h4>\n<p>SystemTap \u662f Linux \u5e73\u53f0\u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u5176\u529f\u80fd\u7c7b\u4f3c DTrace\u3002\u5bf9\u4f7f\u7528\u4e86--enable-dtrace \u7f16\u8bd1\u7684 PostgreSQL\uff0cSystemTap \u53ef\u4ee5\u4f7f\u7528\u3002</p>\n<p>\u76ee\u524d Fedora,RHEL \u7cfb\u7edf\u53d1\u578b\u73ed\u529e\u6cd5\u90fd\u80fd\u652f\u6301 SystemTap,\u4f46 Debian/Ununtu \u5219\u53ef\u80fd\u4f1a\u6709\u4e9b\u95ee\u9898\u3002</p>\n<h3 id=\"_77\">\u4e0e\u7248\u672c\u6709\u5173\u7684\u6027\u80fd\u7279\u6027<a class=\"headerlink\" href=\"#_77\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e66\u4e2d\u63cf\u8ff0\u4e86\u5404\u79cd\u548c\u7248\u672c\u6709\u5173\u7684\u6027\u80fd\u7279\u6027\uff0c\u8fd9\u91cc\u65f6\u6458\u5f55\u4e8e 9.0 \u6709\u5173\u7684\u7279\u6027\u3002</p>\n<h4 id=\"_78\">\u590d\u5236<a class=\"headerlink\" href=\"#_78\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>\u5f02\u6b65\u4e3b\u4ece\u590d\u5236\u5df2\u7ecf\u5185\u7f6e\uff0c\u4e14\u4e0d\u9700\u8981\u914d\u7f6e\u592a\u591a\u989d\u5916\u811a\u672c</p>\n</li>\n<li>\n<p>\u590d\u5236\u7cfb\u7edf\u8fd8\u53ef\u4ee5\u914d\u7f6e\u4e3a HotStandby \u7528\u4e8e\u53ea\u8bfb\u67e5\u8be2</p>\n</li>\n<li>\n<p>\u63a7\u5236 WAL \u5f52\u6863\u53c2\u6570\u5206\u5f00\uff0c\u9664\u4e86\u5df2\u7ecf\u5b58\u5728\u7684 archive_mode \u548c archive_command \u4ee5\u5916\uff0c\u65b0\u589e\u4e86 wal_level \u53c2\u6570\u7528\u4e8e\u8bbe\u7f6e\u5141\u8bb8\u5199\u591a\u5c11\u4fe1\u606f\u5230 WAL \u91cc</p>\n</li>\n<li>\n<p>\u590d\u5236\u8fc7\u7a0b\u7684\u76d1\u63a7\u53ef\u4ee5\u901a\u8fc7 standby \u670d\u52a1\u5668\u4f7f\u7528 pg_last_xlog_receive_location()\u548c pg_last_xlog_replay_location()\u51fd\u6570\u5b9e\u73b0</p>\n</li>\n<li>\n<p>contrib/pg_archivecleanup \u5de5\u5177\u53ef\u4ee5\u7528\u4e8e\u6e05\u9664\u8001\u7684 WAL \u5f52\u6863\u6587\u4ef6\u3002\u8be5\u7a0b\u5e8f\u53ef\u4ee5\u88ab archive_cleanup_command \u53c2\u6570\u8c03\u7528</p>\n</li>\n</ul>\n<h4 id=\"_79\">\u67e5\u8be2\u548c\u5206\u6790<a class=\"headerlink\" href=\"#_79\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>EXPLAIN \u53ef\u4ee5\u8f93\u51fa\u4e3a XML\uff0cJSON \u6216 YAML \u683c\u5f0f\uff0c\u65b9\u4fbf\u5916\u90e8\u5de5\u5177\u5206\u6790</p>\n</li>\n<li>\n<p>EXPLAIN \uff08BUFFERS\uff09 \u53ef\u4ee5\u76d1\u63a7\u67d0\u4e2a\u7279\u5b9a\u67e5\u8be2\u7684\u5b9e\u9645 I/O,\u800c\u4e0d\u662f\u663e\u793a\u6210\u672c</p>\n</li>\n<li>\n<p>\u7a97\u53e3\u51fd\u6570\u65b0\u589e\u4e86\u8bf8\u5982 PRECEDING\uff0cFOLLOWING \u9009\u9879\uff0c\u4ee5\u53ca\u7528 CURRENT\n  ROWS \u5f00\u59cb\u7684\u9009\u9879</p>\n</li>\n<li>\n<p>\u5916\u8054\u63a5\u6240\u5f15\u7528\u5230\u7684\u8868\u5982\u679c\u5e76\u6ca1\u7528\u4e8e\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\uff0c\u5219\u4f1a\u4ece\u67e5\u8be2\u8ba1\u5212\u4e2d\u79fb\u53bb\u4ee5\u63d0\u5347\u6027\u80fd\n  \u3002\u4e00\u822c\u8fd9\u7c7b\u67e5\u8be2\u8bed\u53e5\u7531 ORM \u8f6f\u4ef6\u751f\u6210\u3002</p>\n</li>\n<li>\n<p>\u6bcf\u4e2a\u8868\u7a7a\u95f4\u53ef\u4ee5\u901a\u8fc7 ALTER\n  TABLESPACE \u6765\u5206\u914d\u81ea\u5df1\u7684\u987a\u5e8f\u548c\u968f\u673a\u9875\u67e5\u8be2\u4ee3\u4ef7\uff0c\u5bf9\u4e8e\u4e0d\u540c\u8868\u7a7a\u95f4\u5206\u914d\u5728\u4e0d\u540c\u901f\u5ea6\u7684\u5b58\u50a8\u4ecb\u8d28\u4e0a\u8fd9\u79cd\u60c5\u51b5\uff0c\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u8c03\u6574</p>\n</li>\n<li>\n<p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 ALTER\n  TABLE \u6765\u624b\u5de5\u8c03\u6574\u4e00\u4e2a\u5b57\u6bb5\u4e0d\u540c\u503c\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u5f53\u81ea\u52a8\u8bc4\u4f30\u6709\u95ee\u9898\u65f6\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u63d0\u5347\u6548\u7387</p>\n</li>\n<li>\n<p>\u4f7f\u7528 IS NOT NULL \u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u4f7f\u7528\u7d22\u5f15</p>\n</li>\n<li>\n<p>\u57fa\u56e0\u67e5\u8be2\u4f18\u5316\u5668(Genetic Query Optimizer a.k.a\n  GEQO)\u73b0\u5728\u53ef\u4ee5\u5f3a\u5236\u4f7f\u7528\u56fa\u5b9a\u7684\u968f\u673a\u79cd\u5b50\u503c</p>\n</li>\n<li>\n<p>GIN \u7d22\u5f15\u4f7f\u7528\u81ea\u5e73\u8861\u7ea2\u9ed1\u6811(self-balancing Red-Black trees)</p>\n</li>\n</ul>\n<h4 id=\"_80\">\u6570\u636e\u5e93\u5f00\u53d1<a class=\"headerlink\" href=\"#_80\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>PL/pgSQL \u8bed\u53e5\u73b0\u5728\u7f3a\u7701\u5b89\u88c5\u5230\u6240\u6709\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u5220\u9664</p>\n</li>\n<li>\n<p>\u89e6\u53d1\u5668\u53ef\u4ee5\u9644\u7740\u5728\u7279\u5b9a\u7684\u5b57\u6bb5\u4e0a\uff0c\u4ee5\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8c03\u7528</p>\n</li>\n<li>\n<p>LISTEN/NOTIFY \u673a\u5236\u4f7f\u5f97\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u76f4\u63a5\u4f20\u9012\u6d88\u606f\u66f4\u5feb\uff0c\u800c\u4e14\u53ef\u4ee5\u53d1\u9001\"payload\"\u5b57\u7b26\u4e32\u4fe1\u606f\uff0c\u8fd9\u4f7f\u5f97\u4f7f\u7528\u6570\u636e\u5e93\u81ea\u8eab\u521b\u5efa\u8de8\u5ba2\u6237\u7aef\u6d88\u606f\u7cfb\u7edf\u6210\u4e3a\u53ef\u80fd</p>\n</li>\n<li>\n<p>\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u4f7f\u7528 application_name \u6765\u8bbe\u7f6e\uff0c\u4f7f\u5f97 pg_stat_activity \u4fe1\u606f\u91cc\u663e\u793a\u51fa\u5e94\u7528\u7a0b\u5e8f\u540d\u5b57</p>\n</li>\n<li>\n<p>\u552f\u4e00\u7ea6\u675f\u8fdd\u4f8b\u53d1\u751f\u65f6\u7ed9\u51fa\u7684\u9519\u8bef\u4fe1\u606f\u91cc\u5305\u62ec\u7684\u8bbe\u8ba1\u5230\u7684\u503c\uff0c\u8fd9\u4f7f\u5f97\u5b9a\u4f4d\u5230\u5e95\u65f6\u90a3\u91cc\u5bfc\u81f4\u53d1\u751f\u9519\u8bef\u53d8\u5f97\u5bb9\u6613</p>\n</li>\n<li>\n<p>\u7ea6\u675f\u68c0\u67e5\u53ef\u4ee5\u6807\u8bb0\u4e3a DEFERRABLE</p>\n</li>\n<li>\n<p>\u65b0\u5f15\u8fdb\u6392\u4ed6\u6027\u7ea6\u675f(exclusion constraints)\uff0c\u548c\u552f\u4e00\u6027\u7ea6\u675f\u7c7b\u4f3c</p>\n</li>\n<li>\n<p>contrib/hstore \u6a21\u5757\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4f4e\u5f00\u9500\u7684\u952e\u503c\u5bf9(key/value)\u5b58\u50a8\u7c7b\u578b</p>\n</li>\n</ul>\n<h4 id=\"_81\">\u914d\u7f6e\u548c\u76d1\u63a7<a class=\"headerlink\" href=\"#_81\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>\u670d\u52a1\u5668\u53c2\u6570\u53ef\u4ee5\u88ab\u7528\u6237/\u6570\u636e\u5e93\u7ec4\u5408\u8c03\u6574</p>\n</li>\n<li>\n<p>\u5f53 postgresql.conf \u6587\u4ef6\u88ab\u88ab pg_ctl\n  reload \u6216\u53d1\u9001 SIGHUP \u4fe1\u53f7\u7ed9\u670d\u52a1\u800c\u91cd\u8f7d\u65f6\uff0c\u670d\u52a1\u5668\u65e5\u5fd7\u4f1a\u6ce8\u610f\u5230\u54ea\u4e9b\u53c2\u6570\u88ab\u4fee\u6539\u4e86</p>\n</li>\n<li>\n<p>\u4f7f\u7528 pg_stat_reset_shared('bgwriter')\u51fd\u6570\u53ef\u4ee5\u91cd\u7f6e\u540e\u53f0\u5199\u7edf\u8ba1</p>\n</li>\n<li>\n<p>\u4f7f\u7528 pg_stat_reset_single_table_counters()\u548c pg_stat_reset_single_function_counters()\u53ef\u4ee5\u5206\u522b\u5355\u72ec\u9488\u5bf9\u8868\u548c\u51fd\u6570\u8ba1\u6570\u5668\u8fdb\u884c\u91cd\u7f6e</p>\n</li>\n<li>\n<p>log_temp_files \u53c2\u6570\u53ef\u4ee5\u7528 KB \u5355\u4f4d\u6765\u6307\u5b9a</p>\n</li>\n<li>\n<p>log_line_prefix \u53ef\u4ee5\u8ffd\u8e2a\u8bf8\u5982\u9519\u8bef\u6d88\u606f\u91cc\u8bbe\u7f6e\u7684 SQLSTATE \u503c\uff0c\u8fd9\u5c31\u4f7f\u5f97\u65e5\u5fd7\u53ef\u4ee5\u66f4\u597d\u7684\u5206\u6790\u5bfc\u81f4\u9519\u8bef\u53d1\u751f\u7684\u786e\u5207\u4ee3\u7801</p>\n</li>\n</ul>\n<h4 id=\"_82\">\u5de5\u5177<a class=\"headerlink\" href=\"#_82\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>pgbench \u53ef\u4ee5\u8fd0\u884c\u591a\u8fdb\u7a0b/\u591a\u7ebf\u7a0b\u6a21\u5f0f\u6027\u80fd\u6d4b\u8bd5</p>\n</li>\n<li>\n<p>contrib/auto_explain \u6a21\u5757\u53ef\u4ee5\u8f93\u51fa\u67e5\u8be2\u8bed\u53e5\u4ee5\u53ca\u5b83\u7684\u6267\u884c\u8ba1\u5212</p>\n</li>\n<li>\n<p>contrib/pg_stat_statements \u53ef\u4ee5\u624b\u673a\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\u5305\u62ec\u6bcf\u4e2a\u8bed\u53e5\u6240\u6709\u7684\u6d3b\u52a8\u7f13\u5b58\u4fe1\u606f</p>\n</li>\n</ul>\n<h4 id=\"_83\">\u5185\u90e8<a class=\"headerlink\" href=\"#_83\" title=\"Permanent link\">&para;</a></h4>\n<ul>\n<li>\n<p>contrib/pg_upgrade \u5de5\u5177\u53ef\u4ee5\u4ece\u65e9\u671f\u7684 8.&#8540;.4 \u7248\u672c\u5e73\u6ed1\u5347\u7ea7\u5230 9.0,\u4e0d\u9700\u8981\u5bfc\u51fa\u5bfc\u5165\u6570\u636e\uff0c\u8fd9\u4e2d\u65b9\u5f0f\u4e00\u822c\u79f0\u4e3a\u5c31\u5730\u66f4\u65b0(\\\"in-place\n  upgrade\\\")</p>\n</li>\n<li>\n<p>VACUUM\n  FULL \u4f7f\u7528\u4e86\u65e9\u671f\u7248\u672c\u4e2d CLUSTER \u4e2d\u4f7f\u7528\u7684\u91cd\u5efa\u673a\u5236\u3002\u5b83\u9700\u8981\u66f4\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\uff0c\u4f46\u66f4\u5feb\u800c\u4e14\u53ef\u4ee5\u907f\u514d\u7d22\u5f15\u81a8\u80c0</p>\n</li>\n<li>\n<p>\u7f16\u8bd1\u65f6\u9ed8\u8ba4\u4f7f\u7528--enable-thread-safety\u3002\u8be5\u9009\u9879\u5141\u8bb8\u591a\u7ebf\u7a0b\u5ba2\u6237\u7aef\u7a0b\u5e8f\u4f7f\u7528\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u5e93\u6765\u7f16\u8bd1\uff0c\u4ece\u800c\u5b89\u5168\u8fd0\u884c\u3002\u65e9\u8d77\u7248\u672c\u9ed8\u8ba4\u4e0d\u5f00\u542f\u8be5\u7279\u6027</p>\n</li>\n<li>\n<p>\u6570\u636e\u5e93\u6709\u81ea\u5df1\u66f4\u597d\u7684\u529e\u6cd5\u5904\u7406 OOM \u7684\u95ee\u9898</p>\n</li>\n<li>\n<p>\u6709\u51e0\u4e2a\u6307\u4ee4\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528()\u5305\u62ec\u7684\u5217\u8868\u6765\u4f20\u9012\u9009\u9879\uff0c\u800c\u4e0d\u662f\u4f20\u7edf\u7684 SQL \u8bed\u6cd5\u3002EXPLAIN\uff0cCOPY\uff0cVACUUM \u76ee\u524d\u90fd\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u7279\u6027</p>\n</li>\n</ul>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["performance", "postgresql"]}, {"id": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-1/", "url": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-1/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e00\u90e8\u5206", "content_html": "<h1 id=\"mysql-45\">\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e00\u90e8\u5206<a class=\"headerlink\" href=\"#mysql-45\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md\" title=\"Permalink to MySQL\u5b9e\u621845\u8bb2.md\">Source</a></p>\n<p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e00\u90e8\u5206</p>\n<h2 id=\"00\">00\u73af\u5883\u8bf4\u660e<a class=\"headerlink\" href=\"#00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd95\u7bc7\u5185\u5bb9\u7684\u6d4b\u8bd5\u548c\u9a8c\u8bc1\u5206\u522b\u5728 MySQL 5.7.41 \u4ee5\u53ca MySQL 8.0.32 \u4e0a\u8fdb\u884c\u3002\u4e24\u4e2a\u670d\u52a1\u5206\u522b\u5728\u4e24\u53f0\u914d\u7f6e\u76f8\u540c\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u4fe1\u606f\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u578b\u53f7\uff1aDell R640</li>\n<li>CPU:  Intel(R) Xeon(R) Silver 4216 CPU @ 2.10GHz 32\u6838</li>\n<li>\u5185\u5b58\uff1a64G</li>\n<li>OS: RHEL 7.6 x86_64</li>\n<li>kernel: 5.19.11-1.el7.elrepo</li>\n</ul>\n<h2 id=\"01-sql\">01 \u57fa\u7840\u67b6\u6784\uff1a\u4e00\u6761SQL\u67e5\u8be2\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f<a class=\"headerlink\" href=\"#01-sql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u6570\u636e\u5e93\uff0c\u770b\u5230\u7684\u901a\u5e38\u90fd\u662f\u4e00\u4e2a\u6574\u4f53\u3002\u6bd4\u5982\uff0c\u4f60\u6709\u4e2a\u6700\u7b80\u5355\u7684\u8868\uff0c\u8868\u91cc\u53ea\u6709\u4e00\u4e2a ID \u5b57\u6bb5\uff0c\u5728\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u65f6\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"err\">\uff1b</span>\n</code></pre></div>\n<p>\u6211\u4eec\u770b\u5230\u7684\u53ea\u662f\u8f93\u5165\u4e00\u6761\u8bed\u53e5\uff0c\u8fd4\u56de\u4e00\u4e2a\u7ed3\u679c\uff0c\u5374\u4e0d\u77e5\u9053\u8fd9\u6761\u8bed\u53e5\u5728 MySQL \u5185\u90e8\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p>\n<p>\u6240\u4ee5\u4eca\u5929\u6211\u60f3\u548c\u4f60\u4e00\u8d77\u628a MySQL \u62c6\u89e3\u4e00\u4e0b\uff0c\u770b\u770b\u91cc\u9762\u90fd\u6709\u54ea\u4e9b\u201c\u96f6\u4ef6\u201d\uff0c\u5e0c\u671b\u501f\u7531\u8fd9\u4e2a\u62c6\u89e3\u8fc7\u7a0b\uff0c\u8ba9\u4f60\u5bf9 MySQL \u6709\u66f4\u6df1\u5165\u7684\u7406\u89e3\u3002\u8fd9\u6837\u5f53\u6211\u4eec\u78b0\u5230 MySQL \u7684\u4e00\u4e9b\u5f02\u5e38\u6216\u8005\u95ee\u9898\u65f6\uff0c\u5c31\u80fd\u591f\u76f4\u6233\u672c\u8d28\uff0c\u66f4\u4e3a\u5feb\u901f\u5730\u5b9a\u4f4d\u5e76\u89e3\u51b3\u95ee\u9898\u3002</p>\n<p>\u4e0b\u9762\u6211\u7ed9\u51fa\u7684\u662f MySQL \u7684\u57fa\u672c\u67b6\u6784\u793a\u610f\u56fe\uff0c\u4ece\u4e2d\u4f60\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 SQL \u8bed\u53e5\u5728 MySQL \u7684\u5404\u4e2a\u529f\u80fd\u6a21\u5757\u4e2d\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p>\n<pre class=\"mermaid\"><code>graph \n    %%define comment\n    client[\"fa:fa-user \u5ba2\u6237\u7aef\"]\n    subgraph Server\n        direction TB\n        connector(\"\u8fde\u63a5\u5668&lt;br/&gt;\u7ba1\u7406\u8fde\u63a5\uff0c\u6743\u9650\u9a8c\u8bc1\")\n        qc(\"\u67e5\u8be2\u7f13\u5b58&lt;br/&gt;\u547d\u4e2d\u5219\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\")\n        analyzer(\"\u5206\u6790\u5668&lt;br/&gt;\u8bcd\u6cd5\u5206\u6790\uff0c\u8bed\u6cd5\u5206\u6790\")\n        optimizer(\"\u4f18\u5316\u5668&lt;br/&gt;\u6267\u884c\u8ba1\u5212\u751f\u6210\uff0c\u7d22\u5f15\u9009\u62e9\")\n        executor(\"\u6267\u884c\u5668&lt;br/&gt;\u64cd\u4f5c\u5f15\u64ce\uff0c\u8fd4\u56de\u7ed3\u679c\")\n\n        connector --&gt; qc\n        connector --&gt; analyzer --&gt; optimizer --&gt; executor\n        analyzer --&gt; qc\n    end\n\n    subgraph Storage\n        direction LR\n        node1(\u5b58\u50a8\u5f15\u64ce)\n        node2(\u5b58\u50a8\u5f15\u64ce)\n        node3(\u5b58\u50a8\u5f15\u64ce)\n\n        node1:::nolink -.- node2 -.- node3\n\n        linkStyle 5,6 nolink stroke:white,stroke-width:0px;\n    end\n\n    client --&gt; Server\n    Server --&gt; Storage</code></pre>\n<p>\u5927\u4f53\u6765\u8bf4\uff0cMySQL \u53ef\u4ee5\u5206\u4e3a Server \u5c42\u548c\u5b58\u50a8\u5f15\u64ce\u5c42\u4e24\u90e8\u5206\u3002</p>\n<p>Server \u5c42\u5305\u62ec\u8fde\u63a5\u5668\u3001\u67e5\u8be2\u7f13\u5b58\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\uff0c\u6db5\u76d6 MySQL \u7684\u5927\u591a\u6570\u6838\u5fc3\u670d\u52a1\u529f\u80fd\uff0c\u4ee5\u53ca\u6240\u6709\u7684\u5185\u7f6e\u51fd\u6570\uff08\u5982\u65e5\u671f\u3001\u65f6\u95f4\u3001\u6570\u5b66\u548c\u52a0\u5bc6\u51fd\u6570\u7b49\uff09\uff0c\u6240\u6709\u8de8\u5b58\u50a8\u5f15\u64ce\u7684\u529f\u80fd\u90fd\u5728\u8fd9\u4e00\u5c42\u5b9e\u73b0\uff0c\u6bd4\u5982\u5b58\u50a8\u8fc7\u7a0b\u3001\u89e6\u53d1\u5668\u3001\u89c6\u56fe\u7b49\u3002</p>\n<p>\u800c\u5b58\u50a8\u5f15\u64ce\u5c42\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\u3002\u5176\u67b6\u6784\u6a21\u5f0f\u662f\u63d2\u4ef6\u5f0f\u7684\uff0c\u652f\u6301 InnoDB\u3001MyISAM\u3001Memory \u7b49\u591a\u4e2a\u5b58\u50a8\u5f15\u64ce\u3002\u73b0\u5728\u6700\u5e38\u7528\u7684\u5b58\u50a8\u5f15\u64ce\u662f InnoDB\uff0c\u5b83\u4ece MySQL 5.5.5 \u7248\u672c\u5f00\u59cb\u6210\u4e3a\u4e86\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u6267\u884c create table \u5efa\u8868\u7684\u65f6\u5019\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u5f15\u64ce\u7c7b\u578b\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5c31\u662f InnoDB\u3002\u4e0d\u8fc7\uff0c\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u5b58\u50a8\u5f15\u64ce\u7684\u7c7b\u578b\u6765\u9009\u62e9\u522b\u7684\u5f15\u64ce\uff0c\u6bd4\u5982\u5728 create table \u8bed\u53e5\u4e2d\u4f7f\u7528 engine=memory, \u6765\u6307\u5b9a\u4f7f\u7528\u5185\u5b58\u5f15\u64ce\u521b\u5efa\u8868\u3002\u4e0d\u540c\u5b58\u50a8\u5f15\u64ce\u7684\u8868\u6570\u636e\u5b58\u53d6\u65b9\u5f0f\u4e0d\u540c\uff0c\u652f\u6301\u7684\u529f\u80fd\u4e5f\u4e0d\u540c\uff0c\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4f1a\u8ba8\u8bba\u5230\u5f15\u64ce\u7684\u9009\u62e9\u3002</p>\n<p>\u4ece\u56fe\u4e2d\u4e0d\u96be\u770b\u51fa\uff0c\u4e0d\u540c\u7684\u5b58\u50a8\u5f15\u64ce\u5171\u7528\u4e00\u4e2a**Server \u5c42**\uff0c\u4e5f\u5c31\u662f\u4ece\u8fde\u63a5\u5668\u5230\u6267\u884c\u5668\u7684\u90e8\u5206\u3002\u4f60\u53ef\u4ee5\u5148\u5bf9\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u540d\u5b57\u6709\u4e2a\u5370\u8c61\uff0c\u63a5\u4e0b\u6765\u6211\u4f1a\u7ed3\u5408\u5f00\u5934\u63d0\u5230\u7684\u90a3\u6761 SQL \u8bed\u53e5\uff0c\u5e26\u4f60\u8d70\u4e00\u904d\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\uff0c\u4f9d\u6b21\u770b\u4e0b\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u4f5c\u7528\u3002</p>\n<h3 id=\"_1\">\u8fde\u63a5\u5668<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e00\u6b65\uff0c\u4f60\u4f1a\u5148\u8fde\u63a5\u5230\u8fd9\u4e2a\u6570\u636e\u5e93\u4e0a\uff0c\u8fd9\u65f6\u5019\u63a5\u5f85\u4f60\u7684\u5c31\u662f\u8fde\u63a5\u5668\u3002\u8fde\u63a5\u5668\u8d1f\u8d23\u8ddf\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\u3001\u83b7\u53d6\u6743\u9650\u3001\u7ef4\u6301\u548c\u7ba1\u7406\u8fde\u63a5\u3002\u8fde\u63a5\u547d\u4ee4\u4e00\u822c\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>mysql<span class=\"w\"> </span>-h<span class=\"nv\">$ip</span><span class=\"w\"> </span>-P<span class=\"nv\">$port</span><span class=\"w\"> </span>-u<span class=\"nv\">$user</span><span class=\"w\"> </span>-p\n</code></pre></div>\n<p>\u8f93\u5b8c\u547d\u4ee4\u4e4b\u540e\uff0c\u4f60\u5c31\u9700\u8981\u5728\u4ea4\u4e92\u5bf9\u8bdd\u91cc\u9762\u8f93\u5165\u5bc6\u7801\u3002\u867d\u7136\u5bc6\u7801\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8ddf\u5728 -p \u540e\u9762\u5199\u5728\u547d\u4ee4\u884c\u4e2d\uff0c\u4f46\u8fd9\u6837\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4f60\u7684\u5bc6\u7801\u6cc4\u9732\u3002\u5982\u679c\u4f60\u8fde\u7684\u662f\u751f\u4ea7\u670d\u52a1\u5668\uff0c\u5f3a\u70c8\u5efa\u8bae\u4f60\u4e0d\u8981\u8fd9\u4e48\u505a\u3002</p>\n<p>\u8fde\u63a5\u547d\u4ee4\u4e2d\u7684 mysql \u662f\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u7528\u6765\u8ddf\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\u3002\u5728\u5b8c\u6210\u7ecf\u5178\u7684 TCP \u63e1\u624b\u540e\uff0c\u8fde\u63a5\u5668\u5c31\u8981\u5f00\u59cb\u8ba4\u8bc1\u4f60\u7684\u8eab\u4efd\uff0c\u8fd9\u4e2a\u65f6\u5019\u7528\u7684\u5c31\u662f\u4f60\u8f93\u5165\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</p>\n<ul>\n<li>\u5982\u679c\u7528\u6237\u540d\u6216\u5bc6\u7801\u4e0d\u5bf9\uff0c\u4f60\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\"Access denied for user\"\u7684\u9519\u8bef\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u7a0b\u5e8f\u7ed3\u675f\u6267\u884c\u3002</li>\n<li>\u5982\u679c\u7528\u6237\u540d\u5bc6\u7801\u8ba4\u8bc1\u901a\u8fc7\uff0c\u8fde\u63a5\u5668\u4f1a\u5230\u6743\u9650\u8868\u91cc\u9762\u67e5\u51fa\u4f60\u62e5\u6709\u7684\u6743\u9650\u3002\u4e4b\u540e\uff0c\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7684\u6743\u9650\u5224\u65ad\u903b\u8f91\uff0c\u90fd\u5c06\u4f9d\u8d56\u4e8e\u6b64\u65f6\u8bfb\u5230\u7684\u6743\u9650\u3002</li>\n</ul>\n<p>\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u4e00\u4e2a\u7528\u6237\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u5373\u4f7f\u4f60\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u5bf9\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\u505a\u4e86\u4fee\u6539\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5df2\u7ecf\u5b58\u5728\u8fde\u63a5\u7684\u6743\u9650\u3002\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u53ea\u6709\u518d\u65b0\u5efa\u7684\u8fde\u63a5\u624d\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u8bbe\u7f6e\u3002</p>\n<p>\u8fde\u63a5\u5b8c\u6210\u540e\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u540e\u7eed\u7684\u52a8\u4f5c\uff0c\u8fd9\u4e2a\u8fde\u63a5\u5c31\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u5728 show processlist \u547d\u4ee4\u4e2d\u770b\u5230\u5b83\u3002\u6587\u672c\u4e2d\u8fd9\u4e2a\u56fe\u662f show processlist \u7684\u7ed3\u679c\uff0c\u5176\u4e2d\u7684 Command \u5217\u663e\u793a\u4e3a\u201cSleep\u201d\u7684\u8fd9\u4e00\u884c\uff0c\u5c31\u8868\u793a\u73b0\u5728\u7cfb\u7edf\u91cc\u9762\u6709\u4e00\u4e2a\u7a7a\u95f2\u8fde\u63a5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+------------------+------+---------+------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Host</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">State</span><span class=\"w\">                  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+------------------+------+---------+------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">event_scheduler</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Daemon</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Waiting</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"n\">queue</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">my</span><span class=\"w\">              </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">192</span><span class=\"p\">.</span><span class=\"mi\">168</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"mi\">24691</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sleep</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">53</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">                        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+------------------+------+---------+------+------------------------+------------------+</span>\n<span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u5ba2\u6237\u7aef\u5982\u679c\u592a\u957f\u65f6\u95f4\u6ca1\u52a8\u9759\uff0c\u8fde\u63a5\u5668\u5c31\u4f1a\u81ea\u52a8\u5c06\u5b83\u65ad\u5f00\u3002\u8fd9\u4e2a\u65f6\u95f4\u662f\u7531\u53c2\u6570 <code>wait_timeout</code> \u63a7\u5236\u7684\uff0c\u9ed8\u8ba4\u503c\u662f 8 \u5c0f\u65f6(28800)\u3002</p>\n<p>\u5982\u679c\u5728\u8fde\u63a5\u88ab\u65ad\u5f00\u4e4b\u540e\uff0c\u5ba2\u6237\u7aef\u518d\u6b21\u53d1\u9001\u8bf7\u6c42\u7684\u8bdd\uff0c\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\u9519\u8bef\u63d0\u9192\uff1a <code>Lost connection to MySQL server during query</code>\u3002\u8fd9\u65f6\u5019\u5982\u679c\u4f60\u8981\u7ee7\u7eed\uff0c\u5c31\u9700\u8981\u91cd\u8fde\uff0c\u7136\u540e\u518d\u6267\u884c\u8bf7\u6c42\u4e86\u3002</p>\n<p>\u6570\u636e\u5e93\u91cc\u9762\uff0c\u957f\u8fde\u63a5\u662f\u6307\u8fde\u63a5\u6210\u529f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u6301\u7eed\u6709\u8bf7\u6c42\uff0c\u5219\u4e00\u76f4\u4f7f\u7528\u540c\u4e00\u4e2a\u8fde\u63a5\u3002\u77ed\u8fde\u63a5\u5219\u662f\u6307\u6bcf\u6b21\u6267\u884c\u5b8c\u5f88\u5c11\u7684\u51e0\u6b21\u67e5\u8be2\u5c31\u65ad\u5f00\u8fde\u63a5\uff0c\u4e0b\u6b21\u67e5\u8be2\u518d\u91cd\u65b0\u5efa\u7acb\u4e00\u4e2a\u3002</p>\n<p>\u5efa\u7acb\u8fde\u63a5\u7684\u8fc7\u7a0b\u901a\u5e38\u662f\u6bd4\u8f83\u590d\u6742\u7684\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\u5728\u4f7f\u7528\u4e2d\u8981\u5c3d\u91cf\u51cf\u5c11\u5efa\u7acb\u8fde\u63a5\u7684\u52a8\u4f5c\uff0c\u4e5f\u5c31\u662f\u5c3d\u91cf\u4f7f\u7528\u957f\u8fde\u63a5\u3002</p>\n<p>\u4f46\u662f\u5168\u90e8\u4f7f\u7528\u957f\u8fde\u63a5\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u6709\u4e9b\u65f6\u5019 MySQL \u5360\u7528\u5185\u5b58\u6da8\u5f97\u7279\u522b\u5feb\uff0c\u8fd9\u662f\u56e0\u4e3a MySQL \u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e34\u65f6\u4f7f\u7528\u7684\u5185\u5b58\u662f\u7ba1\u7406\u5728\u8fde\u63a5\u5bf9\u8c61\u91cc\u9762\u7684\u3002\u8fd9\u4e9b\u8d44\u6e90\u4f1a\u5728\u8fde\u63a5\u65ad\u5f00\u7684\u65f6\u5019\u624d\u91ca\u653e\u3002\u6240\u4ee5\u5982\u679c\u957f\u8fde\u63a5\u7d2f\u79ef\u4e0b\u6765\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u592a\u5927\uff0c\u88ab\u7cfb\u7edf\u5f3a\u884c\u6740\u6389\uff08OOM\uff09\uff0c\u4ece\u73b0\u8c61\u770b\u5c31\u662f MySQL \u5f02\u5e38\u91cd\u542f\u4e86\u3002</p>\n<p>\u600e\u4e48\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f\u4f60\u53ef\u4ee5\u8003\u8651\u4ee5\u4e0b\u4e24\u79cd\u65b9\u6848\u3002</p>\n<ol>\n<li>\u5b9a\u671f\u65ad\u5f00\u957f\u8fde\u63a5\u3002\u4f7f\u7528\u4e00\u6bb5\u65f6\u95f4\uff0c\u6216\u8005\u7a0b\u5e8f\u91cc\u9762\u5224\u65ad\u6267\u884c\u8fc7\u4e00\u4e2a\u5360\u7528\u5185\u5b58\u7684\u5927\u67e5\u8be2\u540e\uff0c\u65ad\u5f00\u8fde\u63a5\uff0c\u4e4b\u540e\u8981\u67e5\u8be2\u518d\u91cd\u8fde\u3002</li>\n<li>\u5982\u679c\u4f60\u7528\u7684\u662f MySQL 5.7 \u6216\u66f4\u65b0\u7248\u672c\uff0c\u53ef\u4ee5\u5728\u6bcf\u6b21\u6267\u884c\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u64cd\u4f5c\u540e\uff0c\u901a\u8fc7\u6267\u884c <code>mysql_reset_connection</code> \u6765\u91cd\u65b0\u521d\u59cb\u5316\u8fde\u63a5\u8d44\u6e90\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u91cd\u8fde\u548c\u91cd\u65b0\u505a\u6743\u9650\u9a8c\u8bc1\uff0c\u4f46\u662f\u4f1a\u5c06\u8fde\u63a5\u6062\u590d\u5230\u521a\u521a\u521b\u5efa\u5b8c\u65f6\u7684\u72b6\u6001\u3002</li>\n</ol>\n<h3 id=\"_2\">\u67e5\u8be2\u7f13\u5b58<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fde\u63a5\u5efa\u7acb\u5b8c\u6210\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u6267\u884c select \u8bed\u53e5\u4e86\u3002\u6267\u884c\u903b\u8f91\u5c31\u4f1a\u6765\u5230\u7b2c\u4e8c\u6b65\uff1a\u67e5\u8be2\u7f13\u5b58\u3002</p>\n<p>MySQL \u62ff\u5230\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u540e\uff0c\u4f1a\u5148\u5230\u67e5\u8be2\u7f13\u5b58\u770b\u770b\uff0c\u4e4b\u524d\u662f\u4e0d\u662f\u6267\u884c\u8fc7\u8fd9\u6761\u8bed\u53e5\u3002\u4e4b\u524d\u6267\u884c\u8fc7\u7684\u8bed\u53e5\u53ca\u5176\u7ed3\u679c\u53ef\u80fd\u4f1a\u4ee5 key-value \u5bf9\u7684\u5f62\u5f0f\uff0c\u88ab\u76f4\u63a5\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u3002key \u662f\u67e5\u8be2\u7684\u8bed\u53e5\uff0cvalue \u662f\u67e5\u8be2\u7684\u7ed3\u679c\u3002\u5982\u679c\u4f60\u7684\u67e5\u8be2\u80fd\u591f\u76f4\u63a5\u5728\u8fd9\u4e2a\u7f13\u5b58\u4e2d\u627e\u5230 key\uff0c\u90a3\u4e48\u8fd9\u4e2a value \u5c31\u4f1a\u88ab\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</p>\n<p>\u5982\u679c\u8bed\u53e5\u4e0d\u5728\u67e5\u8be2\u7f13\u5b58\u4e2d\uff0c\u5c31\u4f1a\u7ee7\u7eed\u540e\u9762\u7684\u6267\u884c\u9636\u6bb5\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u6267\u884c\u7ed3\u679c\u4f1a\u88ab\u5b58\u5165\u67e5\u8be2\u7f13\u5b58\u4e2d\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u67e5\u8be2\u547d\u4e2d\u7f13\u5b58\uff0cMySQL \u4e0d\u9700\u8981\u6267\u884c\u540e\u9762\u7684\u590d\u6742\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd9\u4e2a\u6548\u7387\u4f1a\u5f88\u9ad8\u3002</p>\n<p><strong>\u4f46\u662f\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u4e0d\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u56e0\u4e3a\u67e5\u8be2\u7f13\u5b58\u5f80\u5f80\u5f0a\u5927\u4e8e\u5229\u3002</strong></p>\n<p>\u67e5\u8be2\u7f13\u5b58\u7684\u5931\u6548\u975e\u5e38\u9891\u7e41\uff0c\u53ea\u8981\u6709\u5bf9\u4e00\u4e2a\u8868\u7684\u66f4\u65b0\uff0c\u8fd9\u4e2a\u8868\u4e0a\u6240\u6709\u7684\u67e5\u8be2\u7f13\u5b58\u90fd\u4f1a\u88ab\u6e05\u7a7a\u3002\u56e0\u6b64\u5f88\u53ef\u80fd\u4f60\u8d39\u52b2\u5730\u628a\u7ed3\u679c\u5b58\u8d77\u6765\uff0c\u8fd8\u6ca1\u4f7f\u7528\u5462\uff0c\u5c31\u88ab\u4e00\u4e2a\u66f4\u65b0\u5168\u6e05\u7a7a\u4e86\u3002\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u5927\u7684\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u67e5\u8be2\u7f13\u5b58\u7684\u547d\u4e2d\u7387\u4f1a\u975e\u5e38\u4f4e\u3002\u9664\u975e\u4f60\u7684\u4e1a\u52a1\u5c31\u662f\u6709\u4e00\u5f20\u9759\u6001\u8868\uff0c\u5f88\u957f\u65f6\u95f4\u624d\u4f1a\u66f4\u65b0\u4e00\u6b21\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u7cfb\u7edf\u914d\u7f6e\u8868\uff0c\u90a3\u8fd9\u5f20\u8868\u4e0a\u7684\u67e5\u8be2\u624d\u9002\u5408\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002</p>\n<p>\u597d\u5728 MySQL \u4e5f\u63d0\u4f9b\u4e86\u8fd9\u79cd\u201c\u6309\u9700\u4f7f\u7528\u201d\u7684\u65b9\u5f0f\u3002\u4f60\u53ef\u4ee5\u5c06\u53c2\u6570 <code>query_cache_type</code> \u8bbe\u7f6e\u6210 DEMAND(\u8be5\u53c2\u6570\u5728<code>5.7.41</code> \u9ed8\u8ba4\u662f <code>OFF</code>)\uff0c\u8fd9\u6837\u5bf9\u4e8e\u9ed8\u8ba4\u7684 SQL \u8bed\u53e5\u90fd\u4e0d\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002\u800c\u5bf9\u4e8e\u4f60\u786e\u5b9a\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u8bed\u53e5\uff0c\u53ef\u4ee5\u7528 SQL_CACHE \u663e\u5f0f\u6307\u5b9a\uff0c\u50cf\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e00\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">SQL_CACHE</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"err\">\uff1b</span>\n</code></pre></div>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cMySQL 8.0 \u7248\u672c\u76f4\u63a5\u5c06\u67e5\u8be2\u7f13\u5b58\u7684\u6574\u5757\u529f\u80fd\u5220\u6389\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4 8.0.3 \u5f00\u59cb\u5f7b\u5e95\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\u4e86\u3002</p>\n<h3 id=\"_3\">\u5206\u6790\u5668<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u6ca1\u6709\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u5c31\u8981\u5f00\u59cb\u771f\u6b63\u6267\u884c\u8bed\u53e5\u4e86\u3002\u9996\u5148\uff0cMySQL \u9700\u8981\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\uff0c\u56e0\u6b64\u9700\u8981\u5bf9 SQL \u8bed\u53e5\u505a\u89e3\u6790\u3002</p>\n<p>\u5206\u6790\u5668\u5148\u4f1a\u505a\u201c\u8bcd\u6cd5\u5206\u6790\u201d\u3002\u4f60\u8f93\u5165\u7684\u662f\u7531\u591a\u4e2a\u5b57\u7b26\u4e32\u548c\u7a7a\u683c\u7ec4\u6210\u7684\u4e00\u6761 SQL \u8bed\u53e5\uff0cMySQL \u9700\u8981\u8bc6\u522b\u51fa\u91cc\u9762\u7684\u5b57\u7b26\u4e32\u5206\u522b\u662f\u4ec0\u4e48\uff0c\u4ee3\u8868\u4ec0\u4e48\u3002</p>\n<p>MySQL \u4ece\u4f60\u8f93\u5165\u7684\"select\"\u8fd9\u4e2a\u5173\u952e\u5b57\u8bc6\u522b\u51fa\u6765\uff0c\u8fd9\u662f\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u3002\u5b83\u4e5f\u8981\u628a\u5b57\u7b26\u4e32\u201cT\u201d\u8bc6\u522b\u6210\u201c\u8868\u540d T\u201d\uff0c\u628a\u5b57\u7b26\u4e32\u201cID\u201d\u8bc6\u522b\u6210\u201c\u5217 ID\u201d\u3002</p>\n<p>\u505a\u5b8c\u4e86\u8fd9\u4e9b\u8bc6\u522b\u4ee5\u540e\uff0c\u5c31\u8981\u505a\u201c\u8bed\u6cd5\u5206\u6790\u201d\u3002\u6839\u636e\u8bcd\u6cd5\u5206\u6790\u7684\u7ed3\u679c\uff0c\u8bed\u6cd5\u5206\u6790\u5668\u4f1a\u6839\u636e\u8bed\u6cd5\u89c4\u5219\uff0c\u5224\u65ad\u4f60\u8f93\u5165\u7684\u8fd9\u4e2a SQL \u8bed\u53e5\u662f\u5426\u6ee1\u8db3 MySQL \u8bed\u6cd5\u3002</p>\n<p>\u5982\u679c\u4f60\u7684\u8bed\u53e5\u4e0d\u5bf9\uff0c\u5c31\u4f1a\u6536\u5230\u201cYou have an error in your SQL syntax\u201d\u7684\u9519\u8bef\u63d0\u9192\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5 select \u5c11\u6253\u4e86\u5f00\u5934\u7684\u5b57\u6bcd\u201cs\u201d\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">elect</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"n\">ERROR</span><span class=\"w\"> </span><span class=\"mi\">1064</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">42000</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">have</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"k\">SQL</span><span class=\"w\"> </span><span class=\"n\">syntax</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">check</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">manual</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">corresponds</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">MySQL</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"k\">version</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"k\">right</span><span class=\"w\"> </span><span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">near</span><span class=\"w\"> </span><span class=\"s1\">&#39;elect * from t where ID=1&#39;</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>\u4e00\u822c\u8bed\u6cd5\u9519\u8bef\u4f1a\u63d0\u793a\u7b2c\u4e00\u4e2a\u51fa\u73b0\u9519\u8bef\u7684\u4f4d\u7f6e\uff0c\u6240\u4ee5\u4f60\u8981\u5173\u6ce8\u7684\u662f\u7d27\u63a5\u201cuse near\u201d\u7684\u5185\u5bb9\u3002</p>\n<h3 id=\"_4\">\u4f18\u5316\u5668<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ecf\u8fc7\u4e86\u5206\u6790\u5668\uff0cMySQL \u5c31\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\u4e86\u3002\u5728\u5f00\u59cb\u6267\u884c\u4e4b\u524d\uff0c\u8fd8\u8981\u5148\u7ecf\u8fc7\u4f18\u5316\u5668\u7684\u5904\u7406\u3002</p>\n<p>\u4f18\u5316\u5668\u662f\u5728\u8868\u91cc\u9762\u6709\u591a\u4e2a\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\uff1b\u6216\u8005\u5728\u4e00\u4e2a\u8bed\u53e5\u6709\u591a\u8868\u5173\u8054\uff08join\uff09\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u5404\u4e2a\u8868\u7684\u8fde\u63a5\u987a\u5e8f\u3002\u6bd4\u5982\u4f60\u6267\u884c\u4e0b\u9762\u8fd9\u6837\u7684\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u662f\u6267\u884c\u4e24\u4e2a\u8868\u7684 join\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">using</span><span class=\"p\">(</span><span class=\"n\">ID</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">20</span><span class=\"p\">;</span>\n</code></pre></div>\n<ul>\n<li>\u65e2\u53ef\u4ee5\u5148\u4ece\u8868 t1 \u91cc\u9762\u53d6\u51fa c=10 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230\u8868 t2\uff0c\u518d\u5224\u65ad t2 \u91cc\u9762 d \u7684\u503c\u662f\u5426\u7b49\u4e8e 20\u3002</li>\n<li>\u4e5f\u53ef\u4ee5\u5148\u4ece\u8868 t2 \u91cc\u9762\u53d6\u51fa d=20 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230 t1\uff0c\u518d\u5224\u65ad t1 \u91cc\u9762 c \u7684\u503c\u662f\u5426\u7b49\u4e8e 10\u3002</li>\n</ul>\n<p>\u8fd9\u4e24\u79cd\u6267\u884c\u65b9\u6cd5\u7684\u903b\u8f91\u7ed3\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u6267\u884c\u7684\u6548\u7387\u4f1a\u6709\u4e0d\u540c\uff0c\u800c\u4f18\u5316\u5668\u7684\u4f5c\u7528\u5c31\u662f\u51b3\u5b9a\u9009\u62e9\u4f7f\u7528\u54ea\u4e00\u4e2a\u65b9\u6848\u3002</p>\n<p>\u4f18\u5316\u5668\u9636\u6bb5\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u65b9\u6848\u5c31\u786e\u5b9a\u4e0b\u6765\u4e86\uff0c\u7136\u540e\u8fdb\u5165\u6267\u884c\u5668\u9636\u6bb5\u3002\u5982\u679c\u4f60\u8fd8\u6709\u4e00\u4e9b\u7591\u95ee\uff0c\u6bd4\u5982\u4f18\u5316\u5668\u662f\u600e\u4e48\u9009\u62e9\u7d22\u5f15\u7684\uff0c\u6709\u6ca1\u6709\u53ef\u80fd\u9009\u62e9\u9519\u7b49\u7b49\uff0c\u6ca1\u5173\u7cfb\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u5355\u72ec\u5c55\u5f00\u8bf4\u660e\u4f18\u5316\u5668\u7684\u5185\u5bb9\u3002</p>\n<h3 id=\"_5\">\u6267\u884c\u5668<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>MySQL \u901a\u8fc7\u5206\u6790\u5668\u77e5\u9053\u4e86\u4f60\u8981\u505a\u4ec0\u4e48\uff0c\u901a\u8fc7\u4f18\u5316\u5668\u77e5\u9053\u4e86\u8be5\u600e\u4e48\u505a\uff0c\u4e8e\u662f\u5c31\u8fdb\u5165\u4e86\u6267\u884c\u5668\u9636\u6bb5\uff0c\u5f00\u59cb\u6267\u884c\u8bed\u53e5\u3002</p>\n<p>\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u5148\u5224\u65ad\u4e00\u4e0b\u4f60\u5bf9\u8fd9\u4e2a\u8868 T \u6709\u6ca1\u6709\u6267\u884c\u67e5\u8be2\u7684\u6743\u9650\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u4f1a\u8fd4\u56de\u6ca1\u6709\u6743\u9650\u7684\u9519\u8bef\uff0c\u5982\u4e0b\u6240\u793a (\u5728\u5de5\u7a0b\u5b9e\u73b0\u4e0a\uff0c\u5982\u679c\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u4f1a\u5728\u67e5\u8be2\u7f13\u5b58\u8fd4\u56de\u7ed3\u679c\u7684\u65f6\u5019\uff0c\u505a\u6743\u9650\u9a8c\u8bc1\u3002\u67e5\u8be2\u4e5f\u4f1a\u5728\u4f18\u5316\u5668\u4e4b\u524d\u8c03\u7528 precheck \u9a8c\u8bc1\u6743\u9650)\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"n\">ERROR</span><span class=\"w\"> </span><span class=\"mi\">1142</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">42000</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">denied</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"k\">user</span><span class=\"w\"> </span><span class=\"s1\">&#39;b&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;localhost&#39;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"s1\">&#39;T&#39;</span>\n</code></pre></div>\n<p>\u5982\u679c\u6709\u6743\u9650\uff0c\u5c31\u6253\u5f00\u8868\u7ee7\u7eed\u6267\u884c\u3002\u6253\u5f00\u8868\u7684\u65f6\u5019\uff0c\u6267\u884c\u5668\u5c31\u4f1a\u6839\u636e\u8868\u7684\u5f15\u64ce\u5b9a\u4e49\uff0c\u53bb\u4f7f\u7528\u8fd9\u4e2a\u5f15\u64ce\u63d0\u4f9b\u7684\u63a5\u53e3\u3002</p>\n<p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684\u8868 T \u4e2d\uff0cID \u5b57\u6bb5\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u6267\u884c\u5668\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\u53d6\u8fd9\u4e2a\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u5224\u65ad ID \u503c\u662f\u4e0d\u662f 10\uff0c\u5982\u679c\u4e0d\u662f\u5219\u8df3\u8fc7\uff0c\u5982\u679c\u662f\u5219\u5c06\u8fd9\u884c\u5b58\u5728\u7ed3\u679c\u96c6\u4e2d\uff1b</li>\n<li>\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u53d6\u201c\u4e0b\u4e00\u884c\u201d\uff0c\u91cd\u590d\u76f8\u540c\u7684\u5224\u65ad\u903b\u8f91\uff0c\u76f4\u5230\u53d6\u5230\u8fd9\u4e2a\u8868\u7684\u6700\u540e\u4e00\u884c\u3002</li>\n<li>\u6267\u884c\u5668\u5c06\u4e0a\u8ff0\u904d\u5386\u8fc7\u7a0b\u4e2d\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u7ec4\u6210\u7684\u8bb0\u5f55\u96c6\u4f5c\u4e3a\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li>\n</ol>\n<p>\u81f3\u6b64\uff0c\u8fd9\u4e2a\u8bed\u53e5\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002</p>\n<p>\u5bf9\u4e8e\u6709\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u7684\u903b\u8f91\u4e5f\u5dee\u4e0d\u591a\u3002\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u662f\u201c\u53d6\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4e4b\u540e\u5faa\u73af\u53d6\u201c\u6ee1\u8db3\u6761\u4ef6\u7684\u4e0b\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a5\u53e3\u90fd\u662f\u5f15\u64ce\u4e2d\u5df2\u7ecf\u5b9a\u4e49\u597d\u7684\u3002</p>\n<p>\u4f60\u4f1a\u5728\u6570\u636e\u5e93\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\u770b\u5230\u4e00\u4e2a <code>rows_examined</code> \u7684\u5b57\u6bb5\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002\u8fd9\u4e2a\u503c\u5c31\u662f\u5728\u6267\u884c\u5668\u6bcf\u6b21\u8c03\u7528\u5f15\u64ce\u83b7\u53d6\u6570\u636e\u884c\u7684\u65f6\u5019\u7d2f\u52a0\u7684\u3002</p>\n<p>\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6267\u884c\u5668\u8c03\u7528\u4e00\u6b21\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u5219\u626b\u63cf\u4e86\u591a\u884c\uff0c\u56e0\u6b64 <strong>\u5f15\u64ce\u626b\u63cf\u884c\u6570\u8ddf <code>rows_examined</code> \u5e76\u4e0d\u662f\u5b8c\u5168\u76f8\u540c\u7684</strong>\u3002\u6211\u4eec\u540e\u9762\u4f1a\u4e13\u95e8\u6709\u4e00\u7bc7\u6587\u7ae0\u6765\u8bb2\u5b58\u50a8\u5f15\u64ce\u7684\u5185\u90e8\u673a\u5236\uff0c\u91cc\u9762\u4f1a\u6709\u8be6\u7ec6\u7684\u8bf4\u660e\u3002</p>\n<h3 id=\"_6\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u7ed9\u4f60\u7559\u4e00\u4e2a\u95ee\u9898\u5427\uff0c\u5982\u679c\u8868 T \u4e2d\u6ca1\u6709\u5b57\u6bb5 k\uff0c\u800c\u4f60\u6267\u884c\u4e86\u8fd9\u4e2a\u8bed\u53e5 <code>select * from T where k=1</code>, \u90a3\u80af\u5b9a\u662f\u4f1a\u62a5\u201c\u4e0d\u5b58\u5728\u8fd9\u4e2a\u5217\u201d\u7684\u9519\u8bef\uff1a <code>Unknown column \u2018k\u2019 in \u2018where clause</code>\u3002\u4f60\u89c9\u5f97\u8fd9\u4e2a\u9519\u8bef\u662f\u5728\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u54ea\u4e2a\u9636\u6bb5\u62a5\u51fa\u6765\u7684\u5462\uff1f</p>\n<p>\u6267\u884c\u5668\u9636\u6bb5\u4f1a\u68c0\u67e5\u67e5\u8be2\u7684\u5217\u662f\u5426\u5b58\u5728</p>\n<h2 id=\"02-sql\">02 \u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761SQL\u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f<a class=\"headerlink\" href=\"#02-sql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u4eec\u8fd8\u662f\u4ece\u4e00\u4e2a\u8868\u7684\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u8bf4\u8d77\uff0c\u4e0b\u9762\u662f\u8fd9\u4e2a\u8868\u7684\u521b\u5efa\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8868\u6709\u4e00\u4e2a\u4e3b\u952e ID \u548c\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5 c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">(</span><span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5982\u679c\u8981\u5c06 ID=2 \u8fd9\u4e00\u884c\u7684\u503c\u52a0 1\uff0cSQL \u8bed\u53e5\u5c31\u4f1a\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u524d\u9762\u6211\u6709\u8ddf\u4f60\u4ecb\u7ecd\u8fc7 SQL \u8bed\u53e5\u57fa\u672c\u7684\u6267\u884c\u94fe\u8def\uff0c\u8fd9\u91cc\u6211\u518d\u628a\u90a3\u5f20\u56fe\u62ff\u8fc7\u6765\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5148\u7b80\u5355\u770b\u770b\u8fd9\u4e2a\u56fe\u56de\u987e\u4e0b\u3002\u9996\u5148\uff0c\u53ef\u4ee5\u786e\u5b9a\u7684\u8bf4\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u90a3\u4e00\u5957\u6d41\u7a0b\uff0c\u66f4\u65b0\u8bed\u53e5\u4e5f\u662f\u540c\u6837\u4f1a\u8d70\u4e00\u904d\u3002</p>\n<p>\u4f60\u6267\u884c\u8bed\u53e5\u524d\u8981\u5148\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u8fd9\u662f\u8fde\u63a5\u5668\u7684\u5de5\u4f5c\u3002</p>\n<p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\uff0c\u5728\u4e00\u4e2a\u8868\u4e0a\u6709\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u8ddf\u8fd9\u4e2a\u8868\u6709\u5173\u7684\u67e5\u8be2\u7f13\u5b58\u4f1a\u5931\u6548\uff0c\u6240\u4ee5\u8fd9\u6761\u8bed\u53e5\u5c31\u4f1a\u628a\u8868 T \u4e0a\u6240\u6709\u7f13\u5b58\u7ed3\u679c\u90fd\u6e05\u7a7a\u3002\u8fd9\u4e5f\u5c31\u662f\u6211\u4eec\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u539f\u56e0\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u5206\u6790\u5668\u4f1a\u901a\u8fc7\u8bcd\u6cd5\u548c\u8bed\u6cd5\u89e3\u6790\u77e5\u9053\u8fd9\u662f\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u3002\u4f18\u5316\u5668\u51b3\u5b9a\u8981\u4f7f\u7528 ID \u8fd9\u4e2a\u7d22\u5f15\u3002\u7136\u540e\uff0c\u6267\u884c\u5668\u8d1f\u8d23\u5177\u4f53\u6267\u884c\uff0c\u627e\u5230\u8fd9\u4e00\u884c\uff0c\u7136\u540e\u66f4\u65b0\u3002</p>\n<p>\u4e0e\u67e5\u8be2\u6d41\u7a0b\u4e0d\u4e00\u6837\u7684\u662f\uff0c\u66f4\u65b0\u6d41\u7a0b\u8fd8\u6d89\u53ca\u4e24\u4e2a\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff0c\u5b83\u4eec\u6b63\u662f\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u4e3b\u89d2\uff1aredo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\u548c binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002\u5982\u679c\u63a5\u89e6 MySQL\uff0c\u90a3\u8fd9\u4e24\u4e2a\u8bcd\u80af\u5b9a\u662f\u7ed5\u4e0d\u8fc7\u7684\uff0c\u6211\u540e\u9762\u7684\u5185\u5bb9\u91cc\u4e5f\u4f1a\u4e0d\u65ad\u5730\u548c\u4f60\u5f3a\u8c03\u3002\u4e0d\u8fc7\u8bdd\u8bf4\u56de\u6765\uff0credo log \u548c binlog \u5728\u8bbe\u8ba1\u4e0a\u6709\u5f88\u591a\u6709\u610f\u601d\u7684\u5730\u65b9\uff0c\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u8def\u4e5f\u53ef\u4ee5\u7528\u5230\u4f60\u81ea\u5df1\u7684\u7a0b\u5e8f\u91cc\u3002</p>\n<h3 id=\"redo-log\">\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1aredo log<a class=\"headerlink\" href=\"#redo-log\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0d\u77e5\u9053\u4f60\u8fd8\u8bb0\u4e0d\u8bb0\u5f97\u300a\u5b54\u4e59\u5df1\u300b\u8fd9\u7bc7\u6587\u7ae0\uff0c\u9152\u5e97\u638c\u67dc\u6709\u4e00\u4e2a\u7c89\u677f\uff0c\u4e13\u95e8\u7528\u6765\u8bb0\u5f55\u5ba2\u4eba\u7684\u8d4a\u8d26\u8bb0\u5f55\u3002\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u4e0d\u591a\uff0c\u90a3\u4e48\u4ed6\u53ef\u4ee5\u628a\u987e\u5ba2\u540d\u548c\u8d26\u76ee\u5199\u5728\u677f\u4e0a\u3002\u4f46\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u591a\u4e86\uff0c\u7c89\u677f\u603b\u4f1a\u6709\u8bb0\u4e0d\u4e0b\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u4e00\u5b9a\u8fd8\u6709\u4e00\u4e2a\u4e13\u95e8\u8bb0\u5f55\u8d4a\u8d26\u7684\u8d26\u672c\u3002</p>\n<p>\u5982\u679c\u6709\u4eba\u8981\u8d4a\u8d26\u6216\u8005\u8fd8\u8d26\u7684\u8bdd\uff0c\u638c\u67dc\u4e00\u822c\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p>\n<ul>\n<li>\u4e00\u79cd\u505a\u6cd5\u662f\u76f4\u63a5\u628a\u8d26\u672c\u7ffb\u51fa\u6765\uff0c\u628a\u8fd9\u6b21\u8d4a\u7684\u8d26\u52a0\u4e0a\u53bb\u6216\u8005\u6263\u9664\u6389\uff1b</li>\n<li>\u53e6\u4e00\u79cd\u505a\u6cd5\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e0b\u8fd9\u6b21\u7684\u8d26\uff0c\u7b49\u6253\u70ca\u4ee5\u540e\u518d\u628a\u8d26\u672c\u7ffb\u51fa\u6765\u6838\u7b97\u3002</li>\n</ul>\n<p>\u5728\u751f\u610f\u7ea2\u706b\u67dc\u53f0\u5f88\u5fd9\u65f6\uff0c\u638c\u67dc\u4e00\u5b9a\u4f1a\u9009\u62e9\u540e\u8005\uff0c\u56e0\u4e3a\u524d\u8005\u64cd\u4f5c\u5b9e\u5728\u662f\u592a\u9ebb\u70e6\u4e86\u3002\u9996\u5148\uff0c\u4f60\u5f97\u627e\u5230\u8fd9\u4e2a\u4eba\u7684\u8d4a\u8d26\u603b\u989d\u90a3\u6761\u8bb0\u5f55\u3002\u4f60\u60f3\u60f3\uff0c\u5bc6\u5bc6\u9ebb\u9ebb\u51e0\u5341\u9875\uff0c\u638c\u67dc\u8981\u627e\u5230\u90a3\u4e2a\u540d\u5b57\uff0c\u53ef\u80fd\u8fd8\u5f97\u5e26\u4e0a\u8001\u82b1\u955c\u6162\u6162\u627e\uff0c\u627e\u5230\u4e4b\u540e\u518d\u62ff\u51fa\u7b97\u76d8\u8ba1\u7b97\uff0c\u6700\u540e\u518d\u5c06\u7ed3\u679c\u5199\u56de\u5230\u8d26\u672c\u4e0a\u3002</p>\n<p>\u8fd9\u6574\u4e2a\u8fc7\u7a0b\u60f3\u60f3\u90fd\u9ebb\u70e6\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8fd8\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e00\u4e0b\u65b9\u4fbf\u3002\u4f60\u60f3\u60f3\uff0c\u5982\u679c\u638c\u67dc\u6ca1\u6709\u7c89\u677f\u7684\u5e2e\u52a9\uff0c\u6bcf\u6b21\u8bb0\u8d26\u90fd\u5f97\u7ffb\u8d26\u672c\uff0c\u6548\u7387\u662f\u4e0d\u662f\u4f4e\u5f97\u8ba9\u4eba\u96be\u4ee5\u5fcd\u53d7\uff1f</p>\n<p>\u540c\u6837\uff0c\u5728 MySQL \u91cc\u4e5f\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u6bcf\u4e00\u6b21\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u9700\u8981\u5199\u8fdb\u78c1\u76d8\uff0c\u7136\u540e\u78c1\u76d8\u4e5f\u8981\u627e\u5230\u5bf9\u5e94\u7684\u90a3\u6761\u8bb0\u5f55\uff0c\u7136\u540e\u518d\u66f4\u65b0\uff0c\u6574\u4e2a\u8fc7\u7a0b IO \u6210\u672c\u3001\u67e5\u627e\u6210\u672c\u90fd\u5f88\u9ad8\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cMySQL \u7684\u8bbe\u8ba1\u8005\u5c31\u7528\u4e86\u7c7b\u4f3c\u9152\u5e97\u638c\u67dc\u7c89\u677f\u7684\u601d\u8def\u6765\u63d0\u5347\u66f4\u65b0\u6548\u7387\u3002</p>\n<p>\u800c\u7c89\u677f\u548c\u8d26\u672c\u914d\u5408\u7684\u6574\u4e2a\u8fc7\u7a0b\uff0c\u5176\u5b9e\u5c31\u662f MySQL \u91cc\u7ecf\u5e38\u8bf4\u5230\u7684 WAL \u6280\u672f\uff0cWAL \u7684\u5168\u79f0\u662f Write-Ahead Logging\uff0c\u5b83\u7684\u5173\u952e\u70b9\u5c31\u662f\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u5199\u78c1\u76d8\uff0c\u4e5f\u5c31\u662f\u5148\u5199\u7c89\u677f\uff0c\u7b49\u4e0d\u5fd9\u7684\u65f6\u5019\u518d\u5199\u8d26\u672c\u3002</p>\n<p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u6709\u4e00\u6761\u8bb0\u5f55\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019\uff0cInnoDB \u5f15\u64ce\u5c31\u4f1a\u5148\u628a\u8bb0\u5f55\u5199\u5230 redo log\uff08\u7c89\u677f\uff09\u91cc\u9762\uff0c\u5e76\u66f4\u65b0\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019\u66f4\u65b0\u5c31\u7b97\u5b8c\u6210\u4e86\u3002\u540c\u65f6\uff0cInnoDB \u5f15\u64ce\u4f1a\u5728\u9002\u5f53\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u91cc\u9762\uff0c\u800c\u8fd9\u4e2a\u66f4\u65b0\u5f80\u5f80\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u505a\uff0c\u8fd9\u5c31\u50cf\u6253\u70ca\u4ee5\u540e\u638c\u67dc\u505a\u7684\u4e8b\u3002</p>\n<p>\u5982\u679c\u4eca\u5929\u8d4a\u8d26\u7684\u4e0d\u591a\uff0c\u638c\u67dc\u53ef\u4ee5\u7b49\u6253\u70ca\u540e\u518d\u6574\u7406\u3002\u4f46\u5982\u679c\u67d0\u5929\u8d4a\u8d26\u7684\u7279\u522b\u591a\uff0c\u7c89\u677f\u5199\u6ee1\u4e86\uff0c\u53c8\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u53ea\u597d\u653e\u4e0b\u624b\u4e2d\u7684\u6d3b\u513f\uff0c\u628a\u7c89\u677f\u4e2d\u7684\u4e00\u90e8\u5206\u8d4a\u8d26\u8bb0\u5f55\u66f4\u65b0\u5230\u8d26\u672c\u4e2d\uff0c\u7136\u540e\u628a\u8fd9\u4e9b\u8bb0\u5f55\u4ece\u7c89\u677f\u4e0a\u64e6\u6389\uff0c\u4e3a\u8bb0\u65b0\u8d26\u817e\u51fa\u7a7a\u95f4\u3002</p>\n<p>\u4e0e\u6b64\u7c7b\u4f3c\uff0cInnoDB \u7684 redo log \u662f\u56fa\u5b9a\u5927\u5c0f\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u914d\u7f6e\u4e3a\u4e00\u7ec4 4 \u4e2a\u6587\u4ef6\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7684\u5927\u5c0f\u662f 1GB\uff0c\u90a3\u4e48\u8fd9\u5757\u201c\u7c89\u677f\u201d\u603b\u5171\u5c31\u53ef\u4ee5\u8bb0\u5f55 4GB \u7684\u64cd\u4f5c\u3002\u4ece\u5934\u5f00\u59cb\u5199\uff0c\u5199\u5230\u672b\u5c3e\u5c31\u53c8\u56de\u5230\u5f00\u5934\u5faa\u73af\u5199\uff0c\u5982\u4e0b\u9762\u8fd9\u4e2a\u56fe\u6240\u793a\u3002</p>\n<p><img alt=\"redo log cycle\" src=\"../../../images/mysql-lecture-45/1929130942-5db19244c8c03.png\" /></p>\n<p>write pos \u662f\u5f53\u524d\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u4e00\u8fb9\u5199\u4e00\u8fb9\u540e\u79fb\uff0c\u5199\u5230\u7b2c 3 \u53f7\u6587\u4ef6\u672b\u5c3e\u540e\u5c31\u56de\u5230 0 \u53f7\u6587\u4ef6\u5f00\u5934\u3002checkpoint \u662f\u5f53\u524d\u8981\u64e6\u9664\u7684\u4f4d\u7f6e\uff0c\u4e5f\u662f\u5f80\u540e\u63a8\u79fb\u5e76\u4e14\u5faa\u73af\u7684\uff0c\u64e6\u9664\u8bb0\u5f55\u524d\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u6570\u636e\u6587\u4ef6\u3002</p>\n<p>write pos \u548c checkpoint \u4e4b\u95f4\u7684\u662f\u201c\u7c89\u677f\u201d\u4e0a\u8fd8\u7a7a\u7740\u7684\u90e8\u5206(\u4e0a\u56fe\u7eff\u8272\u80cc\u666f\u90e8\u5206\uff09\uff0c\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u65b0\u7684\u64cd\u4f5c\u3002\u5982\u679c write pos \u8ffd\u4e0a checkpoint\uff0c\u8868\u793a\u201c\u7c89\u677f\u201d\u6ee1\u4e86\uff0c\u8fd9\u65f6\u5019\u4e0d\u80fd\u518d\u6267\u884c\u65b0\u7684\u66f4\u65b0\uff0c\u5f97\u505c\u4e0b\u6765\u5148\u64e6\u6389\u4e00\u4e9b\u8bb0\u5f55\uff0c\u628a checkpoint \u63a8\u8fdb\u4e00\u4e0b\u3002</p>\n<p>\u6709\u4e86 redo log\uff0cInnoDB \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5373\u4f7f\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4e4b\u524d\u63d0\u4ea4\u7684\u8bb0\u5f55\u90fd\u4e0d\u4f1a\u4e22\u5931\uff0c\u8fd9\u4e2a\u80fd\u529b\u79f0\u4e3a**crash-safe**\u3002</p>\n<p>\u8981\u7406\u89e3 crash-safe \u8fd9\u4e2a\u6982\u5ff5\uff0c\u53ef\u4ee5\u60f3\u60f3\u6211\u4eec\u524d\u9762\u8d4a\u8d26\u8bb0\u5f55\u7684\u4f8b\u5b50\u3002\u53ea\u8981\u8d4a\u8d26\u8bb0\u5f55\u8bb0\u5728\u4e86\u7c89\u677f\u4e0a\u6216\u5199\u5728\u4e86\u8d26\u672c\u4e0a\uff0c\u4e4b\u540e\u5373\u4f7f\u638c\u67dc\u5fd8\u8bb0\u4e86\uff0c\u6bd4\u5982\u7a81\u7136\u505c\u4e1a\u51e0\u5929\uff0c\u6062\u590d\u751f\u610f\u540e\u4f9d\u7136\u53ef\u4ee5\u901a\u8fc7\u8d26\u672c\u548c\u7c89\u677f\u4e0a\u7684\u6570\u636e\u660e\u786e\u8d4a\u8d26\u8d26\u76ee\u3002</p>\n<h3 id=\"binlog\">\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1abinlog<a class=\"headerlink\" href=\"#binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u6211\u4eec\u8bb2\u8fc7\uff0cMySQL \u6574\u4f53\u6765\u770b\uff0c\u5176\u5b9e\u5c31\u6709\u4e24\u5757\uff1a\u4e00\u5757\u662f Server \u5c42\uff0c\u5b83\u4e3b\u8981\u505a\u7684\u662f MySQL \u529f\u80fd\u5c42\u9762\u7684\u4e8b\u60c5\uff1b\u8fd8\u6709\u4e00\u5757\u662f\u5f15\u64ce\u5c42\uff0c\u8d1f\u8d23\u5b58\u50a8\u76f8\u5173\u7684\u5177\u4f53\u4e8b\u5b9c\u3002\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u7c89\u677f redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\u65e5\u5fd7\uff0c\u800c Server \u5c42\u4e5f\u6709\u81ea\u5df1\u7684\u65e5\u5fd7\uff0c\u79f0\u4e3a binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002</p>\n<p>\u6211\u60f3\u4f60\u80af\u5b9a\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4e24\u4efd\u65e5\u5fd7\u5462\uff1f</p>\n<p>\u56e0\u4e3a\u6700\u5f00\u59cb MySQL \u91cc\u5e76\u6ca1\u6709 InnoDB \u5f15\u64ce\u3002MySQL \u81ea\u5e26\u7684\u5f15\u64ce\u662f MyISAM\uff0c\u4f46\u662f MyISAM \u6ca1\u6709 crash-safe \u7684\u80fd\u529b\uff0cbinlog \u65e5\u5fd7\u53ea\u80fd\u7528\u4e8e\u5f52\u6863\u3002\u800c InnoDB \u662f\u53e6\u4e00\u4e2a\u516c\u53f8\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u5f15\u5165 MySQL \u7684\uff0c\u65e2\u7136\u53ea\u4f9d\u9760 binlog \u662f\u6ca1\u6709 crash-safe \u80fd\u529b\u7684\uff0c\u6240\u4ee5 InnoDB \u4f7f\u7528\u53e6\u5916\u4e00\u5957\u65e5\u5fd7\u7cfb\u7edf\u2014\u2014\u4e5f\u5c31\u662f redo log \u6765\u5b9e\u73b0 crash-safe \u80fd\u529b\u3002</p>\n<p>\u8fd9\u4e24\u79cd\u65e5\u5fd7\u6709\u4ee5\u4e0b\u4e09\u70b9\u4e0d\u540c\u3002</p>\n<ol>\n<li>redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\uff1bbinlog \u662f MySQL \u7684 Server \u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</li>\n<li>redo log \u662f\u7269\u7406\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u201c\u5728\u67d0\u4e2a\u6570\u636e\u9875\u4e0a\u505a\u4e86\u4ec0\u4e48\u4fee\u6539\u201d\uff1bbinlog \u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684\u539f\u59cb\u903b\u8f91\uff0c\u6bd4\u5982\u201c\u7ed9 ID=2 \u8fd9\u4e00\u884c\u7684 c \u5b57\u6bb5\u52a0 1 \u201d\u3002</li>\n<li>redo log \u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1bbinlog \u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307 binlog \u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</li>\n</ol>\n<p>\u6709\u4e86\u5bf9\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u7684\u6982\u5ff5\u6027\u7406\u89e3\uff0c\u6211\u4eec\u518d\u6765\u770b\u6267\u884c\u5668\u548c InnoDB \u5f15\u64ce\u5728\u6267\u884c\u8fd9\u4e2a\u7b80\u5355\u7684 update \u8bed\u53e5\u65f6\u7684\u5185\u90e8\u6d41\u7a0b\u3002</p>\n<ol>\n<li>\u6267\u884c\u5668\u5148\u627e\u5f15\u64ce\u53d6 ID=2 \u8fd9\u4e00\u884c\u3002ID \u662f\u4e3b\u952e\uff0c\u5f15\u64ce\u76f4\u63a5\u7528\u6811\u641c\u7d22\u627e\u5230\u8fd9\u4e00\u884c\u3002\u5982\u679c ID=2 \u8fd9\u4e00\u884c\u6240\u5728\u7684\u6570\u636e\u9875\u672c\u6765\u5c31\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u7ed9\u6267\u884c\u5668\uff1b\u5426\u5219\uff0c\u9700\u8981\u5148\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u518d\u8fd4\u56de\u3002</li>\n<li>\u6267\u884c\u5668\u62ff\u5230\u5f15\u64ce\u7ed9\u7684\u884c\u6570\u636e\uff0c\u628a\u8fd9\u4e2a\u503c\u52a0\u4e0a 1\uff0c\u6bd4\u5982\u539f\u6765\u662f N\uff0c\u73b0\u5728\u5c31\u662f N+1\uff0c\u5f97\u5230\u65b0\u7684\u4e00\u884c\u6570\u636e\uff0c\u518d\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u5199\u5165\u8fd9\u884c\u65b0\u6570\u636e\u3002</li>\n<li>\u5f15\u64ce\u5c06\u8fd9\u884c\u65b0\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u4e2d\uff0c\u540c\u65f6\u5c06\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u8bb0\u5f55\u5230 redo log \u91cc\u9762\uff0c\u6b64\u65f6 redo log \u5904\u4e8e prepare \u72b6\u6001\u3002\u7136\u540e\u544a\u77e5\u6267\u884c\u5668\u6267\u884c\u5b8c\u6210\u4e86\uff0c\u968f\u65f6\u53ef\u4ee5\u63d0\u4ea4\u4e8b\u52a1\u3002</li>\n<li>\u6267\u884c\u5668\u751f\u6210\u8fd9\u4e2a\u64cd\u4f5c\u7684 binlog\uff0c\u5e76\u628a binlog \u5199\u5165\u78c1\u76d8\u3002</li>\n<li>\u6267\u884c\u5668\u8c03\u7528\u5f15\u64ce\u7684\u63d0\u4ea4\u4e8b\u52a1\u63a5\u53e3\uff0c\u5f15\u64ce\u628a\u521a\u521a\u5199\u5165\u7684 redo log \u6539\u6210\u63d0\u4ea4\uff08commit\uff09\u72b6\u6001\uff0c\u66f4\u65b0\u5b8c\u6210\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u6211\u7ed9\u51fa\u8fd9\u4e2a update \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u56fe\uff0c\u56fe\u4e2d\u6d45\u8272\u6846\u8868\u793a\u662f\u5728 InnoDB \u5185\u90e8\u6267\u884c\u7684\uff0c\u6df1\u8272\u6846\u8868\u793a\u662f\u5728\u6267\u884c\u5668\u4e2d\u6267\u884c\u7684\u3002</p>\n<pre class=\"mermaid\"><code>flowchart TB\n    %% define node\n\n    A[\"\u53d6ID=2\u8fd9\u4e00\u884c\"]:::heavygreen --&gt; B{\"\u6570\u636e\u4e5f\u5728\u5185\u5b58\u4e2d\uff1f\"}\n    B --&gt;|Yes| C[\"\u8fd4\u56de\u6570\u636e\u884c\"]\n    C --&gt;D[\"\u5c06\u8fd9\u884c\u7684\u503c\u52a0\u4e00\"]:::heavygreen --&gt; E[\"\u5199\u5165\u65b0\u884c\"]:::heavygreen --&gt; F[\"\u65b0\u884c\u66f4\u65b0\u5230\u5185\u5b58\"]\n    F --&gt; G[\"\u5199\u5165redolog&lt;br/&gt;\u5904\u4e8eprepare\u9636\u6bb5\"]\n    G --&gt; H[\"\u5199 binlog\"]:::heavygreen --&gt; I[\"\u63d0\u4ea4\u4e8b\u52a1&lt;br/&gt;\u5199\u5165redolog,\u5904\u4e8e commit \u72b6\u6001\"]\n\n    B --&gt;|No| M[\"\u78c1\u76d8\u4e2d\u8bfb\u5165\u5185\u5b58\"] --&gt; C\n\n    classDef heavygreen fill:#558241</code></pre>\n<p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u6700\u540e\u4e09\u6b65\u770b\u4e0a\u53bb\u6709\u70b9\u201c\u7ed5\u201d\uff0c\u5c06 redo log \u7684\u5199\u5165\u62c6\u6210\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff1aprepare \u548c commit\uff0c\u8fd9\u5c31\u662f\"\u4e24\u9636\u6bb5\u63d0\u4ea4\"\u3002</p>\n<h3 id=\"_7\">\u4e24\u9636\u6bb5\u63d0\u4ea4<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u6709\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u5462\uff1f\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e24\u4efd\u65e5\u5fd7\u4e4b\u95f4\u7684\u903b\u8f91\u4e00\u81f4\u3002\u8981\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5f97\u4ece\u6587\u7ae0\u5f00\u5934\u7684\u90a3\u4e2a\u95ee\u9898\u8bf4\u8d77\uff1a<strong>\u600e\u6837\u8ba9\u6570\u636e\u5e93\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u4efb\u610f\u4e00\u79d2\u7684\u72b6\u6001\uff1f</strong></p>\n<p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u4e86\uff0cbinlog \u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u903b\u8f91\u64cd\u4f5c\uff0c\u5e76\u4e14\u662f\u91c7\u7528\u201c\u8ffd\u52a0\u5199\u201d\u7684\u5f62\u5f0f\u3002\u5982\u679c\u4f60\u7684 DBA \u627f\u8bfa\u8bf4\u534a\u4e2a\u6708\u5185\u53ef\u4ee5\u6062\u590d\uff0c\u90a3\u4e48\u5907\u4efd\u7cfb\u7edf\u4e2d\u4e00\u5b9a\u4f1a\u4fdd\u5b58\u6700\u8fd1\u534a\u4e2a\u6708\u7684\u6240\u6709 binlog\uff0c\u540c\u65f6\u7cfb\u7edf\u4f1a\u5b9a\u671f\u505a\u6574\u5e93\u5907\u4efd\u3002\u8fd9\u91cc\u7684\u201c\u5b9a\u671f\u201d\u53d6\u51b3\u4e8e\u7cfb\u7edf\u7684\u91cd\u8981\u6027\uff0c\u53ef\u4ee5\u662f\u4e00\u5929\u4e00\u5907\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u5468\u4e00\u5907\u3002</p>\n<p>\u5f53\u9700\u8981\u6062\u590d\u5230\u6307\u5b9a\u7684\u67d0\u4e00\u79d2\u65f6\uff0c\u6bd4\u5982\u67d0\u5929\u4e0b\u5348\u4e24\u70b9\u53d1\u73b0\u4e2d\u5348\u5341\u4e8c\u70b9\u6709\u4e00\u6b21\u8bef\u5220\u8868\uff0c\u9700\u8981\u627e\u56de\u6570\u636e\uff0c\u90a3\u4f60\u53ef\u4ee5\u8fd9\u4e48\u505a\uff1a</p>\n<ul>\n<li>\u9996\u5148\uff0c\u627e\u5230\u6700\u8fd1\u7684\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5982\u679c\u4f60\u8fd0\u6c14\u597d\uff0c\u53ef\u80fd\u5c31\u662f\u6628\u5929\u665a\u4e0a\u7684\u4e00\u4e2a\u5907\u4efd\uff0c\u4ece\u8fd9\u4e2a\u5907\u4efd\u6062\u590d\u5230\u4e34\u65f6\u5e93\uff1b</li>\n<li>\u7136\u540e\uff0c\u4ece\u5907\u4efd\u7684\u65f6\u95f4\u70b9\u5f00\u59cb\uff0c\u5c06\u5907\u4efd\u7684 binlog \u4f9d\u6b21\u53d6\u51fa\u6765\uff0c\u91cd\u653e\u5230\u4e2d\u5348\u8bef\u5220\u8868\u4e4b\u524d\u7684\u90a3\u4e2a\u65f6\u523b\u3002</li>\n</ul>\n<p>\u8fd9\u6837\u4f60\u7684\u4e34\u65f6\u5e93\u5c31\u8ddf\u8bef\u5220\u4e4b\u524d\u7684\u7ebf\u4e0a\u5e93\u4e00\u6837\u4e86\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u628a\u8868\u6570\u636e\u4ece\u4e34\u65f6\u5e93\u53d6\u51fa\u6765\uff0c\u6309\u9700\u8981\u6062\u590d\u5230\u7ebf\u4e0a\u5e93\u53bb\u3002</p>\n<p>\u597d\u4e86\uff0c\u8bf4\u5b8c\u4e86\u6570\u636e\u6062\u590d\u8fc7\u7a0b\uff0c\u6211\u4eec\u56de\u6765\u8bf4\u8bf4\uff0c\u4e3a\u4ec0\u4e48\u65e5\u5fd7\u9700\u8981\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u3002\u8fd9\u91cc\u4e0d\u59a8\u7528\u53cd\u8bc1\u6cd5\u6765\u8fdb\u884c\u89e3\u91ca\u3002</p>\n<p>\u7531\u4e8e redo log \u548c binlog \u662f\u4e24\u4e2a\u72ec\u7acb\u7684\u903b\u8f91\uff0c\u5982\u679c\u4e0d\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u8981\u4e48\u5c31\u662f\u5148\u5199\u5b8c redo log \u518d\u5199 binlog\uff0c\u6216\u8005\u91c7\u7528\u53cd\u8fc7\u6765\u7684\u987a\u5e8f\u3002\u6211\u4eec\u770b\u770b\u8fd9\u4e24\u79cd\u65b9\u5f0f\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p>\n<p>\u4ecd\u7136\u7528\u524d\u9762\u7684 update \u8bed\u53e5\u6765\u505a\u4f8b\u5b50\u3002\u5047\u8bbe\u5f53\u524d ID=2 \u7684\u884c\uff0c\u5b57\u6bb5 c \u7684\u503c\u662f 0\uff0c\u518d\u5047\u8bbe\u6267\u884c update \u8bed\u53e5\u8fc7\u7a0b\u4e2d\u5728\u5199\u5b8c\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u540e\uff0c\u7b2c\u4e8c\u4e2a\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5199\u5b8c\u671f\u95f4\u53d1\u751f\u4e86 crash\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\u5462\uff1f</p>\n<ol>\n<li><strong>\u5148\u5199 redo log \u540e\u5199 binlog</strong>\u3002\u5047\u8bbe\u5728 redo log \u5199\u5b8c\uff0cbinlog \u8fd8\u6ca1\u6709\u5199\u5b8c\u7684\u65f6\u5019\uff0cMySQL \u8fdb\u7a0b\u5f02\u5e38\u91cd\u542f\u3002\u7531\u4e8e\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\u7684\uff0credo log \u5199\u5b8c\u4e4b\u540e\uff0c\u7cfb\u7edf\u5373\u4f7f\u5d29\u6e83\uff0c\u4ecd\u7136\u80fd\u591f\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u6240\u4ee5\u6062\u590d\u540e\u8fd9\u4e00\u884c c \u7684\u503c\u662f 1\u3002 \u4f46\u662f\u7531\u4e8e binlog \u6ca1\u5199\u5b8c\u5c31 crash \u4e86\uff0c\u8fd9\u65f6\u5019 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u8bed\u53e5\u3002\u56e0\u6b64\uff0c\u4e4b\u540e\u5907\u4efd\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u5b58\u8d77\u6765\u7684 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8fd9\u6761\u8bed\u53e5\u3002 \u7136\u540e\u4f60\u4f1a\u53d1\u73b0\uff0c\u5982\u679c\u9700\u8981\u7528\u8fd9\u4e2a binlog \u6765\u6062\u590d\u4e34\u65f6\u5e93\u7684\u8bdd\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684 binlog \u4e22\u5931\uff0c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u5c31\u4f1a\u5c11\u4e86\u8fd9\u4e00\u6b21\u66f4\u65b0\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 0\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li>\n<li><strong>\u5148\u5199 binlog \u540e\u5199 redo log</strong>\u3002\u5982\u679c\u5728 binlog \u5199\u5b8c\u4e4b\u540e crash\uff0c\u7531\u4e8e redo log \u8fd8\u6ca1\u5199\uff0c\u5d29\u6e83\u6062\u590d\u4ee5\u540e\u8fd9\u4e2a\u4e8b\u52a1\u65e0\u6548\uff0c\u6240\u4ee5\u8fd9\u4e00\u884c c \u7684\u503c\u662f 0\u3002\u4f46\u662f binlog \u91cc\u9762\u5df2\u7ecf\u8bb0\u5f55\u4e86\u201c\u628a c \u4ece 0 \u6539\u6210 1\u201d\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u5728\u4e4b\u540e\u7528 binlog \u6765\u6062\u590d\u7684\u65f6\u5019\u5c31\u591a\u4e86\u4e00\u4e2a\u4e8b\u52a1\u51fa\u6765\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 1\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p>\n<p>\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\u5728\u5206\u522b\u5199 redo log \u6216 binlog \u540e\u5d29\u6e83\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f\u6570\u636e\u5e93\u5d29\u6e83\u91cd\u542f\u540e\uff0c\u4f1a\u68c0\u67e5 redo log \u91cc\u5904\u4e8e prepare \u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u7136\u540e\u6839\u636e binlog \u6765\u5224\u65ad\u662f\u5426\u8981\u63d0\u4ea4\u6216\u56de\u6eda\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u5982\u679cRedo log\u91cc\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u4f46binlog\u91cc\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8b\u52a1\u53d8\u66f4\u8bb0\u5f55\uff0c\u8bf4\u660e\u4e8b\u52a1\u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u90a3\u4e48\u5c31\u8981\u56de\u6eda\u8fd9\u4e2a\u4e8b\u52a1\u3002</li>\n<li>\u5982\u679cRedo log\u91cc\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u5e76\u4e14binlog\u91cc\u6709\u5bf9\u5e94\u7684\u4e8b\u52a1\u53d8\u66f4\u8bb0\u5f55\uff0c\u8bf4\u660e\u4e8b\u52a1\u5df2\u7ecf\u63d0\u4ea4\uff0c\u90a3\u4e48\u5c31\u8981\u7ee7\u7eed\u6267\u884c\u8fd9\u4e2a\u4e8b\u52a1\u3002</li>\n<li>\u5982\u679cRedo log\u91cc\u6ca1\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u8bf4\u660e\u6ca1\u6709\u672a\u5b8c\u6210\u7684\u4e8b\u52a1\uff0c\u90a3\u4e48\u5c31\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u64cd\u4f5c\u3002</li>\n</ul>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u6982\u7387\u662f\u4e0d\u662f\u5f88\u4f4e\uff0c\u5e73\u65f6\u4e5f\u6ca1\u6709\u4ec0\u4e48\u52a8\u4e0d\u52a8\u5c31\u9700\u8981\u6062\u590d\u4e34\u65f6\u5e93\u7684\u573a\u666f\u5440\uff1f</p>\n<p>\u5176\u5b9e\u4e0d\u662f\u7684\uff0c\u4e0d\u53ea\u662f\u8bef\u64cd\u4f5c\u540e\u9700\u8981\u7528\u8fd9\u4e2a\u8fc7\u7a0b\u6765\u6062\u590d\u6570\u636e\u3002\u5f53\u4f60\u9700\u8981\u6269\u5bb9\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u518d\u591a\u642d\u5efa\u4e00\u4e9b\u5907\u5e93\u6765\u589e\u52a0\u7cfb\u7edf\u7684\u8bfb\u80fd\u529b\u7684\u65f6\u5019\uff0c\u73b0\u5728\u5e38\u89c1\u7684\u505a\u6cd5\u4e5f\u662f\u7528\u5168\u91cf\u5907\u4efd\u52a0\u4e0a\u5e94\u7528 binlog \u6765\u5b9e\u73b0\u7684\uff0c\u8fd9\u4e2a\u201c\u4e0d\u4e00\u81f4\u201d\u5c31\u4f1a\u5bfc\u81f4\u4f60\u7684\u7ebf\u4e0a\u51fa\u73b0\u4e3b\u4ece\u6570\u636e\u5e93\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p>\n<p>\u7b80\u5355\u8bf4\uff0credo log \u548c binlog \u90fd\u53ef\u4ee5\u7528\u4e8e\u8868\u793a\u4e8b\u52a1\u7684\u63d0\u4ea4\u72b6\u6001\uff0c\u800c\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u8ba9\u8fd9\u4e24\u4e2a\u72b6\u6001\u4fdd\u6301\u903b\u8f91\u4e0a\u7684\u4e00\u81f4\u3002</p>\n<h3 id=\"_8\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u4ecb\u7ecd\u4e86 MySQL \u91cc\u9762\u6700\u91cd\u8981\u7684\u4e24\u4e2a\u65e5\u5fd7\uff0c\u5373\u7269\u7406\u65e5\u5fd7 redo log \u548c\u903b\u8f91\u65e5\u5fd7 binlog\u3002</p>\n<p>redo log \u7528\u4e8e\u4fdd\u8bc1 crash-safe \u80fd\u529b\u3002<code>innodb_flush_log_at_trx_commit</code> \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 redo log \u90fd\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 1\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 MySQL \u5f02\u5e38\u91cd\u542f\u4e4b\u540e\u6570\u636e\u4e0d\u4e22\u5931\u3002</p>\n<p>sync_binlog \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 binlog \u90fd\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u4e5f\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 1\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 MySQL \u5f02\u5e38\u91cd\u542f\u4e4b\u540e binlog \u4e0d\u4e22\u5931\u3002</p>\n<p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u5728 MySQL 5.7 \u548c 8.0 \u9ed8\u8ba4\u90fd\u662f\u8bbe\u7f6e\u4e3a 1</p>\n<h2 id=\"03\">03 \u4e8b\u52a1\u9694\u79bb\uff1a\u4e3a\u4ec0\u4e48\u4f60\u6539\u4e86\u6211\u8fd8\u770b\u4e0d\u89c1\uff1f<a class=\"headerlink\" href=\"#03\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63d0\u5230\u4e8b\u52a1\uff0c\u4f60\u80af\u5b9a\u4e0d\u964c\u751f\uff0c\u548c\u6570\u636e\u5e93\u6253\u4ea4\u9053\u7684\u65f6\u5019\uff0c\u6211\u4eec\u603b\u662f\u4f1a\u7528\u5230\u4e8b\u52a1\u3002\u6700\u7ecf\u5178\u7684\u4f8b\u5b50\u5c31\u662f\u8f6c\u8d26\uff0c\u4f60\u8981\u7ed9\u670b\u53cb\u5c0f\u738b\u8f6c 100 \u5757\u94b1\uff0c\u800c\u6b64\u65f6\u4f60\u7684\u94f6\u884c\u5361\u53ea\u6709 100 \u5757\u94b1\u3002</p>\n<p>\u8f6c\u8d26\u8fc7\u7a0b\u5177\u4f53\u5230\u7a0b\u5e8f\u91cc\u4f1a\u6709\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u67e5\u8be2\u4f59\u989d\u3001\u505a\u52a0\u51cf\u6cd5\u3001\u66f4\u65b0\u4f59\u989d\u7b49\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5fc5\u987b\u4fdd\u8bc1\u662f\u4e00\u4f53\u7684\uff0c\u4e0d\u7136\u7b49\u7a0b\u5e8f\u67e5\u5b8c\u4e4b\u540e\uff0c\u8fd8\u6ca1\u505a\u51cf\u6cd5\u4e4b\u524d\uff0c\u4f60\u8fd9 100 \u5757\u94b1\uff0c\u5b8c\u5168\u53ef\u4ee5\u501f\u7740\u8fd9\u4e2a\u65f6\u95f4\u5dee\u518d\u67e5\u4e00\u6b21\uff0c\u7136\u540e\u518d\u7ed9\u53e6\u5916\u4e00\u4e2a\u670b\u53cb\u8f6c\u8d26\uff0c\u5982\u679c\u94f6\u884c\u8fd9\u4e48\u6574\uff0c\u4e0d\u5c31\u4e71\u4e86\u4e48\uff1f\u8fd9\u65f6\u5c31\u8981\u7528\u5230\u201c\u4e8b\u52a1\u201d\u8fd9\u4e2a\u6982\u5ff5\u4e86\u3002</p>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u4e8b\u52a1\u5c31\u662f\u8981\u4fdd\u8bc1\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u5168\u90e8\u5931\u8d25\u3002\u5728 MySQL \u4e2d\uff0c\u4e8b\u52a1\u652f\u6301\u662f\u5728\u5f15\u64ce\u5c42\u5b9e\u73b0\u7684\u3002\u4f60\u73b0\u5728\u77e5\u9053\uff0cMySQL \u662f\u4e00\u4e2a\u652f\u6301\u591a\u5f15\u64ce\u7684\u7cfb\u7edf\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u4e8b\u52a1\u3002\u6bd4\u5982 MySQL \u539f\u751f\u7684 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u4e8b\u52a1\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u53d6\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p>\n<p>\u4eca\u5929\u7684\u6587\u7ae0\u91cc\uff0c\u6211\u5c06\u4f1a\u4ee5 InnoDB \u4e3a\u4f8b\uff0c\u5256\u6790 MySQL \u5728\u4e8b\u52a1\u652f\u6301\u65b9\u9762\u7684\u7279\u5b9a\u5b9e\u73b0\uff0c\u5e76\u57fa\u4e8e\u539f\u7406\u7ed9\u51fa\u76f8\u5e94\u7684\u5b9e\u8df5\u5efa\u8bae\uff0c\u5e0c\u671b\u8fd9\u4e9b\u6848\u4f8b\u80fd\u52a0\u6df1\u4f60\u5bf9 MySQL \u4e8b\u52a1\u539f\u7406\u7684\u7406\u89e3\u3002</p>\n<h3 id=\"_9\">\u4e8b\u52a1\u9694\u79bb\u7684\u5b9e\u73b0<a class=\"headerlink\" href=\"#_9\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7406\u89e3\u4e86\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u4e8b\u52a1\u9694\u79bb\u5177\u4f53\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u3002\u8fd9\u91cc\u6211\u4eec\u5c55\u5f00\u8bf4\u660e\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u3002</p>\n<p>\u5728 MySQL \u4e2d\uff0c\u5b9e\u9645\u4e0a\u6bcf\u6761\u8bb0\u5f55\u5728\u66f4\u65b0\u7684\u65f6\u5019\u90fd\u4f1a\u540c\u65f6\u8bb0\u5f55\u4e00\u6761\u56de\u6eda\u64cd\u4f5c\u3002\u8bb0\u5f55\u4e0a\u7684\u6700\u65b0\u503c\uff0c\u901a\u8fc7\u56de\u6eda\u64cd\u4f5c\uff0c\u90fd\u53ef\u4ee5\u5f97\u5230\u524d\u4e00\u4e2a\u72b6\u6001\u7684\u503c\u3002</p>\n<p>\u5047\u8bbe\u4e00\u4e2a\u503c\u4ece 1 \u88ab\u6309\u987a\u5e8f\u6539\u6210\u4e86 2\u30013\u30014\uff0c\u5728\u56de\u6eda\u65e5\u5fd7\u91cc\u9762\u5c31\u4f1a\u6709\u7c7b\u4f3c\u4e0b\u9762\u7684\u8bb0\u5f55\u3002</p>\n<pre class=\"mermaid\"><code>flowchart LR\n    %% define node\n        A[\"read view A\"] .-&gt; 2to1\n    B[\"read view B\"] .-&gt; 3to2\n\n    curr[\"\u5f53\u524d\u503c4\"] --&gt; 4to3\n    direction TB\n    C[\"read view C\"] .-&gt; curr\n\n    subgraph redo [\"\u56de\u6eda\u6bb5\"]\n        direction RL\n        2to1[\"\u5c062\u6539\u62101\"]:::heavygreen\n        3to2[\"\u5c063\u6539\u62102\"]\n        4to3[\"\u5c064\u6539\u62103\"]:::heavygreen\n\n        4to3  --&gt; 3to2 --&gt; 2to1\n    end\n\n    classDef heavygreen fill:#f8f2</code></pre>\n<p>\u5f53\u524d\u503c\u662f 4\uff0c\u4f46\u662f\u5728\u67e5\u8be2\u8fd9\u6761\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u4e0d\u540c\u65f6\u523b\u542f\u52a8\u7684\u4e8b\u52a1\u4f1a\u6709\u4e0d\u540c\u7684 read-view\u3002\u5982\u56fe\u4e2d\u770b\u5230\u7684\uff0c\u5728\u89c6\u56fe A\u3001B\u3001C \u91cc\u9762\uff0c\u8fd9\u4e00\u4e2a\u8bb0\u5f55\u7684\u503c\u5206\u522b\u662f 1\u30012\u30014\uff0c\u540c\u4e00\u6761\u8bb0\u5f55\u5728\u7cfb\u7edf\u4e2d\u53ef\u4ee5\u5b58\u5728\u591a\u4e2a\u7248\u672c\uff0c\u5c31\u662f\u6570\u636e\u5e93\u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08MVCC\uff09\u3002\u5bf9\u4e8e read-view A\uff0c\u8981\u5f97\u5230 1\uff0c\u5c31\u5fc5\u987b\u5c06\u5f53\u524d\u503c\u4f9d\u6b21\u6267\u884c\u56fe\u4e2d\u6240\u6709\u7684\u56de\u6eda\u64cd\u4f5c\u5f97\u5230\u3002</p>\n<p>\u540c\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u5373\u4f7f\u73b0\u5728\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u5c06 4 \u6539\u6210 5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u8ddf read-view A\u3001B\u3001C \u5bf9\u5e94\u7684\u4e8b\u52a1\u662f\u4e0d\u4f1a\u51b2\u7a81\u7684\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u95ee\uff0c\u56de\u6eda\u65e5\u5fd7\u603b\u4e0d\u80fd\u4e00\u76f4\u4fdd\u7559\u5427\uff0c\u4ec0\u4e48\u65f6\u5019\u5220\u9664\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5728\u4e0d\u9700\u8981\u7684\u65f6\u5019\u624d\u5220\u9664\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7cfb\u7edf\u4f1a\u5224\u65ad\uff0c\u5f53\u6ca1\u6709\u4e8b\u52a1\u518d\u9700\u8981\u7528\u5230\u8fd9\u4e9b\u56de\u6eda\u65e5\u5fd7\u65f6\uff0c\u56de\u6eda\u65e5\u5fd7\u4f1a\u88ab\u5220\u9664\u3002</p>\n<p>\u4ec0\u4e48\u65f6\u5019\u624d\u4e0d\u9700\u8981\u4e86\u5462\uff1f\u5c31\u662f\u5f53\u7cfb\u7edf\u91cc\u6ca1\u6709\u6bd4\u8fd9\u4e2a\u56de\u6eda\u65e5\u5fd7\u66f4\u65e9\u7684 read-view \u7684\u65f6\u5019\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u5efa\u8bae\u4f60\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u957f\u4e8b\u52a1\u3002</p>\n<p>\u957f\u4e8b\u52a1\u610f\u5473\u7740\u7cfb\u7edf\u91cc\u9762\u4f1a\u5b58\u5728\u5f88\u8001\u7684\u4e8b\u52a1\u89c6\u56fe\u3002\u7531\u4e8e\u8fd9\u4e9b\u4e8b\u52a1\u968f\u65f6\u53ef\u80fd\u8bbf\u95ee\u6570\u636e\u5e93\u91cc\u9762\u7684\u4efb\u4f55\u6570\u636e\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\uff0c\u6570\u636e\u5e93\u91cc\u9762\u5b83\u53ef\u80fd\u7528\u5230\u7684\u56de\u6eda\u8bb0\u5f55\u90fd\u5fc5\u987b\u4fdd\u7559\uff0c\u8fd9\u5c31\u4f1a\u5bfc\u81f4\u5927\u91cf\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002</p>\n<p>\u5728 MySQL 5.5 \u53ca\u4ee5\u524d\u7684\u7248\u672c\uff0c\u56de\u6eda\u65e5\u5fd7\u662f\u8ddf\u6570\u636e\u5b57\u5178\u4e00\u8d77\u653e\u5728 ibdata \u6587\u4ef6\u91cc\u7684\uff0c\u5373\u4f7f\u957f\u4e8b\u52a1\u6700\u7ec8\u63d0\u4ea4\uff0c\u56de\u6eda\u6bb5\u88ab\u6e05\u7406\uff0c\u6587\u4ef6\u4e5f\u4e0d\u4f1a\u53d8\u5c0f\u3002\u6211\u89c1\u8fc7\u6570\u636e\u53ea\u6709 20GB\uff0c\u800c\u56de\u6eda\u6bb5\u6709 200GB \u7684\u5e93\u3002\u6700\u7ec8\u53ea\u597d\u4e3a\u4e86\u6e05\u7406\u56de\u6eda\u6bb5\uff0c\u91cd\u5efa\u6574\u4e2a\u5e93\u3002</p>\n<p>\u9664\u4e86\u5bf9\u56de\u6eda\u6bb5\u7684\u5f71\u54cd\uff0c\u957f\u4e8b\u52a1\u8fd8\u5360\u7528\u9501\u8d44\u6e90\uff0c\u4e5f\u53ef\u80fd\u62d6\u57ae\u6574\u4e2a\u5e93\uff0c\u8fd9\u4e2a\u6211\u4eec\u4f1a\u5728\u540e\u9762\u8bb2\u9501\u7684\u65f6\u5019\u5c55\u5f00\u3002</p>\n<h3 id=\"_10\">\u4e8b\u52a1\u7684\u542f\u52a8\u65b9\u5f0f<a class=\"headerlink\" href=\"#_10\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u524d\u9762\u6240\u8ff0\uff0c\u957f\u4e8b\u52a1\u6709\u8fd9\u4e9b\u6f5c\u5728\u98ce\u9669\uff0c\u6211\u5f53\u7136\u662f\u5efa\u8bae\u4f60\u5c3d\u91cf\u907f\u514d\u3002\u5176\u5b9e\u5f88\u591a\u65f6\u5019\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u5e76\u4e0d\u662f\u6709\u610f\u4f7f\u7528\u957f\u4e8b\u52a1\uff0c\u901a\u5e38\u662f\u7531\u4e8e\u8bef\u7528\u6240\u81f4\u3002MySQL \u7684\u4e8b\u52a1\u542f\u52a8\u65b9\u5f0f\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p>\n<ol>\n<li>\u663e\u5f0f\u542f\u52a8\u4e8b\u52a1\u8bed\u53e5\uff0c begin \u6216 start transaction\u3002\u914d\u5957\u7684\u63d0\u4ea4\u8bed\u53e5\u662f commit\uff0c\u56de\u6eda\u8bed\u53e5\u662f rollback\u3002</li>\n<li><code>set autocommit=0</code>\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5c06\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u81ea\u52a8\u63d0\u4ea4\u5173\u6389\u3002\u610f\u5473\u7740\u5982\u679c\u4f60\u53ea\u6267\u884c\u4e00\u4e2a select \u8bed\u53e5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5c31\u542f\u52a8\u4e86\uff0c\u800c\u4e14\u5e76\u4e0d\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002\u8fd9\u4e2a\u4e8b\u52a1\u6301\u7eed\u5b58\u5728\u76f4\u5230\u4f60\u4e3b\u52a8\u6267\u884c commit \u6216 rollback \u8bed\u53e5\uff0c\u6216\u8005\u65ad\u5f00\u8fde\u63a5\u3002</li>\n</ol>\n<p>\u6709\u4e9b\u5ba2\u6237\u7aef\u8fde\u63a5\u6846\u67b6\u4f1a\u9ed8\u8ba4\u8fde\u63a5\u6210\u529f\u540e\u5148\u6267\u884c\u4e00\u4e2a <code>set autocommit=0</code> \u7684\u547d\u4ee4\u3002\u8fd9\u5c31\u5bfc\u81f4\u63a5\u4e0b\u6765\u7684\u67e5\u8be2\u90fd\u5728\u4e8b\u52a1\u4e2d\uff0c\u5982\u679c\u662f\u957f\u8fde\u63a5\uff0c\u5c31\u5bfc\u81f4\u4e86\u610f\u5916\u7684\u957f\u4e8b\u52a1\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6211\u4f1a\u5efa\u8bae\u4f60\u603b\u662f\u4f7f\u7528 <code>set autocommit=1</code>, \u901a\u8fc7\u663e\u5f0f\u8bed\u53e5\u7684\u65b9\u5f0f\u6765\u542f\u52a8\u4e8b\u52a1\u3002</p>\n<p>\u4f46\u662f\u6709\u7684\u5f00\u53d1\u540c\u5b66\u4f1a\u7ea0\u7ed3\u201c\u591a\u4e00\u6b21\u4ea4\u4e92\u201d\u7684\u95ee\u9898\u3002\u5bf9\u4e8e\u4e00\u4e2a\u9700\u8981\u9891\u7e41\u4f7f\u7528\u4e8b\u52a1\u7684\u4e1a\u52a1\uff0c\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u6bcf\u4e2a\u4e8b\u52a1\u5728\u5f00\u59cb\u65f6\u90fd\u4e0d\u9700\u8981\u4e3b\u52a8\u6267\u884c\u4e00\u6b21 \u201cbegin\u201d\uff0c\u51cf\u5c11\u4e86\u8bed\u53e5\u7684\u4ea4\u4e92\u6b21\u6570\u3002\u5982\u679c\u4f60\u4e5f\u6709\u8fd9\u4e2a\u987e\u8651\uff0c\u6211\u5efa\u8bae\u4f60\u4f7f\u7528 <code>commit work and chain</code> \u8bed\u6cd5\u3002</p>\n<p>\u5728 autocommit \u4e3a 1 \u7684\u60c5\u51b5\u4e0b\uff0c\u7528 begin \u663e\u5f0f\u542f\u52a8\u7684\u4e8b\u52a1\uff0c\u5982\u679c\u6267\u884c commit \u5219\u63d0\u4ea4\u4e8b\u52a1\u3002\u5982\u679c\u6267\u884c commit work and chain\uff0c\u5219\u662f\u63d0\u4ea4\u4e8b\u52a1\u5e76\u81ea\u52a8\u542f\u52a8\u4e0b\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8fd9\u6837\u4e5f\u7701\u53bb\u4e86\u518d\u6b21\u6267\u884c begin \u8bed\u53e5\u7684\u5f00\u9500\u3002\u540c\u65f6\u5e26\u6765\u7684\u597d\u5904\u662f\u4ece\u7a0b\u5e8f\u5f00\u53d1\u7684\u89d2\u5ea6\u660e\u786e\u5730\u77e5\u9053\u6bcf\u4e2a\u8bed\u53e5\u662f\u5426\u5904\u4e8e\u4e8b\u52a1\u4e2d\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u5728 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8fd9\u4e2a\u8868\u4e2d\u67e5\u8be2\u957f\u4e8b\u52a1\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7528\u4e8e\u67e5\u627e\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 60s \u7684\u4e8b\u52a1\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">INNODB_TRX</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">TIME_TO_SEC</span><span class=\"p\">(</span><span class=\"n\">timediff</span><span class=\"p\">(</span><span class=\"n\">now</span><span class=\"p\">(),</span><span class=\"n\">trx_started</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"mi\">60</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_11\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_11\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u7bc7\u6587\u7ae0\u91cc\u9762\uff0c\u6211\u4ecb\u7ecd\u4e86 MySQL \u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u73b0\u8c61\u548c\u5b9e\u73b0\uff0c\u6839\u636e\u5b9e\u73b0\u539f\u7406\u5206\u6790\u4e86\u957f\u4e8b\u52a1\u5b58\u5728\u7684\u98ce\u9669\uff0c\u4ee5\u53ca\u5982\u4f55\u7528\u6b63\u786e\u7684\u65b9\u5f0f\u907f\u514d\u957f\u4e8b\u52a1\u3002\u5e0c\u671b\u6211\u4e3e\u7684\u4f8b\u5b50\u80fd\u591f\u5e2e\u52a9\u4f60\u7406\u89e3\u4e8b\u52a1\uff0c\u5e76\u66f4\u597d\u5730\u4f7f\u7528 MySQL \u7684\u4e8b\u52a1\u7279\u6027\u3002</p>\n<h2 id=\"04\">04 \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0a\uff09<a class=\"headerlink\" href=\"#04\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63d0\u5230\u6570\u636e\u5e93\u7d22\u5f15\uff0c\u6211\u60f3\u4f60\u5e76\u4e0d\u964c\u751f\uff0c\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u4f1a\u7ecf\u5e38\u63a5\u89e6\u5230\u3002\u6bd4\u5982\u67d0\u4e00\u4e2a SQL \u67e5\u8be2\u6bd4\u8f83\u6162\uff0c\u5206\u6790\u5b8c\u539f\u56e0\u4e4b\u540e\uff0c\u4f60\u53ef\u80fd\u5c31\u4f1a\u8bf4\u201c\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u52a0\u4e2a\u7d22\u5f15\u5427\u201d\u4e4b\u7c7b\u7684\u89e3\u51b3\u65b9\u6848\u3002\u4f46\u5230\u5e95\u4ec0\u4e48\u662f\u7d22\u5f15\uff0c\u7d22\u5f15\u53c8\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u5462\uff1f\u4eca\u5929\u5c31\u8ba9\u6211\u4eec\u4e00\u8d77\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u5427\u3002</p>\n<p>\u6570\u636e\u5e93\u7d22\u5f15\u7684\u5185\u5bb9\u6bd4\u8f83\u591a\uff0c\u6211\u5206\u6210\u4e86\u4e0a\u4e0b\u4e24\u7bc7\u6587\u7ae0\u3002\u7d22\u5f15\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u91cc\u9762\u6700\u91cd\u8981\u7684\u6982\u5ff5\u4e4b\u4e00\uff0c\u6240\u4ee5\u6211\u5e0c\u671b\u4f60\u80fd\u591f\u8010\u5fc3\u770b\u5b8c\u3002\u5728\u540e\u9762\u7684\u5b9e\u6218\u6587\u7ae0\u4e2d\uff0c\u6211\u4e5f\u4f1a\u7ecf\u5e38\u5f15\u7528\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u77e5\u8bc6\u70b9\uff0c\u52a0\u6df1\u4f60\u5bf9\u6570\u636e\u5e93\u7d22\u5f15\u7684\u7406\u89e3\u3002</p>\n<p>\u4e00\u53e5\u8bdd\u7b80\u5355\u6765\u8bf4\uff0c\u7d22\u5f15\u7684\u51fa\u73b0\u5176\u5b9e\u5c31\u662f\u4e3a\u4e86\u63d0\u9ad8\u6570\u636e\u67e5\u8be2\u7684\u6548\u7387\uff0c\u5c31\u50cf\u4e66\u7684\u76ee\u5f55\u4e00\u6837\u3002\u4e00\u672c 500 \u9875\u7684\u4e66\uff0c\u5982\u679c\u4f60\u60f3\u5feb\u901f\u627e\u5230\u5176\u4e2d\u7684\u67d0\u4e00\u4e2a\u77e5\u8bc6\u70b9\uff0c\u5728\u4e0d\u501f\u52a9\u76ee\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u90a3\u6211\u4f30\u8ba1\u4f60\u53ef\u5f97\u627e\u4e00\u4f1a\u513f\u3002\u540c\u6837\uff0c\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u8868\u800c\u8a00\uff0c\u7d22\u5f15\u5176\u5b9e\u5c31\u662f\u5b83\u7684\u201c\u76ee\u5f55\u201d\u3002</p>\n<h3 id=\"innodb\">InnoDB \u7684\u7d22\u5f15\u6a21\u578b<a class=\"headerlink\" href=\"#innodb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 InnoDB \u4e2d\uff0c\u8868\u90fd\u662f\u6839\u636e\u4e3b\u952e\u987a\u5e8f\u4ee5\u7d22\u5f15\u7684\u5f62\u5f0f\u5b58\u653e\u7684\uff0c\u8fd9\u79cd\u5b58\u50a8\u65b9\u5f0f\u7684\u8868\u79f0\u4e3a\u7d22\u5f15\u7ec4\u7ec7\u8868\u3002\u53c8\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u63d0\u5230\u7684\uff0cInnoDB \u4f7f\u7528\u4e86 B+ \u6811\u7d22\u5f15\u6a21\u578b\uff0c\u6240\u4ee5\u6570\u636e\u90fd\u662f\u5b58\u50a8\u5728 B+ \u6811\u4e2d\u7684\u3002</p>\n<p>\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5728 InnoDB \u91cc\u9762\u5bf9\u5e94\u4e00\u68f5 B+ \u6811\u3002</p>\n<p>\u5047\u8bbe\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u4e3b\u952e\u5217\u4e3a ID \u7684\u8868\uff0c\u8868\u4e2d\u6709\u5b57\u6bb5 k\uff0c\u5e76\u4e14\u5728 k \u4e0a\u6709\u7d22\u5f15\u3002</p>\n<p>\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">(</span>\n<span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span>\n<span class=\"n\">k</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">),</span>\n<span class=\"k\">index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">))</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8868\u4e2d R1~R5 \u7684 (ID,k) \u503c\u5206\u522b\u4e3a (100,1)\u3001(200,2)\u3001(300,3)\u3001(500,5) \u548c (600,6)\uff0c\u4e24\u68f5\u6811\u7684\u793a\u4f8b\u793a\u610f\u56fe\u5982\u4e0b\u3002</p>\n<p><img alt=\"InnoDB \u7684\u7d22\u5f15\u7ec4\u7ec7\u7ed3\u6784\" src=\"../../../images/mysql-lecture-45/dcda101051f28502bd5c4402b292e38d.png\" /></p>\n<p>\u4ece\u56fe\u4e2d\u4e0d\u96be\u770b\u51fa\uff0c\u6839\u636e\u53f6\u5b50\u8282\u70b9\u7684\u5185\u5bb9\uff0c\u7d22\u5f15\u7c7b\u578b\u5206\u4e3a\u4e3b\u952e\u7d22\u5f15\u548c\u975e\u4e3b\u952e\u7d22\u5f15\u3002</p>\n<p>\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u7684\u662f\u6574\u884c\u6570\u636e\u3002\u5728 InnoDB \u91cc\uff0c\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u805a\u7c07\u7d22\u5f15\uff08clustered index\uff09\u3002</p>\n<p>\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5185\u5bb9\u662f\u4e3b\u952e\u7684\u503c\u3002\u5728 InnoDB \u91cc\uff0c\u975e\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u4e8c\u7ea7\u7d22\u5f15\uff08secondary index\uff09\u3002</p>\n<p>\u6839\u636e\u4e0a\u9762\u7684\u7d22\u5f15\u7ed3\u6784\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a<strong>\u57fa\u4e8e\u4e3b\u952e\u7d22\u5f15\u548c\u666e\u901a\u7d22\u5f15\u7684\u67e5\u8be2\u6709\u4ec0\u4e48\u533a\u522b\uff1f</strong></p>\n<ul>\n<li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where ID=500</code>\uff0c\u5373\u4e3b\u952e\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u53ea\u9700\u8981\u641c\u7d22 ID \u8fd9\u68f5 B+ \u6811\uff1b</li>\n<li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where k=5</code>\uff0c\u5373\u666e\u901a\u7d22\u5f15\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u9700\u8981\u5148\u641c\u7d22 k \u7d22\u5f15\u6811\uff0c\u5f97\u5230 ID \u7684\u503c\u4e3a 500\uff0c\u518d\u5230 ID \u7d22\u5f15\u6811\u641c\u7d22\u4e00\u6b21\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u56de\u8868\u3002</li>\n</ul>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u57fa\u4e8e\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u67e5\u8be2\u9700\u8981\u591a\u626b\u63cf\u4e00\u68f5\u7d22\u5f15\u6811\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5728\u5e94\u7528\u4e2d\u5e94\u8be5\u5c3d\u91cf\u4f7f\u7528\u4e3b\u952e\u67e5\u8be2\u3002</p>\n<h3 id=\"_12\">\u7d22\u5f15\u7ef4\u62a4<a class=\"headerlink\" href=\"#_12\" title=\"Permanent link\">&para;</a></h3>\n<p>B+ \u6811\u4e3a\u4e86\u7ef4\u62a4\u7d22\u5f15\u6709\u5e8f\u6027\uff0c\u5728\u63d2\u5165\u65b0\u503c\u7684\u65f6\u5019\u9700\u8981\u505a\u5fc5\u8981\u7684\u7ef4\u62a4\u3002\u4ee5\u4e0a\u9762\u8fd9\u4e2a\u56fe\u4e3a\u4f8b\uff0c\u5982\u679c\u63d2\u5165\u65b0\u7684\u884c ID \u503c\u4e3a 700\uff0c\u5219\u53ea\u9700\u8981\u5728 R5 \u7684\u8bb0\u5f55\u540e\u9762\u63d2\u5165\u4e00\u4e2a\u65b0\u8bb0\u5f55\u3002\u5982\u679c\u65b0\u63d2\u5165\u7684 ID \u503c\u4e3a 400\uff0c\u5c31\u76f8\u5bf9\u9ebb\u70e6\u4e86\uff0c\u9700\u8981\u903b\u8f91\u4e0a\u632a\u52a8\u540e\u9762\u7684\u6570\u636e\uff0c\u7a7a\u51fa\u4f4d\u7f6e\u3002</p>\n<p>\u800c\u66f4\u7cdf\u7684\u60c5\u51b5\u662f\uff0c\u5982\u679c R5 \u6240\u5728\u7684\u6570\u636e\u9875\u5df2\u7ecf\u6ee1\u4e86\uff0c\u6839\u636e B+ \u6811\u7684\u7b97\u6cd5\uff0c\u8fd9\u65f6\u5019\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u9875\uff0c\u7136\u540e\u632a\u52a8\u90e8\u5206\u6570\u636e\u8fc7\u53bb\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u9875\u5206\u88c2\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6027\u80fd\u81ea\u7136\u4f1a\u53d7\u5f71\u54cd\u3002</p>\n<p>\u9664\u4e86\u6027\u80fd\u5916\uff0c\u9875\u5206\u88c2\u64cd\u4f5c\u8fd8\u5f71\u54cd\u6570\u636e\u9875\u7684\u5229\u7528\u7387\u3002\u539f\u672c\u653e\u5728\u4e00\u4e2a\u9875\u7684\u6570\u636e\uff0c\u73b0\u5728\u5206\u5230\u4e24\u4e2a\u9875\u4e2d\uff0c\u6574\u4f53\u7a7a\u95f4\u5229\u7528\u7387\u964d\u4f4e\u5927\u7ea6 50%\u3002</p>\n<p>\u5f53\u7136\u6709\u5206\u88c2\u5c31\u6709\u5408\u5e76\u3002\u5f53\u76f8\u90bb\u4e24\u4e2a\u9875\u7531\u4e8e\u5220\u9664\u4e86\u6570\u636e\uff0c\u5229\u7528\u7387\u5f88\u4f4e\u4e4b\u540e\uff0c\u4f1a\u5c06\u6570\u636e\u9875\u505a\u5408\u5e76\u3002\u5408\u5e76\u7684\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u662f\u5206\u88c2\u8fc7\u7a0b\u7684\u9006\u8fc7\u7a0b\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u7d22\u5f15\u7ef4\u62a4\u8fc7\u7a0b\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u6848\u4f8b\uff1a</p>\n<blockquote>\n<p>\u4f60\u53ef\u80fd\u5728\u4e00\u4e9b\u5efa\u8868\u89c4\u8303\u91cc\u9762\u89c1\u5230\u8fc7\u7c7b\u4f3c\u7684\u63cf\u8ff0\uff0c\u8981\u6c42\u5efa\u8868\u8bed\u53e5\u91cc\u4e00\u5b9a\u8981\u6709\u81ea\u589e\u4e3b\u952e\u3002\u5f53\u7136\u4e8b\u65e0\u7edd\u5bf9\uff0c\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u54ea\u4e9b\u573a\u666f\u4e0b\u5e94\u8be5\u4f7f\u7528\u81ea\u589e\u4e3b\u952e\uff0c\u800c\u54ea\u4e9b\u573a\u666f\u4e0b\u4e0d\u5e94\u8be5\u3002</p>\n</blockquote>\n<p>\u81ea\u589e\u4e3b\u952e\u662f\u6307\u81ea\u589e\u5217\u4e0a\u5b9a\u4e49\u7684\u4e3b\u952e\uff0c\u5728\u5efa\u8868\u8bed\u53e5\u4e2d\u4e00\u822c\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a NOT NULL PRIMARY KEY AUTO_INCREMENT\u3002</p>\n<p>\u63d2\u5165\u65b0\u8bb0\u5f55\u7684\u65f6\u5019\u53ef\u4ee5\u4e0d\u6307\u5b9a ID \u7684\u503c\uff0c\u7cfb\u7edf\u4f1a\u83b7\u53d6\u5f53\u524d ID \u6700\u5927\u503c\u52a0 1 \u4f5c\u4e3a\u4e0b\u4e00\u6761\u8bb0\u5f55\u7684 ID \u503c\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u81ea\u589e\u4e3b\u952e\u7684\u63d2\u5165\u6570\u636e\u6a21\u5f0f\uff0c\u6b63\u7b26\u5408\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u9012\u589e\u63d2\u5165\u7684\u573a\u666f\u3002\u6bcf\u6b21\u63d2\u5165\u4e00\u6761\u65b0\u8bb0\u5f55\uff0c\u90fd\u662f\u8ffd\u52a0\u64cd\u4f5c\uff0c\u90fd\u4e0d\u6d89\u53ca\u5230\u632a\u52a8\u5176\u4ed6\u8bb0\u5f55\uff0c\u4e5f\u4e0d\u4f1a\u89e6\u53d1\u53f6\u5b50\u8282\u70b9\u7684\u5206\u88c2\u3002</p>\n<p>\u800c\u6709\u4e1a\u52a1\u903b\u8f91\u7684\u5b57\u6bb5\u505a\u4e3b\u952e\uff0c\u5219\u5f80\u5f80\u4e0d\u5bb9\u6613\u4fdd\u8bc1\u6709\u5e8f\u63d2\u5165\uff0c\u8fd9\u6837\u5199\u6570\u636e\u6210\u672c\u76f8\u5bf9\u8f83\u9ad8\u3002</p>\n<p>\u9664\u4e86\u8003\u8651\u6027\u80fd\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4ece\u5b58\u50a8\u7a7a\u95f4\u7684\u89d2\u5ea6\u6765\u770b\u3002\u5047\u8bbe\u4f60\u7684\u8868\u4e2d\u786e\u5b9e\u6709\u4e00\u4e2a\u552f\u4e00\u5b57\u6bb5\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u90a3\u5e94\u8be5\u7528\u8eab\u4efd\u8bc1\u53f7\u505a\u4e3b\u952e\uff0c\u8fd8\u662f\u7528\u81ea\u589e\u5b57\u6bb5\u505a\u4e3b\u952e\u5462\uff1f</p>\n<p>\u7531\u4e8e\u6bcf\u4e2a\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u4e0a\u90fd\u662f\u4e3b\u952e\u7684\u503c\u3002\u5982\u679c\u7528\u8eab\u4efd\u8bc1\u53f7\u505a\u4e3b\u952e\uff0c\u90a3\u4e48\u6bcf\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5360\u7528\u7ea6 20 \u4e2a\u5b57\u8282\uff0c\u800c\u5982\u679c\u7528\u6574\u578b\u505a\u4e3b\u952e\uff0c\u5219\u53ea\u8981 4 \u4e2a\u5b57\u8282\uff0c\u5982\u679c\u662f\u957f\u6574\u578b\uff08bigint\uff09\u5219\u662f 8 \u4e2a\u5b57\u8282\u3002</p>\n<p><strong>\u663e\u7136\uff0c\u4e3b\u952e\u957f\u5ea6\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5c31\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u4e5f\u5c31\u8d8a\u5c0f\u3002</strong></p>\n<p>\u6240\u4ee5\uff0c\u4ece\u6027\u80fd\u548c\u5b58\u50a8\u7a7a\u95f4\u65b9\u9762\u8003\u91cf\uff0c\u81ea\u589e\u4e3b\u952e\u5f80\u5f80\u662f\u66f4\u5408\u7406\u7684\u9009\u62e9\u3002</p>\n<p>\u6709\u6ca1\u6709\u4ec0\u4e48\u573a\u666f\u9002\u5408\u7528\u4e1a\u52a1\u5b57\u6bb5\u76f4\u63a5\u505a\u4e3b\u952e\u7684\u5462\uff1f\u8fd8\u662f\u6709\u7684\u3002\u6bd4\u5982\uff0c\u6709\u4e9b\u4e1a\u52a1\u7684\u573a\u666f\u9700\u6c42\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u53ea\u6709\u4e00\u4e2a\u7d22\u5f15\uff1b</li>\n<li>\u8be5\u7d22\u5f15\u5fc5\u987b\u662f\u552f\u4e00\u7d22\u5f15\u3002</li>\n</ol>\n<p>\u4f60\u4e00\u5b9a\u770b\u51fa\u6765\u4e86\uff0c\u8fd9\u5c31\u662f\u5178\u578b\u7684 KV \u573a\u666f\u3002</p>\n<p>\u7531\u4e8e\u6ca1\u6709\u5176\u4ed6\u7d22\u5f15\uff0c\u6240\u4ee5\u4e5f\u5c31\u4e0d\u7528\u8003\u8651\u5176\u4ed6\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5927\u5c0f\u7684\u95ee\u9898\u3002</p>\n<p>\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u8981\u4f18\u5148\u8003\u8651\u4e0a\u4e00\u6bb5\u63d0\u5230\u7684\u201c\u5c3d\u91cf\u4f7f\u7528\u4e3b\u952e\u67e5\u8be2\u201d\u539f\u5219\uff0c\u76f4\u63a5\u5c06\u8fd9\u4e2a\u7d22\u5f15\u8bbe\u7f6e\u4e3a\u4e3b\u952e\uff0c\u53ef\u4ee5\u907f\u514d\u6bcf\u6b21\u67e5\u8be2\u9700\u8981\u641c\u7d22\u4e24\u68f5\u6811\u3002</p>\n<h3 id=\"_13\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_13\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u8ddf\u4f60\u5206\u6790\u4e86\u6570\u636e\u5e93\u5f15\u64ce\u53ef\u7528\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ecb\u7ecd\u4e86 InnoDB \u91c7\u7528\u7684 B+ \u6811\u7ed3\u6784\uff0c\u4ee5\u53ca\u4e3a\u4ec0\u4e48 InnoDB \u8981\u8fd9\u4e48\u9009\u62e9\u3002B+ \u6811\u80fd\u591f\u5f88\u597d\u5730\u914d\u5408\u78c1\u76d8\u7684\u8bfb\u5199\u7279\u6027\uff0c\u51cf\u5c11\u5355\u6b21\u67e5\u8be2\u7684\u78c1\u76d8\u8bbf\u95ee\u6b21\u6570\u3002</p>\n<p>\u7531\u4e8e InnoDB \u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u521b\u5efa\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e\uff0c\u8fd9\u6837\u975e\u4e3b\u952e\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u6700\u5c0f\u3002\u4f46\u4e8b\u65e0\u7edd\u5bf9\uff0c\u6211\u4e5f\u8ddf\u4f60\u8ba8\u8bba\u4e86\u4f7f\u7528\u4e1a\u52a1\u903b\u8f91\u5b57\u6bb5\u505a\u4e3b\u952e\u7684\u5e94\u7528\u573a\u666f\u3002</p>\n<h2 id=\"05\">05 \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0b\uff09<a class=\"headerlink\" href=\"#05\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 InnoDB \u7d22\u5f15\u7684\u6570\u636e\u7ed3\u6784\u6a21\u578b\uff0c\u4eca\u5929\u6211\u4eec\u518d\u7ee7\u7eed\u804a\u804a\u8ddf MySQL \u7d22\u5f15\u6709\u5173\u7684\u6982\u5ff5\u3002</p>\n<p>\u5728\u5f00\u59cb\u8fd9\u7bc7\u6587\u7ae0\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a</p>\n<p>\u5728\u4e0b\u9762\u8fd9\u4e2a\u8868 T \u4e2d\uff0c\u5982\u679c\u6211\u6267\u884c <code>select * from T where k between 3 and 5</code>\uff0c\u9700\u8981\u6267\u884c\u51e0\u6b21\u6811\u7684\u641c\u7d22\u64cd\u4f5c\uff0c\u4f1a\u626b\u63cf\u591a\u5c11\u884c\uff1f</p>\n<p>\u4e0b\u9762\u662f\u8fd9\u4e2a\u8868\u7684\u521d\u59cb\u5316\u8bed\u53e5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span>\n<span class=\"n\">k</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span>\n<span class=\"n\">s</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span>\n<span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">))</span>\n<span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;aa&#39;</span><span class=\"p\">),(</span><span class=\"mi\">200</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"s1\">&#39;bb&#39;</span><span class=\"p\">),(</span><span class=\"mi\">300</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"s1\">&#39;cc&#39;</span><span class=\"p\">),(</span><span class=\"mi\">500</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"s1\">&#39;ee&#39;</span><span class=\"p\">),(</span><span class=\"mi\">600</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"s1\">&#39;ff&#39;</span><span class=\"p\">),(</span><span class=\"mi\">700</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"s1\">&#39;gg&#39;</span><span class=\"p\">);</span>\n</code></pre></div>\n<p><img alt=\" InnoDB \u7684\u7d22\u5f15\u7ec4\u7ec7\u7ed3\u6784\" src=\"../../../images/mysql-lecture-45/dcda101051f28502bd5c4402b292e38d.png\" /></p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u8fd9\u6761 SQL \u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p>\n<ol>\n<li>\u5728 k \u7d22\u5f15\u6811\u4e0a\u627e\u5230 k=3 \u7684\u8bb0\u5f55\uff0c\u53d6\u5f97 ID = 300\uff1b</li>\n<li>\u518d\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=300 \u5bf9\u5e94\u7684 R3\uff1b</li>\n<li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=5\uff0c\u53d6\u5f97 ID=500\uff1b</li>\n<li>\u518d\u56de\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=500 \u5bf9\u5e94\u7684 R4\uff1b</li>\n<li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=6\uff0c\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c<strong>\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u6811\u641c\u7d22\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u79f0\u4e3a\u56de\u8868</strong>\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u8bfb\u4e86 k \u7d22\u5f15\u6811\u7684 3 \u6761\u8bb0\u5f55\uff08\u6b65\u9aa4 1\u30013 \u548c 5\uff09\uff0c\u56de\u8868\u4e86\u4e24\u6b21\uff08\u6b65\u9aa4 2 \u548c 4\uff09\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u67e5\u8be2\u7ed3\u679c\u6240\u9700\u8981\u7684\u6570\u636e\u53ea\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u6709\uff0c\u6240\u4ee5\u4e0d\u5f97\u4e0d\u56de\u8868\u3002\u90a3\u4e48\uff0c\u6709\u6ca1\u6709\u53ef\u80fd\u7ecf\u8fc7\u7d22\u5f15\u4f18\u5316\uff0c\u907f\u514d\u56de\u8868\u8fc7\u7a0b\u5462\uff1f</p>\n<h3 id=\"_14\">\u8986\u76d6\u7d22\u5f15<a class=\"headerlink\" href=\"#_14\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u6267\u884c\u7684\u8bed\u53e5\u662f <code>select ID from T where k between 3 and 5</code>\uff0c\u8fd9\u65f6\u53ea\u9700\u8981\u67e5 ID \u7684\u503c\uff0c\u800c ID \u7684\u503c\u5df2\u7ecf\u5728 k \u7d22\u5f15\u6811\u4e0a\u4e86\uff0c\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u63d0\u4f9b\u67e5\u8be2\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u56de\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u8fd9\u4e2a\u67e5\u8be2\u91cc\u9762\uff0c\u7d22\u5f15 k \u5df2\u7ecf\u201c\u8986\u76d6\u4e86\u201d\u6211\u4eec\u7684\u67e5\u8be2\u9700\u6c42\uff0c\u6211\u4eec\u79f0\u4e3a\u8986\u76d6\u7d22\u5f15\u3002</p>\n<p><strong>\u7531\u4e8e\u8986\u76d6\u7d22\u5f15\u53ef\u4ee5\u51cf\u5c11\u6811\u7684\u641c\u7d22\u6b21\u6570\uff0c\u663e\u8457\u63d0\u5347\u67e5\u8be2\u6027\u80fd\uff0c\u6240\u4ee5\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\u662f\u4e00\u4e2a\u5e38\u7528\u7684\u6027\u80fd\u4f18\u5316\u624b\u6bb5\u3002</strong></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\u5728\u7d22\u5f15 k \u4e0a\u5176\u5b9e\u8bfb\u4e86\u4e09\u4e2a\u8bb0\u5f55\uff0cR3~R5\uff08\u5bf9\u5e94\u7684\u7d22\u5f15 k \u4e0a\u7684\u8bb0\u5f55\u9879\uff09\uff0c\u4f46\u662f\u5bf9\u4e8e MySQL \u7684 Server \u5c42\u6765\u8bf4\uff0c\u5b83\u5c31\u662f\u627e\u5f15\u64ce\u62ff\u5230\u4e86\u4e24\u6761\u8bb0\u5f55\uff0c\u56e0\u6b64 MySQL \u8ba4\u4e3a\u626b\u63cf\u884c\u6570\u662f 2\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u8986\u76d6\u7d22\u5f15\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a<strong>\u5728\u4e00\u4e2a\u5e02\u6c11\u4fe1\u606f\u8868\u4e0a\uff0c\u662f\u5426\u6709\u5fc5\u8981\u5c06\u8eab\u4efd\u8bc1\u53f7\u548c\u540d\u5b57\u5efa\u7acb\u8054\u5408\u7d22\u5f15\uff1f</strong></p>\n<p>\u5047\u8bbe\u8fd9\u4e2a\u5e02\u6c11\u8868\u7684\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">tuser</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id_card</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">name</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">age</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">ismale</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">tinyint</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">id_card</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id_card</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">name_age</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">name</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">age</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6211\u4eec\u77e5\u9053\uff0c\u8eab\u4efd\u8bc1\u53f7\u662f\u5e02\u6c11\u7684\u552f\u4e00\u6807\u8bc6\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u6709\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5e02\u6c11\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u6211\u4eec\u53ea\u8981\u5728\u8eab\u4efd\u8bc1\u53f7\u5b57\u6bb5\u4e0a\u5efa\u7acb\u7d22\u5f15\u5c31\u591f\u4e86\u3002\u800c\u518d\u5efa\u7acb\u4e00\u4e2a\uff08\u8eab\u4efd\u8bc1\u53f7\u3001\u59d3\u540d\uff09\u7684\u8054\u5408\u7d22\u5f15\uff0c\u662f\u4e0d\u662f\u6d6a\u8d39\u7a7a\u95f4\uff1f</p>\n<p>\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9ad8\u9891\u8bf7\u6c42\uff0c\u8981\u6839\u636e\u5e02\u6c11\u7684\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u4ed6\u7684\u59d3\u540d\uff0c\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u5c31\u6709\u610f\u4e49\u4e86\u3002\u5b83\u53ef\u4ee5\u5728\u8fd9\u4e2a\u9ad8\u9891\u8bf7\u6c42\u4e0a\u7528\u5230\u8986\u76d6\u7d22\u5f15\uff0c\u4e0d\u518d\u9700\u8981\u56de\u8868\u67e5\u6574\u884c\u8bb0\u5f55\uff0c\u51cf\u5c11\u8bed\u53e5\u7684\u6267\u884c\u65f6\u95f4\u3002</p>\n<p>\u5f53\u7136\uff0c\u7d22\u5f15\u5b57\u6bb5\u7684\u7ef4\u62a4\u603b\u662f\u6709\u4ee3\u4ef7\u7684\u3002\u56e0\u6b64\uff0c\u5728\u5efa\u7acb\u5197\u4f59\u7d22\u5f15\u6765\u652f\u6301\u8986\u76d6\u7d22\u5f15\u65f6\u5c31\u9700\u8981\u6743\u8861\u8003\u8651\u4e86\u3002\u8fd9\u6b63\u662f\u4e1a\u52a1 DBA\uff0c\u6216\u8005\u79f0\u4e3a\u4e1a\u52a1\u6570\u636e\u67b6\u6784\u5e08\u7684\u5de5\u4f5c\u3002</p>\n<h3 id=\"_15\">\u6700\u5de6\u524d\u7f00\u539f\u5219<a class=\"headerlink\" href=\"#_15\" title=\"Permanent link\">&para;</a></h3>\n<p>\u770b\u5230\u8fd9\u91cc\u4f60\u4e00\u5b9a\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u5982\u679c\u4e3a\u6bcf\u4e00\u79cd\u67e5\u8be2\u90fd\u8bbe\u8ba1\u4e00\u4e2a\u7d22\u5f15\uff0c\u7d22\u5f15\u662f\u4e0d\u662f\u592a\u591a\u4e86\u3002\u5982\u679c\u6211\u73b0\u5728\u8981\u6309\u7167\u5e02\u6c11\u7684\u8eab\u4efd\u8bc1\u53f7\u53bb\u67e5\u4ed6\u7684\u5bb6\u5ead\u5730\u5740\u5462\uff1f\u867d\u7136\u8fd9\u4e2a\u67e5\u8be2\u9700\u6c42\u5728\u4e1a\u52a1\u4e2d\u51fa\u73b0\u7684\u6982\u7387\u4e0d\u9ad8\uff0c\u4f46\u603b\u4e0d\u80fd\u8ba9\u5b83\u8d70\u5168\u8868\u626b\u63cf\u5427\uff1f\u53cd\u8fc7\u6765\u8bf4\uff0c\u5355\u72ec\u4e3a\u4e00\u4e2a\u4e0d\u9891\u7e41\u7684\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\uff08\u8eab\u4efd\u8bc1\u53f7\uff0c\u5730\u5740\uff09\u7684\u7d22\u5f15\u53c8\u611f\u89c9\u6709\u70b9\u6d6a\u8d39\u3002\u5e94\u8be5\u600e\u4e48\u505a\u5462\uff1f</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u5148\u548c\u4f60\u8bf4\u7ed3\u8bba\u5427\u3002<strong>B+ \u6811\u8fd9\u79cd\u7d22\u5f15\u7ed3\u6784\uff0c\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u7684\u201c\u6700\u5de6\u524d\u7f00\u201d\uff0c\u6765\u5b9a\u4f4d\u8bb0\u5f55\u3002</strong></p>\n<p>\u4e3a\u4e86\u76f4\u89c2\u5730\u8bf4\u660e\u8fd9\u4e2a\u6982\u5ff5\uff0c\u6211\u4eec\u7528 <code>(name\uff0cage)</code>  \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u6765\u5206\u6790\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/89f74c631110cfbc83298ef27dcd6370.jpg\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7d22\u5f15\u9879\u662f\u6309\u7167\u7d22\u5f15\u5b9a\u4e49\u91cc\u9762\u51fa\u73b0\u7684\u5b57\u6bb5\u987a\u5e8f\u6392\u5e8f\u7684\u3002</p>\n<p>\u5f53\u4f60\u7684\u903b\u8f91\u9700\u6c42\u662f\u67e5\u5230\u6240\u6709\u540d\u5b57\u662f\u201c\u5f20\u4e09\u201d\u7684\u4eba\u65f6\uff0c\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u5230 ID4\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\u5f97\u5230\u6240\u6709\u9700\u8981\u7684\u7ed3\u679c\u3002</p>\n<p>\u5982\u679c\u4f60\u8981\u67e5\u7684\u662f\u6240\u6709\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u201c\u5f20\u201d\u7684\u4eba\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u7684\u6761\u4ef6\u662f  <code>where name like '\u5f20%'</code>\u3002\u8fd9\u65f6\uff0c\u4f60\u4e5f\u80fd\u591f\u7528\u4e0a\u8fd9\u4e2a\u7d22\u5f15\uff0c\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\u662f ID3\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\uff0c\u76f4\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u4e3a\u6b62\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u53ea\u662f\u7d22\u5f15\u7684\u5168\u90e8\u5b9a\u4e49\uff0c\u53ea\u8981\u6ee1\u8db3\u6700\u5de6\u524d\u7f00\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u6765\u52a0\u901f\u68c0\u7d22\u3002\u8fd9\u4e2a\u6700\u5de6\u524d\u7f00\u53ef\u4ee5\u662f\u8054\u5408\u7d22\u5f15\u7684\u6700\u5de6 N \u4e2a\u5b57\u6bb5\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u7d22\u5f15\u7684\u6700\u5de6 M \u4e2a\u5b57\u7b26\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u5bf9\u6700\u5de6\u524d\u7f00\u7d22\u5f15\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a<strong>\u5728\u5efa\u7acb\u8054\u5408\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u5982\u4f55\u5b89\u6392\u7d22\u5f15\u5185\u7684\u5b57\u6bb5\u987a\u5e8f\u3002</strong></p>\n<p>\u8fd9\u91cc\u6211\u4eec\u7684\u8bc4\u4f30\u6807\u51c6\u662f\uff0c\u7d22\u5f15\u7684\u590d\u7528\u80fd\u529b\u3002\u56e0\u4e3a\u53ef\u4ee5\u652f\u6301\u6700\u5de6\u524d\u7f00\uff0c\u6240\u4ee5\u5f53\u5df2\u7ecf\u6709\u4e86 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u540e\uff0c\u4e00\u822c\u5c31\u4e0d\u9700\u8981\u5355\u72ec\u5728 a \u4e0a\u5efa\u7acb\u7d22\u5f15\u4e86\u3002\u56e0\u6b64\uff0c<strong>\u7b2c\u4e00\u539f\u5219\u662f\uff0c\u5982\u679c\u901a\u8fc7\u8c03\u6574\u987a\u5e8f\uff0c\u53ef\u4ee5\u5c11\u7ef4\u62a4\u4e00\u4e2a\u7d22\u5f15\uff0c\u90a3\u4e48\u8fd9\u4e2a\u987a\u5e8f\u5f80\u5f80\u5c31\u662f\u9700\u8981\u4f18\u5148\u8003\u8651\u91c7\u7528\u7684\u3002</strong></p>\n<p>\u6240\u4ee5\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u8fd9\u6bb5\u5f00\u5934\u7684\u95ee\u9898\u91cc\uff0c\u6211\u4eec\u8981\u4e3a\u9ad8\u9891\u8bf7\u6c42\u521b\u5efa (\u8eab\u4efd\u8bc1\u53f7\uff0c\u59d3\u540d\uff09\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\uff0c\u5e76\u7528\u8fd9\u4e2a\u7d22\u5f15\u652f\u6301\u201c\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5730\u5740\u201d\u7684\u9700\u6c42\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u65e2\u6709\u8054\u5408\u67e5\u8be2\uff0c\u53c8\u6709\u57fa\u4e8e a\u3001b \u5404\u81ea\u7684\u67e5\u8be2\u5462\uff1f\u67e5\u8be2\u6761\u4ef6\u91cc\u9762\u53ea\u6709 b \u7684\u8bed\u53e5\uff0c\u662f\u65e0\u6cd5\u4f7f\u7528 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u7684\uff0c\u8fd9\u65f6\u5019\u4f60\u4e0d\u5f97\u4e0d\u7ef4\u62a4\u53e6\u5916\u4e00\u4e2a\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u9700\u8981\u540c\u65f6\u7ef4\u62a4 (a,b)\u3001(b) \u8fd9\u4e24\u4e2a\u7d22\u5f15\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u8981**\u8003\u8651\u7684\u539f\u5219\u5c31\u662f\u7a7a\u95f4**\u4e86\u3002\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u5e02\u6c11\u8868\u7684\u60c5\u51b5\uff0cname \u5b57\u6bb5\u662f\u6bd4 age \u5b57\u6bb5\u5927\u7684 \uff0c\u90a3\u6211\u5c31\u5efa\u8bae\u4f60\u521b\u5efa\u4e00\u4e2a\uff08name,age) \u7684\u8054\u5408\u7d22\u5f15\u548c\u4e00\u4e2a (age) \u7684\u5355\u5b57\u6bb5\u7d22\u5f15\u3002</p>\n<h3 id=\"_16\">\u7d22\u5f15\u4e0b\u63a8<a class=\"headerlink\" href=\"#_16\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0a\u4e00\u6bb5\u6211\u4eec\u8bf4\u5230\u6ee1\u8db3\u6700\u5de6\u524d\u7f00\u539f\u5219\u7684\u65f6\u5019\uff0c\u6700\u5de6\u524d\u7f00\u53ef\u4ee5\u7528\u4e8e\u5728\u7d22\u5f15\u4e2d\u5b9a\u4f4d\u8bb0\u5f55\u3002\u8fd9\u65f6\uff0c\u4f60\u53ef\u80fd\u8981\u95ee\uff0c\u90a3\u4e9b\u4e0d\u7b26\u5408\u6700\u5de6\u524d\u7f00\u7684\u90e8\u5206\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f</p>\n<p>\u6211\u4eec\u8fd8\u662f\u4ee5\u5e02\u6c11\u8868\u7684\u8054\u5408\u7d22\u5f15\uff08name, age\uff09\u4e3a\u4f8b\u3002\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9700\u6c42\uff1a\u68c0\u7d22\u51fa\u8868\u4e2d\u201c\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u5f20\uff0c\u800c\u4e14\u5e74\u9f84\u662f 10 \u5c81\u7684\u6240\u6709\u7537\u5b69\u201d\u3002\u90a3\u4e48\uff0cSQL \u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tuser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"s1\">&#39;\u5f20%&#39;</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">age</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">ismale</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\u524d\u7f00\u7d22\u5f15\u89c4\u5219\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8bed\u53e5\u5728\u641c\u7d22\u7d22\u5f15\u6811\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u7528 \u201c\u5f20\u201d\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55 ID3\u3002\u5f53\u7136\uff0c\u8fd9\u8fd8\u4e0d\u9519\uff0c\u603b\u6bd4\u5168\u8868\u626b\u63cf\u8981\u597d\u3002</p>\n<p>\u7136\u540e\u5462\uff1f</p>\n<p>\u5f53\u7136\u662f\u5224\u65ad\u5176\u4ed6\u6761\u4ef6\u662f\u5426\u6ee1\u8db3\u3002</p>\n<p>\u5728 MySQL 5.6 \u4e4b\u524d\uff0c\u53ea\u80fd\u4ece ID3 \u5f00\u59cb\u4e00\u4e2a\u4e2a\u56de\u8868\u3002\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u627e\u51fa\u6570\u636e\u884c\uff0c\u518d\u5bf9\u6bd4\u5b57\u6bb5\u503c\u3002</p>\n<p>\u800c MySQL 5.6 \u5f15\u5165\u7684\u7d22\u5f15\u4e0b\u63a8\u4f18\u5316\uff08index condition pushdown)\uff0c \u53ef\u4ee5\u5728\u7d22\u5f15\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u7d22\u5f15\u4e2d\u5305\u542b\u7684\u5b57\u6bb5\u5148\u505a\u5224\u65ad\uff0c\u76f4\u63a5\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u51cf\u5c11\u56de\u8868\u6b21\u6570\u3002</p>\n<p>\u56fe 3 \u548c\u56fe 4\uff0c\u662f\u8fd9\u4e24\u4e2a\u8fc7\u7a0b\u7684\u6267\u884c\u6d41\u7a0b\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/b32aa8b1f75611e0759e52f5915539ac.jpg\" /></p>\n<p>\u56fe 3 \u65e0\u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/76e385f3df5a694cc4238c7b65acfe1b.jpg\" /></p>\n<p>\u56fe 4 \u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p>\n<p>\u5728\u56fe 3 \u548c 4 \u8fd9\u4e24\u4e2a\u56fe\u91cc\u9762\uff0c\u6bcf\u4e00\u4e2a\u865a\u7ebf\u7bad\u5934\u8868\u793a\u56de\u8868\u4e00\u6b21\u3002</p>\n<p>\u56fe 3 \u4e2d\uff0c\u5728 <code>(name,age)</code> \u7d22\u5f15\u91cc\u9762\u6211\u7279\u610f\u53bb\u6389\u4e86 age \u7684\u503c\uff0c\u8fd9\u4e2a\u8fc7\u7a0b InnoDB \u5e76\u4e0d\u4f1a\u53bb\u770b age \u7684\u503c\uff0c\u53ea\u662f\u6309\u987a\u5e8f\u628a\u201cname \u7b2c\u4e00\u4e2a\u5b57\u662f\u2019\u5f20\u2019\u201d\u7684\u8bb0\u5f55\u4e00\u6761\u6761\u53d6\u51fa\u6765\u56de\u8868\u3002\u56e0\u6b64\uff0c\u9700\u8981\u56de\u8868 4 \u6b21\u3002</p>\n<p>\u56fe 4 \u8ddf\u56fe 3 \u7684\u533a\u522b\u662f\uff0cInnoDB \u5728 (name,age) \u7d22\u5f15\u5185\u90e8\u5c31\u5224\u65ad\u4e86 age \u662f\u5426\u7b49\u4e8e 10\uff0c\u5bf9\u4e8e\u4e0d\u7b49\u4e8e 10 \u7684\u8bb0\u5f55\uff0c\u76f4\u63a5\u5224\u65ad\u5e76\u8df3\u8fc7\u3002\u5728\u6211\u4eec\u7684\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u53ea\u9700\u8981\u5bf9 ID4\u3001ID5 \u8fd9\u4e24\u6761\u8bb0\u5f55\u56de\u8868\u53d6\u6570\u636e\u5224\u65ad\uff0c\u5c31\u53ea\u9700\u8981\u56de\u8868 2 \u6b21\u3002</p>\n<h3 id=\"_17\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_17\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u7ee7\u7eed\u8ba8\u8bba\u4e86\u6570\u636e\u5e93\u7d22\u5f15\u7684\u6982\u5ff5\uff0c\u5305\u62ec\u4e86\u8986\u76d6\u7d22\u5f15\u3001\u524d\u7f00\u7d22\u5f15\u3001\u7d22\u5f15\u4e0b\u63a8\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u6ee1\u8db3\u8bed\u53e5\u9700\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c \u5c3d\u91cf\u5c11\u5730\u8bbf\u95ee\u8d44\u6e90\u662f\u6570\u636e\u5e93\u8bbe\u8ba1\u7684\u91cd\u8981\u539f\u5219\u4e4b\u4e00\u3002\u6211\u4eec\u5728\u4f7f\u7528\u6570\u636e\u5e93\u7684\u65f6\u5019\uff0c\u5c24\u5176\u662f\u5728\u8bbe\u8ba1\u8868\u7ed3\u6784\u65f6\uff0c\u4e5f\u8981\u4ee5\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\u4f5c\u4e3a\u76ee\u6807\u3002</p>\n<p>\u63a5\u4e0b\u6765\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u95ee\u9898\u5427\u3002</p>\n<p>\u5b9e\u9645\u4e0a\u4e3b\u952e\u7d22\u5f15\u4e5f\u662f\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u5b57\u6bb5\u7684\u3002DBA \u5c0f\u5415\u5728\u5165\u804c\u65b0\u516c\u53f8\u7684\u65f6\u5019\uff0c\u5c31\u53d1\u73b0\u81ea\u5df1\u63a5\u624b\u7ef4\u62a4\u7684\u5e93\u91cc\u9762\uff0c\u6709\u8fd9\u4e48\u4e00\u4e2a\u8868\uff0c\u8868\u7ed3\u6784\u5b9a\u4e49\u7c7b\u4f3c\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">geek</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">ca</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">cb</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u516c\u53f8\u7684\u540c\u4e8b\u544a\u8bc9\u4ed6\u8bf4\uff0c\u7531\u4e8e\u5386\u53f2\u539f\u56e0\uff0c\u8fd9\u4e2a\u8868\u9700\u8981 a\u3001b \u505a\u8054\u5408\u4e3b\u952e\uff0c\u8fd9\u4e2a\u5c0f\u5415\u7406\u89e3\u4e86\u3002</p>\n<p>\u4f46\u662f\uff0c\u5b66\u8fc7\u672c\u7ae0\u5185\u5bb9\u7684\u5c0f\u5415\u53c8\u7eb3\u95f7\u4e86\uff0c\u65e2\u7136\u4e3b\u952e\u5305\u542b\u4e86 a\u3001b \u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u90a3\u610f\u5473\u7740\u5355\u72ec\u5728\u5b57\u6bb5 c \u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff0c\u5c31\u5df2\u7ecf\u5305\u542b\u4e86\u4e09\u4e2a\u5b57\u6bb5\u4e86\u5440\uff0c\u4e3a\u4ec0\u4e48\u8981\u521b\u5efa\u201cca\u201d\u201ccb\u201d\u8fd9\u4e24\u4e2a\u7d22\u5f15\uff1f</p>\n<p>\u540c\u4e8b\u544a\u8bc9\u4ed6\uff0c\u662f\u56e0\u4e3a\u4ed6\u4eec\u7684\u4e1a\u52a1\u91cc\u9762\u6709\u8fd9\u6837\u7684\u4e24\u79cd\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">geek</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">geek</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6211\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u8fd9\u4f4d\u540c\u4e8b\u7684\u89e3\u91ca\u5bf9\u5417\uff0c\u4e3a\u4e86\u8fd9\u4e24\u4e2a\u67e5\u8be2\u6a21\u5f0f\uff0c\u8fd9\u4e24\u4e2a\u7d22\u5f15\u662f\u5426\u90fd\u662f\u5fc5\u987b\u7684\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a\u7d22\u5f15<code>ca</code> \u53ef\u4ee5\u53bb\u6389\uff0c<code>cb</code> \u9700\u8981\u4fdd\u7559\u3002\u8fd9\u662f\u56e0\u4e3a <code>c=N order by a</code> \u6761\u4ef6\u4e2d <code>c=N</code> \u53ef\u4ee5\u8d70 \u7d22\u5f15 c\uff0c\u800c <code>order by a</code> \u5219\u53ef\u4ee5\u8d70\u4e3b\u952e\u7d22\u5f15 \uff0c\u56e0\u6b64 <code>ca</code> \u5c31\u4e0d\u9700\u8981\u3002\u4f46\u56e0\u4e3a <code>order by b</code> \u8fd9\u4e2a\u63d0\u4ea4\u4e0d\u7b26\u5408\u6700\u5de6\u539f\u5219\uff0c\u56e0\u6b64\u65e0\u6cd5\u4f7f\u7528\u4e3b\u952e\u7d22\u5f15\uff0c\u9700\u8981\u7528\u5230 <code>cb</code> \u7d22\u5f15\u3002</p>\n<h2 id=\"06\">06 \u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u6709\u8fd9\u4e48\u591a\u963b\u788d\uff1f<a class=\"headerlink\" href=\"#06\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4eca\u5929\u6211\u8981\u8ddf\u4f60\u804a\u804a MySQL \u7684\u9501\u3002\u6570\u636e\u5e93\u9501\u8bbe\u8ba1\u7684\u521d\u8877\u662f\u5904\u7406\u5e76\u53d1\u95ee\u9898\u3002\u4f5c\u4e3a\u591a\u7528\u6237\u5171\u4eab\u7684\u8d44\u6e90\uff0c\u5f53\u51fa\u73b0\u5e76\u53d1\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u6570\u636e\u5e93\u9700\u8981\u5408\u7406\u5730\u63a7\u5236\u8d44\u6e90\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u800c\u9501\u5c31\u662f\u7528\u6765\u5b9e\u73b0\u8fd9\u4e9b\u8bbf\u95ee\u89c4\u5219\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\u3002</p>\n<p><strong>\u6839\u636e\u52a0\u9501\u7684\u8303\u56f4\uff0cMySQL \u91cc\u9762\u7684\u9501\u5927\u81f4\u53ef\u4ee5\u5206\u6210\u5168\u5c40\u9501\u3001\u8868\u7ea7\u9501\u548c\u884c\u9501\u4e09\u7c7b</strong>\u3002\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4f1a\u548c\u4f60\u5206\u4eab\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\u3002\u800c\u5173\u4e8e\u884c\u9501\u7684\u5185\u5bb9\uff0c\u6211\u4f1a\u7559\u7740\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u518d\u548c\u4f60\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>\n<p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u9501\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e0d\u4f1a\u6d89\u53ca\u9501\u7684\u5177\u4f53\u5b9e\u73b0\u7ec6\u8282\uff0c\u4e3b\u8981\u4ecb\u7ecd\u7684\u662f\u78b0\u5230\u9501\u65f6\u7684\u73b0\u8c61\u548c\u5176\u80cc\u540e\u7684\u539f\u7406\u3002</p>\n<h3 id=\"_18\">\u5168\u5c40\u9501<a class=\"headerlink\" href=\"#_18\" title=\"Permanent link\">&para;</a></h3>\n<p>\u987e\u540d\u601d\u4e49\uff0c\u5168\u5c40\u9501\u5c31\u662f\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u52a0\u9501\u3002MySQL \u63d0\u4f9b\u4e86\u4e00\u4e2a\u52a0\u5168\u5c40\u8bfb\u9501\u7684\u65b9\u6cd5\uff0c\u547d\u4ee4\u662f Flush tables with read lock (FTWRL)\u3002\u5f53\u4f60\u9700\u8981\u8ba9\u6574\u4e2a\u5e93\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u4e4b\u540e\u5176\u4ed6\u7ebf\u7a0b\u7684\u4ee5\u4e0b\u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff1a\u6570\u636e\u66f4\u65b0\u8bed\u53e5\uff08\u6570\u636e\u7684\u589e\u5220\u6539\uff09\u3001\u6570\u636e\u5b9a\u4e49\u8bed\u53e5\uff08\u5305\u62ec\u5efa\u8868\u3001\u4fee\u6539\u8868\u7ed3\u6784\u7b49\uff09\u548c\u66f4\u65b0\u7c7b\u4e8b\u52a1\u7684\u63d0\u4ea4\u8bed\u53e5\u3002</p>\n<p><strong>\u5168\u5c40\u9501\u7684\u5178\u578b\u4f7f\u7528\u573a\u666f\u662f\uff0c\u505a\u5168\u5e93\u903b\u8f91\u5907\u4efd</strong>\u3002\u4e5f\u5c31\u662f\u628a\u6574\u5e93\u6bcf\u4e2a\u8868\u90fd select \u51fa\u6765\u5b58\u6210\u6587\u672c\u3002</p>\n<p>\u4ee5\u524d\u6709\u4e00\u79cd\u505a\u6cd5\uff0c\u662f\u901a\u8fc7 FTWRL \u786e\u4fdd\u4e0d\u4f1a\u6709\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u6570\u636e\u5e93\u505a\u66f4\u65b0\uff0c\u7136\u540e\u5bf9\u6574\u4e2a\u5e93\u505a\u5907\u4efd\u3002\u6ce8\u610f\uff0c\u5728\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6574\u4e2a\u5e93\u5b8c\u5168\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u3002</p>\n<p>\u4f46\u662f\u8ba9\u6574\u5e93\u90fd\u53ea\u8bfb\uff0c\u542c\u4e0a\u53bb\u5c31\u5f88\u5371\u9669\uff1a</p>\n<ul>\n<li>\u5982\u679c\u4f60\u5728\u4e3b\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5728\u5907\u4efd\u671f\u95f4\u90fd\u4e0d\u80fd\u6267\u884c\u66f4\u65b0\uff0c\u4e1a\u52a1\u57fa\u672c\u4e0a\u5c31\u5f97\u505c\u6446\uff1b</li>\n<li>\u5982\u679c\u4f60\u5728\u4ece\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5907\u4efd\u671f\u95f4\u4ece\u5e93\u4e0d\u80fd\u6267\u884c\u4e3b\u5e93\u540c\u6b65\u8fc7\u6765\u7684 binlog\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</li>\n</ul>\n<p>\u770b\u6765\u52a0\u5168\u5c40\u9501\u4e0d\u592a\u597d\u3002\u4f46\u662f\u7ec6\u60f3\u4e00\u4e0b\uff0c\u5907\u4efd\u4e3a\u4ec0\u4e48\u8981\u52a0\u9501\u5462\uff1f\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0d\u52a0\u9501\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p>\n<p>\u5047\u8bbe\u4f60\u73b0\u5728\u8981\u7ef4\u62a4\u201c\u6781\u5ba2\u65f6\u95f4\u201d\u7684\u8d2d\u4e70\u7cfb\u7edf\uff0c\u5173\u6ce8\u7684\u662f\u7528\u6237\u8d26\u6237\u4f59\u989d\u8868\u548c\u7528\u6237\u8bfe\u7a0b\u8868\u3002</p>\n<p>\u73b0\u5728\u53d1\u8d77\u4e00\u4e2a\u903b\u8f91\u5907\u4efd\u3002\u5047\u8bbe\u5907\u4efd\u671f\u95f4\uff0c\u6709\u4e00\u4e2a\u7528\u6237\uff0c\u4ed6\u8d2d\u4e70\u4e86\u4e00\u95e8\u8bfe\u7a0b\uff0c\u4e1a\u52a1\u903b\u8f91\u91cc\u5c31\u8981\u6263\u6389\u4ed6\u7684\u4f59\u989d\uff0c\u7136\u540e\u5f80\u5df2\u8d2d\u8bfe\u7a0b\u91cc\u9762\u52a0\u4e0a\u4e00\u95e8\u8bfe\u3002</p>\n<p>\u5982\u679c\u65f6\u95f4\u987a\u5e8f\u4e0a\u662f\u5148\u5907\u4efd\u8d26\u6237\u4f59\u989d\u8868 (<code>u_account</code>)\uff0c\u7136\u540e\u7528\u6237\u8d2d\u4e70\uff0c\u7136\u540e\u5907\u4efd\u7528\u6237\u8bfe\u7a0b\u8868 (<code>u_course</code>)\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u8fd9\u4e2a\u56fe\uff1a</p>\n<pre class=\"mermaid\"><code>graph TB\nbkaccount([\"\u5907\u4efdu_account\"])\nbkcourse([\"\u5907\u4efdu_course\"])\nuserbuy([\"\u7528\u6237\u8d2d\u4e70\u8bfe\u7a0b\"])\nsubgraph db1[\"database\"]\ndirection TB\nua[\"u_account: A | 200\"]\nuc[\"u_course: A | NULL\"]\nend\n\nsubgraph db2[\"database\"]\ndirection TB\nua2[\"u_account: A | 101\"]\nuc2[\"u_course: A | \u5b9e\u621845\u8bb2\"]\nend\ndb1 --&gt; bkaccount\nbkaccount --&gt; userbuy\nuserbuy --&gt; db2 \ndb2 --&gt; bkcourse\nsubgraph bkstatus[\"\u5907\u4efd\u72b6\u6001\"]\n    direction TB\n  subgraph b1[\"\u7b2c\u4e00\u6b21\u5907\u4efd\"]\n  direction TB\n  u_account[\"u_account: A | 200\"]\n  u_course[\"u_course: \u672a\u5907\u4efd\"]\n  end\n  subgraph b2[\"\u7b2c\u4e8c\u6b21\u5907\u4efd\"]\n  direction TB\n  u_account1[\"u_account: A | 200\"]\n  u_course2[\"u_course: A | \u5b9e\u621845\u8bb2\"]\n  end \nend\n\nbkaccount -.-&gt; b1\nbkcourse -.-&gt; b2</code></pre>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u5907\u4efd\u7ed3\u679c\u91cc\uff0c\u7528\u6237 A \u7684\u6570\u636e\u72b6\u6001\u662f\u201c\u8d26\u6237\u4f59\u989d\u6ca1\u6263\uff0c\u4f46\u662f\u7528\u6237\u8bfe\u7a0b\u8868\u91cc\u9762\u5df2\u7ecf\u591a\u4e86\u4e00\u95e8\u8bfe\u201d\u3002\u5982\u679c\u540e\u9762\u7528\u8fd9\u4e2a\u5907\u4efd\u6765\u6062\u590d\u6570\u636e\u7684\u8bdd\uff0c\u7528\u6237 A \u5c31\u53d1\u73b0\uff0c\u81ea\u5df1\u8d5a\u4e86\u3002</p>\n<p>\u4f5c\u4e3a\u7528\u6237\u53ef\u522b\u89c9\u5f97\u8fd9\u6837\u53ef\u771f\u597d\u554a\uff0c\u4f60\u53ef\u4ee5\u8bd5\u60f3\u4e00\u4e0b\uff1a\u5982\u679c\u5907\u4efd\u8868\u7684\u987a\u5e8f\u53cd\u8fc7\u6765\uff0c\u5148\u5907\u4efd\u7528\u6237\u8bfe\u7a0b\u8868\u518d\u5907\u4efd\u8d26\u6237\u4f59\u989d\u8868\uff0c\u53c8\u53ef\u80fd\u4f1a\u51fa\u73b0\u4ec0\u4e48\u7ed3\u679c\uff1f</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e0d\u52a0\u9501\u7684\u8bdd\uff0c\u5907\u4efd\u7cfb\u7edf\u5907\u4efd\u7684\u5f97\u5230\u7684\u5e93\u4e0d\u662f\u4e00\u4e2a\u903b\u8f91\u65f6\u95f4\u70b9\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u903b\u8f91\u4e0d\u4e00\u81f4\u7684\u3002</p>\n<p>\u8bf4\u5230\u89c6\u56fe\u4f60\u80af\u5b9a\u60f3\u8d77\u6765\u4e86\uff0c\u6211\u4eec\u5728\u524d\u9762\u8bb2\u4e8b\u52a1\u9694\u79bb\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u662f\u6709\u4e00\u4e2a\u65b9\u6cd5\u80fd\u591f\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u7684\uff0c\u5bf9\u5427\uff1f</p>\n<p>\u662f\u7684\uff0c\u5c31\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u5f00\u542f\u4e00\u4e2a\u4e8b\u52a1\u3002</p>\n<blockquote>\n<p>\u5907\u6ce8\uff1a\u5982\u679c\u4f60\u5bf9\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u6982\u5ff5\u4e0d\u662f\u5f88\u6e05\u6670\u7684\u8bdd\uff0c\u53ef\u4ee5\u518d\u56de\u987e\u4e00\u4e0b\u7b2c 3 \u7bc7\u6587\u7ae0[\u300a\u4e8b\u52a1\u9694\u79bb\uff1a\u4e3a\u4ec0\u4e48\u4f60\u6539\u4e86\u6211\u8fd8\u770b\u4e0d\u89c1\uff1f\u300b]\u4e2d\u7684\u76f8\u5173\u5185\u5bb9\u3002</p>\n</blockquote>\n<p>\u5b98\u65b9\u81ea\u5e26\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u662f mysqldump\u3002\u5f53 mysqldump \u4f7f\u7528\u53c2\u6570 <code>\u2013-single-transaction</code> \u7684\u65f6\u5019\uff0c\u5bfc\u6570\u636e\u4e4b\u524d\u5c31\u4f1a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6765\u786e\u4fdd\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u800c\u7531\u4e8e MVCC \u7684\u652f\u6301\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u6570\u636e\u662f\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u5728\u7591\u60d1\uff0c\u6709\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 FTWRL \u5462\uff1f\u4e00\u81f4\u6027\u8bfb\u662f\u597d\uff0c\u4f46\u524d\u63d0\u662f\u5f15\u64ce\u8981\u652f\u6301\u8fd9\u4e2a\u9694\u79bb\u7ea7\u522b\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e MyISAM \u8fd9\u79cd\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u5982\u679c\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6709\u66f4\u65b0\uff0c\u603b\u662f\u53ea\u80fd\u53d6\u5230\u6700\u65b0\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u7834\u574f\u4e86\u5907\u4efd\u7684\u4e00\u81f4\u6027\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 FTWRL \u547d\u4ee4\u4e86\u3002</p>\n<p>\u6240\u4ee5\uff0c<strong><code>--single-transaction</code> \u65b9\u6cd5\u53ea\u9002\u7528\u4e8e\u6240\u6709\u7684\u8868\u4f7f\u7528\u4e8b\u52a1\u5f15\u64ce\u7684\u5e93</strong>\u3002\u5982\u679c\u6709\u7684\u8868\u4f7f\u7528\u4e86\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u4e48\u5907\u4efd\u5c31\u53ea\u80fd\u901a\u8fc7 FTWRL \u65b9\u6cd5\u3002\u8fd9\u5f80\u5f80\u662f DBA \u8981\u6c42\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u4f7f\u7528 InnoDB \u66ff\u4ee3 MyISAM \u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>\n<p>\u4f60\u4e5f\u8bb8\u4f1a\u95ee\uff0c<strong>\u65e2\u7136\u8981\u5168\u5e93\u53ea\u8bfb\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 set global readonly=true \u7684\u65b9\u5f0f\u5462</strong>\uff1f\u786e\u5b9e readonly \u65b9\u5f0f\u4e5f\u53ef\u4ee5\u8ba9\u5168\u5e93\u8fdb\u5165\u53ea\u8bfb\u72b6\u6001\uff0c\u4f46\u6211\u8fd8\u662f\u4f1a\u5efa\u8bae\u4f60\u7528 FTWRL \u65b9\u5f0f\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u539f\u56e0\uff1a</p>\n<ul>\n<li>\u4e00\u662f\uff0c\u5728\u6709\u4e9b\u7cfb\u7edf\u4e2d\uff0creadonly \u7684\u503c\u4f1a\u88ab\u7528\u6765\u505a\u5176\u4ed6\u903b\u8f91\uff0c\u6bd4\u5982\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u5e93\u662f\u4e3b\u5e93\u8fd8\u662f\u5907\u5e93\u3002\u56e0\u6b64\uff0c\u4fee\u6539 global \u53d8\u91cf\u7684\u65b9\u5f0f\u5f71\u54cd\u9762\u66f4\u5927\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u4f7f\u7528\u3002</li>\n<li>\u4e8c\u662f\uff0c\u5728\u5f02\u5e38\u5904\u7406\u673a\u5236\u4e0a\u6709\u5dee\u5f02\u3002\u5982\u679c\u6267\u884c FTWRL \u547d\u4ee4\u4e4b\u540e\u7531\u4e8e\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\u65ad\u5f00\uff0c\u90a3\u4e48 MySQL \u4f1a\u81ea\u52a8\u91ca\u653e\u8fd9\u4e2a\u5168\u5c40\u9501\uff0c\u6574\u4e2a\u5e93\u56de\u5230\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u72b6\u6001\u3002\u800c\u5c06\u6574\u4e2a\u5e93\u8bbe\u7f6e\u4e3a readonly \u4e4b\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u6570\u636e\u5e93\u5c31\u4f1a\u4e00\u76f4\u4fdd\u6301 readonly \u72b6\u6001\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5e93\u957f\u65f6\u95f4\u5904\u4e8e\u4e0d\u53ef\u5199\u72b6\u6001\uff0c\u98ce\u9669\u8f83\u9ad8\u3002</li>\n</ul>\n<p>\u4e1a\u52a1\u7684\u66f4\u65b0\u4e0d\u53ea\u662f\u589e\u5220\u6539\u6570\u636e\uff08DML)\uff0c\u8fd8\u6709\u53ef\u80fd\u662f\u52a0\u5b57\u6bb5\u7b49\u4fee\u6539\u8868\u7ed3\u6784\u7684\u64cd\u4f5c\uff08DDL\uff09\u3002\u4e0d\u8bba\u662f\u54ea\u79cd\u65b9\u6cd5\uff0c\u4e00\u4e2a\u5e93\u88ab\u5168\u5c40\u9501\u4e0a\u4ee5\u540e\uff0c\u4f60\u8981\u5bf9\u91cc\u9762\u4efb\u4f55\u4e00\u4e2a\u8868\u505a\u52a0\u5b57\u6bb5\u64cd\u4f5c\uff0c\u90fd\u662f\u4f1a\u88ab\u9501\u4f4f\u7684\u3002</p>\n<p>\u4f46\u662f\uff0c\u5373\u4f7f\u6ca1\u6709\u88ab\u5168\u5c40\u9501\u4f4f\uff0c\u52a0\u5b57\u6bb5\u4e5f\u4e0d\u662f\u5c31\u80fd\u4e00\u5e06\u98ce\u987a\u7684\uff0c\u56e0\u4e3a\u4f60\u8fd8\u4f1a\u78b0\u5230\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u4ecb\u7ecd\u7684\u8868\u7ea7\u9501\u3002</p>\n<h3 id=\"_19\">\u8868\u7ea7\u9501<a class=\"headerlink\" href=\"#_19\" title=\"Permanent link\">&para;</a></h3>\n<p>MySQL \u91cc\u9762\u8868\u7ea7\u522b\u7684\u9501\u6709\u4e24\u79cd\uff1a\u4e00\u79cd\u662f\u8868\u9501\uff0c\u4e00\u79cd\u662f\u5143\u6570\u636e\u9501\uff08meta data lock\uff0cMDL)\u3002</p>\n<p>\u8868\u9501\u7684\u8bed\u6cd5\u662f <code>lock tables \u2026 read/write</code>\u3002\u4e0e FTWRL \u7c7b\u4f3c\uff0c\u53ef\u4ee5\u7528 <code>unlock tables</code> \u4e3b\u52a8\u91ca\u653e\u9501\uff0c\u4e5f\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u65ad\u5f00\u7684\u65f6\u5019\u81ea\u52a8\u91ca\u653e\u3002\u9700\u8981\u6ce8\u610f\uff0c<code>lock tables</code> \u8bed\u6cd5\u9664\u4e86\u4f1a\u9650\u5236\u522b\u7684\u7ebf\u7a0b\u7684\u8bfb\u5199\u5916\uff0c\u4e5f\u9650\u5b9a\u4e86\u672c\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u5bf9\u8c61\u3002</p>\n<p>\u4e3e\u4e2a\u4f8b\u5b50, \u5982\u679c\u5728\u67d0\u4e2a\u7ebf\u7a0b A \u4e2d\u6267\u884c <code>lock tables t1 read, t2 write;</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u5219\u5176\u4ed6\u7ebf\u7a0b\u5199 t1\u3001\u8bfb\u5199 t2 \u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u963b\u585e\u3002\u540c\u65f6\uff0c\u7ebf\u7a0b A \u5728\u6267\u884c <code>unlock tables</code> \u4e4b\u524d\uff0c\u4e5f\u53ea\u80fd\u6267\u884c\u8bfb t1\u3001\u8bfb\u5199 t2 \u7684\u64cd\u4f5c\u3002\u8fde\u5199 t1 \u90fd\u4e0d\u5141\u8bb8\uff0c\u81ea\u7136\u4e5f\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8868\u3002</p>\n<p>\u5728\u8fd8\u6ca1\u6709\u51fa\u73b0\u66f4\u7ec6\u7c92\u5ea6\u7684\u9501\u7684\u65f6\u5019\uff0c\u8868\u9501\u662f\u6700\u5e38\u7528\u7684\u5904\u7406\u5e76\u53d1\u7684\u65b9\u5f0f\u3002\u800c\u5bf9\u4e8e InnoDB \u8fd9\u79cd\u652f\u6301\u884c\u9501\u7684\u5f15\u64ce\uff0c\u4e00\u822c\u4e0d\u4f7f\u7528 lock tables \u547d\u4ee4\u6765\u63a7\u5236\u5e76\u53d1\uff0c\u6bd5\u7adf\u9501\u4f4f\u6574\u4e2a\u8868\u7684\u5f71\u54cd\u9762\u8fd8\u662f\u592a\u5927\u3002</p>\n<p>\u53e6\u4e00\u7c7b\u8868\u7ea7\u7684\u9501\u662f MDL\uff08metadata lock)\u3002MDL \u4e0d\u9700\u8981\u663e\u5f0f\u4f7f\u7528\uff0c\u5728\u8bbf\u95ee\u4e00\u4e2a\u8868\u7684\u65f6\u5019\u4f1a\u88ab\u81ea\u52a8\u52a0\u4e0a\u3002MDL \u7684\u4f5c\u7528\u662f\uff0c\u4fdd\u8bc1\u8bfb\u5199\u7684\u6b63\u786e\u6027\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u6b63\u5728\u904d\u5386\u4e00\u4e2a\u8868\u4e2d\u7684\u6570\u636e\uff0c\u800c\u6267\u884c\u671f\u95f4\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u7ed3\u6784\u505a\u53d8\u66f4\uff0c\u5220\u4e86\u4e00\u5217\uff0c\u90a3\u4e48\u67e5\u8be2\u7ebf\u7a0b\u62ff\u5230\u7684\u7ed3\u679c\u8ddf\u8868\u7ed3\u6784\u5bf9\u4e0d\u4e0a\uff0c\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5728 MySQL 5.5 \u7248\u672c\u4e2d\u5f15\u5165\u4e86 MDL\uff0c\u5f53\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u8bfb\u9501\uff1b\u5f53\u8981\u5bf9\u8868\u505a\u7ed3\u6784\u53d8\u66f4\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u5199\u9501\u3002</p>\n<ul>\n<li>\u8bfb\u9501\u4e4b\u95f4\u4e0d\u4e92\u65a5\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5bf9\u4e00\u5f20\u8868\u589e\u5220\u6539\u67e5\u3002</li>\n<li>\u8bfb\u5199\u9501\u4e4b\u95f4\u3001\u5199\u9501\u4e4b\u95f4\u662f\u4e92\u65a5\u7684\uff0c\u7528\u6765\u4fdd\u8bc1\u53d8\u66f4\u8868\u7ed3\u6784\u64cd\u4f5c\u7684\u5b89\u5168\u6027\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6709\u4e24\u4e2a\u7ebf\u7a0b\u8981\u540c\u65f6\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u5176\u4e2d\u4e00\u4e2a\u8981\u7b49\u53e6\u4e00\u4e2a\u6267\u884c\u5b8c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002</li>\n</ul>\n<p>\u867d\u7136 MDL \u9501\u662f\u7cfb\u7edf\u9ed8\u8ba4\u4f1a\u52a0\u7684\uff0c\u4f46\u5374\u662f\u4f60\u4e0d\u80fd\u5ffd\u7565\u7684\u4e00\u4e2a\u673a\u5236\uff0c\u4e8b\u52a1\u4e2d\u7684 MDL \u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5f00\u59cb\u65f6\u7533\u8bf7\uff0c\u4f46\u662f\u8bed\u53e5\u7ed3\u675f\u540e\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u91ca\u653e\uff0c\u800c\u4f1a\u7b49\u5230\u6574\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\u518d\u91ca\u653e\u3002</p>\n<h3 id=\"_20\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_20\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\u3002</p>\n<p>\u5168\u5c40\u9501\u4e3b\u8981\u7528\u5728\u903b\u8f91\u5907\u4efd\u8fc7\u7a0b\u4e2d\u3002\u5bf9\u4e8e\u5168\u90e8\u662f InnoDB \u5f15\u64ce\u7684\u5e93\uff0c\u6211\u5efa\u8bae\u4f60\u9009\u62e9\u4f7f\u7528<code>-\u2013single-transaction</code> \u53c2\u6570\uff0c\u5bf9\u5e94\u7528\u4f1a\u66f4\u53cb\u597d\u3002</p>\n<p>\u8868\u9501\u4e00\u822c\u662f\u5728\u6570\u636e\u5e93\u5f15\u64ce\u4e0d\u652f\u6301\u884c\u9501\u7684\u65f6\u5019\u624d\u4f1a\u88ab\u7528\u5230\u7684\u3002\u5982\u679c\u4f60\u53d1\u73b0\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u91cc\u6709 lock tables \u8fd9\u6837\u7684\u8bed\u53e5\uff0c\u4f60\u9700\u8981\u8ffd\u67e5\u4e00\u4e0b\uff0c\u6bd4\u8f83\u53ef\u80fd\u7684\u60c5\u51b5\u662f\uff1a</p>\n<ul>\n<li>\u8981\u4e48\u662f\u4f60\u7684\u7cfb\u7edf\u73b0\u5728\u8fd8\u5728\u7528 MyISAM \u8fd9\u7c7b\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u8981\u5b89\u6392\u5347\u7ea7\u6362\u5f15\u64ce\uff1b</li>\n<li>\u8981\u4e48\u662f\u4f60\u7684\u5f15\u64ce\u5347\u7ea7\u4e86\uff0c\u4f46\u662f\u4ee3\u7801\u8fd8\u6ca1\u5347\u7ea7\u3002\u6211\u89c1\u8fc7\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u6700\u540e\u4e1a\u52a1\u5f00\u53d1\u5c31\u662f\u628a lock tables \u548c unlock tables \u6539\u6210 begin \u548c commit\uff0c\u95ee\u9898\u5c31\u89e3\u51b3\u4e86\u3002</li>\n</ul>\n<p>MDL \u4f1a\u76f4\u5230\u4e8b\u52a1\u63d0\u4ea4\u624d\u91ca\u653e\uff0c\u5728\u505a\u8868\u7ed3\u6784\u53d8\u66f4\u7684\u65f6\u5019\uff0c\u4f60\u4e00\u5b9a\u8981\u5c0f\u5fc3\u4e0d\u8981\u5bfc\u81f4\u9501\u4f4f\u7ebf\u4e0a\u67e5\u8be2\u548c\u66f4\u65b0\u3002</p>\n<h2 id=\"07\">07 \u884c\u9501\u529f\u8fc7\uff1a\u600e\u4e48\u51cf\u5c11\u884c\u9501\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\uff1f<a class=\"headerlink\" href=\"#07\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\uff0c\u4eca\u5929\u6211\u4eec\u5c31\u6765\u8bb2\u8bb2 MySQL \u7684\u884c\u9501\u3002</p>\n<p>MySQL \u7684\u884c\u9501\u662f\u5728\u5f15\u64ce\u5c42\u7531\u5404\u4e2a\u5f15\u64ce\u81ea\u5df1\u5b9e\u73b0\u7684\u3002\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u884c\u9501\uff0c\u6bd4\u5982 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u884c\u9501\u3002\u4e0d\u652f\u6301\u884c\u9501\u610f\u5473\u7740\u5e76\u53d1\u63a7\u5236\u53ea\u80fd\u4f7f\u7528\u8868\u9501\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u5f15\u64ce\u7684\u8868\uff0c\u540c\u4e00\u5f20\u8868\u4e0a\u4efb\u4f55\u65f6\u523b\u53ea\u80fd\u6709\u4e00\u4e2a\u66f4\u65b0\u5728\u6267\u884c\uff0c\u8fd9\u5c31\u4f1a\u5f71\u54cd\u5230\u4e1a\u52a1\u5e76\u53d1\u5ea6\u3002InnoDB \u662f\u652f\u6301\u884c\u9501\u7684\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u66ff\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p>\n<p>\u6211\u4eec\u4eca\u5929\u5c31\u4e3b\u8981\u6765\u804a\u804a InnoDB \u7684\u884c\u9501\uff0c\u4ee5\u53ca\u5982\u4f55\u901a\u8fc7\u51cf\u5c11\u9501\u51b2\u7a81\u6765\u63d0\u5347\u4e1a\u52a1\u5e76\u53d1\u5ea6\u3002</p>\n<p>\u987e\u540d\u601d\u4e49\uff0c\u884c\u9501\u5c31\u662f\u9488\u5bf9\u6570\u636e\u8868\u4e2d\u884c\u8bb0\u5f55\u7684\u9501\u3002\u8fd9\u5f88\u597d\u7406\u89e3\uff0c\u6bd4\u5982\u4e8b\u52a1 A \u66f4\u65b0\u4e86\u4e00\u884c\uff0c\u800c\u8fd9\u65f6\u5019\u4e8b\u52a1 B \u4e5f\u8981\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u5219\u5fc5\u987b\u7b49\u4e8b\u52a1 A \u7684\u64cd\u4f5c\u5b8c\u6210\u540e\u624d\u80fd\u8fdb\u884c\u66f4\u65b0\u3002</p>\n<p>\u5f53\u7136\uff0c\u6570\u636e\u5e93\u4e2d\u8fd8\u6709\u4e00\u4e9b\u6ca1\u90a3\u4e48\u4e00\u76ee\u4e86\u7136\u7684\u6982\u5ff5\u548c\u8bbe\u8ba1\uff0c\u8fd9\u4e9b\u6982\u5ff5\u5982\u679c\u7406\u89e3\u548c\u4f7f\u7528\u4e0d\u5f53\uff0c\u5bb9\u6613\u5bfc\u81f4\u7a0b\u5e8f\u51fa\u73b0\u975e\u9884\u671f\u884c\u4e3a\uff0c\u6bd4\u5982\u4e24\u9636\u6bb5\u9501\u3002</p>\n<h3 id=\"_21\">\u4ece\u4e24\u9636\u6bb5\u9501\u8bf4\u8d77<a class=\"headerlink\" href=\"#_21\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u5148\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\u3002\u5728\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\u4e2d\uff0c\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u6267\u884c\u65f6\u4f1a\u662f\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f\u5047\u8bbe\u5b57\u6bb5 id \u662f\u8868 t \u7684\u4e3b\u952e\u3002</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\n    participant T1\n    participant A\n    participant T2\n\n    T1-&gt;&gt;A: begin\n    T1-&gt;&gt;A: update t set k=k+1 where id=1\n    T2-&gt;&gt;A: update t set k=k+1 where id=2\n    T2-&gt;&gt;A: begin\n    T2-&gt;&gt;A: update t set k=k+2 where id=1\n    T2--&gt;&gt;A: waiting lock\n    T1-&gt;&gt;A: commit\n    T2-&gt;&gt;A: execute\n</code></pre>\n<p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7ed3\u8bba\u53d6\u51b3\u4e8e\u4e8b\u52a1 A \u5728\u6267\u884c\u5b8c\u4e24\u6761 update \u8bed\u53e5\u540e\uff0c\u6301\u6709\u54ea\u4e9b\u9501\uff0c\u4ee5\u53ca\u5728\u4ec0\u4e48\u65f6\u5019\u91ca\u653e\u3002\u4f60\u53ef\u4ee5\u9a8c\u8bc1\u4e00\u4e0b\uff1a\u5b9e\u9645\u4e0a\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u4e8b\u52a1 A \u6267\u884c commit \u4e4b\u540e\uff0c\u4e8b\u52a1 B \u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</p>\n<p>\u77e5\u9053\u4e86\u8fd9\u4e2a\u7b54\u6848\uff0c\u4f60\u4e00\u5b9a\u77e5\u9053\u4e86\u4e8b\u52a1 A \u6301\u6709\u7684\u4e24\u4e2a\u8bb0\u5f55\u7684\u884c\u9501\uff0c\u90fd\u662f\u5728 commit \u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<strong>\u5728 InnoDB \u4e8b\u52a1\u4e2d\uff0c\u884c\u9501\u662f\u5728\u9700\u8981\u7684\u65f6\u5019\u624d\u52a0\u4e0a\u7684\uff0c\u4f46\u5e76\u4e0d\u662f\u4e0d\u9700\u8981\u4e86\u5c31\u7acb\u523b\u91ca\u653e\uff0c\u800c\u662f\u8981\u7b49\u5230\u4e8b\u52a1\u7ed3\u675f\u65f6\u624d\u91ca\u653e\u3002\u8fd9\u4e2a\u5c31\u662f\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u3002</strong></p>\n<p>\u77e5\u9053\u4e86\u8fd9\u4e2a\u8bbe\u5b9a\uff0c\u5bf9\u6211\u4eec\u4f7f\u7528\u4e8b\u52a1\u6709\u4ec0\u4e48\u5e2e\u52a9\u5462\uff1f\u90a3\u5c31\u662f\uff0c\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u5c3d\u91cf\u5f80\u540e\u653e\u3002\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\u3002</p>\n<p>\u5047\u8bbe\u4f60\u8d1f\u8d23\u5b9e\u73b0\u4e00\u4e2a\u7535\u5f71\u7968\u5728\u7ebf\u4ea4\u6613\u4e1a\u52a1\uff0c\u987e\u5ba2 A \u8981\u5728\u5f71\u9662 B \u8d2d\u4e70\u7535\u5f71\u7968\u3002\u6211\u4eec\u7b80\u5316\u4e00\u70b9\uff0c\u8fd9\u4e2a\u4e1a\u52a1\u9700\u8981\u6d89\u53ca\u5230\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>\u4ece\u987e\u5ba2 A \u8d26\u6237\u4f59\u989d\u4e2d\u6263\u9664\u7535\u5f71\u7968\u4ef7\uff1b</li>\n<li>\u7ed9\u5f71\u9662 B \u7684\u8d26\u6237\u4f59\u989d\u589e\u52a0\u8fd9\u5f20\u7535\u5f71\u7968\u4ef7\uff1b</li>\n<li>\u8bb0\u5f55\u4e00\u6761\u4ea4\u6613\u65e5\u5fd7\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u5b8c\u6210\u8fd9\u4e2a\u4ea4\u6613\uff0c\u6211\u4eec\u9700\u8981 update \u4e24\u6761\u8bb0\u5f55\uff0c\u5e76 insert \u4e00\u6761\u8bb0\u5f55\u3002\u5f53\u7136\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u4ea4\u6613\u7684\u539f\u5b50\u6027\uff0c\u6211\u4eec\u8981\u628a\u8fd9\u4e09\u4e2a\u64cd\u4f5c\u653e\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u3002\u90a3\u4e48\uff0c\u4f60\u4f1a\u600e\u6837\u5b89\u6392\u8fd9\u4e09\u4e2a\u8bed\u53e5\u5728\u4e8b\u52a1\u4e2d\u7684\u987a\u5e8f\u5462\uff1f</p>\n<p>\u8bd5\u60f3\u5982\u679c\u540c\u65f6\u6709\u53e6\u5916\u4e00\u4e2a\u987e\u5ba2 C \u8981\u5728\u5f71\u9662 B \u4e70\u7968\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u51b2\u7a81\u7684\u90e8\u5206\u5c31\u662f\u8bed\u53e5 2 \u4e86\u3002\u56e0\u4e3a\u5b83\u4eec\u8981\u66f4\u65b0\u540c\u4e00\u4e2a\u5f71\u9662\u8d26\u6237\u7684\u4f59\u989d\uff0c\u9700\u8981\u4fee\u6539\u540c\u4e00\u884c\u6570\u636e\u3002</p>\n<p>\u6839\u636e\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u4e0d\u8bba\u4f60\u600e\u6837\u5b89\u6392\u8bed\u53e5\u987a\u5e8f\uff0c\u6240\u6709\u7684\u64cd\u4f5c\u9700\u8981\u7684\u884c\u9501\u90fd\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u628a\u8bed\u53e5 2 \u5b89\u6392\u5728\u6700\u540e\uff0c\u6bd4\u5982\u6309\u7167 3\u30011\u30012 \u8fd9\u6837\u7684\u987a\u5e8f\uff0c\u90a3\u4e48\u5f71\u9662\u8d26\u6237\u4f59\u989d\u8fd9\u4e00\u884c\u7684\u9501\u65f6\u95f4\u5c31\u6700\u5c11\u3002\u8fd9\u5c31\u6700\u5927\u7a0b\u5ea6\u5730\u51cf\u5c11\u4e86\u4e8b\u52a1\u4e4b\u95f4\u7684\u9501\u7b49\u5f85\uff0c\u63d0\u5347\u4e86\u5e76\u53d1\u5ea6\u3002</p>\n<p>\u597d\u4e86\uff0c\u73b0\u5728\u7531\u4e8e\u4f60\u7684\u6b63\u786e\u8bbe\u8ba1\uff0c\u5f71\u9662\u4f59\u989d\u8fd9\u4e00\u884c\u7684\u884c\u9501\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u4e0d\u4f1a\u505c\u7559\u5f88\u957f\u65f6\u95f4\u3002\u4f46\u662f\uff0c\u8fd9\u5e76\u6ca1\u6709\u5b8c\u5168\u89e3\u51b3\u4f60\u7684\u56f0\u6270\u3002</p>\n<p>\u5982\u679c\u8fd9\u4e2a\u5f71\u9662\u505a\u6d3b\u52a8\uff0c\u53ef\u4ee5\u4f4e\u4ef7\u9884\u552e\u4e00\u5e74\u5185\u6240\u6709\u7684\u7535\u5f71\u7968\uff0c\u800c\u4e14\u8fd9\u4e2a\u6d3b\u52a8\u53ea\u505a\u4e00\u5929\u3002\u4e8e\u662f\u5728\u6d3b\u52a8\u65f6\u95f4\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u4f60\u7684 MySQL \u5c31\u6302\u4e86\u3002\u4f60\u767b\u4e0a\u670d\u52a1\u5668\u4e00\u770b\uff0cCPU \u6d88\u8017\u63a5\u8fd1 100%\uff0c\u4f46\u6574\u4e2a\u6570\u636e\u5e93\u6bcf\u79d2\u5c31\u6267\u884c\u4e0d\u5230 100 \u4e2a\u4e8b\u52a1\u3002\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u5c31\u8981\u8bf4\u5230\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u4e86\u3002</p>\n<h3 id=\"_22\">\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b<a class=\"headerlink\" href=\"#_22\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f53\u5e76\u53d1\u7cfb\u7edf\u4e2d\u4e0d\u540c\u7ebf\u7a0b\u51fa\u73b0\u5faa\u73af\u8d44\u6e90\u4f9d\u8d56\uff0c\u6d89\u53ca\u7684\u7ebf\u7a0b\u90fd\u5728\u7b49\u5f85\u522b\u7684\u7ebf\u7a0b\u91ca\u653e\u8d44\u6e90\u65f6\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8fd9\u51e0\u4e2a\u7ebf\u7a0b\u90fd\u8fdb\u5165\u65e0\u9650\u7b49\u5f85\u7684\u72b6\u6001\uff0c\u79f0\u4e3a\u6b7b\u9501\u3002\u8fd9\u91cc\u6211\u7528\u6570\u636e\u5e93\u4e2d\u7684\u884c\u9501\u4e3e\u4e2a\u4f8b\u5b50\u3002</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\n    participant T1\n    participant A\n    participant T2\n\n    T1-&gt;&gt;A: begin\n    T2-&gt;&gt;A: begin\n    T1-&gt;&gt;A: update t set k=k+1 where id=1\n    T2-&gt;&gt;A: update t set k=k+1 where id=2\n    T1-&gt;&gt;A: update t set k=k+1 where id=2\n    Note over T1,T2: Deadlock!</code></pre>\n<p>\u8fd9\u65f6\u5019\uff0c\u4e8b\u52a1 T1 \u5728\u7b49\u5f85\u4e8b\u52a1 T2 \u91ca\u653e id=2 \u7684\u884c\u9501\uff0c\u800c\u4e8b\u52a1 T2 \u5728\u7b49\u5f85\u4e8b\u52a1 T1 \u91ca\u653e id=1 \u7684\u884c\u9501\u3002 \u4e8b\u52a1 T1 \u548c\u4e8b\u52a1 T2 \u5728\u4e92\u76f8\u7b49\u5f85\u5bf9\u65b9\u7684\u8d44\u6e90\u91ca\u653e\uff0c\u5c31\u662f\u8fdb\u5165\u4e86\u6b7b\u9501\u72b6\u6001\u3002\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u6709\u4e24\u79cd\u7b56\u7565\uff1a</p>\n<ul>\n<li>\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u76f4\u63a5\u8fdb\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u8d85\u65f6\u3002\u8fd9\u4e2a\u8d85\u65f6\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570 <code>innodb_lock_wait_timeout</code>\u6765\u8bbe\u7f6e\u3002</li>\n<li>\u53e6\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u53d1\u8d77\u6b7b\u9501\u68c0\u6d4b\uff0c\u53d1\u73b0\u6b7b\u9501\u540e\uff0c\u4e3b\u52a8\u56de\u6eda\u6b7b\u9501\u94fe\u6761\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8ba9\u5176\u4ed6\u4e8b\u52a1\u5f97\u4ee5\u7ee7\u7eed\u6267\u884c\u3002\u5c06\u53c2\u6570 <code>innodb_deadlock_detect</code> \u8bbe\u7f6e\u4e3a on\uff0c\u8868\u793a\u5f00\u542f\u8fd9\u4e2a\u903b\u8f91\u3002</li>\n</ul>\n<p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_lock_wait_timeout</code> \u7684\u9ed8\u8ba4\u503c\u662f 50s\uff0c\u610f\u5473\u7740\u5982\u679c\u91c7\u7528\u7b2c\u4e00\u4e2a\u7b56\u7565\uff0c\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u7b2c\u4e00\u4e2a\u88ab\u9501\u4f4f\u7684\u7ebf\u7a0b\u8981\u8fc7 50s \u624d\u4f1a\u8d85\u65f6\u9000\u51fa\uff0c\u7136\u540e\u5176\u4ed6\u7ebf\u7a0b\u624d\u6709\u53ef\u80fd\u7ee7\u7eed\u6267\u884c\u3002\u5bf9\u4e8e\u5728\u7ebf\u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a\u7b49\u5f85\u65f6\u95f4\u5f80\u5f80\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002</p>\n<p>\u4f46\u662f\uff0c\u6211\u4eec\u53c8\u4e0d\u53ef\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u65f6\u95f4\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5f88\u5c0f\u7684\u503c\uff0c\u6bd4\u5982 1s\u3002\u8fd9\u6837\u5f53\u51fa\u73b0\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u786e\u5b9e\u5f88\u5feb\u5c31\u53ef\u4ee5\u89e3\u5f00\uff0c\u4f46\u5982\u679c\u4e0d\u662f\u6b7b\u9501\uff0c\u800c\u662f\u7b80\u5355\u7684\u9501\u7b49\u5f85\u5462\uff1f\u6240\u4ee5\uff0c\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u592a\u77ed\u7684\u8bdd\uff0c\u4f1a\u51fa\u73b0\u5f88\u591a\u8bef\u4f24\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u8fd8\u662f\u8981\u91c7\u7528\u7b2c\u4e8c\u79cd\u7b56\u7565\uff0c\u5373\uff1a\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\uff0c\u800c\u4e14 <code>innodb_deadlock_detect</code> \u7684\u9ed8\u8ba4\u503c\u672c\u8eab\u5c31\u662f on\u3002\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u662f\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u5e76\u8fdb\u884c\u5904\u7406\u7684\uff0c\u4f46\u662f\u5b83\u4e5f\u662f\u6709\u989d\u5916\u8d1f\u62c5\u7684\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\uff1a\u6bcf\u5f53\u4e00\u4e2a\u4e8b\u52a1\u88ab\u9501\u7684\u65f6\u5019\uff0c\u5c31\u8981\u770b\u770b\u5b83\u6240\u4f9d\u8d56\u7684\u7ebf\u7a0b\u6709\u6ca1\u6709\u88ab\u522b\u4eba\u9501\u4f4f\uff0c\u5982\u6b64\u5faa\u73af\uff0c\u6700\u540e\u5224\u65ad\u662f\u5426\u51fa\u73b0\u4e86\u5faa\u73af\u7b49\u5f85\uff0c\u4e5f\u5c31\u662f\u6b7b\u9501\u3002</p>\n<p>\u90a3\u5982\u679c\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u6240\u6709\u4e8b\u52a1\u90fd\u8981\u66f4\u65b0\u540c\u4e00\u884c\u7684\u573a\u666f\u5462\uff1f</p>\n<p>\u6bcf\u4e2a\u65b0\u6765\u7684\u88ab\u5835\u4f4f\u7684\u7ebf\u7a0b\uff0c\u90fd\u8981\u5224\u65ad\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u81ea\u5df1\u7684\u52a0\u5165\u5bfc\u81f4\u4e86\u6b7b\u9501\uff0c\u8fd9\u662f\u4e00\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662f <span class=\"arithmatex\">\\(O(n^2)\\)</span> \u7684\u64cd\u4f5c\u3002\u5047\u8bbe\u6709 1000 \u4e2a\u5e76\u53d1\u7ebf\u7a0b\u8981\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u64cd\u4f5c\u5c31\u662f 100 \u4e07\u8fd9\u4e2a\u91cf\u7ea7\u7684\u3002\u867d\u7136\u6700\u7ec8\u68c0\u6d4b\u7684\u7ed3\u679c\u662f\u6ca1\u6709\u6b7b\u9501\uff0c\u4f46\u662f\u8fd9\u671f\u95f4\u8981\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002\u56e0\u6b64\uff0c\u4f60\u5c31\u4f1a\u770b\u5230 CPU \u5229\u7528\u7387\u5f88\u9ad8\uff0c\u4f46\u662f\u6bcf\u79d2\u5374\u6267\u884c\u4e0d\u4e86\u51e0\u4e2a\u4e8b\u52a1\u3002</p>\n<p>\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e0b\uff0c\u600e\u4e48\u89e3\u51b3\u7531\u8fd9\u79cd\u70ed\u70b9\u884c\u66f4\u65b0\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u5462\uff1f\u95ee\u9898\u7684\u75c7\u7ed3\u5728\u4e8e\uff0c\u6b7b\u9501\u68c0\u6d4b\u8981\u8017\u8d39\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002</p>\n<p>\u4e00\u79cd\u5934\u75db\u533b\u5934\u7684\u65b9\u6cd5\uff0c\u5c31\u662f\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u8fd9\u4e2a\u4e1a\u52a1\u4e00\u5b9a\u4e0d\u4f1a\u51fa\u73b0\u6b7b\u9501\uff0c\u53ef\u4ee5\u4e34\u65f6\u628a\u6b7b\u9501\u68c0\u6d4b\u5173\u6389\u3002\u4f46\u662f\u8fd9\u79cd\u64cd\u4f5c\u672c\u8eab\u5e26\u6709\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u4e1a\u52a1\u8bbe\u8ba1\u7684\u65f6\u5019\u4e00\u822c\u4e0d\u4f1a\u628a\u6b7b\u9501\u5f53\u505a\u4e00\u4e2a\u4e25\u91cd\u9519\u8bef\uff0c\u6bd5\u7adf\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u56de\u6eda\uff0c\u7136\u540e\u901a\u8fc7\u4e1a\u52a1\u91cd\u8bd5\u4e00\u822c\u5c31\u6ca1\u95ee\u9898\u4e86\uff0c\u8fd9\u662f\u4e1a\u52a1\u65e0\u635f\u7684\u3002\u800c\u5173\u6389\u6b7b\u9501\u68c0\u6d4b\u610f\u5473\u7740\u53ef\u80fd\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u8d85\u65f6\uff0c\u8fd9\u662f\u4e1a\u52a1\u6709\u635f\u7684\u3002</p>\n<p>\u53e6\u4e00\u4e2a\u601d\u8def\u662f\u63a7\u5236\u5e76\u53d1\u5ea6\u3002\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u4f1a\u53d1\u73b0\u5982\u679c\u5e76\u53d1\u80fd\u591f\u63a7\u5236\u4f4f\uff0c\u6bd4\u5982\u540c\u4e00\u884c\u540c\u65f6\u6700\u591a\u53ea\u6709 10 \u4e2a\u7ebf\u7a0b\u5728\u66f4\u65b0\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u3002\u4e00\u4e2a\u76f4\u63a5\u7684\u60f3\u6cd5\u5c31\u662f\uff0c\u5728\u5ba2\u6237\u7aef\u505a\u5e76\u53d1\u63a7\u5236\u3002\u4f46\u662f\uff0c\u4f60\u4f1a\u5f88\u5feb\u53d1\u73b0\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u592a\u53ef\u884c\uff0c\u56e0\u4e3a\u5ba2\u6237\u7aef\u5f88\u591a\u3002\u6211\u89c1\u8fc7\u4e00\u4e2a\u5e94\u7528\uff0c\u6709 600 \u4e2a\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u5373\u4f7f\u6bcf\u4e2a\u5ba2\u6237\u7aef\u63a7\u5236\u5230\u53ea\u6709 5 \u4e2a\u5e76\u53d1\u7ebf\u7a0b\uff0c\u6c47\u603b\u5230\u6570\u636e\u5e93\u670d\u52a1\u7aef\u4ee5\u540e\uff0c\u5cf0\u503c\u5e76\u53d1\u6570\u4e5f\u53ef\u80fd\u8981\u8fbe\u5230 3000\u3002</p>\n<p>\u56e0\u6b64\uff0c\u8fd9\u4e2a\u5e76\u53d1\u63a7\u5236\u8981\u505a\u5728\u6570\u636e\u5e93\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6709\u4e2d\u95f4\u4ef6\uff0c\u53ef\u4ee5\u8003\u8651\u5728\u4e2d\u95f4\u4ef6\u5b9e\u73b0\uff1b\u5982\u679c\u4f60\u7684\u56e2\u961f\u6709\u80fd\u4fee\u6539 MySQL \u6e90\u7801\u7684\u4eba\uff0c\u4e5f\u53ef\u4ee5\u505a\u5728 MySQL \u91cc\u9762\u3002\u57fa\u672c\u601d\u8def\u5c31\u662f\uff0c\u5bf9\u4e8e\u76f8\u540c\u884c\u7684\u66f4\u65b0\uff0c\u5728\u8fdb\u5165\u5f15\u64ce\u4e4b\u524d\u6392\u961f\u3002\u8fd9\u6837\u5728 InnoDB \u5185\u90e8\u5c31\u4e0d\u4f1a\u6709\u5927\u91cf\u7684\u6b7b\u9501\u68c0\u6d4b\u5de5\u4f5c\u4e86\u3002</p>\n<p>\u53ef\u80fd\u4f60\u4f1a\u95ee\uff0c<strong>\u5982\u679c\u56e2\u961f\u91cc\u6682\u65f6\u6ca1\u6709\u6570\u636e\u5e93\u65b9\u9762\u7684\u4e13\u5bb6\uff0c\u4e0d\u80fd\u5b9e\u73b0\u8fd9\u6837\u7684\u65b9\u6848\uff0c\u80fd\u4e0d\u80fd\u4ece\u8bbe\u8ba1\u4e0a\u4f18\u5316\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f</strong></p>\n<p>\u4f60\u53ef\u4ee5\u8003\u8651\u901a\u8fc7\u5c06\u4e00\u884c\u6539\u6210\u903b\u8f91\u4e0a\u7684\u591a\u884c\u6765\u51cf\u5c11\u9501\u51b2\u7a81\u3002\u8fd8\u662f\u4ee5\u5f71\u9662\u8d26\u6237\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u8003\u8651\u653e\u5728\u591a\u6761\u8bb0\u5f55\u4e0a\uff0c\u6bd4\u5982 10 \u4e2a\u8bb0\u5f55\uff0c\u5f71\u9662\u7684\u8d26\u6237\u603b\u989d\u7b49\u4e8e\u8fd9 10 \u4e2a\u8bb0\u5f55\u7684\u503c\u7684\u603b\u548c\u3002\u8fd9\u6837\u6bcf\u6b21\u8981\u7ed9\u5f71\u9662\u8d26\u6237\u52a0\u91d1\u989d\u7684\u65f6\u5019\uff0c\u968f\u673a\u9009\u5176\u4e2d\u4e00\u6761\u8bb0\u5f55\u6765\u52a0\u3002\u8fd9\u6837\u6bcf\u6b21\u51b2\u7a81\u6982\u7387\u53d8\u6210\u539f\u6765\u7684 1/10\uff0c\u53ef\u4ee5\u51cf\u5c11\u9501\u7b49\u5f85\u4e2a\u6570\uff0c\u4e5f\u5c31\u51cf\u5c11\u4e86\u6b7b\u9501\u68c0\u6d4b\u7684 CPU \u6d88\u8017\u3002</p>\n<p>\u8fd9\u4e2a\u65b9\u6848\u770b\u4e0a\u53bb\u662f\u65e0\u635f\u7684\uff0c\u4f46\u5176\u5b9e\u8fd9\u7c7b\u65b9\u6848\u9700\u8981\u6839\u636e\u4e1a\u52a1\u903b\u8f91\u505a\u8be6\u7ec6\u8bbe\u8ba1\u3002\u5982\u679c\u8d26\u6237\u4f59\u989d\u53ef\u80fd\u4f1a\u51cf\u5c11\uff0c\u6bd4\u5982\u9000\u7968\u903b\u8f91\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u8003\u8651\u5f53\u4e00\u90e8\u5206\u884c\u8bb0\u5f55\u53d8\u6210 0 \u7684\u65f6\u5019\uff0c\u4ee3\u7801\u8981\u6709\u7279\u6b8a\u5904\u7406\u3002</p>\n<h3 id=\"_23\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_23\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u884c\u9501\uff0c\u6d89\u53ca\u4e86\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u3001\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u8fd9\u4e24\u5927\u90e8\u5206\u5185\u5bb9\u3002</p>\n<p>\u5176\u4e2d\uff0c\u6211\u4ee5\u4e24\u9636\u6bb5\u534f\u8bae\u4e3a\u8d77\u70b9\uff0c\u548c\u4f60\u4e00\u8d77\u8ba8\u8bba\u4e86\u5728\u5f00\u53d1\u7684\u65f6\u5019\u5982\u4f55\u5b89\u6392\u6b63\u786e\u7684\u4e8b\u52a1\u8bed\u53e5\u3002\u8fd9\u91cc\u7684\u539f\u5219 / \u6211\u7ed9\u4f60\u7684\u5efa\u8bae\u662f\uff1a\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u7684\u7533\u8bf7\u65f6\u673a\u5c3d\u91cf\u5f80\u540e\u653e\u3002</p>\n<p>\u4f46\u662f\uff0c\u8c03\u6574\u8bed\u53e5\u987a\u5e8f\u5e76\u4e0d\u80fd\u5b8c\u5168\u907f\u514d\u6b7b\u9501\u3002\u6240\u4ee5\u6211\u4eec\u5f15\u5165\u4e86\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u7684\u6982\u5ff5\uff0c\u4ee5\u53ca\u63d0\u4f9b\u4e86\u4e09\u4e2a\u65b9\u6848\uff0c\u6765\u51cf\u5c11\u6b7b\u9501\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u3002\u51cf\u5c11\u6b7b\u9501\u7684\u4e3b\u8981\u65b9\u5411\uff0c\u5c31\u662f\u63a7\u5236\u8bbf\u95ee\u76f8\u540c\u8d44\u6e90\u7684\u5e76\u53d1\u4e8b\u52a1\u91cf\u3002</p>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u95ee\u9898\u5427\u3002\u5982\u679c\u4f60\u8981\u5220\u9664\u4e00\u4e2a\u8868\u91cc\u9762\u7684\u524d 10000 \u884c\u6570\u636e\uff0c\u6709\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\u53ef\u4ee5\u505a\u5230\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u79cd\uff0c\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000</code></li>\n<li>\u7b2c\u4e8c\u79cd\uff0c\u5728\u4e00\u4e2a\u8fde\u63a5\u4e2d\u5faa\u73af\u6267\u884c 20 \u6b21 <code>delete from T limit 500</code></li>\n<li>\u7b2c\u4e09\u79cd\uff0c\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c <code>delete from T limit 500</code></li>\n</ul>\n<p>\u4f60\u4f1a\u9009\u62e9\u54ea\u4e00\u79cd\u65b9\u6cd5\u5462\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\u76f8\u5bf9\u8f83\u597d\u7684\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000</code>\uff09\u91cc\u9762\uff0c\u5355\u4e2a\u8bed\u53e5\u5360\u7528\u65f6\u95f4\u957f\uff0c\u9501\u7684\u65f6\u95f4\u4e5f\u6bd4\u8f83\u957f\uff1b\u800c\u4e14\u5927\u4e8b\u52a1\u8fd8\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</p>\n<p>\u7b2c\u4e09\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c <code>delete from T limit 500</code>\uff09\uff0c\u4f1a\u4eba\u4e3a\u9020\u6210\u9501\u51b2\u7a81\u3002</p>\n<h2 id=\"08\">08 \u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f<a class=\"headerlink\" href=\"#08\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u5728\u7b2c 3 \u7bc7\u6587\u7ae0\u548c\u4f60\u8bb2\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u65f6\u5019\u63d0\u5230\u8fc7\uff0c\u5982\u679c\u662f\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\uff0c\u4e8b\u52a1 T \u542f\u52a8\u7684\u65f6\u5019\u4f1a\u521b\u5efa\u4e00\u4e2a\u89c6\u56fe read-view\uff0c\u4e4b\u540e\u4e8b\u52a1 T \u6267\u884c\u671f\u95f4\uff0c\u5373\u4f7f\u6709\u5176\u4ed6\u4e8b\u52a1\u4fee\u6539\u4e86\u6570\u636e\uff0c\u4e8b\u52a1 T \u770b\u5230\u7684\u4ecd\u7136\u8ddf\u5728\u542f\u52a8\u65f6\u770b\u5230\u7684\u4e00\u6837\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u597d\u50cf\u4e0e\u4e16\u65e0\u4e89\uff0c\u4e0d\u53d7\u5916\u754c\u5f71\u54cd\u3002</p>\n<p>\u4f46\u662f\uff0c\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u548c\u4f60\u5206\u4eab\u884c\u9501\u7684\u65f6\u5019\u53c8\u63d0\u5230\uff0c\u4e00\u4e2a\u4e8b\u52a1\u8981\u66f4\u65b0\u4e00\u884c\uff0c\u5982\u679c\u521a\u597d\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u62e5\u6709\u8fd9\u4e00\u884c\u7684\u884c\u9501\uff0c\u5b83\u53c8\u4e0d\u80fd\u8fd9\u4e48\u8d85\u7136\u4e86\uff0c\u4f1a\u88ab\u9501\u4f4f\uff0c\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002\u95ee\u9898\u662f\uff0c\u65e2\u7136\u8fdb\u5165\u4e86\u7b49\u5f85\u72b6\u6001\uff0c\u90a3\u4e48\u7b49\u5230\u8fd9\u4e2a\u4e8b\u52a1\u81ea\u5df1\u83b7\u53d6\u5230\u884c\u9501\u8981\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u5b83\u8bfb\u5230\u7684\u503c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u6211\u7ed9\u4f60\u4e3e\u4e00\u4e2a\u4f8b\u5b50\u5427\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u53ea\u6709\u4e24\u884c\u7684\u8868\u7684\u521d\u59cb\u5316\u8bed\u53e5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">k</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">),(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span><span class=\"w\"> </span>\n</code></pre></div>\n<pre class=\"mermaid\"><code>sequenceDiagram\n\nparticipant \u4e8b\u52a1A\nparticipant \u4e8b\u52a1B\nparticipant \u4e8b\u52a1C\n\nparticipant \u8868T\n\n\u4e8b\u52a1A-&gt;&gt;\u8868T: start transaction with consistent snapshot\n\u4e8b\u52a1B-&gt;&gt;\u8868T: start transaction with consistent snapshot\n\u4e8b\u52a1C-&gt;&gt;\u8868T: update t set k=k+1 where id=1\n\u4e8b\u52a1B-&gt;&gt;\u8868T: update set k=k+1 where id=1\n\u4e8b\u52a1B-&gt;&gt;+\u8868T: select k from where id=1\n\u8868T--&gt;&gt;-\u4e8b\u52a1B: k=3\n\u4e8b\u52a1A-&gt;&gt;+\u8868T: select from t where id=1\n\u8868T--&gt;&gt;-\u4e8b\u52a1B: k=1\n\u4e8b\u52a1A-&gt;&gt;\u8868T: commit\n\u4e8b\u52a1B-&gt;&gt;\u8868T: commit</code></pre>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e8b\u52a1\u7684\u542f\u52a8\u65f6\u673a\u3002</p>\n<p>begin/start transaction \u547d\u4ee4\u5e76\u4e0d\u662f\u4e00\u4e2a\u4e8b\u52a1\u7684\u8d77\u70b9\uff0c\u5728\u6267\u884c\u5230\u5b83\u4eec\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c InnoDB \u8868\u7684\u8bed\u53e5\uff08\u7b2c\u4e00\u4e2a\u5feb\u7167\u8bfb\u8bed\u53e5\uff09\uff0c\u4e8b\u52a1\u624d\u771f\u6b63\u542f\u52a8\u3002\u5982\u679c\u4f60\u60f3\u8981\u9a6c\u4e0a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>start transaction with consistent snapshot</code> \u8fd9\u4e2a\u547d\u4ee4\u3002</p>\n<p>\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u6574\u4e2a\u4e13\u680f\u91cc\u9762\uff0c\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u90fd\u662f\u9ed8\u8ba4 autocommit=1\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u52a1 C \u6ca1\u6709\u663e\u5f0f\u5730\u4f7f\u7528 begin/commit\uff0c\u8868\u793a\u8fd9\u4e2a update \u8bed\u53e5\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8bed\u53e5\u5b8c\u6210\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002\u4e8b\u52a1 B \u5728\u66f4\u65b0\u4e86\u884c\u4e4b\u540e\u67e5\u8be2 ; \u4e8b\u52a1 A \u5728\u4e00\u4e2a\u53ea\u8bfb\u4e8b\u52a1\u4e2d\u67e5\u8be2\uff0c\u5e76\u4e14\u65f6\u95f4\u987a\u5e8f\u4e0a\u662f\u5728\u4e8b\u52a1 B \u7684\u67e5\u8be2\u4e4b\u540e\u3002</p>\n<p>\u8fd9\u65f6\uff0c\u5982\u679c\u6211\u544a\u8bc9\u4f60\u4e8b\u52a1 B \u67e5\u5230\u7684 k \u7684\u503c\u662f 3\uff0c\u800c\u4e8b\u52a1 A \u67e5\u5230\u7684 k \u7684\u503c\u662f 1\uff0c\u4f60\u662f\u4e0d\u662f\u611f\u89c9\u6709\u70b9\u6655\u5462\uff1f</p>\n<p>\u6240\u4ee5\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5176\u5b9e\u5c31\u662f\u60f3\u548c\u4f60\u8bf4\u660e\u767d\u8fd9\u4e2a\u95ee\u9898\uff0c\u5e0c\u671b\u501f\u7531\u628a\u8fd9\u4e2a\u7591\u60d1\u89e3\u5f00\u7684\u8fc7\u7a0b\uff0c\u80fd\u591f\u5e2e\u52a9\u4f60\u5bf9 InnoDB \u7684\u4e8b\u52a1\u548c\u9501\u6709\u66f4\u8fdb\u4e00\u6b65\u7684\u7406\u89e3\u3002</p>\n<p>\u5728 MySQL \u91cc\uff0c\u6709\u4e24\u4e2a\u201c\u89c6\u56fe\u201d\u7684\u6982\u5ff5\uff1a</p>\n<ul>\n<li>\u4e00\u4e2a\u662f view\u3002\u5b83\u662f\u4e00\u4e2a\u7528\u67e5\u8be2\u8bed\u53e5\u5b9a\u4e49\u7684\u865a\u62df\u8868\uff0c\u5728\u8c03\u7528\u7684\u65f6\u5019\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u5e76\u751f\u6210\u7ed3\u679c\u3002\u521b\u5efa\u89c6\u56fe\u7684\u8bed\u6cd5\u662f create view ... \uff0c\u800c\u5b83\u7684\u67e5\u8be2\u65b9\u6cd5\u4e0e\u8868\u4e00\u6837\u3002</li>\n<li>\u53e6\u4e00\u4e2a\u662f InnoDB \u5728\u5b9e\u73b0 MVCC \u65f6\u7528\u5230\u7684\u4e00\u81f4\u6027\u8bfb\u89c6\u56fe\uff0c\u5373 consistent read view\uff0c\u7528\u4e8e\u652f\u6301 RC\uff08Read Committed\uff0c\u8bfb\u63d0\u4ea4\uff09\u548c RR\uff08Repeatable Read\uff0c\u53ef\u91cd\u590d\u8bfb\uff09\u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0\u3002</li>\n</ul>\n<p>\u5b83\u6ca1\u6709\u7269\u7406\u7ed3\u6784\uff0c\u4f5c\u7528\u662f\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u7528\u6765\u5b9a\u4e49\u201c\u6211\u80fd\u770b\u5230\u4ec0\u4e48\u6570\u636e\u201d\u3002</p>\n<h3 id=\"_24\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_24\" title=\"Permanent link\">&para;</a></h3>\n<p>InnoDB \u7684\u884c\u6570\u636e\u6709\u591a\u4e2a\u7248\u672c\uff0c\u6bcf\u4e2a\u6570\u636e\u7248\u672c\u6709\u81ea\u5df1\u7684 <code>row trx_id</code>\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6216\u8005\u8bed\u53e5\u6709\u81ea\u5df1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u666e\u901a\u67e5\u8be2\u8bed\u53e5\u662f\u4e00\u81f4\u6027\u8bfb\uff0c\u4e00\u81f4\u6027\u8bfb\u4f1a\u6839\u636e <code>row trx_id</code> \u548c\u4e00\u81f4\u6027\u89c6\u56fe\u786e\u5b9a\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u3002</p>\n<ul>\n<li>\u5bf9\u4e8e\u53ef\u91cd\u590d\u8bfb\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u4e8b\u52a1\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</li>\n<li>\u5bf9\u4e8e\u8bfb\u63d0\u4ea4\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u8bed\u53e5\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</li>\n</ul>\n<p>\u800c\u5f53\u524d\u8bfb\uff0c\u603b\u662f\u8bfb\u53d6\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6700\u65b0\u7248\u672c\u3002</p>\n<p>\u4f60\u4e5f\u53ef\u4ee5\u60f3\u4e00\u4e0b\uff0c\u4e3a\u4ec0\u4e48\u8868\u7ed3\u6784\u4e0d\u652f\u6301\u201c\u53ef\u91cd\u590d\u8bfb\u201d\uff1f\u8fd9\u662f\u56e0\u4e3a\u8868\u7ed3\u6784\u6ca1\u6709\u5bf9\u5e94\u7684\u884c\u6570\u636e\uff0c\u4e5f\u6ca1\u6709 <code>row trx_id</code>\uff0c\u56e0\u6b64\u53ea\u80fd\u9075\u5faa\u5f53\u524d\u8bfb\u7684\u903b\u8f91\u3002</p>\n<p>\u5f53\u7136\uff0cMySQL 8.0 \u5df2\u7ecf\u53ef\u4ee5\u628a\u8868\u7ed3\u6784\u653e\u5728 InnoDB \u5b57\u5178\u91cc\u4e86\uff0c\u4e5f\u8bb8\u4ee5\u540e\u4f1a\u652f\u6301\u8868\u7ed3\u6784\u7684\u53ef\u91cd\u590d\u8bfb\u3002</p>\n<h2 id=\"09\">09 \u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\uff0c\u5e94\u8be5\u600e\u4e48\u9009\u62e9\uff1f<a class=\"headerlink\" href=\"#09\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u524d\u9762\u7684\u57fa\u7840\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u8fc7\u7d22\u5f15\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u76f8\u4fe1\u4f60\u5df2\u7ecf\u4e86\u89e3\u4e86\u552f\u4e00\u7d22\u5f15\u548c\u666e\u901a\u7d22\u5f15\u7684\u533a\u522b\u3002\u4eca\u5929\u6211\u4eec\u5c31\u7ee7\u7eed\u6765\u8c08\u8c08\uff0c\u5728\u4e0d\u540c\u7684\u4e1a\u52a1\u573a\u666f\u4e0b\uff0c\u5e94\u8be5\u9009\u62e9\u666e\u901a\u7d22\u5f15\uff0c\u8fd8\u662f\u552f\u4e00\u7d22\u5f15\uff1f</p>\n<p>\u5047\u8bbe\u4f60\u5728\u7ef4\u62a4\u4e00\u4e2a\u5e02\u6c11\u7cfb\u7edf\uff0c\u6bcf\u4e2a\u4eba\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u800c\u4e14\u4e1a\u52a1\u4ee3\u7801\u5df2\u7ecf\u4fdd\u8bc1\u4e86\u4e0d\u4f1a\u5199\u5165\u4e24\u4e2a\u91cd\u590d\u7684\u8eab\u4efd\u8bc1\u53f7\u3002\u5982\u679c\u5e02\u6c11\u7cfb\u7edf\u9700\u8981\u6309\u7167\u8eab\u4efd\u8bc1\u53f7\u67e5\u59d3\u540d\uff0c\u5c31\u4f1a\u6267\u884c\u7c7b\u4f3c\u8fd9\u6837\u7684 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">CUser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id_card</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;xxxxxxxyyyyyyzzzzz&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6240\u4ee5\uff0c\u4f60\u4e00\u5b9a\u4f1a\u8003\u8651\u5728 <code>id_card</code> \u5b57\u6bb5\u4e0a\u5efa\u7d22\u5f15\u3002</p>\n<p>\u7531\u4e8e\u8eab\u4efd\u8bc1\u53f7\u5b57\u6bb5\u6bd4\u8f83\u5927\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u628a\u8eab\u4efd\u8bc1\u53f7\u5f53\u505a\u4e3b\u952e\uff0c\u90a3\u4e48\u73b0\u5728\u4f60\u6709\u4e24\u4e2a\u9009\u62e9\uff0c\u8981\u4e48\u7ed9 <code>id_card</code> \u5b57\u6bb5\u521b\u5efa\u552f\u4e00\u7d22\u5f15\uff0c\u8981\u4e48\u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7d22\u5f15\u3002\u5982\u679c\u4e1a\u52a1\u4ee3\u7801\u5df2\u7ecf\u4fdd\u8bc1\u4e86\u4e0d\u4f1a\u5199\u5165\u91cd\u590d\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u9009\u62e9\u903b\u8f91\u4e0a\u90fd\u662f\u6b63\u786e\u7684\u3002</p>\n<p>\u73b0\u5728\u6211\u8981\u95ee\u4f60\u7684\u662f\uff0c\u4ece\u6027\u80fd\u7684\u89d2\u5ea6\u8003\u8651\uff0c\u4f60\u9009\u62e9\u552f\u4e00\u7d22\u5f15\u8fd8\u662f\u666e\u901a\u7d22\u5f15\u5462\uff1f\u9009\u62e9\u7684\u4f9d\u636e\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u8fd8\u662f\u7528\u7b2c 4 \u7bc7\u6587\u7ae0[\u300a\u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0a\uff09\u300b]\u4e2d\u7684\u4f8b\u5b50\u6765\u8bf4\u660e\uff0c\u5047\u8bbe\u5b57\u6bb5 k \u4e0a\u7684\u503c\u90fd\u4e0d\u91cd\u590d\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/dcda101051f28502bd5c4402b292e38d.png\" /></p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e24\u79cd\u7d22\u5f15\u5bf9\u67e5\u8be2\u8bed\u53e5\u548c\u66f4\u65b0\u8bed\u53e5\u7684\u6027\u80fd\u5f71\u54cd\u6765\u8fdb\u884c\u5206\u6790\u3002</p>\n<h3 id=\"_25\">\u67e5\u8be2\u8fc7\u7a0b<a class=\"headerlink\" href=\"#_25\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5047\u8bbe\uff0c\u6267\u884c\u67e5\u8be2\u7684\u8bed\u53e5\u662f <code>select id from T where k=5</code>\u3002\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u5728\u7d22\u5f15\u6811\u4e0a\u67e5\u627e\u7684\u8fc7\u7a0b\uff0c\u5148\u662f\u901a\u8fc7 B+ \u6811\u4ece\u6811\u6839\u5f00\u59cb\uff0c\u6309\u5c42\u641c\u7d22\u5230\u53f6\u5b50\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u53f3\u4e0b\u89d2\u7684\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u7136\u540e\u53ef\u4ee5\u8ba4\u4e3a\u6570\u636e\u9875\u5185\u90e8\u901a\u8fc7\u4e8c\u5206\u6cd5\u6765\u5b9a\u4f4d\u8bb0\u5f55\u3002</p>\n<ul>\n<li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u67e5\u627e\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u8bb0\u5f55 (5,500) \u540e\uff0c\u9700\u8981\u67e5\u627e\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u76f4\u5230\u78b0\u5230\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3 k=5 \u6761\u4ef6\u7684\u8bb0\u5f55\u3002</li>\n<li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u7531\u4e8e\u7d22\u5f15\u5b9a\u4e49\u4e86\u552f\u4e00\u6027\uff0c\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\u540e\uff0c\u5c31\u4f1a\u505c\u6b62\u7ee7\u7eed\u68c0\u7d22\u3002</li>\n</ul>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u4e0d\u540c\u5e26\u6765\u7684\u6027\u80fd\u5dee\u8ddd\u4f1a\u6709\u591a\u5c11\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5fae\u4e4e\u5176\u5fae\u3002</p>\n<p>\u4f60\u77e5\u9053\u7684\uff0cInnoDB \u7684\u6570\u636e\u662f\u6309\u6570\u636e\u9875\u4e3a\u5355\u4f4d\u6765\u8bfb\u5199\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u9700\u8981\u8bfb\u4e00\u6761\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u5e76\u4e0d\u662f\u5c06\u8fd9\u4e2a\u8bb0\u5f55\u672c\u8eab\u4ece\u78c1\u76d8\u8bfb\u51fa\u6765\uff0c\u800c\u662f\u4ee5\u9875\u4e3a\u5355\u4f4d\uff0c\u5c06\u5176\u6574\u4f53\u8bfb\u5165\u5185\u5b58\u3002\u5728 InnoDB \u4e2d\uff0c\u6bcf\u4e2a\u6570\u636e\u9875\u7684\u5927\u5c0f\u9ed8\u8ba4\u662f 16KB\u3002</p>\n<p>\u56e0\u4e3a\u5f15\u64ce\u662f\u6309\u9875\u8bfb\u5199\u7684\uff0c\u6240\u4ee5\u8bf4\uff0c\u5f53\u627e\u5230 k=5 \u7684\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u5b83\u6240\u5728\u7684\u6570\u636e\u9875\u5c31\u90fd\u5728\u5185\u5b58\u91cc\u4e86\u3002\u90a3\u4e48\uff0c\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u8981\u591a\u505a\u7684\u90a3\u4e00\u6b21\u201c\u67e5\u627e\u548c\u5224\u65ad\u4e0b\u4e00\u6761\u8bb0\u5f55\u201d\u7684\u64cd\u4f5c\uff0c\u5c31\u53ea\u9700\u8981\u4e00\u6b21\u6307\u9488\u5bfb\u627e\u548c\u4e00\u6b21\u8ba1\u7b97\u3002</p>\n<p>\u5f53\u7136\uff0c\u5982\u679c k=5 \u8fd9\u4e2a\u8bb0\u5f55\u521a\u597d\u662f\u8fd9\u4e2a\u6570\u636e\u9875\u7684\u6700\u540e\u4e00\u4e2a\u8bb0\u5f55\uff0c\u90a3\u4e48\u8981\u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u5fc5\u987b\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u6570\u636e\u9875\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u4f1a\u7a0d\u5fae\u590d\u6742\u4e00\u4e9b\u3002</p>\n<p>\u4f46\u662f\uff0c\u6211\u4eec\u4e4b\u524d\u8ba1\u7b97\u8fc7\uff0c\u5bf9\u4e8e\u6574\u578b\u5b57\u6bb5\uff0c\u4e00\u4e2a\u6570\u636e\u9875\u53ef\u4ee5\u653e\u8fd1\u5343\u4e2a key\uff0c\u56e0\u6b64\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u6982\u7387\u4f1a\u5f88\u4f4e\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u8ba1\u7b97\u5e73\u5747\u6027\u80fd\u5dee\u5f02\u65f6\uff0c\u4ecd\u53ef\u4ee5\u8ba4\u4e3a\u8fd9\u4e2a\u64cd\u4f5c\u6210\u672c\u5bf9\u4e8e\u73b0\u5728\u7684 CPU \u6765\u8bf4\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002</p>\n<h3 id=\"_26\">\u66f4\u65b0\u8fc7\u7a0b<a class=\"headerlink\" href=\"#_26\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u8bf4\u660e\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5bf9\u66f4\u65b0\u8bed\u53e5\u6027\u80fd\u7684\u5f71\u54cd\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u9700\u8981\u5148\u8ddf\u4f60\u4ecb\u7ecd\u4e00\u4e0b change buffer\u3002</p>\n<p>\u5f53\u9700\u8981\u66f4\u65b0\u4e00\u4e2a\u6570\u636e\u9875\u65f6\uff0c\u5982\u679c\u6570\u636e\u9875\u5728\u5185\u5b58\u4e2d\u5c31\u76f4\u63a5\u66f4\u65b0\uff0c\u800c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u8fd8\u6ca1\u6709\u5728\u5185\u5b58\u4e2d\u7684\u8bdd\uff0c\u5728\u4e0d\u5f71\u54cd\u6570\u636e\u4e00\u81f4\u6027\u7684\u524d\u63d0\u4e0b\uff0cInooDB \u4f1a\u5c06\u8fd9\u4e9b\u66f4\u65b0\u64cd\u4f5c\u7f13\u5b58\u5728 change buffer \u4e2d\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u8fd9\u4e2a\u6570\u636e\u9875\u4e86\u3002\u5728\u4e0b\u6b21\u67e5\u8be2\u9700\u8981\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u7684\u65f6\u5019\uff0c\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u6267\u884c change buffer \u4e2d\u4e0e\u8fd9\u4e2a\u9875\u6709\u5173\u7684\u64cd\u4f5c\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5c31\u80fd\u4fdd\u8bc1\u8fd9\u4e2a\u6570\u636e\u903b\u8f91\u7684\u6b63\u786e\u6027\u3002</p>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u867d\u7136\u540d\u5b57\u53eb\u4f5c change buffer\uff0c\u5b9e\u9645\u4e0a\u5b83\u662f\u53ef\u4ee5\u6301\u4e45\u5316\u7684\u6570\u636e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cchange buffer \u5728\u5185\u5b58\u4e2d\u6709\u62f7\u8d1d\uff0c\u4e5f\u4f1a\u88ab\u5199\u5165\u5230\u78c1\u76d8\u4e0a\u3002</p>\n<p>\u5c06 change buffer \u4e2d\u7684\u64cd\u4f5c\u5e94\u7528\u5230\u539f\u6570\u636e\u9875\uff0c\u5f97\u5230\u6700\u65b0\u7ed3\u679c\u7684\u8fc7\u7a0b\u79f0\u4e3a merge\u3002\u9664\u4e86\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u4f1a\u89e6\u53d1 merge \u5916\uff0c\u7cfb\u7edf\u6709\u540e\u53f0\u7ebf\u7a0b\u4f1a\u5b9a\u671f merge\u3002\u5728\u6570\u636e\u5e93\u6b63\u5e38\u5173\u95ed\uff08shutdown\uff09\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u4f1a\u6267\u884c merge \u64cd\u4f5c\u3002</p>\n<p>\u663e\u7136\uff0c\u5982\u679c\u80fd\u591f\u5c06\u66f4\u65b0\u64cd\u4f5c\u5148\u8bb0\u5f55\u5728 change buffer\uff0c\u51cf\u5c11\u8bfb\u78c1\u76d8\uff0c\u8bed\u53e5\u7684\u6267\u884c\u901f\u5ea6\u4f1a\u5f97\u5230\u660e\u663e\u7684\u63d0\u5347\u3002\u800c\u4e14\uff0c\u6570\u636e\u8bfb\u5165\u5185\u5b58\u662f\u9700\u8981\u5360\u7528 buffer pool \u7684\uff0c\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd8\u80fd\u591f\u907f\u514d\u5360\u7528\u5185\u5b58\uff0c\u63d0\u9ad8\u5185\u5b58\u5229\u7528\u7387\u3002</p>\n<p>\u90a3\u4e48\uff0c<strong>\u4ec0\u4e48\u6761\u4ef6\u4e0b\u53ef\u4ee5\u4f7f\u7528 change buffer \u5462\uff1f</strong></p>\n<p>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u6240\u6709\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u8981\u5148\u5224\u65ad\u8fd9\u4e2a\u64cd\u4f5c\u662f\u5426\u8fdd\u53cd\u552f\u4e00\u6027\u7ea6\u675f\u3002\u6bd4\u5982\uff0c\u8981\u63d2\u5165 (4,400) \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u5c31\u8981\u5148\u5224\u65ad\u73b0\u5728\u8868\u4e2d\u662f\u5426\u5df2\u7ecf\u5b58\u5728 k=4 \u7684\u8bb0\u5f55\uff0c\u800c\u8fd9\u5fc5\u987b\u8981\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\u624d\u80fd\u5224\u65ad\u3002\u5982\u679c\u90fd\u5df2\u7ecf\u8bfb\u5165\u5230\u5185\u5b58\u4e86\uff0c\u90a3\u76f4\u63a5\u66f4\u65b0\u5185\u5b58\u4f1a\u66f4\u5feb\uff0c\u5c31\u6ca1\u5fc5\u8981\u4f7f\u7528 change buffer \u4e86\u3002</p>\n<p>\u56e0\u6b64\uff0c\u552f\u4e00\u7d22\u5f15\u7684\u66f4\u65b0\u5c31\u4e0d\u80fd\u4f7f\u7528 change buffer\uff0c\u5b9e\u9645\u4e0a\u4e5f\u53ea\u6709\u666e\u901a\u7d22\u5f15\u53ef\u4ee5\u4f7f\u7528\u3002</p>\n<p>change buffer \u7528\u7684\u662f buffer pool \u91cc\u7684\u5185\u5b58\uff0c\u56e0\u6b64\u4e0d\u80fd\u65e0\u9650\u589e\u5927\u3002change buffer \u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570 <code>innodb_change_buffer_max_size</code> \u6765\u52a8\u6001\u8bbe\u7f6e(\u9ed8\u8ba4\u503c\u4e3a25)\u3002\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a 50 \u7684\u65f6\u5019\uff0c\u8868\u793a change buffer \u7684\u5927\u5c0f\u6700\u591a\u53ea\u80fd\u5360\u7528 buffer pool \u7684 50%\u3002</p>\n<p>\u73b0\u5728\uff0c\u4f60\u5df2\u7ecf\u7406\u89e3\u4e86 change buffer \u7684\u673a\u5236\uff0c\u90a3\u4e48\u6211\u4eec\u518d\u4e00\u8d77\u6765\u770b\u770b\u5982\u679c\u8981\u5728\u8fd9\u5f20\u8868\u4e2d\u63d2\u5165\u4e00\u4e2a\u65b0\u8bb0\u5f55 (4,400) \u7684\u8bdd\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u662f\u600e\u6837\u7684\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c<strong>\u8fd9\u4e2a\u8bb0\u5f55\u8981\u66f4\u65b0\u7684\u76ee\u6807\u9875\u5728\u5185\u5b58\u4e2d</strong>\u3002\u8fd9\u65f6\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u627e\u5230 3 \u548c 5 \u4e4b\u95f4\u7684\u4f4d\u7f6e\uff0c\u5224\u65ad\u5230\u6ca1\u6709\u51b2\u7a81\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\uff1b</li>\n<li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u627e\u5230 3 \u548c 5 \u4e4b\u95f4\u7684\u4f4d\u7f6e\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\u3002</li>\n</ul>\n<p>\u8fd9\u6837\u770b\u6765\uff0c\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5bf9\u66f4\u65b0\u8bed\u53e5\u6027\u80fd\u5f71\u54cd\u7684\u5dee\u522b\uff0c\u53ea\u662f\u4e00\u4e2a\u5224\u65ad\uff0c\u53ea\u4f1a\u8017\u8d39\u5fae\u5c0f\u7684 CPU \u65f6\u95f4\u3002</p>\n<p>\u4f46\uff0c\u8fd9\u4e0d\u662f\u6211\u4eec\u5173\u6ce8\u7684\u91cd\u70b9\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c<strong>\u8fd9\u4e2a\u8bb0\u5f55\u8981\u66f4\u65b0\u7684\u76ee\u6807\u9875\u4e0d\u5728\u5185\u5b58\u4e2d</strong>\u3002\u8fd9\u65f6\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u9700\u8981\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\uff0c\u5224\u65ad\u5230\u6ca1\u6709\u51b2\u7a81\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\uff1b</li>\n<li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u5219\u662f\u5c06\u66f4\u65b0\u8bb0\u5f55\u5728 change buffer\uff0c\u8bed\u53e5\u6267\u884c\u5c31\u7ed3\u675f\u4e86\u3002</li>\n</ul>\n<p>\u5c06\u6570\u636e\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u6d89\u53ca\u968f\u673a IO \u7684\u8bbf\u95ee\uff0c\u662f\u6570\u636e\u5e93\u91cc\u9762\u6210\u672c\u6700\u9ad8\u7684\u64cd\u4f5c\u4e4b\u4e00\u3002change buffer \u56e0\u4e3a\u51cf\u5c11\u4e86\u968f\u673a\u78c1\u76d8\u8bbf\u95ee\uff0c\u6240\u4ee5\u5bf9\u66f4\u65b0\u6027\u80fd\u7684\u63d0\u5347\u662f\u4f1a\u5f88\u660e\u663e\u7684\u3002</p>\n<p>\u4e4b\u524d\u6211\u5c31\u78b0\u5230\u8fc7\u4e00\u4ef6\u4e8b\u513f\uff0c\u6709\u4e2a DBA \u7684\u540c\u5b66\u8ddf\u6211\u53cd\u9988\u8bf4\uff0c\u4ed6\u8d1f\u8d23\u7684\u67d0\u4e2a\u4e1a\u52a1\u7684\u5e93\u5185\u5b58\u547d\u4e2d\u7387\u7a81\u7136\u4ece 99% \u964d\u4f4e\u5230\u4e86 75%\uff0c\u6574\u4e2a\u7cfb\u7edf\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u66f4\u65b0\u8bed\u53e5\u5168\u90e8\u5835\u4f4f\u3002\u800c\u63a2\u7a76\u5176\u539f\u56e0\u540e\uff0c\u6211\u53d1\u73b0\u8fd9\u4e2a\u4e1a\u52a1\u6709\u5927\u91cf\u63d2\u5165\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u800c\u4ed6\u5728\u524d\u4e00\u5929\u628a\u5176\u4e2d\u7684\u67d0\u4e2a\u666e\u901a\u7d22\u5f15\u6539\u6210\u4e86\u552f\u4e00\u7d22\u5f15\u3002</p>\n<h3 id=\"change-buffer\">change buffer \u7684\u4f7f\u7528\u573a\u666f<a class=\"headerlink\" href=\"#change-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u5df2\u7ecf\u6e05\u695a\u4e86\u4f7f\u7528 change buffer \u5bf9\u66f4\u65b0\u8fc7\u7a0b\u7684\u52a0\u901f\u4f5c\u7528\uff0c\u4e5f\u6e05\u695a\u4e86 change buffer \u53ea\u9650\u4e8e\u7528\u5728\u666e\u901a\u7d22\u5f15\u7684\u573a\u666f\u4e0b\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u552f\u4e00\u7d22\u5f15\u3002\u90a3\u4e48\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff1a\u666e\u901a\u7d22\u5f15\u7684\u6240\u6709\u573a\u666f\uff0c\u4f7f\u7528 change buffer \u90fd\u53ef\u4ee5\u8d77\u5230\u52a0\u901f\u4f5c\u7528\u5417\uff1f</p>\n<p>\u56e0\u4e3a merge \u7684\u65f6\u5019\u662f\u771f\u6b63\u8fdb\u884c\u6570\u636e\u66f4\u65b0\u7684\u65f6\u523b\uff0c\u800c change buffer \u7684\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u5c06\u8bb0\u5f55\u7684\u53d8\u66f4\u52a8\u4f5c\u7f13\u5b58\u4e0b\u6765\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a\u6570\u636e\u9875\u505a merge \u4e4b\u524d\uff0cchange buffer \u8bb0\u5f55\u7684\u53d8\u66f4\u8d8a\u591a\uff08\u4e5f\u5c31\u662f\u8fd9\u4e2a\u9875\u9762\u4e0a\u8981\u66f4\u65b0\u7684\u6b21\u6570\u8d8a\u591a\uff09\uff0c\u6536\u76ca\u5c31\u8d8a\u5927\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5bf9\u4e8e\u5199\u591a\u8bfb\u5c11\u7684\u4e1a\u52a1\u6765\u8bf4\uff0c\u9875\u9762\u5728\u5199\u5b8c\u4ee5\u540e\u9a6c\u4e0a\u88ab\u8bbf\u95ee\u5230\u7684\u6982\u7387\u6bd4\u8f83\u5c0f\uff0c\u6b64\u65f6 change buffer \u7684\u4f7f\u7528\u6548\u679c\u6700\u597d\u3002\u8fd9\u79cd\u4e1a\u52a1\u6a21\u578b\u5e38\u89c1\u7684\u5c31\u662f\u8d26\u5355\u7c7b\u3001\u65e5\u5fd7\u7c7b\u7684\u7cfb\u7edf\u3002</p>\n<p>\u53cd\u8fc7\u6765\uff0c\u5047\u8bbe\u4e00\u4e2a\u4e1a\u52a1\u7684\u66f4\u65b0\u6a21\u5f0f\u662f\u5199\u5165\u4e4b\u540e\u9a6c\u4e0a\u4f1a\u505a\u67e5\u8be2\uff0c\u90a3\u4e48\u5373\u4f7f\u6ee1\u8db3\u4e86\u6761\u4ef6\uff0c\u5c06\u66f4\u65b0\u5148\u8bb0\u5f55\u5728 change buffer\uff0c\u4f46\u4e4b\u540e\u7531\u4e8e\u9a6c\u4e0a\u8981\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u4f1a\u7acb\u5373\u89e6\u53d1 merge \u8fc7\u7a0b\u3002\u8fd9\u6837\u968f\u673a\u8bbf\u95ee IO \u7684\u6b21\u6570\u4e0d\u4f1a\u51cf\u5c11\uff0c\u53cd\u800c\u589e\u52a0\u4e86 change buffer \u7684\u7ef4\u62a4\u4ee3\u4ef7\u3002\u6240\u4ee5\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u4e1a\u52a1\u6a21\u5f0f\u6765\u8bf4\uff0cchange buffer \u53cd\u800c\u8d77\u5230\u4e86\u526f\u4f5c\u7528\u3002</p>\n<h3 id=\"_27\">\u7d22\u5f15\u9009\u62e9\u548c\u5b9e\u8df5<a class=\"headerlink\" href=\"#_27\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u5230\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5e94\u8be5\u600e\u4e48\u9009\u62e9\u3002\u5176\u5b9e\uff0c\u8fd9\u4e24\u7c7b\u7d22\u5f15\u5728\u67e5\u8be2\u80fd\u529b\u4e0a\u662f\u6ca1\u5dee\u522b\u7684\uff0c\u4e3b\u8981\u8003\u8651\u7684\u662f\u5bf9\u66f4\u65b0\u6027\u80fd\u7684\u5f71\u54cd\u3002\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u4f60\u5c3d\u91cf\u9009\u62e9\u666e\u901a\u7d22\u5f15\u3002</p>\n<p>\u5982\u679c\u6240\u6709\u7684\u66f4\u65b0\u540e\u9762\uff0c\u90fd\u9a6c\u4e0a\u4f34\u968f\u7740\u5bf9\u8fd9\u4e2a\u8bb0\u5f55\u7684\u67e5\u8be2\uff0c\u90a3\u4e48\u4f60\u5e94\u8be5\u5173\u95ed change buffer\u3002\u800c\u5728\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0cchange buffer \u90fd\u80fd\u63d0\u5347\u66f4\u65b0\u6027\u80fd\u3002</p>\n<p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u666e\u901a\u7d22\u5f15\u548c change buffer \u7684\u914d\u5408\u4f7f\u7528\uff0c\u5bf9\u4e8e\u6570\u636e\u91cf\u5927\u7684\u8868\u7684\u66f4\u65b0\u4f18\u5316\u8fd8\u662f\u5f88\u660e\u663e\u7684\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u5728\u4f7f\u7528\u673a\u68b0\u786c\u76d8\u65f6\uff0cchange buffer \u8fd9\u4e2a\u673a\u5236\u7684\u6536\u6548\u662f\u975e\u5e38\u663e\u8457\u7684\u3002\u6240\u4ee5\uff0c\u5f53\u4f60\u6709\u4e00\u4e2a\u7c7b\u4f3c\u201c\u5386\u53f2\u6570\u636e\u201d\u7684\u5e93\uff0c\u5e76\u4e14\u51fa\u4e8e\u6210\u672c\u8003\u8651\u7528\u7684\u662f\u673a\u68b0\u786c\u76d8\u65f6\uff0c\u90a3\u4f60\u5e94\u8be5\u7279\u522b\u5173\u6ce8\u8fd9\u4e9b\u8868\u91cc\u7684\u7d22\u5f15\uff0c\u5c3d\u91cf\u4f7f\u7528\u666e\u901a\u7d22\u5f15\uff0c\u7136\u540e\u628a change buffer \u5c3d\u91cf\u5f00\u5927\uff0c\u4ee5\u786e\u4fdd\u8fd9\u4e2a\u201c\u5386\u53f2\u6570\u636e\u201d\u8868\u7684\u6570\u636e\u5199\u5165\u901f\u5ea6\u3002</p>\n<h3 id=\"change-buffer-redo-log\">change buffer \u548c redo log<a class=\"headerlink\" href=\"#change-buffer-redo-log\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7406\u89e3\u4e86 change buffer \u7684\u539f\u7406\uff0c\u4f60\u53ef\u80fd\u4f1a\u8054\u60f3\u5230\u6211\u5728\u524d\u9762\u6587\u7ae0\u4e2d\u548c\u4f60\u4ecb\u7ecd\u8fc7\u7684 redo log \u548c WAL\u3002</p>\n<p>\u5728\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u4e2d\uff0c\u6211\u53d1\u73b0\u6709\u540c\u5b66\u6df7\u6dc6\u4e86 redo log \u548c change buffer\u3002WAL \u63d0\u5347\u6027\u80fd\u7684\u6838\u5fc3\u673a\u5236\uff0c\u4e5f\u7684\u786e\u662f\u5c3d\u91cf\u51cf\u5c11\u968f\u673a\u8bfb\u5199\uff0c\u8fd9\u4e24\u4e2a\u6982\u5ff5\u786e\u5b9e\u5bb9\u6613\u6df7\u6dc6\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u6211\u628a\u5b83\u4eec\u653e\u5230\u4e86\u540c\u4e00\u4e2a\u6d41\u7a0b\u91cc\u6765\u8bf4\u660e\uff0c\u4fbf\u4e8e\u4f60\u533a\u5206\u8fd9\u4e24\u4e2a\u6982\u5ff5\u3002</p>\n<blockquote>\n<p>\u5907\u6ce8\uff1a\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e0b\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\u7684\u76f8\u5173\u5185\u5bb9\u3002</p>\n</blockquote>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u8981\u5728\u8868\u4e0a\u6267\u884c\u8fd9\u4e2a\u63d2\u5165\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"n\">k</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">id1</span><span class=\"p\">,</span><span class=\"n\">k1</span><span class=\"p\">),(</span><span class=\"n\">id2</span><span class=\"p\">,</span><span class=\"n\">k2</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u5047\u8bbe\b\u5f53\u524d k \u7d22\u5f15\u6811\u7684\u72b6\u6001\uff0c\u67e5\u627e\u5230\u4f4d\u7f6e\u540e\uff0ck1 \u6240\u5728\u7684\u6570\u636e\u9875\u5728\u5185\u5b58 (InnoDB buffer pool) \u4e2d\uff0ck2 \u6240\u5728\u7684\u6570\u636e\u9875\u4e0d\u5728\u5185\u5b58\u4e2d\u3002\u5982\u56fe 2 \u6240\u793a\u662f\u5e26 change buffer \u7684\u66f4\u65b0\u72b6\u6001\u56fe\u3002</p>\n<pre class=\"mermaid\"><code>graph TB\nsubgraph buffer[\"InnoDB buffer pool\"]\n    subgraph cb[\"change buffer\"]\n        node1[\"add(id2,k2) to Page 2\"]\n    end\n    p1[\"Page1&lt;br/&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;(a,b)&lt;/td&gt;&lt;td&gt;&lt;font color='red'&gt;(id1,k1)&lt;/font&gt;&lt;/td&gt;&lt;td&gt;(c,d)&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\"]\nend\nsubgraph redolog[\"Redo log(ib_logfileX)\"]\n rn1[\"add(id1,k1) to Page 1\"]\n rn2[\"new change buffer item &lt;br/&gt;'add(id2,k2) to Page2'\"]\nend\nsubgraph tablespace[\"system table space(ibdata1)\"]\n    subgraph cbtb[\"change buffer\"]\n        n[\"add(id2,k2) to Page 2\"]\n    end\nend\nsubgraph data[\"data(t.ibd)\"]\n    dn[\"&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td colspan='2'&gt;Page 1&lt;/td&gt;&lt;td&gt;...&lt;/td&gt;&lt;td colspan='2'&gt;Page 2&lt;/td&gt;&lt;/tr&gt;\n       &lt;tr&gt;&lt;td&gt;(a,b)&lt;/td&gt;&lt;td&gt;(c,d)&lt;/td&gt;&lt;td&gt;...&lt;/td&gt;&lt;td&gt;(e,f)&lt;/td&gt;&lt;td&gt;(g,h)&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;\"]\nend\ncb --&gt;cbtb\np1 --&gt;dn</code></pre>\n<p>\u5206\u6790\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u6d89\u53ca\u4e86\u56db\u4e2a\u90e8\u5206\uff1a\u5185\u5b58\u3001redo log\uff08<code>ib_logfileX</code>\uff09\u3001 \u6570\u636e\u8868\u7a7a\u95f4\uff08t.ibd\uff09\u3001\u7cfb\u7edf\u8868\u7a7a\u95f4\uff08ibdata1\uff09\u3002</p>\n<p>\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u505a\u4e86\u5982\u4e0b\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>Page 1 \u5728\u5185\u5b58\u4e2d\uff0c\u76f4\u63a5\u66f4\u65b0\u5185\u5b58\uff1b</li>\n<li>Page 2 \u6ca1\u6709\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u5728\u5185\u5b58\u7684 change buffer \u533a\u57df\uff0c\u8bb0\u5f55\u4e0b\u201c\u6211\u8981\u5f80 Page 2 \u63d2\u5165\u4e00\u884c\u201d\u8fd9\u4e2a\u4fe1\u606f</li>\n<li>\u5c06\u4e0a\u8ff0\u4e24\u4e2a\u52a8\u4f5c\u8bb0\u5165 redo log \u4e2d\u3002</li>\n</ol>\n<p>\u505a\u5b8c\u4e0a\u9762\u8fd9\u4e9b\uff0c\u4e8b\u52a1\u5c31\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002\u6240\u4ee5\uff0c\u4f60\u4f1a\u770b\u5230\uff0c\u6267\u884c\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u662f\u5199\u4e86\u4e24\u5904\u5185\u5b58\uff0c\u7136\u540e\u5199\u4e86\u4e00\u5904\u78c1\u76d8\uff08\u4e24\u6b21\u64cd\u4f5c\u5408\u5728\u4e00\u8d77\u5199\u4e86\u4e00\u6b21\u78c1\u76d8\uff09\uff0c\u800c\u4e14\u8fd8\u662f\u987a\u5e8f\u5199\u7684\u3002</p>\n<p>\u90a3\u5728\u8fd9\u4e4b\u540e\u7684\u8bfb\u8bf7\u6c42\uff0c\u8981\u600e\u4e48\u5904\u7406\u5462\uff1f</p>\n<p>\u6bd4\u5982\uff0c\u6211\u4eec\u73b0\u5728\u8981\u6267\u884c <code>select * from t where k in (k1, k2)</code>\u3002\u8fd9\u91cc\uff0c\u6211\u753b\u4e86\u8fd9\u4e24\u4e2a\u8bfb\u8bf7\u6c42\u7684\u6d41\u7a0b\u56fe\u3002</p>\n<p>\u5982\u679c\u8bfb\u8bed\u53e5\u53d1\u751f\u5728\u66f4\u65b0\u8bed\u53e5\u540e\u4e0d\u4e45\uff0c\u5185\u5b58\u4e2d\u7684\u6570\u636e\u90fd\u8fd8\u5728\uff0c\u90a3\u4e48\u6b64\u65f6\u7684\u8fd9\u4e24\u4e2a\u8bfb\u64cd\u4f5c\u5c31\u4e0e\u7cfb\u7edf\u8868\u7a7a\u95f4\uff08ibdata1\uff09\u548c redo log\uff08<code>ib_logfileX</code>\uff09\u65e0\u5173\u4e86\u3002\u6240\u4ee5\uff0c\u6211\u5728\u56fe\u4e2d\u5c31\u6ca1\u753b\u51fa\u8fd9\u4e24\u90e8\u5206\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/6dc743577af1dbcbb8550bddbfc5f98e.png\" /></p>\n<p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ol>\n<li>\u8bfb Page 1 \u7684\u65f6\u5019\uff0c\u76f4\u63a5\u4ece\u5185\u5b58\u8fd4\u56de\u3002\u6709\u51e0\u4f4d\u540c\u5b66\u5728\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u4e2d\u95ee\u5230\uff0cWAL \u4e4b\u540e\u5982\u679c\u8bfb\u6570\u636e\uff0c\u662f\u4e0d\u662f\u4e00\u5b9a\u8981\u8bfb\u76d8\uff0c\u662f\u4e0d\u662f\u4e00\u5b9a\u8981\u4ece redo log \u91cc\u9762\u628a\u6570\u636e\u66f4\u65b0\u4ee5\u540e\u624d\u53ef\u4ee5\u8fd4\u56de\uff1f\u5176\u5b9e\u662f\u4e0d\u7528\u7684\u3002\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u56fe 3 \u7684\u8fd9\u4e2a\u72b6\u6001\uff0c\u867d\u7136\u78c1\u76d8\u4e0a\u8fd8\u662f\u4e4b\u524d\u7684\u6570\u636e\uff0c\u4f46\u662f\u8fd9\u91cc\u76f4\u63a5\u4ece\u5185\u5b58\u8fd4\u56de\u7ed3\u679c\uff0c\u7ed3\u679c\u662f\u6b63\u786e\u7684\u3002</li>\n<li>\u8981\u8bfb Page 2 \u7684\u65f6\u5019\uff0c\u9700\u8981\u628a Page 2 \u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u5e94\u7528 change buffer \u91cc\u9762\u7684\u64cd\u4f5c\u65e5\u5fd7\uff0c\u751f\u6210\u4e00\u4e2a\u6b63\u786e\u7684\u7248\u672c\u5e76\u8fd4\u56de\u7ed3\u679c\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u76f4\u5230\u9700\u8981\u8bfb Page 2 \u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u624d\u4f1a\u88ab\u8bfb\u5165\u5185\u5b58\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u8981\u7b80\u5355\u5730\u5bf9\u6bd4\u8fd9\u4e24\u4e2a\u673a\u5236\u5728\u63d0\u5347\u66f4\u65b0\u6027\u80fd\u4e0a\u7684\u6536\u76ca\u7684\u8bdd\uff0c<strong>redo log \u4e3b\u8981\u8282\u7701\u7684\u662f\u968f\u673a\u5199\u78c1\u76d8\u7684 IO \u6d88\u8017\uff08\u8f6c\u6210\u987a\u5e8f\u5199\uff09\uff0c\u800c change buffer \u4e3b\u8981\u8282\u7701\u7684\u5219\u662f\u968f\u673a\u8bfb\u78c1\u76d8\u7684 IO \u6d88\u8017\u3002</strong></p>\n<h3 id=\"_28\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_28\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u4ece\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u7684\u9009\u62e9\u5f00\u59cb\uff0c\u548c\u4f60\u5206\u4eab\u4e86\u6570\u636e\u7684\u67e5\u8be2\u548c\u66f4\u65b0\u8fc7\u7a0b\uff0c\u7136\u540e\u8bf4\u660e\u4e86 change buffer \u7684\u673a\u5236\u4ee5\u53ca\u5e94\u7528\u573a\u666f\uff0c\u6700\u540e\u8bb2\u5230\u4e86\u7d22\u5f15\u9009\u62e9\u7684\u5b9e\u8df5\u3002</p>\n<p>\u7531\u4e8e\u552f\u4e00\u7d22\u5f15\u7528\u4e0d\u4e0a change buffer \u7684\u4f18\u5316\u673a\u5236\uff0c\u56e0\u6b64\u5982\u679c\u4e1a\u52a1\u53ef\u4ee5\u63a5\u53d7\uff0c\u4ece\u6027\u80fd\u89d2\u5ea6\u51fa\u53d1\u6211\u5efa\u8bae\u4f60\u4f18\u5148\u8003\u8651\u975e\u552f\u4e00\u7d22\u5f15\u3002</p>\n<p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u601d\u8003\u9898\u65f6\u95f4\u3002</p>\n<p>\u901a\u8fc7\u56fe 2 \u4f60\u53ef\u4ee5\u770b\u5230\uff0cchange buffer \u4e00\u5f00\u59cb\u662f\u5199\u5185\u5b58\u7684\uff0c\u90a3\u4e48\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u673a\u5668\u6389\u7535\u91cd\u542f\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4 change buffer \u4e22\u5931\u5462\uff1fchange buffer \u4e22\u5931\u53ef\u4e0d\u662f\u5c0f\u4e8b\u513f\uff0c\u518d\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u53ef\u5c31\u6ca1\u6709\u4e86 merge \u8fc7\u7a0b\uff0c\u5c31\u7b49\u4e8e\u662f\u6570\u636e\u4e22\u5931\u4e86\u3002\u4f1a\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u5462\uff1f</p>\n<p>\u4f60\u53ef\u4ee5\u628a\u4f60\u7684\u601d\u8003\u548c\u89c2\u70b9\u5199\u5728\u7559\u8a00\u533a\u91cc\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u7684\u672b\u5c3e\u548c\u4f60\u8ba8\u8bba\u8fd9\u4e2a\u95ee\u9898\u3002\u611f\u8c22\u4f60\u7684\u6536\u542c\uff0c\u4e5f\u6b22\u8fce\u4f60\u628a\u8fd9\u7bc7\u6587\u7ae0\u5206\u4eab\u7ed9\u66f4\u591a\u7684\u670b\u53cb\u4e00\u8d77\u9605\u8bfb\u3002</p>\n<p>\u56de\u7b54\uff1a</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u662f\u4e0d\u4f1a\u4e22\u5931\uff0c\u7559\u8a00\u533a\u7684\u5f88\u591a\u540c\u5b66\u90fd\u56de\u7b54\u5bf9\u4e86\u3002\u867d\u7136\u662f\u53ea\u66f4\u65b0\u5185\u5b58\uff0c\u4f46\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u628a change buffer \u7684\u64cd\u4f5c\u4e5f\u8bb0\u5f55\u5230 redo log \u91cc\u4e86\uff0c\u6240\u4ee5\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0cchange buffer \u4e5f\u80fd\u627e\u56de\u6765\u3002</p>\n<p>\u5728\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u95ee\u5230\uff0cmerge \u7684\u8fc7\u7a0b\u662f\u5426\u4f1a\u628a\u6570\u636e\u76f4\u63a5\u5199\u56de\u78c1\u76d8\uff0c\u8fd9\u662f\u4e2a\u597d\u95ee\u9898\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u4e3a\u4f60\u5206\u6790\u4e00\u4e0b\u3002</p>\n<p>merge \u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u9875\u5230\u5185\u5b58\uff08\u8001\u7248\u672c\u7684\u6570\u636e\u9875\uff09\uff1b</li>\n<li>\u4ece change buffer \u91cc\u627e\u51fa\u8fd9\u4e2a\u6570\u636e\u9875\u7684 change buffer \u8bb0\u5f55 (\u53ef\u80fd\u6709\u591a\u4e2a\uff09\uff0c\u4f9d\u6b21\u5e94\u7528\uff0c\u5f97\u5230\u65b0\u7248\u6570\u636e\u9875\uff1b</li>\n<li>\u5199 redo log\u3002\u8fd9\u4e2a redo log \u5305\u542b\u4e86\u6570\u636e\u7684\u53d8\u66f4\u548c change buffer \u7684\u53d8\u66f4\u3002</li>\n</ol>\n<p>\u5230\u8fd9\u91cc merge \u8fc7\u7a0b\u5c31\u7ed3\u675f\u4e86\u3002\u8fd9\u65f6\u5019\uff0c\u6570\u636e\u9875\u548c\u5185\u5b58\u4e2d change buffer \u5bf9\u5e94\u7684\u78c1\u76d8\u4f4d\u7f6e\u90fd\u8fd8\u6ca1\u6709\u4fee\u6539\uff0c\u5c5e\u4e8e\u810f\u9875\uff0c\u4e4b\u540e\u5404\u81ea\u5237\u56de\u81ea\u5df1\u7684\u7269\u7406\u6570\u636e\uff0c\u5c31\u662f\u53e6\u5916\u4e00\u4e2a\u8fc7\u7a0b\u4e86\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["mysql", "tuning"]}, {"id": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-2/", "url": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-2/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e8c\u90e8\u5206", "content_html": "<h1 id=\"mysql-45\">\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e8c\u90e8\u5206<a class=\"headerlink\" href=\"#mysql-45\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md\" title=\"Permalink to MySQL\u5b9e\u621845\u8bb2.md\">Source</a></p>\n<p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e8c\u90e8\u5206</p>\n<h2 id=\"10-mysql\">10 MySQL\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u4f1a\u9009\u9519\u7d22\u5f15\uff1f<a class=\"headerlink\" href=\"#10-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7d22\u5f15\uff0c\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\u5728 MySQL \u4e2d\u4e00\u5f20\u8868\u5176\u5b9e\u662f\u53ef\u4ee5\u652f\u6301\u591a\u4e2a\u7d22\u5f15\u7684\u3002\u4f46\u662f\uff0c\u4f60\u5199 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5e76\u6ca1\u6709\u4e3b\u52a8\u6307\u5b9a\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\u662f\u7531 MySQL \u6765\u786e\u5b9a\u7684\u3002</p>\n<p>\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u78b0\u5230\u8fc7\u8fd9\u79cd\u60c5\u51b5\uff0c\u4e00\u6761\u672c\u6765\u53ef\u4ee5\u6267\u884c\u5f97\u5f88\u5feb\u7684\u8bed\u53e5\uff0c\u5374\u7531\u4e8e MySQL \u9009\u9519\u4e86\u7d22\u5f15\uff0c\u800c\u5bfc\u81f4\u6267\u884c\u901f\u5ea6\u53d8\u5f97\u5f88\u6162\uff1f</p>\n<p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\u5427\u3002</p>\n<p>\u6211\u4eec\u5148\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u8868\uff0c\u8868\u91cc\u6709 a\u3001b \u4e24\u4e2a\u5b57\u6bb5\uff0c\u5e76\u5206\u522b\u5efa\u4e0a\u7d22\u5f15\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u6211\u4eec\u5f80\u8868 t \u4e2d\u63d2\u5165 10 \u4e07\u884c\u8bb0\u5f55\uff0c\u53d6\u503c\u6309\u6574\u6570\u9012\u589e\uff0c\u5373\uff1a<code>(1,1,1)\uff0c(2,2,2)\uff0c(3,3,3)</code> \u76f4\u5230 <code>(100000,100000,100000)</code>\u3002</p>\n<p>\u6211\u662f\u7528\u5b58\u50a8\u8fc7\u7a0b\u6765\u63d2\u5165\u6570\u636e\u7684\uff0c\u8fd9\u91cc\u6211\u8d34\u51fa\u6765\u65b9\u4fbf\u4f60\u590d\u73b0\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">100000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5206\u6790\u4e00\u6761 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u8fd8\u7528\u5206\u6790\u5417\uff0c\u5f88\u7b80\u5355\u5440\uff0ca \u4e0a\u6709\u7d22\u5f15\uff0c\u80af\u5b9a\u662f\u8981\u4f7f\u7528\u7d22\u5f15 a \u7684\u3002</p>\n<p>\u4f60\u8bf4\u5f97\u6ca1\u9519\uff0c\u4e0b\u9762\u663e\u793a\u7684\u5c31\u662f\u4f7f\u7528 explain \u547d\u4ee4\u770b\u5230\u7684\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                 </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">10001</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u4e5f\u786e\u5b9e\u7b26\u5408\u9884\u671f\uff0ckey \u8fd9\u4e2a\u5b57\u6bb5\u503c\u662f <code>a</code>\uff0c\u8868\u793a\u4f18\u5316\u5668\u9009\u62e9\u4e86\u7d22\u5f15 a\u3002</p>\n<p>\u4e0d\u8fc7\u522b\u6025\uff0c\u8fd9\u4e2a\u6848\u4f8b\u4e0d\u4f1a\u8fd9\u4e48\u7b80\u5355\u3002\u5728\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u7684\u5305\u542b\u4e86 10 \u4e07\u884c\u6570\u636e\u7684\u8868\u4e0a\uff0c\u6211\u4eec\u518d\u505a\u5982\u4e0b\u64cd\u4f5c\u3002</p>\n<pre class=\"mermaid\"><code>%%{init: {\"theme\":\"gray\"}}%%\nsequenceDiagram\nparticipant Session A\nparticipant Session B\nparticipant Table\n\nSession A -&gt;&gt;Table: start transaction with consistent snapshot\nSession B -&gt;&gt;Table: delete from t;\nSession B -&gt;&gt;Table: call ibdata();\n\nSession B -&gt;&gt;Table: explain select * from t where a between 10000 and 20000\nSession A -&gt;&gt;Table: commit\n</code></pre>\n<p>\u8fd9\u91cc\uff0csession A \u7684\u64cd\u4f5c\u4f60\u5df2\u7ecf\u5f88\u719f\u6089\u4e86\uff0c\u5b83\u5c31\u662f\u5f00\u542f\u4e86\u4e00\u4e2a\u4e8b\u52a1\u3002\u968f\u540e\uff0csession B \u628a\u6570\u636e\u90fd\u5220\u9664\u540e\uff0c\u53c8\u8c03\u7528\u4e86 idata \u8fd9\u4e2a\u5b58\u50a8\u8fc7\u7a0b\uff0c\u63d2\u5165\u4e86 10 \u4e07\u884c\u6570\u636e\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0csession B \u7684\u67e5\u8be2\u8bed\u53e5 <code>select * from t where a between 10000 and 20000</code> \u5c31\u4e0d\u4f1a\u518d\u9009\u62e9\u7d22\u5f15 <code>a</code> \u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6765\u67e5\u770b\u4e00\u4e0b\u5177\u4f53\u7684\u6267\u884c\u60c5\u51b5\u3002</p>\n<p>\u4e3a\u4e86\u8bf4\u660e\u4f18\u5316\u5668\u9009\u62e9\u7684\u7ed3\u679c\u662f\u5426\u6b63\u786e\uff0c\u6211\u589e\u52a0\u4e86\u4e00\u4e2a\u5bf9\u7167\uff0c\u5373\uff1a\u4f7f\u7528 <code>force index(a)</code> \u6765\u8ba9\u4f18\u5316\u5668\u5f3a\u5236\u4f7f\u7528\u7d22\u5f15 <code>a</code></p>\n<p>\u4e0b\u9762\u7684\u4e09\u6761 SQL \u8bed\u53e5\uff0c\u5c31\u662f\u8fd9\u4e2a\u5b9e\u9a8c\u8fc7\u7a0b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">long_query_time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*Q1*/</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span><span class=\"cm\">/*Q2*/</span>\n</code></pre></div>\n<ul>\n<li>\u7b2c\u4e00\u53e5\uff0c\u662f\u5c06\u6162\u67e5\u8be2\u65e5\u5fd7\u7684\u9608\u503c\u8bbe\u7f6e\u4e3a 0\uff0c\u8868\u793a\u8fd9\u4e2a\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5165\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\uff1b</li>\n<li>\u7b2c\u4e8c\u53e5\uff0cQ1 \u662f session B \u539f\u6765\u7684\u67e5\u8be2\uff1b</li>\n<li>\u7b2c\u4e09\u53e5\uff0cQ2 \u662f\u52a0\u4e86 <code>force index(a)</code> \u6765\u548c session B \u539f\u6765\u7684\u67e5\u8be2\u8bed\u53e5\u6267\u884c\u60c5\u51b5\u5bf9\u6bd4\u3002</li>\n</ul>\n<p>\u5982\u56fe 3 \u6240\u793a\u662f\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2018</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"n\">T10</span><span class=\"p\">:</span><span class=\"mi\">26</span><span class=\"p\">:</span><span class=\"mi\">35</span><span class=\"p\">.</span><span class=\"mi\">711526</span><span class=\"n\">Z</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"o\">@</span><span class=\"k\">Host</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">[</span><span class=\"n\">root</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"p\">:</span>\n<span class=\"mi\">4</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"n\">Query_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">040877</span><span class=\"w\"> </span><span class=\"n\">Lock_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000151</span><span class=\"w\"> </span><span class=\"n\">Rows_sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10001</span><span class=\"w\"> </span><span class=\"n\">Rows_examined</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">100000</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"o\">=</span><span class=\"mi\">1543832795</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2018</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"n\">T10</span><span class=\"p\">:</span><span class=\"mi\">26</span><span class=\"p\">:</span><span class=\"mi\">11</span><span class=\"p\">.</span><span class=\"mi\">0287037</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"o\">@</span><span class=\"k\">Host</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">[</span><span class=\"n\">root</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"p\">:</span>\n<span class=\"mi\">4</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"n\">Query_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">021076</span><span class=\"w\"> </span><span class=\"n\">Lock_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000163</span><span class=\"w\"> </span><span class=\"n\">Rows_sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10001</span><span class=\"w\"> </span><span class=\"n\">Rows_examined</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10001</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"o\">=</span><span class=\"mi\">1543832771</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cQ1 \u626b\u63cf\u4e86 10 \u4e07\u884c\uff0c\u663e\u7136\u662f\u8d70\u4e86\u5168\u8868\u626b\u63cf\uff0c\u6267\u884c\u65f6\u95f4\u662f 40 \u6beb\u79d2\u3002Q2 \u626b\u63cf\u4e86 10001 \u884c\uff0c\u6267\u884c\u4e86 21 \u6beb\u79d2\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u5728\u6ca1\u6709\u4f7f\u7528 <code>force index</code> \u7684\u65f6\u5019\uff0cMySQL \u7528\u9519\u4e86\u7d22\u5f15\uff0c\u5bfc\u81f4\u4e86\u66f4\u957f\u7684\u6267\u884c\u65f6\u95f4\u3002</p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u5e94\u7684\u662f\u6211\u4eec\u5e73\u5e38\u4e0d\u65ad\u5730\u5220\u9664\u5386\u53f2\u6570\u636e\u548c\u65b0\u589e\u6570\u636e\u7684\u573a\u666f\u3002\u8fd9\u65f6\uff0cMySQL \u7adf\u7136\u4f1a\u9009\u9519\u7d22\u5f15\uff0c\u662f\u4e0d\u662f\u6709\u70b9\u5947\u602a\u5462\uff1f\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u5947\u602a\u7684\u7ed3\u679c\u8bf4\u8d77\u5427\u3002</p>\n<h3 id=\"_1\">\u4f18\u5316\u5668\u7684\u903b\u8f91<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c31\u63d0\u5230\u8fc7\uff0c\u9009\u62e9\u7d22\u5f15\u662f\u4f18\u5316\u5668\u7684\u5de5\u4f5c\u3002</p>\n<p>\u800c\u4f18\u5316\u5668\u9009\u62e9\u7d22\u5f15\u7684\u76ee\u7684\uff0c\u662f\u627e\u5230\u4e00\u4e2a\u6700\u4f18\u7684\u6267\u884c\u65b9\u6848\uff0c\u5e76\u7528\u6700\u5c0f\u7684\u4ee3\u4ef7\u53bb\u6267\u884c\u8bed\u53e5\u3002\u5728\u6570\u636e\u5e93\u91cc\u9762\uff0c\u626b\u63cf\u884c\u6570\u662f\u5f71\u54cd\u6267\u884c\u4ee3\u4ef7\u7684\u56e0\u7d20\u4e4b\u4e00\u3002\u626b\u63cf\u7684\u884c\u6570\u8d8a\u5c11\uff0c\u610f\u5473\u7740\u8bbf\u95ee\u78c1\u76d8\u6570\u636e\u7684\u6b21\u6570\u8d8a\u5c11\uff0c\u6d88\u8017\u7684 CPU \u8d44\u6e90\u8d8a\u5c11\u3002</p>\n<p>\u5f53\u7136\uff0c\u626b\u63cf\u884c\u6570\u5e76\u4e0d\u662f\u552f\u4e00\u7684\u5224\u65ad\u6807\u51c6\uff0c\u4f18\u5316\u5668\u8fd8\u4f1a\u7ed3\u5408\u662f\u5426\u4f7f\u7528\u4e34\u65f6\u8868\u3001\u662f\u5426\u6392\u5e8f\u7b49\u56e0\u7d20\u8fdb\u884c\u7efc\u5408\u5224\u65ad\u3002</p>\n<p>\u6211\u4eec\u8fd9\u4e2a\u7b80\u5355\u7684\u67e5\u8be2\u8bed\u53e5\u5e76\u6ca1\u6709\u6d89\u53ca\u5230\u4e34\u65f6\u8868\u548c\u6392\u5e8f\uff0c\u6240\u4ee5 MySQL \u9009\u9519\u7d22\u5f15\u80af\u5b9a\u662f\u5728\u5224\u65ad\u626b\u63cf\u884c\u6570\u7684\u65f6\u5019\u51fa\u95ee\u9898\u4e86\u3002</p>\n<p>\u90a3\u4e48\uff0c\u95ee\u9898\u5c31\u662f\uff1a<strong>\u626b\u63cf\u884c\u6570\u662f\u600e\u4e48\u5224\u65ad\u7684\uff1f</strong></p>\n<p>MySQL \u5728\u771f\u6b63\u5f00\u59cb\u6267\u884c\u8bed\u53e5\u4e4b\u524d\uff0c\u5e76\u4e0d\u80fd\u7cbe\u786e\u5730\u77e5\u9053\u6ee1\u8db3\u8fd9\u4e2a\u6761\u4ef6\u7684\u8bb0\u5f55\u6709\u591a\u5c11\u6761\uff0c\u800c\u53ea\u80fd\u6839\u636e\u7edf\u8ba1\u4fe1\u606f\u6765\u4f30\u7b97\u8bb0\u5f55\u6570\u3002</p>\n<p>\u8fd9\u4e2a\u7edf\u8ba1\u4fe1\u606f\u5c31\u662f\u7d22\u5f15\u7684\u201c\u533a\u5206\u5ea6\u201d\u3002\u663e\u7136\uff0c\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u8d8a\u591a\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u5c31\u8d8a\u597d\u3002\u800c\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u7684\u4e2a\u6570\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u201c\u57fa\u6570\u201d\uff08cardinality\uff09\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u57fa\u6570\u8d8a\u5927\uff0c\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u8d8a\u597d\u3002</p>\n<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 show index \u65b9\u6cd5\uff0c\u770b\u5230\u4e00\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u3002\u5982\u56fe 4 \u6240\u793a\uff0c\u5c31\u662f\u8868 t \u7684 show index \u7684\u7ed3\u679c \u3002\u867d\u7136\u8fd9\u4e2a\u8868\u7684\u6bcf\u4e00\u884c\u7684\u4e09\u4e2a\u5b57\u6bb5\u503c\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u5728\u7edf\u8ba1\u4fe1\u606f\u4e2d\uff0c\u8fd9\u4e09\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u503c\u5e76\u4e0d\u540c\uff0c\u800c\u4e14\u5176\u5b9e\u90fd\u4e0d\u51c6\u786e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Non_unique</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Key_name</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Seq_in_index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Column_name</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Collation</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Cardinality</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sub_part</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Packed</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Null</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Index_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Comment</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Index_comment</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Visible</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Expression</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">100256</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">BTREE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">YES</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">100256</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">YES</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">BTREE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">YES</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">       </span><span class=\"mi\">98190</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">YES</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">BTREE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">YES</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>\n</code></pre></div>\n<p>\u90a3\u4e48\uff0cMySQL \u662f\u600e\u6837\u5f97\u5230\u7d22\u5f15\u7684\u57fa\u6570\u7684\u5462\uff1f\u8fd9\u91cc\uff0c\u6211\u7ed9\u4f60\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b MySQL \u91c7\u6837\u7edf\u8ba1\u7684\u65b9\u6cd5\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8981\u91c7\u6837\u7edf\u8ba1\u5462\uff1f\u56e0\u4e3a\u628a\u6574\u5f20\u8868\u53d6\u51fa\u6765\u4e00\u884c\u884c\u7edf\u8ba1\uff0c\u867d\u7136\u53ef\u4ee5\u5f97\u5230\u7cbe\u786e\u7684\u7ed3\u679c\uff0c\u4f46\u662f\u4ee3\u4ef7\u592a\u9ad8\u4e86\uff0c\u6240\u4ee5\u53ea\u80fd\u9009\u62e9\u201c\u91c7\u6837\u7edf\u8ba1\u201d\u3002</p>\n<p>\u91c7\u6837\u7edf\u8ba1\u7684\u65f6\u5019\uff0cInnoDB \u9ed8\u8ba4\u4f1a\u9009\u62e9 N \u4e2a\u6570\u636e\u9875\uff0c\u7edf\u8ba1\u8fd9\u4e9b\u9875\u9762\u4e0a\u7684\u4e0d\u540c\u503c\uff0c\u5f97\u5230\u4e00\u4e2a\u5e73\u5747\u503c\uff0c\u7136\u540e\u4e58\u4ee5\u8fd9\u4e2a\u7d22\u5f15\u7684\u9875\u9762\u6570\uff0c\u5c31\u5f97\u5230\u4e86\u8fd9\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u3002</p>\n<p>\u800c\u6570\u636e\u8868\u662f\u4f1a\u6301\u7eed\u66f4\u65b0\u7684\uff0c\u7d22\u5f15\u7edf\u8ba1\u4fe1\u606f\u4e5f\u4e0d\u4f1a\u56fa\u5b9a\u4e0d\u53d8\u3002\u6240\u4ee5\uff0c\u5f53\u53d8\u66f4\u7684\u6570\u636e\u884c\u6570\u8d85\u8fc7 1/M \u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u89e6\u53d1\u91cd\u65b0\u505a\u4e00\u6b21\u7d22\u5f15\u7edf\u8ba1\u3002</p>\n<p>\u5728 MySQL \u4e2d\uff0c\u6709\u4e24\u79cd\u5b58\u50a8\u7d22\u5f15\u7edf\u8ba1\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u53c2\u6570 <code>innodb_stats_persistent</code> \u7684\u503c\u6765\u9009\u62e9\uff1a</p>\n<ul>\n<li>\u8bbe\u7f6e\u4e3a on \u7684\u65f6\u5019\uff0c\u8868\u793a\u7edf\u8ba1\u4fe1\u606f\u4f1a\u6301\u4e45\u5316\u5b58\u50a8\u3002\u8fd9\u65f6\uff0c\u9ed8\u8ba4\u7684 N \u662f 20\uff0cM \u662f 10\u3002</li>\n<li>\u8bbe\u7f6e\u4e3a off \u7684\u65f6\u5019\uff0c\u8868\u793a\u7edf\u8ba1\u4fe1\u606f\u53ea\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002\u8fd9\u65f6\uff0c\u9ed8\u8ba4\u7684 N \u662f 8\uff0cM \u662f 16\u3002</li>\n</ul>\n<p>\u7531\u4e8e\u662f\u91c7\u6837\u7edf\u8ba1\uff0c\u6240\u4ee5\u4e0d\u7ba1 N \u662f 20 \u8fd8\u662f 8\uff0c\u8fd9\u4e2a\u57fa\u6570\u90fd\u662f\u5f88\u5bb9\u6613\u4e0d\u51c6\u7684\u3002</p>\n<p>\u4f46\uff0c\u8fd9\u8fd8\u4e0d\u662f\u5168\u90e8\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u4ece\u4e0a\u8868\u4e2d\u770b\u5230\uff0c\u8fd9\u6b21\u7684\u7d22\u5f15\u7edf\u8ba1\u503c\uff08cardinality \u5217\uff09\u867d\u7136\u4e0d\u591f\u7cbe\u786e\uff0c\u4f46\u5927\u4f53\u4e0a\u8fd8\u662f\u5dee\u4e0d\u591a\u7684\uff0c\u9009\u9519\u7d22\u5f15\u4e00\u5b9a\u8fd8\u6709\u522b\u7684\u539f\u56e0\u3002</p>\n<p>\u5176\u5b9e\u7d22\u5f15\u7edf\u8ba1\u53ea\u662f\u4e00\u4e2a\u8f93\u5165\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5177\u4f53\u7684\u8bed\u53e5\u6765\u8bf4\uff0c\u4f18\u5316\u5668\u8fd8\u8981\u5224\u65ad\uff0c\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u672c\u8eab\u8981\u626b\u63cf\u591a\u5c11\u884c\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b\u4f18\u5316\u5668\u9884\u4f30\u7684\uff0c\u8fd9\u4e24\u4e2a\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u662f\u591a\u5c11\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">104620</span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                 </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">37116</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>rows \u8fd9\u4e2a\u5b57\u6bb5\u8868\u793a\u7684\u662f\u9884\u8ba1\u626b\u63cf\u884c\u6570\u3002</p>\n<p>\u5176\u4e2d\uff0cQ1 \u7684\u7ed3\u679c\u8fd8\u662f\u7b26\u5408\u9884\u671f\u7684\uff0crows \u7684\u503c\u662f 104620\uff1b\u4f46\u662f Q2 \u7684 rows \u503c\u662f 37116\uff0c\u504f\u5dee\u5c31\u5927\u4e86\u3002\u800c\u56fe 1 \u4e2d\u6211\u4eec\u7528 explain \u547d\u4ee4\u770b\u5230\u7684 rows \u662f\u53ea\u6709 10001 \u884c\uff0c\u662f\u8fd9\u4e2a\u504f\u5dee\u8bef\u5bfc\u4e86\u4f18\u5316\u5668\u7684\u5224\u65ad\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u53ef\u80fd\u4f60\u7684\u7b2c\u4e00\u4e2a\u7591\u95ee\u4e0d\u662f\u4e3a\u4ec0\u4e48\u4e0d\u51c6\uff0c\u800c\u662f\u4f18\u5316\u5668\u4e3a\u4ec0\u4e48\u653e\u7740\u626b\u63cf 37000 \u884c\u7684\u6267\u884c\u8ba1\u5212\u4e0d\u7528\uff0c\u5374\u9009\u62e9\u4e86\u626b\u63cf\u884c\u6570\u662f 100000 \u7684\u6267\u884c\u8ba1\u5212\u5462\uff1f</p>\n<p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a\uff0c\u6bcf\u6b21\u4ece\u7d22\u5f15 a \u4e0a\u62ff\u5230\u4e00\u4e2a\u503c\uff0c\u90fd\u8981\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u67e5\u51fa\u6574\u884c\u6570\u636e\uff0c\u8fd9\u4e2a\u4ee3\u4ef7\u4f18\u5316\u5668\u4e5f\u8981\u7b97\u8fdb\u53bb\u7684\u3002</p>\n<p>\u800c\u5982\u679c\u9009\u62e9\u626b\u63cf 10 \u4e07\u884c\uff0c\u662f\u76f4\u63a5\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u626b\u63cf\u7684\uff0c\u6ca1\u6709\u989d\u5916\u7684\u4ee3\u4ef7\u3002</p>\n<p>\u4f18\u5316\u5668\u4f1a\u4f30\u7b97\u8fd9\u4e24\u4e2a\u9009\u62e9\u7684\u4ee3\u4ef7\uff0c\u4ece\u7ed3\u679c\u770b\u6765\uff0c\u4f18\u5316\u5668\u8ba4\u4e3a\u76f4\u63a5\u626b\u63cf\u4e3b\u952e\u7d22\u5f15\u66f4\u5feb\u3002\u5f53\u7136\uff0c\u4ece\u6267\u884c\u65f6\u95f4\u770b\u6765\uff0c\u8fd9\u4e2a\u9009\u62e9\u5e76\u4e0d\u662f\u6700\u4f18\u7684\u3002</p>\n<p>\u4f7f\u7528\u666e\u901a\u7d22\u5f15\u9700\u8981\u628a\u56de\u8868\u7684\u4ee3\u4ef7\u7b97\u8fdb\u53bb\uff0c\u5728\u56fe 1 \u6267\u884c explain \u7684\u65f6\u5019\uff0c\u4e5f\u8003\u8651\u4e86\u8fd9\u4e2a\u7b56\u7565\u7684\u4ee3\u4ef7 \uff0c\u4f46\u56fe 1 \u7684\u9009\u62e9\u662f\u5bf9\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u7b56\u7565\u5e76\u6ca1\u6709\u95ee\u9898\u3002</p>\n<p>\u6240\u4ee5\u51a4\u6709\u5934\u503a\u6709\u4e3b\uff0cMySQL \u9009\u9519\u7d22\u5f15\uff0c\u8fd9\u4ef6\u4e8b\u513f\u8fd8\u5f97\u5f52\u548e\u5230\u6ca1\u80fd\u51c6\u786e\u5730\u5224\u65ad\u51fa\u626b\u63cf\u884c\u6570\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u4f1a\u5f97\u5230\u9519\u8bef\u7684\u626b\u63cf\u884c\u6570\uff0c\u8fd9\u4e2a\u539f\u56e0\u5c31\u4f5c\u4e3a\u8bfe\u540e\u95ee\u9898\uff0c\u7559\u7ed9\u4f60\u53bb\u5206\u6790\u4e86\u3002</p>\n<p>\u65e2\u7136\u662f\u7edf\u8ba1\u4fe1\u606f\u4e0d\u5bf9\uff0c\u90a3\u5c31\u4fee\u6b63\u3002<code>analyze table t</code> \u547d\u4ee4\uff0c\u53ef\u4ee5\u7528\u6765\u91cd\u65b0\u7edf\u8ba1\u7d22\u5f15\u4fe1\u606f\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u6267\u884c\u6548\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">analyze</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">--------+---------+----------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Table</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Msg_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Msg_text</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">--------+---------+----------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">analyze</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">OK</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">--------+---------+----------+----------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">20000</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                 </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">10001</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u56de\u5bf9\u4e86\u3002</p>\n<p>\u6240\u4ee5\u5728\u5b9e\u8df5\u4e2d\uff0c\u5982\u679c\u4f60\u53d1\u73b0 explain \u7684\u7ed3\u679c\u9884\u4f30\u7684 rows \u503c\u8ddf\u5b9e\u9645\u60c5\u51b5\u5dee\u8ddd\u6bd4\u8f83\u5927\uff0c\u53ef\u4ee5\u91c7\u7528\u8fd9\u4e2a\u65b9\u6cd5\u6765\u5904\u7406\u3002</p>\n<p>\u5176\u5b9e\uff0c\u5982\u679c\u53ea\u662f\u7d22\u5f15\u7edf\u8ba1\u4e0d\u51c6\u786e\uff0c\u901a\u8fc7 analyze \u547d\u4ee4\u53ef\u4ee5\u89e3\u51b3\u5f88\u591a\u95ee\u9898\uff0c\u4f46\u662f\u524d\u9762\u6211\u4eec\u8bf4\u4e86\uff0c\u4f18\u5316\u5668\u53ef\u4e0d\u6b62\u662f\u770b\u626b\u63cf\u884c\u6570\u3002</p>\n<p>\u4f9d\u7136\u662f\u57fa\u4e8e\u8fd9\u4e2a\u8868 t\uff0c\u6211\u4eec\u770b\u770b\u53e6\u5916\u4e00\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"w\">  </span>\n<span class=\"k\">and</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4ece\u6761\u4ef6\u4e0a\u770b\uff0c\u8fd9\u4e2a\u67e5\u8be2\u6ca1\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u56e0\u6b64\u4f1a\u8fd4\u56de\u7a7a\u96c6\u5408\u3002</p>\n<p>\u5728\u5f00\u59cb\u6267\u884c\u8fd9\u6761\u8bed\u53e5\u4e4b\u524d\uff0c\u4f60\u53ef\u4ee5\u5148\u8bbe\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u6765\u9009\u62e9\u7d22\u5f15\uff0c\u4f1a\u9009\u62e9\u54ea\u4e00\u4e2a\u5462\uff1f</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b a\u3001b \u8fd9\u4e24\u4e2a\u7d22\u5f15\u7684\u7ed3\u6784\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/1d037f92063e800c3bfff3f4dbf1a2b9.png\" /></p>\n<p>\u56fe 7 a\u3001b \u7d22\u5f15\u7684\u7ed3\u6784\u56fe</p>\n<p>\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a \u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u5c31\u662f\u626b\u63cf\u7d22\u5f15 a \u7684\u524d 1000 \u4e2a\u503c\uff0c\u7136\u540e\u53d6\u5230\u5bf9\u5e94\u7684 id\uff0c\u518d\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u67e5\u51fa\u6bcf\u4e00\u884c\uff0c\u7136\u540e\u6839\u636e\u5b57\u6bb5 b \u6765\u8fc7\u6ee4\u3002\u663e\u7136\u8fd9\u6837\u9700\u8981\u626b\u63cf 1000 \u884c\u3002</p>\n<p>\u5982\u679c\u4f7f\u7528\u7d22\u5f15 b \u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u5c31\u662f\u626b\u63cf\u7d22\u5f15 b \u7684\u6700\u540e 50001 \u4e2a\u503c\uff0c\u4e0e\u4e0a\u9762\u7684\u6267\u884c\u8fc7\u7a0b\u76f8\u540c\uff0c\u4e5f\u662f\u9700\u8981\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53d6\u503c\u518d\u5224\u65ad\uff0c\u6240\u4ee5\u9700\u8981\u626b\u63cf 50001 \u884c\u3002</p>\n<p>\u6240\u4ee5\u4f60\u4e00\u5b9a\u4f1a\u60f3\uff0c\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a \u7684\u8bdd\uff0c\u6267\u884c\u901f\u5ea6\u660e\u663e\u4f1a\u5feb\u5f88\u591a\u3002\u90a3\u4e48\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u770b\u770b\u5230\u5e95\u662f\u4e0d\u662f\u8fd9\u4e48\u4e00\u56de\u4e8b\u513f\u3002</p>\n<p>\u56fe 8 \u662f\u6267\u884c explain \u7684\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                              </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"n\">b</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">50128</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd4\u56de\u7ed3\u679c\u4e2d key \u5b57\u6bb5\u663e\u793a\uff0c\u8fd9\u6b21\u4f18\u5316\u5668\u9009\u62e9\u4e86\u7d22\u5f15 b\uff0c\u800c rows \u5b57\u6bb5\u663e\u793a\u9700\u8981\u626b\u63cf\u7684\u884c\u6570\u662f 50128\u3002</p>\n<p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a\u7ed3\u8bba\uff1a</p>\n<ol>\n<li>\u626b\u63cf\u884c\u6570\u7684\u4f30\u8ba1\u503c\u4f9d\u7136\u4e0d\u51c6\u786e\uff1b</li>\n<li>\u8fd9\u4e2a\u4f8b\u5b50\u91cc MySQL \u53c8\u9009\u9519\u4e86\u7d22\u5f15\u3002</li>\n</ol>\n<h3 id=\"_2\">\u7d22\u5f15\u9009\u62e9\u5f02\u5e38\u548c\u5904\u7406<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5176\u5b9e\u5927\u591a\u6570\u65f6\u5019\u4f18\u5316\u5668\u90fd\u80fd\u627e\u5230\u6b63\u786e\u7684\u7d22\u5f15\uff0c\u4f46\u5076\u5c14\u4f60\u8fd8\u662f\u4f1a\u78b0\u5230\u6211\u4eec\u4e0a\u9762\u4e3e\u4f8b\u7684\u8fd9\u4e24\u79cd\u60c5\u51b5\uff1a\u539f\u672c\u53ef\u4ee5\u6267\u884c\u5f97\u5f88\u5feb\u7684 SQL \u8bed\u53e5\uff0c\u6267\u884c\u901f\u5ea6\u5374\u6bd4\u4f60\u9884\u671f\u7684\u6162\u5f88\u591a\uff0c\u4f60\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\uff0c\u50cf\u6211\u4eec\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u91c7\u7528 force index \u5f3a\u884c\u9009\u62e9\u4e00\u4e2a\u7d22\u5f15\u3002MySQL \u4f1a\u6839\u636e\u8bcd\u6cd5\u89e3\u6790\u7684\u7ed3\u679c\u5206\u6790\u51fa\u53ef\u80fd\u53ef\u4ee5\u4f7f\u7528\u7684\u7d22\u5f15\u4f5c\u4e3a\u5019\u9009\u9879\uff0c\u7136\u540e\u5728\u5019\u9009\u5217\u8868\u4e2d\u4f9d\u6b21\u5224\u65ad\u6bcf\u4e2a\u7d22\u5f15\u9700\u8981\u626b\u63cf\u591a\u5c11\u884c\u3002\u5982\u679c force index \u6307\u5b9a\u7684\u7d22\u5f15\u5728\u5019\u9009\u7d22\u5f15\u5217\u8868\u4e2d\uff0c\u5c31\u76f4\u63a5\u9009\u62e9\u8fd9\u4e2a\u7d22\u5f15\uff0c\u4e0d\u518d\u8bc4\u4f30\u5176\u4ed6\u7d22\u5f15\u7684\u6267\u884c\u4ee3\u4ef7\u3002</p>\n<p>\u6211\u4eec\u6765\u770b\u770b\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u3002\u521a\u5f00\u59cb\u5206\u6790\u65f6\uff0c\u6211\u4eec\u8ba4\u4e3a\u9009\u62e9\u7d22\u5f15 a \u4f1a\u66f4\u597d\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u770b\u770b\u6267\u884c\u6548\u679c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"n\">Empty</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"n\">Empty</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u539f\u672c\u8bed\u53e5\u9700\u8981\u6267\u884c 0.04 \u79d2\uff0c\u800c\u5f53\u4f60\u4f7f\u7528 <code>force index(a)</code> \u7684\u65f6\u5019\uff0c\u53ea\u7528\u4e86 0.01 \u79d2\uff0c\u6bd4\u4f18\u5316\u5668\u7684\u9009\u62e9\u5feb\u4e86 4 \u500d\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f18\u5316\u5668\u6ca1\u6709\u9009\u62e9\u6b63\u786e\u7684\u7d22\u5f15\uff0cforce index \u8d77\u5230\u4e86\u201c\u77eb\u6b63\u201d\u7684\u4f5c\u7528\u3002</p>\n<p>\u4e0d\u8fc7\u5f88\u591a\u7a0b\u5e8f\u5458\u4e0d\u559c\u6b22\u4f7f\u7528 force index\uff0c\u4e00\u6765\u8fd9\u4e48\u5199\u4e0d\u4f18\u7f8e\uff0c\u4e8c\u6765\u5982\u679c\u7d22\u5f15\u6539\u4e86\u540d\u5b57\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4e5f\u5f97\u6539\uff0c\u663e\u5f97\u5f88\u9ebb\u70e6\u3002\u800c\u4e14\u5982\u679c\u4ee5\u540e\u8fc1\u79fb\u5230\u522b\u7684\u6570\u636e\u5e93\u7684\u8bdd\uff0c\u8fd9\u4e2a\u8bed\u6cd5\u8fd8\u53ef\u80fd\u4f1a\u4e0d\u517c\u5bb9\u3002</p>\n<p>\u4f46\u5176\u5b9e\u4f7f\u7528 force index \u6700\u4e3b\u8981\u7684\u95ee\u9898\u8fd8\u662f\u53d8\u66f4\u7684\u53ca\u65f6\u6027\u3002\u56e0\u4e3a\u9009\u9519\u7d22\u5f15\u7684\u60c5\u51b5\u8fd8\u662f\u6bd4\u8f83\u5c11\u51fa\u73b0\u7684\uff0c\u6240\u4ee5\u5f00\u53d1\u7684\u65f6\u5019\u901a\u5e38\u4e0d\u4f1a\u5148\u5199\u4e0a force index\u3002\u800c\u662f\u7b49\u5230\u7ebf\u4e0a\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\uff0c\u4f60\u624d\u4f1a\u518d\u53bb\u4fee\u6539 SQL \u8bed\u53e5\u3001\u52a0\u4e0a force index\u3002\u4f46\u662f\u4fee\u6539\u4e4b\u540e\u8fd8\u8981\u6d4b\u8bd5\u548c\u53d1\u5e03\uff0c\u5bf9\u4e8e\u751f\u4ea7\u7cfb\u7edf\u6765\u8bf4\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u591f\u654f\u6377\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6570\u636e\u5e93\u7684\u95ee\u9898\u6700\u597d\u8fd8\u662f\u5728\u6570\u636e\u5e93\u5185\u90e8\u6765\u89e3\u51b3\u3002\u90a3\u4e48\uff0c\u5728\u6570\u636e\u5e93\u91cc\u9762\u8be5\u600e\u6837\u89e3\u51b3\u5462\uff1f</p>\n<p>\u65e2\u7136\u4f18\u5316\u5668\u653e\u5f03\u4e86\u4f7f\u7528\u7d22\u5f15 a\uff0c\u8bf4\u660e a \u8fd8\u4e0d\u591f\u5408\u9002\uff0c\u6240\u4ee5</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5c31\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4fee\u6539\u8bed\u53e5\uff0c\u5f15\u5bfc MySQL \u4f7f\u7528\u6211\u4eec\u671f\u671b\u7684\u7d22\u5f15\u3002</p>\n<p>\u6bd4\u5982\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u663e\u7136\u628a <code>order by b limit 1</code> \u6539\u6210  <code>order by b,a limit 1</code> \uff0c\u8bed\u4e49\u7684\u903b\u8f91\u662f\u76f8\u540c\u7684\u3002</p>\n<p>\u6211\u4eec\u6765\u770b\u770b\u6539\u4e4b\u540e\u7684\u6548\u679c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"n\">b</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">50128</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"n\">b</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">50</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4e4b\u524d\u4f18\u5316\u5668\u9009\u62e9\u4f7f\u7528\u7d22\u5f15 b\uff0c\u662f\u56e0\u4e3a\u5b83\u8ba4\u4e3a\u4f7f\u7528\u7d22\u5f15 b \u53ef\u4ee5\u907f\u514d\u6392\u5e8f\uff08b \u672c\u8eab\u662f\u7d22\u5f15\uff0c\u5df2\u7ecf\u662f\u6709\u5e8f\u7684\u4e86\uff0c\u5982\u679c\u9009\u62e9\u7d22\u5f15 b \u7684\u8bdd\uff0c\u4e0d\u9700\u8981\u518d\u505a\u6392\u5e8f\uff0c\u53ea\u9700\u8981\u904d\u5386\uff09\uff0c\u6240\u4ee5\u5373\u4f7f\u626b\u63cf\u884c\u6570\u591a\uff0c\u4e5f\u5224\u5b9a\u4e3a\u4ee3\u4ef7\u66f4\u5c0f\u3002</p>\n<p>\u73b0\u5728 order by b,a \u8fd9\u79cd\u5199\u6cd5\uff0c\u8981\u6c42\u6309\u7167 b,a \u6392\u5e8f\uff0c\u5c31\u610f\u5473\u7740\u4f7f\u7528\u8fd9\u4e24\u4e2a\u7d22\u5f15\u90fd\u9700\u8981\u6392\u5e8f\u3002\u56e0\u6b64\uff0c\u626b\u63cf\u884c\u6570\u6210\u4e86\u5f71\u54cd\u51b3\u7b56\u7684\u4e3b\u8981\u6761\u4ef6\uff0c\u4e8e\u662f\u6b64\u65f6\u4f18\u5316\u5668\u9009\u4e86\u53ea\u9700\u8981\u626b\u63cf 1000 \u884c\u7684\u7d22\u5f15 a\u3002</p>\n<p>\u5f53\u7136\uff0c\u8fd9\u79cd\u4fee\u6539\u5e76\u4e0d\u662f\u901a\u7528\u7684\u4f18\u5316\u624b\u6bb5\uff0c\u53ea\u662f\u521a\u597d\u5728\u8fd9\u4e2a\u8bed\u53e5\u91cc\u9762\u6709 limit 1\uff0c\u56e0\u6b64\u5982\u679c\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c order by b limit 1 \u548c order by b,a limit 1 \u90fd\u4f1a\u8fd4\u56de b \u662f\u6700\u5c0f\u7684\u90a3\u4e00\u884c\uff0c\u903b\u8f91\u4e0a\u4e00\u81f4\uff0c\u624d\u53ef\u4ee5\u8fd9\u4e48\u505a\u3002</p>\n<p>\u5982\u679c\u4f60\u89c9\u5f97\u4fee\u6539\u8bed\u4e49\u8fd9\u4ef6\u4e8b\u513f\u4e0d\u592a\u597d\uff0c\u8fd9\u91cc\u8fd8\u6709\u4e00\u79cd\u6539\u6cd5\uff0c\u4e0b\u9762\u662f\u6267\u884c\u6548\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"w\">  </span>\n<span class=\"w\">       </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">between</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">alias</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">derived2</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">DERIVED</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"n\">b</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">50</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+</span>\n<span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6211\u4eec\u7528 limit 100 \u8ba9\u4f18\u5316\u5668\u610f\u8bc6\u5230\uff0c\u4f7f\u7528 b \u7d22\u5f15\u4ee3\u4ef7\u662f\u5f88\u9ad8\u7684\u3002\u5176\u5b9e\u662f\u6211\u4eec\u6839\u636e\u6570\u636e\u7279\u5f81\u8bf1\u5bfc\u4e86\u4e00\u4e0b\u4f18\u5316\u5668\uff0c\u4e5f\u4e0d\u5177\u5907\u901a\u7528\u6027\u3002</p>\n<p><strong>\u7b2c\u4e09\u79cd\u65b9\u6cd5\u662f\uff0c\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u66f4\u5408\u9002\u7684\u7d22\u5f15\uff0c\u6765\u63d0\u4f9b\u7ed9\u4f18\u5316\u5668\u505a\u9009\u62e9\uff0c\u6216\u5220\u6389\u8bef\u7528\u7684\u7d22\u5f15\u3002</strong></p>\n<p>\u4e0d\u8fc7\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u6ca1\u6709\u627e\u5230\u901a\u8fc7\u65b0\u589e\u7d22\u5f15\u6765\u6539\u53d8\u4f18\u5316\u5668\u884c\u4e3a\u7684\u65b9\u6cd5\u3002\u8fd9\u79cd\u60c5\u51b5\u5176\u5b9e\u6bd4\u8f83\u5c11\uff0c\u5c24\u5176\u662f\u7ecf\u8fc7 DBA \u7d22\u5f15\u4f18\u5316\u8fc7\u7684\u5e93\uff0c\u518d\u78b0\u5230\u8fd9\u4e2a bug\uff0c\u627e\u5230\u4e00\u4e2a\u66f4\u5408\u9002\u7684\u7d22\u5f15\u4e00\u822c\u6bd4\u8f83\u96be\u3002</p>\n<p>\u5982\u679c\u6211\u8bf4\u8fd8\u6709\u4e00\u4e2a\u65b9\u6cd5\u662f\u5220\u6389\u7d22\u5f15 b\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u597d\u7b11\u3002\u4f46\u5b9e\u9645\u4e0a\u6211\u78b0\u5230\u8fc7\u4e24\u6b21\u8fd9\u6837\u7684\u4f8b\u5b50\uff0c\u6700\u7ec8\u662f DBA \u8ddf\u4e1a\u52a1\u5f00\u53d1\u6c9f\u901a\u540e\uff0c\u53d1\u73b0\u8fd9\u4e2a\u4f18\u5316\u5668\u9519\u8bef\u9009\u62e9\u7684\u7d22\u5f15\u5176\u5b9e\u6839\u672c\u6ca1\u6709\u5fc5\u8981\u5b58\u5728\uff0c\u4e8e\u662f\u5c31\u5220\u6389\u4e86\u8fd9\u4e2a\u7d22\u5f15\uff0c\u4f18\u5316\u5668\u4e5f\u5c31\u91cd\u65b0\u9009\u62e9\u5230\u4e86\u6b63\u786e\u7684\u7d22\u5f15\u3002</p>\n<h3 id=\"_3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u6211\u4eec\u4e00\u8d77\u804a\u4e86\u804a\u7d22\u5f15\u7edf\u8ba1\u7684\u66f4\u65b0\u673a\u5236\uff0c\u5e76\u63d0\u5230\u4e86\u4f18\u5316\u5668\u5b58\u5728\u9009\u9519\u7d22\u5f15\u7684\u53ef\u80fd\u6027\u3002</p>\n<p>\u5bf9\u4e8e\u7531\u4e8e\u7d22\u5f15\u7edf\u8ba1\u4fe1\u606f\u4e0d\u51c6\u786e\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u7528 <code>analyze table</code> \u6765\u89e3\u51b3\u3002</p>\n<p>\u800c\u5bf9\u4e8e\u5176\u4ed6\u4f18\u5316\u5668\u8bef\u5224\u7684\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u5728\u5e94\u7528\u7aef\u7528 <code>force index</code> \u6765\u5f3a\u884c\u6307\u5b9a\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u8bed\u53e5\u6765\u5f15\u5bfc\u4f18\u5316\u5668\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0\u6216\u8005\u5220\u9664\u7d22\u5f15\u6765\u7ed5\u8fc7\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u540e\u9762\u7684\u51e0\u4e2a\u4f8b\u5b50\uff0c\u600e\u4e48\u90fd\u6ca1\u6709\u5c55\u5f00\u8bf4\u660e\u5176\u539f\u7406\u3002\u6211\u8981\u544a\u8bc9\u4f60\u7684\u662f\uff0c\u4eca\u5929\u7684\u8bdd\u9898\uff0c\u6211\u4eec\u9762\u5bf9\u7684\u662f MySQL \u7684 bug\uff0c\u6bcf\u4e00\u4e2a\u5c55\u5f00\u90fd\u5fc5\u987b\u6df1\u5165\u5230\u4e00\u884c\u884c\u4ee3\u7801\u53bb\u91cf\u5316\uff0c\u5b9e\u5728\u4e0d\u662f\u6211\u4eec\u5728\u8fd9\u91cc\u5e94\u8be5\u505a\u7684\u4e8b\u60c5\u3002</p>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u3002\u524d\u9762\u6211\u4eec\u5728\u6784\u9020\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u7684\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 session A \u7684\u914d\u5408\uff0c\u8ba9 session B \u5220\u9664\u6570\u636e\u540e\u53c8\u91cd\u65b0\u63d2\u5165\u4e86\u4e00\u904d\u6570\u636e\uff0c\u7136\u540e\u5c31\u53d1\u73b0 explain \u7ed3\u679c\u4e2d\uff0crows \u5b57\u6bb5\u4ece 10001 \u53d8\u6210 37000 \u591a\u3002</p>\n<p>\u800c\u5982\u679c\u6ca1\u6709 session A \u7684\u914d\u5408\uff0c\u53ea\u662f\u5355\u72ec\u6267\u884c delete from t \u3001call idata()\u3001explain \u8fd9\u4e09\u53e5\u8bdd\uff0c\u4f1a\u770b\u5230 rows \u5b57\u6bb5\u5176\u5b9e\u8fd8\u662f 10000 \u5de6\u53f3\u3002\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u8fd9\u4e2a\u7ed3\u679c\u3002</p>\n<p>\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f\u4e5f\u8bf7\u4f60\u5206\u6790\u4e00\u4e0b\u5427\u3002</p>\n<h2 id=\"11\">11 \u600e\u4e48\u7ed9\u5b57\u7b26\u4e32\u5b57\u6bb5\u52a0\u7d22\u5f15\uff1f<a class=\"headerlink\" href=\"#11\" title=\"Permanent link\">&para;</a></h2>\n<p>\u73b0\u5728\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u7cfb\u7edf\u90fd\u652f\u6301\u90ae\u7bb1\u767b\u5f55\uff0c\u5982\u4f55\u5728\u90ae\u7bb1\u8fd9\u6837\u7684\u5b57\u6bb5\u4e0a\u5efa\u7acb\u5408\u7406\u7684\u7d22\u5f15\uff0c\u662f\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\u3002</p>\n<p>\u5047\u8bbe\uff0c\u4f60\u73b0\u5728\u7ef4\u62a4\u4e00\u4e2a\u652f\u6301\u90ae\u7bb1\u767b\u5f55\u7684\u7cfb\u7edf\uff0c\u7528\u6237\u8868\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"p\">(</span>\n<span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"nb\">bigint</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span>\n<span class=\"n\">email</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">64</span><span class=\"p\">),</span><span class=\"w\"> </span>\n<span class=\"p\">...</span><span class=\"w\"> </span>\n<span class=\"p\">)</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7531\u4e8e\u8981\u4f7f\u7528\u90ae\u7bb1\u767b\u5f55\uff0c\u6240\u4ee5\u4e1a\u52a1\u4ee3\u7801\u4e2d\u4e00\u5b9a\u4f1a\u51fa\u73b0\u7c7b\u4f3c\u4e8e\u8fd9\u6837\u7684\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">f1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f2</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"o\">=</span><span class=\"s1\">&#39;xxx&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4ece\u7b2c 4 \u548c\u7b2c 5 \u7bc7\u8bb2\u89e3\u7d22\u5f15\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u5982\u679c email \u8fd9\u4e2a\u5b57\u6bb5\u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8bed\u53e5\u5c31\u53ea\u80fd\u505a\u5168\u8868\u626b\u63cf\u3002</p>\n<p>\u540c\u65f6\uff0cMySQL \u662f\u652f\u6301\u524d\u7f00\u7d22\u5f15\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u5b57\u7b26\u4e32\u7684\u4e00\u90e8\u5206\u4f5c\u4e3a\u7d22\u5f15\u3002\u9ed8\u8ba4\u5730\uff0c\u5982\u679c\u4f60\u521b\u5efa\u7d22\u5f15\u7684\u8bed\u53e5\u4e0d\u6307\u5b9a\u524d\u7f00\u957f\u5ea6\uff0c\u90a3\u4e48\u7d22\u5f15\u5c31\u4f1a\u5305\u542b\u6574\u4e2a\u5b57\u7b26\u4e32\u3002</p>\n<p>\u6bd4\u5982\uff0c\u8fd9\u4e24\u4e2a\u5728 email \u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u7684\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">index1</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">-- \u6216</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">index2</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">));</span>\n</code></pre></div>\n<p>\u7b2c\u4e00\u4e2a\u8bed\u53e5\u521b\u5efa\u7684 index1 \u7d22\u5f15\u91cc\u9762\uff0c\u5305\u542b\u4e86\u6bcf\u4e2a\u8bb0\u5f55\u7684\u6574\u4e2a\u5b57\u7b26\u4e32\uff1b\u800c\u7b2c\u4e8c\u4e2a\u8bed\u53e5\u521b\u5efa\u7684 index2 \u7d22\u5f15\u91cc\u9762\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8bb0\u5f55\u90fd\u662f\u53ea\u53d6\u524d 6 \u4e2a\u5b57\u8282\u3002</p>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e24\u79cd\u4e0d\u540c\u7684\u5b9a\u4e49\u5728\u6570\u636e\u7ed3\u6784\u548c\u5b58\u50a8\u4e0a\u6709\u4ec0\u4e48\u533a\u522b\u5462\uff1f\u5982\u56fe 2 \u548c 3 \u6240\u793a\uff0c\u5c31\u662f\u8fd9\u4e24\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/d31da662bee595991862c439a5567eb7.jpg\" /></p>\n<p>\u56fe 1 email \u7d22\u5f15\u7ed3\u6784</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/134583875561de914991fc2e192cf842.jpg\" /></p>\n<p>\u56fe 2 email(6) \u7d22\u5f15\u7ed3\u6784</p>\n<p>\u4ece\u56fe\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e email(6) \u8fd9\u4e2a\u7d22\u5f15\u7ed3\u6784\u4e2d\u6bcf\u4e2a\u90ae\u7bb1\u5b57\u6bb5\u90fd\u53ea\u53d6\u524d 6 \u4e2a\u5b57\u8282\uff08\u5373\uff1azhangs\uff09\uff0c\u6240\u4ee5\u5360\u7528\u7684\u7a7a\u95f4\u4f1a\u66f4\u5c0f\uff0c\u8fd9\u5c31\u662f\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u7684\u4f18\u52bf\u3002</p>\n<p>\u4f46\uff0c\u8fd9\u540c\u65f6\u5e26\u6765\u7684\u635f\u5931\u662f\uff0c\u53ef\u80fd\u4f1a\u589e\u52a0\u989d\u5916\u7684\u8bb0\u5f55\u626b\u63cf\u6b21\u6570\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u5728\u8fd9\u4e24\u4e2a\u7d22\u5f15\u5b9a\u4e49\u4e0b\u5206\u522b\u662f\u600e\u4e48\u6267\u884c\u7684\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">email</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"o\">=</span><span class=\"s1\">&#39;zhangssxyz@xxx.com&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p><strong>\u5982\u679c\u4f7f\u7528\u7684\u662f index1</strong>\uff08\u5373 email \u6574\u4e2a\u5b57\u7b26\u4e32\u7684\u7d22\u5f15\u7ed3\u6784\uff09\uff0c\u6267\u884c\u987a\u5e8f\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4ece index1 \u7d22\u5f15\u6811\u627e\u5230\u6ee1\u8db3\u7d22\u5f15\u503c\u662f <code>zhangssxyz@xxx.com</code> \u7684\u8fd9\u6761\u8bb0\u5f55\uff0c\u53d6\u5f97 ID2 \u7684\u503c\uff1b</li>\n<li>\u5230\u4e3b\u952e\u4e0a\u67e5\u5230\u4e3b\u952e\u503c\u662f ID2 \u7684\u884c\uff0c\u5224\u65ad email \u7684\u503c\u662f\u6b63\u786e\u7684\uff0c\u5c06\u8fd9\u884c\u8bb0\u5f55\u52a0\u5165\u7ed3\u679c\u96c6\uff1b</li>\n<li>\u53d6 index1 \u7d22\u5f15\u6811\u4e0a\u521a\u521a\u67e5\u5230\u7684\u4f4d\u7f6e\u7684\u4e0b\u4e00\u6761\u8bb0\u5f55\uff0c\u53d1\u73b0\u5df2\u7ecf\u4e0d\u6ee1\u8db3 <code>email='zhangssxyz@xxx.com'</code> \u7684\u6761\u4ef6\u4e86\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u9700\u8981\u56de\u4e3b\u952e\u7d22\u5f15\u53d6\u4e00\u6b21\u6570\u636e\uff0c\u6240\u4ee5\u7cfb\u7edf\u8ba4\u4e3a\u53ea\u626b\u63cf\u4e86\u4e00\u884c\u3002</p>\n<p><strong>\u5982\u679c\u4f7f\u7528\u7684\u662f index2</strong>\uff08\u5373 email(6) \u7d22\u5f15\u7ed3\u6784\uff09\uff0c\u6267\u884c\u987a\u5e8f\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4ece index2 \u7d22\u5f15\u6811\u627e\u5230\u6ee1\u8db3\u7d22\u5f15\u503c\u662f <code>zhangs</code> \u7684\u8bb0\u5f55\uff0c\u627e\u5230\u7684\u7b2c\u4e00\u4e2a\u662f ID1\uff1b</li>\n<li>\u5230\u4e3b\u952e\u4e0a\u67e5\u5230\u4e3b\u952e\u503c\u662f ID1 \u7684\u884c\uff0c\u5224\u65ad\u51fa email \u7684\u503c\u4e0d\u662f <code>zhangssxyz@xxx.com</code>\uff0c\u8fd9\u884c\u8bb0\u5f55\u4e22\u5f03\uff1b</li>\n<li>\u53d6 index2 \u4e0a\u521a\u521a\u67e5\u5230\u7684\u4f4d\u7f6e\u7684\u4e0b\u4e00\u6761\u8bb0\u5f55\uff0c\u53d1\u73b0\u4ecd\u7136\u662f <code>zhangs</code>\uff0c\u53d6\u51fa ID2\uff0c\u518d\u5230 ID \u7d22\u5f15\u4e0a\u53d6\u6574\u884c\u7136\u540e\u5224\u65ad\uff0c\u8fd9\u6b21\u503c\u5bf9\u4e86\uff0c\u5c06\u8fd9\u884c\u8bb0\u5f55\u52a0\u5165\u7ed3\u679c\u96c6\uff1b</li>\n<li>\u91cd\u590d\u4e0a\u4e00\u6b65\uff0c\u76f4\u5230\u5728 idxe2 \u4e0a\u53d6\u5230\u7684\u503c\u4e0d\u662f <code>zhangs</code> \u65f6\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u8981\u56de\u4e3b\u952e\u7d22\u5f15\u53d6 4 \u6b21\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u626b\u63cf\u4e86 4 \u884c\u3002</p>\n<p>\u901a\u8fc7\u8fd9\u4e2a\u5bf9\u6bd4\uff0c\u4f60\u5f88\u5bb9\u6613\u5c31\u53ef\u4ee5\u53d1\u73b0\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u540e\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u67e5\u8be2\u8bed\u53e5\u8bfb\u6570\u636e\u7684\u6b21\u6570\u53d8\u591a\u3002</p>\n<p>\u4f46\u662f\uff0c\u5bf9\u4e8e\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u5b9a\u4e49\u7684 index2 \u4e0d\u662f email(6) \u800c\u662f email(7\uff09\uff0c\u4e5f\u5c31\u662f\u8bf4\u53d6 email \u5b57\u6bb5\u7684\u524d 7 \u4e2a\u5b57\u8282\u6765\u6784\u5efa\u7d22\u5f15\u7684\u8bdd\uff0c\u5373\u6ee1\u8db3\u524d\u7f00 <code>zhangss</code> \u7684\u8bb0\u5f55\u53ea\u6709\u4e00\u4e2a\uff0c\u4e5f\u80fd\u591f\u76f4\u63a5\u67e5\u5230 ID2\uff0c\u53ea\u626b\u63cf\u4e00\u884c\u5c31\u7ed3\u675f\u4e86\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4**\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\uff0c\u5b9a\u4e49\u597d\u957f\u5ea6\uff0c\u5c31\u53ef\u4ee5\u505a\u5230\u65e2\u8282\u7701\u7a7a\u95f4\uff0c\u53c8\u4e0d\u7528\u989d\u5916\u589e\u52a0\u592a\u591a\u7684\u67e5\u8be2\u6210\u672c\u3002**</p>\n<p>\u4e8e\u662f\uff0c\u4f60\u5c31\u6709\u4e2a\u95ee\u9898\uff1a\u5f53\u8981\u7ed9\u5b57\u7b26\u4e32\u521b\u5efa\u524d\u7f00\u7d22\u5f15\u65f6\uff0c\u6709\u4ec0\u4e48\u65b9\u6cd5\u80fd\u591f\u786e\u5b9a\u6211\u5e94\u8be5\u4f7f\u7528\u591a\u957f\u7684\u524d\u7f00\u5462\uff1f</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5728\u5efa\u7acb\u7d22\u5f15\u65f6\u5173\u6ce8\u7684\u662f\u533a\u5206\u5ea6\uff0c\u533a\u5206\u5ea6\u8d8a\u9ad8\u8d8a\u597d\u3002\u56e0\u4e3a\u533a\u5206\u5ea6\u8d8a\u9ad8\uff0c\u610f\u5473\u7740\u91cd\u590d\u7684\u952e\u503c\u8d8a\u5c11\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7edf\u8ba1\u7d22\u5f15\u4e0a\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u503c\u6765\u5224\u65ad\u8981\u4f7f\u7528\u591a\u957f\u7684\u524d\u7f00\u3002</p>\n<p>\u9996\u5148\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7b97\u51fa\u8fd9\u4e2a\u5217\u4e0a\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u503c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"k\">distinct</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u4f9d\u6b21\u9009\u53d6\u4e0d\u540c\u957f\u5ea6\u7684\u524d\u7f00\u6765\u770b\u8fd9\u4e2a\u503c\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u770b\u4e00\u4e0b 4~7 \u4e2a\u5b57\u8282\u7684\u524d\u7f00\u7d22\u5f15\uff0c\u53ef\u4ee5\u7528\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"k\">distinct</span><span class=\"w\"> </span><span class=\"k\">left</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"err\">\uff09</span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">L4</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"k\">distinct</span><span class=\"w\"> </span><span class=\"k\">left</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"err\">\uff09</span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">L5</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"k\">distinct</span><span class=\"w\"> </span><span class=\"k\">left</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">)</span><span class=\"err\">\uff09</span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">L6</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"k\">distinct</span><span class=\"w\"> </span><span class=\"k\">left</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"p\">)</span><span class=\"err\">\uff09</span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">L7</span><span class=\"p\">,</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5f53\u7136\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u5f88\u53ef\u80fd\u4f1a\u635f\u5931\u533a\u5206\u5ea6\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u9884\u5148\u8bbe\u5b9a\u4e00\u4e2a\u53ef\u4ee5\u63a5\u53d7\u7684\u635f\u5931\u6bd4\u4f8b\uff0c\u6bd4\u5982 5%\u3002\u7136\u540e\uff0c\u5728\u8fd4\u56de\u7684 L4~L7 \u4e2d\uff0c\u627e\u51fa\u4e0d\u5c0f\u4e8e L * 95% \u7684\u503c\uff0c\u5047\u8bbe\u8fd9\u91cc L6\u3001L7 \u90fd\u6ee1\u8db3\uff0c\u4f60\u5c31\u53ef\u4ee5\u9009\u62e9\u524d\u7f00\u957f\u5ea6\u4e3a 6\u3002</p>\n<h3 id=\"_4\">\u524d\u7f00\u7d22\u5f15\u5bf9\u8986\u76d6\u7d22\u5f15\u7684\u5f71\u54cd<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u6211\u4eec\u8bf4\u4e86\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u53ef\u80fd\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\uff0c\u8fd9\u4f1a\u5f71\u54cd\u5230\u6027\u80fd\u3002\u5176\u5b9e\uff0c\u524d\u7f00\u7d22\u5f15\u7684\u5f71\u54cd\u4e0d\u6b62\u5982\u6b64\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u53e6\u5916\u4e00\u4e2a\u573a\u666f\u3002</p>\n<p>\u4f60\u5148\u6765\u770b\u770b\u8fd9\u4e2a SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"o\">=</span><span class=\"s1\">&#39;zhangssxyz@xxx.com&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4e0e\u524d\u9762\u4f8b\u5b50\u4e2d\u7684 SQL \u8bed\u53e5</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">SUser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">email</span><span class=\"o\">=</span><span class=\"s1\">&#39;zhangssxyz@xxx.com&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u76f8\u6bd4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u53ea\u8981\u6c42\u8fd4\u56de id \u548c email \u5b57\u6bb5\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u4f7f\u7528 index1\uff08\u5373 email \u6574\u4e2a\u5b57\u7b26\u4e32\u7684\u7d22\u5f15\u7ed3\u6784\uff09\u7684\u8bdd\uff0c\u53ef\u4ee5\u5229\u7528\u8986\u76d6\u7d22\u5f15\uff0c\u4ece index1 \u67e5\u5230\u7ed3\u679c\u540e\u76f4\u63a5\u5c31\u8fd4\u56de\u4e86\uff0c\u4e0d\u9700\u8981\u56de\u5230 ID \u7d22\u5f15\u518d\u53bb\u67e5\u4e00\u6b21\u3002\u800c\u5982\u679c\u4f7f\u7528 index2\uff08\u5373 email(6) \u7d22\u5f15\u7ed3\u6784\uff09\u7684\u8bdd\uff0c\u5c31\u4e0d\u5f97\u4e0d\u56de\u5230 ID \u7d22\u5f15\u518d\u53bb\u5224\u65ad email \u5b57\u6bb5\u7684\u503c\u3002</p>\n<p>\u5373\u4f7f\u4f60\u5c06 index2 \u7684\u5b9a\u4e49\u4fee\u6539\u4e3a <code>email(18)</code> \u7684\u524d\u7f00\u7d22\u5f15\uff0c\u8fd9\u65f6\u5019\u867d\u7136 index2 \u5df2\u7ecf\u5305\u542b\u4e86\u6240\u6709\u7684\u4fe1\u606f\uff0c\u4f46 InnoDB \u8fd8\u662f\u8981\u56de\u5230 id \u7d22\u5f15\u518d\u67e5\u4e00\u4e0b\uff0c\u56e0\u4e3a\u7cfb\u7edf\u5e76\u4e0d\u786e\u5b9a\u524d\u7f00\u7d22\u5f15\u7684\u5b9a\u4e49\u662f\u5426\u622a\u65ad\u4e86\u5b8c\u6574\u4fe1\u606f\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u5c31\u7528\u4e0d\u4e0a\u8986\u76d6\u7d22\u5f15\u5bf9\u67e5\u8be2\u6027\u80fd\u7684\u4f18\u5316\u4e86\uff0c\u8fd9\u4e5f\u662f\u4f60\u5728\u9009\u62e9\u662f\u5426\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u65f6\u9700\u8981\u8003\u8651\u7684\u4e00\u4e2a\u56e0\u7d20\u3002</p>\n<h3 id=\"_5\">\u5176\u4ed6\u65b9\u5f0f<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e\u90ae\u7bb1\u8fd9\u6837\u7684\u5b57\u6bb5\u6765\u8bf4\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u7684\u6548\u679c\u53ef\u80fd\u8fd8\u4e0d\u9519\u3002\u4f46\u662f\uff0c\u9047\u5230\u524d\u7f00\u7684\u533a\u5206\u5ea6\u4e0d\u591f\u597d\u7684\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u8981\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>\u6bd4\u5982\uff0c\u6211\u4eec\u56fd\u5bb6\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u4e00\u5171 18 \u4f4d\uff0c\u5176\u4e2d\u524d 6 \u4f4d\u662f\u5730\u5740\u7801\uff0c\u6240\u4ee5\u540c\u4e00\u4e2a\u53bf\u7684\u4eba\u7684\u8eab\u4efd\u8bc1\u53f7\u524d 6 \u4f4d\u4e00\u822c\u4f1a\u662f\u76f8\u540c\u7684\u3002</p>\n<p>\u5047\u8bbe\u4f60\u7ef4\u62a4\u7684\u6570\u636e\u5e93\u662f\u4e00\u4e2a\u5e02\u7684\u516c\u6c11\u4fe1\u606f\u7cfb\u7edf\uff0c\u8fd9\u65f6\u5019\u5982\u679c\u5bf9\u8eab\u4efd\u8bc1\u53f7\u505a\u957f\u5ea6\u4e3a 6 \u7684\u524d\u7f00\u7d22\u5f15\u7684\u8bdd\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u5c31\u975e\u5e38\u4f4e\u4e86\u3002</p>\n<p>\u6309\u7167\u6211\u4eec\u524d\u9762\u8bf4\u7684\u65b9\u6cd5\uff0c\u53ef\u80fd\u4f60\u9700\u8981\u521b\u5efa\u957f\u5ea6\u4e3a 12 \u4ee5\u4e0a\u7684\u524d\u7f00\u7d22\u5f15\uff0c\u624d\u80fd\u591f\u6ee1\u8db3\u533a\u5206\u5ea6\u8981\u6c42\u3002</p>\n<p>\u4f46\u662f\uff0c\u7d22\u5f15\u9009\u53d6\u7684\u8d8a\u957f\uff0c\u5360\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u5c31\u8d8a\u5927\uff0c\u76f8\u540c\u7684\u6570\u636e\u9875\u80fd\u653e\u4e0b\u7684\u7d22\u5f15\u503c\u5c31\u8d8a\u5c11\uff0c\u641c\u7d22\u7684\u6548\u7387\u4e5f\u5c31\u4f1a\u8d8a\u4f4e\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u80fd\u591f\u786e\u5b9a\u4e1a\u52a1\u9700\u6c42\u91cc\u9762\u53ea\u6709\u6309\u7167\u8eab\u4efd\u8bc1\u8fdb\u884c\u7b49\u503c\u67e5\u8be2\u7684\u9700\u6c42\uff0c\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u5904\u7406\u65b9\u6cd5\u5462\uff1f\u8fd9\u79cd\u65b9\u6cd5\uff0c\u65e2\u53ef\u4ee5\u5360\u7528\u66f4\u5c0f\u7684\u7a7a\u95f4\uff0c\u4e5f\u80fd\u8fbe\u5230\u76f8\u540c\u7684\u67e5\u8be2\u6548\u7387\u3002</p>\n<p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p>\n<p><strong>\u7b2c\u4e00\u79cd\u65b9\u5f0f\u662f\u4f7f\u7528\u5012\u5e8f\u5b58\u50a8</strong>\u3002\u5982\u679c\u4f60\u5b58\u50a8\u8eab\u4efd\u8bc1\u53f7\u7684\u65f6\u5019\u628a\u5b83\u5012\u8fc7\u6765\u5b58\uff0c\u6bcf\u6b21\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">field_list</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id_card</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;input_id_card_string&#39;</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u7531\u4e8e\u8eab\u4efd\u8bc1\u53f7\u7684\u6700\u540e 6 \u4f4d\u6ca1\u6709\u5730\u5740\u7801\u8fd9\u6837\u7684\u91cd\u590d\u903b\u8f91\uff0c\u6240\u4ee5\u6700\u540e\u8fd9 6 \u4f4d\u5f88\u53ef\u80fd\u5c31\u63d0\u4f9b\u4e86\u8db3\u591f\u7684\u533a\u5206\u5ea6\u3002\u5f53\u7136\u4e86\uff0c\u5b9e\u8df5\u4e2d\u4f60\u4e0d\u8981\u5fd8\u8bb0\u4f7f\u7528 <code>count(distinct)</code> \u65b9\u6cd5\u53bb\u505a\u4e2a\u9a8c\u8bc1\u3002</p>\n<p><strong>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\u4f7f\u7528 hash \u5b57\u6bb5</strong>\u3002\u4f60\u53ef\u4ee5\u5728\u8868\u4e0a\u518d\u521b\u5efa\u4e00\u4e2a\u6574\u6570\u5b57\u6bb5\uff0c\u6765\u4fdd\u5b58\u8eab\u4efd\u8bc1\u7684\u6821\u9a8c\u7801\uff0c\u540c\u65f6\u5728\u8fd9\u4e2a\u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"n\">id_card_crc</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">id_card_crc</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u7136\u540e\u6bcf\u6b21\u63d2\u5165\u65b0\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u90fd\u540c\u65f6\u7528 <code>crc32()</code> \u8fd9\u4e2a\u51fd\u6570\u5f97\u5230\u6821\u9a8c\u7801\u586b\u5230\u8fd9\u4e2a\u65b0\u5b57\u6bb5\u3002\u7531\u4e8e\u6821\u9a8c\u7801\u53ef\u80fd\u5b58\u5728\u51b2\u7a81\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e24\u4e2a\u4e0d\u540c\u7684\u8eab\u4efd\u8bc1\u53f7\u901a\u8fc7 <code>crc32()</code> \u51fd\u6570\u5f97\u5230\u7684\u7ed3\u679c\u53ef\u80fd\u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u4f60\u7684\u67e5\u8be2\u8bed\u53e5 where \u90e8\u5206\u8981\u5224\u65ad id_card \u7684\u503c\u662f\u5426\u7cbe\u786e\u76f8\u540c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">field_list</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id_card_crc</span><span class=\"o\">=</span><span class=\"n\">crc32</span><span class=\"p\">(</span><span class=\"s1\">&#39;input_id_card_string&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">id_card</span><span class=\"o\">=</span><span class=\"s1\">&#39;input_id_card_string&#39;</span>\n</code></pre></div>\n<p>\u8fd9\u6837\uff0c\u7d22\u5f15\u7684\u957f\u5ea6\u53d8\u6210\u4e86 4 \u4e2a\u5b57\u8282\uff0c\u6bd4\u539f\u6765\u5c0f\u4e86\u5f88\u591a\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b**\u4f7f\u7528\u5012\u5e8f\u5b58\u50a8\u548c\u4f7f\u7528 hash \u5b57\u6bb5\u8fd9\u4e24\u79cd\u65b9\u6cd5\u7684\u5f02\u540c\u70b9\u3002**</p>\n<p>\u9996\u5148\uff0c\u5b83\u4eec\u7684\u76f8\u540c\u70b9\u662f\uff0c\u90fd\u4e0d\u652f\u6301\u8303\u56f4\u67e5\u8be2\u3002\u5012\u5e8f\u5b58\u50a8\u7684\u5b57\u6bb5\u4e0a\u521b\u5efa\u7684\u7d22\u5f15\u662f\u6309\u7167\u5012\u5e8f\u5b57\u7b26\u4e32\u7684\u65b9\u5f0f\u6392\u5e8f\u7684\uff0c\u5df2\u7ecf\u6ca1\u6709\u529e\u6cd5\u5229\u7528\u7d22\u5f15\u65b9\u5f0f\u67e5\u51fa\u8eab\u4efd\u8bc1\u53f7\u7801\u5728 <code>[ID_X, ID_Y]</code> \u7684\u6240\u6709\u5e02\u6c11\u4e86\u3002\u540c\u6837\u5730\uff0chash \u5b57\u6bb5\u7684\u65b9\u5f0f\u4e5f\u53ea\u80fd\u652f\u6301\u7b49\u503c\u67e5\u8be2\u3002</p>\n<p>\u5b83\u4eec\u7684\u533a\u522b\uff0c\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u4e09\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>\u4ece\u5360\u7528\u7684\u989d\u5916\u7a7a\u95f4\u6765\u770b\uff0c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u4e0d\u4f1a\u6d88\u8017\u989d\u5916\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u800c hash \u5b57\u6bb5\u65b9\u6cd5\u9700\u8981\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\u3002\u5f53\u7136\uff0c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u4f7f\u7528 4 \u4e2a\u5b57\u8282\u7684\u524d\u7f00\u957f\u5ea6\u5e94\u8be5\u662f\u4e0d\u591f\u7684\uff0c\u5982\u679c\u518d\u957f\u4e00\u70b9\uff0c\u8fd9\u4e2a\u6d88\u8017\u8ddf\u989d\u5916\u8fd9\u4e2a hash \u5b57\u6bb5\u4e5f\u5dee\u4e0d\u591a\u62b5\u6d88\u4e86\u3002</li>\n<li>\u5728 CPU \u6d88\u8017\u65b9\u9762\uff0c\u5012\u5e8f\u65b9\u5f0f\u6bcf\u6b21\u5199\u548c\u8bfb\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u989d\u5916\u8c03\u7528\u4e00\u6b21 reverse \u51fd\u6570\uff0c\u800c hash \u5b57\u6bb5\u7684\u65b9\u5f0f\u9700\u8981\u989d\u5916\u8c03\u7528\u4e00\u6b21 crc32() \u51fd\u6570\u3002\u5982\u679c\u53ea\u4ece\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u8ba1\u7b97\u590d\u6742\u5ea6\u6765\u770b\u7684\u8bdd\uff0creverse \u51fd\u6570\u989d\u5916\u6d88\u8017\u7684 CPU \u8d44\u6e90\u4f1a\u66f4\u5c0f\u4e9b\u3002</li>\n<li>\u4ece\u67e5\u8be2\u6548\u7387\u4e0a\u770b\uff0c\u4f7f\u7528 hash \u5b57\u6bb5\u65b9\u5f0f\u7684\u67e5\u8be2\u6027\u80fd\u76f8\u5bf9\u66f4\u7a33\u5b9a\u4e00\u4e9b\u3002\u56e0\u4e3a crc32 \u7b97\u51fa\u6765\u7684\u503c\u867d\u7136\u6709\u51b2\u7a81\u7684\u6982\u7387\uff0c\u4f46\u662f\u6982\u7387\u975e\u5e38\u5c0f\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u6bcf\u6b21\u67e5\u8be2\u7684\u5e73\u5747\u626b\u63cf\u884c\u6570\u63a5\u8fd1 1\u3002\u800c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u6bd5\u7adf\u8fd8\u662f\u7528\u7684\u524d\u7f00\u7d22\u5f15\u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd8\u662f\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\u3002</li>\n</ol>\n<h3 id=\"_6\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u804a\u4e86\u804a\u5b57\u7b26\u4e32\u5b57\u6bb5\u521b\u5efa\u7d22\u5f15\u7684\u573a\u666f\u3002\u6211\u4eec\u6765\u56de\u987e\u4e00\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684\u65b9\u5f0f\u6709\uff1a</p>\n<ol>\n<li>\u76f4\u63a5\u521b\u5efa\u5b8c\u6574\u7d22\u5f15\uff0c\u8fd9\u6837\u53ef\u80fd\u6bd4\u8f83\u5360\u7528\u7a7a\u95f4\uff1b</li>\n<li>\u521b\u5efa\u524d\u7f00\u7d22\u5f15\uff0c\u8282\u7701\u7a7a\u95f4\uff0c\u4f46\u4f1a\u589e\u52a0\u67e5\u8be2\u626b\u63cf\u6b21\u6570\uff0c\u5e76\u4e14\u4e0d\u80fd\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\uff1b</li>\n<li>\u5012\u5e8f\u5b58\u50a8\uff0c\u518d\u521b\u5efa\u524d\u7f00\u7d22\u5f15\uff0c\u7528\u4e8e\u7ed5\u8fc7\u5b57\u7b26\u4e32\u672c\u8eab\u524d\u7f00\u7684\u533a\u5206\u5ea6\u4e0d\u591f\u7684\u95ee\u9898\uff1b</li>\n<li>\u521b\u5efa hash \u5b57\u6bb5\u7d22\u5f15\uff0c\u67e5\u8be2\u6027\u80fd\u7a33\u5b9a\uff0c\u6709\u989d\u5916\u7684\u5b58\u50a8\u548c\u8ba1\u7b97\u6d88\u8017\uff0c\u8ddf\u7b2c\u4e09\u79cd\u65b9\u5f0f\u4e00\u6837\uff0c\u90fd\u4e0d\u652f\u6301\u8303\u56f4\u626b\u63cf\u3002</li>\n</ol>\n<p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u4f60\u8981\u6839\u636e\u4e1a\u52a1\u5b57\u6bb5\u7684\u7279\u70b9\u9009\u62e9\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\u3002</p>\n<h2 id=\"12-mysql\">12 \u4e3a\u4ec0\u4e48\u6211\u7684MySQL\u4f1a\u201c\u6296\u201d\u4e00\u4e0b\uff1f<a class=\"headerlink\" href=\"#12-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5e73\u65f6\u7684\u5de5\u4f5c\u4e2d\uff0c\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u573a\u666f\uff0c\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u6b63\u5e38\u6267\u884c\u7684\u65f6\u5019\u7279\u522b\u5feb\uff0c\u4f46\u662f\u6709\u65f6\u4e5f\u4e0d\u77e5\u9053\u600e\u4e48\u56de\u4e8b\uff0c\u5b83\u5c31\u4f1a\u53d8\u5f97\u7279\u522b\u6162\uff0c\u5e76\u4e14\u8fd9\u6837\u7684\u573a\u666f\u5f88\u96be\u590d\u73b0\uff0c\u5b83\u4e0d\u53ea\u968f\u673a\uff0c\u800c\u4e14\u6301\u7eed\u65f6\u95f4\u8fd8\u5f88\u77ed\u3002</p>\n<p>\u770b\u4e0a\u53bb\uff0c\u8fd9\u5c31\u50cf\u662f\u6570\u636e\u5e93\u201c\u6296\u201d\u4e86\u4e00\u4e0b\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u770b\u4e00\u770b\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p>\n<h3 id=\"sql\">\u4f60\u7684 SQL \u8bed\u53e5\u4e3a\u4ec0\u4e48\u53d8\u201c\u6162\u201d\u4e86<a class=\"headerlink\" href=\"#sql\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u524d\u9762\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\uff0c\u6211\u4e3a\u4f60\u4ecb\u7ecd\u4e86 WAL \u673a\u5236\u3002\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0cInnoDB \u5728\u5904\u7406\u66f4\u65b0\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u53ea\u505a\u4e86\u5199\u65e5\u5fd7\u8fd9\u4e00\u4e2a\u78c1\u76d8\u64cd\u4f5c\u3002\u8fd9\u4e2a\u65e5\u5fd7\u53eb\u4f5c redo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\uff0c\u4e5f\u5c31\u662f\u300a\u5b54\u4e59\u5df1\u300b\u91cc\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7528\u6765\u8bb0\u8d26\u7684\u7c89\u677f\uff0c\u5728\u66f4\u65b0\u5185\u5b58\u5199\u5b8c redo log \u540e\uff0c\u5c31\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u672c\u6b21\u66f4\u65b0\u6210\u529f\u3002</p>\n<p>\u505a\u4e0b\u7c7b\u6bd4\u7684\u8bdd\uff0c\u638c\u67dc\u8bb0\u8d26\u7684\u8d26\u672c\u662f\u6570\u636e\u6587\u4ef6\uff0c\u8bb0\u8d26\u7528\u7684\u7c89\u677f\u662f\u65e5\u5fd7\u6587\u4ef6\uff08redo log\uff09\uff0c\u638c\u67dc\u7684\u8bb0\u5fc6\u5c31\u662f\u5185\u5b58\u3002</p>\n<p>\u638c\u67dc\u603b\u8981\u627e\u65f6\u95f4\u628a\u8d26\u672c\u66f4\u65b0\u4e00\u4e0b\uff0c\u8fd9\u5bf9\u5e94\u7684\u5c31\u662f\u628a\u5185\u5b58\u91cc\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u672f\u8bed\u5c31\u662f flush\u3002\u5728\u8fd9\u4e2a flush \u64cd\u4f5c\u6267\u884c\u4e4b\u524d\uff0c\u5b54\u4e59\u5df1\u7684\u8d4a\u8d26\u603b\u989d\uff0c\u5176\u5b9e\u8ddf\u638c\u67dc\u624b\u4e2d\u8d26\u672c\u91cc\u9762\u7684\u8bb0\u5f55\u662f\u4e0d\u4e00\u81f4\u7684\u3002\u56e0\u4e3a\u5b54\u4e59\u5df1\u4eca\u5929\u7684\u8d4a\u8d26\u91d1\u989d\u8fd8\u53ea\u5728\u7c89\u677f\u4e0a\uff0c\u800c\u8d26\u672c\u91cc\u7684\u8bb0\u5f55\u662f\u8001\u7684\uff0c\u8fd8\u6ca1\u628a\u4eca\u5929\u7684\u8d4a\u8d26\u7b97\u8fdb\u53bb\u3002</p>\n<p><strong>\u5f53\u5185\u5b58\u6570\u636e\u9875\u8ddf\u78c1\u76d8\u6570\u636e\u9875\u5185\u5bb9\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u79f0\u8fd9\u4e2a\u5185\u5b58\u9875\u4e3a\u201c\u810f\u9875\u201d\u3002\u5185\u5b58\u6570\u636e\u5199\u5165\u5230\u78c1\u76d8\u540e\uff0c\u5185\u5b58\u548c\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u9875\u7684\u5185\u5bb9\u5c31\u4e00\u81f4\u4e86\uff0c\u79f0\u4e3a\u201c\u5e72\u51c0\u9875\u201d</strong>\u3002</p>\n<p>\u4e0d\u8bba\u662f\u810f\u9875\u8fd8\u662f\u5e72\u51c0\u9875\uff0c\u90fd\u5728\u5185\u5b58\u4e2d\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5185\u5b58\u5bf9\u5e94\u7684\u5c31\u662f\u638c\u67dc\u7684\u8bb0\u5fc6\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u793a\u610f\u56fe\u6765\u5c55\u793a\u4e00\u4e0b\u201c\u5b54\u4e59\u5df1\u8d4a\u8d26\u201d\u7684\u6574\u4e2a\u64cd\u4f5c\u8fc7\u7a0b\u3002\u5047\u8bbe\u539f\u6765\u5b54\u4e59\u5df1\u6b20\u8d26 10 \u6587\uff0c\u8fd9\u6b21\u53c8\u8981\u8d4a 9 \u6587\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/349cfab9e4f5d2a75e07b2132a301fda.jpeg\" /></p>\n<p>\u56fe 1 \u201c\u5b54\u4e59\u5df1\u8d4a\u8d26\u201d\u66f4\u65b0\u548c flush \u8fc7\u7a0b</p>\n<p>\u56de\u5230\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u4f60\u4e0d\u96be\u60f3\u8c61\uff0c\u5e73\u65f6\u6267\u884c\u5f88\u5feb\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u5176\u5b9e\u5c31\u662f\u5728\u5199\u5185\u5b58\u548c\u65e5\u5fd7\uff0c\u800c MySQL \u5076\u5c14\u201c\u6296\u201d\u4e00\u4e0b\u7684\u90a3\u4e2a\u77ac\u95f4\uff0c\u53ef\u80fd\u5c31\u662f\u5728\u5237\u810f\u9875\uff08flush\uff09\u3002</p>\n<p>\u90a3\u4e48\uff0c\u4ec0\u4e48\u60c5\u51b5\u4f1a\u5f15\u53d1\u6570\u636e\u5e93\u7684 flush \u8fc7\u7a0b\u5462\uff1f</p>\n<p>\u6211\u4eec\u8fd8\u662f\u7ee7\u7eed\u7528\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u60f3\u4e00\u60f3\uff1a\u638c\u67dc\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u628a\u7c89\u677f\u4e0a\u7684\u8d4a\u8d26\u8bb0\u5f55\u6539\u5230\u8d26\u672c\u4e0a\uff1f</p>\n<ul>\n<li>\u7b2c\u4e00\u79cd\u573a\u666f\u662f\uff0c\u7c89\u677f\u6ee1\u4e86\uff0c\u8bb0\u4e0d\u4e0b\u4e86\u3002\u8fd9\u65f6\u5019\u5982\u679c\u518d\u6709\u4eba\u6765\u8d4a\u8d26\uff0c\u638c\u67dc\u5c31\u53ea\u5f97\u653e\u4e0b\u624b\u91cc\u7684\u6d3b\u513f\uff0c\u5c06\u7c89\u677f\u4e0a\u7684\u8bb0\u5f55\u64e6\u6389\u4e00\u4e9b\uff0c\u7559\u51fa\u7a7a\u4f4d\u4ee5\u4fbf\u7ee7\u7eed\u8bb0\u8d26\u3002\u5f53\u7136\u5728\u64e6\u6389\u4e4b\u524d\uff0c\u4ed6\u5fc5\u987b\u5148\u5c06\u6b63\u786e\u7684\u8d26\u76ee\u8bb0\u5f55\u5230\u8d26\u672c\u4e2d\u624d\u884c\u3002 \u8fd9\u4e2a\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f InnoDB \u7684 redo log \u5199\u6ee1\u4e86\u3002\u8fd9\u65f6\u5019\u7cfb\u7edf\u4f1a\u505c\u6b62\u6240\u6709\u66f4\u65b0\u64cd\u4f5c\uff0c\u628a checkpoint \u5f80\u524d\u63a8\u8fdb\uff0credo log \u7559\u51fa\u7a7a\u95f4\u53ef\u4ee5\u7ee7\u7eed\u5199\u3002\u6211\u5728\u7b2c\u4e8c\u8bb2\u753b\u4e86\u4e00\u4e2a redo log \u7684\u793a\u610f\u56fe\uff0c\u8fd9\u91cc\u6211\u6539\u6210\u73af\u5f62\uff0c\u4fbf\u4e8e\u5927\u5bb6\u7406\u89e3\u3002</li>\n</ul>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/a25bdbbfc2cfc5d5e20690547fe7f2e5.jpg\" /></p>\n<p>\u56fe 2 redo log \u72b6\u6001\u56fe</p>\n<p>checkpoint \u53ef\u4e0d\u662f\u968f\u4fbf\u5f80\u524d\u4fee\u6539\u4e00\u4e0b\u4f4d\u7f6e\u5c31\u53ef\u4ee5\u7684\u3002\u6bd4\u5982\u56fe 2 \u4e2d\uff0c\u628a checkpoint \u4f4d\u7f6e\u4ece CP \u63a8\u8fdb\u5230 CP\u2019\uff0c\u5c31\u9700\u8981\u5c06\u4e24\u4e2a\u70b9\u4e4b\u95f4\u7684\u65e5\u5fd7\uff08\u6d45\u7eff\u8272\u90e8\u5206\uff09\uff0c\u5bf9\u5e94\u7684\u6240\u6709\u810f\u9875\u90fd flush \u5230\u78c1\u76d8\u4e0a\u3002\u4e4b\u540e\uff0c\u56fe\u4e2d\u4ece write pos \u5230 CP\u2019\u4e4b\u95f4\u5c31\u662f\u53ef\u4ee5\u518d\u5199\u5165\u7684 redo log \u7684\u533a\u57df\u3002</p>\n<ul>\n<li>\u7b2c\u4e8c\u79cd\u573a\u666f\u662f\uff0c\u8fd9\u4e00\u5929\u751f\u610f\u592a\u597d\uff0c\u8981\u8bb0\u4f4f\u7684\u4e8b\u60c5\u592a\u591a\uff0c\u638c\u67dc\u53d1\u73b0\u81ea\u5df1\u5feb\u8bb0\u4e0d\u4f4f\u4e86\uff0c\u8d76\u7d27\u627e\u51fa\u8d26\u672c\u628a\u5b54\u4e59\u5df1\u8fd9\u7b14\u8d26\u5148\u52a0\u8fdb\u53bb\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u7cfb\u7edf\u5185\u5b58\u4e0d\u8db3\u3002\u5f53\u9700\u8981\u65b0\u7684\u5185\u5b58\u9875\uff0c\u800c\u5185\u5b58\u4e0d\u591f\u7528\u7684\u65f6\u5019\uff0c\u5c31\u8981\u6dd8\u6c70\u4e00\u4e9b\u6570\u636e\u9875\uff0c\u7a7a\u51fa\u5185\u5b58\u7ed9\u522b\u7684\u6570\u636e\u9875\u4f7f\u7528\u3002\u5982\u679c\u6dd8\u6c70\u7684\u662f\u201c\u810f\u9875\u201d\uff0c\u5c31\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u3002 \u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u65f6\u5019\u96be\u9053\u4e0d\u80fd\u76f4\u63a5\u628a\u5185\u5b58\u6dd8\u6c70\u6389\uff0c\u4e0b\u6b21\u9700\u8981\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u9875\uff0c\u7136\u540e\u62ff redo log \u51fa\u6765\u5e94\u7528\u4e0d\u5c31\u884c\u4e86\uff1f\u8fd9\u91cc\u5176\u5b9e\u662f\u4ece\u6027\u80fd\u8003\u8651\u7684\u3002\u5982\u679c\u5237\u810f\u9875\u4e00\u5b9a\u4f1a\u5199\u76d8\uff0c\u5c31\u4fdd\u8bc1\u4e86\u6bcf\u4e2a\u6570\u636e\u9875\u6709\u4e24\u79cd\u72b6\u6001\uff1a </li>\n<li>\u4e00\u79cd\u662f\u5185\u5b58\u91cc\u5b58\u5728\uff0c\u5185\u5b58\u91cc\u5c31\u80af\u5b9a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b</li>\n<li>\u53e6\u4e00\u79cd\u662f\u5185\u5b58\u91cc\u6ca1\u6709\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u80af\u5b9a\u6570\u636e\u6587\u4ef6\u4e0a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u8bfb\u5165\u5185\u5b58\u540e\u8fd4\u56de\u3002 \u8fd9\u6837\u7684\u6548\u7387\u6700\u9ad8\u3002</li>\n<li>\u7b2c\u4e09\u79cd\u573a\u666f\u662f\uff0c\u751f\u610f\u4e0d\u5fd9\u7684\u65f6\u5019\uff0c\u6216\u8005\u6253\u70ca\u4e4b\u540e\u3002\u8fd9\u65f6\u5019\u67dc\u53f0\u6ca1\u4e8b\uff0c\u638c\u67dc\u95f2\u7740\u4e5f\u662f\u95f2\u7740\uff0c\u4e0d\u5982\u66f4\u65b0\u8d26\u672c\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f MySQL \u8ba4\u4e3a\u7cfb\u7edf\u201c\u7a7a\u95f2\u201d\u7684\u65f6\u5019\u3002\u5f53\u7136\uff0cMySQL\u201c\u8fd9\u5bb6\u9152\u5e97\u201d\u7684\u751f\u610f\u597d\u8d77\u6765\u53ef\u662f\u4f1a\u5f88\u5feb\u5c31\u80fd\u628a\u7c89\u677f\u8bb0\u6ee1\u7684\uff0c\u6240\u4ee5\u201c\u638c\u67dc\u201d\u8981\u5408\u7406\u5730\u5b89\u6392\u65f6\u95f4\uff0c\u5373\u4f7f\u662f\u201c\u751f\u610f\u597d\u201d\u7684\u65f6\u5019\uff0c\u4e5f\u8981\u89c1\u7f1d\u63d2\u9488\u5730\u627e\u65f6\u95f4\uff0c\u53ea\u8981\u6709\u673a\u4f1a\u5c31\u5237\u4e00\u70b9\u201c\u810f\u9875\u201d\u3002</li>\n<li>\u7b2c\u56db\u79cd\u573a\u666f\u662f\uff0c\u5e74\u5e95\u4e86\u54b8\u4ea8\u9152\u5e97\u8981\u5173\u95e8\u51e0\u5929\uff0c\u9700\u8981\u628a\u8d26\u7ed3\u6e05\u4e00\u4e0b\u3002\u8fd9\u65f6\u5019\u638c\u67dc\u8981\u628a\u6240\u6709\u8d26\u90fd\u8bb0\u5230\u8d26\u672c\u4e0a\uff0c\u8fd9\u6837\u8fc7\u5b8c\u5e74\u91cd\u65b0\u5f00\u5f20\u7684\u65f6\u5019\uff0c\u5c31\u80fd\u5c31\u7740\u8d26\u672c\u660e\u786e\u8d26\u76ee\u60c5\u51b5\u4e86\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f MySQL \u6b63\u5e38\u5173\u95ed\u7684\u60c5\u51b5\u3002\u8fd9\u65f6\u5019\uff0cMySQL \u4f1a\u628a\u5185\u5b58\u7684\u810f\u9875\u90fd flush \u5230\u78c1\u76d8\u4e0a\uff0c\u8fd9\u6837\u4e0b\u6b21 MySQL \u542f\u52a8\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u78c1\u76d8\u4e0a\u8bfb\u6570\u636e\uff0c\u542f\u52a8\u901f\u5ea6\u4f1a\u5f88\u5feb\u3002</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\uff0c<strong>\u4f60\u53ef\u4ee5\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u56db\u79cd\u573a\u666f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u3002</strong></p>\n<p>\u5176\u4e2d\uff0c\u7b2c\u4e09\u79cd\u60c5\u51b5\u662f\u5c5e\u4e8e MySQL \u7a7a\u95f2\u65f6\u7684\u64cd\u4f5c\uff0c\u8fd9\u65f6\u7cfb\u7edf\u6ca1\u4ec0\u4e48\u538b\u529b\uff0c\u800c\u7b2c\u56db\u79cd\u573a\u666f\u662f\u6570\u636e\u5e93\u672c\u6765\u5c31\u8981\u5173\u95ed\u4e86\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e0d\u4f1a\u592a\u5173\u6ce8\u201c\u6027\u80fd\u201d\u95ee\u9898\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u6211\u4eec\u4e3b\u8981\u6765\u5206\u6790\u4e00\u4e0b\u524d\u4e24\u79cd\u573a\u666f\u4e0b\u7684\u6027\u80fd\u95ee\u9898\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u662f\u201credo log \u5199\u6ee1\u4e86\uff0c\u8981 flush \u810f\u9875\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u662f InnoDB \u8981\u5c3d\u91cf\u907f\u514d\u7684\u3002\u56e0\u4e3a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u65f6\u5019\uff0c\u6574\u4e2a\u7cfb\u7edf\u5c31\u4e0d\u80fd\u518d\u63a5\u53d7\u66f4\u65b0\u4e86\uff0c\u6240\u6709\u7684\u66f4\u65b0\u90fd\u5fc5\u987b\u5835\u4f4f\u3002\u5982\u679c\u4f60\u4ece\u76d1\u63a7\u4e0a\u770b\uff0c\u8fd9\u65f6\u5019\u66f4\u65b0\u6570\u4f1a\u8dcc\u4e3a 0\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u662f\u201c\u5185\u5b58\u4e0d\u591f\u7528\u4e86\uff0c\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u5176\u5b9e\u662f\u5e38\u6001\u3002<strong>InnoDB \u7528\u7f13\u51b2\u6c60\uff08buffer pool\uff09\u7ba1\u7406\u5185\u5b58\uff0c\u7f13\u51b2\u6c60\u4e2d\u7684\u5185\u5b58\u9875\u6709\u4e09\u79cd\u72b6\u6001\uff1a</strong></p>\n<ul>\n<li>\u7b2c\u4e00\u79cd\u662f\uff0c\u8fd8\u6ca1\u6709\u4f7f\u7528\u7684\uff1b</li>\n<li>\u7b2c\u4e8c\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u5e72\u51c0\u9875\uff1b</li>\n<li>\u7b2c\u4e09\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u810f\u9875\u3002</li>\n</ul>\n<p>InnoDB \u7684\u7b56\u7565\u662f\u5c3d\u91cf\u4f7f\u7528\u5185\u5b58\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4e00\u4e2a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u5e93\u6765\u8bf4\uff0c\u672a\u88ab\u4f7f\u7528\u7684\u9875\u9762\u5f88\u5c11\u3002</p>\n<p>\u800c\u5f53\u8981\u8bfb\u5165\u7684\u6570\u636e\u9875\u6ca1\u6709\u5728\u5185\u5b58\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u5230\u7f13\u51b2\u6c60\u4e2d\u7533\u8bf7\u4e00\u4e2a\u6570\u636e\u9875\u3002\u8fd9\u65f6\u5019\u53ea\u80fd\u628a\u6700\u4e45\u4e0d\u4f7f\u7528\u7684\u6570\u636e\u9875\u4ece\u5185\u5b58\u4e2d\u6dd8\u6c70\u6389\uff1a\u5982\u679c\u8981\u6dd8\u6c70\u7684\u662f\u4e00\u4e2a\u5e72\u51c0\u9875\uff0c\u5c31\u76f4\u63a5\u91ca\u653e\u51fa\u6765\u590d\u7528\uff1b\u4f46\u5982\u679c\u662f\u810f\u9875\u5462\uff0c\u5c31\u5fc5\u987b\u5c06\u810f\u9875\u5148\u5237\u5230\u78c1\u76d8\uff0c\u53d8\u6210\u5e72\u51c0\u9875\u540e\u624d\u80fd\u590d\u7528\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5237\u810f\u9875\u867d\u7136\u662f\u5e38\u6001\uff0c\u4f46\u662f\u51fa\u73b0\u4ee5\u4e0b\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u90fd\u662f\u4f1a\u660e\u663e\u5f71\u54cd\u6027\u80fd\u7684\uff1a</p>\n<ol>\n<li>\u4e00\u4e2a\u67e5\u8be2\u8981\u6dd8\u6c70\u7684\u810f\u9875\u4e2a\u6570\u592a\u591a\uff0c\u4f1a\u5bfc\u81f4\u67e5\u8be2\u7684\u54cd\u5e94\u65f6\u95f4\u660e\u663e\u53d8\u957f\uff1b</li>\n<li>\u65e5\u5fd7\u5199\u6ee1\uff0c\u66f4\u65b0\u5168\u90e8\u5835\u4f4f\uff0c\u5199\u6027\u80fd\u8dcc\u4e3a 0\uff0c\u8fd9\u79cd\u60c5\u51b5\u5bf9\u654f\u611f\u4e1a\u52a1\u6765\u8bf4\uff0c\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0cInnoDB \u9700\u8981\u6709\u63a7\u5236\u810f\u9875\u6bd4\u4f8b\u7684\u673a\u5236\uff0c\u6765\u5c3d\u91cf\u907f\u514d\u4e0a\u9762\u7684\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002</p>\n<h3 id=\"innodb\">InnoDB \u5237\u810f\u9875\u7684\u63a7\u5236\u7b56\u7565<a class=\"headerlink\" href=\"#innodb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u6765\u548c\u4f60\u8bf4\u8bf4 InnoDB \u810f\u9875\u7684\u63a7\u5236\u7b56\u7565\uff0c\u4ee5\u53ca\u548c\u8fd9\u4e9b\u7b56\u7565\u76f8\u5173\u7684\u53c2\u6570\u3002</p>\n<p>\u9996\u5148\uff0c\u4f60\u8981\u6b63\u786e\u5730\u544a\u8bc9 InnoDB \u6240\u5728\u4e3b\u673a\u7684 IO \u80fd\u529b\uff0c\u8fd9\u6837 InnoDB \u624d\u80fd\u77e5\u9053\u9700\u8981\u5168\u529b\u5237\u810f\u9875\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5237\u591a\u5feb\u3002</p>\n<p>\u8fd9\u5c31\u8981\u7528\u5230 <code>innodb_io_capacity</code> \u8fd9\u4e2a\u53c2\u6570\u4e86\uff0c\u5b83\u4f1a\u544a\u8bc9 InnoDB \u4f60\u7684\u78c1\u76d8\u80fd\u529b\u3002\u8fd9\u4e2a\u503c\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210\u78c1\u76d8\u7684 IOPS\u3002\u78c1\u76d8\u7684 IOPS \u53ef\u4ee5\u901a\u8fc7 fio \u8fd9\u4e2a\u5de5\u5177\u6765\u6d4b\u8bd5\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u662f\u6211\u7528\u6765\u6d4b\u8bd5\u78c1\u76d8\u968f\u673a\u8bfb\u5199\u7684\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">fio</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">filename</span><span class=\"o\">=</span><span class=\"n\">mytest</span><span class=\"p\">.</span><span class=\"n\">img</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">direct</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">iodepth</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">=</span><span class=\"n\">randrw</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">ioengine</span><span class=\"o\">=</span><span class=\"n\">psync</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">bs</span><span class=\"o\">=</span><span class=\"mi\">16</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"k\">size</span><span class=\"o\">=</span><span class=\"mi\">500</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">numjobs</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">group_reporting</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">mytest</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u5176\u5b9e\uff0c\u56e0\u4e3a\u6ca1\u80fd\u6b63\u786e\u5730\u8bbe\u7f6e <code>innodb_io_capacity</code> \u53c2\u6570\uff0c\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u4e5f\u6bd4\u6bd4\u7686\u662f\u3002\u4e4b\u524d\uff0c\u5c31\u66fe\u6709\u5176\u4ed6\u516c\u53f8\u7684\u5f00\u53d1\u8d1f\u8d23\u4eba\u627e\u6211\u770b\u4e00\u4e2a\u5e93\u7684\u6027\u80fd\u95ee\u9898\uff0c\u8bf4 MySQL \u7684\u5199\u5165\u901f\u5ea6\u5f88\u6162\uff0cTPS \u5f88\u4f4e\uff0c\u4f46\u662f\u6570\u636e\u5e93\u4e3b\u673a\u7684 IO \u538b\u529b\u5e76\u4e0d\u5927\u3002\u7ecf\u8fc7\u4e00\u756a\u6392\u67e5\uff0c\u53d1\u73b0\u7f6a\u9b41\u7978\u9996\u5c31\u662f\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u51fa\u4e86\u95ee\u9898\u3002</p>\n<p>\u4ed6\u7684\u4e3b\u673a\u78c1\u76d8\u7528\u7684\u662f SSD\uff0c\u4f46\u662f <code>innodb_io_capacity</code> \u7684\u503c\u8bbe\u7f6e\u7684\u662f 300\u3002\u4e8e\u662f\uff0cInnoDB \u8ba4\u4e3a\u8fd9\u4e2a\u7cfb\u7edf\u7684\u80fd\u529b\u5c31\u8fd9\u4e48\u5dee\uff0c\u6240\u4ee5\u5237\u810f\u9875\u5237\u5f97\u7279\u522b\u6162\uff0c\u751a\u81f3\u6bd4\u810f\u9875\u751f\u6210\u7684\u901f\u5ea6\u8fd8\u6162\uff0c\u8fd9\u6837\u5c31\u9020\u6210\u4e86\u810f\u9875\u7d2f\u79ef\uff0c\u5f71\u54cd\u4e86\u67e5\u8be2\u548c\u66f4\u65b0\u6027\u80fd\u3002</p>\n<p>\u867d\u7136\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u5b9a\u4e49\u4e86\u201c\u5168\u529b\u5237\u810f\u9875\u201d\u7684\u884c\u4e3a\uff0c\u4f46\u5e73\u65f6\u603b\u4e0d\u80fd\u4e00\u76f4\u662f\u5168\u529b\u5237\u5427\uff1f\u6bd5\u7adf\u78c1\u76d8\u80fd\u529b\u4e0d\u80fd\u53ea\u7528\u6765\u5237\u810f\u9875\uff0c\u8fd8\u9700\u8981\u670d\u52a1\u7528\u6237\u8bf7\u6c42\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u770b\u770b InnoDB \u600e\u4e48\u63a7\u5236\u5f15\u64ce\u6309\u7167\u201c\u5168\u529b\u201d\u7684\u767e\u5206\u6bd4\u6765\u5237\u810f\u9875\u3002</p>\n<p>\u6839\u636e\u6211\u524d\u9762\u63d0\u5230\u7684\u77e5\u8bc6\u70b9\uff0c\u8bd5\u60f3\u4e00\u4e0b\uff0c<strong>\u5982\u679c\u4f60\u6765\u8bbe\u8ba1\u7b56\u7565\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\uff0c\u4f1a\u53c2\u8003\u54ea\u4e9b\u56e0\u7d20\u5462\uff1f</strong></p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u53ef\u4ee5\u8fd9\u4e48\u60f3\uff0c\u5982\u679c\u5237\u592a\u6162\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\uff1f\u9996\u5148\u662f\u5185\u5b58\u810f\u9875\u592a\u591a\uff0c\u5176\u6b21\u662f redo log \u5199\u6ee1\u3002</p>\n<p>\u6240\u4ee5\uff0cInnoDB \u7684\u5237\u76d8\u901f\u5ea6\u5c31\u662f\u8981\u53c2\u8003\u8fd9\u4e24\u4e2a\u56e0\u7d20\uff1a\u4e00\u4e2a\u662f\u810f\u9875\u6bd4\u4f8b\uff0c\u4e00\u4e2a\u662f redo log \u5199\u76d8\u901f\u5ea6\u3002</p>\n<p>InnoDB \u4f1a\u6839\u636e\u8fd9\u4e24\u4e2a\u56e0\u7d20\u5148\u5355\u72ec\u7b97\u51fa\u4e24\u4e2a\u6570\u5b57\u3002</p>\n<p>\u53c2\u6570 <code>innodb_max_dirty_pages_pct</code> \u662f\u810f\u9875\u6bd4\u4f8b\u4e0a\u9650\uff0cMySQL 5.7 \u9ed8\u8ba4\u503c\u662f 75%, 8.0 \u5219\u53d8\u6210\u4e86 90%\u3002InnoDB \u4f1a\u6839\u636e\u5f53\u524d\u7684\u810f\u9875\u6bd4\u4f8b\uff08\u5047\u8bbe\u4e3a M\uff09\uff0c\u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u5728 0 \u5230 100 \u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8ba1\u7b97\u8fd9\u4e2a\u6570\u5b57\u7684\u4f2a\u4ee3\u7801\u7c7b\u4f3c\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">F1</span><span class=\"p\">(</span><span class=\"n\">M</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">&gt;=</span><span class=\"n\">innodb_max_dirty_pages_pct</span><span class=\"w\"> </span><span class=\"n\">then</span>\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">*</span><span class=\"n\">M</span><span class=\"o\">/</span><span class=\"n\">innodb_max_dirty_pages_pct</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>InnoDB \u6bcf\u6b21\u5199\u5165\u7684\u65e5\u5fd7\u90fd\u6709\u4e00\u4e2a\u5e8f\u53f7\uff0c\u5f53\u524d\u5199\u5165\u7684\u5e8f\u53f7\u8ddf checkpoint \u5bf9\u5e94\u7684\u5e8f\u53f7\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u6211\u4eec\u5047\u8bbe\u4e3a N\u3002InnoDB \u4f1a\u6839\u636e\u8fd9\u4e2a N \u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u5728 0 \u5230 100 \u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8fd9\u4e2a\u8ba1\u7b97\u516c\u5f0f\u53ef\u4ee5\u8bb0\u4e3a F2(N)\u3002F2(N) \u7b97\u6cd5\u6bd4\u8f83\u590d\u6742\uff0c\u4f60\u53ea\u8981\u77e5\u9053 N \u8d8a\u5927\uff0c\u7b97\u51fa\u6765\u7684\u503c\u8d8a\u5927\u5c31\u597d\u4e86\u3002</p>\n<p>\u7136\u540e\uff0c<strong>\u6839\u636e\u4e0a\u8ff0\u7b97\u5f97\u7684 F1(M) \u548c F2(N) \u4e24\u4e2a\u503c\uff0c\u53d6\u5176\u4e2d\u8f83\u5927\u7684\u503c\u8bb0\u4e3a R\uff0c\u4e4b\u540e\u5f15\u64ce\u5c31\u53ef\u4ee5\u6309\u7167 innodb_io_capacity \u5b9a\u4e49\u7684\u80fd\u529b\u4e58\u4ee5 R% \u6765\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\u3002</strong></p>\n<p>\u4e0a\u8ff0\u7684\u8ba1\u7b97\u6d41\u7a0b\u6bd4\u8f83\u62bd\u8c61\uff0c\u4e0d\u5bb9\u6613\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u753b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u6d41\u7a0b\u56fe\u3002\u56fe\u4e2d\u7684 F1\u3001F2 \u5c31\u662f\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u810f\u9875\u6bd4\u4f8b\u548c redo log \u5199\u5165\u901f\u5ea6\u7b97\u51fa\u6765\u7684\u4e24\u4e2a\u503c\u3002</p>\n<pre class=\"mermaid\"><code>%%{ init: {\"flowchart\": {\"curve\": \"catmullRom\"}}}%%\ngraph TB\n    begin((\" \"))\n    begin --&gt; M(\"\u810f\u9875\u6bd4\u4f8bM&lt;br/&gt;max_dirty_pages_pct\")\n    begin --&gt; N(\"(\u5f53\u524d\u65e5\u5fd7\u5e8f\u5217 - checkponit) N\")\n    M --&gt; F1\n    N --&gt; F2\n    F1 --&gt; R[\"R = max{F1,F2}\"]\n    F2 --&gt; R\n    R --&gt; refresh(\"\u6309\u7167 R% \u901f\u5ea6\u5237\u65b0\u810f\u9875\")\n    refresh --&gt; over((\"   \"))\n\n    over .-&gt; begin</code></pre>\n<p>\u56fe 3 InnoDB \u5237\u810f\u9875\u901f\u5ea6\u7b56\u7565</p>\n<p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0cInnoDB \u4f1a\u5728\u540e\u53f0\u5237\u810f\u9875\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u662f\u8981\u5c06\u5185\u5b58\u9875\u5199\u5165\u78c1\u76d8\u3002\u6240\u4ee5\uff0c\u65e0\u8bba\u662f\u4f60\u7684\u67e5\u8be2\u8bed\u53e5\u5728\u9700\u8981\u5185\u5b58\u7684\u65f6\u5019\u53ef\u80fd\u8981\u6c42\u6dd8\u6c70\u4e00\u4e2a\u810f\u9875\uff0c\u8fd8\u662f\u7531\u4e8e\u5237\u810f\u9875\u7684\u903b\u8f91\u4f1a\u5360\u7528 IO \u8d44\u6e90\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u4e86\u4f60\u7684\u66f4\u65b0\u8bed\u53e5\uff0c\u90fd\u53ef\u80fd\u662f\u9020\u6210\u4f60\u4ece\u4e1a\u52a1\u7aef\u611f\u77e5\u5230 MySQL\u201c\u6296\u201d\u4e86\u4e00\u4e0b\u7684\u539f\u56e0\u3002</p>\n<p>\u8981\u5c3d\u91cf\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u5c31\u8981\u5408\u7406\u5730\u8bbe\u7f6e <code>innodb_io_capacity</code> \u7684\u503c\uff0c\u5e76\u4e14**\u5e73\u65f6\u8981\u591a\u5173\u6ce8\u810f\u9875\u6bd4\u4f8b\uff0c\u4e0d\u8981\u8ba9\u5b83\u7ecf\u5e38\u63a5\u8fd1 75%**\u3002</p>\n<p>\u5176\u4e2d\uff0c\u810f\u9875\u6bd4\u4f8b\u662f\u901a\u8fc7 <code>Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total</code> \u5f97\u5230\u7684\uff0c\u5177\u4f53\u7684\u547d\u4ee4\u53c2\u8003\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">global</span><span class=\"w\"> </span><span class=\"n\">show_compatibility_56</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">-- turn on if version &gt; 5.7.6</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">VARIABLE_VALUE</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">VARIABLE_VALUE</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">GLOBAL_STATUS</span>\n<span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">VARIABLE_NAME</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_buffer_pool_pages_total&#39;</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">ratio</span>\n<span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">GLOBAL_STATUS</span>\n<span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">VARIABLE_NAME</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_buffer_pool_pages_dirty&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u6709\u8da3\u7684\u7b56\u7565\u3002</p>\n<p>\u4e00\u65e6\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u9700\u8981\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5148 flush \u6389\u4e00\u4e2a\u810f\u9875\u65f6\uff0c\u8fd9\u4e2a\u67e5\u8be2\u5c31\u53ef\u80fd\u8981\u6bd4\u5e73\u65f6\u6162\u4e86\u3002\u800c MySQL \u4e2d\u7684\u4e00\u4e2a\u673a\u5236\uff0c\u53ef\u80fd\u8ba9\u4f60\u7684\u67e5\u8be2\u4f1a\u66f4\u6162\uff1a\u5728\u51c6\u5907\u5237\u4e00\u4e2a\u810f\u9875\u7684\u65f6\u5019\uff0c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u65c1\u8fb9\u7684\u6570\u636e\u9875\u521a\u597d\u662f\u810f\u9875\uff0c\u5c31\u4f1a\u628a\u8fd9\u4e2a\u201c\u90bb\u5c45\u201d\u4e5f\u5e26\u7740\u4e00\u8d77\u5237\u6389\uff1b\u800c\u4e14\u8fd9\u4e2a\u628a\u201c\u90bb\u5c45\u201d\u62d6\u4e0b\u6c34\u7684\u903b\u8f91\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u8513\u5ef6\uff0c\u4e5f\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u90bb\u5c45\u6570\u636e\u9875\uff0c\u5982\u679c\u8ddf\u5b83\u76f8\u90bb\u7684\u6570\u636e\u9875\u4e5f\u8fd8\u662f\u810f\u9875\u7684\u8bdd\uff0c\u4e5f\u4f1a\u88ab\u653e\u5230\u4e00\u8d77\u5237\u3002</p>\n<p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_flush_neighbors</code> \u53c2\u6570\u5c31\u662f\u7528\u6765\u63a7\u5236\u8fd9\u4e2a\u884c\u4e3a\u7684\uff0c\u503c\u4e3a 1 \u7684\u65f6\u5019\u4f1a\u6709\u4e0a\u8ff0\u7684\u201c\u8fde\u5750\u201d\u673a\u5236\uff0c\u503c\u4e3a 0 \u65f6\u8868\u793a\u4e0d\u627e\u90bb\u5c45\uff0c\u81ea\u5df1\u5237\u81ea\u5df1\u7684\u3002</p>\n<p>\u627e\u201c\u90bb\u5c45\u201d\u8fd9\u4e2a\u4f18\u5316\u5728\u673a\u68b0\u786c\u76d8\u65f6\u4ee3\u662f\u5f88\u6709\u610f\u4e49\u7684\uff0c\u53ef\u4ee5\u51cf\u5c11\u5f88\u591a\u968f\u673a IO\u3002\u673a\u68b0\u786c\u76d8\u7684\u968f\u673a IOPS \u4e00\u822c\u53ea\u6709\u51e0\u767e\uff0c\u76f8\u540c\u7684\u903b\u8f91\u64cd\u4f5c\u51cf\u5c11\u968f\u673a IO \u5c31\u610f\u5473\u7740\u7cfb\u7edf\u6027\u80fd\u7684\u5927\u5e45\u5ea6\u63d0\u5347\u3002</p>\n<p>\u800c\u5982\u679c\u4f7f\u7528\u7684\u662f SSD \u8fd9\u7c7b IOPS \u6bd4\u8f83\u9ad8\u7684\u8bbe\u5907\u7684\u8bdd\uff0c\u6211\u5c31\u5efa\u8bae\u4f60\u628a <code>innodb_flush_neighbors</code> \u7684\u503c\u8bbe\u7f6e\u6210 0\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019 IOPS \u5f80\u5f80\u4e0d\u662f\u74f6\u9888\uff0c\u800c\u201c\u53ea\u5237\u81ea\u5df1\u201d\uff0c\u5c31\u80fd\u66f4\u5feb\u5730\u6267\u884c\u5b8c\u5fc5\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\uff0c\u51cf\u5c11 SQL \u8bed\u53e5\u54cd\u5e94\u65f6\u95f4\u3002</p>\n<p>\u5728 MySQL 8.0 \u4e2d\uff0c<code>innodb_flush_neighbors</code> \u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u5df2\u7ecf\u662f 0 \u4e86\u3002</p>\n<h3 id=\"_7\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5ef6\u7eed\u7b2c 2 \u7bc7\u4e2d\u4ecb\u7ecd\u7684 WAL \u7684\u6982\u5ff5\uff0c\u548c\u4f60\u89e3\u91ca\u4e86\u8fd9\u4e2a\u673a\u5236\u540e\u7eed\u9700\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\u548c\u6267\u884c\u65f6\u673a\u3002\u5229\u7528 WAL \u6280\u672f\uff0c\u6570\u636e\u5e93\u5c06\u968f\u673a\u5199\u8f6c\u6362\u6210\u4e86\u987a\u5e8f\u5199\uff0c\u5927\u5927\u63d0\u5347\u4e86\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p>\n<p>\u4f46\u662f\uff0c\u7531\u6b64\u4e5f\u5e26\u6765\u4e86\u5185\u5b58\u810f\u9875\u7684\u95ee\u9898\u3002\u810f\u9875\u4f1a\u88ab\u540e\u53f0\u7ebf\u7a0b\u81ea\u52a8 flush\uff0c\u4e5f\u4f1a\u7531\u4e8e\u6570\u636e\u9875\u6dd8\u6c70\u800c\u89e6\u53d1 flush\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u7531\u4e8e\u4f1a\u5360\u7528\u8d44\u6e90\uff0c\u53ef\u80fd\u4f1a\u8ba9\u4f60\u7684\u66f4\u65b0\u548c\u67e5\u8be2\u8bed\u53e5\u7684\u54cd\u5e94\u65f6\u95f4\u957f\u4e00\u4e9b\u3002\u5728\u6587\u7ae0\u91cc\uff0c\u6211\u4e5f\u7ed9\u4f60\u4ecb\u7ecd\u4e86\u63a7\u5236\u5237\u810f\u9875\u7684\u65b9\u6cd5\u548c\u5bf9\u5e94\u7684\u76d1\u63a7\u65b9\u5f0f\u3002</p>\n<h2 id=\"13\">13 \u4e3a\u4ec0\u4e48\u8868\u6570\u636e\u5220\u6389\u4e00\u534a\uff0c\u8868\u6587\u4ef6\u5927\u5c0f\u4e0d\u53d8\uff1f<a class=\"headerlink\" href=\"#13\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7ecf\u5e38\u4f1a\u6709\u540c\u5b66\u6765\u95ee\u6211\uff0c\u6211\u7684\u6570\u636e\u5e93\u5360\u7528\u7a7a\u95f4\u592a\u5927\uff0c\u6211\u628a\u4e00\u4e2a\u6700\u5927\u7684\u8868\u5220\u6389\u4e86\u4e00\u534a\u7684\u6570\u636e\uff0c\u600e\u4e48\u8868\u6587\u4ef6\u7684\u5927\u5c0f\u8fd8\u662f\u6ca1\u53d8\uff1f</p>\n<p>\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u5c31\u548c\u4f60\u804a\u804a\u6570\u636e\u5e93\u8868\u7684\u7a7a\u95f4\u56de\u6536\uff0c\u770b\u770b\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u8fd8\u662f\u9488\u5bf9 MySQL \u4e2d\u5e94\u7528\u6700\u5e7f\u6cdb\u7684 InnoDB \u5f15\u64ce\u5c55\u5f00\u8ba8\u8bba\u3002\u4e00\u4e2a InnoDB \u8868\u5305\u542b\u4e24\u90e8\u5206\uff0c\u5373\uff1a\u8868\u7ed3\u6784\u5b9a\u4e49\u548c\u6570\u636e\u3002\u5728 MySQL 8.0 \u7248\u672c\u4ee5\u524d\uff0c\u8868\u7ed3\u6784\u662f\u5b58\u5728\u4ee5 <code>.frm</code> \u4e3a\u540e\u7f00\u7684\u6587\u4ef6\u91cc\u3002</p>\n<p>\u800c MySQL 8.0 \u7248\u672c\uff0c\u5219\u5df2\u7ecf\u5141\u8bb8\u628a\u8868\u7ed3\u6784\u5b9a\u4e49\u653e\u5728\u7cfb\u7edf\u6570\u636e\u8868\u4e2d\u4e86\u3002\u56e0\u4e3a\u8868\u7ed3\u6784\u5b9a\u4e49\u5360\u7528\u7684\u7a7a\u95f4\u5f88\u5c0f\uff0c\u6240\u4ee5\u6211\u4eec\u4eca\u5929\u4e3b\u8981\u8ba8\u8bba\u7684\u662f\u8868\u6570\u636e\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4f1a\u5148\u548c\u4f60\u8bf4\u660e\u4e3a\u4ec0\u4e48\u7b80\u5355\u5730\u5220\u9664\u8868\u6570\u636e\u8fbe\u4e0d\u5230\u8868\u7a7a\u95f4\u56de\u6536\u7684\u6548\u679c\uff0c\u7136\u540e\u518d\u548c\u4f60\u4ecb\u7ecd\u6b63\u786e\u56de\u6536\u7a7a\u95f4\u7684\u65b9\u6cd5\u3002</p>\n<h3 id=\"innodb_file_per_table\">\u53c2\u6570 <code>innodb_file_per_table</code><a class=\"headerlink\" href=\"#innodb_file_per_table\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8868\u6570\u636e\u65e2\u53ef\u4ee5\u5b58\u5728\u5171\u4eab\u8868\u7a7a\u95f4\u91cc\uff0c\u4e5f\u53ef\u4ee5\u662f\u5355\u72ec\u7684\u6587\u4ef6\u3002\u8fd9\u4e2a\u884c\u4e3a\u662f\u7531\u53c2\u6570 <code>innodb_file_per_table</code> \u63a7\u5236\u7684\uff1a</p>\n<ol>\n<li>\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a <code>OFF</code> \u8868\u793a\u7684\u662f\uff0c\u8868\u7684\u6570\u636e\u653e\u5728\u7cfb\u7edf\u5171\u4eab\u8868\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u8ddf\u6570\u636e\u5b57\u5178\u653e\u5728\u4e00\u8d77\uff1b</li>\n<li>\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a <code>ON</code> \u8868\u793a\u7684\u662f\uff0c\u6bcf\u4e2a InnoDB \u8868\u6570\u636e\u5b58\u50a8\u5728\u4e00\u4e2a\u4ee5 .ibd \u4e3a\u540e\u7f00\u7684\u6587\u4ef6\u4e2d\u3002</li>\n</ol>\n<p>\u4ece MySQL 5.6.6 \u7248\u672c\u5f00\u59cb\uff0c\u5b83\u7684\u9ed8\u8ba4\u503c\u5c31\u662f ON \u4e86\u3002</p>\n<p>\u6211\u5efa\u8bae\u4f60\u4e0d\u8bba\u4f7f\u7528 MySQL \u7684\u54ea\u4e2a\u7248\u672c\uff0c\u90fd\u5c06\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a ON\u3002</p>\n<p>\u56e0\u4e3a\uff0c\u4e00\u4e2a\u8868\u5355\u72ec\u5b58\u50a8\u4e3a\u4e00\u4e2a\u6587\u4ef6\u66f4\u5bb9\u6613\u7ba1\u7406\uff0c\u800c\u4e14\u5728\u4f60\u4e0d\u9700\u8981\u8fd9\u4e2a\u8868\u7684\u65f6\u5019\uff0c\u901a\u8fc7 <code>drop table</code> \u547d\u4ee4\uff0c\u7cfb\u7edf\u5c31\u4f1a\u76f4\u63a5\u5220\u9664\u8fd9\u4e2a\u6587\u4ef6\u3002\u800c\u5982\u679c\u662f\u653e\u5728\u5171\u4eab\u8868\u7a7a\u95f4\u4e2d\uff0c\u5373\u4f7f\u8868\u5220\u6389\u4e86\uff0c\u7a7a\u95f4\u4e5f\u662f\u4e0d\u4f1a\u56de\u6536\u7684\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5c06 <code>innodb_file_per_table</code> \u8bbe\u7f6e\u4e3a ON\uff0c\u662f\u63a8\u8350\u505a\u6cd5\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u7684\u8ba8\u8bba\u90fd\u662f\u57fa\u4e8e\u8fd9\u4e2a\u8bbe\u7f6e\u5c55\u5f00\u7684\u3002</p>\n<p>\u6211\u4eec\u5728\u5220\u9664\u6574\u4e2a\u8868\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>drop table</code> \u547d\u4ee4\u56de\u6536\u8868\u7a7a\u95f4\u3002\u4f46\u662f\uff0c\u6211\u4eec\u9047\u5230\u7684\u66f4\u591a\u7684\u5220\u9664\u6570\u636e\u7684\u573a\u666f\u662f\u5220\u9664\u67d0\u4e9b\u884c\uff0c\u8fd9\u65f6\u5c31\u9047\u5230\u4e86\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff1a\u8868\u4e2d\u7684\u6570\u636e\u88ab\u5220\u9664\u4e86\uff0c\u4f46\u662f\u8868\u7a7a\u95f4\u5374\u6ca1\u6709\u88ab\u56de\u6536\u3002</p>\n<p>\u6211\u4eec\u8981\u5f7b\u5e95\u641e\u660e\u767d\u8fd9\u4e2a\u95ee\u9898\u7684\u8bdd\uff0c\u5c31\u8981\u4ece\u6570\u636e\u5220\u9664\u6d41\u7a0b\u8bf4\u8d77\u4e86\u3002</p>\n<h3 id=\"_8\">\u6570\u636e\u5220\u9664\u6d41\u7a0b<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u5148\u518d\u6765\u770b\u4e00\u4e0b InnoDB \u4e2d\u4e00\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002\u5728\u524d\u9762\u7b2c4\u548c\u7b2c5\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u7d22\u5f15\u65f6\u66fe\u7ecf\u63d0\u5230\u8fc7\uff0cInnoDB \u91cc\u7684\u6570\u636e\u90fd\u662f\u7528 B+ \u6811\u7684\u7ed3\u6784\u7ec4\u7ec7\u7684\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/f0b1e4ac610bcb5c5922d0b18563f3c8.png\" /></p>\n<p>\u5047\u8bbe\uff0c\u6211\u4eec\u8981\u5220\u6389 R4 \u8fd9\u4e2a\u8bb0\u5f55\uff0cInnoDB \u5f15\u64ce\u53ea\u4f1a\u628a R4 \u8fd9\u4e2a\u8bb0\u5f55\u6807\u8bb0\u4e3a\u5220\u9664\u3002\u5982\u679c\u4e4b\u540e\u8981\u518d\u63d2\u5165\u4e00\u4e2a ID \u5728 300 \u548c 600 \u4e4b\u95f4\u7684\u8bb0\u5f55\u65f6\uff0c\u53ef\u80fd\u4f1a\u590d\u7528\u8fd9\u4e2a\u4f4d\u7f6e\u3002\u4f46\u662f\uff0c\u78c1\u76d8\u6587\u4ef6\u7684\u5927\u5c0f\u5e76\u4e0d\u4f1a\u7f29\u5c0f\u3002</p>\n<p>\u73b0\u5728\uff0c\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86 InnoDB \u7684\u6570\u636e\u662f\u6309\u9875\u5b58\u50a8\u7684\uff0c\u90a3\u4e48\u5982\u679c\u6211\u4eec\u5220\u6389\u4e86\u4e00\u4e2a\u6570\u636e\u9875\u4e0a\u7684\u6240\u6709\u8bb0\u5f55\uff0c\u4f1a\u600e\u4e48\u6837\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u6574\u4e2a\u6570\u636e\u9875\u5c31\u53ef\u4ee5\u88ab\u590d\u7528\u4e86\u3002</p>\n<p>\u4f46\u662f\uff0c<strong>\u6570\u636e\u9875\u7684\u590d\u7528\u8ddf\u8bb0\u5f55\u7684\u590d\u7528\u662f\u4e0d\u540c\u7684\u3002</strong></p>\n<p>\u8bb0\u5f55\u7684\u590d\u7528\uff0c\u53ea\u9650\u4e8e\u7b26\u5408\u8303\u56f4\u6761\u4ef6\u7684\u6570\u636e\u3002\u6bd4\u5982\u4e0a\u9762\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0cR4 \u8fd9\u6761\u8bb0\u5f55\u88ab\u5220\u9664\u540e\uff0c\u5982\u679c\u63d2\u5165\u4e00\u4e2a ID \u662f 400 \u7684\u884c\uff0c\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u8fd9\u4e2a\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u63d2\u5165\u7684\u662f\u4e00\u4e2a ID \u662f 800 \u7684\u884c\uff0c\u5c31\u4e0d\u80fd\u590d\u7528\u8fd9\u4e2a\u4f4d\u7f6e\u4e86\u3002</p>\n<p>\u800c\u5f53\u6574\u4e2a\u9875\u4ece B+ \u6811\u91cc\u9762\u6458\u6389\u4ee5\u540e\uff0c\u53ef\u4ee5\u590d\u7528\u5230\u4efb\u4f55\u4f4d\u7f6e\u3002\u4ee5\u56fe 1 \u4e3a\u4f8b\uff0c\u5982\u679c\u5c06\u6570\u636e\u9875 page A \u4e0a\u7684\u6240\u6709\u8bb0\u5f55\u5220\u9664\u4ee5\u540e\uff0cpage A \u4f1a\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002\u8fd9\u65f6\u5019\u5982\u679c\u8981\u63d2\u5165\u4e00\u6761 ID=50 \u7684\u8bb0\u5f55\u9700\u8981\u4f7f\u7528\u65b0\u9875\u7684\u65f6\u5019\uff0cpage A \u662f\u53ef\u4ee5\u88ab\u590d\u7528\u7684\u3002</p>\n<p>\u5982\u679c\u76f8\u90bb\u7684\u4e24\u4e2a\u6570\u636e\u9875\u5229\u7528\u7387\u90fd\u5f88\u5c0f\uff0c\u7cfb\u7edf\u5c31\u4f1a\u628a\u8fd9\u4e24\u4e2a\u9875\u4e0a\u7684\u6570\u636e\u5408\u5230\u5176\u4e2d\u4e00\u4e2a\u9875\u4e0a\uff0c\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u9875\u5c31\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u5730\uff0c\u5982\u679c\u6211\u4eec\u7528 <code>delete</code> \u547d\u4ee4\u628a\u6574\u4e2a\u8868\u7684\u6570\u636e\u5220\u9664\u5462\uff1f\u7ed3\u679c\u5c31\u662f\uff0c\u6240\u6709\u7684\u6570\u636e\u9875\u90fd\u4f1a\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002\u4f46\u662f\u78c1\u76d8\u4e0a\uff0c\u6587\u4ef6\u4e0d\u4f1a\u53d8\u5c0f\u3002</p>\n<p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c<code>delete</code> \u547d\u4ee4\u5176\u5b9e\u53ea\u662f\u628a\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u6216\u8005\u6570\u636e\u9875\u6807\u8bb0\u4e3a\u4e86\u201c\u53ef\u590d\u7528\u201d\uff0c\u4f46\u78c1\u76d8\u6587\u4ef6\u7684\u5927\u5c0f\u662f\u4e0d\u4f1a\u53d8\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u901a\u8fc7 <code>delete</code> \u547d\u4ee4\u662f\u4e0d\u80fd\u56de\u6536\u8868\u7a7a\u95f4\u7684\u3002\u8fd9\u4e9b\u53ef\u4ee5\u590d\u7528\uff0c\u800c\u6ca1\u6709\u88ab\u4f7f\u7528\u7684\u7a7a\u95f4\uff0c\u770b\u8d77\u6765\u5c31\u50cf\u662f\u201c\u7a7a\u6d1e\u201d\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c<strong>\u4e0d\u6b62\u662f\u5220\u9664\u6570\u636e\u4f1a\u9020\u6210\u7a7a\u6d1e\uff0c\u63d2\u5165\u6570\u636e\u4e5f\u4f1a\u3002</strong></p>\n<p>\u5982\u679c\u6570\u636e\u662f\u6309\u7167\u7d22\u5f15\u9012\u589e\u987a\u5e8f\u63d2\u5165\u7684\uff0c\u90a3\u4e48\u7d22\u5f15\u662f\u7d27\u51d1\u7684\u3002\u4f46\u5982\u679c\u6570\u636e\u662f\u968f\u673a\u63d2\u5165\u7684\uff0c\u5c31\u53ef\u80fd\u9020\u6210\u7d22\u5f15\u7684\u6570\u636e\u9875\u5206\u88c2\u3002</p>\n<p>\u5047\u8bbe\u56fe 1 \u4e2d page A \u5df2\u7ecf\u6ee1\u4e86\uff0c\u8fd9\u65f6\u6211\u8981\u518d\u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u4f1a\u600e\u6837\u5462\uff1f</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/8083f05a4a4c0372833a6e01d5a8e6ea.png\" /></p>\n<p>\u56fe 2 \u63d2\u5165\u6570\u636e\u5bfc\u81f4\u9875\u5206\u88c2</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e page A \u6ee1\u4e86\uff0c\u518d\u63d2\u5165\u4e00\u4e2a ID \u662f 550 \u7684\u6570\u636e\u65f6\uff0c\u5c31\u4e0d\u5f97\u4e0d\u518d\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u9875\u9762 page B \u6765\u4fdd\u5b58\u6570\u636e\u4e86\u3002\u9875\u5206\u88c2\u5b8c\u6210\u540e\uff0cpage A \u7684\u672b\u5c3e\u5c31\u7559\u4e0b\u4e86\u7a7a\u6d1e\uff08\u6ce8\u610f\uff1a\u5b9e\u9645\u4e0a\uff0c\u53ef\u80fd\u4e0d\u6b62 1 \u4e2a\u8bb0\u5f55\u7684\u4f4d\u7f6e\u662f\u7a7a\u6d1e\uff09\u3002</p>\n<p>\u53e6\u5916\uff0c\u66f4\u65b0\u7d22\u5f15\u4e0a\u7684\u503c\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5220\u9664\u4e00\u4e2a\u65e7\u7684\u503c\uff0c\u518d\u63d2\u5165\u4e00\u4e2a\u65b0\u503c\u3002\u4e0d\u96be\u7406\u89e3\uff0c\u8fd9\u4e5f\u662f\u4f1a\u9020\u6210\u7a7a\u6d1e\u7684\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u7ecf\u8fc7\u5927\u91cf\u589e\u5220\u6539\u7684\u8868\uff0c\u90fd\u662f\u53ef\u80fd\u662f\u5b58\u5728\u7a7a\u6d1e\u7684\u3002\u6240\u4ee5\uff0c\u5982\u679c\u80fd\u591f\u628a\u8fd9\u4e9b\u7a7a\u6d1e\u53bb\u6389\uff0c\u5c31\u80fd\u8fbe\u5230\u6536\u7f29\u8868\u7a7a\u95f4\u7684\u76ee\u7684\u3002</p>\n<p>\u800c\u91cd\u5efa\u8868\uff0c\u5c31\u53ef\u4ee5\u8fbe\u5230\u8fd9\u6837\u7684\u76ee\u7684\u3002</p>\n<h3 id=\"_9\">\u91cd\u5efa\u8868<a class=\"headerlink\" href=\"#_9\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bd5\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u73b0\u5728\u6709\u4e00\u4e2a\u8868 A\uff0c\u9700\u8981\u505a\u7a7a\u95f4\u6536\u7f29\uff0c\u4e3a\u4e86\u628a\u8868\u4e2d\u5b58\u5728\u7684\u7a7a\u6d1e\u53bb\u6389\uff0c\u4f60\u53ef\u4ee5\u600e\u4e48\u505a\u5462\uff1f</p>\n<p>\u4f60\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u4e0e\u8868 A \u7ed3\u6784\u76f8\u540c\u7684\u8868 B\uff0c\u7136\u540e\u6309\u7167\u4e3b\u952e ID \u9012\u589e\u7684\u987a\u5e8f\uff0c\u628a\u6570\u636e\u4e00\u884c\u4e00\u884c\u5730\u4ece\u8868 A \u91cc\u8bfb\u51fa\u6765\u518d\u63d2\u5165\u5230\u8868 B \u4e2d\u3002</p>\n<p>\u7531\u4e8e\u8868 B \u662f\u65b0\u5efa\u7684\u8868\uff0c\u6240\u4ee5\u8868 A \u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\u7a7a\u6d1e\uff0c\u5728\u8868 B \u4e2d\u5c31\u90fd\u4e0d\u5b58\u5728\u4e86\u3002\u663e\u7136\u5730\uff0c\u8868 B \u7684\u4e3b\u952e\u7d22\u5f15\u66f4\u7d27\u51d1\uff0c\u6570\u636e\u9875\u7684\u5229\u7528\u7387\u4e5f\u66f4\u9ad8\u3002\u5982\u679c\u6211\u4eec\u628a\u8868 B \u4f5c\u4e3a\u4e34\u65f6\u8868\uff0c\u6570\u636e\u4ece\u8868 A \u5bfc\u5165\u8868 B \u7684\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u7528\u8868 B \u66ff\u6362 A\uff0c\u4ece\u6548\u679c\u4e0a\u770b\uff0c\u5c31\u8d77\u5230\u4e86\u6536\u7f29\u8868 A \u7a7a\u95f4\u7684\u4f5c\u7528\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>alter table A engine=InnoDB</code> \u547d\u4ee4\u6765\u91cd\u5efa\u8868\u3002\u5728 MySQL 5.5 \u7248\u672c\u4e4b\u524d\uff0c\u8fd9\u4e2a\u547d\u4ee4\u7684\u6267\u884c\u6d41\u7a0b\u8ddf\u6211\u4eec\u524d\u9762\u63cf\u8ff0\u7684\u5dee\u4e0d\u591a\uff0c\u533a\u522b\u53ea\u662f\u8fd9\u4e2a\u4e34\u65f6\u8868 B \u4e0d\u9700\u8981\u4f60\u81ea\u5df1\u521b\u5efa\uff0cMySQL \u4f1a\u81ea\u52a8\u5b8c\u6210\u8f6c\u5b58\u6570\u636e\u3001\u4ea4\u6362\u8868\u540d\u3001\u5220\u9664\u65e7\u8868\u7684\u64cd\u4f5c\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/02e083adaec6e1191f54992f7bc13dcd.png\" /></p>\n<p>\u56fe 3 \u6539\u9501\u8868 DDL</p>\n<p>\u663e\u7136\uff0c\u82b1\u65f6\u95f4\u6700\u591a\u7684\u6b65\u9aa4\u662f\u5f80\u4e34\u65f6\u8868\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6709\u65b0\u7684\u6570\u636e\u8981\u5199\u5165\u5230\u8868 A \u7684\u8bdd\uff0c\u5c31\u4f1a\u9020\u6210\u6570\u636e\u4e22\u5931\u3002\u56e0\u6b64\uff0c\u5728\u6574\u4e2a DDL \u8fc7\u7a0b\u4e2d\uff0c\u8868 A \u4e2d\u4e0d\u80fd\u6709\u66f4\u65b0\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a DDL \u4e0d\u662f Online \u7684\u3002</p>\n<p>\u800c\u5728**MySQL 5.6 \u7248\u672c\u5f00\u59cb\u5f15\u5165\u7684 Online DDL\uff0c\u5bf9\u8fd9\u4e2a\u64cd\u4f5c\u6d41\u7a0b\u505a\u4e86\u4f18\u5316\u3002**</p>\n<p>\u6211\u7ed9\u4f60\u7b80\u5355\u63cf\u8ff0\u4e00\u4e0b\u5f15\u5165\u4e86 Online DDL \u4e4b\u540e\uff0c\u91cd\u5efa\u8868\u7684\u6d41\u7a0b\uff1a</p>\n<ol>\n<li>\u5efa\u7acb\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u626b\u63cf\u8868 A \u4e3b\u952e\u7684\u6240\u6709\u6570\u636e\u9875\uff1b</li>\n<li>\u7528\u6570\u636e\u9875\u4e2d\u8868 A \u7684\u8bb0\u5f55\u751f\u6210 B+ \u6811\uff0c\u5b58\u50a8\u5230\u4e34\u65f6\u6587\u4ef6\u4e2d\uff1b</li>\n<li>\u751f\u6210\u4e34\u65f6\u6587\u4ef6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5c06\u6240\u6709\u5bf9 A \u7684\u64cd\u4f5c\u8bb0\u5f55\u5728\u4e00\u4e2a\u65e5\u5fd7\u6587\u4ef6\uff08row log\uff09\u4e2d\uff0c\u5bf9\u5e94\u7684\u662f\u56fe\u4e2d state2 \u7684\u72b6\u6001\uff1b</li>\n<li>\u4e34\u65f6\u6587\u4ef6\u751f\u6210\u540e\uff0c\u5c06\u65e5\u5fd7\u6587\u4ef6\u4e2d\u7684\u64cd\u4f5c\u5e94\u7528\u5230\u4e34\u65f6\u6587\u4ef6\uff0c\u5f97\u5230\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u4e0a\u4e0e\u8868 A \u76f8\u540c\u7684\u6570\u636e\u6587\u4ef6\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u56fe\u4e2d state3 \u7684\u72b6\u6001\uff1b</li>\n<li>\u7528\u4e34\u65f6\u6587\u4ef6\u66ff\u6362\u8868 A \u7684\u6570\u636e\u6587\u4ef6\u3002</li>\n</ol>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/2d1cfbbeb013b851a56390d38b5321f0.png\" /></p>\n<p>\u56fe 4 Online DDL</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0e\u56fe 3 \u8fc7\u7a0b\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c\u7531\u4e8e\u65e5\u5fd7\u6587\u4ef6\u8bb0\u5f55\u548c\u91cd\u653e\u64cd\u4f5c\u8fd9\u4e2a\u529f\u80fd\u7684\u5b58\u5728\uff0c\u8fd9\u4e2a\u65b9\u6848\u5728\u91cd\u5efa\u8868\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5141\u8bb8\u5bf9\u8868 A \u505a\u589e\u5220\u6539\u64cd\u4f5c\u3002\u8fd9\u4e5f\u5c31\u662f Online DDL \u540d\u5b57\u7684\u6765\u6e90\u3002</p>\n<p>\u6211\u8bb0\u5f97\u6709\u540c\u5b66\u5728\u7b2c 6 \u7bc7\u8bb2\u8868\u9501\u7684\u6587\u7ae0[\u300a\u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u7d22\u8fd9\u4e48\u591a\u963b\u788d\uff1f\u300b]\u7684\u8bc4\u8bba\u533a\u7559\u8a00\u8bf4\uff0cDDL \u4e4b\u524d\u662f\u8981\u62ff MDL \u5199\u9501\u7684\uff0c\u8fd9\u6837\u8fd8\u80fd\u53eb Online DDL \u5417\uff1f</p>\n<p>\u786e\u5b9e\uff0c\u56fe 4 \u7684\u6d41\u7a0b\u4e2d\uff0calter \u8bed\u53e5\u5728\u542f\u52a8\u7684\u65f6\u5019\u9700\u8981\u83b7\u53d6 MDL \u5199\u9501\uff0c\u4f46\u662f\u8fd9\u4e2a\u5199\u9501\u5728\u771f\u6b63\u62f7\u8d1d\u6570\u636e\u4e4b\u524d\u5c31\u9000\u5316\u6210\u8bfb\u9501\u4e86\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8981\u9000\u5316\u5462\uff1f\u4e3a\u4e86\u5b9e\u73b0 Online\uff0cMDL \u8bfb\u9501\u4e0d\u4f1a\u963b\u585e\u589e\u5220\u6539\u64cd\u4f5c\u3002</p>\n<p>\u90a3\u4e3a\u4ec0\u4e48\u4e0d\u5e72\u8106\u76f4\u63a5\u89e3\u9501\u5462\uff1f\u4e3a\u4e86\u4fdd\u62a4\u81ea\u5df1\uff0c\u7981\u6b62\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u540c\u65f6\u505a DDL\u3002</p>\n<p>\u800c\u5bf9\u4e8e\u4e00\u4e2a\u5927\u8868\u6765\u8bf4\uff0cOnline DDL \u6700\u8017\u65f6\u7684\u8fc7\u7a0b\u5c31\u662f\u62f7\u8d1d\u6570\u636e\u5230\u4e34\u65f6\u8868\u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u7684\u6267\u884c\u671f\u95f4\u53ef\u4ee5\u63a5\u53d7\u589e\u5220\u6539\u64cd\u4f5c\u3002\u6240\u4ee5\uff0c\u76f8\u5bf9\u4e8e\u6574\u4e2a DDL \u8fc7\u7a0b\u6765\u8bf4\uff0c\u9501\u7684\u65f6\u95f4\u975e\u5e38\u77ed\u3002\u5bf9\u4e1a\u52a1\u6765\u8bf4\uff0c\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u662f Online \u7684\u3002</p>\n<p>\u9700\u8981\u8865\u5145\u8bf4\u660e\u7684\u662f\uff0c\u4e0a\u8ff0\u7684\u8fd9\u4e9b\u91cd\u5efa\u65b9\u6cd5\u90fd\u4f1a\u626b\u63cf\u539f\u8868\u6570\u636e\u548c\u6784\u5efa\u4e34\u65f6\u6587\u4ef6\u3002\u5bf9\u4e8e\u5f88\u5927\u7684\u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u662f\u5f88\u6d88\u8017 IO \u548c CPU \u8d44\u6e90\u7684\u3002\u56e0\u6b64\uff0c\u5982\u679c\u662f\u7ebf\u4e0a\u670d\u52a1\uff0c\u4f60\u8981\u5f88\u5c0f\u5fc3\u5730\u63a7\u5236\u64cd\u4f5c\u65f6\u95f4\u3002\u5982\u679c\u60f3\u8981\u6bd4\u8f83\u5b89\u5168\u7684\u64cd\u4f5c\u7684\u8bdd\uff0c\u6211\u63a8\u8350\u4f60\u4f7f\u7528 GitHub \u5f00\u6e90\u7684 <a href=\"https://github.com/github/gh-ost\">gh-ost</a> \u6765\u505a\u3002</p>\n<h3 id=\"online-inplace\">Online \u548c inplace<a class=\"headerlink\" href=\"#online-inplace\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bf4\u5230 Online\uff0c\u6211\u8fd8\u8981\u518d\u548c\u4f60\u6f84\u6e05\u4e00\u4e0b\u5b83\u548c\u53e6\u4e00\u4e2a\u8ddf DDL \u6709\u5173\u7684\u3001\u5bb9\u6613\u6df7\u6dc6\u7684\u6982\u5ff5 inplace \u7684\u533a\u522b\u3002</p>\n<p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u5728\u56fe 3 \u4e2d\uff0c\u6211\u4eec\u628a\u8868 A \u4e2d\u7684\u6570\u636e\u5bfc\u51fa\u6765\u7684\u5b58\u653e\u4f4d\u7f6e\u53eb\u4f5c <code>tmp_table</code>\u3002\u8fd9\u662f\u4e00\u4e2a\u4e34\u65f6\u8868\uff0c\u662f\u5728 server \u5c42\u521b\u5efa\u7684\u3002</p>\n<p>\u5728\u56fe 4 \u4e2d\uff0c\u6839\u636e\u8868 A \u91cd\u5efa\u51fa\u6765\u7684\u6570\u636e\u662f\u653e\u5728 <code>tmp_file</code> \u91cc\u7684\uff0c\u8fd9\u4e2a\u4e34\u65f6\u6587\u4ef6\u662f InnoDB \u5728\u5185\u90e8\u521b\u5efa\u51fa\u6765\u7684\u3002\u6574\u4e2a DDL \u8fc7\u7a0b\u90fd\u5728 InnoDB \u5185\u90e8\u5b8c\u6210\u3002\u5bf9\u4e8e server \u5c42\u6765\u8bf4\uff0c\u6ca1\u6709\u628a\u6570\u636e\u632a\u52a8\u5230\u4e34\u65f6\u8868\uff0c\u662f\u4e00\u4e2a\u201c\u539f\u5730\u201d\u64cd\u4f5c\uff0c\u8fd9\u5c31\u662f\u201cinplace\u201d\u540d\u79f0\u7684\u6765\u6e90\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6211\u73b0\u5728\u95ee\u4f60\uff0c\u5982\u679c\u4f60\u6709\u4e00\u4e2a 1TB \u7684\u8868\uff0c\u73b0\u5728\u78c1\u76d8\u95f4\u662f 1.2TB\uff0c\u80fd\u4e0d\u80fd\u505a\u4e00\u4e2a inplace \u7684 DDL \u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\u4e0d\u80fd\u3002\u56e0\u4e3a\uff0c<code>tmp_file</code> \u4e5f\u662f\u8981\u5360\u7528\u4e34\u65f6\u7a7a\u95f4\u7684\u3002</p>\n<p>\u6211\u4eec\u91cd\u5efa\u8868\u7684\u8fd9\u4e2a\u8bed\u53e5 <code>alter table t engine=InnoDB</code>\uff0c\u5176\u5b9e\u9690\u542b\u7684\u610f\u601d\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">,</span><span class=\"n\">ALGORITHM</span><span class=\"o\">=</span><span class=\"n\">inplace</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8ddf inplace \u5bf9\u5e94\u7684\u5c31\u662f\u62f7\u8d1d\u8868\u7684\u65b9\u5f0f\u4e86\uff0c\u7528\u6cd5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">,</span><span class=\"n\">ALGORITHM</span><span class=\"o\">=</span><span class=\"k\">copy</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5f53\u4f60\u4f7f\u7528 <code>ALGORITHM=copy</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u7684\u662f\u5f3a\u5236\u62f7\u8d1d\u8868\uff0c\u5bf9\u5e94\u7684\u6d41\u7a0b\u5c31\u662f\u56fe 3 \u7684\u64cd\u4f5c\u8fc7\u7a0b\u3002</p>\n<p>\u4f46\u6211\u8fd9\u6837\u8bf4\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0cinplace \u8ddf Online \u662f\u4e0d\u662f\u5c31\u662f\u4e00\u4e2a\u610f\u601d\uff1f</p>\n<p>\u5176\u5b9e\u4e0d\u662f\u7684\uff0c\u53ea\u662f\u5728\u91cd\u5efa\u8868\u8fd9\u4e2a\u903b\u8f91\u4e2d\u521a\u597d\u662f\u8fd9\u6837\u800c\u5df2\u3002</p>\n<p>\u6bd4\u5982\uff0c\u5982\u679c\u6211\u8981\u7ed9 InnoDB \u8868\u7684\u4e00\u4e2a\u5b57\u6bb5\u52a0\u5168\u6587\u7d22\u5f15\uff0c\u5199\u6cd5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"n\">FULLTEXT</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u662f inplace \u7684\uff0c\u4f46\u4f1a\u963b\u585e\u589e\u5220\u6539\u64cd\u4f5c\uff0c\u662f\u975e Online \u7684\u3002</p>\n<p>\u5982\u679c\u8bf4\u8fd9\u4e24\u4e2a\u903b\u8f91\u4e4b\u95f4\u7684\u5173\u7cfb\u662f\u4ec0\u4e48\u7684\u8bdd\uff0c\u53ef\u4ee5\u6982\u62ec\u4e3a\uff1a</p>\n<ol>\n<li>DDL \u8fc7\u7a0b\u5982\u679c\u662f Online \u7684\uff0c\u5c31\u4e00\u5b9a\u662f inplace \u7684\uff1b</li>\n<li>\u53cd\u8fc7\u6765\u672a\u5fc5\uff0c\u4e5f\u5c31\u662f\u8bf4 inplace \u7684 DDL\uff0c\u6709\u53ef\u80fd\u4e0d\u662f Online \u7684\u3002\u622a\u6b62\u5230 MySQL 8.0\uff0c\u6dfb\u52a0\u5168\u6587\u7d22\u5f15\uff08FULLTEXT index\uff09\u548c\u7a7a\u95f4\u7d22\u5f15 (SPATIAL index) \u5c31\u5c5e\u4e8e\u8fd9\u79cd\u60c5\u51b5\u3002</li>\n</ol>\n<p>\u6700\u540e\uff0c\u6211\u4eec\u518d\u5ef6\u4f38\u4e00\u4e0b\u3002</p>\n<p>\u5728\u7b2c 10 \u7bc7\u6587\u7ae0[\u300aMySQL \u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u4f1a\u9009\u9519\u7d22\u5f15\u300b]\u7684\u8bc4\u8bba\u533a\u4e2d\uff0c\u6709\u540c\u5b66\u95ee\u5230\u4f7f\u7528 <code>optimize table</code>\u3001<code>analyze table</code> \u548c <code>alter table</code> \u8fd9\u4e09\u79cd\u65b9\u5f0f\u91cd\u5efa\u8868\u7684\u533a\u522b\u3002\u8fd9\u91cc\uff0c\u6211\u987a\u4fbf\u518d\u7b80\u5355\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u3002</p>\n<ul>\n<li>\u4ece MySQL 5.6 \u7248\u672c\u5f00\u59cb\uff0c<code>alter table t engine = InnoDB</code>\uff08\u4e5f\u5c31\u662f recreate\uff09\u9ed8\u8ba4\u7684\u5c31\u662f\u4e0a\u9762\u56fe 4 \u7684\u6d41\u7a0b\u4e86\uff1b</li>\n<li><code>analyze table t</code> \u5176\u5b9e\u4e0d\u662f\u91cd\u5efa\u8868\uff0c\u53ea\u662f\u5bf9\u8868\u7684\u7d22\u5f15\u4fe1\u606f\u505a\u91cd\u65b0\u7edf\u8ba1\uff0c\u6ca1\u6709\u4fee\u6539\u6570\u636e\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u52a0\u4e86 MDL \u8bfb\u9501\uff1b</li>\n<li><code>optimize table t</code> \u7b49\u4e8e <code>recreate+analyze</code>\u3002</li>\n</ul>\n<h3 id=\"_10\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_10\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\uff0c\u5982\u679c\u8981\u6536\u7f29\u4e00\u4e2a\u8868\uff0c\u53ea\u662f delete \u6389\u8868\u91cc\u9762\u4e0d\u7528\u7684\u6570\u636e\u7684\u8bdd\uff0c\u8868\u6587\u4ef6\u7684\u5927\u5c0f\u662f\u4e0d\u4f1a\u53d8\u7684\uff0c\u4f60\u8fd8\u8981\u901a\u8fc7 <code>alter table</code> \u547d\u4ee4\u91cd\u5efa\u8868\uff0c\u624d\u80fd\u8fbe\u5230\u8868\u6587\u4ef6\u53d8\u5c0f\u7684\u76ee\u7684\u3002\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u91cd\u5efa\u8868\u7684\u4e24\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff0cOnline DDL \u7684\u65b9\u5f0f\u662f\u53ef\u4ee5\u8003\u8651\u5728\u4e1a\u52a1\u4f4e\u5cf0\u671f\u4f7f\u7528\u7684\uff0c\u800c MySQL 5.5 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u8fd9\u4e2a\u547d\u4ee4\u662f\u4f1a\u963b\u585e DML \u7684\uff0c\u8fd9\u4e2a\u4f60\u9700\u8981\u7279\u522b\u5c0f\u5fc3\u3002</p>\n<h2 id=\"14-count\">14 <code>count()</code>\u8fd9\u4e48\u6162\uff0c\u6211\u8be5\u600e\u4e48\u529e\uff1f<a class=\"headerlink\" href=\"#14-count\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5f00\u53d1\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u7ecf\u5e38\u9700\u8981\u8ba1\u7b97\u4e00\u4e2a\u8868\u7684\u884c\u6570\uff0c\u6bd4\u5982\u4e00\u4e2a\u4ea4\u6613\u7cfb\u7edf\u7684\u6240\u6709\u53d8\u66f4\u8bb0\u5f55\u603b\u6570\u3002\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0c\u4e00\u6761 <code>select count(*) from t</code> \u8bed\u53e5\u4e0d\u5c31\u89e3\u51b3\u4e86\u5417\uff1f</p>\n<p>\u4f46\u662f\uff0c\u4f60\u4f1a\u53d1\u73b0\u968f\u7740\u7cfb\u7edf\u4e2d\u8bb0\u5f55\u6570\u8d8a\u6765\u8d8a\u591a\uff0c\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u5f97\u4e5f\u4f1a\u8d8a\u6765\u8d8a\u6162\u3002\u7136\u540e\u4f60\u53ef\u80fd\u5c31\u60f3\u4e86\uff0cMySQL \u600e\u4e48\u8fd9\u4e48\u7b28\u554a\uff0c\u8bb0\u4e2a\u603b\u6570\uff0c\u6bcf\u6b21\u8981\u67e5\u7684\u65f6\u5019\u76f4\u63a5\u8bfb\u51fa\u6765\uff0c\u4e0d\u5c31\u597d\u4e86\u5417\u3002</p>\n<p>\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u804a\u804a <code>count(*)</code> \u8bed\u53e5\u5230\u5e95\u662f\u600e\u6837\u5b9e\u73b0\u7684\uff0c\u4ee5\u53ca MySQL \u4e3a\u4ec0\u4e48\u4f1a\u8fd9\u4e48\u5b9e\u73b0\u3002\u7136\u540e\uff0c\u6211\u4f1a\u518d\u548c\u4f60\u8bf4\u8bf4\uff0c\u5982\u679c\u5e94\u7528\u4e2d\u6709\u8fd9\u79cd\u9891\u7e41\u53d8\u66f4\u5e76\u9700\u8981\u7edf\u8ba1\u8868\u884c\u6570\u7684\u9700\u6c42\uff0c\u4e1a\u52a1\u8bbe\u8ba1\u4e0a\u53ef\u4ee5\u600e\u4e48\u505a\u3002</p>\n<h3 id=\"count\"><code>count(*)</code> \u7684\u5b9e\u73b0\u65b9\u5f0f<a class=\"headerlink\" href=\"#count\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f60\u9996\u5148\u8981\u660e\u786e\u7684\u662f\uff0c\u5728\u4e0d\u540c\u7684 MySQL \u5f15\u64ce\u4e2d\uff0c<code>count(*)</code> \u6709\u4e0d\u540c\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002</p>\n<ul>\n<li>MyISAM \u5f15\u64ce\u628a\u4e00\u4e2a\u8868\u7684\u603b\u884c\u6570\u5b58\u5728\u4e86\u78c1\u76d8\u4e0a\uff0c\u56e0\u6b64\u6267\u884c <code>count(*)</code> \u7684\u65f6\u5019\u4f1a\u76f4\u63a5\u8fd4\u56de\u8fd9\u4e2a\u6570\uff0c\u6548\u7387\u5f88\u9ad8\uff1b</li>\n<li>\u800c InnoDB \u5f15\u64ce\u5c31\u9ebb\u70e6\u4e86\uff0c\u5b83\u6267\u884c <code>count(*)</code> \u7684\u65f6\u5019\uff0c\u9700\u8981\u628a\u6570\u636e\u4e00\u884c\u4e00\u884c\u5730\u4ece\u5f15\u64ce\u91cc\u9762\u8bfb\u51fa\u6765\uff0c\u7136\u540e\u7d2f\u79ef\u8ba1\u6570\u3002</li>\n</ul>\n<p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u5728\u8fd9\u7bc7\u6587\u7ae0\u91cc\u8ba8\u8bba\u7684\u662f\u6ca1\u6709\u8fc7\u6ee4\u6761\u4ef6\u7684 <code>count(*)</code>\uff0c\u5982\u679c\u52a0\u4e86 where \u6761\u4ef6\u7684\u8bdd\uff0cMyISAM \u8868\u4e5f\u662f\u4e0d\u80fd\u8fd4\u56de\u5f97\u8fd9\u4e48\u5feb\u7684\u3002</p>\n<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4e00\u8d77\u5206\u6790\u4e86\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528 InnoDB\uff0c\u56e0\u4e3a\u4e0d\u8bba\u662f\u5728\u4e8b\u52a1\u652f\u6301\u3001\u5e76\u53d1\u80fd\u529b\u8fd8\u662f\u5728\u6570\u636e\u5b89\u5168\u65b9\u9762\uff0cInnoDB \u90fd\u4f18\u4e8e MyISAM\u3002\u6211\u731c\u4f60\u7684\u8868\u4e5f\u4e00\u5b9a\u662f\u7528\u4e86 InnoDB \u5f15\u64ce\u3002\u8fd9\u5c31\u662f\u5f53\u4f60\u7684\u8bb0\u5f55\u6570\u8d8a\u6765\u8d8a\u591a\u7684\u65f6\u5019\uff0c\u8ba1\u7b97\u4e00\u4e2a\u8868\u7684\u603b\u884c\u6570\u4f1a\u8d8a\u6765\u8d8a\u6162\u7684\u539f\u56e0\u3002</p>\n<h3 id=\"count_1\">\u4e0d\u540c\u7684 count \u7528\u6cd5<a class=\"headerlink\" href=\"#count_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 <code>select count(?) from t</code> \u8fd9\u6837\u7684\u67e5\u8be2\u8bed\u53e5\u91cc\u9762\uff0c<code>count(*)</code>\u3001<code>count(\u4e3b\u952e id</code>)\u3001<code>count(\u5b57\u6bb5)</code> \u548c <code>count(1)</code> \u7b49\u4e0d\u540c\u7528\u6cd5\u7684\u6027\u80fd\uff0c\u6709\u54ea\u4e9b\u5dee\u522b\u3002\u4eca\u5929\u8c08\u5230\u4e86 <code>count(*)</code> \u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u5c31\u501f\u6b64\u673a\u4f1a\u548c\u4f60\u8be6\u7ec6\u8bf4\u660e\u4e00\u4e0b\u8fd9\u51e0\u79cd\u7528\u6cd5\u7684\u6027\u80fd\u5dee\u522b\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0b\u9762\u7684\u8ba8\u8bba\u8fd8\u662f\u57fa\u4e8e InnoDB \u5f15\u64ce\u7684\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u9996\u5148\u4f60\u8981\u5f04\u6e05\u695a <code>count()</code> \u7684\u8bed\u4e49\u3002<code>count()</code> \u662f\u4e00\u4e2a\u805a\u5408\u51fd\u6570\uff0c\u5bf9\u4e8e\u8fd4\u56de\u7684\u7ed3\u679c\u96c6\uff0c\u4e00\u884c\u884c\u5730\u5224\u65ad\uff0c\u5982\u679c <code>count</code> \u51fd\u6570\u7684\u53c2\u6570\u4e0d\u662f NULL\uff0c\u7d2f\u8ba1\u503c\u5c31\u52a0 1\uff0c\u5426\u5219\u4e0d\u52a0\u3002\u6700\u540e\u8fd4\u56de\u7d2f\u8ba1\u503c\u3002</p>\n<p>\u6240\u4ee5\uff0c<code>count(*)</code>\u3001<code>count(\u4e3b\u952e id</code>)\u3001<code>count(\u5b57\u6bb5)</code>\u548c <code>count(1)</code> \u90fd\u8868\u793a\u8fd4\u56de\u6ee1\u8db3\u6761\u4ef6\u7684\u7ed3\u679c\u96c6\u7684\u603b\u884c\u6570\uff1b\u800c <code>count(\u5b57\u6bb5</code>\uff09\uff0c\u5219\u8868\u793a\u8fd4\u56de\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u884c\u91cc\u9762\uff0c\u53c2\u6570\u201c\u5b57\u6bb5\u201d\u4e0d\u4e3a NULL \u7684\u603b\u4e2a\u6570\u3002</p>\n<p>\u81f3\u4e8e\u5206\u6790\u6027\u80fd\u5dee\u522b\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u8bb0\u4f4f\u8fd9\u4e48\u51e0\u4e2a\u539f\u5219\uff1a</p>\n<ol>\n<li>server \u5c42\u8981\u4ec0\u4e48\u5c31\u7ed9\u4ec0\u4e48\uff1b</li>\n<li>InnoDB \u53ea\u7ed9\u5fc5\u8981\u7684\u503c\uff1b</li>\n<li>\u73b0\u5728\u7684\u4f18\u5316\u5668\u53ea\u4f18\u5316\u4e86 <code>count(*)</code> \u7684\u8bed\u4e49\u4e3a\u201c\u53d6\u884c\u6570\u201d\uff0c\u5176\u4ed6\u201c\u663e\u800c\u6613\u89c1\u201d\u7684\u4f18\u5316\u5e76\u6ca1\u6709\u505a\u3002</li>\n</ol>\n<p>\u8fd9\u662f\u4ec0\u4e48\u610f\u601d\u5462\uff1f\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u4e2a\u4e2a\u5730\u6765\u770b\u770b\u3002</p>\n<p><strong>\u5bf9\u4e8e count(\u4e3b\u952e id) \u6765\u8bf4</strong>\uff0cInnoDB \u5f15\u64ce\u4f1a\u904d\u5386\u6574\u5f20\u8868\uff0c\u628a\u6bcf\u4e00\u884c\u7684 id \u503c\u90fd\u53d6\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 server \u5c42\u3002server \u5c42\u62ff\u5230 id \u540e\uff0c\u5224\u65ad\u662f\u4e0d\u53ef\u80fd\u4e3a\u7a7a\u7684\uff0c\u5c31\u6309\u884c\u7d2f\u52a0\u3002</p>\n<p><strong>\u5bf9\u4e8e count(1) \u6765\u8bf4</strong>\uff0cInnoDB \u5f15\u64ce\u904d\u5386\u6574\u5f20\u8868\uff0c\u4f46\u4e0d\u53d6\u503c\u3002server \u5c42\u5bf9\u4e8e\u8fd4\u56de\u7684\u6bcf\u4e00\u884c\uff0c\u653e\u4e00\u4e2a\u6570\u5b57\u201c1\u201d\u8fdb\u53bb\uff0c\u5224\u65ad\u662f\u4e0d\u53ef\u80fd\u4e3a\u7a7a\u7684\uff0c\u6309\u884c\u7d2f\u52a0\u3002</p>\n<p>\u5355\u770b\u8fd9\u4e24\u4e2a\u7528\u6cd5\u7684\u5dee\u522b\u7684\u8bdd\uff0c\u4f60\u80fd\u5bf9\u6bd4\u51fa\u6765\uff0c<code>count(1)</code> \u6267\u884c\u5f97\u8981\u6bd4 <code>count(\u4e3b\u952e id)</code> \u5feb\u3002\u56e0\u4e3a\u4ece\u5f15\u64ce\u8fd4\u56de id \u4f1a\u6d89\u53ca\u5230\u89e3\u6790\u6570\u636e\u884c\uff0c\u4ee5\u53ca\u62f7\u8d1d\u5b57\u6bb5\u503c\u7684\u64cd\u4f5c\u3002</p>\n<p><strong>\u5bf9\u4e8e count(\u5b57\u6bb5) \u6765\u8bf4</strong>\uff1a</p>\n<ol>\n<li>\u5982\u679c\u8fd9\u4e2a\u201c\u5b57\u6bb5\u201d\u662f\u5b9a\u4e49\u4e3a not null \u7684\u8bdd\uff0c\u4e00\u884c\u884c\u5730\u4ece\u8bb0\u5f55\u91cc\u9762\u8bfb\u51fa\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5224\u65ad\u4e0d\u80fd\u4e3a null\uff0c\u6309\u884c\u7d2f\u52a0\uff1b</li>\n<li>\u5982\u679c\u8fd9\u4e2a\u201c\u5b57\u6bb5\u201d\u5b9a\u4e49\u5141\u8bb8\u4e3a null\uff0c\u90a3\u4e48\u6267\u884c\u7684\u65f6\u5019\uff0c\u5224\u65ad\u5230\u6709\u53ef\u80fd\u662f null\uff0c\u8fd8\u8981\u628a\u503c\u53d6\u51fa\u6765\u518d\u5224\u65ad\u4e00\u4e0b\uff0c\u4e0d\u662f null \u624d\u7d2f\u52a0\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u524d\u9762\u7684\u7b2c\u4e00\u6761\u539f\u5219\uff0cserver \u5c42\u8981\u4ec0\u4e48\u5b57\u6bb5\uff0cInnoDB \u5c31\u8fd4\u56de\u4ec0\u4e48\u5b57\u6bb5\u3002</p>\n<p>\u4f46\u662f <code>count(*)</code> \u662f\u4f8b\u5916\uff0c\u5e76\u4e0d\u4f1a\u628a\u5168\u90e8\u5b57\u6bb5\u53d6\u51fa\u6765\uff0c\u800c\u662f\u4e13\u95e8\u505a\u4e86\u4f18\u5316\uff0c\u4e0d\u53d6\u503c\u3002<code>count(*)</code> \u80af\u5b9a\u4e0d\u662f null\uff0c\u6309\u884c\u7d2f\u52a0\u3002</p>\n<p>\u6240\u4ee5\u7ed3\u8bba\u662f\uff1a\u6309\u7167\u6548\u7387\u6392\u5e8f\u7684\u8bdd\uff0c<code>count(\u5b57\u6bb5)</code>\\&lt;<code>count(\u4e3b\u952e id)</code>\\&lt;<code>count(1)</code>\u2248<code>count(*)</code>\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\uff0c\u5c3d\u91cf\u4f7f\u7528 <code>count(*)</code>\u3002</p>\n<h3 id=\"_11\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_11\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u804a\u4e86\u804a MySQL \u4e2d\u83b7\u5f97\u8868\u884c\u6570\u7684\u4e24\u79cd\u65b9\u6cd5\u3002\u6211\u4eec\u63d0\u5230\u4e86\u5728\u4e0d\u540c\u5f15\u64ce\u4e2d count(*) \u7684\u5b9e\u73b0\u65b9\u5f0f\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e5f\u5206\u6790\u4e86\u7528\u7f13\u5b58\u7cfb\u7edf\u6765\u5b58\u50a8\u8ba1\u6570\u503c\u5b58\u5728\u7684\u95ee\u9898\u3002</p>\n<p>\u5176\u5b9e\uff0c\u628a\u8ba1\u6570\u653e\u5728 Redis \u91cc\u9762\uff0c\u4e0d\u80fd\u591f\u4fdd\u8bc1\u8ba1\u6570\u548c MySQL \u8868\u91cc\u7684\u6570\u636e\u7cbe\u786e\u4e00\u81f4\u7684\u539f\u56e0\uff0c\u662f\u8fd9\u4e24\u4e2a\u4e0d\u540c\u7684\u5b58\u50a8\u6784\u6210\u7684\u7cfb\u7edf\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u65e0\u6cd5\u62ff\u5230\u7cbe\u786e\u4e00\u81f4\u7684\u89c6\u56fe\u3002\u800c\u628a\u8ba1\u6570\u503c\u4e5f\u653e\u5728 MySQL \u4e2d\uff0c\u5c31\u89e3\u51b3\u4e86\u4e00\u81f4\u6027\u89c6\u56fe\u7684\u95ee\u9898\u3002</p>\n<p>InnoDB \u5f15\u64ce\u652f\u6301\u4e8b\u52a1\uff0c\u6211\u4eec\u5229\u7528\u597d\u4e8b\u52a1\u7684\u539f\u5b50\u6027\u548c\u9694\u79bb\u6027\uff0c\u5c31\u53ef\u4ee5\u7b80\u5316\u5728\u4e1a\u52a1\u5f00\u53d1\u65f6\u7684\u903b\u8f91\u3002\u8fd9\u4e5f\u662f InnoDB \u5f15\u64ce\u5907\u53d7\u9752\u7750\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>\n<h2 id=\"15\">15 \u7b54\u7591\u6587\u7ae0\uff08\u4e00\uff09\uff1a\u65e5\u5fd7\u548c\u7d22\u5f15\u76f8\u5173\u95ee\u9898<a class=\"headerlink\" href=\"#15\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u66f4\u65b0\u524d\uff0cMySQL \u5b9e\u6218\u8fd9\u4e2a\u4e13\u680f\u5df2\u7ecf\u66f4\u65b0\u4e86 14 \u7bc7\u3002\u5728\u8fd9\u4e9b\u6587\u7ae0\u4e2d\uff0c\u5927\u5bb6\u5728\u8bc4\u8bba\u533a\u7559\u4e0b\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u7559\u8a00\u3002\u73b0\u5728\uff0c\u6bcf\u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u90fd\u6709\u70ed\u5fc3\u7684\u540c\u5b66\u5e2e\u5fd9\u603b\u7ed3\u6587\u7ae0\u77e5\u8bc6\u70b9\uff0c\u4e5f\u6709\u4e0d\u5c11\u540c\u5b66\u63d0\u51fa\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u95ee\u9898\uff0c\u66f4\u6709\u4e00\u4e9b\u540c\u5b66\u5e2e\u5fd9\u89e3\u7b54\u5176\u4ed6\u540c\u5b66\u63d0\u51fa\u7684\u95ee\u9898\u3002</p>\n<p>\u5728\u6d4f\u89c8\u8fd9\u4e9b\u7559\u8a00\u5e76\u56de\u590d\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6211\u500d\u53d7\u9f13\u821e\uff0c\u4e5f\u5c3d\u6211\u6240\u77e5\u5730\u5e2e\u52a9\u4f60\u89e3\u51b3\u95ee\u9898\u3001\u548c\u4f60\u8ba8\u8bba\u3002\u53ef\u4ee5\u8bf4\uff0c\u4f60\u4eec\u7684\u7559\u8a00\u6d3b\u8dc3\u4e86\u6574\u4e2a\u4e13\u680f\u7684\u6c1b\u56f4\u3001\u63d0\u5347\u4e86\u6574\u4e2a\u4e13\u680f\u7684\u8d28\u91cf\uff0c\u8c22\u8c22\u4f60\u4eec\u3002</p>\n<p>\u8bc4\u8bba\u533a\u7684\u5927\u591a\u6570\u7559\u8a00\u6211\u90fd\u76f4\u63a5\u56de\u590d\u4e86\uff0c\u5bf9\u4e8e\u9700\u8981\u5c55\u5f00\u8bf4\u660e\u7684\u95ee\u9898\uff0c\u6211\u90fd\u62ff\u51fa\u5c0f\u672c\u5b50\u8bb0\u4e86\u4e0b\u6765\u3002\u8fd9\u4e9b\u88ab\u8bb0\u4e0b\u6765\u7684\u95ee\u9898\uff0c\u5c31\u662f\u6211\u4eec\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u7684\u7d20\u6750\u4e86\u3002</p>\n<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u5df2\u7ecf\u6536\u96c6\u4e86 47 \u4e2a\u95ee\u9898\uff0c\u5f88\u96be\u901a\u8fc7\u4eca\u5929\u8fd9\u4e00\u7bc7\u6587\u7ae0\u5168\u90e8\u5c55\u5f00\u3002\u6240\u4ee5\uff0c\u6211\u5c31\u5148\u4ece\u4e2d\u627e\u4e86\u51e0\u4e2a\u8054\u7cfb\u975e\u5e38\u7d27\u5bc6\u7684\u95ee\u9898\uff0c\u4e32\u4e86\u8d77\u6765\uff0c\u5e0c\u671b\u53ef\u4ee5\u5e2e\u4f60\u89e3\u51b3\u5173\u4e8e\u65e5\u5fd7\u548c\u7d22\u5f15\u7684\u4e00\u4e9b\u7591\u60d1\u3002\u800c\u5176\u4ed6\u95ee\u9898\uff0c\u6211\u4eec\u5c31\u7559\u7740\u540e\u9762\u6162\u6162\u5c55\u5f00\u5427\u3002</p>\n<h3 id=\"_12\">\u65e5\u5fd7\u76f8\u5173\u95ee\u9898<a class=\"headerlink\" href=\"#_12\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u5728\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\uff0c\u548c\u4f60\u8bb2\u5230 binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u548c redo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\u914d\u5408\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u53cd\u8bc1\u6cd5\uff0c\u8bf4\u660e\u4e86\u5982\u679c\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u4f1a\u5bfc\u81f4 MySQL \u51fa\u73b0\u4e3b\u5907\u6570\u636e\u4e0d\u4e00\u81f4\u7b49\u95ee\u9898\u3002</p>\n<p>\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e0b\u9762\uff0c\u5f88\u591a\u540c\u5b66\u5728\u95ee\uff0c\u5728\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u4e0d\u540c\u77ac\u95f4\uff0cMySQL \u5982\u679c\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u5b8c\u6574\u6027\u7684\uff1f</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u5f00\u59cb\u5427\u3002</p>\n<p>\u6211\u518d\u653e\u4e00\u6b21\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u56fe\uff0c\u65b9\u4fbf\u4f60\u5b66\u4e60\u4e0b\u9762\u7684\u5185\u5bb9\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/ee9af616e05e4b853eba27048351f62a.jpg\" /></p>\n<p>\u56fe 1 \u4e24\u9636\u6bb5\u63d0\u4ea4\u793a\u610f\u56fe</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u8981\u5148\u548c\u4f60\u89e3\u91ca\u4e00\u4e2a\u8bef\u4f1a\u5f0f\u7684\u95ee\u9898\u3002\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u95ee\u5230\uff0c\u8fd9\u4e2a\u56fe\u4e0d\u662f\u4e00\u4e2a update \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5417\uff0c\u600e\u4e48\u8fd8\u4f1a\u8c03\u7528 commit \u8bed\u53e5\uff1f</p>\n<p>\u4ed6\u4ea7\u751f\u8fd9\u4e2a\u7591\u95ee\u7684\u539f\u56e0\uff0c\u662f\u628a**\u4e24\u4e2a\u201ccommit\u201d\u7684\u6982\u5ff5**\u6df7\u6dc6\u4e86\uff1a</p>\n<ul>\n<li>\u4ed6\u8bf4\u7684\u201ccommit \u8bed\u53e5\u201d\uff0c\u662f\u6307 MySQL \u8bed\u6cd5\u4e2d\uff0c\u7528\u4e8e\u63d0\u4ea4\u4e00\u4e2a\u4e8b\u52a1\u7684\u547d\u4ee4\u3002\u4e00\u822c\u8ddf begin/start transaction \u914d\u5bf9\u4f7f\u7528\u3002</li>\n<li>\u800c\u6211\u4eec\u56fe\u4e2d\u7528\u5230\u7684\u8fd9\u4e2a\u201ccommit \u6b65\u9aa4\u201d\uff0c\u6307\u7684\u662f\u4e8b\u52a1\u63d0\u4ea4\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e2a\u5c0f\u6b65\u9aa4\uff0c\u4e5f\u662f\u6700\u540e\u4e00\u6b65\u3002\u5f53\u8fd9\u4e2a\u6b65\u9aa4\u6267\u884c\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5c31\u63d0\u4ea4\u5b8c\u6210\u4e86\u3002</li>\n<li>\u201ccommit \u8bed\u53e5\u201d\u6267\u884c\u7684\u65f6\u5019\uff0c\u4f1a\u5305\u542b\u201ccommit \u6b65\u9aa4\u201d\u3002</li>\n</ul>\n<p>\u800c\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u9762\uff0c\u6ca1\u6709\u663e\u5f0f\u5730\u5f00\u542f\u4e8b\u52a1\uff0c\u56e0\u6b64\u8fd9\u4e2a update \u8bed\u53e5\u81ea\u5df1\u5c31\u662f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u6267\u884c\u5b8c\u6210\u540e\u63d0\u4ea4\u4e8b\u52a1\u65f6\uff0c\u5c31\u4f1a\u7528\u5230\u8fd9\u4e2a\u201ccommit \u6b65\u9aa4\u201c\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u5206\u6790\u4e00\u4e0b**\u5728\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u4e0d\u540c\u65f6\u523b\uff0cMySQL \u5f02\u5e38\u91cd\u542f\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u3002**</p>\n<p>\u5982\u679c\u5728\u56fe\u4e2d\u65f6\u523b A \u7684\u5730\u65b9\uff0c\u4e5f\u5c31\u662f\u5199\u5165 redo log \u5904\u4e8e prepare \u9636\u6bb5\u4e4b\u540e\u3001\u5199 binlog \u4e4b\u524d\uff0c\u53d1\u751f\u4e86\u5d29\u6e83\uff08crash\uff09\uff0c\u7531\u4e8e\u6b64\u65f6 binlog \u8fd8\u6ca1\u5199\uff0credo log \u4e5f\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u6240\u4ee5\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u56de\u6eda\u3002\u8fd9\u65f6\u5019\uff0cbinlog \u8fd8\u6ca1\u5199\uff0c\u6240\u4ee5\u4e5f\u4e0d\u4f1a\u4f20\u5230\u5907\u5e93\u3002\u5230\u8fd9\u91cc\uff0c\u5927\u5bb6\u90fd\u53ef\u4ee5\u7406\u89e3\u3002</p>\n<p>\u5927\u5bb6\u51fa\u73b0\u95ee\u9898\u7684\u5730\u65b9\uff0c\u4e3b\u8981\u96c6\u4e2d\u5728\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\uff0credo log \u8fd8\u6ca1 commit \u524d\u53d1\u751f crash\uff0c\u90a3\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019 MySQL \u4f1a\u600e\u4e48\u5904\u7406\uff1f</p>\n<p>\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u5d29\u6e83\u6062\u590d\u65f6\u7684\u5224\u65ad\u89c4\u5219\u3002</p>\n<ol>\n<li>\u5982\u679c redo log \u91cc\u9762\u7684\u4e8b\u52a1\u662f\u5b8c\u6574\u7684\uff0c\u4e5f\u5c31\u662f\u5df2\u7ecf\u6709\u4e86 commit \u6807\u8bc6\uff0c\u5219\u76f4\u63a5\u63d0\u4ea4\uff1b</li>\n<li>\u5982\u679c redo log \u91cc\u9762\u7684\u4e8b\u52a1\u53ea\u6709\u5b8c\u6574\u7684 prepare\uff0c\u5219\u5224\u65ad\u5bf9\u5e94\u7684\u4e8b\u52a1 binlog \u662f\u5426\u5b58\u5728\u5e76\u5b8c\u6574\uff1a a. \u5982\u679c\u662f\uff0c\u5219\u63d0\u4ea4\u4e8b\u52a1\uff1b b. \u5426\u5219\uff0c\u56de\u6eda\u4e8b\u52a1\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\uff0c\u65f6\u523b B \u53d1\u751f crash \u5bf9\u5e94\u7684\u5c31\u662f 2(a) \u7684\u60c5\u51b5\uff0c\u5d29\u6e83\u6062\u590d\u8fc7\u7a0b\u4e2d\u4e8b\u52a1\u4f1a\u88ab\u63d0\u4ea4\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u7ee7\u7eed\u5ef6\u5c55\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<h3 id=\"1mysql-binlog\">\u8ffd\u95ee 1\uff1aMySQL \u600e\u4e48\u77e5\u9053 binlog \u662f\u5b8c\u6574\u7684?<a class=\"headerlink\" href=\"#1mysql-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u6709\u5b8c\u6574\u683c\u5f0f\u7684\uff1a</p>\n<ul>\n<li>statement \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709 COMMIT\uff1b</li>\n<li>row \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709\u4e00\u4e2a XID event\u3002</li>\n</ul>\n<p>\u53e6\u5916\uff0c\u5728 MySQL 5.6.2 \u7248\u672c\u4ee5\u540e\uff0c\u8fd8\u5f15\u5165\u4e86 binlog-checksum \u53c2\u6570\uff0c\u7528\u6765\u9a8c\u8bc1 binlog \u5185\u5bb9\u7684\u6b63\u786e\u6027\u3002\u5bf9\u4e8e binlog \u65e5\u5fd7\u7531\u4e8e\u78c1\u76d8\u539f\u56e0\uff0c\u53ef\u80fd\u4f1a\u5728\u65e5\u5fd7\u4e2d\u95f4\u51fa\u9519\u7684\u60c5\u51b5\uff0cMySQL \u53ef\u4ee5\u901a\u8fc7\u6821\u9a8c checksum \u7684\u7ed3\u679c\u6765\u53d1\u73b0\u3002\u6240\u4ee5\uff0cMySQL \u8fd8\u662f\u6709\u529e\u6cd5\u9a8c\u8bc1\u4e8b\u52a1 binlog \u7684\u5b8c\u6574\u6027\u7684\u3002</p>\n<h3 id=\"2redo-log-binlog\">\u8ffd\u95ee 2\uff1aredo log \u548c binlog \u662f\u600e\u4e48\u5173\u8054\u8d77\u6765\u7684?<a class=\"headerlink\" href=\"#2redo-log-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u5b83\u4eec\u6709\u4e00\u4e2a\u5171\u540c\u7684\u6570\u636e\u5b57\u6bb5\uff0c\u53eb XID\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u4f1a\u6309\u987a\u5e8f\u626b\u63cf redo log\uff1a</p>\n<ul>\n<li>\u5982\u679c\u78b0\u5230\u65e2\u6709 prepare\u3001\u53c8\u6709 commit \u7684 redo log\uff0c\u5c31\u76f4\u63a5\u63d0\u4ea4\uff1b</li>\n<li>\u5982\u679c\u78b0\u5230\u53ea\u6709 parepare\u3001\u800c\u6ca1\u6709 commit \u7684 redo log\uff0c\u5c31\u62ff\u7740 XID \u53bb binlog \u627e\u5bf9\u5e94\u7684\u4e8b\u52a1\u3002</li>\n</ul>\n<h3 id=\"3-prepare-redo-log-binlogmysql\">\u8ffd\u95ee 3\uff1a\u5904\u4e8e prepare \u9636\u6bb5\u7684 redo log \u52a0\u4e0a\u5b8c\u6574 binlog\uff0c\u91cd\u542f\u5c31\u80fd\u6062\u590d\uff0cMySQL \u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u8bbe\u8ba1?<a class=\"headerlink\" href=\"#3-prepare-redo-log-binlogmysql\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u5176\u5b9e\uff0c\u8fd9\u4e2a\u95ee\u9898\u8fd8\u662f\u8ddf\u6211\u4eec\u5728\u53cd\u8bc1\u6cd5\u4e2d\u8bf4\u5230\u7684\u6570\u636e\u4e0e\u5907\u4efd\u7684\u4e00\u81f4\u6027\u6709\u5173\u3002\u5728\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\u4ee5\u540e MySQL \u53d1\u751f\u5d29\u6e83\uff0c\u8fd9\u65f6\u5019 binlog \u5df2\u7ecf\u5199\u5165\u4e86\uff0c\u4e4b\u540e\u5c31\u4f1a\u88ab\u4ece\u5e93\uff08\u6216\u8005\u7528\u8fd9\u4e2a binlog \u6062\u590d\u51fa\u6765\u7684\u5e93\uff09\u4f7f\u7528\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5728\u4e3b\u5e93\u4e0a\u4e5f\u8981\u63d0\u4ea4\u8fd9\u4e2a\u4e8b\u52a1\u3002\u91c7\u7528\u8fd9\u4e2a\u7b56\u7565\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u7684\u6570\u636e\u5c31\u4fdd\u8bc1\u4e86\u4e00\u81f4\u6027\u3002</p>\n<h3 id=\"4-redo-log-binlog\">\u8ffd\u95ee 4\uff1a\u5982\u679c\u8fd9\u6837\u7684\u8bdd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u4e24\u9636\u6bb5\u63d0\u4ea4\u5462\uff1f\u5e72\u8106\u5148 redo log \u5199\u5b8c\uff0c\u518d\u5199 binlog\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u5fc5\u987b\u5f97\u4e24\u4e2a\u65e5\u5fd7\u90fd\u5b8c\u6574\u624d\u53ef\u4ee5\u3002\u662f\u4e0d\u662f\u4e00\u6837\u7684\u903b\u8f91\uff1f<a class=\"headerlink\" href=\"#4-redo-log-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u5176\u5b9e\uff0c\u4e24\u9636\u6bb5\u63d0\u4ea4\u662f\u7ecf\u5178\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u95ee\u9898\uff0c\u5e76\u4e0d\u662f MySQL \u72ec\u6709\u7684\u3002</p>\n<p>\u5982\u679c\u5fc5\u987b\u8981\u4e3e\u4e00\u4e2a\u573a\u666f\uff0c\u6765\u8bf4\u660e\u8fd9\u4e48\u505a\u7684\u5fc5\u8981\u6027\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u95ee\u9898\u3002</p>\n<p>\u5bf9\u4e8e InnoDB \u5f15\u64ce\u6765\u8bf4\uff0c\u5982\u679c redo log \u63d0\u4ea4\u5b8c\u6210\u4e86\uff0c\u4e8b\u52a1\u5c31\u4e0d\u80fd\u56de\u6eda\uff08\u5982\u679c\u8fd9\u8fd8\u5141\u8bb8\u56de\u6eda\uff0c\u5c31\u53ef\u80fd\u8986\u76d6\u6389\u522b\u7684\u4e8b\u52a1\u7684\u66f4\u65b0\uff09\u3002\u800c\u5982\u679c redo log \u76f4\u63a5\u63d0\u4ea4\uff0c\u7136\u540e binlog \u5199\u5165\u7684\u65f6\u5019\u5931\u8d25\uff0cInnoDB \u53c8\u56de\u6eda\u4e0d\u4e86\uff0c\u6570\u636e\u548c binlog \u65e5\u5fd7\u53c8\u4e0d\u4e00\u81f4\u4e86\u3002</p>\n<p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u4e3a\u4e86\u7ed9\u6240\u6709\u4eba\u4e00\u4e2a\u673a\u4f1a\uff0c\u5f53\u6bcf\u4e2a\u4eba\u90fd\u8bf4\u201c\u6211 ok\u201d\u7684\u65f6\u5019\uff0c\u518d\u4e00\u8d77\u63d0\u4ea4\u3002</p>\n<h3 id=\"5-binlog\">\u8ffd\u95ee 5\uff1a\u4e0d\u5f15\u5165\u4e24\u4e2a\u65e5\u5fd7\uff0c\u4e5f\u5c31\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u5fc5\u8981\u4e86\u3002\u53ea\u7528 binlog \u6765\u652f\u6301\u5d29\u6e83\u6062\u590d\uff0c\u53c8\u80fd\u652f\u6301\u5f52\u6863\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4e86\uff1f<a class=\"headerlink\" href=\"#5-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u8fd9\u4f4d\u540c\u5b66\u7684\u610f\u601d\u662f\uff0c\u53ea\u4fdd\u7559 binlog\uff0c\u7136\u540e\u53ef\u4ee5\u628a\u63d0\u4ea4\u6d41\u7a0b\u6539\u6210\u8fd9\u6837\uff1a\u2026 -&gt; \u201c\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u201d -&gt; \u201c\u5199 binlog\u201d -&gt; \u201c\u63d0\u4ea4\u4e8b\u52a1\u201d\uff0c\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u5d29\u6e83\u6062\u590d\u7684\u80fd\u529b\uff1f</p>\n<p>\u7b54\u6848\u662f\u4e0d\u53ef\u4ee5\u3002</p>\n<p>\u5982\u679c\u8bf4**\u5386\u53f2\u539f\u56e0**\u7684\u8bdd\uff0c\u90a3\u5c31\u662f InnoDB \u5e76\u4e0d\u662f MySQL \u7684\u539f\u751f\u5b58\u50a8\u5f15\u64ce\u3002MySQL \u7684\u539f\u751f\u5f15\u64ce\u662f MyISAM\uff0c\u8bbe\u8ba1\u4e4b\u521d\u5c31\u6709\u6ca1\u6709\u652f\u6301\u5d29\u6e83\u6062\u590d\u3002</p>\n<p>InnoDB \u5728\u4f5c\u4e3a MySQL \u7684\u63d2\u4ef6\u52a0\u5165 MySQL \u5f15\u64ce\u5bb6\u65cf\u4e4b\u524d\uff0c\u5c31\u5df2\u7ecf\u662f\u4e00\u4e2a\u63d0\u4f9b\u4e86\u5d29\u6e83\u6062\u590d\u548c\u4e8b\u52a1\u652f\u6301\u7684\u5f15\u64ce\u4e86\u3002</p>\n<p>InnoDB \u63a5\u5165\u4e86 MySQL \u540e\uff0c\u53d1\u73b0\u65e2\u7136 binlog \u6ca1\u6709\u5d29\u6e83\u6062\u590d\u7684\u80fd\u529b\uff0c\u90a3\u5c31\u7528 InnoDB \u539f\u6709\u7684 redo log \u597d\u4e86\u3002</p>\n<p>\u800c\u5982\u679c\u8bf4**\u5b9e\u73b0\u4e0a\u7684\u539f\u56e0**\u7684\u8bdd\uff0c\u5c31\u6709\u5f88\u591a\u4e86\u3002\u5c31\u6309\u7167\u95ee\u9898\u4e2d\u8bf4\u7684\uff0c\u53ea\u7528 binlog \u6765\u5b9e\u73b0\u5d29\u6e83\u6062\u590d\u7684\u6d41\u7a0b\uff0c\u6211\u753b\u4e86\u4e00\u5f20\u793a\u610f\u56fe\uff0c\u8fd9\u91cc\u5c31\u6ca1\u6709 redo log \u4e86\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/eb838b87e9c20fa00aca50ef154f2a63.jpg\" /></p>\n<p>\u56fe 2 \u53ea\u7528 binlog \u652f\u6301\u5d29\u6e83\u6062\u590d</p>\n<p>\u8fd9\u6837\u7684\u6d41\u7a0b\u4e0b\uff0cbinlog \u8fd8\u662f\u4e0d\u80fd\u652f\u6301\u5d29\u6e83\u6062\u590d\u7684\u3002\u6211\u8bf4\u4e00\u4e2a\u4e0d\u652f\u6301\u7684\u70b9\u5427\uff1abinlog \u6ca1\u6709\u80fd\u529b\u6062\u590d\u201c\u6570\u636e\u9875\u201d\u3002</p>\n<p>\u5982\u679c\u5728\u56fe\u4e2d\u6807\u7684\u4f4d\u7f6e\uff0c\u4e5f\u5c31\u662f binlog2 \u5199\u5b8c\u4e86\uff0c\u4f46\u662f\u6574\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u6709 commit \u7684\u65f6\u5019\uff0cMySQL \u53d1\u751f\u4e86 crash\u3002</p>\n<p>\u91cd\u542f\u540e\uff0c\u5f15\u64ce\u5185\u90e8\u4e8b\u52a1 2 \u4f1a\u56de\u6eda\uff0c\u7136\u540e\u5e94\u7528 binlog2 \u53ef\u4ee5\u8865\u56de\u6765\uff1b\u4f46\u662f\u5bf9\u4e8e\u4e8b\u52a1 1 \u6765\u8bf4\uff0c\u7cfb\u7edf\u5df2\u7ecf\u8ba4\u4e3a\u63d0\u4ea4\u5b8c\u6210\u4e86\uff0c\u4e0d\u4f1a\u518d\u5e94\u7528\u4e00\u6b21 binlog1\u3002</p>\n<p>\u4f46\u662f\uff0cInnoDB \u5f15\u64ce\u4f7f\u7528\u7684\u662f WAL \u6280\u672f\uff0c\u6267\u884c\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u5199\u5b8c\u5185\u5b58\u548c\u65e5\u5fd7\uff0c\u4e8b\u52a1\u5c31\u7b97\u5b8c\u6210\u4e86\u3002\u5982\u679c\u4e4b\u540e\u5d29\u6e83\uff0c\u8981\u4f9d\u8d56\u4e8e\u65e5\u5fd7\u6765\u6062\u590d\u6570\u636e\u9875\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\u5728\u56fe\u4e2d\u8fd9\u4e2a\u4f4d\u7f6e\u53d1\u751f\u5d29\u6e83\u7684\u8bdd\uff0c\u4e8b\u52a1 1 \u4e5f\u662f\u53ef\u80fd\u4e22\u5931\u4e86\u7684\uff0c\u800c\u4e14\u662f\u6570\u636e\u9875\u7ea7\u7684\u4e22\u5931\u3002\u6b64\u65f6\uff0cbinlog \u91cc\u9762\u5e76\u6ca1\u6709\u8bb0\u5f55\u6570\u636e\u9875\u7684\u66f4\u65b0\u7ec6\u8282\uff0c\u662f\u8865\u4e0d\u56de\u6765\u7684\u3002</p>\n<p>\u4f60\u5982\u679c\u8981\u8bf4\uff0c\u90a3\u6211\u4f18\u5316\u4e00\u4e0b binlog \u7684\u5185\u5bb9\uff0c\u8ba9\u5b83\u6765\u8bb0\u5f55\u6570\u636e\u9875\u7684\u66f4\u6539\u53ef\u4ee5\u5417\uff1f\u4f46\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u53c8\u505a\u4e86\u4e00\u4e2a redo log \u51fa\u6765\u3002</p>\n<p>\u6240\u4ee5\uff0c\u81f3\u5c11\u73b0\u5728\u7684 binlog \u80fd\u529b\uff0c\u8fd8\u4e0d\u80fd\u652f\u6301\u5d29\u6e83\u6062\u590d\u3002</p>\n<h3 id=\"6-redo-log-binlog\">\u8ffd\u95ee 6\uff1a\u90a3\u80fd\u4e0d\u80fd\u53cd\u8fc7\u6765\uff0c\u53ea\u7528 redo log\uff0c\u4e0d\u8981 binlog\uff1f<a class=\"headerlink\" href=\"#6-redo-log-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u5982\u679c\u53ea\u4ece\u5d29\u6e83\u6062\u590d\u7684\u89d2\u5ea6\u6765\u8bb2\u662f\u53ef\u4ee5\u7684\u3002\u4f60\u53ef\u4ee5\u628a binlog \u5173\u6389\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\u4e86\uff0c\u4f46\u7cfb\u7edf\u4f9d\u7136\u662f crash-safe \u7684\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u4e86\u89e3\u4e00\u4e0b\u4e1a\u754c\u5404\u4e2a\u516c\u53f8\u7684\u4f7f\u7528\u573a\u666f\u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\u5728\u6b63\u5f0f\u7684\u751f\u4ea7\u5e93\u4e0a\uff0cbinlog \u90fd\u662f\u5f00\u7740\u7684\u3002\u56e0\u4e3a binlog \u6709\u7740 redo log \u65e0\u6cd5\u66ff\u4ee3\u7684\u529f\u80fd\u3002</p>\n<p>\u4e00\u4e2a\u662f\u5f52\u6863\u3002redo log \u662f\u5faa\u73af\u5199\uff0c\u5199\u5230\u672b\u5c3e\u662f\u8981\u56de\u5230\u5f00\u5934\u7ee7\u7eed\u5199\u7684\u3002\u8fd9\u6837\u5386\u53f2\u65e5\u5fd7\u6ca1\u6cd5\u4fdd\u7559\uff0credo log \u4e5f\u5c31\u8d77\u4e0d\u5230\u5f52\u6863\u7684\u4f5c\u7528\u3002</p>\n<p>\u4e00\u4e2a\u5c31\u662f MySQL \u7cfb\u7edf\u4f9d\u8d56\u4e8e binlog\u3002binlog \u4f5c\u4e3a MySQL \u4e00\u5f00\u59cb\u5c31\u6709\u7684\u529f\u80fd\uff0c\u88ab\u7528\u5728\u4e86\u5f88\u591a\u5730\u65b9\u3002\u5176\u4e2d\uff0cMySQL \u7cfb\u7edf\u9ad8\u53ef\u7528\u7684\u57fa\u7840\uff0c\u5c31\u662f binlog \u590d\u5236\u3002</p>\n<p>\u8fd8\u6709\u5f88\u591a\u516c\u53f8\u6709\u5f02\u6784\u7cfb\u7edf\uff08\u6bd4\u5982\u4e00\u4e9b\u6570\u636e\u5206\u6790\u7cfb\u7edf\uff09\uff0c\u8fd9\u4e9b\u7cfb\u7edf\u5c31\u9760\u6d88\u8d39 MySQL \u7684 binlog \u6765\u66f4\u65b0\u81ea\u5df1\u7684\u6570\u636e\u3002\u5173\u6389 binlog \u7684\u8bdd\uff0c\u8fd9\u4e9b\u4e0b\u6e38\u7cfb\u7edf\u5c31\u6ca1\u6cd5\u8f93\u5165\u4e86\u3002</p>\n<p>\u603b\u4e4b\uff0c\u7531\u4e8e\u73b0\u5728\u5305\u62ec MySQL \u9ad8\u53ef\u7528\u5728\u5185\u7684\u5f88\u591a\u7cfb\u7edf\u673a\u5236\u90fd\u4f9d\u8d56\u4e8e binlog\uff0c\u6240\u4ee5\u201c\u9e20\u5360\u9e4a\u5de2\u201dredo log \u8fd8\u505a\u4e0d\u5230\u3002\u4f60\u770b\uff0c\u53d1\u5c55\u751f\u6001\u662f\u591a\u4e48\u91cd\u8981\u3002</p>\n<h3 id=\"7redo-log\">\u8ffd\u95ee 7\uff1aredo log \u4e00\u822c\u8bbe\u7f6e\u591a\u5927\uff1f<a class=\"headerlink\" href=\"#7redo-log\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1aredo log \u592a\u5c0f\u7684\u8bdd\uff0c\u4f1a\u5bfc\u81f4\u5f88\u5feb\u5c31\u88ab\u5199\u6ee1\uff0c\u7136\u540e\u4e0d\u5f97\u4e0d\u5f3a\u884c\u5237 redo log\uff0c\u8fd9\u6837 WAL \u673a\u5236\u7684\u80fd\u529b\u5c31\u53d1\u6325\u4e0d\u51fa\u6765\u4e86\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u662f\u73b0\u5728\u5e38\u89c1\u7684\u51e0\u4e2a TB \u7684\u78c1\u76d8\u7684\u8bdd\uff0c\u5c31\u4e0d\u8981\u592a\u5c0f\u6c14\u4e86\uff0c\u76f4\u63a5\u5c06 redo log \u8bbe\u7f6e\u4e3a 4 \u4e2a\u6587\u4ef6\u3001\u6bcf\u4e2a\u6587\u4ef6 1GB \u5427\u3002</p>\n<h3 id=\"8-redo-log-buffer-pool\">\u8ffd\u95ee 8\uff1a\u6b63\u5e38\u8fd0\u884c\u4e2d\u7684\u5b9e\u4f8b\uff0c\u6570\u636e\u5199\u5165\u540e\u7684\u6700\u7ec8\u843d\u76d8\uff0c\u662f\u4ece redo log \u66f4\u65b0\u8fc7\u6765\u7684\u8fd8\u662f\u4ece buffer pool \u66f4\u65b0\u8fc7\u6765\u7684\u5462\uff1f<a class=\"headerlink\" href=\"#8-redo-log-buffer-pool\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u8fd9\u4e2a\u95ee\u9898\u5176\u5b9e\u95ee\u5f97\u975e\u5e38\u597d\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u4e86\uff0c\u201credo log \u91cc\u9762\u5230\u5e95\u662f\u4ec0\u4e48\u201d\u7684\u95ee\u9898\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0credo log \u5e76\u6ca1\u6709\u8bb0\u5f55\u6570\u636e\u9875\u7684\u5b8c\u6574\u6570\u636e\uff0c\u6240\u4ee5\u5b83\u5e76\u6ca1\u6709\u80fd\u529b\u81ea\u5df1\u53bb\u66f4\u65b0\u78c1\u76d8\u6570\u636e\u9875\uff0c\u4e5f\u5c31\u4e0d\u5b58\u5728\u201c\u6570\u636e\u6700\u7ec8\u843d\u76d8\uff0c\u662f\u7531 redo log \u66f4\u65b0\u8fc7\u53bb\u201d\u7684\u60c5\u51b5\u3002</p>\n<ol>\n<li>\u5982\u679c\u662f\u6b63\u5e38\u8fd0\u884c\u7684\u5b9e\u4f8b\u7684\u8bdd\uff0c\u6570\u636e\u9875\u88ab\u4fee\u6539\u4ee5\u540e\uff0c\u8ddf\u78c1\u76d8\u7684\u6570\u636e\u9875\u4e0d\u4e00\u81f4\uff0c\u79f0\u4e3a\u810f\u9875\u3002\u6700\u7ec8\u6570\u636e\u843d\u76d8\uff0c\u5c31\u662f\u628a\u5185\u5b58\u4e2d\u7684\u6570\u636e\u9875\u5199\u76d8\u3002\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u751a\u81f3\u4e0e redo log \u6beb\u65e0\u5173\u7cfb\u3002</li>\n<li>\u5728\u5d29\u6e83\u6062\u590d\u573a\u666f\u4e2d\uff0cInnoDB \u5982\u679c\u5224\u65ad\u5230\u4e00\u4e2a\u6570\u636e\u9875\u53ef\u80fd\u5728\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\u4e22\u5931\u4e86\u66f4\u65b0\uff0c\u5c31\u4f1a\u5c06\u5b83\u8bfb\u5230\u5185\u5b58\uff0c\u7136\u540e\u8ba9 redo log \u66f4\u65b0\u5185\u5b58\u5185\u5bb9\u3002\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u5185\u5b58\u9875\u53d8\u6210\u810f\u9875\uff0c\u5c31\u56de\u5230\u4e86\u7b2c\u4e00\u79cd\u60c5\u51b5\u7684\u72b6\u6001\u3002</li>\n</ol>\n<h3 id=\"9redo-log-buffer-redo-log\">\u8ffd\u95ee 9\uff1aredo log buffer \u662f\u4ec0\u4e48\uff1f\u662f\u5148\u4fee\u6539\u5185\u5b58\uff0c\u8fd8\u662f\u5148\u5199 redo log \u6587\u4ef6\uff1f<a class=\"headerlink\" href=\"#9redo-log-buffer-redo-log\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u7b54\uff1a\u8fd9\u4e24\u4e2a\u95ee\u9898\u53ef\u4ee5\u4e00\u8d77\u56de\u7b54\u3002</p>\n<p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u7684\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u65e5\u5fd7\u662f\u8981\u5199\u591a\u6b21\u7684\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u4e8b\u52a1\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u4e8b\u52a1\u8981\u5f80\u4e24\u4e2a\u8868\u4e2d\u63d2\u5165\u8bb0\u5f55\uff0c\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u7684\u65e5\u5fd7\u90fd\u5f97\u5148\u4fdd\u5b58\u8d77\u6765\uff0c\u4f46\u53c8\u4e0d\u80fd\u5728\u8fd8\u6ca1 commit \u7684\u65f6\u5019\u5c31\u76f4\u63a5\u5199\u5230 redo log \u6587\u4ef6\u91cc\u3002</p>\n<p>\u6240\u4ee5\uff0credo log buffer \u5c31\u662f\u4e00\u5757\u5185\u5b58\uff0c\u7528\u6765\u5148\u5b58 redo \u65e5\u5fd7\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6267\u884c\u7b2c\u4e00\u4e2a insert \u7684\u65f6\u5019\uff0c\u6570\u636e\u7684\u5185\u5b58\u88ab\u4fee\u6539\u4e86\uff0credo log buffer \u4e5f\u5199\u5165\u4e86\u65e5\u5fd7\u3002</p>\n<p>\u4f46\u662f\uff0c\u771f\u6b63\u628a\u65e5\u5fd7\u5199\u5230 redo log \u6587\u4ef6\uff08\u6587\u4ef6\u540d\u662f ib_logfile+ \u6570\u5b57\uff09\uff0c\u662f\u5728\u6267\u884c commit \u8bed\u53e5\u7684\u65f6\u5019\u505a\u7684\u3002</p>\n<p>\uff08\u8fd9\u91cc\u8bf4\u7684\u662f\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u201c\u4e3b\u52a8\u53bb\u5237\u76d8\u201d\uff0c\u4ee5\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684 IO \u6d88\u8017\u3002\u4f46\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u201c\u88ab\u52a8\u5199\u5165\u78c1\u76d8\u201d\uff0c\u6bd4\u5982\u5185\u5b58\u4e0d\u591f\u3001\u5176\u4ed6\u4e8b\u52a1\u63d0\u4ea4\u7b49\u60c5\u51b5\u3002\u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7b2c 22 \u7bc7\u6587\u7ae0\u300aMySQL \u6709\u54ea\u4e9b\u201c\u996e\u9e29\u6b62\u6e34\u201d\u7684\u63d0\u9ad8\u6027\u80fd\u7684\u65b9\u6cd5\uff1f\u300b\u4e2d\u518d\u8be6\u7ec6\u5c55\u5f00\uff09\u3002</p>\n<p>\u5355\u72ec\u6267\u884c\u4e00\u4e2a\u66f4\u65b0\u8bed\u53e5\u7684\u65f6\u5019\uff0cInnoDB \u4f1a\u81ea\u5df1\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u7684\u65f6\u5019\u63d0\u4ea4\u3002\u8fc7\u7a0b\u8ddf\u4e0a\u9762\u662f\u4e00\u6837\u7684\uff0c\u53ea\u4e0d\u8fc7\u662f\u201c\u538b\u7f29\u201d\u5230\u4e86\u4e00\u4e2a\u8bed\u53e5\u91cc\u9762\u5b8c\u6210\u3002</p>\n<p>\u4ee5\u4e0a\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c31\u662f\u628a\u5927\u5bb6\u63d0\u8fc7\u7684\u5173\u4e8e redo log \u548c binlog \u7684\u95ee\u9898\u4e32\u8d77\u6765\uff0c\u505a\u7684\u4e00\u6b21\u96c6\u4e2d\u56de\u7b54\u3002\u5982\u679c\u4f60\u8fd8\u6709\u95ee\u9898\uff0c\u53ef\u4ee5\u5728\u8bc4\u8bba\u533a\u7ee7\u7eed\u7559\u8a00\u8865\u5145\u3002</p>\n<h3 id=\"_13\">\u4e1a\u52a1\u8bbe\u8ba1\u95ee\u9898<a class=\"headerlink\" href=\"#_13\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e1a\u52a1\u4e0a\u6709\u8fd9\u6837\u7684\u9700\u6c42\uff0cA\u3001B \u4e24\u4e2a\u7528\u6237\uff0c\u5982\u679c\u4e92\u76f8\u5173\u6ce8\uff0c\u5219\u6210\u4e3a\u597d\u53cb\u3002\u8bbe\u8ba1\u4e0a\u662f\u6709\u4e24\u5f20\u8868\uff0c\u4e00\u4e2a\u662f like \u8868\uff0c\u4e00\u4e2a\u662f friend \u8868\uff0clike \u8868\u6709 <code>user_id</code>\u3001<code>liker_id</code> \u4e24\u4e2a\u5b57\u6bb5\uff0c\u6211\u8bbe\u7f6e\u4e3a\u590d\u5408\u552f\u4e00\u7d22\u5f15\u5373 <code>uk_user_id_liker_id</code>\u3002\u8bed\u53e5\u6267\u884c\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a</p>\n<p>\u4ee5 A \u5173\u6ce8 B \u4e3a\u4f8b\uff1a \u7b2c\u4e00\u6b65\uff0c\u5148\u67e5\u8be2\u5bf9\u65b9\u6709\u6ca1\u6709\u5173\u6ce8\u81ea\u5df1\uff08B \u6709\u6ca1\u6709\u5173\u6ce8 A\uff09</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">user_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">liker_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5982\u679c\u6709\uff0c\u5219\u6210\u4e3a\u597d\u53cb <code>insert into friend;</code></p>\n<p>\u6ca1\u6709\uff0c\u5219\u53ea\u662f\u5355\u5411\u5173\u6ce8\u5173\u7cfb <code>insert into like;</code></p>\n<p>\u4f46\u662f\u5982\u679c A\u3001B \u540c\u65f6\u5173\u6ce8\u5bf9\u65b9\uff0c\u4f1a\u51fa\u73b0\u4e0d\u4f1a\u6210\u4e3a\u597d\u53cb\u7684\u60c5\u51b5\u3002\u56e0\u4e3a\u4e0a\u9762\u7b2c 1 \u6b65\uff0c\u53cc\u65b9\u90fd\u6ca1\u5173\u6ce8\u5bf9\u65b9\u3002\u7b2c 1 \u6b65\u5373\u4f7f\u4f7f\u7528\u4e86\u6392\u4ed6\u9501\u4e5f\u4e0d\u884c\uff0c\u56e0\u4e3a\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u884c\u9501\u65e0\u6cd5\u751f\u6548\u3002\u8bf7\u95ee\u8fd9\u79cd\u60c5\u51b5\uff0c\u5728 MySQL \u9501\u5c42\u9762\u6709\u6ca1\u6709\u529e\u6cd5\u5904\u7406\uff1f</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u628a\u8868\u6a21\u62df\u51fa\u6765\uff0c\u65b9\u4fbf\u6211\u4eec\u8ba8\u8bba\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">like</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">user_id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">liker_id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">uk_user_id_liker_id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">user_id</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">liker_id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">friend</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">friend_1_id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">firned_2_id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">uk_friend</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">friend_1_id</span><span class=\"o\">`</span><span class=\"p\">,</span><span class=\"o\">`</span><span class=\"n\">firned_2_id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u867d\u7136\u8fd9\u4e2a\u9898\u5e72\u4e2d\uff0c\u5e76\u6ca1\u6709\u8bf4\u5230 friend \u8868\u7684\u7d22\u5f15\u7ed3\u6784\u3002\u4f46\u6211\u731c\u6d4b <code>friend_1_id</code> \u548c <code>friend_2_id</code> \u4e5f\u6709\u7d22\u5f15\uff0c\u4e3a\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u7ed9\u52a0\u4e0a\u552f\u4e00\u7d22\u5f15\u3002</p>\n<p>\u987a\u4fbf\u8bf4\u660e\u4e00\u4e0b\uff0c<code>like</code> \u662f\u5173\u952e\u5b57\uff0c\u6211\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u5173\u952e\u5b57\u4f5c\u4e3a\u5e93\u540d\u3001\u8868\u540d\u3001\u5b57\u6bb5\u540d\u6216\u7d22\u5f15\u540d\u3002</p>\n<p>\u5728\u5e76\u53d1\u573a\u666f\u4e0b\uff0c\u540c\u65f6\u6709\u4e24\u4e2a\u4eba\uff0c\u8bbe\u7f6e\u4e3a\u5173\u6ce8\u5bf9\u65b9\uff0c\u5c31\u53ef\u80fd\u5bfc\u81f4\u65e0\u6cd5\u6210\u529f\u52a0\u4e3a\u670b\u53cb\u5173\u7cfb\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u7528\u4f60\u5df2\u7ecf\u719f\u6089\u7684\u65f6\u523b\u987a\u5e8f\u8868\u7684\u5f62\u5f0f\uff0c\u628a\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u7684\u6267\u884c\u8bed\u53e5\u5217\u51fa\u6765\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session 1(\u903b\u8f91\u64cd\u4f5c\uff1a A \u559c\u6b22 B)</th>\n<th>session 2\uff08\u64cd\u4f5c\u903b\u8f91\uff1aB \u559c\u6b22 A\uff09</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from <code>like</code> where user_id= B <br />and liker_id = A; // \u8fd4\u56de\u7a7a</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>begin;<br />select * from <code>like</code> where user_id= A <br />and liker_id = B; // \u8fd4\u56de\u7a7a</td>\n</tr>\n<tr>\n<td></td>\n<td>insert into <code>like</code> (user_id, liker_id) values(B, A);</td>\n</tr>\n<tr>\n<td>insert into <code>like</code> (user_id, liker_id) values(A, B);</td>\n<td></td>\n</tr>\n<tr>\n<td>commit;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>commit;</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u4e8e\u4e00\u5f00\u59cb A \u548c B \u4e4b\u95f4\u6ca1\u6709\u5173\u6ce8\u5173\u7cfb\uff0c\u6240\u4ee5\u4e24\u4e2a\u4e8b\u52a1\u91cc\u9762\u7684 select \u8bed\u53e5\u67e5\u51fa\u6765\u7684\u7ed3\u679c\u90fd\u662f\u7a7a\u3002</p>\n<p>\u56e0\u6b64\uff0csession 1 \u7684\u903b\u8f91\u5c31\u662f\u201c\u65e2\u7136 B \u6ca1\u6709\u5173\u6ce8 A\uff0c\u90a3\u5c31\u53ea\u63d2\u5165\u4e00\u4e2a\u5355\u5411\u5173\u6ce8\u5173\u7cfb\u201d\u3002session 2 \u4e5f\u540c\u6837\u662f\u8fd9\u4e2a\u903b\u8f91\u3002</p>\n<p>\u8fd9\u4e2a\u7ed3\u679c\u5bf9\u4e1a\u52a1\u6765\u8bf4\u5c31\u662f bug \u4e86\u3002\u56e0\u4e3a\u5728\u4e1a\u52a1\u8bbe\u5b9a\u91cc\u9762\uff0c\u8fd9\u4e24\u4e2a\u903b\u8f91\u90fd\u6267\u884c\u5b8c\u6210\u4ee5\u540e\uff0c\u662f\u5e94\u8be5\u5728 friend \u8868\u91cc\u9762\u63d2\u5165\u4e00\u884c\u8bb0\u5f55\u7684\u3002</p>\n<p>\u5982\u63d0\u95ee\u91cc\u9762\u8bf4\u7684\uff0c\u201c\u7b2c 1 \u6b65\u5373\u4f7f\u4f7f\u7528\u4e86\u6392\u4ed6\u9501\u4e5f\u4e0d\u884c\uff0c\u56e0\u4e3a\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u884c\u9501\u65e0\u6cd5\u751f\u6548\u201d\u3002\u4e0d\u8fc7\uff0c\u6211\u60f3\u5230\u4e86\u53e6\u5916\u4e00\u4e2a\u65b9\u6cd5\uff0c\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u9996\u5148\uff0c\u8981\u7ed9 <code>like</code> \u8868\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\uff0c\u6bd4\u5982\u53eb\u4f5c <code>relation_ship</code>\uff0c\u5e76\u8bbe\u4e3a\u6574\u578b\uff0c\u53d6\u503c 1\u30012\u30013\u3002</p>\n<ul>\n<li>\u503c\u662f 1 \u7684\u65f6\u5019\uff0c\u8868\u793a user_id \u5173\u6ce8 liker_id; </li>\n<li>\u503c\u662f 2 \u7684\u65f6\u5019\uff0c\u8868\u793a liker_id \u5173\u6ce8 user_id; </li>\n<li>\u503c\u662f 3 \u7684\u65f6\u5019\uff0c\u8868\u793a\u4e92\u76f8\u5173\u6ce8\u3002</li>\n</ul>\n<p>\u7136\u540e\uff0c\u5f53 A \u5173\u6ce8 B \u7684\u65f6\u5019\uff0c\u903b\u8f91\u6539\u6210\u5982\u4e0b\u6240\u793a\u7684\u6837\u5b50\uff1a</p>\n<p>\u5e94\u7528\u4ee3\u7801\u91cc\u9762\uff0c\u6bd4\u8f83 A \u548c B \u7684\u5927\u5c0f\uff0c\u5982\u679c A\\&lt;B\uff0c\u5c31\u6267\u884c\u4e0b\u9762\u7684\u903b\u8f91</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">begin</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* \u542f\u52a8\u4e8b\u52a1 */</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">like</span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"n\">user_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">liker_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"o\">=</span><span class=\"n\">relation_ship</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">like</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">user_id</span><span class=\"o\">=</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">liker_id</span><span class=\"o\">=</span><span class=\"n\">B</span><span class=\"p\">;</span>\n<span class=\"cm\">/* \u4ee3\u7801\u4e2d\u5224\u65ad\u8fd4\u56de\u7684 relation_ship\uff0c</span>\n<span class=\"cm\">  \u5982\u679c\u662f 1\uff0c\u4e8b\u52a1\u7ed3\u675f\uff0c\u6267\u884c commit</span>\n<span class=\"cm\">  \u5982\u679c\u662f 3\uff0c\u5219\u6267\u884c\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\uff1a</span>\n<span class=\"cm\">  */</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">ignore</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">friend</span><span class=\"p\">(</span><span class=\"n\">friend_1_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">friend_2_id</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"n\">B</span><span class=\"p\">);</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5982\u679c A&gt;B\uff0c\u5219\u6267\u884c\u4e0b\u9762\u7684\u903b\u8f91</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">begin</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* \u542f\u52a8\u4e8b\u52a1 */</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">like</span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"n\">user_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">liker_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"o\">=</span><span class=\"n\">relation_ship</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">relation_ship</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">like</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">user_id</span><span class=\"o\">=</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">liker_id</span><span class=\"o\">=</span><span class=\"n\">A</span><span class=\"p\">;</span>\n<span class=\"cm\">/* \u4ee3\u7801\u4e2d\u5224\u65ad\u8fd4\u56de\u7684 relation_ship\uff0c</span>\n<span class=\"cm\">  \u5982\u679c\u662f 2\uff0c\u4e8b\u52a1\u7ed3\u675f\uff0c\u6267\u884c commit</span>\n<span class=\"cm\">  \u5982\u679c\u662f 3\uff0c\u5219\u6267\u884c\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\uff1a</span>\n<span class=\"cm\">*/</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">ignore</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">friend</span><span class=\"p\">(</span><span class=\"n\">friend_1_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">friend_2_id</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"n\">A</span><span class=\"p\">);</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bbe\u8ba1\u91cc\uff0c\u8ba9 <code>like</code> \u8868\u91cc\u7684\u6570\u636e\u4fdd\u8bc1 <code>user_id &lt; liker_id</code>\uff0c\u8fd9\u6837\u4e0d\u8bba\u662f A \u5173\u6ce8 B\uff0c\u8fd8\u662f B \u5173\u6ce8 A\uff0c\u5728\u64cd\u4f5clike \u8868\u7684\u65f6\u5019\uff0c\u5982\u679c\u53cd\u5411\u7684\u5173\u7cfb\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4f1a\u51fa\u73b0\u884c\u9501\u51b2\u7a81\u3002</p>\n<p>\u7136\u540e\uff0c<code>insert \u2026 on duplicate</code> \u8bed\u53e5\uff0c\u786e\u4fdd\u4e86\u5728\u4e8b\u52a1\u5185\u90e8\uff0c\u6267\u884c\u4e86\u8fd9\u4e2a SQL \u8bed\u53e5\u540e\uff0c\u5c31\u5f3a\u884c\u5360\u4f4f\u4e86\u8fd9\u4e2a\u884c\u9501\uff0c\u4e4b\u540e\u7684 select \u5224\u65ad <code>relation_ship</code> \u8fd9\u4e2a\u903b\u8f91\u65f6\u5c31\u786e\u4fdd\u4e86\u662f\u5728\u884c\u9501\u4fdd\u62a4\u4e0b\u7684\u8bfb\u64cd\u4f5c\u3002</p>\n<p>\u64cd\u4f5c\u7b26 <code>|</code> \u662f\u6309\u4f4d\u6216\uff0c\u8fde\u540c\u6700\u540e\u4e00\u53e5 insert \u8bed\u53e5\u91cc\u7684 ignore\uff0c\u662f\u4e3a\u4e86\u4fdd\u8bc1\u91cd\u590d\u8c03\u7528\u65f6\u7684\u5e42\u7b49\u6027\u3002</p>\n<p>\u8fd9\u6837\uff0c\u5373\u4f7f\u5728\u53cc\u65b9\u201c\u540c\u65f6\u201d\u6267\u884c\u5173\u6ce8\u64cd\u4f5c\uff0c\u6700\u7ec8\u6570\u636e\u5e93\u91cc\u7684\u7ed3\u679c\uff0c\u4e5f\u662f like \u8868\u91cc\u9762\u6709\u4e00\u6761\u5173\u4e8e A \u548c B \u7684\u8bb0\u5f55\uff0c\u800c\u4e14 relation_ship \u7684\u503c\u662f 3\uff0c \u5e76\u4e14 friend \u8868\u91cc\u9762\u4e5f\u6709\u4e86 A \u548c B \u7684\u8fd9\u6761\u8bb0\u5f55\u3002</p>\n<p>\u4e0d\u77e5\u9053\u4f60\u4f1a\u4e0d\u4f1a\u5410\u69fd\uff1a\u4e4b\u524d\u660e\u660e\u8fd8\u8bf4\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\uff0c\u7ed3\u679c\u8fd9\u4e2a\u4f8b\u5b50\u4e00\u4e0a\u6765\u6211\u5c31\u521b\u5efa\u4e86\u4e24\u4e2a\u3002\u8fd9\u91cc\u6211\u8981\u518d\u548c\u4f60\u8bf4\u660e\u4e00\u4e0b\uff0c\u4e4b\u524d\u6587\u7ae0\u6211\u4eec\u8ba8\u8bba\u7684\uff0c\u662f\u5728\u201c\u4e1a\u52a1\u5f00\u53d1\u4fdd\u8bc1\u4e0d\u4f1a\u63d2\u5165\u91cd\u590d\u8bb0\u5f55\u201d\u7684\u60c5\u51b5\u4e0b\uff0c\u7740\u91cd\u8981\u89e3\u51b3\u6027\u80fd\u95ee\u9898\u7684\u65f6\u5019\uff0c\u624d\u5efa\u8bae\u5c3d\u91cf\u4f7f\u7528\u666e\u901a\u7d22\u5f15\u3002</p>\n<p>\u800c\u50cf\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6309\u7167\u8fd9\u4e2a\u8bbe\u8ba1\uff0c\u4e1a\u52a1\u6839\u672c\u5c31\u662f\u4fdd\u8bc1\u201c\u6211\u4e00\u5b9a\u4f1a\u63d2\u5165\u91cd\u590d\u6570\u636e\uff0c\u6570\u636e\u5e93\u4e00\u5b9a\u8981\u8981\u6709\u552f\u4e00\u6027\u7ea6\u675f\u201d\uff0c\u8fd9\u65f6\u5c31\u6ca1\u5565\u597d\u8bf4\u7684\u4e86\uff0c\u552f\u4e00\u7d22\u5f15\u5efa\u8d77\u6765\u5427\u3002</p>\n<h3 id=\"_14\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_14\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u662f\u4e13\u680f\u7684\u7b2c\u4e00\u7bc7\u7b54\u7591\u6587\u7ae0\u3002</p>\n<p>\u6211\u9488\u5bf9\u524d 14 \u7bc7\u6587\u7ae0\uff0c\u5927\u5bb6\u5728\u8bc4\u8bba\u533a\u4e2d\u7684\u7559\u8a00\uff0c\u4ece\u4e2d\u6458\u53d6\u4e86\u5173\u4e8e\u65e5\u5fd7\u548c\u7d22\u5f15\u7684\u76f8\u5173\u95ee\u9898\uff0c\u4e32\u6210\u4e86\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u3002\u8fd9\u91cc\u6211\u4e5f\u8981\u518d\u548c\u4f60\u8bf4\u4e00\u58f0\uff0c\u6709\u4e9b\u6211\u7b54\u5e94\u5728\u7b54\u7591\u6587\u7ae0\u4e2d\u8fdb\u884c\u6269\u5c55\u7684\u8bdd\u9898\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u6ca1\u6765\u5f97\u53ca\u6269\u5c55\uff0c\u540e\u7eed\u6211\u4f1a\u518d\u627e\u673a\u4f1a\u4e3a\u4f60\u89e3\u7b54\u3002\u6240\u4ee5\uff0c\u7bc7\u5e45\u6240\u9650\uff0c\u8bc4\u8bba\u533a\u89c1\u5427\u3002</p>\n<p>\u6700\u540e\uff0c\u867d\u7136\u8fd9\u7bc7\u662f\u7b54\u7591\u6587\u7ae0\uff0c\u4f46\u8bfe\u540e\u95ee\u9898\u8fd8\u662f\u8981\u6709\u7684\u3002</p>\n<p>\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u8868 t\uff0c\u5e76\u63d2\u5165\u4e00\u884c\uff0c\u7136\u540e\u5bf9\u8fd9\u4e00\u884c\u505a\u4fee\u6539\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"n\">auto_increment</span><span class=\"p\">,</span>\n<span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\uff0c\u8868 t \u91cc\u6709\u552f\u4e00\u7684\u4e00\u884c\u6570\u636e (1,2)\u3002\u5047\u8bbe\uff0c\u6211\u73b0\u5728\u8981\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u7ed3\u679c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"n\">OK</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"n\">affected</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n<span class=\"k\">Rows</span><span class=\"w\"> </span><span class=\"n\">matched</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">Changed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"n\">Warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>\u7ed3\u679c\u663e\u793a\uff0c\u5339\u914d (rows matched) \u4e86\u4e00\u884c\uff0c\u4fee\u6539 (Changed) \u4e86 0 \u884c\u3002</p>\n<p>\u4ec5\u4ece\u73b0\u8c61\u4e0a\u770b\uff0cMySQL \u5185\u90e8\u5728\u5904\u7406\u8fd9\u4e2a\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6709\u4ee5\u4e0b\u4e09\u79cd\u9009\u62e9\uff1a</p>\n<ol>\n<li>\u66f4\u65b0\u90fd\u662f\u5148\u8bfb\u540e\u5199\u7684\uff0cMySQL \u8bfb\u51fa\u6570\u636e\uff0c\u53d1\u73b0 a \u7684\u503c\u672c\u6765\u5c31\u662f 2\uff0c\u4e0d\u66f4\u65b0\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\u6267\u884c\u7ed3\u675f\uff1b</li>\n<li>MySQL \u8c03\u7528\u4e86 InnoDB \u5f15\u64ce\u63d0\u4f9b\u7684\u201c\u4fee\u6539\u4e3a (1,2)\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4f46\u662f\u5f15\u64ce\u53d1\u73b0\u503c\u4e0e\u539f\u6765\u76f8\u540c\uff0c\u4e0d\u66f4\u65b0\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b</li>\n<li>InnoDB \u8ba4\u771f\u6267\u884c\u4e86\u201c\u628a\u8fd9\u4e2a\u503c\u4fee\u6539\u6210 (1,2)\"\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u8be5\u52a0\u9501\u7684\u52a0\u9501\uff0c\u8be5\u66f4\u65b0\u7684\u66f4\u65b0\u3002</li>\n</ol>\n<h2 id=\"16-order-by\">16 \u201corder by\u201d\u662f\u600e\u4e48\u5de5\u4f5c\u7684\uff1f<a class=\"headerlink\" href=\"#16-order-by\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4f60\u5f00\u53d1\u5e94\u7528\u7684\u65f6\u5019\uff0c\u4e00\u5b9a\u4f1a\u7ecf\u5e38\u78b0\u5230\u9700\u8981\u6839\u636e\u6307\u5b9a\u7684\u5b57\u6bb5\u6392\u5e8f\u6765\u663e\u793a\u7ed3\u679c\u7684\u9700\u6c42\u3002\u8fd8\u662f\u4ee5\u6211\u4eec\u524d\u9762\u4e3e\u4f8b\u7528\u8fc7\u7684\u5e02\u6c11\u8868\u4e3a\u4f8b\uff0c\u5047\u8bbe\u4f60\u8981\u67e5\u8be2\u57ce\u5e02\u662f\u201c\u676d\u5dde\u201d\u7684\u6240\u6709\u4eba\u540d\u5b57\uff0c\u5e76\u4e14\u6309\u7167\u59d3\u540d\u6392\u5e8f\u8fd4\u56de\u524d 1000 \u4e2a\u4eba\u7684\u59d3\u540d\u3001\u5e74\u9f84\u3002</p>\n<p>\u5047\u8bbe\u8fd9\u4e2a\u8868\u7684\u90e8\u5206\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">city</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">name</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">age</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">addr</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">city</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">city</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\">  </span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u770b\u4e0a\u53bb\u903b\u8f91\u5f88\u6e05\u6670\uff0c\u4f46\u662f\u4f60\u4e86\u89e3\u5b83\u7684\u6267\u884c\u6d41\u7a0b\u5417\uff1f\u4eca\u5929\uff0c\u6211\u5c31\u548c\u4f60\u804a\u804a\u8fd9\u4e2a\u8bed\u53e5\u662f\u600e\u4e48\u6267\u884c\u7684\uff0c\u4ee5\u53ca\u6709\u4ec0\u4e48\u53c2\u6570\u4f1a\u5f71\u54cd\u6267\u884c\u7684\u884c\u4e3a\u3002</p>\n<h3 id=\"_15\">\u5168\u5b57\u6bb5\u6392\u5e8f<a class=\"headerlink\" href=\"#_15\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7d22\u5f15\uff0c\u6240\u4ee5\u4f60\u73b0\u5728\u5c31\u5f88\u6e05\u695a\u4e86\uff0c\u4e3a\u907f\u514d\u5168\u8868\u626b\u63cf\uff0c\u6211\u4eec\u9700\u8981\u5728 city \u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\u3002</p>\n<p>\u5728 city \u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u4e4b\u540e\uff0c\u6211\u4eec\u7528 explain \u547d\u4ee4\u6765\u770b\u770b\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\">  </span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">          </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">66</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"n\">filesort</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Extra \u8fd9\u4e2a\u5b57\u6bb5\u4e2d\u7684\u201cUsing filesort\u201d\u8868\u793a\u7684\u5c31\u662f\u9700\u8981\u6392\u5e8f\uff0cMySQL \u4f1a\u7ed9\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u4e00\u5757\u5185\u5b58\u7528\u4e8e\u6392\u5e8f\uff0c\u79f0\u4e3a <code>sort_buffer</code>\u3002</p>\n<p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a SQL \u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b city \u8fd9\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/5334cca9118be14bde95ec94b02f0a3e.png\" /></p>\n<p>\u56fe 2 city \u5b57\u6bb5\u7684\u7d22\u5f15\u793a\u610f\u56fe</p>\n<p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u884c\uff0c\u662f\u4ece <code>ID_X</code> \u5230 <code>ID_(X+N)</code> \u7684\u8fd9\u4e9b\u8bb0\u5f55\u3002</p>\n<p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a \uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316 <code>sort_buffer</code>\uff0c\u786e\u5b9a\u653e\u5165 name\u3001city\u3001age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\uff1b</li>\n<li>\u4ece\u7d22\u5f15 city \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 city='\u676d\u5dde\u2019\u6761\u4ef6\u7684\u4e3b\u952e id\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_X</code>\uff1b</li>\n<li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 name\u3001city\u3001age \u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u5b58\u5165 <code>sort_buffer</code> \u4e2d\uff1b</li>\n<li>\u4ece\u7d22\u5f15 city \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u7684\u4e3b\u952e id\uff1b</li>\n<li>\u91cd\u590d\u6b65\u9aa4 3\u30014 \u76f4\u5230 city \u7684\u503c\u4e0d\u6ee1\u8db3\u67e5\u8be2\u6761\u4ef6\u4e3a\u6b62\uff0c\u5bf9\u5e94\u7684\u4e3b\u952e id \u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_Y</code>\uff1b</li>\n<li>\u5bf9 <code>sort_buffer</code> \u4e2d\u7684\u6570\u636e\u6309\u7167\u5b57\u6bb5 name \u505a\u5feb\u901f\u6392\u5e8f\uff1b</li>\n<li>\u6309\u7167\u6392\u5e8f\u7ed3\u679c\u53d6\u524d 1000 \u884c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li>\n</ol>\n<p>\u6211\u4eec\u6682\u4e14\u628a\u8fd9\u4e2a\u6392\u5e8f\u8fc7\u7a0b\uff0c\u79f0\u4e3a\u5168\u5b57\u6bb5\u6392\u5e8f\uff0c\u6267\u884c\u6d41\u7a0b\u7684\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff0c\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u8fd8\u4f1a\u7528\u5230\u8fd9\u4e2a\u6392\u5e8f\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/6c821828cddf46670f9d56e126e3e772.jpg\" /></p>\n<p>\u56fe 3 \u5168\u5b57\u6bb5\u6392\u5e8f</p>\n<p>\u56fe\u4e2d\u201c\u6309 name \u6392\u5e8f\u201d\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u53ef\u80fd\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\uff0c\u4e5f\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u5916\u90e8\u6392\u5e8f\uff0c\u8fd9\u53d6\u51b3\u4e8e\u6392\u5e8f\u6240\u9700\u7684\u5185\u5b58\u548c\u53c2\u6570 <code>sort_buffer_size</code>\u3002</p>\n<p><code>sort_buffer_size</code>\uff0c\u5c31\u662f MySQL \u4e3a\u6392\u5e8f\u5f00\u8f9f\u7684\u5185\u5b58\uff08<code>sort_buffer</code>\uff09\u7684\u5927\u5c0f\u3002\u5982\u679c\u8981\u6392\u5e8f\u7684\u6570\u636e\u91cf\u5c0f\u4e8e <code>sort_buffer_size</code>\uff0c\u6392\u5e8f\u5c31\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u3002\u4f46\u5982\u679c\u6392\u5e8f\u6570\u636e\u91cf\u592a\u5927\uff0c\u5185\u5b58\u653e\u4e0d\u4e0b\uff0c\u5219\u4e0d\u5f97\u4e0d\u5229\u7528\u78c1\u76d8\u4e34\u65f6\u6587\u4ef6\u8f85\u52a9\u6392\u5e8f\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u6765\u786e\u5b9a\u4e00\u4e2a\u6392\u5e8f\u8bed\u53e5\u662f\u5426\u4f7f\u7528\u4e86\u4e34\u65f6\u6587\u4ef6\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"cm\">/* \u6253\u5f00 optimizer_trace\uff0c\u53ea\u5bf9\u672c\u7ebf\u7a0b\u6709\u6548 */</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">optimizer_trace</span><span class=\"o\">=</span><span class=\"s1\">&#39;enabled=on&#39;</span><span class=\"p\">;</span><span class=\"w\">  </span>\n<span class=\"cm\">/* @a \u4fdd\u5b58 Innodb_rows_read \u7684\u521d\u59cb\u503c */</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">variable_value</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\">  </span><span class=\"n\">performance_schema</span><span class=\"p\">.</span><span class=\"n\">session_status</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">variable_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_rows_read&#39;</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* \u6267\u884c\u8bed\u53e5 */</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">;</span><span class=\"w\">  </span>\n<span class=\"cm\">/* \u67e5\u770b OPTIMIZER_TRACE \u8f93\u51fa */</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">information_schema</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">OPTIMIZER_TRACE</span><span class=\"o\">`</span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* @b \u4fdd\u5b58 Innodb_rows_read \u7684\u5f53\u524d\u503c */</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">variable_value</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">performance_schema</span><span class=\"p\">.</span><span class=\"n\">session_status</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">variable_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_rows_read&#39;</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* \u8ba1\u7b97 Innodb_rows_read \u5dee\u503c */</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">b</span><span class=\"o\">-@</span><span class=\"n\">a</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u65b9\u6cd5\u662f\u901a\u8fc7\u67e5\u770b OPTIMIZER_TRACE \u7684\u7ed3\u679c\u6765\u786e\u8ba4\u7684\uff0c\u4f60\u53ef\u4ee5\u4ece <code>number_of_tmp_files</code> \u4e2d\u770b\u5230\u662f\u5426\u4f7f\u7528\u4e86\u4e34\u65f6\u6587\u4ef6\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;filesort_summary&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;rows&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4000</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;examined_rows&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4000</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;number_of_tmp_files&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;sort_buffer_size&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">32768</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;sort_mode&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;&lt;sort_key, packed_additional_fields&gt;&quot;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><code>number_of_tmp_files</code> \u8868\u793a\u7684\u662f\uff0c\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u7684\u4e34\u65f6\u6587\u4ef6\u6570\u3002\u4f60\u4e00\u5b9a\u5947\u602a\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981 12 \u4e2a\u6587\u4ef6\uff1f\u5185\u5b58\u653e\u4e0d\u4e0b\u65f6\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u5916\u90e8\u6392\u5e8f\uff0c\u5916\u90e8\u6392\u5e8f\u4e00\u822c\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u3002\u53ef\u4ee5\u8fd9\u4e48\u7b80\u5355\u7406\u89e3\uff0c<strong>MySQL \u5c06\u9700\u8981\u6392\u5e8f\u7684\u6570\u636e\u5206\u6210 12 \u4efd\uff0c\u6bcf\u4e00\u4efd\u5355\u72ec\u6392\u5e8f\u540e\u5b58\u5728\u8fd9\u4e9b\u4e34\u65f6\u6587\u4ef6\u4e2d\u3002\u7136\u540e\u628a\u8fd9 12 \u4e2a\u6709\u5e8f\u6587\u4ef6\u518d\u5408\u5e76\u6210\u4e00\u4e2a\u6709\u5e8f\u7684\u5927\u6587\u4ef6\u3002</strong></p>\n<p>\u5982\u679c <code>sort_buffer_size</code> \u8d85\u8fc7\u4e86\u9700\u8981\u6392\u5e8f\u7684\u6570\u636e\u91cf\u7684\u5927\u5c0f\uff0c<code>number_of_tmp_files</code> \u5c31\u662f 0\uff0c\u8868\u793a\u6392\u5e8f\u53ef\u4ee5\u76f4\u63a5\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u3002</p>\n<p>\u5426\u5219\u5c31\u9700\u8981\u653e\u5728\u4e34\u65f6\u6587\u4ef6\u4e2d\u6392\u5e8f\u3002<code>sort_buffer_size</code> \u8d8a\u5c0f\uff0c\u9700\u8981\u5206\u6210\u7684\u4efd\u6570\u8d8a\u591a\uff0c<code>number_of_tmp_files</code> \u7684\u503c\u5c31\u8d8a\u5927\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u518d\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u56fe 4 \u4e2d\u5176\u4ed6\u4e24\u4e2a\u503c\u7684\u610f\u601d\u3002</p>\n<p>\u6211\u4eec\u7684\u793a\u4f8b\u8868\u4e2d\u6709 4000 \u6761\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u770b\u5230 <code>examined_rows=4000</code>\uff0c\u8868\u793a\u53c2\u4e0e\u6392\u5e8f\u7684\u884c\u6570\u662f 4000 \u884c\u3002</p>\n<p><code>sort_mode</code> \u91cc\u9762\u7684 <code>packed_additional_fields</code> \u7684\u610f\u601d\u662f\uff0c\u6392\u5e8f\u8fc7\u7a0b\u5bf9\u5b57\u7b26\u4e32\u505a\u4e86\u201c\u7d27\u51d1\u201d\u5904\u7406\u3002\u5373\u4f7f name \u5b57\u6bb5\u7684\u5b9a\u4e49\u662f <code>varchar(16)</code>\uff0c\u5728\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u8fd8\u662f\u8981\u6309\u7167\u5b9e\u9645\u957f\u5ea6\u6765\u5206\u914d\u7a7a\u95f4\u7684\u3002</p>\n<p>\u540c\u65f6\uff0c\u6700\u540e\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5 <code>select @b-@a</code> \u7684\u8fd4\u56de\u7ed3\u679c\u662f 4000\uff0c\u8868\u793a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u53ea\u626b\u63cf\u4e86 4000 \u884c\u3002</p>\n<p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e3a\u4e86\u907f\u514d\u5bf9\u7ed3\u8bba\u9020\u6210\u5e72\u6270\uff0c\u6211\u628a <code>internal_tmp_disk_storage_engine</code> \u8bbe\u7f6e\u6210 MyISAM\u3002\u5426\u5219\uff0c<code>select @b-@a</code> \u7684\u7ed3\u679c\u4f1a\u663e\u793a\u4e3a 4001\u3002</p>\n<p>\u8fd9\u662f\u56e0\u4e3a\u67e5\u8be2 <code>OPTIMIZER_TRACE</code> \u8fd9\u4e2a\u8868\u65f6\uff0c\u9700\u8981\u7528\u5230\u4e34\u65f6\u8868\uff0c\u800c <code>internal_tmp_disk_storage_engine</code> \u7684\u9ed8\u8ba4\u503c\u662f InnoDB\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f InnoDB \u5f15\u64ce\u7684\u8bdd\uff0c\u628a\u6570\u636e\u4ece\u4e34\u65f6\u8868\u53d6\u51fa\u6765\u7684\u65f6\u5019\uff0c\u4f1a\u8ba9 <code>Innodb_rows_read</code> \u7684\u503c\u52a0 1\u3002</p>\n<h3 id=\"rowid\">rowid \u6392\u5e8f<a class=\"headerlink\" href=\"#rowid\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u7b97\u6cd5\u8fc7\u7a0b\u91cc\u9762\uff0c\u53ea\u5bf9\u539f\u8868\u7684\u6570\u636e\u8bfb\u4e86\u4e00\u904d\uff0c\u5269\u4e0b\u7684\u64cd\u4f5c\u90fd\u662f\u5728 <code>sort_buffer</code> \u548c\u4e34\u65f6\u6587\u4ef6\u4e2d\u6267\u884c\u7684\u3002\u4f46\u8fd9\u4e2a\u7b97\u6cd5\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u5982\u679c\u67e5\u8be2\u8981\u8fd4\u56de\u7684\u5b57\u6bb5\u5f88\u591a\u7684\u8bdd\uff0c\u90a3\u4e48 <code>sort_buffer</code> \u91cc\u9762\u8981\u653e\u7684\u5b57\u6bb5\u6570\u592a\u591a\uff0c\u8fd9\u6837\u5185\u5b58\u91cc\u80fd\u591f\u540c\u65f6\u653e\u4e0b\u7684\u884c\u6570\u5f88\u5c11\uff0c\u8981\u5206\u6210\u5f88\u591a\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u6392\u5e8f\u7684\u6027\u80fd\u4f1a\u5f88\u5dee\u3002</p>\n<p>\u6240\u4ee5\u5982\u679c\u5355\u884c\u5f88\u5927\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6548\u7387\u4e0d\u591f\u597d\u3002</p>\n<p>\u90a3\u4e48\uff0c<strong>\u5982\u679c MySQL \u8ba4\u4e3a\u6392\u5e8f\u7684\u5355\u884c\u957f\u5ea6\u592a\u5927\u4f1a\u600e\u4e48\u505a\u5462\uff1f</strong></p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u6765\u4fee\u6539\u4e00\u4e2a\u53c2\u6570\uff0c\u8ba9 MySQL \u91c7\u7528\u53e6\u5916\u4e00\u79cd\u7b97\u6cd5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">max_length_for_sort_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">;</span>\n</code></pre></div>\n<p><code>max_length_for_sort_data</code>\uff0c\u662f MySQL \u4e2d\u4e13\u95e8\u63a7\u5236\u7528\u4e8e\u6392\u5e8f\u7684\u884c\u6570\u636e\u7684\u957f\u5ea6\u7684\u4e00\u4e2a\u53c2\u6570\u3002\u5b83\u7684\u610f\u601d\u662f\uff0c\u5982\u679c\u5355\u884c\u7684\u957f\u5ea6\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0cMySQL \u5c31\u8ba4\u4e3a\u5355\u884c\u592a\u5927\uff0c\u8981\u6362\u4e00\u4e2a\u7b97\u6cd5\u3002</p>\n<p><code>city\u3001name\u3001age</code> \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u5b9a\u4e49\u603b\u957f\u5ea6\u662f 36\uff0c\u6211\u628a <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u4e3a 16\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u8ba1\u7b97\u8fc7\u7a0b\u6709\u4ec0\u4e48\u6539\u53d8\u3002</p>\n<p>\u65b0\u7684\u7b97\u6cd5\u653e\u5165 <code>sort_buffer</code> \u7684\u5b57\u6bb5\uff0c\u53ea\u6709\u8981\u6392\u5e8f\u7684\u5217\uff08\u5373 name \u5b57\u6bb5\uff09\u548c\u4e3b\u952e id\u3002</p>\n<p>\u4f46\u8fd9\u65f6\uff0c\u6392\u5e8f\u7684\u7ed3\u679c\u5c31\u56e0\u4e3a\u5c11\u4e86 city \u548c age \u5b57\u6bb5\u7684\u503c\uff0c\u4e0d\u80fd\u76f4\u63a5\u8fd4\u56de\u4e86\uff0c\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u5982\u4e0b\u6240\u793a\u7684\u6837\u5b50\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316 <code>sort_buffer</code>\uff0c\u786e\u5b9a\u653e\u5165\u4e24\u4e2a\u5b57\u6bb5\uff0c\u5373 name \u548c id\uff1b</li>\n<li>\u4ece\u7d22\u5f15 city \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u4e3b\u952e id\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_X</code>\uff1b</li>\n<li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 name\u3001id \u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u5b58\u5165 <code>sort_buffer</code> \u4e2d\uff1b</li>\n<li>\u4ece\u7d22\u5f15 city \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u7684\u4e3b\u952e id\uff1b</li>\n<li>\u91cd\u590d\u6b65\u9aa4 3\u30014 \u76f4\u5230\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u4e3a\u6b62\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_Y</code>\uff1b</li>\n<li>\u5bf9 <code>sort_buffer</code> \u4e2d\u7684\u6570\u636e\u6309\u7167\u5b57\u6bb5 name \u8fdb\u884c\u6392\u5e8f\uff1b</li>\n<li>\u904d\u5386\u6392\u5e8f\u7ed3\u679c\uff0c\u53d6\u524d 1000 \u884c\uff0c\u5e76\u6309\u7167 id \u7684\u503c\u56de\u5230\u539f\u8868\u4e2d\u53d6\u51fa city\u3001name \u548c age \u4e09\u4e2a\u5b57\u6bb5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u6267\u884c\u6d41\u7a0b\u7684\u793a\u610f\u56fe\u5982\u4e0b\uff0c\u6211\u628a\u5b83\u79f0\u4e3a rowid \u6392\u5e8f\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/dc92b67721171206a302eb679c83e86d.jpg\" /></p>\n<p>\u56fe 5 rowid \u6392\u5e8f</p>\n<p>\u5bf9\u6bd4\u56fe 3 \u7684\u5168\u5b57\u6bb5\u6392\u5e8f\u6d41\u7a0b\u56fe\u4f60\u4f1a\u53d1\u73b0\uff0crowid \u6392\u5e8f\u591a\u8bbf\u95ee\u4e86\u4e00\u6b21\u8868 t \u7684\u4e3b\u952e\u7d22\u5f15\uff0c\u5c31\u662f\u6b65\u9aa4 7\u3002</p>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6700\u540e\u7684\u201c\u7ed3\u679c\u96c6\u201d\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u5b9e\u9645\u4e0a MySQL \u670d\u52a1\u7aef\u4ece\u6392\u5e8f\u540e\u7684 <code>sort_buffer</code> \u4e2d\u4f9d\u6b21\u53d6\u51fa id\uff0c\u7136\u540e\u5230\u539f\u8868\u67e5\u5230 city\u3001name \u548c age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u5728\u670d\u52a1\u7aef\u518d\u8017\u8d39\u5185\u5b58\u5b58\u50a8\u7ed3\u679c\uff0c\u662f\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u3002</p>\n<p>\u6839\u636e\u8fd9\u4e2a\u8bf4\u660e\u8fc7\u7a0b\u548c\u56fe\u793a\uff0c\u4f60\u53ef\u4ee5\u60f3\u4e00\u4e0b\uff0c\u8fd9\u4e2a\u65f6\u5019\u6267\u884c <code>select @b-@a</code>\uff0c\u7ed3\u679c\u4f1a\u662f\u591a\u5c11\u5462\uff1f</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u770b\u770b\u7ed3\u679c\u6709\u4ec0\u4e48\u4e0d\u540c\u3002</p>\n<p>\u9996\u5148\uff0c\u56fe\u4e2d\u7684 <code>examined_rows</code> \u7684\u503c\u8fd8\u662f 4000\uff0c\u8868\u793a\u7528\u4e8e\u6392\u5e8f\u7684\u6570\u636e\u662f 4000 \u884c\u3002\u4f46\u662f <code>select @b-@a</code> \u8fd9\u4e2a\u8bed\u53e5\u7684\u503c\u53d8\u6210 5000 \u4e86\u3002</p>\n<p>\u56e0\u4e3a\u8fd9\u65f6\u5019\u9664\u4e86\u6392\u5e8f\u8fc7\u7a0b\u5916\uff0c\u5728\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u8fd8\u8981\u6839\u636e id \u53bb\u539f\u8868\u53d6\u503c\u3002\u7531\u4e8e\u8bed\u53e5\u662f <code>limit 1000</code>\uff0c\u56e0\u6b64\u4f1a\u591a\u8bfb 1000 \u884c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;filesort_summary&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;rows&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4000</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;examined_rows&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4000</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;number_of_tmp_files&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;sort_buffer_size&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">32768</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;sort_mode&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;&lt;sort_key, rowid&gt;&quot;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>\u4ece <code>OPTIMIZER_TRACE</code> \u7684\u7ed3\u679c\u4e2d\uff0c\u4f60\u8fd8\u80fd\u770b\u5230\u53e6\u5916\u4e24\u4e2a\u4fe1\u606f\u4e5f\u53d8\u4e86\u3002</p>\n<ul>\n<li><code>sort_mode</code> \u53d8\u6210\u4e86 <code>&lt;sort_key, rowid&gt;</code>\uff0c\u8868\u793a\u53c2\u4e0e\u6392\u5e8f\u7684\u53ea\u6709 name \u548c id \u8fd9\u4e24\u4e2a\u5b57\u6bb5\u3002</li>\n<li><code>number_of_tmp_files</code> \u53d8\u6210 10 \u4e86\uff0c\u662f\u56e0\u4e3a\u8fd9\u65f6\u5019\u53c2\u4e0e\u6392\u5e8f\u7684\u884c\u6570\u867d\u7136\u4ecd\u7136\u662f 4000 \u884c\uff0c\u4f46\u662f\u6bcf\u4e00\u884c\u90fd\u53d8\u5c0f\u4e86\uff0c\u56e0\u6b64\u9700\u8981\u6392\u5e8f\u7684\u603b\u6570\u636e\u91cf\u5c31\u53d8\u5c0f\u4e86\uff0c\u9700\u8981\u7684\u4e34\u65f6\u6587\u4ef6\u4e5f\u76f8\u5e94\u5730\u53d8\u5c11\u4e86\u3002</li>\n</ul>\n<h3 id=\"vs-rowid\">\u5168\u5b57\u6bb5\u6392\u5e8f VS rowid \u6392\u5e8f<a class=\"headerlink\" href=\"#vs-rowid\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\uff0c\u4ece\u8fd9\u4e24\u4e2a\u6267\u884c\u6d41\u7a0b\u91cc\uff0c\u8fd8\u80fd\u5f97\u51fa\u4ec0\u4e48\u7ed3\u8bba\u3002</p>\n<p>\u5982\u679c MySQL \u5b9e\u5728\u662f\u62c5\u5fc3\u6392\u5e8f\u5185\u5b58\u592a\u5c0f\uff0c\u4f1a\u5f71\u54cd\u6392\u5e8f\u6548\u7387\uff0c\u624d\u4f1a\u91c7\u7528 rowid \u6392\u5e8f\u7b97\u6cd5\uff0c\u8fd9\u6837\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u4e00\u6b21\u53ef\u4ee5\u6392\u5e8f\u66f4\u591a\u884c\uff0c\u4f46\u662f\u9700\u8981\u518d\u56de\u5230\u539f\u8868\u53bb\u53d6\u6570\u636e\u3002</p>\n<p>\u5982\u679c MySQL \u8ba4\u4e3a\u5185\u5b58\u8db3\u591f\u5927\uff0c\u4f1a\u4f18\u5148\u9009\u62e9\u5168\u5b57\u6bb5\u6392\u5e8f\uff0c\u628a\u9700\u8981\u7684\u5b57\u6bb5\u90fd\u653e\u5230 sort_buffer \u4e2d\uff0c\u8fd9\u6837\u6392\u5e8f\u540e\u5c31\u4f1a\u76f4\u63a5\u4ece\u5185\u5b58\u91cc\u9762\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c\u4e86\uff0c\u4e0d\u7528\u518d\u56de\u5230\u539f\u8868\u53bb\u53d6\u6570\u636e\u3002</p>\n<p>\u8fd9\u4e5f\u5c31\u4f53\u73b0\u4e86 MySQL \u7684\u4e00\u4e2a\u8bbe\u8ba1\u601d\u60f3\uff1a<strong>\u5982\u679c\u5185\u5b58\u591f\uff0c\u5c31\u8981\u591a\u5229\u7528\u5185\u5b58\uff0c\u5c3d\u91cf\u51cf\u5c11\u78c1\u76d8\u8bbf\u95ee\u3002</strong></p>\n<p>\u5bf9\u4e8e InnoDB \u8868\u6765\u8bf4\uff0crowid \u6392\u5e8f\u4f1a\u8981\u6c42\u56de\u8868\u591a\u9020\u6210\u78c1\u76d8\u8bfb\uff0c\u56e0\u6b64\u4e0d\u4f1a\u88ab\u4f18\u5148\u9009\u62e9\u3002</p>\n<p>\u8fd9\u4e2a\u7ed3\u8bba\u770b\u4e0a\u53bb\u6709\u70b9\u5e9f\u8bdd\u7684\u611f\u89c9\uff0c\u4f46\u662f\u4f60\u8981\u8bb0\u4f4f\u5b83\uff0c\u4e0b\u4e00\u7bc7\u6587\u7ae0\u6211\u4eec\u5c31\u4f1a\u7528\u5230\u3002</p>\n<p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u5c31\u4e86\u89e3\u4e86\uff0cMySQL \u505a\u6392\u5e8f\u662f\u4e00\u4e2a\u6210\u672c\u6bd4\u8f83\u9ad8\u7684\u64cd\u4f5c\u3002\u90a3\u4e48\u4f60\u4f1a\u95ee\uff0c\u662f\u4e0d\u662f\u6240\u6709\u7684 <code>order by</code> \u90fd\u9700\u8981\u6392\u5e8f\u64cd\u4f5c\u5462\uff1f\u5982\u679c\u4e0d\u6392\u5e8f\u5c31\u80fd\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u90a3\u5bf9\u7cfb\u7edf\u7684\u6d88\u8017\u4f1a\u5c0f\u5f88\u591a\uff0c\u8bed\u53e5\u7684\u6267\u884c\u65f6\u95f4\u4e5f\u4f1a\u53d8\u5f97\u66f4\u77ed\u3002</p>\n<p>\u5176\u5b9e\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684 <code>order by</code> \u8bed\u53e5\uff0c\u90fd\u9700\u8981\u6392\u5e8f\u64cd\u4f5c\u7684\u3002\u4ece\u4e0a\u9762\u5206\u6790\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u4e4b\u6240\u4ee5\u9700\u8981\u751f\u6210\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u5728\u4e34\u65f6\u8868\u4e0a\u505a\u6392\u5e8f\u64cd\u4f5c\uff0c<strong>\u5176\u539f\u56e0\u662f\u539f\u6765\u7684\u6570\u636e\u90fd\u662f\u65e0\u5e8f\u7684\u3002</strong></p>\n<p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e0b\uff0c\u5982\u679c\u80fd\u591f\u4fdd\u8bc1\u4ece city \u8fd9\u4e2a\u7d22\u5f15\u4e0a\u53d6\u51fa\u6765\u7684\u884c\uff0c\u5929\u7136\u5c31\u662f\u6309\u7167 name \u9012\u589e\u6392\u5e8f\u7684\u8bdd\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u4e0d\u7528\u518d\u6392\u5e8f\u4e86\u5462\uff1f</p>\n<p>\u786e\u5b9e\u662f\u8fd9\u6837\u7684\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fd9\u4e2a\u5e02\u6c11\u8868\u4e0a\u521b\u5efa\u4e00\u4e2a city \u548c name \u7684\u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">city_user</span><span class=\"p\">(</span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u4f5c\u4e3a\u4e0e city \u7d22\u5f15\u7684\u5bf9\u6bd4\uff0c\u6211\u4eec\u6765\u770b\u770b\u8fd9\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/f980201372b676893647fb17fac4e2bf.png\" /></p>\n<p>\u56fe 7 city \u548c name \u8054\u5408\u7d22\u5f15\u793a\u610f\u56fe</p>\n<p>\u5728\u8fd9\u4e2a\u7d22\u5f15\u91cc\u9762\uff0c\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u7528\u6811\u641c\u7d22\u7684\u65b9\u5f0f\u5b9a\u4f4d\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u7684\u8bb0\u5f55\uff0c\u5e76\u4e14\u989d\u5916\u786e\u4fdd\u4e86\uff0c\u63a5\u4e0b\u6765\u6309\u987a\u5e8f\u53d6\u201c\u4e0b\u4e00\u6761\u8bb0\u5f55\u201d\u7684\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u8981 city \u7684\u503c\u662f\u676d\u5dde\uff0cname \u7684\u503c\u5c31\u4e00\u5b9a\u662f\u6709\u5e8f\u7684\u3002</p>\n<p>\u8fd9\u6837\u6574\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u7684\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p>\n<ol>\n<li>\u4ece\u7d22\u5f15 <code>(city,name)</code> \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u4e3b\u952e id\uff1b</li>\n<li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 <code>name\u3001city\u3001age</code> \u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li>\n<li>\u4ece\u7d22\u5f15 <code>(city,name)</code> \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u4e3b\u952e id\uff1b</li>\n<li>\u91cd\u590d\u6b65\u9aa4 2\u30013\uff0c\u76f4\u5230\u67e5\u5230\u7b2c 1000 \u6761\u8bb0\u5f55\uff0c\u6216\u8005\u662f\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u65f6\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/3f590c3a14f9236f2d8e1e2cb9686692.jpg\" /></p>\n<p>\u56fe 8 \u5f15\u5165 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\u540e\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8ba1\u5212</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u4e0d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u6392\u5e8f\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7528 explain \u7684\u7ed3\u679c\u6765\u5370\u8bc1\u4e00\u4e0b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\">  </span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">city_user</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city_user</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">66</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0cExtra \u5b57\u6bb5\u4e2d\u6ca1\u6709 <code>Using filesort</code> \u4e86\uff0c\u4e5f\u5c31\u662f\u4e0d\u9700\u8981\u6392\u5e8f\u4e86\u3002\u800c\u4e14\u7531\u4e8e <code>(city,name)</code> \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u672c\u8eab\u6709\u5e8f\uff0c\u6240\u4ee5\u8fd9\u4e2a\u67e5\u8be2\u4e5f\u4e0d\u7528\u628a 4000 \u884c\u5168\u90fd\u8bfb\u4e00\u904d\uff0c\u53ea\u8981\u627e\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u524d 1000 \u6761\u8bb0\u5f55\u5c31\u53ef\u4ee5\u9000\u51fa\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u53ea\u9700\u8981\u626b\u63cf 1000 \u6b21\u3002</p>\n<p>\u65e2\u7136\u8bf4\u5230\u8fd9\u91cc\u4e86\uff0c\u6211\u4eec\u518d\u5f80\u524d\u8ba8\u8bba\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u6709\u6ca1\u6709\u53ef\u80fd\u8fdb\u4e00\u6b65\u7b80\u5316\u5462\uff1f\u4e0d\u77e5\u9053\u4f60\u8fd8\u8bb0\u4e0d\u8bb0\u5f97\uff0c\u6211\u5728\u7b2c 5 \u7bc7\u6587\u7ae0[\u300a \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0b\uff09\u300b]\u4e2d\uff0c\u548c\u4f60\u4ecb\u7ecd\u7684\u8986\u76d6\u7d22\u5f15\u3002</p>\n<p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u518d\u7a0d\u5fae\u590d\u4e60\u4e00\u4e0b\u3002<strong>\u8986\u76d6\u7d22\u5f15\u662f\u6307\uff0c\u7d22\u5f15\u4e0a\u7684\u4fe1\u606f\u8db3\u591f\u6ee1\u8db3\u67e5\u8be2\u8bf7\u6c42\uff0c\u4e0d\u9700\u8981\u518d\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u53d6\u6570\u636e\u3002</strong></p>\n<p>\u6309\u7167\u8986\u76d6\u7d22\u5f15\u7684\u6982\u5ff5\uff0c\u6211\u4eec\u53ef\u4ee5\u518d\u4f18\u5316\u4e00\u4e0b\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002</p>\n<p>\u9488\u5bf9\u8fd9\u4e2a\u67e5\u8be2\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a city\u3001name \u548c age \u7684\u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u5c31\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">city_user_age</span><span class=\"p\">(</span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">age</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\uff0c\u5bf9\u4e8e city \u5b57\u6bb5\u7684\u503c\u76f8\u540c\u7684\u884c\u6765\u8bf4\uff0c\u8fd8\u662f\u6309\u7167 name \u5b57\u6bb5\u7684\u503c\u9012\u589e\u6392\u5e8f\u7684\uff0c\u6b64\u65f6\u7684\u67e5\u8be2\u8bed\u53e5\u4e5f\u5c31\u4e0d\u518d\u9700\u8981\u6392\u5e8f\u4e86\u3002\u8fd9\u6837\u6574\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p>\n<ol>\n<li>\u4ece\u7d22\u5f15 <code>(city,name,age)</code> \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u53d6\u51fa\u5176\u4e2d\u7684 city\u3001name \u548c age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li>\n<li>\u4ece\u7d22\u5f15 <code>(city,name,age)</code> \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u540c\u6837\u53d6\u51fa\u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li>\n<li>\u91cd\u590d\u6267\u884c\u6b65\u9aa4 2\uff0c\u76f4\u5230\u67e5\u5230\u7b2c 1000 \u6761\u8bb0\u5f55\uff0c\u6216\u8005\u662f\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u65f6\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/df4b8e445a59c53df1f2e0f115f02cd6.jpg\" /></p>\n<p>\u56fe 10 \u5f15\u5165 (city,name,age) \u8054\u5408\u7d22\u5f15\u540e\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b</p>\n<p>\u7136\u540e\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b explain \u7684\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\">  </span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">           </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">city_user_age</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">city_user_age</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">66</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cExtra \u5b57\u6bb5\u91cc\u9762\u591a\u4e86 <code>Using index</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u6027\u80fd\u4e0a\u4f1a\u5feb\u5f88\u591a\u3002</p>\n<p>\u5f53\u7136\uff0c\u8fd9\u91cc\u5e76\u4e0d\u662f\u8bf4\u8981\u4e3a\u4e86\u6bcf\u4e2a\u67e5\u8be2\u80fd\u7528\u4e0a\u8986\u76d6\u7d22\u5f15\uff0c\u5c31\u8981\u628a\u8bed\u53e5\u4e2d\u6d89\u53ca\u7684\u5b57\u6bb5\u90fd\u5efa\u4e0a\u8054\u5408\u7d22\u5f15\uff0c\u6bd5\u7adf\u7d22\u5f15\u8fd8\u662f\u6709\u7ef4\u62a4\u4ee3\u4ef7\u7684\u3002\u8fd9\u662f\u4e00\u4e2a\u9700\u8981\u6743\u8861\u7684\u51b3\u5b9a\u3002</p>\n<h3 id=\"_16\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_16\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u91cc\u9762 <code>order by</code> \u8bed\u53e5\u7684\u51e0\u79cd\u7b97\u6cd5\u6d41\u7a0b\u3002</p>\n<p>\u5728\u5f00\u53d1\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u4f60\u603b\u662f\u4e0d\u53ef\u907f\u514d\u5730\u4f1a\u4f7f\u7528\u5230 <code>order by</code> \u8bed\u53e5\u3002\u4f60\u5fc3\u91cc\u8981\u6e05\u695a\u6bcf\u4e2a\u8bed\u53e5\u7684\u6392\u5e8f\u903b\u8f91\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff0c\u8fd8\u8981\u80fd\u591f\u5206\u6790\u51fa\u5728\u6700\u574f\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u5bf9\u7cfb\u7edf\u8d44\u6e90\u7684\u6d88\u8017\uff0c\u8fd9\u6837\u624d\u80fd\u505a\u5230\u4e0b\u7b14\u5982\u6709\u795e\uff0c\u4e0d\u72af\u4f4e\u7ea7\u9519\u8bef\u3002</p>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p>\n<p>\u5047\u8bbe\u4f60\u7684\u8868\u91cc\u9762\u5df2\u7ecf\u6709\u4e86 <code>city_name(city, name)</code> \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\uff0c\u7136\u540e\u4f60\u8981\u67e5\u676d\u5dde\u548c\u82cf\u5dde\u4e24\u4e2a\u57ce\u5e02\u4e2d\u6240\u6709\u7684\u5e02\u6c11\u7684\u59d3\u540d\uff0c\u5e76\u4e14\u6309\u540d\u5b57\u6392\u5e8f\uff0c\u663e\u793a\u524d 100 \u6761\u8bb0\u5f55\u3002\u5982\u679c SQL \u67e5\u8be2\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684 \uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"p\">,</span><span class=\"ss\">&quot;\u82cf\u5dde&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u7684\u65f6\u5019\u4f1a\u6709\u6392\u5e8f\u8fc7\u7a0b\u5417\uff0c\u4e3a\u4ec0\u4e48\uff1f</p>\n<p>\u5982\u679c\u4e1a\u52a1\u7aef\u4ee3\u7801\u7531\u4f60\u6765\u5f00\u53d1\uff0c\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u5728\u6570\u636e\u5e93\u7aef\u4e0d\u9700\u8981\u6392\u5e8f\u7684\u65b9\u6848\uff0c\u4f60\u4f1a\u600e\u4e48\u5b9e\u73b0\u5462\uff1f</p>\n<p>\u8fdb\u4e00\u6b65\u5730\uff0c\u5982\u679c\u6709\u5206\u9875\u9700\u6c42\uff0c\u8981\u663e\u793a\u7b2c 101 \u9875\uff0c\u4e5f\u5c31\u662f\u8bf4\u8bed\u53e5\u6700\u540e\u8981\u6539\u6210  <code>limit 10000,100</code>\uff0c \u4f60\u7684\u5b9e\u73b0\u65b9\u6cd5\u53c8\u4f1a\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a</p>\n<p>\u867d\u7136\u6709 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u4e8e\u5355\u4e2a city \u5185\u90e8\uff0cname \u662f\u9012\u589e\u7684\u3002\u4f46\u662f\u7531\u4e8e\u8fd9\u6761 SQL \u8bed\u53e5\u4e0d\u662f\u8981\u5355\u72ec\u5730\u67e5\u4e00\u4e2a city \u7684\u503c\uff0c\u800c\u662f\u540c\u65f6\u67e5\u4e86\"\u676d\u5dde\"\u548c\" \u82cf\u5dde \"\u4e24\u4e2a\u57ce\u5e02\uff0c\u56e0\u6b64\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684 name \u5c31\u4e0d\u662f\u9012\u589e\u7684\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u9700\u8981\u6392\u5e8f\u3002</p>\n<p>\u90a3\u600e\u4e48\u907f\u514d\u6392\u5e8f\u5462\uff1f</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u8981\u7528\u5230 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\u7684\u7279\u6027\uff0c\u628a\u8fd9\u4e00\u6761\u8bed\u53e5\u62c6\u6210\u4e24\u6761\u8bed\u53e5\uff0c\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6267\u884c <code>select * from t where city=\u201c\u676d\u5dde\u201d order by name limit 100;</code> \u8fd9\u4e2a\u8bed\u53e5\u662f\u4e0d\u9700\u8981\u6392\u5e8f\u7684\uff0c\u5ba2\u6237\u7aef\u7528\u4e00\u4e2a\u957f\u5ea6\u4e3a 100 \u7684\u5185\u5b58\u6570\u7ec4 A \u4fdd\u5b58\u7ed3\u679c\u3002</li>\n<li>\u6267\u884c <code>select * from t where city=\u201c\u82cf\u5dde\u201d order by name limit 100;</code> \u7528\u76f8\u540c\u7684\u65b9\u6cd5\uff0c\u5047\u8bbe\u7ed3\u679c\u88ab\u5b58\u8fdb\u4e86\u5185\u5b58\u6570\u7ec4 B\u3002</li>\n<li>\u73b0\u5728 A \u548c B \u662f\u4e24\u4e2a\u6709\u5e8f\u6570\u7ec4\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u7528\u5f52\u5e76\u6392\u5e8f\u7684\u601d\u60f3\uff0c\u5f97\u5230 name \u6700\u5c0f\u7684\u524d 100 \u503c\uff0c\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684\u7ed3\u679c\u4e86\u3002</li>\n</ol>\n<p>\u5982\u679c\u628a\u8fd9\u6761 SQL \u8bed\u53e5\u91cc <code>limit 100</code> \u6539\u6210 <code>limit 10000,100</code> \u7684\u8bdd\uff0c\u5904\u7406\u65b9\u5f0f\u5176\u5b9e\u4e5f\u5dee\u4e0d\u591a\uff0c\u5373\uff1a\u8981\u628a\u4e0a\u9762\u7684\u4e24\u6761\u8bed\u53e5\u6539\u6210\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10100</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u548c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u82cf\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10100</span><span class=\"err\">\u3002</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\u6570\u636e\u91cf\u8f83\u5927\uff0c\u53ef\u4ee5\u540c\u65f6\u8d77\u4e24\u4e2a\u8fde\u63a5\u4e00\u884c\u884c\u8bfb\u7ed3\u679c\uff0c\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u62ff\u5230\u8fd9\u4e24\u4e2a\u7ed3\u679c\u96c6\u91cc\uff0c\u6309\u987a\u5e8f\u53d6\u7b2c <code>10001~10100</code> \u7684 name \u503c\uff0c\u5c31\u662f\u9700\u8981\u7684\u7ed3\u679c\u4e86\u3002</p>\n<p>\u5f53\u7136\u8fd9\u4e2a\u65b9\u6848\u6709\u4e00\u4e2a\u660e\u663e\u7684\u635f\u5931\uff0c\u5c31\u662f\u4ece\u6570\u636e\u5e93\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u6570\u636e\u91cf\u53d8\u5927\u4e86\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u6570\u636e\u7684\u5355\u884c\u6bd4\u8f83\u5927\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u628a\u8fd9\u4e24\u6761 SQL \u8bed\u53e5\u6539\u6210\u4e0b\u9762\u8fd9\u79cd\u5199\u6cd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10100</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u548c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u82cf\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10100</span><span class=\"err\">\u3002</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u518d\u7528\u5f52\u5e76\u6392\u5e8f\u7684\u65b9\u6cd5\u53d6\u5f97\u6309 name \u987a\u5e8f\u7b2c <code>10001~10100</code> \u7684 name\u3001id \u7684\u503c\uff0c\u7136\u540e\u62ff\u7740\u8fd9 100 \u4e2a id \u5230\u6570\u636e\u5e93\u4e2d\u53bb\u67e5\u51fa\u6240\u6709\u8bb0\u5f55\u3002</p>\n<p>\u4e0a\u9762\u8fd9\u4e9b\u65b9\u6cd5\uff0c\u9700\u8981\u4f60\u6839\u636e\u6027\u80fd\u9700\u6c42\u548c\u5f00\u53d1\u7684\u590d\u6742\u5ea6\u505a\u51fa\u6743\u8861\u3002</p>\n<h2 id=\"17\">17 \u5982\u4f55\u6b63\u786e\u5730\u663e\u793a\u968f\u673a\u6d88\u606f\uff1f<a class=\"headerlink\" href=\"#17\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\uff0c\u4e3a\u4f60\u8bb2\u89e3\u5b8c order by \u8bed\u53e5\u7684\u51e0\u79cd\u6267\u884c\u6a21\u5f0f\u540e\uff0c\u5c31\u60f3\u5230\u4e86\u4e4b\u524d\u4e00\u4e2a\u505a\u82f1\u8bed\u5b66\u4e60 App \u7684\u670b\u53cb\u78b0\u5230\u8fc7\u7684\u4e00\u4e2a\u6027\u80fd\u95ee\u9898\u3002</p>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u4ece\u8fd9\u4e2a\u6027\u80fd\u95ee\u9898\u8bf4\u8d77\uff0c\u548c\u4f60\u8bf4\u8bf4 MySQL \u4e2d\u7684\u53e6\u5916\u4e00\u79cd\u6392\u5e8f\u9700\u6c42\uff0c\u5e0c\u671b\u80fd\u591f\u52a0\u6df1\u4f60\u5bf9 MySQL \u6392\u5e8f\u903b\u8f91\u7684\u7406\u89e3\u3002</p>\n<p>\u67d0\u82f1\u8bed\u5b66\u4e60 App \u9996\u9875\u6709\u4e00\u4e2a\u968f\u673a\u663e\u793a\u5355\u8bcd\u7684\u529f\u80fd\uff0c\u4e5f\u5c31\u662f\u6839\u636e\u6bcf\u4e2a\u7528\u6237\u7684\u7ea7\u522b\u6709\u4e00\u4e2a\u5355\u8bcd\u8868\uff0c\u7136\u540e\u8fd9\u4e2a\u7528\u6237\u6bcf\u6b21\u8bbf\u95ee\u9996\u9875\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u968f\u673a\u6eda\u52a8\u663e\u793a\u4e09\u4e2a\u5355\u8bcd\u3002\u4ed6\u4eec\u53d1\u73b0\u968f\u7740\u5355\u8bcd\u8868\u53d8\u5927\uff0c\u9009\u5355\u8bcd\u8fd9\u4e2a\u903b\u8f91\u53d8\u5f97\u8d8a\u6765\u8d8a\u6162\uff0c\u751a\u81f3\u5f71\u54cd\u5230\u4e86\u9996\u9875\u7684\u6253\u5f00\u901f\u5ea6\u3002</p>\n<p>\u73b0\u5728\uff0c\u5982\u679c\u8ba9\u4f60\u6765\u8bbe\u8ba1\u8fd9\u4e2a SQL \u8bed\u53e5\uff0c\u4f60\u4f1a\u600e\u4e48\u5199\u5462\uff1f</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u6211\u5bf9\u8fd9\u4e2a\u4f8b\u5b50\u8fdb\u884c\u4e86\u7b80\u5316\uff1a\u53bb\u6389\u6bcf\u4e2a\u7ea7\u522b\u7684\u7528\u6237\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684\u5355\u8bcd\u8868\u8fd9\u4e2a\u903b\u8f91\uff0c\u76f4\u63a5\u5c31\u662f\u4ece\u4e00\u4e2a\u5355\u8bcd\u8868\u4e2d\u968f\u673a\u9009\u51fa\u4e09\u4e2a\u5355\u8bcd\u3002\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u548c\u521d\u59cb\u6570\u636e\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">words</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">word</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">&lt;</span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"p\">(</span><span class=\"n\">word</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">concat</span><span class=\"p\">(</span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">97</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">div</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">97</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">div</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">97</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">div</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"nb\">char</span><span class=\"p\">(</span><span class=\"mi\">97</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">))));</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u8bf4\u660e\uff0c\u6211\u5728\u8fd9\u4e2a\u8868\u91cc\u9762\u63d2\u5165\u4e86 10000 \u884c\u8bb0\u5f55\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u770b\u770b\u8981\u968f\u673a\u9009\u62e9 3 \u4e2a\u5355\u8bcd\uff0c\u6709\u4ec0\u4e48\u65b9\u6cd5\u5b9e\u73b0\uff0c\u5b58\u5728\u4ec0\u4e48\u95ee\u9898\u4ee5\u53ca\u5982\u4f55\u6539\u8fdb\u3002</p>\n<h3 id=\"_17\">\u5185\u5b58\u4e34\u65f6\u8868<a class=\"headerlink\" href=\"#_17\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\uff0c\u4f60\u4f1a\u60f3\u5230\u7528 order by rand() \u6765\u5b9e\u73b0\u8fd9\u4e2a\u903b\u8f91\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u610f\u601d\u5f88\u76f4\u767d\uff0c\u968f\u673a\u6392\u5e8f\u53d6\u524d 3 \u4e2a\u3002\u867d\u7136\u8fd9\u4e2a SQL \u8bed\u53e5\u5199\u6cd5\u5f88\u7b80\u5355\uff0c\u4f46\u6267\u884c\u6d41\u7a0b\u5374\u6709\u70b9\u590d\u6742\u7684\u3002</p>\n<p>\u6211\u4eec\u5148\u7528 explain \u547d\u4ee4\u6765\u770b\u770b\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                           </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">9980</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"n\">filesort</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Extra \u5b57\u6bb5\u663e\u793a <code>Using temporary</code>\uff0c\u8868\u793a\u7684\u662f\u9700\u8981\u4f7f\u7528\u4e34\u65f6\u8868\uff1b<code>Using filesort</code>\uff0c\u8868\u793a\u7684\u662f\u9700\u8981\u6267\u884c\u6392\u5e8f\u64cd\u4f5c\u3002</p>\n<p>\u56e0\u6b64\u8fd9\u4e2a Extra \u7684\u610f\u601d\u5c31\u662f\uff0c\u9700\u8981\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u9700\u8981\u5728\u4e34\u65f6\u8868\u4e0a\u6392\u5e8f\u3002</p>\n<p>\u4f60\u89c9\u5f97\u5bf9\u4e8e\u4e34\u65f6\u5185\u5b58\u8868\u7684\u6392\u5e8f\u6765\u8bf4\uff0c\u5b83\u4f1a\u9009\u62e9\u54ea\u4e00\u79cd\u7b97\u6cd5\u5462\uff1f\u56de\u987e\u4e00\u4e0b\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684\u4e00\u4e2a\u7ed3\u8bba\uff1a<strong>\u5bf9\u4e8e InnoDB \u8868\u6765\u8bf4</strong>\uff0c\u6267\u884c\u5168\u5b57\u6bb5\u6392\u5e8f\u4f1a\u51cf\u5c11\u78c1\u76d8\u8bbf\u95ee\uff0c\u56e0\u6b64\u4f1a\u88ab\u4f18\u5148\u9009\u62e9\u3002</p>\n<p>\u6211\u5f3a\u8c03\u4e86\u201cInnoDB \u8868\u201d\uff0c\u4f60\u80af\u5b9a\u60f3\u5230\u4e86\uff0c<strong>\u5bf9\u4e8e\u5185\u5b58\u8868\uff0c\u56de\u8868\u8fc7\u7a0b\u53ea\u662f\u7b80\u5355\u5730\u6839\u636e\u6570\u636e\u884c\u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u8bbf\u95ee\u5185\u5b58\u5f97\u5230\u6570\u636e\uff0c\u6839\u672c\u4e0d\u4f1a\u5bfc\u81f4\u591a\u8bbf\u95ee\u78c1\u76d8</strong>\u3002\u4f18\u5316\u5668\u6ca1\u6709\u4e86\u8fd9\u4e00\u5c42\u987e\u8651\uff0c\u90a3\u4e48\u5b83\u4f1a\u4f18\u5148\u8003\u8651\u7684\uff0c\u5c31\u662f\u7528\u4e8e\u6392\u5e8f\u7684\u884c\u8d8a\u5c11\u8d8a\u597d\u4e86\uff0c\u6240\u4ee5\uff0cMySQL \u8fd9\u65f6\u5c31\u4f1a\u9009\u62e9 rowid \u6392\u5e8f\u3002</p>\n<p>\u7406\u89e3\u4e86\u8fd9\u4e2a\u7b97\u6cd5\u9009\u62e9\u7684\u903b\u8f91\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002\u540c\u65f6\uff0c\u901a\u8fc7\u4eca\u5929\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u6765\u5c1d\u8bd5\u5206\u6790\u4e00\u4e0b\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u3002</p>\n<p>\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u8868\u3002\u8fd9\u4e2a\u4e34\u65f6\u8868\u4f7f\u7528\u7684\u662f memory \u5f15\u64ce\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5\uff0c\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u662f double \u7c7b\u578b\uff0c\u4e3a\u4e86\u540e\u9762\u63cf\u8ff0\u65b9\u4fbf\uff0c\u8bb0\u4e3a\u5b57\u6bb5 R\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u662f <code>varchar(64)</code> \u7c7b\u578b\uff0c\u8bb0\u4e3a\u5b57\u6bb5 W\u3002\u5e76\u4e14\uff0c\u8fd9\u4e2a\u8868\u6ca1\u6709\u5efa\u7d22\u5f15\u3002</li>\n<li>\u4ece words \u8868\u4e2d\uff0c\u6309\u4e3b\u952e\u987a\u5e8f\u53d6\u51fa\u6240\u6709\u7684 word \u503c\u3002\u5bf9\u4e8e\u6bcf\u4e00\u4e2a word \u503c\uff0c\u8c03\u7528 <code>rand()</code> \u51fd\u6570\u751f\u6210\u4e00\u4e2a\u5927\u4e8e 0 \u5c0f\u4e8e 1 \u7684\u968f\u673a\u5c0f\u6570\uff0c\u5e76\u628a\u8fd9\u4e2a\u968f\u673a\u5c0f\u6570\u548c word \u5206\u522b\u5b58\u5165\u4e34\u65f6\u8868\u7684 R \u548c W \u5b57\u6bb5\u4e2d\uff0c\u5230\u6b64\uff0c\u626b\u63cf\u884c\u6570\u662f 10000\u3002</li>\n<li>\u73b0\u5728\u4e34\u65f6\u8868\u6709 10000 \u884c\u6570\u636e\u4e86\uff0c\u63a5\u4e0b\u6765\u4f60\u8981\u5728\u8fd9\u4e2a\u6ca1\u6709\u7d22\u5f15\u7684\u5185\u5b58\u4e34\u65f6\u8868\u4e0a\uff0c\u6309\u7167\u5b57\u6bb5 R \u6392\u5e8f\u3002</li>\n<li>\u521d\u59cb\u5316 <code>sort_buffer</code>\u3002<code>sort_buffer</code> \u4e2d\u6709\u4e24\u4e2a\u5b57\u6bb5\uff0c\u4e00\u4e2a\u662f double \u7c7b\u578b\uff0c\u53e6\u4e00\u4e2a\u662f\u6574\u578b\u3002</li>\n<li>\u4ece\u5185\u5b58\u4e34\u65f6\u8868\u4e2d\u4e00\u884c\u4e00\u884c\u5730\u53d6\u51fa R \u503c\u548c\u4f4d\u7f6e\u4fe1\u606f\uff0c\u5206\u522b\u5b58\u5165 <code>sort_buffer</code> \u4e2d\u7684\u4e24\u4e2a\u5b57\u6bb5\u91cc\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u8981\u5bf9\u5185\u5b58\u4e34\u65f6\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u6b64\u65f6\u626b\u63cf\u884c\u6570\u589e\u52a0 10000\uff0c\u53d8\u6210\u4e86 20000\u3002</li>\n<li>\u5728 <code>sort_buffer</code> \u4e2d\u6839\u636e R \u7684\u503c\u8fdb\u884c\u6392\u5e8f\u3002\u6ce8\u610f\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6ca1\u6709\u6d89\u53ca\u5230\u8868\u64cd\u4f5c\uff0c\u6240\u4ee5\u4e0d\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\u3002</li>\n<li>\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u53d6\u51fa\u524d\u4e09\u4e2a\u7ed3\u679c\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0c\u4f9d\u6b21\u5230\u5185\u5b58\u4e34\u65f6\u8868\u4e2d\u53d6\u51fa word \u503c\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u8bbf\u95ee\u4e86\u8868\u7684\u4e09\u884c\u6570\u636e\uff0c\u603b\u626b\u63cf\u884c\u6570\u53d8\u6210\u4e86 20003\u3002</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6765\u9a8c\u8bc1\u4e00\u4e0b\u6211\u4eec\u5206\u6790\u5f97\u5230\u7684\u626b\u63cf\u884c\u6570\u662f\u5426\u6b63\u786e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"o\">###</span><span class=\"w\"> </span><span class=\"n\">Query_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">900376</span><span class=\"w\">  </span><span class=\"n\">Lock_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000347</span><span class=\"w\"> </span><span class=\"n\">Rows_sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">Rows_examined</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">20003</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"o\">=</span><span class=\"mi\">1541402277</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff0c<code>Rows_examined\uff1a20003</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86 20003 \u884c\uff0c\u4e5f\u5c31\u9a8c\u8bc1\u4e86\u6211\u4eec\u5206\u6790\u5f97\u51fa\u7684\u7ed3\u8bba\u3002</p>\n<p>\u8fd9\u91cc\u63d2\u4e00\u53e5\u9898\u5916\u8bdd\uff0c\u5728\u5e73\u65f6\u5b66\u4e60\u6982\u5ff5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u7ecf\u5e38\u8fd9\u6837\u505a\uff0c\u5148\u901a\u8fc7\u539f\u7406\u5206\u6790\u7b97\u51fa\u626b\u63cf\u884c\u6570\uff0c\u7136\u540e\u518d\u901a\u8fc7\u67e5\u770b\u6162\u67e5\u8be2\u65e5\u5fd7\uff0c\u6765\u9a8c\u8bc1\u81ea\u5df1\u7684\u7ed3\u8bba\u3002\u6211\u81ea\u5df1\u5c31\u662f\u7ecf\u5e38\u8fd9\u4e48\u505a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5f88\u6709\u8da3\uff0c\u5206\u6790\u5bf9\u4e86\u5f00\u5fc3\uff0c\u5206\u6790\u9519\u4e86\u4f46\u662f\u5f04\u6e05\u695a\u4e86\u4e5f\u5f88\u5f00\u5fc3\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u6765\u628a\u5b8c\u6574\u7684\u6392\u5e8f\u6267\u884c\u6d41\u7a0b\u56fe\u753b\u51fa\u6765\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/2abe849faa7dcad0189b61238b849ffc.png\" /></p>\n<p>\u56fe 4 \u968f\u673a\u6392\u5e8f\u5b8c\u6574\u6d41\u7a0b\u56fe 1</p>\n<p>\u56fe\u4e2d\u7684 pos \u5c31\u662f\u4f4d\u7f6e\u4fe1\u606f\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u5947\u602a\uff0c\u8fd9\u91cc\u7684\u201c\u4f4d\u7f6e\u4fe1\u606f\u201d\u662f\u4e2a\u4ec0\u4e48\u6982\u5ff5\uff1f\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5bf9 InnoDB \u8868\u6392\u5e8f\u7684\u65f6\u5019\uff0c\u660e\u660e\u7528\u7684\u8fd8\u662f ID \u5b57\u6bb5\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u8981\u56de\u5230\u4e00\u4e2a\u57fa\u672c\u6982\u5ff5\uff1a<strong>MySQL \u7684\u8868\u662f\u7528\u4ec0\u4e48\u65b9\u6cd5\u6765\u5b9a\u4f4d\u201c\u4e00\u884c\u6570\u636e\u201d\u7684\u3002</strong></p>\n<p>\u5728\u524d\u9762[\u7b2c 4]\u548c[\u7b2c 5]\u7bc7\u4ecb\u7ecd\u7d22\u5f15\u7684\u6587\u7ae0\u4e2d\uff0c\u6709\u51e0\u4f4d\u540c\u5b66\u95ee\u5230\uff0c\u5982\u679c\u628a\u4e00\u4e2a InnoDB \u8868\u7684\u4e3b\u952e\u5220\u6389\uff0c\u662f\u4e0d\u662f\u5c31\u6ca1\u6709\u4e3b\u952e\uff0c\u5c31\u6ca1\u529e\u6cd5\u56de\u8868\u4e86\uff1f</p>\n<p>\u5176\u5b9e\u4e0d\u662f\u7684\u3002\u5982\u679c\u4f60\u521b\u5efa\u7684\u8868\u6ca1\u6709\u4e3b\u952e\uff0c\u6216\u8005\u628a\u4e00\u4e2a\u8868\u7684\u4e3b\u952e\u5220\u6389\u4e86\uff0c\u90a3\u4e48 InnoDB \u4f1a\u81ea\u5df1\u751f\u6210\u4e00\u4e2a\u957f\u5ea6\u4e3a 6 \u5b57\u8282\u7684 rowid \u6765\u4f5c\u4e3a\u4e3b\u952e\u3002</p>\n<p>\u8fd9\u4e5f\u5c31\u662f\u6392\u5e8f\u6a21\u5f0f\u91cc\u9762\uff0crowid \u540d\u5b57\u7684\u6765\u5386\u3002\u5b9e\u9645\u4e0a\u5b83\u8868\u793a\u7684\u662f\uff1a\u6bcf\u4e2a\u5f15\u64ce\u7528\u6765\u552f\u4e00\u6807\u8bc6\u6570\u636e\u884c\u7684\u4fe1\u606f\u3002</p>\n<ul>\n<li>\u5bf9\u4e8e\u6709\u4e3b\u952e\u7684 InnoDB \u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a rowid \u5c31\u662f\u4e3b\u952e ID\uff1b</li>\n<li>\u5bf9\u4e8e\u6ca1\u6709\u4e3b\u952e\u7684 InnoDB \u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a rowid \u5c31\u662f\u7531\u7cfb\u7edf\u751f\u6210\u7684\uff1b</li>\n<li>MEMORY \u5f15\u64ce\u4e0d\u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u9762\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u5c31\u662f\u4e00\u4e2a\u6570\u7ec4\u3002\u56e0\u6b64\uff0c\u8fd9\u4e2a rowid \u5176\u5b9e\u5c31\u662f\u6570\u7ec4\u7684\u4e0b\u6807\u3002</li>\n</ul>\n<p>\u5230\u8fd9\u91cc\uff0c\u6211\u6765\u7a0d\u5fae\u5c0f\u7ed3\u4e00\u4e0b\uff1a<strong>order by rand() \u4f7f\u7528\u4e86\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u5185\u5b58\u4e34\u65f6\u8868\u6392\u5e8f\u7684\u65f6\u5019\u4f7f\u7528\u4e86 rowid \u6392\u5e8f\u65b9\u6cd5\u3002</strong></p>\n<h3 id=\"_18\">\u78c1\u76d8\u4e34\u65f6\u8868<a class=\"headerlink\" href=\"#_18\" title=\"Permanent link\">&para;</a></h3>\n<p>\u90a3\u4e48\uff0c\u662f\u4e0d\u662f\u6240\u6709\u7684\u4e34\u65f6\u8868\u90fd\u662f\u5185\u5b58\u8868\u5462\uff1f</p>\n<p>\u5176\u5b9e\u4e0d\u662f\u7684\u3002<code>tmp_table_size</code> \u8fd9\u4e2a\u914d\u7f6e\u9650\u5236\u4e86\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\uff0c\u9ed8\u8ba4\u503c\u662f 16M\u3002\u5982\u679c\u4e34\u65f6\u8868\u5927\u5c0f\u8d85\u8fc7\u4e86 <code>tmp_table_size</code>\uff0c\u90a3\u4e48\u5185\u5b58\u4e34\u65f6\u8868\u5c31\u4f1a\u8f6c\u6210\u78c1\u76d8\u4e34\u65f6\u8868\u3002</p>\n<p>\u78c1\u76d8\u4e34\u65f6\u8868\u4f7f\u7528\u7684\u5f15\u64ce\u9ed8\u8ba4\u662f InnoDB\uff0c\u662f\u7531\u53c2\u6570 <code>internal_tmp_disk_storage_engine</code> (MySQL 8.0 \u5df2\u6ca1\u6709\u6b64\u53c2\u6570\uff0c\u5f15\u5165\u4e86\u65b0\u7684\u4e34\u65f6\u8868\u5f15\u64ce <code>Temporary MyISAM</code> )\u63a7\u5236\u7684\u3002</p>\n<p>\u5f53\u4f7f\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u7684\u65f6\u5019\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u4e00\u4e2a\u6ca1\u6709\u663e\u5f0f\u7d22\u5f15\u7684 InnoDB \u8868\u7684\u6392\u5e8f\u8fc7\u7a0b\u3002</p>\n<p>\u4e3a\u4e86\u590d\u73b0\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6211\u628a <code>tmp_table_size</code> \u8bbe\u7f6e\u6210 1024\uff0c\u628a <code>sort_buffer_size</code> \u8bbe\u7f6e\u6210 32768, \u628a <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u6210 16\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">tmp_table_size</span><span class=\"o\">=</span><span class=\"mi\">1024</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">sort_buffer_size</span><span class=\"o\">=</span><span class=\"mi\">32768</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">max_length_for_sort_data</span><span class=\"o\">=</span><span class=\"mi\">16</span><span class=\"p\">;</span>\n<span class=\"cm\">/* \u6253\u5f00 optimizer_trace\uff0c\u53ea\u5bf9\u672c\u7ebf\u7a0b\u6709\u6548 */</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">optimizer_trace</span><span class=\"o\">=</span><span class=\"s1\">&#39;enabled=on&#39;</span><span class=\"p\">;</span><span class=\"w\">  </span>\n<span class=\"cm\">/* \u6267\u884c\u8bed\u53e5 */</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* \u67e5\u770b OPTIMIZER_TRACE \u8f93\u51fa */</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">information_schema</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">OPTIMIZER_TRACE</span><span class=\"o\">`</span><span class=\"err\">\\</span><span class=\"k\">G</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;filesort_priority_queue_optimization&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;limit&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;chosen&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n<span class=\"w\">   </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;filesort_execution&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[],</span>\n<span class=\"w\">    </span><span class=\"nt\">&quot;filesort_summary&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;memory_available&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">32768</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;key_size&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;row_size&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;max_rows_per_buffer&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;num_rows_estimate&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10010</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;num_rows_found&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;num_initial_chunks_spilled_to_disk&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;peak_memory_used&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">96</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;sort_algorithm&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;std::sort&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;unpacked_addon_fields&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;using_priority_queue&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nt\">&quot;sort_mode&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;&lt;fixed_sort_key, rowid&gt;&quot;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6b21 <code>OPTIMIZER_TRACE</code> \u7684\u7ed3\u679c\u3002</p>\n<p>\u56e0\u4e3a\u5c06 <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u6210 16\uff0c\u5c0f\u4e8e word \u5b57\u6bb5\u7684\u957f\u5ea6\u5b9a\u4e49\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u5230 <code>sort_mode</code> \u91cc\u9762\u663e\u793a\u7684\u662f rowid \u6392\u5e8f\uff0c\u8fd9\u4e2a\u662f\u7b26\u5408\u9884\u671f\u7684\uff0c\u53c2\u4e0e\u6392\u5e8f\u7684\u662f\u968f\u673a\u503c R \u5b57\u6bb5\u548c rowid \u5b57\u6bb5\u7ec4\u6210\u7684\u884c\u3002</p>\n<p>\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u5fc3\u7b97\u4e86\u4e00\u4e0b\uff0c\u53d1\u73b0\u4e0d\u5bf9\u3002R \u5b57\u6bb5\u5b58\u653e\u7684\u968f\u673a\u503c\u5c31 8 \u4e2a\u5b57\u8282\uff0crowid \u662f 6 \u4e2a\u5b57\u8282\uff0c\u6570\u636e\u603b\u884c\u6570\u662f 10000\uff0c\u8fd9\u6837\u7b97\u51fa\u6765\u5c31\u6709 140000 \u5b57\u8282\uff0c\u8d85\u8fc7\u4e86 <code>sort_buffer_size</code> \u5b9a\u4e49\u7684 32768 \u5b57\u8282\u4e86\u3002\u4f46\u662f\uff0c<code>number_of_tmp_files</code> \u7684\u503c\u5c45\u7136\u662f 0\uff0c\u96be\u9053\u4e0d\u9700\u8981\u7528\u4e34\u65f6\u6587\u4ef6\u5417\uff1f</p>\n<p>\u8fd9\u4e2a SQL \u8bed\u53e5\u7684\u6392\u5e8f\u786e\u5b9e\u6ca1\u6709\u7528\u5230\u4e34\u65f6\u6587\u4ef6\uff0c\u91c7\u7528\u662f MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684\u4e00\u4e2a\u65b0\u7684\u6392\u5e8f\u7b97\u6cd5\uff0c\u5373\uff1a\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u4e3a\u4ec0\u4e48\u6ca1\u6709\u4f7f\u7528\u4e34\u65f6\u6587\u4ef6\u7684\u7b97\u6cd5\uff0c\u4e5f\u5c31\u662f\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\uff0c\u800c\u662f\u91c7\u7528\u4e86\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u3002</p>\n<p>\u5176\u5b9e\uff0c\u6211\u4eec\u73b0\u5728\u7684 SQL \u8bed\u53e5\uff0c\u53ea\u9700\u8981\u53d6 R \u503c\u6700\u5c0f\u7684 3 \u4e2a rowid\u3002\u4f46\u662f\uff0c\u5982\u679c\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u7684\u8bdd\uff0c\u867d\u7136\u6700\u7ec8\u4e5f\u80fd\u5f97\u5230\u524d 3 \u4e2a\u503c\uff0c\u4f46\u662f\u8fd9\u4e2a\u7b97\u6cd5\u7ed3\u675f\u540e\uff0c\u5df2\u7ecf\u5c06 10000 \u884c\u6570\u636e\u90fd\u6392\u597d\u5e8f\u4e86\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u540e\u9762\u7684 9997 \u884c\u4e5f\u662f\u6709\u5e8f\u7684\u4e86\u3002\u4f46\uff0c\u6211\u4eec\u7684\u67e5\u8be2\u5e76\u4e0d\u9700\u8981\u8fd9\u4e9b\u6570\u636e\u662f\u6709\u5e8f\u7684\u3002\u6240\u4ee5\uff0c\u60f3\u4e00\u4e0b\u5c31\u660e\u767d\u4e86\uff0c\u8fd9\u6d6a\u8d39\u4e86\u975e\u5e38\u591a\u7684\u8ba1\u7b97\u91cf\u3002</p>\n<p>\u800c\u4f18\u5148\u961f\u5217\u7b97\u6cd5\uff0c\u5c31\u53ef\u4ee5\u7cbe\u786e\u5730\u53ea\u5f97\u5230\u4e09\u4e2a\u6700\u5c0f\u503c\uff0c\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e\u8fd9 10000 \u4e2a\u51c6\u5907\u6392\u5e8f\u7684 <code>(R,rowid)</code>\uff0c\u5148\u53d6\u524d\u4e09\u884c\uff0c\u6784\u9020\u6210\u4e00\u4e2a\u5806\uff1b\uff08\u5bf9\u6570\u636e\u7ed3\u6784\u5370\u8c61\u6a21\u7cca\u7684\u540c\u5b66\uff0c\u53ef\u4ee5\u5148\u8bbe\u60f3\u6210\u8fd9\u662f\u4e00\u4e2a\u7531\u4e09\u4e2a\u5143\u7d20\u7ec4\u6210\u7684\u6570\u7ec4\uff09</li>\n<li>\u53d6\u4e0b\u4e00\u4e2a\u884c <code>(R\u2019,rowid\u2019)</code>\uff0c\u8ddf\u5f53\u524d\u5806\u91cc\u9762\u6700\u5927\u7684 R \u6bd4\u8f83\uff0c\u5982\u679c R\u2019 \u5c0f\u4e8e R\uff0c\u628a\u8fd9\u4e2a <code>(R,rowid)</code> \u4ece\u5806\u4e2d\u53bb\u6389\uff0c\u6362\u6210 <code>(R\u2019,rowid\u2019)</code>\uff1b</li>\n<li>\u91cd\u590d\u7b2c 2 \u6b65\uff0c\u76f4\u5230\u7b2c 10000 \u4e2a <code>(R\u2019,rowid\u2019)</code> \u5b8c\u6210\u6bd4\u8f83\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u6211\u7b80\u5355\u753b\u4e86\u4e00\u4e2a\u4f18\u5148\u961f\u5217\u6392\u5e8f\u8fc7\u7a0b\u7684\u793a\u610f\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/e9c29cb20bf9668deba8981e444f6897.png\" /></p>\n<p>\u56fe 6 \u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u793a\u4f8b</p>\n<p>\u56fe 6 \u662f\u6a21\u62df 6 \u4e2a <code>(R,rowid)</code> \u884c\uff0c\u901a\u8fc7\u4f18\u5148\u961f\u5217\u6392\u5e8f\u627e\u5230\u6700\u5c0f\u7684\u4e09\u4e2a R \u503c\u7684\u884c\u7684\u8fc7\u7a0b\u3002\u6574\u4e2a\u6392\u5e8f\u8fc7\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u6700\u5feb\u5730\u62ff\u5230\u5f53\u524d\u5806\u7684\u6700\u5927\u503c\uff0c\u603b\u662f\u4fdd\u6301\u6700\u5927\u503c\u5728\u5806\u9876\uff0c\u56e0\u6b64\u8fd9\u662f\u4e00\u4e2a\u6700\u5927\u5806\u3002</p>\n<p>\u56fe 5 \u7684 <code>OPTIMIZER_TRACE</code> \u7ed3\u679c\u4e2d\uff0c<code>filesort_priority_queue_optimization</code> \u8fd9\u4e2a\u90e8\u5206\u7684 <code>chosen=true</code>\uff0c\u5c31\u8868\u793a\u4f7f\u7528\u4e86\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u4e34\u65f6\u6587\u4ef6\uff0c\u56e0\u6b64\u5bf9\u5e94\u7684 number_of_tmp_files \u662f 0\u3002</p>\n<p>\u8fd9\u4e2a\u6d41\u7a0b\u7ed3\u675f\u540e\uff0c\u6211\u4eec\u6784\u9020\u7684\u5806\u91cc\u9762\uff0c\u5c31\u662f\u8fd9\u4e2a 10000 \u884c\u91cc\u9762 R \u503c\u6700\u5c0f\u7684\u4e09\u884c\u3002\u7136\u540e\uff0c\u4f9d\u6b21\u628a\u5b83\u4eec\u7684 rowid \u53d6\u51fa\u6765\uff0c\u53bb\u4e34\u65f6\u8868\u91cc\u9762\u62ff\u5230 word \u5b57\u6bb5\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u8ddf\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684 rowid \u6392\u5e8f\u7684\u8fc7\u7a0b\u4e00\u6837\u4e86\u3002</p>\n<p>\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u4e0a\u9762\u4e00\u7bc7\u6587\u7ae0\u7684 SQL \u67e5\u8be2\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"p\">,</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s1\">&#39;\u676d\u5dde&#39;</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\">  </span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u8fd9\u91cc\u4e5f\u7528\u5230\u4e86 limit\uff0c\u4e3a\u4ec0\u4e48\u6ca1\u7528\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u5462\uff1f\u539f\u56e0\u662f\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u662f limit 1000\uff0c\u5982\u679c\u4f7f\u7528\u4f18\u5148\u961f\u5217\u7b97\u6cd5\u7684\u8bdd\uff0c\u9700\u8981\u7ef4\u62a4\u7684\u5806\u7684\u5927\u5c0f\u5c31\u662f 1000 \u884c\u7684 <code>(name,rowid)</code>\uff0c\u8d85\u8fc7\u4e86\u6211\u8bbe\u7f6e\u7684 <code>sort_buffer_size</code> \u5927\u5c0f\uff0c\u6240\u4ee5\u53ea\u80fd\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u3002</p>\n<p>\u603b\u4e4b\uff0c\u4e0d\u8bba\u662f\u4f7f\u7528\u54ea\u79cd\u7c7b\u578b\u7684\u4e34\u65f6\u8868\uff0c<code>order by rand()</code> \u8fd9\u79cd\u5199\u6cd5\u90fd\u4f1a\u8ba9\u8ba1\u7b97\u8fc7\u7a0b\u975e\u5e38\u590d\u6742\uff0c\u9700\u8981\u5927\u91cf\u7684\u626b\u63cf\u884c\u6570\uff0c\u56e0\u6b64\u6392\u5e8f\u8fc7\u7a0b\u7684\u8d44\u6e90\u6d88\u8017\u4e5f\u4f1a\u5f88\u5927\u3002</p>\n<p>\u518d\u56de\u5230\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u600e\u4e48\u6b63\u786e\u5730\u968f\u673a\u6392\u5e8f\u5462\uff1f</p>\n<h3 id=\"_19\">\u968f\u673a\u6392\u5e8f\u65b9\u6cd5<a class=\"headerlink\" href=\"#_19\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u5148\u628a\u95ee\u9898\u7b80\u5316\u4e00\u4e0b\uff0c\u5982\u679c\u53ea\u968f\u673a\u9009\u62e9 1 \u4e2a word \u503c\uff0c\u53ef\u4ee5\u600e\u4e48\u505a\u5462\uff1f\u601d\u8def\u4e0a\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u53d6\u5f97\u8fd9\u4e2a\u8868\u7684\u4e3b\u952e id \u7684\u6700\u5927\u503c M \u548c\u6700\u5c0f\u503c N;</li>\n<li>\u7528\u968f\u673a\u51fd\u6570\u751f\u6210\u4e00\u4e2a\u6700\u5927\u503c\u5230\u6700\u5c0f\u503c\u4e4b\u95f4\u7684\u6570 <span class=\"arithmatex\">\\(X = (M-N) * rand() + N\\)</span></li>\n<li>\u53d6\u4e0d\u5c0f\u4e8e X \u7684\u7b2c\u4e00\u4e2a ID \u7684\u884c\u3002</li>\n</ol>\n<p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u6682\u65f6\u79f0\u4f5c\u968f\u673a\u7b97\u6cd5 1\u3002\u8fd9\u91cc\uff0c\u6211\u76f4\u63a5\u7ed9\u4f60\u8d34\u4e00\u4e0b\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">max</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">),</span><span class=\"k\">min</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">M</span><span class=\"p\">,</span><span class=\"o\">@</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">X</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">((</span><span class=\"o\">@</span><span class=\"n\">M</span><span class=\"o\">-@</span><span class=\"n\">N</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"n\">rand</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">N</span><span class=\"p\">);</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u65b9\u6cd5\u6548\u7387\u5f88\u9ad8\uff0c\u56e0\u4e3a\u53d6 <code>max(id)</code> \u548c <code>min(id)</code> \u90fd\u662f\u4e0d\u9700\u8981\u626b\u63cf\u7d22\u5f15\u7684\uff0c\u800c\u7b2c\u4e09\u6b65\u7684 select \u4e5f\u53ef\u4ee5\u7528\u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u5c31\u53ea\u626b\u63cf\u4e86 3 \u884c\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u672c\u8eab\u5e76\u4e0d\u4e25\u683c\u6ee1\u8db3\u9898\u76ee\u7684\u968f\u673a\u8981\u6c42\uff0c\u56e0\u4e3a ID \u4e2d\u95f4\u53ef\u80fd\u6709\u7a7a\u6d1e\uff0c\u56e0\u6b64\u9009\u62e9\u4e0d\u540c\u884c\u7684\u6982\u7387\u4e0d\u4e00\u6837\uff0c\u4e0d\u662f\u771f\u6b63\u7684\u968f\u673a\u3002</p>\n<p>\u6bd4\u5982\u4f60\u6709 4 \u4e2a id\uff0c\u5206\u522b\u662f 1\u30012\u30014\u30015\uff0c\u5982\u679c\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\uff0c\u90a3\u4e48\u53d6\u5230 id=4 \u7684\u8fd9\u4e00\u884c\u7684\u6982\u7387\u662f\u53d6\u5f97\u5176\u4ed6\u884c\u6982\u7387\u7684\u4e24\u500d\u3002</p>\n<p>\u5982\u679c\u8fd9\u56db\u884c\u7684 id \u5206\u522b\u662f 1\u30012\u300140000\u300140001 \u5462\uff1f\u8fd9\u4e2a\u7b97\u6cd5\u57fa\u672c\u5c31\u80fd\u5f53 bug \u6765\u770b\u5f85\u4e86\u3002</p>\n<p>\u6240\u4ee5\uff0c\u4e3a\u4e86\u5f97\u5230\u4e25\u683c\u968f\u673a\u7684\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u8fd9\u4e2a\u6d41\u7a0b:</p>\n<ol>\n<li>\u53d6\u5f97\u6574\u4e2a\u8868\u7684\u884c\u6570\uff0c\u5e76\u8bb0\u4e3a C\u3002</li>\n<li>\u53d6\u5f97 <span class=\"arithmatex\">\\(Y = floor(C * rand())\\)</span>\u3002 floor \u51fd\u6570\u5728\u8fd9\u91cc\u7684\u4f5c\u7528\uff0c\u5c31\u662f\u53d6\u6574\u6570\u90e8\u5206\u3002</li>\n<li>\u518d\u7528 <code>limit Y,1</code> \u53d6\u5f97\u4e00\u884c\u3002</li>\n</ol>\n<p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u79f0\u4e3a\u968f\u673a\u7b97\u6cd5 2\u3002\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\uff0c\u5c31\u662f\u4e0a\u9762\u6d41\u7a0b\u7684\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">());</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"k\">sql</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">concat</span><span class=\"p\">(</span><span class=\"ss\">&quot;select * from t limit &quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">&quot;,1&quot;</span><span class=\"p\">);</span>\n<span class=\"k\">prepare</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"k\">sql</span><span class=\"p\">;</span>\n<span class=\"k\">execute</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"p\">;</span>\n<span class=\"k\">DEALLOCATE</span><span class=\"w\"> </span><span class=\"k\">prepare</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7531\u4e8e limit \u540e\u9762\u7684\u53c2\u6570\u4e0d\u80fd\u76f4\u63a5\u8ddf\u53d8\u91cf\uff0c\u6240\u4ee5\u6211\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 prepare+execute \u7684\u65b9\u6cd5\u3002\u4f60\u4e5f\u53ef\u4ee5\u628a\u62fc\u63a5 SQL \u8bed\u53e5\u7684\u65b9\u6cd5\u5199\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u4f1a\u66f4\u7b80\u5355\u4e9b\u3002</p>\n<p>\u8fd9\u4e2a\u968f\u673a\u7b97\u6cd5 2\uff0c\u89e3\u51b3\u4e86\u7b97\u6cd5 1 \u91cc\u9762\u660e\u663e\u7684\u6982\u7387\u4e0d\u5747\u5300\u95ee\u9898\u3002</p>\n<p>MySQL \u5904\u7406 limit Y,1 \u7684\u505a\u6cd5\u5c31\u662f\u6309\u987a\u5e8f\u4e00\u4e2a\u4e00\u4e2a\u5730\u8bfb\u51fa\u6765\uff0c\u4e22\u6389\u524d Y \u4e2a\uff0c\u7136\u540e\u628a\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u4f5c\u4e3a\u8fd4\u56de\u7ed3\u679c\uff0c\u56e0\u6b64\u8fd9\u4e00\u6b65\u9700\u8981\u626b\u63cf Y+1 \u884c\u3002\u518d\u52a0\u4e0a\uff0c\u7b2c\u4e00\u6b65\u626b\u63cf\u7684 C \u884c\uff0c\u603b\u5171\u9700\u8981\u626b\u63cf C+Y+1 \u884c\uff0c\u6267\u884c\u4ee3\u4ef7\u6bd4\u968f\u673a\u7b97\u6cd5 1 \u7684\u4ee3\u4ef7\u8981\u9ad8\u3002</p>\n<p>\u5f53\u7136\uff0c\u968f\u673a\u7b97\u6cd5 2 \u8ddf\u76f4\u63a5 <code>order by rand()</code> \u6bd4\u8d77\u6765\uff0c\u6267\u884c\u4ee3\u4ef7\u8fd8\u662f\u5c0f\u5f88\u591a\u7684\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u518d\u770b\u770b\uff0c\u5982\u679c\u6211\u4eec\u6309\u7167\u968f\u673a\u7b97\u6cd5 2 \u7684\u601d\u8def\uff0c\u8981\u968f\u673a\u53d6 3 \u4e2a word \u503c\u5462\uff1f\u4f60\u53ef\u4ee5\u8fd9\u4e48\u505a\uff1a</p>\n<ol>\n<li>\u53d6\u5f97\u6574\u4e2a\u8868\u7684\u884c\u6570\uff0c\u8bb0\u4e3a C\uff1b</li>\n<li>\u6839\u636e\u76f8\u540c\u7684\u968f\u673a\u65b9\u6cd5\u5f97\u5230 Y1\u3001Y2\u3001Y3\uff1b</li>\n<li>\u518d\u6267\u884c\u4e09\u4e2a limit Y, 1 \u8bed\u53e5\u5f97\u5230\u4e09\u884c\u6570\u636e\u3002</li>\n</ol>\n<p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u79f0\u4f5c\u968f\u673a\u7b97\u6cd5 3\u3002\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\uff0c\u5c31\u662f\u4e0a\u9762\u6d41\u7a0b\u7684\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">());</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">());</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"k\">C</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">());</span>\n<span class=\"c1\">-- \u5728\u5e94\u7528\u4ee3\u7801\u91cc\u9762\u53d6 Y1\u3001Y2\u3001Y3 \u503c\uff0c\u62fc\u51fa SQL \u540e\u6267\u884c</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y1</span><span class=\"err\">\uff0c</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y2</span><span class=\"err\">\uff0c</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">Y3</span><span class=\"err\">\uff0c</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_20\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_20\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u662f\u501f\u7740\u968f\u673a\u6392\u5e8f\u7684\u9700\u6c42\uff0c\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u5bf9\u4e34\u65f6\u8868\u6392\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p>\n<p>\u5982\u679c\u4f60\u76f4\u63a5\u4f7f\u7528 <code>order by rand()</code>\uff0c\u8fd9\u4e2a\u8bed\u53e5\u9700\u8981 Using temporary \u548c Using filesort\uff0c\u67e5\u8be2\u7684\u6267\u884c\u4ee3\u4ef7\u5f80\u5f80\u662f\u6bd4\u8f83\u5927\u7684\u3002\u6240\u4ee5\uff0c\u5728\u8bbe\u8ba1\u7684\u65f6\u5019\u4f60\u8981\u91cf\u907f\u5f00\u8fd9\u79cd\u5199\u6cd5\u3002</p>\n<p>\u4eca\u5929\u7684\u4f8b\u5b50\u91cc\u9762\uff0c\u6211\u4eec\u4e0d\u662f\u4ec5\u4ec5\u5728\u6570\u636e\u5e93\u5185\u90e8\u89e3\u51b3\u95ee\u9898\uff0c\u8fd8\u4f1a\u8ba9\u5e94\u7528\u4ee3\u7801\u914d\u5408\u62fc\u63a5 SQL \u8bed\u53e5\u3002\u5728\u5b9e\u9645\u5e94\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bd4\u8f83\u89c4\u8303\u7684\u7528\u6cd5\u5c31\u662f\uff1a\u5c3d\u91cf\u5c06\u4e1a\u52a1\u903b\u8f91\u5199\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\uff0c\u8ba9\u6570\u636e\u5e93\u53ea\u505a\u201c\u8bfb\u5199\u6570\u636e\u201d\u7684\u4e8b\u60c5\u3002\u56e0\u6b64\uff0c\u8fd9\u7c7b\u65b9\u6cd5\u7684\u5e94\u7528\u8fd8\u662f\u6bd4\u8f83\u5e7f\u6cdb\u7684\u3002</p>\n<h2 id=\"18-sql\">18 \u4e3a\u4ec0\u4e48\u8fd9\u4e9bSQL\u8bed\u53e5\u903b\u8f91\u76f8\u540c\uff0c\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\uff1f<a class=\"headerlink\" href=\"#18-sql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 MySQL \u4e2d\uff0c\u6709\u5f88\u591a\u770b\u4e0a\u53bb\u903b\u8f91\u76f8\u540c\uff0c\u4f46\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\u7684 SQL \u8bed\u53e5\u3002\u5bf9\u8fd9\u4e9b\u8bed\u53e5\u4f7f\u7528\u4e0d\u5f53\u7684\u8bdd\uff0c\u5c31\u4f1a\u4e0d\u7ecf\u610f\u95f4\u5bfc\u81f4\u6574\u4e2a\u6570\u636e\u5e93\u7684\u538b\u529b\u53d8\u5927\u3002</p>\n<p>\u6211\u4eca\u5929\u6311\u9009\u4e86\u4e09\u4e2a\u8fd9\u6837\u7684\u6848\u4f8b\u548c\u4f60\u5206\u4eab\u3002\u5e0c\u671b\u518d\u9047\u5230\u76f8\u4f3c\u7684\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u4ee5\u505a\u5230\u4e3e\u4e00\u53cd\u4e09\u3001\u5feb\u901f\u89e3\u51b3\u95ee\u9898\u3002</p>\n<h3 id=\"_21\">\u6848\u4f8b\u4e00\uff1a\u6761\u4ef6\u5b57\u6bb5\u51fd\u6570\u64cd\u4f5c<a class=\"headerlink\" href=\"#_21\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5047\u8bbe\u4f60\u73b0\u5728\u7ef4\u62a4\u4e86\u4e00\u4e2a\u4ea4\u6613\u7cfb\u7edf\uff0c\u5176\u4e2d\u4ea4\u6613\u8bb0\u5f55\u8868 tradelog \u5305\u542b\u4ea4\u6613\u6d41\u6c34\u53f7\uff08tradeid\uff09\u3001\u4ea4\u6613\u5458 id\uff08operator\uff09\u3001\u4ea4\u6613\u65f6\u95f4\uff08<code>t_modified</code>\uff09\u7b49\u5b57\u6bb5\u3002\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u4eec\u5148\u5ffd\u7565\u5176\u4ed6\u5b57\u6bb5\u3002\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">tradelog</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">operator</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">datetime</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"n\">CHARSET</span><span class=\"o\">=</span><span class=\"n\">utf8mb4</span><span class=\"p\">;</span>\n\n<span class=\"c1\">-- \u586b\u5145\u6570\u636e</span>\n<span class=\"k\">DELIMITER</span><span class=\"w\"> </span><span class=\"err\">$$</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">PROCEDURE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">populate_tradelog</span><span class=\"o\">`</span><span class=\"p\">()</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"w\">    </span><span class=\"k\">DECLARE</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">DECLARE</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"nb\">VARCHAR</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">DECLARE</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">DECLARE</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"n\">DATETIME</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">WHILE</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"k\">DO</span>\n<span class=\"w\">        </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CONCAT</span><span class=\"p\">(</span><span class=\"s1\">&#39;TRADEID-&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">FLOOR</span><span class=\"p\">(</span><span class=\"n\">RAND</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">DATE_ADD</span><span class=\"p\">(</span><span class=\"n\">NOW</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">INTERVAL</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">FLOOR</span><span class=\"p\">(</span><span class=\"n\">RAND</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">365</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DAY</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"k\">INTO</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"k\">VALUES</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">END</span><span class=\"w\"> </span><span class=\"n\">WHILE</span><span class=\"p\">;</span>\n<span class=\"k\">END</span><span class=\"err\">$$</span>\n\n<span class=\"k\">DELIMITER</span><span class=\"w\"> </span><span class=\"p\">;</span>\n\n<span class=\"c1\">-- populate</span>\n<span class=\"k\">CALL</span><span class=\"w\"> </span><span class=\"n\">populate_tradelog</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u5047\u8bbe\uff0c\u73b0\u5728\u5df2\u7ecf\u8bb0\u5f55\u4e86\u4ece 2016 \u5e74\u521d\u5230 2018 \u5e74\u5e95\u7684\u6240\u6709\u6570\u636e\uff0c\u8fd0\u8425\u90e8\u95e8\u6709\u4e00\u4e2a\u9700\u6c42\u662f\uff0c\u8981\u7edf\u8ba1\u53d1\u751f\u5728\u6240\u6709\u5e74\u4efd\u4e2d 7 \u6708\u4efd\u7684\u4ea4\u6613\u8bb0\u5f55\u603b\u6570\u3002\u8fd9\u4e2a\u903b\u8f91\u770b\u4e0a\u53bb\u5e76\u4e0d\u590d\u6742\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u53ef\u80fd\u4f1a\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">month</span><span class=\"p\">(</span><span class=\"n\">t_modified</span><span class=\"p\">)</span><span class=\"o\">=</span><span class=\"mi\">7</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7531\u4e8e <code>t_modified</code> \u5b57\u6bb5\u4e0a\u6709\u7d22\u5f15\uff0c\u4e8e\u662f\u4f60\u5c31\u5f88\u653e\u5fc3\u5730\u5728\u751f\u4ea7\u5e93\u4e2d\u6267\u884c\u4e86\u8fd9\u6761\u8bed\u53e5\uff0c\u4f46\u5374\u53d1\u73b0\u6267\u884c\u4e86\u7279\u522b\u4e45\uff0c\u624d\u8fd4\u56de\u4e86\u7ed3\u679c\u3002</p>\n<p>\u5982\u679c\u4f60\u95ee DBA \u540c\u4e8b\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u4ed6\u5927\u6982\u4f1a\u544a\u8bc9\u4f60\uff1a\u5982\u679c\u5bf9\u5b57\u6bb5\u505a\u4e86\u51fd\u6570\u8ba1\u7b97\uff0c\u5c31\u7528\u4e0d\u4e0a\u7d22\u5f15\u4e86\uff0c\u8fd9\u662f MySQL \u7684\u89c4\u5b9a\u3002</p>\n<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u5b66\u8fc7\u4e86 InnoDB \u7684\u7d22\u5f15\u7ed3\u6784\u4e86\uff0c\u53ef\u4ee5\u518d\u8ffd\u95ee\u4e00\u53e5\u4e3a\u4ec0\u4e48\uff1f\u4e3a\u4ec0\u4e48\u6761\u4ef6\u662f <code>where t_modified='2018-7-1\u2019</code> \u7684\u65f6\u5019\u53ef\u4ee5\u7528\u4e0a\u7d22\u5f15\uff0c\u800c\u6539\u6210 <code>where month(t_modified)=7</code> \u7684\u65f6\u5019\u5c31\u4e0d\u884c\u4e86\uff1f</p>\n<p>\u4e0b\u9762\u662f\u8fd9\u4e2a <code>t_modified</code> \u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002\u65b9\u6846\u4e0a\u9762\u7684\u6570\u5b57\u5c31\u662f <code>month()</code> \u51fd\u6570\u5bf9\u5e94\u7684\u503c\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/3e30d9a5e67f711f5af2e2599e800286.png\" /></p>\n<p>\u56fe 1 t_modified \u7d22\u5f15\u793a\u610f\u56fe</p>\n<p>\u5982\u679c\u4f60\u7684 SQL \u8bed\u53e5\u6761\u4ef6\u7528\u7684\u662f <code>where t_modified='2018-7-1'</code>\u7684\u8bdd\uff0c\u5f15\u64ce\u5c31\u4f1a\u6309\u7167\u4e0a\u9762\u7eff\u8272\u7bad\u5934\u7684\u8def\u7ebf\uff0c\u5feb\u901f\u5b9a\u4f4d\u5230 <code>t_modified='2018-7-1'</code>\u9700\u8981\u7684\u7ed3\u679c\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0cB+ \u6811\u63d0\u4f9b\u7684\u8fd9\u4e2a\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\uff0c\u6765\u6e90\u4e8e\u540c\u4e00\u5c42\u5144\u5f1f\u8282\u70b9\u7684\u6709\u5e8f\u6027\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u8ba1\u7b97 <code>month()</code> \u51fd\u6570\u7684\u8bdd\uff0c\u4f60\u4f1a\u770b\u5230\u4f20\u5165 7 \u7684\u65f6\u5019\uff0c\u5728\u6811\u7684\u7b2c\u4e00\u5c42\u5c31\u4e0d\u77e5\u9053\u8be5\u600e\u4e48\u529e\u4e86\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<strong>\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u7d22\u5f15\u503c\u7684\u6709\u5e8f\u6027\uff0c\u56e0\u6b64\u4f18\u5316\u5668\u5c31\u51b3\u5b9a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</strong></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4f18\u5316\u5668\u5e76\u4e0d\u662f\u8981\u653e\u5f03\u4f7f\u7528\u8fd9\u4e2a\u7d22\u5f15\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u653e\u5f03\u4e86\u6811\u641c\u7d22\u529f\u80fd\uff0c\u4f18\u5316\u5668\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u4e3b\u952e\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u7d22\u5f15 <code>t_modified</code>\uff0c\u4f18\u5316\u5668\u5bf9\u6bd4\u7d22\u5f15\u5927\u5c0f\u540e\u53d1\u73b0\uff0c\u7d22\u5f15 <code>t_modified</code> \u66f4\u5c0f\uff0c\u904d\u5386\u8fd9\u4e2a\u7d22\u5f15\u6bd4\u904d\u5386\u4e3b\u952e\u7d22\u5f15\u6765\u5f97\u66f4\u5feb\u3002\u56e0\u6b64\u6700\u7ec8\u8fd8\u662f\u4f1a\u9009\u62e9\u7d22\u5f15 <code>t_modified</code>\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4f7f\u7528 explain \u547d\u4ee4\uff0c\u67e5\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">month</span><span class=\"p\">(</span><span class=\"n\">t_modified</span><span class=\"p\">)</span><span class=\"o\">=</span><span class=\"mi\">7</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"mi\">100335</span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+</span>\n</code></pre></div>\n<p><code>key=\"t_modified\"</code> \u8868\u793a\u7684\u662f\uff0c\u4f7f\u7528\u4e86 <code>t_modified</code> \u8fd9\u4e2a\u7d22\u5f15\uff1b\u6211\u5728\u6d4b\u8bd5\u8868\u6570\u636e\u4e2d\u63d2\u5165\u4e86 10 \u4e07\u884c\u6570\u636e\uff0c<code>rows=100335</code>\uff0c\u8bf4\u660e\u8fd9\u6761\u8bed\u53e5\u626b\u63cf\u4e86\u6574\u4e2a\u7d22\u5f15\u7684\u6240\u6709\u503c\uff1bExtra \u5b57\u6bb5\u7684 Using index\uff0c\u8868\u793a\u7684\u662f\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u7531\u4e8e\u5728 <code>t_modified</code> \u5b57\u6bb5\u52a0\u4e86 <code>month()</code> \u51fd\u6570\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e86\u5168\u7d22\u5f15\u626b\u63cf\u3002\u4e3a\u4e86\u80fd\u591f\u7528\u4e0a\u7d22\u5f15\u7684\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\uff0c\u6211\u4eec\u5c31\u8981\u628a SQL \u8bed\u53e5\u6539\u6210\u57fa\u4e8e\u5b57\u6bb5\u672c\u8eab\u7684\u8303\u56f4\u67e5\u8be2\u3002\u6309\u7167\u4e0b\u9762\u8fd9\u4e2a\u5199\u6cd5\uff0c\u4f18\u5316\u5668\u5c31\u80fd\u6309\u7167\u6211\u4eec\u9884\u671f\u7684\uff0c\u7528\u4e0a <code>t_modified</code> \u7d22\u5f15\u7684\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"s1\">&#39;2016-7-1&#39;</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">&lt;</span><span class=\"s1\">&#39;2016-8-1&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">or</span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"s1\">&#39;2017-7-1&#39;</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">&lt;</span><span class=\"s1\">&#39;2017-8-1&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">or</span><span class=\"w\"> </span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"s1\">&#39;2018-7-1&#39;</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">&lt;</span><span class=\"s1\">&#39;2018-8-1&#39;</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5f53\u7136\uff0c\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u4e0a\u7ebf\u65f6\u95f4\u66f4\u65e9\uff0c\u6216\u8005\u540e\u9762\u53c8\u63d2\u5165\u4e86\u4e4b\u540e\u5e74\u4efd\u7684\u6570\u636e\u7684\u8bdd\uff0c\u4f60\u5c31\u9700\u8981\u518d\u628a\u5176\u4ed6\u5e74\u4efd\u8865\u9f50\u3002</p>\n<p>\u5230\u8fd9\u91cc\u6211\u7ed9\u4f60\u8bf4\u660e\u4e86\uff0c\u7531\u4e8e\u52a0\u4e86 <code>month()</code> \u51fd\u6570\u64cd\u4f5c\uff0cMySQL \u65e0\u6cd5\u518d\u4f7f\u7528\u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\u529f\u80fd\uff0c\u800c\u53ea\u80fd\u4f7f\u7528\u5168\u7d22\u5f15\u626b\u63cf\u3002</p>\n<p>\u4e0d\u8fc7\u4f18\u5316\u5668\u5728\u4e2a\u95ee\u9898\u4e0a\u786e\u5b9e\u6709\u201c\u5077\u61d2\u201d\u884c\u4e3a\uff0c\u5373\u4f7f\u662f\u5bf9\u4e8e\u4e0d\u6539\u53d8\u6709\u5e8f\u6027\u7684\u51fd\u6570\uff0c\u4e5f\u4e0d\u4f1a\u8003\u8651\u4f7f\u7528\u7d22\u5f15\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e <code>select * from tradelog where id + 1 = 10000</code> \u8fd9\u4e2a SQL \u8bed\u53e5\uff0c\u8fd9\u4e2a\u52a0 1 \u64cd\u4f5c\u5e76\u4e0d\u4f1a\u6539\u53d8\u6709\u5e8f\u6027\uff0c\u4f46\u662f MySQL \u4f18\u5316\u5668\u8fd8\u662f\u4e0d\u80fd\u7528 id \u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\u5230 9999 \u8fd9\u4e00\u884c\u3002\u6240\u4ee5\uff0c\u9700\u8981\u4f60\u5728\u5199 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u624b\u52a8\u6539\u5199\u6210 <code>where id = 10000 -1</code> \u624d\u53ef\u4ee5\u3002</p>\n<h3 id=\"_22\">\u6848\u4f8b\u4e8c\uff1a\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362<a class=\"headerlink\" href=\"#_22\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u6211\u518d\u8ddf\u4f60\u8bf4\u4e00\u8bf4\uff0c\u53e6\u4e00\u4e2a\u7ecf\u5e38\u8ba9\u7a0b\u5e8f\u5458\u6389\u5751\u91cc\u7684\u4f8b\u5b50\u3002</p>\n<p>\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"mi\">110717</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4ea4\u6613\u7f16\u53f7 tradeid \u8fd9\u4e2a\u5b57\u6bb5\u4e0a\uff0c\u672c\u6765\u5c31\u6709\u7d22\u5f15\uff0c\u4f46\u662f explain \u7684\u7ed3\u679c\u5374\u663e\u793a\uff0c\u8fd9\u6761\u8bed\u53e5\u9700\u8981\u8d70\u5168\u8868\u626b\u63cf\u3002\u4f60\u53ef\u80fd\u4e5f\u53d1\u73b0\u4e86\uff0ctradeid \u7684\u5b57\u6bb5\u7c7b\u578b\u662f <code>varchar(32)</code>\uff0c\u800c\u8f93\u5165\u7684\u53c2\u6570\u5374\u662f\u6574\u578b\uff0c\u6240\u4ee5\u9700\u8981\u505a\u7c7b\u578b\u8f6c\u6362\u3002</p>\n<p>\u90a3\u4e48\uff0c\u73b0\u5728\u8fd9\u91cc\u5c31\u6709\u4e24\u4e2a\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u6570\u636e\u7c7b\u578b\u8f6c\u6362\u7684\u89c4\u5219\u662f\u4ec0\u4e48\uff1f</li>\n<li>\u4e3a\u4ec0\u4e48\u6709\u6570\u636e\u7c7b\u578b\u8f6c\u6362\uff0c\u5c31\u9700\u8981\u8d70\u5168\u7d22\u5f15\u626b\u63cf\uff1f</li>\n</ol>\n<p>\u5148\u6765\u770b\u7b2c\u4e00\u4e2a\u95ee\u9898\uff0c\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u6570\u636e\u5e93\u91cc\u9762\u7c7b\u578b\u8fd9\u4e48\u591a\uff0c\u8fd9\u79cd\u6570\u636e\u7c7b\u578b\u8f6c\u6362\u89c4\u5219\u66f4\u591a\uff0c\u6211\u8bb0\u4e0d\u4f4f\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u770b <code>select '10' &gt; 9</code> \u7684\u7ed3\u679c\uff1a</p>\n<ol>\n<li>\u5982\u679c\u89c4\u5219\u662f\u201c\u5c06\u5b57\u7b26\u4e32\u8f6c\u6210\u6570\u5b57\u201d\uff0c\u90a3\u4e48\u5c31\u662f\u505a\u6570\u5b57\u6bd4\u8f83\uff0c\u7ed3\u679c\u5e94\u8be5\u662f 1\uff1b</li>\n<li>\u5982\u679c\u89c4\u5219\u662f\u201c\u5c06\u6570\u5b57\u8f6c\u6210\u5b57\u7b26\u4e32\u201d\uff0c\u90a3\u4e48\u5c31\u662f\u505a\u5b57\u7b26\u4e32\u6bd4\u8f83\uff0c\u7ed3\u679c\u5e94\u8be5\u662f 0\u3002</li>\n</ol>\n<p>\u9a8c\u8bc1\u7ed3\u679c\u5982\u4e0b\u6240\u793a\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"s1\">&#39;10&#39;</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"s1\">&#39;10&#39;</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----------+</span>\n<span class=\"o\">|</span><span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u4ece\u56fe\u4e2d\u53ef\u77e5\uff0c<code>select '10' &gt; 9</code> \u8fd4\u56de\u7684\u662f 1\uff0c\u6240\u4ee5\u4f60\u5c31\u80fd\u786e\u8ba4 MySQL \u91cc\u7684\u8f6c\u6362\u89c4\u5219\u4e86\uff1a\u5728 MySQL \u4e2d\uff0c\u5b57\u7b26\u4e32\u548c\u6570\u5b57\u505a\u6bd4\u8f83\u7684\u8bdd\uff0c\u662f\u5c06\u5b57\u7b26\u4e32\u8f6c\u6362\u6210\u6570\u5b57\u3002</p>\n<p>\u8fd9\u65f6\uff0c\u4f60\u518d\u770b\u8fd9\u4e2a\u5168\u8868\u626b\u63cf\u7684\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"mi\">110717</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5c31\u77e5\u9053\u5bf9\u4e8e\u4f18\u5316\u5668\u6765\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u76f8\u5f53\u4e8e\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\">  </span><span class=\"k\">CAST</span><span class=\"p\">(</span><span class=\"n\">tradid</span><span class=\"w\"> </span><span class=\"k\">AS</span><span class=\"w\"> </span><span class=\"n\">signed</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">110717</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8bed\u53e5\u89e6\u53d1\u4e86\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u89c4\u5219\uff1a\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u4f18\u5316\u5668\u4f1a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u7559\u7ed9\u4f60\u4e00\u4e2a\u5c0f\u95ee\u9898\uff0cid \u7684\u7c7b\u578b\u662f int\uff0c\u5982\u679c\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u662f\u5426\u4f1a\u5bfc\u81f4\u5168\u8868\u626b\u63cf\u5462\uff1f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"s1\">&#39;83126&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u4ee5\u5148\u81ea\u5df1\u5206\u6790\u4e00\u4e0b\uff0c\u518d\u5230\u6570\u636e\u5e93\u91cc\u9762\u53bb\u9a8c\u8bc1\u786e\u8ba4\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u7a0d\u5fae\u590d\u6742\u70b9\u7684\u4f8b\u5b50\u3002</p>\n<h3 id=\"_23\">\u6848\u4f8b\u4e09\uff1a\u9690\u5f0f\u5b57\u7b26\u7f16\u7801\u8f6c\u6362<a class=\"headerlink\" href=\"#_23\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5047\u8bbe\u7cfb\u7edf\u91cc\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u8868 <code>trade_detail</code>\uff0c\u7528\u4e8e\u8bb0\u5f55\u4ea4\u6613\u7684\u64cd\u4f5c\u7ec6\u8282\u3002\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\u548c\u590d\u73b0\uff0c\u6211\u5f80\u4ea4\u6613\u65e5\u5fd7\u8868 tradelog \u548c\u4ea4\u6613\u8be6\u60c5\u8868 <code>trade_detail</code> \u8fd9\u4e24\u4e2a\u8868\u91cc\u63d2\u5165\u4e00\u4e9b\u6570\u636e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">trade_detail</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">trade_step</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"cm\">/* \u64cd\u4f5c\u6b65\u9aa4 */</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">step_info</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"cm\">/* \u6b65\u9aa4\u4fe1\u606f */</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">tradeid</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"n\">CHARSET</span><span class=\"o\">=</span><span class=\"n\">utf8</span><span class=\"p\">;</span><span class=\"w\"> </span>\n\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;update&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;update&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;update again&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-3&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-3&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;update&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-3&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;update again&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;TRADEID-3&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u8981\u67e5\u8be2 <code>id=2</code> \u7684\u4ea4\u6613\u7684\u6240\u6709\u64cd\u4f5c\u6b65\u9aa4\u4fe1\u606f\uff0cSQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* \u8bed\u53e5 Q1*/</span>\n</code></pre></div>\n<p>explain \u7ed3\u679c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* \u8bed\u53e5 Q1*/</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"p\">,</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">        </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+</span>\n</code></pre></div>\n<p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u7ed3\u679c\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u884c\u663e\u793a\u4f18\u5316\u5668\u4f1a\u5148\u5728\u4ea4\u6613\u8bb0\u5f55\u8868 tradelog \u4e0a\u67e5\u5230 id=2 \u7684\u884c\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u7528\u4e0a\u4e86\u4e3b\u952e\u7d22\u5f15\uff0crows=1 \u8868\u793a\u53ea\u626b\u63cf\u4e00\u884c\uff1b</li>\n<li>\u7b2c\u4e8c\u884c <code>key=NULL</code>\uff0c\u8868\u793a\u6ca1\u6709\u7528\u4e0a\u4ea4\u6613\u8be6\u60c5\u8868 <code>trade_detail</code> \u4e0a\u7684 tradeid \u7d22\u5f15\uff0c\u8fdb\u884c\u4e86\u5168\u8868\u626b\u63cf\u3002</li>\n</ol>\n<p>\u5728\u8fd9\u4e2a\u6267\u884c\u8ba1\u5212\u91cc\uff0c\u662f\u4ece tradelog \u8868\u4e2d\u53d6 tradeid \u5b57\u6bb5\uff0c\u518d\u53bb <code>trade_detail</code> \u8868\u91cc\u67e5\u8be2\u5339\u914d\u5b57\u6bb5\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u628a tradelog \u79f0\u4e3a\u9a71\u52a8\u8868\uff0c\u628a <code>trade_detail</code> \u79f0\u4e3a\u88ab\u9a71\u52a8\u8868\uff0c\u628a tradeid \u79f0\u4e3a\u5173\u8054\u5b57\u6bb5\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u770b\u4e0b\u8fd9\u4e2a explain \u7ed3\u679c\u8868\u793a\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/8289c184c8529acea0269a7460dc62a9.png\" /></p>\n<p>\u56fe 5 \u8bed\u53e5 Q1 \u7684\u6267\u884c\u8fc7\u7a0b</p>\n<p>\u56fe\u4e2d\uff1a</p>\n<ul>\n<li>\u7b2c 1 \u6b65\uff0c\u662f\u6839\u636e id \u5728 tradelog \u8868\u91cc\u627e\u5230 L2 \u8fd9\u4e00\u884c\uff1b</li>\n<li>\u7b2c 2 \u6b65\uff0c\u662f\u4ece L2 \u4e2d\u53d6\u51fa tradeid \u5b57\u6bb5\u7684\u503c\uff1b</li>\n<li>\u7b2c 3 \u6b65\uff0c\u662f\u6839\u636e tradeid \u503c\u5230 <code>trade_detail</code> \u8868\u4e2d\u67e5\u627e\u6761\u4ef6\u5339\u914d\u7684\u884c\u3002explain \u7684\u7ed3\u679c\u91cc\u9762\u7b2c\u4e8c\u884c\u7684 <code>key=NULL</code> \u8868\u793a\u7684\u5c31\u662f\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u901a\u8fc7\u904d\u5386\u4e3b\u952e\u7d22\u5f15\u7684\u65b9\u5f0f\uff0c\u4e00\u4e2a\u4e00\u4e2a\u5730\u5224\u65ad tradeid \u7684\u503c\u662f\u5426\u5339\u914d\u3002</li>\n</ul>\n<p>\u8fdb\u884c\u5230\u8fd9\u91cc\uff0c\u4f60\u4f1a\u53d1\u73b0\u7b2c 3 \u6b65\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u3002\u56e0\u4e3a\u8868 <code>trade_detail</code> \u91cc tradeid \u5b57\u6bb5\u4e0a\u662f\u6709\u7d22\u5f15\u7684\uff0c\u6211\u4eec\u672c\u6765\u662f\u5e0c\u671b\u901a\u8fc7\u4f7f\u7528 tradeid \u7d22\u5f15\u80fd\u591f\u5feb\u901f\u5b9a\u4f4d\u5230\u7b49\u503c\u7684\u884c\u3002\u4f46\u8fd9\u91cc\u5e76\u6ca1\u6709\u3002</p>\n<p>\u5982\u679c\u4f60\u53bb\u95ee DBA \u540c\u5b66\uff0c\u4ed6\u4eec\u53ef\u80fd\u4f1a\u544a\u8bc9\u4f60\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u8868\u7684\u5b57\u7b26\u96c6\u4e0d\u540c\uff0c\u4e00\u4e2a\u662f utf8\uff0c\u4e00\u4e2a\u662f utf8mb4\uff0c\u6240\u4ee5\u505a\u8868\u8fde\u63a5\u67e5\u8be2\u7684\u65f6\u5019\u7528\u4e0d\u4e0a\u5173\u8054\u5b57\u6bb5\u7684\u7d22\u5f15\u3002\u8fd9\u4e2a\u56de\u7b54\uff0c\u4e5f\u662f\u901a\u5e38\u4f60\u641c\u7d22\u8fd9\u4e2a\u95ee\u9898\u65f6\u4f1a\u5f97\u5230\u7684\u7b54\u6848\u3002</p>\n<p>\u4f46\u662f\u4f60\u5e94\u8be5\u518d\u8ffd\u95ee\u4e00\u4e0b\uff0c\u4e3a\u4ec0\u4e48\u5b57\u7b26\u96c6\u4e0d\u540c\u5c31\u7528\u4e0d\u4e0a\u7d22\u5f15\u5462\uff1f</p>\n<p>\u6211\u4eec\u8bf4\u95ee\u9898\u662f\u51fa\u5728\u6267\u884c\u6b65\u9aa4\u7684\u7b2c 3 \u6b65\uff0c\u5982\u679c\u5355\u72ec\u628a\u8fd9\u4e00\u6b65\u6539\u6210 SQL \u8bed\u53e5\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">L2</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff0c<code>$L2.tradeid.value</code> \u7684\u5b57\u7b26\u96c6\u662f <code>utf8mb4</code>\u3002</p>\n<p>\u53c2\u7167\u524d\u9762\u7684\u4e24\u4e2a\u4f8b\u5b50\uff0c\u4f60\u80af\u5b9a\u5c31\u60f3\u5230\u4e86\uff0c\u5b57\u7b26\u96c6 <code>utf8mb4</code> \u662f utf8 \u7684\u8d85\u96c6\uff0c\u6240\u4ee5\u5f53\u8fd9\u4e24\u4e2a\u7c7b\u578b\u7684\u5b57\u7b26\u4e32\u5728\u505a\u6bd4\u8f83\u7684\u65f6\u5019\uff0cMySQL \u5185\u90e8\u7684\u64cd\u4f5c\u662f\uff0c\u5148\u628a utf8 \u5b57\u7b26\u4e32\u8f6c\u6210 utf8mb4 \u5b57\u7b26\u96c6\uff0c\u518d\u505a\u6bd4\u8f83\u3002</p>\n<p>\u56e0\u6b64\uff0c \u5728\u6267\u884c\u4e0a\u9762\u8fd9\u4e2a\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u9700\u8981\u5c06\u88ab\u9a71\u52a8\u6570\u636e\u8868\u91cc\u7684\u5b57\u6bb5\u4e00\u4e2a\u4e2a\u5730\u8f6c\u6362\u6210 <code>utf8mb4</code>\uff0c\u518d\u8ddf L2 \u505a\u6bd4\u8f83\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u8bed\u53e5\u7b49\u540c\u4e8e\u4e0b\u9762\u8fd9\u4e2a\u5199\u6cd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">CONVERT</span><span class=\"p\">(</span><span class=\"n\">traideid</span><span class=\"w\"> </span><span class=\"k\">USING</span><span class=\"w\"> </span><span class=\"n\">utf8mb4</span><span class=\"p\">)</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">L2</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>CONVERT() \u51fd\u6570\uff0c\u5728\u8fd9\u91cc\u7684\u610f\u601d\u662f\u628a\u8f93\u5165\u7684\u5b57\u7b26\u4e32\u8f6c\u6210 utf8mb4 \u5b57\u7b26\u96c6\u3002</p>\n<p>\u8fd9\u5c31\u518d\u6b21\u89e6\u53d1\u4e86\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u539f\u5219\uff1a\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u4f18\u5316\u5668\u4f1a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u4f60\u7ec8\u4e8e\u660e\u786e\u4e86\uff0c\u5b57\u7b26\u96c6\u4e0d\u540c\u53ea\u662f\u6761\u4ef6\u4e4b\u4e00\uff0c<strong>\u8fde\u63a5\u8fc7\u7a0b\u4e2d\u8981\u6c42\u5728\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u5b57\u6bb5\u4e0a\u52a0\u51fd\u6570\u64cd\u4f5c</strong>\uff0c\u662f\u76f4\u63a5\u5bfc\u81f4\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u5168\u8868\u626b\u63cf\u7684\u539f\u56e0\u3002</p>\n<p>\u4f5c\u4e3a\u5bf9\u6bd4\u9a8c\u8bc1\uff0c\u6211\u7ed9\u4f60\u63d0\u53e6\u5916\u4e00\u4e2a\u9700\u6c42\uff0c\u201c\u67e5\u627e trade_detail \u8868\u91cc id=4 \u7684\u64cd\u4f5c\uff0c\u5bf9\u5e94\u7684\u64cd\u4f5c\u8005\u662f\u8c01\u201d\uff0c\u518d\u6765\u770b\u4e0b\u8fd9\u4e2a\u8bed\u53e5\u548c\u5b83\u7684\u6267\u884c\u8ba1\u5212\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>explain \u7ed3\u679c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">131</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u91cc <code>trade_detail</code> \u8868\u6210\u4e86\u9a71\u52a8\u8868\uff0c\u4f46\u662f explain \u7ed3\u679c\u7684\u7b2c\u4e8c\u884c\u663e\u793a\uff0c\u8fd9\u6b21\u7684\u67e5\u8be2\u64cd\u4f5c\u7528\u4e0a\u4e86\u88ab\u9a71\u52a8\u8868 tradelog \u91cc\u7684\u7d22\u5f15 (tradeid)\uff0c\u626b\u63cf\u884c\u6570\u662f 1\u3002</p>\n<p>\u8fd9\u4e5f\u662f\u4e24\u4e2a tradeid \u5b57\u6bb5\u7684 join \u64cd\u4f5c\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u6b21\u80fd\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684 tradeid \u7d22\u5f15\u5462\uff1f\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u3002</p>\n<p>\u5047\u8bbe\u9a71\u52a8\u8868 trade_detail \u91cc id=4 \u7684\u884c\u8bb0\u4e3a R4\uff0c\u90a3\u4e48\u5728\u8fde\u63a5\u7684\u65f6\u5019\uff08\u56fe 5 \u7684\u7b2c 3 \u6b65\uff09\uff0c\u88ab\u9a71\u52a8\u8868 tradelog \u4e0a\u6267\u884c\u7684\u5c31\u662f\u7c7b\u4f3c\u8fd9\u6837\u7684 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">traideid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">R4</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019 $R4.tradeid.value \u7684\u5b57\u7b26\u96c6\u662f utf8, \u6309\u7167\u5b57\u7b26\u96c6\u8f6c\u6362\u89c4\u5219\uff0c\u8981\u8f6c\u6210 utf8mb4\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u88ab\u6539\u5199\u6210\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">operator</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">traideid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"k\">CONVERT</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">R4</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"k\">USING</span><span class=\"w\"> </span><span class=\"n\">utf8mb4</span><span class=\"p\">);</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u4f60\u770b\uff0c\u8fd9\u91cc\u7684 CONVERT \u51fd\u6570\u662f\u52a0\u5728\u8f93\u5165\u53c2\u6570\u4e0a\u7684\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684 traideid \u7d22\u5f15\u3002</p>\n<p>\u7406\u89e3\u4e86\u539f\u7406\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u7528\u6765\u6307\u5bfc\u64cd\u4f5c\u4e86\u3002\u5982\u679c\u8981\u4f18\u5316\u8bed\u53e5</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p>\n<ul>\n<li>\n<p>\u6bd4\u8f83\u5e38\u89c1\u7684\u4f18\u5316\u65b9\u6cd5\u662f\uff0c\u628a <code>trade_detail</code> \u8868\u4e0a\u7684 tradeid \u5b57\u6bb5\u7684\u5b57\u7b26\u96c6\u4e5f\u6539\u6210 utf8mb4\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u5b57\u7b26\u96c6\u8f6c\u6362\u7684\u95ee\u9898\u4e86\u3002</p>\n<p><code>alter table trade_detail modify tradeid varchar(32) CHARACTER SET utf8mb4 default null;</code></p>\n</li>\n<li>\n<p>\u5982\u679c\u80fd\u591f\u4fee\u6539\u5b57\u6bb5\u7684\u5b57\u7b26\u96c6\u7684\u8bdd\uff0c\u662f\u6700\u597d\u4e0d\u8fc7\u4e86\u3002\u4f46\u5982\u679c\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c \u6216\u8005\u4e1a\u52a1\u4e0a\u6682\u65f6\u4e0d\u80fd\u505a\u8fd9\u4e2a DDL \u7684\u8bdd\uff0c\u90a3\u5c31\u53ea\u80fd\u91c7\u7528\u4fee\u6539 SQL \u8bed\u53e5\u7684\u65b9\u6cd5\u4e86\u3002</p>\n<p><code>mysql&gt; select d.* from tradelog l , trade_detail d where d.tradeid=CONVERT(l.tradeid USING utf8) and l.id=2;</code></p>\n</li>\n</ul>\n<p>SQL \u8bed\u53e5\u4f18\u5316\u540e\u7684 explain \u7ed3\u679c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">tradelog</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trade_detail</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"o\">=</span><span class=\"k\">CONVERT</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"k\">USING</span><span class=\"w\"> </span><span class=\"n\">utf8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">tradeid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\uff0c\u6211\u4e3b\u52a8\u628a l.tradeid \u8f6c\u6210 utf8\uff0c\u5c31\u907f\u514d\u4e86\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u5b57\u7b26\u7f16\u7801\u8f6c\u6362\uff0c\u4ece explain \u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6b21\u7d22\u5f15\u8d70\u5bf9\u4e86\u3002</p>\n<h3 id=\"_24\">\u6848\u4f8b\u56db\uff1a\u8d85\u8fc7\u5b57\u6bb5\u957f\u5ea6\u67e5\u8be2<a class=\"headerlink\" href=\"#_24\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">table_a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">varchar</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5047\u8bbe\u73b0\u5728\u8868\u91cc\u9762\uff0c\u6709 100 \u4e07\u884c\u6570\u636e\uff0c\u5176\u4e2d\u6709 10 \u4e07\u884c\u6570\u636e\u7684 b \u7684\u503c\u662f\u20191234567890\u2019\uff0c \u5047\u8bbe\u73b0\u5728\u6267\u884c\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684:</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">table_a</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"s1\">&#39;1234567890abcd&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\uff0cMySQL \u4f1a\u600e\u4e48\u6267\u884c\u5462\uff1f</p>\n<p>\u6700\u7406\u60f3\u7684\u60c5\u51b5\u662f\uff0cMySQL \u770b\u5230\u5b57\u6bb5 b \u5b9a\u4e49\u7684\u662f <code>varchar(10)</code>\uff0c\u90a3\u80af\u5b9a\u8fd4\u56de\u7a7a\u5440\u3002\u53ef\u60dc\uff0cMySQL \u5e76\u6ca1\u6709\u8fd9\u4e48\u505a\u3002</p>\n<p>\u90a3\u8981\u4e0d\uff0c\u5c31\u662f\u628a <code>'1234567890abcd'</code> \u62ff\u5230\u7d22\u5f15\u91cc\u9762\u53bb\u505a\u5339\u914d\uff0c\u80af\u5b9a\u4e5f\u6ca1\u80fd\u591f\u5feb\u901f\u5224\u65ad\u51fa\u7d22\u5f15\u6811 b \u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e2a\u503c\uff0c\u4e5f\u5f88\u5feb\u5c31\u80fd\u8fd4\u56de\u7a7a\u7ed3\u679c\u3002</p>\n<p>\u4f46\u5b9e\u9645\u4e0a\uff0cMySQL \u4e5f\u4e0d\u662f\u8fd9\u4e48\u505a\u7684\u3002</p>\n<p>\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u6267\u884c\u5f88\u6162\uff0c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5728\u4f20\u7ed9\u5f15\u64ce\u6267\u884c\u7684\u65f6\u5019\uff0c\u505a\u4e86\u5b57\u7b26\u622a\u65ad\u3002\u56e0\u4e3a\u5f15\u64ce\u91cc\u9762\u8fd9\u4e2a\u884c\u53ea\u5b9a\u4e49\u4e86\u957f\u5ea6\u662f 10\uff0c\u6240\u4ee5\u53ea\u622a\u4e86\u524d 10 \u4e2a\u5b57\u8282\uff0c\u5c31\u662f <code>'1234567890'</code> \u8fdb\u53bb\u505a\u5339\u914d\uff1b</li>\n<li>\u8fd9\u6837\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u6709 10 \u4e07\u884c\uff1b</li>\n<li>\u56e0\u4e3a\u662f <code>select *</code>\uff0c \u6240\u4ee5\u8981\u505a 10 \u4e07\u6b21\u56de\u8868\uff1b</li>\n<li>\u4f46\u662f\u6bcf\u6b21\u56de\u8868\u4ee5\u540e\u67e5\u51fa\u6574\u884c\uff0c\u5230 server \u5c42\u4e00\u5224\u65ad\uff0cb \u7684\u503c\u90fd\u4e0d\u662f <code>\u20191234567890abcd'</code></li>\n<li>\u8fd4\u56de\u7ed3\u679c\u662f\u7a7a\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u662f\u6211\u4eec\u6587\u7ae0\u5185\u5bb9\u7684\u4e00\u4e2a\u5f88\u597d\u7684\u8865\u5145\u3002\u867d\u7136\u6267\u884c\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u7ecf\u8fc7\u51fd\u6570\u64cd\u4f5c\uff0c\u4f46\u662f\u6700\u7ec8\u5728\u62ff\u5230\u7ed3\u679c\u540e\uff0cserver \u5c42\u8fd8\u662f\u8981\u505a\u4e00\u8f6e\u5224\u65ad\u7684\u3002</p>\n<h3 id=\"_25\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_25\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u6211\u7ed9\u4f60\u4e3e\u4e86\u4e09\u4e2a\u4f8b\u5b50\uff0c\u5176\u5b9e\u662f\u5728\u8bf4\u540c\u4e00\u4ef6\u4e8b\u513f\uff0c\u5373\uff1a<strong>\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u7d22\u5f15\u503c\u7684\u6709\u5e8f\u6027\uff0c\u56e0\u6b64\u4f18\u5316\u5668\u5c31\u51b3\u5b9a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</strong></p>\n<p>\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u662f\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362\uff0c\u7b2c\u4e09\u4e2a\u4f8b\u5b50\u662f\u9690\u5f0f\u5b57\u7b26\u7f16\u7801\u8f6c\u6362\uff0c\u5b83\u4eec\u90fd\u8ddf\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u56e0\u4e3a\u8981\u6c42\u5728\u7d22\u5f15\u5b57\u6bb5\u4e0a\u505a\u51fd\u6570\u64cd\u4f5c\u800c\u5bfc\u81f4\u4e86\u5168\u7d22\u5f15\u626b\u63cf\u3002</p>\n<p>MySQL \u7684\u4f18\u5316\u5668\u786e\u5b9e\u6709\u201c\u5077\u61d2\u201d\u7684\u5acc\u7591\uff0c\u5373\u4f7f\u7b80\u5355\u5730\u628a where id+1=1000 \u6539\u5199\u6210 where id=1000-1 \u5c31\u80fd\u591f\u7528\u4e0a\u7d22\u5f15\u5feb\u901f\u67e5\u627e\uff0c\u4e5f\u4e0d\u4f1a\u4e3b\u52a8\u505a\u8fd9\u4e2a\u8bed\u53e5\u91cd\u5199\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6bcf\u6b21\u4f60\u7684\u4e1a\u52a1\u4ee3\u7801\u5347\u7ea7\u65f6\uff0c\u628a\u53ef\u80fd\u51fa\u73b0\u7684\u3001\u65b0\u7684 SQL \u8bed\u53e5 explain \u4e00\u4e0b\uff0c\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4e60\u60ef\u3002</p>\n<h2 id=\"19\">19 \u4e3a\u4ec0\u4e48\u6211\u53ea\u67e5\u4e00\u884c\u7684\u8bed\u53e5\uff0c\u4e5f\u6267\u884c\u8fd9\u4e48\u6162\uff1f<a class=\"headerlink\" href=\"#19\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6211\u8ddf\u4f60\u8bf4\u67e5\u8be2\u6027\u80fd\u4f18\u5316\uff0c\u4f60\u9996\u5148\u4f1a\u60f3\u5230\u4e00\u4e9b\u590d\u6742\u7684\u8bed\u53e5\uff0c\u60f3\u5230\u67e5\u8be2\u9700\u8981\u8fd4\u56de\u5927\u91cf\u7684\u6570\u636e\u3002\u4f46\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u201c\u67e5\u4e00\u884c\u201d\uff0c\u4e5f\u4f1a\u6267\u884c\u5f97\u7279\u522b\u6162\u3002\u4eca\u5929\uff0c\u6211\u5c31\u8ddf\u4f60\u804a\u804a\u8fd9\u4e2a\u6709\u8da3\u7684\u8bdd\u9898\uff0c\u770b\u770b\u4ec0\u4e48\u60c5\u51b5\u4e0b\uff0c\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u73b0\u8c61\u3002</p>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5982\u679c MySQL \u6570\u636e\u5e93\u672c\u8eab\u5c31\u6709\u5f88\u5927\u7684\u538b\u529b\uff0c\u5bfc\u81f4\u6570\u636e\u5e93\u670d\u52a1\u5668 CPU \u5360\u7528\u7387\u5f88\u9ad8\u6216 ioutil\uff08IO \u5229\u7528\u7387\uff09\u5f88\u9ad8\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6240\u6709\u8bed\u53e5\u7684\u6267\u884c\u90fd\u6709\u53ef\u80fd\u53d8\u6162\uff0c\u4e0d\u5c5e\u4e8e\u6211\u4eec\u4eca\u5929\u7684\u8ba8\u8bba\u8303\u56f4\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u8fd8\u662f\u6784\u9020\u4e00\u4e2a\u8868\uff0c\u57fa\u4e8e\u8fd9\u4e2a\u8868\u6765\u8bf4\u660e\u4eca\u5929\u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u8868\u6709\u4e24\u4e2a\u5b57\u6bb5 id \u548c c\uff0c\u5e76\u4e14\u6211\u5728\u91cc\u9762\u63d2\u5165\u4e86 10 \u4e07\u884c\u8bb0\u5f55\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">100000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4f1a\u7528\u51e0\u4e2a\u4e0d\u540c\u7684\u573a\u666f\u6765\u4e3e\u4f8b\uff0c\u6709\u4e9b\u662f\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u6211\u4eec\u5df2\u7ecf\u4ecb\u7ecd\u8fc7\u7684\u77e5\u8bc6\u70b9\uff0c\u4f60\u770b\u770b\u80fd\u4e0d\u80fd\u4e00\u773c\u770b\u7a7f\uff0c\u6765\u68c0\u9a8c\u4e00\u4e0b\u5427\u3002</p>\n<h3 id=\"flush\">\u7b49 flush<a class=\"headerlink\" href=\"#flush\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u5728\u8868 t \u4e0a\uff0c\u6267\u884c\u4e0b\u9762\u7684 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">processlist</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\uff0c\u6211\u5148\u5356\u4e2a\u5173\u5b50\u3002</p>\n<p>\u6211\u67e5\u51fa\u6765\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u662f <code>Waiting for table flush</code>\uff0c\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">PROCESSLIST</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">USER</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">HOST</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">DB</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">COMMAND</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">TIME</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">STATE</span><span class=\"w\">                  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">INFO</span><span class=\"w\">                       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">622</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Waiting</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">flush</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u72b6\u6001\u8868\u793a\u7684\u662f\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6b63\u8981\u5bf9\u8868 t \u505a flush \u64cd\u4f5c\u3002MySQL \u91cc\u9762\u5bf9\u8868\u505a flush \u64cd\u4f5c\u7684\u7528\u6cd5\uff0c\u4e00\u822c\u6709\u4ee5\u4e0b\u4e24\u4e2a\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">flush</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">read</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"n\">flush</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">read</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e24\u4e2a flush \u8bed\u53e5\uff0c\u5982\u679c\u6307\u5b9a\u8868 t \u7684\u8bdd\uff0c\u4ee3\u8868\u7684\u662f\u53ea\u5173\u95ed\u8868 t\uff1b\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5177\u4f53\u7684\u8868\u540d\uff0c\u5219\u8868\u793a\u5173\u95ed MySQL \u91cc\u6240\u6709\u6253\u5f00\u7684\u8868\u3002</p>\n<p>\u4f46\u662f\u6b63\u5e38\u8fd9\u4e24\u4e2a\u8bed\u53e5\u6267\u884c\u8d77\u6765\u90fd\u5f88\u5feb\uff0c\u9664\u975e\u5b83\u4eec\u4e5f\u88ab\u522b\u7684\u7ebf\u7a0b\u5835\u4f4f\u4e86\u3002</p>\n<p>\u6240\u4ee5\uff0c\u51fa\u73b0 Waiting for table flush \u72b6\u6001\u7684\u53ef\u80fd\u60c5\u51b5\u662f\uff1a\u6709\u4e00\u4e2a flush tables \u547d\u4ee4\u88ab\u522b\u7684\u8bed\u53e5\u5835\u4f4f\u4e86\uff0c\u7136\u540e\u5b83\u53c8\u5835\u4f4f\u4e86\u6211\u4eec\u7684 select \u8bed\u53e5\u3002</p>\n<h3 id=\"_26\">\u7b49\u884c\u9501<a class=\"headerlink\" href=\"#_26\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\uff0c\u7ecf\u8fc7\u4e86\u8868\u7ea7\u9501\u7684\u8003\u9a8c\uff0c\u6211\u4eec\u7684 select \u8bed\u53e5\u7ec8\u4e8e\u6765\u5230\u5f15\u64ce\u91cc\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\u7684\u7528\u6cd5\u4f60\u4e5f\u5f88\u719f\u6089\u4e86\uff0c\u6211\u4eec\u5728\u7b2c 8 \u7bc7[\u300a\u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f\u300b]\u6587\u7ae0\u4ecb\u7ecd\u5f53\u524d\u8bfb\u65f6\u63d0\u5230\u8fc7\u3002</p>\n<p>\u7531\u4e8e\u8bbf\u95ee id=1 \u8fd9\u4e2a\u8bb0\u5f55\u65f6\u8981\u52a0\u8bfb\u9501\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u5df2\u7ecf\u6709\u4e00\u4e2a\u4e8b\u52a1\u5728\u8fd9\u884c\u8bb0\u5f55\u4e0a\u6301\u6709\u4e00\u4e2a\u5199\u9501\uff0c\u6211\u4eec\u7684 select \u8bed\u53e5\u5c31\u4f1a\u88ab\u5835\u4f4f\u3002</p>\n<p>\u590d\u73b0\u6b65\u9aa4\u548c\u73b0\u573a\u5982\u4e0b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />update t set c  = c + 1 where id = 1;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td><code>select * from where id = 1 lock in share mode;</code></td>\n</tr>\n</tbody>\n</table>\n<p>\u884c\u9501\u590d\u73b0</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Host</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">State</span><span class=\"w\">                  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                                          </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">event_scheduler</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Daemon</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">75402</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Waiting</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"n\">queue</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">                                          </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"w\">                              </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">statistics</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+</span>\n<span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u663e\u7136\uff0csession A \u542f\u52a8\u4e86\u4e8b\u52a1\uff0c\u5360\u6709\u5199\u9501\uff0c\u8fd8\u4e0d\u63d0\u4ea4\uff0c\u662f\u5bfc\u81f4 session B \u88ab\u5835\u4f4f\u7684\u539f\u56e0\u3002</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u5e76\u4e0d\u96be\u5206\u6790\uff0c\u4f46\u95ee\u9898\u662f\u600e\u4e48\u67e5\u51fa\u662f\u8c01\u5360\u7740\u8fd9\u4e2a\u5199\u9501\u3002\u5982\u679c\u4f60\u7528\u7684\u662f MySQL 5.7 \u7248\u672c\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>sys.innodb_lock_waits</code> \u8868\u67e5\u5230\u3002</p>\n<p>\u67e5\u8be2\u65b9\u6cd5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">sys</span><span class=\"p\">.</span><span class=\"n\">innodb_lock_waits</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">locked_table</span><span class=\"o\">=</span><span class=\"s1\">&#39;`test`.`t`&#39;</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">                </span><span class=\"n\">wait_started</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">:</span><span class=\"mi\">57</span><span class=\"p\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">                    </span><span class=\"n\">wait_age</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">01</span>\n<span class=\"w\">               </span><span class=\"n\">wait_age_secs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">                </span><span class=\"n\">locked_table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span>\n<span class=\"w\">         </span><span class=\"n\">locked_table_schema</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"w\">           </span><span class=\"n\">locked_table_name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">      </span><span class=\"n\">locked_table_partition</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">   </span><span class=\"n\">locked_table_subpartition</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">                </span><span class=\"n\">locked_index</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span>\n<span class=\"w\">                 </span><span class=\"n\">locked_type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">RECORD</span>\n<span class=\"w\">              </span><span class=\"n\">waiting_trx_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">421933896469888</span>\n<span class=\"w\">         </span><span class=\"n\">waiting_trx_started</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">:</span><span class=\"mi\">57</span><span class=\"p\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">             </span><span class=\"n\">waiting_trx_age</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">01</span>\n<span class=\"w\">     </span><span class=\"n\">waiting_trx_rows_locked</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">   </span><span class=\"n\">waiting_trx_rows_modified</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">                 </span><span class=\"n\">waiting_pid</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">21</span>\n<span class=\"w\">               </span><span class=\"n\">waiting_query</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span>\n<span class=\"w\">             </span><span class=\"n\">waiting_lock_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">140458919759232</span><span class=\"p\">:</span><span class=\"mi\">488</span><span class=\"p\">:</span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"mi\">140458768951320</span>\n<span class=\"w\">           </span><span class=\"n\">waiting_lock_mode</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"p\">,</span><span class=\"n\">REC_NOT_GAP</span>\n<span class=\"w\">             </span><span class=\"n\">blocking_trx_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">588483</span>\n<span class=\"w\">                </span><span class=\"n\">blocking_pid</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"w\">              </span><span class=\"n\">blocking_query</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">sys</span><span class=\"p\">.</span><span class=\"n\">innodb_lock_waits</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">locked_table</span><span class=\"o\">=</span><span class=\"s1\">&#39;`test`.`t`&#39;</span>\n<span class=\"w\">            </span><span class=\"n\">blocking_lock_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">140458919758376</span><span class=\"p\">:</span><span class=\"mi\">488</span><span class=\"p\">:</span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"mi\">140458768946712</span>\n<span class=\"w\">          </span><span class=\"n\">blocking_lock_mode</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"p\">,</span><span class=\"n\">REC_NOT_GAP</span>\n<span class=\"w\">        </span><span class=\"n\">blocking_trx_started</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">:</span><span class=\"mi\">56</span><span class=\"p\">:</span><span class=\"mi\">23</span>\n<span class=\"w\">            </span><span class=\"n\">blocking_trx_age</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">00</span><span class=\"p\">:</span><span class=\"mi\">58</span>\n<span class=\"w\">    </span><span class=\"n\">blocking_trx_rows_locked</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">blocking_trx_rows_modified</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">     </span><span class=\"n\">sql_kill_blocking_query</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">KILL</span><span class=\"w\"> </span><span class=\"n\">QUERY</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"n\">sql_kill_blocking_connection</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">KILL</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u4fe1\u606f\u5f88\u5168\uff0c20 \u53f7\u7ebf\u7a0b\u662f\u9020\u6210\u5835\u585e\u7684\u7f6a\u9b41\u7978\u9996\u3002\u800c\u5e72\u6389\u8fd9\u4e2a\u7f6a\u9b41\u7978\u9996\u7684\u65b9\u5f0f\uff0c\u5c31\u662f <code>KILL QUERY 20</code> \u6216 <code>KILL 20</code>\u3002</p>\n<p>\u4e0d\u8fc7\uff0c\u8fd9\u91cc\u4e0d\u5e94\u8be5\u663e\u793a <code>KILL QUERY 20</code>\u3002\u8fd9\u4e2a\u547d\u4ee4\u8868\u793a\u505c\u6b62 20 \u53f7\u7ebf\u7a0b\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\uff0c\u800c\u8fd9\u4e2a\u65b9\u6cd5\u5176\u5b9e\u662f\u6ca1\u6709\u7528\u7684\u3002\u56e0\u4e3a\u5360\u6709\u884c\u9501\u7684\u662f update \u8bed\u53e5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u5df2\u7ecf\u662f\u4e4b\u524d\u6267\u884c\u5b8c\u6210\u4e86\u7684\uff0c\u73b0\u5728\u6267\u884c KILL QUERY\uff0c\u65e0\u6cd5\u8ba9\u8fd9\u4e2a\u4e8b\u52a1\u53bb\u6389 id=1 \u4e0a\u7684\u884c\u9501\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0cKILL 20 \u624d\u6709\u6548\uff0c\u4e5f\u5c31\u662f\u8bf4\u76f4\u63a5\u65ad\u5f00\u8fd9\u4e2a\u8fde\u63a5\u3002\u8fd9\u91cc\u9690\u542b\u7684\u4e00\u4e2a\u903b\u8f91\u5c31\u662f\uff0c\u8fde\u63a5\u88ab\u65ad\u5f00\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u56de\u6eda\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u6b63\u5728\u6267\u884c\u7684\u7ebf\u7a0b\uff0c\u4e5f\u5c31\u91ca\u653e\u4e86 id=1 \u4e0a\u7684\u884c\u9501\u3002</p>\n<h3 id=\"_27\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_27\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u6211\u7ed9\u4f60\u4e3e\u4e86\u5728\u4e00\u4e2a\u7b80\u5355\u7684\u8868\u4e0a\uff0c\u6267\u884c\u201c\u67e5\u4e00\u884c\u201d\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u7684\u88ab\u9501\u4f4f\u548c\u6267\u884c\u6162\u7684\u4f8b\u5b50\u3002\u8fd9\u5176\u4e2d\u6d89\u53ca\u5230\u4e86\u8868\u9501\u3001\u884c\u9501\u548c\u4e00\u81f4\u6027\u8bfb\u7684\u6982\u5ff5\u3002</p>\n<p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u78b0\u5230\u7684\u573a\u666f\u4f1a\u66f4\u590d\u6742\u3002\u4f46\u5927\u540c\u5c0f\u5f02\uff0c\u4f60\u53ef\u4ee5\u6309\u7167\u6211\u5728\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u7684\u5b9a\u4f4d\u65b9\u6cd5\uff0c\u6765\u5b9a\u4f4d\u5e76\u89e3\u51b3\u95ee\u9898\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["mysql", "tuning"]}, {"id": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-3/", "url": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-3/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e09\u90e8\u5206", "content_html": "<h1 id=\"mysql-45\">\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e09\u90e8\u5206<a class=\"headerlink\" href=\"#mysql-45\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md\" title=\"Permalink to MySQL\u5b9e\u621845\u8bb2.md\">Source</a></p>\n<p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e09\u90e8\u5206</p>\n<h2 id=\"20\">20 \u5e7b\u8bfb\u662f\u4ec0\u4e48\uff0c\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\uff1f<a class=\"headerlink\" href=\"#20\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e86\u4e00\u4e2a\u5173\u4e8e\u52a0\u9501\u89c4\u5219\u7684\u95ee\u9898\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u8bf4\u8d77\u5427\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\u95ee\u9898\uff0c\u8fd9\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u5148\u4f7f\u7528\u4e00\u4e2a\u5c0f\u4e00\u70b9\u513f\u7684\u8868\u3002\u5efa\u8868\u548c\u521d\u59cb\u5316\u8bed\u53e5\u5982\u4e0b\uff08\u4e3a\u4e86\u4fbf\u4e8e\u672c\u671f\u7684\u4f8b\u5b50\u8bf4\u660e\uff0c\u6211\u628a\u4e0a\u7bc7\u6587\u7ae0\u4e2d\u7528\u5230\u7684\u8868\u7ed3\u6784\u505a\u4e86\u70b9\u513f\u4fee\u6539\uff09\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">),(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">),</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">),(</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">),(</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">),(</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8868\u9664\u4e86\u4e3b\u952e id \u5916\uff0c\u8fd8\u6709\u4e00\u4e2a\u7d22\u5f15 c\uff0c\u521d\u59cb\u5316\u8bed\u53e5\u5728\u8868\u4e2d\u63d2\u5165\u4e86 6 \u884c\u6570\u636e\u3002</p>\n<p>\u4e0a\u671f\u6211\u7559\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u5e8f\u5217\uff0c\u662f\u600e\u4e48\u52a0\u9501\u7684\uff0c\u52a0\u7684\u9501\u53c8\u662f\u4ec0\u4e48\u65f6\u5019\u91ca\u653e\u7684\u5462\uff1f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6bd4\u8f83\u597d\u7406\u89e3\u7684\u662f\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u547d\u4e2d d=5 \u7684\u8fd9\u4e00\u884c\uff0c\u5bf9\u5e94\u7684\u4e3b\u952e id=5\uff0c\u56e0\u6b64\u5728 select \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0cid=5 \u8fd9\u4e00\u884c\u4f1a\u52a0\u4e00\u4e2a\u5199\u9501\uff0c\u800c\u4e14\u7531\u4e8e\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u8fd9\u4e2a\u5199\u9501\u4f1a\u5728\u6267\u884c commit \u8bed\u53e5\u7684\u65f6\u5019\u91ca\u653e\u3002</p>\n<p>\u7531\u4e8e\u5b57\u6bb5 d \u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u56e0\u6b64\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u4f1a\u505a\u5168\u8868\u626b\u63cf\u3002\u90a3\u4e48\uff0c\u5176\u4ed6\u88ab\u626b\u63cf\u5230\u7684\uff0c\u4f46\u662f\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684 5 \u884c\u8bb0\u5f55\u4e0a\uff0c\u4f1a\u4e0d\u4f1a\u88ab\u52a0\u9501\u5462\uff1f</p>\n<p>\u6211\u4eec\u77e5\u9053\uff0cInnoDB \u7684\u9ed8\u8ba4\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u662f\u53ef\u91cd\u590d\u8bfb\uff0c\u6240\u4ee5\u672c\u6587\u63a5\u4e0b\u6765\u6ca1\u6709\u7279\u6b8a\u8bf4\u660e\u7684\u90e8\u5206\uff0c\u90fd\u662f\u8bbe\u5b9a\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u3002</p>\n<h3 id=\"_1\">\u5e7b\u8bfb\u662f\u4ec0\u4e48\uff1f<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u5206\u6790\u4e00\u4e0b\uff0c\u5982\u679c\u53ea\u5728 id=5 \u8fd9\u4e00\u884c\u52a0\u9501\uff0c\u800c\u5176\u4ed6\u884c\u7684\u4e0d\u52a0\u9501\u7684\u8bdd\uff0c\u4f1a\u600e\u4e48\u6837\u3002</p>\n<p>\u4e0b\u9762\u5148\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\uff08\u6ce8\u610f\uff1a\u8fd9\u662f\u6211\u5047\u8bbe\u7684\u4e00\u4e2a\u573a\u666f\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n<th>Session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />//result: (5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>update t set d=5 where id=0;</td>\n<td></td>\n</tr>\n<tr>\n<td>T3</td>\n<td>select * from t where d=5 fro update; /<em>Q2</em>/<br />//result: (0,0,5), (5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td></td>\n<td>insert into t values(1,1,5);</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>select * from t where d=5 fro update; /<em>Q3</em>/<br />//result: (0,0,5),(1,1,5),(5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td>commit;</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0csession A \u91cc\u6267\u884c\u4e86\u4e09\u6b21\u67e5\u8be2\uff0c\u5206\u522b\u662f Q1\u3001Q2 \u548c Q3\u3002\u5b83\u4eec\u7684 SQL \u8bed\u53e5\u76f8\u540c\uff0c\u90fd\u662f <code>select * from t where d=5 for update</code>\u3002\u8fd9\u4e2a\u8bed\u53e5\u7684\u610f\u601d\u4f60\u5e94\u8be5\u5f88\u6e05\u695a\u4e86\uff0c\u67e5\u6240\u6709 d=5 \u7684\u884c\uff0c\u800c\u4e14\u4f7f\u7528\u7684\u662f\u5f53\u524d\u8bfb\uff0c\u5e76\u4e14\u52a0\u4e0a\u5199\u9501\u3002\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\uff0c\u5206\u522b\u4f1a\u8fd4\u56de\u4ec0\u4e48\u7ed3\u679c\u3002</p>\n<ol>\n<li>Q1 \u53ea\u8fd4\u56de id=5 \u8fd9\u4e00\u884c\uff1b</li>\n<li>\u5728 T2 \u65f6\u523b\uff0csession B \u628a id=0 \u8fd9\u4e00\u884c\u7684 d \u503c\u6539\u6210\u4e86 5\uff0c\u56e0\u6b64 T3 \u65f6\u523b Q2 \u67e5\u51fa\u6765\u7684\u662f id=0 \u548c id=5 \u8fd9\u4e24\u884c\uff1b</li>\n<li>\u5728 T4 \u65f6\u523b\uff0csession C \u53c8\u63d2\u5165\u4e00\u884c<code>\uff081,1,5\uff09</code>\uff0c\u56e0\u6b64 T5 \u65f6\u523b Q3 \u67e5\u51fa\u6765\u7684\u662f id=0\u3001id=1 \u548c id=5 \u7684\u8fd9\u4e09\u884c\u3002</li>\n</ol>\n<p>\u5176\u4e2d\uff0cQ3 \u8bfb\u5230 id=1 \u8fd9\u4e00\u884c\u7684\u73b0\u8c61\uff0c\u88ab\u79f0\u4e3a\u201c\u5e7b\u8bfb\u201d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5e7b\u8bfb\u6307\u7684\u662f\u4e00\u4e2a\u4e8b\u52a1\u5728\u524d\u540e\u4e24\u6b21\u67e5\u8be2\u540c\u4e00\u4e2a\u8303\u56f4\u7684\u65f6\u5019\uff0c\u540e\u4e00\u6b21\u67e5\u8be2\u770b\u5230\u4e86\u524d\u4e00\u6b21\u67e5\u8be2\u6ca1\u6709\u770b\u5230\u7684\u884c\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5bf9\u201c\u5e7b\u8bfb\u201d\u505a\u4e00\u4e2a\u8bf4\u660e\uff1a</p>\n<ol>\n<li>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u666e\u901a\u7684\u67e5\u8be2\u662f\u5feb\u7167\u8bfb\uff0c\u662f\u4e0d\u4f1a\u770b\u5230\u522b\u7684\u4e8b\u52a1\u63d2\u5165\u7684\u6570\u636e\u7684\u3002\u56e0\u6b64\uff0c\u5e7b\u8bfb\u5728\u201c\u5f53\u524d\u8bfb\u201d\u4e0b\u624d\u4f1a\u51fa\u73b0\u3002</li>\n<li>\u4e0a\u9762 session B \u7684\u4fee\u6539\u7ed3\u679c\uff0c\u88ab session A \u4e4b\u540e\u7684 select \u8bed\u53e5\u7528\u201c\u5f53\u524d\u8bfb\u201d\u770b\u5230\uff0c\u4e0d\u80fd\u79f0\u4e3a\u5e7b\u8bfb\u3002\u5e7b\u8bfb\u4ec5\u4e13\u6307\u201c\u65b0\u63d2\u5165\u7684\u884c\u201d\u3002</li>\n</ol>\n<p>\u5982\u679c\u53ea\u4ece\u7b2c 8 \u7bc7\u6587\u7ae0[\u300a\u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f\u300b]\u6211\u4eec\u5b66\u5230\u7684\u4e8b\u52a1\u53ef\u89c1\u6027\u89c4\u5219\u6765\u5206\u6790\u7684\u8bdd\uff0c\u4e0a\u9762\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\u7684\u8fd4\u56de\u7ed3\u679c\u90fd\u6ca1\u6709\u95ee\u9898\u3002</p>\n<p>\u56e0\u4e3a\u8fd9\u4e09\u4e2a\u67e5\u8be2\u90fd\u662f\u52a0\u4e86 for update\uff0c\u90fd\u662f\u5f53\u524d\u8bfb\u3002\u800c\u5f53\u524d\u8bfb\u7684\u89c4\u5219\uff0c\u5c31\u662f\u8981\u80fd\u8bfb\u5230\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u8bb0\u5f55\u7684\u6700\u65b0\u503c\u3002\u5e76\u4e14\uff0csession B \u548c sessionC \u7684\u4e24\u6761\u8bed\u53e5\uff0c\u6267\u884c\u540e\u5c31\u4f1a\u63d0\u4ea4\uff0c\u6240\u4ee5 Q2 \u548c Q3 \u5c31\u662f\u5e94\u8be5\u770b\u5230\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u7684\u64cd\u4f5c\u6548\u679c\uff0c\u800c\u4e14\u4e5f\u770b\u5230\u4e86\uff0c\u8fd9\u8ddf\u4e8b\u52a1\u7684\u53ef\u89c1\u6027\u89c4\u5219\u5e76\u4e0d\u77db\u76fe\u3002</p>\n<p>\u4f46\u662f\uff0c\u8fd9\u662f\u4e0d\u662f\u771f\u7684\u6ca1\u95ee\u9898\u5462\uff1f</p>\n<p>\u4e0d\uff0c\u8fd9\u91cc\u8fd8\u771f\u5c31\u6709\u95ee\u9898\u3002</p>\n<h3 id=\"_2\">\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\uff1f<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>**\u9996\u5148\u662f\u8bed\u4e49\u4e0a\u7684\u3002**session A \u5728 T1 \u65f6\u523b\u5c31\u58f0\u660e\u4e86\uff0c\u201c\u6211\u8981\u628a\u6240\u6709 d=5 \u7684\u884c\u9501\u4f4f\uff0c\u4e0d\u51c6\u522b\u7684\u4e8b\u52a1\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u201d\u3002\u800c\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u8bed\u4e49\u88ab\u7834\u574f\u4e86\u3002</p>\n<p>\u5982\u679c\u73b0\u5728\u8fd9\u6837\u770b\u611f\u89c9\u8fd8\u4e0d\u660e\u663e\u7684\u8bdd\uff0c\u6211\u518d\u5f80 session B \u548c session C \u91cc\u9762\u5206\u522b\u52a0\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u4f60\u518d\u770b\u770b\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n<th>Session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />//result: (5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>update t set d=5 where id=0;<br />update t set c=5 where id=0;</td>\n<td></td>\n</tr>\n<tr>\n<td>T3</td>\n<td>select * from t where d=5 fro update; /<em>Q2</em>/<br />//result: (0,0,5), (5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td></td>\n<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>select * from t where d=5 fro update; /<em>Q3</em>/<br />//result: (0,0,5),(1,1,5),(5,5,5)</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td>commit;</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>session B \u7684\u7b2c\u4e8c\u6761\u8bed\u53e5 <code>update t set c=5 where id=0</code>\uff0c\u8bed\u4e49\u662f\u201c\u6211\u628a id=0\u3001d=5 \u8fd9\u4e00\u884c\u7684 c \u503c\uff0c\u6539\u6210\u4e86 5\u201d\u3002</p>\n<p>\u7531\u4e8e\u5728 T1 \u65f6\u523b\uff0csession A \u8fd8\u53ea\u662f\u7ed9 id=5 \u8fd9\u4e00\u884c\u52a0\u4e86\u884c\u9501\uff0c \u5e76\u6ca1\u6709\u7ed9 id=0 \u8fd9\u884c\u52a0\u4e0a\u9501\u3002\u56e0\u6b64\uff0csession B \u5728 T2 \u65f6\u523b\uff0c\u662f\u53ef\u4ee5\u6267\u884c\u8fd9\u4e24\u6761 update \u8bed\u53e5\u7684\u3002\u8fd9\u6837\uff0c\u5c31\u7834\u574f\u4e86 session A \u91cc Q1 \u8bed\u53e5\u8981\u9501\u4f4f\u6240\u6709 d=5 \u7684\u884c\u7684\u52a0\u9501\u58f0\u660e\u3002</p>\n<p>session C \u4e5f\u662f\u4e00\u6837\u7684\u9053\u7406\uff0c\u5bf9 id=1 \u8fd9\u4e00\u884c\u7684\u4fee\u6539\uff0c\u4e5f\u662f\u7834\u574f\u4e86 Q1 \u7684\u52a0\u9501\u58f0\u660e\u3002</p>\n<p><strong>\u5176\u6b21\uff0c\u662f\u6570\u636e\u4e00\u81f4\u6027\u7684\u95ee\u9898\u3002</strong></p>\n<p>\u6211\u4eec\u77e5\u9053\uff0c\u9501\u7684\u8bbe\u8ba1\u662f\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u800c\u8fd9\u4e2a\u4e00\u81f4\u6027\uff0c\u4e0d\u6b62\u662f\u6570\u636e\u5e93\u5185\u90e8\u6570\u636e\u72b6\u6001\u5728\u6b64\u523b\u7684\u4e00\u81f4\u6027\uff0c\u8fd8\u5305\u542b\u4e86\u6570\u636e\u548c\u65e5\u5fd7\u5728\u903b\u8f91\u4e0a\u7684\u4e00\u81f4\u6027\u3002</p>\n<p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u7ed9 session A \u5728 T1 \u65f6\u523b\u518d\u52a0\u4e00\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u5373\uff1a<code>update t set d=100 where d=5</code>\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n<th>Session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />update t set d=100 where d=5;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>update t set d=5 where id=0;<br />update t set c=5 where id=0;</td>\n<td></td>\n</tr>\n<tr>\n<td>T3</td>\n<td>select * from t where d=5 fro update; /<em>Q2</em>/</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td></td>\n<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>select * from t where d=5 fro update; /<em>Q3</em>/</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td>commit;</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>update \u7684\u52a0\u9501\u8bed\u4e49\u548c <code>select \u2026for update</code> \u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u8fd9\u65f6\u5019\u52a0\u4e0a\u8fd9\u6761 update \u8bed\u53e5\u4e5f\u5f88\u5408\u7406\u3002session A \u58f0\u660e\u8bf4\u201c\u8981\u7ed9 d=5 \u7684\u8bed\u53e5\u52a0\u4e0a\u9501\u201d\uff0c\u5c31\u662f\u4e3a\u4e86\u8981\u66f4\u65b0\u6570\u636e\uff0c\u65b0\u52a0\u7684\u8fd9\u6761 update \u8bed\u53e5\u5c31\u662f\u628a\u5b83\u8ba4\u4e3a\u52a0\u4e0a\u4e86\u9501\u7684\u8fd9\u4e00\u884c\u7684 d \u503c\u4fee\u6539\u6210\u4e86 100\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u56fe 3 \u6267\u884c\u5b8c\u6210\u540e\uff0c\u6570\u636e\u5e93\u91cc\u4f1a\u662f\u4ec0\u4e48\u7ed3\u679c\u3002</p>\n<ol>\n<li>\u7ecf\u8fc7 T1 \u65f6\u523b\uff0cid=5 \u8fd9\u4e00\u884c\u53d8\u6210 (5,5,100)\uff0c\u5f53\u7136\u8fd9\u4e2a\u7ed3\u679c\u6700\u7ec8\u662f\u5728 T6 \u65f6\u523b\u6b63\u5f0f\u63d0\u4ea4\u7684 ;</li>\n<li>\u7ecf\u8fc7 T2 \u65f6\u523b\uff0cid=0 \u8fd9\u4e00\u884c\u53d8\u6210 (0,5,5);</li>\n<li>\u7ecf\u8fc7 T4 \u65f6\u523b\uff0c\u8868\u91cc\u9762\u591a\u4e86\u4e00\u884c (1,5,5);</li>\n<li>\u5176\u4ed6\u884c\u8ddf\u8fd9\u4e2a\u6267\u884c\u5e8f\u5217\u65e0\u5173\uff0c\u4fdd\u6301\u4e0d\u53d8\u3002</li>\n</ol>\n<p>\u8fd9\u6837\u770b\uff0c\u8fd9\u4e9b\u6570\u636e\u4e5f\u6ca1\u5565\u95ee\u9898\uff0c\u4f46\u662f\u6211\u4eec\u518d\u6765\u770b\u770b\u8fd9\u65f6\u5019 binlog \u91cc\u9762\u7684\u5185\u5bb9\u3002</p>\n<ol>\n<li>T2 \u65f6\u523b\uff0csession B \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86\u4e24\u6761\u8bed\u53e5\uff1b</li>\n<li>T4 \u65f6\u523b\uff0csession C \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86\u4e24\u6761\u8bed\u53e5\uff1b</li>\n<li>T6 \u65f6\u523b\uff0csession A \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86 update t set d=100 where d=5 \u8fd9\u6761\u8bed\u53e5\u3002</li>\n</ol>\n<p>\u6211\u7edf\u4e00\u653e\u5230\u4e00\u8d77\u7684\u8bdd\uff0c\u5c31\u662f\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(0,0,5)*/</span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(0,5,5)*/</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/*(1,1,5)*/</span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(1,5,5)*/</span><span class=\"w\"> </span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"p\">;</span><span class=\"cm\">/* \u6240\u6709 d=5 \u7684\u884c\uff0cd \u6539\u6210 100*/</span>\n</code></pre></div>\n<p>\u597d\uff0c\u4f60\u5e94\u8be5\u770b\u51fa\u95ee\u9898\u4e86\u3002\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff0c\u4e0d\u8bba\u662f\u62ff\u5230\u5907\u5e93\u53bb\u6267\u884c\uff0c\u8fd8\u662f\u4ee5\u540e\u7528 binlog \u6765\u514b\u9686\u4e00\u4e2a\u5e93\uff0c\u8fd9\u4e09\u884c\u7684\u7ed3\u679c\uff0c\u90fd\u53d8\u6210\u4e86 (0,5,100)\u3001(1,5,100) \u548c (5,5,100)\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0cid=0 \u548c id=1 \u8fd9\u4e24\u884c\uff0c\u53d1\u751f\u4e86\u6570\u636e\u4e0d\u4e00\u81f4\u3002\u8fd9\u4e2a\u95ee\u9898\u5f88\u4e25\u91cd\uff0c\u662f\u4e0d\u884c\u7684\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u518d\u56de\u987e\u4e00\u4e0b\uff0c<strong>\u8fd9\u4e2a\u6570\u636e\u4e0d\u4e00\u81f4\u5230\u5e95\u662f\u600e\u4e48\u5f15\u5165\u7684\uff1f</strong></p>\n<p>\u6211\u4eec\u5206\u6790\u4e00\u4e0b\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u662f\u6211\u4eec\u5047\u8bbe <code>select * from t where d=5 for update</code> \u8fd9\u6761\u8bed\u53e5\u53ea\u7ed9 d=5 \u8fd9\u4e00\u884c\uff0c\u4e5f\u5c31\u662f id=5 \u7684\u8fd9\u4e00\u884c\u52a0\u9501\u201d\u5bfc\u81f4\u7684\u3002</p>\n<p>\u6240\u4ee5\u6211\u4eec\u8ba4\u4e3a\uff0c\u4e0a\u9762\u7684\u8bbe\u5b9a\u4e0d\u5408\u7406\uff0c\u8981\u6539\u3002</p>\n<p>\u90a3\u600e\u4e48\u6539\u5462\uff1f\u6211\u4eec\u628a\u626b\u63cf\u8fc7\u7a0b\u4e2d\u78b0\u5230\u7684\u884c\uff0c\u4e5f\u90fd\u52a0\u4e0a\u5199\u9501\uff0c\u518d\u6765\u770b\u770b\u6267\u884c\u6548\u679c\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n<th>Session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>begin;<br />select * from t where d=5 fro update; /<em>Q1</em>/<br />update t set d=100 where d=5;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>update t set d=5 where id=0;<br />(blocked)<br />update t set c=5 where id=0;</td>\n<td></td>\n</tr>\n<tr>\n<td>T3</td>\n<td>select * from t where d=5 fro update; /<em>Q2</em>/</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td></td>\n<td>insert into t values(1,1,5);<br />update t set c=5 where id=1;</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>select * from t where d=5 fro update; /<em>Q3</em>/</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td>commit;</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u4e8e session A \u628a\u6240\u6709\u7684\u884c\u90fd\u52a0\u4e86\u5199\u9501\uff0c\u6240\u4ee5 session B \u5728\u6267\u884c\u7b2c\u4e00\u4e2a update \u8bed\u53e5\u7684\u65f6\u5019\u5c31\u88ab\u9501\u4f4f\u4e86\u3002\u9700\u8981\u7b49\u5230 T6 \u65f6\u523b session A \u63d0\u4ea4\u4ee5\u540e\uff0csession B \u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</p>\n<p>\u8fd9\u6837\u5bf9\u4e8e id=0 \u8fd9\u4e00\u884c\uff0c\u5728\u6570\u636e\u5e93\u91cc\u7684\u6700\u7ec8\u7ed3\u679c\u8fd8\u662f (0,5,5)\u3002\u5728 binlog \u91cc\u9762\uff0c\u6267\u884c\u5e8f\u5217\u662f\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/*(1,1,5)*/</span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(1,5,5)*/</span><span class=\"w\"> </span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"p\">;</span><span class=\"cm\">/* \u6240\u6709 d=5 \u7684\u884c\uff0cd \u6539\u6210 100*/</span><span class=\"w\"> </span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(0,0,5)*/</span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/*(0,5,5)*/</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u6309\u7167\u65e5\u5fd7\u987a\u5e8f\u6267\u884c\uff0cid=0 \u8fd9\u4e00\u884c\u7684\u6700\u7ec8\u7ed3\u679c\u4e5f\u662f (0,5,5)\u3002\u6240\u4ee5\uff0cid=0 \u8fd9\u4e00\u884c\u7684\u95ee\u9898\u89e3\u51b3\u4e86\u3002</p>\n<p>\u4f46\u540c\u65f6\u4f60\u4e5f\u53ef\u4ee5\u770b\u5230\uff0cid=1 \u8fd9\u4e00\u884c\uff0c\u5728\u6570\u636e\u5e93\u91cc\u9762\u7684\u7ed3\u679c\u662f (1,5,5)\uff0c\u800c\u6839\u636e binlog \u7684\u6267\u884c\u7ed3\u679c\u662f (1,5,100)\uff0c\u4e5f\u5c31\u662f\u8bf4\u5e7b\u8bfb\u7684\u95ee\u9898\u8fd8\u662f\u6ca1\u6709\u89e3\u51b3\u3002\u4e3a\u4ec0\u4e48\u6211\u4eec\u5df2\u7ecf\u8fd9\u4e48\u201c\u51f6\u6b8b\u201d\u5730\uff0c\u628a\u6240\u6709\u7684\u8bb0\u5f55\u90fd\u4e0a\u4e86\u9501\uff0c\u8fd8\u662f\u963b\u6b62\u4e0d\u4e86 id=1 \u8fd9\u4e00\u884c\u7684\u63d2\u5165\u548c\u66f4\u65b0\u5462\uff1f</p>\n<p>\u539f\u56e0\u5f88\u7b80\u5355\u3002\u5728 T3 \u65f6\u523b\uff0c\u6211\u4eec\u7ed9\u6240\u6709\u884c\u52a0\u9501\u7684\u65f6\u5019\uff0cid=1 \u8fd9\u4e00\u884c\u8fd8\u4e0d\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u4e5f\u5c31\u52a0\u4e0d\u4e0a\u9501\u3002</p>\n<p>**\u4e5f\u5c31\u662f\u8bf4\uff0c\u5373\u4f7f\u628a\u6240\u6709\u7684\u8bb0\u5f55\u90fd\u52a0\u4e0a\u9501\uff0c\u8fd8\u662f\u963b\u6b62\u4e0d\u4e86\u65b0\u63d2\u5165\u7684\u8bb0\u5f55\uff0c**\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u201c\u5e7b\u8bfb\u201d\u4f1a\u88ab\u5355\u72ec\u62ff\u51fa\u6765\u89e3\u51b3\u7684\u539f\u56e0\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u5176\u5b9e\u6211\u4eec\u521a\u8bf4\u660e\u5b8c\u6587\u7ae0\u7684\u6807\u9898 \uff1a\u5e7b\u8bfb\u7684\u5b9a\u4e49\u548c\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b InnoDB \u600e\u4e48\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\u3002</p>\n<h3 id=\"_3\">\u5982\u4f55\u89e3\u51b3\u5e7b\u8bfb\uff1f<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u4ea7\u751f\u5e7b\u8bfb\u7684\u539f\u56e0\u662f\uff0c\u884c\u9501\u53ea\u80fd\u9501\u4f4f\u884c\uff0c\u4f46\u662f\u65b0\u63d2\u5165\u8bb0\u5f55\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u8981\u66f4\u65b0\u7684\u662f\u8bb0\u5f55\u4e4b\u95f4\u7684\u201c\u95f4\u9699\u201d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\uff0cInnoDB \u53ea\u597d\u5f15\u5165\u65b0\u7684\u9501\uff0c\u4e5f\u5c31\u662f\u95f4\u9699\u9501 (Gap Lock)\u3002</p>\n<p>\u987e\u540d\u601d\u4e49\uff0c\u95f4\u9699\u9501\uff0c\u9501\u7684\u5c31\u662f\u4e24\u4e2a\u503c\u4e4b\u95f4\u7684\u7a7a\u9699\u3002\u6bd4\u5982\u6587\u7ae0\u5f00\u5934\u7684\u8868 t\uff0c\u521d\u59cb\u5316\u63d2\u5165\u4e86 6 \u4e2a\u8bb0\u5f55\uff0c\u8fd9\u5c31\u4ea7\u751f\u4e86 7 \u4e2a\u95f4\u9699\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/e7f7ca0d3dab2f48c588d714ee3ac861.png\" /></p>\n<p>\u56fe 5 \u8868 t \u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\u884c\u9501\u548c\u95f4\u9699\u9501</p>\n<p>\u8fd9\u6837\uff0c\u5f53\u4f60\u6267\u884c <code>select * from t where d=5 for update</code> \u7684\u65f6\u5019\uff0c\u5c31\u4e0d\u6b62\u662f\u7ed9\u6570\u636e\u5e93\u4e2d\u5df2\u6709\u7684 6 \u4e2a\u8bb0\u5f55\u52a0\u4e0a\u4e86\u884c\u9501\uff0c\u8fd8\u540c\u65f6\u52a0\u4e86 7 \u4e2a\u95f4\u9699\u9501\u3002\u8fd9\u6837\u5c31\u786e\u4fdd\u4e86\u65e0\u6cd5\u518d\u63d2\u5165\u65b0\u7684\u8bb0\u5f55\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\u8fd9\u65f6\u5019\uff0c\u5728\u4e00\u884c\u884c\u626b\u63cf\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u4ec5\u5c06\u7ed9\u884c\u52a0\u4e0a\u4e86\u884c\u9501\uff0c\u8fd8\u7ed9\u884c\u4e24\u8fb9\u7684\u7a7a\u9699\uff0c\u4e5f\u52a0\u4e0a\u4e86\u95f4\u9699\u9501\u3002</p>\n<p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u6570\u636e\u884c\u662f\u53ef\u4ee5\u52a0\u4e0a\u9501\u7684\u5b9e\u4f53\uff0c\u6570\u636e\u884c\u4e4b\u95f4\u7684\u95f4\u9699\uff0c\u4e5f\u662f\u53ef\u4ee5\u52a0\u4e0a\u9501\u7684\u5b9e\u4f53\u3002\u4f46\u662f\u95f4\u9699\u9501\u8ddf\u6211\u4eec\u4e4b\u524d\u78b0\u5230\u8fc7\u7684\u9501\u90fd\u4e0d\u592a\u4e00\u6837\u3002</p>\n<p>\u6bd4\u5982\u884c\u9501\uff0c\u5206\u6210\u8bfb\u9501\u548c\u5199\u9501\u3002\u4e0b\u56fe\u5c31\u662f\u8fd9\u4e24\u79cd\u7c7b\u578b\u884c\u9501\u7684\u51b2\u7a81\u5173\u7cfb\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>\u8bfb\u9501</th>\n<th>\u5199\u9501</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>\u8bfb\u9501</td>\n<td><font color='green'>\u517c\u5bb9</font></td>\n<td><font color='red'>\u51b2\u7a81</font></td>\n</tr>\n<tr>\n<td>\u5199\u9501</td>\n<td><font color='red'>\u51b2\u7a81</font></td>\n<td><font color='red'>\u51b2\u7a81</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8ddf\u884c\u9501\u6709\u51b2\u7a81\u5173\u7cfb\u7684\u662f\u201c\u53e6\u5916\u4e00\u4e2a\u884c\u9501\u201d\u3002</p>\n<p>\u4f46\u662f\u95f4\u9699\u9501\u4e0d\u4e00\u6837\uff0c**\u8ddf\u95f4\u9699\u9501\u5b58\u5728\u51b2\u7a81\u5173\u7cfb\u7684\uff0c\u662f\u201c\u5f80\u8fd9\u4e2a\u95f4\u9699\u4e2d\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55\u201d\u8fd9\u4e2a\u64cd\u4f5c\u3002**\u95f4\u9699\u9501\u4e4b\u95f4\u90fd\u4e0d\u5b58\u5728\u51b2\u7a81\u5173\u7cfb\u3002</p>\n<p>\u8fd9\u53e5\u8bdd\u4e0d\u592a\u597d\u7406\u89e3\uff0c\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where c=7 lock in share mode;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>begin;<br />select * from t where c = 7 for update;</td>\n</tr>\n</tbody>\n</table>\n<p>\u8fd9\u91cc session B \u5e76\u4e0d\u4f1a\u88ab\u5835\u4f4f\u3002\u56e0\u4e3a\u8868 t \u91cc\u5e76\u6ca1\u6709 c=7 \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u56e0\u6b64 session A \u52a0\u7684\u662f\u95f4\u9699\u9501 (5,10)\u3002\u800c session B \u4e5f\u662f\u5728\u8fd9\u4e2a\u95f4\u9699\u52a0\u7684\u95f4\u9699\u9501\u3002\u5b83\u4eec\u6709\u5171\u540c\u7684\u76ee\u6807\uff0c\u5373\uff1a\u4fdd\u62a4\u8fd9\u4e2a\u95f4\u9699\uff0c\u4e0d\u5141\u8bb8\u63d2\u5165\u503c\u3002\u4f46\uff0c\u5b83\u4eec\u4e4b\u95f4\u662f\u4e0d\u51b2\u7a81\u7684\u3002</p>\n<p>\u95f4\u9699\u9501\u548c\u884c\u9501\u5408\u79f0 next-key lock\uff0c\u6bcf\u4e2a next-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u7684\u8868 t \u521d\u59cb\u5316\u4ee5\u540e\uff0c\u5982\u679c\u7528 <code>select * from t for update</code> \u8981\u628a\u6574\u4e2a\u8868\u6240\u6709\u8bb0\u5f55\u9501\u8d77\u6765\uff0c\u5c31\u5f62\u6210\u4e86 7 \u4e2a next-key lock\uff0c\u5206\u522b\u662f <code>(-\u221e,0]\u3001(0,5]\u3001(5,10]\u3001(10,15]\u3001(15,20]\u3001(20, 25]\u3001(25, +supremum]</code>\u3002</p>\n<blockquote>\n<p>\u5907\u6ce8\uff1a\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u6211\u4eec\u628a\u95f4\u9699\u9501\u8bb0\u4e3a\u5f00\u533a\u95f4\uff0c\u628a next-key lock \u8bb0\u4e3a\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</p>\n</blockquote>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\u8bf4\uff0c\u8fd9\u4e2a supremum \u4ece\u54ea\u513f\u6765\u7684\u5462\uff1f</p>\n<p>\u8fd9\u662f\u56e0\u4e3a <code>+\u221e</code> \u662f\u5f00\u533a\u95f4\u3002\u5b9e\u73b0\u4e0a\uff0cInnoDB \u7ed9\u6bcf\u4e2a\u7d22\u5f15\u52a0\u4e86\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u6700\u5927\u503c supremum\uff0c\u8fd9\u6837\u624d\u7b26\u5408\u6211\u4eec\u524d\u9762\u8bf4\u7684\u201c\u90fd\u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u201d\u3002</p>\n<p><strong>\u95f4\u9699\u9501\u548c next-key lock \u7684\u5f15\u5165\uff0c\u5e2e\u6211\u4eec\u89e3\u51b3\u4e86\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u4f46\u540c\u65f6\u4e5f\u5e26\u6765\u4e86\u4e00\u4e9b\u201c\u56f0\u6270\u201d\u3002</strong></p>\n<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u5c31\u6709\u540c\u5b66\u63d0\u5230\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002\u6211\u628a\u4ed6\u7684\u95ee\u9898\u8f6c\u8ff0\u4e00\u4e0b\uff0c\u5bf9\u5e94\u5230\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u7684\u8868\u6765\u8bf4\uff0c\u4e1a\u52a1\u903b\u8f91\u8fd9\u6837\u7684\uff1a\u4efb\u610f\u9501\u4f4f\u4e00\u884c\uff0c\u5982\u679c\u8fd9\u4e00\u884c\u4e0d\u5b58\u5728\u7684\u8bdd\u5c31\u63d2\u5165\uff0c\u5982\u679c\u5b58\u5728\u8fd9\u4e00\u884c\u5c31\u66f4\u65b0\u5b83\u7684\u6570\u636e\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* \u5982\u679c\u884c\u4e0d\u5b58\u5728 */</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"n\">N</span><span class=\"p\">);</span>\n<span class=\"cm\">/* \u5982\u679c\u884c\u5b58\u5728 */</span>\n<span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u53ef\u80fd\u4f60\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u4e0d\u662f <code>insert \u2026 on duplicate key update</code> \u5c31\u80fd\u89e3\u51b3\u5417\uff1f\u4f46\u5176\u5b9e\u5728\u6709\u591a\u4e2a\u552f\u4e00\u952e\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e0d\u80fd\u6ee1\u8db3\u8fd9\u4f4d\u63d0\u95ee\u540c\u5b66\u7684\u9700\u6c42\u7684\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u518d\u5c55\u5f00\u8bf4\u660e\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u53ea\u8ba8\u8bba\u8fd9\u4e2a\u903b\u8f91\u3002</p>\n<p>\u8fd9\u4e2a\u540c\u5b66\u78b0\u5230\u7684\u73b0\u8c61\u662f\uff0c\u8fd9\u4e2a\u903b\u8f91\u4e00\u65e6\u6709\u5e76\u53d1\uff0c\u5c31\u4f1a\u78b0\u5230\u6b7b\u9501\u3002\u4f60\u4e00\u5b9a\u4e5f\u89c9\u5f97\u5947\u602a\uff0c\u8fd9\u4e2a\u903b\u8f91\u6bcf\u6b21\u64cd\u4f5c\u524d\u7528 for update \u9501\u8d77\u6765\uff0c\u5df2\u7ecf\u662f\u6700\u4e25\u683c\u7684\u6a21\u5f0f\u4e86\uff0c\u600e\u4e48\u8fd8\u4f1a\u6709\u6b7b\u9501\u5462\uff1f</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u7528\u4e24\u4e2a session \u6765\u6a21\u62df\u5e76\u53d1\uff0c\u5e76\u5047\u8bbe N=9\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where id=9 for update;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>begin;<br />select * from t where id=9 for update;</td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(9,9,9);<br /><font color='red'>(blocked)</font></td>\n</tr>\n<tr>\n<td>insert into t values(9,9,9);<br /><font color='red'>(Error 1213(40001): Deadlock found)</font></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>\u4f60\u770b\u5230\u4e86\uff0c\u5176\u5b9e\u90fd\u4e0d\u9700\u8981\u7528\u5230\u540e\u9762\u7684 update \u8bed\u53e5\uff0c\u5c31\u5df2\u7ecf\u5f62\u6210\u6b7b\u9501\u4e86\u3002\u6211\u4eec\u6309\u8bed\u53e5\u6267\u884c\u987a\u5e8f\u6765\u5206\u6790\u4e00\u4e0b\uff1a</p>\n<ol>\n<li>session A \u6267\u884c <code>select \u2026 for update</code> \u8bed\u53e5\uff0c\u7531\u4e8e id=9 \u8fd9\u4e00\u884c\u5e76\u4e0d\u5b58\u5728\uff0c\u56e0\u6b64\u4f1a\u52a0\u4e0a\u95f4\u9699\u9501 (5,10);</li>\n<li>session B \u6267\u884c <code>select \u2026 for update</code> \u8bed\u53e5\uff0c\u540c\u6837\u4f1a\u52a0\u4e0a\u95f4\u9699\u9501 (5,10)\uff0c\u95f4\u9699\u9501\u4e4b\u95f4\u4e0d\u4f1a\u51b2\u7a81\uff0c\u56e0\u6b64\u8fd9\u4e2a\u8bed\u53e5\u53ef\u4ee5\u6267\u884c\u6210\u529f\uff1b</li>\n<li>session B \u8bd5\u56fe\u63d2\u5165\u4e00\u884c (9,9,9)\uff0c\u88ab session A \u7684\u95f4\u9699\u9501\u6321\u4f4f\u4e86\uff0c\u53ea\u597d\u8fdb\u5165\u7b49\u5f85\uff1b</li>\n<li>session A \u8bd5\u56fe\u63d2\u5165\u4e00\u884c (9,9,9)\uff0c\u88ab session B \u7684\u95f4\u9699\u9501\u6321\u4f4f\u4e86\u3002</li>\n</ol>\n<p>\u81f3\u6b64\uff0c\u4e24\u4e2a session \u8fdb\u5165\u4e92\u76f8\u7b49\u5f85\u72b6\u6001\uff0c\u5f62\u6210\u6b7b\u9501\u3002\u5f53\u7136\uff0cInnoDB \u7684\u6b7b\u9501\u68c0\u6d4b\u9a6c\u4e0a\u5c31\u53d1\u73b0\u4e86\u8fd9\u5bf9\u6b7b\u9501\u5173\u7cfb\uff0c\u8ba9 session A \u7684 insert \u8bed\u53e5\u62a5\u9519\u8fd4\u56de\u4e86\u3002</p>\n<p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c<strong>\u95f4\u9699\u9501\u7684\u5f15\u5165\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u540c\u6837\u7684\u8bed\u53e5\u9501\u4f4f\u66f4\u5927\u7684\u8303\u56f4\uff0c\u8fd9\u5176\u5b9e\u662f\u5f71\u54cd\u4e86\u5e76\u53d1\u5ea6\u7684</strong>\u3002\u5176\u5b9e\uff0c\u8fd9\u8fd8\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u8fd8\u4f1a\u78b0\u5230\u66f4\u591a\u3001\u66f4\u590d\u6742\u7684\u4f8b\u5b50\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u4e3a\u4e86\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u6211\u4eec\u5f15\u5165\u4e86\u8fd9\u4e48\u4e00\u5927\u4e32\u5185\u5bb9\uff0c\u6709\u6ca1\u6709\u66f4\u7b80\u5355\u4e00\u70b9\u7684\u5904\u7406\u65b9\u6cd5\u5462\u3002</p>\n<p>\u6211\u5728\u6587\u7ae0\u4e00\u5f00\u59cb\u5c31\u8bf4\u8fc7\uff0c\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u4eca\u5929\u548c\u4f60\u5206\u6790\u7684\u95ee\u9898\u90fd\u662f\u5728 <strong>\u53ef\u91cd\u590d\u8bfb</strong> \u9694\u79bb\u7ea7\u522b\u4e0b\u7684\uff0c\u95f4\u9699\u9501\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u624d\u4f1a\u751f\u6548\u7684\u3002\u6240\u4ee5\uff0c\u4f60\u5982\u679c\u628a\u9694\u79bb\u7ea7\u522b\u8bbe\u7f6e\u4e3a **\u8bfb\u5df2\u63d0\u4ea4**\u7684\u8bdd\uff0c\u5c31\u6ca1\u6709\u95f4\u9699\u9501\u4e86\u3002\u4f46\u540c\u65f6\uff0c\u4f60\u8981\u89e3\u51b3\u53ef\u80fd\u51fa\u73b0\u7684\u6570\u636e\u548c\u65e5\u5fd7\u4e0d\u4e00\u81f4\u95ee\u9898\uff0c\u9700\u8981\u628a binlog \u683c\u5f0f\u8bbe\u7f6e\u4e3a row\u3002\u8fd9\uff0c\u4e5f\u662f\u73b0\u5728\u4e0d\u5c11\u516c\u53f8\u4f7f\u7528\u7684\u914d\u7f6e\u7ec4\u5408\u3002</p>\n<p>\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u7559\u8a00\u8bf4\uff0c\u4ed6\u4eec\u516c\u53f8\u5c31\u4f7f\u7528\u7684\u662f\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u52a0 <code>binlog_format=row</code> \u7684\u7ec4\u5408\u3002\u4ed6\u66fe\u95ee\u4ed6\u4eec\u516c\u53f8\u7684 DBA \u8bf4\uff0c\u4f60\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u914d\u7f6e\u3002DBA \u76f4\u63a5\u7b54\u590d\u8bf4\uff0c\u56e0\u4e3a\u5927\u5bb6\u90fd\u8fd9\u4e48\u7528\u5440\u3002</p>\n<p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u5c31\u95ee\u8bf4\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5230\u5e95\u5408\u4e0d\u5408\u7406\u3002</p>\n<p>\u5173\u4e8e\u8fd9\u4e2a\u95ee\u9898\u672c\u8eab\u7684\u7b54\u6848\u662f\uff0c\u5982\u679c\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u591f\u7528\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e1a\u52a1\u4e0d\u9700\u8981\u53ef\u91cd\u590d\u8bfb\u7684\u4fdd\u8bc1\uff0c\u8fd9\u6837\u8003\u8651\u5230\u8bfb\u63d0\u4ea4\u4e0b\u64cd\u4f5c\u6570\u636e\u7684\u9501\u8303\u56f4\u66f4\u5c0f\uff08\u6ca1\u6709\u95f4\u9699\u9501\uff09\uff0c\u8fd9\u4e2a\u9009\u62e9\u662f\u5408\u7406\u7684\u3002</p>\n<p>\u4f46\u5176\u5b9e\u6211\u60f3\u8bf4\u7684\u662f\uff0c\u914d\u7f6e\u662f\u5426\u5408\u7406\uff0c\u8ddf\u4e1a\u52a1\u573a\u666f\u6709\u5173\uff0c\u9700\u8981\u5177\u4f53\u95ee\u9898\u5177\u4f53\u5206\u6790\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c DBA \u8ba4\u4e3a\u4e4b\u6240\u4ee5\u8fd9\u4e48\u7528\u7684\u539f\u56e0\u662f\u201c\u5927\u5bb6\u90fd\u8fd9\u4e48\u7528\u201d\uff0c\u90a3\u5c31\u6709\u95ee\u9898\u4e86\uff0c\u6216\u8005\u8bf4\uff0c\u8fdf\u65e9\u4f1a\u51fa\u95ee\u9898\u3002</p>\n<p>\u6bd4\u5982\u8bf4\uff0c\u5927\u5bb6\u90fd\u7528\u8bfb\u63d0\u4ea4\uff0c\u53ef\u662f\u903b\u8f91\u5907\u4efd\u7684\u65f6\u5019\uff0cmysqldump \u4e3a\u4ec0\u4e48\u8981\u628a\u5907\u4efd\u7ebf\u7a0b\u8bbe\u7f6e\u6210\u53ef\u91cd\u590d\u8bfb\u5462\uff1f\uff08\u8fd9\u4e2a\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u5df2\u7ecf\u89e3\u91ca\u8fc7\u4e86\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e0b\u7b2c 6 \u7bc7\u6587\u7ae0[\u300a\u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u6709\u8fd9\u4e48\u591a\u963b\u788d\uff1f\u300b]\u7684\u5185\u5bb9\uff09</p>\n<p>\u7136\u540e\uff0c\u5728\u5907\u4efd\u671f\u95f4\uff0c\u5907\u4efd\u7ebf\u7a0b\u7528\u7684\u662f\u53ef\u91cd\u590d\u8bfb\uff0c\u800c\u4e1a\u52a1\u7ebf\u7a0b\u7528\u7684\u662f\u8bfb\u63d0\u4ea4\u3002\u540c\u65f6\u5b58\u5728\u4e24\u79cd\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff0c\u4f1a\u4e0d\u4f1a\u6709\u95ee\u9898\uff1f</p>\n<p>\u8fdb\u4e00\u6b65\u5730\uff0c\u8fd9\u4e24\u4e2a\u4e0d\u540c\u7684\u9694\u79bb\u7ea7\u522b\u73b0\u8c61\u6709\u4ec0\u4e48\u4e0d\u4e00\u6837\u7684\uff0c\u5173\u4e8e\u6211\u4eec\u7684\u4e1a\u52a1\uff0c\u201c\u7528\u8bfb\u63d0\u4ea4\u5c31\u591f\u4e86\u201d\u8fd9\u4e2a\u7ed3\u8bba\u662f\u600e\u4e48\u5f97\u5230\u7684\uff1f</p>\n<p>\u5982\u679c\u4e1a\u52a1\u5f00\u53d1\u548c\u8fd0\u7ef4\u56e2\u961f\u8fd9\u4e9b\u95ee\u9898\u90fd\u6ca1\u6709\u5f04\u6e05\u695a\uff0c\u90a3\u4e48\u201c\u6ca1\u95ee\u9898\u201d\u8fd9\u4e2a\u7ed3\u8bba\uff0c\u672c\u8eab\u5c31\u662f\u6709\u95ee\u9898\u7684\u3002</p>\n<h3 id=\"_4\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u6211\u4eec\u4ece\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684\u8bfe\u540e\u95ee\u9898\u8bf4\u8d77\uff0c\u63d0\u5230\u4e86\u5168\u8868\u626b\u63cf\u7684\u52a0\u9501\u65b9\u5f0f\u3002\u6211\u4eec\u53d1\u73b0\u5373\u4f7f\u7ed9\u6240\u6709\u7684\u884c\u90fd\u52a0\u4e0a\u884c\u9501\uff0c\u4ecd\u7136\u65e0\u6cd5\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\uff0c\u56e0\u6b64\u5f15\u5165\u4e86\u95f4\u9699\u9501\u7684\u6982\u5ff5\u3002</p>\n<p>\u6211\u78b0\u5230\u8fc7\u5f88\u591a\u5bf9\u6570\u636e\u5e93\u6709\u4e00\u5b9a\u4e86\u89e3\u7684\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\uff0c\u4ed6\u4eec\u5728\u8bbe\u8ba1\u6570\u636e\u8868\u7ed3\u6784\u548c\u4e1a\u52a1 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5bf9\u884c\u9501\u6709\u5f88\u51c6\u786e\u7684\u8ba4\u8bc6\uff0c\u4f46\u5374\u5f88\u5c11\u8003\u8651\u5230\u95f4\u9699\u9501\u3002\u6700\u540e\u7684\u7ed3\u679c\uff0c\u5c31\u662f\u751f\u4ea7\u5e93\u4e0a\u4f1a\u7ecf\u5e38\u51fa\u73b0\u7531\u4e8e\u95f4\u9699\u9501\u5bfc\u81f4\u7684\u6b7b\u9501\u73b0\u8c61\u3002</p>\n<p>\u884c\u9501\u786e\u5b9e\u6bd4\u8f83\u76f4\u89c2\uff0c\u5224\u65ad\u89c4\u5219\u4e5f\u76f8\u5bf9\u7b80\u5355\uff0c\u95f4\u9699\u9501\u7684\u5f15\u5165\u4f1a\u5f71\u54cd\u7cfb\u7edf\u7684\u5e76\u53d1\u5ea6\uff0c\u4e5f\u589e\u52a0\u4e86\u9501\u5206\u6790\u7684\u590d\u6742\u5ea6\uff0c\u4f46\u4e5f\u6709\u7ae0\u53ef\u5faa\u3002\u4e0b\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u4f1a\u4e3a\u4f60\u8bb2\u89e3 InnoDB \u7684\u52a0\u9501\u89c4\u5219\uff0c\u5e2e\u4f60\u7406\u987a\u8fd9\u5176\u4e2d\u7684\u201c\u7ae0\u6cd5\u201d\u3002</p>\n<p>\u4f5c\u4e3a\u5bf9\u4e0b\u4e00\u7bc7\u6587\u7ae0\u7684\u9884\u4e60\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where c&gt;=15 <br />and c&lt;=20 order by c desc for update;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(11,11,11)</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>insert into t values(6,6,6);</td>\n</tr>\n</tbody>\n</table>\n<p>\u5982\u679c\u4f60\u4e4b\u524d\u6ca1\u6709\u4e86\u89e3\u8fc7\u672c\u7bc7\u6587\u7ae0\u7684\u76f8\u5173\u5185\u5bb9\uff0c\u4e00\u5b9a\u89c9\u5f97\u8fd9\u4e09\u4e2a\u8bed\u53e5\u7b80\u76f4\u662f\u98ce\u9a6c\u725b\u4e0d\u76f8\u53ca\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u91cc session B \u548c session C \u7684 insert \u8bed\u53e5\u90fd\u4f1a\u8fdb\u5165\u9501\u7b49\u5f85\u72b6\u6001\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u8bd5\u7740\u5206\u6790\u4e00\u4e0b\uff0c\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u539f\u56e0\u662f\u4ec0\u4e48\uff1f</p>\n<h2 id=\"21\">21 \u4e3a\u4ec0\u4e48\u6211\u53ea\u6539\u4e00\u884c\u7684\u8bed\u53e5\uff0c\u9501\u8fd9\u4e48\u591a\uff1f<a class=\"headerlink\" href=\"#21\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u95f4\u9699\u9501\u548c next-key lock \u7684\u6982\u5ff5\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u8bf4\u660e\u52a0\u9501\u89c4\u5219\u3002\u95f4\u9699\u9501\u7684\u6982\u5ff5\u7406\u89e3\u8d77\u6765\u786e\u5b9e\u6709\u70b9\u513f\u96be\uff0c\u5c24\u5176\u5728\u914d\u5408\u4e0a\u884c\u9501\u4ee5\u540e\uff0c\u5f88\u5bb9\u6613\u5728\u5224\u65ad\u662f\u5426\u4f1a\u51fa\u73b0\u9501\u7b49\u5f85\u7684\u95ee\u9898\u4e0a\u72af\u9519\u3002</p>\n<p>\u6240\u4ee5\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u5148\u4ece\u8fd9\u4e2a\u52a0\u9501\u89c4\u5219\u5f00\u59cb\u5427\u3002</p>\n<p>\u9996\u5148\u8bf4\u660e\u4e00\u4e0b\uff0c\u8fd9\u4e9b\u52a0\u9501\u89c4\u5219\u6211\u6ca1\u5728\u522b\u7684\u5730\u65b9\u770b\u5230\u8fc7\u6709\u7c7b\u4f3c\u7684\u603b\u7ed3\uff0c\u4ee5\u524d\u6211\u81ea\u5df1\u5224\u65ad\u7684\u65f6\u5019\u90fd\u662f\u60f3\u7740\u4ee3\u7801\u91cc\u9762\u7684\u5b9e\u73b0\u6765\u8111\u8865\u7684\u3002\u8fd9\u6b21\u4e3a\u4e86\u603b\u7ed3\u6210\u4e0d\u770b\u4ee3\u7801\u7684\u540c\u5b66\u4e5f\u80fd\u7406\u89e3\u7684\u89c4\u5219\uff0c\u662f\u6211\u53c8\u91cd\u65b0\u5237\u4e86\u4ee3\u7801\u4e34\u65f6\u603b\u7ed3\u51fa\u6765\u7684\u3002\u6240\u4ee5\uff0c<strong>\u8fd9\u4e2a\u89c4\u5219\u6709\u4ee5\u4e0b\u4e24\u6761\u524d\u63d0\u8bf4\u660e\uff1a</strong></p>\n<ol>\n<li>MySQL \u540e\u9762\u7684\u7248\u672c\u53ef\u80fd\u4f1a\u6539\u53d8\u52a0\u9501\u7b56\u7565\uff0c\u6240\u4ee5\u8fd9\u4e2a\u89c4\u5219\u53ea\u9650\u4e8e\u622a\u6b62\u5230\u73b0\u5728\u7684\u6700\u65b0\u7248\u672c\uff0c\u5373 5.x \u7cfb\u5217 \\&lt;=5.7.24\uff0c8.0 \u7cfb\u5217 \\&lt;=8.0.13\u3002</li>\n<li>\u5982\u679c\u5927\u5bb6\u5728\u9a8c\u8bc1\u4e2d\u6709\u53d1\u73b0 bad case \u7684\u8bdd\uff0c\u8bf7\u63d0\u51fa\u6765\uff0c\u6211\u4f1a\u518d\u8865\u5145\u8fdb\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4f7f\u5f97\u4e00\u8d77\u5b66\u4e60\u672c\u4e13\u680f\u7684\u6240\u6709\u540c\u5b66\u90fd\u80fd\u53d7\u76ca\u3002</li>\n</ol>\n<p>\u56e0\u4e3a\u95f4\u9699\u9501\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u624d\u6709\u6548\uff0c\u6240\u4ee5\u672c\u7bc7\u6587\u7ae0\u63a5\u4e0b\u6765\u7684\u63cf\u8ff0\uff0c\u82e5\u6ca1\u6709\u7279\u6b8a\u8bf4\u660e\uff0c\u9ed8\u8ba4\u662f\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u3002</p>\n<p><strong>\u6211\u603b\u7ed3\u7684\u52a0\u9501\u89c4\u5219\u91cc\u9762\uff0c\u5305\u542b\u4e86\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\u3002</strong></p>\n<ol>\n<li>\u539f\u5219 1\uff1a\u52a0\u9501\u7684\u57fa\u672c\u5355\u4f4d\u662f next-key lock\u3002\u5e0c\u671b\u4f60\u8fd8\u8bb0\u5f97\uff0cnext-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</li>\n<li>\u539f\u5219 2\uff1a\u67e5\u627e\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501\u3002</li>\n<li>\u4f18\u5316 1\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u7ed9\u552f\u4e00\u7d22\u5f15\u52a0\u9501\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u884c\u9501\u3002</li>\n<li>\u4f18\u5316 2\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u65f6\u4e14\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3\u7b49\u503c\u6761\u4ef6\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u95f4\u9699\u9501\u3002</li>\n<li>\u4e00\u4e2a bug\uff1a\u552f\u4e00\u7d22\u5f15\u4e0a\u7684\u8303\u56f4\u67e5\u8be2\u4f1a\u8bbf\u95ee\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u503c\u4e3a\u6b62\u3002</li>\n</ol>\n<p>\u6211\u8fd8\u662f\u4ee5\u4e0a\u7bc7\u6587\u7ae0\u7684\u8868 t \u4e3a\u4f8b\uff0c\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u8fd9\u4e9b\u89c4\u5219\u3002\u8868 t \u7684\u5efa\u8868\u8bed\u53e5\u548c\u521d\u59cb\u5316\u8bed\u53e5\u5982\u4e0b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">),(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">),</span>\n<span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">),(</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">),(</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">),(</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\u7684\u4f8b\u5b50\u57fa\u672c\u90fd\u662f\u914d\u5408\u7740\u56fe\u7247\u8bf4\u660e\u7684\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\u53ef\u4ee5\u5bf9\u7167\u7740\u6587\u7a3f\u770b\uff0c\u6709\u4e9b\u4f8b\u5b50\u53ef\u80fd\u4f1a\u201c\u6bc1\u4e09\u89c2\u201d\uff0c\u4e5f\u5efa\u8bae\u4f60\u8bfb\u5b8c\u6587\u7ae0\u540e\u4eb2\u624b\u5b9e\u8df5\u4e00\u4e0b\u3002</p>\n<h3 id=\"_5\">\u6848\u4f8b\u4e00\uff1a\u7b49\u503c\u67e5\u8be2\u95f4\u9699\u9501<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u7b49\u503c\u6761\u4ef6\u64cd\u4f5c\u95f4\u9699\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />update t set d = d + 1 where id =7;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(8,8,8);<br /><font color='red'>(blocked)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>update t set d=d+1 where id=10;<br /><font color='green'>(Query OK)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u4e8e\u8868 t \u4e2d\u6ca1\u6709 id=7 \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u7528\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u52a0\u9501\u89c4\u5219\u5224\u65ad\u4e00\u4e0b\u7684\u8bdd\uff1a</p>\n<ol>\n<li>\u6839\u636e\u539f\u5219 1\uff0c\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0csession A \u52a0\u9501\u8303\u56f4\u5c31\u662f (5,10]\uff1b</li>\n<li>\u540c\u65f6\u6839\u636e\u4f18\u5316 2\uff0c\u8fd9\u662f\u4e00\u4e2a\u7b49\u503c\u67e5\u8be2 (id=7)\uff0c\u800c id=10 \u4e0d\u6ee1\u8db3\u67e5\u8be2\u6761\u4ef6\uff0cnext-key lock \u9000\u5316\u6210\u95f4\u9699\u9501\uff0c\u56e0\u6b64\u6700\u7ec8\u52a0\u9501\u7684\u8303\u56f4\u662f (5,10)\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0csession B \u8981\u5f80\u8fd9\u4e2a\u95f4\u9699\u91cc\u9762\u63d2\u5165 id=8 \u7684\u8bb0\u5f55\u4f1a\u88ab\u9501\u4f4f\uff0c\u4f46\u662f session C \u4fee\u6539 id=10 \u8fd9\u884c\u662f\u53ef\u4ee5\u7684\u3002</p>\n<h3 id=\"_6\">\u6848\u4f8b\u4e8c\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u7b49\u503c\u9501<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u8986\u76d6\u7d22\u5f15\u4e0a\u7684\u9501\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select id from t where c=5 lock in share mode;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>update t set d=d+1 where id=5;<br /><font color='green'>(Query OK)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>insert into t values(7,7,7);<br /><font color='red'>(blocked)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u770b\u5230\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u4f60\u662f\u4e0d\u662f\u6709\u4e00\u79cd\u201c\u8be5\u9501\u7684\u4e0d\u9501\uff0c\u4e0d\u8be5\u9501\u7684\u4e71\u9501\u201d\u7684\u611f\u89c9\uff1f\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u5427\u3002</p>\n<p>\u8fd9\u91cc session A \u8981\u7ed9\u7d22\u5f15 c \u4e0a c=5 \u7684\u8fd9\u4e00\u884c\u52a0\u4e0a\u8bfb\u9501\u3002</p>\n<ol>\n<li>\u6839\u636e\u539f\u5219 1\uff0c\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0c\u56e0\u6b64\u4f1a\u7ed9 (0,5] \u52a0\u4e0a next-key lock\u3002</li>\n<li>\u8981\u6ce8\u610f c \u662f\u666e\u901a\u7d22\u5f15\uff0c\u56e0\u6b64\u4ec5\u8bbf\u95ee c=5 \u8fd9\u4e00\u6761\u8bb0\u5f55\u662f\u4e0d\u80fd\u9a6c\u4e0a\u505c\u4e0b\u6765\u7684\uff0c\u9700\u8981\u5411\u53f3\u904d\u5386\uff0c\u67e5\u5230 c=10 \u624d\u653e\u5f03\u3002\u6839\u636e\u539f\u5219 2\uff0c\u8bbf\u95ee\u5230\u7684\u90fd\u8981\u52a0\u9501\uff0c\u56e0\u6b64\u8981\u7ed9 (5,10] \u52a0 next-key lock\u3002</li>\n<li>\u4f46\u662f\u540c\u65f6\u8fd9\u4e2a\u7b26\u5408\u4f18\u5316 2\uff1a\u7b49\u503c\u5224\u65ad\uff0c\u5411\u53f3\u904d\u5386\uff0c\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3 c=5 \u8fd9\u4e2a\u7b49\u503c\u6761\u4ef6\uff0c\u56e0\u6b64\u9000\u5316\u6210\u95f4\u9699\u9501 (5,10)\u3002</li>\n<li>\u6839\u636e\u539f\u5219 2 \uff0c<strong>\u53ea\u6709\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501</strong>\uff0c\u8fd9\u4e2a\u67e5\u8be2\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\uff0c\u5e76\u4e0d\u9700\u8981\u8bbf\u95ee\u4e3b\u952e\u7d22\u5f15\uff0c\u6240\u4ee5\u4e3b\u952e\u7d22\u5f15\u4e0a\u6ca1\u6709\u52a0\u4efb\u4f55\u9501\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 session B \u7684 update \u8bed\u53e5\u53ef\u4ee5\u6267\u884c\u5b8c\u6210\u3002</li>\n</ol>\n<p>\u4f46 session C \u8981\u63d2\u5165\u4e00\u4e2a (7,7,7) \u7684\u8bb0\u5f55\uff0c\u5c31\u4f1a\u88ab session A \u7684\u95f4\u9699\u9501 (5,10) \u9501\u4f4f\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0clock in share mode \u53ea\u9501\u8986\u76d6\u7d22\u5f15\uff0c\u4f46\u662f\u5982\u679c\u662f for update \u5c31\u4e0d\u4e00\u6837\u4e86\u3002 \u6267\u884c for update \u65f6\uff0c\u7cfb\u7edf\u4f1a\u8ba4\u4e3a\u4f60\u63a5\u4e0b\u6765\u8981\u66f4\u65b0\u6570\u636e\uff0c\u56e0\u6b64\u4f1a\u987a\u4fbf\u7ed9\u4e3b\u952e\u7d22\u5f15\u4e0a\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u52a0\u4e0a\u884c\u9501\u3002</p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\uff0c\u9501\u662f\u52a0\u5728\u7d22\u5f15\u4e0a\u7684\uff1b\u540c\u65f6\uff0c\u5b83\u7ed9\u6211\u4eec\u7684\u6307\u5bfc\u662f\uff0c\u5982\u679c\u4f60\u8981\u7528 lock in share mode \u6765\u7ed9\u884c\u52a0\u8bfb\u9501\u907f\u514d\u6570\u636e\u88ab\u66f4\u65b0\u7684\u8bdd\uff0c\u5c31\u5fc5\u987b\u5f97\u7ed5\u8fc7\u8986\u76d6\u7d22\u5f15\u7684\u4f18\u5316\uff0c\u5728\u67e5\u8be2\u5b57\u6bb5\u4e2d\u52a0\u5165\u7d22\u5f15\u4e2d\u4e0d\u5b58\u5728\u7684\u5b57\u6bb5\u3002\u6bd4\u5982\uff0c\u5c06 session A \u7684\u67e5\u8be2\u8bed\u53e5\u6539\u6210 <code>select d from t where c=5 lock in share mode</code>\u3002\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u6548\u679c\u3002</p>\n<h3 id=\"_7\">\u6848\u4f8b\u4e09\uff1a\u4e3b\u952e\u7d22\u5f15\u8303\u56f4\u9501<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e09\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u8303\u56f4\u67e5\u8be2\u7684\u3002</p>\n<p>\u4e3e\u4f8b\u4e4b\u524d\uff0c\u4f60\u53ef\u4ee5\u5148\u601d\u8003\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a\u5bf9\u4e8e\u6211\u4eec\u8fd9\u4e2a\u8868 t\uff0c\u4e0b\u9762\u8fd9\u4e24\u6761\u67e5\u8be2\u8bed\u53e5\uff0c\u52a0\u9501\u8303\u56f4\u76f8\u540c\u5417\uff1f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&gt;=</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&lt;</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0cid \u5b9a\u4e49\u4e3a int \u7c7b\u578b\uff0c\u8fd9\u4e24\u4e2a\u8bed\u53e5\u5c31\u662f\u7b49\u4ef7\u7684\u5427\uff1f\u5176\u5b9e\uff0c\u5b83\u4eec\u5e76\u4e0d\u5b8c\u5168\u7b49\u4ef7\u3002</p>\n<p>\u5728\u903b\u8f91\u4e0a\uff0c\u8fd9\u4e24\u6761\u67e5\u8bed\u53e5\u80af\u5b9a\u662f\u7b49\u4ef7\u7684\uff0c\u4f46\u662f\u5b83\u4eec\u7684\u52a0\u9501\u89c4\u5219\u4e0d\u592a\u4e00\u6837\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u8ba9 session A \u6267\u884c\u7b2c\u4e8c\u4e2a\u67e5\u8be2\u8bed\u53e5\uff0c\u6765\u770b\u770b\u52a0\u9501\u6548\u679c\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where id&gt;=10 and id&lt;11 for update;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(8,8,8);<br /><font color='green'>(Query OK)</font><br />insert into t values(13,13,13);<br /><font color='red'>(blocked)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>update t set d =d+1 where id=15;<br /><font color='red'>(blocked)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u73b0\u5728\u6211\u4eec\u5c31\u7528\u524d\u9762\u63d0\u5230\u7684\u52a0\u9501\u89c4\u5219\uff0c\u6765\u5206\u6790\u4e00\u4e0b session A \u4f1a\u52a0\u4ec0\u4e48\u9501\u5462\uff1f</p>\n<ol>\n<li>\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u627e\u5230\u7b2c\u4e00\u4e2a id=10 \u7684\u884c\uff0c\u56e0\u6b64\u672c\u8be5\u662f next-key lock(5,10]\u3002 \u6839\u636e\u4f18\u5316 1\uff0c \u4e3b\u952e id \u4e0a\u7684\u7b49\u503c\u6761\u4ef6\uff0c\u9000\u5316\u6210\u884c\u9501\uff0c\u53ea\u52a0\u4e86 id=10 \u8fd9\u4e00\u884c\u7684\u884c\u9501\u3002</li>\n<li>\u8303\u56f4\u67e5\u627e\u5c31\u5f80\u540e\u7ee7\u7eed\u627e\uff0c\u627e\u5230 id=15 \u8fd9\u4e00\u884c\u505c\u4e0b\u6765\uff0c\u56e0\u6b64\u9700\u8981\u52a0 next-key lock(10,15]\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0csession A \u8fd9\u65f6\u5019\u9501\u7684\u8303\u56f4\u5c31\u662f\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u884c\u9501 id=10 \u548c next-key lock(10,15]\u3002\u8fd9\u6837\uff0csession B \u548c session C \u7684\u7ed3\u679c\u4f60\u5c31\u80fd\u7406\u89e3\u4e86\u3002</p>\n<p>\u8fd9\u91cc\u4f60\u9700\u8981\u6ce8\u610f\u4e00\u70b9\uff0c\u9996\u6b21 session A \u5b9a\u4f4d\u67e5\u627e id=10 \u7684\u884c\u7684\u65f6\u5019\uff0c\u662f\u5f53\u505a\u7b49\u503c\u67e5\u8be2\u6765\u5224\u65ad\u7684\uff0c\u800c\u5411\u53f3\u626b\u63cf\u5230 id=15 \u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u8303\u56f4\u67e5\u8be2\u5224\u65ad\u3002</p>\n<h3 id=\"_8\">\u6848\u4f8b\u56db\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u8303\u56f4\u9501<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e24\u4e2a\u8303\u56f4\u67e5\u8be2\u52a0\u9501\u7684\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u5bf9\u7167\u7740\u6848\u4f8b\u4e09\u6765\u770b\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0e\u6848\u4f8b\u4e09\u4e0d\u540c\u7684\u662f\uff0c\u6848\u4f8b\u56db\u4e2d\u67e5\u8be2\u8bed\u53e5\u7684 where \u90e8\u5206\u7528\u7684\u662f\u5b57\u6bb5 c\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where c&gt;=10 and c&lt;11 for update;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(8,8,8);<br /><font color='red'>(blocked)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>update t set d =d+1 where c=15;<br /><font color='red'>(blocked)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u8fd9\u6b21 session A \u7528\u5b57\u6bb5 c \u6765\u5224\u65ad\uff0c\u52a0\u9501\u89c4\u5219\u8ddf\u6848\u4f8b\u4e09\u552f\u4e00\u7684\u4e0d\u540c\u662f\uff1a\u5728\u7b2c\u4e00\u6b21\u7528 c=10 \u5b9a\u4f4d\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u7d22\u5f15 c \u4e0a\u52a0\u4e86 (5,10] \u8fd9\u4e2a next-key lock \u540e\uff0c\u7531\u4e8e\u7d22\u5f15 c \u662f\u975e\u552f\u4e00\u7d22\u5f15\uff0c\u6ca1\u6709\u4f18\u5316\u89c4\u5219\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e0d\u4f1a\u8715\u53d8\u4e3a\u884c\u9501\uff0c\u56e0\u6b64\u6700\u7ec8 sesion A \u52a0\u7684\u9501\u662f\uff0c\u7d22\u5f15 c \u4e0a\u7684 (5,10] \u548c (10,15] \u8fd9\u4e24\u4e2a next-key lock\u3002</p>\n<p>\u6240\u4ee5\u4ece\u7ed3\u679c\u4e0a\u6765\u770b\uff0csesson B \u8981\u63d2\u5165\uff088,8,8) \u7684\u8fd9\u4e2a insert \u8bed\u53e5\u65f6\u5c31\u88ab\u5835\u4f4f\u4e86\u3002</p>\n<p>\u8fd9\u91cc\u9700\u8981\u626b\u63cf\u5230 c=15 \u624d\u505c\u6b62\u626b\u63cf\uff0c\u662f\u5408\u7406\u7684\uff0c\u56e0\u4e3a InnoDB \u8981\u626b\u5230 c=15\uff0c\u624d\u77e5\u9053\u4e0d\u9700\u8981\u7ee7\u7eed\u5f80\u540e\u627e\u4e86\u3002</p>\n<h3 id=\"bug\">\u6848\u4f8b\u4e94\uff1a\u552f\u4e00\u7d22\u5f15\u8303\u56f4\u9501 bug<a class=\"headerlink\" href=\"#bug\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u7684\u56db\u4e2a\u6848\u4f8b\uff0c\u6211\u4eec\u5df2\u7ecf\u7528\u5230\u4e86\u52a0\u9501\u89c4\u5219\u4e2d\u7684\u4e24\u4e2a\u539f\u5219\u548c\u4e24\u4e2a\u4f18\u5316\uff0c\u63a5\u4e0b\u6765\u518d\u770b\u4e00\u4e2a\u5173\u4e8e\u52a0\u9501\u89c4\u5219\u4e2d bug \u7684\u6848\u4f8b\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select * from t where id&gt;10 and id&lt;=11 for update;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>update t set d=d+1 where id=20;<br /><font color='red'>(blocked)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>insert into t values(16,16,16);<br /><font color='red'>(blocked)</font></td>\n</tr>\n</tbody>\n</table>\n<p>session A \u662f\u4e00\u4e2a\u8303\u56f4\u67e5\u8be2\uff0c\u6309\u7167\u539f\u5219 1 \u7684\u8bdd\uff0c\u5e94\u8be5\u662f\u7d22\u5f15 id \u4e0a\u53ea\u52a0 (10,15] \u8fd9\u4e2a next-key lock\uff0c\u5e76\u4e14\u56e0\u4e3a id \u662f\u552f\u4e00\u952e\uff0c\u6240\u4ee5\u5faa\u73af\u5224\u65ad\u5230 id=15 \u8fd9\u4e00\u884c\u5c31\u5e94\u8be5\u505c\u6b62\u4e86\u3002</p>\n<p>\u4f46\u662f\u5b9e\u73b0\u4e0a\uff0cInnoDB \u4f1a\u5f80\u524d\u626b\u63cf\u5230\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u4e3a\u6b62\uff0c\u4e5f\u5c31\u662f id=20\u3002\u800c\u4e14\u7531\u4e8e\u8fd9\u662f\u4e2a\u8303\u56f4\u626b\u63cf\uff0c\u56e0\u6b64\u7d22\u5f15 id \u4e0a\u7684 (15,20] \u8fd9\u4e2a next-key lock \u4e5f\u4f1a\u88ab\u9501\u4e0a\u3002</p>\n<p>\u6240\u4ee5\u4f60\u770b\u5230\u4e86\uff0csession B \u8981\u66f4\u65b0 id=20 \u8fd9\u4e00\u884c\uff0c\u662f\u4f1a\u88ab\u9501\u4f4f\u7684\u3002\u540c\u6837\u5730\uff0csession C \u8981\u63d2\u5165 id=16 \u7684\u4e00\u884c\uff0c\u4e5f\u4f1a\u88ab\u9501\u4f4f\u3002</p>\n<p>\u7167\u7406\u8bf4\uff0c\u8fd9\u91cc\u9501\u4f4f id=20 \u8fd9\u4e00\u884c\u7684\u884c\u4e3a\uff0c\u5176\u5b9e\u662f\u6ca1\u6709\u5fc5\u8981\u7684\u3002\u56e0\u4e3a\u626b\u63cf\u5230 id=15\uff0c\u5c31\u53ef\u4ee5\u786e\u5b9a\u4e0d\u7528\u5f80\u540e\u518d\u627e\u4e86\u3002\u4f46\u5b9e\u73b0\u4e0a\u8fd8\u662f\u8fd9\u4e48\u505a\u4e86\uff0c\u56e0\u6b64\u6211\u8ba4\u4e3a\u8fd9\u662f\u4e2a bug\u3002</p>\n<p>\u6211\u4e5f\u66fe\u627e\u793e\u533a\u7684\u4e13\u5bb6\u8ba8\u8bba\u8fc7\uff0c\u5b98\u65b9 bug \u7cfb\u7edf\u4e0a\u4e5f\u6709\u63d0\u5230\uff0c\u4f46\u662f\u5e76\u672a\u88ab verified\u3002\u6240\u4ee5\uff0c\u8ba4\u4e3a\u8fd9\u662f bug \u8fd9\u4e2a\u4e8b\u513f\uff0c\u4e5f\u53ea\u80fd\u7b97\u6211\u7684\u4e00\u5bb6\u4e4b\u8a00\uff0c\u5982\u679c\u4f60\u6709\u5176\u4ed6\u89c1\u89e3\u7684\u8bdd\uff0c\u4e5f\u6b22\u8fce\u4f60\u63d0\u51fa\u6765\u3002</p>\n<h3 id=\"_9\">\u6848\u4f8b\u516d\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u4e0a\u5b58\u5728\"\u7b49\u503c\"\u7684\u4f8b\u5b50<a class=\"headerlink\" href=\"#_9\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u7684\u4f8b\u5b50\uff0c\u662f\u4e3a\u4e86\u66f4\u597d\u5730\u8bf4\u660e\u201c\u95f4\u9699\u201d\u8fd9\u4e2a\u6982\u5ff5\u3002\u8fd9\u91cc\uff0c\u6211\u7ed9\u8868 t \u63d2\u5165\u4e00\u6761\u65b0\u8bb0\u5f55\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">30</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">30</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u65b0\u63d2\u5165\u7684\u8fd9\u4e00\u884c c=10\uff0c\u4e5f\u5c31\u662f\u8bf4\u73b0\u5728\u8868\u91cc\u6709\u4e24\u4e2a c=10 \u7684\u884c\u3002\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7d22\u5f15 c \u4e0a\u7684\u95f4\u9699\u662f\u4ec0\u4e48\u72b6\u6001\u4e86\u5462\uff1f\u4f60\u8981\u77e5\u9053\uff0c\u7531\u4e8e\u975e\u552f\u4e00\u7d22\u5f15\u4e0a\u5305\u542b\u4e3b\u952e\u7684\u503c\uff0c\u6240\u4ee5\u662f\u4e0d\u53ef\u80fd\u5b58\u5728\u201c\u76f8\u540c\u201d\u7684\u4e24\u884c\u7684\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/c1fda36c1502606eb5be3908011ba159.png\" /></p>\n<p>\u56fe 6 \u975e\u552f\u4e00\u7d22\u5f15\u7b49\u503c\u7684\u4f8b\u5b50</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u867d\u7136\u6709\u4e24\u4e2a c=10\uff0c\u4f46\u662f\u5b83\u4eec\u7684\u4e3b\u952e\u503c id \u662f\u4e0d\u540c\u7684\uff08\u5206\u522b\u662f 10 \u548c 30\uff09\uff0c\u56e0\u6b64\u8fd9\u4e24\u4e2a c=10 \u7684\u8bb0\u5f55\u4e4b\u95f4\uff0c\u4e5f\u662f\u6709\u95f4\u9699\u7684\u3002</p>\n<p>\u56fe\u4e2d\u6211\u753b\u51fa\u4e86\u7d22\u5f15 c \u4e0a\u7684\u4e3b\u952e id\u3002\u4e3a\u4e86\u8ddf\u95f4\u9699\u9501\u7684\u5f00\u533a\u95f4\u5f62\u5f0f\u8fdb\u884c\u533a\u522b\uff0c\u6211\u7528 <code>(c=10,id=30)</code> \u8fd9\u6837\u7684\u5f62\u5f0f\uff0c\u6765\u8868\u793a\u7d22\u5f15\u4e0a\u7684\u4e00\u884c\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u6848\u4f8b\u516d\u3002</p>\n<p>\u8fd9\u6b21\u6211\u4eec\u7528 delete \u8bed\u53e5\u6765\u9a8c\u8bc1\u3002\u6ce8\u610f\uff0cdelete \u8bed\u53e5\u52a0\u9501\u7684\u903b\u8f91\uff0c\u5176\u5b9e\u8ddf <code>select ... for update</code> \u662f\u7c7b\u4f3c\u7684\uff0c\u4e5f\u5c31\u662f\u6211\u5728\u6587\u7ae0\u5f00\u59cb\u603b\u7ed3\u7684\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />delete from t where c=10;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(12,12,12);<br /><font color='red'>(blocked)</font></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>update t set d =d+1 where c=15;<br /><font color='green'>(Query OK)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u8fd9\u65f6\uff0csession A \u5728\u904d\u5386\u7684\u65f6\u5019\uff0c\u5148\u8bbf\u95ee\u7b2c\u4e00\u4e2a c=10 \u7684\u8bb0\u5f55\u3002\u540c\u6837\u5730\uff0c\u6839\u636e\u539f\u5219 1\uff0c\u8fd9\u91cc\u52a0\u7684\u662f <code>(c=5,id=5)</code> \u5230 <code>(c=10,id=10)</code> \u8fd9\u4e2a next-key lock\u3002</p>\n<p>\u7136\u540e\uff0csession A \u5411\u53f3\u67e5\u627e\uff0c\u76f4\u5230\u78b0\u5230 <code>(c=15,id=15)</code> \u8fd9\u4e00\u884c\uff0c\u5faa\u73af\u624d\u7ed3\u675f\u3002\u6839\u636e\u4f18\u5316 2\uff0c\u8fd9\u662f\u4e00\u4e2a\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u67e5\u627e\u5230\u4e86\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u6240\u4ee5\u4f1a\u9000\u5316\u6210 <code>(c=10,id=10)</code> \u5230 <code>(c=15,id=15)</code> \u7684\u95f4\u9699\u9501\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a delete \u8bed\u53e5\u5728\u7d22\u5f15 c \u4e0a\u7684\u52a0\u9501\u8303\u56f4\uff0c\u5c31\u662f\u4e0b\u56fe\u4e2d\u84dd\u8272\u533a\u57df\u8986\u76d6\u7684\u90e8\u5206\u3002<img alt=\"img\" src=\"../../../images/mysql-lecture-45/bb0ad92483d71f0dcaeeef278f89cb24.png\" /></p>\n<p>\u56fe 8 delete \u52a0\u9501\u6548\u679c\u793a\u4f8b</p>\n<p>\u8fd9\u4e2a\u84dd\u8272\u533a\u57df\u5de6\u53f3\u4e24\u8fb9\u90fd\u662f\u865a\u7ebf\uff0c\u8868\u793a\u5f00\u533a\u95f4\uff0c\u5373 (c=5,id=5) \u548c (c=15,id=15) \u8fd9\u4e24\u884c\u4e0a\u90fd\u6ca1\u6709\u9501\u3002</p>\n<h3 id=\"limit\">\u6848\u4f8b\u4e03\uff1alimit \u8bed\u53e5\u52a0\u9501<a class=\"headerlink\" href=\"#limit\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f8b\u5b50 6 \u4e5f\u6709\u4e00\u4e2a\u5bf9\u7167\u6848\u4f8b\uff0c\u573a\u666f\u5982\u4e0b\u6240\u793a\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />delete from t where c=10 limit 2;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(12,12,12);<br /><font color='green'>(Query OK)</font></td>\n</tr>\n</tbody>\n</table>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0csession A \u7684 delete \u8bed\u53e5\u52a0\u4e86 limit 2\u3002\u4f60\u77e5\u9053\u8868 t \u91cc c=10 \u7684\u8bb0\u5f55\u5176\u5b9e\u53ea\u6709\u4e24\u6761\uff0c\u56e0\u6b64\u52a0\u4e0d\u52a0 limit 2\uff0c\u5220\u9664\u7684\u6548\u679c\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u52a0\u9501\u7684\u6548\u679c\u5374\u4e0d\u540c\u3002\u53ef\u4ee5\u770b\u5230\uff0csession B \u7684 insert \u8bed\u53e5\u6267\u884c\u901a\u8fc7\u4e86\uff0c\u8ddf\u6848\u4f8b\u516d\u7684\u7ed3\u679c\u4e0d\u540c\u3002</p>\n<p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u6848\u4f8b\u4e03\u91cc\u7684 delete \u8bed\u53e5\u660e\u786e\u52a0\u4e86 limit 2 \u7684\u9650\u5236\uff0c\u56e0\u6b64\u5728\u904d\u5386\u5230 (c=10, id=30) \u8fd9\u4e00\u884c\u4e4b\u540e\uff0c\u6ee1\u8db3\u6761\u4ef6\u7684\u8bed\u53e5\u5df2\u7ecf\u6709\u4e24\u6761\uff0c\u5faa\u73af\u5c31\u7ed3\u675f\u4e86\u3002</p>\n<p>\u56e0\u6b64\uff0c\u7d22\u5f15 c \u4e0a\u7684\u52a0\u9501\u8303\u56f4\u5c31\u53d8\u6210\u4e86\u4ece\uff08c=5,id=5) \u5230\uff08c=10,id=30) \u8fd9\u4e2a\u524d\u5f00\u540e\u95ed\u533a\u95f4\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a<img alt=\"img\" src=\"../../../images/mysql-lecture-45/e5408ed94b3d44985073255db63bd0d5.png\" /></p>\n<p>\u56fe 10 \u5e26 limit 2 \u7684\u52a0\u9501\u6548\u679c</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c(c=10,id=30\uff09\u4e4b\u540e\u7684\u8fd9\u4e2a\u95f4\u9699\u5e76\u6ca1\u6709\u5728\u52a0\u9501\u8303\u56f4\u91cc\uff0c\u56e0\u6b64 insert \u8bed\u53e5\u63d2\u5165 c=12 \u662f\u53ef\u4ee5\u6267\u884c\u6210\u529f\u7684\u3002</p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u6211\u4eec\u5b9e\u8df5\u7684\u6307\u5bfc\u610f\u4e49\u5c31\u662f\uff0c<strong>\u5728\u5220\u9664\u6570\u636e\u7684\u65f6\u5019\u5c3d\u91cf\u52a0 limit</strong>\u3002\u8fd9\u6837\u4e0d\u4ec5\u53ef\u4ee5\u63a7\u5236\u5220\u9664\u6570\u636e\u7684\u6761\u6570\uff0c\u8ba9\u64cd\u4f5c\u66f4\u5b89\u5168\uff0c\u8fd8\u53ef\u4ee5\u51cf\u5c0f\u52a0\u9501\u7684\u8303\u56f4\u3002</p>\n<h3 id=\"_10\">\u6848\u4f8b\u516b\uff1a\u4e00\u4e2a\u6b7b\u9501\u7684\u4f8b\u5b50<a class=\"headerlink\" href=\"#_10\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u5728\u5206\u6790\u7684\u65f6\u5019\uff0c\u662f\u6309\u7167 next-key lock \u7684\u903b\u8f91\u6765\u5206\u6790\u7684\uff0c\u56e0\u4e3a\u8fd9\u6837\u5206\u6790\u6bd4\u8f83\u65b9\u4fbf\u3002\u6700\u540e\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u6848\u4f8b\uff0c\u76ee\u7684\u662f\u8bf4\u660e\uff1anext-key lock \u5b9e\u9645\u4e0a\u662f\u95f4\u9699\u9501\u548c\u884c\u9501\u52a0\u8d77\u6765\u7684\u7ed3\u679c\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u7591\u60d1\uff0c\u8fd9\u4e2a\u6982\u5ff5\u4e0d\u662f\u4e00\u5f00\u59cb\u5c31\u8bf4\u4e86\u5417\uff1f\u4e0d\u8981\u7740\u6025\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />select id from t where c=10 lock in share mode;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>update t set d=d+1 where c=10;<br /><font color='red'>(blocked)</font></td>\n</tr>\n<tr>\n<td>insert into t values(8,8,8);</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>ERROR 1213 (40001):<br />Deadlock found where trying to get lock;<br />try restarting transaction</td>\n</tr>\n</tbody>\n</table>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u6309\u65f6\u95f4\u987a\u5e8f\u6765\u5206\u6790\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u662f\u8fd9\u6837\u7684\u7ed3\u679c\u3002</p>\n<ol>\n<li>session A \u542f\u52a8\u4e8b\u52a1\u540e\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u52a0 <code>lock in share mode</code>\uff0c\u5728\u7d22\u5f15 c \u4e0a\u52a0\u4e86 next-key lock(5,10] \u548c\u95f4\u9699\u9501 (10,15)\uff1b</li>\n<li>session B \u7684 update \u8bed\u53e5\u4e5f\u8981\u5728\u7d22\u5f15 c \u4e0a\u52a0 next-key lock(5,10] \uff0c\u8fdb\u5165\u9501\u7b49\u5f85\uff1b</li>\n<li>\u7136\u540e session A \u8981\u518d\u63d2\u5165 <code>(8,8,8)</code> \u8fd9\u4e00\u884c\uff0c\u88ab session B \u7684\u95f4\u9699\u9501\u9501\u4f4f\u3002\u7531\u4e8e\u51fa\u73b0\u4e86\u6b7b\u9501\uff0cInnoDB \u8ba9 session B \u56de\u6eda\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0csession B \u7684 next-key lock \u4e0d\u662f\u8fd8\u6ca1\u7533\u8bf7\u6210\u529f\u5417\uff1f</p>\n<p>\u5176\u5b9e\u662f\u8fd9\u6837\u7684\uff0csession B \u7684\u201c\u52a0 next-key lock(5,10] \u201d\u64cd\u4f5c\uff0c\u5b9e\u9645\u4e0a\u5206\u6210\u4e86\u4e24\u6b65\uff0c\u5148\u662f\u52a0 (5,10) \u7684\u95f4\u9699\u9501\uff0c\u52a0\u9501\u6210\u529f\uff1b\u7136\u540e\u52a0 c=10 \u7684\u884c\u9501\uff0c\u8fd9\u65f6\u5019\u624d\u88ab\u9501\u4f4f\u7684\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u5728\u5206\u6790\u52a0\u9501\u89c4\u5219\u7684\u65f6\u5019\u53ef\u4ee5\u7528 next-key lock \u6765\u5206\u6790\u3002\u4f46\u662f\u8981\u77e5\u9053\uff0c\u5177\u4f53\u6267\u884c\u7684\u65f6\u5019\uff0c\u662f\u8981\u5206\u6210\u95f4\u9699\u9501\u548c\u884c\u9501\u4e24\u6bb5\u6765\u6267\u884c\u7684\u3002</p>\n<h3 id=\"_11\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_11\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u91cc\u6211\u518d\u6b21\u8bf4\u660e\u4e00\u4e0b\uff0c\u6211\u4eec\u4e0a\u9762\u7684\u6240\u6709\u6848\u4f8b\u90fd\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b (repeatable-read) \u4e0b\u9a8c\u8bc1\u7684\u3002\u540c\u65f6\uff0c\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u9075\u5b88\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u6240\u6709\u52a0\u9501\u7684\u8d44\u6e90\uff0c\u90fd\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p>\n<p>\u5728\u6700\u540e\u7684\u6848\u4f8b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u6e05\u695a\u5730\u77e5\u9053 next-key lock \u5b9e\u9645\u4e0a\u662f\u7531\u95f4\u9699\u9501\u52a0\u884c\u9501\u5b9e\u73b0\u7684\u3002\u5982\u679c\u5207\u6362\u5230\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b (read-committed) \u7684\u8bdd\uff0c\u5c31\u597d\u7406\u89e3\u4e86\uff0c\u8fc7\u7a0b\u4e2d\u53bb\u6389\u95f4\u9699\u9501\u7684\u90e8\u5206\uff0c\u4e5f\u5c31\u662f\u53ea\u5269\u4e0b\u884c\u9501\u7684\u90e8\u5206\u3002</p>\n<p>\u5176\u5b9e\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u5728\u5916\u952e\u573a\u666f\u4e0b\u8fd8\u662f\u6709\u95f4\u9699\u9501\uff0c\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\uff0c\u6211\u4eec\u4eca\u5929\u5148\u4e0d\u5c55\u5f00\u3002</p>\n<p>\u53e6\u5916\uff0c\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\u8fd8\u6709\u4e00\u4e2a\u4f18\u5316\uff0c\u5373\uff1a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u52a0\u4e0a\u7684\u884c\u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c31\u8981\u628a\u201c\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u201d\u4e0a\u7684\u884c\u9501\u76f4\u63a5\u91ca\u653e\u4e86\uff0c\u4e0d\u9700\u8981\u7b49\u5230\u4e8b\u52a1\u63d0\u4ea4\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u9501\u7684\u8303\u56f4\u66f4\u5c0f\uff0c\u9501\u7684\u65f6\u95f4\u66f4\u77ed\uff0c\u8fd9\u4e5f\u662f\u4e0d\u5c11\u4e1a\u52a1\u90fd\u9ed8\u8ba4\u4f7f\u7528\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u7684\u539f\u56e0\u3002</p>\n<p>\u4e0d\u8fc7\uff0c\u6211\u5e0c\u671b\u4f60\u5b66\u8fc7\u4eca\u5929\u7684\u8bfe\u7a0b\u4ee5\u540e\uff0c\u53ef\u4ee5\u5bf9 next-key lock \u7684\u6982\u5ff5\u6709\u66f4\u6e05\u6670\u7684\u8ba4\u8bc6\uff0c\u5e76\u4e14\u4f1a\u7528\u52a0\u9501\u89c4\u5219\u53bb\u5224\u65ad\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u3002</p>\n<p>\u5728\u4e1a\u52a1\u9700\u8981\u4f7f\u7528\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u7684\u65f6\u5019\uff0c\u80fd\u591f\u66f4\u7ec6\u81f4\u5730\u8bbe\u8ba1\u64cd\u4f5c\u6570\u636e\u5e93\u7684\u8bed\u53e5\uff0c\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\u7684\u540c\u65f6\uff0c\u6700\u5927\u9650\u5ea6\u5730\u63d0\u5347\u7cfb\u7edf\u5e76\u884c\u5904\u7406\u4e8b\u52a1\u7684\u80fd\u529b\u3002</p>\n<h2 id=\"22-mysql\">22 MySQL\u6709\u54ea\u4e9b\u201c\u996e\u9e29\u6b62\u6e34\u201d\u63d0\u9ad8\u6027\u80fd\u7684\u65b9\u6cd5\uff1f<a class=\"headerlink\" href=\"#22-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0d\u77e5\u9053\u4f60\u5728\u5b9e\u9645\u8fd0\u7ef4\u8fc7\u7a0b\u4e2d\u6709\u6ca1\u6709\u78b0\u5230\u8fd9\u6837\u7684\u60c5\u666f\uff1a\u4e1a\u52a1\u9ad8\u5cf0\u671f\uff0c\u751f\u4ea7\u73af\u5883\u7684 MySQL \u538b\u529b\u592a\u5927\uff0c\u6ca1\u6cd5\u6b63\u5e38\u54cd\u5e94\uff0c\u9700\u8981\u77ed\u671f\u5185\u3001\u4e34\u65f6\u6027\u5730\u63d0\u5347\u4e00\u4e9b\u6027\u80fd\u3002</p>\n<p>\u6211\u4ee5\u524d\u505a\u4e1a\u52a1\u62a4\u822a\u7684\u65f6\u5019\uff0c\u5c31\u5076\u5c14\u4f1a\u78b0\u4e0a\u8fd9\u79cd\u573a\u666f\u3002\u7528\u6237\u7684\u5f00\u53d1\u8d1f\u8d23\u4eba\u8bf4\uff0c\u4e0d\u7ba1\u4f60\u7528\u4ec0\u4e48\u65b9\u6848\uff0c\u8ba9\u4e1a\u52a1\u5148\u8dd1\u8d77\u6765\u518d\u8bf4\u3002</p>\n<p>\u4f46\uff0c\u5982\u679c\u662f\u65e0\u635f\u65b9\u6848\u7684\u8bdd\uff0c\u80af\u5b9a\u4e0d\u9700\u8981\u7b49\u5230\u8fd9\u4e2a\u65f6\u5019\u624d\u4e0a\u573a\u3002\u4eca\u5929\u6211\u4eec\u5c31\u6765\u804a\u804a\u8fd9\u4e9b\u4e34\u65f6\u65b9\u6848\uff0c\u5e76\u7740\u91cd\u8bf4\u4e00\u8bf4\u5b83\u4eec\u53ef\u80fd\u5b58\u5728\u7684\u98ce\u9669\u3002</p>\n<h3 id=\"_12\">\u77ed\u8fde\u63a5\u98ce\u66b4<a class=\"headerlink\" href=\"#_12\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6b63\u5e38\u7684\u77ed\u8fde\u63a5\u6a21\u5f0f\u5c31\u662f\u8fde\u63a5\u5230\u6570\u636e\u5e93\u540e\uff0c\u6267\u884c\u5f88\u5c11\u7684 SQL \u8bed\u53e5\u5c31\u65ad\u5f00\uff0c\u4e0b\u6b21\u9700\u8981\u7684\u65f6\u5019\u518d\u91cd\u8fde\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f\u77ed\u8fde\u63a5\uff0c\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u8fde\u63a5\u6570\u7a81\u7136\u66b4\u6da8\u7684\u60c5\u51b5\u3002</p>\n<p>\u6211\u5728\u7b2c 1 \u7bc7\u6587\u7ae0[\u300a\u57fa\u7840\u67b6\u6784\uff1a\u4e00\u6761 SQL \u67e5\u8be2\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\u8bf4\u8fc7\uff0cMySQL \u5efa\u7acb\u8fde\u63a5\u7684\u8fc7\u7a0b\uff0c\u6210\u672c\u662f\u5f88\u9ad8\u7684\u3002\u9664\u4e86\u6b63\u5e38\u7684\u7f51\u7edc\u8fde\u63a5\u4e09\u6b21\u63e1\u624b\u5916\uff0c\u8fd8\u9700\u8981\u505a\u767b\u5f55\u6743\u9650\u5224\u65ad\u548c\u83b7\u5f97\u8fd9\u4e2a\u8fde\u63a5\u7684\u6570\u636e\u8bfb\u5199\u6743\u9650\u3002</p>\n<p>\u5728\u6570\u636e\u5e93\u538b\u529b\u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u989d\u5916\u7684\u6210\u672c\u5e76\u4e0d\u660e\u663e\u3002</p>\n<p>\u4f46\u662f\uff0c\u77ed\u8fde\u63a5\u6a21\u578b\u5b58\u5728\u4e00\u4e2a\u98ce\u9669\uff0c\u5c31\u662f\u4e00\u65e6\u6570\u636e\u5e93\u5904\u7406\u5f97\u6162\u4e00\u4e9b\uff0c\u8fde\u63a5\u6570\u5c31\u4f1a\u66b4\u6da8\u3002<code>max_connections</code> \u53c2\u6570\uff0c\u7528\u6765\u63a7\u5236\u4e00\u4e2a MySQL \u5b9e\u4f8b\u540c\u65f6\u5b58\u5728\u7684\u8fde\u63a5\u6570\u7684\u4e0a\u9650\uff0c\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u62d2\u7edd\u63a5\u4e0b\u6765\u7684\u8fde\u63a5\u8bf7\u6c42\uff0c\u5e76\u62a5\u9519\u63d0\u793a \u201cToo many connections\u201d\u3002\u5bf9\u4e8e\u88ab\u62d2\u7edd\u8fde\u63a5\u7684\u8bf7\u6c42\u6765\u8bf4\uff0c\u4ece\u4e1a\u52a1\u89d2\u5ea6\u770b\u5c31\u662f\u6570\u636e\u5e93\u4e0d\u53ef\u7528\u3002</p>\n<p>\u5728\u673a\u5668\u8d1f\u8f7d\u6bd4\u8f83\u9ad8\u7684\u65f6\u5019\uff0c\u5904\u7406\u73b0\u6709\u8bf7\u6c42\u7684\u65f6\u95f4\u53d8\u957f\uff0c\u6bcf\u4e2a\u8fde\u63a5\u4fdd\u6301\u7684\u65f6\u95f4\u4e5f\u66f4\u957f\u3002\u8fd9\u65f6\uff0c\u518d\u6709\u65b0\u5efa\u8fde\u63a5\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u4f1a\u8d85\u8fc7 <code>max_connections</code> \u7684\u9650\u5236\u3002</p>\n<p>\u78b0\u5230\u8fd9\u79cd\u60c5\u51b5\u65f6\uff0c\u4e00\u4e2a\u6bd4\u8f83\u81ea\u7136\u7684\u60f3\u6cd5\uff0c\u5c31\u662f\u8c03\u9ad8 <code>max_connections</code> \u7684\u503c\u3002\u4f46\u8fd9\u6837\u505a\u662f\u6709\u98ce\u9669\u7684\u3002\u56e0\u4e3a\u8bbe\u8ba1 <code>max_connections</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u76ee\u7684\u662f\u60f3\u4fdd\u62a4 MySQL\uff0c\u5982\u679c\u6211\u4eec\u628a\u5b83\u6539\u5f97\u592a\u5927\uff0c\u8ba9\u66f4\u591a\u7684\u8fde\u63a5\u90fd\u53ef\u4ee5\u8fdb\u6765\uff0c\u90a3\u4e48\u7cfb\u7edf\u7684\u8d1f\u8f7d\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u52a0\u5927\uff0c\u5927\u91cf\u7684\u8d44\u6e90\u8017\u8d39\u5728\u6743\u9650\u9a8c\u8bc1\u7b49\u903b\u8f91\u4e0a\uff0c\u7ed3\u679c\u53ef\u80fd\u662f\u9002\u5f97\u5176\u53cd\uff0c\u5df2\u7ecf\u8fde\u63a5\u7684\u7ebf\u7a0b\u62ff\u4e0d\u5230 CPU \u8d44\u6e90\u53bb\u6267\u884c\u4e1a\u52a1\u7684 SQL \u8bf7\u6c42\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u5efa\u8bae\u5462\uff1f\u6211\u8fd9\u91cc\u8fd8\u6709\u4e24\u79cd\u65b9\u6cd5\uff0c\u4f46\u8981\u6ce8\u610f\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u90fd\u662f\u6709\u635f\u7684\u3002</p>\n<p><strong>\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff1a\u5148\u5904\u7406\u6389\u90a3\u4e9b\u5360\u7740\u8fde\u63a5\u4f46\u662f\u4e0d\u5de5\u4f5c\u7684\u7ebf\u7a0b\u3002</strong></p>\n<p><code>max_connections</code> \u7684\u8ba1\u7b97\uff0c\u4e0d\u662f\u770b\u8c01\u5728 running\uff0c\u662f\u53ea\u8981\u8fde\u7740\u5c31\u5360\u7528\u4e00\u4e2a\u8ba1\u6570\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u90a3\u4e9b\u4e0d\u9700\u8981\u4fdd\u6301\u7684\u8fde\u63a5\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kill connection</code> \u4e3b\u52a8\u8e22\u6389\u3002\u8fd9\u4e2a\u884c\u4e3a\u8ddf\u4e8b\u5148\u8bbe\u7f6e <code>wait_timeout</code> \u7684\u6548\u679c\u662f\u4e00\u6837\u7684\u3002\u8bbe\u7f6e <code>wait_timeout</code> \u53c2\u6570\u8868\u793a\u7684\u662f\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u7a7a\u95f2 <code>wait_timeout</code> \u8fd9\u4e48\u591a\u79d2\u4e4b\u540e\uff0c\u5c31\u4f1a\u88ab MySQL \u76f4\u63a5\u65ad\u5f00\u8fde\u63a5\u3002</p>\n<p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\uff0c\u5728 show processlist \u7684\u7ed3\u679c\u91cc\uff0c\u8e22\u6389\u663e\u793a\u4e3a sleep \u7684\u7ebf\u7a0b\uff0c\u53ef\u80fd\u662f\u6709\u635f\u7684\u3002\u6211\u4eec\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T</td>\n<td>begin;<br />insert into t values(1,1);</td>\n<td>select * from t where id=1;</td>\n<td></td>\n</tr>\n<tr>\n<td>T+30s</td>\n<td></td>\n<td></td>\n<td>show processlist;</td>\n</tr>\n</tbody>\n</table>\n<p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5982\u679c\u65ad\u5f00 session A \u7684\u8fde\u63a5\uff0c\u56e0\u4e3a\u8fd9\u65f6\u5019 session A \u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5 MySQL \u53ea\u80fd\u6309\u7167\u56de\u6eda\u4e8b\u52a1\u6765\u5904\u7406\uff1b\u800c\u65ad\u5f00 session B \u7684\u8fde\u63a5\uff0c\u5c31\u6ca1\u4ec0\u4e48\u5927\u5f71\u54cd\u3002\u6240\u4ee5\uff0c\u5982\u679c\u6309\u7167\u4f18\u5148\u7ea7\u6765\u8bf4\uff0c\u4f60\u5e94\u8be5\u4f18\u5148\u65ad\u5f00\u50cf session B \u8fd9\u6837\u7684\u4e8b\u52a1\u5916\u7a7a\u95f2\u7684\u8fde\u63a5\u3002</p>\n<p>\u4f46\u662f\uff0c\u600e\u4e48\u5224\u65ad\u54ea\u4e9b\u662f\u4e8b\u52a1\u5916\u7a7a\u95f2\u7684\u5462\uff1fsession C \u5728 T \u65f6\u523b\u4e4b\u540e\u7684 30 \u79d2\u6267\u884c show processlist\uff0c\u770b\u5230\u7684\u7ed3\u679c\u662f\u8fd9\u6837\u7684\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Host</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">State</span><span class=\"w\">                  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">event_scheduler</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Daemon</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">86184</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Waiting</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"n\">queue</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sleep</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">                        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sleep</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">                        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+-------+------------------------+------------------+</span>\n</code></pre></div>\n<p>\u56fe\u4e2d id=20 \u548c id=22 \u7684\u4e24\u4e2a\u4f1a\u8bdd\u90fd\u662f Sleep \u72b6\u6001\u3002\u800c\u8981\u770b\u4e8b\u52a1\u5177\u4f53\u72b6\u6001\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u67e5 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8868\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">information_schema</span><span class=\"p\">.</span><span class=\"n\">innodb_trx</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">                    </span><span class=\"n\">trx_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">588510</span>\n<span class=\"w\">                 </span><span class=\"n\">trx_state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">RUNNING</span>\n<span class=\"w\">               </span><span class=\"n\">trx_started</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"mi\">52</span><span class=\"p\">:</span><span class=\"mi\">57</span>\n<span class=\"w\">     </span><span class=\"n\">trx_requested_lock_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">          </span><span class=\"n\">trx_wait_started</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">                </span><span class=\"n\">trx_weight</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">       </span><span class=\"n\">trx_mysql_thread_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"w\">                 </span><span class=\"n\">trx_query</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">       </span><span class=\"n\">trx_operation_state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">         </span><span class=\"n\">trx_tables_in_use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">         </span><span class=\"n\">trx_tables_locked</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">          </span><span class=\"n\">trx_lock_structs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">     </span><span class=\"n\">trx_lock_memory_bytes</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1136</span>\n<span class=\"w\">           </span><span class=\"n\">trx_rows_locked</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">         </span><span class=\"n\">trx_rows_modified</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">   </span><span class=\"n\">trx_concurrency_tickets</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">       </span><span class=\"n\">trx_isolation_level</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">REPEATABLE</span><span class=\"w\"> </span><span class=\"k\">READ</span>\n<span class=\"w\">         </span><span class=\"n\">trx_unique_checks</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">trx_foreign_key_checks</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">trx_last_foreign_key_error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\"> </span><span class=\"n\">trx_adaptive_hash_latched</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"n\">trx_adaptive_hash_timeout</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">          </span><span class=\"n\">trx_is_read_only</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">trx_autocommit_non_locking</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u7ed3\u679c\u91cc\uff0c<code>trx_mysql_thread_id=20</code>\uff0c\u8868\u793a id=20 \u7684\u7ebf\u7a0b\u8fd8\u5904\u5728\u4e8b\u52a1\u4e2d\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5982\u679c\u662f\u8fde\u63a5\u6570\u8fc7\u591a\uff0c\u4f60\u53ef\u4ee5\u4f18\u5148\u65ad\u5f00\u4e8b\u52a1\u5916\u7a7a\u95f2\u592a\u4e45\u7684\u8fde\u63a5\uff1b\u5982\u679c\u8fd9\u6837\u8fd8\u4e0d\u591f\uff0c\u518d\u8003\u8651\u65ad\u5f00\u4e8b\u52a1\u5185\u7a7a\u95f2\u592a\u4e45\u7684\u8fde\u63a5\u3002</p>\n<p>\u4ece\u670d\u52a1\u7aef\u65ad\u5f00\u8fde\u63a5\u4f7f\u7528\u7684\u662f <code>kill connection + id</code> \u7684\u547d\u4ee4\uff0c \u4e00\u4e2a\u5ba2\u6237\u7aef\u5904\u4e8e sleep \u72b6\u6001\u65f6\uff0c\u5b83\u7684\u8fde\u63a5\u88ab\u670d\u52a1\u7aef\u4e3b\u52a8\u65ad\u5f00\u540e\uff0c\u8fd9\u4e2a\u5ba2\u6237\u7aef\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u77e5\u9053\u3002\u76f4\u5230\u5ba2\u6237\u7aef\u5728\u53d1\u8d77\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u624d\u4f1a\u6536\u5230\u8fd9\u6837\u7684\u62a5\u9519 <code>ERROR 2013 (HY000): Lost connection to MySQL server during query</code>\u3002</p>\n<p>\u4ece\u6570\u636e\u5e93\u7aef\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\u53ef\u80fd\u662f\u6709\u635f\u7684\uff0c\u5c24\u5176\u662f\u6709\u7684\u5e94\u7528\u7aef\u6536\u5230\u8fd9\u4e2a\u9519\u8bef\u540e\uff0c\u4e0d\u91cd\u65b0\u8fde\u63a5\uff0c\u800c\u662f\u76f4\u63a5\u7528\u8fd9\u4e2a\u5df2\u7ecf\u4e0d\u80fd\u7528\u7684\u53e5\u67c4\u91cd\u8bd5\u67e5\u8be2\u3002\u8fd9\u4f1a\u5bfc\u81f4\u4ece\u5e94\u7528\u7aef\u770b\u4e0a\u53bb\uff0c\u201cMySQL \u4e00\u76f4\u6ca1\u6062\u590d\u201d\u3002</p>\n<p>\u4f60\u53ef\u80fd\u89c9\u5f97\u8fd9\u662f\u4e00\u4e2a\u51b7\u7b11\u8bdd\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u78b0\u5230\u8fc7\u4e0d\u4e0b 10 \u6b21\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u662f\u4e00\u4e2a\u652f\u6301\u4e1a\u52a1\u7684 DBA\uff0c\u4e0d\u8981\u5047\u8bbe\u6240\u6709\u7684\u5e94\u7528\u4ee3\u7801\u90fd\u4f1a\u88ab\u6b63\u786e\u5730\u5904\u7406\u3002\u5373\u4f7f\u53ea\u662f\u4e00\u4e2a\u65ad\u5f00\u8fde\u63a5\u7684\u64cd\u4f5c\uff0c\u4e5f\u8981\u786e\u4fdd\u901a\u77e5\u5230\u4e1a\u52a1\u5f00\u53d1\u56e2\u961f\u3002</p>\n<p><strong>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff1a\u51cf\u5c11\u8fde\u63a5\u8fc7\u7a0b\u7684\u6d88\u8017\u3002</strong></p>\n<p>\u6709\u7684\u4e1a\u52a1\u4ee3\u7801\u4f1a\u5728\u77ed\u65f6\u95f4\u5185\u5148\u5927\u91cf\u7533\u8bf7\u6570\u636e\u5e93\u8fde\u63a5\u505a\u5907\u7528\uff0c\u5982\u679c\u73b0\u5728\u6570\u636e\u5e93\u786e\u8ba4\u662f\u88ab\u8fde\u63a5\u884c\u4e3a\u6253\u6302\u4e86\uff0c\u90a3\u4e48\u4e00\u79cd\u53ef\u80fd\u7684\u505a\u6cd5\uff0c\u662f\u8ba9\u6570\u636e\u5e93\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u9636\u6bb5\u3002</p>\n<p>\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u7684\u65b9\u6cd5\u662f\uff1a\u91cd\u542f\u6570\u636e\u5e93\uff0c\u5e76\u4f7f\u7528 <code>\u2013-skip-grant-tables</code> \u53c2\u6570\u542f\u52a8\u3002\u8fd9\u6837\uff0c\u6574\u4e2a MySQL \u4f1a\u8df3\u8fc7\u6240\u6709\u7684\u6743\u9650\u9a8c\u8bc1\u9636\u6bb5\uff0c\u5305\u62ec\u8fde\u63a5\u8fc7\u7a0b\u548c\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u5728\u5185\u3002</p>\n<p>\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7279\u522b\u7b26\u5408\u6211\u4eec\u6807\u9898\u91cc\u8bf4\u7684\u201c\u996e\u9e29\u6b62\u6e34\u201d\uff0c\u98ce\u9669\u6781\u9ad8\uff0c\u662f\u6211\u7279\u522b\u4e0d\u5efa\u8bae\u4f7f\u7528\u7684\u65b9\u6848\u3002\u5c24\u5176\u4f60\u7684\u5e93\u5916\u7f51\u53ef\u8bbf\u95ee\u7684\u8bdd\uff0c\u5c31\u66f4\u4e0d\u80fd\u8fd9\u4e48\u505a\u4e86\u3002</p>\n<p>\u5728 MySQL 8.0 \u7248\u672c\u91cc\uff0c\u5982\u679c\u4f60\u542f\u7528 <code>-\u2013skip-grant-tables</code> \u53c2\u6570\uff0cMySQL \u4f1a\u9ed8\u8ba4\u628a <code>--skip-networking</code> \u53c2\u6570\u6253\u5f00\uff0c\u8868\u793a\u8fd9\u65f6\u5019\u6570\u636e\u5e93\u53ea\u80fd\u88ab\u672c\u5730\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u3002\u53ef\u89c1\uff0cMySQL \u5b98\u65b9\u5bf9 <code>--skip-grant-tables</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u5b89\u5168\u95ee\u9898\u4e5f\u5f88\u91cd\u89c6\u3002</p>\n<p>\u9664\u4e86\u77ed\u8fde\u63a5\u6570\u66b4\u589e\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u95ee\u9898\u5916\uff0c\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5728\u7ebf\u4e0a\u78b0\u5230\u66f4\u591a\u7684\u662f\u67e5\u8be2\u6216\u8005\u66f4\u65b0\u8bed\u53e5\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u3002\u5176\u4e2d\uff0c\u67e5\u8be2\u95ee\u9898\u6bd4\u8f83\u5178\u578b\u7684\u6709\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u7531\u65b0\u51fa\u73b0\u7684\u6162\u67e5\u8be2\u5bfc\u81f4\u7684\uff0c\u4e00\u7c7b\u662f\u7531 QPS\uff08\u6bcf\u79d2\u67e5\u8be2\u6570\uff09\u7a81\u589e\u5bfc\u81f4\u7684\u3002\u800c\u5173\u4e8e\u66f4\u65b0\u8bed\u53e5\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u548c\u4f60\u5c55\u5f00\u8bf4\u660e\u3002</p>\n<h3 id=\"_13\">\u6162\u67e5\u8be2\u6027\u80fd\u95ee\u9898<a class=\"headerlink\" href=\"#_13\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 MySQL \u4e2d\uff0c\u4f1a\u5f15\u53d1\u6027\u80fd\u95ee\u9898\u7684\u6162\u67e5\u8be2\uff0c\u5927\u4f53\u6709\u4ee5\u4e0b\u4e09\u79cd\u53ef\u80fd\uff1a</p>\n<ol>\n<li>\u7d22\u5f15\u6ca1\u6709\u8bbe\u8ba1\u597d\uff1b</li>\n<li>SQL \u8bed\u53e5\u6ca1\u5199\u597d\uff1b</li>\n<li>MySQL \u9009\u9519\u4e86\u7d22\u5f15\u3002</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5177\u4f53\u5206\u6790\u4e00\u4e0b\u8fd9\u4e09\u79cd\u53ef\u80fd\uff0c\u4ee5\u53ca\u5bf9\u5e94\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>\n<p><strong>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e00\u79cd\u53ef\u80fd\u662f\uff0c\u7d22\u5f15\u6ca1\u6709\u8bbe\u8ba1\u597d\u3002</strong></p>\n<p>\u8fd9\u79cd\u573a\u666f\u4e00\u822c\u5c31\u662f\u901a\u8fc7\u7d27\u6025\u521b\u5efa\u7d22\u5f15\u6765\u89e3\u51b3\u3002MySQL 5.6 \u7248\u672c\u4ee5\u540e\uff0c\u521b\u5efa\u7d22\u5f15\u90fd\u652f\u6301 Online DDL \u4e86\uff0c\u5bf9\u4e8e\u90a3\u79cd\u9ad8\u5cf0\u671f\u6570\u636e\u5e93\u5df2\u7ecf\u88ab\u8fd9\u4e2a\u8bed\u53e5\u6253\u6302\u4e86\u7684\u60c5\u51b5\uff0c\u6700\u9ad8\u6548\u7684\u505a\u6cd5\u5c31\u662f\u76f4\u63a5\u6267\u884c alter table \u8bed\u53e5\u3002</p>\n<p>\u6bd4\u8f83\u7406\u60f3\u7684\u662f\u80fd\u591f\u5728\u5907\u5e93\u5148\u6267\u884c\u3002\u5047\u8bbe\u4f60\u73b0\u5728\u7684\u670d\u52a1\u662f\u4e00\u4e3b\u4e00\u5907\uff0c\u4e3b\u5e93 A\u3001\u5907\u5e93 B\uff0c\u8fd9\u4e2a\u65b9\u6848\u7684\u5927\u81f4\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5728\u5907\u5e93 B \u4e0a\u6267\u884c <code>set sql_log_bin=off</code>\uff0c\u4e5f\u5c31\u662f\u4e0d\u5199 binlog\uff0c\u7136\u540e\u6267\u884c alter table \u8bed\u53e5\u52a0\u4e0a\u7d22\u5f15\uff1b</li>\n<li>\u6267\u884c\u4e3b\u5907\u5207\u6362\uff1b</li>\n<li>\u8fd9\u65f6\u5019\u4e3b\u5e93\u662f B\uff0c\u5907\u5e93\u662f A\u3002\u5728 A \u4e0a\u6267\u884c <code>set sql_log_bin=off</code>\uff0c\u7136\u540e\u6267\u884c alter table \u8bed\u53e5\u52a0\u4e0a\u7d22\u5f15\u3002</li>\n</ol>\n<p>\u8fd9\u662f\u4e00\u4e2a\u201c\u53e4\u8001\u201d\u7684 DDL \u65b9\u6848\u3002\u5e73\u65f6\u5728\u505a\u53d8\u66f4\u7684\u65f6\u5019\uff0c\u4f60\u5e94\u8be5\u8003\u8651\u7c7b\u4f3c <a href=\"https://github.com/github/gh-ost\">gh-ost</a> \u8fd9\u6837\u7684\u65b9\u6848\uff0c\u66f4\u52a0\u7a33\u59a5\u3002\u4f46\u662f\u5728\u9700\u8981\u7d27\u6025\u5904\u7406\u65f6\uff0c\u4e0a\u9762\u8fd9\u4e2a\u65b9\u6848\u7684\u6548\u7387\u662f\u6700\u9ad8\u7684\u3002</p>\n<p><strong>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e8c\u79cd\u53ef\u80fd\u662f\uff0c\u8bed\u53e5\u6ca1\u5199\u597d\u3002</strong></p>\n<p>\u6bd4\u5982\uff0c\u6211\u4eec\u72af\u4e86\u5728\u7b2c 18 \u7bc7\u6587\u7ae0[\u300a\u4e3a\u4ec0\u4e48\u8fd9\u4e9b SQL \u8bed\u53e5\u903b\u8f91\u76f8\u540c\uff0c\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\uff1f\u300b]\u4e2d\u63d0\u5230\u7684\u90a3\u4e9b\u9519\u8bef\uff0c\u5bfc\u81f4\u8bed\u53e5\u6ca1\u6709\u4f7f\u7528\u4e0a\u7d22\u5f15\u3002</p>\n<p>\u8fd9\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6539\u5199 SQL \u8bed\u53e5\u6765\u5904\u7406\u3002MySQL 5.7 \u63d0\u4f9b\u4e86 <code>query_rewrite</code> \u529f\u80fd\uff0c\u53ef\u4ee5\u628a\u8f93\u5165\u7684\u4e00\u79cd\u8bed\u53e5\u6539\u5199\u6210\u53e6\u5916\u4e00\u79cd\u6a21\u5f0f\u3002</p>\n<p>\u6bd4\u5982\uff0c\u8bed\u53e5\u88ab\u9519\u8bef\u5730\u5199\u6210\u4e86 <code>select * from t where id + 1 = 10000</code>\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u65b9\u5f0f\uff0c\u589e\u52a0\u4e00\u4e2a\u8bed\u53e5\u6539\u5199\u89c4\u5219\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">query_rewrite</span><span class=\"p\">.</span><span class=\"n\">rewrite_rules</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern_database</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"ss\">&quot;select * from t where id + 1 = ?&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">&quot;select * from t where id = ? - 1&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">&quot;test&quot;</span><span class=\"p\">);</span><span class=\"w\"> </span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">query_rewrite</span><span class=\"p\">.</span><span class=\"n\">flush_rewrite_rules</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\uff0c<code>call query_rewrite.flush_rewrite_rules()</code> \u8fd9\u4e2a\u5b58\u50a8\u8fc7\u7a0b\uff0c\u662f\u8ba9\u63d2\u5165\u7684\u65b0\u89c4\u5219\u751f\u6548\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684\u201c\u67e5\u8be2\u91cd\u5199\u201d\u3002\u4f60\u53ef\u4ee5\u7528\u56fe 4 \u4e2d\u7684\u65b9\u6cd5\u6765\u786e\u8ba4\u6539\u5199\u89c4\u5219\u662f\u5426\u751f\u6548\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">warnings</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Level</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Code</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Message</span><span class=\"w\">                                                                                                            </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Note</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1105</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"s1\">&#39;select * from t where id + 1 = 1&#39;</span><span class=\"w\"> </span><span class=\"n\">rewritten</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;select * from t where id = 1 - 1&#39;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">rewrite</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+--------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u5982\u679c\u4f60\u5728\u6267\u884c\u4e0a\u8ff0\u63d2\u5165\u8bed\u53e5\u63d0\u793a <code>ERROR 1049 (42000): Unknown database 'query_rewrite'</code>\uff0c\u5219\u8bf4\u660e\u4f60\u7684\u6570\u636e\u5e93\u6ca1\u6709\u542f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u542f\u7528\u65b9\u5f0f\u5982\u4e0b\uff0c\u9996\u5148\u5bfc\u5165\u542f\u7528\u811a\u672c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"err\">$</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">uroot</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"k\">share</span><span class=\"o\">/</span><span class=\"n\">mysql</span><span class=\"o\">/</span><span class=\"n\">install_rewriter</span><span class=\"p\">.</span><span class=\"k\">sql</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u67e5\u8be2\u6765\u786e\u8ba4\u5df2\u7ecf\u542f\u7528\u4e86\u8be5\u529f\u80fd</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">SHOW</span><span class=\"w\"> </span><span class=\"k\">GLOBAL</span><span class=\"w\"> </span><span class=\"n\">VARIABLES</span><span class=\"w\"> </span><span class=\"k\">LIKE</span><span class=\"w\"> </span><span class=\"s1\">&#39;rewriter_enabled&#39;</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Variable_name</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+-------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">rewriter_enabled</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+-------+</span>\n</code></pre></div>\n<p>\u5982\u679c\u4f60\u4e0d\u9700\u8981\u8fd9\u4e2a\u529f\u80fd\u4e86\uff0c\u5219\u53ef\u4ee5\u6267\u884c <code>/usr/share/mysql/uninstall_rewriter.sql</code> \u8fd9\u4e2a\u811a\u672c\u6765\u5378\u8f7d</p>\n<p><strong>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e09\u79cd\u53ef\u80fd\u662fMySQL \u9009\u9519\u4e86\u7d22\u5f15\u3002</strong></p>\n<p>\u8fd9\u65f6\u5019\uff0c\u5e94\u6025\u65b9\u6848\u5c31\u662f\u7ed9\u8fd9\u4e2a\u8bed\u53e5\u52a0\u4e0a <code>force index</code>\u3002</p>\n<p>\u540c\u6837\u5730\uff0c\u4f7f\u7528\u67e5\u8be2\u91cd\u5199\u529f\u80fd\uff0c\u7ed9\u539f\u6765\u7684\u8bed\u53e5\u52a0\u4e0a <code>force index</code>\uff0c\u4e5f\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u4e0a\u9762\u6211\u548c\u4f60\u8ba8\u8bba\u7684\u7531\u6162\u67e5\u8be2\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u7684\u4e09\u79cd\u53ef\u80fd\u60c5\u51b5\uff0c\u5b9e\u9645\u4e0a\u51fa\u73b0\u6700\u591a\u7684\u662f\u524d\u4e24\u79cd\uff0c\u5373\uff1a\u7d22\u5f15\u6ca1\u8bbe\u8ba1\u597d\u548c\u8bed\u53e5\u6ca1\u5199\u597d\u3002\u800c\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u6070\u6070\u662f\u5b8c\u5168\u53ef\u4ee5\u907f\u514d\u7684\u3002\u6bd4\u5982\uff0c\u901a\u8fc7\u4e0b\u9762\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u5148\u53d1\u73b0\u95ee\u9898\u3002</p>\n<ol>\n<li>\u4e0a\u7ebf\u524d\uff0c\u5728\u6d4b\u8bd5\u73af\u5883\uff0c\u628a\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6253\u5f00\uff0c\u5e76\u4e14\u628a <code>long_query_time</code> \u8bbe\u7f6e\u6210 0\uff0c\u786e\u4fdd\u6bcf\u4e2a\u8bed\u53e5\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5165\u6162\u67e5\u8be2\u65e5\u5fd7\uff1b</li>\n<li>\u5728\u6d4b\u8bd5\u8868\u91cc\u63d2\u5165\u6a21\u62df\u7ebf\u4e0a\u7684\u6570\u636e\uff0c\u505a\u4e00\u904d\u56de\u5f52\u6d4b\u8bd5\uff1b</li>\n<li>\u89c2\u5bdf\u6162\u67e5\u8be2\u65e5\u5fd7\u91cc\u6bcf\u7c7b\u8bed\u53e5\u7684\u8f93\u51fa\uff0c\u7279\u522b\u7559\u610f <code>Rows_examined</code> \u5b57\u6bb5\u662f\u5426\u4e0e\u9884\u671f\u4e00\u81f4\u3002</li>\n</ol>\n<p>\u4e0d\u8981\u541d\u556c\u8fd9\u6bb5\u82b1\u5728\u4e0a\u7ebf\u524d\u7684\u201c\u989d\u5916\u201d\u65f6\u95f4\uff0c\u56e0\u4e3a\u8fd9\u4f1a\u5e2e\u4f60\u7701\u4e0b\u5f88\u591a\u6545\u969c\u590d\u76d8\u7684\u65f6\u95f4\u3002</p>\n<p>\u5982\u679c\u65b0\u589e\u7684 SQL \u8bed\u53e5\u4e0d\u591a\uff0c\u624b\u52a8\u8dd1\u4e00\u4e0b\u5c31\u53ef\u4ee5\u3002\u800c\u5982\u679c\u662f\u65b0\u9879\u76ee\u7684\u8bdd\uff0c\u6216\u8005\u662f\u4fee\u6539\u4e86\u539f\u6709\u9879\u76ee\u7684 \u8868\u7ed3\u6784\u8bbe\u8ba1\uff0c\u5168\u91cf\u56de\u5f52\u6d4b\u8bd5\u90fd\u662f\u5fc5\u8981\u7684\u3002\u8fd9\u65f6\u5019\uff0c\u4f60\u9700\u8981\u5de5\u5177\u5e2e\u4f60\u68c0\u67e5\u6240\u6709\u7684 SQL \u8bed\u53e5\u7684\u8fd4\u56de\u7ed3\u679c\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u5f00\u6e90\u5de5\u5177 <a href=\"https://docs.percona.com/percona-toolkit/pt-query-digest.html\">pt-query-digest</a></p>\n<h3 id=\"qps\">QPS \u7a81\u589e\u95ee\u9898<a class=\"headerlink\" href=\"#qps\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6709\u65f6\u5019\u7531\u4e8e\u4e1a\u52a1\u7a81\u7136\u51fa\u73b0\u9ad8\u5cf0\uff0c\u6216\u8005\u5e94\u7528\u7a0b\u5e8f bug\uff0c\u5bfc\u81f4\u67d0\u4e2a\u8bed\u53e5\u7684 QPS \u7a81\u7136\u66b4\u6da8\uff0c\u4e5f\u53ef\u80fd\u5bfc\u81f4 MySQL \u538b\u529b\u8fc7\u5927\uff0c\u5f71\u54cd\u670d\u52a1\u3002</p>\n<p>\u6211\u4e4b\u524d\u78b0\u5230\u8fc7\u4e00\u7c7b\u60c5\u51b5\uff0c\u662f\u7531\u4e00\u4e2a\u65b0\u529f\u80fd\u7684 bug \u5bfc\u81f4\u7684\u3002\u5f53\u7136\uff0c\u6700\u7406\u60f3\u7684\u60c5\u51b5\u662f\u8ba9\u4e1a\u52a1\u628a\u8fd9\u4e2a\u529f\u80fd\u4e0b\u6389\uff0c\u670d\u52a1\u81ea\u7136\u5c31\u4f1a\u6062\u590d\u3002</p>\n<p>\u800c\u4e0b\u6389\u4e00\u4e2a\u529f\u80fd\uff0c\u5982\u679c\u4ece\u6570\u636e\u5e93\u7aef\u5904\u7406\u7684\u8bdd\uff0c\u5bf9\u5e94\u4e8e\u4e0d\u540c\u7684\u80cc\u666f\uff0c\u6709\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u7528\u3002</p>\n<ol>\n<li>\u4e00\u79cd\u662f\u7531\u5168\u65b0\u4e1a\u52a1\u7684 bug \u5bfc\u81f4\u7684\u3002\u5047\u8bbe\u4f60\u7684 DB \u8fd0\u7ef4\u662f\u6bd4\u8f83\u89c4\u8303\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u767d\u540d\u5355\u662f\u4e00\u4e2a\u4e2a\u52a0\u7684\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4f60\u80fd\u591f\u786e\u5b9a\u4e1a\u52a1\u65b9\u4f1a\u4e0b\u6389\u8fd9\u4e2a\u529f\u80fd\uff0c\u53ea\u662f\u65f6\u95f4\u4e0a\u6ca1\u90a3\u4e48\u5feb\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4ece\u6570\u636e\u5e93\u7aef\u76f4\u63a5\u628a\u767d\u540d\u5355\u53bb\u6389\u3002</li>\n<li>\u5982\u679c\u8fd9\u4e2a\u65b0\u529f\u80fd\u4f7f\u7528\u7684\u662f\u5355\u72ec\u7684\u6570\u636e\u5e93\u7528\u6237\uff0c\u53ef\u4ee5\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u628a\u8fd9\u4e2a\u7528\u6237\u5220\u6389\uff0c\u7136\u540e\u65ad\u5f00\u73b0\u6709\u8fde\u63a5\u3002\u8fd9\u6837\uff0c\u8fd9\u4e2a\u65b0\u529f\u80fd\u7684\u8fde\u63a5\u4e0d\u6210\u529f\uff0c\u7531\u5b83\u5f15\u53d1\u7684 QPS \u5c31\u4f1a\u53d8\u6210 0\u3002</li>\n<li>\u5982\u679c\u8fd9\u4e2a\u65b0\u589e\u7684\u529f\u80fd\u8ddf\u4e3b\u4f53\u529f\u80fd\u662f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u80fd\u901a\u8fc7\u5904\u7406\u8bed\u53e5\u6765\u9650\u5236\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u67e5\u8be2\u91cd\u5199\u529f\u80fd\uff0c\u628a\u538b\u529b\u6700\u5927\u7684 SQL \u8bed\u53e5\u76f4\u63a5\u91cd\u5199\u6210 <code>select 1</code> \u8fd4\u56de\u3002</li>\n</ol>\n<p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u7684\u98ce\u9669\u5f88\u9ad8\uff0c\u9700\u8981\u4f60\u7279\u522b\u7ec6\u81f4\u3002\u5b83\u53ef\u80fd\u5b58\u5728\u4e24\u4e2a\u526f\u4f5c\u7528\uff1a</p>\n<ol>\n<li>\u5982\u679c\u522b\u7684\u529f\u80fd\u91cc\u9762\u4e5f\u7528\u5230\u4e86\u8fd9\u4e2a SQL \u8bed\u53e5\u6a21\u677f\uff0c\u4f1a\u6709\u8bef\u4f24\uff1b</li>\n<li>\u5f88\u591a\u4e1a\u52a1\u5e76\u4e0d\u662f\u9760\u8fd9\u4e00\u4e2a\u8bed\u53e5\u5c31\u80fd\u5b8c\u6210\u903b\u8f91\u7684\uff0c\u6240\u4ee5\u5982\u679c\u5355\u72ec\u628a\u8fd9\u4e00\u4e2a\u8bed\u53e5\u4ee5 <code>select 1</code> \u7684\u7ed3\u679c\u8fd4\u56de\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u540e\u9762\u7684\u4e1a\u52a1\u903b\u8f91\u4e00\u8d77\u5931\u8d25\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0c\u65b9\u6848 3 \u662f\u7528\u4e8e\u6b62\u8840\u7684\uff0c\u8ddf\u524d\u9762\u63d0\u5230\u7684\u53bb\u6389\u6743\u9650\u9a8c\u8bc1\u4e00\u6837\uff0c\u5e94\u8be5\u662f\u4f60\u6240\u6709\u9009\u9879\u91cc\u4f18\u5148\u7ea7\u6700\u4f4e\u7684\u4e00\u4e2a\u65b9\u6848\u3002</p>\n<p>\u540c\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u5176\u5b9e\u65b9\u6848 1 \u548c 2 \u90fd\u8981\u4f9d\u8d56\u4e8e\u89c4\u8303\u7684\u8fd0\u7ef4\u4f53\u7cfb\uff1a\u865a\u62df\u5316\u3001\u767d\u540d\u5355\u673a\u5236\u3001\u4e1a\u52a1\u8d26\u53f7\u5206\u79bb\u3002\u7531\u6b64\u53ef\u89c1\uff0c\u66f4\u591a\u7684\u51c6\u5907\uff0c\u5f80\u5f80\u610f\u5473\u7740\u66f4\u7a33\u5b9a\u7684\u7cfb\u7edf\u3002</p>\n<h3 id=\"_14\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_14\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4ee5\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u6027\u80fd\u95ee\u9898\u4e3a\u80cc\u666f\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e9b\u7d27\u6025\u5904\u7406\u7684\u624b\u6bb5\u3002</p>\n<p>\u8fd9\u4e9b\u5904\u7406\u624b\u6bb5\u4e2d\uff0c\u65e2\u5305\u62ec\u4e86\u7c97\u66b4\u5730\u62d2\u7edd\u8fde\u63a5\u548c\u65ad\u5f00\u8fde\u63a5\uff0c\u4e5f\u6709\u901a\u8fc7\u91cd\u5199\u8bed\u53e5\u6765\u7ed5\u8fc7\u4e00\u4e9b\u5751\u7684\u65b9\u6cd5\uff1b\u65e2\u6709\u4e34\u65f6\u7684\u9ad8\u5371\u65b9\u6848\uff0c\u4e5f\u6709\u672a\u96e8\u7ef8\u7f2a\u7684\u3001\u76f8\u5bf9\u5b89\u5168\u7684\u9884\u6848\u3002</p>\n<p>\u5728\u5b9e\u9645\u5f00\u53d1\u4e2d\uff0c\u6211\u4eec\u4e5f\u8981\u5c3d\u91cf\u907f\u514d\u4e00\u4e9b\u4f4e\u6548\u7684\u65b9\u6cd5\uff0c\u6bd4\u5982\u907f\u514d\u5927\u91cf\u5730\u4f7f\u7528\u77ed\u8fde\u63a5\u3002\u540c\u65f6\uff0c\u5982\u679c\u4f60\u505a\u4e1a\u52a1\u5f00\u53d1\u7684\u8bdd\uff0c\u8981\u77e5\u9053\uff0c\u8fde\u63a5\u5f02\u5e38\u65ad\u5f00\u662f\u5e38\u6709\u7684\u4e8b\uff0c\u4f60\u7684\u4ee3\u7801\u91cc\u8981\u6709\u6b63\u786e\u5730\u91cd\u8fde\u5e76\u91cd\u8bd5\u7684\u673a\u5236\u3002</p>\n<p>DBA \u867d\u7136\u53ef\u4ee5\u901a\u8fc7\u8bed\u53e5\u91cd\u5199\u6765\u6682\u65f6\u5904\u7406\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u672c\u8eab\u662f\u4e00\u4e2a\u98ce\u9669\u9ad8\u7684\u64cd\u4f5c\uff0c\u505a\u597d SQL \u5ba1\u8ba1\u53ef\u4ee5\u51cf\u5c11\u9700\u8981\u8fd9\u7c7b\u64cd\u4f5c\u7684\u673a\u4f1a\u3002</p>\n<p>\u5176\u5b9e\uff0c\u4f60\u53ef\u4ee5\u770b\u5f97\u51fa\u6765\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u6211\u63d0\u5230\u7684\u89e3\u51b3\u65b9\u6cd5\u4e3b\u8981\u96c6\u4e2d\u5728 server \u5c42\u3002\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4f1a\u7ee7\u7eed\u548c\u4f60\u8ba8\u8bba\u4e00\u4e9b\u8ddf InnoDB \u6709\u5173\u7684\u5904\u7406\u65b9\u6cd5\u3002</p>\n<h2 id=\"23-mysql\">23 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u7684\uff1f<a class=\"headerlink\" href=\"#23-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4f1a\u7ee7\u7eed\u548c\u4f60\u4ecb\u7ecd\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u4e34\u65f6\u63d0\u5347\u6027\u80fd\u7684\u65b9\u6cd5\u3002\u4ece\u6587\u7ae0\u6807\u9898\u201cMySQL \u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u7684\uff1f\u201d\uff0c\u4f60\u5c31\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u4eca\u5929\u6211\u548c\u4f60\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u8ddf\u6570\u636e\u7684\u53ef\u9760\u6027\u6709\u5173\u3002</p>\n<p>\u5728\u4e13\u680f\u524d\u9762\u6587\u7ae0\u548c\u7b54\u7591\u7bc7\u4e2d\uff0c\u6211\u90fd\u7740\u91cd\u4ecb\u7ecd\u4e86 WAL \u673a\u5236\uff0c\u5f97\u5230\u7684\u7ed3\u8bba\u662f\uff1a\u53ea\u8981 redo log \u548c binlog \u4fdd\u8bc1\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u5c31\u80fd\u786e\u4fdd MySQL \u5f02\u5e38\u91cd\u542f\u540e\uff0c\u6570\u636e\u53ef\u4ee5\u6062\u590d\u3002</p>\n<p>\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u53c8\u7ee7\u7eed\u8ffd\u95ee\uff0credo log \u7684\u5199\u5165\u6d41\u7a0b\u662f\u600e\u4e48\u6837\u7684\uff0c\u5982\u4f55\u4fdd\u8bc1 redo log \u771f\u5b9e\u5730\u5199\u5165\u4e86\u78c1\u76d8\u3002\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u518d\u4e00\u8d77\u770b\u770b MySQL \u5199\u5165 binlog \u548c redo log \u7684\u6d41\u7a0b\u3002</p>\n<h3 id=\"binlog\">binlog \u7684\u5199\u5165\u673a\u5236<a class=\"headerlink\" href=\"#binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5176\u5b9e\uff0cbinlog \u7684\u5199\u5165\u903b\u8f91\u6bd4\u8f83\u7b80\u5355\uff1a\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5148\u628a\u65e5\u5fd7\u5199\u5230 binlog cache\uff0c\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u518d\u628a binlog cache \u5199\u5230 binlog \u6587\u4ef6\u4e2d\u3002</p>\n<p>\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u4e0d\u80fd\u88ab\u62c6\u5f00\u7684\uff0c\u56e0\u6b64\u4e0d\u8bba\u8fd9\u4e2a\u4e8b\u52a1\u591a\u5927\uff0c\u4e5f\u8981\u786e\u4fdd\u4e00\u6b21\u6027\u5199\u5165\u3002\u8fd9\u5c31\u6d89\u53ca\u5230\u4e86 binlog cache \u7684\u4fdd\u5b58\u95ee\u9898\u3002</p>\n<p>\u7cfb\u7edf\u7ed9 binlog cache \u5206\u914d\u4e86\u4e00\u7247\u5185\u5b58\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u4e00\u4e2a\uff0c\u53c2\u6570 binlog_cache_size \u7528\u4e8e\u63a7\u5236\u5355\u4e2a\u7ebf\u7a0b\u5185 binlog cache \u6240\u5360\u5185\u5b58\u7684\u5927\u5c0f\u3002\u5982\u679c\u8d85\u8fc7\u4e86\u8fd9\u4e2a\u53c2\u6570\u89c4\u5b9a\u7684\u5927\u5c0f\uff0c\u5c31\u8981\u6682\u5b58\u5230\u78c1\u76d8\u3002</p>\n<p>\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6267\u884c\u5668\u628a binlog cache \u91cc\u7684\u5b8c\u6574\u4e8b\u52a1\u5199\u5165\u5230 binlog \u4e2d\uff0c\u5e76\u6e05\u7a7a binlog cache\u3002\u72b6\u6001\u5982\u56fe 1 \u6240\u793a\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/9ed86644d5f39efb0efec595abb92e3e.png\" /></p>\n<p>\u56fe 1 binlog \u5199\u76d8\u72b6\u6001</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u81ea\u5df1 binlog cache\uff0c\u4f46\u662f\u5171\u7528\u540c\u4e00\u4efd binlog \u6587\u4ef6\u3002</p>\n<ul>\n<li>\u56fe\u4e2d\u7684 write\uff0c\u6307\u7684\u5c31\u662f\u6307\u628a\u65e5\u5fd7\u5199\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\uff0c\u5e76\u6ca1\u6709\u628a\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u6240\u4ee5\u901f\u5ea6\u6bd4\u8f83\u5feb\u3002</li>\n<li>\u56fe\u4e2d\u7684 fsync\uff0c\u624d\u662f\u5c06\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u64cd\u4f5c\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u8ba4\u4e3a fsync \u624d\u5360\u78c1\u76d8\u7684 IOPS\u3002</li>\n</ul>\n<p>write \u548c fsync \u7684\u65f6\u673a\uff0c\u662f\u7531\u53c2\u6570 <code>sync_binlog</code> \u63a7\u5236\u7684\uff1a</p>\n<ol>\n<li><code>sync_binlog=0</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u53ea write\uff0c\u4e0d fsync\uff1b</li>\n<li><code>sync_binlog=1</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u4f1a\u6267\u884c fsync\uff1b</li>\n<li><code>sync_binlog=N</code>(N&gt;1) \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd write\uff0c\u4f46\u7d2f\u79ef N \u4e2a\u4e8b\u52a1\u540e\u624d fsync\u3002</li>\n</ol>\n<p>\u56e0\u6b64\uff0c\u5728\u51fa\u73b0 IO \u74f6\u9888\u7684\u573a\u666f\u91cc\uff0c\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u6210\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u503c\uff0c\u53ef\u4ee5\u63d0\u5347\u6027\u80fd\u3002\u5728\u5b9e\u9645\u7684\u4e1a\u52a1\u573a\u666f\u4e2d\uff0c\u8003\u8651\u5230\u4e22\u5931\u65e5\u5fd7\u91cf\u7684\u53ef\u63a7\u6027\uff0c\u4e00\u822c\u4e0d\u5efa\u8bae\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u6210 0\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u662f\u5c06\u5176\u8bbe\u7f6e\u4e3a 100~1000 \u4e2d\u7684\u67d0\u4e2a\u6570\u503c\u3002</p>\n<p>\u4f46\u662f\uff0c\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u4e3a N\uff0c\u5bf9\u5e94\u7684\u98ce\u9669\u662f\uff1a\u5982\u679c\u4e3b\u673a\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4f1a\u4e22\u5931\u6700\u8fd1 N \u4e2a\u4e8b\u52a1\u7684 binlog \u65e5\u5fd7\u3002</p>\n<h3 id=\"redo-log\">redo log \u7684\u5199\u5165\u673a\u5236<a class=\"headerlink\" href=\"#redo-log\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u8bf4\u8bf4 redo log \u7684\u5199\u5165\u673a\u5236\u3002</p>\n<p>\u5728\u4e13\u680f\u7684[\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0]\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 redo log buffer\u3002\u4e8b\u52a1\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u7684 redo log \u662f\u8981\u5148\u5199\u5230 redo log buffer \u7684\u3002</p>\n<p>\u7136\u540e\u5c31\u6709\u540c\u5b66\u95ee\u4e86\uff0credo log buffer \u91cc\u9762\u7684\u5185\u5bb9\uff0c\u662f\u4e0d\u662f\u6bcf\u6b21\u751f\u6210\u540e\u90fd\u8981\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u4e0d\u9700\u8981\u3002</p>\n<p>\u5982\u679c\u4e8b\u52a1\u6267\u884c\u671f\u95f4 MySQL \u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u90a3\u8fd9\u90e8\u5206\u65e5\u5fd7\u5c31\u4e22\u4e86\u3002\u7531\u4e8e\u4e8b\u52a1\u5e76\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u8fd9\u65f6\u65e5\u5fd7\u4e22\u4e86\u4e5f\u4e0d\u4f1a\u6709\u635f\u5931\u3002</p>\n<p>\u90a3\u4e48\uff0c\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u662f\uff0c\u4e8b\u52a1\u8fd8\u6ca1\u63d0\u4ea4\u7684\u65f6\u5019\uff0credo log buffer \u4e2d\u7684\u90e8\u5206\u65e5\u5fd7\u6709\u6ca1\u6709\u53ef\u80fd\u88ab\u6301\u4e45\u5316\u5230\u78c1\u76d8\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u786e\u5b9e\u4f1a\u6709\u3002</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\uff0c\u8981\u4ece redo log \u53ef\u80fd\u5b58\u5728\u7684\u4e09\u79cd\u72b6\u6001\u8bf4\u8d77\u3002\u8fd9\u4e09\u79cd\u72b6\u6001\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u56fe 2 \u4e2d\u7684\u4e09\u4e2a\u989c\u8272\u5757\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/9d057f61d3962407f413deebc80526d4.png\" /></p>\n<p>\u56fe 2 MySQL redo log \u5b58\u50a8\u72b6\u6001</p>\n<p>\u8fd9\u4e09\u79cd\u72b6\u6001\u5206\u522b\u662f\uff1a</p>\n<ol>\n<li>\u5b58\u5728 redo log buffer \u4e2d\uff0c\u7269\u7406\u4e0a\u662f\u5728 MySQL \u8fdb\u7a0b\u5185\u5b58\u4e2d\uff0c\u5c31\u662f\u56fe\u4e2d\u7684\u7ea2\u8272\u90e8\u5206\uff1b</li>\n<li>\u5199\u5230\u78c1\u76d8 (write)\uff0c\u4f46\u662f\u6ca1\u6709\u6301\u4e45\u5316\uff08fsync)\uff0c\u7269\u7406\u4e0a\u662f\u5728\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u91cc\u9762\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684\u9ec4\u8272\u90e8\u5206\uff1b</li>\n<li>\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u5bf9\u5e94\u7684\u662f hard disk\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684\u7eff\u8272\u90e8\u5206\u3002</li>\n</ol>\n<p>\u65e5\u5fd7\u5199\u5230 redo log buffer \u662f\u5f88\u5feb\u7684\uff0cwirte \u5230 page cache \u4e5f\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u901f\u5ea6\u5c31\u6162\u591a\u4e86\u3002</p>\n<p>\u4e3a\u4e86\u63a7\u5236 redo log \u7684\u5199\u5165\u7b56\u7565\uff0cInnoDB \u63d0\u4f9b\u4e86 <code>innodb_flush_log_at_trx_commit</code> \u53c2\u6570\uff0c\u5b83\u6709\u4e09\u79cd\u53ef\u80fd\u53d6\u503c\uff1a</p>\n<ol>\n<li>\u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u53ea\u662f\u628a redo log \u7559\u5728 redo log buffer \u4e2d ;</li>\n<li>\u8bbe\u7f6e\u4e3a 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u5c06 redo log \u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff1b</li>\n<li>\u8bbe\u7f6e\u4e3a 2 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u53ea\u662f\u628a redo log \u5199\u5230 page cache\u3002</li>\n</ol>\n<p>InnoDB \u6709\u4e00\u4e2a\u540e\u53f0\u7ebf\u7a0b\uff0c\u6bcf\u9694 1 \u79d2\uff0c\u5c31\u4f1a\u628a redo log buffer \u4e2d\u7684\u65e5\u5fd7\uff0c\u8c03\u7528 write \u5199\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\uff0c\u7136\u540e\u8c03\u7528 fsync \u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002</p>\n<p>\u6ce8\u610f\uff0c\u4e8b\u52a1\u6267\u884c\u4e2d\u95f4\u8fc7\u7a0b\u7684 redo log \u4e5f\u662f\u76f4\u63a5\u5199\u5728 redo log buffer \u4e2d\u7684\uff0c\u8fd9\u4e9b redo log \u4e5f\u4f1a\u88ab\u540e\u53f0\u7ebf\u7a0b\u4e00\u8d77\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u6ca1\u6709\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684 redo log\uff0c\u4e5f\u662f\u53ef\u80fd\u5df2\u7ecf\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u9664\u4e86\u540e\u53f0\u7ebf\u7a0b\u6bcf\u79d2\u4e00\u6b21\u7684\u8f6e\u8be2\u64cd\u4f5c\u5916\uff0c\u8fd8\u6709\u4e24\u79cd\u573a\u666f\u4f1a\u8ba9\u4e00\u4e2a\u6ca1\u6709\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684 redo log \u5199\u5165\u5230\u78c1\u76d8\u4e2d\u3002</p>\n<ol>\n<li>**\u4e00\u79cd\u662f\uff0credo log buffer \u5360\u7528\u7684\u7a7a\u95f4\u5373\u5c06\u8fbe\u5230 innodb_log_buffer_size \u4e00\u534a\u7684\u65f6\u5019\uff0c\u540e\u53f0\u7ebf\u7a0b\u4f1a\u4e3b\u52a8\u5199\u76d8\u3002**\u6ce8\u610f\uff0c\u7531\u4e8e\u8fd9\u4e2a\u4e8b\u52a1\u5e76\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5199\u76d8\u52a8\u4f5c\u53ea\u662f write\uff0c\u800c\u6ca1\u6709\u8c03\u7528 fsync\uff0c\u4e5f\u5c31\u662f\u53ea\u7559\u5728\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\u3002</li>\n<li>**\u53e6\u4e00\u79cd\u662f\uff0c\u5e76\u884c\u7684\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u987a\u5e26\u5c06\u8fd9\u4e2a\u4e8b\u52a1\u7684 redo log buffer \u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002**\u5047\u8bbe\u4e00\u4e2a\u4e8b\u52a1 A \u6267\u884c\u5230\u4e00\u534a\uff0c\u5df2\u7ecf\u5199\u4e86\u4e00\u4e9b redo log \u5230 buffer \u4e2d\uff0c\u8fd9\u65f6\u5019\u6709\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u7684\u4e8b\u52a1 B \u63d0\u4ea4\uff0c\u5982\u679c <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u7684\u662f 1\uff0c\u90a3\u4e48\u6309\u7167\u8fd9\u4e2a\u53c2\u6570\u7684\u903b\u8f91\uff0c\u4e8b\u52a1 B \u8981\u628a redo log buffer \u91cc\u7684\u65e5\u5fd7\u5168\u90e8\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u65f6\u5019\uff0c\u5c31\u4f1a\u5e26\u4e0a\u4e8b\u52a1 A \u5728 redo log buffer \u91cc\u7684\u65e5\u5fd7\u4e00\u8d77\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u65f6\u5019\u8bf4\u8fc7\uff0c\u65f6\u5e8f\u4e0a redo log \u5148 prepare\uff0c \u518d\u5199 binlog\uff0c\u6700\u540e\u518d\u628a redo log commit\u3002</p>\n<p>\u5982\u679c\u628a <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u6210 1\uff0c\u90a3\u4e48 redo log \u5728 prepare \u9636\u6bb5\u5c31\u8981\u6301\u4e45\u5316\u4e00\u6b21\uff0c\u56e0\u4e3a\u6709\u4e00\u4e2a\u5d29\u6e83\u6062\u590d\u903b\u8f91\u662f\u8981\u4f9d\u8d56\u4e8e prepare \u7684 redo log\uff0c\u518d\u52a0\u4e0a binlog \u6765\u6062\u590d\u7684\u3002</p>\n<p>\u6bcf\u79d2\u4e00\u6b21\u540e\u53f0\u8f6e\u8be2\u5237\u76d8\uff0c\u518d\u52a0\u4e0a\u5d29\u6e83\u6062\u590d\u8fd9\u4e2a\u903b\u8f91\uff0cInnoDB \u5c31\u8ba4\u4e3a redo log \u5728 commit \u7684\u65f6\u5019\u5c31\u4e0d\u9700\u8981 fsync \u4e86\uff0c\u53ea\u4f1a write \u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u4e2d\u5c31\u591f\u4e86\u3002</p>\n<p>\u901a\u5e38\u6211\u4eec\u8bf4 MySQL \u7684\u201c\u53cc 1\u201d\u914d\u7f6e\uff0c\u6307\u7684\u5c31\u662f <code>sync_binlog</code> \u548c <code>innodb_flush_log_at_trx_commit</code> \u90fd\u8bbe\u7f6e\u6210 1\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u4e8b\u52a1\u5b8c\u6574\u63d0\u4ea4\u524d\uff0c\u9700\u8981\u7b49\u5f85\u4e24\u6b21\u5237\u76d8\uff0c\u4e00\u6b21\u662f redo log\uff08prepare \u9636\u6bb5\uff09\uff0c\u4e00\u6b21\u662f binlog\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4ece MySQL \u770b\u5230\u7684 TPS \u662f\u6bcf\u79d2\u4e24\u4e07\u7684\u8bdd\uff0c\u6bcf\u79d2\u5c31\u4f1a\u5199\u56db\u4e07\u6b21\u78c1\u76d8\u3002\u4f46\u662f\uff0c\u6211\u7528\u5de5\u5177\u6d4b\u8bd5\u51fa\u6765\uff0c\u78c1\u76d8\u80fd\u529b\u4e5f\u5c31\u4e24\u4e07\u5de6\u53f3\uff0c\u600e\u4e48\u80fd\u5b9e\u73b0\u4e24\u4e07\u7684 TPS\uff1f</p>\n<p>\u89e3\u91ca\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u8981\u7528\u5230\u7ec4\u63d0\u4ea4\uff08group commit\uff09\u673a\u5236\u4e86\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u65e5\u5fd7\u903b\u8f91\u5e8f\u5217\u53f7\uff08log sequence number\uff0cLSN\uff09\u7684\u6982\u5ff5\u3002LSN \u662f\u5355\u8c03\u9012\u589e\u7684\uff0c\u7528\u6765\u5bf9\u5e94 redo log \u7684\u4e00\u4e2a\u4e2a\u5199\u5165\u70b9\u3002\u6bcf\u6b21\u5199\u5165\u957f\u5ea6\u4e3a length \u7684 redo log\uff0c LSN \u7684\u503c\u5c31\u4f1a\u52a0\u4e0a length\u3002</p>\n<p>LSN \u4e5f\u4f1a\u5199\u5230 InnoDB \u7684\u6570\u636e\u9875\u4e2d\uff0c\u6765\u786e\u4fdd\u6570\u636e\u9875\u4e0d\u4f1a\u88ab\u591a\u6b21\u6267\u884c\u91cd\u590d\u7684 redo log\u3002\u5173\u4e8e LSN \u548c redo log\u3001checkpoint \u7684\u5173\u7cfb\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u8be6\u7ec6\u5c55\u5f00\u3002</p>\n<p>\u5982\u56fe 3 \u6240\u793a\uff0c\u662f\u4e09\u4e2a\u5e76\u53d1\u4e8b\u52a1 (trx1, trx2, trx3) \u5728 prepare \u9636\u6bb5\uff0c\u90fd\u5199\u5b8c redo log buffer\uff0c\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u5bf9\u5e94\u7684 LSN \u5206\u522b\u662f 50\u3001120 \u548c 160\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/933fdc052c6339de2aa3bf3f65b188cc.png\" /></p>\n<p>\u56fe 3 redo log \u7ec4\u63d0\u4ea4</p>\n<p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c</p>\n<ol>\n<li>trx1 \u662f\u7b2c\u4e00\u4e2a\u5230\u8fbe\u7684\uff0c\u4f1a\u88ab\u9009\u4e3a\u8fd9\u7ec4\u7684 leader\uff1b</li>\n<li>\u7b49 trx1 \u8981\u5f00\u59cb\u5199\u76d8\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u7ec4\u91cc\u9762\u5df2\u7ecf\u6709\u4e86\u4e09\u4e2a\u4e8b\u52a1\uff0c\u8fd9\u65f6\u5019 LSN \u4e5f\u53d8\u6210\u4e86 160\uff1b</li>\n<li>trx1 \u53bb\u5199\u76d8\u7684\u65f6\u5019\uff0c\u5e26\u7684\u5c31\u662f LSN=160\uff0c\u56e0\u6b64\u7b49 trx1 \u8fd4\u56de\u65f6\uff0c\u6240\u6709 LSN \u5c0f\u4e8e\u7b49\u4e8e 160 \u7684 redo log\uff0c\u90fd\u5df2\u7ecf\u88ab\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff1b</li>\n<li>\u8fd9\u65f6\u5019 trx2 \u548c trx3 \u5c31\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u4e86\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0c\u4e00\u6b21\u7ec4\u63d0\u4ea4\u91cc\u9762\uff0c\u7ec4\u5458\u8d8a\u591a\uff0c\u8282\u7ea6\u78c1\u76d8 IOPS \u7684\u6548\u679c\u8d8a\u597d\u3002\u4f46\u5982\u679c\u53ea\u6709\u5355\u7ebf\u7a0b\u538b\u6d4b\uff0c\u90a3\u5c31\u53ea\u80fd\u8001\u8001\u5b9e\u5b9e\u5730\u4e00\u4e2a\u4e8b\u52a1\u5bf9\u5e94\u4e00\u6b21\u6301\u4e45\u5316\u64cd\u4f5c\u4e86\u3002</p>\n<p>\u5728\u5e76\u53d1\u66f4\u65b0\u573a\u666f\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5199\u5b8c redo log buffer \u4ee5\u540e\uff0c\u63a5\u4e0b\u6765\u8fd9\u4e2a fsync \u8d8a\u665a\u8c03\u7528\uff0c\u7ec4\u5458\u53ef\u80fd\u8d8a\u591a\uff0c\u8282\u7ea6 IOPS \u7684\u6548\u679c\u5c31\u8d8a\u597d\u3002</p>\n<p>\u4e3a\u4e86\u8ba9\u4e00\u6b21 fsync \u5e26\u7684\u7ec4\u5458\u66f4\u591a\uff0cMySQL \u6709\u4e00\u4e2a\u5f88\u6709\u8da3\u7684\u4f18\u5316\uff1a\u62d6\u65f6\u95f4\u3002\u5728\u4ecb\u7ecd\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6211\u66fe\u7ecf\u7ed9\u4f60\u753b\u4e86\u4e00\u4e2a\u56fe\uff0c\u73b0\u5728\u6211\u628a\u5b83\u622a\u8fc7\u6765\u3002</p>\n<pre class=\"mermaid\"><code>graph TB\n    A[\"\u5199\u5165redolog&lt;br/&gt;\u5904\u4e8eprepare\u9636\u6bb5\"]\n    B[\"\u5199 binlog\"]\n    C[\"\u63d0\u4ea4\u4e8b\u52a1&lt;br/&gt;\u5904\u4e8e commit \u72b6\u6001\"]\n\n    A --&gt; B --&gt; C</code></pre>\n<p>\u56fe 4 \u4e24\u9636\u6bb5\u63d0\u4ea4</p>\n<p>\u56fe\u4e2d\uff0c\u6211\u628a\u201c\u5199 binlog\u201d\u5f53\u6210\u4e00\u4e2a\u52a8\u4f5c\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u5199 binlog \u662f\u5206\u6210\u4e24\u6b65\u7684\uff1a</p>\n<ol>\n<li>\u5148\u628a binlog \u4ece binlog cache \u4e2d\u5199\u5230\u78c1\u76d8\u4e0a\u7684 binlog \u6587\u4ef6\uff1b</li>\n<li>\u8c03\u7528 fsync \u6301\u4e45\u5316\u3002</li>\n</ol>\n<p>MySQL \u4e3a\u4e86\u8ba9\u7ec4\u63d0\u4ea4\u7684\u6548\u679c\u66f4\u597d\uff0c\u628a redo log \u505a fsync \u7684\u65f6\u95f4\u62d6\u5230\u4e86\u6b65\u9aa4 1 \u4e4b\u540e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e0a\u9762\u7684\u56fe\u53d8\u6210\u4e86\u8fd9\u6837\uff1a</p>\n<pre class=\"mermaid\"><code>graph TB\n    A[\"1. redo log prepare: write\"]\n    B[\"2. binlog: write\"]\n    C[\"3. redo log preapre: fsync\"]\n    D[\"4. binlog: fsync\"]\n    E[\"5. redo log commit: write\"]\n\n    A --&gt; B --&gt; C \n    A .-&gt; C\n    B .-&gt; D\n    C --&gt; D \n    D --&gt; E</code></pre>\n<p>\u56fe 5 \u4e24\u9636\u6bb5\u63d0\u4ea4\u7ec6\u5316</p>\n<p>\u8fd9\u4e48\u4e00\u6765\uff0cbinlog \u4e5f\u53ef\u4ee5\u7ec4\u63d0\u4ea4\u4e86\u3002\u5728\u6267\u884c\u56fe 5 \u4e2d\u7b2c 4 \u6b65\u628a binlog fsync \u5230\u78c1\u76d8\u65f6\uff0c\u5982\u679c\u6709\u591a\u4e2a\u4e8b\u52a1\u7684 binlog \u5df2\u7ecf\u5199\u5b8c\u4e86\uff0c\u4e5f\u662f\u4e00\u8d77\u6301\u4e45\u5316\u7684\uff0c\u8fd9\u6837\u4e5f\u53ef\u4ee5\u51cf\u5c11 IOPS \u7684\u6d88\u8017\u3002</p>\n<p>\u4e0d\u8fc7\u901a\u5e38\u60c5\u51b5\u4e0b\u7b2c 3 \u6b65\u6267\u884c\u5f97\u4f1a\u5f88\u5feb\uff0c\u6240\u4ee5 binlog \u7684 write \u548c fsync \u95f4\u7684\u95f4\u9694\u65f6\u95f4\u77ed\uff0c\u5bfc\u81f4\u80fd\u96c6\u5408\u5230\u4e00\u8d77\u6301\u4e45\u5316\u7684 binlog \u6bd4\u8f83\u5c11\uff0c\u56e0\u6b64 binlog \u7684\u7ec4\u63d0\u4ea4\u7684\u6548\u679c\u901a\u5e38\u4e0d\u5982 redo log \u7684\u6548\u679c\u90a3\u4e48\u597d\u3002</p>\n<p>\u5982\u679c\u4f60\u60f3\u63d0\u5347 binlog \u7ec4\u63d0\u4ea4\u7684\u6548\u679c\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>binlog_group_commit_sync_delay</code> \u548c <code>binlog_group_commit_sync_no_delay_count</code> \u6765\u5b9e\u73b0\u3002</p>\n<ol>\n<li><code>binlog_group_commit_sync_delay</code> \u53c2\u6570\uff0c\u8868\u793a\u5ef6\u8fdf\u591a\u5c11\u5fae\u79d2\u540e\u624d\u8c03\u7528 fsync;</li>\n<li><code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u8868\u793a\u7d2f\u79ef\u591a\u5c11\u6b21\u4ee5\u540e\u624d\u8c03\u7528 fsync\u3002</li>\n</ol>\n<p>\u8fd9\u4e24\u4e2a\u6761\u4ef6\u662f\u6216\u7684\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u8981\u6709\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u5c31\u4f1a\u8c03\u7528 fsync\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5f53 <code>binlog_group_commit_sync_delay</code> \u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c<code>binlog_group_commit_sync_no_delay_count</code> \u4e5f\u65e0\u6548\u4e86\u3002</p>\n<p>\u4e4b\u524d\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u95ee\u5230\uff0cWAL \u673a\u5236\u662f\u51cf\u5c11\u78c1\u76d8\u5199\uff0c\u53ef\u662f\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u8981\u5199 redo log \u548c binlog\uff0c\u8fd9\u78c1\u76d8\u8bfb\u5199\u6b21\u6570\u4e5f\u6ca1\u53d8\u5c11\u5440\uff1f</p>\n<p>\u73b0\u5728\u4f60\u5c31\u80fd\u7406\u89e3\u4e86\uff0cWAL \u673a\u5236\u4e3b\u8981\u5f97\u76ca\u4e8e\u4e24\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>redo log \u548c binlog \u90fd\u662f\u987a\u5e8f\u5199\uff0c\u78c1\u76d8\u7684\u987a\u5e8f\u5199\u6bd4\u968f\u673a\u5199\u901f\u5ea6\u8981\u5feb\uff1b</li>\n<li>\u7ec4\u63d0\u4ea4\u673a\u5236\uff0c\u53ef\u4ee5\u5927\u5e45\u5ea6\u964d\u4f4e\u78c1\u76d8\u7684 IOPS \u6d88\u8017\u3002</li>\n</ol>\n<p>\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u518d\u6765\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff1a<strong>\u5982\u679c\u4f60\u7684 MySQL \u73b0\u5728\u51fa\u73b0\u4e86\u6027\u80fd\u74f6\u9888\uff0c\u800c\u4e14\u74f6\u9888\u5728 IO \u4e0a\uff0c\u53ef\u4ee5\u901a\u8fc7\u54ea\u4e9b\u65b9\u6cd5\u6765\u63d0\u5347\u6027\u80fd\u5462\uff1f</strong></p>\n<p>\u9488\u5bf9\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u8003\u8651\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u8bbe\u7f6e <code>binlog_group_commit_sync_delay</code> \u548c <code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u51cf\u5c11 binlog \u7684\u5199\u76d8\u6b21\u6570\u3002\u8fd9\u4e2a\u65b9\u6cd5\u662f\u57fa\u4e8e\u201c\u989d\u5916\u7684\u6545\u610f\u7b49\u5f85\u201d\u6765\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u53ef\u80fd\u4f1a\u589e\u52a0\u8bed\u53e5\u7684\u54cd\u5e94\u65f6\u95f4\uff0c\u4f46\u6ca1\u6709\u4e22\u5931\u6570\u636e\u7684\u98ce\u9669\u3002</li>\n<li>\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u4e3a\u5927\u4e8e 1 \u7684\u503c\uff08\u6bd4\u8f83\u5e38\u89c1\u662f 100~1000\uff09\u3002\u8fd9\u6837\u505a\u7684\u98ce\u9669\u662f\uff0c\u4e3b\u673a\u6389\u7535\u65f6\u4f1a\u4e22 binlog \u65e5\u5fd7\u3002</li>\n<li>\u5c06 <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u4e3a 2\u3002\u8fd9\u6837\u505a\u7684\u98ce\u9669\u662f\uff0c\u4e3b\u673a\u6389\u7535\u7684\u65f6\u5019\u4f1a\u4e22\u6570\u636e\u3002</li>\n</ol>\n<p>\u6211\u4e0d\u5efa\u8bae\u4f60\u628a <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u6210 0\u3002\u56e0\u4e3a\u628a\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 0\uff0c\u8868\u793a redo log \u53ea\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u8fd9\u6837\u7684\u8bdd MySQL \u672c\u8eab\u5f02\u5e38\u91cd\u542f\u4e5f\u4f1a\u4e22\u6570\u636e\uff0c\u98ce\u9669\u592a\u5927\u3002\u800c redo log \u5199\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u7684\u901f\u5ea6\u4e5f\u662f\u5f88\u5feb\u7684\uff0c\u6240\u4ee5\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 2 \u8ddf\u8bbe\u7f6e\u6210 0 \u5176\u5b9e\u6027\u80fd\u5dee\u4e0d\u591a\uff0c\u4f46\u8fd9\u6837\u505a MySQL \u5f02\u5e38\u91cd\u542f\u65f6\u5c31\u4e0d\u4f1a\u4e22\u6570\u636e\u4e86\uff0c\u76f8\u6bd4\u4e4b\u4e0b\u98ce\u9669\u4f1a\u66f4\u5c0f\u3002</p>\n<h3 id=\"_15\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_15\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4e13\u680f\u7684[\u7b2c 2 \u7bc7]\u548c[\u7b2c 15 \u7bc7]\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u5206\u6790\u4e86\uff0c\u5982\u679c redo log \u548c binlog \u662f\u5b8c\u6574\u7684\uff0cMySQL \u662f\u5982\u4f55\u4fdd\u8bc1 crash-safe \u7684\u3002\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7740\u91cd\u548c\u4f60\u4ecb\u7ecd\u7684\u662f MySQL \u662f\u201c\u600e\u4e48\u4fdd\u8bc1 redo log \u548c binlog \u662f\u5b8c\u6574\u7684\u201d\u3002</p>\n<p>\u5e0c\u671b\u8fd9\u4e09\u7bc7\u6587\u7ae0\u4e32\u8d77\u6765\u7684\u5185\u5bb9\uff0c\u80fd\u591f\u8ba9\u4f60\u5bf9 crash-safe \u8fd9\u4e2a\u6982\u5ff5\u6709\u66f4\u6e05\u6670\u7684\u7406\u89e3\u3002</p>\n<p>\u4e4b\u524d\u7684\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0\u53d1\u5e03\u4e4b\u540e\uff0c\u6709\u540c\u5b66\u7ee7\u7eed\u7559\u8a00\u95ee\u5230\u4e86\u4e00\u4e9b\u8ddf\u65e5\u5fd7\u76f8\u5173\u7684\u95ee\u9898\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u4f60\u56de\u987e\u3001\u5b66\u4e60\uff0c\u6211\u518d\u96c6\u4e2d\u56de\u7b54\u4e00\u6b21\u8fd9\u4e9b\u95ee\u9898\u3002</p>\n<p>**\u95ee\u9898 1\uff1a**\u6267\u884c\u4e00\u4e2a update \u8bed\u53e5\u4ee5\u540e\uff0c\u6211\u518d\u53bb\u6267\u884c hexdump \u547d\u4ee4\u76f4\u63a5\u67e5\u770b ibd \u6587\u4ef6\u5185\u5bb9\uff0c\u4e3a\u4ec0\u4e48\u6ca1\u6709\u770b\u5230\u6570\u636e\u6709\u6539\u53d8\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a WAL \u673a\u5236\u7684\u539f\u56e0\u3002update \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0cInnoDB \u53ea\u4fdd\u8bc1\u5199\u5b8c\u4e86 redo log\u3001\u5185\u5b58\uff0c\u53ef\u80fd\u8fd8\u6ca1\u6765\u5f97\u53ca\u5c06\u6570\u636e\u5199\u5230\u78c1\u76d8\u3002</p>\n<p>**\u95ee\u9898 2\uff1a**\u4e3a\u4ec0\u4e48 binlog cache \u662f\u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u7ef4\u62a4\u7684\uff0c\u800c redo log buffer \u662f\u5168\u5c40\u5171\u7528\u7684\uff1f</p>\n<p>\u56de\u7b54\uff1aMySQL \u8fd9\u4e48\u8bbe\u8ba1\u7684\u4e3b\u8981\u539f\u56e0\u662f\uff0cbinlog \u662f\u4e0d\u80fd\u201c\u88ab\u6253\u65ad\u7684\u201d\u3002\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u5fc5\u987b\u8fde\u7eed\u5199\uff0c\u56e0\u6b64\u8981\u6574\u4e2a\u4e8b\u52a1\u5b8c\u6210\u540e\uff0c\u518d\u4e00\u8d77\u5199\u5230\u6587\u4ef6\u91cc\u3002</p>\n<p>\u800c redo log \u5e76\u6ca1\u6709\u8fd9\u4e2a\u8981\u6c42\uff0c\u4e2d\u95f4\u6709\u751f\u6210\u7684\u65e5\u5fd7\u53ef\u4ee5\u5199\u5230 redo log buffer \u4e2d\u3002redo log buffer \u4e2d\u7684\u5185\u5bb9\u8fd8\u80fd\u201c\u642d\u4fbf\u8f66\u201d\uff0c\u5176\u4ed6\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u53ef\u4ee5\u88ab\u4e00\u8d77\u5199\u5230\u78c1\u76d8\u4e2d\u3002</p>\n<p>**\u95ee\u9898 3\uff1a**\u4e8b\u52a1\u6267\u884c\u671f\u95f4\uff0c\u8fd8\u6ca1\u5230\u63d0\u4ea4\u9636\u6bb5\uff0c\u5982\u679c\u53d1\u751f crash \u7684\u8bdd\uff0credo log \u80af\u5b9a\u4e22\u4e86\uff0c\u8fd9\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a\u4e0d\u4f1a\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019 binlog \u4e5f\u8fd8\u5728 binlog cache \u91cc\uff0c\u6ca1\u53d1\u7ed9\u5907\u5e93\u3002crash \u4ee5\u540e redo log \u548c binlog \u90fd\u6ca1\u6709\u4e86\uff0c\u4ece\u4e1a\u52a1\u89d2\u5ea6\u770b\u8fd9\u4e2a\u4e8b\u52a1\u4e5f\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002</p>\n<p>**\u95ee\u9898 4\uff1a**\u5982\u679c binlog \u5199\u5b8c\u76d8\u4ee5\u540e\u53d1\u751f crash\uff0c\u8fd9\u65f6\u5019\u8fd8\u6ca1\u7ed9\u5ba2\u6237\u7aef\u7b54\u590d\u5c31\u91cd\u542f\u4e86\u3002\u7b49\u5ba2\u6237\u7aef\u518d\u91cd\u8fde\u8fdb\u6765\uff0c\u53d1\u73b0\u4e8b\u52a1\u5df2\u7ecf\u63d0\u4ea4\u6210\u529f\u4e86\uff0c\u8fd9\u662f\u4e0d\u662f bug\uff1f</p>\n<p>\u56de\u7b54\uff1a\u4e0d\u662f\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u66f4\u6781\u7aef\u7684\u60c5\u51b5\uff0c\u6574\u4e2a\u4e8b\u52a1\u90fd\u63d0\u4ea4\u6210\u529f\u4e86\uff0credo log commit \u5b8c\u6210\u4e86\uff0c\u5907\u5e93\u4e5f\u6536\u5230 binlog \u5e76\u6267\u884c\u4e86\u3002\u4f46\u662f\u4e3b\u5e93\u548c\u5ba2\u6237\u7aef\u7f51\u7edc\u65ad\u5f00\u4e86\uff0c\u5bfc\u81f4\u4e8b\u52a1\u6210\u529f\u7684\u5305\u8fd4\u56de\u4e0d\u56de\u53bb\uff0c\u8fd9\u65f6\u5019\u5ba2\u6237\u7aef\u4e5f\u4f1a\u6536\u5230\u201c\u7f51\u7edc\u65ad\u5f00\u201d\u7684\u5f02\u5e38\u3002\u8fd9\u79cd\u4e5f\u53ea\u80fd\u7b97\u662f\u4e8b\u52a1\u6210\u529f\u7684\uff0c\u4e0d\u80fd\u8ba4\u4e3a\u662f bug\u3002</p>\n<p>\u5b9e\u9645\u4e0a\u6570\u636e\u5e93\u7684 crash-safe \u4fdd\u8bc1\u7684\u662f\uff1a</p>\n<ol>\n<li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u4e8b\u52a1\u6210\u529f\u7684\u6d88\u606f\uff0c\u4e8b\u52a1\u5c31\u4e00\u5b9a\u6301\u4e45\u5316\u4e86\uff1b</li>\n<li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u4e8b\u52a1\u5931\u8d25\uff08\u6bd4\u5982\u4e3b\u952e\u51b2\u7a81\u3001\u56de\u6eda\u7b49\uff09\u7684\u6d88\u606f\uff0c\u4e8b\u52a1\u5c31\u4e00\u5b9a\u5931\u8d25\u4e86\uff1b</li>\n<li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u201c\u6267\u884c\u5f02\u5e38\u201d\u7684\u6d88\u606f\uff0c\u5e94\u7528\u9700\u8981\u91cd\u8fde\u540e\u901a\u8fc7\u67e5\u8be2\u5f53\u524d\u72b6\u6001\u6765\u7ee7\u7eed\u540e\u7eed\u7684\u903b\u8f91\u3002\u6b64\u65f6\u6570\u636e\u5e93\u53ea\u9700\u8981\u4fdd\u8bc1\u5185\u90e8\uff08\u6570\u636e\u548c\u65e5\u5fd7\u4e4b\u95f4\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u4e4b\u95f4\uff09\u4e00\u81f4\u5c31\u53ef\u4ee5\u4e86\u3002</li>\n</ol>\n<h2 id=\"24-mysql\">24 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u4e3b\u5907\u4e00\u81f4\u7684\uff1f<a class=\"headerlink\" href=\"#24-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4e0d\u6b62\u4e00\u6b21\u5730\u548c\u4f60\u63d0\u5230\u4e86 binlog\uff0c\u5927\u5bb6\u77e5\u9053 binlog \u53ef\u4ee5\u7528\u6765\u5f52\u6863\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u505a\u4e3b\u5907\u540c\u6b65\uff0c\u4f46\u5b83\u7684\u5185\u5bb9\u662f\u4ec0\u4e48\u6837\u7684\u5462\uff1f\u4e3a\u4ec0\u4e48\u5907\u5e93\u6267\u884c\u4e86 binlog \u5c31\u53ef\u4ee5\u8ddf\u4e3b\u5e93\u4fdd\u6301\u4e00\u81f4\u4e86\u5462\uff1f\u4eca\u5929\u6211\u5c31\u6b63\u5f0f\u5730\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e0b\u5b83\u3002</p>\n<p>\u6beb\u4e0d\u5938\u5f20\u5730\u8bf4\uff0cMySQL \u80fd\u591f\u6210\u4e3a\u73b0\u4e0b\u6700\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u5e93\uff0cbinlog \u529f\u4e0d\u53ef\u6ca1\u3002</p>\n<p>\u5728\u6700\u5f00\u59cb\uff0cMySQL \u662f\u4ee5\u5bb9\u6613\u5b66\u4e60\u548c\u65b9\u4fbf\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u88ab\u5f00\u53d1\u4eba\u5458\u9752\u7750\u7684\u3002\u800c\u5b83\u7684\u51e0\u4e4e\u6240\u6709\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u90fd\u76f4\u63a5\u4f9d\u8d56\u4e8e binlog\u3002\u867d\u7136\u8fd9\u4e9b\u9ad8\u53ef\u7528\u67b6\u6784\u5df2\u7ecf\u5448\u73b0\u51fa\u8d8a\u6765\u8d8a\u590d\u6742\u7684\u8d8b\u52bf\uff0c\u4f46\u90fd\u662f\u4ece\u6700\u57fa\u672c\u7684\u4e00\u4e3b\u4e00\u5907\u6f14\u5316\u8fc7\u6765\u7684\u3002</p>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u6211\u4e3b\u8981\u4e3a\u4f60\u4ecb\u7ecd\u4e3b\u5907\u7684\u57fa\u672c\u539f\u7406\u3002\u7406\u89e3\u4e86\u80cc\u540e\u7684\u8bbe\u8ba1\u539f\u7406\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4ece\u4e1a\u52a1\u5f00\u53d1\u7684\u89d2\u5ea6\uff0c\u6765\u501f\u9274\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u60f3\u3002</p>\n<h3 id=\"mysql\">MySQL \u4e3b\u5907\u7684\u57fa\u672c\u539f\u7406<a class=\"headerlink\" href=\"#mysql\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u56fe 1 \u6240\u793a\u5c31\u662f\u57fa\u672c\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/fd75a2b37ae6ca709b7f16fe060c2c10.png\" /></p>\n<p>\u56fe 1 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b</p>\n<p>\u5728\u72b6\u6001 1 \u4e2d\uff0c\u5ba2\u6237\u7aef\u7684\u8bfb\u5199\u90fd\u76f4\u63a5\u8bbf\u95ee\u8282\u70b9 A\uff0c\u800c\u8282\u70b9 B \u662f A \u7684\u5907\u5e93\uff0c\u53ea\u662f\u5c06 A \u7684\u66f4\u65b0\u90fd\u540c\u6b65\u8fc7\u6765\uff0c\u5230\u672c\u5730\u6267\u884c\u3002\u8fd9\u6837\u53ef\u4ee5\u4fdd\u6301\u8282\u70b9 B \u548c A \u7684\u6570\u636e\u662f\u76f8\u540c\u7684\u3002</p>\n<p>\u5f53\u9700\u8981\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u5207\u6210\u72b6\u6001 2\u3002\u8fd9\u65f6\u5019\u5ba2\u6237\u7aef\u8bfb\u5199\u8bbf\u95ee\u7684\u90fd\u662f\u8282\u70b9 B\uff0c\u800c\u8282\u70b9 A \u662f B \u7684\u5907\u5e93\u3002</p>\n<p>\u5728\u72b6\u6001 1 \u4e2d\uff0c\u867d\u7136\u8282\u70b9 B \u6ca1\u6709\u88ab\u76f4\u63a5\u8bbf\u95ee\uff0c\u4f46\u662f\u6211\u4f9d\u7136\u5efa\u8bae\u4f60\u628a\u8282\u70b9 B\uff08\u4e5f\u5c31\u662f\u5907\u5e93\uff09\u8bbe\u7f6e\u6210\u53ea\u8bfb\uff08readonly\uff09\u6a21\u5f0f\u3002\u8fd9\u6837\u505a\uff0c\u6709\u4ee5\u4e0b\u51e0\u4e2a\u8003\u8651\uff1a</p>\n<ol>\n<li>\u6709\u65f6\u5019\u4e00\u4e9b\u8fd0\u8425\u7c7b\u7684\u67e5\u8be2\u8bed\u53e5\u4f1a\u88ab\u653e\u5230\u5907\u5e93\u4e0a\u53bb\u67e5\uff0c\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u53ef\u4ee5\u9632\u6b62\u8bef\u64cd\u4f5c\uff1b</li>\n<li>\u9632\u6b62\u5207\u6362\u903b\u8f91\u6709 bug\uff0c\u6bd4\u5982\u5207\u6362\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u53cc\u5199\uff0c\u9020\u6210\u4e3b\u5907\u4e0d\u4e00\u81f4\uff1b</li>\n<li>\u53ef\u4ee5\u7528 readonly \u72b6\u6001\uff0c\u6765\u5224\u65ad\u8282\u70b9\u7684\u89d2\u8272\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u6211\u628a\u5907\u5e93\u8bbe\u7f6e\u6210\u53ea\u8bfb\u4e86\uff0c\u8fd8\u600e\u4e48\u8ddf\u4e3b\u5e93\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\u5462\uff1f</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u4e0d\u7528\u62c5\u5fc3\u3002\u56e0\u4e3a readonly \u8bbe\u7f6e\u5bf9\u8d85\u7ea7 (super) \u6743\u9650\u7528\u6237\u662f\u65e0\u6548\u7684\uff0c\u800c\u7528\u4e8e\u540c\u6b65\u66f4\u65b0\u7684\u7ebf\u7a0b\uff0c\u5c31\u62e5\u6709\u8d85\u7ea7\u6743\u9650\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b**\u8282\u70b9 A \u5230 B \u8fd9\u6761\u7ebf\u7684\u5185\u90e8\u6d41\u7a0b\u662f\u4ec0\u4e48\u6837\u7684**\u3002\u56fe 2 \u4e2d\u753b\u51fa\u7684\u5c31\u662f\u4e00\u4e2a update \u8bed\u53e5\u5728\u8282\u70b9 A \u6267\u884c\uff0c\u7136\u540e\u540c\u6b65\u5230\u8282\u70b9 B \u7684\u5b8c\u6574\u6d41\u7a0b\u56fe\u3002</p>\n<pre class=\"mermaid\"><code>graph TB \n    subgraph A [\"master A\"]\n    direction LR\n    undo[\"undo log(mem)\"] --&gt; data[\"data(mem)\"] --&gt; redo[\"redo log(prepare)\"] --&gt; binlog\n    binlog --&gt; redo2[\"redo log (commit)\"]\n    binlog --&gt; dump[\"dump_thread\"]\n\n    bg_thread --&gt; undo2[\"undo log(disk)\"] --&gt; data2[\"data(disk)\"]\n    end\n\n    subgraph B [\"slave B\"]\n        direction RL\n        ioThread[\"io_thread\"] --&gt; relay[\"relay log\"] --&gt; sqlThread[\"sql_thread\"] --&gt; dataB[\"DATA\"] \n    end\n\n    dump --&gt; ioThread\n    start --&gt;undo\n    redo2 --&gt; ack</code></pre>\n<p>\u56fe 2 \u4e3b\u5907\u6d41\u7a0b\u56fe</p>\n<p>\u56fe 2 \u4e2d\uff0c\u5305\u542b\u4e86\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bb2\u5230\u7684 binlog \u548c redo log \u7684\u5199\u5165\u673a\u5236\u76f8\u5173\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u770b\u5230\uff1a\u4e3b\u5e93\u63a5\u6536\u5230\u5ba2\u6237\u7aef\u7684\u66f4\u65b0\u8bf7\u6c42\u540e\uff0c\u6267\u884c\u5185\u90e8\u4e8b\u52a1\u7684\u66f4\u65b0\u903b\u8f91\uff0c\u540c\u65f6\u5199 binlog\u3002</p>\n<p>\u5907\u5e93 B \u8ddf\u4e3b\u5e93 A \u4e4b\u95f4\u7ef4\u6301\u4e86\u4e00\u4e2a\u957f\u8fde\u63a5\u3002\u4e3b\u5e93 A \u5185\u90e8\u6709\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e13\u95e8\u7528\u4e8e\u670d\u52a1\u5907\u5e93 B \u7684\u8fd9\u4e2a\u957f\u8fde\u63a5\u3002\u4e00\u4e2a\u4e8b\u52a1\u65e5\u5fd7\u540c\u6b65\u7684\u5b8c\u6574\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5728\u5907\u5e93 B \u4e0a\u901a\u8fc7 change master \u547d\u4ee4\uff0c\u8bbe\u7f6e\u4e3b\u5e93 A \u7684 IP\u3001\u7aef\u53e3\u3001\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u4ee5\u53ca\u8981\u4ece\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u8bf7\u6c42 binlog\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5305\u542b\u6587\u4ef6\u540d\u548c\u65e5\u5fd7\u504f\u79fb\u91cf\u3002</li>\n<li>\u5728\u5907\u5e93 B \u4e0a\u6267\u884c start slave \u547d\u4ee4\uff0c\u8fd9\u65f6\u5019\u5907\u5e93\u4f1a\u542f\u52a8\u4e24\u4e2a\u7ebf\u7a0b\uff0c\u5c31\u662f\u56fe\u4e2d\u7684 <code>io_thread</code> \u548c <code>sql_thread</code>\u3002\u5176\u4e2d <code>io_thread</code> \u8d1f\u8d23\u4e0e\u4e3b\u5e93\u5efa\u7acb\u8fde\u63a5\u3002</li>\n<li>\u4e3b\u5e93 A \u6821\u9a8c\u5b8c\u7528\u6237\u540d\u3001\u5bc6\u7801\u540e\uff0c\u5f00\u59cb\u6309\u7167\u5907\u5e93 B \u4f20\u8fc7\u6765\u7684\u4f4d\u7f6e\uff0c\u4ece\u672c\u5730\u8bfb\u53d6 binlog\uff0c\u53d1\u7ed9 B\u3002</li>\n<li>\u5907\u5e93 B \u62ff\u5230 binlog \u540e\uff0c\u5199\u5230\u672c\u5730\u6587\u4ef6\uff0c\u79f0\u4e3a\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u3002</li>\n<li><code>sql_thread</code> \u8bfb\u53d6\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u89e3\u6790\u51fa\u65e5\u5fd7\u91cc\u7684\u547d\u4ee4\uff0c\u5e76\u6267\u884c\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\uff0c\u540e\u6765\u7531\u4e8e\u591a\u7ebf\u7a0b\u590d\u5236\u65b9\u6848\u7684\u5f15\u5165\uff0c<code>sql_thread</code> \u6f14\u5316\u6210\u4e3a\u4e86\u591a\u4e2a\u7ebf\u7a0b\uff0c\u8ddf\u6211\u4eec\u4eca\u5929\u8981\u4ecb\u7ecd\u7684\u539f\u7406\u6ca1\u6709\u76f4\u63a5\u5173\u7cfb\uff0c\u6682\u4e14\u4e0d\u5c55\u5f00\u3002</p>\n<p>\u5206\u6790\u5b8c\u4e86\u8fd9\u4e2a\u957f\u8fde\u63a5\u7684\u903b\u8f91\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u95ee\u9898\uff1abinlog \u91cc\u9762\u5230\u5e95\u662f\u4ec0\u4e48\u5185\u5bb9\uff0c\u4e3a\u4ec0\u4e48\u5907\u5e93\u62ff\u8fc7\u53bb\u53ef\u4ee5\u76f4\u63a5\u6267\u884c\u3002</p>\n<h3 id=\"binlog_1\">binlog \u7684\u4e09\u79cd\u683c\u5f0f\u5bf9\u6bd4<a class=\"headerlink\" href=\"#binlog_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u5728[\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0]\u4e2d\uff0c\u548c\u4f60\u63d0\u5230\u8fc7 binlog \u6709\u4e24\u79cd\u683c\u5f0f\uff0c\u4e00\u79cd\u662f statement\uff0c\u4e00\u79cd\u662f row\u3002\u53ef\u80fd\u4f60\u5728\u5176\u4ed6\u8d44\u6599\u4e0a\u8fd8\u4f1a\u770b\u5230\u6709\u7b2c\u4e09\u79cd\u683c\u5f0f\uff0c\u53eb\u4f5c mixed\uff0c\u5176\u5b9e\u5b83\u5c31\u662f\u524d\u4e24\u79cd\u683c\u5f0f\u7684\u6df7\u5408\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0 binlog \u7684\u8fd9\u4e09\u79cd\u683c\u5f0f\u95f4\u7684\u533a\u522b\uff0c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a\u8868\uff0c\u5e76\u521d\u59cb\u5316\u51e0\u884c\u6570\u636e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">CURRENT_TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"s1\">&#39;2018-11-13&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"s1\">&#39;2018-11-12&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"s1\">&#39;2018-11-11&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"s1\">&#39;2018-11-10&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"s1\">&#39;2018-11-09&#39;</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5982\u679c\u8981\u5728\u8868\u4e2d\u5220\u9664\u4e00\u884c\u6570\u636e\u7684\u8bdd\uff0c\u6211\u4eec\u6765\u770b\u770b\u8fd9\u4e2a delete \u8bed\u53e5\u7684 binlog \u662f\u600e\u4e48\u8bb0\u5f55\u7684\u3002</p>\n<p>\u6ce8\u610f\uff0c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5305\u542b\u6ce8\u91ca\uff0c\u5982\u679c\u4f60\u7528 MySQL \u5ba2\u6237\u7aef\u6765\u505a\u8fd9\u4e2a\u5b9e\u9a8c\u7684\u8bdd\uff0c\u8981\u8bb0\u5f97\u52a0 -c \u53c2\u6570\uff0c\u5426\u5219\u5ba2\u6237\u7aef\u4f1a\u81ea\u52a8\u53bb\u6389\u6ce8\u91ca\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"cm\">/*comment*/</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&gt;=</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">&lt;=</span><span class=\"s1\">&#39;2018-11-10&#39;</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5f53 binlog_format=statement \u65f6\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u7684\u5c31\u662f SQL \u8bed\u53e5\u7684\u539f\u6587\u3002\u4f60\u53ef\u4ee5\u7528</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"w\"> </span><span class=\"n\">events</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"s1\">&#39;binlog.000079&#39;</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"mi\">60602403</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Log_name</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Event_type</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Server_id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">End_log_pos</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                                                                                   </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60602403</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Anonymous_Gtid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60602482</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;ANONYMOUS&#39;</span><span class=\"w\">                                                   </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60602482</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60602572</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">BEGIN</span><span class=\"w\">                                                                                  </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60602572</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60602731</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"cm\">/*comment*/</span><span class=\"w\">  </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&gt;=</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">&lt;=</span><span class=\"s1\">&#39;2018-11-10&#39;</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60602731</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Xid</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60602762</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">COMMIT</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630521 */</span><span class=\"w\">                                                                </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+</span>\n</code></pre></div>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8f93\u51fa\u7ed3\u679c\u3002</p>\n<ul>\n<li>\u7b2c\u4e00\u884c <code>SET @@SESSION.GTID_NEXT='ANONYMOUS'</code>\u4f60\u53ef\u4ee5\u5148\u5ffd\u7565\uff0c\u540e\u9762\u6587\u7ae0\u6211\u4eec\u4f1a\u5728\u4ecb\u7ecd\u4e3b\u5907\u5207\u6362\u7684\u65f6\u5019\u518d\u63d0\u5230\uff1b</li>\n<li>\u7b2c\u4e8c\u884c\u662f\u4e00\u4e2a BEGIN\uff0c\u8ddf\u7b2c\u56db\u884c\u7684 commit \u5bf9\u5e94\uff0c\u8868\u793a\u4e2d\u95f4\u662f\u4e00\u4e2a\u4e8b\u52a1\uff1b</li>\n<li>\u7b2c\u4e09\u884c\u5c31\u662f\u771f\u5b9e\u6267\u884c\u7684\u8bed\u53e5\u4e86\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u771f\u5b9e\u6267\u884c\u7684 delete \u547d\u4ee4\u4e4b\u524d\uff0c\u8fd8\u6709\u4e00\u4e2a <code>use 'test'</code>\u547d\u4ee4\u3002\u8fd9\u6761\u547d\u4ee4\u4e0d\u662f\u6211\u4eec\u4e3b\u52a8\u6267\u884c\u7684\uff0c\u800c\u662f MySQL \u6839\u636e\u5f53\u524d\u8981\u64cd\u4f5c\u7684\u8868\u6240\u5728\u7684\u6570\u636e\u5e93\uff0c\u81ea\u884c\u6dfb\u52a0\u7684\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4fdd\u8bc1\u65e5\u5fd7\u4f20\u5230\u5907\u5e93\u53bb\u6267\u884c\u7684\u65f6\u5019\uff0c\u4e0d\u8bba\u5f53\u524d\u7684\u5de5\u4f5c\u7ebf\u7a0b\u5728\u54ea\u4e2a\u5e93\u91cc\uff0c\u90fd\u80fd\u591f\u6b63\u786e\u5730\u66f4\u65b0\u5230 test \u5e93\u7684\u8868 t\u3002 <code>use 'test'</code> \u547d\u4ee4\u4e4b\u540e\u7684 delete \u8bed\u53e5\uff0c\u5c31\u662f\u6211\u4eec\u8f93\u5165\u7684 SQL \u539f\u6587\u4e86\u3002\u53ef\u4ee5\u770b\u5230\uff0cbinlog\u201c\u5fe0\u5b9e\u201d\u5730\u8bb0\u5f55\u4e86 SQL \u547d\u4ee4\uff0c\u751a\u81f3\u8fde\u6ce8\u91ca\u4e5f\u4e00\u5e76\u8bb0\u5f55\u4e86\u3002</li>\n<li>\u6700\u540e\u4e00\u884c\u662f\u4e00\u4e2a COMMIT\u3002\u4f60\u53ef\u4ee5\u770b\u5230\u91cc\u9762\u5199\u7740 xid=630521\u3002</li>\n</ul>\n<p>\u4e3a\u4e86\u8bf4\u660e statement \u548c row \u683c\u5f0f\u7684\u533a\u522b\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6761 delete \u547d\u4ee4\u7684\u6267\u884c\u6548\u679c\u56fe\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">warnings</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Level</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Code</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Message</span><span class=\"w\">                                                                                                                                                                                                                         </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Note</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1592</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Unsafe</span><span class=\"w\"> </span><span class=\"k\">statement</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"nb\">binary</span><span class=\"w\"> </span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"k\">statement</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"n\">BINLOG_FORMAT</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">STATEMENT</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"k\">statement</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">LIMIT</span><span class=\"w\"> </span><span class=\"n\">clause</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"n\">included</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">predicted</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd0\u884c\u8fd9\u6761 delete \u547d\u4ee4\u4ea7\u751f\u4e86\u4e00\u4e2a warning\uff0c\u539f\u56e0\u662f\u5f53\u524d binlog \u8bbe\u7f6e\u7684\u662f statement \u683c\u5f0f\uff0c\u5e76\u4e14\u8bed\u53e5\u4e2d\u6709 limit\uff0c\u6240\u4ee5\u8fd9\u4e2a\u547d\u4ee4\u53ef\u80fd\u662f unsafe \u7684\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a delete \u5e26 limit\uff0c\u5f88\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e3b\u5907\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p>\n<ol>\n<li>\u5982\u679c delete \u8bed\u53e5\u4f7f\u7528\u7684\u662f\u7d22\u5f15 a\uff0c\u90a3\u4e48\u4f1a\u6839\u636e\u7d22\u5f15 a \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u5220\u9664\u7684\u662f a=4 \u8fd9\u4e00\u884c\uff1b</li>\n<li>\u4f46\u5982\u679c\u4f7f\u7528\u7684\u662f\u7d22\u5f15 <code>t_modified</code>\uff0c\u90a3\u4e48\u5220\u9664\u7684\u5c31\u662f <code>t_modified='2018-11-09'</code>\u4e5f\u5c31\u662f a=5 \u8fd9\u4e00\u884c\u3002</li>\n</ol>\n<p>\u7531\u4e8e statement \u683c\u5f0f\u4e0b\uff0c\u8bb0\u5f55\u5230 binlog \u91cc\u7684\u662f\u8bed\u53e5\u539f\u6587\uff0c\u56e0\u6b64\u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u5728\u4e3b\u5e93\u6267\u884c\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u7d22\u5f15 a\uff1b\u800c\u5728\u5907\u5e93\u6267\u884c\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5374\u4f7f\u7528\u4e86\u7d22\u5f15 <code>t_modified</code>\u3002\u56e0\u6b64\uff0cMySQL \u8ba4\u4e3a\u8fd9\u6837\u5199\u662f\u6709\u98ce\u9669\u7684\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u628a binlog \u7684\u683c\u5f0f\u6539\u4e3a <code>binlog_format=\u2018row\u2019</code>\uff0c \u662f\u4e0d\u662f\u5c31\u6ca1\u6709\u8fd9\u4e2a\u95ee\u9898\u4e86\u5462\uff1f\u6211\u4eec\u5148\u6765\u770b\u770b\u8fd9\u65f6\u5019 binog \u4e2d\u7684\u5185\u5bb9\u5427\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"w\"> </span><span class=\"n\">events</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"s1\">&#39;binlog.000079&#39;</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"mi\">60603121</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Log_name</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Event_type</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Server_id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">End_log_pos</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                                 </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603121</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Anonymous_Gtid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603200</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;ANONYMOUS&#39;</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603200</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603283</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">BEGIN</span><span class=\"w\">                                </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603283</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Table_map</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603333</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">table_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">154</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">t</span><span class=\"p\">)</span><span class=\"w\">               </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603333</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Delete_rows</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603381</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">table_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">154</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">STMT_END_F</span><span class=\"w\">      </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603381</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Xid</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603412</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">COMMIT</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630541 */</span><span class=\"w\">              </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+--------------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0e statement \u683c\u5f0f\u7684 binlog \u76f8\u6bd4\uff0c\u524d\u540e\u7684 BEGIN \u548c COMMIT \u662f\u4e00\u6837\u7684\u3002\u4f46\u662f\uff0crow \u683c\u5f0f\u7684 binlog \u91cc\u6ca1\u6709\u4e86 SQL \u8bed\u53e5\u7684\u539f\u6587\uff0c\u800c\u662f\u66ff\u6362\u6210\u4e86\u4e24\u4e2a event: <code>Table_map</code> \u548c <code>Delete_rows</code>\u3002</p>\n<ol>\n<li><code>Table_map</code> event\uff0c\u7528\u4e8e\u8bf4\u660e\u63a5\u4e0b\u6765\u8981\u64cd\u4f5c\u7684\u8868\u662f test \u5e93\u7684\u8868 t;</li>\n<li><code>Delete_rows</code> event\uff0c\u7528\u4e8e\u5b9a\u4e49\u5220\u9664\u7684\u884c\u4e3a\u3002</li>\n</ol>\n<p>\u5176\u5b9e\uff0c\u6211\u4eec\u901a\u8fc7\u56fe 5 \u662f\u770b\u4e0d\u5230\u8be6\u7ec6\u4fe1\u606f\u7684\uff0c\u8fd8\u9700\u8981\u501f\u52a9 mysqlbinlog \u5de5\u5177\uff0c\u7528\u4e0b\u9762\u8fd9\u4e2a\u547d\u4ee4\u89e3\u6790\u548c\u67e5\u770b binlog \u4e2d\u7684\u5185\u5bb9\u3002\u56e0\u4e3a\u56fe 5 \u4e2d\u7684\u4fe1\u606f\u663e\u793a\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u4ece 60603121\u8fd9\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528 <code>--start-position</code> \u53c2\u6570\u6765\u6307\u5b9a\u4ece\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u65e5\u5fd7\u5f00\u59cb\u89e3\u6790\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>mysqlbinlog<span class=\"w\">  </span>-vv<span class=\"w\"> </span>binlog.000079<span class=\"w\"> </span>--start-position<span class=\"o\">=</span><span class=\"m\">60603121</span><span class=\"p\">;</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603283</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x49b211b3</span><span class=\"w\">     </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"n\">thread_id</span><span class=\"o\">=</span><span class=\"mi\">28</span><span class=\"w\">    </span><span class=\"n\">exec_time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"o\">=</span><span class=\"mi\">0</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"o\">=</span><span class=\"mi\">1675237914</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">pseudo_thread_id</span><span class=\"o\">=</span><span class=\"mi\">28</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">foreign_key_checks</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">sql_auto_is_null</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">unique_checks</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">autocommit</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">sql_mode</span><span class=\"o\">=</span><span class=\"mi\">1168113696</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">auto_increment_increment</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">auto_increment_offset</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"cm\">/*!\\C utf8mb4 *//*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">character_set_client</span><span class=\"o\">=</span><span class=\"mi\">45</span><span class=\"p\">,</span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">collation_connection</span><span class=\"o\">=</span><span class=\"mi\">45</span><span class=\"p\">,</span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">collation_server</span><span class=\"o\">=</span><span class=\"mi\">45</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">time_zone</span><span class=\"o\">=</span><span class=\"s1\">&#39;SYSTEM&#39;</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">lc_time_names</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">session</span><span class=\"p\">.</span><span class=\"n\">collation_database</span><span class=\"o\">=</span><span class=\"k\">DEFAULT</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"cm\">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">60603283</span>\n<span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603333</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x261dd71a</span><span class=\"w\">     </span><span class=\"n\">Table_map</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">mapped</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"nb\">number</span><span class=\"w\"> </span><span class=\"mi\">154</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">60603333</span>\n<span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603381</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xbef257a2</span><span class=\"w\">     </span><span class=\"n\">Delete_rows</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">154</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">STMT_END_F</span>\n\n<span class=\"n\">BINLOG</span><span class=\"w\"> </span><span class=\"s1\">&#39;</span>\n<span class=\"s1\">GhraYxMBAAAAMgAAAMW7nAMAAJoAAAAAAAEABHRlc3QAAXQAAwMDEQEAAgEBABrXHSY=</span>\n<span class=\"s1\">GhraYyABAAAAMAAAAPW7nAMAAJoAAAAAAAEAAgAD/wADAAAAAwAAAFvnAICiV/K+</span>\n<span class=\"s1\">&#39;</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"o\">###</span><span class=\"w\"> </span><span class=\"k\">DELETE</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span>\n<span class=\"o\">###</span><span class=\"w\"> </span><span class=\"k\">WHERE</span>\n<span class=\"o\">###</span><span class=\"w\">   </span><span class=\"o\">@</span><span class=\"mi\">1</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"cm\">/* INT meta=0 nullable=0 is_null=0 */</span>\n<span class=\"o\">###</span><span class=\"w\">   </span><span class=\"o\">@</span><span class=\"mi\">2</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"cm\">/* INT meta=0 nullable=1 is_null=0 */</span>\n<span class=\"o\">###</span><span class=\"w\">   </span><span class=\"o\">@</span><span class=\"mi\">3</span><span class=\"o\">=</span><span class=\"mi\">1541865600</span><span class=\"w\"> </span><span class=\"cm\">/* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">60603381</span>\n<span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603412</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x1a408274</span><span class=\"w\">     </span><span class=\"n\">Xid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">630541</span>\n<span class=\"k\">COMMIT</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;AUTOMATIC&#39;</span><span class=\"w\"> </span><span class=\"cm\">/* added by mysqlbinlog */</span><span class=\"w\"> </span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4ece\u8fd9\u4e2a\u56fe\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u51e0\u4e2a\u4fe1\u606f\uff1a</p>\n<ul>\n<li>server id 1\uff0c\u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u662f\u5728 <code>server_id=1</code> \u7684\u8fd9\u4e2a\u5e93\u4e0a\u6267\u884c\u7684\u3002</li>\n<li>\u6bcf\u4e2a event \u90fd\u6709 CRC32 \u7684\u503c\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u628a\u53c2\u6570 <code>binlog_checksum</code> \u8bbe\u7f6e\u6210\u4e86 CRC32\u3002</li>\n<li><code>Table_map</code> event \u8ddf\u4e4b\u524d\u770b\u5230\u7684\u76f8\u540c\uff0c\u663e\u793a\u4e86\u63a5\u4e0b\u6765\u8981\u6253\u5f00\u7684\u8868\uff0cmap \u5230\u6570\u5b57 154\u3002\u73b0\u5728\u6211\u4eec\u8fd9\u6761 SQL \u8bed\u53e5\u53ea\u64cd\u4f5c\u4e86\u4e00\u5f20\u8868\uff0c\u5982\u679c\u8981\u64cd\u4f5c\u591a\u5f20\u8868\u5462\uff1f\u6bcf\u4e2a\u8868\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>Table_map</code> event\u3001\u90fd\u4f1a map \u5230\u4e00\u4e2a\u5355\u72ec\u7684\u6570\u5b57\uff0c\u7528\u4e8e\u533a\u5206\u5bf9\u4e0d\u540c\u8868\u7684\u64cd\u4f5c\u3002</li>\n<li>\u5728 mysqlbinlog \u7684\u547d\u4ee4\u4e2d\uff0c\u4f7f\u7528\u4e86 <code>-vv</code> \u53c2\u6570\u662f\u4e3a\u4e86\u628a\u5185\u5bb9\u90fd\u89e3\u6790\u51fa\u6765\uff0c\u6240\u4ee5\u4ece\u7ed3\u679c\u91cc\u9762\u53ef\u4ee5\u770b\u5230\u5404\u4e2a\u5b57\u6bb5\u7684\u503c\uff08\u6bd4\u5982\uff0c<code>@1=4</code>\u3001 <code>@2=4</code> \u8fd9\u4e9b\u503c\uff09\u3002</li>\n<li><code>binlog_row_image</code> \u7684\u9ed8\u8ba4\u914d\u7f6e\u662f FULL\uff0c\u56e0\u6b64 <code>Delete_event</code> \u91cc\u9762\uff0c\u5305\u542b\u4e86\u5220\u6389\u7684\u884c\u7684\u6240\u6709\u5b57\u6bb5\u7684\u503c\u3002\u5982\u679c\u628a <code>binlog_row_image</code> \u8bbe\u7f6e\u4e3a MINIMAL\uff0c\u5219\u53ea\u4f1a\u8bb0\u5f55\u5fc5\u8981\u7684\u4fe1\u606f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5c31\u662f\u53ea\u4f1a\u8bb0\u5f55 <code>id=4</code> \u8fd9\u4e2a\u4fe1\u606f\u3002</li>\n<li>\u6700\u540e\u7684 Xid event\uff0c\u7528\u4e8e\u8868\u793a\u4e8b\u52a1\u88ab\u6b63\u786e\u5730\u63d0\u4ea4\u4e86\u3002</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5f53 <code>binlog_format</code> \u4f7f\u7528 row \u683c\u5f0f\u7684\u65f6\u5019\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u4e86\u771f\u5b9e\u5220\u9664\u884c\u7684\u4e3b\u952e id\uff0c\u8fd9\u6837 binlog \u4f20\u5230\u5907\u5e93\u53bb\u7684\u65f6\u5019\uff0c\u5c31\u80af\u5b9a\u4f1a\u5220\u9664 id=4 \u7684\u884c\uff0c\u4e0d\u4f1a\u6709\u4e3b\u5907\u5220\u9664\u4e0d\u540c\u884c\u7684\u95ee\u9898\u3002</p>\n<h3 id=\"mixed-binlog\">\u4e3a\u4ec0\u4e48\u4f1a\u6709 mixed \u683c\u5f0f\u7684 binlog\uff1f<a class=\"headerlink\" href=\"#mixed-binlog\" title=\"Permanent link\">&para;</a></h3>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a**\u4e3a\u4ec0\u4e48\u4f1a\u6709 mixed \u8fd9\u79cd binlog \u683c\u5f0f\u7684\u5b58\u5728\u573a\u666f\uff1f**\u63a8\u8bba\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ul>\n<li>\u56e0\u4e3a\u6709\u4e9b statement \u683c\u5f0f\u7684 binlog \u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0c\u6240\u4ee5\u8981\u4f7f\u7528 row \u683c\u5f0f\u3002</li>\n<li>\u4f46 row \u683c\u5f0f\u7684\u7f3a\u70b9\u662f\uff0c\u5f88\u5360\u7a7a\u95f4\u3002\u6bd4\u5982\u4f60\u7528\u4e00\u4e2a delete \u8bed\u53e5\u5220\u6389 10 \u4e07\u884c\u6570\u636e\uff0c\u7528 statement \u7684\u8bdd\u5c31\u662f\u4e00\u4e2a SQL \u8bed\u53e5\u88ab\u8bb0\u5f55\u5230 binlog \u4e2d\uff0c\u5360\u7528\u51e0\u5341\u4e2a\u5b57\u8282\u7684\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u7528 row \u683c\u5f0f\u7684 binlog\uff0c\u5c31\u8981\u628a\u8fd9 10 \u4e07\u6761\u8bb0\u5f55\u90fd\u5199\u5230 binlog \u4e2d\u3002\u8fd9\u6837\u505a\uff0c\u4e0d\u4ec5\u4f1a\u5360\u7528\u66f4\u5927\u7684\u7a7a\u95f4\uff0c\u540c\u65f6\u5199 binlog \u4e5f\u8981\u8017\u8d39 IO \u8d44\u6e90\uff0c\u5f71\u54cd\u6267\u884c\u901f\u5ea6\u3002</li>\n<li>\u6240\u4ee5\uff0cMySQL \u5c31\u53d6\u4e86\u4e2a\u6298\u4e2d\u65b9\u6848\uff0c\u4e5f\u5c31\u662f\u6709\u4e86 mixed \u683c\u5f0f\u7684 binlog\u3002mixed \u683c\u5f0f\u7684\u610f\u601d\u662f\uff0cMySQL \u81ea\u5df1\u4f1a\u5224\u65ad\u8fd9\u6761 SQL \u8bed\u53e5\u662f\u5426\u53ef\u80fd\u5f15\u8d77\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0c\u5982\u679c\u6709\u53ef\u80fd\uff0c\u5c31\u7528 row \u683c\u5f0f\uff0c\u5426\u5219\u5c31\u7528 statement \u683c\u5f0f\u3002</li>\n</ul>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0cmixed \u683c\u5f0f\u53ef\u4ee5\u5229\u7528 statment \u683c\u5f0f\u7684\u4f18\u70b9\uff0c\u540c\u65f6\u53c8\u907f\u514d\u4e86\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u98ce\u9669\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u7684\u7ebf\u4e0a MySQL \u8bbe\u7f6e\u7684 binlog \u683c\u5f0f\u662f statement \u7684\u8bdd\uff0c\u90a3\u57fa\u672c\u4e0a\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u8fd9\u662f\u4e00\u4e2a\u4e0d\u5408\u7406\u7684\u8bbe\u7f6e\u3002\u4f60\u81f3\u5c11\u5e94\u8be5\u628a binlog \u7684\u683c\u5f0f\u8bbe\u7f6e\u4e3a mixed\u3002</p>\n<p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u8bbe\u7f6e\u4e3a mixed \u540e\uff0c\u5c31\u4f1a\u8bb0\u5f55\u4e3a row \u683c\u5f0f\uff1b\u800c\u5982\u679c\u6267\u884c\u7684\u8bed\u53e5\u53bb\u6389 limit 1\uff0c\u5c31\u4f1a\u8bb0\u5f55\u4e3a statement \u683c\u5f0f\u3002</p>\n<p>\u5f53\u7136\u6211\u8981\u8bf4\u7684\u662f\uff0c\u73b0\u5728\u8d8a\u6765\u8d8a\u591a\u7684\u573a\u666f\u8981\u6c42\u628a MySQL \u7684 binlog \u683c\u5f0f\u8bbe\u7f6e\u6210 row\u3002\u8fd9\u4e48\u505a\u7684\u7406\u7531\u6709\u5f88\u591a\uff0c\u6211\u6765\u7ed9\u4f60\u4e3e\u4e00\u4e2a\u53ef\u4ee5\u76f4\u63a5\u770b\u51fa\u6765\u7684\u597d\u5904\uff1a<strong>\u6062\u590d\u6570\u636e</strong>\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5206\u522b\u4ece delete\u3001insert \u548c update \u8fd9\u4e09\u79cd SQL \u8bed\u53e5\u7684\u89d2\u5ea6\uff0c\u6765\u770b\u770b\u6570\u636e\u6062\u590d\u7684\u95ee\u9898\u3002</p>\n<p>\u901a\u8fc7\u56fe 6 \u4f60\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5373\u4f7f\u6211\u6267\u884c\u7684\u662f delete \u8bed\u53e5\uff0crow \u683c\u5f0f\u7684 binlog \u4e5f\u4f1a\u628a\u88ab\u5220\u6389\u7684\u884c\u7684\u6574\u884c\u4fe1\u606f\u4fdd\u5b58\u8d77\u6765\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u5728\u6267\u884c\u5b8c\u4e00\u6761 delete \u8bed\u53e5\u4ee5\u540e\uff0c\u53d1\u73b0\u5220\u9519\u6570\u636e\u4e86\uff0c\u53ef\u4ee5\u76f4\u63a5\u628a binlog \u4e2d\u8bb0\u5f55\u7684 delete \u8bed\u53e5\u8f6c\u6210 insert\uff0c\u628a\u88ab\u9519\u5220\u7684\u6570\u636e\u63d2\u5165\u56de\u53bb\u5c31\u53ef\u4ee5\u6062\u590d\u4e86\u3002</p>\n<p>\u5982\u679c\u4f60\u662f\u6267\u884c\u9519\u4e86 insert \u8bed\u53e5\u5462\uff1f\u90a3\u5c31\u66f4\u76f4\u63a5\u4e86\u3002row \u683c\u5f0f\u4e0b\uff0cinsert \u8bed\u53e5\u7684 binlog \u91cc\u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u5b57\u6bb5\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u7528\u6765\u7cbe\u786e\u5b9a\u4f4d\u521a\u521a\u88ab\u63d2\u5165\u7684\u90a3\u4e00\u884c\u3002\u8fd9\u65f6\uff0c\u4f60\u76f4\u63a5\u628a insert \u8bed\u53e5\u8f6c\u6210 delete \u8bed\u53e5\uff0c\u5220\u9664\u6389\u8fd9\u88ab\u8bef\u63d2\u5165\u7684\u4e00\u884c\u6570\u636e\u5c31\u53ef\u4ee5\u4e86\u3002</p>\n<p>\u5982\u679c\u6267\u884c\u7684\u662f update \u8bed\u53e5\u7684\u8bdd\uff0cbinlog \u91cc\u9762\u4f1a\u8bb0\u5f55\u4fee\u6539\u524d\u6574\u884c\u7684\u6570\u636e\u548c\u4fee\u6539\u540e\u7684\u6574\u884c\u6570\u636e\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u8bef\u6267\u884c\u4e86 update \u8bed\u53e5\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u628a\u8fd9\u4e2a event \u524d\u540e\u7684\u4e24\u884c\u4fe1\u606f\u5bf9\u8c03\u4e00\u4e0b\uff0c\u518d\u53bb\u6570\u636e\u5e93\u91cc\u9762\u6267\u884c\uff0c\u5c31\u80fd\u6062\u590d\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u4e86\u3002</p>\n<p>\u5176\u5b9e\uff0c\u7531 delete\u3001insert \u6216\u8005 update \u8bed\u53e5\u5bfc\u81f4\u7684\u6570\u636e\u64cd\u4f5c\u9519\u8bef\uff0c\u9700\u8981\u6062\u590d\u5230\u64cd\u4f5c\u4e4b\u524d\u72b6\u6001\u7684\u60c5\u51b5\uff0c\u4e5f\u65f6\u6709\u53d1\u751f\u3002MariaDB \u7684<a href=\"https://mariadb.com/kb/en/library/flashback/\">Flashback</a>\u5de5\u5177\u5c31\u662f\u57fa\u4e8e\u4e0a\u9762\u4ecb\u7ecd\u7684\u539f\u7406\u6765\u56de\u6eda\u6570\u636e\u7684\u3002</p>\n<p>\u867d\u7136 mixed \u683c\u5f0f\u7684 binlog \u73b0\u5728\u5df2\u7ecf\u7528\u5f97\u4e0d\u591a\u4e86\uff0c\u4f46\u8fd9\u91cc\u6211\u8fd8\u662f\u8981\u518d\u501f\u7528\u4e00\u4e0b mixed \u683c\u5f0f\u6765\u8bf4\u660e\u4e00\u4e2a\u95ee\u9898\uff0c\u6765\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"p\">());</span>\n</code></pre></div>\n<p>\u5982\u679c\u6211\u4eec\u628a binlog \u683c\u5f0f\u8bbe\u7f6e\u4e3a mixed\uff0c\u4f60\u89c9\u5f97 MySQL \u4f1a\u628a\u5b83\u8bb0\u5f55\u4e3a row \u683c\u5f0f\u8fd8\u662f statement \u683c\u5f0f\u5462\uff1f</p>\n<p>\u5148\u4e0d\u8981\u7740\u6025\u8bf4\u7ed3\u679c\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u7684\u6548\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"w\"> </span><span class=\"n\">events</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"s1\">&#39;binlog.000079&#39;</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"mi\">60603412</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Log_name</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Event_type</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Server_id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">End_log_pos</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                                           </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603412</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Anonymous_Gtid</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603491</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;ANONYMOUS&#39;</span><span class=\"w\">           </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603491</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603581</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">BEGIN</span><span class=\"w\">                                          </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603581</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603700</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000079</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">60603700</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Xid</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">60603731</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">COMMIT</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630548 */</span><span class=\"w\">                        </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+----------+----------------+-----------+-------------+------------------------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u7528\u7684\u5c45\u7136\u662f statement \u683c\u5f0f\u3002\u4f60\u4e00\u5b9a\u4f1a\u5947\u602a\uff0c\u5982\u679c\u8fd9\u4e2a binlog \u8fc7\u4e86 1 \u5206\u949f\u624d\u4f20\u7ed9\u5907\u5e93\u7684\u8bdd\uff0c\u90a3\u4e3b\u5907\u7684\u6570\u636e\u4e0d\u5c31\u4e0d\u4e00\u81f4\u4e86\u5417\uff1f</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u7528 mysqlbinlog \u5de5\u5177\u6765\u770b\u770b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"cm\">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">BEGIN</span>\n<span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">60603581</span>\n<span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">41</span><span class=\"p\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603700</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xfc0bb7ba</span><span class=\"w\">     </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"n\">thread_id</span><span class=\"o\">=</span><span class=\"mi\">28</span><span class=\"w\">    </span><span class=\"n\">exec_time</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">error_code</span><span class=\"o\">=</span><span class=\"mi\">0</span>\n<span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"o\">=</span><span class=\"mi\">1675240896</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"p\">())</span>\n<span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">60603700</span>\n<span class=\"o\">#</span><span class=\"mi\">230201</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">41</span><span class=\"p\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">end_log_pos</span><span class=\"w\"> </span><span class=\"mi\">60603731</span><span class=\"w\"> </span><span class=\"n\">CRC32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x554021b0</span><span class=\"w\">     </span><span class=\"n\">Xid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">630548</span>\n<span class=\"k\">COMMIT</span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;AUTOMATIC&#39;</span><span class=\"w\"> </span><span class=\"cm\">/* added by mysqlbinlog */</span><span class=\"w\"> </span><span class=\"cm\">/*!*/</span><span class=\"p\">;</span>\n<span class=\"k\">DELIMITER</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"o\">#</span><span class=\"w\"> </span><span class=\"k\">End</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">file</span>\n<span class=\"cm\">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span><span class=\"p\">;</span>\n<span class=\"cm\">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4ece\u56fe\u4e2d\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0c\u539f\u6765 binlog \u5728\u8bb0\u5f55 event \u7684\u65f6\u5019\uff0c\u591a\u8bb0\u4e86\u4e00\u6761\u547d\u4ee4\uff1a<code>SET TIMESTAMP=1675240896</code>\u3002\u5b83\u7528 SET TIMESTAMP \u547d\u4ee4\u7ea6\u5b9a\u4e86\u63a5\u4e0b\u6765\u7684 now() \u51fd\u6570\u7684\u8fd4\u56de\u65f6\u95f4\u3002</p>\n<p>\u56e0\u6b64\uff0c\u4e0d\u8bba\u8fd9\u4e2a binlog \u662f 1 \u5206\u949f\u4e4b\u540e\u88ab\u5907\u5e93\u6267\u884c\uff0c\u8fd8\u662f 3 \u5929\u540e\u7528\u6765\u6062\u590d\u8fd9\u4e2a\u5e93\u7684\u5907\u4efd\uff0c\u8fd9\u4e2a insert \u8bed\u53e5\u63d2\u5165\u7684\u884c\uff0c\u503c\u90fd\u662f\u56fa\u5b9a\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u901a\u8fc7\u8fd9\u6761 SET TIMESTAMP \u547d\u4ee4\uff0cMySQL \u5c31\u786e\u4fdd\u4e86\u4e3b\u5907\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002</p>\n<p>\u6211\u4e4b\u524d\u770b\u8fc7\u6709\u4eba\u5728\u91cd\u653e binlog \u6570\u636e\u7684\u65f6\u5019\uff0c\u662f\u8fd9\u4e48\u505a\u7684\uff1a\u7528 mysqlbinlog \u89e3\u6790\u51fa\u65e5\u5fd7\uff0c\u7136\u540e\u628a\u91cc\u9762\u7684 statement \u8bed\u53e5\u76f4\u63a5\u62f7\u8d1d\u51fa\u6765\u6267\u884c\u3002</p>\n<p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u6709\u98ce\u9669\u7684\u3002\u56e0\u4e3a\u6709\u4e9b\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\u662f\u4f9d\u8d56\u4e8e\u4e0a\u4e0b\u6587\u547d\u4ee4\u7684\uff0c\u76f4\u63a5\u6267\u884c\u7684\u7ed3\u679c\u5f88\u53ef\u80fd\u662f\u9519\u8bef\u7684\u3002</p>\n<p>\u6240\u4ee5\uff0c\u7528 binlog \u6765\u6062\u590d\u6570\u636e\u7684\u6807\u51c6\u505a\u6cd5\u662f\uff0c\u7528 mysqlbinlog \u5de5\u5177\u89e3\u6790\u51fa\u6765\uff0c\u7136\u540e\u628a\u89e3\u6790\u7ed3\u679c\u6574\u4e2a\u53d1\u7ed9 MySQL \u6267\u884c\u3002\u7c7b\u4f3c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>mysqlbinlog<span class=\"w\"> </span>binlog.000079<span class=\"w\"> </span>--start-position<span class=\"o\">=</span><span class=\"m\">60603412</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>mysql<span class=\"w\"> </span>-h127.0.0.1<span class=\"w\"> </span>-P13000<span class=\"w\"> </span>-u<span class=\"nv\">$user</span><span class=\"w\"> </span>-p<span class=\"nv\">$pwd</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_16\">\u5faa\u73af\u590d\u5236\u95ee\u9898<a class=\"headerlink\" href=\"#_16\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u4e0a\u9762\u5bf9 MySQL \u4e2d binlog \u57fa\u672c\u5185\u5bb9\u7684\u7406\u89e3\uff0c\u4f60\u73b0\u5728\u53ef\u4ee5\u77e5\u9053\uff0cbinlog \u7684\u7279\u6027\u786e\u4fdd\u4e86\u5728\u5907\u5e93\u6267\u884c\u76f8\u540c\u7684 binlog\uff0c\u53ef\u4ee5\u5f97\u5230\u4e0e\u4e3b\u5e93\u76f8\u540c\u7684\u72b6\u6001\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e3b\u5907\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u56fe 1 \u4e2d A\u3001B \u4e24\u4e2a\u8282\u70b9\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\u3002\u5176\u5b9e\uff0c\u56fe 1 \u4e2d\u6211\u753b\u7684\u662f M-S \u7ed3\u6784\uff0c\u4f46\u5b9e\u9645\u751f\u4ea7\u4e0a\u4f7f\u7528\u6bd4\u8f83\u591a\u7684\u662f\u53cc M \u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u56fe 9 \u6240\u793a\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/20ad4e163115198dc6cf372d5116c956.png\" /></p>\n<p>\u56fe 9 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b -- \u53cc M \u7ed3\u6784</p>\n<p>\u5bf9\u6bd4\u56fe 9 \u548c\u56fe 1\uff0c\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u53cc M \u7ed3\u6784\u548c M-S \u7ed3\u6784\uff0c\u5176\u5b9e\u533a\u522b\u53ea\u662f\u591a\u4e86\u4e00\u6761\u7ebf\uff0c\u5373\uff1a\u8282\u70b9 A \u548c B \u4e4b\u95f4\u603b\u662f\u4e92\u4e3a\u4e3b\u5907\u5173\u7cfb\u3002\u8fd9\u6837\u5728\u5207\u6362\u7684\u65f6\u5019\u5c31\u4e0d\u7528\u518d\u4fee\u6539\u4e3b\u5907\u5173\u7cfb\u3002</p>\n<p>\u4f46\u662f\uff0c\u53cc M \u7ed3\u6784\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\u3002</p>\n<p>\u4e1a\u52a1\u903b\u8f91\u5728\u8282\u70b9 A \u4e0a\u66f4\u65b0\u4e86\u4e00\u6761\u8bed\u53e5\uff0c\u7136\u540e\u518d\u628a\u751f\u6210\u7684 binlog \u53d1\u7ed9\u8282\u70b9 B\uff0c\u8282\u70b9 B \u6267\u884c\u5b8c\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u540e\u4e5f\u4f1a\u751f\u6210 binlog\u3002\uff08\u5efa\u8bae\u628a\u53c2\u6570 <code>log_slave_updates</code> \u8bbe\u7f6e\u4e3a on\uff0c\u8868\u793a\u5907\u5e93\u6267\u884c relay log \u540e\u751f\u6210 binlog\uff09\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u8282\u70b9 A \u540c\u65f6\u662f\u8282\u70b9 B \u7684\u5907\u5e93\uff0c\u76f8\u5f53\u4e8e\u53c8\u628a\u8282\u70b9 B \u65b0\u751f\u6210\u7684 binlog \u62ff\u8fc7\u6765\u6267\u884c\u4e86\u4e00\u6b21\uff0c\u7136\u540e\u8282\u70b9 A \u548c B \u95f4\uff0c\u4f1a\u4e0d\u65ad\u5730\u5faa\u73af\u6267\u884c\u8fd9\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u4e5f\u5c31\u662f\u5faa\u73af\u590d\u5236\u4e86\u3002\u8fd9\u4e2a\u8981\u600e\u4e48\u89e3\u51b3\u5462\uff1f</p>\n<p>\u4ece\u4e0a\u9762\u7684\u56fe 6 \u4e2d\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u5728 binlog \u4e2d\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u547d\u4ee4\u7b2c\u4e00\u6b21\u6267\u884c\u65f6\u6240\u5728\u5b9e\u4f8b\u7684 server id\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u903b\u8f91\uff0c\u6765\u89e3\u51b3\u4e24\u4e2a\u8282\u70b9\u95f4\u7684\u5faa\u73af\u590d\u5236\u7684\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u89c4\u5b9a\u4e24\u4e2a\u5e93\u7684 server id \u5fc5\u987b\u4e0d\u540c\uff0c\u5982\u679c\u76f8\u540c\uff0c\u5219\u5b83\u4eec\u4e4b\u95f4\u4e0d\u80fd\u8bbe\u5b9a\u4e3a\u4e3b\u5907\u5173\u7cfb\uff1b</li>\n<li>\u4e00\u4e2a\u5907\u5e93\u63a5\u5230 binlog \u5e76\u5728\u91cd\u653e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u4e0e\u539f binlog \u7684 server id \u76f8\u540c\u7684\u65b0\u7684 binlog\uff1b</li>\n<li>\u6bcf\u4e2a\u5e93\u5728\u6536\u5230\u4ece\u81ea\u5df1\u7684\u4e3b\u5e93\u53d1\u8fc7\u6765\u7684\u65e5\u5fd7\u540e\uff0c\u5148\u5224\u65ad server id\uff0c\u5982\u679c\u8ddf\u81ea\u5df1\u7684\u76f8\u540c\uff0c\u8868\u793a\u8fd9\u4e2a\u65e5\u5fd7\u662f\u81ea\u5df1\u751f\u6210\u7684\uff0c\u5c31\u76f4\u63a5\u4e22\u5f03\u8fd9\u4e2a\u65e5\u5fd7\u3002</li>\n</ol>\n<p>\u6309\u7167\u8fd9\u4e2a\u903b\u8f91\uff0c\u5982\u679c\u6211\u4eec\u8bbe\u7f6e\u4e86\u53cc M \u7ed3\u6784\uff0c\u65e5\u5fd7\u7684\u6267\u884c\u6d41\u5c31\u4f1a\u53d8\u6210\u8fd9\u6837\uff1a</p>\n<ol>\n<li>\u4ece\u8282\u70b9 A \u66f4\u65b0\u7684\u4e8b\u52a1\uff0cbinlog \u91cc\u9762\u8bb0\u7684\u90fd\u662f A \u7684 server id\uff1b</li>\n<li>\u4f20\u5230\u8282\u70b9 B \u6267\u884c\u4e00\u6b21\u4ee5\u540e\uff0c\u8282\u70b9 B \u751f\u6210\u7684 binlog \u7684 server id \u4e5f\u662f A \u7684 server id\uff1b</li>\n<li>\u518d\u4f20\u56de\u7ed9\u8282\u70b9 A\uff0cA \u5224\u65ad\u5230\u8fd9\u4e2a server id \u4e0e\u81ea\u5df1\u7684\u76f8\u540c\uff0c\u5c31\u4e0d\u4f1a\u518d\u5904\u7406\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u6b7b\u5faa\u73af\u5728\u8fd9\u91cc\u5c31\u65ad\u6389\u4e86\u3002</li>\n</ol>\n<h3 id=\"_17\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_17\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 MySQL binlog \u7684\u683c\u5f0f\u548c\u4e00\u4e9b\u57fa\u672c\u673a\u5236\uff0c\u662f\u540e\u9762\u6211\u8981\u4ecb\u7ecd\u7684\u8bfb\u5199\u5206\u79bb\u7b49\u7cfb\u5217\u6587\u7ae0\u7684\u80cc\u666f\u77e5\u8bc6\uff0c\u5e0c\u671b\u4f60\u53ef\u4ee5\u8ba4\u771f\u6d88\u5316\u7406\u89e3\u3002</p>\n<p>binlog \u5728 MySQL \u7684\u5404\u79cd\u9ad8\u53ef\u7528\u65b9\u6848\u4e0a\u626e\u6f14\u4e86\u91cd\u8981\u89d2\u8272\u3002\u4eca\u5929\u4ecb\u7ecd\u7684\u53ef\u4ee5\u8bf4\u662f\u6240\u6709 MySQL \u9ad8\u53ef\u7528\u65b9\u6848\u7684\u57fa\u7840\u3002\u5728\u8fd9\u4e4b\u4e0a\u6f14\u5316\u51fa\u4e86\u8bf8\u5982\u591a\u8282\u70b9\u3001\u534a\u540c\u6b65\u3001MySQL group replication \u7b49\u76f8\u5bf9\u590d\u6742\u7684\u65b9\u6848\u3002</p>\n<p>\u6211\u4e5f\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u4e0d\u540c\u683c\u5f0f binlog \u7684\u4f18\u7f3a\u70b9\uff0c\u548c\u8bbe\u8ba1\u8005\u7684\u601d\u8003\u3002\u5e0c\u671b\u4f60\u5728\u505a\u7cfb\u7edf\u5f00\u53d1\u65f6\u5019\uff0c\u4e5f\u80fd\u501f\u9274\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u60f3\u3002</p>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p>\n<p>\u8bf4\u5230\u5faa\u73af\u590d\u5236\u95ee\u9898\u7684\u65f6\u5019\uff0c\u6211\u4eec\u8bf4 MySQL \u901a\u8fc7\u5224\u65ad server id \u7684\u65b9\u5f0f\uff0c\u65ad\u6389\u6b7b\u5faa\u73af\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u673a\u5236\u5176\u5b9e\u5e76\u4e0d\u5b8c\u5907\uff0c\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u8fd8\u662f\u6709\u53ef\u80fd\u51fa\u73b0\u6b7b\u5faa\u73af\u3002</p>\n<p>\u4f60\u80fd\u6784\u9020\u51fa\u4e00\u4e2a\u8fd9\u6837\u7684\u573a\u666f\u5417\uff1f\u53c8\u5e94\u8be5\u600e\u4e48\u89e3\u51b3\u5462\uff1f</p>\n<p>\u4f60\u53ef\u4ee5\u628a\u4f60\u7684\u8bbe\u8ba1\u548c\u5206\u6790\u5199\u5728\u8bc4\u8bba\u533a\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u8ddf\u4f60\u8ba8\u8bba\u8fd9\u4e2a\u95ee\u9898\u3002\u611f\u8c22\u4f60\u7684\u6536\u542c\uff0c\u4e5f\u6b22\u8fce\u4f60\u628a\u8fd9\u7bc7\u6587\u7ae0\u5206\u4eab\u7ed9\u66f4\u591a\u7684\u670b\u53cb\u4e00\u8d77\u9605\u8bfb\u3002</p>\n<h3 id=\"_18\">\u4e0a\u671f\u95ee\u9898\u65f6\u95f4<a class=\"headerlink\" href=\"#_18\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0a\u671f\u6211\u7559\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u4f60\u5728\u4ec0\u4e48\u65f6\u5019\u4f1a\u628a\u7ebf\u4e0a\u751f\u4ea7\u5e93\u8bbe\u7f6e\u6210\u201c\u975e\u53cc 1\u201d\u3002\u6211\u76ee\u524d\u77e5\u9053\u7684\u573a\u666f\uff0c\u6709\u4ee5\u4e0b\u8fd9\u4e9b\uff1a</p>\n<ol>\n<li>\u4e1a\u52a1\u9ad8\u5cf0\u671f\u3002\u4e00\u822c\u5982\u679c\u6709\u9884\u77e5\u7684\u9ad8\u5cf0\u671f\uff0cDBA \u4f1a\u6709\u9884\u6848\uff0c\u628a\u4e3b\u5e93\u8bbe\u7f6e\u6210\u201c\u975e\u53cc 1\u201d\u3002</li>\n<li>\u5907\u5e93\u5ef6\u8fdf\uff0c\u4e3a\u4e86\u8ba9\u5907\u5e93\u5c3d\u5feb\u8d76\u4e0a\u4e3b\u5e93\u3002@\u6c38\u6052\u8bb0\u5fc6\u548c <a class=\"magiclink magiclink-github magiclink-mention\" href=\"https://github.com/Second\" title=\"GitHub User: Second\">@Second</a> Sight \u63d0\u5230\u4e86\u8fd9\u4e2a\u573a\u666f\u3002</li>\n<li>\u7528\u5907\u4efd\u6062\u590d\u4e3b\u5e93\u7684\u526f\u672c\uff0c\u5e94\u7528 binlog \u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u8ddf\u4e0a\u4e00\u79cd\u573a\u666f\u7c7b\u4f3c\u3002</li>\n<li>\u6279\u91cf\u5bfc\u5165\u6570\u636e\u7684\u65f6\u5019\u3002</li>\n</ol>\n<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u628a\u751f\u4ea7\u5e93\u6539\u6210\u201c\u975e\u53cc 1\u201d\u914d\u7f6e\uff0c\u662f\u8bbe\u7f6e <code>innodb_flush_logs_at_trx_commit=2</code>\u3001<code>sync_binlog=1000</code>\u3002</p>\n<h2 id=\"25-mysql\">25 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u9ad8\u53ef\u7528\u7684\uff1f<a class=\"headerlink\" href=\"#25-mysql\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 binlog \u7684\u57fa\u672c\u5185\u5bb9\uff0c\u5728\u4e00\u4e2a\u4e3b\u5907\u5173\u7cfb\u4e2d\uff0c\u6bcf\u4e2a\u5907\u5e93\u63a5\u6536\u4e3b\u5e93\u7684 binlog \u5e76\u6267\u884c\u3002</p>\n<p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u53ea\u8981\u4e3b\u5e93\u6267\u884c\u66f4\u65b0\u751f\u6210\u7684\u6240\u6709 binlog\uff0c\u90fd\u53ef\u4ee5\u4f20\u5230\u5907\u5e93\u5e76\u88ab\u6b63\u786e\u5730\u6267\u884c\uff0c\u5907\u5e93\u5c31\u80fd\u8fbe\u5230\u8ddf\u4e3b\u5e93\u4e00\u81f4\u7684\u72b6\u6001\uff0c\u8fd9\u5c31\u662f\u6700\u7ec8\u4e00\u81f4\u6027\u3002</p>\n<p>\u4f46\u662f\uff0cMySQL \u8981\u63d0\u4f9b\u9ad8\u53ef\u7528\u80fd\u529b\uff0c\u53ea\u6709\u6700\u7ec8\u4e00\u81f4\u6027\u662f\u4e0d\u591f\u7684\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u4eca\u5929\u6211\u5c31\u7740\u91cd\u548c\u4f60\u5206\u6790\u4e00\u4e0b\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u518d\u653e\u4e00\u6b21\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bb2\u5230\u7684\u53cc M \u7ed3\u6784\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/89290bbcf454ff9a3dc5de42a85a69cc.png\" /></p>\n<p>\u56fe 1 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b -- \u53cc M \u7ed3\u6784</p>\n<h3 id=\"_19\">\u4e3b\u5907\u5ef6\u8fdf<a class=\"headerlink\" href=\"#_19\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3b\u5907\u5207\u6362\u53ef\u80fd\u662f\u4e00\u4e2a\u4e3b\u52a8\u8fd0\u7ef4\u52a8\u4f5c\uff0c\u6bd4\u5982\u8f6f\u4ef6\u5347\u7ea7\u3001\u4e3b\u5e93\u6240\u5728\u673a\u5668\u6309\u8ba1\u5212\u4e0b\u7ebf\u7b49\uff0c\u4e5f\u53ef\u80fd\u662f\u88ab\u52a8\u64cd\u4f5c\uff0c\u6bd4\u5982\u4e3b\u5e93\u6240\u5728\u673a\u5668\u6389\u7535\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5148\u4e00\u8d77\u770b\u770b\u4e3b\u52a8\u5207\u6362\u7684\u573a\u666f\u3002</p>\n<p>\u5728\u4ecb\u7ecd\u4e3b\u52a8\u5207\u6362\u6d41\u7a0b\u7684\u8be6\u7ec6\u6b65\u9aa4\u4e4b\u524d\uff0c\u6211\u8981\u5148\u8ddf\u4f60\u8bf4\u660e\u4e00\u4e2a\u6982\u5ff5\uff0c\u5373\u201c\u540c\u6b65\u5ef6\u8fdf\u201d\u3002\u4e0e\u6570\u636e\u540c\u6b65\u6709\u5173\u7684\u65f6\u95f4\u70b9\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u4e09\u4e2a\uff1a</p>\n<ol>\n<li>\u4e3b\u5e93 A \u6267\u884c\u5b8c\u6210\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5199\u5165 binlog\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u65f6\u523b\u8bb0\u4e3a T1;</li>\n<li>\u4e4b\u540e\u4f20\u7ed9\u5907\u5e93 B\uff0c\u6211\u4eec\u628a\u5907\u5e93 B \u63a5\u6536\u5b8c\u8fd9\u4e2a binlog \u7684\u65f6\u523b\u8bb0\u4e3a T2;</li>\n<li>\u5907\u5e93 B \u6267\u884c\u5b8c\u6210\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u65f6\u523b\u8bb0\u4e3a T3\u3002</li>\n</ol>\n<p>\u6240\u8c13\u4e3b\u5907\u5ef6\u8fdf\uff0c\u5c31\u662f\u540c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u5b8c\u6210\u7684\u65f6\u95f4\u548c\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\u7684\u65f6\u95f4\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u4e5f\u5c31\u662f T3-T1\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u5728\u5907\u5e93\u4e0a\u6267\u884c <code>show slave status</code> \u547d\u4ee4\uff0c\u5b83\u7684\u8fd4\u56de\u7ed3\u679c\u91cc\u9762\u4f1a\u663e\u793a <code>seconds_behind_master</code>\uff0c\u7528\u4e8e\u8868\u793a\u5f53\u524d\u5907\u5e93\u5ef6\u8fdf\u4e86\u591a\u5c11\u79d2\u3002</p>\n<p><code>seconds_behind_master</code> \u7684\u8ba1\u7b97\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u6bcf\u4e2a\u4e8b\u52a1\u7684 binlog \u91cc\u9762\u90fd\u6709\u4e00\u4e2a\u65f6\u95f4\u5b57\u6bb5\uff0c\u7528\u4e8e\u8bb0\u5f55\u4e3b\u5e93\u4e0a\u5199\u5165\u7684\u65f6\u95f4\uff1b</li>\n<li>\u5907\u5e93\u53d6\u51fa\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u5b57\u6bb5\u7684\u503c\uff0c\u8ba1\u7b97\u5b83\u4e0e\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u7684\u5dee\u503c\uff0c\u5f97\u5230 <code>seconds_behind_master</code>\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5176\u5b9e <code>seconds_behind_master</code> \u8fd9\u4e2a\u53c2\u6570\u8ba1\u7b97\u7684\u5c31\u662f <code>T3-T1</code>\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 <code>seconds_behind_master</code> \u6765\u4f5c\u4e3a\u4e3b\u5907\u5ef6\u8fdf\u7684\u503c\uff0c\u8fd9\u4e2a\u503c\u7684\u65f6\u95f4\u7cbe\u5ea6\u662f\u79d2\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u5982\u679c\u4e3b\u5907\u5e93\u673a\u5668\u7684\u7cfb\u7edf\u65f6\u95f4\u8bbe\u7f6e\u4e0d\u4e00\u81f4\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u503c\u4e0d\u51c6\uff1f</p>\n<p>\u5176\u5b9e\u4e0d\u4f1a\u7684\u3002\u56e0\u4e3a\uff0c\u5907\u5e93\u8fde\u63a5\u5230\u4e3b\u5e93\u7684\u65f6\u5019\uff0c\u4f1a\u901a\u8fc7\u6267\u884c <code>SELECT UNIX_TIMESTAMP()</code> \u51fd\u6570\u6765\u83b7\u5f97\u5f53\u524d\u4e3b\u5e93\u7684\u7cfb\u7edf\u65f6\u95f4\u3002\u5982\u679c\u8fd9\u65f6\u5019\u53d1\u73b0\u4e3b\u5e93\u7684\u7cfb\u7edf\u65f6\u95f4\u4e0e\u81ea\u5df1\u4e0d\u4e00\u81f4\uff0c\u5907\u5e93\u5728\u6267\u884c <code>seconds_behind_master</code> \u8ba1\u7b97\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u6263\u6389\u8fd9\u4e2a\u5dee\u503c\u3002</p>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5728\u7f51\u7edc\u6b63\u5e38\u7684\u65f6\u5019\uff0c\u65e5\u5fd7\u4ece\u4e3b\u5e93\u4f20\u7ed9\u5907\u5e93\u6240\u9700\u7684\u65f6\u95f4\u662f\u5f88\u77ed\u7684\uff0c\u5373 T2-T1 \u7684\u503c\u662f\u975e\u5e38\u5c0f\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7f51\u7edc\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e3b\u5907\u5ef6\u8fdf\u7684\u4e3b\u8981\u6765\u6e90\u662f\u5907\u5e93\u63a5\u6536\u5b8c binlog \u548c\u6267\u884c\u5b8c\u8fd9\u4e2a\u4e8b\u52a1\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\u3002</p>\n<p>\u6240\u4ee5\u8bf4\uff0c\u4e3b\u5907\u5ef6\u8fdf\u6700\u76f4\u63a5\u7684\u8868\u73b0\u662f\uff0c\u5907\u5e93\u6d88\u8d39\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u7684\u901f\u5ea6\uff0c\u6bd4\u4e3b\u5e93\u751f\u4ea7 binlog \u7684\u901f\u5ea6\u8981\u6162\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u548c\u4f60\u4e00\u8d77\u5206\u6790\u4e0b\uff0c\u8fd9\u53ef\u80fd\u662f\u7531\u54ea\u4e9b\u539f\u56e0\u5bfc\u81f4\u7684\u3002</p>\n<h3 id=\"_20\">\u4e3b\u5907\u5ef6\u8fdf\u7684\u6765\u6e90<a class=\"headerlink\" href=\"#_20\" title=\"Permanent link\">&para;</a></h3>\n<p><strong>\u9996\u5148\uff0c\u6709\u4e9b\u90e8\u7f72\u6761\u4ef6\u4e0b\uff0c\u5907\u5e93\u6240\u5728\u673a\u5668\u7684\u6027\u80fd\u8981\u6bd4\u4e3b\u5e93\u6240\u5728\u7684\u673a\u5668\u6027\u80fd\u5dee\u3002</strong></p>\n<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6709\u4eba\u8fd9\u4e48\u90e8\u7f72\u65f6\u7684\u60f3\u6cd5\u662f\uff0c\u53cd\u6b63\u5907\u5e93\u6ca1\u6709\u8bf7\u6c42\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528\u5dee\u4e00\u70b9\u513f\u7684\u673a\u5668\u3002\u6216\u8005\uff0c\u4ed6\u4eec\u4f1a\u628a 20 \u4e2a\u4e3b\u5e93\u653e\u5728 4 \u53f0\u673a\u5668\u4e0a\uff0c\u800c\u628a\u5907\u5e93\u96c6\u4e2d\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u3002</p>\n<p>\u5176\u5b9e\u6211\u4eec\u90fd\u77e5\u9053\uff0c\u66f4\u65b0\u8bf7\u6c42\u5bf9 IOPS \u7684\u538b\u529b\uff0c\u5728\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u662f\u65e0\u5dee\u522b\u7684\u3002\u6240\u4ee5\uff0c\u505a\u8fd9\u79cd\u90e8\u7f72\u65f6\uff0c\u4e00\u822c\u90fd\u4f1a\u5c06\u5907\u5e93\u8bbe\u7f6e\u4e3a\u201c\u975e\u53cc 1\u201d\u7684\u6a21\u5f0f\u3002</p>\n<p>\u4f46\u5b9e\u9645\u4e0a\uff0c\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u4e5f\u4f1a\u89e6\u53d1\u5927\u91cf\u7684\u8bfb\u64cd\u4f5c\u3002\u6240\u4ee5\uff0c\u5f53\u5907\u5e93\u4e3b\u673a\u4e0a\u7684\u591a\u4e2a\u5907\u5e93\u90fd\u5728\u4e89\u62a2\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u4e86\u3002</p>\n<p>\u5f53\u7136\uff0c\u8fd9\u79cd\u90e8\u7f72\u73b0\u5728\u6bd4\u8f83\u5c11\u4e86\u3002\u56e0\u4e3a\u4e3b\u5907\u53ef\u80fd\u53d1\u751f\u5207\u6362\uff0c\u5907\u5e93\u968f\u65f6\u53ef\u80fd\u53d8\u6210\u4e3b\u5e93\uff0c\u6240\u4ee5\u4e3b\u5907\u5e93\u9009\u7528\u76f8\u540c\u89c4\u683c\u7684\u673a\u5668\uff0c\u5e76\u4e14\u505a\u5bf9\u79f0\u90e8\u7f72\uff0c\u662f\u73b0\u5728\u6bd4\u8f83\u5e38\u89c1\u7684\u60c5\u51b5\u3002</p>\n<p>\u8ffd\u95ee 1\uff1a\u4f46\u662f\uff0c\u505a\u4e86\u5bf9\u79f0\u90e8\u7f72\u4ee5\u540e\uff0c\u8fd8\u53ef\u80fd\u4f1a\u6709\u5ef6\u8fdf\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u8fd9\u5c31\u662f**\u7b2c\u4e8c\u79cd\u5e38\u89c1\u7684\u53ef\u80fd\u4e86\uff0c\u5373\u5907\u5e93\u7684\u538b\u529b\u5927**\u3002\u4e00\u822c\u7684\u60f3\u6cd5\u662f\uff0c\u4e3b\u5e93\u65e2\u7136\u63d0\u4f9b\u4e86\u5199\u80fd\u529b\uff0c\u90a3\u4e48\u5907\u5e93\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e9b\u8bfb\u80fd\u529b\u3002\u6216\u8005\u4e00\u4e9b\u8fd0\u8425\u540e\u53f0\u9700\u8981\u7684\u5206\u6790\u8bed\u53e5\uff0c\u4e0d\u80fd\u5f71\u54cd\u6b63\u5e38\u4e1a\u52a1\uff0c\u6240\u4ee5\u53ea\u80fd\u5728\u5907\u5e93\u4e0a\u8dd1\u3002</p>\n<p>\u6211\u771f\u5c31\u89c1\u8fc7\u4e0d\u5c11\u8fd9\u6837\u7684\u60c5\u51b5\u3002\u7531\u4e8e\u4e3b\u5e93\u76f4\u63a5\u5f71\u54cd\u4e1a\u52a1\uff0c\u5927\u5bb6\u4f7f\u7528\u8d77\u6765\u4f1a\u6bd4\u8f83\u514b\u5236\uff0c\u53cd\u800c\u5ffd\u89c6\u4e86\u5907\u5e93\u7684\u538b\u529b\u63a7\u5236\u3002\u7ed3\u679c\u5c31\u662f\uff0c\u5907\u5e93\u4e0a\u7684\u67e5\u8be2\u8017\u8d39\u4e86\u5927\u91cf\u7684 CPU \u8d44\u6e90\uff0c\u5f71\u54cd\u4e86\u540c\u6b65\u901f\u5ea6\uff0c\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u3002</p>\n<p>\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u4e00\u822c\u53ef\u4ee5\u8fd9\u4e48\u5904\u7406\uff1a</p>\n<ol>\n<li>\u4e00\u4e3b\u591a\u4ece\u3002\u9664\u4e86\u5907\u5e93\u5916\uff0c\u53ef\u4ee5\u591a\u63a5\u51e0\u4e2a\u4ece\u5e93\uff0c\u8ba9\u8fd9\u4e9b\u4ece\u5e93\u6765\u5206\u62c5\u8bfb\u7684\u538b\u529b\u3002</li>\n<li>\u901a\u8fc7 binlog \u8f93\u51fa\u5230\u5916\u90e8\u7cfb\u7edf\uff0c\u6bd4\u5982 Hadoop \u8fd9\u7c7b\u7cfb\u7edf\uff0c\u8ba9\u5916\u90e8\u7cfb\u7edf\u63d0\u4f9b\u7edf\u8ba1\u7c7b\u67e5\u8be2\u7684\u80fd\u529b\u3002</li>\n</ol>\n<p>\u5176\u4e2d\uff0c\u4e00\u4e3b\u591a\u4ece\u7684\u65b9\u5f0f\u5927\u90fd\u4f1a\u88ab\u91c7\u7528\u3002\u56e0\u4e3a\u4f5c\u4e3a\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u8fd8\u5fc5\u987b\u4fdd\u8bc1\u6709\u5b9a\u671f\u5168\u91cf\u5907\u4efd\u7684\u80fd\u529b\u3002\u800c\u4ece\u5e93\uff0c\u5c31\u5f88\u9002\u5408\u7528\u6765\u505a\u5907\u4efd\u3002</p>\n<blockquote>\n<p>\u5907\u6ce8\uff1a\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u4e00\u4e0b\uff0c\u4ece\u5e93\u548c\u5907\u5e93\u5728\u6982\u5ff5\u4e0a\u5176\u5b9e\u5dee\u4e0d\u591a\u3002\u5728\u6211\u4eec\u8fd9\u4e2a\u4e13\u680f\u91cc\uff0c\u4e3a\u4e86\u65b9\u4fbf\u63cf\u8ff0\uff0c\u6211\u628a\u4f1a\u5728 HA \u8fc7\u7a0b\u4e2d\u88ab\u9009\u6210\u65b0\u4e3b\u5e93\u7684\uff0c\u79f0\u4e3a\u5907\u5e93\uff0c\u5176\u4ed6\u7684\u79f0\u4e3a\u4ece\u5e93\u3002</p>\n</blockquote>\n<p>\u8ffd\u95ee 2\uff1a\u91c7\u7528\u4e86\u4e00\u4e3b\u591a\u4ece\uff0c\u4fdd\u8bc1\u5907\u5e93\u7684\u538b\u529b\u4e0d\u4f1a\u8d85\u8fc7\u4e3b\u5e93\uff0c\u8fd8\u6709\u4ec0\u4e48\u60c5\u51b5\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u5417\uff1f</p>\n<p><strong>\u8fd9\u5c31\u662f\u7b2c\u4e09\u79cd\u53ef\u80fd\u4e86\uff0c\u5373\u5927\u4e8b\u52a1\u3002</strong></p>\n<p>\u5927\u4e8b\u52a1\u8fd9\u79cd\u60c5\u51b5\u5f88\u597d\u7406\u89e3\u3002\u56e0\u4e3a\u4e3b\u5e93\u4e0a\u5fc5\u987b\u7b49\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\u624d\u4f1a\u5199\u5165 binlog\uff0c\u518d\u4f20\u7ed9\u5907\u5e93\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4e00\u4e2a\u4e3b\u5e93\u4e0a\u7684\u8bed\u53e5\u6267\u884c 10 \u5206\u949f\uff0c\u90a3\u8fd9\u4e2a\u4e8b\u52a1\u5f88\u53ef\u80fd\u5c31\u4f1a\u5bfc\u81f4\u4ece\u5e93\u5ef6\u8fdf 10 \u5206\u949f\u3002</p>\n<p>\u4e0d\u77e5\u9053\u4f60\u6240\u5728\u516c\u53f8\u7684 DBA \u6709\u6ca1\u6709\u8ddf\u4f60\u8fd9\u4e48\u8bf4\u8fc7\uff1a\u4e0d\u8981**\u4e00\u6b21\u6027\u5730\u7528 delete \u8bed\u53e5\u5220\u9664\u592a\u591a\u6570\u636e**\u3002\u5176\u5b9e\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5927\u4e8b\u52a1\u573a\u666f\u3002</p>\n<p>\u6bd4\u5982\uff0c\u4e00\u4e9b\u5f52\u6863\u7c7b\u7684\u6570\u636e\uff0c\u5e73\u65f6\u6ca1\u6709\u6ce8\u610f\u5220\u9664\u5386\u53f2\u6570\u636e\uff0c\u7b49\u5230\u7a7a\u95f4\u5feb\u6ee1\u4e86\uff0c\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u8981\u4e00\u6b21\u6027\u5730\u5220\u6389\u5927\u91cf\u5386\u53f2\u6570\u636e\u3002\u540c\u65f6\uff0c\u53c8\u56e0\u4e3a\u8981\u907f\u514d\u5728\u9ad8\u5cf0\u671f\u64cd\u4f5c\u4f1a\u5f71\u54cd\u4e1a\u52a1\uff08\u81f3\u5c11\u6709\u8fd9\u4e2a\u610f\u8bc6\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\uff09\uff0c\u6240\u4ee5\u4f1a\u5728\u665a\u4e0a\u6267\u884c\u8fd9\u4e9b\u5927\u91cf\u6570\u636e\u7684\u5220\u9664\u64cd\u4f5c\u3002</p>\n<p>\u7ed3\u679c\uff0c\u8d1f\u8d23\u7684 DBA \u540c\u5b66\u534a\u591c\u5c31\u4f1a\u6536\u5230\u5ef6\u8fdf\u62a5\u8b66\u3002\u7136\u540e\uff0cDBA \u56e2\u961f\u5c31\u8981\u6c42\u4f60\u540e\u7eed\u518d\u5220\u9664\u6570\u636e\u7684\u65f6\u5019\uff0c\u8981\u63a7\u5236\u6bcf\u4e2a\u4e8b\u52a1\u5220\u9664\u7684\u6570\u636e\u91cf\uff0c\u5206\u6210\u591a\u6b21\u5220\u9664\u3002</p>\n<p>**\u53e6\u4e00\u79cd\u5178\u578b\u7684\u5927\u4e8b\u52a1\u573a\u666f\uff0c\u5c31\u662f\u5927\u8868 DDL\u3002**\u8fd9\u4e2a\u573a\u666f\uff0c\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u8fc7\u3002\u5904\u7406\u65b9\u6848\u5c31\u662f\uff0c\u8ba1\u5212\u5185\u7684 DDL\uff0c\u5efa\u8bae\u4f7f\u7528 gh-ost \u65b9\u6848.</p>\n<p>\u8ffd\u95ee 3\uff1a\u5982\u679c\u4e3b\u5e93\u4e0a\u4e5f\u4e0d\u505a\u5927\u4e8b\u52a1\u4e86\uff0c\u8fd8\u6709\u4ec0\u4e48\u539f\u56e0\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u5417\uff1f</p>\n<p>\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u8fd8\u6709\u4e00\u4e2a\u5927\u65b9\u5411\u7684\u539f\u56e0\uff0c\u5c31\u662f**\u5907\u5e93\u7684\u5e76\u884c\u590d\u5236\u80fd\u529b**\u3002\u8fd9\u4e2a\u8bdd\u9898\uff0c\u6211\u4f1a\u7559\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u518d\u548c\u4f60\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>\n<p>\u5176\u5b9e\u8fd8\u662f\u6709\u4e0d\u5c11\u5176\u4ed6\u60c5\u51b5\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\uff0c\u5982\u679c\u4f60\u8fd8\u78b0\u5230\u8fc7\u5176\u4ed6\u573a\u666f\uff0c\u6b22\u8fce\u4f60\u5728\u8bc4\u8bba\u533a\u7ed9\u6211\u7559\u8a00\uff0c\u6211\u6765\u548c\u4f60\u4e00\u8d77\u5206\u6790\u3001\u8ba8\u8bba\u3002</p>\n<p>\u7531\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u5b58\u5728\uff0c\u6240\u4ee5\u5728\u4e3b\u5907\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u76f8\u5e94\u7684\u6709\u4e0d\u540c\u7684\u7b56\u7565\u3002</p>\n<h3 id=\"_21\">\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565<a class=\"headerlink\" href=\"#_21\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u56fe 1 \u7684\u53cc M \u7ed3\u6784\u4e0b\uff0c\u4ece\u72b6\u6001 1 \u5230\u72b6\u6001 2 \u5207\u6362\u7684\u8be6\u7ec6\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5224\u65ad\u5907\u5e93 B \u73b0\u5728\u7684 <code>seconds_behind_master</code>\uff0c\u5982\u679c\u5c0f\u4e8e\u67d0\u4e2a\u503c\uff08\u6bd4\u5982 5 \u79d2\uff09\u7ee7\u7eed\u4e0b\u4e00\u6b65\uff0c\u5426\u5219\u6301\u7eed\u91cd\u8bd5\u8fd9\u4e00\u6b65\uff1b</li>\n<li>\u628a\u4e3b\u5e93 A \u6539\u6210\u53ea\u8bfb\u72b6\u6001\uff0c\u5373\u628a readonly \u8bbe\u7f6e\u4e3a true\uff1b</li>\n<li>\u5224\u65ad\u5907\u5e93 B \u7684 <code>seconds_behind_master</code> \u7684\u503c\uff0c\u76f4\u5230\u8fd9\u4e2a\u503c\u53d8\u6210 0 \u4e3a\u6b62\uff1b</li>\n<li>\u628a\u5907\u5e93 B \u6539\u6210\u53ef\u8bfb\u5199\u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u628a readonly \u8bbe\u7f6e\u4e3a false\uff1b</li>\n<li>\u628a\u4e1a\u52a1\u8bf7\u6c42\u5207\u5230\u5907\u5e93 B\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff0c\u4e00\u822c\u662f\u7531\u4e13\u95e8\u7684 HA \u7cfb\u7edf\u6765\u5b8c\u6210\u7684\uff0c\u6211\u4eec\u6682\u65f6\u79f0\u4e4b\u4e3a\u53ef\u9760\u6027\u4f18\u5148\u6d41\u7a0b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/54f4c7c31e6f0f807c2ab77f78c8844a.png\" /></p>\n<p>\u56fe 2 MySQL \u53ef\u9760\u6027\u4f18\u5148\u4e3b\u5907\u5207\u6362\u6d41\u7a0b</p>\n<p>\u5907\u6ce8\uff1a\u56fe\u4e2d\u7684 SBM\uff0c\u662f <code>seconds_behind_master</code> \u53c2\u6570\u7684\u7b80\u5199\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\u4e2d\u662f\u6709\u4e0d\u53ef\u7528\u65f6\u95f4\u7684\u3002\u56e0\u4e3a\u5728\u6b65\u9aa4 2 \u4e4b\u540e\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u90fd\u5904\u4e8e readonly \u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u65f6\u7cfb\u7edf\u5904\u4e8e\u4e0d\u53ef\u5199\u72b6\u6001\uff0c\u76f4\u5230\u6b65\u9aa4 5 \u5b8c\u6210\u540e\u624d\u80fd\u6062\u590d\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u4e0d\u53ef\u7528\u72b6\u6001\u4e2d\uff0c\u6bd4\u8f83\u8017\u8d39\u65f6\u95f4\u7684\u662f\u6b65\u9aa4 3\uff0c\u53ef\u80fd\u9700\u8981\u8017\u8d39\u597d\u51e0\u79d2\u7684\u65f6\u95f4\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u9700\u8981\u5728\u6b65\u9aa4 1 \u5148\u505a\u5224\u65ad\uff0c\u786e\u4fdd <code>seconds_behind_master</code> \u7684\u503c\u8db3\u591f\u5c0f\u3002</p>\n<p>\u8bd5\u60f3\u5982\u679c\u4e00\u5f00\u59cb\u4e3b\u5907\u5ef6\u8fdf\u5c31\u957f\u8fbe 30 \u5206\u949f\uff0c\u800c\u4e0d\u5148\u505a\u5224\u65ad\u76f4\u63a5\u5207\u6362\u7684\u8bdd\uff0c\u7cfb\u7edf\u7684\u4e0d\u53ef\u7528\u65f6\u95f4\u5c31\u4f1a\u957f\u8fbe 30 \u5206\u949f\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e00\u822c\u4e1a\u52a1\u90fd\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002</p>\n<p>\u5f53\u7136\uff0c\u7cfb\u7edf\u7684\u4e0d\u53ef\u7528\u65f6\u95f4\uff0c\u662f\u7531\u8fd9\u4e2a\u6570\u636e\u53ef\u9760\u6027\u4f18\u5148\u7684\u7b56\u7565\u51b3\u5b9a\u7684\u3002\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u53ef\u7528\u6027\u4f18\u5148\u7684\u7b56\u7565\uff0c\u6765\u628a\u8fd9\u4e2a\u4e0d\u53ef\u7528\u65f6\u95f4\u51e0\u4e4e\u964d\u4e3a 0\u3002</p>\n<h3 id=\"_22\">\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565<a class=\"headerlink\" href=\"#_22\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u6211\u5f3a\u884c\u628a\u6b65\u9aa4 4\u30015 \u8c03\u6574\u5230\u6700\u5f00\u59cb\u6267\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e0d\u7b49\u4e3b\u5907\u6570\u636e\u540c\u6b65\uff0c\u76f4\u63a5\u628a\u8fde\u63a5\u5207\u5230\u5907\u5e93 B\uff0c\u5e76\u4e14\u8ba9\u5907\u5e93 B \u53ef\u4ee5\u8bfb\u5199\uff0c\u90a3\u4e48\u7cfb\u7edf\u51e0\u4e4e\u5c31\u6ca1\u6709\u4e0d\u53ef\u7528\u65f6\u95f4\u4e86\u3002</p>\n<p>\u6211\u4eec\u628a\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff0c\u6682\u65f6\u79f0\u4f5c\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u3002\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\u7684\u4ee3\u4ef7\uff0c\u5c31\u662f\u53ef\u80fd\u51fa\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u548c\u4f60\u5206\u4eab\u4e00\u4e2a\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u4ea7\u751f\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u4f8b\u5b50\u3002\u5047\u8bbe\u6709\u4e00\u4e2a\u8868 t\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">),(</span><span class=\"mi\">2</span><span class=\"p\">),(</span><span class=\"mi\">3</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8868\u5b9a\u4e49\u4e86\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e id\uff0c\u521d\u59cb\u5316\u6570\u636e\u540e\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u90fd\u662f 3 \u884c\u6570\u636e\u3002\u63a5\u4e0b\u6765\uff0c\u4e1a\u52a1\u4eba\u5458\u8981\u7ee7\u7eed\u5728\u8868 t \u4e0a\u6267\u884c\u4e24\u6761\u63d2\u5165\u8bed\u53e5\u7684\u547d\u4ee4\uff0c\u4f9d\u6b21\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5047\u8bbe\uff0c\u73b0\u5728\u4e3b\u5e93\u4e0a\u5176\u4ed6\u7684\u6570\u636e\u8868\u6709\u5927\u91cf\u7684\u66f4\u65b0\uff0c\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u8fbe\u5230 5 \u79d2\u3002\u5728\u63d2\u5165\u4e00\u6761 c=4 \u7684\u8bed\u53e5\u540e\uff0c\u53d1\u8d77\u4e86\u4e3b\u5907\u5207\u6362\u3002</p>\n<p>\u56fe 3 \u662f**\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 binlog_format=mixed**\u65f6\u7684\u5207\u6362\u6d41\u7a0b\u548c\u6570\u636e\u7ed3\u679c\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/3786bd6ad37faa34aca25bf1a1d8af3a.png\" /></p>\n<p>\u56fe 3 \u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 <code>binlog_format=mixed</code></p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u5206\u6790\u4e0b\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff1a</p>\n<ol>\n<li>\u6b65\u9aa4 2 \u4e2d\uff0c\u4e3b\u5e93 A \u6267\u884c\u5b8c insert \u8bed\u53e5\uff0c\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff084,4\uff09\uff0c\u4e4b\u540e\u5f00\u59cb\u8fdb\u884c\u4e3b\u5907\u5207\u6362\u3002</li>\n<li>\u6b65\u9aa4 3 \u4e2d\uff0c\u7531\u4e8e\u4e3b\u5907\u4e4b\u95f4\u6709 5 \u79d2\u7684\u5ef6\u8fdf\uff0c\u6240\u4ee5\u5907\u5e93 B \u8fd8\u6ca1\u6765\u5f97\u53ca\u5e94\u7528\u201c\u63d2\u5165 c=4\u201d\u8fd9\u4e2a\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u5c31\u5f00\u59cb\u63a5\u6536\u5ba2\u6237\u7aef\u201c\u63d2\u5165 c=5\u201d\u7684\u547d\u4ee4\u3002</li>\n<li>\u6b65\u9aa4 4 \u4e2d\uff0c\u5907\u5e93 B \u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff084,5\uff09\uff0c\u5e76\u4e14\u628a\u8fd9\u4e2a binlog \u53d1\u7ed9\u4e3b\u5e93 A\u3002</li>\n<li>\u6b65\u9aa4 5 \u4e2d\uff0c\u5907\u5e93 B \u6267\u884c\u201c\u63d2\u5165 c=4\u201d\u8fd9\u4e2a\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff085,4\uff09\u3002\u800c\u76f4\u63a5\u5728\u5907\u5e93 B \u6267\u884c\u7684\u201c\u63d2\u5165 c=5\u201d\u8fd9\u4e2a\u8bed\u53e5\uff0c\u4f20\u5230\u4e3b\u5e93 A\uff0c\u5c31\u63d2\u5165\u4e86\u4e00\u884c\u65b0\u6570\u636e\uff085,5\uff09\u3002</li>\n</ol>\n<p>\u6700\u540e\u7684\u7ed3\u679c\u5c31\u662f\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u4e0a\u51fa\u73b0\u4e86\u4e24\u884c\u4e0d\u4e00\u81f4\u7684\u6570\u636e\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u662f\u7531\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u5bfc\u81f4\u7684\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u8fd8\u662f\u7528**\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4f46\u8bbe\u7f6e binlog_format=row**\uff0c\u60c5\u51b5\u53c8\u4f1a\u600e\u6837\u5462\uff1f</p>\n<p>\u56e0\u4e3a row \u683c\u5f0f\u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4f1a\u8bb0\u5f55\u65b0\u63d2\u5165\u7684\u884c\u7684\u6240\u6709\u5b57\u6bb5\u503c\uff0c\u6240\u4ee5\u6700\u540e\u53ea\u4f1a\u6709\u4e00\u884c\u4e0d\u4e00\u81f4\u3002\u800c\u4e14\uff0c\u4e24\u8fb9\u7684\u4e3b\u5907\u540c\u6b65\u7684\u5e94\u7528\u7ebf\u7a0b\u4f1a\u62a5\u9519 duplicate key error \u5e76\u505c\u6b62\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5907\u5e93 B \u7684 (5,4) \u548c\u4e3b\u5e93 A \u7684 (5,5) \u8fd9\u4e24\u884c\u6570\u636e\uff0c\u90fd\u4e0d\u4f1a\u88ab\u5bf9\u65b9\u6267\u884c\u3002</p>\n<p>\u56fe 4 \u4e2d\u6211\u753b\u51fa\u4e86\u8be6\u7ec6\u8fc7\u7a0b\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u518d\u5206\u6790\u4e00\u4e0b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/b8d2229b2b40dd087fd3b111d1bdda43.png\" /></p>\n<p>\u56fe 4 \u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 <code>binlog_format=row</code></p>\n<p>\u4ece\u4e0a\u9762\u7684\u5206\u6790\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u7ed3\u8bba\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 row \u683c\u5f0f\u7684 binlog \u65f6\uff0c\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u66f4\u5bb9\u6613\u88ab\u53d1\u73b0\u3002\u800c\u4f7f\u7528 mixed \u6216\u8005 statement \u683c\u5f0f\u7684 binlog \u65f6\uff0c\u6570\u636e\u5f88\u53ef\u80fd\u6084\u6084\u5730\u5c31\u4e0d\u4e00\u81f4\u4e86\u3002\u5982\u679c\u4f60\u8fc7\u4e86\u5f88\u4e45\u624d\u53d1\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u5f88\u53ef\u80fd\u8fd9\u65f6\u7684\u6570\u636e\u4e0d\u4e00\u81f4\u5df2\u7ecf\u4e0d\u53ef\u67e5\uff0c\u6216\u8005\u8fde\u5e26\u9020\u6210\u4e86\u66f4\u591a\u7684\u6570\u636e\u903b\u8f91\u4e0d\u4e00\u81f4\u3002</li>\n<li>\u4e3b\u5907\u5207\u6362\u7684\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\u4f1a\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\u3002\u56e0\u6b64\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u3002\u6bd5\u7adf\u5bf9\u6570\u636e\u670d\u52a1\u6765\u8bf4\u7684\u8bdd\uff0c\u6570\u636e\u7684\u53ef\u9760\u6027\u4e00\u822c\u8fd8\u662f\u8981\u4f18\u4e8e\u53ef\u7528\u6027\u7684\u3002</li>\n</ol>\n<p>\u4f46\u4e8b\u65e0\u7edd\u5bf9\uff0c<strong>\u6709\u6ca1\u6709\u54ea\u79cd\u60c5\u51b5\u6570\u636e\u7684\u53ef\u7528\u6027\u4f18\u5148\u7ea7\u66f4\u9ad8\u5462\uff1f</strong></p>\n<p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p>\n<p>\u6211\u66fe\u7ecf\u78b0\u5230\u8fc7\u8fd9\u6837\u7684\u4e00\u4e2a\u573a\u666f\uff1a</p>\n<ul>\n<li>\u6709\u4e00\u4e2a\u5e93\u7684\u4f5c\u7528\u662f\u8bb0\u5f55\u64cd\u4f5c\u65e5\u5fd7\u3002\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u6570\u636e\u4e0d\u4e00\u81f4\u53ef\u4ee5\u901a\u8fc7 binlog \u6765\u4fee\u8865\uff0c\u800c\u8fd9\u4e2a\u77ed\u6682\u7684\u4e0d\u4e00\u81f4\u4e5f\u4e0d\u4f1a\u5f15\u53d1\u4e1a\u52a1\u95ee\u9898\u3002</li>\n<li>\u540c\u65f6\uff0c\u4e1a\u52a1\u7cfb\u7edf\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u65e5\u5fd7\u5199\u5165\u903b\u8f91\uff0c\u5982\u679c\u8fd9\u4e2a\u5e93\u4e0d\u53ef\u5199\uff0c\u4f1a\u5bfc\u81f4\u7ebf\u4e0a\u7684\u4e1a\u52a1\u64cd\u4f5c\u65e0\u6cd5\u6267\u884c\u3002</li>\n</ul>\n<p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u5c31\u9700\u8981\u9009\u62e9\u5148\u5f3a\u884c\u5207\u6362\uff0c\u4e8b\u540e\u518d\u8865\u6570\u636e\u7684\u7b56\u7565\u3002</p>\n<p>\u5f53\u7136\uff0c\u4e8b\u540e\u590d\u76d8\u7684\u65f6\u5019\uff0c\u6211\u4eec\u60f3\u5230\u4e86\u4e00\u4e2a\u6539\u8fdb\u63aa\u65bd\u5c31\u662f\uff0c\u8ba9\u4e1a\u52a1\u903b\u8f91\u4e0d\u8981\u4f9d\u8d56\u4e8e\u8fd9\u7c7b\u65e5\u5fd7\u7684\u5199\u5165\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u65e5\u5fd7\u5199\u5165\u8fd9\u4e2a\u903b\u8f91\u6a21\u5757\u5e94\u8be5\u53ef\u4ee5\u964d\u7ea7\uff0c\u6bd4\u5982\u5199\u5230\u672c\u5730\u6587\u4ef6\uff0c\u6216\u8005\u5199\u5230\u53e6\u5916\u4e00\u4e2a\u4e34\u65f6\u5e93\u91cc\u9762\u3002</p>\n<p>\u8fd9\u6837\u7684\u8bdd\uff0c\u8fd9\u79cd\u573a\u666f\u5c31\u53c8\u53ef\u4ee5\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u4e86\u3002</p>\n<p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u770b\u770b\uff0c<strong>\u6309\u7167\u53ef\u9760\u6027\u4f18\u5148\u7684\u601d\u8def\uff0c\u5f02\u5e38\u5207\u6362\u4f1a\u662f\u4ec0\u4e48\u6548\u679c\uff1f</strong></p>\n<p>\u5047\u8bbe\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u95f4\u7684\u4e3b\u5907\u5ef6\u8fdf\u662f 30 \u5206\u949f\uff0c\u8fd9\u65f6\u5019\u4e3b\u5e93 A \u6389\u7535\u4e86\uff0cHA \u7cfb\u7edf\u8981\u5207\u6362 B \u4f5c\u4e3a\u4e3b\u5e93\u3002\u6211\u4eec\u5728\u4e3b\u52a8\u5207\u6362\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u7b49\u5230\u4e3b\u5907\u5ef6\u8fdf\u5c0f\u4e8e 5 \u79d2\u7684\u65f6\u5019\u518d\u542f\u52a8\u5207\u6362\uff0c\u4f46\u8fd9\u65f6\u5019\u5df2\u7ecf\u522b\u65e0\u9009\u62e9\u4e86\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/553b7fc2d0dce3ec78bb595e1806eb8b.png\" /></p>\n<p>\u56fe 5 \u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e3b\u5e93\u4e0d\u53ef\u7528</p>\n<p>\u91c7\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u7684\u8bdd\uff0c\u4f60\u5c31\u5fc5\u987b\u5f97\u7b49\u5230\u5907\u5e93 B \u7684 <code>seconds_behind_master</code>=0 \u4e4b\u540e\uff0c\u624d\u80fd\u5207\u6362\u3002\u4f46\u73b0\u5728\u7684\u60c5\u51b5\u6bd4\u521a\u521a\u66f4\u4e25\u91cd\uff0c\u5e76\u4e0d\u662f\u7cfb\u7edf\u53ea\u8bfb\u3001\u4e0d\u53ef\u5199\u7684\u95ee\u9898\u4e86\uff0c\u800c\u662f\u7cfb\u7edf\u5904\u4e8e\u5b8c\u5168\u4e0d\u53ef\u7528\u7684\u72b6\u6001\u3002\u56e0\u4e3a\uff0c\u4e3b\u5e93 A \u6389\u7535\u540e\uff0c\u6211\u4eec\u7684\u8fde\u63a5\u8fd8\u6ca1\u6709\u5207\u5230\u5907\u5e93 B\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u90a3\u80fd\u4e0d\u80fd\u76f4\u63a5\u5207\u6362\u5230\u5907\u5e93 B\uff0c\u4f46\u662f\u4fdd\u6301 B \u53ea\u8bfb\u5462\uff1f</p>\n<p>\u8fd9\u6837\u4e5f\u4e0d\u884c\u3002</p>\n<p>\u56e0\u4e3a\uff0c\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u4e2d\u8f6c\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5e94\u7528\u5b8c\u6210\uff0c\u5982\u679c\u76f4\u63a5\u53d1\u8d77\u4e3b\u5907\u5207\u6362\uff0c\u5ba2\u6237\u7aef\u67e5\u8be2\u770b\u4e0d\u5230\u4e4b\u524d\u6267\u884c\u5b8c\u6210\u7684\u4e8b\u52a1\uff0c\u4f1a\u8ba4\u4e3a\u6709\u201c\u6570\u636e\u4e22\u5931\u201d\u3002</p>\n<p>\u867d\u7136\u968f\u7740\u4e2d\u8f6c\u65e5\u5fd7\u7684\u7ee7\u7eed\u5e94\u7528\uff0c\u8fd9\u4e9b\u6570\u636e\u4f1a\u6062\u590d\u56de\u6765\uff0c\u4f46\u662f\u5bf9\u4e8e\u4e00\u4e9b\u4e1a\u52a1\u6765\u8bf4\uff0c\u67e5\u8be2\u5230\u201c\u6682\u65f6\u4e22\u5931\u6570\u636e\u7684\u72b6\u6001\u201d\u4e5f\u662f\u4e0d\u80fd\u88ab\u63a5\u53d7\u7684\u3002</p>\n<p>\u804a\u5230\u8fd9\u91cc\u4f60\u5c31\u77e5\u9053\u4e86\uff0c\u5728\u6ee1\u8db3\u6570\u636e\u53ef\u9760\u6027\u7684\u524d\u63d0\u4e0b\uff0cMySQL \u9ad8\u53ef\u7528\u7cfb\u7edf\u7684\u53ef\u7528\u6027\uff0c\u662f\u4f9d\u8d56\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u3002\u5ef6\u8fdf\u7684\u65f6\u95f4\u8d8a\u5c0f\uff0c\u5728\u4e3b\u5e93\u6545\u969c\u7684\u65f6\u5019\uff0c\u670d\u52a1\u6062\u590d\u9700\u8981\u7684\u65f6\u95f4\u5c31\u8d8a\u77ed\uff0c\u53ef\u7528\u6027\u5c31\u8d8a\u9ad8\u3002</p>\n<h3 id=\"_23\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_23\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u9ad8\u53ef\u7528\u7cfb\u7edf\u7684\u57fa\u7840\uff0c\u5c31\u662f\u4e3b\u5907\u5207\u6362\u903b\u8f91\u3002\u7d27\u63a5\u7740\uff0c\u6211\u53c8\u548c\u4f60\u8ba8\u8bba\u4e86\u51e0\u79cd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u60c5\u51b5\uff0c\u4ee5\u53ca\u76f8\u5e94\u7684\u6539\u8fdb\u65b9\u5411\u3002</p>\n<p>\u7136\u540e\uff0c\u7531\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u5b58\u5728\uff0c\u5207\u6362\u7b56\u7565\u5c31\u6709\u4e0d\u540c\u7684\u9009\u62e9\u3002\u6240\u4ee5\uff0c\u6211\u53c8\u548c\u4f60\u4e00\u8d77\u5206\u6790\u4e86\u53ef\u9760\u6027\u4f18\u5148\u548c\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\u7684\u533a\u522b\u3002</p>\n<p>\u5728\u5b9e\u9645\u7684\u5e94\u7528\u4e2d\uff0c\u6211\u66f4\u5efa\u8bae\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7684\u7b56\u7565\u3002\u6bd5\u7adf\u4fdd\u8bc1\u6570\u636e\u51c6\u786e\uff0c\u5e94\u8be5\u662f\u6570\u636e\u5e93\u670d\u52a1\u7684\u5e95\u7ebf\u3002\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\uff0c\u901a\u8fc7\u51cf\u5c11\u4e3b\u5907\u5ef6\u8fdf\uff0c\u63d0\u5347\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u3002</p>\n<h2 id=\"26\">26 \u5907\u5e93\u4e3a\u4ec0\u4e48\u4f1a\u5ef6\u8fdf\u597d\u51e0\u4e2a\u5c0f\u65f6\uff1f<a class=\"headerlink\" href=\"#26\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u51e0\u79cd\u53ef\u80fd\u5bfc\u81f4\u5907\u5e93\u5ef6\u8fdf\u7684\u539f\u56e0\u3002\u4f60\u4f1a\u53d1\u73b0\uff0c\u8fd9\u4e9b\u573a\u666f\u91cc\uff0c\u4e0d\u8bba\u662f\u5076\u53d1\u6027\u7684\u67e5\u8be2\u538b\u529b\uff0c\u8fd8\u662f\u5907\u4efd\uff0c\u5bf9\u5907\u5e93\u5ef6\u8fdf\u7684\u5f71\u54cd\u4e00\u822c\u662f\u5206\u949f\u7ea7\u7684\uff0c\u800c\u4e14\u5728\u5907\u5e93\u6062\u590d\u6b63\u5e38\u4ee5\u540e\u90fd\u80fd\u591f\u8ffd\u4e0a\u6765\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u5907\u5e93\u6267\u884c\u65e5\u5fd7\u7684\u901f\u5ea6\u6301\u7eed\u4f4e\u4e8e\u4e3b\u5e93\u751f\u6210\u65e5\u5fd7\u7684\u901f\u5ea6\uff0c\u90a3\u8fd9\u4e2a\u5ef6\u8fdf\u5c31\u6709\u53ef\u80fd\u6210\u4e86\u5c0f\u65f6\u7ea7\u522b\u3002\u800c\u4e14\u5bf9\u4e8e\u4e00\u4e2a\u538b\u529b\u6301\u7eed\u6bd4\u8f83\u9ad8\u7684\u4e3b\u5e93\u6765\u8bf4\uff0c\u5907\u5e93\u5f88\u53ef\u80fd\u6c38\u8fdc\u90fd\u8ffd\u4e0d\u4e0a\u4e3b\u5e93\u7684\u8282\u594f\u3002</p>\n<p>\u8fd9\u5c31\u6d89\u53ca\u5230\u4eca\u5929\u6211\u8981\u7ed9\u4f60\u4ecb\u7ecd\u7684\u8bdd\u9898\uff1a\u5907\u5e93\u5e76\u884c\u590d\u5236\u80fd\u529b\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u4f60\u7406\u89e3\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u4e00\u4e0b\u7b2c 24 \u7bc7\u6587\u7ae0[\u300aMySQL \u662f\u600e\u4e48\u4fdd\u8bc1\u4e3b\u5907\u4e00\u81f4\u7684\uff1f\u300b]\u7684\u4e3b\u5907\u6d41\u7a0b\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/1a85a3bac30a32438bfd8862e5a34eef.png\" /></p>\n<p>\u56fe 1 \u4e3b\u5907\u6d41\u7a0b\u56fe</p>\n<p>\u8c08\u5230\u4e3b\u5907\u7684\u5e76\u884c\u590d\u5236\u80fd\u529b\uff0c\u6211\u4eec\u8981\u5173\u6ce8\u7684\u662f\u56fe\u4e2d\u9ed1\u8272\u7684\u4e24\u4e2a\u7bad\u5934\u3002\u4e00\u4e2a\u7bad\u5934\u4ee3\u8868\u4e86\u5ba2\u6237\u7aef\u5199\u5165\u4e3b\u5e93\uff0c\u53e6\u4e00\u7bad\u5934\u4ee3\u8868\u7684\u662f\u5907\u5e93\u4e0a <code>sql_thread</code> \u6267\u884c\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u3002\u5982\u679c\u7528\u7bad\u5934\u7684\u7c97\u7ec6\u6765\u4ee3\u8868\u5e76\u884c\u5ea6\u7684\u8bdd\uff0c\u90a3\u4e48\u771f\u5b9e\u60c5\u51b5\u5c31\u5982\u56fe 1 \u6240\u793a\uff0c\u7b2c\u4e00\u4e2a\u7bad\u5934\u8981\u660e\u663e\u7c97\u4e8e\u7b2c\u4e8c\u4e2a\u7bad\u5934\u3002</p>\n<p>\u5728\u4e3b\u5e93\u4e0a\uff0c\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u539f\u56e0\u5c31\u662f\u5404\u79cd\u9501\u4e86\u3002\u7531\u4e8e InnoDB \u5f15\u64ce\u652f\u6301\u884c\u9501\uff0c\u9664\u4e86\u6240\u6709\u5e76\u53d1\u4e8b\u52a1\u90fd\u5728\u66f4\u65b0\u540c\u4e00\u884c\uff08\u70ed\u70b9\u884c\uff09\u8fd9\u79cd\u6781\u7aef\u573a\u666f\u5916\uff0c\u5b83\u5bf9\u4e1a\u52a1\u5e76\u53d1\u5ea6\u7684\u652f\u6301\u8fd8\u662f\u5f88\u53cb\u597d\u7684\u3002\u6240\u4ee5\uff0c\u4f60\u5728\u6027\u80fd\u6d4b\u8bd5\u7684\u65f6\u5019\u4f1a\u53d1\u73b0\uff0c\u5e76\u53d1\u538b\u6d4b\u7ebf\u7a0b 32 \u5c31\u6bd4\u5355\u7ebf\u7a0b\u65f6\uff0c\u603b\u4f53\u541e\u5410\u91cf\u9ad8\u3002</p>\n<p>\u800c\u65e5\u5fd7\u5728\u5907\u5e93\u4e0a\u7684\u6267\u884c\uff0c\u5c31\u662f\u56fe\u4e2d\u5907\u5e93\u4e0a <code>sql_thread</code> \u66f4\u65b0\u6570\u636e (DATA) \u7684\u903b\u8f91\u3002\u5982\u679c\u662f\u7528\u5355\u7ebf\u7a0b\u7684\u8bdd\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5907\u5e93\u5e94\u7528\u65e5\u5fd7\u4e0d\u591f\u5feb\uff0c\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u3002</p>\n<p>\u5728\u5b98\u65b9\u7684 5.6 \u7248\u672c\u4e4b\u524d\uff0cMySQL \u53ea\u652f\u6301\u5355\u7ebf\u7a0b\u590d\u5236\uff0c\u7531\u6b64\u5728\u4e3b\u5e93\u5e76\u53d1\u9ad8\u3001TPS \u9ad8\u65f6\u5c31\u4f1a\u51fa\u73b0\u4e25\u91cd\u7684\u4e3b\u5907\u5ef6\u8fdf\u95ee\u9898\u3002</p>\n<p>\u4ece\u5355\u7ebf\u7a0b\u590d\u5236\u5230\u6700\u65b0\u7248\u672c\u7684\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u4e2d\u95f4\u7684\u6f14\u5316\u7ecf\u5386\u4e86\u597d\u51e0\u4e2a\u7248\u672c\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u8ddf\u4f60\u8bf4\u8bf4 MySQL \u591a\u7ebf\u7a0b\u590d\u5236\u7684\u6f14\u8fdb\u8fc7\u7a0b\u3002</p>\n<p>\u5176\u5b9e\u8bf4\u5230\u5e95\uff0c\u6240\u6709\u7684\u591a\u7ebf\u7a0b\u590d\u5236\u673a\u5236\uff0c\u90fd\u662f\u8981\u628a\u56fe 1 \u4e2d\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u7684 <code>sql_thread</code>\uff0c\u62c6\u6210\u591a\u4e2a\u7ebf\u7a0b\uff0c\u4e5f\u5c31\u662f\u90fd\u7b26\u5408\u4e0b\u9762\u7684\u8fd9\u4e2a\u6a21\u578b\uff1a</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/bcf75aa3b0f496699fd7885426bc6245.png\" /></p>\n<p>\u56fe 2 \u591a\u7ebf\u7a0b\u6a21\u578b</p>\n<p>\u56fe 2 \u4e2d\uff0ccoordinator \u5c31\u662f\u539f\u6765\u7684 <code>sql_thread</code>, \u4e0d\u8fc7\u73b0\u5728\u5b83\u4e0d\u518d\u76f4\u63a5\u66f4\u65b0\u6570\u636e\u4e86\uff0c\u53ea\u8d1f\u8d23\u8bfb\u53d6\u4e2d\u8f6c\u65e5\u5fd7\u548c\u5206\u53d1\u4e8b\u52a1\u3002\u771f\u6b63\u66f4\u65b0\u65e5\u5fd7\u7684\uff0c\u53d8\u6210\u4e86 worker \u7ebf\u7a0b\u3002\u800c work \u7ebf\u7a0b\u7684\u4e2a\u6570\uff0c\u5c31\u662f\u7531\u53c2\u6570 <code>slave_parallel_workers</code> \u51b3\u5b9a\u7684\u3002\u6839\u636e\u6211\u7684\u7ecf\u9a8c\uff0c\u628a\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a 8~16 \u4e4b\u95f4\u6700\u597d\uff0832 \u6838\u7269\u7406\u673a\u7684\u60c5\u51b5\uff09\uff0c\u6bd5\u7adf\u5907\u5e93\u8fd8\u6709\u53ef\u80fd\u8981\u63d0\u4f9b\u8bfb\u67e5\u8be2\uff0c\u4e0d\u80fd\u628a CPU \u90fd\u5403\u5149\u4e86\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u4f60\u9700\u8981\u5148\u601d\u8003\u4e00\u4e2a\u95ee\u9898\uff1a\u4e8b\u52a1\u80fd\u4e0d\u80fd\u6309\u7167\u8f6e\u8be2\u7684\u65b9\u5f0f\u5206\u53d1\u7ed9\u5404\u4e2a worker\uff0c\u4e5f\u5c31\u662f\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5206\u7ed9 <code>worker_1</code>\uff0c\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u53d1\u7ed9 <code>worker_2</code> \u5462\uff1f</p>\n<p>\u5176\u5b9e\u662f\u4e0d\u884c\u7684\u3002\u56e0\u4e3a\uff0c\u4e8b\u52a1\u88ab\u5206\u53d1\u7ed9 worker \u4ee5\u540e\uff0c\u4e0d\u540c\u7684 worker \u5c31\u72ec\u7acb\u6267\u884c\u4e86\u3002\u4f46\u662f\uff0c\u7531\u4e8e CPU \u7684\u8c03\u5ea6\u7b56\u7565\uff0c\u5f88\u53ef\u80fd\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u6700\u7ec8\u6bd4\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5148\u6267\u884c\u3002\u800c\u5982\u679c\u8fd9\u65f6\u5019\u521a\u597d\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u66f4\u65b0\u7684\u662f\u540c\u4e00\u884c\uff0c\u4e5f\u5c31\u610f\u5473\u7740\uff0c\u540c\u4e00\u884c\u4e0a\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5728\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u7684\u6267\u884c\u987a\u5e8f\u76f8\u53cd\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u8bf7\u4f60\u518d\u8bbe\u60f3\u4e00\u4e0b\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff1a\u540c\u4e00\u4e2a\u4e8b\u52a1\u7684\u591a\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u80fd\u4e0d\u80fd\u5206\u7ed9\u4e0d\u540c\u7684 worker \u6765\u6267\u884c\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u4e5f\u4e0d\u884c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4e00\u4e2a\u4e8b\u52a1\u66f4\u65b0\u4e86\u8868 t1 \u548c\u8868 t2 \u4e2d\u7684\u5404\u4e00\u884c\uff0c\u5982\u679c\u8fd9\u4e24\u6761\u66f4\u65b0\u8bed\u53e5\u88ab\u5206\u5230\u4e0d\u540c worker \u7684\u8bdd\uff0c\u867d\u7136\u6700\u7ec8\u7684\u7ed3\u679c\u662f\u4e3b\u5907\u4e00\u81f4\u7684\uff0c\u4f46\u5982\u679c\u8868 t1 \u6267\u884c\u5b8c\u6210\u7684\u77ac\u95f4\uff0c\u5907\u5e93\u4e0a\u6709\u4e00\u4e2a\u67e5\u8be2\uff0c\u5c31\u4f1a\u770b\u5230\u8fd9\u4e2a\u4e8b\u52a1\u201c\u66f4\u65b0\u4e86\u4e00\u534a\u7684\u7ed3\u679c\u201d\uff0c\u7834\u574f\u4e86\u4e8b\u52a1\u903b\u8f91\u7684\u9694\u79bb\u6027\u3002</p>\n<p>\u6240\u4ee5\uff0ccoordinator \u5728\u5206\u53d1\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u8fd9\u4e24\u4e2a\u57fa\u672c\u8981\u6c42\uff1a</p>\n<ol>\n<li>\u4e0d\u80fd\u9020\u6210\u66f4\u65b0\u8986\u76d6\u3002\u8fd9\u5c31\u8981\u6c42\u66f4\u65b0\u540c\u4e00\u884c\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5fc5\u987b\u88ab\u5206\u53d1\u5230\u540c\u4e00\u4e2a worker \u4e2d\u3002</li>\n<li>\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e0d\u80fd\u88ab\u62c6\u5f00\uff0c\u5fc5\u987b\u653e\u5230\u540c\u4e00\u4e2a worker \u4e2d\u3002</li>\n</ol>\n<p>\u5404\u4e2a\u7248\u672c\u7684\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u90fd\u9075\u5faa\u4e86\u8fd9\u4e24\u6761\u57fa\u672c\u539f\u5219\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u5404\u4e2a\u7248\u672c\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u3002</p>\n<h3 id=\"mysql-56\">MySQL 5.6 \u7248\u672c\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565<a class=\"headerlink\" href=\"#mysql-56\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9 MySQL5.6 \u7248\u672c\uff0c\u652f\u6301\u4e86\u5e76\u884c\u590d\u5236\uff0c\u53ea\u662f\u652f\u6301\u7684\u7c92\u5ea6\u662f\u6309\u5e93\u5e76\u884c\u3002\u7406\u89e3\u4e86\u4e0a\u9762\u4ecb\u7ecd\u7684\u6309\u8868\u5206\u53d1\u7b56\u7565\u548c\u6309\u884c\u5206\u53d1\u7b56\u7565\uff0c\u4f60\u5c31\u7406\u89e3\u4e86\uff0c\u7528\u4e8e\u51b3\u5b9a\u5206\u53d1\u7b56\u7565\u7684 hash \u8868\u91cc\uff0ckey \u5c31\u662f\u6570\u636e\u5e93\u540d\u3002</p>\n<p>\u8fd9\u4e2a\u7b56\u7565\u7684\u5e76\u884c\u6548\u679c\uff0c\u53d6\u51b3\u4e8e\u538b\u529b\u6a21\u578b\u3002\u5982\u679c\u5728\u4e3b\u5e93\u4e0a\u6709\u591a\u4e2a DB\uff0c\u5e76\u4e14\u5404\u4e2a DB \u7684\u538b\u529b\u5747\u8861\uff0c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u7684\u6548\u679c\u4f1a\u5f88\u597d\u3002</p>\n<p>\u76f8\u6bd4\u4e8e\u6309\u8868\u548c\u6309\u884c\u5206\u53d1\uff0c\u8fd9\u4e2a\u7b56\u7565\u6709\u4e24\u4e2a\u4f18\u52bf\uff1a</p>\n<ol>\n<li>\u6784\u9020 hash \u503c\u7684\u65f6\u5019\u5f88\u5feb\uff0c\u53ea\u9700\u8981\u5e93\u540d\uff1b\u800c\u4e14\u4e00\u4e2a\u5b9e\u4f8b\u4e0a DB \u6570\u4e5f\u4e0d\u4f1a\u5f88\u591a\uff0c\u4e0d\u4f1a\u51fa\u73b0\u9700\u8981\u6784\u9020 100 \u4e07\u4e2a\u9879\u8fd9\u79cd\u60c5\u51b5\u3002</li>\n<li>\u4e0d\u8981\u6c42 binlog \u7684\u683c\u5f0f\u3002\u56e0\u4e3a statement \u683c\u5f0f\u7684 binlog \u4e5f\u53ef\u4ee5\u5f88\u5bb9\u6613\u62ff\u5230\u5e93\u540d\u3002</li>\n</ol>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u7684\u4e3b\u5e93\u4e0a\u7684\u8868\u90fd\u653e\u5728\u540c\u4e00\u4e2a DB \u91cc\u9762\uff0c\u8fd9\u4e2a\u7b56\u7565\u5c31\u6ca1\u6709\u6548\u679c\u4e86\uff1b\u6216\u8005\u5982\u679c\u4e0d\u540c DB \u7684\u70ed\u70b9\u4e0d\u540c\uff0c\u6bd4\u5982\u4e00\u4e2a\u662f\u4e1a\u52a1\u903b\u8f91\u5e93\uff0c\u4e00\u4e2a\u662f\u7cfb\u7edf\u914d\u7f6e\u5e93\uff0c\u90a3\u4e5f\u8d77\u4e0d\u5230\u5e76\u884c\u7684\u6548\u679c\u3002</p>\n<p>\u7406\u8bba\u4e0a\u4f60\u53ef\u4ee5\u521b\u5efa\u4e0d\u540c\u7684 DB\uff0c\u628a\u76f8\u540c\u70ed\u5ea6\u7684\u8868\u5747\u5300\u5206\u5230\u8fd9\u4e9b\u4e0d\u540c\u7684 DB \u4e2d\uff0c\u5f3a\u884c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u3002\u4e0d\u8fc7\u636e\u6211\u6240\u77e5\uff0c\u7531\u4e8e\u9700\u8981\u7279\u5730\u79fb\u52a8\u6570\u636e\uff0c\u8fd9\u4e2a\u7b56\u7565\u7528\u5f97\u5e76\u4e0d\u591a\u3002</p>\n<h3 id=\"mariadb\">MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565<a class=\"headerlink\" href=\"#mariadb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u7b2c 23 \u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 redo log \u7ec4\u63d0\u4ea4 (group commit) \u4f18\u5316\uff0c \u800c MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u5229\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u7279\u6027\uff1a</p>\n<ol>\n<li>\u80fd\u591f\u5728\u540c\u4e00\u7ec4\u91cc\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u4e00\u5b9a\u4e0d\u4f1a\u4fee\u6539\u540c\u4e00\u884c\uff1b</li>\n<li>\u4e3b\u5e93\u4e0a\u53ef\u4ee5\u5e76\u884c\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u5907\u5e93\u4e0a\u4e5f\u4e00\u5b9a\u662f\u53ef\u4ee5\u5e76\u884c\u6267\u884c\u7684\u3002</li>\n</ol>\n<p>\u5728\u5b9e\u73b0\u4e0a\uff0cMariaDB \u662f\u8fd9\u4e48\u505a\u7684\uff1a</p>\n<ol>\n<li>\u5728\u4e00\u7ec4\u91cc\u9762\u4e00\u8d77\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u6709\u4e00\u4e2a\u76f8\u540c\u7684 <code>commit_id</code>\uff0c\u4e0b\u4e00\u7ec4\u5c31\u662f <code>commit_id+1</code>\uff1b</li>\n<li><code>commit_id</code> \u76f4\u63a5\u5199\u5230 binlog \u91cc\u9762\uff1b</li>\n<li>\u4f20\u5230\u5907\u5e93\u5e94\u7528\u7684\u65f6\u5019\uff0c\u76f8\u540c <code>commit_id</code> \u7684\u4e8b\u52a1\u5206\u53d1\u5230\u591a\u4e2a worker \u6267\u884c\uff1b</li>\n<li>\u8fd9\u4e00\u7ec4\u5168\u90e8\u6267\u884c\u5b8c\u6210\u540e\uff0ccoordinator \u518d\u53bb\u53d6\u4e0b\u4e00\u6279\u3002</li>\n</ol>\n<p>\u5f53\u65f6\uff0c\u8fd9\u4e2a\u7b56\u7565\u51fa\u6765\u7684\u65f6\u5019\u662f\u76f8\u5f53\u60ca\u8273\u7684\u3002\u56e0\u4e3a\uff0c\u4e4b\u524d\u4e1a\u754c\u7684\u601d\u8def\u90fd\u662f\u5728\u201c\u5206\u6790 binlog\uff0c\u5e76\u62c6\u5206\u5230 worker\u201d\u4e0a\u3002\u800c MariaDB \u7684\u8fd9\u4e2a\u7b56\u7565\uff0c\u76ee\u6807\u662f\u201c\u6a21\u62df\u4e3b\u5e93\u7684\u5e76\u884c\u6a21\u5f0f\u201d\u3002</p>\n<p>\u4f46\u662f\uff0c\u8fd9\u4e2a\u7b56\u7565\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5b83\u5e76\u6ca1\u6709\u5b9e\u73b0\u201c\u771f\u6b63\u7684\u6a21\u62df\u4e3b\u5e93\u5e76\u53d1\u5ea6\u201d\u8fd9\u4e2a\u76ee\u6807\u3002\u5728\u4e3b\u5e93\u4e0a\uff0c\u4e00\u7ec4\u4e8b\u52a1\u5728 commit \u7684\u65f6\u5019\uff0c\u4e0b\u4e00\u7ec4\u4e8b\u52a1\u662f\u540c\u65f6\u5904\u4e8e\u201c\u6267\u884c\u4e2d\u201d\u72b6\u6001\u7684\u3002</p>\n<p>\u5982\u56fe 5 \u6240\u793a\uff0c\u5047\u8bbe\u4e86\u4e09\u7ec4\u4e8b\u52a1\u5728\u4e3b\u5e93\u7684\u6267\u884c\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u5728 trx1\u3001trx2 \u548c trx3 \u63d0\u4ea4\u7684\u65f6\u5019\uff0ctrx4\u3001trx5 \u548c trx6 \u662f\u5728\u6267\u884c\u7684\u3002\u8fd9\u6837\uff0c\u5728\u7b2c\u4e00\u7ec4\u4e8b\u52a1\u63d0\u4ea4\u5b8c\u6210\u7684\u65f6\u5019\uff0c\u4e0b\u4e00\u7ec4\u4e8b\u52a1\u5f88\u5feb\u5c31\u4f1a\u8fdb\u5165 commit \u72b6\u6001\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/8fec5fb48d6095aecc80016826efbfc3.png\" /></p>\n<p>\u56fe 5 \u4e3b\u5e93\u5e76\u884c\u4e8b\u52a1</p>\n<p>\u800c\u6309\u7167 MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\uff0c\u5907\u5e93\u4e0a\u7684\u6267\u884c\u6548\u679c\u5982\u56fe 6 \u6240\u793a\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/8ac3799c1ff2f9833619a1624ca3e622.png\" /></p>\n<p>\u56fe 6 MariaDB \u5e76\u884c\u590d\u5236\uff0c\u5907\u5e93\u5e76\u884c\u6548\u679c</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u5907\u5e93\u4e0a\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u7b49\u7b2c\u4e00\u7ec4\u4e8b\u52a1\u5b8c\u5168\u6267\u884c\u5b8c\u6210\u540e\uff0c\u7b2c\u4e8c\u7ec4\u4e8b\u52a1\u624d\u80fd\u5f00\u59cb\u6267\u884c\uff0c\u8fd9\u6837\u7cfb\u7edf\u7684\u541e\u5410\u91cf\u5c31\u4e0d\u591f\u3002</p>\n<p>\u53e6\u5916\uff0c\u8fd9\u4e2a\u65b9\u6848\u5f88\u5bb9\u6613\u88ab\u5927\u4e8b\u52a1\u62d6\u540e\u817f\u3002\u5047\u8bbe trx2 \u662f\u4e00\u4e2a\u8d85\u5927\u4e8b\u52a1\uff0c\u90a3\u4e48\u5728\u5907\u5e93\u5e94\u7528\u7684\u65f6\u5019\uff0ctrx1 \u548c trx3 \u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c31\u53ea\u80fd\u7b49 trx2 \u5b8c\u5168\u6267\u884c\u5b8c\u6210\uff0c\u4e0b\u4e00\u7ec4\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002\u8fd9\u6bb5\u65f6\u95f4\uff0c\u53ea\u6709\u4e00\u4e2a worker \u7ebf\u7a0b\u5728\u5de5\u4f5c\uff0c\u662f\u5bf9\u8d44\u6e90\u7684\u6d6a\u8d39\u3002</p>\n<p>\u4e0d\u8fc7\u5373\u4f7f\u5982\u6b64\uff0c\u8fd9\u4e2a\u7b56\u7565\u4ecd\u7136\u662f\u4e00\u4e2a\u5f88\u6f02\u4eae\u7684\u521b\u65b0\u3002\u56e0\u4e3a\uff0c\u5b83\u5bf9\u539f\u7cfb\u7edf\u7684\u6539\u9020\u975e\u5e38\u5c11\uff0c\u5b9e\u73b0\u4e5f\u5f88\u4f18\u96c5\u3002</p>\n<h3 id=\"mysql-57\">MySQL 5.7 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565<a class=\"headerlink\" href=\"#mysql-57\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 MariaDB \u5e76\u884c\u590d\u5236\u5b9e\u73b0\u4e4b\u540e\uff0c\u5b98\u65b9\u7684 MySQL5.7 \u7248\u672c\u4e5f\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u7531\u53c2\u6570 slave-parallel-type \u6765\u63a7\u5236\u5e76\u884c\u590d\u5236\u7b56\u7565\uff1a</p>\n<ol>\n<li>\u914d\u7f6e\u4e3a DATABASE\uff0c\u8868\u793a\u4f7f\u7528 MySQL 5.6 \u7248\u672c\u7684\u6309\u5e93\u5e76\u884c\u7b56\u7565\uff1b</li>\n<li>\u914d\u7f6e\u4e3a <code>LOGICAL_CLOCK</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u7c7b\u4f3c MariaDB \u7684\u7b56\u7565\u3002\u4e0d\u8fc7\uff0cMySQL 5.7 \u8fd9\u4e2a\u7b56\u7565\uff0c\u9488\u5bf9\u5e76\u884c\u5ea6\u505a\u4e86\u4f18\u5316\u3002\u8fd9\u4e2a\u4f18\u5316\u7684\u601d\u8def\u4e5f\u5f88\u6709\u8da3\u513f\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u4ee5\u5148\u8003\u8651\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a\u540c\u65f6\u5904\u4e8e\u201c\u6267\u884c\u72b6\u6001\u201d\u7684\u6240\u6709\u4e8b\u52a1\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u5e76\u884c\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u4e0d\u80fd\u3002</p>\n<p>\u56e0\u4e3a\uff0c\u8fd9\u91cc\u9762\u53ef\u80fd\u6709\u7531\u4e8e\u9501\u51b2\u7a81\u800c\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\u7684\u4e8b\u52a1\u3002\u5982\u679c\u8fd9\u4e9b\u4e8b\u52a1\u5728\u5907\u5e93\u4e0a\u88ab\u5206\u914d\u5230\u4e0d\u540c\u7684 worker\uff0c\u5c31\u4f1a\u51fa\u73b0\u5907\u5e93\u8ddf\u4e3b\u5e93\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p>\n<p>\u800c\u4e0a\u9762\u63d0\u5230\u7684 MariaDB \u8fd9\u4e2a\u7b56\u7565\u7684\u6838\u5fc3\uff0c\u662f\u201c\u6240\u6709\u5904\u4e8e commit\u201d\u72b6\u6001\u7684\u4e8b\u52a1\u53ef\u4ee5\u5e76\u884c\u3002\u4e8b\u52a1\u5904\u4e8e commit \u72b6\u6001\uff0c\u8868\u793a\u5df2\u7ecf\u901a\u8fc7\u4e86\u9501\u51b2\u7a81\u7684\u68c0\u9a8c\u4e86\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e00\u4e0b\u4e24\u9636\u6bb5\u63d0\u4ea4\u3002</p>\n<p>\u5176\u5b9e\uff0c\u4e0d\u7528\u7b49\u5230 commit \u9636\u6bb5\uff0c\u53ea\u8981\u80fd\u591f\u5230\u8fbe redo log prepare \u9636\u6bb5\uff0c\u5c31\u8868\u793a\u4e8b\u52a1\u5df2\u7ecf\u901a\u8fc7\u9501\u51b2\u7a81\u7684\u68c0\u9a8c\u4e86\u3002</p>\n<p>\u56e0\u6b64\uff0cMySQL 5.7 \u5e76\u884c\u590d\u5236\u7b56\u7565\u7684\u601d\u60f3\u662f\uff1a</p>\n<ol>\n<li>\u540c\u65f6\u5904\u4e8e prepare \u72b6\u6001\u7684\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u65f6\u662f\u53ef\u4ee5\u5e76\u884c\u7684\uff1b</li>\n<li>\u5904\u4e8e prepare \u72b6\u6001\u7684\u4e8b\u52a1\uff0c\u4e0e\u5904\u4e8e commit \u72b6\u6001\u7684\u4e8b\u52a1\u4e4b\u95f4\uff0c\u5728\u5907\u5e93\u6267\u884c\u65f6\u4e5f\u662f\u53ef\u4ee5\u5e76\u884c\u7684\u3002</li>\n</ol>\n<p>\u6211\u5728\u7b2c 23 \u7bc7\u6587\u7ae0\uff0c\u8bb2 binlog \u7684\u7ec4\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u4ecb\u7ecd\u8fc7\u4e24\u4e2a\u53c2\u6570\uff1a</p>\n<ol>\n<li><code>binlog_group_commit_sync_delay</code> \u53c2\u6570\uff0c\u8868\u793a\u5ef6\u8fdf\u591a\u5c11\u5fae\u79d2\u540e\u624d\u8c03\u7528 fsync;</li>\n<li><code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u8868\u793a\u7d2f\u79ef\u591a\u5c11\u6b21\u4ee5\u540e\u624d\u8c03\u7528 fsync\u3002</li>\n</ol>\n<p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u662f\u7528\u4e8e\u6545\u610f\u62c9\u957f binlog \u4ece write \u5230 fsync \u7684\u65f6\u95f4\uff0c\u4ee5\u6b64\u51cf\u5c11 binlog \u7684\u5199\u76d8\u6b21\u6570\u3002\u5728 MySQL 5.7 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u91cc\uff0c\u5b83\u4eec\u53ef\u4ee5\u7528\u6765\u5236\u9020\u66f4\u591a\u7684\u201c\u540c\u65f6\u5904\u4e8e prepare \u9636\u6bb5\u7684\u4e8b\u52a1\u201d\u3002\u8fd9\u6837\u5c31\u589e\u52a0\u4e86\u5907\u5e93\u590d\u5236\u7684\u5e76\u884c\u5ea6\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u65e2\u53ef\u4ee5\u201c\u6545\u610f\u201d\u8ba9\u4e3b\u5e93\u63d0\u4ea4\u5f97\u6162\u4e9b\uff0c\u53c8\u53ef\u4ee5\u8ba9\u5907\u5e93\u6267\u884c\u5f97\u5feb\u4e9b\u3002\u5728 MySQL 5.7 \u5904\u7406\u5907\u5e93\u5ef6\u8fdf\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u8003\u8651\u8c03\u6574\u8fd9\u4e24\u4e2a\u53c2\u6570\u503c\uff0c\u6765\u8fbe\u5230\u63d0\u5347\u5907\u5e93\u590d\u5236\u5e76\u53d1\u5ea6\u7684\u76ee\u7684\u3002</p>\n<h3 id=\"mysql-5722\">MySQL 5.7.22 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565<a class=\"headerlink\" href=\"#mysql-5722\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 2018 \u5e74 4 \u6708\u4efd\u53d1\u5e03\u7684 MySQL 5.7.22 \u7248\u672c\u91cc\uff0cMySQL \u589e\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\uff0c\u57fa\u4e8e WRITESET \u7684\u5e76\u884c\u590d\u5236\u3002</p>\n<p>\u76f8\u5e94\u5730\uff0c\u65b0\u589e\u4e86\u4e00\u4e2a\u53c2\u6570 <code>binlog-transaction-dependency-tracking</code>\uff0c\u7528\u6765\u63a7\u5236\u662f\u5426\u542f\u7528\u8fd9\u4e2a\u65b0\u7b56\u7565\u3002\u8fd9\u4e2a\u53c2\u6570\u7684\u53ef\u9009\u503c\u6709\u4ee5\u4e0b\u4e09\u79cd\u3002</p>\n<ol>\n<li><code>COMMIT_ORDER</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u524d\u9762\u4ecb\u7ecd\u7684\uff0c\u6839\u636e\u540c\u65f6\u8fdb\u5165 prepare \u548c commit \u6765\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u5e76\u884c\u7684\u7b56\u7565\u3002</li>\n<li><code>WRITESET</code>\uff0c\u8868\u793a\u7684\u662f\u5bf9\u4e8e\u4e8b\u52a1\u6d89\u53ca\u66f4\u65b0\u7684\u6bcf\u4e00\u884c\uff0c\u8ba1\u7b97\u51fa\u8fd9\u4e00\u884c\u7684 hash \u503c\uff0c\u7ec4\u6210\u96c6\u5408 writeset\u3002\u5982\u679c\u4e24\u4e2a\u4e8b\u52a1\u6ca1\u6709\u64cd\u4f5c\u76f8\u540c\u7684\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u4eec\u7684 writeset \u6ca1\u6709\u4ea4\u96c6\uff0c\u5c31\u53ef\u4ee5\u5e76\u884c\u3002</li>\n<li><code>WRITESET_SESSION</code>\uff0c\u662f\u5728 WRITESET \u7684\u57fa\u7840\u4e0a\u591a\u4e86\u4e00\u4e2a\u7ea6\u675f\uff0c\u5373\u5728\u4e3b\u5e93\u4e0a\u540c\u4e00\u4e2a\u7ebf\u7a0b\u5148\u540e\u6267\u884c\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u4fdd\u8bc1\u76f8\u540c\u7684\u5148\u540e\u987a\u5e8f\u3002</li>\n</ol>\n<p>\u5f53\u7136\u4e3a\u4e86\u552f\u4e00\u6807\u8bc6\uff0c\u8fd9\u4e2a hash \u503c\u662f\u901a\u8fc7\u201c\u5e93\u540d + \u8868\u540d + \u7d22\u5f15\u540d + \u503c\u201d\u8ba1\u7b97\u51fa\u6765\u7684\u3002\u5982\u679c\u4e00\u4e2a\u8868\u4e0a\u9664\u4e86\u6709\u4e3b\u952e\u7d22\u5f15\u5916\uff0c\u8fd8\u6709\u5176\u4ed6\u552f\u4e00\u7d22\u5f15\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u4e2a\u552f\u4e00\u7d22\u5f15\uff0cinsert \u8bed\u53e5\u5bf9\u5e94\u7684 writeset \u5c31\u8981\u591a\u589e\u52a0\u4e00\u4e2a hash \u503c\u3002</p>\n<p>\u4f60\u53ef\u80fd\u770b\u51fa\u6765\u4e86\uff0c\u8fd9\u8ddf\u6211\u4eec\u524d\u9762\u4ecb\u7ecd\u7684\u57fa\u4e8e MySQL 5.5 \u7248\u672c\u7684\u6309\u884c\u5206\u53d1\u7684\u7b56\u7565\u662f\u5dee\u4e0d\u591a\u7684\u3002\u4e0d\u8fc7\uff0cMySQL \u5b98\u65b9\u7684\u8fd9\u4e2a\u5b9e\u73b0\u8fd8\u662f\u6709\u5f88\u5927\u7684\u4f18\u52bf\uff1a</p>\n<ol>\n<li>writeset \u662f\u5728\u4e3b\u5e93\u751f\u6210\u540e\u76f4\u63a5\u5199\u5165\u5230 binlog \u91cc\u9762\u7684\uff0c\u8fd9\u6837\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u4e0d\u9700\u8981\u89e3\u6790 binlog \u5185\u5bb9\uff08event \u91cc\u7684\u884c\u6570\u636e\uff09\uff0c\u8282\u7701\u4e86\u5f88\u591a\u8ba1\u7b97\u91cf\uff1b</li>\n<li>\u4e0d\u9700\u8981\u628a\u6574\u4e2a\u4e8b\u52a1\u7684 binlog \u90fd\u626b\u4e00\u904d\u624d\u80fd\u51b3\u5b9a\u5206\u53d1\u5230\u54ea\u4e2a worker\uff0c\u66f4\u7701\u5185\u5b58\uff1b</li>\n<li>\u7531\u4e8e\u5907\u5e93\u7684\u5206\u53d1\u7b56\u7565\u4e0d\u4f9d\u8d56\u4e8e binlog \u5185\u5bb9\uff0c\u6240\u4ee5 binlog \u662f statement \u683c\u5f0f\u4e5f\u662f\u53ef\u4ee5\u7684\u3002</li>\n</ol>\n<p>\u56e0\u6b64\uff0cMySQL 5.7.22 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u5728\u901a\u7528\u6027\u4e0a\u8fd8\u662f\u6709\u4fdd\u8bc1\u7684\u3002</p>\n<p>\u5f53\u7136\uff0c\u5bf9\u4e8e\u201c\u8868\u4e0a\u6ca1\u4e3b\u952e\u201d\u548c\u201c\u5916\u952e\u7ea6\u675f\u201d\u7684\u573a\u666f\uff0cWRITESET \u7b56\u7565\u4e5f\u662f\u6ca1\u6cd5\u5e76\u884c\u7684\uff0c\u4e5f\u4f1a\u6682\u65f6\u9000\u5316\u4e3a\u5355\u7ebf\u7a0b\u6a21\u578b\u3002</p>\n<h3 id=\"_24\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_24\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5404\u79cd\u591a\u7ebf\u7a0b\u590d\u5236\u7b56\u7565\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8981\u6709\u591a\u7ebf\u7a0b\u590d\u5236\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5355\u7ebf\u7a0b\u590d\u5236\u7684\u80fd\u529b\u5168\u9762\u4f4e\u4e8e\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u8f83\u5927\u7684\u4e3b\u5e93\uff0c\u5907\u5e93\u662f\u53ef\u80fd\u4e00\u76f4\u8ffd\u4e0d\u4e0a\u4e3b\u5e93\u7684\u3002\u4ece\u73b0\u8c61\u4e0a\u770b\u5c31\u662f\uff0c\u5907\u5e93\u4e0a <code>seconds_behind_master</code> \u7684\u503c\u8d8a\u6765\u8d8a\u5927\u3002</p>\n<p>\u5728\u4ecb\u7ecd\u5b8c\u6bcf\u4e2a\u5e76\u884c\u590d\u5236\u7b56\u7565\u540e\uff0c\u6211\u8fd8\u548c\u4f60\u5206\u4eab\u4e86\u4e0d\u540c\u7b56\u7565\u7684\u4f18\u7f3a\u70b9\uff1a</p>\n<ul>\n<li>\u5982\u679c\u4f60\u662f DBA\uff0c\u5c31\u9700\u8981\u6839\u636e\u4e0d\u540c\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u9009\u62e9\u4e0d\u540c\u7684\u7b56\u7565\uff1b</li>\n<li>\u5982\u679c\u662f\u4f60\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\uff0c\u4e5f\u5e0c\u671b\u4f60\u80fd\u4ece\u4e2d\u83b7\u53d6\u7075\u611f\u7528\u5230\u5e73\u65f6\u7684\u5f00\u53d1\u5de5\u4f5c\u4e2d\u3002</li>\n</ul>\n<p>\u4ece\u8fd9\u4e9b\u5206\u6790\u4e2d\uff0c\u4f60\u4e5f\u4f1a\u53d1\u73b0\u5927\u4e8b\u52a1\u4e0d\u4ec5\u4f1a\u5f71\u54cd\u5230\u4e3b\u5e93\uff0c\u4e5f\u662f\u9020\u6210\u5907\u5e93\u590d\u5236\u5ef6\u8fdf\u7684\u4e3b\u8981\u539f\u56e0\u4e4b\u4e00\u3002\u56e0\u6b64\uff0c\u5728\u5e73\u65f6\u7684\u5f00\u53d1\u5de5\u4f5c\u4e2d\uff0c\u6211\u5efa\u8bae\u4f60\u5c3d\u91cf\u51cf\u5c11\u5927\u4e8b\u52a1\u64cd\u4f5c\uff0c\u628a\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</p>\n<p>\u5b98\u65b9 MySQL5.7 \u7248\u672c\u65b0\u589e\u7684\u5907\u5e93\u5e76\u884c\u7b56\u7565\uff0c\u4fee\u6539\u4e86 binlog \u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8bf4 binlog \u534f\u8bae\u5e76\u4e0d\u662f\u5411\u4e0a\u517c\u5bb9\u7684\uff0c\u5728\u4e3b\u5907\u5207\u6362\u3001\u7248\u672c\u5347\u7ea7\u7684\u65f6\u5019\u9700\u8981\u628a\u8fd9\u4e2a\u56e0\u7d20\u4e5f\u8003\u8651\u8fdb\u53bb\u3002</p>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p>\n<p>\u5047\u8bbe\u4e00\u4e2a MySQL 5.7.22 \u7248\u672c\u7684\u4e3b\u5e93\uff0c\u5355\u7ebf\u7a0b\u63d2\u5165\u4e86\u5f88\u591a\u6570\u636e\uff0c\u8fc7\u4e86 3 \u4e2a\u5c0f\u65f6\u540e\uff0c\u6211\u4eec\u8981\u7ed9\u8fd9\u4e2a\u4e3b\u5e93\u642d\u5efa\u4e00\u4e2a\u76f8\u540c\u7248\u672c\u7684\u5907\u5e93\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u4f60\u4e3a\u4e86\u66f4\u5feb\u5730\u8ba9\u5907\u5e93\u8ffd\u4e0a\u4e3b\u5e93\uff0c\u8981\u5f00\u5e76\u884c\u590d\u5236\u3002\u5728 binlog-transaction-dependency-tracking \u53c2\u6570\u7684 <code>COMMIT_ORDER</code>\u3001<code>WRITESET</code> \u548c <code>WRITE_SESSION</code> \u8fd9\u4e09\u4e2a\u53d6\u503c\u4e2d\uff0c\u4f60\u4f1a\u9009\u62e9\u54ea\u4e00\u4e2a\u5462\uff1f</p>\n<p>\u4f60\u9009\u62e9\u7684\u539f\u56e0\u662f\u4ec0\u4e48\uff1f\u5982\u679c\u8bbe\u7f6e\u53e6\u5916\u4e24\u4e2a\u53c2\u6570\uff0c\u4f60\u8ba4\u4e3a\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u662f\uff0c\u5e94\u8be5\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a WRITESET\u3002</p>\n<p>\u7531\u4e8e\u4e3b\u5e93\u662f\u5355\u7ebf\u7a0b\u538b\u529b\u6a21\u5f0f\uff0c\u6240\u4ee5\u6bcf\u4e2a\u4e8b\u52a1\u7684 <code>commit_id</code> \u90fd\u4e0d\u540c\uff0c\u90a3\u4e48\u8bbe\u7f6e\u4e3a <code>COMMIT_ORDER</code> \u6a21\u5f0f\u7684\u8bdd\uff0c\u4ece\u5e93\u4e5f\u53ea\u80fd\u5355\u7ebf\u7a0b\u6267\u884c\u3002</p>\n<p>\u540c\u6837\u5730\uff0c\u7531\u4e8e <code>WRITESET_SESSION</code> \u6a21\u5f0f\u8981\u6c42\u5728\u5907\u5e93\u5e94\u7528\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u540c\u4e00\u4e2a\u7ebf\u7a0b\u7684\u65e5\u5fd7\u5fc5\u987b\u4e0e\u4e3b\u5e93\u4e0a\u6267\u884c\u7684\u5148\u540e\u987a\u5e8f\u76f8\u540c\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u4e3b\u5e93\u5355\u7ebf\u7a0b\u538b\u529b\u6a21\u5f0f\u4e0b\u9000\u5316\u6210\u5355\u7ebf\u7a0b\u590d\u5236\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5e94\u8be5\u5c06 binlog-transaction-dependency-tracking \u8bbe\u7f6e\u4e3a WRITESET\u3002</p>\n<h2 id=\"27\">27 \u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff0c\u4ece\u5e93\u600e\u4e48\u529e\uff1f<a class=\"headerlink\" href=\"#27\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u4ecb\u7ecd\u4e86 MySQL \u4e3b\u5907\u590d\u5236\u7684\u57fa\u7840\u7ed3\u6784\uff0c\u4f46\u8fd9\u4e9b\u90fd\u662f\u4e00\u4e3b\u4e00\u5907\u7684\u7ed3\u6784\u3002</p>\n<p>\u5927\u591a\u6570\u7684\u4e92\u8054\u7f51\u5e94\u7528\u573a\u666f\u90fd\u662f\u8bfb\u591a\u5199\u5c11\uff0c\u56e0\u6b64\u4f60\u8d1f\u8d23\u7684\u4e1a\u52a1\uff0c\u5728\u53d1\u5c55\u8fc7\u7a0b\u4e2d\u5f88\u53ef\u80fd\u5148\u4f1a\u9047\u5230\u8bfb\u6027\u80fd\u7684\u95ee\u9898\u3002\u800c\u5728\u6570\u636e\u5e93\u5c42\u89e3\u51b3\u8bfb\u6027\u80fd\u95ee\u9898\uff0c\u5c31\u8981\u6d89\u53ca\u5230\u63a5\u4e0b\u6765\u4e24\u7bc7\u6587\u7ae0\u8981\u8ba8\u8bba\u7684\u67b6\u6784\uff1a\u4e00\u4e3b\u591a\u4ece\u3002</p>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u5148\u804a\u804a\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u6b63\u786e\u6027\u3002\u7136\u540e\uff0c\u6211\u4eec\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u518d\u804a\u804a\u89e3\u51b3\u4e00\u4e3b\u591a\u4ece\u7684\u67e5\u8be2\u903b\u8f91\u6b63\u786e\u6027\u7684\u65b9\u6cd5\u3002</p>\n<p>\u5982\u56fe 1 \u6240\u793a\uff0c\u5c31\u662f\u4e00\u4e2a\u57fa\u672c\u7684\u4e00\u4e3b\u591a\u4ece\u7ed3\u6784\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/aadb3b956d1ffc13ac46515a7d619e79.png\" /></p>\n<p>\u56fe 1 \u4e00\u4e3b\u591a\u4ece\u57fa\u672c\u7ed3\u6784</p>\n<p>\u56fe\u4e2d\uff0c\u865a\u7ebf\u7bad\u5934\u8868\u793a\u7684\u662f\u4e3b\u5907\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f A \u548c A\u2019\u4e92\u4e3a\u4e3b\u5907\uff0c \u4ece\u5e93 B\u3001C\u3001D \u6307\u5411\u7684\u662f\u4e3b\u5e93 A\u3002\u4e00\u4e3b\u591a\u4ece\u7684\u8bbe\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u8bfb\u5199\u5206\u79bb\uff0c\u4e3b\u5e93\u8d1f\u8d23\u6240\u6709\u7684\u5199\u5165\u548c\u4e00\u90e8\u5206\u8bfb\uff0c\u5176\u4ed6\u7684\u8bfb\u8bf7\u6c42\u5219\u7531\u4ece\u5e93\u5206\u62c5\u3002</p>\n<p>\u4eca\u5929\u6211\u4eec\u8981\u8ba8\u8bba\u7684\u5c31\u662f\uff0c\u5728\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u4e0b\uff0c\u4e3b\u5e93\u6545\u969c\u540e\u7684\u4e3b\u5907\u5207\u6362\u95ee\u9898\u3002</p>\n<p>\u5982\u56fe 2 \u6240\u793a\uff0c\u5c31\u662f\u4e3b\u5e93\u53d1\u751f\u6545\u969c\uff0c\u4e3b\u5907\u5207\u6362\u540e\u7684\u7ed3\u679c\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/0014f97423bd75235a9187f492fb2453.png\" /></p>\n<p>\u56fe 2 \u4e00\u4e3b\u591a\u4ece\u57fa\u672c\u7ed3\u6784 -- \u4e3b\u5907\u5207\u6362</p>\n<p>\u76f8\u6bd4\u4e8e\u4e00\u4e3b\u4e00\u5907\u7684\u5207\u6362\u6d41\u7a0b\uff0c\u4e00\u4e3b\u591a\u4ece\u7ed3\u6784\u5728\u5207\u6362\u5b8c\u6210\u540e\uff0cA\u2019\u4f1a\u6210\u4e3a\u65b0\u7684\u4e3b\u5e93\uff0c\u4ece\u5e93 B\u3001C\u3001D \u4e5f\u8981\u6539\u63a5\u5230 A\u2019\u3002\u6b63\u662f\u7531\u4e8e\u591a\u4e86\u4ece\u5e93 B\u3001C\u3001D \u91cd\u65b0\u6307\u5411\u7684\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6240\u4ee5\u4e3b\u5907\u5207\u6362\u7684\u590d\u6742\u6027\u4e5f\u76f8\u5e94\u589e\u52a0\u4e86\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b\u4e00\u4e2a\u5207\u6362\u7cfb\u7edf\u4f1a\u600e\u4e48\u5b8c\u6210\u4e00\u4e3b\u591a\u4ece\u7684\u4e3b\u5907\u5207\u6362\u8fc7\u7a0b\u3002</p>\n<h3 id=\"_25\">\u57fa\u4e8e\u4f4d\u70b9\u7684\u4e3b\u5907\u5207\u6362<a class=\"headerlink\" href=\"#_25\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u9700\u8981\u5148\u6765\u56de\u987e\u4e00\u4e2a\u77e5\u8bc6\u70b9\u3002</p>\n<p>\u5f53\u6211\u4eec\u628a\u8282\u70b9 B \u8bbe\u7f6e\u6210\u8282\u70b9 A\u2019\u7684\u4ece\u5e93\u7684\u65f6\u5019\uff0c\u9700\u8981\u6267\u884c\u4e00\u6761 change master \u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">CHANGE</span><span class=\"w\"> </span><span class=\"n\">MASTER</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_HOST</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">host_name</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_PORT</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">port</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_USER</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">user_name</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_PASSWORD</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">password</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_LOG_FILE</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">master_log_name</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"n\">MASTER_LOG_POS</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">master_log_pos</span><span class=\"w\">  </span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u6709\u8fd9\u4e48 6 \u4e2a\u53c2\u6570\uff1a</p>\n<ul>\n<li><code>MASTER_HOST</code>\u3001<code>MASTER_PORT</code>\u3001<code>MASTER_USER</code> \u548c <code>MASTER_PASSWORD</code> \u56db\u4e2a\u53c2\u6570\uff0c\u5206\u522b\u4ee3\u8868\u4e86\u4e3b\u5e93 A\u2019\u7684 IP\u3001\u7aef\u53e3\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</li>\n<li>\u6700\u540e\u4e24\u4e2a\u53c2\u6570 <code>MASTER_LOG_FILE</code> \u548c <code>MASTER_LOG_POS</code> \u8868\u793a\uff0c\u8981\u4ece\u4e3b\u5e93\u7684 <code>master_log_name</code> \u6587\u4ef6\u7684 <code>master_log_pos</code> \u8fd9\u4e2a\u4f4d\u7f6e\u7684\u65e5\u5fd7\u7ee7\u7eed\u540c\u6b65\u3002\u800c\u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u540c\u6b65\u4f4d\u70b9\uff0c\u4e5f\u5c31\u662f\u4e3b\u5e93\u5bf9\u5e94\u7684\u6587\u4ef6\u540d\u548c\u65e5\u5fd7\u504f\u79fb\u91cf\u3002</li>\n</ul>\n<p>\u90a3\u4e48\uff0c\u8fd9\u91cc\u5c31\u6709\u4e00\u4e2a\u95ee\u9898\u4e86\uff0c\u8282\u70b9 B \u8981\u8bbe\u7f6e\u6210 A\u2019\u7684\u4ece\u5e93\uff0c\u5c31\u8981\u6267\u884c change master \u547d\u4ee4\uff0c\u5c31\u4e0d\u53ef\u907f\u514d\u5730\u8981\u8bbe\u7f6e\u4f4d\u70b9\u7684\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u4f46\u662f\u8fd9\u4e24\u4e2a\u53c2\u6570\u5230\u5e95\u5e94\u8be5\u600e\u4e48\u8bbe\u7f6e\u5462\uff1f</p>\n<p>\u539f\u6765\u8282\u70b9 B \u662f A \u7684\u4ece\u5e93\uff0c\u672c\u5730\u8bb0\u5f55\u7684\u4e5f\u662f A \u7684\u4f4d\u70b9\u3002\u4f46\u662f\u76f8\u540c\u7684\u65e5\u5fd7\uff0cA \u7684\u4f4d\u70b9\u548c A\u2019\u7684\u4f4d\u70b9\u662f\u4e0d\u540c\u7684\u3002\u56e0\u6b64\uff0c\u4ece\u5e93 B \u8981\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u5148\u7ecf\u8fc7\u201c\u627e\u540c\u6b65\u4f4d\u70b9\u201d\u8fd9\u4e2a\u903b\u8f91\u3002</p>\n<p>\u8fd9\u4e2a\u4f4d\u70b9\u5f88\u96be\u7cbe\u786e\u53d6\u5230\uff0c\u53ea\u80fd\u53d6\u4e00\u4e2a\u5927\u6982\u4f4d\u7f6e\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p>\n<p>\u6211\u6765\u548c\u4f60\u5206\u6790\u4e00\u4e0b\u770b\u770b\u8fd9\u4e2a\u4f4d\u70b9\u4e00\u822c\u662f\u600e\u4e48\u83b7\u53d6\u5230\u7684\uff0c\u4f60\u5c31\u6e05\u695a\u5176\u4e2d\u4e0d\u7cbe\u786e\u7684\u539f\u56e0\u4e86\u3002</p>\n<p>\u8003\u8651\u5230\u5207\u6362\u8fc7\u7a0b\u4e2d\u4e0d\u80fd\u4e22\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u627e\u4f4d\u70b9\u7684\u65f6\u5019\uff0c\u603b\u662f\u8981\u627e\u4e00\u4e2a\u201c\u7a0d\u5fae\u5f80\u524d\u201d\u7684\uff0c\u7136\u540e\u518d\u901a\u8fc7\u5224\u65ad\u8df3\u8fc7\u90a3\u4e9b\u5728\u4ece\u5e93 B \u4e0a\u5df2\u7ecf\u6267\u884c\u8fc7\u7684\u4e8b\u52a1\u3002</p>\n<p>\u4e00\u79cd\u53d6\u540c\u6b65\u4f4d\u70b9\u7684\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\n<p>\u7b49\u5f85\u65b0\u4e3b\u5e93 A\u2019\u628a\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u5168\u90e8\u540c\u6b65\u5b8c\u6210\uff1b</p>\n</li>\n<li>\n<p>\u5728 A\u2019\u4e0a\u6267\u884c <code>show master status</code> \u547d\u4ee4\uff0c\u5f97\u5230\u5f53\u524d A\u2019\u4e0a\u6700\u65b0\u7684 File \u548c Position\uff1b</p>\n</li>\n<li>\n<p>\u53d6\u539f\u4e3b\u5e93 A \u6545\u969c\u7684\u65f6\u523b T\uff1b</p>\n</li>\n<li>\n<p>\u7528 mysqlbinlog \u5de5\u5177\u89e3\u6790 A\u2019\u7684 File\uff0c\u5f97\u5230 T \u65f6\u523b\u7684\u4f4d\u70b9\u3002</p>\n<div class=\"highlight\"><pre><span></span><code>$<span class=\"w\"> </span>mysqlbinlog<span class=\"w\">  </span>binlog.000079<span class=\"w\"> </span>--start-datetime<span class=\"o\">=</span><span class=\"s1\">&#39;2023-02-01 16:41:36&#39;</span><span class=\"w\"> </span>--stop-datetime<span class=\"o\">=</span><span class=\"s1\">&#39;2023-02-01 16:41:36&#39;</span>\n\n/*!50530<span class=\"w\"> </span>SET<span class=\"w\"> </span>@@SESSION.PSEUDO_SLAVE_MODE<span class=\"o\">=</span><span class=\"m\">1</span>*/<span class=\"p\">;</span>\n/*!50003<span class=\"w\"> </span>SET<span class=\"w\"> </span>@OLD_COMPLETION_TYPE<span class=\"o\">=</span>@@COMPLETION_TYPE,COMPLETION_TYPE<span class=\"o\">=</span><span class=\"m\">0</span>*/<span class=\"p\">;</span>\nDELIMITER<span class=\"w\"> </span>/*!*/<span class=\"p\">;</span>\n<span class=\"c1\"># at 4</span>\n<span class=\"c1\">#230131 14:56:46 server id 1  end_log_pos 124 CRC32 0x76c363e1  Start: binlog v 4, server v 8.0.18 created 230131 14:56:46 at startup</span>\n</code></pre></div>\n</li>\n</ol>\n<p>\u56fe\u4e2d\uff0c<code>end_log_pos</code> \u540e\u9762\u7684\u503c 124\uff0c\u8868\u793a\u7684\u5c31\u662f A\u2019 \u8fd9\u4e2a\u5b9e\u4f8b\uff0c\u5728 T \u65f6\u523b\u5199\u5165\u65b0\u7684 binlog \u7684\u4f4d\u7f6e\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u628a 123 \u8fd9\u4e2a\u503c\u4f5c\u4e3a <code>$master_log_pos</code> \uff0c\u7528\u5728\u8282\u70b9 B \u7684 change master \u547d\u4ee4\u91cc\u3002</p>\n<p>\u5f53\u7136\u8fd9\u4e2a\u503c\u5e76\u4e0d\u7cbe\u786e\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u6709\u8fd9\u4e48\u4e00\u79cd\u60c5\u51b5\uff0c\u5047\u8bbe\u5728 T \u8fd9\u4e2a\u65f6\u523b\uff0c\u4e3b\u5e93 A \u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u4e86\u4e00\u4e2a insert \u8bed\u53e5\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e R\uff0c\u5e76\u4e14\u5df2\u7ecf\u5c06 binlog \u4f20\u7ed9\u4e86 A\u2019\u548c B\uff0c\u7136\u540e\u5728\u4f20\u5b8c\u7684\u77ac\u95f4\u4e3b\u5e93 A \u7684\u4e3b\u673a\u5c31\u6389\u7535\u4e86\u3002</p>\n<p>\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7cfb\u7edf\u7684\u72b6\u6001\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5728\u4ece\u5e93 B \u4e0a\uff0c\u7531\u4e8e\u540c\u6b65\u4e86 binlog\uff0c R \u8fd9\u4e00\u884c\u5df2\u7ecf\u5b58\u5728\uff1b</li>\n<li>\u5728\u65b0\u4e3b\u5e93 A\u2019\u4e0a\uff0c R \u8fd9\u4e00\u884c\u4e5f\u5df2\u7ecf\u5b58\u5728\uff0c\u65e5\u5fd7\u662f\u5199\u5728 123 \u8fd9\u4e2a\u4f4d\u7f6e\u4e4b\u540e\u7684\uff1b</li>\n<li>\u6211\u4eec\u5728\u4ece\u5e93 B \u4e0a\u6267\u884c change master \u547d\u4ee4\uff0c\u6307\u5411 A\u2019\u7684 File \u6587\u4ef6\u7684 123 \u4f4d\u7f6e\uff0c\u5c31\u4f1a\u628a\u63d2\u5165 R \u8fd9\u4e00\u884c\u6570\u636e\u7684 binlog \u53c8\u540c\u6b65\u5230\u4ece\u5e93 B \u53bb\u6267\u884c\u3002</li>\n</ol>\n<p>\u8fd9\u65f6\u5019\uff0c\u4ece\u5e93 B \u7684\u540c\u6b65\u7ebf\u7a0b\u5c31\u4f1a\u62a5\u544a <code>Duplicate entry \u2018id_of_R\u2019 for key \u2018PRIMARY\u2019</code> \u9519\u8bef\uff0c\u63d0\u793a\u51fa\u73b0\u4e86\u4e3b\u952e\u51b2\u7a81\uff0c\u7136\u540e\u505c\u6b62\u540c\u6b65\u3002</p>\n<p>\u6240\u4ee5\uff0c<strong>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5728\u5207\u6362\u4efb\u52a1\u7684\u65f6\u5019\uff0c\u8981\u5148\u4e3b\u52a8\u8df3\u8fc7\u8fd9\u4e9b\u9519\u8bef\uff0c\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u6cd5\u3002</strong></p>\n<p><strong>\u4e00\u79cd\u505a\u6cd5\u662f</strong>\uff0c\u4e3b\u52a8\u8df3\u8fc7\u4e00\u4e2a\u4e8b\u52a1\u3002\u8df3\u8fc7\u547d\u4ee4\u7684\u5199\u6cd5\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">global</span><span class=\"w\"> </span><span class=\"n\">sql_slave_skip_counter</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">start</span><span class=\"w\"> </span><span class=\"n\">slave</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u56e0\u4e3a\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u4f1a\u4e0d\u6b62\u91cd\u590d\u6267\u884c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728\u4ece\u5e93 B \u521a\u5f00\u59cb\u63a5\u5230\u65b0\u4e3b\u5e93 A\u2019\u65f6\uff0c\u6301\u7eed\u89c2\u5bdf\uff0c\u6bcf\u6b21\u78b0\u5230\u8fd9\u4e9b\u9519\u8bef\u5c31\u505c\u4e0b\u6765\uff0c\u6267\u884c\u4e00\u6b21\u8df3\u8fc7\u547d\u4ee4\uff0c\u76f4\u5230\u4e0d\u518d\u51fa\u73b0\u505c\u4e0b\u6765\u7684\u60c5\u51b5\uff0c\u4ee5\u6b64\u6765\u8df3\u8fc7\u53ef\u80fd\u6d89\u53ca\u7684\u6240\u6709\u4e8b\u52a1\u3002</p>\n<p>**\u53e6\u5916\u4e00\u79cd\u65b9\u5f0f\u662f\uff0c**\u901a\u8fc7\u8bbe\u7f6e <code>slave_skip_errors</code> \u53c2\u6570\uff0c\u76f4\u63a5\u8bbe\u7f6e\u8df3\u8fc7\u6307\u5b9a\u7684\u9519\u8bef\u3002</p>\n<p>\u5728\u6267\u884c\u4e3b\u5907\u5207\u6362\u65f6\uff0c\u6709\u8fd9\u4e48\u4e24\u7c7b\u9519\u8bef\uff0c\u662f\u7ecf\u5e38\u4f1a\u9047\u5230\u7684\uff1a</p>\n<ul>\n<li>1062 \u9519\u8bef\u662f\u63d2\u5165\u6570\u636e\u65f6\u552f\u4e00\u952e\u51b2\u7a81\uff1b</li>\n<li>1032 \u9519\u8bef\u662f\u5220\u9664\u6570\u636e\u65f6\u627e\u4e0d\u5230\u884c\u3002</li>\n</ul>\n<p>\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u628a <code>slave_skip_errors</code> \u8bbe\u7f6e\u4e3a <code>1032,1062</code>\uff0c\u8fd9\u6837\u4e2d\u95f4\u78b0\u5230\u8fd9\u4e24\u4e2a\u9519\u8bef\u65f6\u5c31\u76f4\u63a5\u8df3\u8fc7\u3002</p>\n<p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u79cd\u76f4\u63a5\u8df3\u8fc7\u6307\u5b9a\u9519\u8bef\u7684\u65b9\u6cd5\uff0c\u9488\u5bf9\u7684\u662f\u4e3b\u5907\u5207\u6362\u65f6\uff0c\u7531\u4e8e\u627e\u4e0d\u5230\u7cbe\u786e\u7684\u540c\u6b65\u4f4d\u70b9\uff0c\u6240\u4ee5\u53ea\u80fd\u91c7\u7528\u8fd9\u79cd\u65b9\u6cd5\u6765\u521b\u5efa\u4ece\u5e93\u548c\u65b0\u4e3b\u5e93\u7684\u4e3b\u5907\u5173\u7cfb\u3002</p>\n<p>\u8fd9\u4e2a\u80cc\u666f\u662f\uff0c\u6211\u4eec\u5f88\u6e05\u695a\u5728\u4e3b\u5907\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u76f4\u63a5\u8df3\u8fc7 1032 \u548c 1062 \u8fd9\u4e24\u7c7b\u9519\u8bef\u662f\u65e0\u635f\u7684\uff0c\u6240\u4ee5\u624d\u53ef\u4ee5\u8fd9\u4e48\u8bbe\u7f6e <code>slave_skip_errors</code> \u53c2\u6570\u3002\u7b49\u5230\u4e3b\u5907\u95f4\u7684\u540c\u6b65\u5173\u7cfb\u5efa\u7acb\u5b8c\u6210\uff0c\u5e76\u7a33\u5b9a\u6267\u884c\u4e00\u6bb5\u65f6\u95f4\u4e4b\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u628a\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a\u7a7a\uff0c\u4ee5\u514d\u4e4b\u540e\u771f\u7684\u51fa\u73b0\u4e86\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e5f\u8df3\u8fc7\u4e86\u3002</p>\n<h3 id=\"gtid\">GTID<a class=\"headerlink\" href=\"#gtid\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7 <code>sql_slave_skip_counter</code> \u8df3\u8fc7\u4e8b\u52a1\u548c\u901a\u8fc7 <code>slave_skip_errors</code> \u5ffd\u7565\u9519\u8bef\u7684\u65b9\u6cd5\uff0c\u867d\u7136\u90fd\u6700\u7ec8\u53ef\u4ee5\u5efa\u7acb\u4ece\u5e93 B \u548c\u65b0\u4e3b\u5e93 A\u2019\u7684\u4e3b\u5907\u5173\u7cfb\uff0c\u4f46\u8fd9\u4e24\u79cd\u64cd\u4f5c\u90fd\u5f88\u590d\u6742\uff0c\u800c\u4e14\u5bb9\u6613\u51fa\u9519\u3002\u6240\u4ee5\uff0cMySQL 5.6 \u7248\u672c\u5f15\u5165\u4e86 GTID\uff0c\u5f7b\u5e95\u89e3\u51b3\u4e86\u8fd9\u4e2a\u56f0\u96be\u3002</p>\n<p>\u90a3\u4e48\uff0cGTID \u5230\u5e95\u662f\u4ec0\u4e48\u610f\u601d\uff0c\u53c8\u662f\u5982\u4f55\u89e3\u51b3\u627e\u540c\u6b65\u4f4d\u70b9\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f\u73b0\u5728\uff0c\u6211\u5c31\u548c\u4f60\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u3002</p>\n<p>GTID \u7684\u5168\u79f0\u662f Global Transaction Identifier\uff0c\u4e5f\u5c31\u662f\u5168\u5c40\u4e8b\u52a1 ID\uff0c\u662f\u4e00\u4e2a\u4e8b\u52a1\u5728\u63d0\u4ea4\u7684\u65f6\u5019\u751f\u6210\u7684\uff0c\u662f\u8fd9\u4e2a\u4e8b\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u3002\u5b83\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff0c\u683c\u5f0f\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"na\">GTID</span><span class=\"o\">=</span><span class=\"s\">server_uuid:gno</span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff1a</p>\n<ul>\n<li><code>server_uuid</code> \u662f\u4e00\u4e2a\u5b9e\u4f8b\u7b2c\u4e00\u6b21\u542f\u52a8\u65f6\u81ea\u52a8\u751f\u6210\u7684\uff0c\u662f\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684\u503c\uff1b</li>\n<li>gno \u662f\u4e00\u4e2a\u6574\u6570\uff0c\u521d\u59cb\u503c\u662f 1\uff0c\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u7684\u65f6\u5019\u5206\u914d\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u5e76\u52a0 1\u3002</li>\n</ul>\n<p>\u8fd9\u91cc\u6211\u9700\u8981\u548c\u4f60\u8bf4\u660e\u4e00\u4e0b\uff0c\u5728 MySQL \u7684\u5b98\u65b9\u6587\u6863\u91cc\uff0cGTID \u683c\u5f0f\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"na\">GTID</span><span class=\"o\">=</span><span class=\"s\">source_id:transaction_id</span>\n</code></pre></div>\n<p>\u8fd9\u91cc\u7684 source_id \u5c31\u662f <code>server_uuid</code>\uff1b\u800c\u540e\u9762\u7684\u8fd9\u4e2a <code>transaction_id</code>\uff0c\u6211\u89c9\u5f97\u5bb9\u6613\u9020\u6210\u8bef\u5bfc\uff0c\u6240\u4ee5\u6211\u6539\u6210\u4e86 gno\u3002\u4e3a\u4ec0\u4e48\u8bf4\u4f7f\u7528 <code>transaction_id</code> \u5bb9\u6613\u9020\u6210\u8bef\u89e3\u5462\uff1f</p>\n<p>\u56e0\u4e3a\uff0c\u5728 MySQL \u91cc\u9762\u6211\u4eec\u8bf4 <code>transaction_id</code> \u5c31\u662f\u6307\u4e8b\u52a1 id\uff0c\u4e8b\u52a1 id \u662f\u5728\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u5206\u914d\u7684\uff0c\u5982\u679c\u8fd9\u4e2a\u4e8b\u52a1\u56de\u6eda\u4e86\uff0c\u4e8b\u52a1 id \u4e5f\u4f1a\u9012\u589e\uff0c\u800c gno \u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u624d\u4f1a\u5206\u914d\u3002</p>\n<p>\u4ece\u6548\u679c\u4e0a\u770b\uff0cGTID \u5f80\u5f80\u662f\u8fde\u7eed\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u7528 gno \u6765\u8868\u793a\u66f4\u5bb9\u6613\u7406\u89e3\u3002</p>\n<p>GTID \u6a21\u5f0f\u7684\u542f\u52a8\u4e5f\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u542f\u52a8\u4e00\u4e2a MySQL \u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u52a0\u4e0a\u53c2\u6570 <code>gtid_mode=on</code> \u548c <code>enforce_gtid_consistency=on</code> \u5c31\u53ef\u4ee5\u4e86\u3002</p>\n<p>\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u90fd\u4f1a\u8ddf\u4e00\u4e2a GTID \u4e00\u4e00\u5bf9\u5e94\u3002\u8fd9\u4e2a GTID \u6709\u4e24\u79cd\u751f\u6210\u65b9\u5f0f\uff0c\u800c\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\u53d6\u51b3\u4e8e session \u53d8\u91cf <code>gtid_next</code> \u7684\u503c\u3002</p>\n<ol>\n<li>\u5982\u679c <code>gtid_next=automatic</code>\uff0c\u4ee3\u8868\u4f7f\u7528\u9ed8\u8ba4\u503c\u3002\u8fd9\u65f6\uff0cMySQL \u5c31\u4f1a\u628a <code>server_uuid:gno</code> \u5206\u914d\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\u3002</li>\n<li>\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u5148\u8bb0\u5f55\u4e00\u884c <code>SET @@SESSION.GTID_NEXT=\u2018server_uuid:gno\u2019;</code> </li>\n<li>\n<p>\u628a\u8fd9\u4e2a GTID \u52a0\u5165\u672c\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u3002</p>\n</li>\n<li>\n<p>\u5982\u679c <code>gtid_next</code> \u662f\u4e00\u4e2a\u6307\u5b9a\u7684 GTID \u7684\u503c\uff0c\u6bd4\u5982\u901a\u8fc7 <code>set gtid_next='current_gtid'</code>\u6307\u5b9a\u4e3a <code>current_gtid</code>\uff0c\u90a3\u4e48\u5c31\u6709\u4e24\u79cd\u53ef\u80fd\uff1a </p>\n</li>\n<li>\u5982\u679c <code>current_gtid</code> \u5df2\u7ecf\u5b58\u5728\u4e8e\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u4e2d\uff0c\u63a5\u4e0b\u6765\u6267\u884c\u7684\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u76f4\u63a5\u88ab\u7cfb\u7edf\u5ffd\u7565\uff1b </li>\n<li>\u5982\u679c <code>current_gtid</code> \u6ca1\u6709\u5b58\u5728\u4e8e\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u4e2d\uff0c\u5c31\u5c06\u8fd9\u4e2a <code>current_gtid</code> \u5206\u914d\u7ed9\u63a5\u4e0b\u6765\u8981\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u4e5f\u5c31\u662f\u8bf4\u7cfb\u7edf\u4e0d\u9700\u8981\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\u751f\u6210\u65b0\u7684 GTID\uff0c\u56e0\u6b64 gno \u4e5f\u4e0d\u7528\u52a0 1\u3002</li>\n</ol>\n<p>\u6ce8\u610f\uff0c\u4e00\u4e2a <code>current_gtid</code> \u53ea\u80fd\u7ed9\u4e00\u4e2a\u4e8b\u52a1\u4f7f\u7528\u3002\u8fd9\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u5982\u679c\u8981\u6267\u884c\u4e0b\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5c31\u8981\u6267\u884c set \u547d\u4ee4\uff0c\u628a <code>gtid_next</code> \u8bbe\u7f6e\u6210\u53e6\u5916\u4e00\u4e2a gtid \u6216\u8005 automatic\u3002</p>\n<p>\u8fd9\u6837\uff0c\u6bcf\u4e2a MySQL \u5b9e\u4f8b\u90fd\u7ef4\u62a4\u4e86\u4e00\u4e2a GTID \u96c6\u5408\uff0c\u7528\u6765\u5bf9\u5e94\u201c\u8fd9\u4e2a\u5b9e\u4f8b\u6267\u884c\u8fc7\u7684\u6240\u6709\u4e8b\u52a1\u201d\u3002</p>\n<p>\u8fd9\u6837\u770b\u4e0a\u53bb\u4e0d\u592a\u5bb9\u6613\u7406\u89e3\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6765\u548c\u4f60\u8bf4\u660e GTID \u7684\u57fa\u672c\u7528\u6cd5\u3002</p>\n<p>\u6211\u4eec\u5728\u5b9e\u4f8b X \u4e2d\u521b\u5efa\u4e00\u4e2a\u8868 t\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"w\"> </span><span class=\"n\">events</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"s1\">&#39;binlog.000082&#39;</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"mi\">155</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Log_name</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Event_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Server_id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">End_log_pos</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                                                                                                                                      </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">155</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Gtid</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">232</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;faddd5d4-9259-11e9-8971-868e345923a2:1&#39;</span><span class=\"w\">                                                                         </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">232</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">358</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"cm\">/* generated by server */</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630565 */</span><span class=\"w\">                                                                     </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">358</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Gtid</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">437</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;faddd5d4-9259-11e9-8971-868e345923a2:2&#39;</span><span class=\"w\">                                                                         </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">437</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">633</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630566 */</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">633</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Gtid</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">712</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"k\">SESSION</span><span class=\"p\">.</span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;faddd5d4-9259-11e9-8971-868e345923a2:3&#39;</span><span class=\"w\">                                                                         </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">712</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">794</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">BEGIN</span><span class=\"w\">                                                                                                                                     </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">794</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">896</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\">                                                                                                     </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">896</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Xid</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"mi\">927</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">COMMIT</span><span class=\"w\"> </span><span class=\"cm\">/* xid=630567 */</span><span class=\"w\">                                                                                                                   </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span>\n<span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e8b\u52a1\u7684 BEGIN \u4e4b\u524d\u6709\u4e00\u6761 <code>SET @@SESSION.GTID_NEXT</code> \u547d\u4ee4\u3002\u8fd9\u65f6\uff0c\u5982\u679c\u5b9e\u4f8b  \u6709\u4ece\u5e93\uff0c\u90a3\u4e48\u5c06 CREATE TABLE \u548c insert \u8bed\u53e5\u7684 binlog \u540c\u6b65\u8fc7\u53bb\u6267\u884c\u7684\u8bdd\uff0c\u6267\u884c\u4e8b\u52a1\u4e4b\u524d\u5c31\u4f1a\u5148\u6267\u884c\u8fd9\u4e24\u4e2a SET \u547d\u4ee4\uff0c \u8fd9\u6837\u88ab\u52a0\u5165\u4ece\u5e93\u7684 GTID \u96c6\u5408\u7684\uff0c\u5c31\u662f\u56fe\u4e2d\u7684\u8fd9\u4e24\u4e2a GTID\u3002</p>\n<p>\u5047\u8bbe\uff0c\u73b0\u5728\u8fd9\u4e2a\u5b9e\u4f8b X \u662f\u53e6\u5916\u4e00\u4e2a\u5b9e\u4f8b Y \u7684\u4ece\u5e93\uff0c\u5e76\u4e14\u6b64\u65f6\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c\u4e86\u4e0b\u9762\u8fd9\u6761\u63d2\u5165\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5e76\u4e14\uff0c\u8fd9\u6761\u8bed\u53e5\u5728\u5b9e\u4f8b Y \u4e0a\u7684 GTID \u662f <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code></p>\n<p>\u90a3\u4e48\uff0c\u5b9e\u4f8b X \u4f5c\u4e3a Y \u7684\u4ece\u5e93\uff0c\u5c31\u8981\u540c\u6b65\u8fd9\u4e2a\u4e8b\u52a1\u8fc7\u6765\u6267\u884c\uff0c\u663e\u7136\u4f1a\u51fa\u73b0\u4e3b\u952e\u51b2\u7a81\uff0c\u5bfc\u81f4\u5b9e\u4f8b X \u7684\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5e94\u8be5\u600e\u4e48\u5904\u7406\u5462\uff1f</p>\n<p>\u5904\u7406\u65b9\u6cd5\u5c31\u662f\uff0c\u4f60\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">gtid_next</span><span class=\"o\">=</span><span class=\"s1\">&#39;aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">gtid_next</span><span class=\"o\">=</span><span class=\"n\">automatic</span><span class=\"p\">;</span>\n<span class=\"k\">start</span><span class=\"w\"> </span><span class=\"n\">slave</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff0c\u524d\u4e09\u6761\u8bed\u53e5\u7684\u4f5c\u7528\uff0c\u662f\u901a\u8fc7\u63d0\u4ea4\u4e00\u4e2a\u7a7a\u4e8b\u52a1\uff0c\u628a\u8fd9\u4e2a GTID \u52a0\u5230\u5b9e\u4f8b X \u7684 GTID \u96c6\u5408\u4e2d\u3002\u5982\u56fe 5 \u6240\u793a\uff0c\u5c31\u662f\u6267\u884c\u5b8c\u8fd9\u4e2a\u7a7a\u4e8b\u52a1\u4e4b\u540e\u7684 <code>show master status</code> \u7684\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">master</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">             </span><span class=\"n\">File</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">binlog</span><span class=\"p\">.</span><span class=\"mi\">000082</span>\n<span class=\"w\">         </span><span class=\"k\">Position</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">927</span>\n<span class=\"w\">     </span><span class=\"n\">Binlog_Do_DB</span><span class=\"p\">:</span>\n<span class=\"w\"> </span><span class=\"n\">Binlog_Ignore_DB</span><span class=\"p\">:</span>\n<span class=\"n\">Executed_Gtid_Set</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">faddd5d4</span><span class=\"o\">-</span><span class=\"mi\">9259</span><span class=\"o\">-</span><span class=\"mi\">11</span><span class=\"n\">e9</span><span class=\"o\">-</span><span class=\"mi\">8971</span><span class=\"o\">-</span><span class=\"mi\">868</span><span class=\"n\">e345923a2</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"n\">aaaaaaaa</span><span class=\"o\">-</span><span class=\"n\">cccc</span><span class=\"o\">-</span><span class=\"n\">dddd</span><span class=\"o\">-</span><span class=\"n\">eeee</span><span class=\"o\">-</span><span class=\"n\">ffffffffffff</span><span class=\"p\">:</span><span class=\"mi\">10</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\u5b9e\u4f8b X \u7684 <code>Executed_Gtid_set</code> \u91cc\u9762\uff0c\u5df2\u7ecf\u52a0\u5165\u4e86\u8fd9\u4e2a GTID\u3002</p>\n<p>\u8fd9\u6837\uff0c\u6211\u518d\u6267\u884c start slave \u547d\u4ee4\u8ba9\u540c\u6b65\u7ebf\u7a0b\u6267\u884c\u8d77\u6765\u7684\u65f6\u5019\uff0c\u867d\u7136\u5b9e\u4f8b X \u4e0a\u8fd8\u662f\u4f1a\u7ee7\u7eed\u6267\u884c\u5b9e\u4f8b Y \u4f20\u8fc7\u6765\u7684\u4e8b\u52a1\uff0c\u4f46\u662f\u7531\u4e8e <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code> \u5df2\u7ecf\u5b58\u5728\u4e8e\u5b9e\u4f8b X \u7684 GTID \u96c6\u5408\u4e2d\u4e86\uff0c\u6240\u4ee5\u5b9e\u4f8b X \u5c31\u4f1a\u76f4\u63a5\u8df3\u8fc7\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u518d\u51fa\u73b0\u4e3b\u952e\u51b2\u7a81\u7684\u9519\u8bef\u3002</p>\n<p>\u5728\u4e0a\u9762\u7684\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\u4e2d\uff0cstart slave \u547d\u4ee4\u4e4b\u524d\u8fd8\u6709\u4e00\u53e5 <code>set gtid_next=automatic</code>\u3002\u8fd9\u53e5\u8bdd\u7684\u4f5c\u7528\u662f\u201c\u6062\u590d GTID \u7684\u9ed8\u8ba4\u5206\u914d\u884c\u4e3a\u201d\uff0c\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u4e4b\u540e\u6709\u65b0\u7684\u4e8b\u52a1\u518d\u6267\u884c\uff0c\u5c31\u8fd8\u662f\u6309\u7167\u539f\u6765\u7684\u5206\u914d\u65b9\u5f0f\uff0c\u7ee7\u7eed\u5206\u914d gno=3\u3002</p>\n<h3 id=\"gtid_1\">\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u5207\u6362<a class=\"headerlink\" href=\"#gtid_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u5df2\u7ecf\u7406\u89e3 GTID \u7684\u6982\u5ff5\uff0c\u518d\u4e00\u8d77\u6765\u770b\u770b\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u590d\u5236\u7684\u7528\u6cd5\u3002</p>\n<p>\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u5907\u5e93 B \u8981\u8bbe\u7f6e\u4e3a\u65b0\u4e3b\u5e93 A\u2019\u7684\u4ece\u5e93\u7684\u8bed\u6cd5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">CHANGE</span><span class=\"w\"> </span><span class=\"n\">MASTER</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span>\n<span class=\"n\">MASTER_HOST</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">host_name</span><span class=\"w\"> </span>\n<span class=\"n\">MASTER_PORT</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">port</span><span class=\"w\"> </span>\n<span class=\"n\">MASTER_USER</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">user_name</span><span class=\"w\"> </span>\n<span class=\"n\">MASTER_PASSWORD</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"n\">password</span><span class=\"w\"> </span>\n<span class=\"n\">master_auto_position</span><span class=\"o\">=</span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff0c<code>master_auto_position=1</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u4e3b\u5907\u5173\u7cfb\u4f7f\u7528\u7684\u662f GTID \u534f\u8bae\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u524d\u9762\u8ba9\u6211\u4eec\u5934\u75bc\u4e0d\u5df2\u7684 <code>MASTER_LOG_FILE</code> \u548c <code>MASTER_LOG_POS</code> \u53c2\u6570\uff0c\u5df2\u7ecf\u4e0d\u9700\u8981\u6307\u5b9a\u4e86\u3002</p>\n<p>\u6211\u4eec\u628a\u73b0\u5728\u8fd9\u4e2a\u65f6\u523b\uff0c\u5b9e\u4f8b A\u2019\u7684 GTID \u96c6\u5408\u8bb0\u4e3a <code>set_a</code>\uff0c\u5b9e\u4f8b B \u7684 GTID \u96c6\u5408\u8bb0\u4e3a <code>set_b</code>\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u73b0\u5728\u7684\u4e3b\u5907\u5207\u6362\u903b\u8f91\u3002</p>\n<p>\u6211\u4eec\u5728\u5b9e\u4f8b B \u4e0a\u6267\u884c start slave \u547d\u4ee4\uff0c\u53d6 binlog \u7684\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u5b9e\u4f8b B \u6307\u5b9a\u4e3b\u5e93 A\u2019\uff0c\u57fa\u4e8e\u4e3b\u5907\u534f\u8bae\u5efa\u7acb\u8fde\u63a5\u3002</li>\n<li>\u5b9e\u4f8b B \u628a <code>set_b</code> \u53d1\u7ed9\u4e3b\u5e93 A\u2019\u3002</li>\n<li>\u5b9e\u4f8b A\u2019\u7b97\u51fa <code>set_a</code> \u4e0e <code>set_b</code> \u7684\u5dee\u96c6\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u5b58\u5728\u4e8e <code>set_a</code>\uff0c\u4f46\u662f\u4e0d\u5b58\u5728\u4e8e <code>set_b</code> \u7684 GITD \u7684\u96c6\u5408\uff0c\u5224\u65ad A\u2019 \u672c\u5730\u662f\u5426\u5305\u542b\u4e86\u8fd9\u4e2a\u5dee\u96c6\u9700\u8981\u7684\u6240\u6709 binlog \u4e8b\u52a1\u3002 </li>\n<li>\u5982\u679c\u4e0d\u5305\u542b\uff0c\u8868\u793a A\u2019 \u5df2\u7ecf\u628a\u5b9e\u4f8b B \u9700\u8981\u7684 binlog \u7ed9\u5220\u6389\u4e86\uff0c\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\uff1b</li>\n<li>\n<p>\u5982\u679c\u786e\u8ba4\u5168\u90e8\u5305\u542b\uff0cA\u2019 \u4ece\u81ea\u5df1\u7684 binlog \u6587\u4ef6\u91cc\u9762\uff0c\u627e\u51fa\u7b2c\u4e00\u4e2a\u4e0d\u5728 <code>set_b</code> \u7684\u4e8b\u52a1\uff0c\u53d1\u7ed9 B\uff1b</p>\n</li>\n<li>\n<p>\u4e4b\u540e\u5c31\u4ece\u8fd9\u4e2a\u4e8b\u52a1\u5f00\u59cb\uff0c\u5f80\u540e\u8bfb\u6587\u4ef6\uff0c\u6309\u987a\u5e8f\u53d6 binlog \u53d1\u7ed9 B \u53bb\u6267\u884c\u3002</p>\n</li>\n</ol>\n<p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u903b\u8f91\u91cc\u9762\u5305\u542b\u4e86\u4e00\u4e2a\u8bbe\u8ba1\u601d\u60f3\uff1a\u5728\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u5173\u7cfb\u91cc\uff0c\u7cfb\u7edf\u8ba4\u4e3a\u53ea\u8981\u5efa\u7acb\u4e3b\u5907\u5173\u7cfb\uff0c\u5c31\u5fc5\u987b\u4fdd\u8bc1\u4e3b\u5e93\u53d1\u7ed9\u5907\u5e93\u7684\u65e5\u5fd7\u662f\u5b8c\u6574\u7684\u3002\u56e0\u6b64\uff0c\u5982\u679c\u5b9e\u4f8b B \u9700\u8981\u7684\u65e5\u5fd7\u5df2\u7ecf\u4e0d\u5b58\u5728\uff0cA\u2019 \u5c31\u62d2\u7edd\u628a\u65e5\u5fd7\u53d1\u7ed9 B\u3002</p>\n<p>\u8fd9\u8ddf\u57fa\u4e8e\u4f4d\u70b9\u7684\u4e3b\u5907\u534f\u8bae\u4e0d\u540c\u3002\u57fa\u4e8e\u4f4d\u70b9\u7684\u534f\u8bae\uff0c\u662f\u7531\u5907\u5e93\u51b3\u5b9a\u7684\uff0c\u5907\u5e93\u6307\u5b9a\u54ea\u4e2a\u4f4d\u70b9\uff0c\u4e3b\u5e93\u5c31\u53d1\u54ea\u4e2a\u4f4d\u70b9\uff0c\u4e0d\u505a\u65e5\u5fd7\u7684\u5b8c\u6574\u6027\u5224\u65ad\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u5f15\u5165 GTID \u540e\uff0c\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u573a\u666f\u4e0b\uff0c\u4e3b\u5907\u5207\u6362\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002</p>\n<p>\u7531\u4e8e\u4e0d\u9700\u8981\u627e\u4f4d\u70b9\u4e86\uff0c\u6240\u4ee5\u4ece\u5e93 B\u3001C\u3001D \u53ea\u9700\u8981\u5206\u522b\u6267\u884c change master \u547d\u4ee4\u6307\u5411\u5b9e\u4f8b A\u2019 \u5373\u53ef\u3002</p>\n<p>\u5176\u5b9e\uff0c\u4e25\u8c28\u5730\u8bf4\uff0c\u4e3b\u5907\u5207\u6362\u4e0d\u662f\u4e0d\u9700\u8981\u627e\u4f4d\u70b9\u4e86\uff0c\u800c\u662f\u627e\u4f4d\u70b9\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u5728\u5b9e\u4f8b A\u2019 \u5185\u90e8\u5c31\u5df2\u7ecf\u81ea\u52a8\u5b8c\u6210\u4e86\u3002\u4f46\u7531\u4e8e\u8fd9\u4e2a\u5de5\u4f5c\u662f\u81ea\u52a8\u7684\uff0c\u6240\u4ee5\u5bf9 HA \u7cfb\u7edf\u7684\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\uff0c\u975e\u5e38\u53cb\u597d\u3002</p>\n<p>\u4e4b\u540e\u8fd9\u4e2a\u7cfb\u7edf\u5c31\u7531\u65b0\u4e3b\u5e93 A\u2019 \u5199\u5165\uff0c\u4e3b\u5e93 A\u2019 \u7684\u81ea\u5df1\u751f\u6210\u7684 binlog \u4e2d\u7684 GTID \u96c6\u5408\u683c\u5f0f\u662f\uff1a<code>server_uuid_of_A\u2019:1-M</code>\u3002</p>\n<p>\u5982\u679c\u4e4b\u524d\u4ece\u5e93 B \u7684 GTID \u96c6\u5408\u683c\u5f0f\u662f <code>server_uuid_of_A:1-N</code>\uff0c \u90a3\u4e48\u5207\u6362\u4e4b\u540e GTID \u96c6\u5408\u7684\u683c\u5f0f\u5c31\u53d8\u6210\u4e86 <code>server_uuid_of_A:1-N, server_uuid_of_A\u2019:1-M</code>\u3002</p>\n<p>\u5f53\u7136\uff0c\u4e3b\u5e93 A\u2019 \u4e4b\u524d\u4e5f\u662f A \u7684\u5907\u5e93\uff0c\u56e0\u6b64\u4e3b\u5e93 A\u2019 \u548c\u4ece\u5e93 B \u7684 GTID \u96c6\u5408\u662f\u4e00\u6837\u7684\u3002\u8fd9\u5c31\u8fbe\u5230\u4e86\u6211\u4eec\u9884\u671f\u3002</p>\n<h3 id=\"gtid-ddl\">GTID \u548c\u5728\u7ebf DDL<a class=\"headerlink\" href=\"#gtid-ddl\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u518d\u4e3e\u4e2a\u4f8b\u5b50\u5e2e\u4f60\u7406\u89e3 GTID\u3002</p>\n<p>\u4e4b\u524d\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u63d0\u5230\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u6162\u67e5\u8be2\u6027\u80fd\u95ee\u9898\u65f6\uff0c\u5206\u6790\u5230\u5982\u679c\u662f\u7531\u4e8e\u7d22\u5f15\u7f3a\u5931\u5f15\u8d77\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u7ebf\u52a0\u7d22\u5f15\u6765\u89e3\u51b3\u3002\u4f46\u662f\uff0c\u8003\u8651\u5230\u8981\u907f\u514d\u65b0\u589e\u7d22\u5f15\u5bf9\u4e3b\u5e93\u6027\u80fd\u9020\u6210\u7684\u5f71\u54cd\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5728\u5907\u5e93\u52a0\u7d22\u5f15\uff0c\u7136\u540e\u518d\u5207\u6362\u3002</p>\n<p>\u5f53\u65f6\u6211\u8bf4\uff0c\u5728\u53cc M \u7ed3\u6784\u4e0b\uff0c\u5907\u5e93\u6267\u884c\u7684 DDL \u8bed\u53e5\u4e5f\u4f1a\u4f20\u7ed9\u4e3b\u5e93\uff0c\u4e3a\u4e86\u907f\u514d\u4f20\u56de\u540e\u5bf9\u4e3b\u5e93\u9020\u6210\u5f71\u54cd\uff0c\u8981\u901a\u8fc7 <code>set sql_log_bin=off</code> \u5173\u6389 binlog\u3002</p>\n<p>\u8bc4\u8bba\u533a\u6709\u4f4d\u540c\u5b66\u63d0\u51fa\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u8fd9\u6837\u64cd\u4f5c\u7684\u8bdd\uff0c\u6570\u636e\u5e93\u91cc\u9762\u662f\u52a0\u4e86\u7d22\u5f15\uff0c\u4f46\u662f binlog \u5e76\u6ca1\u6709\u8bb0\u5f55\u4e0b\u8fd9\u4e00\u4e2a\u66f4\u65b0\uff0c\u662f\u4e0d\u662f\u4f1a\u5bfc\u81f4\u6570\u636e\u548c\u65e5\u5fd7\u4e0d\u4e00\u81f4\uff1f</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u63d0\u5f97\u975e\u5e38\u597d\u3002\u5f53\u65f6\uff0c\u6211\u5728\u7559\u8a00\u7684\u56de\u590d\u4e2d\u5c31\u5f15\u7528\u4e86 GTID \u6765\u8bf4\u660e\u3002\u4eca\u5929\uff0c\u6211\u518d\u548c\u4f60\u5c55\u5f00\u8bf4\u660e\u4e00\u4e0b\u3002</p>\n<p>\u5047\u8bbe\uff0c\u8fd9\u4e24\u4e2a\u4e92\u4e3a\u4e3b\u5907\u5173\u7cfb\u7684\u5e93\u8fd8\u662f\u5b9e\u4f8b X \u548c\u5b9e\u4f8b Y\uff0c\u4e14\u5f53\u524d\u4e3b\u5e93\u662f X\uff0c\u5e76\u4e14\u90fd\u6253\u5f00\u4e86 GTID \u6a21\u5f0f\u3002\u8fd9\u65f6\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u53ef\u4ee5\u53d8\u6210\u4e0b\u9762\u8fd9\u6837\uff1a</p>\n<ul>\n<li>\n<p>\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c <code>stop slave</code>\u3002</p>\n</li>\n<li>\n<p>\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c DDL \u8bed\u53e5\u3002\u6ce8\u610f\uff0c\u8fd9\u91cc\u5e76\u4e0d\u9700\u8981\u5173\u95ed binlog\u3002</p>\n</li>\n<li>\n<p>\u6267\u884c\u5b8c\u6210\u540e\uff0c\u67e5\u51fa\u8fd9\u4e2a DDL \u8bed\u53e5\u5bf9\u5e94\u7684 GTID\uff0c\u5e76\u8bb0\u4e3a <code>server_uuid_of_Y:gno</code>\u3002</p>\n</li>\n<li>\n<p>\u5230\u5b9e\u4f8b X \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bed\u53e5\u5e8f\u5217\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">GTID_NEXT</span><span class=\"o\">=</span><span class=\"ss\">&quot;server_uuid_of_Y:gno&quot;</span><span class=\"p\">;</span>\n<span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n<span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">gtid_next</span><span class=\"o\">=</span><span class=\"n\">automatic</span><span class=\"p\">;</span>\n<span class=\"k\">start</span><span class=\"w\"> </span><span class=\"n\">slave</span><span class=\"p\">;</span>\n</code></pre></div>\n</li>\n</ul>\n<p>\u200b       \u8fd9\u6837\u505a\u7684\u76ee\u7684\u5728\u4e8e\uff0c\u65e2\u53ef\u4ee5\u8ba9\u5b9e\u4f8b Y \u7684\u66f4\u65b0\u6709 binlog \u8bb0\u5f55\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u786e\u4fdd\u4e0d\u4f1a\u5728\u5b9e\u4f8b X \u4e0a\u6267\u884c\u8fd9\u6761\u66f4\u65b0\u3002</p>\n<ul>\n<li>\u63a5\u4e0b\u6765\uff0c\u6267\u884c\u5b8c\u4e3b\u5907\u5207\u6362\uff0c\u7136\u540e\u7167\u7740\u4e0a\u8ff0\u6d41\u7a0b\u518d\u6267\u884c\u4e00\u904d\u5373\u53ef\u3002</li>\n</ul>\n<h3 id=\"_26\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_26\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u4ece\u5e93\u627e\u65b0\u4e3b\u5e93\u7684\u4f4d\u70b9\u662f\u4e00\u4e2a\u75db\u70b9\u3002\u7531\u6b64\uff0c\u6211\u4eec\u5f15\u51fa\u4e86 MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684 GTID \u6a21\u5f0f\uff0c\u4ecb\u7ecd\u4e86 GTID \u7684\u57fa\u672c\u6982\u5ff5\u548c\u7528\u6cd5\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u4e00\u4e3b\u591a\u4ece\u5207\u6362\u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u7684 MySQL \u7248\u672c\u652f\u6301 GTID \u7684\u8bdd\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u5c3d\u91cf\u4f7f\u7528 GTID \u6a21\u5f0f\u6765\u505a\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u3002</p>\n<p>\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u8fd8\u80fd\u770b\u5230 GTID \u6a21\u5f0f\u5728\u8bfb\u5199\u5206\u79bb\u573a\u666f\u7684\u5e94\u7528\u3002</p>\n<p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u6211\u4eec\u7684\u601d\u8003\u9898\u65f6\u95f4\u3002</p>\n<p>\u4f60\u5728 GTID \u6a21\u5f0f\u4e0b\u8bbe\u7f6e\u4e3b\u4ece\u5173\u7cfb\u7684\u65f6\u5019\uff0c\u4ece\u5e93\u6267\u884c start slave \u547d\u4ee4\u540e\uff0c\u4e3b\u5e93\u53d1\u73b0\u9700\u8981\u7684 binlog \u5df2\u7ecf\u88ab\u5220\u9664\u6389\u4e86\uff0c\u5bfc\u81f4\u4e3b\u5907\u521b\u5efa\u4e0d\u6210\u529f\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u89c9\u5f97\u53ef\u4ee5\u600e\u4e48\u5904\u7406\u5462\uff1f</p>\n<p>\u53c2\u8003\u5904\u7406\u65b9\u6848\uff1a</p>\n<ol>\n<li>\u5982\u679c\u4e1a\u52a1\u5141\u8bb8\u4e3b\u4ece\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728\u4e3b\u5e93\u4e0a\u5148\u6267\u884c <code>show global variables like 'gtid_purged'</code>\uff0c\u5f97\u5230\u4e3b\u5e93\u5df2\u7ecf\u5220\u9664\u7684 GTID \u96c6\u5408\uff0c\u5047\u8bbe\u662f <code>gtid_purged1</code>\uff1b\u7136\u540e\u5148\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>reset master</code>\uff0c\u518d\u6267\u884c <code>set global gtid_purged ='gtid_purged1'</code>\uff1b\u6700\u540e\u6267\u884c <code>start slave</code>\uff0c\u5c31\u4f1a\u4ece\u4e3b\u5e93\u73b0\u5b58\u7684 binlog \u5f00\u59cb\u540c\u6b65\u3002binlog \u7f3a\u5931\u7684\u90a3\u4e00\u90e8\u5206\uff0c\u6570\u636e\u5728\u4ece\u5e93\u4e0a\u5c31\u53ef\u80fd\u4f1a\u6709\u4e22\u5931\uff0c\u9020\u6210\u4e3b\u4ece\u4e0d\u4e00\u81f4\u3002</li>\n<li>\u5982\u679c\u9700\u8981\u4e3b\u4ece\u6570\u636e\u4e00\u81f4\u7684\u8bdd\uff0c\u6700\u597d\u8fd8\u662f\u901a\u8fc7\u91cd\u65b0\u642d\u5efa\u4ece\u5e93\u6765\u505a\u3002</li>\n<li>\u5982\u679c\u6709\u5176\u4ed6\u7684\u4ece\u5e93\u4fdd\u7559\u6709\u5168\u91cf\u7684 binlog \u7684\u8bdd\uff0c\u53ef\u4ee5\u628a\u65b0\u7684\u4ece\u5e93\u5148\u63a5\u5230\u8fd9\u4e2a\u4fdd\u7559\u4e86\u5168\u91cf binlog \u7684\u4ece\u5e93\uff0c\u8ffd\u4e0a\u65e5\u5fd7\u4ee5\u540e\uff0c\u5982\u679c\u6709\u9700\u8981\uff0c\u518d\u63a5\u56de\u4e3b\u5e93\u3002</li>\n<li>\u5982\u679c binlog \u6709\u5907\u4efd\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5148\u5728\u4ece\u5e93\u4e0a\u5e94\u7528\u7f3a\u5931\u7684 binlog\uff0c\u7136\u540e\u518d\u6267\u884c start slave\u3002</li>\n</ol>\n<h2 id=\"28\">28 \u8bfb\u5199\u5206\u79bb\u6709\u54ea\u4e9b\u5751\uff1f<a class=\"headerlink\" href=\"#28\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u7684\u7ed3\u6784\u4ee5\u53ca\u5207\u6362\u6d41\u7a0b\u3002\u4eca\u5929\u6211\u4eec\u5c31\u7ee7\u7eed\u804a\u804a\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u7684\u5e94\u7528\u573a\u666f\uff1a\u8bfb\u5199\u5206\u79bb\uff0c\u4ee5\u53ca\u600e\u4e48\u5904\u7406\u4e3b\u5907\u5ef6\u8fdf\u5bfc\u81f4\u7684\u8bfb\u5199\u5206\u79bb\u95ee\u9898\u3002</p>\n<p>\u6211\u4eec\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u4e00\u4e3b\u591a\u4ece\u7684\u7ed3\u6784\uff0c\u5176\u5b9e\u5c31\u662f\u8bfb\u5199\u5206\u79bb\u7684\u57fa\u672c\u7ed3\u6784\u4e86\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u628a\u8fd9\u5f20\u56fe\u8d34\u8fc7\u6765\uff0c\u65b9\u4fbf\u4f60\u7406\u89e3\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/1334b9c08b8fd837832fdb2d82e6b0aa.png\" /></p>\n<p>\u56fe 1 \u8bfb\u5199\u5206\u79bb\u57fa\u672c\u7ed3\u6784</p>\n<p>\u8bfb\u5199\u5206\u79bb\u7684\u4e3b\u8981\u76ee\u6807\u5c31\u662f\u5206\u644a\u4e3b\u5e93\u7684\u538b\u529b\u3002\u56fe 1 \u4e2d\u7684\u7ed3\u6784\u662f\u5ba2\u6237\u7aef\uff08client\uff09\u4e3b\u52a8\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u8fd9\u79cd\u6a21\u5f0f\u4e0b\u4e00\u822c\u4f1a\u628a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u4fe1\u606f\u653e\u5728\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u5c42\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7531\u5ba2\u6237\u7aef\u6765\u9009\u62e9\u540e\u7aef\u6570\u636e\u5e93\u8fdb\u884c\u67e5\u8be2\u3002</p>\n<p>\u8fd8\u6709\u4e00\u79cd\u67b6\u6784\u662f\uff0c\u5728 MySQL \u548c\u5ba2\u6237\u7aef\u4e4b\u95f4\u6709\u4e00\u4e2a\u4e2d\u95f4\u4ee3\u7406\u5c42 proxy\uff0c\u5ba2\u6237\u7aef\u53ea\u8fde\u63a5 proxy\uff0c \u7531 proxy \u6839\u636e\u8bf7\u6c42\u7c7b\u578b\u548c\u4e0a\u4e0b\u6587\u51b3\u5b9a\u8bf7\u6c42\u7684\u5206\u53d1\u8def\u7531\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/065ef246c59019effc8384967d774318.png\" /></p>\n<p>\u56fe 2 \u5e26 proxy \u7684\u8bfb\u5199\u5206\u79bb\u67b6\u6784</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u4e00\u4e0b\u5ba2\u6237\u7aef\u76f4\u8fde\u548c\u5e26 proxy \u7684\u8bfb\u5199\u5206\u79bb\u67b6\u6784\uff0c\u5404\u6709\u54ea\u4e9b\u7279\u70b9\u3002</p>\n<ol>\n<li>\u5ba2\u6237\u7aef\u76f4\u8fde\u65b9\u6848\uff0c\u56e0\u4e3a\u5c11\u4e86\u4e00\u5c42 proxy \u8f6c\u53d1\uff0c\u6240\u4ee5\u67e5\u8be2\u6027\u80fd\u7a0d\u5fae\u597d\u4e00\u70b9\u513f\uff0c\u5e76\u4e14\u6574\u4f53\u67b6\u6784\u7b80\u5355\uff0c\u6392\u67e5\u95ee\u9898\u66f4\u65b9\u4fbf\u3002\u4f46\u662f\u8fd9\u79cd\u65b9\u6848\uff0c\u7531\u4e8e\u8981\u4e86\u89e3\u540e\u7aef\u90e8\u7f72\u7ec6\u8282\uff0c\u6240\u4ee5\u5728\u51fa\u73b0\u4e3b\u5907\u5207\u6362\u3001\u5e93\u8fc1\u79fb\u7b49\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u5ba2\u6237\u7aef\u90fd\u4f1a\u611f\u77e5\u5230\uff0c\u5e76\u4e14\u9700\u8981\u8c03\u6574\u6570\u636e\u5e93\u8fde\u63a5\u4fe1\u606f\u3002 \u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u8fd9\u6837\u5ba2\u6237\u7aef\u4e5f\u592a\u9ebb\u70e6\u4e86\uff0c\u4fe1\u606f\u5927\u91cf\u5197\u4f59\uff0c\u67b6\u6784\u5f88\u4e11\u3002\u5176\u5b9e\u4e5f\u672a\u5fc5\uff0c\u4e00\u822c\u91c7\u7528\u8fd9\u6837\u7684\u67b6\u6784\uff0c\u4e00\u5b9a\u4f1a\u4f34\u968f\u4e00\u4e2a\u8d1f\u8d23\u7ba1\u7406\u540e\u7aef\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982 Zookeeper\uff0c\u5c3d\u91cf\u8ba9\u4e1a\u52a1\u7aef\u53ea\u4e13\u6ce8\u4e8e\u4e1a\u52a1\u903b\u8f91\u5f00\u53d1\u3002</li>\n<li>\u5e26 proxy \u7684\u67b6\u6784\uff0c\u5bf9\u5ba2\u6237\u7aef\u6bd4\u8f83\u53cb\u597d\u3002\u5ba2\u6237\u7aef\u4e0d\u9700\u8981\u5173\u6ce8\u540e\u7aef\u7ec6\u8282\uff0c\u8fde\u63a5\u7ef4\u62a4\u3001\u540e\u7aef\u4fe1\u606f\u7ef4\u62a4\u7b49\u5de5\u4f5c\uff0c\u90fd\u662f\u7531 proxy \u5b8c\u6210\u7684\u3002\u4f46\u8fd9\u6837\u7684\u8bdd\uff0c\u5bf9\u540e\u7aef\u7ef4\u62a4\u56e2\u961f\u7684\u8981\u6c42\u4f1a\u66f4\u9ad8\u3002\u800c\u4e14\uff0cproxy \u4e5f\u9700\u8981\u6709\u9ad8\u53ef\u7528\u67b6\u6784\u3002\u56e0\u6b64\uff0c\u5e26 proxy \u67b6\u6784\u7684\u6574\u4f53\u5c31\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\u3002</li>\n</ol>\n<p>\u7406\u89e3\u4e86\u8fd9\u4e24\u79cd\u65b9\u6848\u7684\u4f18\u52a3\uff0c\u5177\u4f53\u9009\u62e9\u54ea\u4e2a\u65b9\u6848\u5c31\u53d6\u51b3\u4e8e\u6570\u636e\u5e93\u56e2\u961f\u63d0\u4f9b\u7684\u80fd\u529b\u4e86\u3002\u4f46\u76ee\u524d\u770b\uff0c\u8d8b\u52bf\u662f\u5f80\u5e26 proxy \u7684\u67b6\u6784\u65b9\u5411\u53d1\u5c55\u7684\u3002</p>\n<p>\u4f46\u662f\uff0c\u4e0d\u8bba\u4f7f\u7528\u54ea\u79cd\u67b6\u6784\uff0c\u4f60\u90fd\u4f1a\u78b0\u5230\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\uff1a\u7531\u4e8e\u4e3b\u4ece\u53ef\u80fd\u5b58\u5728\u5ef6\u8fdf\uff0c\u5ba2\u6237\u7aef\u6267\u884c\u5b8c\u4e00\u4e2a\u66f4\u65b0\u4e8b\u52a1\u540e\u9a6c\u4e0a\u53d1\u8d77\u67e5\u8be2\uff0c\u5982\u679c\u67e5\u8be2\u9009\u62e9\u7684\u662f\u4ece\u5e93\u7684\u8bdd\uff0c\u5c31\u6709\u53ef\u80fd\u8bfb\u5230\u521a\u521a\u7684\u4e8b\u52a1\u66f4\u65b0\u4e4b\u524d\u7684\u72b6\u6001\u3002</p>\n<p><strong>\u8fd9\u79cd\u201c\u5728\u4ece\u5e93\u4e0a\u4f1a\u8bfb\u5230\u7cfb\u7edf\u7684\u4e00\u4e2a\u8fc7\u671f\u72b6\u6001\u201d\u7684\u73b0\u8c61\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u91cc\uff0c\u6211\u4eec\u6682\u4e14\u79f0\u4e4b\u4e3a\u201c\u8fc7\u671f\u8bfb\u201d\u3002</strong></p>\n<p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u4e86\u51e0\u79cd\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u539f\u56e0\uff0c\u4ee5\u53ca\u5bf9\u5e94\u7684\u4f18\u5316\u7b56\u7565\uff0c\u4f46\u662f\u4e3b\u4ece\u5ef6\u8fdf\u8fd8\u662f\u4e0d\u80fd 100% \u907f\u514d\u7684\u3002</p>\n<p>\u4e0d\u8bba\u54ea\u79cd\u7ed3\u6784\uff0c\u5ba2\u6237\u7aef\u90fd\u5e0c\u671b\u67e5\u8be2\u4ece\u5e93\u7684\u6570\u636e\u7ed3\u679c\uff0c\u8ddf\u67e5\u4e3b\u5e93\u7684\u6570\u636e\u7ed3\u679c\u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u6765\u8ba8\u8bba\u600e\u4e48\u5904\u7406\u8fc7\u671f\u8bfb\u95ee\u9898\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u5148\u628a\u6587\u7ae0\u4e2d\u6d89\u53ca\u5230\u7684\u5904\u7406\u8fc7\u671f\u8bfb\u7684\u65b9\u6848\u6c47\u603b\u5728\u8fd9\u91cc\uff0c\u4ee5\u5e2e\u52a9\u4f60\u66f4\u597d\u5730\u7406\u89e3\u548c\u638c\u63e1\u5168\u6587\u7684\u77e5\u8bc6\u8109\u7edc\u3002\u8fd9\u4e9b\u65b9\u6848\u5305\u62ec\uff1a</p>\n<ul>\n<li>\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848\uff1b</li>\n<li>sleep \u65b9\u6848\uff1b</li>\n<li>\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u65b9\u6848\uff1b</li>\n<li>\u914d\u5408 semi-sync \u65b9\u6848\uff1b</li>\n<li>\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff1b</li>\n<li>\u7b49 GTID \u65b9\u6848\u3002</li>\n</ul>\n<h3 id=\"_27\">\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848<a class=\"headerlink\" href=\"#_27\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848\u5176\u5b9e\u5c31\u662f\uff0c\u5c06\u67e5\u8be2\u8bf7\u6c42\u505a\u5206\u7c7b\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u67e5\u8be2\u8bf7\u6c42\u5206\u4e3a\u8fd9\u4e48\u4e24\u7c7b\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e\u5fc5\u987b\u8981\u62ff\u5230\u6700\u65b0\u7ed3\u679c\u7684\u8bf7\u6c42\uff0c\u5f3a\u5236\u5c06\u5176\u53d1\u5230\u4e3b\u5e93\u4e0a\u3002\u6bd4\u5982\uff0c\u5728\u4e00\u4e2a\u4ea4\u6613\u5e73\u53f0\u4e0a\uff0c\u5356\u5bb6\u53d1\u5e03\u5546\u54c1\u4ee5\u540e\uff0c\u9a6c\u4e0a\u8981\u8fd4\u56de\u4e3b\u9875\u9762\uff0c\u770b\u5546\u54c1\u662f\u5426\u53d1\u5e03\u6210\u529f\u3002\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bf7\u6c42\u9700\u8981\u62ff\u5230\u6700\u65b0\u7684\u7ed3\u679c\uff0c\u5c31\u5fc5\u987b\u8d70\u4e3b\u5e93\u3002</li>\n<li>\u5bf9\u4e8e\u53ef\u4ee5\u8bfb\u5230\u65e7\u6570\u636e\u7684\u8bf7\u6c42\uff0c\u624d\u5c06\u5176\u53d1\u5230\u4ece\u5e93\u4e0a\u3002\u5728\u8fd9\u4e2a\u4ea4\u6613\u5e73\u53f0\u4e0a\uff0c\u4e70\u5bb6\u6765\u901b\u5546\u94fa\u9875\u9762\uff0c\u5c31\u7b97\u665a\u51e0\u79d2\u770b\u5230\u6700\u65b0\u53d1\u5e03\u7684\u5546\u54c1\uff0c\u4e5f\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002\u90a3\u4e48\uff0c\u8fd9\u7c7b\u8bf7\u6c42\u5c31\u53ef\u4ee5\u8d70\u4ece\u5e93\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u65b9\u6848\u662f\u4e0d\u662f\u6709\u70b9\u754f\u96be\u548c\u53d6\u5de7\u7684\u610f\u601d\uff0c\u4f46\u5176\u5b9e\u8fd9\u4e2a\u65b9\u6848\u662f\u7528\u5f97\u6700\u591a\u7684\u3002</p>\n<p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u65b9\u6848\u6700\u5927\u7684\u95ee\u9898\u5728\u4e8e\uff0c\u6709\u65f6\u5019\u4f60\u4f1a\u78b0\u5230\u201c\u6240\u6709\u67e5\u8be2\u90fd\u4e0d\u80fd\u662f\u8fc7\u671f\u8bfb\u201d\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u4e00\u4e9b\u91d1\u878d\u7c7b\u7684\u4e1a\u52a1\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u4f60\u5c31\u8981\u653e\u5f03\u8bfb\u5199\u5206\u79bb\uff0c\u6240\u6709\u8bfb\u5199\u538b\u529b\u90fd\u5728\u4e3b\u5e93\uff0c\u7b49\u540c\u4e8e\u653e\u5f03\u4e86\u6269\u5c55\u6027\u3002</p>\n<p>\u56e0\u6b64\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u7684\u8bdd\u9898\u662f\uff1a\u53ef\u4ee5\u652f\u6301\u8bfb\u5199\u5206\u79bb\u7684\u573a\u666f\u4e0b\uff0c\u6709\u54ea\u4e9b\u89e3\u51b3\u8fc7\u671f\u8bfb\u7684\u65b9\u6848\uff0c\u5e76\u5206\u6790\u5404\u4e2a\u65b9\u6848\u7684\u4f18\u7f3a\u70b9\u3002</p>\n<h3 id=\"sleep\">Sleep \u65b9\u6848<a class=\"headerlink\" href=\"#sleep\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3b\u5e93\u66f4\u65b0\u540e\uff0c\u8bfb\u4ece\u5e93\u4e4b\u524d\u5148 sleep \u4e00\u4e0b\u3002\u5177\u4f53\u7684\u65b9\u6848\u5c31\u662f\uff0c\u7c7b\u4f3c\u4e8e\u6267\u884c\u4e00\u6761 <code>select sleep(1)</code> \u547d\u4ee4\u3002</p>\n<p>\u8fd9\u4e2a\u65b9\u6848\u7684\u5047\u8bbe\u662f\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u4e3b\u5907\u5ef6\u8fdf\u5728 1 \u79d2\u4e4b\u5185\uff0c\u505a\u4e00\u4e2a sleep \u53ef\u4ee5\u6709\u5f88\u5927\u6982\u7387\u62ff\u5230\u6700\u65b0\u7684\u6570\u636e\u3002</p>\n<p>\u8fd9\u4e2a\u65b9\u6848\u7ed9\u4f60\u7684\u7b2c\u4e00\u611f\u89c9\uff0c\u5f88\u53ef\u80fd\u662f\u4e0d\u9760\u8c31\u513f\uff0c\u5e94\u8be5\u4e0d\u4f1a\u6709\u4eba\u7528\u5427\uff1f\u5e76\u4e14\uff0c\u4f60\u8fd8\u53ef\u80fd\u4f1a\u8bf4\uff0c\u76f4\u63a5\u5728\u53d1\u8d77\u67e5\u8be2\u65f6\u5148\u6267\u884c\u4e00\u6761 sleep \u8bed\u53e5\uff0c\u7528\u6237\u4f53\u9a8c\u5f88\u4e0d\u53cb\u597d\u554a\u3002</p>\n<p>\u4f46\uff0c\u8fd9\u4e2a\u601d\u8def\u786e\u5b9e\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u95ee\u9898\u3002\u4e3a\u4e86\u770b\u8d77\u6765\u66f4\u9760\u8c31\u513f\uff0c\u6211\u4eec\u53ef\u4ee5\u6362\u4e00\u79cd\u65b9\u5f0f\u3002</p>\n<p>\u4ee5\u5356\u5bb6\u53d1\u5e03\u5546\u54c1\u4e3a\u4f8b\uff0c\u5546\u54c1\u53d1\u5e03\u540e\uff0c\u7528 Ajax \u76f4\u63a5\u628a\u5ba2\u6237\u7aef\u8f93\u5165\u7684\u5185\u5bb9\u4f5c\u4e3a\u201c\u65b0\u7684\u5546\u54c1\u201d\u663e\u793a\u5728\u9875\u9762\u4e0a\uff0c\u800c\u4e0d\u662f\u771f\u6b63\u5730\u53bb\u6570\u636e\u5e93\u505a\u67e5\u8be2\u3002</p>\n<p>\u8fd9\u6837\uff0c\u5356\u5bb6\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u663e\u793a\uff0c\u6765\u786e\u8ba4\u4ea7\u54c1\u5df2\u7ecf\u53d1\u5e03\u6210\u529f\u4e86\u3002\u7b49\u5230\u5356\u5bb6\u518d\u5237\u65b0\u9875\u9762\uff0c\u53bb\u67e5\u770b\u5546\u54c1\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u5df2\u7ecf\u8fc7\u4e86\u4e00\u6bb5\u65f6\u95f4\uff0c\u4e5f\u5c31\u8fbe\u5230\u4e86 sleep \u7684\u76ee\u7684\uff0c\u8fdb\u800c\u4e5f\u5c31\u89e3\u51b3\u4e86\u8fc7\u671f\u8bfb\u7684\u95ee\u9898\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a sleep \u65b9\u6848\u786e\u5b9e\u89e3\u51b3\u4e86\u7c7b\u4f3c\u573a\u666f\u4e0b\u7684\u8fc7\u671f\u8bfb\u95ee\u9898\u3002\u4f46\uff0c\u4ece\u4e25\u683c\u610f\u4e49\u4e0a\u6765\u8bf4\uff0c\u8fd9\u4e2a\u65b9\u6848\u5b58\u5728\u7684\u95ee\u9898\u5c31\u662f\u4e0d\u7cbe\u786e\u3002\u8fd9\u4e2a\u4e0d\u7cbe\u786e\u5305\u542b\u4e86\u4e24\u5c42\u610f\u601d\uff1a</p>\n<ol>\n<li>\u5982\u679c\u8fd9\u4e2a\u67e5\u8be2\u8bf7\u6c42\u672c\u6765 0.5 \u79d2\u5c31\u53ef\u4ee5\u5728\u4ece\u5e93\u4e0a\u62ff\u5230\u6b63\u786e\u7ed3\u679c\uff0c\u4e5f\u4f1a\u7b49 1 \u79d2\uff1b</li>\n<li>\u5982\u679c\u5ef6\u8fdf\u8d85\u8fc7 1 \u79d2\uff0c\u8fd8\u662f\u4f1a\u51fa\u73b0\u8fc7\u671f\u8bfb\u3002</li>\n</ol>\n<p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u662f\u4e0d\u662f\u6709\u4e00\u79cd\u201c\u4f60\u662f\u4e0d\u662f\u5728\u9017\u6211\u201d\u7684\u611f\u89c9\uff0c\u8fd9\u4e2a\u6539\u8fdb\u65b9\u6848\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u7c7b\u4f3c Ajax \u573a\u666f\u4e0b\u7684\u8fc7\u671f\u8bfb\u95ee\u9898\uff0c\u4f46\u8fd8\u662f\u600e\u4e48\u770b\u90fd\u4e0d\u9760\u8c31\u513f\u3002\u522b\u7740\u6025\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e9b\u66f4\u51c6\u786e\u7684\u65b9\u6848\u3002</p>\n<h3 id=\"_28\">\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u65b9\u6848<a class=\"headerlink\" href=\"#_28\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8981\u786e\u4fdd\u5907\u5e93\u65e0\u5ef6\u8fdf\uff0c\u901a\u5e38\u6709\u4e09\u79cd\u505a\u6cd5\u3002</p>\n<p>\u901a\u8fc7\u524d\u9762\u7684\u6587\u7ae0\uff0c\u6211\u4eec\u77e5\u9053 <code>show slave status</code> \u7ed3\u679c\u91cc\u7684 <code>seconds_behind_master</code> \u53c2\u6570\u7684\u503c\uff0c\u53ef\u4ee5\u7528\u6765\u8861\u91cf\u4e3b\u5907\u5ef6\u8fdf\u65f6\u95f4\u7684\u957f\u77ed\u3002</p>\n<p>\u6240\u4ee5**\u7b2c\u4e00\u79cd\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u65b9\u6cd5\u662f\uff0c**\u6bcf\u6b21\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u524d\uff0c\u5148\u5224\u65ad <code>seconds_behind_master</code> \u662f\u5426\u5df2\u7ecf\u7b49\u4e8e 0\u3002\u5982\u679c\u8fd8\u4e0d\u7b49\u4e8e 0 \uff0c\u90a3\u5c31\u5fc5\u987b\u7b49\u5230\u8fd9\u4e2a\u53c2\u6570\u53d8\u4e3a 0 \u624d\u80fd\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u3002</p>\n<p><code>seconds_behind_master</code> \u7684\u5355\u4f4d\u662f\u79d2\uff0c\u5982\u679c\u4f60\u89c9\u5f97\u7cbe\u5ea6\u4e0d\u591f\u7684\u8bdd\uff0c\u8fd8\u53ef\u4ee5\u91c7\u7528\u5bf9\u6bd4\u4f4d\u70b9\u548c GTID \u7684\u65b9\u6cd5\u6765\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u8bf4\u7684\u7b2c\u4e8c\u548c\u7b2c\u4e09\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u5982\u4e0b\u662f\u4e00\u4e2a <code>show slave status</code> \u7ed3\u679c\u7684\u90e8\u5206\u5185\u5bb9\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\">      </span><span class=\"n\">Master_Log_File</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">master</span><span class=\"p\">.</span><span class=\"mi\">000012</span>\n<span class=\"w\">  </span><span class=\"n\">Read_Master_log_Pos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1206067593</span>\n<span class=\"p\">.....</span>\n<span class=\"n\">Relay_Master_Log_File</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">master</span><span class=\"p\">.</span><span class=\"mi\">000012</span>\n<span class=\"p\">....</span>\n<span class=\"w\">  </span><span class=\"n\">Exec_Master_Log_Pos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">126067593</span>\n<span class=\"p\">....</span>\n<span class=\"w\">   </span><span class=\"n\">Retrieved_Gtid_Set</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"o\">-</span><span class=\"mi\">1111</span><span class=\"o\">-</span><span class=\"mi\">000</span><span class=\"o\">-</span><span class=\"mi\">1111</span><span class=\"o\">-</span><span class=\"mi\">0000000000</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">10000</span>\n<span class=\"w\">    </span><span class=\"n\">Executed_Gtid_Set</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"o\">-</span><span class=\"mi\">1111</span><span class=\"o\">-</span><span class=\"mi\">000</span><span class=\"o\">-</span><span class=\"mi\">1111</span><span class=\"o\">-</span><span class=\"mi\">0000000000</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">10000</span>\n<span class=\"w\">        </span><span class=\"n\">Auto_Position</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>**\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff0c**\u5bf9\u6bd4\u4f4d\u70b9\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff1a</p>\n<ul>\n<li><code>Master_Log_File</code> \u548c <code>Read_Master_Log_Pos</code>\uff0c\u8868\u793a\u7684\u662f\u8bfb\u5230\u7684\u4e3b\u5e93\u7684\u6700\u65b0\u4f4d\u70b9\uff1b</li>\n<li><code>Relay_Master_Log_File</code> \u548c <code>Exec_Master_Log_Pos</code>\uff0c\u8868\u793a\u7684\u662f\u5907\u5e93\u6267\u884c\u7684\u6700\u65b0\u4f4d\u70b9\u3002</li>\n</ul>\n<p>\u5982\u679c <code>Master_Log_File</code> \u548c <code>Relay_Master_Log_File</code>\u3001<code>Read_Master_Log_Pos</code> \u548c <code>Exec_Master_Log_Pos</code> \u8fd9\u4e24\u7ec4\u503c\u5b8c\u5168\u76f8\u540c\uff0c\u5c31\u8868\u793a\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u5df2\u7ecf\u540c\u6b65\u5b8c\u6210\u3002</p>\n<p>**\u7b2c\u4e09\u79cd\u65b9\u6cd5\uff0c**\u5bf9\u6bd4 GTID \u96c6\u5408\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff1a</p>\n<ul>\n<li><code>Auto_Position=1</code> \uff0c\u8868\u793a\u8fd9\u5bf9\u4e3b\u5907\u5173\u7cfb\u4f7f\u7528\u4e86 GTID \u534f\u8bae\u3002</li>\n<li><code>Retrieved_Gtid_Set</code>\uff0c\u662f\u5907\u5e93\u6536\u5230\u7684\u6240\u6709\u65e5\u5fd7\u7684 GTID \u96c6\u5408\uff1b</li>\n<li><code>Executed_Gtid_Set</code>\uff0c\u662f\u5907\u5e93\u6240\u6709\u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u7684 GTID \u96c6\u5408\u3002</li>\n</ul>\n<p>\u5982\u679c\u8fd9\u4e24\u4e2a\u96c6\u5408\u76f8\u540c\uff0c\u4e5f\u8868\u793a\u5907\u5e93\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u90fd\u5df2\u7ecf\u540c\u6b65\u5b8c\u6210\u3002</p>\n<p>\u53ef\u89c1\uff0c\u5bf9\u6bd4\u4f4d\u70b9\u548c\u5bf9\u6bd4 GTID \u8fd9\u4e24\u79cd\u65b9\u6cd5\uff0c\u90fd\u8981\u6bd4\u5224\u65ad <code>seconds_behind_master</code> \u662f\u5426\u4e3a 0 \u66f4\u51c6\u786e\u3002</p>\n<p>\u5728\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u4e4b\u524d\uff0c\u5148\u5224\u65ad\u4ece\u5e93\u662f\u5426\u540c\u6b65\u5b8c\u6210\u7684\u65b9\u6cd5\uff0c\u76f8\u6bd4\u4e8e sleep \u65b9\u6848\uff0c\u51c6\u786e\u5ea6\u786e\u5b9e\u63d0\u5347\u4e86\u4e0d\u5c11\uff0c\u4f46\u8fd8\u662f\u6ca1\u6709\u8fbe\u5230\u201c\u7cbe\u786e\u201d\u7684\u7a0b\u5ea6\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p>\n<p>\u6211\u4eec\u73b0\u5728\u4e00\u8d77\u6765\u56de\u987e\u4e0b\uff0c\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u5728\u4e3b\u5907\u5e93\u4e4b\u95f4\u7684\u72b6\u6001\uff1a</p>\n<ol>\n<li>\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\uff0c\u5199\u5165 binlog\uff0c\u5e76\u53cd\u9988\u7ed9\u5ba2\u6237\u7aef\uff1b</li>\n<li>binlog \u88ab\u4ece\u4e3b\u5e93\u53d1\u9001\u7ed9\u5907\u5e93\uff0c\u5907\u5e93\u6536\u5230\uff1b</li>\n<li>\u5728\u5907\u5e93\u6267\u884c binlog \u5b8c\u6210\u3002</li>\n</ol>\n<p>\u6211\u4eec\u4e0a\u9762\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u903b\u8f91\uff0c\u662f\u201c\u5907\u5e93\u6536\u5230\u7684\u65e5\u5fd7\u90fd\u6267\u884c\u5b8c\u6210\u4e86\u201d\u3002\u4f46\u662f\uff0c\u4ece binlog \u5728\u4e3b\u5907\u4e4b\u95f4\u72b6\u6001\u7684\u5206\u6790\u4e2d\uff0c\u4e0d\u96be\u770b\u51fa\u8fd8\u6709\u4e00\u90e8\u5206\u65e5\u5fd7\uff0c\u5904\u4e8e\u5ba2\u6237\u7aef\u5df2\u7ecf\u6536\u5230\u63d0\u4ea4\u786e\u8ba4\uff0c\u800c\u5907\u5e93\u8fd8\u6ca1\u6536\u5230\u65e5\u5fd7\u7684\u72b6\u6001\u3002</p>\n<p>\u5982\u56fe 4 \u6240\u793a\u5c31\u662f\u8fd9\u6837\u7684\u4e00\u4e2a\u72b6\u6001\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/557445207b57d6c0f2747509d7d6619e.png\" /></p>\n<p>\u56fe 4 \u5907\u5e93\u8fd8\u6ca1\u6536\u5230 trx3</p>\n<p>\u8fd9\u65f6\uff0c\u4e3b\u5e93\u4e0a\u6267\u884c\u5b8c\u6210\u4e86\u4e09\u4e2a\u4e8b\u52a1 trx1\u3001trx2 \u548c trx3\uff0c\u5176\u4e2d\uff1a</p>\n<ol>\n<li>trx1 \u548c trx2 \u5df2\u7ecf\u4f20\u5230\u4ece\u5e93\uff0c\u5e76\u4e14\u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u4e86\uff1b</li>\n<li>trx3 \u5728\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\uff0c\u5e76\u4e14\u5df2\u7ecf\u56de\u590d\u7ed9\u5ba2\u6237\u7aef\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u4f20\u5230\u4ece\u5e93\u4e2d\u3002</li>\n</ol>\n<p>\u5982\u679c\u8fd9\u65f6\u5019\u4f60\u5728\u4ece\u5e93 B \u4e0a\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u6309\u7167\u6211\u4eec\u4e0a\u9762\u7684\u903b\u8f91\uff0c\u4ece\u5e93\u8ba4\u4e3a\u5df2\u7ecf\u6ca1\u6709\u540c\u6b65\u5ef6\u8fdf\uff0c\u4f46\u8fd8\u662f\u67e5\u4e0d\u5230 trx3 \u7684\u3002\u4e25\u683c\u5730\u8bf4\uff0c\u5c31\u662f\u51fa\u73b0\u4e86\u8fc7\u671f\u8bfb\u3002</p>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u95ee\u9898\u6709\u6ca1\u6709\u529e\u6cd5\u89e3\u51b3\u5462\uff1f</p>\n<h3 id=\"semi-sync\">\u914d\u5408 semi-sync<a class=\"headerlink\" href=\"#semi-sync\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u8981\u5f15\u5165\u534a\u540c\u6b65\u590d\u5236\uff0c\u4e5f\u5c31\u662f semi-sync replication\u3002</p>\n<p>semi-sync \u505a\u4e86\u8fd9\u6837\u7684\u8bbe\u8ba1\uff1a</p>\n<ol>\n<li>\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u4e3b\u5e93\u628a binlog \u53d1\u7ed9\u4ece\u5e93\uff1b</li>\n<li>\u4ece\u5e93\u6536\u5230 binlog \u4ee5\u540e\uff0c\u53d1\u56de\u7ed9\u4e3b\u5e93\u4e00\u4e2a ack\uff0c\u8868\u793a\u6536\u5230\u4e86\uff1b</li>\n<li>\u4e3b\u5e93\u6536\u5230\u8fd9\u4e2a ack \u4ee5\u540e\uff0c\u624d\u80fd\u7ed9\u5ba2\u6237\u7aef\u8fd4\u56de\u201c\u4e8b\u52a1\u5b8c\u6210\u201d\u7684\u786e\u8ba4\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u542f\u7528\u4e86 semi-sync\uff0c\u5c31\u8868\u793a\u6240\u6709\u7ed9\u5ba2\u6237\u7aef\u53d1\u9001\u8fc7\u786e\u8ba4\u7684\u4e8b\u52a1\uff0c\u90fd\u786e\u4fdd\u4e86\u5907\u5e93\u5df2\u7ecf\u6536\u5230\u4e86\u8fd9\u4e2a\u65e5\u5fd7\u3002</p>\n<p>\u5728[\u7b2c 25 \u7bc7\u6587\u7ae0]\u7684\u8bc4\u8bba\u533a\uff0c\u6709\u540c\u5b66\u95ee\u5230\uff1a\u5982\u679c\u4e3b\u5e93\u6389\u7535\u7684\u65f6\u5019\uff0c\u6709\u4e9b binlog \u8fd8\u6765\u4e0d\u53ca\u53d1\u7ed9\u4ece\u5e93\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u7cfb\u7edf\u6570\u636e\u4e22\u5931\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f\u666e\u901a\u7684\u5f02\u6b65\u590d\u5236\u6a21\u5f0f\uff0c\u5c31\u53ef\u80fd\u4f1a\u4e22\u5931\uff0c\u4f46 semi-sync \u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u8fd9\u6837\uff0csemi-sync \u914d\u5408\u524d\u9762\u5173\u4e8e\u4f4d\u70b9\u7684\u5224\u65ad\uff0c\u5c31\u80fd\u591f\u786e\u5b9a\u5728\u4ece\u5e93\u4e0a\u6267\u884c\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u53ef\u4ee5\u907f\u514d\u8fc7\u671f\u8bfb\u3002</p>\n<p>\u4f46\u662f\uff0csemi-sync+ \u4f4d\u70b9\u5224\u65ad\u7684\u65b9\u6848\uff0c\u53ea\u5bf9\u4e00\u4e3b\u4e00\u5907\u7684\u573a\u666f\u662f\u6210\u7acb\u7684\u3002\u5728\u4e00\u4e3b\u591a\u4ece\u573a\u666f\u4e2d\uff0c\u4e3b\u5e93\u53ea\u8981\u7b49\u5230\u4e00\u4e2a\u4ece\u5e93\u7684 ack\uff0c\u5c31\u5f00\u59cb\u7ed9\u5ba2\u6237\u7aef\u8fd4\u56de\u786e\u8ba4\u3002\u8fd9\u65f6\uff0c\u5728\u4ece\u5e93\u4e0a\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u5c31\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u5982\u679c\u67e5\u8be2\u662f\u843d\u5728\u8fd9\u4e2a\u54cd\u5e94\u4e86 ack \u7684\u4ece\u5e93\u4e0a\uff0c\u662f\u80fd\u591f\u786e\u4fdd\u8bfb\u5230\u6700\u65b0\u6570\u636e\uff1b</li>\n<li>\u4f46\u5982\u679c\u662f\u67e5\u8be2\u843d\u5230\u5176\u4ed6\u4ece\u5e93\u4e0a\uff0c\u5b83\u4eec\u53ef\u80fd\u8fd8\u6ca1\u6709\u6536\u5230\u6700\u65b0\u7684\u65e5\u5fd7\uff0c\u5c31\u4f1a\u4ea7\u751f\u8fc7\u671f\u8bfb\u7684\u95ee\u9898\u3002</li>\n</ol>\n<p>\u5176\u5b9e\uff0c\u5224\u65ad\u540c\u6b65\u4f4d\u70b9\u7684\u65b9\u6848\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u6f5c\u5728\u7684\u95ee\u9898\uff0c\u5373\uff1a\u5982\u679c\u5728\u4e1a\u52a1\u66f4\u65b0\u7684\u9ad8\u5cf0\u671f\uff0c\u4e3b\u5e93\u7684\u4f4d\u70b9\u6216\u8005 GTID \u96c6\u5408\u66f4\u65b0\u5f88\u5feb\uff0c\u90a3\u4e48\u4e0a\u9762\u7684\u4e24\u4e2a\u4f4d\u70b9\u7b49\u503c\u5224\u65ad\u5c31\u4f1a\u4e00\u76f4\u4e0d\u6210\u7acb\uff0c\u5f88\u53ef\u80fd\u51fa\u73b0\u4ece\u5e93\u4e0a\u8fdf\u8fdf\u65e0\u6cd5\u54cd\u5e94\u67e5\u8be2\u8bf7\u6c42\u7684\u60c5\u51b5\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u56de\u5230\u6211\u4eec\u6700\u521d\u7684\u4e1a\u52a1\u903b\u8f91\u91cc\uff0c\u5f53\u53d1\u8d77\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u4ee5\u540e\uff0c\u6211\u4eec\u8981\u5f97\u5230\u51c6\u786e\u7684\u7ed3\u679c\uff0c\u5176\u5b9e\u5e76\u4e0d\u9700\u8981\u7b49\u5230\u201c\u4e3b\u5907\u5b8c\u5168\u540c\u6b65\u201d\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u65f6\u5e8f\u56fe\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/9cf54f3e91dc8f7b8947d7d8e384aa09.png\" /></p>\n<p>\u56fe 5 \u4e3b\u5907\u6301\u7eed\u5ef6\u8fdf\u4e00\u4e2a\u4e8b\u52a1</p>\n<p>\u56fe 5 \u6240\u793a\uff0c\u5c31\u662f\u7b49\u5f85\u4f4d\u70b9\u65b9\u6848\u7684\u4e00\u4e2a bad case\u3002\u56fe\u4e2d\u5907\u5e93 B \u4e0b\u7684\u865a\u7ebf\u6846\uff0c\u5206\u522b\u8868\u793a relaylog \u548c binlog \u4e2d\u7684\u4e8b\u52a1\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u56fe 5 \u4e2d\u4ece\u72b6\u6001 1 \u5230\u72b6\u6001 4\uff0c\u4e00\u76f4\u5904\u4e8e\u5ef6\u8fdf\u4e00\u4e2a\u4e8b\u52a1\u7684\u72b6\u6001\u3002</p>\n<p>\u5907\u5e93 B \u4e00\u76f4\u5230\u72b6\u6001 4 \u90fd\u548c\u4e3b\u5e93 A \u5b58\u5728\u5ef6\u8fdf\uff0c\u5982\u679c\u7528\u4e0a\u9762\u5fc5\u987b\u7b49\u5230\u65e0\u5ef6\u8fdf\u624d\u80fd\u67e5\u8be2\u7684\u65b9\u6848\uff0cselect \u8bed\u53e5\u76f4\u5230\u72b6\u6001 4 \u90fd\u4e0d\u80fd\u88ab\u6267\u884c\u3002</p>\n<p>\u4f46\u662f\uff0c\u5176\u5b9e\u5ba2\u6237\u7aef\u662f\u5728\u53d1\u5b8c trx1 \u66f4\u65b0\u540e\u53d1\u8d77\u7684 select \u8bed\u53e5\uff0c\u6211\u4eec\u53ea\u9700\u8981\u786e\u4fdd trx1 \u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u5c31\u53ef\u4ee5\u6267\u884c select \u8bed\u53e5\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5728\u72b6\u6001 3 \u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u5f97\u5230\u7684\u5c31\u662f\u9884\u671f\u7ed3\u679c\u4e86\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c0f\u7ed3\u4e00\u4e0b\uff0csemi-sync \u914d\u5408\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u65b9\u6848\uff0c\u5b58\u5728\u4e24\u4e2a\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u4e00\u4e3b\u591a\u4ece\u7684\u65f6\u5019\uff0c\u5728\u67d0\u4e9b\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u4f1a\u5b58\u5728\u8fc7\u671f\u8bfb\u7684\u73b0\u8c61\uff1b</li>\n<li>\u5728\u6301\u7eed\u5ef6\u8fdf\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u51fa\u73b0\u8fc7\u5ea6\u7b49\u5f85\u7684\u95ee\u9898\u3002</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u8981\u548c\u4f60\u4ecb\u7ecd\u7684\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e24\u4e2a\u95ee\u9898\u3002</p>\n<h3 id=\"_29\">\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848<a class=\"headerlink\" href=\"#_29\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8981\u7406\u89e3\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u6761\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">master_pos_wait</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"p\">]);</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u7684\u903b\u8f91\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u5b83\u662f\u5728\u4ece\u5e93\u6267\u884c\u7684\uff1b</li>\n<li>\u53c2\u6570 file \u548c pos \u6307\u7684\u662f\u4e3b\u5e93\u4e0a\u7684\u6587\u4ef6\u540d\u548c\u4f4d\u7f6e\uff1b</li>\n<li>timeout \u53ef\u9009\uff0c\u8bbe\u7f6e\u4e3a\u6b63\u6574\u6570 N \u8868\u793a\u8fd9\u4e2a\u51fd\u6570\u6700\u591a\u7b49\u5f85 N \u79d2\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u547d\u4ee4\u6b63\u5e38\u8fd4\u56de\u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u6b63\u6574\u6570 M\uff0c\u8868\u793a\u4ece\u547d\u4ee4\u5f00\u59cb\u6267\u884c\uff0c\u5230\u5e94\u7528\u5b8c file \u548c pos \u8868\u793a\u7684 binlog \u4f4d\u7f6e\uff0c\u6267\u884c\u4e86\u591a\u5c11\u4e8b\u52a1\u3002</p>\n<p>\u5f53\u7136\uff0c\u9664\u4e86\u6b63\u5e38\u8fd4\u56de\u4e00\u4e2a\u6b63\u6574\u6570 M \u5916\uff0c\u8fd9\u6761\u547d\u4ee4\u8fd8\u4f1a\u8fd4\u56de\u4e00\u4e9b\u5176\u4ed6\u7ed3\u679c\uff0c\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u5982\u679c\u6267\u884c\u671f\u95f4\uff0c\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u8fd4\u56de NULL\uff1b</li>\n<li>\u5982\u679c\u7b49\u5f85\u8d85\u8fc7 N \u79d2\uff0c\u5c31\u8fd4\u56de -1\uff1b</li>\n<li>\u5982\u679c\u521a\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53d1\u73b0\u5df2\u7ecf\u6267\u884c\u8fc7\u8fd9\u4e2a\u4f4d\u7f6e\u4e86\uff0c\u5219\u8fd4\u56de 0\u3002</li>\n</ol>\n<p>\u5bf9\u4e8e\u56fe 5 \u4e2d\u5148\u6267\u884c trx1\uff0c\u518d\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u7684\u903b\u8f91\uff0c\u8981\u4fdd\u8bc1\u80fd\u591f\u67e5\u5230\u6b63\u786e\u7684\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u903b\u8f91\uff1a</p>\n<ol>\n<li>trx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u9a6c\u4e0a\u6267\u884c show master status \u5f97\u5230\u5f53\u524d\u4e3b\u5e93\u6267\u884c\u5230\u7684 File \u548c Position\uff1b</li>\n<li>\u9009\u5b9a\u4e00\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li>\n<li>\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>select master_pos_wait(File, Position, 1)</code>\uff1b</li>\n<li>\u5982\u679c\u8fd4\u56de\u503c\u662f &gt;=0 \u7684\u6b63\u6574\u6570\uff0c\u5219\u5728\u8fd9\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li>\n<li>\u5426\u5219\uff0c\u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u3002</li>\n</ol>\n<p>\u6211\u628a\u4e0a\u9762\u8fd9\u4e2a\u6d41\u7a0b\u753b\u51fa\u6765\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/b20ae91ea46803df1b63ed683e1de357.png\" /></p>\n<p>\u56fe 6 <code>master_pos_wait</code> \u65b9\u6848</p>\n<p>\u8fd9\u91cc\u6211\u4eec\u5047\u8bbe\uff0c\u8fd9\u6761 select \u67e5\u8be2\u6700\u591a\u5728\u4ece\u5e93\u4e0a\u7b49\u5f85 1 \u79d2\u3002\u90a3\u4e48\uff0c\u5982\u679c 1 \u79d2\u5185 <code>master_pos_wait</code> \u8fd4\u56de\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e 0 \u7684\u6574\u6570\uff0c\u5c31\u786e\u4fdd\u4e86\u4ece\u5e93\u4e0a\u6267\u884c\u7684\u8fd9\u4e2a\u67e5\u8be2\u7ed3\u679c\u4e00\u5b9a\u5305\u542b\u4e86 trx1 \u7684\u6570\u636e\u3002</p>\n<p>\u6b65\u9aa4 5 \u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff0c\u662f\u8fd9\u7c7b\u65b9\u6848\u5e38\u7528\u7684\u9000\u5316\u673a\u5236\u3002\u56e0\u4e3a\u4ece\u5e93\u7684\u5ef6\u8fdf\u65f6\u95f4\u4e0d\u53ef\u63a7\uff0c\u4e0d\u80fd\u65e0\u9650\u7b49\u5f85\uff0c\u6240\u4ee5\u5982\u679c\u7b49\u5f85\u8d85\u65f6\uff0c\u5c31\u5e94\u8be5\u653e\u5f03\uff0c\u7136\u540e\u5230\u4e3b\u5e93\u53bb\u67e5\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u6240\u6709\u7684\u4ece\u5e93\u90fd\u5ef6\u8fdf\u8d85\u8fc7 1 \u79d2\u4e86\uff0c\u90a3\u67e5\u8be2\u538b\u529b\u4e0d\u5c31\u90fd\u8dd1\u5230\u4e3b\u5e93\u4e0a\u4e86\u5417\uff1f\u786e\u5b9e\u662f\u8fd9\u6837\u3002</p>\n<p>\u4f46\u662f\uff0c\u6309\u7167\u6211\u4eec\u8bbe\u5b9a\u4e0d\u5141\u8bb8\u8fc7\u671f\u8bfb\u7684\u8981\u6c42\uff0c\u5c31\u53ea\u6709\u4e24\u79cd\u9009\u62e9\uff0c\u4e00\u79cd\u662f\u8d85\u65f6\u653e\u5f03\uff0c\u4e00\u79cd\u662f\u8f6c\u5230\u4e3b\u5e93\u67e5\u8be2\u3002\u5177\u4f53\u600e\u4e48\u9009\u62e9\uff0c\u5c31\u9700\u8981\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u505a\u597d\u9650\u6d41\u7b56\u7565\u4e86\u3002</p>\n<h3 id=\"gtid_2\">GTID \u65b9\u6848<a class=\"headerlink\" href=\"#gtid_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u4f60\u7684\u6570\u636e\u5e93\u5f00\u542f\u4e86 GTID \u6a21\u5f0f\uff0c\u5bf9\u5e94\u7684\u4e5f\u6709\u7b49\u5f85 GTID \u7684\u65b9\u6848\u3002</p>\n<p>MySQL \u4e2d\u540c\u6837\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7c7b\u4f3c\u7684\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">wait_for_executed_gtid_set</span><span class=\"p\">(</span><span class=\"n\">gtid_set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u7684\u903b\u8f91\u662f\uff1a</p>\n<ol>\n<li>\u7b49\u5f85\uff0c\u76f4\u5230\u8fd9\u4e2a\u5e93\u6267\u884c\u7684\u4e8b\u52a1\u4e2d\u5305\u542b\u4f20\u5165\u7684 gtid_set\uff0c\u8fd4\u56de 0\uff1b</li>\n<li>\u8d85\u65f6\u8fd4\u56de 1\u3002</li>\n</ol>\n<p>\u5728\u524d\u9762\u7b49\u4f4d\u70b9\u7684\u65b9\u6848\u4e2d\uff0c\u6211\u4eec\u6267\u884c\u5b8c\u4e8b\u52a1\u540e\uff0c\u8fd8\u8981\u4e3b\u52a8\u53bb\u4e3b\u5e93\u6267\u884c <code>show master status</code>\u3002</p>\n<p>\u800c MySQL 5.7.6 \u7248\u672c\u5f00\u59cb\uff0c\u5141\u8bb8\u5728\u6267\u884c\u5b8c\u66f4\u65b0\u7c7b\u4e8b\u52a1\u540e\uff0c\u628a\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u7b49 GTID \u7684\u65b9\u6848\u5c31\u53ef\u4ee5\u51cf\u5c11\u4e00\u6b21\u67e5\u8be2\u3002</p>\n<p>\u8fd9\u65f6\uff0c\u7b49 GTID \u7684\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p>\n<ol>\n<li>trx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u4ece\u8fd4\u56de\u5305\u76f4\u63a5\u83b7\u53d6\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID\uff0c\u8bb0\u4e3a gtid1\uff1b</li>\n<li>\u9009\u5b9a\u4e00\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li>\n<li>\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>select wait_for_executed_gtid_set(gtid1, 1)</code>\uff1b</li>\n<li>\u5982\u679c\u8fd4\u56de\u503c\u662f 0\uff0c\u5219\u5728\u8fd9\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li>\n<li>\u5426\u5219\uff0c\u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u3002</li>\n</ol>\n<p>\u8ddf\u7b49\u4e3b\u5e93\u4f4d\u70b9\u7684\u65b9\u6848\u4e00\u6837\uff0c\u7b49\u5f85\u8d85\u65f6\u540e\u662f\u5426\u76f4\u63a5\u5230\u4e3b\u5e93\u67e5\u8be2\uff0c\u9700\u8981\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u6765\u505a\u9650\u6d41\u8003\u8651\u3002</p>\n<p>\u6211\u628a\u8fd9\u4e2a\u6d41\u7a0b\u56fe\u753b\u51fa\u6765\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/d521de8017297aff59db2f68170ee739.png\" /></p>\n<p>\u56fe 7 <code>wait_for_executed_gtid_set</code> \u65b9\u6848</p>\n<p>\u5728\u4e0a\u9762\u7684\u7b2c\u4e00\u6b65\u4e2d\uff0ctrx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u4ece\u8fd4\u56de\u5305\u76f4\u63a5\u83b7\u53d6\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID\u3002</p>\n<p>\u95ee\u9898\u662f\uff0c\u600e\u4e48\u80fd\u591f\u8ba9 MySQL \u5728\u6267\u884c\u4e8b\u52a1\u540e\uff0c\u8fd4\u56de\u5305\u4e2d\u5e26\u4e0a GTID \u5462\uff1f</p>\n<p>\u4f60\u53ea\u9700\u8981\u5c06\u53c2\u6570 <code>session_track_gtids</code> \u8bbe\u7f6e\u4e3a <code>OWN_GTID</code>\uff0c\u7136\u540e\u901a\u8fc7 API \u63a5\u53e3 <code>mysql_session_track_get_first</code> \u4ece\u8fd4\u56de\u5305\u89e3\u6790\u51fa GTID \u7684\u503c\u5373\u53ef\u3002</p>\n<p>\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4ecb\u7ecd <code>mysql_reset_connection</code> \u7684\u65f6\u5019\uff0c\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u7559\u8a00\u95ee\u8fd9\u7c7b\u63a5\u53e3\u5e94\u8be5\u600e\u4e48\u4f7f\u7528\u3002</p>\n<p>\u8fd9\u91cc\u6211\u518d\u56de\u7b54\u4e00\u4e0b\u3002\u5176\u5b9e\uff0cMySQL \u5e76\u6ca1\u6709\u63d0\u4f9b\u8fd9\u7c7b\u63a5\u53e3\u7684 SQL \u7528\u6cd5\uff0c\u662f\u63d0\u4f9b\u7ed9\u7a0b\u5e8f\u7684 API\u3002</p>\n<h3 id=\"_30\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_30\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u505a\u8bfb\u5199\u5206\u79bb\u65f6\uff0c\u53ef\u80fd\u78b0\u5230\u8fc7\u671f\u8bfb\u7684\u539f\u56e0\uff0c\u4ee5\u53ca\u51e0\u79cd\u5e94\u5bf9\u7684\u65b9\u6848\u3002</p>\n<p>\u8fd9\u51e0\u79cd\u65b9\u6848\u4e2d\uff0c\u6709\u7684\u65b9\u6848\u770b\u4e0a\u53bb\u662f\u505a\u4e86\u59a5\u534f\uff0c\u6709\u7684\u65b9\u6848\u770b\u4e0a\u53bb\u4e0d\u90a3\u4e48\u9760\u8c31\u513f\uff0c\u4f46\u90fd\u662f\u6709\u5b9e\u9645\u5e94\u7528\u573a\u666f\u7684\uff0c\u4f60\u9700\u8981\u6839\u636e\u4e1a\u52a1\u9700\u6c42\u9009\u62e9\u3002</p>\n<p>\u5373\u4f7f\u662f\u6700\u540e\u7b49\u5f85\u4f4d\u70b9\u548c\u7b49\u5f85 GTID \u8fd9\u4e24\u4e2a\u65b9\u6848\uff0c\u867d\u7136\u770b\u4e0a\u53bb\u6bd4\u8f83\u9760\u8c31\u513f\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u9700\u8981\u6743\u8861\u7684\u60c5\u51b5\u3002\u5982\u679c\u6240\u6709\u7684\u4ece\u5e93\u90fd\u5ef6\u8fdf\uff0c\u90a3\u4e48\u8bf7\u6c42\u5c31\u4f1a\u5168\u90e8\u843d\u5230\u4e3b\u5e93\u4e0a\uff0c\u8fd9\u65f6\u5019\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u538b\u529b\u7a81\u7136\u589e\u5927\uff0c\u628a\u4e3b\u5e93\u6253\u6302\u4e86\u5462\uff1f</p>\n<p>\u5176\u5b9e\uff0c\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u8fd9\u51e0\u4e2a\u65b9\u6848\u662f\u53ef\u4ee5\u6df7\u5408\u4f7f\u7528\u7684\u3002</p>\n<p>\u6bd4\u5982\uff0c\u5148\u5728\u5ba2\u6237\u7aef\u5bf9\u8bf7\u6c42\u505a\u5206\u7c7b\uff0c\u533a\u5206\u54ea\u4e9b\u8bf7\u6c42\u53ef\u4ee5\u63a5\u53d7\u8fc7\u671f\u8bfb\uff0c\u800c\u54ea\u4e9b\u8bf7\u6c42\u5b8c\u5168\u4e0d\u80fd\u63a5\u53d7\u8fc7\u671f\u8bfb\uff1b\u7136\u540e\uff0c\u5bf9\u4e8e\u4e0d\u80fd\u63a5\u53d7\u8fc7\u671f\u8bfb\u7684\u8bed\u53e5\uff0c\u518d\u4f7f\u7528\u7b49 GTID \u6216\u7b49\u4f4d\u70b9\u7684\u65b9\u6848\u3002</p>\n<p>\u4f46\u8bdd\u8bf4\u56de\u6765\uff0c\u8fc7\u671f\u8bfb\u5728\u672c\u8d28\u4e0a\u662f\u7531\u4e00\u5199\u591a\u8bfb\u5bfc\u81f4\u7684\u3002\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u53ef\u80fd\u4f1a\u6709\u522b\u7684\u4e0d\u9700\u8981\u7b49\u5f85\u5c31\u53ef\u4ee5\u6c34\u5e73\u6269\u5c55\u7684\u6570\u636e\u5e93\u65b9\u6848\uff0c\u4f46\u8fd9\u5f80\u5f80\u662f\u7528\u727a\u7272\u5199\u6027\u80fd\u6362\u6765\u7684\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u8bfb\u6027\u80fd\u548c\u5199\u6027\u80fd\u4e2d\u53d6\u6743\u8861\u3002</p>\n<h2 id=\"29\">29 \u5982\u4f55\u5224\u65ad\u4e00\u4e2a\u6570\u636e\u5e93\u662f\u4e0d\u662f\u51fa\u95ee\u9898\u4e86\uff1f<a class=\"headerlink\" href=\"#29\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u6587\u7ae0\u4e2d\uff0c\u4ecb\u7ecd\u4e86\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002\u901a\u8fc7\u8fd9\u4e9b\u5185\u5bb9\u7684\u8bb2\u89e3\uff0c\u4f60\u5e94\u8be5\u5df2\u7ecf\u5f88\u6e05\u695a\u4e86\uff1a\u5728\u4e00\u4e3b\u4e00\u5907\u7684\u53cc M \u67b6\u6784\u91cc\uff0c\u4e3b\u5907\u5207\u6362\u53ea\u9700\u8981\u628a\u5ba2\u6237\u7aef\u6d41\u91cf\u5207\u5230\u5907\u5e93\uff1b\u800c\u5728\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u91cc\uff0c\u4e3b\u5907\u5207\u6362\u9664\u4e86\u8981\u628a\u5ba2\u6237\u7aef\u6d41\u91cf\u5207\u5230\u5907\u5e93\u5916\uff0c\u8fd8\u9700\u8981\u628a\u4ece\u5e93\u63a5\u5230\u65b0\u4e3b\u5e93\u4e0a\u3002</p>\n<p>\u4e3b\u5907\u5207\u6362\u6709\u4e24\u79cd\u573a\u666f\uff0c\u4e00\u79cd\u662f\u4e3b\u52a8\u5207\u6362\uff0c\u4e00\u79cd\u662f\u88ab\u52a8\u5207\u6362\u3002\u800c\u5176\u4e2d\u88ab\u52a8\u5207\u6362\uff0c\u5f80\u5f80\u662f\u56e0\u4e3a\u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff0c\u7531 HA \u7cfb\u7edf\u53d1\u8d77\u7684\u3002</p>\n<p>\u8fd9\u4e5f\u5c31\u5f15\u51fa\u4e86\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\uff1a\u600e\u4e48\u5224\u65ad\u4e00\u4e2a\u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff1f</p>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u5f88\u7b80\u5355\u554a\uff0c\u8fde\u4e0a MySQL\uff0c\u6267\u884c\u4e2a select 1 \u5c31\u597d\u4e86\u3002\u4f46\u662f select 1 \u6210\u529f\u8fd4\u56de\u4e86\uff0c\u5c31\u8868\u793a\u4e3b\u5e93\u6ca1\u95ee\u9898\u5417\uff1f</p>\n<h3 id=\"select-1\">select 1 \u5224\u65ad<a class=\"headerlink\" href=\"#select-1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b9e\u9645\u4e0a\uff0cselect 1 \u6210\u529f\u8fd4\u56de\uff0c\u53ea\u80fd\u8bf4\u660e\u8fd9\u4e2a\u5e93\u7684\u8fdb\u7a0b\u8fd8\u5728\uff0c\u5e76\u4e0d\u80fd\u8bf4\u660e\u4e3b\u5e93\u6ca1\u95ee\u9898\u3002\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"k\">global</span><span class=\"w\"> </span><span class=\"n\">innodb_thread_concurrency</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</code></pre></div>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n<th>session D</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>select sleep(100) from t;</td>\n<td>select sleep(100) from t;</td>\n<td>select sleep(100) from t;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td>select 1;<br />(Query OK)<br />select * from t;<br />(blocked)</td>\n</tr>\n</tbody>\n</table>\n<p>\u6211\u4eec\u8bbe\u7f6e <code>innodb_thread_concurrency</code> \u53c2\u6570\u7684\u76ee\u7684\u662f\uff0c\u63a7\u5236 InnoDB \u7684\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u65e6\u5e76\u53d1\u7ebf\u7a0b\u6570\u8fbe\u5230\u8fd9\u4e2a\u503c\uff0cInnoDB \u5728\u63a5\u6536\u5230\u65b0\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\uff0c\u76f4\u5230\u6709\u7ebf\u7a0b\u9000\u51fa\u3002</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u628a <code>innodb_thread_concurrency</code> \u8bbe\u7f6e\u6210 3\uff0c\u8868\u793a InnoDB \u53ea\u5141\u8bb8 3 \u4e2a\u7ebf\u7a0b\u5e76\u884c\u6267\u884c\u3002\u800c\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u524d\u4e09\u4e2a session \u4e2d\u7684 sleep(100)\uff0c\u4f7f\u5f97\u8fd9\u4e09\u4e2a\u8bed\u53e5\u90fd\u5904\u4e8e\u201c\u6267\u884c\u201d\u72b6\u6001\uff0c\u4ee5\u6b64\u6765\u6a21\u62df\u5927\u67e5\u8be2\u3002</p>\n<p>\u4f60\u770b\u5230\u4e86\uff0c session D \u91cc\u9762\uff0cselect 1 \u662f\u80fd\u6267\u884c\u6210\u529f\u7684\uff0c\u4f46\u662f\u67e5\u8be2\u8868 t \u7684\u8bed\u53e5\u4f1a\u88ab\u5835\u4f4f\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u6211\u4eec\u7528 select 1 \u6765\u68c0\u6d4b\u5b9e\u4f8b\u662f\u5426\u6b63\u5e38\u7684\u8bdd\uff0c\u662f\u68c0\u6d4b\u4e0d\u51fa\u95ee\u9898\u7684\u3002</p>\n<p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_thread_concurrency</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u662f 0\uff0c\u8868\u793a\u4e0d\u9650\u5236\u5e76\u53d1\u7ebf\u7a0b\u6570\u91cf\u3002\u4f46\u662f\uff0c\u4e0d\u9650\u5236\u5e76\u53d1\u7ebf\u7a0b\u6570\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002\u56e0\u4e3a\uff0c\u4e00\u4e2a\u673a\u5668\u7684 CPU \u6838\u6570\u6709\u9650\uff0c\u7ebf\u7a0b\u5168\u51b2\u8fdb\u6765\uff0c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u6210\u672c\u5c31\u4f1a\u592a\u9ad8\u3002</p>\n<p>\u6240\u4ee5\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5efa\u8bae\u628a <code>innodb_thread_concurrency</code> \u8bbe\u7f6e\u4e3a 64~128 \u4e4b\u95f4\u7684\u503c\u3002\u8fd9\u65f6\uff0c\u4f60\u4e00\u5b9a\u4f1a\u6709\u7591\u95ee\uff0c\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u6570\u8bbe\u7f6e\u4e3a 128 \u591f\u5e72\u5565\uff0c\u7ebf\u4e0a\u7684\u5e76\u53d1\u8fde\u63a5\u6570\u52a8\u4e0d\u52a8\u5c31\u4e0a\u5343\u4e86\u3002</p>\n<p>\u4ea7\u751f\u8fd9\u4e2a\u7591\u95ee\u7684\u539f\u56e0\uff0c\u662f\u641e\u6df7\u4e86**\u5e76\u53d1\u8fde\u63a5\u548c\u5e76\u53d1\u67e5\u8be2\u3002**</p>\n<p>\u5e76\u53d1\u8fde\u63a5\u548c\u5e76\u53d1\u67e5\u8be2\uff0c\u5e76\u4e0d\u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002\u4f60\u5728 <code>show processlist</code> \u7684\u7ed3\u679c\u91cc\uff0c\u770b\u5230\u7684\u51e0\u5343\u4e2a\u8fde\u63a5\uff0c\u6307\u7684\u5c31\u662f\u5e76\u53d1\u8fde\u63a5\u3002\u800c\u201c\u5f53\u524d\u6b63\u5728\u6267\u884c\u201d\u7684\u8bed\u53e5\uff0c\u624d\u662f\u6211\u4eec\u6240\u8bf4\u7684\u5e76\u53d1\u67e5\u8be2\u3002</p>\n<p>\u5e76\u53d1\u8fde\u63a5\u6570\u8fbe\u5230\u51e0\u5343\u4e2a\u5f71\u54cd\u5e76\u4e0d\u5927\uff0c\u5c31\u662f\u591a\u5360\u4e00\u4e9b\u5185\u5b58\u800c\u5df2\u3002\u6211\u4eec\u5e94\u8be5\u5173\u6ce8\u7684\u662f\u5e76\u53d1\u67e5\u8be2\uff0c\u56e0\u4e3a\u5e76\u53d1\u67e5\u8be2\u592a\u9ad8\u624d\u662f CPU \u6740\u624b\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981\u8bbe\u7f6e <code>innodb_thread_concurrency</code> \u53c2\u6570\u7684\u539f\u56e0\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c<strong>\u5728\u7ebf\u7a0b\u8fdb\u5165\u9501\u7b49\u5f85\u4ee5\u540e\uff0c\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u4f1a\u51cf\u4e00</strong>\uff0c\u4e5f\u5c31\u662f\u8bf4\u7b49\u884c\u9501\uff08\u4e5f\u5305\u62ec\u95f4\u9699\u9501\uff09\u7684\u7ebf\u7a0b\u662f\u4e0d\u7b97\u5728 128 \u91cc\u9762\u7684\u3002</p>\n<p>MySQL \u8fd9\u6837\u8bbe\u8ba1\u662f\u975e\u5e38\u6709\u610f\u4e49\u7684\u3002\u56e0\u4e3a\uff0c\u8fdb\u5165\u9501\u7b49\u5f85\u7684\u7ebf\u7a0b\u5df2\u7ecf\u4e0d\u5403 CPU \u4e86\uff1b\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5fc5\u987b\u8fd9\u4e48\u8bbe\u8ba1\uff0c\u624d\u80fd\u907f\u514d\u6574\u4e2a\u7cfb\u7edf\u9501\u6b7b\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u5462\uff1f\u5047\u8bbe\u5904\u4e8e\u9501\u7b49\u5f85\u7684\u7ebf\u7a0b\u4e5f\u5360\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\uff0c\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\uff1a</p>\n<ol>\n<li>\u7ebf\u7a0b 1 \u6267\u884c <code>begin; update t set c=c+1 where id=1</code>, \u542f\u52a8\u4e86\u4e8b\u52a1 trx1\uff0c \u7136\u540e\u4fdd\u6301\u8fd9\u4e2a\u72b6\u6001\u3002\u8fd9\u65f6\u5019\uff0c\u7ebf\u7a0b\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4e0d\u7b97\u5728\u5e76\u53d1\u7ebf\u7a0b\u91cc\u9762\u3002</li>\n<li>\u7ebf\u7a0b 2 \u5230\u7ebf\u7a0b 129 \u90fd\u6267\u884c <code>update t set c=c+1 where id=1</code>; \u7531\u4e8e\u7b49\u884c\u9501\uff0c\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002\u8fd9\u6837\u5c31\u6709 128 \u4e2a\u7ebf\u7a0b\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff1b</li>\n<li>\u5982\u679c\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\u7684\u7ebf\u7a0b\u8ba1\u6570\u4e0d\u51cf\u4e00\uff0cInnoDB \u5c31\u4f1a\u8ba4\u4e3a\u7ebf\u7a0b\u6570\u7528\u6ee1\u4e86\uff0c\u4f1a\u963b\u6b62\u5176\u4ed6\u8bed\u53e5\u8fdb\u5165\u5f15\u64ce\u6267\u884c\uff0c\u8fd9\u6837\u7ebf\u7a0b 1 \u4e0d\u80fd\u63d0\u4ea4\u4e8b\u52a1\u3002\u800c\u53e6\u5916\u7684 128 \u4e2a\u7ebf\u7a0b\u53c8\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\uff0c\u6574\u4e2a\u7cfb\u7edf\u5c31\u5835\u4f4f\u4e86\u3002</li>\n</ol>\n<p>\u4e0b\u56fe 2 \u663e\u793a\u7684\u5c31\u662f\u8fd9\u4e2a\u72b6\u6001\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/3206ea18b8a24b546515b1b95dc4a11d.png\" /></p>\n<p>\u56fe 2 \u7cfb\u7edf\u9501\u6b7b\u72b6\u6001\uff08\u5047\u8bbe\u7b49\u884c\u9501\u7684\u8bed\u53e5\u5360\u7528\u5e76\u53d1\u8ba1\u6570\uff09</p>\n<p>\u8fd9\u65f6\u5019 InnoDB \u4e0d\u80fd\u54cd\u5e94\u4efb\u4f55\u8bf7\u6c42\uff0c\u6574\u4e2a\u7cfb\u7edf\u88ab\u9501\u6b7b\u3002\u800c\u4e14\uff0c\u7531\u4e8e\u6240\u6709\u7ebf\u7a0b\u90fd\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u6b64\u65f6\u5360\u7528\u7684 CPU \u5374\u662f 0\uff0c\u800c\u8fd9\u660e\u663e\u4e0d\u5408\u7406\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u8bf4 InnoDB \u5728\u8bbe\u8ba1\u65f6\uff0c\u9047\u5230\u8fdb\u7a0b\u8fdb\u5165\u9501\u7b49\u5f85\u7684\u60c5\u51b5\u65f6\uff0c\u5c06\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u51cf 1 \u7684\u8bbe\u8ba1\uff0c\u662f\u5408\u7406\u800c\u4e14\u662f\u5fc5\u8981\u7684\u3002</p>\n<p>\u867d\u7136\u8bf4\u7b49\u9501\u7684\u7ebf\u7a0b\u4e0d\u7b97\u5728\u5e76\u53d1\u7ebf\u7a0b\u8ba1\u6570\u91cc\uff0c\u4f46\u5982\u679c\u5b83\u5728\u771f\u6b63\u5730\u6267\u884c\u67e5\u8be2\uff0c\u5c31\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u4f8b\u5b50\u4e2d\u524d\u4e09\u4e2a\u4e8b\u52a1\u4e2d\u7684 <code>select sleep(100) from t</code>\uff0c\u8fd8\u662f\u8981\u7b97\u8fdb\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u7684\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u540c\u65f6\u5728\u6267\u884c\u7684\u8bed\u53e5\u8d85\u8fc7\u4e86\u8bbe\u7f6e\u7684 <code>innodb_thread_concurrency</code> \u7684\u503c\uff0c\u8fd9\u65f6\u5019\u7cfb\u7edf\u5176\u5b9e\u5df2\u7ecf\u4e0d\u884c\u4e86\uff0c\u4f46\u662f\u901a\u8fc7 select 1 \u6765\u68c0\u6d4b\u7cfb\u7edf\uff0c\u4f1a\u8ba4\u4e3a\u7cfb\u7edf\u8fd8\u662f\u6b63\u5e38\u7684\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6211\u4eec\u4f7f\u7528 select 1 \u7684\u5224\u65ad\u903b\u8f91\u8981\u4fee\u6539\u4e00\u4e0b\u3002</p>\n<h3 id=\"_31\">\u67e5\u8868\u5224\u65ad<a class=\"headerlink\" href=\"#_31\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u80fd\u591f\u68c0\u6d4b InnoDB \u5e76\u53d1\u7ebf\u7a0b\u6570\u8fc7\u591a\u5bfc\u81f4\u7684\u7cfb\u7edf\u4e0d\u53ef\u7528\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u627e\u4e00\u4e2a\u8bbf\u95ee InnoDB \u7684\u573a\u666f\u3002\u4e00\u822c\u7684\u505a\u6cd5\u662f\uff0c\u5728\u7cfb\u7edf\u5e93\uff08mysql \u5e93\uff09\u91cc\u521b\u5efa\u4e00\u4e2a\u8868\uff0c\u6bd4\u5982\u547d\u540d\u4e3a health_check\uff0c\u91cc\u9762\u53ea\u653e\u4e00\u884c\u6570\u636e\uff0c\u7136\u540e\u5b9a\u671f\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"p\">.</span><span class=\"n\">health_check</span><span class=\"p\">;</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4b\u51fa\u7531\u4e8e\u5e76\u53d1\u7ebf\u7a0b\u8fc7\u591a\u5bfc\u81f4\u7684\u6570\u636e\u5e93\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u3002</p>\n<p>\u4f46\u662f\uff0c\u6211\u4eec\u9a6c\u4e0a\u8fd8\u4f1a\u78b0\u5230\u4e0b\u4e00\u4e2a\u95ee\u9898\uff0c\u5373\uff1a\u7a7a\u95f4\u6ee1\u4e86\u4ee5\u540e\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53c8\u4f1a\u53d8\u5f97\u4e0d\u597d\u4f7f\u3002</p>\n<p>\u6211\u4eec\u77e5\u9053\uff0c\u66f4\u65b0\u4e8b\u52a1\u8981\u5199 binlog\uff0c\u800c\u4e00\u65e6 binlog \u6240\u5728\u78c1\u76d8\u7684\u7a7a\u95f4\u5360\u7528\u7387\u8fbe\u5230 100%\uff0c\u90a3\u4e48\u6240\u6709\u7684\u66f4\u65b0\u8bed\u53e5\u548c\u4e8b\u52a1\u63d0\u4ea4\u7684 commit \u8bed\u53e5\u5c31\u90fd\u4f1a\u88ab\u5835\u4f4f\u3002\u4f46\u662f\uff0c\u7cfb\u7edf\u8fd9\u65f6\u5019\u8fd8\u662f\u53ef\u4ee5\u6b63\u5e38\u8bfb\u6570\u636e\u7684\u3002</p>\n<p>\u56e0\u6b64\uff0c\u6211\u4eec\u8fd8\u662f\u628a\u8fd9\u6761\u76d1\u63a7\u8bed\u53e5\u518d\u6539\u8fdb\u4e00\u4e0b\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u628a\u67e5\u8be2\u8bed\u53e5\u6539\u6210\u66f4\u65b0\u8bed\u53e5\u540e\u7684\u6548\u679c\u3002</p>\n<h3 id=\"_32\">\u66f4\u65b0\u5224\u65ad<a class=\"headerlink\" href=\"#_32\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136\u8981\u66f4\u65b0\uff0c\u5c31\u8981\u653e\u4e2a\u6709\u610f\u4e49\u7684\u5b57\u6bb5\uff0c\u5e38\u89c1\u505a\u6cd5\u662f\u653e\u4e00\u4e2a timestamp \u5b57\u6bb5\uff0c\u7528\u6765\u8868\u793a\u6700\u540e\u4e00\u6b21\u6267\u884c\u68c0\u6d4b\u7684\u65f6\u95f4\u3002\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u7c7b\u4f3c\u4e8e\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"p\">.</span><span class=\"n\">health_check</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">=</span><span class=\"n\">now</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u8282\u70b9\u53ef\u7528\u6027\u7684\u68c0\u6d4b\u90fd\u5e94\u8be5\u5305\u542b\u4e3b\u5e93\u548c\u5907\u5e93\u3002\u5982\u679c\u7528\u66f4\u65b0\u6765\u68c0\u6d4b\u4e3b\u5e93\u7684\u8bdd\uff0c\u90a3\u4e48\u5907\u5e93\u4e5f\u8981\u8fdb\u884c\u66f4\u65b0\u68c0\u6d4b\u3002</p>\n<p>\u4f46\uff0c\u5907\u5e93\u7684\u68c0\u6d4b\u4e5f\u662f\u8981\u5199 binlog \u7684\u3002\u7531\u4e8e\u6211\u4eec\u4e00\u822c\u4f1a\u628a\u6570\u636e\u5e93 A \u548c B \u7684\u4e3b\u5907\u5173\u7cfb\u8bbe\u8ba1\u4e3a\u53cc M \u7ed3\u6784\uff0c\u6240\u4ee5\u5728\u5907\u5e93 B \u4e0a\u6267\u884c\u7684\u68c0\u6d4b\u547d\u4ee4\uff0c\u4e5f\u8981\u53d1\u56de\u7ed9\u4e3b\u5e93 A\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u90fd\u7528\u76f8\u540c\u7684\u66f4\u65b0\u547d\u4ee4\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u884c\u51b2\u7a81\uff0c\u4e5f\u5c31\u662f\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002\u6240\u4ee5\uff0c\u73b0\u5728\u770b\u6765 <code>mysql.health_check</code> \u8fd9\u4e2a\u8868\u5c31\u4e0d\u80fd\u53ea\u6709\u4e00\u884c\u6570\u636e\u4e86\u3002</p>\n<p>\u4e3a\u4e86\u8ba9\u4e3b\u5907\u4e4b\u95f4\u7684\u66f4\u65b0\u4e0d\u4ea7\u751f\u51b2\u7a81\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 mysql.health_check \u8868\u4e0a\u5b58\u5165\u591a\u884c\u6570\u636e\uff0c\u5e76\u7528 A\u3001B \u7684 server_id \u505a\u4e3b\u952e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">health_check</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">t_modified</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">CURRENT_TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"cm\">/* \u68c0\u6d4b\u547d\u4ee4 */</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"p\">.</span><span class=\"n\">health_check</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">@@</span><span class=\"n\">server_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"o\">=</span><span class=\"n\">now</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u7531\u4e8e MySQL \u89c4\u5b9a\u4e86\u4e3b\u5e93\u548c\u5907\u5e93\u7684 server_id \u5fc5\u987b\u4e0d\u540c\uff08\u5426\u5219\u521b\u5efa\u4e3b\u5907\u5173\u7cfb\u7684\u65f6\u5019\u5c31\u4f1a\u62a5\u9519\uff09\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u4e3b\u3001\u5907\u5e93\u5404\u81ea\u7684\u68c0\u6d4b\u547d\u4ee4\u4e0d\u4f1a\u53d1\u751f\u51b2\u7a81\u3002</p>\n<p>\u66f4\u65b0\u5224\u65ad\u662f\u4e00\u4e2a\u76f8\u5bf9\u6bd4\u8f83\u5e38\u7528\u7684\u65b9\u6848\u4e86\uff0c\u4e0d\u8fc7\u4f9d\u7136\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\u3002\u5176\u4e2d\uff0c\u201c\u5224\u5b9a\u6162\u201d\u4e00\u76f4\u662f\u8ba9 DBA \u5934\u75bc\u7684\u95ee\u9898\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u7591\u60d1\uff0c<strong>\u66f4\u65b0\u8bed\u53e5\uff0c\u5982\u679c\u5931\u8d25\u6216\u8005\u8d85\u65f6\uff0c\u5c31\u53ef\u4ee5\u53d1\u8d77\u4e3b\u5907\u5207\u6362\u4e86\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u4f1a\u6709\u5224\u5b9a\u6162\u7684\u95ee\u9898\u5462\uff1f</strong></p>\n<p>\u5176\u5b9e\uff0c\u8fd9\u91cc\u6d89\u53ca\u5230\u7684\u662f\u670d\u52a1\u5668 IO \u8d44\u6e90\u5206\u914d\u7684\u95ee\u9898\u3002</p>\n<p>\u9996\u5148\uff0c\u6240\u6709\u7684\u68c0\u6d4b\u903b\u8f91\u90fd\u9700\u8981\u4e00\u4e2a\u8d85\u65f6\u65f6\u95f4 N\u3002\u6267\u884c\u4e00\u6761 update \u8bed\u53e5\uff0c\u8d85\u8fc7 N \u79d2\u540e\u8fd8\u4e0d\u8fd4\u56de\uff0c\u5c31\u8ba4\u4e3a\u7cfb\u7edf\u4e0d\u53ef\u7528\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e2a\u65e5\u5fd7\u76d8\u7684 IO \u5229\u7528\u7387\u5df2\u7ecf\u662f 100% \u7684\u573a\u666f\u3002\u8fd9\u65f6\u5019\uff0c\u6574\u4e2a\u7cfb\u7edf\u54cd\u5e94\u975e\u5e38\u6162\uff0c\u5df2\u7ecf\u9700\u8981\u505a\u4e3b\u5907\u5207\u6362\u4e86\u3002</p>\n<p>\u4f46\u662f\u4f60\u8981\u77e5\u9053\uff0cIO \u5229\u7528\u7387 100% \u8868\u793a\u7cfb\u7edf\u7684 IO \u662f\u5728\u5de5\u4f5c\u7684\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u6709\u673a\u4f1a\u83b7\u5f97 IO \u8d44\u6e90\uff0c\u6267\u884c\u81ea\u5df1\u7684\u4efb\u52a1\u3002\u800c\u6211\u4eec\u7684\u68c0\u6d4b\u4f7f\u7528\u7684 update \u547d\u4ee4\uff0c\u9700\u8981\u7684\u8d44\u6e90\u5f88\u5c11\uff0c\u6240\u4ee5\u53ef\u80fd\u5728\u62ff\u5230 IO \u8d44\u6e90\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u63d0\u4ea4\u6210\u529f\uff0c\u5e76\u4e14\u5728\u8d85\u65f6\u65f6\u95f4 N \u79d2\u672a\u5230\u8fbe\u4e4b\u524d\u5c31\u8fd4\u56de\u7ed9\u4e86\u68c0\u6d4b\u7cfb\u7edf\u3002</p>\n<p>\u68c0\u6d4b\u7cfb\u7edf\u4e00\u770b\uff0cupdate \u547d\u4ee4\u6ca1\u6709\u8d85\u65f6\uff0c\u4e8e\u662f\u5c31\u5f97\u5230\u4e86\u201c\u7cfb\u7edf\u6b63\u5e38\u201d\u7684\u7ed3\u8bba\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u65f6\u5019\u5728\u4e1a\u52a1\u7cfb\u7edf\u4e0a\u6b63\u5e38\u7684 SQL \u8bed\u53e5\u5df2\u7ecf\u6267\u884c\u5f97\u5f88\u6162\u4e86\uff0c\u4f46\u662f DBA \u4e0a\u53bb\u4e00\u770b\uff0cHA \u7cfb\u7edf\u8fd8\u5728\u6b63\u5e38\u5de5\u4f5c\uff0c\u5e76\u4e14\u8ba4\u4e3a\u4e3b\u5e93\u73b0\u5728\u5904\u4e8e\u53ef\u7528\u72b6\u6001\u3002</p>\n<p>\u4e4b\u6240\u4ee5\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u73b0\u8c61\uff0c\u6839\u672c\u539f\u56e0\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u7684\u6240\u6709\u65b9\u6cd5\uff0c\u90fd\u662f\u57fa\u4e8e\u5916\u90e8\u68c0\u6d4b\u7684\u3002\u5916\u90e8\u68c0\u6d4b\u5929\u7136\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u968f\u673a\u6027\u3002</p>\n<p>\u56e0\u4e3a\uff0c\u5916\u90e8\u68c0\u6d4b\u90fd\u9700\u8981\u5b9a\u65f6\u8f6e\u8be2\uff0c\u6240\u4ee5\u7cfb\u7edf\u53ef\u80fd\u5df2\u7ecf\u51fa\u95ee\u9898\u4e86\uff0c\u4f46\u662f\u5374\u9700\u8981\u7b49\u5230\u4e0b\u4e00\u4e2a\u68c0\u6d4b\u53d1\u8d77\u6267\u884c\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u6211\u4eec\u624d\u6709\u53ef\u80fd\u53d1\u73b0\u95ee\u9898\u3002\u800c\u4e14\uff0c\u5982\u679c\u4f60\u7684\u8fd0\u6c14\u4e0d\u591f\u597d\u7684\u8bdd\uff0c\u53ef\u80fd\u7b2c\u4e00\u6b21\u8f6e\u8be2\u8fd8\u4e0d\u80fd\u53d1\u73b0\uff0c\u8fd9\u5c31\u4f1a\u5bfc\u81f4\u5207\u6362\u6162\u7684\u95ee\u9898\u3002</p>\n<p>\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\u6211\u8981\u518d\u548c\u4f60\u4ecb\u7ecd\u4e00\u79cd\u5728 MySQL \u5185\u90e8\u53d1\u73b0\u6570\u636e\u5e93\u95ee\u9898\u7684\u65b9\u6cd5\u3002</p>\n<h3 id=\"_33\">\u5185\u90e8\u7edf\u8ba1<a class=\"headerlink\" href=\"#_33\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9488\u5bf9\u78c1\u76d8\u5229\u7528\u7387\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c MySQL \u53ef\u4ee5\u544a\u8bc9\u6211\u4eec\uff0c\u5185\u90e8\u6bcf\u4e00\u6b21 IO \u8bf7\u6c42\u7684\u65f6\u95f4\uff0c\u90a3\u6211\u4eec\u5224\u65ad\u6570\u636e\u5e93\u662f\u5426\u51fa\u95ee\u9898\u7684\u65b9\u6cd5\u5c31\u53ef\u9760\u5f97\u591a\u4e86\u3002</p>\n<p>\u5176\u5b9e\uff0cMySQL 5.6 \u7248\u672c\u4ee5\u540e\u63d0\u4f9b\u7684 <code>performance_schema</code> \u5e93\uff0c\u5c31\u5728 <code>file_summary_by_event_name</code> \u8868\u91cc\u7edf\u8ba1\u4e86\u6bcf\u6b21 IO \u8bf7\u6c42\u7684\u65f6\u95f4\u3002</p>\n<p><code>file_summary_by_event_name</code> \u8868\u91cc\u6709\u5f88\u591a\u884c\u6570\u636e\uff0c\u6211\u4eec\u5148\u6765\u770b\u770b <code>event_name='wait/io/file/innodb/innodb_log_file\u2019</code>\u8fd9\u4e00\u884c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">performance_schema</span><span class=\"p\">.</span><span class=\"n\">file_summary_by_event_name</span><span class=\"w\"> </span>\n<span class=\"w\">      </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">event_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">               </span><span class=\"n\">EVENT_NAME</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">wait</span><span class=\"o\">/</span><span class=\"n\">io</span><span class=\"o\">/</span><span class=\"n\">file</span><span class=\"o\">/</span><span class=\"n\">innodb</span><span class=\"o\">/</span><span class=\"n\">innodb_log_file</span>\n<span class=\"w\">               </span><span class=\"n\">COUNT_STAR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">793403</span>\n<span class=\"w\">           </span><span class=\"n\">SUM_TIMER_WAIT</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">95887122719672</span>\n<span class=\"w\">           </span><span class=\"n\">MIN_TIMER_WAIT</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">871382</span>\n<span class=\"w\">           </span><span class=\"n\">AVG_TIMER_WAIT</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">120855468</span>\n<span class=\"w\">           </span><span class=\"n\">MAX_TIMER_WAIT</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">735743606690</span>\n<span class=\"w\">               </span><span class=\"n\">COUNT_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"w\">           </span><span class=\"n\">SUM_TIMER_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">33772444588</span>\n<span class=\"w\">           </span><span class=\"n\">MIN_TIMER_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1012608</span>\n<span class=\"w\">           </span><span class=\"n\">AVG_TIMER_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">4221555427</span>\n<span class=\"w\">           </span><span class=\"n\">MAX_TIMER_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">24994999638</span>\n<span class=\"w\"> </span><span class=\"n\">SUM_NUMBER_OF_BYTES_READ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">70656</span>\n<span class=\"w\">              </span><span class=\"n\">COUNT_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">415313</span>\n<span class=\"w\">          </span><span class=\"n\">SUM_TIMER_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">26836729823736</span>\n<span class=\"w\">          </span><span class=\"n\">MIN_TIMER_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2974536</span>\n<span class=\"w\">          </span><span class=\"n\">AVG_TIMER_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">64617927</span>\n<span class=\"w\">          </span><span class=\"n\">MAX_TIMER_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">228565239606</span>\n<span class=\"n\">SUM_NUMBER_OF_BYTES_WRITE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">345248256</span>\n<span class=\"w\">               </span><span class=\"n\">COUNT_MISC</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">378082</span>\n<span class=\"w\">           </span><span class=\"n\">SUM_TIMER_MISC</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">69016620451348</span>\n<span class=\"w\">           </span><span class=\"n\">MIN_TIMER_MISC</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">871382</span>\n<span class=\"w\">           </span><span class=\"n\">AVG_TIMER_MISC</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">182543981</span>\n<span class=\"w\">           </span><span class=\"n\">MAX_TIMER_MISC</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">735743606690</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u56fe\u4e2d\u8fd9\u4e00\u884c\u8868\u793a\u7edf\u8ba1\u7684\u662f redo log \u7684\u5199\u5165\u65f6\u95f4\uff0c\u7b2c\u4e00\u5217 EVENT_NAME \u8868\u793a\u7edf\u8ba1\u7684\u7c7b\u578b\u3002</p>\n<p>\u63a5\u4e0b\u6765\u7684\u4e09\u7ec4\u6570\u636e\uff0c\u663e\u793a\u7684\u662f redo log \u64cd\u4f5c\u7684\u65f6\u95f4\u7edf\u8ba1\u3002</p>\n<p>\u7b2c\u4e00\u7ec4\u4e94\u5217\uff0c\u662f\u6240\u6709 IO \u7c7b\u578b\u7684\u7edf\u8ba1\u3002\u5176\u4e2d\uff0c<code>COUNT_STAR</code> \u662f\u6240\u6709 IO \u7684\u603b\u6b21\u6570\uff0c\u63a5\u4e0b\u6765\u56db\u5217\u662f\u5177\u4f53\u7684\u7edf\u8ba1\u9879\uff0c \u5355\u4f4d\u662f\u76ae\u79d2\uff1b\u524d\u7f00 SUM\u3001MIN\u3001AVG\u3001MAX\uff0c\u987e\u540d\u601d\u4e49\u6307\u7684\u5c31\u662f\u603b\u548c\u3001\u6700\u5c0f\u503c\u3001\u5e73\u5747\u503c\u548c\u6700\u5927\u503c\u3002</p>\n<p>\u7b2c\u4e8c\u7ec4\u516d\u5217\uff0c\u662f\u8bfb\u64cd\u4f5c\u7684\u7edf\u8ba1\u3002\u6700\u540e\u4e00\u5217 <code>SUM_NUMBER_OF_BYTES_READ</code> \u7edf\u8ba1\u7684\u662f\uff0c\u603b\u5171\u4ece redo log \u91cc\u8bfb\u4e86\u591a\u5c11\u4e2a\u5b57\u8282\u3002</p>\n<p>\u7b2c\u4e09\u7ec4\u516d\u5217\uff0c\u7edf\u8ba1\u7684\u662f\u5199\u64cd\u4f5c\u3002</p>\n<p>\u6700\u540e\u7684\u7b2c\u56db\u7ec4\u6570\u636e\uff0c\u662f\u5bf9\u5176\u4ed6\u7c7b\u578b\u6570\u636e\u7684\u7edf\u8ba1\u3002\u5728 redo log \u91cc\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u4eec\u5c31\u662f\u5bf9 fsync \u7684\u7edf\u8ba1\u3002</p>\n<p>\u5728 <code>performance_schema</code> \u5e93\u7684 <code>file_summary_by_event_name</code> \u8868\u91cc\uff0cbinlog \u5bf9\u5e94\u7684\u662f <code>event_name = 'wait/io/file/sql/binlog'</code>\u8fd9\u4e00\u884c\u3002\u5404\u4e2a\u5b57\u6bb5\u7684\u7edf\u8ba1\u903b\u8f91\uff0c\u4e0e redo log \u7684\u5404\u4e2a\u5b57\u6bb5\u5b8c\u5168\u76f8\u540c\u3002\u8fd9\u91cc\uff0c\u6211\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p>\n<p>\u56e0\u4e3a\u6211\u4eec\u6bcf\u4e00\u6b21\u64cd\u4f5c\u6570\u636e\u5e93\uff0c<code>performance_schema</code> \u90fd\u9700\u8981\u989d\u5916\u5730\u7edf\u8ba1\u8fd9\u4e9b\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u6253\u5f00\u8fd9\u4e2a\u7edf\u8ba1\u529f\u80fd\u662f\u6709\u6027\u80fd\u635f\u8017\u7684\u3002</p>\n<p>\u6211\u7684\u6d4b\u8bd5\u7ed3\u679c\u662f\uff0c\u5982\u679c\u6253\u5f00\u6240\u6709\u7684 <code>performance_schema</code> \u9879\uff0c\u6027\u80fd\u5927\u6982\u4f1a\u4e0b\u964d 10% \u5de6\u53f3\u3002\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u4f60\u53ea\u6253\u5f00\u81ea\u5df1\u9700\u8981\u7684\u9879\u8fdb\u884c\u7edf\u8ba1\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u65b9\u6cd5\u6253\u5f00\u6216\u8005\u5173\u95ed\u67d0\u4e2a\u5177\u4f53\u9879\u7684\u7edf\u8ba1\u3002</p>\n<p>\u5982\u679c\u8981\u6253\u5f00 redo log \u7684\u65f6\u95f4\u76d1\u63a7\uff0c\u4f60\u53ef\u4ee5\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"n\">setup_instruments</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">ENABLED</span><span class=\"o\">=</span><span class=\"s1\">&#39;YES&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Timed</span><span class=\"o\">=</span><span class=\"s1\">&#39;YES&#39;</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"s1\">&#39;%wait/io/file/innodb/innodb_log_file%&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5047\u8bbe\uff0c\u73b0\u5728\u4f60\u5df2\u7ecf\u5f00\u542f\u4e86 redo log \u548c binlog \u8fd9\u4e24\u4e2a\u7edf\u8ba1\u4fe1\u606f\uff0c\u90a3\u8981\u600e\u4e48\u628a\u8fd9\u4e2a\u4fe1\u606f\u7528\u5728\u5b9e\u4f8b\u72b6\u6001\u8bca\u65ad\u4e0a\u5462\uff1f</p>\n<p>\u5f88\u7b80\u5355\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 MAX_TIMER \u7684\u503c\u6765\u5224\u65ad\u6570\u636e\u5e93\u662f\u5426\u51fa\u95ee\u9898\u4e86\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u8bbe\u5b9a\u9608\u503c\uff0c\u5355\u6b21 IO \u8bf7\u6c42\u65f6\u95f4\u8d85\u8fc7 200 \u6beb\u79d2\u5c5e\u4e8e\u5f02\u5e38\uff0c\u7136\u540e\u4f7f\u7528\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\u4f5c\u4e3a\u68c0\u6d4b\u903b\u8f91\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">event_name</span><span class=\"p\">,</span><span class=\"n\">MAX_TIMER_WAIT</span><span class=\"w\">  </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">performance_schema</span><span class=\"p\">.</span><span class=\"n\">file_summary_by_event_name</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">event_name</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s1\">&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class=\"p\">,</span><span class=\"s1\">&#39;wait/io/file/sql/binlog&#39;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">MAX_TIMER_WAIT</span><span class=\"o\">&gt;</span><span class=\"mi\">200</span><span class=\"o\">*</span><span class=\"mi\">1000000000</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u53d1\u73b0\u5f02\u5e38\u540e\uff0c\u53d6\u5230\u4f60\u9700\u8981\u7684\u4fe1\u606f\uff0c\u518d\u901a\u8fc7\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">truncate</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">performance_schema</span><span class=\"p\">.</span><span class=\"n\">file_summary_by_event_name</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u628a\u4e4b\u524d\u7684\u7edf\u8ba1\u4fe1\u606f\u6e05\u7a7a\u3002\u8fd9\u6837\u5982\u679c\u540e\u9762\u7684\u76d1\u63a7\u4e2d\uff0c\u518d\u6b21\u51fa\u73b0\u8fd9\u4e2a\u5f02\u5e38\uff0c\u5c31\u53ef\u4ee5\u52a0\u5165\u76d1\u63a7\u7d2f\u79ef\u503c\u4e86\u3002</p>\n<h3 id=\"_34\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_34\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u68c0\u6d4b\u4e00\u4e2a MySQL \u5b9e\u4f8b\u5065\u5eb7\u72b6\u6001\u7684\u51e0\u79cd\u65b9\u6cd5\uff0c\u4ee5\u53ca\u5404\u79cd\u65b9\u6cd5\u5b58\u5728\u7684\u95ee\u9898\u548c\u6f14\u8fdb\u7684\u903b\u8f91\u3002</p>\n<p>\u4f60\u770b\u5b8c\u540e\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0cselect 1 \u8fd9\u6837\u7684\u65b9\u6cd5\u662f\u4e0d\u662f\u5df2\u7ecf\u88ab\u6dd8\u6c70\u4e86\u5462\uff0c\u4f46\u5b9e\u9645\u4e0a\u4f7f\u7528\u975e\u5e38\u5e7f\u6cdb\u7684 MHA\uff08Master High Availability\uff09\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u65b9\u6cd5\u3002</p>\n<p>MHA \u4e2d\u7684\u53e6\u4e00\u4e2a\u53ef\u9009\u65b9\u6cd5\u662f\u53ea\u505a\u8fde\u63a5\uff0c\u5c31\u662f \u201c\u5982\u679c\u8fde\u63a5\u6210\u529f\u5c31\u8ba4\u4e3a\u4e3b\u5e93\u6ca1\u95ee\u9898\u201d\u3002\u4e0d\u8fc7\u636e\u6211\u6240\u77e5\uff0c\u9009\u62e9\u8fd9\u4e2a\u65b9\u6cd5\u7684\u5f88\u5c11\u3002</p>\n<p>\u5176\u5b9e\uff0c\u6bcf\u4e2a\u6539\u8fdb\u7684\u65b9\u6848\uff0c\u90fd\u4f1a\u589e\u52a0\u989d\u5916\u635f\u8017\uff0c\u5e76\u4e0d\u80fd\u7528\u201c\u5bf9\u9519\u201d\u505a\u76f4\u63a5\u5224\u65ad\uff0c\u9700\u8981\u4f60\u6839\u636e\u4e1a\u52a1\u5b9e\u9645\u60c5\u51b5\u53bb\u505a\u6743\u8861\u3002</p>\n<p>\u6211\u4e2a\u4eba\u6bd4\u8f83\u503e\u5411\u7684\u65b9\u6848\uff0c\u662f\u4f18\u5148\u8003\u8651 update \u7cfb\u7edf\u8868\uff0c\u7136\u540e\u518d\u914d\u5408\u589e\u52a0\u68c0\u6d4b <code>performance_schema</code> \u7684\u4fe1\u606f\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["mysql", "tuning"]}, {"id": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-4/", "url": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-4/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u56db\u90e8\u5206", "content_html": "<h1 id=\"mysql-45\">\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u56db\u90e8\u5206<a class=\"headerlink\" href=\"#mysql-45\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md\" title=\"Permalink to MySQL\u5b9e\u621845\u8bb2.md\">Source</a></p>\n<p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u56db\u90e8\u5206</p>\n<h2 id=\"30\">30 \u7b54\u7591\u6587\u7ae0\uff08\u4e8c\uff09\uff1a\u7528\u52a8\u6001\u7684\u89c2\u70b9\u770b\u52a0\u9501<a class=\"headerlink\" href=\"#30\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u7684\u6587\u7ae0\u4ecb\u7ecd\u4e86 InnoDB \u7684\u95f4\u9699\u9501\u3001next-key lock\uff0c\u4ee5\u53ca\u52a0\u9501\u89c4\u5219\u3002\u5728\u8fd9\u4e24\u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\uff0c\u51fa\u73b0\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u7559\u8a00\u3002\u6211\u89c9\u5f97\u901a\u8fc7\u5206\u6790\u8fd9\u4e9b\u95ee\u9898\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u52a0\u6df1\u5bf9\u52a0\u9501\u89c4\u5219\u7684\u7406\u89e3\u3002</p>\n<p>\u6240\u4ee5\uff0c\u6211\u5c31\u4ece\u4e2d\u6311\u9009\u4e86\u51e0\u4e2a\u6709\u4ee3\u8868\u6027\u7684\u95ee\u9898\uff0c\u6784\u6210\u4e86\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u7684\u4e3b\u9898\uff0c\u5373\uff1a\u7528\u52a8\u6001\u7684\u89c2\u70b9\u770b\u52a0\u9501\u3002</p>\n<p><strong>\u4e3a\u4e86\u65b9\u4fbf\u4f60\u7406\u89e3\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u590d\u4e60\u4e00\u4e0b\u52a0\u9501\u89c4\u5219\u3002\u8fd9\u4e2a\u89c4\u5219\u4e2d\uff0c\u5305\u542b\u4e86\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\uff1a</strong></p>\n<ul>\n<li>\u539f\u5219 1\uff1a\u52a0\u9501\u7684\u57fa\u672c\u5355\u4f4d\u662f next-key lock\u3002\u5e0c\u671b\u4f60\u8fd8\u8bb0\u5f97\uff0cnext-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</li>\n<li>\u539f\u5219 2\uff1a\u67e5\u627e\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501\u3002</li>\n<li>\u4f18\u5316 1\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u7ed9\u552f\u4e00\u7d22\u5f15\u52a0\u9501\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u884c\u9501\u3002</li>\n<li>\u4f18\u5316 2\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u65f6\u4e14\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3\u7b49\u503c\u6761\u4ef6\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u95f4\u9699\u9501\u3002</li>\n<li>\u4e00\u4e2a bug\uff1a\u552f\u4e00\u7d22\u5f15\u4e0a\u7684\u8303\u56f4\u67e5\u8be2\u4f1a\u8bbf\u95ee\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u503c\u4e3a\u6b62\u3002</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7684\u8ba8\u8bba\u8fd8\u662f\u57fa\u4e8e\u4e0b\u9762\u8fd9\u4e2a\u8868 t\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">),(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">),(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">),(</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"mi\">15</span><span class=\"p\">),(</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">),(</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"mi\">25</span><span class=\"p\">);</span>\n</code></pre></div>\n<h3 id=\"_1\">\u4e0d\u7b49\u53f7\u6761\u4ef6\u91cc\u7684\u7b49\u503c\u67e5\u8be2<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6709\u540c\u5b66\u5bf9\u201c\u7b49\u503c\u67e5\u8be2\u201d\u63d0\u51fa\u4e86\u7591\u95ee\uff1a\u7b49\u503c\u67e5\u8be2\u548c\u201c\u904d\u5386\u201d\u6709\u4ec0\u4e48\u533a\u522b\uff1f\u4e3a\u4ec0\u4e48\u6211\u4eec\u6587\u7ae0\u7684\u4f8b\u5b50\u91cc\u9762\uff0cwhere \u6761\u4ef6\u662f\u4e0d\u7b49\u53f7\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u91cc\u4e5f\u6709\u7b49\u503c\u67e5\u8be2\uff1f</p>\n<p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5206\u6790\u4e00\u4e0b\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&gt;</span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&lt;</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5229\u7528\u4e0a\u9762\u7684\u52a0\u9501\u89c4\u5219\uff0c\u6211\u4eec\u77e5\u9053\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u662f\u4e3b\u952e\u7d22\u5f15\u4e0a\u7684 (0,5]\u3001(5,10] \u548c (10, 15)\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cid=15 \u8fd9\u4e00\u884c\uff0c\u5e76\u6ca1\u6709\u88ab\u52a0\u4e0a\u884c\u9501\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u6211\u4eec\u8bf4\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0c\u90fd\u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\uff0c\u4f46\u662f\u8fd9\u91cc\u7528\u5230\u4e86\u4f18\u5316 2\uff0c\u5373\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u7684\u65f6\u5019 id=15 \u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u6240\u4ee5 next-key lock \u9000\u5316\u4e3a\u4e86\u95f4\u9699\u9501 (10, 15)\u3002</p>\n<p>\u4f46\u662f\uff0c\u6211\u4eec\u7684\u67e5\u8be2\u8bed\u53e5\u4e2d where \u6761\u4ef6\u662f\u5927\u4e8e\u53f7\u548c\u5c0f\u4e8e\u53f7\uff0c\u8fd9\u91cc\u7684\u201c\u7b49\u503c\u67e5\u8be2\u201d\u53c8\u662f\u4ece\u54ea\u91cc\u6765\u7684\u5462\uff1f</p>\n<p>\u8981\u77e5\u9053\uff0c\u52a0\u9501\u52a8\u4f5c\u662f\u53d1\u751f\u5728\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\uff0c\u6240\u4ee5\u4f60\u5728\u5206\u6790\u52a0\u9501\u884c\u4e3a\u7684\u65f6\u5019\uff0c\u8981\u4ece\u7d22\u5f15\u4e0a\u7684\u6570\u636e\u7ed3\u6784\u5f00\u59cb\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u628a\u8fd9\u4e2a\u8fc7\u7a0b\u62c6\u89e3\u4e00\u4e0b\u3002</p>\n<p>\u5982\u56fe 1 \u6240\u793a\uff0c\u662f\u8fd9\u4e2a\u8868\u7684\u7d22\u5f15 id \u7684\u793a\u610f\u56fe\u3002</p>\n<table>\n<thead>\n<tr>\n<th>(0,0,0)</th>\n<th>(5,5,5)</th>\n<th>(10,10,10)</th>\n<th>(15,15,15)</th>\n<th>(20,20,20)</th>\n<th>(25,25,25)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<ol>\n<li>\u9996\u5148\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u8bed\u4e49\u662f order by id desc\uff0c\u8981\u62ff\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u6240\u6709\u884c\uff0c\u4f18\u5316\u5668\u5fc5\u987b\u5148\u627e\u5230\u201c\u7b2c\u4e00\u4e2a id\\&lt;12 \u7684\u503c\u201d\u3002</li>\n<li>\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u901a\u8fc7\u7d22\u5f15\u6811\u7684\u641c\u7d22\u8fc7\u7a0b\u5f97\u5230\u7684\uff0c\u5728\u5f15\u64ce\u5185\u90e8\uff0c\u5176\u5b9e\u662f\u8981\u627e\u5230 id=12 \u7684\u8fd9\u4e2a\u503c\uff0c\u53ea\u662f\u6700\u7ec8\u6ca1\u627e\u5230\uff0c\u4f46\u627e\u5230\u4e86 (10,15) \u8fd9\u4e2a\u95f4\u9699\u3002</li>\n<li>\u7136\u540e\u5411\u5de6\u904d\u5386\uff0c\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u4e0d\u662f\u7b49\u503c\u67e5\u8be2\u4e86\uff0c\u4f1a\u626b\u63cf\u5230 id=5 \u8fd9\u4e00\u884c\uff0c\u6240\u4ee5\u4f1a\u52a0\u4e00\u4e2a next-key lock (0,5]\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7\u6811\u641c\u7d22\u7684\u65b9\u5f0f\u5b9a\u4f4d\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u201c\u7b49\u503c\u67e5\u8be2\u201d\u7684\u65b9\u6cd5\u3002</p>\n<h3 id=\"_2\">\u7b49\u503c\u67e5\u8be2\u7684\u8fc7\u7a0b<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0e\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u5e94\u7684\uff0c\u662f @\u53d1\u6761\u6a59\u5b50\u540c\u5b66\u63d0\u51fa\u7684\u95ee\u9898\uff1a\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u662f\u4ec0\u4e48\uff1f</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u91cc\u7528\u7684\u662f in\uff0c\u6211\u4eec\u5148\u6765\u770b\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6761 in \u8bed\u53e5\u4f7f\u7528\u4e86\u7d22\u5f15 c \u5e76\u4e14 rows=3\uff0c\u8bf4\u660e\u8fd9\u4e09\u4e2a\u503c\u90fd\u662f\u901a\u8fc7 B+ \u6811\u641c\u7d22\u5b9a\u4f4d\u7684\u3002</p>\n<p>\u5728\u67e5\u627e c=5 \u7684\u65f6\u5019\uff0c\u5148\u9501\u4f4f\u4e86 (0,5]\u3002\u4f46\u662f\u56e0\u4e3a c \u4e0d\u662f\u552f\u4e00\u7d22\u5f15\uff0c\u4e3a\u4e86\u786e\u8ba4\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u8bb0\u5f55 c=5\uff0c\u5c31\u8981\u5411\u53f3\u904d\u5386\uff0c\u627e\u5230 c=10 \u624d\u786e\u8ba4\u6ca1\u6709\u4e86\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6ee1\u8db3\u4f18\u5316 2\uff0c\u6240\u4ee5\u52a0\u4e86\u95f4\u9699\u9501 (5,10)\u3002</p>\n<p>\u540c\u6837\u7684\uff0c\u6267\u884c c=10 \u8fd9\u4e2a\u903b\u8f91\u7684\u65f6\u5019\uff0c\u52a0\u9501\u7684\u8303\u56f4\u662f (5,10] \u548c (10,15)\uff1b\u6267\u884c c=20 \u8fd9\u4e2a\u903b\u8f91\u7684\u65f6\u5019\uff0c\u52a0\u9501\u7684\u8303\u56f4\u662f (15,20] \u548c (20,25)\u3002</p>\n<p>\u901a\u8fc7\u8fd9\u4e2a\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u6761\u8bed\u53e5\u5728\u7d22\u5f15 c \u4e0a\u52a0\u7684\u4e09\u4e2a\u8bb0\u5f55\u9501\u7684\u987a\u5e8f\u662f\uff1a\u5148\u52a0 c=5 \u7684\u8bb0\u5f55\u9501\uff0c\u518d\u52a0 c=10 \u7684\u8bb0\u5f55\u9501\uff0c\u6700\u540e\u52a0 c=20 \u7684\u8bb0\u5f55\u9501\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u52a0\u9501\u8303\u56f4\uff0c\u4e0d\u5c31\u662f\u4ece (5,25) \u4e2d\u53bb\u6389 c=15 \u7684\u884c\u9501\u5417\uff1f\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u9ebb\u70e6\u5730\u5206\u6bb5\u8bf4\u5462\uff1f</p>\n<p>\u56e0\u4e3a\u6211\u8981\u8ddf\u4f60\u5f3a\u8c03\u8fd9\u4e2a\u8fc7\u7a0b\uff1a\u8fd9\u4e9b\u9501\u662f\u201c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e00\u4e2a\u4e00\u4e2a\u52a0\u7684\u201d\uff0c\u800c\u4e0d\u662f\u4e00\u6b21\u6027\u52a0\u4e0a\u53bb\u7684\u3002</p>\n<p>\u7406\u89e3\u4e86\u8fd9\u4e2a\u52a0\u9501\u8fc7\u7a0b\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u5206\u6790\u4e0b\u9762\u4f8b\u5b50\u4e2d\u7684\u6b7b\u9501\u95ee\u9898\u4e86\u3002</p>\n<p>\u5982\u679c\u540c\u65f6\u6709\u53e6\u5916\u4e00\u4e2a\u8bed\u53e5\uff0c\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6b64\u65f6\u7684\u52a0\u9501\u8303\u56f4\uff0c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u6211\u4eec\u73b0\u5728\u90fd\u77e5\u9053\u95f4\u9699\u9501\u662f\u4e0d\u4e92\u9501\u7684\uff0c\u4f46\u662f\u8fd9\u4e24\u6761\u8bed\u53e5\u90fd\u4f1a\u5728\u7d22\u5f15 c \u4e0a\u7684 c=5\u300110\u300120 \u8fd9\u4e09\u884c\u8bb0\u5f55\u4e0a\u52a0\u8bb0\u5f55\u9501\u3002</p>\n<p>\u8fd9\u91cc\u4f60\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\uff0c\u7531\u4e8e\u8bed\u53e5\u91cc\u9762\u662f order by c desc\uff0c \u8fd9\u4e09\u4e2a\u8bb0\u5f55\u9501\u7684\u52a0\u9501\u987a\u5e8f\uff0c\u662f\u5148\u9501 c=20\uff0c\u7136\u540e c=10\uff0c\u6700\u540e\u662f c=5\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u6761\u8bed\u53e5\u8981\u52a0\u9501\u76f8\u540c\u7684\u8d44\u6e90\uff0c\u4f46\u662f\u52a0\u9501\u987a\u5e8f\u76f8\u53cd\u3002\u5f53\u8fd9\u4e24\u6761\u8bed\u53e5\u5e76\u53d1\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u6b7b\u9501\u3002</p>\n<p>\u5173\u4e8e\u6b7b\u9501\u7684\u4fe1\u606f\uff0cMySQL \u53ea\u4fdd\u7559\u4e86\u6700\u540e\u4e00\u4e2a\u6b7b\u9501\u7684\u73b0\u573a\uff0c\u4f46\u8fd9\u4e2a\u73b0\u573a\u8fd8\u662f\u4e0d\u5b8c\u5907\u7684\u3002</p>\n<p>\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u7559\u8a00\u5230\uff0c\u5e0c\u671b\u6211\u80fd\u5c55\u5f00\u4e00\u4e0b\u600e\u4e48\u770b\u6b7b\u9501\u3002\u73b0\u5728\uff0c\u6211\u5c31\u6765\u7b80\u5355\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u7684\u6b7b\u9501\u73b0\u573a\u3002</p>\n<h3 id=\"_3\">\u600e\u4e48\u770b\u6b7b\u9501\uff1f<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ee5\u4e0b \u662f\u5728\u51fa\u73b0\u6b7b\u9501\u540e\uff0c\u6267\u884c <code>show engine innodb status</code> \u547d\u4ee4\u5f97\u5230\u7684\u90e8\u5206\u8f93\u51fa\u3002\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u8f93\u51fa\u5f88\u591a\u4fe1\u606f\uff0c\u6709\u4e00\u8282 <code>LATESTDETECTED DEADLOCK</code>\uff0c\u5c31\u662f\u8bb0\u5f55\u7684\u6700\u540e\u4e00\u6b21\u6b7b\u9501\u4fe1\u606f\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"mi\">2019</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"p\">:</span><span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7feb98d47700</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">TRANSACTION</span><span class=\"p\">:</span>\n<span class=\"k\">TRANSACTION</span><span class=\"w\"> </span><span class=\"mi\">422127109356256</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ACTIVE</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">read</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">locked</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"k\">LOCK</span><span class=\"w\"> </span><span class=\"n\">WAIT</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"mi\">1136</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span>\n<span class=\"n\">MySQL</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">98</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"mi\">140649857836800</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">119190</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"mi\">127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"k\">data</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">share</span><span class=\"w\"> </span><span class=\"k\">mode</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">WAITING</span><span class=\"w\"> </span><span class=\"k\">FOR</span><span class=\"w\"> </span><span class=\"n\">THIS</span><span class=\"w\"> </span><span class=\"k\">LOCK</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span><span class=\"n\">BE</span><span class=\"w\"> </span><span class=\"k\">GRANTED</span><span class=\"p\">:</span>\n<span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"n\">LOCKS</span><span class=\"w\"> </span><span class=\"k\">space</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">trx</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">422127109356256</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"k\">mode</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">waiting</span>\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">_fields</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span>\n<span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n<span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">TRANSACTION</span><span class=\"p\">:</span>\n<span class=\"k\">TRANSACTION</span><span class=\"w\"> </span><span class=\"mi\">1315</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ACTIVE</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">read</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">locked</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"mi\">1136</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span>\n<span class=\"n\">MySQL</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"mi\">140649858103040</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">119189</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"mi\">127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"k\">data</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">20</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">HOLDS</span><span class=\"w\"> </span><span class=\"n\">THE</span><span class=\"w\"> </span><span class=\"k\">LOCK</span><span class=\"p\">(</span><span class=\"n\">S</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">:</span>\n<span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"n\">LOCKS</span><span class=\"w\"> </span><span class=\"k\">space</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">trx</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1315</span><span class=\"w\"> </span><span class=\"n\">lock_mode</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">_fields</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">    </span><span class=\"p\">;;</span>\n<span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">    </span><span class=\"p\">;;</span>\n\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">_fields</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">00000014</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">   </span><span class=\"p\">;;</span>\n<span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">00000014</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">   </span><span class=\"p\">;;</span>\n\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">WAITING</span><span class=\"w\"> </span><span class=\"k\">FOR</span><span class=\"w\"> </span><span class=\"n\">THIS</span><span class=\"w\"> </span><span class=\"k\">LOCK</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span><span class=\"n\">BE</span><span class=\"w\"> </span><span class=\"k\">GRANTED</span><span class=\"p\">:</span>\n<span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"n\">LOCKS</span><span class=\"w\"> </span><span class=\"k\">space</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">trx</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1315</span><span class=\"w\"> </span><span class=\"n\">lock_mode</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">waiting</span>\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">_fields</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">00000005</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">   </span><span class=\"p\">;;</span>\n<span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">00000005</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">   </span><span class=\"p\">;;</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"n\">WE</span><span class=\"w\"> </span><span class=\"n\">ROLL</span><span class=\"w\"> </span><span class=\"n\">BACK</span><span class=\"w\"> </span><span class=\"k\">TRANSACTION</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u6211\u4eec\u6765\u770b\u770b\u8fd9\u56fe\u4e2d\u7684\u51e0\u4e2a\u5173\u952e\u4fe1\u606f\u3002</p>\n<ol>\n<li>\u8fd9\u4e2a\u7ed3\u679c\u5206\u6210\u4e09\u90e8\u5206\uff1a </li>\n<li><code>(1) TRANSACTION</code>\uff0c\u662f\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\uff1b</li>\n<li><code>(2) TRANSACTION</code>\uff0c\u662f\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\uff1b</li>\n<li><code>WE ROLL BACK TRANSACTION (1)</code>\uff0c\u662f\u6700\u7ec8\u7684\u5904\u7406\u7ed3\u679c\uff0c\u8868\u793a\u56de\u6eda\u4e86\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u3002</li>\n<li>\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\u4e2d\uff1a </li>\n<li>WAITING FOR THIS LOCK TO BE GRANTED\uff0c\u8868\u793a\u7684\u662f\u8fd9\u4e2a\u4e8b\u52a1\u5728\u7b49\u5f85\u7684\u9501\u4fe1\u606f\uff1b</li>\n<li>index c of table <code>test</code>.<code>t</code>\uff0c\u8bf4\u660e\u5728\u7b49\u7684\u662f\u8868 t \u4e0a\u7d22\u5f15c\u7684\u9501\uff1b</li>\n<li>lock mode S waiting \u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u8981\u81ea\u5df1\u52a0\u4e00\u4e2a\u8bfb\u9501\uff0c\u5f53\u524d\u7684\u72b6\u6001\u662f\u7b49\u5f85\u4e2d\uff1b</li>\n<li>Record lock \u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a\u8bb0\u5f55\u9501\uff1b</li>\n<li>n_fields 2 \u8868\u793a\u8fd9\u4e2a\u8bb0\u5f55\u662f2\u5217\uff0c\u4e5f\u5c31\u662f\u5b57\u6bb5 c \u548c\u4e3b\u952e\u5b57\u6bb5 id\uff1b</li>\n<li><code>0: len 4; hex 0000000a; asc ;;</code> \u662f\u7b2c\u4e00\u4e2a\u5b57\u6bb5\uff0c\u4e5f\u5c31\u662f c\u3002\u503c\u662f\u5341\u516d\u8fdb\u5236 a\uff0c\u4e5f\u5c31\u662f 10\uff1b</li>\n<li><code>1: len 4; hex 0000000a; asc ;;</code> \u662f\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\uff0c\u4e5f\u5c31\u662f\u4e3b\u952e id\uff0c\u503c\u4e5f\u662f 10\uff1b</li>\n<li>\u8fd9\u4e24\u884c\u91cc\u9762\u7684 asc \u8868\u793a\u7684\u662f\uff0c\u63a5\u4e0b\u6765\u8981\u6253\u5370\u51fa\u503c\u91cc\u9762\u7684\u201c\u53ef\u6253\u5370\u5b57\u7b26\u201d\uff0c\u4f46 10 \u4e0d\u662f\u53ef\u6253\u5370\u5b57\u7b26\uff0c\u56e0\u6b64\u5c31\u663e\u793a\u7a7a\u683c\u3002</li>\n<li>\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u4fe1\u606f\u5c31\u53ea\u663e\u793a\u51fa\u4e86\u7b49\u9501\u7684\u72b6\u6001\uff0c\u5728\u7b49\u5f85 <code>(c=10,id=10)</code> \u8fd9\u4e00\u884c\u7684\u9501\u3002</li>\n<li>\u5f53\u7136\u4f60\u662f\u77e5\u9053\u7684\uff0c\u65e2\u7136\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u4e5f\u5360\u6709\u522b\u7684\u9501\uff0c\u4f46\u662f\u6ca1\u6709\u663e\u793a\u51fa\u6765\u3002\u522b\u7740\u6025\uff0c\u6211\u4eec\u4ece\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\u4e2d\u63a8\u5bfc\u51fa\u6765\u3002</li>\n<li>\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u663e\u793a\u7684\u4fe1\u606f\u8981\u591a\u4e00\u4e9b\uff1a </li>\n<li>HOLDS THE LOCK(S) \u7528\u6765\u663e\u793a\u8fd9\u4e2a\u4e8b\u52a1\u6301\u6709\u54ea\u4e9b\u9501\uff1b</li>\n<li>index c of table <code>test</code>.<code>t</code> \u8868\u793a\u9501\u662f\u5728\u8868 t \u7684\u7d22\u5f15 c \u4e0a\uff1b</li>\n<li>hex 0000000a \u548c hex 00000014 \u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u6301\u6709 c=10 \u548c c=20 \u8fd9\u4e24\u4e2a\u8bb0\u5f55\u9501\uff1b</li>\n<li>WAITING FOR THIS LOCK TO BE GRANTED\uff0c\u8868\u793a\u5728\u7b49 <code>(c=5,id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u9501\u3002</li>\n</ol>\n<p>\u4ece\u4e0a\u9762\u8fd9\u4e9b\u4fe1\u606f\u4e2d\uff0c\u6211\u4eec\u5c31\u77e5\u9053\uff1a</p>\n<ol>\n<li><code>lock in share mode</code> \u7684\u8fd9\u6761\u8bed\u53e5\uff0c\u6301\u6709 c=5 \u7684\u8bb0\u5f55\u9501\uff0c\u5728\u7b49 c=10 \u7684\u9501\uff1b</li>\n<li><code>for update</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u6301\u6709 c=20 \u548c c=10 \u7684\u8bb0\u5f55\u9501\uff0c\u5728\u7b49 c=5 \u7684\u8bb0\u5f55\u9501\u3002</li>\n</ol>\n<p>\u56e0\u6b64\u5bfc\u81f4\u4e86\u6b7b\u9501\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a\u7ed3\u8bba\uff1a</p>\n<ol>\n<li>\u7531\u4e8e\u9501\u662f\u4e00\u4e2a\u4e2a\u52a0\u7684\uff0c\u8981\u907f\u514d\u6b7b\u9501\uff0c\u5bf9\u540c\u4e00\u7ec4\u8d44\u6e90\uff0c\u8981\u6309\u7167\u5c3d\u91cf\u76f8\u540c\u7684\u987a\u5e8f\u8bbf\u95ee\uff1b</li>\n<li>\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u523b\uff0cfor update \u8fd9\u6761\u8bed\u53e5\u5360\u6709\u7684\u8d44\u6e90\u66f4\u591a\uff0c\u56de\u6eda\u6210\u672c\u66f4\u5927\uff0c\u6240\u4ee5 InnoDB \u9009\u62e9\u4e86\u56de\u6eda\u6210\u672c\u66f4\u5c0f\u7684 lock in share mode \u8bed\u53e5\uff0c\u6765\u56de\u6eda\u3002</li>\n</ol>\n<h3 id=\"_4\">\u600e\u4e48\u770b\u9501\u7b49\u5f85\uff1f<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u770b\u5b8c\u6b7b\u9501\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u9501\u7b49\u5f85\u7684\u4f8b\u5b50\u3002</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\nSessionA -&gt;&gt; Table: begin\nSessionA -&gt;&gt; Table: select * from t where id&gt;10 and id&lt;=15 for update\nSessionB -&gt;&gt;+ Table: delete from t where id=10\nTable --&gt;&gt;-SessionB: Query OK\nSessionB -&gt;&gt;+ Table: insert into t values(10,10,10)\nTable --&gt;&gt;- SessionB: (blocked)</code></pre>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e session A \u5e76\u6ca1\u6709\u9501\u4f4f c=10 \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u6240\u4ee5 session B \u5220\u9664 id=10 \u8fd9\u4e00\u884c\u662f\u53ef\u4ee5\u7684\u3002\u4f46\u662f\u4e4b\u540e\uff0csession B \u518d\u60f3 insert id=10 \u8fd9\u4e00\u884c\u56de\u53bb\u5c31\u4e0d\u884c\u4e86\u3002</p>\n<p>\u73b0\u5728\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u6b64\u65f6 <code>show engine innodb status</code> \u7684\u7ed3\u679c\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u7ed9\u6211\u4eec\u4e00\u4e9b\u63d0\u793a\u3002\u9501\u4fe1\u606f\u662f\u5728\u8fd9\u4e2a\u547d\u4ee4\u8f93\u51fa\u7ed3\u679c\u7684 TRANSACTIONS \u8fd9\u4e00\u8282\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"c1\">---TRANSACTION 1311, ACTIVE 4 sec inserting</span>\n<span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">locked</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"k\">LOCK</span><span class=\"w\"> </span><span class=\"n\">WAIT</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"mi\">1136</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span>\n<span class=\"n\">MySQL</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"mi\">140504341464832</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">20700</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"mi\">127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">)</span>\n<span class=\"c1\">------ TX HAS BEEN WAITING 4 SEC FOR THIS LOCK TO BE GRANTED:</span>\n<span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"n\">LOCKS</span><span class=\"w\"> </span><span class=\"k\">space</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"s1\">&#39;test&#39;</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"s1\">&#39;t&#39;</span><span class=\"w\"> </span><span class=\"n\">trx</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">1311</span><span class=\"w\"> </span><span class=\"n\">lock_mode</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">locks</span><span class=\"w\"> </span><span class=\"n\">gap</span><span class=\"w\"> </span><span class=\"k\">before</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"n\">intention</span><span class=\"w\"> </span><span class=\"n\">waiting</span>\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">_fields</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"n\">o</span>\n<span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">f</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n<span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"n\">en</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">000000000513</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n<span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hey</span><span class=\"w\"> </span><span class=\"n\">b0000001250134</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;;</span>\n<span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">hey</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">f</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n<span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">hey</span><span class=\"w\"> </span><span class=\"mi\">0000000</span><span class=\"n\">f</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\">     </span><span class=\"p\">;;</span>\n</code></pre></div>\n<p>\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u5173\u952e\u4fe1\u606f\u3002</p>\n<ol>\n<li>index PRIMARY of table <code>test</code>.<code>t</code> \uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u88ab\u9501\u4f4f\u662f\u56e0\u4e3a\u8868 t \u4e3b\u952e\u4e0a\u7684\u67d0\u4e2a\u9501\u3002</li>\n<li><code>lock_mode X locks gap before rec insert intention waiting</code> \u8fd9\u91cc\u6709\u51e0\u4e2a\u4fe1\u606f\uff1a </li>\n<li><code>insert intention</code> \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u51c6\u5907\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55\uff0c\u8fd9\u662f\u4e00\u4e2a\u63d2\u5165\u610f\u5411\u9501\u3002\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u5c31\u662f\u8fd9\u4e2a\u63d2\u5165\u52a8\u4f5c\u672c\u8eab\u3002</li>\n<li><code>gap before rec</code> \u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u95f4\u9699\u9501\uff0c\u800c\u4e0d\u662f\u8bb0\u5f55\u9501\u3002</li>\n<li>\u90a3\u4e48\u8fd9\u4e2a gap \u662f\u5728\u54ea\u4e2a\u8bb0\u5f55\u4e4b\u524d\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u7684 0~4 \u8fd9 5 \u884c\u7684\u5185\u5bb9\u5c31\u662f\u8fd9\u4e2a\u8bb0\u5f55\u7684\u4fe1\u606f\u3002</li>\n<li><code>n_fields 5</code> \u4e5f\u8868\u793a\u4e86\uff0c\u8fd9\u4e00\u4e2a\u8bb0\u5f55\u6709 5 \u5217\uff1a </li>\n<li><code>0: len 4; hex 0000000f; asc ;;</code> \u7b2c\u4e00\u5217\u662f\u4e3b\u952e id \u5b57\u6bb5\uff0c\u5341\u516d\u8fdb\u5236 f \u5c31\u662f id=15\u3002\u6240\u4ee5\uff0c\u8fd9\u65f6\u6211\u4eec\u5c31\u77e5\u9053\u4e86\uff0c\u8fd9\u4e2a\u95f4\u9699\u5c31\u662f id=15 \u4e4b\u524d\u7684\uff0c\u56e0\u4e3a id=10 \u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86\uff0c\u5b83\u8868\u793a\u7684\u5c31\u662f <code>(5,15)</code>\u3002</li>\n<li><code>1: len 6; hex 0000008fb53; asc S;;</code> \u7b2c\u4e8c\u5217\u662f\u957f\u5ea6\u4e3a 6 \u5b57\u8282\u7684\u4e8b\u52a1 id\uff0c\u8868\u793a\u6700\u540e\u4fee\u6539\u8fd9\u4e00\u884c\u7684\u662f trx id \u4e3a 588627 \u7684\u4e8b\u52a1\u3002</li>\n<li><code>2: len 7; hex 82000002010137; asc  7;;</code> \u7b2c\u4e09\u5217\u957f\u5ea6\u4e3a 7 \u5b57\u8282\u7684\u56de\u6eda\u6bb5\u4fe1\u606f\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u7684 acs \u540e\u9762\u6709\u663e\u793a\u5185\u5bb9 (7)\uff0c\u8fd9\u662f\u56e0\u4e3a\u521a\u597d\u8fd9\u4e2a\u5b57\u8282\u662f\u53ef\u6253\u5370\u5b57\u7b26\u3002</li>\n<li>\u540e\u9762\u4e24\u5217\u662f c \u548c d \u7684\u503c\uff0c\u90fd\u662f 15\u3002</li>\n</ol>\n<p>\u56e0\u6b64\uff0c\u6211\u4eec\u5c31\u77e5\u9053\u4e86\uff0c\u7531\u4e8e delete \u64cd\u4f5c\u628a id=10 \u8fd9\u4e00\u884c\u5220\u6389\u4e86\uff0c\u539f\u6765\u7684\u4e24\u4e2a\u95f4\u9699 (5,10)\u3001(10,15\uff09\u53d8\u6210\u4e86\u4e00\u4e2a (5,15)\u3002</p>\n<p>\u8bf4\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u8054\u5408\u8d77\u6765\u518d\u601d\u8003\u4e00\u4e0b\u8fd9\u4e24\u4e2a\u73b0\u8c61\u4e4b\u95f4\u7684\u5173\u8054\uff1a</p>\n<ol>\n<li>session A \u6267\u884c\u5b8c select \u8bed\u53e5\u540e\uff0c\u4ec0\u4e48\u90fd\u6ca1\u505a\uff0c\u4f46\u5b83\u52a0\u9501\u7684\u8303\u56f4\u7a81\u7136\u201c\u53d8\u5927\u201d\u4e86\uff1b</li>\n<li>\u5f53\u6211\u4eec\u6267\u884c <code>select * from t where c&gt;=15 and c&lt;=20 order by c desc lock in share mode;</code> \u5411\u5de6\u626b\u63cf\u5230 c=10 \u7684\u65f6\u5019\uff0c\u8981\u628a (5, 10] \u9501\u8d77\u6765\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6240\u8c13\u201c\u95f4\u9699\u201d\uff0c\u5176\u5b9e\u6839\u672c\u5c31\u662f\u7531\u201c\u8fd9\u4e2a\u95f4\u9699\u53f3\u8fb9\u7684\u90a3\u4e2a\u8bb0\u5f55\u201d\u5b9a\u4e49\u7684\u3002</p>\n<h3 id=\"update\">update \u7684\u4f8b\u5b50<a class=\"headerlink\" href=\"#update\" title=\"Permanent link\">&para;</a></h3>\n<p>\u518d\u6765\u770b\u4e00\u4e2a update \u8bed\u53e5\u7684\u6848\u4f8b\u3002</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\n\nSessionA -&gt;&gt; Table: begin\nSessionA -&gt;&gt; Table: select c from t where c &gt; 5 lock in share mode\nSessionB -&gt;&gt;+ Table: update t set c = 1 where c = 5\nTable --&gt;&gt;- SessionB: Query OK\nSessionB -&gt;&gt;+ Table: update t set c = 5 where c = 1\nTable --&gt;&gt;- SessionB: blocked</code></pre>\n<p>\u4f60\u53ef\u4ee5\u81ea\u5df1\u5206\u6790\u4e00\u4e0b\uff0csession A \u7684\u52a0\u9501\u8303\u56f4\u662f\u7d22\u5f15 c \u4e0a\u7684 <code>(5,10]\u3001(10,15]\u3001(15,20]\u3001(20,25]</code> \u548c <code>(25,supremum]</code>\u3002</p>\n<blockquote>\n<p>\u6ce8\u610f\uff1a\u6839\u636e c&gt;5 \u67e5\u5230\u7684\u7b2c\u4e00\u4e2a\u8bb0\u5f55\u662f c=10\uff0c\u56e0\u6b64\u4e0d\u4f1a\u52a0 (0,5] \u8fd9\u4e2a next-key lock\u3002</p>\n</blockquote>\n<p>\u4e4b\u540e session B \u7684\u7b2c\u4e00\u4e2a update \u8bed\u53e5\uff0c\u8981\u628a c=5 \u6539\u6210 c=1\uff0c\u4f60\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e24\u6b65\uff1a</p>\n<ol>\n<li>\u63d2\u5165 <code>(c=1, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\uff1b</li>\n<li>\u5220\u9664 <code>(c=5, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u3002</li>\n</ol>\n<p>\u6309\u7167\u6211\u4eec\u4e0a\u4e00\u8282\u8bf4\u7684\uff0c\u7d22\u5f15 c \u4e0a (5,10) \u95f4\u9699\u662f\u7531\u8fd9\u4e2a\u95f4\u9699\u53f3\u8fb9\u7684\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f c=10 \u5b9a\u4e49\u7684\u3002\u6240\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u64cd\u4f5c\uff0csession A \u7684\u52a0\u9501\u8303\u56f4\u53d8\u6210\u4e86\u56fe 7 \u6240\u793a\u7684\u6837\u5b50\uff1a<img alt=\"img\" src=\"../../../images/mysql-lecture-45/d2f6a0c46dd8d12f6a90dacc466d53e9.png\" /></p>\n<p>\u56fe 7 session B \u4fee\u6539\u540e\uff0c session A \u7684\u52a0\u9501\u8303\u56f4</p>\n<p>\u597d\uff0c\u63a5\u4e0b\u6765 session B \u8981\u6267\u884c <code>update t set c = 5 where c = 1</code> \u8fd9\u4e2a\u8bed\u53e5\u4e86\uff0c\u4e00\u6837\u5730\u53ef\u4ee5\u62c6\u6210\u4e24\u6b65\uff1a</p>\n<ol>\n<li>\u63d2\u5165 <code>(c=5, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\uff1b</li>\n<li>\u5220\u9664 <code>(c=1, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u3002</li>\n</ol>\n<p>\u7b2c\u4e00\u6b65\u8bd5\u56fe\u5728\u5df2\u7ecf\u52a0\u4e86\u95f4\u9699\u9501\u7684 <code>(1,10)</code> \u4e2d\u63d2\u5165\u6570\u636e\uff0c\u6240\u4ee5\u5c31\u88ab\u5835\u4f4f\u4e86\u3002</p>\n<h3 id=\"_5\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7528\u524d\u9762\u6587\u7ae0\u8bc4\u8bba\u533a\u7684\u51e0\u4e2a\u95ee\u9898\uff0c\u518d\u6b21\u590d\u4e60\u4e86\u52a0\u9501\u89c4\u5219\u3002\u5e76\u4e14\u91cd\u70b9\u8bf4\u660e\u4e86\u5206\u6790\u52a0\u9501\u8303\u56f4\u65f6\uff0c\u4e00\u5b9a\u8981\u914d\u5408\u8bed\u53e5\u6267\u884c\u903b\u8f91\u6765\u8fdb\u884c\u3002</p>\n<p>\u5728\u6211\u770b\u6765\uff0c\u6bcf\u4e2a\u60f3\u8ba4\u771f\u4e86\u89e3 MySQL \u539f\u7406\u7684\u540c\u5b66\uff0c\u5e94\u8be5\u90fd\u8981\u80fd\u591f\u505a\u5230\uff1a\u901a\u8fc7 explain \u7684\u7ed3\u679c\uff0c\u5c31\u80fd\u591f\u8111\u8865\u51fa\u4e00\u4e2a SQL \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002\u8fbe\u5230\u8fd9\u6837\u7684\u7a0b\u5ea6\uff0c\u624d\u7b97\u662f\u5bf9\u7d22\u5f15\u7ec4\u7ec7\u8868\u3001\u7d22\u5f15\u3001\u9501\u7684\u6982\u5ff5\u6709\u4e86\u6bd4\u8f83\u6e05\u6670\u7684\u8ba4\u8bc6\u3002\u4f60\u540c\u6837\u4e5f\u53ef\u4ee5\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u6765\u9a8c\u8bc1\u81ea\u5df1\u5bf9\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u7684\u638c\u63e1\u7a0b\u5ea6\u3002</p>\n<p>\u5728\u5206\u6790\u8fd9\u4e9b\u52a0\u9501\u89c4\u5219\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u987a\u4fbf\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u600e\u4e48\u770b <code>show engine innodb status</code> \u8f93\u51fa\u7ed3\u679c\u4e2d\u7684\u4e8b\u52a1\u4fe1\u606f\u548c\u6b7b\u9501\u4fe1\u606f\uff0c\u5e0c\u671b\u8fd9\u4e9b\u5185\u5bb9\u5bf9\u4f60\u4ee5\u540e\u5206\u6790\u73b0\u573a\u80fd\u6709\u6240\u5e2e\u52a9\u3002</p>\n<h2 id=\"31\">31 \u8bef\u5220\u6570\u636e\u540e\u9664\u4e86\u8dd1\u8def\uff0c\u8fd8\u80fd\u600e\u4e48\u529e\uff1f<a class=\"headerlink\" href=\"#31\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4eca\u5929\u6211\u8981\u548c\u4f60\u8ba8\u8bba\u7684\u662f\u4e00\u4e2a\u6c89\u91cd\u7684\u8bdd\u9898\uff1a\u8bef\u5220\u6570\u636e\u3002</p>\n<p>\u5728\u524d\u9762\u51e0\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86 MySQL \u7684\u9ad8\u53ef\u7528\u67b6\u6784\u3002\u5f53\u7136\uff0c\u4f20\u7edf\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u662f\u4e0d\u80fd\u9884\u9632\u8bef\u5220\u6570\u636e\u7684\uff0c\u56e0\u4e3a\u4e3b\u5e93\u7684\u4e00\u4e2a <code>drop table</code> \u547d\u4ee4\uff0c\u4f1a\u901a\u8fc7 binlog \u4f20\u7ed9\u6240\u6709\u4ece\u5e93\u548c\u7ea7\u8054\u4ece\u5e93\uff0c\u8fdb\u800c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u5b9e\u4f8b\u90fd\u4f1a\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\u3002</p>\n<p>\u867d\u7136\u6211\u4eec\u4e4b\u524d\u9047\u5230\u7684\u5927\u591a\u6570\u7684\u6570\u636e\u88ab\u5220\uff0c\u90fd\u662f\u8fd0\u7ef4\u540c\u5b66\u6216\u8005 DBA \u80cc\u9505\u7684\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u53ea\u8981\u6709\u6570\u636e\u64cd\u4f5c\u6743\u9650\u7684\u540c\u5b66\uff0c\u90fd\u6709\u53ef\u80fd\u8e29\u5230\u8bef\u5220\u6570\u636e\u8fd9\u6761\u7ebf\u3002</p>\n<p>\u4eca\u5929\u6211\u4eec\u5c31\u6765\u804a\u804a\u8bef\u5220\u6570\u636e\u524d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u505a\u4e9b\u4ec0\u4e48\uff0c\u51cf\u5c11\u8bef\u5220\u6570\u636e\u7684\u98ce\u9669\uff0c\u548c\u7531\u8bef\u5220\u6570\u636e\u5e26\u6765\u7684\u635f\u5931\u3002</p>\n<p>\u4e3a\u4e86\u627e\u5230\u89e3\u51b3\u8bef\u5220\u6570\u636e\u7684\u66f4\u9ad8\u6548\u7684\u65b9\u6cd5\uff0c\u6211\u4eec\u9700\u8981\u5148\u5bf9\u548c MySQL \u76f8\u5173\u7684\u8bef\u5220\u6570\u636e\uff0c\u505a\u4e0b\u5206\u7c7b\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 delete \u8bed\u53e5\u8bef\u5220\u6570\u636e\u884c\uff1b</li>\n<li>\u4f7f\u7528 drop table \u6216\u8005 truncate table \u8bed\u53e5\u8bef\u5220\u6570\u636e\u8868\uff1b</li>\n<li>\u4f7f\u7528 drop database \u8bed\u53e5\u8bef\u5220\u6570\u636e\u5e93\uff1b</li>\n<li>\u4f7f\u7528 rm \u547d\u4ee4\u8bef\u5220\u6574\u4e2a MySQL \u5b9e\u4f8b\u3002</li>\n</ol>\n<h3 id=\"_6\">\u8bef\u5220\u884c<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5982\u679c\u662f\u4f7f\u7528 delete \u8bed\u53e5\u8bef\u5220\u4e86\u6570\u636e\u884c\uff0c\u53ef\u4ee5\u7528 <a href=\"https://mariadb.com/kb/en/flashback/\">Flashback</a> \u5de5\u5177\u901a\u8fc7\u95ea\u56de\u628a\u6570\u636e\u6062\u590d\u56de\u6765\u3002</p>\n<p>Flashback \u6062\u590d\u6570\u636e\u7684\u539f\u7406\uff0c\u662f\u4fee\u6539 binlog \u7684\u5185\u5bb9\uff0c\u62ff\u56de\u539f\u5e93\u91cd\u653e\u3002\u800c\u80fd\u591f\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6848\u7684\u524d\u63d0\u662f\uff0c\u9700\u8981\u786e\u4fdd <code>binlog_format=row</code> \u548c <code>binlog_row_image=FULL</code>\u3002</p>\n<p>\u5177\u4f53\u6062\u590d\u6570\u636e\u65f6\uff0c\u5bf9\u5355\u4e2a\u4e8b\u52a1\u505a\u5982\u4e0b\u5904\u7406\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e insert \u8bed\u53e5\uff0c\u5bf9\u5e94\u7684 binlog event \u7c7b\u578b\u662f Write_rows event\uff0c\u628a\u5b83\u6539\u6210 <code>Delete_rows</code> event \u5373\u53ef\uff1b</li>\n<li>\u540c\u7406\uff0c\u5bf9\u4e8e delete \u8bed\u53e5\uff0c\u4e5f\u662f\u5c06 Delete_rows event \u6539\u4e3a Write_rows event\uff1b</li>\n<li>\u800c\u5982\u679c\u662f Update_rows \u7684\u8bdd\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u4e86\u6570\u636e\u884c\u4fee\u6539\u524d\u548c\u4fee\u6539\u540e\u7684\u503c\uff0c\u5bf9\u8c03\u8fd9\u4e24\u884c\u7684\u4f4d\u7f6e\u5373\u53ef\u3002</li>\n</ol>\n<p>\u5982\u679c\u8bef\u64cd\u4f5c\u4e0d\u662f\u4e00\u4e2a\uff0c\u800c\u662f\u591a\u4e2a\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u6bd4\u5982\u4e0b\u9762\u4e09\u4e2a\u4e8b\u52a1\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">)</span><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">)</span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"p\">(</span><span class=\"k\">C</span><span class=\"p\">)</span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"p\">...</span>\n</code></pre></div>\n<p>\u73b0\u5728\u8981\u628a\u6570\u636e\u5e93\u6062\u590d\u56de\u8fd9\u4e09\u4e2a\u4e8b\u52a1\u64cd\u4f5c\u4e4b\u524d\u7684\u72b6\u6001\uff0c\u7528 Flashback \u5de5\u5177\u89e3\u6790 binlog \u540e\uff0c\u5199\u56de\u4e3b\u5e93\u7684\u547d\u4ee4\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"k\">C</span><span class=\"p\">)</span><span class=\"k\">update</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">)</span><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"p\">...</span>\n<span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"p\">)</span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"p\">...</span>\n</code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u8bef\u5220\u6570\u636e\u6d89\u53ca\u5230\u4e86\u591a\u4e2a\u4e8b\u52a1\u7684\u8bdd\uff0c\u9700\u8981\u5c06\u4e8b\u52a1\u7684\u987a\u5e8f\u8c03\u8fc7\u6765\u518d\u6267\u884c\u3002</p>\n<p><strong>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u76f4\u63a5\u5728\u4e3b\u5e93\u4e0a\u6267\u884c\u8fd9\u4e9b\u64cd\u4f5c\u3002</strong></p>\n<p>\u6062\u590d\u6570\u636e\u6bd4\u8f83\u5b89\u5168\u7684\u505a\u6cd5\uff0c\u662f\u6062\u590d\u51fa\u4e00\u4e2a\u5907\u4efd\uff0c\u6216\u8005\u627e\u4e00\u4e2a\u4ece\u5e93\u4f5c\u4e3a\u4e34\u65f6\u5e93\uff0c\u5728\u8fd9\u4e2a\u4e34\u65f6\u5e93\u4e0a\u6267\u884c\u8fd9\u4e9b\u64cd\u4f5c\uff0c\u7136\u540e\u518d\u5c06\u786e\u8ba4\u8fc7\u7684\u4e34\u65f6\u5e93\u7684\u6570\u636e\uff0c\u6062\u590d\u56de\u4e3b\u5e93\u3002</p>\n<p>\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u505a\u5462\uff1f</p>\n<p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u4e00\u4e2a\u5728\u6267\u884c\u7ebf\u4e0a\u903b\u8f91\u7684\u4e3b\u5e93\uff0c\u6570\u636e\u72b6\u6001\u7684\u53d8\u66f4\u5f80\u5f80\u662f\u6709\u5173\u8054\u7684\u3002\u53ef\u80fd\u7531\u4e8e\u53d1\u73b0\u6570\u636e\u95ee\u9898\u7684\u65f6\u95f4\u665a\u4e86\u4e00\u70b9\u513f\uff0c\u5c31\u5bfc\u81f4\u5df2\u7ecf\u5728\u4e4b\u524d\u8bef\u64cd\u4f5c\u7684\u57fa\u7840\u4e0a\uff0c\u4e1a\u52a1\u4ee3\u7801\u903b\u8f91\u53c8\u7ee7\u7eed\u4fee\u6539\u4e86\u5176\u4ed6\u6570\u636e\u3002\u6240\u4ee5\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u5355\u72ec\u6062\u590d\u8fd9\u51e0\u884c\u6570\u636e\uff0c\u800c\u53c8\u672a\u7ecf\u786e\u8ba4\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u4f1a\u51fa\u73b0\u5bf9\u6570\u636e\u7684\u4e8c\u6b21\u7834\u574f\u3002</p>\n<p>\u5f53\u7136\uff0c<strong>\u6211\u4eec\u4e0d\u6b62\u8981\u8bf4\u8bef\u5220\u6570\u636e\u7684\u4e8b\u540e\u5904\u7406\u529e\u6cd5\uff0c\u66f4\u91cd\u8981\u662f\u8981\u505a\u5230\u4e8b\u524d\u9884\u9632</strong>\u3002\u6211\u6709\u4ee5\u4e0b\u4e24\u4e2a\u5efa\u8bae\uff1a</p>\n<ol>\n<li>\u628a <code>sql_safe_updates</code> \u53c2\u6570\u8bbe\u7f6e\u4e3a on\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5982\u679c\u6211\u4eec\u5fd8\u8bb0\u5728 delete \u6216\u8005 update \u8bed\u53e5\u4e2d\u5199 where \u6761\u4ef6\uff0c\u6216\u8005 where \u6761\u4ef6\u91cc\u9762\u6ca1\u6709\u5305\u542b\u7d22\u5f15\u5b57\u6bb5\u7684\u8bdd\uff0c\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u5c31\u4f1a\u62a5\u9519\u3002</li>\n<li>\u4ee3\u7801\u4e0a\u7ebf\u524d\uff0c\u5fc5\u987b\u7ecf\u8fc7 SQL \u5ba1\u8ba1\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8bbe\u7f6e\u4e86 <code>sql_safe_updates=on</code>\uff0c\u5982\u679c\u6211\u771f\u7684\u8981\u628a\u4e00\u4e2a\u5c0f\u8868\u7684\u6570\u636e\u5168\u90e8\u5220\u6389\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>\u5982\u679c\u4f60\u786e\u5b9a\u8fd9\u4e2a\u5220\u9664\u64cd\u4f5c\u6ca1\u95ee\u9898\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728 delete \u8bed\u53e5\u4e2d\u52a0\u4e0a where \u6761\u4ef6\uff0c\u6bd4\u5982 <code>where id&gt;=0</code>\u3002</p>\n<p>\u4f46\u662f\uff0cdelete \u5168\u8868\u662f\u5f88\u6162\u7684\uff0c\u9700\u8981\u751f\u6210\u56de\u6eda\u65e5\u5fd7\u3001\u5199 redo\u3001\u5199 binlog\u3002\u6240\u4ee5\uff0c\u4ece\u6027\u80fd\u89d2\u5ea6\u8003\u8651\uff0c\u4f60\u5e94\u8be5\u4f18\u5148\u8003\u8651\u4f7f\u7528 truncate table \u6216\u8005 drop table \u547d\u4ee4\u3002</p>\n<p>\u4f7f\u7528 delete \u547d\u4ee4\u5220\u9664\u7684\u6570\u636e\uff0c\u4f60\u8fd8\u53ef\u4ee5\u7528 Flashback \u6765\u6062\u590d\u3002\u800c\u4f7f\u7528 truncate /drop table \u548c drop database \u547d\u4ee4\u5220\u9664\u7684\u6570\u636e\uff0c\u5c31\u6ca1\u529e\u6cd5\u901a\u8fc7 Flashback \u6765\u6062\u590d\u4e86\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u5373\u4f7f\u6211\u4eec\u914d\u7f6e\u4e86 binlog_format=row\uff0c\u6267\u884c\u8fd9\u4e09\u4e2a\u547d\u4ee4\u65f6\uff0c\u8bb0\u5f55\u7684 binlog \u8fd8\u662f statement \u683c\u5f0f\u3002binlog \u91cc\u9762\u5c31\u53ea\u6709\u4e00\u4e2a truncate/drop \u8bed\u53e5\uff0c\u8fd9\u4e9b\u4fe1\u606f\u662f\u6062\u590d\u4e0d\u51fa\u6570\u636e\u7684\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u771f\u7684\u662f\u4f7f\u7528\u8fd9\u51e0\u6761\u547d\u4ee4\u8bef\u5220\u6570\u636e\u4e86\uff0c\u53c8\u8be5\u600e\u4e48\u529e\u5462\uff1f</p>\n<h3 id=\"_7\">\u8bef\u5220\u5e93 / \u8868<a class=\"headerlink\" href=\"#_7\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8981\u60f3\u6062\u590d\u6570\u636e\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u5168\u91cf\u5907\u4efd\uff0c\u52a0\u589e\u91cf\u65e5\u5fd7\u7684\u65b9\u5f0f\u4e86\u3002\u8fd9\u4e2a\u65b9\u6848\u8981\u6c42\u7ebf\u4e0a\u6709\u5b9a\u671f\u7684\u5168\u91cf\u5907\u4efd\uff0c\u5e76\u4e14\u5b9e\u65f6\u5907\u4efd binlog\u3002</p>\n<p>\u5728\u8fd9\u4e24\u4e2a\u6761\u4ef6\u90fd\u5177\u5907\u7684\u60c5\u51b5\u4e0b\uff0c\u5047\u5982\u6709\u4eba\u4e2d\u5348 12 \u70b9\u8bef\u5220\u4e86\u4e00\u4e2a\u5e93\uff0c\u6062\u590d\u6570\u636e\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u53d6\u6700\u8fd1\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5047\u8bbe\u8fd9\u4e2a\u5e93\u662f\u4e00\u5929\u4e00\u5907\uff0c\u4e0a\u6b21\u5907\u4efd\u662f\u5f53\u5929 0 \u70b9\uff1b</li>\n<li>\u7528\u5907\u4efd\u6062\u590d\u51fa\u4e00\u4e2a\u4e34\u65f6\u5e93\uff1b</li>\n<li>\u4ece\u65e5\u5fd7\u5907\u4efd\u91cc\u9762\uff0c\u53d6\u51fa\u51cc\u6668 0 \u70b9\u4e4b\u540e\u7684\u65e5\u5fd7\uff1b</li>\n<li>\u628a\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u9664\u4e86\u8bef\u5220\u9664\u6570\u636e\u7684\u8bed\u53e5\u5916\uff0c\u5168\u90e8\u5e94\u7528\u5230\u4e34\u65f6\u5e93\u3002</li>\n</ol>\n<p>\u5173\u4e8e\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u9700\u8981\u8bf4\u660e\u5982\u4e0b\u51e0\u70b9\uff1a</p>\n<ol>\n<li>\u4e3a\u4e86\u52a0\u901f\u6570\u636e\u6062\u590d\uff0c\u5982\u679c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u4e0a\u6709\u591a\u4e2a\u6570\u636e\u5e93\uff0c\u4f60\u53ef\u4ee5\u5728\u4f7f\u7528 mysqlbinlog \u547d\u4ee4\u65f6\uff0c\u52a0\u4e0a\u4e00\u4e2a <code>-\u2013database</code> \u53c2\u6570\uff0c\u7528\u6765\u6307\u5b9a\u8bef\u5220\u8868\u6240\u5728\u7684\u5e93\u3002\u8fd9\u6837\uff0c\u5c31\u907f\u514d\u4e86\u5728\u6062\u590d\u6570\u636e\u65f6\u8fd8\u8981\u5e94\u7528\u5176\u4ed6\u5e93\u65e5\u5fd7\u7684\u60c5\u51b5\u3002</li>\n<li>\u5728\u5e94\u7528\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u9700\u8981\u8df3\u8fc7 12 \u70b9\u8bef\u64cd\u4f5c\u7684\u90a3\u4e2a\u8bed\u53e5\u7684 binlog\uff1a </li>\n<li>\u5982\u679c\u539f\u5b9e\u4f8b\u6ca1\u6709\u4f7f\u7528 GTID \u6a21\u5f0f\uff0c\u53ea\u80fd\u5728\u5e94\u7528\u5230\u5305\u542b 12 \u70b9\u7684 binlog \u6587\u4ef6\u7684\u65f6\u5019\uff0c\u5148\u7528 <code>-\u2013stop-position</code> \u53c2\u6570\u6267\u884c\u5230\u8bef\u64cd\u4f5c\u4e4b\u524d\u7684\u65e5\u5fd7\uff0c\u7136\u540e\u518d\u7528 <code>-\u2013start-position</code> \u4ece\u8bef\u64cd\u4f5c\u4e4b\u540e\u7684\u65e5\u5fd7\u7ee7\u7eed\u6267\u884c\uff1b</li>\n<li>\u5982\u679c\u5b9e\u4f8b\u4f7f\u7528\u4e86 GTID \u6a21\u5f0f\uff0c\u5c31\u65b9\u4fbf\u591a\u4e86\u3002\u5047\u8bbe\u8bef\u64cd\u4f5c\u547d\u4ee4\u7684 GTID \u662f gtid1\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u6267\u884c <code>set gtid_next=gtid1;begin;commit;</code> \u5148\u628a\u8fd9\u4e2a GTID \u52a0\u5230\u4e34\u65f6\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\uff0c\u4e4b\u540e\u6309\u987a\u5e8f\u6267\u884c binlog \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u81ea\u52a8\u8df3\u8fc7\u8bef\u64cd\u4f5c\u7684\u8bed\u53e5\u3002</li>\n</ol>\n<p>\u4e0d\u8fc7\uff0c\u5373\u4f7f\u8fd9\u6837\uff0c\u4f7f\u7528 mysqlbinlog \u65b9\u6cd5\u6062\u590d\u6570\u636e\u8fd8\u662f\u4e0d\u591f\u5feb\uff0c\u4e3b\u8981\u539f\u56e0\u6709\u4e24\u4e2a\uff1a</p>\n<ol>\n<li>\u5982\u679c\u662f\u8bef\u5220\u8868\uff0c\u6700\u597d\u5c31\u662f\u53ea\u6062\u590d\u51fa\u8fd9\u5f20\u8868\uff0c\u4e5f\u5c31\u662f\u53ea\u91cd\u653e\u8fd9\u5f20\u8868\u7684\u64cd\u4f5c\uff0c\u4f46\u662f mysqlbinlog \u5de5\u5177\u5e76\u4e0d\u80fd\u6307\u5b9a\u53ea\u89e3\u6790\u4e00\u4e2a\u8868\u7684\u65e5\u5fd7\uff1b</li>\n<li>\u7528 mysqlbinlog \u89e3\u6790\u51fa\u65e5\u5fd7\u5e94\u7528\uff0c\u5e94\u7528\u65e5\u5fd7\u7684\u8fc7\u7a0b\u5c31\u53ea\u80fd\u662f\u5355\u7ebf\u7a0b\u3002</li>\n</ol>\n<p>**\u4e00\u79cd\u52a0\u901f\u7684\u65b9\u6cd5\u662f\uff0c**\u5728\u7528\u5907\u4efd\u6062\u590d\u51fa\u4e34\u65f6\u5b9e\u4f8b\u4e4b\u540e\uff0c\u5c06\u8fd9\u4e2a\u4e34\u65f6\u5b9e\u4f8b\u8bbe\u7f6e\u6210\u7ebf\u4e0a\u5907\u5e93\u7684\u4ece\u5e93\uff0c\u8fd9\u6837\uff1a</p>\n<ol>\n<li>\u5728 start slave \u4e4b\u524d\uff0c\u5148\u901a\u8fc7\u6267\u884c <code>change replication filter replicate_do_table = (tbl_name)</code> \u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u8ba9\u4e34\u65f6\u5e93\u53ea\u540c\u6b65\u8bef\u64cd\u4f5c\u7684\u8868\uff1b</li>\n<li>\u8fd9\u6837\u505a\u4e5f\u53ef\u4ee5\u7528\u4e0a\u5e76\u884c\u590d\u5236\u6280\u672f\uff0c\u6765\u52a0\u901f\u6574\u4e2a\u6570\u636e\u6062\u590d\u8fc7\u7a0b\u3002</li>\n</ol>\n<p>\u5047\u8bbe\uff0c\u6211\u4eec\u53d1\u73b0\u5f53\u524d\u4e34\u65f6\u5b9e\u4f8b\u9700\u8981\u7684 binlog \u662f\u4ece <code>master.000005</code> \u5f00\u59cb\u7684\uff0c\u4f46\u662f\u5728\u5907\u5e93\u4e0a\u6267\u884c <code>show binlogs</code> \u663e\u793a\u7684\u6700\u5c0f\u7684 binlog \u6587\u4ef6\u662f <code>master.000007</code>\uff0c\u610f\u5473\u7740\u5c11\u4e86\u4e24\u4e2a binlog \u6587\u4ef6\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u9700\u8981\u53bb binlog \u5907\u4efd\u7cfb\u7edf\u4e2d\u627e\u5230\u8fd9\u4e24\u4e2a\u6587\u4ef6\u3002</p>\n<p>\u628a\u4e4b\u524d\u5220\u6389\u7684 binlog \u653e\u56de\u5907\u5e93\u7684\u64cd\u4f5c\u6b65\u9aa4\uff0c\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4ece\u5907\u4efd\u7cfb\u7edf\u4e0b\u8f7d <code>master.000005</code> \u548c <code>master.000006</code> \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u653e\u5230\u5907\u5e93\u7684\u65e5\u5fd7\u76ee\u5f55\u4e0b\uff1b</li>\n<li>\u6253\u5f00\u65e5\u5fd7\u76ee\u5f55\u4e0b\u7684 <code>master.index</code> \u6587\u4ef6\uff0c\u5728\u6587\u4ef6\u5f00\u5934\u52a0\u5165\u4e24\u884c\uff0c\u5185\u5bb9\u5206\u522b\u662f <code>master.000005</code> \u548c <code>master.000006</code>;</li>\n<li>\u91cd\u542f\u5907\u5e93\uff0c\u76ee\u7684\u662f\u8981\u8ba9\u5907\u5e93\u91cd\u65b0\u8bc6\u522b\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u6587\u4ef6\uff1b</li>\n<li>\u73b0\u5728\u8fd9\u4e2a\u5907\u5e93\u4e0a\u5c31\u6709\u4e86\u4e34\u65f6\u5e93\u9700\u8981\u7684\u6240\u6709 binlog \u4e86\uff0c\u5efa\u7acb\u4e3b\u5907\u5173\u7cfb\uff0c\u5c31\u53ef\u4ee5\u6b63\u5e38\u540c\u6b65\u4e86\u3002</li>\n</ol>\n<p>\u4e0d\u8bba\u662f\u628a mysqlbinlog \u5de5\u5177\u89e3\u6790\u51fa\u7684 binlog \u6587\u4ef6\u5e94\u7528\u5230\u4e34\u65f6\u5e93\uff0c\u8fd8\u662f\u628a\u4e34\u65f6\u5e93\u63a5\u5230\u5907\u5e93\u4e0a\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6848\u7684\u5171\u540c\u70b9\u662f\uff1a\u8bef\u5220\u5e93\u6216\u8005\u8868\u540e\uff0c\u6062\u590d\u6570\u636e\u7684\u601d\u8def\u4e3b\u8981\u5c31\u662f\u901a\u8fc7\u5907\u4efd\uff0c\u518d\u52a0\u4e0a\u5e94\u7528 binlog \u7684\u65b9\u5f0f\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6848\u90fd\u8981\u6c42\u5907\u4efd\u7cfb\u7edf\u5b9a\u671f\u5907\u4efd\u5168\u91cf\u65e5\u5fd7\uff0c\u800c\u4e14\u9700\u8981\u786e\u4fdd binlog \u5728\u88ab\u4ece\u672c\u5730\u5220\u9664\u4e4b\u524d\u5df2\u7ecf\u505a\u4e86\u5907\u4efd\u3002</p>\n<p>\u4f46\u662f\uff0c\u4e00\u4e2a\u7cfb\u7edf\u4e0d\u53ef\u80fd\u5907\u4efd\u65e0\u9650\u7684\u65e5\u5fd7\uff0c\u4f60\u8fd8\u9700\u8981\u6839\u636e\u6210\u672c\u548c\u78c1\u76d8\u7a7a\u95f4\u8d44\u6e90\uff0c\u8bbe\u5b9a\u4e00\u4e2a\u65e5\u5fd7\u4fdd\u7559\u7684\u5929\u6570\u3002\u5982\u679c\u4f60\u7684 DBA \u56e2\u961f\u544a\u8bc9\u4f60\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u628a\u67d0\u4e2a\u5b9e\u4f8b\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u7684\u4efb\u610f\u65f6\u95f4\u70b9\uff0c\u8fd9\u5c31\u8868\u793a\u5907\u4efd\u7cfb\u7edf\u4fdd\u7559\u7684\u65e5\u5fd7\u65f6\u95f4\u5c31\u81f3\u5c11\u662f\u534a\u4e2a\u6708\u3002</p>\n<p>\u53e6\u5916\uff0c\u6211\u5efa\u8bae\u4f60\u4e0d\u8bba\u4f7f\u7528\u4e0a\u8ff0\u54ea\u79cd\u65b9\u5f0f\uff0c\u90fd\u8981\u628a\u8fd9\u4e2a\u6570\u636e\u6062\u590d\u529f\u80fd\u505a\u6210\u81ea\u52a8\u5316\u5de5\u5177\uff0c\u5e76\u4e14\u7ecf\u5e38\u62ff\u51fa\u6765\u6f14\u7ec3\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p>\n<p>\u8fd9\u91cc\u7684\u539f\u56e0\uff0c\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>\u867d\u7136\u201c\u53d1\u751f\u8fd9\u79cd\u4e8b\uff0c\u5927\u5bb6\u90fd\u4e0d\u60f3\u7684\u201d\uff0c\u4f46\u662f\u4e07\u4e00\u51fa\u73b0\u4e86\u8bef\u5220\u4e8b\u4ef6\uff0c\u80fd\u591f\u5feb\u901f\u6062\u590d\u6570\u636e\uff0c\u5c06\u635f\u5931\u964d\u5230\u6700\u5c0f\uff0c\u4e5f\u5e94\u8be5\u4e0d\u7528\u8dd1\u8def\u4e86\u3002</li>\n<li>\u800c\u5982\u679c\u4e34\u65f6\u518d\u624b\u5fd9\u811a\u4e71\u5730\u624b\u52a8\u64cd\u4f5c\uff0c\u6700\u540e\u53c8\u8bef\u64cd\u4f5c\u4e86\uff0c\u5bf9\u4e1a\u52a1\u9020\u6210\u4e86\u4e8c\u6b21\u4f24\u5bb3\uff0c\u90a3\u5c31\u8bf4\u4e0d\u8fc7\u53bb\u4e86\u3002</li>\n</ol>\n<h3 id=\"_8\">\u5ef6\u8fdf\u590d\u5236\u5907\u5e93<a class=\"headerlink\" href=\"#_8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u867d\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5229\u7528\u5e76\u884c\u590d\u5236\u6765\u52a0\u901f\u6062\u590d\u6570\u636e\u7684\u8fc7\u7a0b\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6848\u4ecd\u7136\u5b58\u5728\u201c\u6062\u590d\u65f6\u95f4\u4e0d\u53ef\u63a7\u201d\u7684\u95ee\u9898\u3002</p>\n<p>\u5982\u679c\u4e00\u4e2a\u5e93\u7684\u5907\u4efd\u7279\u522b\u5927\uff0c\u6216\u8005\u8bef\u64cd\u4f5c\u7684\u65f6\u95f4\u8ddd\u79bb\u4e0a\u4e00\u4e2a\u5168\u91cf\u5907\u4efd\u7684\u65f6\u95f4\u8f83\u957f\uff0c\u6bd4\u5982\u4e00\u5468\u4e00\u5907\u7684\u5b9e\u4f8b\uff0c\u5728\u5907\u4efd\u4e4b\u540e\u7684\u7b2c 6 \u5929\u53d1\u751f\u8bef\u64cd\u4f5c\uff0c\u90a3\u5c31\u9700\u8981\u6062\u590d 6 \u5929\u7684\u65e5\u5fd7\uff0c\u8fd9\u4e2a\u6062\u590d\u65f6\u95f4\u53ef\u80fd\u662f\u8981\u6309\u5929\u6765\u8ba1\u7b97\u7684\u3002</p>\n<p>\u90a3\u4e48\uff0c\u6211\u4eec\u6709\u4ec0\u4e48\u65b9\u6cd5\u53ef\u4ee5\u7f29\u77ed\u6062\u590d\u6570\u636e\u9700\u8981\u7684\u65f6\u95f4\u5462\uff1f</p>\n<p>\u5982\u679c\u6709\u975e\u5e38\u6838\u5fc3\u7684\u4e1a\u52a1\uff0c\u4e0d\u5141\u8bb8\u592a\u957f\u7684\u6062\u590d\u65f6\u95f4\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651 **\u642d\u5efa\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u3002**\u8fd9\u4e2a\u529f\u80fd\u662f MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684\u3002</p>\n<p>\u4e00\u822c\u7684\u4e3b\u5907\u590d\u5236\u7ed3\u6784\u5b58\u5728\u7684\u95ee\u9898\u662f\uff0c\u5982\u679c\u4e3b\u5e93\u4e0a\u6709\u4e2a\u8868\u88ab\u8bef\u5220\u4e86\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5f88\u5feb\u4e5f\u4f1a\u88ab\u53d1\u7ed9\u6240\u6709\u4ece\u5e93\uff0c\u8fdb\u800c\u5bfc\u81f4\u6240\u6709\u4ece\u5e93\u7684\u6570\u636e\u8868\u4e5f\u90fd\u4e00\u8d77\u88ab\u8bef\u5220\u4e86\u3002</p>\n<p>\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u5907\u5e93\uff0c\u901a\u8fc7 <code>CHANGE MASTER TO MASTER_DELAY = N</code> \u547d\u4ee4\uff0c\u53ef\u4ee5\u6307\u5b9a\u8fd9\u4e2a\u5907\u5e93\u6301\u7eed\u4fdd\u6301\u8ddf\u4e3b\u5e93\u6709 N \u79d2\u7684\u5ef6\u8fdf\u3002</p>\n<p>\u6bd4\u5982\u4f60\u628a N \u8bbe\u7f6e\u4e3a 3600\uff0c\u8fd9\u5c31\u4ee3\u8868\u4e86\u5982\u679c\u4e3b\u5e93\u4e0a\u6709\u6570\u636e\u88ab\u8bef\u5220\u4e86\uff0c\u5e76\u4e14\u5728 1 \u5c0f\u65f6\u5185\u53d1\u73b0\u4e86\u8fd9\u4e2a\u8bef\u64cd\u4f5c\u547d\u4ee4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5c31\u8fd8\u6ca1\u6709\u5728\u8fd9\u4e2a\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u6267\u884c\u3002\u8fd9\u65f6\u5019\u5230\u8fd9\u4e2a\u5907\u5e93\u4e0a\u6267\u884c stop slave\uff0c\u518d\u901a\u8fc7\u4e4b\u524d\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u8df3\u8fc7\u8bef\u64cd\u4f5c\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u6062\u590d\u51fa\u9700\u8981\u7684\u6570\u636e\u3002</p>\n<p>\u8fd9\u6837\u7684\u8bdd\uff0c\u4f60\u5c31\u968f\u65f6\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\uff0c\u53ea\u9700\u8981\u6700\u591a\u518d\u8ffd 1 \u5c0f\u65f6\uff0c\u5c31\u53ef\u4ee5\u6062\u590d\u51fa\u6570\u636e\u7684\u4e34\u65f6\u5b9e\u4f8b\uff0c\u4e5f\u5c31\u7f29\u77ed\u4e86\u6574\u4e2a\u6570\u636e\u6062\u590d\u9700\u8981\u7684\u65f6\u95f4\u3002</p>\n<h3 id=\"_9\">\u9884\u9632\u8bef\u5220\u5e93 / \u8868\u7684\u65b9\u6cd5<a class=\"headerlink\" href=\"#_9\" title=\"Permanent link\">&para;</a></h3>\n<p>\u867d\u7136\u5e38\u5728\u6cb3\u8fb9\u8d70\uff0c\u5f88\u96be\u4e0d\u6e7f\u978b\uff0c\u4f46\u7ec8\u7a76\u8fd8\u662f\u53ef\u4ee5\u627e\u5230\u4e00\u4e9b\u65b9\u6cd5\u6765\u907f\u514d\u7684\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u6211\u4e5f\u4f1a\u7ed9\u4f60\u4e00\u4e9b\u51cf\u5c11\u8bef\u5220\u64cd\u4f5c\u98ce\u9669\u7684\u5efa\u8bae\u3002</p>\n<p>\u7b2c\u4e00\u6761\u5efa\u8bae\u662f\uff0c\u8d26\u53f7\u5206\u79bb\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\uff0c\u907f\u514d\u5199\u9519\u547d\u4ee4\u3002\u6bd4\u5982\uff1a</p>\n<ul>\n<li>\u6211\u4eec\u53ea\u7ed9\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66 DML \u6743\u9650\uff0c\u800c\u4e0d\u7ed9 truncate/drop \u6743\u9650\u3002\u800c\u5982\u679c\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u6709 DDL \u9700\u6c42\u7684\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5f00\u53d1\u7ba1\u7406\u7cfb\u7edf\u5f97\u5230\u652f\u6301\u3002</li>\n<li>\u5373\u4f7f\u662f DBA \u56e2\u961f\u6210\u5458\uff0c\u65e5\u5e38\u4e5f\u90fd\u89c4\u5b9a\u53ea\u4f7f\u7528\u53ea\u8bfb\u8d26\u53f7\uff0c\u5fc5\u8981\u7684\u65f6\u5019\u624d\u4f7f\u7528\u6709\u66f4\u65b0\u6743\u9650\u7684\u8d26\u53f7\u3002</li>\n</ul>\n<p>\u7b2c\u4e8c\u6761\u5efa\u8bae\u662f\uff0c\u5236\u5b9a\u64cd\u4f5c\u89c4\u8303\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\uff0c\u662f\u907f\u514d\u5199\u9519\u8981\u5220\u9664\u7684\u8868\u540d\u3002\u6bd4\u5982\uff1a</p>\n<ul>\n<li>\u5728\u5220\u9664\u6570\u636e\u8868\u4e4b\u524d\uff0c\u5fc5\u987b\u5148\u5bf9\u8868\u505a\u6539\u540d\u64cd\u4f5c\u3002\u7136\u540e\uff0c\u89c2\u5bdf\u4e00\u6bb5\u65f6\u95f4\uff0c\u786e\u4fdd\u5bf9\u4e1a\u52a1\u65e0\u5f71\u54cd\u4ee5\u540e\u518d\u5220\u9664\u8fd9\u5f20\u8868\u3002</li>\n<li>\u6539\u8868\u540d\u7684\u65f6\u5019\uff0c\u8981\u6c42\u7ed9\u8868\u540d\u52a0\u56fa\u5b9a\u7684\u540e\u7f00\uff08\u6bd4\u5982\u52a0 <code>_to_be_deleted</code>)\uff0c\u7136\u540e\u5220\u9664\u8868\u7684\u52a8\u4f5c\u5fc5\u987b\u901a\u8fc7\u7ba1\u7406\u7cfb\u7edf\u6267\u884c\u3002\u5e76\u4e14\uff0c\u7ba1\u7406\u7cfb\u5220\u9664\u8868\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u5220\u9664\u56fa\u5b9a\u540e\u7f00\u7684\u8868\u3002</li>\n</ul>\n<h3 id=\"rm\">rm \u5220\u9664\u6570\u636e<a class=\"headerlink\" href=\"#rm\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5176\u5b9e\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u6709\u9ad8\u53ef\u7528\u673a\u5236\u7684 MySQL \u96c6\u7fa4\u6765\u8bf4\uff0c\u6700\u4e0d\u6015\u7684\u5c31\u662f rm \u5220\u9664\u6570\u636e\u4e86\u3002\u53ea\u8981\u4e0d\u662f\u6076\u610f\u5730\u628a\u6574\u4e2a\u96c6\u7fa4\u5220\u9664\uff0c\u800c\u53ea\u662f\u5220\u6389\u4e86\u5176\u4e2d\u67d0\u4e00\u4e2a\u8282\u70b9\u7684\u6570\u636e\u7684\u8bdd\uff0cHA \u7cfb\u7edf\u5c31\u4f1a\u5f00\u59cb\u5de5\u4f5c\uff0c\u9009\u51fa\u4e00\u4e2a\u65b0\u7684\u4e3b\u5e93\uff0c\u4ece\u800c\u4fdd\u8bc1\u6574\u4e2a\u96c6\u7fa4\u7684\u6b63\u5e38\u5de5\u4f5c\u3002</p>\n<p>\u8fd9\u65f6\uff0c\u4f60\u8981\u505a\u7684\u5c31\u662f\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u518d\u63a5\u5165\u6574\u4e2a\u96c6\u7fa4\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u73b0\u5728\u4e0d\u6b62\u662f DBA \u6709\u81ea\u52a8\u5316\u7cfb\u7edf\uff0cSA\uff08\u7cfb\u7edf\u7ba1\u7406\u5458\uff09\u4e5f\u6709\u81ea\u52a8\u5316\u7cfb\u7edf\uff0c\u6240\u4ee5\u4e5f\u8bb8\u4e00\u4e2a\u6279\u91cf\u4e0b\u7ebf\u673a\u5668\u7684\u64cd\u4f5c\uff0c\u4f1a\u8ba9\u4f60\u6574\u4e2a MySQL \u96c6\u7fa4\u7684\u6240\u6709\u8282\u70b9\u90fd\u5168\u519b\u8986\u6ca1\u3002</p>\n<p>\u5e94\u5bf9\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u7684\u5efa\u8bae\u53ea\u80fd\u662f\u8bf4\u5c3d\u91cf\u628a\u4f60\u7684\u5907\u4efd\u8de8\u673a\u623f\uff0c\u6216\u8005\u6700\u597d\u662f\u8de8\u57ce\u5e02\u4fdd\u5b58\u3002</p>\n<h3 id=\"_10\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_10\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u8ba8\u8bba\u4e86\u8bef\u5220\u6570\u636e\u7684\u51e0\u79cd\u53ef\u80fd\uff0c\u4ee5\u53ca\u8bef\u5220\u540e\u7684\u5904\u7406\u65b9\u6cd5\u3002</p>\n<p>\u4f46\uff0c\u6211\u8981\u5f3a\u8c03\u7684\u662f\uff0c\u9884\u9632\u8fdc\u6bd4\u5904\u7406\u7684\u610f\u4e49\u6765\u5f97\u5927\u3002</p>\n<p>\u53e6\u5916\uff0c\u5728 MySQL \u7684\u96c6\u7fa4\u65b9\u6848\u4e2d\uff0c\u4f1a\u65f6\u4e0d\u65f6\u5730\u7528\u5230\u5907\u4efd\u6765\u6062\u590d\u5b9e\u4f8b\uff0c\u56e0\u6b64\u5b9a\u671f\u68c0\u67e5\u5907\u4efd\u7684\u6709\u6548\u6027\u4e5f\u5f88\u6709\u5fc5\u8981\u3002</p>\n<p>\u5982\u679c\u4f60\u662f\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\uff0c\u4f60\u53ef\u4ee5\u7528 show grants \u547d\u4ee4\u67e5\u770b\u8d26\u6237\u7684\u6743\u9650\uff0c\u5982\u679c\u6743\u9650\u8fc7\u5927\uff0c\u53ef\u4ee5\u5efa\u8bae DBA \u540c\u5b66\u7ed9\u4f60\u5206\u914d\u6743\u9650\u4f4e\u4e00\u4e9b\u7684\u8d26\u53f7\uff1b\u4f60\u4e5f\u53ef\u4ee5\u8bc4\u4f30\u4e1a\u52a1\u7684\u91cd\u8981\u6027\uff0c\u548c DBA \u5546\u91cf\u5907\u4efd\u7684\u5468\u671f\u3001\u662f\u5426\u6709\u5fc5\u8981\u521b\u5efa\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u7b49\u7b49\u3002</p>\n<p>\u6570\u636e\u548c\u670d\u52a1\u7684\u53ef\u9760\u6027\u4e0d\u6b62\u662f\u8fd0\u7ef4\u56e2\u961f\u7684\u5de5\u4f5c\uff0c\u6700\u7ec8\u662f\u5404\u4e2a\u73af\u8282\u4e00\u8d77\u4fdd\u969c\u7684\u7ed3\u679c\u3002</p>\n<h3 id=\"_11\">\u4e0a\u671f\u95ee\u9898\u65f6\u95f4<a class=\"headerlink\" href=\"#_11\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7ed9\u4f60\u7559\u7684\u95ee\u9898\uff0c\u662f\u5173\u4e8e\u7a7a\u8868\u7684\u95f4\u9699\u7684\u5b9a\u4e49\u3002</p>\n<p>\u4e00\u4e2a\u7a7a\u8868\u5c31\u53ea\u6709\u4e00\u4e2a\u95f4\u9699\u3002\u6bd4\u5982\uff0c\u5728\u7a7a\u8868\u4e0a\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&gt;</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">update</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u52a0\u9501\u7684\u8303\u56f4\u5c31\u662f next-key lock (-\u221e, supremum]\u3002</p>\n<p>\u9a8c\u8bc1\u65b9\u6cd5\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\u3002</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>create table t(id int primary key) engine=innodb;<br />begin;<br />select * from t where id &gt; 1 for update;</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into t values(2);<br />(blocked)</td>\n</tr>\n<tr>\n<td>show engine innodb status \\G;</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">locked</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"k\">LOCK</span><span class=\"w\"> </span><span class=\"n\">WAIT</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"mi\">1136</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span>\n<span class=\"n\">MySQL</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"mi\">123145585483776</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">630638</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"k\">update</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">tt</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"c1\">------- TRX HAS BEEN WAITING 4 SEC FOR THIS LOCK TO BE GRANTED:</span>\n<span class=\"n\">RECORD</span><span class=\"w\"> </span><span class=\"n\">LOCKS</span><span class=\"w\"> </span><span class=\"k\">space</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">498</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">of</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">test</span><span class=\"o\">`</span><span class=\"p\">.</span><span class=\"o\">`</span><span class=\"n\">tt</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"n\">trx</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"mi\">588668</span><span class=\"w\"> </span><span class=\"n\">lock_mode</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"n\">intention</span><span class=\"w\"> </span><span class=\"n\">waiting</span>\n<span class=\"n\">Record</span><span class=\"w\"> </span><span class=\"k\">lock</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"k\">no</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">PHYSICAL</span><span class=\"w\"> </span><span class=\"n\">RECORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">n_fields</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">compact</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"mi\">73757072656</span><span class=\"n\">d756d</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">asc</span><span class=\"w\"> </span><span class=\"n\">supremum</span><span class=\"p\">;;</span>\n</code></pre></div>\n<h2 id=\"32-kill\">32 \u4e3a\u4ec0\u4e48\u8fd8\u6709kill\u4e0d\u6389\u7684\u8bed\u53e5\uff1f<a class=\"headerlink\" href=\"#32-kill\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 MySQL \u4e2d\u6709\u4e24\u4e2a kill \u547d\u4ee4\uff1a\u4e00\u4e2a\u662f <code>kill query + \u7ebf\u7a0b id</code>\uff0c\u8868\u793a\u7ec8\u6b62\u8fd9\u4e2a\u7ebf\u7a0b\u4e2d\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\uff1b\u4e00\u4e2a\u662f <code>kill connection + \u7ebf\u7a0b id</code>\uff0c\u8fd9\u91cc connection \u53ef\u7f3a\u7701\uff0c\u8868\u793a\u65ad\u5f00\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u8fde\u63a5\uff0c\u5f53\u7136\u5982\u679c\u8fd9\u4e2a\u7ebf\u7a0b\u6709\u8bed\u53e5\u6b63\u5728\u6267\u884c\uff0c\u4e5f\u662f\u8981\u5148\u505c\u6b62\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\u7684\u3002</p>\n<p>\u4e0d\u77e5\u9053\u4f60\u5728\u4f7f\u7528 MySQL \u7684\u65f6\u5019\uff0c\u6709\u6ca1\u6709\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u73b0\u8c61\uff1a\u4f7f\u7528\u4e86 kill \u547d\u4ee4\uff0c\u5374\u6ca1\u80fd\u65ad\u5f00\u8fd9\u4e2a\u8fde\u63a5\u3002\u518d\u6267\u884c <code>show processlist</code> \u547d\u4ee4\uff0c\u770b\u5230\u8fd9\u6761\u8bed\u53e5\u7684 Command \u5217\u663e\u793a\u7684\u662f Killed\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u4f1a\u5947\u602a\uff0c\u663e\u793a\u4e3a Killed \u662f\u4ec0\u4e48\u610f\u601d\uff0c\u4e0d\u662f\u5e94\u8be5\u76f4\u63a5\u5728 show processlist \u7684\u7ed3\u679c\u91cc\u770b\u4e0d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u4e86\u5417\uff1f</p>\n<p>\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u8ba8\u8bba\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u5176\u5b9e\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0ckill query/connection \u547d\u4ee4\u662f\u6709\u6548\u7684\u3002\u6bd4\u5982\uff0c\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u6267\u884c\u65f6\u95f4\u592a\u4e45\uff0c\u8981\u653e\u5f03\u7ee7\u7eed\u67e5\u8be2\uff0c\u8fd9\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u7528 kill query \u547d\u4ee4\uff0c\u7ec8\u6b62\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u3002</p>\n<p>\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8bed\u53e5\u5904\u4e8e\u9501\u7b49\u5f85\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u4f7f\u7528 kill \u547d\u4ee4\u4e5f\u662f\u6709\u6548\u7684\u3002\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>session A</th>\n<th>session B</th>\n<th>session C</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>begin;<br />update t set c=c+1 where id=1;</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>update t set c=c+1 where id=1;<br />(blocked)</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>ERROR 1317(70100): Query execution was interrupted</td>\n<td>kill query <code>thread_id_B</code></td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0csession C \u6267\u884c kill query \u4ee5\u540e\uff0csession B \u51e0\u4e4e\u540c\u65f6\u5c31\u63d0\u793a\u4e86\u8bed\u53e5\u88ab\u4e2d\u65ad\u3002\u8fd9\uff0c\u5c31\u662f\u6211\u4eec\u9884\u671f\u7684\u7ed3\u679c\u3002</p>\n<h3 id=\"kill\">\u6536\u5230 kill \u4ee5\u540e\uff0c\u7ebf\u7a0b\u505a\u4ec0\u4e48\uff1f<a class=\"headerlink\" href=\"#kill\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f46\u662f\uff0c\u8fd9\u91cc\u4f60\u8981\u505c\u4e0b\u6765\u60f3\u4e00\u4e0b\uff1asession B \u662f\u76f4\u63a5\u7ec8\u6b62\u6389\u7ebf\u7a0b\uff0c\u4ec0\u4e48\u90fd\u4e0d\u7ba1\u5c31\u76f4\u63a5\u9000\u51fa\u5417\uff1f\u663e\u7136\uff0c\u8fd9\u662f\u4e0d\u884c\u7684\u3002</p>\n<p>\u6211\u5728[\u7b2c 6 \u7bc7\u6587\u7ae0]\u4e2d\u8bb2\u8fc7\uff0c\u5f53\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u65f6\uff0c\u4f1a\u5728\u8868\u4e0a\u52a0 MDL \u8bfb\u9501\u3002\u6240\u4ee5\uff0csession B \u867d\u7136\u5904\u4e8e blocked \u72b6\u6001\uff0c\u4f46\u8fd8\u662f\u62ff\u7740\u4e00\u4e2a MDL \u8bfb\u9501\u7684\u3002\u5982\u679c\u7ebf\u7a0b\u88ab kill \u7684\u65f6\u5019\uff0c\u5c31\u76f4\u63a5\u7ec8\u6b62\uff0c\u90a3\u4e4b\u540e\u8fd9\u4e2a MDL \u8bfb\u9501\u5c31\u6ca1\u673a\u4f1a\u88ab\u91ca\u653e\u4e86\u3002</p>\n<p>\u8fd9\u6837\u770b\u6765\uff0ckill \u5e76\u4e0d\u662f\u9a6c\u4e0a\u505c\u6b62\u7684\u610f\u601d\uff0c\u800c\u662f\u544a\u8bc9\u6267\u884c\u7ebf\u7a0b\u8bf4\uff0c\u8fd9\u6761\u8bed\u53e5\u5df2\u7ecf\u4e0d\u9700\u8981\u7ee7\u7eed\u6267\u884c\u4e86\uff0c\u53ef\u4ee5\u5f00\u59cb\u201c\u6267\u884c\u505c\u6b62\u7684\u903b\u8f91\u4e86\u201d\u3002</p>\n<blockquote>\n<p>\u5176\u5b9e\uff0c\u8fd9\u8ddf Linux \u7684 kill \u547d\u4ee4\u7c7b\u4f3c\uff0ckill -N pid \u5e76\u4e0d\u662f\u8ba9\u8fdb\u7a0b\u76f4\u63a5\u505c\u6b62\uff0c\u800c\u662f\u7ed9\u8fdb\u7a0b\u53d1\u4e00\u4e2a\u4fe1\u53f7\uff0c\u7136\u540e\u8fdb\u7a0b\u5904\u7406\u8fd9\u4e2a\u4fe1\u53f7\uff0c\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u3002\u53ea\u662f\u5bf9\u4e8e MySQL \u7684 kill \u547d\u4ee4\u6765\u8bf4\uff0c\u4e0d\u9700\u8981\u4f20\u4fe1\u53f7\u91cf\u53c2\u6570\uff0c\u5c31\u53ea\u6709\u201c\u505c\u6b62\u201d\u8fd9\u4e2a\u547d\u4ee4\u3002</p>\n</blockquote>\n<p><strong>\u5b9e\u73b0\u4e0a\uff0c\u5f53\u7528\u6237\u6267\u884c <code>kill query thread_id_B</code> \u65f6\uff0cMySQL \u91cc\u5904\u7406 kill \u547d\u4ee4\u7684\u7ebf\u7a0b\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a</strong></p>\n<ol>\n<li>\u628a session B \u7684\u8fd0\u884c\u72b6\u6001\u6539\u6210 <code>THD::KILL_QUERY</code>(\u5c06\u53d8\u91cf killed \u8d4b\u503c\u4e3a <code>THD::KILL_QUERY</code>)\uff1b</li>\n<li>\u7ed9 session B \u7684\u6267\u884c\u7ebf\u7a0b\u53d1\u4e00\u4e2a\u4fe1\u53f7\u3002</li>\n</ol>\n<p>\u4e3a\u4ec0\u4e48\u8981\u53d1\u4fe1\u53f7\u5462\uff1f</p>\n<p>\u56e0\u4e3a\u50cf\u56fe 1 \u7684\u6211\u4eec\u4f8b\u5b50\u91cc\u9762\uff0csession B \u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\uff0c\u5982\u679c\u53ea\u662f\u628a session B \u7684\u7ebf\u7a0b\u72b6\u6001\u8bbe\u7f6e  <code>THD::KILL_QUERY</code>\uff0c\u7ebf\u7a0b B \u5e76\u4e0d\u77e5\u9053\u8fd9\u4e2a\u72b6\u6001\u53d8\u5316\uff0c\u8fd8\u662f\u4f1a\u7ee7\u7eed\u7b49\u5f85\u3002\u53d1\u4e00\u4e2a\u4fe1\u53f7\u7684\u76ee\u7684\uff0c\u5c31\u662f\u8ba9 session B \u9000\u51fa\u7b49\u5f85\uff0c\u6765\u5904\u7406\u8fd9\u4e2a  <code>THD::KILL_QUERY</code> \u72b6\u6001\u3002</p>\n<p>\u4e0a\u9762\u7684\u5206\u6790\u4e2d\uff0c\u9690\u542b\u4e86\u8fd9\u4e48\u4e09\u5c42\u610f\u601d\uff1a</p>\n<ol>\n<li>\u4e00\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u6709\u591a\u5904\u201c\u57cb\u70b9\u201d\uff0c\u5728\u8fd9\u4e9b\u201c\u57cb\u70b9\u201d\u7684\u5730\u65b9\u5224\u65ad\u7ebf\u7a0b\u72b6\u6001\uff0c\u5982\u679c\u53d1\u73b0\u7ebf\u7a0b\u72b6\u6001\u662f  <code>THD::KILL_QUERY</code>\uff0c\u624d\u5f00\u59cb\u8fdb\u5165\u8bed\u53e5\u7ec8\u6b62\u903b\u8f91\uff1b</li>\n<li>\u5982\u679c\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u5fc5\u987b\u662f\u4e00\u4e2a\u53ef\u4ee5\u88ab\u5524\u9192\u7684\u7b49\u5f85\uff0c\u5426\u5219\u6839\u672c\u4e0d\u4f1a\u6267\u884c\u5230\u201c\u57cb\u70b9\u201d\u5904\uff1b</li>\n<li>\u8bed\u53e5\u4ece\u5f00\u59cb\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\uff0c\u5230\u7ec8\u6b62\u903b\u8f91\u5b8c\u5168\u5b8c\u6210\uff0c\u662f\u6709\u4e00\u4e2a\u8fc7\u7a0b\u7684\u3002</li>\n</ol>\n<p>\u5230\u8fd9\u91cc\u4f60\u5c31\u77e5\u9053\u4e86\uff0c\u539f\u6765\u4e0d\u662f\u201c\u8bf4\u505c\u5c31\u505c\u7684\u201d\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec**\u518d\u770b\u4e00\u4e2a kill \u4e0d\u6389\u7684\u4f8b\u5b50**\uff0c\u4e5f\u5c31\u662f <code>innodb_thread_concurrency</code> \u4e0d\u591f\u7528\u7684\u4f8b\u5b50\u3002</p>\n<p>\u9996\u5148\uff0c\u6267\u884c set global innodb_thread_concurrency=2\uff0c\u5c06 InnoDB \u7684\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u6570\u8bbe\u7f6e\u4e3a 2\uff1b\u7136\u540e\uff0c\u6267\u884c\u4e0b\u9762\u7684\u5e8f\u5217\uff1a</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\nparticipant SessionA\nparticipant SessionB\nparticipant SessionC\nparticipant SessionD\nparticipant SessionE\nparticipant Table\npar \nSessionA -&gt;&gt;Table: select sleep(100) from t;\nand \nSessionB -&gt;&gt; Table: select sleep(100) from t;\nend\nSessionC -&gt;&gt;+ Table: select * from t\nTable --&gt;&gt;- SessionC: blocked\n\nSessionD -&gt;&gt; Table: kill query SessionC\npar\nSessionE -&gt;&gt; Table: kill SessionC\nand \nTable --&gt;&gt; SessionC: ERROR 2013(HY000): Lost connection to MySQL server during query\nend</code></pre>\n<p>\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ol>\n<li>\n<p>sesssion C \u6267\u884c\u7684\u65f6\u5019\u88ab\u5835\u4f4f\u4e86\uff1b</p>\n</li>\n<li>\n<p>\u4f46\u662f session D \u6267\u884c\u7684 kill query C \u547d\u4ee4\u5374\u6ca1\u4ec0\u4e48\u6548\u679c\uff0c</p>\n</li>\n<li>\n<p>\u76f4\u5230 session E \u6267\u884c\u4e86 kill connection \u547d\u4ee4\uff0c\u624d\u65ad\u5f00\u4e86 session C \u7684\u8fde\u63a5\uff0c\u63d0\u793a\u201cLost connection to MySQL server during query\u201d\uff0c</p>\n</li>\n<li>\n<p>\u4f46\u662f\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u5728 session E \u4e2d\u6267\u884c show processlist\uff0c\u4f60\u5c31\u80fd\u770b\u5230\u4e0b\u9762\u8fd9\u4e2a\u56fe\u3002</p>\n</li>\n</ol>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+-----------------+------+---------+------+--------------+---------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Host</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">State</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">                      </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+-----------------+------+---------+------+--------------+---------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"p\">:</span><span class=\"mi\">50934</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"p\">:</span><span class=\"mi\">50956</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">26</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"p\">:</span><span class=\"mi\">53288</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"k\">data</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">           </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+-----------------+------+---------+------+--------------+---------------------------+</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\uff0cid=12 \u8fd9\u4e2a\u7ebf\u7a0b\u7684 Commnad \u5217\u663e\u793a\u7684\u662f Killed\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5ba2\u6237\u7aef\u867d\u7136\u65ad\u5f00\u4e86\u8fde\u63a5\uff0c\u4f46\u5b9e\u9645\u4e0a\u670d\u52a1\u7aef\u4e0a\u8fd9\u6761\u8bed\u53e5\u8fd8\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u3002</p>\n<p><strong>\u4e3a\u4ec0\u4e48\u5728\u6267\u884c kill query \u547d\u4ee4\u65f6\uff0c\u8fd9\u6761\u8bed\u53e5\u4e0d\u50cf\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u7684 update \u8bed\u53e5\u4e00\u6837\u9000\u51fa\u5462\uff1f</strong></p>\n<p>\u5728\u5b9e\u73b0\u4e0a\uff0c\u7b49\u884c\u9501\u65f6\uff0c\u4f7f\u7528\u7684\u662f pthread_cond_timedwait \u51fd\u6570\uff0c\u8fd9\u4e2a\u7b49\u5f85\u72b6\u6001\u53ef\u4ee5\u88ab\u5524\u9192\u3002\u4f46\u662f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c12 \u53f7\u7ebf\u7a0b\u7684\u7b49\u5f85\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a\u6bcf 10 \u6beb\u79d2\u5224\u65ad\u4e00\u4e0b\u662f\u5426\u53ef\u4ee5\u8fdb\u5165 InnoDB \u6267\u884c\uff0c\u5982\u679c\u4e0d\u884c\uff0c\u5c31\u8c03\u7528 nanosleep \u51fd\u6570\u8fdb\u5165 sleep \u72b6\u6001\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u867d\u7136 12 \u53f7\u7ebf\u7a0b\u7684\u72b6\u6001\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u6210\u4e86 KILL_QUERY\uff0c\u4f46\u662f\u5728\u8fd9\u4e2a\u7b49\u5f85\u8fdb\u5165 InnoDB \u7684\u5faa\u73af\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u6ca1\u6709\u53bb\u5224\u65ad\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u56e0\u6b64\u6839\u672c\u4e0d\u4f1a\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002</p>\n<p>\u800c\u5f53 session E \u6267\u884c kill connection \u547d\u4ee4\u65f6\uff0c\u662f\u8fd9\u4e48\u505a\u7684\uff0c</p>\n<ol>\n<li>\u628a 12 \u53f7\u7ebf\u7a0b\u72b6\u6001\u8bbe\u7f6e\u4e3a KILL_CONNECTION\uff1b</li>\n<li>\u5173\u6389 12 \u53f7\u7ebf\u7a0b\u7684\u7f51\u7edc\u8fde\u63a5\u3002\u56e0\u4e3a\u6709\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u6240\u4ee5\u4f60\u4f1a\u770b\u5230\uff0c\u8fd9\u65f6\u5019 session C \u6536\u5230\u4e86\u65ad\u5f00\u8fde\u63a5\u7684\u63d0\u793a\u3002</li>\n</ol>\n<p>\u90a3\u4e3a\u4ec0\u4e48\u6267\u884c show processlist \u7684\u65f6\u5019\uff0c\u4f1a\u770b\u5230 Command \u5217\u663e\u793a\u4e3a killed \u5462\uff1f\u5176\u5b9e\uff0c\u8fd9\u5c31\u662f\u56e0\u4e3a\u5728\u6267\u884c show processlist \u7684\u65f6\u5019\uff0c\u6709\u4e00\u4e2a\u7279\u522b\u7684\u903b\u8f91\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code>\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u662f KILL_CONNECTION\uff0c\u5c31\u628a Command \u5217\u663e\u793a\u6210 Killed\u3002\n</code></pre></div>\n<p>\u6240\u4ee5\u5176\u5b9e\uff0c\u5373\u4f7f\u662f\u5ba2\u6237\u7aef\u9000\u51fa\u4e86\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u4ecd\u7136\u662f\u5728\u7b49\u5f85\u4e2d\u3002\u90a3\u8fd9\u4e2a\u7ebf\u7a0b\u4ec0\u4e48\u65f6\u5019\u4f1a\u9000\u51fa\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u53ea\u6709\u7b49\u5230\u6ee1\u8db3\u8fdb\u5165 InnoDB \u7684\u6761\u4ef6\u540e\uff0csession C \u7684\u67e5\u8be2\u8bed\u53e5\u7ee7\u7eed\u6267\u884c\uff0c\u7136\u540e\u624d\u6709\u53ef\u80fd\u5224\u65ad\u5230\u7ebf\u7a0b\u72b6\u6001\u5df2\u7ecf\u53d8\u6210\u4e86 KILL_QUERY \u6216\u8005 KILL_CONNECTION\uff0c\u518d\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u6765\u5c0f\u7ed3\u4e00\u4e0b\u3002</p>\n<p>**\u8fd9\u4e2a\u4f8b\u5b50\u662f kill \u65e0\u6548\u7684\u7b2c\u4e00\u7c7b\u60c5\u51b5\uff0c\u5373\uff1a\u7ebf\u7a0b\u6ca1\u6709\u6267\u884c\u5230\u5224\u65ad\u7ebf\u7a0b\u72b6\u6001\u7684\u903b\u8f91\u3002**\u8ddf\u8fd9\u79cd\u60c5\u51b5\u76f8\u540c\u7684\uff0c\u8fd8\u6709\u7531\u4e8e IO \u538b\u529b\u8fc7\u5927\uff0c\u8bfb\u5199 IO \u7684\u51fd\u6570\u4e00\u76f4\u65e0\u6cd5\u8fd4\u56de\uff0c\u5bfc\u81f4\u4e0d\u80fd\u53ca\u65f6\u5224\u65ad\u7ebf\u7a0b\u7684\u72b6\u6001\u3002</p>\n<p>**\u53e6\u4e00\u7c7b\u60c5\u51b5\u662f\uff0c\u7ec8\u6b62\u903b\u8f91\u8017\u65f6\u8f83\u957f\u3002**\u8fd9\u65f6\u5019\uff0c\u4ece show processlist \u7ed3\u679c\u4e0a\u770b\u4e5f\u662f Command=Killed\uff0c\u9700\u8981\u7b49\u5230\u7ec8\u6b62\u903b\u8f91\u5b8c\u6210\uff0c\u8bed\u53e5\u624d\u7b97\u771f\u6b63\u5b8c\u6210\u3002\u8fd9\u7c7b\u60c5\u51b5\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u573a\u666f\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p>\n<ol>\n<li>\u8d85\u5927\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u88ab kill\u3002\u8fd9\u65f6\u5019\uff0c\u56de\u6eda\u64cd\u4f5c\u9700\u8981\u5bf9\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u65b0\u6570\u636e\u7248\u672c\u505a\u56de\u6536\u64cd\u4f5c\uff0c\u8017\u65f6\u5f88\u957f\u3002</li>\n<li>\u5927\u67e5\u8be2\u56de\u6eda\u3002\u5982\u679c\u67e5\u8be2\u8fc7\u7a0b\u4e2d\u751f\u6210\u4e86\u6bd4\u8f83\u5927\u7684\u4e34\u65f6\u6587\u4ef6\uff0c\u52a0\u4e0a\u6b64\u65f6\u6587\u4ef6\u7cfb\u7edf\u538b\u529b\u5927\uff0c\u5220\u9664\u4e34\u65f6\u6587\u4ef6\u53ef\u80fd\u9700\u8981\u7b49\u5f85 IO \u8d44\u6e90\uff0c\u5bfc\u81f4\u8017\u65f6\u8f83\u957f\u3002</li>\n<li>DDL \u547d\u4ee4\u6267\u884c\u5230\u6700\u540e\u9636\u6bb5\uff0c\u5982\u679c\u88ab kill\uff0c\u9700\u8981\u5220\u9664\u4e2d\u95f4\u8fc7\u7a0b\u7684\u4e34\u65f6\u6587\u4ef6\uff0c\u4e5f\u53ef\u80fd\u53d7 IO \u8d44\u6e90\u5f71\u54cd\u8017\u65f6\u8f83\u4e45\u3002</li>\n</ol>\n<p>\u4e4b\u524d\u6709\u4eba\u95ee\u8fc7\u6211\uff0c\u5982\u679c\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u901a\u8fc7 Ctrl+C \u547d\u4ee4\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u76f4\u63a5\u7ec8\u6b62\u7ebf\u7a0b\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u4e0d\u53ef\u4ee5\u3002</p>\n<p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u8bef\u89e3\uff0c\u5176\u5b9e\u5728\u5ba2\u6237\u7aef\u7684\u64cd\u4f5c\u53ea\u80fd\u64cd\u4f5c\u5230\u5ba2\u6237\u7aef\u7684\u7ebf\u7a0b\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u53ea\u80fd\u901a\u8fc7\u7f51\u7edc\u4ea4\u4e92\uff0c\u662f\u4e0d\u53ef\u80fd\u76f4\u63a5\u64cd\u4f5c\u670d\u52a1\u7aef\u7ebf\u7a0b\u7684\u3002</p>\n<p>\u800c\u7531\u4e8e MySQL \u662f\u505c\u7b49\u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u4e2a\u7ebf\u7a0b\u6267\u884c\u7684\u8bed\u53e5\u8fd8\u6ca1\u6709\u8fd4\u56de\u7684\u65f6\u5019\uff0c\u518d\u5f80\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7ee7\u7eed\u53d1\u547d\u4ee4\u4e5f\u662f\u6ca1\u6709\u7528\u7684\u3002\u5b9e\u9645\u4e0a\uff0c\u6267\u884c Ctrl+C \u7684\u65f6\u5019\uff0c\u662f MySQL \u5ba2\u6237\u7aef\u53e6\u5916\u542f\u52a8\u4e00\u4e2a\u8fde\u63a5\uff0c\u7136\u540e\u53d1\u9001\u4e00\u4e2a kill query \u547d\u4ee4\u3002</p>\n<p>\u6240\u4ee5\uff0c\u4f60\u53ef\u522b\u4ee5\u4e3a\u5728\u5ba2\u6237\u7aef\u6267\u884c\u5b8c Ctrl+C \u5c31\u4e07\u4e8b\u5927\u5409\u4e86\u3002\u56e0\u4e3a\uff0c\u8981 kill \u6389\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8fd8\u6d89\u53ca\u5230\u540e\u7aef\u7684\u5f88\u591a\u64cd\u4f5c\u3002</p>\n<h3 id=\"_12\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_12\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u9996\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u4e2d\uff0c\u6709\u4e9b\u8bed\u53e5\u548c\u8fde\u63a5\u201ckill \u4e0d\u6389\u201d\u7684\u60c5\u51b5\u3002</p>\n<p>\u8fd9\u4e9b\u201ckill \u4e0d\u6389\u201d\u7684\u60c5\u51b5\uff0c\u5176\u5b9e\u662f\u56e0\u4e3a\u53d1\u9001 kill \u547d\u4ee4\u7684\u5ba2\u6237\u7aef\uff0c\u5e76\u6ca1\u6709\u5f3a\u884c\u505c\u6b62\u76ee\u6807\u7ebf\u7a0b\u7684\u6267\u884c\uff0c\u800c\u53ea\u662f\u8bbe\u7f6e\u4e86\u4e2a\u72b6\u6001\uff0c\u5e76\u5524\u9192\u5bf9\u5e94\u7684\u7ebf\u7a0b\u3002\u800c\u88ab kill \u7684\u7ebf\u7a0b\uff0c\u9700\u8981\u6267\u884c\u5230\u5224\u65ad\u72b6\u6001\u7684\u201c\u57cb\u70b9\u201d\uff0c\u624d\u4f1a\u5f00\u59cb\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002\u5e76\u4e14\uff0c\u7ec8\u6b62\u903b\u8f91\u672c\u8eab\u4e5f\u662f\u9700\u8981\u8017\u8d39\u65f6\u95f4\u7684\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u53d1\u73b0\u4e00\u4e2a\u7ebf\u7a0b\u5904\u4e8e Killed \u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff0c\u901a\u8fc7\u5f71\u54cd\u7cfb\u7edf\u73af\u5883\uff0c\u8ba9\u8fd9\u4e2a Killed \u72b6\u6001\u5c3d\u5feb\u7ed3\u675f\u3002</p>\n<p>\u6bd4\u5982\uff0c\u5982\u679c\u662f\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u91cc InnoDB \u5e76\u53d1\u5ea6\u7684\u95ee\u9898\uff0c\u4f60\u5c31\u53ef\u4ee5\u4e34\u65f6\u8c03\u5927 <code>innodb_thread_concurrency</code> \u7684\u503c\uff0c\u6216\u8005\u505c\u6389\u522b\u7684\u7ebf\u7a0b\uff0c\u8ba9\u51fa\u4f4d\u5b50\u7ed9\u8fd9\u4e2a\u7ebf\u7a0b\u6267\u884c\u3002</p>\n<p>\u800c\u5982\u679c\u662f\u56de\u6eda\u903b\u8f91\u7531\u4e8e\u53d7\u5230 IO \u8d44\u6e90\u9650\u5236\u6267\u884c\u5f97\u6bd4\u8f83\u6162\uff0c\u5c31\u901a\u8fc7\u51cf\u5c11\u7cfb\u7edf\u538b\u529b\u8ba9\u5b83\u52a0\u901f\u3002</p>\n<p>\u505a\u5b8c\u8fd9\u4e9b\u64cd\u4f5c\u540e\uff0c\u5176\u5b9e\u4f60\u5df2\u7ecf\u6ca1\u6709\u529e\u6cd5\u518d\u5bf9\u5b83\u505a\u4ec0\u4e48\u4e86\uff0c\u53ea\u80fd\u7b49\u5f85\u6d41\u7a0b\u81ea\u5df1\u5b8c\u6210\u3002</p>\n<h2 id=\"33\">33 \u6211\u67e5\u8fd9\u4e48\u591a\u6570\u636e\uff0c\u4f1a\u4e0d\u4f1a\u628a\u6570\u636e\u5e93\u5185\u5b58\u6253\u7206\uff1f<a class=\"headerlink\" href=\"#33\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u7ecf\u5e38\u4f1a\u88ab\u95ee\u5230\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a\u6211\u7684\u4e3b\u673a\u5185\u5b58\u53ea\u6709 100G\uff0c\u73b0\u5728\u8981\u5bf9\u4e00\u4e2a 200G \u7684\u5927\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u4f1a\u4e0d\u4f1a\u628a\u6570\u636e\u5e93\u4e3b\u673a\u7684\u5185\u5b58\u7528\u5149\u4e86\uff1f</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u786e\u5b9e\u503c\u5f97\u62c5\u5fc3\uff0c\u88ab\u7cfb\u7edf OOM\uff08out of memory\uff09\u53ef\u4e0d\u662f\u95f9\u7740\u73a9\u7684\u3002\u4f46\u662f\uff0c\u53cd\u8fc7\u6765\u60f3\u60f3\uff0c\u903b\u8f91\u5907\u4efd\u7684\u65f6\u5019\uff0c\u53ef\u4e0d\u5c31\u662f\u505a\u6574\u5e93\u626b\u63cf\u5417\uff1f\u5982\u679c\u8fd9\u6837\u5c31\u4f1a\u628a\u5185\u5b58\u5403\u5149\uff0c\u903b\u8f91\u5907\u4efd\u4e0d\u662f\u65e9\u5c31\u6302\u4e86\uff1f</p>\n<p>\u6240\u4ee5\u8bf4\uff0c\u5bf9\u5927\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u770b\u6765\u5e94\u8be5\u662f\u6ca1\u95ee\u9898\u7684\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u6d41\u7a0b\u5230\u5e95\u662f\u600e\u4e48\u6837\u7684\u5462\uff1f</p>\n<h3 id=\"server\">\u5168\u8868\u626b\u63cf\u5bf9 server \u5c42\u7684\u5f71\u54cd<a class=\"headerlink\" href=\"#server\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5047\u8bbe\uff0c\u6211\u4eec\u73b0\u5728\u8981\u5bf9\u4e00\u4e2a 200G \u7684 InnoDB \u8868 db1. t\uff0c\u6267\u884c\u4e00\u4e2a\u5168\u8868\u626b\u63cf\u3002\u5f53\u7136\uff0c\u4f60\u8981\u628a\u626b\u63cf\u7ed3\u679c\u4fdd\u5b58\u5728\u5ba2\u6237\u7aef\uff0c\u4f1a\u4f7f\u7528\u7c7b\u4f3c\u8fd9\u6837\u7684\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h$host</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P$port</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u$user</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p$pwd</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"ss\">&quot;select * from db1.t&quot;</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"err\">$</span><span class=\"n\">target_file</span>\n</code></pre></div>\n<p>\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\uff0cInnoDB \u7684\u6570\u636e\u662f\u4fdd\u5b58\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\uff0c\u6240\u4ee5\u5168\u8868\u626b\u63cf\u5b9e\u9645\u4e0a\u662f\u76f4\u63a5\u626b\u63cf\u8868 t \u7684\u4e3b\u952e\u7d22\u5f15\u3002\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7531\u4e8e\u6ca1\u6709\u5176\u4ed6\u7684\u5224\u65ad\u6761\u4ef6\uff0c\u6240\u4ee5\u67e5\u5230\u7684\u6bcf\u4e00\u884c\u90fd\u53ef\u4ee5\u76f4\u63a5\u653e\u5230\u7ed3\u679c\u96c6\u91cc\u9762\uff0c\u7136\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</p>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u201c\u7ed3\u679c\u96c6\u201d\u5b58\u5728\u54ea\u91cc\u5462\uff1f</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u670d\u52a1\u7aef\u5e76\u4e0d\u9700\u8981\u4fdd\u5b58\u4e00\u4e2a\u5b8c\u6574\u7684\u7ed3\u679c\u96c6\u3002\u53d6\u6570\u636e\u548c\u53d1\u6570\u636e\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u83b7\u53d6\u4e00\u884c\uff0c\u5199\u5230 <code>net_buffer</code> \u4e2d\u3002\u8fd9\u5757\u5185\u5b58\u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>net_buffer_length</code> \u5b9a\u4e49\u7684\uff0c\u9ed8\u8ba4\u662f 16k\u3002</li>\n<li>\u91cd\u590d\u83b7\u53d6\u884c\uff0c\u76f4\u5230 <code>net_buffer</code> \u5199\u6ee1\uff0c\u8c03\u7528\u7f51\u7edc\u63a5\u53e3\u53d1\u51fa\u53bb\u3002</li>\n<li>\u5982\u679c\u53d1\u9001\u6210\u529f\uff0c\u5c31\u6e05\u7a7a <code>net_buffer</code>\uff0c\u7136\u540e\u7ee7\u7eed\u53d6\u4e0b\u4e00\u884c\uff0c\u5e76\u5199\u5165 <code>net_buffer</code>\u3002</li>\n<li>\u5982\u679c\u53d1\u9001\u51fd\u6570\u8fd4\u56de EAGAIN \u6216 WSAEWOULDBLOCK\uff0c\u5c31\u8868\u793a\u672c\u5730\u7f51\u7edc\u6808\uff08socket send buffer\uff09\u5199\u6ee1\u4e86\uff0c\u8fdb\u5165\u7b49\u5f85\u3002\u76f4\u5230\u7f51\u7edc\u6808\u91cd\u65b0\u53ef\u5199\uff0c\u518d\u7ee7\u7eed\u53d1\u9001\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u5bf9\u5e94\u7684\u6d41\u7a0b\u56fe\u5982\u4e0b\u6240\u793a\u3002</p>\n<pre class=\"mermaid\"><code>%%{init: {\"theme\": \"dark\"}}%%\ngraph LR\nsubgraph client\nnode1[\"socket receive buffer\"]\nend\nsubgraph server\n  subgraph MySQL\n    direction TB\n    data --&gt; net_buffer\n  end\n  net_buffer --&gt; node2[\"socket send buffer\"]\nend\nserver --&gt; client</code></pre>\n<p>\u4ece\u8fd9\u4e2a\u6d41\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ol>\n<li>\u4e00\u4e2a\u67e5\u8be2\u5728\u53d1\u9001\u8fc7\u7a0b\u4e2d\uff0c\u5360\u7528\u7684 MySQL \u5185\u90e8\u7684\u5185\u5b58\u6700\u5927\u5c31\u662f <code>net_buffer_length</code> \u8fd9\u4e48\u5927\uff0c\u5e76\u4e0d\u4f1a\u8fbe\u5230 200G\uff1b</li>\n<li>socket send buffer \u4e5f\u4e0d\u53ef\u80fd\u8fbe\u5230 200G\uff08\u9ed8\u8ba4\u5b9a\u4e49 <code>/proc/sys/net/core/wmem_default</code>\uff09\uff0c\u5982\u679c socket send buffer \u88ab\u5199\u6ee1\uff0c\u5c31\u4f1a\u6682\u505c\u8bfb\u6570\u636e\u7684\u6d41\u7a0b\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<strong>MySQL \u662f\u201c\u8fb9\u8bfb\u8fb9\u53d1\u7684\u201d</strong>\uff0c\u8fd9\u4e2a\u6982\u5ff5\u5f88\u91cd\u8981\u3002\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u63a5\u6536\u5f97\u6162\uff0c\u4f1a\u5bfc\u81f4 MySQL \u670d\u52a1\u7aef\u7531\u4e8e\u7ed3\u679c\u53d1\u4e0d\u51fa\u53bb\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u7684\u6267\u884c\u65f6\u95f4\u53d8\u957f\u3002</p>\n<p>\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u72b6\u6001\uff0c\u5c31\u662f\u6211\u6545\u610f\u8ba9\u5ba2\u6237\u7aef\u4e0d\u53bb\u8bfb socket receive buffer \u4e2d\u7684\u5185\u5bb9\uff0c\u7136\u540e\u5728\u670d\u52a1\u7aef show processlist \u770b\u5230\u7684\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+--------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">User</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Host</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Time</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">State</span><span class=\"w\">                  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+--------+------------------------+------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">event_scheduler</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Daemon</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">151029</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Waiting</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"n\">queue</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\">               </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">processlist</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\">            </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">localhost</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-----------------+-----------+------+---------+--------+------------------------+------------------+</span>\n</code></pre></div>\n<p>\u5982\u679c\u4f60\u770b\u5230 State \u7684\u503c\u4e00\u76f4\u5904\u4e8e**\u201cSending to client\u201d**\uff0c\u5c31\u8868\u793a\u670d\u52a1\u5668\u7aef\u7684\u7f51\u7edc\u6808\u5199\u6ee1\u4e86\u3002</p>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u66fe\u63d0\u5230\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u4f7f\u7528 <code>\u2013-quick</code> \u53c2\u6570\uff0c\u4f1a\u4f7f\u7528 <code>mysql_use_result</code> \u65b9\u6cd5\u3002\u8fd9\u4e2a\u65b9\u6cd5\u662f\u8bfb\u4e00\u884c\u5904\u7406\u4e00\u884c\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5047\u8bbe\u6709\u4e00\u4e2a\u4e1a\u52a1\u7684\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u6bcf\u8bfb\u4e00\u884c\u6570\u636e\u4ee5\u540e\u8981\u5904\u7406\u7684\u903b\u8f91\u5982\u679c\u5f88\u6162\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5ba2\u6237\u7aef\u8981\u8fc7\u5f88\u4e45\u624d\u4f1a\u53bb\u53d6\u4e0b\u4e00\u884c\u6570\u636e\uff0c\u53ef\u80fd\u5c31\u4f1a\u51fa\u73b0\u5982\u56fe \u6240\u793a\u7684\u8fd9\u79cd\u60c5\u51b5\u3002</p>\n<p>\u56e0\u6b64\uff0c<strong>\u5bf9\u4e8e\u6b63\u5e38\u7684\u7ebf\u4e0a\u4e1a\u52a1\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u7684\u8fd4\u56de\u7ed3\u679c\u4e0d\u4f1a\u5f88\u591a\u7684\u8bdd\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u4f7f\u7528 <code>mysql_store_result</code> \u8fd9\u4e2a\u63a5\u53e3\uff0c\u76f4\u63a5\u628a\u67e5\u8be2\u7ed3\u679c\u4fdd\u5b58\u5230\u672c\u5730\u5185\u5b58\u3002</strong></p>\n<p>\u5f53\u7136\u524d\u63d0\u662f\u67e5\u8be2\u8fd4\u56de\u7ed3\u679c\u4e0d\u591a\u3002</p>\n<p>\u53e6\u4e00\u65b9\u9762\uff0c\u5982\u679c\u4f60\u5728\u81ea\u5df1\u8d1f\u8d23\u7ef4\u62a4\u7684 MySQL \u91cc\u770b\u5230\u5f88\u591a\u4e2a\u7ebf\u7a0b\u90fd\u5904\u4e8e\u201cSending to client\u201d\u8fd9\u4e2a\u72b6\u6001\uff0c\u5c31\u610f\u5473\u7740\u4f60\u8981\u8ba9\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u4f18\u5316\u67e5\u8be2\u7ed3\u679c\uff0c\u5e76\u8bc4\u4f30\u8fd9\u4e48\u591a\u7684\u8fd4\u56de\u7ed3\u679c\u662f\u5426\u5408\u7406\u3002</p>\n<p>\u800c\u5982\u679c\u8981\u5feb\u901f\u51cf\u5c11\u5904\u4e8e\u8fd9\u4e2a\u72b6\u6001\u7684\u7ebf\u7a0b\u7684\u8bdd\uff0c\u5c06 <code>net_buffer_length</code> \u53c2\u6570\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u66f4\u5927\u7684\u503c\u662f\u4e00\u4e2a\u53ef\u9009\u65b9\u6848\u3002</p>\n<p>\u4e0e \u201cSending to client\u201d \u957f\u76f8\u5f88\u7c7b\u4f3c\u7684\u4e00\u4e2a\u72b6\u6001\u662f <strong>\u201cSending data\u201d</strong>\uff0c\u8fd9\u662f\u4e00\u4e2a\u7ecf\u5e38\u88ab\u8bef\u4f1a\u7684\u95ee\u9898\u3002\u6709\u540c\u5b66\u95ee\u6211\u8bf4\uff0c\u5728\u81ea\u5df1\u7ef4\u62a4\u7684\u5b9e\u4f8b\u4e0a\u770b\u5230\u5f88\u591a\u67e5\u8be2\u8bed\u53e5\u7684\u72b6\u6001\u662f\u201cSending data\u201d\uff0c\u4f46\u67e5\u770b\u7f51\u7edc\u4e5f\u6ca1\u4ec0\u4e48\u95ee\u9898\u554a\uff0c\u4e3a\u4ec0\u4e48 Sending data \u8981\u8fd9\u4e48\u4e45\uff1f</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u72b6\u6001\u53d8\u5316\u662f\u8fd9\u6837\u7684\uff08\u6ce8\u610f\uff1a\u8fd9\u91cc\uff0c\u6211\u7565\u53bb\u4e86\u5176\u4ed6\u65e0\u5173\u7684\u72b6\u6001\uff09\uff1a</p>\n<ul>\n<li>MySQL \u67e5\u8be2\u8bed\u53e5\u8fdb\u5165\u6267\u884c\u9636\u6bb5\u540e\uff0c\u9996\u5148\u628a\u72b6\u6001\u8bbe\u7f6e\u6210\u201cSending data\u201d\uff1b</li>\n<li>\u7136\u540e\uff0c\u53d1\u9001\u6267\u884c\u7ed3\u679c\u7684\u5217\u76f8\u5173\u7684\u4fe1\u606f\uff08meta data) \u7ed9\u5ba2\u6237\u7aef\uff1b</li>\n<li>\u518d\u7ee7\u7eed\u6267\u884c\u8bed\u53e5\u7684\u6d41\u7a0b\uff1b</li>\n<li>\u6267\u884c\u5b8c\u6210\u540e\uff0c\u628a\u72b6\u6001\u8bbe\u7f6e\u6210\u7a7a\u5b57\u7b26\u4e32\u3002</li>\n</ul>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u201cSending data\u201d\u5e76\u4e0d\u4e00\u5b9a\u662f\u6307\u201c\u6b63\u5728\u53d1\u9001\u6570\u636e\u201d\uff0c\u800c\u53ef\u80fd\u662f\u5904\u4e8e\u6267\u884c\u5668\u8fc7\u7a0b\u4e2d\u7684\u4efb\u610f\u9636\u6bb5\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4ec5\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u5904\u4e8e\u201c\u7b49\u5f85\u5ba2\u6237\u7aef\u63a5\u6536\u7ed3\u679c\u201d\u7684\u72b6\u6001\uff0c\u624d\u4f1a\u663e\u793a\"Sending to client\"\uff1b\u800c\u5982\u679c\u663e\u793a\u6210\u201cSending data\u201d\uff0c\u5b83\u7684\u610f\u601d\u53ea\u662f\u201c\u6b63\u5728\u6267\u884c\u201d\u3002</p>\n<p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u67e5\u8be2\u7684\u7ed3\u679c\u662f\u5206\u6bb5\u53d1\u7ed9\u5ba2\u6237\u7aef\u7684\uff0c\u56e0\u6b64\u626b\u63cf\u5168\u8868\uff0c\u67e5\u8be2\u8fd4\u56de\u5927\u91cf\u7684\u6570\u636e\uff0c\u5e76\u4e0d\u4f1a\u628a\u5185\u5b58\u6253\u7206\u3002</p>\n<p>\u5728 server \u5c42\u7684\u5904\u7406\u903b\u8f91\u6211\u4eec\u90fd\u6e05\u695a\u4e86\uff0c\u5728 InnoDB \u5f15\u64ce\u91cc\u9762\u53c8\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f \u626b\u63cf\u5168\u8868\u4f1a\u4e0d\u4f1a\u5bf9\u5f15\u64ce\u7cfb\u7edf\u9020\u6210\u5f71\u54cd\u5462\uff1f</p>\n<h3 id=\"innodb\">\u5168\u8868\u626b\u63cf\u5bf9 InnoDB \u7684\u5f71\u54cd<a class=\"headerlink\" href=\"#innodb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5185\u5b58\u7684\u6570\u636e\u9875\u662f\u5728 Buffer Pool (BP) \u4e2d\u7ba1\u7406\u7684\uff0c\u5728 WAL \u91cc Buffer Pool \u8d77\u5230\u4e86\u52a0\u901f\u66f4\u65b0\u7684\u4f5c\u7528\u3002\u800c\u5b9e\u9645\u4e0a\uff0cBuffer Pool \u8fd8\u6709\u4e00\u4e2a\u66f4\u91cd\u8981\u7684\u4f5c\u7528\uff0c\u5c31\u662f\u52a0\u901f\u67e5\u8be2\u3002</p>\n<p>\u5728\u7b2c 2 \u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u95ee\u9053\uff0c\u7531\u4e8e\u6709 WAL \u673a\u5236\uff0c\u5f53\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u9875\u662f\u65e7\u7684\uff0c\u90a3\u5982\u679c\u8fd9\u65f6\u5019\u9a6c\u4e0a\u6709\u4e00\u4e2a\u67e5\u8be2\u8981\u6765\u8bfb\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u662f\u4e0d\u662f\u8981\u9a6c\u4e0a\u628a redo log \u5e94\u7528\u5230\u6570\u636e\u9875\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\u4e0d\u9700\u8981\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019\u5185\u5b58\u6570\u636e\u9875\u7684\u7ed3\u679c\u662f\u6700\u65b0\u7684\uff0c\u76f4\u63a5\u8bfb\u5185\u5b58\u9875\u5c31\u53ef\u4ee5\u4e86\u3002\u4f60\u770b\uff0c\u8fd9\u65f6\u5019\u67e5\u8be2\u6839\u672c\u4e0d\u9700\u8981\u8bfb\u78c1\u76d8\uff0c\u76f4\u63a5\u4ece\u5185\u5b58\u62ff\u7ed3\u679c\uff0c\u901f\u5ea6\u662f\u5f88\u5feb\u7684\u3002\u6240\u4ee5\u8bf4\uff0cBuffer Pool \u8fd8\u6709\u52a0\u901f\u67e5\u8be2\u7684\u4f5c\u7528\u3002</p>\n<p>\u800c Buffer Pool \u5bf9\u67e5\u8be2\u7684\u52a0\u901f\u6548\u679c\uff0c\u4f9d\u8d56\u4e8e\u4e00\u4e2a\u91cd\u8981\u7684\u6307\u6807\uff0c\u5373\uff1a<strong>\u5185\u5b58\u547d\u4e2d\u7387</strong>\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u5728 <code>show engine innodb status</code> \u7ed3\u679c\u4e2d\uff0c\u67e5\u770b\u4e00\u4e2a\u7cfb\u7edf\u5f53\u524d\u7684 BP \u547d\u4e2d\u7387\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u7a33\u5b9a\u670d\u52a1\u7684\u7ebf\u4e0a\u7cfb\u7edf\uff0c\u8981\u4fdd\u8bc1\u54cd\u5e94\u65f6\u95f4\u7b26\u5408\u8981\u6c42\u7684\u8bdd\uff0c\u5185\u5b58\u547d\u4e2d\u7387\u8981\u5728 99% \u4ee5\u4e0a\u3002</p>\n<p>\u6267\u884c <code>show engine innodb status</code> \uff0c\u53ef\u4ee5\u770b\u5230\u201cBuffer pool hit rate\u201d\u5b57\u6837\uff0c\u663e\u793a\u7684\u5c31\u662f\u5f53\u524d\u7684\u547d\u4e2d\u7387\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">Buffer</span><span class=\"w\"> </span><span class=\"n\">pool</span><span class=\"w\"> </span><span class=\"n\">hit</span><span class=\"w\"> </span><span class=\"n\">rate</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">young</span><span class=\"o\">-</span><span class=\"n\">making</span><span class=\"w\"> </span><span class=\"n\">rate</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">not</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n</code></pre></div>\n<p>\u5982\u679c\u6240\u6709\u67e5\u8be2\u9700\u8981\u7684\u6570\u636e\u9875\u90fd\u80fd\u591f\u76f4\u63a5\u4ece\u5185\u5b58\u5f97\u5230\uff0c\u90a3\u662f\u6700\u597d\u7684\uff0c\u5bf9\u5e94\u7684\u547d\u4e2d\u7387\u5c31\u662f 100%\u3002\u4f46\uff0c\u8fd9\u5728\u5b9e\u9645\u751f\u4ea7\u4e0a\u662f\u5f88\u96be\u505a\u5230\u7684\u3002</p>\n<p>InnoDB Buffer Pool \u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>innodb_buffer_pool_size</code> \u786e\u5b9a\u7684\uff0c\u4e00\u822c\u5efa\u8bae\u8bbe\u7f6e\u6210\u53ef\u7528\u7269\u7406\u5185\u5b58\u7684 60%~80%\u3002</p>\n<p>\u5728\u5927\u7ea6\u5341\u5e74\u524d\uff0c\u5355\u673a\u7684\u6570\u636e\u91cf\u662f\u4e0a\u767e\u4e2a G\uff0c\u800c\u7269\u7406\u5185\u5b58\u662f\u51e0\u4e2a G\uff1b\u73b0\u5728\u867d\u7136\u5f88\u591a\u670d\u52a1\u5668\u90fd\u80fd\u6709 128G \u751a\u81f3\u66f4\u9ad8\u7684\u5185\u5b58\uff0c\u4f46\u662f\u5355\u673a\u7684\u6570\u636e\u91cf\u5374\u8fbe\u5230\u4e86 T \u7ea7\u522b\u3002</p>\n<p>\u6240\u4ee5\uff0c<code>innodb_buffer_pool_size</code> \u5c0f\u4e8e\u78c1\u76d8\u7684\u6570\u636e\u91cf\u662f\u5f88\u5e38\u89c1\u7684\u3002\u5982\u679c\u4e00\u4e2a Buffer Pool \u6ee1\u4e86\uff0c\u800c\u53c8\u8981\u4ece\u78c1\u76d8\u8bfb\u5165\u4e00\u4e2a\u6570\u636e\u9875\uff0c\u90a3\u80af\u5b9a\u662f\u8981\u6dd8\u6c70\u4e00\u4e2a\u65e7\u6570\u636e\u9875\u7684\u3002</p>\n<p>InnoDB \u5185\u5b58\u7ba1\u7406\u7528\u7684\u662f\u6700\u8fd1\u6700\u5c11\u4f7f\u7528 (Least Recently Used, LRU) \u7b97\u6cd5\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u7684\u6838\u5fc3\u5c31\u662f\u6dd8\u6c70\u6700\u4e45\u672a\u4f7f\u7528\u7684\u6570\u636e\u3002</p>\n<p>\u4e0b\u56fe\u662f\u4e00\u4e2a LRU \u7b97\u6cd5\u7684\u57fa\u672c\u6a21\u578b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/e0ac92febac50a5d881f1188ea5bfd65.jpg\" /></p>\n<p>\u56fe 6 \u57fa\u672c LRU \u7b97\u6cd5</p>\n<p>InnoDB \u7ba1\u7406 Buffer Pool \u7684 LRU \u7b97\u6cd5\uff0c\u662f\u7528\u94fe\u8868\u6765\u5b9e\u73b0\u7684\u3002</p>\n<ol>\n<li>\u5728\u56fe 6 \u7684\u72b6\u6001 1 \u91cc\uff0c\u94fe\u8868\u5934\u90e8\u662f P1\uff0c\u8868\u793a P1 \u662f\u6700\u8fd1\u521a\u521a\u88ab\u8bbf\u95ee\u8fc7\u7684\u6570\u636e\u9875\uff1b\u5047\u8bbe\u5185\u5b58\u91cc\u53ea\u80fd\u653e\u4e0b\u8fd9\u4e48\u591a\u6570\u636e\u9875\uff1b</li>\n<li>\u8fd9\u65f6\u5019\u6709\u4e00\u4e2a\u8bfb\u8bf7\u6c42\u8bbf\u95ee P3\uff0c\u56e0\u6b64\u53d8\u6210\u72b6\u6001 2\uff0cP3 \u88ab\u79fb\u5230\u6700\u524d\u9762\uff1b</li>\n<li>\u72b6\u6001 3 \u8868\u793a\uff0c\u8fd9\u6b21\u8bbf\u95ee\u7684\u6570\u636e\u9875\u662f\u4e0d\u5b58\u5728\u4e8e\u94fe\u8868\u4e2d\u7684\uff0c\u6240\u4ee5\u9700\u8981\u5728 Buffer Pool \u4e2d\u65b0\u7533\u8bf7\u4e00\u4e2a\u6570\u636e\u9875 Px\uff0c\u52a0\u5230\u94fe\u8868\u5934\u90e8\u3002\u4f46\u662f\u7531\u4e8e\u5185\u5b58\u5df2\u7ecf\u6ee1\u4e86\uff0c\u4e0d\u80fd\u7533\u8bf7\u65b0\u7684\u5185\u5b58\u3002\u4e8e\u662f\uff0c\u4f1a\u6e05\u7a7a\u94fe\u8868\u672b\u5c3e Pm \u8fd9\u4e2a\u6570\u636e\u9875\u7684\u5185\u5b58\uff0c\u5b58\u5165 Px \u7684\u5185\u5bb9\uff0c\u7136\u540e\u653e\u5230\u94fe\u8868\u5934\u90e8\u3002</li>\n<li>\u4ece\u6548\u679c\u4e0a\u770b\uff0c\u5c31\u662f\u6700\u4e45\u6ca1\u6709\u88ab\u8bbf\u95ee\u7684\u6570\u636e\u9875 Pm\uff0c\u88ab\u6dd8\u6c70\u4e86\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u7b97\u6cd5\u4e4d\u4e00\u770b\u4e0a\u53bb\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u662f\u5982\u679c\u8003\u8651\u5230\u8981\u505a\u4e00\u4e2a\u5168\u8868\u626b\u63cf\uff0c\u4f1a\u4e0d\u4f1a\u6709\u95ee\u9898\u5462\uff1f</p>\n<p>\u5047\u8bbe\u6309\u7167\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u6211\u4eec\u8981\u626b\u63cf\u4e00\u4e2a 200G \u7684\u8868\uff0c\u800c\u8fd9\u4e2a\u8868\u662f\u4e00\u4e2a\u5386\u53f2\u6570\u636e\u8868\uff0c\u5e73\u65f6\u6ca1\u6709\u4e1a\u52a1\u8bbf\u95ee\u5b83\u3002</p>\n<p>\u90a3\u4e48\uff0c\u6309\u7167\u8fd9\u4e2a\u7b97\u6cd5\u626b\u63cf\u7684\u8bdd\uff0c\u5c31\u4f1a\u628a\u5f53\u524d\u7684 Buffer Pool \u91cc\u7684\u6570\u636e\u5168\u90e8\u6dd8\u6c70\u6389\uff0c\u5b58\u5165\u626b\u63cf\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u6570\u636e\u9875\u7684\u5185\u5bb9\u3002\u4e5f\u5c31\u662f\u8bf4 Buffer Pool \u91cc\u9762\u4e3b\u8981\u653e\u7684\u662f\u8fd9\u4e2a\u5386\u53f2\u6570\u636e\u8868\u7684\u6570\u636e\u3002</p>\n<p>\u5bf9\u4e8e\u4e00\u4e2a\u6b63\u5728\u505a\u4e1a\u52a1\u670d\u52a1\u7684\u5e93\uff0c\u8fd9\u53ef\u4e0d\u5999\u3002\u4f60\u4f1a\u770b\u5230\uff0cBuffer Pool \u7684\u5185\u5b58\u547d\u4e2d\u7387\u6025\u5267\u4e0b\u964d\uff0c\u78c1\u76d8\u538b\u529b\u589e\u52a0\uff0cSQL \u8bed\u53e5\u54cd\u5e94\u53d8\u6162\u3002</p>\n<p>\u6240\u4ee5\uff0cInnoDB \u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a LRU \u7b97\u6cd5\u3002\u5b9e\u9645\u4e0a\uff0cInnoDB \u5bf9 LRU \u7b97\u6cd5\u505a\u4e86\u6539\u8fdb\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/25e18920dd204cf99eec2d62755fe99e.png\" /></p>\n<p>\u56fe 7 \u6539\u8fdb\u7684 LRU \u7b97\u6cd5</p>\n<p>\u5728 InnoDB \u5b9e\u73b0\u4e0a\uff0c\u6309\u7167 5:3 \u7684\u6bd4\u4f8b\u628a\u6574\u4e2a LRU \u94fe\u8868\u5206\u6210\u4e86 young \u533a\u57df\u548c old \u533a\u57df\u3002\u56fe\u4e2d LRU_old \u6307\u5411\u7684\u5c31\u662f old \u533a\u57df\u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u662f\u6574\u4e2a\u94fe\u8868\u7684 &#8541; \u5904\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u9760\u8fd1\u94fe\u8868\u5934\u90e8\u7684 &#8541; \u662f young \u533a\u57df\uff0c\u9760\u8fd1\u94fe\u8868\u5c3e\u90e8\u7684 &#8540; \u662f old \u533a\u57df\u3002</p>\n<p>\u6539\u8fdb\u540e\u7684 LRU \u7b97\u6cd5\u6267\u884c\u6d41\u7a0b\u53d8\u6210\u4e86\u4e0b\u9762\u8fd9\u6837\u3002</p>\n<ol>\n<li>\u56fe 7 \u4e2d\u72b6\u6001 1\uff0c\u8981\u8bbf\u95ee\u6570\u636e\u9875 P3\uff0c\u7531\u4e8e P3 \u5728 young \u533a\u57df\uff0c\u56e0\u6b64\u548c\u4f18\u5316\u524d\u7684 LRU \u7b97\u6cd5\u4e00\u6837\uff0c\u5c06\u5176\u79fb\u5230\u94fe\u8868\u5934\u90e8\uff0c\u53d8\u6210\u72b6\u6001 2\u3002</li>\n<li>\u4e4b\u540e\u8981\u8bbf\u95ee\u4e00\u4e2a\u65b0\u7684\u4e0d\u5b58\u5728\u4e8e\u5f53\u524d\u94fe\u8868\u7684\u6570\u636e\u9875\uff0c\u8fd9\u65f6\u5019\u4f9d\u7136\u662f\u6dd8\u6c70\u6389\u6570\u636e\u9875 Pm\uff0c\u4f46\u662f\u65b0\u63d2\u5165\u7684\u6570\u636e\u9875 Px\uff0c\u662f\u653e\u5728 LRU_old \u5904\u3002</li>\n<li>\u5904\u4e8e old \u533a\u57df\u7684\u6570\u636e\u9875\uff0c\u6bcf\u6b21\u88ab\u8bbf\u95ee\u7684\u65f6\u5019\u90fd\u8981\u505a\u4e0b\u9762\u8fd9\u4e2a\u5224\u65ad\uff1a </li>\n<li>\u82e5\u8fd9\u4e2a\u6570\u636e\u9875\u5728 LRU \u94fe\u8868\u4e2d\u5b58\u5728\u7684\u65f6\u95f4\u8d85\u8fc7\u4e86 1 \u79d2\uff0c\u5c31\u628a\u5b83\u79fb\u52a8\u5230\u94fe\u8868\u5934\u90e8\uff1b</li>\n<li>\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u5728 LRU \u94fe\u8868\u4e2d\u5b58\u5728\u7684\u65f6\u95f4\u77ed\u4e8e 1 \u79d2\uff0c\u4f4d\u7f6e\u4fdd\u6301\u4e0d\u53d8\u30021 \u79d2\u8fd9\u4e2a\u65f6\u95f4\uff0c\u662f\u7531\u53c2\u6570 innodb_old_blocks_time \u63a7\u5236\u7684\u3002\u5176\u9ed8\u8ba4\u503c\u662f 1000\uff0c\u5355\u4f4d\u6beb\u79d2\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u7b56\u7565\uff0c\u5c31\u662f\u4e3a\u4e86\u5904\u7406\u7c7b\u4f3c\u5168\u8868\u626b\u63cf\u7684\u64cd\u4f5c\u91cf\u8eab\u5b9a\u5236\u7684\u3002\u8fd8\u662f\u4ee5\u521a\u521a\u7684\u626b\u63cf 200G \u7684\u5386\u53f2\u6570\u636e\u8868\u4e3a\u4f8b\uff0c\u6211\u4eec\u770b\u770b\u6539\u8fdb\u540e\u7684 LRU \u7b97\u6cd5\u7684\u64cd\u4f5c\u903b\u8f91\uff1a</p>\n<ol>\n<li>\u626b\u63cf\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u65b0\u63d2\u5165\u7684\u6570\u636e\u9875\uff0c\u90fd\u88ab\u653e\u5230 old \u533a\u57df ;</li>\n<li>\u4e00\u4e2a\u6570\u636e\u9875\u91cc\u9762\u6709\u591a\u6761\u8bb0\u5f55\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u4f1a\u88ab\u591a\u6b21\u8bbf\u95ee\u5230\uff0c\u4f46\u7531\u4e8e\u662f\u987a\u5e8f\u626b\u63cf\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u7b2c\u4e00\u6b21\u88ab\u8bbf\u95ee\u548c\u6700\u540e\u4e00\u6b21\u88ab\u8bbf\u95ee\u7684\u65f6\u95f4\u95f4\u9694\u4e0d\u4f1a\u8d85\u8fc7 1 \u79d2\uff0c\u56e0\u6b64\u8fd8\u662f\u4f1a\u88ab\u4fdd\u7559\u5728 old \u533a\u57df\uff1b</li>\n<li>\u518d\u7ee7\u7eed\u626b\u63cf\u540e\u7eed\u7684\u6570\u636e\uff0c\u4e4b\u524d\u7684\u8fd9\u4e2a\u6570\u636e\u9875\u4e4b\u540e\u4e5f\u4e0d\u4f1a\u518d\u88ab\u8bbf\u95ee\u5230\uff0c\u4e8e\u662f\u59cb\u7ec8\u6ca1\u6709\u673a\u4f1a\u79fb\u5230\u94fe\u8868\u5934\u90e8\uff08\u4e5f\u5c31\u662f young \u533a\u57df\uff09\uff0c\u5f88\u5feb\u5c31\u4f1a\u88ab\u6dd8\u6c70\u51fa\u53bb\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u7b56\u7565\u6700\u5927\u7684\u6536\u76ca\uff0c\u5c31\u662f\u5728\u626b\u63cf\u8fd9\u4e2a\u5927\u8868\u7684\u8fc7\u7a0b\u4e2d\uff0c\u867d\u7136\u4e5f\u7528\u5230\u4e86 Buffer Pool\uff0c\u4f46\u662f\u5bf9 young \u533a\u57df\u5b8c\u5168\u6ca1\u6709\u5f71\u54cd\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86 Buffer Pool \u54cd\u5e94\u6b63\u5e38\u4e1a\u52a1\u7684\u67e5\u8be2\u547d\u4e2d\u7387\u3002</p>\n<h3 id=\"_13\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_13\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u7528\u201c\u5927\u67e5\u8be2\u4f1a\u4e0d\u4f1a\u628a\u5185\u5b58\u7528\u5149\u201d\u8fd9\u4e2a\u95ee\u9898\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u67e5\u8be2\u7ed3\u679c\uff0c\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u8fc7\u7a0b\u3002</p>\n<p>\u7531\u4e8e MySQL \u91c7\u7528\u7684\u662f\u8fb9\u7b97\u8fb9\u53d1\u7684\u903b\u8f91\uff0c\u56e0\u6b64\u5bf9\u4e8e\u6570\u636e\u91cf\u5f88\u5927\u7684\u67e5\u8be2\u7ed3\u679c\u6765\u8bf4\uff0c\u4e0d\u4f1a\u5728 server \u7aef\u4fdd\u5b58\u5b8c\u6574\u7684\u7ed3\u679c\u96c6\u3002\u6240\u4ee5\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u8bfb\u7ed3\u679c\u4e0d\u53ca\u65f6\uff0c\u4f1a\u5835\u4f4f MySQL \u7684\u67e5\u8be2\u8fc7\u7a0b\uff0c\u4f46\u662f\u4e0d\u4f1a\u628a\u5185\u5b58\u6253\u7206\u3002</p>\n<p>\u800c\u5bf9\u4e8e InnoDB \u5f15\u64ce\u5185\u90e8\uff0c\u7531\u4e8e\u6709\u6dd8\u6c70\u7b56\u7565\uff0c\u5927\u67e5\u8be2\u4e5f\u4e0d\u4f1a\u5bfc\u81f4\u5185\u5b58\u66b4\u6da8\u3002\u5e76\u4e14\uff0c\u7531\u4e8e InnoDB \u5bf9 LRU \u7b97\u6cd5\u505a\u4e86\u6539\u8fdb\uff0c\u51b7\u6570\u636e\u7684\u5168\u8868\u626b\u63cf\uff0c\u5bf9 Buffer Pool \u7684\u5f71\u54cd\u4e5f\u80fd\u505a\u5230\u53ef\u63a7\u3002</p>\n<p>\u5f53\u7136\uff0c\u6211\u4eec\u524d\u9762\u6587\u7ae0\u6709\u8bf4\u8fc7\uff0c\u5168\u8868\u626b\u63cf\u8fd8\u662f\u6bd4\u8f83\u8017\u8d39 IO \u8d44\u6e90\u7684\uff0c\u6240\u4ee5\u4e1a\u52a1\u9ad8\u5cf0\u671f\u8fd8\u662f\u4e0d\u80fd\u76f4\u63a5\u5728\u7ebf\u4e0a\u4e3b\u5e93\u6267\u884c\u5168\u8868\u626b\u63cf\u7684\u3002</p>\n<h2 id=\"34-join\">34 \u5230\u5e95\u53ef\u4e0d\u53ef\u4ee5\u4f7f\u7528join\uff1f<a class=\"headerlink\" href=\"#34-join\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u5173\u4e8e join \u8bed\u53e5\u4f7f\u7528\u7684\u95ee\u9898\uff0c\u4e00\u822c\u4f1a\u96c6\u4e2d\u5728\u4ee5\u4e0b\u4e24\u7c7b\uff1a</p>\n<ol>\n<li>\u6211\u4eec DBA \u4e0d\u8ba9\u4f7f\u7528 join\uff0c\u4f7f\u7528 join \u6709\u4ec0\u4e48\u95ee\u9898\u5462\uff1f</li>\n<li>\u5982\u679c\u6709\u4e24\u4e2a\u5927\u5c0f\u4e0d\u540c\u7684\u8868\u505a join\uff0c\u5e94\u8be5\u7528\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u5462\uff1f</li>\n</ol>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u5148\u8ddf\u4f60\u8bf4\u8bf4 join \u8bed\u53e5\u5230\u5e95\u662f\u600e\u4e48\u6267\u884c\u7684\uff0c\u7136\u540e\u518d\u6765\u56de\u7b54\u8fd9\u4e24\u4e2a\u95ee\u9898\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\uff0c\u6211\u8fd8\u662f\u521b\u5efa\u4e24\u4e2a\u8868 t1 \u548c t2 \u6765\u548c\u4f60\u8bf4\u660e\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t2</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">drop</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span><span class=\"w\"> </span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&lt;=</span><span class=\"mi\">100</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e24\u4e2a\u8868\u90fd\u6709\u4e00\u4e2a\u4e3b\u952e\u7d22\u5f15 id \u548c\u4e00\u4e2a\u7d22\u5f15 a\uff0c\u5b57\u6bb5 b \u4e0a\u65e0\u7d22\u5f15\u3002\u5b58\u50a8\u8fc7\u7a0b idata() \u5f80\u8868 t2 \u91cc\u63d2\u5165\u4e86 1000 \u884c\u6570\u636e\uff0c\u5728\u8868 t1 \u91cc\u63d2\u5165\u7684\u662f 100 \u884c\u6570\u636e\u3002</p>\n<h3 id=\"index-nested-loop-join\">Index Nested-Loop Join<a class=\"headerlink\" href=\"#index-nested-loop-join\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u5982\u679c\u76f4\u63a5\u4f7f\u7528 join \u8bed\u53e5\uff0cMySQL \u4f18\u5316\u5668\u53ef\u80fd\u4f1a\u9009\u62e9\u8868 t1 \u6216 t2 \u4f5c\u4e3a\u9a71\u52a8\u8868\uff0c\u8fd9\u6837\u4f1a\u5f71\u54cd\u6211\u4eec\u5206\u6790 SQL \u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u6240\u4ee5\uff0c\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u6539\u7528 straight_join \u8ba9 MySQL \u4f7f\u7528\u56fa\u5b9a\u7684\u8fde\u63a5\u65b9\u5f0f\u6267\u884c\u67e5\u8be2\uff0c\u8fd9\u6837\u4f18\u5316\u5668\u53ea\u4f1a\u6309\u7167\u6211\u4eec\u6307\u5b9a\u7684\u65b9\u5f0f\u53bb join\u3002\u5728\u8fd9\u4e2a\u8bed\u53e5\u91cc\uff0ct1 \u662f\u9a71\u52a8\u8868\uff0ct2 \u662f\u88ab\u9a71\u52a8\u8868\u3002</p>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">);</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">        </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u6761\u8bed\u53e5\u91cc\uff0c\u88ab\u9a71\u52a8\u8868 t2 \u7684\u5b57\u6bb5 a \u4e0a\u6709\u7d22\u5f15\uff0cjoin \u8fc7\u7a0b\u7528\u4e0a\u4e86\u8fd9\u4e2a\u7d22\u5f15\uff0c\u56e0\u6b64\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4ece\u8868 t1 \u4e2d\u8bfb\u5165\u4e00\u884c\u6570\u636e R\uff1b</li>\n<li>\u4ece\u6570\u636e\u884c R \u4e2d\uff0c\u53d6\u51fa a \u5b57\u6bb5\u5230\u8868 t2 \u91cc\u53bb\u67e5\u627e\uff1b</li>\n<li>\u53d6\u51fa\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u8ddf R \u7ec4\u6210\u4e00\u884c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\uff1b</li>\n<li>\u91cd\u590d\u6267\u884c\u6b65\u9aa4 1 \u5230 3\uff0c\u76f4\u5230\u8868 t1 \u7684\u672b\u5c3e\u5faa\u73af\u7ed3\u675f\u3002</li>\n</ol>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u5148\u904d\u5386\u8868 t1\uff0c\u7136\u540e\u6839\u636e\u4ece\u8868 t1 \u4e2d\u53d6\u51fa\u7684\u6bcf\u884c\u6570\u636e\u4e2d\u7684 a \u503c\uff0c\u53bb\u8868 t2 \u4e2d\u67e5\u627e\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\u3002\u5728\u5f62\u5f0f\u4e0a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u8ddf\u6211\u4eec\u5199\u7a0b\u5e8f\u65f6\u7684\u5d4c\u5957\u67e5\u8be2\u7c7b\u4f3c\uff0c\u5e76\u4e14\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u6240\u4ee5\u6211\u4eec\u79f0\u4e4b\u4e3a\u201cIndex Nested-Loop Join\u201d\uff0c\u7b80\u79f0 NLJ\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u6d41\u7a0b\u91cc\uff1a</p>\n<ol>\n<li>\u5bf9\u9a71\u52a8\u8868 t1 \u505a\u4e86\u5168\u8868\u626b\u63cf\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u9700\u8981\u626b\u63cf 100 \u884c\uff1b</li>\n<li>\u800c\u5bf9\u4e8e\u6bcf\u4e00\u884c R\uff0c\u6839\u636e a \u5b57\u6bb5\u53bb\u8868 t2 \u67e5\u627e\uff0c\u8d70\u7684\u662f\u6811\u641c\u7d22\u8fc7\u7a0b\u3002\u7531\u4e8e\u6211\u4eec\u6784\u9020\u7684\u6570\u636e\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0c\u56e0\u6b64\u6bcf\u6b21\u7684\u641c\u7d22\u8fc7\u7a0b\u90fd\u53ea\u626b\u63cf\u4e00\u884c\uff0c\u4e5f\u662f\u603b\u5171\u626b\u63cf 100 \u884c\uff1b</li>\n<li>\u6240\u4ee5\uff0c\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\uff0c\u603b\u626b\u63cf\u884c\u6570\u662f 200\u3002</li>\n</ol>\n<p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u518d\u8bd5\u7740\u56de\u7b54\u4e00\u4e0b\u6587\u7ae0\u5f00\u5934\u7684\u4e24\u4e2a\u95ee\u9898\u3002</p>\n<p>\u5148\u770b\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a<strong>\u80fd\u4e0d\u80fd\u4f7f\u7528 join?</strong></p>\n<p>\u5047\u8bbe\u4e0d\u4f7f\u7528 join\uff0c\u90a3\u6211\u4eec\u5c31\u53ea\u80fd\u7528\u5355\u8868\u67e5\u8be2\u3002\u6211\u4eec\u770b\u770b\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\u7684\u9700\u6c42\uff0c\u7528\u5355\u8868\u67e5\u8be2\u600e\u4e48\u5b9e\u73b0\u3002</p>\n<ol>\n<li>\u6267\u884c<code>select * from t1</code>\uff0c\u67e5\u51fa\u8868 t1 \u7684\u6240\u6709\u6570\u636e\uff0c\u8fd9\u91cc\u6709 100 \u884c\uff1b</li>\n<li>\u5faa\u73af\u904d\u5386\u8fd9 100 \u884c\u6570\u636e\uff1a </li>\n<li>\u4ece\u6bcf\u4e00\u884c R \u53d6\u51fa\u5b57\u6bb5 a \u7684\u503c $R.a\uff1b</li>\n<li>\u6267\u884c<code>select * from t2 where a=$R.a</code>\uff1b</li>\n<li>\u628a\u8fd4\u56de\u7684\u7ed3\u679c\u548c R \u6784\u6210\u7ed3\u679c\u96c6\u7684\u4e00\u884c\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\uff0c\u4e5f\u662f\u626b\u63cf\u4e86 200 \u884c\uff0c\u4f46\u662f\u603b\u5171\u6267\u884c\u4e86 101 \u6761\u8bed\u53e5\uff0c\u6bd4\u76f4\u63a5 join \u591a\u4e86 100 \u6b21\u4ea4\u4e92\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u5ba2\u6237\u7aef\u8fd8\u8981\u81ea\u5df1\u62fc\u63a5 SQL \u8bed\u53e5\u548c\u7ed3\u679c\u3002</p>\n<p>\u663e\u7136\uff0c\u8fd9\u4e48\u505a\u8fd8\u4e0d\u5982\u76f4\u63a5 join \u597d\u3002</p>\n<p>\u6211\u4eec\u518d\u6765\u770b\u770b\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a<strong>\u600e\u4e48\u9009\u62e9\u9a71\u52a8\u8868\uff1f</strong></p>\n<p>\u5728\u8fd9\u4e2a join \u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u9a71\u52a8\u8868\u662f\u8d70\u5168\u8868\u626b\u63cf\uff0c\u800c\u88ab\u9a71\u52a8\u8868\u662f\u8d70\u6811\u641c\u7d22\u3002</p>\n<p>\u5047\u8bbe\u88ab\u9a71\u52a8\u8868\u7684\u884c\u6570\u662f M\u3002\u6bcf\u6b21\u5728\u88ab\u9a71\u52a8\u8868\u67e5\u4e00\u884c\u6570\u636e\uff0c\u8981\u5148\u641c\u7d22\u7d22\u5f15 a\uff0c\u518d\u641c\u7d22\u4e3b\u952e\u7d22\u5f15\u3002\u6bcf\u6b21\u641c\u7d22\u4e00\u68f5\u6811\u8fd1\u4f3c\u590d\u6742\u5ea6\u662f\u4ee5 2 \u4e3a\u5e95\u7684 M \u7684\u5bf9\u6570\uff0c\u8bb0\u4e3a <span class=\"arithmatex\">\\(log_2M\\)</span>\uff0c\u6240\u4ee5\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u67e5\u4e00\u884c\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f <span class=\"arithmatex\">\\(2*log_2M\\)</span>\u3002</p>\n<p>\u5047\u8bbe\u9a71\u52a8\u8868\u7684\u884c\u6570\u662f N\uff0c\u6267\u884c\u8fc7\u7a0b\u5c31\u8981\u626b\u63cf\u9a71\u52a8\u8868 N \u884c\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u4e00\u884c\uff0c\u5230\u88ab\u9a71\u52a8\u8868\u4e0a\u5339\u914d\u4e00\u6b21\u3002</p>\n<p>\u56e0\u6b64\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\uff0c\u8fd1\u4f3c\u590d\u6742\u5ea6\u662f <span class=\"arithmatex\">\\(N + N*2*log_2M\\)</span>\u3002</p>\n<p>\u663e\u7136\uff0cN \u5bf9\u626b\u63cf\u884c\u6570\u7684\u5f71\u54cd\u66f4\u5927\uff0c\u56e0\u6b64\u5e94\u8be5\u8ba9\u5c0f\u8868\u6765\u505a\u9a71\u52a8\u8868\u3002</p>\n<blockquote>\n<p>\u5982\u679c\u4f60\u6ca1\u89c9\u5f97\u8fd9\u4e2a\u5f71\u54cd\u6709\u90a3\u4e48\u201c\u663e\u7136\u201d\uff0c \u53ef\u4ee5\u8fd9\u4e48\u7406\u89e3\uff1aN \u6269\u5927 1000 \u500d\u7684\u8bdd\uff0c\u626b\u63cf\u884c\u6570\u5c31\u4f1a\u6269\u5927 1000 \u500d\uff1b\u800c M \u6269\u5927 1000 \u500d\uff0c\u626b\u63cf\u884c\u6570\u6269\u5927\u4e0d\u5230 10 \u500d\u3002</p>\n</blockquote>\n<p>\u5230\u8fd9\u91cc\u5c0f\u7ed3\u4e00\u4e0b\uff0c\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\u6211\u4eec\u5f97\u5230\u4e86\u4e24\u4e2a\u7ed3\u8bba\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 join \u8bed\u53e5\uff0c\u6027\u80fd\u6bd4\u5f3a\u884c\u62c6\u6210\u591a\u4e2a\u5355\u8868\u6267\u884c SQL \u8bed\u53e5\u7684\u6027\u80fd\u8981\u597d\uff1b</li>\n<li>\u5982\u679c\u4f7f\u7528 join \u8bed\u53e5\u7684\u8bdd\uff0c\u9700\u8981\u8ba9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li>\n</ol>\n<p>\u4f46\u662f\uff0c\u4f60\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u4e2a\u7ed3\u8bba\u7684\u524d\u63d0\u662f\u201c\u53ef\u4ee5\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u201d\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u88ab\u9a71\u52a8\u8868\u7528\u4e0d\u4e0a\u7d22\u5f15\u7684\u60c5\u51b5\u3002</p>\n<h3 id=\"simple-nested-loop-join\">Simple Nested-Loop Join<a class=\"headerlink\" href=\"#simple-nested-loop-join\" title=\"Permanent link\">&para;</a></h3>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u628a SQL \u8bed\u53e5\u6539\u6210\u8fd9\u6837\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u7531\u4e8e\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u56e0\u6b64\u518d\u7528\u56fe 2 \u7684\u6267\u884c\u6d41\u7a0b\u65f6\uff0c\u6bcf\u6b21\u5230 t2 \u53bb\u5339\u914d\u7684\u65f6\u5019\uff0c\u5c31\u8981\u505a\u4e00\u6b21\u5168\u8868\u626b\u63cf\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u5148\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff0c\u7ee7\u7eed\u4f7f\u7528\u56fe 2 \u7684\u7b97\u6cd5\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u5462\uff1f\u5982\u679c\u53ea\u770b\u7ed3\u679c\u7684\u8bdd\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u662f\u6b63\u786e\u7684\uff0c\u800c\u4e14\u8fd9\u4e2a\u7b97\u6cd5\u4e5f\u6709\u4e00\u4e2a\u540d\u5b57\uff0c\u53eb\u505a\u201cSimple Nested-Loop Join\u201d\u3002</p>\n<p>\u4f46\u662f\uff0c\u8fd9\u6837\u7b97\u6765\uff0c\u8fd9\u4e2a SQL \u8bf7\u6c42\u5c31\u8981\u626b\u63cf\u8868 t2 \u591a\u8fbe 100 \u6b21\uff0c\u603b\u5171\u626b\u63cf <span class=\"arithmatex\">\\(100*1000=10\\)</span> \u4e07\u884c\u3002</p>\n<p>\u8fd9\u8fd8\u53ea\u662f\u4e24\u4e2a\u5c0f\u8868\uff0c\u5982\u679c t1 \u548c t2 \u90fd\u662f 10 \u4e07\u884c\u7684\u8868\uff08\u5f53\u7136\u4e86\uff0c\u8fd9\u4e5f\u8fd8\u662f\u5c5e\u4e8e\u5c0f\u8868\u7684\u8303\u56f4\uff09\uff0c\u5c31\u8981\u626b\u63cf 100 \u4ebf\u884c\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u770b\u4e0a\u53bb\u592a\u201c\u7b28\u91cd\u201d\u4e86\u3002</p>\n<p>\u5f53\u7136\uff0cMySQL \u4e5f\u6ca1\u6709\u4f7f\u7528\u8fd9\u4e2a Simple Nested-Loop Join \u7b97\u6cd5\uff0c\u800c\u662f\u4f7f\u7528\u4e86\u53e6\u4e00\u4e2a\u53eb\u4f5c\u201cBlock Nested-Loop Join\u201d\u7684\u7b97\u6cd5\uff0c\u7b80\u79f0 BNL\u3002</p>\n<h3 id=\"block-nested-loop-join\">Block Nested-Loop Join<a class=\"headerlink\" href=\"#block-nested-loop-join\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u65f6\u5019\uff0c\u88ab\u9a71\u52a8\u8868\u4e0a\u6ca1\u6709\u53ef\u7528\u7684\u7d22\u5f15\uff0c\u7b97\u6cd5\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u628a\u8868 t1 \u7684\u6570\u636e\u8bfb\u5165\u7ebf\u7a0b\u5185\u5b58 <code>join_buffer</code> \u4e2d\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u4e2a\u8bed\u53e5\u4e2d\u5199\u7684\u662f <code>select *</code>\uff0c\u56e0\u6b64\u662f\u628a\u6574\u4e2a\u8868 t1 \u653e\u5165\u4e86\u5185\u5b58\uff1b</li>\n<li>\u626b\u63cf\u8868 t2\uff0c\u628a\u8868 t2 \u4e2d\u7684\u6bcf\u4e00\u884c\u53d6\u51fa\u6765\uff0c\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u505a\u5bf9\u6bd4\uff0c\u6ee1\u8db3 join \u6761\u4ef6\u7684\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\u3002</li>\n</ol>\n<p>\u5bf9\u5e94\u5730\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u7684 explain \u7ed3\u679c\u5982\u4e0b\u6240\u793a\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                                              </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">                                               </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">10</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Block</span><span class=\"w\"> </span><span class=\"n\">Nested</span><span class=\"w\"> </span><span class=\"n\">Loop</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8868 t1 \u548c t2 \u90fd\u505a\u4e86\u4e00\u6b21\u5168\u8868\u626b\u63cf\uff0c\u56e0\u6b64\u603b\u7684\u626b\u63cf\u884c\u6570\u662f 1100\u3002\u7531\u4e8e <code>join_buffer</code> \u662f\u4ee5\u65e0\u5e8f\u6570\u7ec4\u7684\u65b9\u5f0f\u7ec4\u7ec7\u7684\uff0c\u56e0\u6b64\u5bf9\u8868 t2 \u4e2d\u7684\u6bcf\u4e00\u884c\uff0c\u90fd\u8981\u505a 100 \u6b21\u5224\u65ad\uff0c\u603b\u5171\u9700\u8981\u5728\u5185\u5b58\u4e2d\u505a\u7684\u5224\u65ad\u6b21\u6570\u662f\uff1a100 *1000=10 \u4e07\u6b21\u3002</p>\n<p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\uff0c\u5982\u679c\u4f7f\u7528 Simple Nested-Loop Join \u7b97\u6cd5\u8fdb\u884c\u67e5\u8be2\uff0c\u626b\u63cf\u884c\u6570\u4e5f\u662f 10 \u4e07\u884c\u3002\u56e0\u6b64\uff0c\u4ece\u65f6\u95f4\u590d\u6742\u5ea6\u4e0a\u6765\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u7b97\u6cd5\u662f\u4e00\u6837\u7684\u3002\u4f46\u662f\uff0cBlock Nested-Loop Join \u7b97\u6cd5\u7684\u8fd9 10 \u4e07\u6b21\u5224\u65ad\u662f\u5185\u5b58\u64cd\u4f5c\uff0c\u901f\u5ea6\u4e0a\u4f1a\u5feb\u5f88\u591a\uff0c\u6027\u80fd\u4e5f\u66f4\u597d\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u9009\u62e9\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u3002</p>\n<p>\u5047\u8bbe\u5c0f\u8868\u7684\u884c\u6570\u662f N\uff0c\u5927\u8868\u7684\u884c\u6570\u662f M\uff0c\u90a3\u4e48\u5728\u8fd9\u4e2a\u7b97\u6cd5\u91cc\uff1a</p>\n<ol>\n<li>\u4e24\u4e2a\u8868\u90fd\u505a\u4e00\u6b21\u5168\u8868\u626b\u63cf\uff0c\u6240\u4ee5\u603b\u7684\u626b\u63cf\u884c\u6570\u662f M+N\uff1b</li>\n<li>\u5185\u5b58\u4e2d\u7684\u5224\u65ad\u6b21\u6570\u662f M*N\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8c03\u6362\u8fd9\u4e24\u4e2a\u7b97\u5f0f\u4e2d\u7684 M \u548c N \u6ca1\u5dee\u522b\uff0c\u56e0\u6b64\u8fd9\u65f6\u5019\u9009\u62e9\u5927\u8868\u8fd8\u662f\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff0c\u6267\u884c\u8017\u65f6\u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u7136\u540e\uff0c\u4f60\u53ef\u80fd\u9a6c\u4e0a\u5c31\u4f1a\u95ee\u4e86\uff0c\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u8868 t1 \u624d 100 \u884c\uff0c\u8981\u662f\u8868 t1 \u662f\u4e00\u4e2a\u5927\u8868\uff0cjoin_buffer \u653e\u4e0d\u4e0b\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>join_buffer \u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>join_buffer_size</code> \u8bbe\u5b9a\u7684\uff0c\u9ed8\u8ba4\u503c\u662f 256k\u3002**\u5982\u679c\u653e\u4e0d\u4e0b\u8868 t1 \u7684\u6240\u6709\u6570\u636e\u8bdd\uff0c\u7b56\u7565\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5206\u6bb5\u653e\u3002**\u6211\u628a <code>join_buffer_size</code> \u6539\u6210 1200\uff0c\u518d\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u6267\u884c\u8fc7\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p>\n<ol>\n<li>\u626b\u63cf\u8868 t1\uff0c\u987a\u5e8f\u8bfb\u53d6\u6570\u636e\u884c\u653e\u5165 <code>join_buffer</code> \u4e2d\uff0c\u653e\u5b8c\u7b2c 88 \u884c <code>join_buffer</code> \u6ee1\u4e86\uff0c\u7ee7\u7eed\u7b2c 2 \u6b65\uff1b</li>\n<li>\u626b\u63cf\u8868 t2\uff0c\u628a t2 \u4e2d\u7684\u6bcf\u4e00\u884c\u53d6\u51fa\u6765\uff0c\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u505a\u5bf9\u6bd4\uff0c\u6ee1\u8db3 join \u6761\u4ef6\u7684\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\uff1b</li>\n<li>\u6e05\u7a7a <code>join_buffer</code>\uff1b</li>\n<li>\u7ee7\u7eed\u626b\u63cf\u8868 t1\uff0c\u987a\u5e8f\u8bfb\u53d6\u6700\u540e\u7684 12 \u884c\u6570\u636e\u653e\u5165 <code>join_buffer</code> \u4e2d\uff0c\u7ee7\u7eed\u6267\u884c\u7b2c 2 \u6b65\u3002</li>\n</ol>\n<p>\u6267\u884c\u6d41\u7a0b\u56fe\u4e5f\u5c31\u53d8\u6210\u8fd9\u6837\uff1a</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/695adf810fcdb07e393467bcfd2f6ac4.jpg\" /></p>\n<p>\u56fe 5 Block Nested-Loop Join -- \u4e24\u6bb5</p>\n<p>\u56fe\u4e2d\u7684\u6b65\u9aa4 4 \u548c 5\uff0c\u8868\u793a\u6e05\u7a7a <code>join_buffer</code> \u518d\u590d\u7528\u3002</p>\n<p>\u8fd9\u4e2a\u6d41\u7a0b\u624d\u4f53\u73b0\u51fa\u4e86\u8fd9\u4e2a\u7b97\u6cd5\u540d\u5b57\u4e2d\u201cBlock\u201d\u7684\u7531\u6765\uff0c\u8868\u793a\u201c\u5206\u5757\u53bb join\u201d\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u7531\u4e8e\u8868 t1 \u88ab\u5206\u6210\u4e86\u4e24\u6b21\u653e\u5165 join_buffer \u4e2d\uff0c\u5bfc\u81f4\u8868 t2 \u4f1a\u88ab\u626b\u63cf\u4e24\u6b21\u3002\u867d\u7136\u5206\u6210\u4e24\u6b21\u653e\u5165 <code>join_buffer</code>\uff0c\u4f46\u662f\u5224\u65ad\u7b49\u503c\u6761\u4ef6\u7684\u6b21\u6570\u8fd8\u662f\u4e0d\u53d8\u7684\uff0c\u4f9d\u7136\u662f (88+12)*1000=10 \u4e07\u6b21\u3002</p>\n<p>\u6211\u4eec\u518d\u6765\u770b\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9a71\u52a8\u8868\u7684\u9009\u62e9\u95ee\u9898\u3002</p>\n<p>\u5047\u8bbe\uff0c\u9a71\u52a8\u8868\u7684\u6570\u636e\u884c\u6570\u662f N\uff0c\u9700\u8981\u5206 K \u6bb5\u624d\u80fd\u5b8c\u6210\u7b97\u6cd5\u6d41\u7a0b\uff0c\u88ab\u9a71\u52a8\u8868\u7684\u6570\u636e\u884c\u6570\u662f M\u3002</p>\n<p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684 K \u4e0d\u662f\u5e38\u6570\uff0cN \u8d8a\u5927 K \u5c31\u4f1a\u8d8a\u5927\uff0c\u56e0\u6b64\u628a K \u8868\u793a\u4e3a $ \\lambda*N$\uff0c\u663e\u7136 <span class=\"arithmatex\">\\(\\lambda\\)</span> \u7684\u53d6\u503c\u8303\u56f4\u662f (0,1)\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5728\u8fd9\u4e2a\u7b97\u6cd5\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff1a</p>\n<ol>\n<li>\u626b\u63cf\u884c\u6570\u662f <span class=\"arithmatex\">\\(N+\\lambda*N*M\\)</span>\uff1b</li>\n<li>\u5185\u5b58\u5224\u65ad <span class=\"arithmatex\">\\(N*M\\)</span> \u6b21\u3002</li>\n</ol>\n<p>\u663e\u7136\uff0c\u5185\u5b58\u5224\u65ad\u6b21\u6570\u662f\u4e0d\u53d7\u9009\u62e9\u54ea\u4e2a\u8868\u4f5c\u4e3a\u9a71\u52a8\u8868\u5f71\u54cd\u7684\u3002\u800c\u8003\u8651\u5230\u626b\u63cf\u884c\u6570\uff0c\u5728 M \u548c N \u5927\u5c0f\u786e\u5b9a\u7684\u60c5\u51b5\u4e0b\uff0cN \u5c0f\u4e00\u4e9b\uff0c\u6574\u4e2a\u7b97\u5f0f\u7684\u7ed3\u679c\u4f1a\u66f4\u5c0f\u3002</p>\n<p>\u6240\u4ee5\u7ed3\u8bba\u662f\uff0c\u5e94\u8be5\u8ba9\u5c0f\u8868\u5f53\u9a71\u52a8\u8868\u3002</p>\n<p>\u5f53\u7136\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u5728 <span class=\"arithmatex\">\\(N+\\lambda*N*M\\)</span>\u8fd9\u4e2a\u5f0f\u5b50\u91cc\uff0c<span class=\"arithmatex\">\\(\\lambda\\)</span>\u624d\u662f\u5f71\u54cd\u626b\u63cf\u884c\u6570\u7684\u5173\u952e\u56e0\u7d20\uff0c\u8fd9\u4e2a\u503c\u8d8a\u5c0f\u8d8a\u597d\u3002</p>\n<p>\u521a\u521a\u6211\u4eec\u8bf4\u4e86 N \u8d8a\u5927\uff0c\u5206\u6bb5\u6570 K \u8d8a\u5927\u3002\u90a3\u4e48\uff0cN \u56fa\u5b9a\u7684\u65f6\u5019\uff0c\u4ec0\u4e48\u53c2\u6570\u4f1a\u5f71\u54cd K \u7684\u5927\u5c0f\u5462\uff1f\u7b54\u6848\u662f <code>join_buffer_size</code>\u3002<code>join_buffer_size</code> \u8d8a\u5927\uff0c\u4e00\u6b21\u53ef\u4ee5\u653e\u5165\u7684\u884c\u8d8a\u591a\uff0c\u5206\u6210\u7684\u6bb5\u6570\u4e5f\u5c31\u8d8a\u5c11\uff0c\u5bf9\u88ab\u9a71\u52a8\u8868\u7684\u5168\u8868\u626b\u63cf\u6b21\u6570\u5c31\u8d8a\u5c11\u3002</p>\n<p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\uff0c\u4f60\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e9b\u5efa\u8bae\u544a\u8bc9\u4f60\uff0c\u5982\u679c\u4f60\u7684 join \u8bed\u53e5\u5f88\u6162\uff0c\u5c31\u628a <code>join_buffer_size</code> \u6539\u5927\u3002</p>\n<p>\u7406\u89e3\u4e86 MySQL \u6267\u884c join \u7684\u4e24\u79cd\u7b97\u6cd5\uff0c\u73b0\u5728\u6211\u4eec\u518d\u6765\u8bd5\u7740**\u56de\u7b54\u6587\u7ae0\u5f00\u5934\u7684\u4e24\u4e2a\u95ee\u9898**\u3002</p>\n<p>\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u80fd\u4e0d\u80fd\u4f7f\u7528 join \u8bed\u53e5\uff1f</p>\n<ol>\n<li>\u5982\u679c\u53ef\u4ee5\u4f7f\u7528 Index Nested-Loop Join \u7b97\u6cd5\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u7d22\u5f15\uff0c\u5176\u5b9e\u662f\u6ca1\u95ee\u9898\u7684\uff1b</li>\n<li>\u5982\u679c\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u626b\u63cf\u884c\u6570\u5c31\u4f1a\u8fc7\u591a\u3002\u5c24\u5176\u662f\u5728\u5927\u8868\u4e0a\u7684 join \u64cd\u4f5c\uff0c\u8fd9\u6837\u53ef\u80fd\u8981\u626b\u63cf\u88ab\u9a71\u52a8\u8868\u5f88\u591a\u6b21\uff0c\u4f1a\u5360\u7528\u5927\u91cf\u7684\u7cfb\u7edf\u8d44\u6e90\u3002\u6240\u4ee5\u8fd9\u79cd join \u5c3d\u91cf\u4e0d\u8981\u7528\u3002</li>\n</ol>\n<p>\u6240\u4ee5\u4f60\u5728\u5224\u65ad\u8981\u4e0d\u8981\u4f7f\u7528 join \u8bed\u53e5\u65f6\uff0c\u5c31\u662f\u770b explain \u7ed3\u679c\u91cc\u9762\uff0cExtra \u5b57\u6bb5\u91cc\u9762\u6709\u6ca1\u6709\u51fa\u73b0\u201cBlock Nested Loop\u201d\u5b57\u6837\u3002</p>\n<p>\u7b2c\u4e8c\u4e2a\u95ee\u9898\u662f\uff1a\u5982\u679c\u8981\u4f7f\u7528 join\uff0c\u5e94\u8be5\u9009\u62e9\u5927\u8868\u505a\u9a71\u52a8\u8868\u8fd8\u662f\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff1f</p>\n<ol>\n<li>\u5982\u679c\u662f Index Nested-Loop Join \u7b97\u6cd5\uff0c\u5e94\u8be5\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff1b</li>\n<li>\u5982\u679c\u662f Block Nested-Loop Join \u7b97\u6cd5\uff1a </li>\n<li>\u5728 <code>join_buffer_size</code> \u8db3\u591f\u5927\u7684\u65f6\u5019\uff0c\u662f\u4e00\u6837\u7684\uff1b</li>\n<li>\u5728 <code>join_buffer_size</code> \u4e0d\u591f\u5927\u7684\u65f6\u5019\uff08\u8fd9\u79cd\u60c5\u51b5\u66f4\u5e38\u89c1\uff09\uff0c\u5e94\u8be5\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u95ee\u9898\u7684\u7ed3\u8bba\u5c31\u662f\uff0c\u603b\u662f\u5e94\u8be5\u4f7f\u7528\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u6211\u9700\u8981\u8bf4\u660e\u4e0b\uff0c<strong>\u4ec0\u4e48\u53eb\u4f5c\u201c\u5c0f\u8868\u201d</strong>\u3002</p>\n<p>\u6211\u4eec\u524d\u9762\u7684\u4f8b\u5b50\u662f\u6ca1\u6709\u52a0\u6761\u4ef6\u7684\u3002\u5982\u679c\u6211\u5728\u8bed\u53e5\u7684 where \u6761\u4ef6\u52a0\u4e0a t2.id\\&lt;=50 \u8fd9\u4e2a\u9650\u5b9a\u6761\u4ef6\uff0c\u518d\u6765\u770b\u4e0b\u8fd9\u4e24\u6761\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">&lt;=</span><span class=\"mi\">50</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">&lt;=</span><span class=\"mi\">50</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6ce8\u610f\uff0c\u4e3a\u4e86\u8ba9\u4e24\u6761\u8bed\u53e5\u7684\u88ab\u9a71\u52a8\u8868\u90fd\u7528\u4e0d\u4e0a\u7d22\u5f15\uff0c\u6240\u4ee5 join \u5b57\u6bb5\u90fd\u4f7f\u7528\u4e86\u6ca1\u6709\u7d22\u5f15\u7684\u5b57\u6bb5 b\u3002</p>\n<p>\u4f46\u5982\u679c\u662f\u7528\u7b2c\u4e8c\u4e2a\u8bed\u53e5\u7684\u8bdd\uff0cjoin_buffer \u53ea\u9700\u8981\u653e\u5165 t2 \u7684\u524d 50 \u884c\uff0c\u663e\u7136\u662f\u66f4\u597d\u7684\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u201ct2 \u7684\u524d 50 \u884c\u201d\u662f\u90a3\u4e2a\u76f8\u5bf9\u5c0f\u7684\u8868\uff0c\u4e5f\u5c31\u662f\u201c\u5c0f\u8868\u201d\u3002</p>\n<p>\u6211\u4eec\u518d\u6765\u770b\u53e6\u5916\u4e00\u7ec4\u4f8b\u5b50\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\">  </span><span class=\"n\">t1</span><span class=\"w\">  </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">&lt;=</span><span class=\"mi\">100</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\">  </span><span class=\"n\">t2</span><span class=\"w\">  </span><span class=\"n\">straight_join</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"o\">&lt;=</span><span class=\"mi\">100</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u8868 t1 \u548c t2 \u90fd\u662f\u53ea\u6709 100 \u884c\u53c2\u52a0 join\u3002\u4f46\u662f\uff0c\u8fd9\u4e24\u6761\u8bed\u53e5\u6bcf\u6b21\u67e5\u8be2\u653e\u5165 <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u662f\u4e0d\u4e00\u6837\u7684\uff1a</p>\n<ul>\n<li>\u8868 t1 \u53ea\u67e5\u5b57\u6bb5 b\uff0c\u56e0\u6b64\u5982\u679c\u628a t1 \u653e\u5230 join_buffer \u4e2d\uff0c\u5219 join_buffer \u4e2d\u53ea\u9700\u8981\u653e\u5165 b \u7684\u503c\uff1b</li>\n<li>\u8868 t2 \u9700\u8981\u67e5\u6240\u6709\u7684\u5b57\u6bb5\uff0c\u56e0\u6b64\u5982\u679c\u628a\u8868 t2 \u653e\u5230 join_buffer \u4e2d\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u653e\u5165\u4e09\u4e2a\u5b57\u6bb5 id\u3001a \u548c b\u3002</li>\n</ul>\n<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u5e94\u8be5\u9009\u62e9\u8868 t1 \u4f5c\u4e3a\u9a71\u52a8\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u201c\u53ea\u9700\u8981\u4e00\u5217\u53c2\u4e0e join \u7684\u8868 t1\u201d\u662f\u90a3\u4e2a\u76f8\u5bf9\u5c0f\u7684\u8868\u3002</p>\n<p>\u6240\u4ee5\uff0c\u66f4\u51c6\u786e\u5730\u8bf4\uff0c<strong>\u5728\u51b3\u5b9a\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u662f\u4e24\u4e2a\u8868\u6309\u7167\u5404\u81ea\u7684\u6761\u4ef6\u8fc7\u6ee4\uff0c\u8fc7\u6ee4\u5b8c\u6210\u4e4b\u540e\uff0c\u8ba1\u7b97\u53c2\u4e0e join \u7684\u5404\u4e2a\u5b57\u6bb5\u7684\u603b\u6570\u636e\u91cf\uff0c\u6570\u636e\u91cf\u5c0f\u7684\u90a3\u4e2a\u8868\uff0c\u5c31\u662f\u201c\u5c0f\u8868\u201d\uff0c\u5e94\u8be5\u4f5c\u4e3a\u9a71\u52a8\u8868\u3002</strong></p>\n<h3 id=\"_14\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_14\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u6267\u884c join \u8bed\u53e5\u7684\u4e24\u79cd\u53ef\u80fd\u7b97\u6cd5\uff0c\u8fd9\u4e24\u79cd\u7b97\u6cd5\u662f\u7531\u80fd\u5426\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u51b3\u5b9a\u7684\u3002\u800c\u80fd\u5426\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u5bf9 join \u8bed\u53e5\u7684\u6027\u80fd\u5f71\u54cd\u5f88\u5927\u3002</p>\n<p>\u901a\u8fc7\u5bf9 Index Nested-Loop Join \u548c Block Nested-Loop Join \u4e24\u4e2a\u7b97\u6cd5\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u6790\uff0c\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u6587\u7ae0\u5f00\u5934\u4e24\u4e2a\u95ee\u9898\u7684\u7b54\u6848\uff1a</p>\n<ol>\n<li>\u5982\u679c\u53ef\u4ee5\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0cjoin \u8bed\u53e5\u8fd8\u662f\u6709\u5176\u4f18\u52bf\u7684\uff1b</li>\n<li>\u4e0d\u80fd\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u53ea\u80fd\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u8fd9\u6837\u7684\u8bed\u53e5\u5c31\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\uff1b</li>\n<li>\u5728\u4f7f\u7528 join \u7684\u65f6\u5019\uff0c\u5e94\u8be5\u8ba9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li>\n</ol>\n<p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u4eca\u5929\u7684\u95ee\u9898\u65f6\u95f4\u3002</p>\n<p>\u6211\u4eec\u5728\u4e0a\u6587\u8bf4\u5230\uff0c\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u53ef\u80fd\u4f1a\u56e0\u4e3a <code>join_buffer</code> \u4e0d\u591f\u5927\uff0c\u9700\u8981\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u591a\u6b21\u5168\u8868\u626b\u63cf\u3002</p>\n<h2 id=\"35-join\">35 join\u8bed\u53e5\u600e\u4e48\u4f18\u5316\uff1f<a class=\"headerlink\" href=\"#35-join\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 join \u8bed\u53e5\u7684\u4e24\u79cd\u7b97\u6cd5\uff0c\u5206\u522b\u662f Index Nested-Loop Join(NLJ) \u548c Block Nested-Loop Join(BNL)\u3002</p>\n<p>\u6211\u4eec\u53d1\u73b0\u5728\u4f7f\u7528 NLJ \u7b97\u6cd5\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u6548\u679c\u8fd8\u662f\u4e0d\u9519\u7684\uff0c\u6bd4\u901a\u8fc7\u5e94\u7528\u5c42\u62c6\u5206\u6210\u591a\u4e2a\u8bed\u53e5\u7136\u540e\u518d\u62fc\u63a5\u67e5\u8be2\u7ed3\u679c\u66f4\u65b9\u4fbf\uff0c\u800c\u4e14\u6027\u80fd\u4e5f\u4e0d\u4f1a\u5dee\u3002</p>\n<p>\u4f46\u662f\uff0cBNL \u7b97\u6cd5\u5728\u5927\u8868 join \u7684\u65f6\u5019\u6027\u80fd\u5c31\u5dee\u591a\u4e86\uff0c\u6bd4\u8f83\u6b21\u6570\u7b49\u4e8e\u4e24\u4e2a\u8868\u53c2\u4e0e join \u7684\u884c\u6570\u7684\u4e58\u79ef\uff0c\u5f88\u6d88\u8017 CPU \u8d44\u6e90\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u8fd9\u4e24\u4e2a\u7b97\u6cd5\u90fd\u8fd8\u6709\u7ee7\u7eed\u4f18\u5316\u7684\u7a7a\u95f4\uff0c\u6211\u4eec\u4eca\u5929\u5c31\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u8fd8\u662f\u521b\u5efa\u4e24\u4e2a\u8868 t1\u3001t2 \u6765\u548c\u4f60\u5c55\u5f00\u4eca\u5929\u7684\u95ee\u9898\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">;</span>\n<span class=\"k\">drop</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1001</span><span class=\"o\">-</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">1000000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u540e\u9762\u91cf\u5316\u8bf4\u660e\uff0c\u6211\u5728\u8868 t1 \u91cc\uff0c\u63d2\u5165\u4e86 1000 \u884c\u6570\u636e\uff0c\u6bcf\u4e00\u884c\u7684 a=1001-id \u7684\u503c\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8868 t1 \u4e2d\u5b57\u6bb5 a \u662f\u9006\u5e8f\u7684\u3002\u540c\u65f6\uff0c\u6211\u5728\u8868 t2 \u4e2d\u63d2\u5165\u4e86 100 \u4e07\u884c\u6570\u636e\u3002</p>\n<h3 id=\"multi-range-read\">Multi-Range Read \u4f18\u5316<a class=\"headerlink\" href=\"#multi-range-read\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u4ecb\u7ecd join \u8bed\u53e5\u7684\u4f18\u5316\u65b9\u6848\u4e4b\u524d\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e2a\u77e5\u8bc6\u70b9\uff0c\u5373\uff1aMulti-Range Read \u4f18\u5316 (MRR)\u3002\u8fd9\u4e2a\u4f18\u5316\u7684\u4e3b\u8981\u76ee\u7684\u662f\u5c3d\u91cf\u4f7f\u7528\u987a\u5e8f\u8bfb\u76d8\u3002</p>\n<p>\u5728[\u7b2c 4 \u7bc7\u6587\u7ae0]\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd InnoDB \u7684\u7d22\u5f15\u7ed3\u6784\u65f6\uff0c\u63d0\u5230\u4e86\u201c\u56de\u8868\u201d\u7684\u6982\u5ff5\u3002\u6211\u4eec\u5148\u6765\u56de\u987e\u4e00\u4e0b\u8fd9\u4e2a\u6982\u5ff5\u3002\u56de\u8868\u662f\u6307\uff0cInnoDB \u5728\u666e\u901a\u7d22\u5f15 a \u4e0a\u67e5\u5230\u4e3b\u952e id \u7684\u503c\u540e\uff0c\u518d\u6839\u636e\u4e00\u4e2a\u4e2a\u4e3b\u952e id \u7684\u503c\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u67e5\u6574\u884c\u6570\u636e\u7684\u8fc7\u7a0b\u3002</p>\n<p>\u7136\u540e\uff0c\u6709\u540c\u5b66\u5728\u7559\u8a00\u533a\u95ee\u5230\uff0c\u56de\u8868\u8fc7\u7a0b\u662f\u4e00\u884c\u884c\u5730\u67e5\u6570\u636e\uff0c\u8fd8\u662f\u6279\u91cf\u5730\u67e5\u6570\u636e\uff1f</p>\n<p>\u6211\u4eec\u5148\u6765\u770b\u770b\u8fd9\u4e2a\u95ee\u9898\u3002\u5047\u8bbe\uff0c\u6211\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&lt;=</span><span class=\"mi\">100</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4e3b\u952e\u7d22\u5f15\u662f\u4e00\u68f5 B+ \u6811\uff0c\u5728\u8fd9\u68f5\u6811\u4e0a\uff0c\u6bcf\u6b21\u53ea\u80fd\u6839\u636e\u4e00\u4e2a\u4e3b\u952e id \u67e5\u5230\u4e00\u884c\u6570\u636e\u3002\u56e0\u6b64\uff0c\u56de\u8868\u80af\u5b9a\u662f\u4e00\u884c\u884c\u641c\u7d22\u4e3b\u952e\u7d22\u5f15\u7684\uff0c\u57fa\u672c\u6d41\u7a0b\u5982\u56fe 1 \u6240\u793a\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/1761edbd7734276ae0a213af3cdd3311.jpg\" /></p>\n<p>\u56fe 1 \u57fa\u672c\u56de\u8868\u6d41\u7a0b</p>\n<p>\u5982\u679c\u968f\u7740 a \u7684\u503c\u9012\u589e\u987a\u5e8f\u67e5\u8be2\u7684\u8bdd\uff0cid \u7684\u503c\u5c31\u53d8\u6210\u968f\u673a\u7684\uff0c\u90a3\u4e48\u5c31\u4f1a\u51fa\u73b0\u968f\u673a\u8bbf\u95ee\uff0c\u6027\u80fd\u76f8\u5bf9\u8f83\u5dee\u3002\u867d\u7136\u201c\u6309\u884c\u67e5\u201d\u8fd9\u4e2a\u673a\u5236\u4e0d\u80fd\u6539\uff0c\u4f46\u662f\u8c03\u6574\u67e5\u8be2\u7684\u987a\u5e8f\uff0c\u8fd8\u662f\u80fd\u591f\u52a0\u901f\u7684\u3002</p>\n<p><strong>\u56e0\u4e3a\u5927\u591a\u6570\u7684\u6570\u636e\u90fd\u662f\u6309\u7167\u4e3b\u952e\u9012\u589e\u987a\u5e8f\u63d2\u5165\u5f97\u5230\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\uff0c\u5982\u679c\u6309\u7167\u4e3b\u952e\u7684\u9012\u589e\u987a\u5e8f\u67e5\u8be2\u7684\u8bdd\uff0c\u5bf9\u78c1\u76d8\u7684\u8bfb\u6bd4\u8f83\u63a5\u8fd1\u987a\u5e8f\u8bfb\uff0c\u80fd\u591f\u63d0\u5347\u8bfb\u6027\u80fd\u3002</strong></p>\n<p>\u8fd9\uff0c\u5c31\u662f MRR \u4f18\u5316\u7684\u8bbe\u8ba1\u601d\u8def\u3002\u6b64\u65f6\uff0c\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u53d8\u6210\u4e86\u8fd9\u6837\uff1a</p>\n<ol>\n<li>\u6839\u636e\u7d22\u5f15 a\uff0c\u5b9a\u4f4d\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u5c06 id \u503c\u653e\u5165 <code>read_rnd_buffer</code> \u4e2d ;</li>\n<li>\u5c06 <code>read_rnd_buffer</code> \u4e2d\u7684 id \u8fdb\u884c\u9012\u589e\u6392\u5e8f\uff1b</li>\n<li>\u6392\u5e8f\u540e\u7684 id \u6570\u7ec4\uff0c\u4f9d\u6b21\u5230\u4e3b\u952e id \u7d22\u5f15\u4e2d\u67e5\u8bb0\u5f55\uff0c\u5e76\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\uff0c<code>read_rnd_buffer</code> \u7684\u5927\u5c0f\u662f\u7531 <code>read_rnd_buffer_size</code> \u53c2\u6570\u63a7\u5236\u7684\u3002\u5982\u679c\u6b65\u9aa4 1 \u4e2d\uff0c<code>read_rnd_buffer</code> \u653e\u6ee1\u4e86\uff0c\u5c31\u4f1a\u5148\u6267\u884c\u5b8c\u6b65\u9aa4 2 \u548c 3\uff0c\u7136\u540e\u6e05\u7a7a <code>read_rnd_buffer</code>\u3002\u4e4b\u540e\u7ee7\u7eed\u627e\u7d22\u5f15 a \u7684\u4e0b\u4e2a\u8bb0\u5f55\uff0c\u5e76\u7ee7\u7eed\u5faa\u73af\u3002</p>\n<p>\u53e6\u5916\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5982\u679c\u4f60\u60f3\u8981\u7a33\u5b9a\u5730\u4f7f\u7528 MRR \u4f18\u5316\u7684\u8bdd\uff0c\u9700\u8981\u8bbe\u7f6e<code>set optimizer_switch=\"mrr_cost_based=off\"</code>\u3002\uff08\u5b98\u65b9\u6587\u6863\u7684\u8bf4\u6cd5\uff0c\u662f\u73b0\u5728\u7684\u4f18\u5316\u5668\u7b56\u7565\uff0c\u5224\u65ad\u6d88\u8017\u7684\u65f6\u5019\uff0c\u4f1a\u66f4\u503e\u5411\u4e8e\u4e0d\u4f7f\u7528 MRR\uff0c\u628a <code>mrr_cost_based</code> \u8bbe\u7f6e\u4e3a off\uff0c\u5c31\u662f\u56fa\u5b9a\u4f7f\u7528 MRR \u4e86\u3002\uff09</p>\n<p>\u4e0b\u9762\u4e24\u5e45\u56fe\u5c31\u662f\u4f7f\u7528\u4e86 MRR \u4f18\u5316\u540e\u7684\u6267\u884c\u6d41\u7a0b\u548c explain \u7ed3\u679c\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/d502fbaea7cac6f815c626b078da86c7.jpg\" /></p>\n<p>\u56fe 2 MRR \u6267\u884c\u6d41\u7a0b</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&lt;=</span><span class=\"mi\">100</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                            </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"n\">MRR</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+</span>\n</code></pre></div>\n<p>\u4ece explain \u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Extra \u5b57\u6bb5\u591a\u4e86 Using MRR\uff0c\u8868\u793a\u7684\u662f\u7528\u4e0a\u4e86 MRR \u4f18\u5316\u3002\u800c\u4e14\uff0c\u7531\u4e8e\u6211\u4eec\u5728 <code>read_rnd_buffer</code> \u4e2d\u6309\u7167 id \u505a\u4e86\u6392\u5e8f\uff0c\u6240\u4ee5\u6700\u540e\u5f97\u5230\u7684\u7ed3\u679c\u96c6\u4e5f\u662f\u6309\u7167\u4e3b\u952e id \u9012\u589e\u987a\u5e8f\u7684\uff0c\u4e5f\u5c31\u662f\u4e0e\u56fe 1 \u7ed3\u679c\u96c6\u4e2d\u884c\u7684\u987a\u5e8f\u76f8\u53cd\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c0f\u7ed3\u4e00\u4e0b\u3002</p>\n<p>**MRR \u80fd\u591f\u63d0\u5347\u6027\u80fd\u7684\u6838\u5fc3**\u5728\u4e8e\uff0c\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u5728\u7d22\u5f15 a \u4e0a\u505a\u7684\u662f\u4e00\u4e2a\u8303\u56f4\u67e5\u8be2\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u591a\u503c\u67e5\u8be2\uff09\uff0c\u53ef\u4ee5\u5f97\u5230\u8db3\u591f\u591a\u7684\u4e3b\u952e id\u3002\u8fd9\u6837\u901a\u8fc7\u6392\u5e8f\u4ee5\u540e\uff0c\u518d\u53bb\u4e3b\u952e\u7d22\u5f15\u67e5\u6570\u636e\uff0c\u624d\u80fd\u4f53\u73b0\u51fa\u201c\u987a\u5e8f\u6027\u201d\u7684\u4f18\u52bf\u3002</p>\n<h3 id=\"batched-key-access\">Batched Key Access<a class=\"headerlink\" href=\"#batched-key-access\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7406\u89e3\u4e86 MRR \u6027\u80fd\u63d0\u5347\u7684\u539f\u7406\uff0c\u6211\u4eec\u5c31\u80fd\u7406\u89e3 MySQL \u5728 5.6 \u7248\u672c\u540e\u5f00\u59cb\u5f15\u5165\u7684 Batched Key Acess(BKA) \u7b97\u6cd5\u4e86\u3002\u8fd9\u4e2a BKA \u7b97\u6cd5\uff0c\u5176\u5b9e\u5c31\u662f\u5bf9 NLJ \u7b97\u6cd5\u7684\u4f18\u5316\u3002</p>\n<p>\u6211\u4eec\u518d\u6765\u770b\u770b\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u7528\u5230\u7684 NLJ \u7b97\u6cd5\u7684\u6d41\u7a0b\u56fe\uff1a</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/10e14e8b9691ac6337d457172b641a3d.jpg\" /></p>\n<p>\u56fe 4 Index Nested-Loop Join \u6d41\u7a0b\u56fe</p>\n<p>NLJ \u7b97\u6cd5\u6267\u884c\u7684\u903b\u8f91\u662f\uff1a\u4ece\u9a71\u52a8\u8868 t1\uff0c\u4e00\u884c\u884c\u5730\u53d6\u51fa a \u7684\u503c\uff0c\u518d\u5230\u88ab\u9a71\u52a8\u8868 t2 \u53bb\u505a join\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u8868 t2 \u6765\u8bf4\uff0c\u6bcf\u6b21\u90fd\u662f\u5339\u914d\u4e00\u4e2a\u503c\u3002\u8fd9\u65f6\uff0cMRR \u7684\u4f18\u52bf\u5c31\u7528\u4e0d\u4e0a\u4e86\u3002</p>\n<p>\u90a3\u600e\u4e48\u624d\u80fd\u4e00\u6b21\u6027\u5730\u591a\u4f20\u4e9b\u503c\u7ed9\u8868 t2 \u5462\uff1f\u65b9\u6cd5\u5c31\u662f\uff0c\u4ece\u8868 t1 \u91cc\u4e00\u6b21\u6027\u5730\u591a\u62ff\u4e9b\u884c\u51fa\u6765\uff0c\u4e00\u8d77\u4f20\u7ed9\u8868 t2\u3002</p>\n<p>\u65e2\u7136\u5982\u6b64\uff0c\u6211\u4eec\u5c31\u628a\u8868 t1 \u7684\u6570\u636e\u53d6\u51fa\u6765\u4e00\u90e8\u5206\uff0c\u5148\u653e\u5230\u4e00\u4e2a\u4e34\u65f6\u5185\u5b58\u3002\u8fd9\u4e2a\u4e34\u65f6\u5185\u5b58\u4e0d\u662f\u522b\u4eba\uff0c\u5c31\u662f join_buffer\u3002</p>\n<p>\u901a\u8fc7\u4e0a\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u77e5\u9053 <code>join_buffer</code> \u5728 BNL \u7b97\u6cd5\u91cc\u7684\u4f5c\u7528\uff0c\u662f\u6682\u5b58\u9a71\u52a8\u8868\u7684\u6570\u636e\u3002\u4f46\u662f\u5728 NLJ \u7b97\u6cd5\u91cc\u5e76\u6ca1\u6709\u7528\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u521a\u597d\u5c31\u53ef\u4ee5\u590d\u7528 <code>join_buffer</code> \u5230 BKA \u7b97\u6cd5\u4e2d\u3002</p>\n<p>\u5982\u56fe 5 \u6240\u793a\uff0c\u662f\u4e0a\u9762\u7684 NLJ \u7b97\u6cd5\u4f18\u5316\u540e\u7684 BKA \u7b97\u6cd5\u7684\u6d41\u7a0b\u3002</p>\n<p><img alt=\"img\" src=\"../../../images/mysql-lecture-45/31d85666542b9cb0b47a447a8593a47e.jpg\" /></p>\n<p>\u56fe 5 Batched Key Acess \u6d41\u7a0b</p>\n<p>\u56fe\u4e2d\uff0c\u6211\u5728 <code>join_buffer</code> \u4e2d\u653e\u5165\u7684\u6570\u636e\u662f P1~P100\uff0c\u8868\u793a\u7684\u662f\u53ea\u4f1a\u53d6\u67e5\u8be2\u9700\u8981\u7684\u5b57\u6bb5\u3002\u5f53\u7136\uff0c\u5982\u679c join buffer \u653e\u4e0d\u4e0b P1~P100 \u7684\u6240\u6709\u6570\u636e\uff0c\u5c31\u4f1a\u628a\u8fd9 100 \u884c\u6570\u636e\u5206\u6210\u591a\u6bb5\u6267\u884c\u4e0a\u56fe\u7684\u6d41\u7a0b\u3002</p>\n<p>\u90a3\u4e48\uff0c\u8fd9\u4e2a BKA \u7b97\u6cd5\u5230\u5e95\u8981\u600e\u4e48\u542f\u7528\u5462\uff1f</p>\n<p>\u5982\u679c\u8981\u4f7f\u7528 BKA \u4f18\u5316\u7b97\u6cd5\u7684\u8bdd\uff0c\u4f60\u9700\u8981\u5728\u6267\u884c SQL \u8bed\u53e5\u4e4b\u524d\uff0c\u5148\u8bbe\u7f6e</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">optimizer_switch</span><span class=\"o\">=</span><span class=\"s1\">&#39;mrr=on,mrr_cost_based=off,batched_key_access=on&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5176\u4e2d\uff0c\u524d\u4e24\u4e2a\u53c2\u6570\u7684\u4f5c\u7528\u662f\u8981\u542f\u7528 MRR\u3002\u8fd9\u4e48\u505a\u7684\u539f\u56e0\u662f\uff0cBKA \u7b97\u6cd5\u7684\u4f18\u5316\u8981\u4f9d\u8d56\u4e8e MRR\u3002</p>\n<h3 id=\"bnl\">BNL \u7b97\u6cd5\u7684\u6027\u80fd\u95ee\u9898<a class=\"headerlink\" href=\"#bnl\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bf4\u5b8c\u4e86 NLJ \u7b97\u6cd5\u7684\u4f18\u5316\uff0c\u6211\u4eec\u518d\u6765\u770b BNL \u7b97\u6cd5\u7684\u4f18\u5316\u3002</p>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u672b\u5c3e\uff0c\u7ed9\u4f60\u7559\u4e0b\u7684\u601d\u8003\u9898\u662f\uff0c\u4f7f\u7528 Block Nested-Loop Join(BNL) \u7b97\u6cd5\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u591a\u6b21\u626b\u63cf\u3002\u5982\u679c\u8fd9\u4e2a\u88ab\u9a71\u52a8\u8868\u662f\u4e00\u4e2a\u5927\u7684\u51b7\u6570\u636e\u8868\uff0c\u9664\u4e86\u4f1a\u5bfc\u81f4 IO \u538b\u529b\u5927\u4ee5\u5916\uff0c\u8fd8\u4f1a\u5bf9\u7cfb\u7edf\u6709\u4ec0\u4e48\u5f71\u54cd\u5462\uff1f</p>\n<p>\u6211\u4eec\u8bf4\u5230 InnoDB \u7684 LRU \u7b97\u6cd5\u7684\u65f6\u5019\u63d0\u5230\uff0c\u7531\u4e8e InnoDB \u5bf9 Bufffer Pool \u7684 LRU \u7b97\u6cd5\u505a\u4e86\u4f18\u5316\uff0c\u5373\uff1a\u7b2c\u4e00\u6b21\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u7684\u6570\u636e\u9875\uff0c\u4f1a\u5148\u653e\u5728 old \u533a\u57df\u3002\u5982\u679c 1 \u79d2\u4e4b\u540e\u8fd9\u4e2a\u6570\u636e\u9875\u4e0d\u518d\u88ab\u8bbf\u95ee\u4e86\uff0c\u5c31\u4e0d\u4f1a\u88ab\u79fb\u52a8\u5230 LRU \u94fe\u8868\u5934\u90e8\uff0c\u8fd9\u6837\u5bf9 Buffer Pool \u7684\u547d\u4e2d\u7387\u5f71\u54cd\u5c31\u4e0d\u5927\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4e00\u4e2a\u4f7f\u7528 BNL \u7b97\u6cd5\u7684 join \u8bed\u53e5\uff0c\u591a\u6b21\u626b\u63cf\u4e00\u4e2a\u51b7\u8868\uff0c\u800c\u4e14\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u65f6\u95f4\u8d85\u8fc7 1 \u79d2\uff0c\u5c31\u4f1a\u5728\u518d\u6b21\u626b\u63cf\u51b7\u8868\u7684\u65f6\u5019\uff0c\u628a\u51b7\u8868\u7684\u6570\u636e\u9875\u79fb\u5230 LRU \u94fe\u8868\u5934\u90e8\u3002</p>\n<p>\u8fd9\u79cd\u60c5\u51b5\u5bf9\u5e94\u7684\uff0c\u662f\u51b7\u8868\u7684\u6570\u636e\u91cf\u5c0f\u4e8e\u6574\u4e2a Buffer Pool \u7684 &#8540;\uff0c\u80fd\u591f\u5b8c\u5168\u653e\u5165 old \u533a\u57df\u7684\u60c5\u51b5\u3002</p>\n<p>\u5982\u679c\u8fd9\u4e2a\u51b7\u8868\u5f88\u5927\uff0c\u5c31\u4f1a\u51fa\u73b0\u53e6\u5916\u4e00\u79cd\u60c5\u51b5\uff1a\u4e1a\u52a1\u6b63\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u9875\uff0c\u6ca1\u6709\u673a\u4f1a\u8fdb\u5165 young \u533a\u57df\u3002</p>\n<p>\u7531\u4e8e\u4f18\u5316\u673a\u5236\u7684\u5b58\u5728\uff0c\u4e00\u4e2a\u6b63\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u9875\uff0c\u8981\u8fdb\u5165 young \u533a\u57df\uff0c\u9700\u8981\u9694 1 \u79d2\u540e\u518d\u6b21\u88ab\u8bbf\u95ee\u5230\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u7684 join \u8bed\u53e5\u5728\u5faa\u73af\u8bfb\u78c1\u76d8\u548c\u6dd8\u6c70\u5185\u5b58\u9875\uff0c\u8fdb\u5165 old \u533a\u57df\u7684\u6570\u636e\u9875\uff0c\u5f88\u53ef\u80fd\u5728 1 \u79d2\u4e4b\u5185\u5c31\u88ab\u6dd8\u6c70\u4e86\u3002\u8fd9\u6837\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8fd9\u4e2a MySQL \u5b9e\u4f8b\u7684 Buffer Pool \u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0cyoung \u533a\u57df\u7684\u6570\u636e\u9875\u6ca1\u6709\u88ab\u5408\u7406\u5730\u6dd8\u6c70\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u79cd\u60c5\u51b5\u90fd\u4f1a\u5f71\u54cd Buffer Pool \u7684\u6b63\u5e38\u8fd0\u4f5c\u3002</p>\n<p><strong>\u5927\u8868 join \u64cd\u4f5c\u867d\u7136\u5bf9 IO \u6709\u5f71\u54cd\uff0c\u4f46\u662f\u5728\u8bed\u53e5\u6267\u884c\u7ed3\u675f\u540e\uff0c\u5bf9 IO \u7684\u5f71\u54cd\u4e5f\u5c31\u7ed3\u675f\u4e86\u3002\u4f46\u662f\uff0c\u5bf9 Buffer Pool \u7684\u5f71\u54cd\u5c31\u662f\u6301\u7eed\u6027\u7684\uff0c\u9700\u8981\u4f9d\u9760\u540e\u7eed\u7684\u67e5\u8be2\u8bf7\u6c42\u6162\u6162\u6062\u590d\u5185\u5b58\u547d\u4e2d\u7387\u3002</strong></p>\n<p>\u4e3a\u4e86\u51cf\u5c11\u8fd9\u79cd\u5f71\u54cd\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u589e\u5927 join_buffer_size \u7684\u503c\uff0c\u51cf\u5c11\u5bf9\u88ab\u9a71\u52a8\u8868\u7684\u626b\u63cf\u6b21\u6570\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0cBNL \u7b97\u6cd5\u5bf9\u7cfb\u7edf\u7684\u5f71\u54cd\u4e3b\u8981\u5305\u62ec\u4e09\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>\u53ef\u80fd\u4f1a\u591a\u6b21\u626b\u63cf\u88ab\u9a71\u52a8\u8868\uff0c\u5360\u7528\u78c1\u76d8 IO \u8d44\u6e90\uff1b</li>\n<li>\u5224\u65ad join \u6761\u4ef6\u9700\u8981\u6267\u884c M*N \u6b21\u5bf9\u6bd4\uff08M\u3001N \u5206\u522b\u662f\u4e24\u5f20\u8868\u7684\u884c\u6570\uff09\uff0c\u5982\u679c\u662f\u5927\u8868\u5c31\u4f1a\u5360\u7528\u975e\u5e38\u591a\u7684 CPU \u8d44\u6e90\uff1b</li>\n<li>\u53ef\u80fd\u4f1a\u5bfc\u81f4 Buffer Pool \u7684\u70ed\u6570\u636e\u88ab\u6dd8\u6c70\uff0c\u5f71\u54cd\u5185\u5b58\u547d\u4e2d\u7387\u3002</li>\n</ol>\n<p>\u6211\u4eec\u6267\u884c\u8bed\u53e5\u4e4b\u524d\uff0c\u9700\u8981\u901a\u8fc7\u7406\u8bba\u5206\u6790\u548c\u67e5\u770b explain \u7ed3\u679c\u7684\u65b9\u5f0f\uff0c\u786e\u8ba4\u662f\u5426\u8981\u4f7f\u7528 BNL \u7b97\u6cd5\u3002\u5982\u679c\u786e\u8ba4\u4f18\u5316\u5668\u4f1a\u4f7f\u7528 BNL \u7b97\u6cd5\uff0c\u5c31\u9700\u8981\u505a\u4f18\u5316\u3002\u4f18\u5316\u7684\u5e38\u89c1\u505a\u6cd5\u662f\uff0c\u7ed9\u88ab\u9a71\u52a8\u8868\u7684 join \u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\uff0c\u628a BNL \u7b97\u6cd5\u8f6c\u6210 BKA \u7b97\u6cd5\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5177\u4f53\u770b\u770b\uff0c\u8fd9\u4e2a\u4f18\u5316\u600e\u4e48\u505a\uff1f</p>\n<h3 id=\"bnl-bka\">BNL \u8f6c BKA<a class=\"headerlink\" href=\"#bnl-bka\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u5efa\u7d22\u5f15\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u76f4\u63a5\u8f6c\u6210 BKA \u7b97\u6cd5\u4e86\u3002</p>\n<p>\u4f46\u662f\uff0c\u6709\u65f6\u5019\u4f60\u786e\u5b9e\u4f1a\u78b0\u5230\u4e00\u4e9b\u4e0d\u9002\u5408\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u5efa\u7d22\u5f15\u7684\u60c5\u51b5\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6211\u4eec\u5728\u6587\u7ae0\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u5728\u8868 t2 \u4e2d\u63d2\u5165\u4e86 100 \u4e07\u884c\u6570\u636e\uff0c\u4f46\u662f\u7ecf\u8fc7 where \u6761\u4ef6\u8fc7\u6ee4\u540e\uff0c\u9700\u8981\u53c2\u4e0e join \u7684\u53ea\u6709 2000 \u884c\u6570\u636e\u3002\u5982\u679c\u8fd9\u6761\u8bed\u53e5\u540c\u65f6\u662f\u4e00\u4e2a\u4f4e\u9891\u7684 SQL \u8bed\u53e5\uff0c\u90a3\u4e48\u518d\u4e3a\u8fd9\u4e2a\u8bed\u53e5\u5728\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u5c31\u5f88\u6d6a\u8d39\u4e86\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u4f7f\u7528 BNL \u7b97\u6cd5\u6765 join \u7684\u8bdd\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u628a\u8868 t1 \u7684\u6240\u6709\u5b57\u6bb5\u53d6\u51fa\u6765\uff0c\u5b58\u5165 <code>join_buffer</code> \u4e2d\u3002\u8fd9\u4e2a\u8868\u53ea\u6709 1000 \u884c\uff0c<code>join_buffer_size</code> \u9ed8\u8ba4\u503c\u662f 256k\uff0c\u53ef\u4ee5\u5b8c\u5168\u5b58\u5165\u3002</li>\n<li>\u626b\u63cf\u8868 t2\uff0c\u53d6\u51fa\u6bcf\u4e00\u884c\u6570\u636e\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5bf9\u6bd4\uff0c </li>\n<li>\u5982\u679c\u4e0d\u6ee1\u8db3 t1.b=t2.b\uff0c\u5219\u8df3\u8fc7\uff1b</li>\n<li>\u5982\u679c\u6ee1\u8db3 t1.b=t2.b, \u518d\u5224\u65ad\u5176\u4ed6\u6761\u4ef6\uff0c\u4e5f\u5c31\u662f\u662f\u5426\u6ee1\u8db3 t2.b \u5904\u4e8e [1,2000] \u7684\u6761\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5c31\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\uff0c\u5426\u5219\u8df3\u8fc7\u3002</li>\n</ol>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bf4\u8fc7\uff0c\u5bf9\u4e8e\u8868 t2 \u7684\u6bcf\u4e00\u884c\uff0c\u5224\u65ad join \u662f\u5426\u6ee1\u8db3\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u904d\u5386 join_buffer \u4e2d\u7684\u6240\u6709\u884c\u3002\u56e0\u6b64\u5224\u65ad\u7b49\u503c\u6761\u4ef6\u7684\u6b21\u6570\u662f 1000*100 \u4e07 =10 \u4ebf\u6b21\uff0c\u8fd9\u4e2a\u5224\u65ad\u7684\u5de5\u4f5c\u91cf\u5f88\u5927\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                                              </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\">                                        </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"mi\">998222</span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Block</span><span class=\"w\"> </span><span class=\"n\">Nested</span><span class=\"w\"> </span><span class=\"n\">Loop</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cexplain \u7ed3\u679c\u91cc Extra \u5b57\u6bb5\u663e\u793a\u4f7f\u7528\u4e86 BNL \u7b97\u6cd5\u3002\u5728\u6211\u7684\u6d4b\u8bd5\u73af\u5883\u91cc\uff0c\u8fd9\u6761\u8bed\u53e5\u9700\u8981\u6267\u884c 1 \u5206 11 \u79d2\u3002</p>\n<p>\u5728\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u7d22\u5f15\u4f1a\u6d6a\u8d39\u8d44\u6e90\uff0c\u4f46\u662f\u4e0d\u521b\u5efa\u7d22\u5f15\u7684\u8bdd\u8fd9\u4e2a\u8bed\u53e5\u7684\u7b49\u503c\u6761\u4ef6\u8981\u5224\u65ad 10 \u4ebf\u6b21\uff0c\u60f3\u60f3\u4e5f\u662f\u6d6a\u8d39\u3002\u90a3\u4e48\uff0c\u6709\u6ca1\u6709\u4e24\u5168\u5176\u7f8e\u7684\u529e\u6cd5\u5462\uff1f</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u4e34\u65f6\u8868\u3002\u4f7f\u7528\u4e34\u65f6\u8868\u7684\u5927\u81f4\u601d\u8def\u662f\uff1a</p>\n<ol>\n<li>\u628a\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u653e\u5728\u4e34\u65f6\u8868 tmp_t \u4e2d\uff1b</li>\n<li>\u4e3a\u4e86\u8ba9 join \u4f7f\u7528 BKA \u7b97\u6cd5\uff0c\u7ed9\u4e34\u65f6\u8868 tmp_t \u7684\u5b57\u6bb5 b \u52a0\u4e0a\u7d22\u5f15\uff1b</li>\n<li>\u8ba9\u8868 t1 \u548c tmp_t \u505a join \u64cd\u4f5c\u3002</li>\n</ol>\n<p>\u6b64\u65f6\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u7684\u5199\u6cd5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">))</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">temp_t</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u6d88\u8017\uff1a</p>\n<ol>\n<li>\u6267\u884c insert \u8bed\u53e5\u6784\u9020 <code>temp_t</code> \u8868\u5e76\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8868 t2 \u505a\u4e86\u5168\u8868\u626b\u63cf\uff0c\u8fd9\u91cc\u626b\u63cf\u884c\u6570\u662f 100 \u4e07\u3002</li>\n<li>\u4e4b\u540e\u7684 join \u8bed\u53e5\uff0c\u626b\u63cf\u8868 t1\uff0c\u8fd9\u91cc\u7684\u626b\u63cf\u884c\u6570\u662f 1000\uff1bjoin \u6bd4\u8f83\u8fc7\u7a0b\u4e2d\uff0c\u505a\u4e86 1000 \u6b21\u5e26\u7d22\u5f15\u7684\u67e5\u8be2\u3002\u76f8\u6bd4\u4e8e\u4f18\u5316\u524d\u7684 join \u8bed\u53e5\u9700\u8981\u505a 10 \u4ebf\u6b21\u6761\u4ef6\u5224\u65ad\u6765\u8bf4\uff0c\u8fd9\u4e2a\u4f18\u5316\u6548\u679c\u8fd8\u662f\u5f88\u660e\u663e\u7684\u3002</li>\n</ol>\n<p>\u603b\u4f53\u6765\u770b\uff0c\u4e0d\u8bba\u662f\u5728\u539f\u8868\u4e0a\u52a0\u7d22\u5f15\uff0c\u8fd8\u662f\u7528\u6709\u7d22\u5f15\u7684\u4e34\u65f6\u8868\uff0c\u6211\u4eec\u7684\u601d\u8def\u90fd\u662f\u8ba9 join \u8bed\u53e5\u80fd\u591f\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u7d22\u5f15\uff0c\u6765\u89e6\u53d1 BKA \u7b97\u6cd5\uff0c\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002</p>\n<h3 id=\"hash-join\">\u6269\u5c55 hash join<a class=\"headerlink\" href=\"#hash-join\" title=\"Permanent link\">&para;</a></h3>\n<p>\u770b\u5230\u8fd9\u91cc\u4f60\u53ef\u80fd\u53d1\u73b0\u4e86\uff0c\u5176\u5b9e\u4e0a\u9762\u8ba1\u7b97 10 \u4ebf\u6b21\u90a3\u4e2a\u64cd\u4f5c\uff0c\u770b\u4e0a\u53bb\u6709\u70b9\u513f\u50bb\u3002\u5982\u679c <code>join_buffer</code> \u91cc\u9762\u7ef4\u62a4\u7684\u4e0d\u662f\u4e00\u4e2a\u65e0\u5e8f\u6570\u7ec4\uff0c\u800c\u662f\u4e00\u4e2a\u54c8\u5e0c\u8868\u7684\u8bdd\uff0c\u90a3\u4e48\u5c31\u4e0d\u662f 10 \u4ebf\u6b21\u5224\u65ad\uff0c\u800c\u662f 100 \u4e07\u6b21 hash \u67e5\u627e\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u6574\u6761\u8bed\u53e5\u7684\u6267\u884c\u901f\u5ea6\u5c31\u5feb\u591a\u4e86\u5427\uff1f</p>\n<p>\u786e\u5b9e\u5982\u6b64\u3002</p>\n<p>\u8fd9\uff0c\u4e5f\u6b63\u662f MySQL \u7684\u4f18\u5316\u5668\u548c\u6267\u884c\u5668\u4e00\u76f4\u88ab\u8bdf\u75c5\u7684\u4e00\u4e2a\u539f\u56e0\uff1a\u4e0d\u652f\u6301\u54c8\u5e0c join\u3002\u5e76\u4e14\uff0cMySQL \u5b98\u65b9\u7684 roadmap\uff0c\u4e5f\u662f\u8fdf\u8fdf\u6ca1\u6709\u628a\u8fd9\u4e2a\u4f18\u5316\u6392\u4e0a\u8bae\u7a0b\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u4f18\u5316\u601d\u8def\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0\u5728\u4e1a\u52a1\u7aef\u3002\u5b9e\u73b0\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>select * from t1;</code>\u53d6\u5f97\u8868 t1 \u7684\u5168\u90e8 1000 \u884c\u6570\u636e\uff0c\u5728\u4e1a\u52a1\u7aef\u5b58\u5165\u4e00\u4e2a hash \u7ed3\u6784\uff0c\u6bd4\u5982 C++ \u91cc\u7684 set\u3001PHP \u7684 dict \u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u3002</li>\n<li><code>select * from t2 where b&gt;=1 and b&lt;=2000;</code> \u83b7\u53d6\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684 2000 \u884c\u6570\u636e\u3002</li>\n<li>\u628a\u8fd9 2000 \u884c\u6570\u636e\uff0c\u4e00\u884c\u4e00\u884c\u5730\u53d6\u5230\u4e1a\u52a1\u7aef\uff0c\u5230 hash \u7ed3\u6784\u7684\u6570\u636e\u8868\u4e2d\u5bfb\u627e\u5339\u914d\u7684\u6570\u636e\u3002\u6ee1\u8db3\u5339\u914d\u7684\u6761\u4ef6\u7684\u8fd9\u884c\u6570\u636e\uff0c\u5c31\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u884c\u3002</li>\n</ol>\n<p>\u7406\u8bba\u4e0a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u6bd4\u4e34\u65f6\u8868\u65b9\u6848\u7684\u6267\u884c\u901f\u5ea6\u8fd8\u8981\u5feb\u4e00\u4e9b\u3002\u5982\u679c\u4f60\u611f\u5174\u8da3\u7684\u8bdd\uff0c\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u3002</p>\n<h3 id=\"_15\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_15\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u5206\u4eab\u4e86 Index Nested-Loop Join\uff08NLJ\uff09\u548c Block Nested-Loop Join\uff08BNL\uff09\u7684\u4f18\u5316\u65b9\u6cd5\u3002</p>\n<p>\u5728\u8fd9\u4e9b\u4f18\u5316\u65b9\u6cd5\u4e2d\uff1a</p>\n<ol>\n<li>BKA \u4f18\u5316\u662f MySQL \u5df2\u7ecf\u5185\u7f6e\u652f\u6301\u7684\uff0c\u5efa\u8bae\u4f60\u9ed8\u8ba4\u4f7f\u7528\uff1b</li>\n<li>BNL \u7b97\u6cd5\u6548\u7387\u4f4e\uff0c\u5efa\u8bae\u4f60\u90fd\u5c3d\u91cf\u8f6c\u6210 BKA \u7b97\u6cd5\u3002\u4f18\u5316\u7684\u65b9\u5411\u5c31\u662f\u7ed9\u88ab\u9a71\u52a8\u8868\u7684\u5173\u8054\u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\uff1b</li>\n<li>\u57fa\u4e8e\u4e34\u65f6\u8868\u7684\u6539\u8fdb\u65b9\u6848\uff0c\u5bf9\u4e8e\u80fd\u591f\u63d0\u524d\u8fc7\u6ee4\u51fa\u5c0f\u6570\u636e\u7684 join \u8bed\u53e5\u6765\u8bf4\uff0c\u6548\u679c\u8fd8\u662f\u5f88\u597d\u7684\uff1b</li>\n<li>MySQL \u76ee\u524d\u7684\u7248\u672c\u8fd8\u4e0d\u652f\u6301 hash join\uff0c\u4f46\u4f60\u53ef\u4ee5\u914d\u5408\u5e94\u7528\u7aef\u81ea\u5df1\u6a21\u62df\u51fa\u6765\uff0c\u7406\u8bba\u4e0a\u6548\u679c\u8981\u597d\u4e8e\u4e34\u65f6\u8868\u7684\u65b9\u6848\u3002</li>\n</ol>\n<p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u9053\u601d\u8003\u9898\u5427\u3002</p>\n<p>\u6211\u4eec\u5728\u8bb2 join \u8bed\u53e5\u7684\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e2d\uff0c\u90fd\u53ea\u6d89\u53ca\u5230\u4e86\u4e24\u4e2a\u8868\u7684 join\u3002\u90a3\u4e48\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u4e09\u4e2a\u8868 join \u7684\u9700\u6c42\uff0c\u5047\u8bbe\u8fd9\u4e09\u4e2a\u8868\u7684\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t1</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">a</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">b</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t3</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"p\">...</span><span class=\"w\"> </span><span class=\"c1\">-- \u521d\u59cb\u5316\u4e09\u5f20\u8868\u7684\u6570\u636e</span>\n</code></pre></div>\n<p>\u8bed\u53e5\u7684\u9700\u6c42\u5b9e\u73b0\u5982\u4e0b\u7684 join \u903b\u8f91\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">t3</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">t3</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"k\">c</span><span class=\"o\">&gt;=</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">.</span><span class=\"k\">c</span><span class=\"o\">&gt;=</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">t3</span><span class=\"p\">.</span><span class=\"k\">c</span><span class=\"o\">&gt;=</span><span class=\"n\">Z</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u73b0\u5728\u4e3a\u4e86\u5f97\u5230\u6700\u5feb\u7684\u6267\u884c\u901f\u5ea6\uff0c\u5982\u679c\u8ba9\u4f60\u6765\u8bbe\u8ba1\u8868 t1\u3001t2\u3001t3 \u4e0a\u7684\u7d22\u5f15\uff0c\u6765\u652f\u6301\u8fd9\u4e2a join \u8bed\u53e5\uff0c\u4f60\u4f1a\u52a0\u54ea\u4e9b\u7d22\u5f15\u5462\uff1f</p>\n<p>\u540c\u65f6\uff0c\u5982\u679c\u6211\u5e0c\u671b\u4f60\u7528 <code>straight_join</code> \u6765\u91cd\u5199\u8fd9\u4e2a\u8bed\u53e5\uff0c\u914d\u5408\u4f60\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u4f60\u5c31\u9700\u8981\u5b89\u6392\u8fde\u63a5\u987a\u5e8f\uff0c\u4f60\u4e3b\u8981\u8003\u8651\u7684\u56e0\u7d20\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u56de\u7b54\uff1a</p>\n<p>\u5982\u679c\u6539\u5199\u6210 <code>straight_join</code>\uff0c\u8981\u600e\u4e48\u6307\u5b9a\u8fde\u63a5\u987a\u5e8f\uff0c\u4ee5\u53ca\u600e\u4e48\u7ed9\u4e09\u4e2a\u8868\u521b\u5efa\u7d22\u5f15\u3002</p>\n<p>\u7b2c\u4e00\u539f\u5219\u662f\u8981\u5c3d\u91cf\u4f7f\u7528 BKA \u7b97\u6cd5\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4f7f\u7528 BKA \u7b97\u6cd5\u7684\u65f6\u5019\uff0c\u5e76\u4e0d\u662f\u201c\u5148\u8ba1\u7b97\u4e24\u4e2a\u8868 join \u7684\u7ed3\u679c\uff0c\u518d\u8ddf\u7b2c\u4e09\u4e2a\u8868 join\u201d\uff0c\u800c\u662f\u76f4\u63a5\u5d4c\u5957\u67e5\u8be2\u7684\u3002</p>\n<p>\u5177\u4f53\u5b9e\u73b0\u662f\uff1a\u5728 t1.c&gt;=X\u3001t2.c&gt;=Y\u3001t3.c&gt;=Z \u8fd9\u4e09\u4e2a\u6761\u4ef6\u91cc\uff0c\u9009\u62e9\u4e00\u4e2a\u7ecf\u8fc7\u8fc7\u6ee4\u4ee5\u540e\uff0c\u6570\u636e\u6700\u5c11\u7684\u90a3\u4e2a\u8868\uff0c\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u3002\u6b64\u65f6\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u5982\u4e0b\u4e24\u79cd\u60c5\u51b5\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u9009\u51fa\u6765\u662f\u8868 t1 \u6216\u8005 t3\uff0c\u90a3\u5269\u4e0b\u7684\u90e8\u5206\u5c31\u56fa\u5b9a\u4e86\u3002</p>\n<ol>\n<li>\u5982\u679c\u9a71\u52a8\u8868\u662f t1\uff0c\u5219\u8fde\u63a5\u987a\u5e8f\u662f t1-&gt;t2-&gt;t3\uff0c\u8981\u5728\u88ab\u9a71\u52a8\u8868\u5b57\u6bb5\u521b\u5efa\u4e0a\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f t2.a \u548c t3.b \u4e0a\u521b\u5efa\u7d22\u5f15\uff1b</li>\n<li>\u5982\u679c\u9a71\u52a8\u8868\u662f t3\uff0c\u5219\u8fde\u63a5\u987a\u5e8f\u662f t3-&gt;t2-&gt;t1\uff0c\u9700\u8981\u5728 t2.b \u548c t1.a \u4e0a\u521b\u5efa\u7d22\u5f15\u3002</li>\n</ol>\n<p>\u540c\u65f6\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5728\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u7684\u5b57\u6bb5 c \u4e0a\u521b\u5efa\u7d22\u5f15\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u5982\u679c\u9009\u51fa\u6765\u7684\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u662f\u8868 t2 \u7684\u8bdd\uff0c\u5219\u9700\u8981\u8bc4\u4f30\u53e6\u5916\u4e24\u4e2a\u6761\u4ef6\u7684\u8fc7\u6ee4\u6548\u679c\u3002</p>\n<p>\u603b\u4e4b\uff0c\u6574\u4f53\u7684\u601d\u8def\u5c31\u662f\uff0c\u5c3d\u91cf\u8ba9\u6bcf\u4e00\u6b21\u53c2\u4e0e join \u7684\u9a71\u52a8\u8868\u7684\u6570\u636e\u96c6\uff0c\u8d8a\u5c0f\u8d8a\u597d\uff0c\u56e0\u4e3a\u8fd9\u6837\u6211\u4eec\u7684\u9a71\u52a8\u8868\u5c31\u4f1a\u8d8a\u5c0f\u3002</p>\n<h2 id=\"36\">36 \u4e3a\u4ec0\u4e48\u4e34\u65f6\u8868\u53ef\u4ee5\u91cd\u540d\uff1f<a class=\"headerlink\" href=\"#36\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5728\u4f18\u5316 join \u67e5\u8be2\u7684\u65f6\u5019\u4f7f\u7528\u5230\u4e86\u4e34\u65f6\u8868\u3002\u5f53\u65f6\uff0c\u6211\u4eec\u662f\u8fd9\u4e48\u7528\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">;</span>\n<span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">temp_t</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u6709\u7591\u95ee\uff0c\u4e3a\u4ec0\u4e48\u8981\u7528\u4e34\u65f6\u8868\u5462\uff1f\u76f4\u63a5\u7528\u666e\u901a\u8868\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u5462\uff1f</p>\n<p>\u4eca\u5929\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u8bf4\u8d77\uff1a\u4e34\u65f6\u8868\u6709\u54ea\u4e9b\u7279\u5f81\uff0c\u4e3a\u4ec0\u4e48\u5b83\u9002\u5408\u8fd9\u4e2a\u573a\u666f\uff1f</p>\n<p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5148\u5e2e\u4f60\u5398\u6e05\u4e00\u4e2a\u5bb9\u6613\u8bef\u89e3\u7684\u95ee\u9898\uff1a\u6709\u7684\u4eba\u53ef\u80fd\u4f1a\u8ba4\u4e3a\uff0c\u4e34\u65f6\u8868\u5c31\u662f\u5185\u5b58\u8868\u3002\u4f46\u662f\uff0c\u8fd9\u4e24\u4e2a\u6982\u5ff5\u53ef\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u3002</p>\n<ul>\n<li>\u5185\u5b58\u8868\uff0c\u6307\u7684\u662f\u4f7f\u7528 Memory \u5f15\u64ce\u7684\u8868\uff0c\u5efa\u8868\u8bed\u6cd5\u662f <code>create table \u2026 engine=memory</code>\u3002\u8fd9\u79cd\u8868\u7684\u6570\u636e\u90fd\u4fdd\u5b58\u5728\u5185\u5b58\u91cc\uff0c\u7cfb\u7edf\u91cd\u542f\u7684\u65f6\u5019\u4f1a\u88ab\u6e05\u7a7a\uff0c\u4f46\u662f\u8868\u7ed3\u6784\u8fd8\u5728\u3002\u9664\u4e86\u8fd9\u4e24\u4e2a\u7279\u6027\u770b\u4e0a\u53bb\u6bd4\u8f83\u201c\u5947\u602a\u201d\u5916\uff0c\u4ece\u5176\u4ed6\u7684\u7279\u5f81\u4e0a\u770b\uff0c\u5b83\u5c31\u662f\u4e00\u4e2a\u6b63\u5e38\u7684\u8868\u3002</li>\n<li>\u800c\u4e34\u65f6\u8868\uff0c\u53ef\u4ee5\u4f7f\u7528\u5404\u79cd\u5f15\u64ce\u7c7b\u578b \u3002\u5982\u679c\u662f\u4f7f\u7528 InnoDB \u5f15\u64ce\u6216\u8005 MyISAM \u5f15\u64ce\u7684\u4e34\u65f6\u8868\uff0c\u5199\u6570\u636e\u7684\u65f6\u5019\u662f\u5199\u5230\u78c1\u76d8\u4e0a\u7684\u3002\u5f53\u7136\uff0c\u4e34\u65f6\u8868\u4e5f\u53ef\u4ee5\u4f7f\u7528 Memory \u5f15\u64ce\u3002</li>\n</ul>\n<p>\u5f04\u6e05\u695a\u4e86\u5185\u5b58\u8868\u548c\u4e34\u65f6\u8868\u7684\u533a\u522b\u4ee5\u540e\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u4e34\u65f6\u8868\u6709\u54ea\u4e9b\u7279\u5f81\u3002</p>\n<h3 id=\"_16\">\u4e34\u65f6\u8868\u7684\u7279\u6027<a class=\"headerlink\" href=\"#_16\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u6211\u4eec\u6765\u770b\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u64cd\u4f5c\u5e8f\u5217\uff1a</p>\n<pre class=\"mermaid\"><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\n\nSessionA -&gt;&gt; Table: create temporary table t(c int) engine=myisam;\n\nSessionB -&gt;&gt;+ Table: show create table t\nTable --&gt;&gt;- SessionB: Table 't' doesn't exists\n\nSessionA -&gt;&gt; Table: create table t (id int primary key) engine=innodb\nSessionA -&gt;&gt; Table: show create table t;\nTable --&gt;&gt; SessionA: return 't' defination\nSessionA -&gt;&gt; Table: show tables \nTable --&gt;&gt; SessionA: return all normal tables\n\nSessionB -&gt;&gt;+ Table: insert into t values(1)\nTable --&gt;&gt;- SessionB: return 1\n\nSessionA -&gt;&gt;+ Table: select * from t\nTable --&gt;&gt;- SessionA: return empty</code></pre>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e34\u65f6\u8868\u5728\u4f7f\u7528\u4e0a\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p>\n<ol>\n<li>\u5efa\u8868\u8bed\u6cd5\u662f <code>create temporary table \u2026</code>\u3002</li>\n<li>\u4e00\u4e2a\u4e34\u65f6\u8868\u53ea\u80fd\u88ab\u521b\u5efa\u5b83\u7684 session \u8bbf\u95ee\uff0c\u5bf9\u5176\u4ed6\u7ebf\u7a0b\u4e0d\u53ef\u89c1\u3002\u6240\u4ee5\uff0c\u56fe\u4e2d session A \u521b\u5efa\u7684\u4e34\u65f6\u8868 t\uff0c\u5bf9\u4e8e session B \u5c31\u662f\u4e0d\u53ef\u89c1\u7684\u3002</li>\n<li>\u4e34\u65f6\u8868\u53ef\u4ee5\u4e0e\u666e\u901a\u8868\u540c\u540d\u3002</li>\n<li>session A \u5185\u6709\u540c\u540d\u7684\u4e34\u65f6\u8868\u548c\u666e\u901a\u8868\u7684\u65f6\u5019\uff0cshow create \u8bed\u53e5\uff0c\u4ee5\u53ca\u589e\u5220\u6539\u67e5\u8bed\u53e5\u8bbf\u95ee\u7684\u662f\u4e34\u65f6\u8868\u3002</li>\n<li>show tables \u547d\u4ee4\u4e0d\u663e\u793a\u4e34\u65f6\u8868\u3002</li>\n</ol>\n<p>\u7531\u4e8e\u4e34\u65f6\u8868\u53ea\u80fd\u88ab\u521b\u5efa\u5b83\u7684 session \u8bbf\u95ee\uff0c\u6240\u4ee5\u5728\u8fd9\u4e2a session \u7ed3\u675f\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u5220\u9664\u4e34\u65f6\u8868\u3002\u4e5f\u6b63\u662f\u7531\u4e8e\u8fd9\u4e2a\u7279\u6027\uff0c<strong>\u4e34\u65f6\u8868\u5c31\u7279\u522b\u9002\u5408\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684 join \u4f18\u5316\u8fd9\u79cd\u573a\u666f</strong>\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u539f\u56e0\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u4e24\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>\u4e0d\u540c session \u7684\u4e34\u65f6\u8868\u662f\u53ef\u4ee5\u91cd\u540d\u7684\uff0c\u5982\u679c\u6709\u591a\u4e2a session \u540c\u65f6\u6267\u884c join \u4f18\u5316\uff0c\u4e0d\u9700\u8981\u62c5\u5fc3\u8868\u540d\u91cd\u590d\u5bfc\u81f4\u5efa\u8868\u5931\u8d25\u7684\u95ee\u9898\u3002</li>\n<li>\u4e0d\u9700\u8981\u62c5\u5fc3\u6570\u636e\u5220\u9664\u95ee\u9898\u3002\u5982\u679c\u4f7f\u7528\u666e\u901a\u8868\uff0c\u5728\u6d41\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u5ba2\u6237\u7aef\u53d1\u751f\u4e86\u5f02\u5e38\u65ad\u5f00\uff0c\u6216\u8005\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u8fd8\u9700\u8981\u4e13\u95e8\u6765\u6e05\u7406\u4e2d\u95f4\u8fc7\u7a0b\u4e2d\u751f\u6210\u7684\u6570\u636e\u8868\u3002\u800c\u4e34\u65f6\u8868\u7531\u4e8e\u4f1a\u81ea\u52a8\u56de\u6536\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u8fd9\u4e2a\u989d\u5916\u7684\u64cd\u4f5c\u3002</li>\n</ol>\n<h3 id=\"_17\">\u4e34\u65f6\u8868\u7684\u5e94\u7528<a class=\"headerlink\" href=\"#_17\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7531\u4e8e\u4e0d\u7528\u62c5\u5fc3\u7ebf\u7a0b\u4e4b\u95f4\u7684\u91cd\u540d\u51b2\u7a81\uff0c\u4e34\u65f6\u8868\u7ecf\u5e38\u4f1a\u88ab\u7528\u5728\u590d\u6742\u67e5\u8be2\u7684\u4f18\u5316\u8fc7\u7a0b\u4e2d\u3002\u5176\u4e2d\uff0c\u5206\u5e93\u5206\u8868\u7cfb\u7edf\u7684\u8de8\u5e93\u67e5\u8be2\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u4f7f\u7528\u573a\u666f\u3002</p>\n<p>\u4e00\u822c\u5206\u5e93\u5206\u8868\u7684\u573a\u666f\uff0c\u5c31\u662f\u8981\u628a\u4e00\u4e2a\u903b\u8f91\u4e0a\u7684\u5927\u8868\u5206\u6563\u5230\u4e0d\u540c\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\u3002\u6bd4\u5982\u3002\u5c06\u4e00\u4e2a\u5927\u8868 ht\uff0c\u6309\u7167\u5b57\u6bb5 f\uff0c\u62c6\u5206\u6210 1024 \u4e2a\u5206\u8868\uff0c\u7136\u540e\u5206\u5e03\u5230 32 \u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\u3002</p>\n<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u5206\u5e93\u5206\u8868\u7cfb\u7edf\u90fd\u6709\u4e00\u4e2a\u4e2d\u95f4\u5c42 proxy\u3002\u4e0d\u8fc7\uff0c\u4e5f\u6709\u4e00\u4e9b\u65b9\u6848\u4f1a\u8ba9\u5ba2\u6237\u7aef\u76f4\u63a5\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u4e5f\u5c31\u662f\u6ca1\u6709 proxy \u8fd9\u4e00\u5c42\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u67b6\u6784\u4e2d\uff0c\u5206\u533a key \u7684\u9009\u62e9\u662f\u4ee5\u201c\u51cf\u5c11\u8de8\u5e93\u548c\u8de8\u8868\u67e5\u8be2\u201d\u4e3a\u4f9d\u636e\u7684\u3002\u5982\u679c\u5927\u90e8\u5206\u7684\u8bed\u53e5\u90fd\u4f1a\u5305\u542b f \u7684\u7b49\u503c\u6761\u4ef6\uff0c\u90a3\u4e48\u5c31\u8981\u7528 f \u505a\u5206\u533a\u952e\u3002\u8fd9\u6837\uff0c\u5728 proxy \u8fd9\u4e00\u5c42\u89e3\u6790\u5b8c SQL \u8bed\u53e5\u4ee5\u540e\uff0c\u5c31\u80fd\u786e\u5b9a\u5c06\u8fd9\u6761\u8bed\u53e5\u8def\u7531\u5230\u54ea\u4e2a\u5206\u8868\u505a\u67e5\u8be2\u3002</p>\n<p>\u6bd4\u5982\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">=</span><span class=\"n\">N</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5206\u8868\u89c4\u5219\uff08\u6bd4\u5982\uff0cN%1024) \u6765\u786e\u8ba4\u9700\u8981\u7684\u6570\u636e\u88ab\u653e\u5728\u4e86\u54ea\u4e2a\u5206\u8868\u4e0a\u3002\u8fd9\u79cd\u8bed\u53e5\u53ea\u9700\u8981\u8bbf\u95ee\u4e00\u4e2a\u5206\u8868\uff0c\u662f\u5206\u5e93\u5206\u8868\u65b9\u6848\u6700\u6b22\u8fce\u7684\u8bed\u53e5\u5f62\u5f0f\u4e86\u3002</p>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u8fd9\u4e2a\u8868\u4e0a\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u7d22\u5f15 k\uff0c\u5e76\u4e14\u67e5\u8be2\u8bed\u53e5\u662f\u8fd9\u6837\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">t_modified</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u65f6\u5019\uff0c\u7531\u4e8e\u67e5\u8be2\u6761\u4ef6\u91cc\u9762\u6ca1\u6709\u7528\u5230\u5206\u533a\u5b57\u6bb5 f\uff0c\u53ea\u80fd\u5230\u6240\u6709\u7684\u5206\u533a\u4e2d\u53bb\u67e5\u627e\u6ee1\u8db3\u6761\u4ef6\u7684\u6240\u6709\u884c\uff0c\u7136\u540e\u7edf\u4e00\u505a order by \u7684\u64cd\u4f5c\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6709\u4e24\u79cd\u6bd4\u8f83\u5e38\u7528\u7684\u601d\u8def\u3002</p>\n<p>**\u7b2c\u4e00\u79cd\u601d\u8def\u662f\uff0c**\u5728 proxy \u5c42\u7684\u8fdb\u7a0b\u4ee3\u7801\u4e2d\u5b9e\u73b0\u6392\u5e8f\u3002</p>\n<p>\u8fd9\u79cd\u65b9\u5f0f\u7684\u4f18\u52bf\u662f\u5904\u7406\u901f\u5ea6\u5feb\uff0c\u62ff\u5230\u5206\u5e93\u7684\u6570\u636e\u4ee5\u540e\uff0c\u76f4\u63a5\u5728\u5185\u5b58\u4e2d\u53c2\u4e0e\u8ba1\u7b97\u3002\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u65b9\u6848\u7684\u7f3a\u70b9\u4e5f\u6bd4\u8f83\u660e\u663e\uff1a</p>\n<ol>\n<li>\u9700\u8981\u7684\u5f00\u53d1\u5de5\u4f5c\u91cf\u6bd4\u8f83\u5927\u3002\u6211\u4eec\u4e3e\u4f8b\u7684\u8fd9\u6761\u8bed\u53e5\u8fd8\u7b97\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u5982\u679c\u6d89\u53ca\u5230\u590d\u6742\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982 group by\uff0c\u751a\u81f3 join \u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u5bf9\u4e2d\u95f4\u5c42\u7684\u5f00\u53d1\u80fd\u529b\u8981\u6c42\u6bd4\u8f83\u9ad8\uff1b</li>\n<li>\u5bf9 proxy \u7aef\u7684\u538b\u529b\u6bd4\u8f83\u5927\uff0c\u5c24\u5176\u662f\u5f88\u5bb9\u6613\u51fa\u73b0\u5185\u5b58\u4e0d\u591f\u7528\u548c CPU \u74f6\u9888\u7684\u95ee\u9898\u3002</li>\n</ol>\n<p>**\u53e6\u4e00\u79cd\u601d\u8def\u5c31\u662f\uff0c**\u628a\u5404\u4e2a\u5206\u5e93\u62ff\u5230\u7684\u6570\u636e\uff0c\u6c47\u603b\u5230\u4e00\u4e2a MySQL \u5b9e\u4f8b\u7684\u4e00\u4e2a\u8868\u4e2d\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u6c47\u603b\u5b9e\u4f8b\u4e0a\u505a\u903b\u8f91\u64cd\u4f5c\u3002</p>\n<p>\u6bd4\u5982\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\uff0c\u6267\u884c\u6d41\u7a0b\u53ef\u4ee5\u7c7b\u4f3c\u8fd9\u6837\uff1a</p>\n<ul>\n<li>\u5728\u6c47\u603b\u5e93\u4e0a\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u8868 <code>temp_ht</code>\uff0c\u8868\u91cc\u5305\u542b\u4e09\u4e2a\u5b57\u6bb5 v\u3001k\u3001<code>t_modified</code>\uff1b</li>\n<li>\n<p>\u5728\u5404\u4e2a\u5206\u5e93\u4e0a\u6267\u884c</p>\n<p><code>select v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100;</code></p>\n</li>\n<li>\n<p>\u628a\u5206\u5e93\u6267\u884c\u7684\u7ed3\u679c\u63d2\u5165\u5230 temp_ht \u8868\u4e2d\uff1b</p>\n</li>\n<li>\n<p>\u6267\u884c</p>\n<p><code>select v from temp_ht order by t_modified desc limit 100;</code> </p>\n</li>\n</ul>\n<p>\u5f97\u5230\u7ed3\u679c\u3002</p>\n<p>**\u5728\u5b9e\u8df5\u4e2d\uff0c\u6211\u4eec\u5f80\u5f80\u4f1a\u53d1\u73b0\u6bcf\u4e2a\u5206\u5e93\u7684\u8ba1\u7b97\u91cf\u90fd\u4e0d\u9971\u548c\uff0c\u6240\u4ee5\u4f1a\u76f4\u63a5\u628a\u4e34\u65f6\u8868 <code>temp_ht</code> \u653e\u5230 32 \u4e2a\u5206\u5e93\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e0a\u3002**\u8fd9\u65f6\u7684\u67e5\u8be2\u903b\u8f91\u4e0e\u56fe 3 \u7c7b\u4f3c\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u518d\u601d\u8003\u4e00\u4e0b\u5177\u4f53\u7684\u6d41\u7a0b\u3002</p>\n<h3 id=\"_18\">\u4e34\u65f6\u8868\u548c\u4e3b\u5907\u590d\u5236<a class=\"headerlink\" href=\"#_18\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136\u5199 binlog\uff0c\u5c31\u610f\u5473\u7740\u5907\u5e93\u9700\u8981\u3002</p>\n<p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\uff0c\u5728\u4e3b\u5e93\u4e0a\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t_normal</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">)</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span><span class=\"cm\">/*Q1*/</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t_normal</span><span class=\"p\">;</span><span class=\"cm\">/*Q2*/</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span><span class=\"cm\">/*Q3*/</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t_normal</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">;</span><span class=\"cm\">/*Q4*/</span>\n</code></pre></div>\n<p>\u5982\u679c\u5173\u4e8e\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u90fd\u4e0d\u8bb0\u5f55\uff0c\u90a3\u4e48\u5728\u5907\u5e93\u5c31\u53ea\u6709 <code>create table t_normal</code> \u8868\u548c <code>insert into t_normal select * from temp_t</code> \u8fd9\u4e24\u4e2a\u8bed\u53e5\u7684 binlog \u65e5\u5fd7\uff0c\u5907\u5e93\u5728\u6267\u884c\u5230 <code>insert into t_normal</code> \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u62a5\u9519 <code>\u8868 temp_t \u4e0d\u5b58\u5728</code></p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u628a binlog \u8bbe\u7f6e\u4e3a row \u683c\u5f0f\u5c31\u597d\u4e86\u5427\uff1f\u56e0\u4e3a binlog \u662f row \u683c\u5f0f\u65f6\uff0c\u5728\u8bb0\u5f55 <code>insert into t_normal</code> \u7684 binlog \u65f6\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u64cd\u4f5c\u7684\u6570\u636e\uff0c\u5373\uff1a<code>write_row</code> event \u91cc\u9762\u8bb0\u5f55\u7684\u903b\u8f91\u662f\u201c\u63d2\u5165\u4e00\u884c\u6570\u636e\uff081,1)\u201d\u3002</p>\n<p>\u786e\u5b9e\u662f\u8fd9\u6837\u3002\u5982\u679c\u5f53\u524d\u7684 <code>binlog_format=row</code>\uff0c\u90a3\u4e48\u8ddf\u4e34\u65f6\u8868\u6709\u5173\u7684\u8bed\u53e5\uff0c\u5c31\u4e0d\u4f1a\u8bb0\u5f55\u5230 binlog \u91cc\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ea\u5728 b<code>inlog_format=statment/mixed</code> \u7684\u65f6\u5019\uff0cbinlog \u4e2d\u624d\u4f1a\u8bb0\u5f55\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u3002</p>\n<p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u521b\u5efa\u4e34\u65f6\u8868\u7684\u8bed\u53e5\u4f1a\u4f20\u5230\u5907\u5e93\u6267\u884c\uff0c\u56e0\u6b64\u5907\u5e93\u7684\u540c\u6b65\u7ebf\u7a0b\u5c31\u4f1a\u521b\u5efa\u8fd9\u4e2a\u4e34\u65f6\u8868\u3002\u4e3b\u5e93\u5728\u7ebf\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u5220\u9664\u4e34\u65f6\u8868\uff0c\u4f46\u662f\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u662f\u6301\u7eed\u5728\u8fd0\u884c\u7684\u3002\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5728\u4e3b\u5e93\u4e0a\u518d\u5199\u4e00\u4e2a DROP TEMPORARY TABLE \u4f20\u7ed9\u5907\u5e93\u6267\u884c\u3002</p>\n<p>**\u4e4b\u524d\u6709\u4eba\u95ee\u8fc7\u6211\u4e00\u4e2a\u6709\u8da3\u7684\u95ee\u9898\uff1a**MySQL \u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4e0d\u8bba\u662f create table \u8fd8\u662f alter table \u8bed\u53e5\uff0c\u90fd\u662f\u539f\u6837\u8bb0\u5f55\uff0c\u751a\u81f3\u4e8e\u8fde\u7a7a\u683c\u90fd\u4e0d\u53d8\u3002\u4f46\u662f\u5982\u679c\u6267\u884c <code>drop table t_normal</code>\uff0c\u7cfb\u7edf\u8bb0\u5f55 binlog \u5c31\u4f1a\u5199\u6210\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t_normal</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"cm\">/* generated by server */</span>\n</code></pre></div>\n<p>\u4e5f\u5c31\u662f\u6539\u6210\u4e86\u6807\u51c6\u7684\u683c\u5f0f\u3002\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u505a\u5462 \uff1f</p>\n<p>\u73b0\u5728\u4f60\u77e5\u9053\u539f\u56e0\u4e86\uff0c\u90a3\u5c31\u662f\uff1adrop table \u547d\u4ee4\u662f\u53ef\u4ee5\u4e00\u6b21\u5220\u9664\u591a\u4e2a\u8868\u7684\u3002\u6bd4\u5982\uff0c\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u8bbe\u7f6e <code>binlog_format=row</code>\uff0c\u5982\u679c\u4e3b\u5e93\u4e0a\u6267\u884c  <code>drop table t_normal, temp_t</code>\u8fd9\u4e2a\u547d\u4ee4\uff0c\u90a3\u4e48 binlog \u4e2d\u5c31\u53ea\u80fd\u8bb0\u5f55\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">DROP</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t_normal</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"cm\">/* generated by server */</span>\n</code></pre></div>\n<p>\u56e0\u4e3a\u5907\u5e93\u4e0a\u5e76\u6ca1\u6709\u8868 temp_t\uff0c\u5c06\u8fd9\u4e2a\u547d\u4ee4\u91cd\u5199\u540e\u518d\u4f20\u5230\u5907\u5e93\u6267\u884c\uff0c\u624d\u4e0d\u4f1a\u5bfc\u81f4\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\u3002</p>\n<p>\u6240\u4ee5\uff0cdrop table \u547d\u4ee4\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u5bf9\u8bed\u53e5\u505a\u6539\u5199\u3002 <code>/* generated by server */</code>\u660e\u4e86\u8fd9\u662f\u4e00\u4e2a\u88ab\u670d\u52a1\u7aef\u6539\u5199\u8fc7\u7684\u547d\u4ee4\u3002</p>\n<p>\u8bf4\u5230\u4e3b\u5907\u590d\u5236\uff0c<strong>\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3</strong>\uff1a\u4e3b\u5e93\u4e0a\u4e0d\u540c\u7684\u7ebf\u7a0b\u521b\u5efa\u540c\u540d\u7684\u4e34\u65f6\u8868\u662f\u6ca1\u5173\u7cfb\u7684\uff0c\u4f46\u662f\u4f20\u5230\u5907\u5e93\u6267\u884c\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f</p>\n<p>\u4e3b\u5e93 M \u4e0a\u7684\u4e24\u4e2a session \u521b\u5efa\u4e86\u540c\u540d\u7684\u4e34\u65f6\u8868 t1\uff0c\u8fd9\u4e24\u4e2a <code>create temporary table t1</code> \u8bed\u53e5\u90fd\u4f1a\u88ab\u4f20\u5230\u5907\u5e93 S \u4e0a\u3002</p>\n<p>\u4f46\u662f\uff0c\u5907\u5e93\u7684\u5e94\u7528\u65e5\u5fd7\u7ebf\u7a0b\u662f\u5171\u7528\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u8981\u5728\u5e94\u7528\u7ebf\u7a0b\u91cc\u9762\u5148\u540e\u6267\u884c\u8fd9\u4e2a create \u8bed\u53e5\u4e24\u6b21\u3002\uff08\u5373\u4f7f\u5f00\u4e86\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u4e5f\u53ef\u80fd\u88ab\u5206\u914d\u5230\u4ece\u5e93\u7684\u540c\u4e00\u4e2a worker \u4e2d\u6267\u884c\uff09\u3002\u90a3\u4e48\uff0c\u8fd9\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u540c\u6b65\u7ebf\u7a0b\u62a5\u9519 \uff1f</p>\n<p>\u663e\u7136\u662f\u4e0d\u4f1a\u7684\uff0c\u5426\u5219\u4e34\u65f6\u8868\u5c31\u662f\u4e00\u4e2a bug \u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5907\u5e93\u7ebf\u7a0b\u5728\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u628a\u8fd9\u4e24\u4e2a t1 \u8868\u5f53\u505a\u4e24\u4e2a\u4e0d\u540c\u7684\u4e34\u65f6\u8868\u6765\u5904\u7406\u3002\u8fd9\uff0c\u53c8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f</p>\n<p>MySQL \u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4f1a\u628a\u4e3b\u5e93\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u7684\u7ebf\u7a0b id \u5199\u5230 binlog \u4e2d\u3002\u8fd9\u6837\uff0c\u5728\u5907\u5e93\u7684\u5e94\u7528\u7ebf\u7a0b\u5c31\u80fd\u591f\u77e5\u9053\u6267\u884c\u6bcf\u4e2a\u8bed\u53e5\u7684\u4e3b\u5e93\u7ebf\u7a0b id\uff0c\u5e76\u5229\u7528\u8fd9\u4e2a\u7ebf\u7a0b id \u6765\u6784\u9020\u4e34\u65f6\u8868\u7684 table_def_key\uff1a</p>\n<ol>\n<li>session A \u7684\u4e34\u65f6\u8868 t1\uff0c\u5728\u5907\u5e93\u7684 <code>table_def_key</code> \u5c31\u662f\uff1a\u5e93\u540d +t1+\u201cM \u7684 serverid\u201d+\u201csession A \u7684 thread_id\u201d;</li>\n<li>session B \u7684\u4e34\u65f6\u8868 t1\uff0c\u5728\u5907\u5e93\u7684 <code>table_def_key</code> \u5c31\u662f \uff1a\u5e93\u540d +t1+\u201cM \u7684 serverid\u201d+\u201csession B \u7684 thread_id\u201d\u3002</li>\n</ol>\n<p>\u7531\u4e8e <code>table_def_key</code> \u4e0d\u540c\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a\u8868\u5728\u5907\u5e93\u7684\u5e94\u7528\u7ebf\u7a0b\u91cc\u9762\u662f\u4e0d\u4f1a\u51b2\u7a81\u7684\u3002</p>\n<h3 id=\"_19\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_19\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e34\u65f6\u8868\u7684\u7528\u6cd5\u548c\u7279\u6027\u3002</p>\n<p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u4e34\u65f6\u8868\u4e00\u822c\u7528\u4e8e\u5904\u7406\u6bd4\u8f83\u590d\u6742\u7684\u8ba1\u7b97\u903b\u8f91\u3002\u7531\u4e8e\u4e34\u65f6\u8868\u662f\u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u53ef\u89c1\u7684\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u8003\u8651\u591a\u4e2a\u7ebf\u7a0b\u6267\u884c\u540c\u4e00\u4e2a\u5904\u7406\u903b\u8f91\u65f6\uff0c\u4e34\u65f6\u8868\u7684\u91cd\u540d\u95ee\u9898\u3002\u5728\u7ebf\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u8868\u4e5f\u80fd\u81ea\u52a8\u5220\u9664\uff0c\u7701\u53bb\u4e86\u6536\u5c3e\u548c\u5f02\u5e38\u5904\u7406\u7684\u5de5\u4f5c\u3002</p>\n<p>\u5728 <code>binlog_format='row'</code>\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u4e0d\u8bb0\u5f55\u5230 binlog \u4e2d\uff0c\u4e5f\u7701\u53bb\u4e86\u4e0d\u5c11\u9ebb\u70e6\uff0c\u8fd9\u4e5f\u53ef\u4ee5\u6210\u4e3a\u4f60\u9009\u62e9 <code>binlog_format</code> \u65f6\u7684\u4e00\u4e2a\u8003\u8651\u56e0\u7d20\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u8fd9\u79cd\u4e34\u65f6\u8868\uff0c\u662f\u7528\u6237\u81ea\u5df1\u521b\u5efa\u7684 \uff0c\u4e5f\u53ef\u4ee5\u79f0\u4e3a\u7528\u6237\u4e34\u65f6\u8868\u3002\u4e0e\u5b83\u76f8\u5bf9\u5e94\u7684\uff0c\u5c31\u662f\u5185\u90e8\u4e34\u65f6\u8868\u3002</p>\n<h2 id=\"37\">37 \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\uff1f<a class=\"headerlink\" href=\"#37\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4f60\u53ef\u80fd\u4f1a\u6709\u8fd9\u6837\u7684\u7591\u95ee\uff0cMySQL \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\u5462\uff1f</p>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u5148\u7ed9\u4f60\u4e3e\u4e24\u4e2a\u9700\u8981\u7528\u5230\u5185\u90e8\u4e34\u65f6\u8868\u7684\u4f8b\u5b50\uff0c\u6765\u770b\u770b\u5185\u90e8\u4e34\u65f6\u8868\u662f\u600e\u4e48\u5de5\u4f5c\u7684\u3002\u7136\u540e\uff0c\u6211\u4eec\u518d\u6765\u5206\u6790\uff0c\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\u3002</p>\n<h3 id=\"union\">union \u6267\u884c\u6d41\u7a0b<a class=\"headerlink\" href=\"#union\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\uff0c\u6211\u7528\u4e0b\u9762\u7684\u8868 t1 \u6765\u4e3e\u4f8b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">));</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"w\">  </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u6211\u4eec\u6267\u884c\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u8bed\u53e5\u7528\u5230\u4e86 union\uff0c\u5b83\u7684\u8bed\u4e49\u662f\uff0c\u53d6\u8fd9\u4e24\u4e2a\u5b50\u67e5\u8be2\u7ed3\u679c\u7684\u5e76\u96c6\u3002\u5e76\u96c6\u7684\u610f\u601d\u5c31\u662f\u8fd9\u4e24\u4e2a\u96c6\u5408\u52a0\u8d77\u6765\uff0c\u91cd\u590d\u7684\u884c\u53ea\u4fdd\u7559\u4e00\u884c\u3002</p>\n<p>\u4e0b\u56fe\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"o\">+</span><span class=\"c1\">----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                            </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">No</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\">                   </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UNION</span><span class=\"w\">        </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">         </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Backward</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">scan</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UNION</span><span class=\"w\"> </span><span class=\"k\">RESULT</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">union1</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\">                  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ul>\n<li>\u7b2c\u4e8c\u884c\u7684 key=PRIMARY\uff0c\u8bf4\u660e\u7b2c\u4e8c\u4e2a\u5b50\u53e5\u7528\u5230\u4e86\u7d22\u5f15 id\u3002</li>\n<li>\u7b2c\u4e09\u884c\u7684 Extra \u5b57\u6bb5\uff0c\u8868\u793a\u5728\u5bf9\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u96c6\u505a union \u7684\u65f6\u5019\uff0c\u4f7f\u7528\u4e86\u4e34\u65f6\u8868 (Using temporary)\u3002</li>\n</ul>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u521b\u5efa\u4e00\u4e2a\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u8fd9\u4e2a\u4e34\u65f6\u8868\u53ea\u6709\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5 f\uff0c\u5e76\u4e14 f \u662f\u4e3b\u952e\u5b57\u6bb5\u3002</li>\n<li>\u6267\u884c\u7b2c\u4e00\u4e2a\u5b50\u67e5\u8be2\uff0c\u5f97\u5230 1000 \u8fd9\u4e2a\u503c\uff0c\u5e76\u5b58\u5165\u4e34\u65f6\u8868\u4e2d\u3002</li>\n<li>\u6267\u884c\u7b2c\u4e8c\u4e2a\u5b50\u67e5\u8be2\uff1a </li>\n<li>\u62ff\u5230\u7b2c\u4e00\u884c id=1000\uff0c\u8bd5\u56fe\u63d2\u5165\u4e34\u65f6\u8868\u4e2d\u3002\u4f46\u7531\u4e8e 1000 \u8fd9\u4e2a\u503c\u5df2\u7ecf\u5b58\u5728\u4e8e\u4e34\u65f6\u8868\u4e86\uff0c\u8fdd\u53cd\u4e86\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u6240\u4ee5\u63d2\u5165\u5931\u8d25\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c\uff1b</li>\n<li>\u53d6\u5230\u7b2c\u4e8c\u884c id=999\uff0c\u63d2\u5165\u4e34\u65f6\u8868\u6210\u529f\u3002</li>\n<li>\u4ece\u4e34\u65f6\u8868\u4e2d\u6309\u884c\u53d6\u51fa\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\uff0c\u5e76\u5220\u9664\u4e34\u65f6\u8868\uff0c\u7ed3\u679c\u4e2d\u5305\u542b\u4e24\u884c\u6570\u636e\u5206\u522b\u662f 1000 \u548c 999\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u7684\u5185\u5b58\u4e34\u65f6\u8868\u8d77\u5230\u4e86\u6682\u5b58\u6570\u636e\u7684\u4f5c\u7528\uff0c\u800c\u4e14\u8ba1\u7b97\u8fc7\u7a0b\u8fd8\u7528\u4e0a\u4e86\u4e34\u65f6\u8868\u4e3b\u952e id \u7684\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u5b9e\u73b0\u4e86 union \u7684\u8bed\u4e49\u3002</p>\n<p>\u987a\u4fbf\u63d0\u4e00\u4e0b\uff0c\u5982\u679c\u628a\u4e0a\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e2d\u7684 union \u6539\u6210 union all \u7684\u8bdd\uff0c\u5c31\u6ca1\u6709\u4e86\u201c\u53bb\u91cd\u201d\u7684\u8bed\u4e49\u3002\u8fd9\u6837\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u4f9d\u6b21\u6267\u884c\u5b50\u67e5\u8be2\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u76f4\u63a5\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\uff0c\u53d1\u7ed9\u5ba2\u6237\u7aef\u3002\u56e0\u6b64\u4e5f\u5c31\u4e0d\u9700\u8981\u4e34\u65f6\u8868\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"k\">all</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                            </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">No</span><span class=\"w\"> </span><span class=\"n\">tables</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\">                   </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">UNION</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Backward</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">scan</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7b2c\u4e8c\u884c\u7684 Extra \u5b57\u6bb5\u663e\u793a\u7684\u662f Using index\uff0c\u8868\u793a\u53ea\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u6ca1\u6709\u7528\u4e34\u65f6\u8868\u4e86\u3002</p>\n<h3 id=\"group-by\">group by \u6267\u884c\u6d41\u7a0b<a class=\"headerlink\" href=\"#group-by\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53e6\u5916\u4e00\u4e2a\u5e38\u89c1\u7684\u4f7f\u7528\u4e34\u65f6\u8868\u7684\u4f8b\u5b50\u662f group by\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8bed\u53e5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u903b\u8f91\u662f\u628a\u8868 t1 \u91cc\u7684\u6570\u636e\uff0c\u6309\u7167 id%10 \u8fdb\u884c\u5206\u7ec4\u7edf\u8ba1\uff0c\u5e76\u6309\u7167 m \u7684\u7ed3\u679c\u6392\u5e8f\u540e\u8f93\u51fa\u3002\u5b83\u7684 explain \u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                        </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"p\">,</span><span class=\"n\">a</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+</span>\n</code></pre></div>\n<p>\u5728 Extra \u5b57\u6bb5\u91cc\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Using index\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u9009\u62e9\u4e86\u7d22\u5f15 a\uff0c\u4e0d\u9700\u8981\u56de\u8868\uff1b</li>\n<li>Using temporary\uff0c\u8868\u793a\u4f7f\u7528\u4e86\u4e34\u65f6\u8868\uff1b</li>\n<li>Using filesort\uff0c\u8868\u793a\u9700\u8981\u6392\u5e8f\u3002</li>\n</ul>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u521b\u5efa\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5 m \u548c c\uff0c\u4e3b\u952e\u662f m\uff1b</li>\n<li>\u626b\u63cf\u8868 t1 \u7684\u7d22\u5f15 a\uff0c\u4f9d\u6b21\u53d6\u51fa\u53f6\u5b50\u8282\u70b9\u4e0a\u7684 id \u503c\uff0c\u8ba1\u7b97 id%10 \u7684\u7ed3\u679c\uff0c\u8bb0\u4e3a x\uff1b </li>\n<li>\u5982\u679c\u4e34\u65f6\u8868\u4e2d\u6ca1\u6709\u4e3b\u952e\u4e3a x \u7684\u884c\uff0c\u5c31\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55 (x,1);</li>\n<li>\u5982\u679c\u8868\u4e2d\u6709\u4e3b\u952e\u4e3a x \u7684\u884c\uff0c\u5c31\u5c06 x \u8fd9\u4e00\u884c\u7684 c \u503c\u52a0 1\uff1b</li>\n<li>\u904d\u5386\u5b8c\u6210\u540e\uff0c\u518d\u6839\u636e\u5b57\u6bb5 m \u505a\u6392\u5e8f\uff0c\u5f97\u5230\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\">  </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">------+-----+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------+-----+</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------+-----+</span>\n</code></pre></div>\n<p>\u5982\u679c\u4f60\u7684\u9700\u6c42\u5e76\u4e0d\u9700\u8981\u5bf9\u7ed3\u679c\u8fdb\u884c\u6392\u5e8f\uff0c\u90a3\u4f60\u53ef\u4ee5\u5728 SQL \u8bed\u53e5\u672b\u5c3e\u589e\u52a0 order by null\uff0c\u4e5f\u5c31\u662f\u6539\u6210\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6837\u5c31\u8df3\u8fc7\u4e86\u6700\u540e\u6392\u5e8f\u7684\u9636\u6bb5\uff0c\u76f4\u63a5\u4ece\u4e34\u65f6\u8868\u4e2d\u53d6\u6570\u636e\u8fd4\u56de\u3002</p>\n<p>\u7531\u4e8e\u8868 t1 \u4e2d\u7684 id \u503c\u662f\u4ece 1 \u5f00\u59cb\u7684\uff0c\u56e0\u6b64\u8fd4\u56de\u7684\u7ed3\u679c\u96c6\u4e2d\u7b2c\u4e00\u884c\u662f id=1\uff1b\u626b\u63cf\u5230 id=10 \u7684\u65f6\u5019\u624d\u63d2\u5165 m=0 \u8fd9\u4e00\u884c\uff0c\u56e0\u6b64\u7ed3\u679c\u96c6\u91cc\u6700\u540e\u4e00\u884c\u624d\u662f m=0\u3002</p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u7531\u4e8e\u4e34\u65f6\u8868\u53ea\u6709 10 \u884c\uff0c\u5185\u5b58\u53ef\u4ee5\u653e\u5f97\u4e0b\uff0c\u56e0\u6b64\u5168\u7a0b\u53ea\u4f7f\u7528\u4e86\u5185\u5b58\u4e34\u65f6\u8868\u3002\u4f46\u662f\uff0c\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\u662f\u6709\u9650\u5236\u7684\uff0c\u53c2\u6570 <code>tmp_table_size</code> \u5c31\u662f\u63a7\u5236\u8fd9\u4e2a\u5185\u5b58\u5927\u5c0f\u7684\uff0c\u9ed8\u8ba4\u662f 16M\u3002</p>\n<p>\u5982\u679c\u6211\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">tmp_table_size</span><span class=\"o\">=</span><span class=\"mi\">1024</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u628a\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\u9650\u5236\u4e3a\u6700\u5927 1024 \u5b57\u8282\uff0c\u5e76\u628a\u8bed\u53e5\u6539\u6210 id % 100\uff0c\u8fd9\u6837\u8fd4\u56de\u7ed3\u679c\u91cc\u6709 100 \u884c\u6570\u636e\u3002\u4f46\u662f\uff0c\u8fd9\u65f6\u7684\u5185\u5b58\u4e34\u65f6\u8868\u5927\u5c0f\u4e0d\u591f\u5b58\u4e0b\u8fd9 100 \u884c\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u53d1\u73b0\u5185\u5b58\u4e34\u65f6\u8868\u5927\u5c0f\u5230\u8fbe\u4e86\u4e0a\u9650\uff081024 \u5b57\u8282\uff09\u3002</p>\n<p>\u5982\u679c\u8fd9\u4e2a\u8868 t1 \u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u5f88\u53ef\u80fd\u8fd9\u4e2a\u67e5\u8be2\u9700\u8981\u7684\u78c1\u76d8\u4e34\u65f6\u8868\u5c31\u4f1a\u5360\u7528\u5927\u91cf\u7684\u78c1\u76d8\u7a7a\u95f4\u3002</p>\n<h3 id=\"group-by-\">group by \u4f18\u5316\u65b9\u6cd5 -- \u7d22\u5f15<a class=\"headerlink\" href=\"#group-by-\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u8bba\u662f\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u8fd8\u662f\u78c1\u76d8\u4e34\u65f6\u8868\uff0cgroup by \u903b\u8f91\u90fd\u9700\u8981\u6784\u9020\u4e00\u4e2a\u5e26\u552f\u4e00\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u4ee3\u4ef7\u90fd\u662f\u6bd4\u8f83\u9ad8\u7684\u3002\u5982\u679c\u8868\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u4e0a\u9762\u8fd9\u4e2a group by \u8bed\u53e5\u6267\u884c\u8d77\u6765\u5c31\u4f1a\u5f88\u6162\uff0c\u6211\u4eec\u6709\u4ec0\u4e48\u4f18\u5316\u7684\u65b9\u6cd5\u5462\uff1f</p>\n<p>\u8981\u89e3\u51b3 group by \u8bed\u53e5\u7684\u4f18\u5316\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u5148\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a\u6267\u884c group by \u8bed\u53e5\u4e3a\u4ec0\u4e48\u9700\u8981\u4e34\u65f6\u8868\uff1f</p>\n<p>group by \u7684\u8bed\u4e49\u903b\u8f91\uff0c\u662f\u7edf\u8ba1\u4e0d\u540c\u7684\u503c\u51fa\u73b0\u7684\u4e2a\u6570\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6bcf\u4e00\u884c\u7684 id%100 \u7684\u7ed3\u679c\u662f\u65e0\u5e8f\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u4e34\u65f6\u8868\uff0c\u6765\u8bb0\u5f55\u5e76\u7edf\u8ba1\u7ed3\u679c\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u626b\u63cf\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u4fdd\u8bc1\u51fa\u73b0\u7684\u6570\u636e\u662f\u6709\u5e8f\u7684\uff0c\u662f\u4e0d\u662f\u5c31\u7b80\u5355\u4e86\u5462\uff1f</p>\n<p>\u5982\u679c\u53ef\u4ee5\u786e\u4fdd\u8f93\u5165\u7684\u6570\u636e\u662f\u6709\u5e8f\u7684\uff0c\u90a3\u4e48\u8ba1\u7b97 group by \u7684\u65f6\u5019\uff0c\u5c31\u53ea\u9700\u8981\u4ece\u5de6\u5230\u53f3\uff0c\u987a\u5e8f\u626b\u63cf\uff0c\u4f9d\u6b21\u7d2f\u52a0\u3002\u4e5f\u5c31\u662f\u4e0b\u9762\u8fd9\u4e2a\u8fc7\u7a0b\uff1a</p>\n<ul>\n<li>\u5f53\u78b0\u5230\u7b2c\u4e00\u4e2a 1 \u7684\u65f6\u5019\uff0c\u5df2\u7ecf\u77e5\u9053\u7d2f\u79ef\u4e86 X \u4e2a 0\uff0c\u7ed3\u679c\u96c6\u91cc\u7684\u7b2c\u4e00\u884c\u5c31\u662f (0,X);</li>\n<li>\u5f53\u78b0\u5230\u7b2c\u4e00\u4e2a 2 \u7684\u65f6\u5019\uff0c\u5df2\u7ecf\u77e5\u9053\u7d2f\u79ef\u4e86 Y \u4e2a 1\uff0c\u7ed3\u679c\u96c6\u91cc\u7684\u7b2c\u4e8c\u884c\u5c31\u662f (1,Y);</li>\n</ul>\n<p>\u6309\u7167\u8fd9\u4e2a\u903b\u8f91\u6267\u884c\u7684\u8bdd\uff0c\u626b\u63cf\u5230\u6574\u4e2a\u8f93\u5165\u7684\u6570\u636e\u7ed3\u675f\uff0c\u5c31\u53ef\u4ee5\u62ff\u5230 group by \u7684\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u518d\u989d\u5916\u6392\u5e8f\u3002</p>\n<p>\u4f60\u4e00\u5b9a\u60f3\u5230\u4e86\uff0cInnoDB \u7684\u7d22\u5f15\uff0c\u5c31\u53ef\u4ee5\u6ee1\u8db3\u8fd9\u4e2a\u8f93\u5165\u6709\u5e8f\u7684\u6761\u4ef6\u3002</p>\n<p>\u5728 MySQL 5.7 \u7248\u672c\u652f\u6301\u4e86 generated column \u673a\u5236\uff0c\u7528\u6765\u5b9e\u73b0\u5217\u6570\u636e\u7684\u5173\u8054\u66f4\u65b0\u3002\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2a\u5217 z\uff0c\u7136\u540e\u5728 z \u5217\u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff08\u5982\u679c\u662f MySQL 5.6 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u666e\u901a\u5217\u548c\u7d22\u5f15\uff0c\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">column</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">generated</span><span class=\"w\"> </span><span class=\"n\">always</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">z</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u6837\uff0c\u7d22\u5f15 z \u4e0a\u7684\u6570\u636e\u5c31\u662f\u7c7b\u4f3c\u56fe 10 \u8fd9\u6837\u6709\u5e8f\u7684\u4e86\u3002\u4e0a\u9762\u7684 group by \u8bed\u53e5\u5c31\u53ef\u4ee5\u6539\u6210\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u4f18\u5316\u540e\u7684 group by \u8bed\u53e5\u7684 explain \u7ed3\u679c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span>\n</code></pre></div>\n<p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u4e0d\u518d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u6392\u5e8f\u4e86\u3002</p>\n<h3 id=\"group-by-_1\">group by \u4f18\u5316\u65b9\u6cd5 -- \u76f4\u63a5\u6392\u5e8f<a class=\"headerlink\" href=\"#group-by-_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u53ef\u4ee5\u901a\u8fc7\u52a0\u7d22\u5f15\u6765\u5b8c\u6210 group by \u903b\u8f91\u5c31\u518d\u597d\u4e0d\u8fc7\u4e86\u3002\u4f46\u662f\uff0c\u5982\u679c\u78b0\u4e0a\u4e0d\u9002\u5408\u521b\u5efa\u7d22\u5f15\u7684\u573a\u666f\uff0c\u6211\u4eec\u8fd8\u662f\u8981\u8001\u8001\u5b9e\u5b9e\u505a\u6392\u5e8f\u7684\u3002\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7684 group by \u8981\u600e\u4e48\u4f18\u5316\u5462\uff1f</p>\n<p>\u5982\u679c\u6211\u4eec\u660e\u660e\u77e5\u9053\uff0c\u4e00\u4e2a group by \u8bed\u53e5\u4e2d\u9700\u8981\u653e\u5230\u4e34\u65f6\u8868\u4e0a\u7684\u6570\u636e\u91cf\u7279\u522b\u5927\uff0c\u5374\u8fd8\u662f\u8981\u6309\u7167\u201c\u5148\u653e\u5230\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u63d2\u5165\u4e00\u90e8\u5206\u6570\u636e\u540e\uff0c\u53d1\u73b0\u5185\u5b58\u4e34\u65f6\u8868\u4e0d\u591f\u7528\u4e86\u518d\u8f6c\u6210\u78c1\u76d8\u4e34\u65f6\u8868\u201d\uff0c\u770b\u4e0a\u53bb\u5c31\u6709\u70b9\u513f\u50bb\u3002</p>\n<p>\u90a3\u4e48\uff0c\u6211\u4eec\u5c31\u4f1a\u60f3\u4e86\uff0cMySQL \u6709\u6ca1\u6709\u8ba9\u6211\u4eec\u76f4\u63a5\u8d70\u78c1\u76d8\u4e34\u65f6\u8868\u7684\u65b9\u6cd5\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p>\n<p>\u5728 group by \u8bed\u53e5\u4e2d\u52a0\u5165 <code>SQL_BIG_RESULT</code> \u8fd9\u4e2a\u63d0\u793a\uff08hint\uff09\uff0c\u5c31\u53ef\u4ee5\u544a\u8bc9\u4f18\u5316\u5668\uff1a\u8fd9\u4e2a\u8bed\u53e5\u6d89\u53ca\u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u8bf7\u76f4\u63a5\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u3002</p>\n<p>MySQL \u7684\u4f18\u5316\u5668\u4e00\u770b\uff0c\u78c1\u76d8\u4e34\u65f6\u8868\u662f B+ \u6811\u5b58\u50a8\uff0c\u5b58\u50a8\u6548\u7387\u4e0d\u5982\u6570\u7ec4\u6765\u5f97\u9ad8\u3002\u6240\u4ee5\uff0c\u65e2\u7136\u4f60\u544a\u8bc9\u6211\u6570\u636e\u91cf\u5f88\u5927\uff0c\u90a3\u4ece\u78c1\u76d8\u7a7a\u95f4\u8003\u8651\uff0c\u8fd8\u662f\u76f4\u63a5\u7528\u6570\u7ec4\u6765\u5b58\u5427\u3002</p>\n<p>\u56e0\u6b64\uff0c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">SQL_BIG_RESULT</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316 sort_buffer\uff0c\u786e\u5b9a\u653e\u5165\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5\uff0c\u8bb0\u4e3a m\uff1b</li>\n<li>\u626b\u63cf\u8868 t1 \u7684\u7d22\u5f15 a\uff0c\u4f9d\u6b21\u53d6\u51fa\u91cc\u9762\u7684 id \u503c, \u5c06 id%100 \u7684\u503c\u5b58\u5165 sort_buffer \u4e2d\uff1b</li>\n<li>\u626b\u63cf\u5b8c\u6210\u540e\uff0c\u5bf9 sort_buffer \u7684\u5b57\u6bb5 m \u505a\u6392\u5e8f\uff08\u5982\u679c sort_buffer \u5185\u5b58\u4e0d\u591f\u7528\uff0c\u5c31\u4f1a\u5229\u7528\u78c1\u76d8\u4e34\u65f6\u6587\u4ef6\u8f85\u52a9\u6392\u5e8f\uff09\uff1b</li>\n<li>\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a\u6709\u5e8f\u6570\u7ec4\u3002</li>\n</ol>\n<p>\u6839\u636e\u6709\u5e8f\u6570\u7ec4\uff0c\u5f97\u5230\u6570\u7ec4\u91cc\u9762\u7684\u4e0d\u540c\u503c\uff0c\u4ee5\u53ca\u6bcf\u4e2a\u503c\u7684\u51fa\u73b0\u6b21\u6570\u3002</p>\n<p>\u56fe\u4f7f\u7528 SQL_BIG_RESULT \u7684 explain \u7ed3\u679c</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">SQL_BIG_RESULT</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">%</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">count</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">group</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                       </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"n\">filesort</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n</code></pre></div>\n<p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6ca1\u6709\u518d\u4f7f\u7528\u4e34\u65f6\u8868\uff0c\u800c\u662f\u76f4\u63a5\u7528\u4e86\u6392\u5e8f\u7b97\u6cd5\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684 union\u3001union all \u548c group by \u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u56de\u7b54\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff1aMySQL \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\uff1f</p>\n<ol>\n<li>\u5982\u679c\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u53ef\u4ee5\u4e00\u8fb9\u8bfb\u6570\u636e\uff0c\u4e00\u8fb9\u76f4\u63a5\u5f97\u5230\u7ed3\u679c\uff0c\u662f\u4e0d\u9700\u8981\u989d\u5916\u5185\u5b58\u7684\uff0c\u5426\u5219\u5c31\u9700\u8981\u989d\u5916\u7684\u5185\u5b58\uff0c\u6765\u4fdd\u5b58\u4e2d\u95f4\u7ed3\u679c\uff1b</li>\n<li>join_buffer \u662f\u65e0\u5e8f\u6570\u7ec4\uff0csort_buffer \u662f\u6709\u5e8f\u6570\u7ec4\uff0c\u4e34\u65f6\u8868\u662f\u4e8c\u7ef4\u8868\u7ed3\u6784\uff1b</li>\n<li>\u5982\u679c\u6267\u884c\u903b\u8f91\u9700\u8981\u7528\u5230\u4e8c\u7ef4\u8868\u7279\u6027\uff0c\u5c31\u4f1a\u4f18\u5148\u8003\u8651\u4f7f\u7528\u4e34\u65f6\u8868\u3002\u6bd4\u5982\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0cunion \u9700\u8981\u7528\u5230\u552f\u4e00\u7d22\u5f15\u7ea6\u675f\uff0c group by \u8fd8\u9700\u8981\u7528\u5230\u53e6\u5916\u4e00\u4e2a\u5b57\u6bb5\u6765\u5b58\u7d2f\u79ef\u8ba1\u6570\u3002</li>\n</ol>\n<h3 id=\"_20\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_20\" title=\"Permanent link\">&para;</a></h3>\n<p>\u901a\u8fc7\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u91cd\u70b9\u548c\u4f60\u8bb2\u4e86 group by \u7684\u51e0\u79cd\u5b9e\u73b0\u7b97\u6cd5\uff0c\u4ece\u4e2d\u53ef\u4ee5\u603b\u7ed3\u4e00\u4e9b\u4f7f\u7528\u7684\u6307\u5bfc\u539f\u5219\uff1a</p>\n<ol>\n<li>\u5982\u679c\u5bf9 group by \u8bed\u53e5\u7684\u7ed3\u679c\u6ca1\u6709\u6392\u5e8f\u8981\u6c42\uff0c\u8981\u5728\u8bed\u53e5\u540e\u9762\u52a0 order by null\uff1b</li>\n<li>\u5c3d\u91cf\u8ba9 group by \u8fc7\u7a0b\u7528\u4e0a\u8868\u7684\u7d22\u5f15\uff0c\u786e\u8ba4\u65b9\u6cd5\u662f explain \u7ed3\u679c\u91cc\u6ca1\u6709 Using temporary \u548c Using filesort\uff1b</li>\n<li>\u5982\u679c group by \u9700\u8981\u7edf\u8ba1\u7684\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u5c3d\u91cf\u53ea\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\uff1b\u4e5f\u53ef\u4ee5\u901a\u8fc7\u9002\u5f53\u8c03\u5927 <code>tmp_table_size</code> \u53c2\u6570\uff0c\u6765\u907f\u514d\u7528\u5230\u78c1\u76d8\u4e34\u65f6\u8868\uff1b</li>\n<li>\u5982\u679c\u6570\u636e\u91cf\u5b9e\u5728\u592a\u5927\uff0c\u4f7f\u7528 <code>SQL_BIG_RESULT</code> \u8fd9\u4e2a\u63d0\u793a\uff0c\u6765\u544a\u8bc9\u4f18\u5316\u5668\u76f4\u63a5\u4f7f\u7528\u6392\u5e8f\u7b97\u6cd5\u5f97\u5230 group by \u7684\u7ed3\u679c\u3002</li>\n</ol>\n<h2 id=\"38-innodbmemory\">38 \u90fd\u8bf4InnoDB\u597d\uff0c\u90a3\u8fd8\u8981\u4e0d\u8981\u4f7f\u7528Memory\u5f15\u64ce\uff1f<a class=\"headerlink\" href=\"#38-innodbmemory\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e24\u4e2a group by \u8bed\u53e5\u90fd\u7528\u4e86 order by null\uff0c\u4e3a\u4ec0\u4e48\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u5f97\u5230\u7684\u8bed\u53e5\u7ed3\u679c\u91cc\uff0c0 \u8fd9\u4e2a\u503c\u5728\u6700\u540e\u4e00\u884c\uff1b\u800c\u4f7f\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u5f97\u5230\u7684\u7ed3\u679c\u91cc\uff0c0 \u8fd9\u4e2a\u503c\u5728\u7b2c\u4e00\u884c\uff1f</p>\n<p>\u4eca\u5929\u6211\u4eec\u5c31\u6765\u770b\u770b\uff0c\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u7684\u539f\u56e0\u5427\u3002</p>\n<h3 id=\"_21\">\u5185\u5b58\u8868\u7684\u6570\u636e\u7ec4\u7ec7\u7ed3\u6784<a class=\"headerlink\" href=\"#_21\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u6765\u628a\u8fd9\u4e2a\u95ee\u9898\u7b80\u5316\u4e00\u4e0b\uff0c\u5047\u8bbe\u6709\u4ee5\u4e0b\u7684\u4e24\u5f20\u8868 t1 \u548c t2\uff0c\u5176\u4e2d\u8868 t1 \u4f7f\u7528 Memory \u5f15\u64ce\uff0c \u8868 t2 \u4f7f\u7528 InnoDB \u5f15\u64ce\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">Memory</span><span class=\"p\">;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">),(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">),(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">),(</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">),(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">),(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">),(</span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"p\">),(</span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"mi\">8</span><span class=\"p\">),(</span><span class=\"mi\">9</span><span class=\"p\">,</span><span class=\"mi\">9</span><span class=\"p\">),(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">),(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">),(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">),(</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">),(</span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"p\">),(</span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"mi\">6</span><span class=\"p\">),(</span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"p\">),(</span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"mi\">8</span><span class=\"p\">),(</span><span class=\"mi\">9</span><span class=\"p\">,</span><span class=\"mi\">9</span><span class=\"p\">),(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u7136\u540e\uff0c\u6211\u5206\u522b\u6267\u884c <code>select * from t1</code> \u548c <code>select * from t2\u3002</code></p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5185\u5b58\u8868 t1 \u7684\u8fd4\u56de\u7ed3\u679c\u91cc\u9762 0 \u5728\u6700\u540e\u4e00\u884c\uff0c\u800c InnoDB \u8868 t2 \u7684\u8fd4\u56de\u7ed3\u679c\u91cc 0 \u5728\u7b2c\u4e00\u884c\u3002</p>\n<p>\u51fa\u73b0\u8fd9\u4e2a\u533a\u522b\u7684\u539f\u56e0\uff0cInnoDB \u548c Memory \u5f15\u64ce\u7684\u6570\u636e\u7ec4\u7ec7\u65b9\u5f0f\u662f\u4e0d\u540c\u7684\uff1a</p>\n<ul>\n<li>InnoDB \u5f15\u64ce\u628a\u6570\u636e\u653e\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u5176\u4ed6\u7d22\u5f15\u4e0a\u4fdd\u5b58\u7684\u662f\u4e3b\u952e id\u3002\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a**\u7d22\u5f15\u7ec4\u7ec7\u8868**\uff08Index Organizied Table\uff09\u3002</li>\n<li>\u800c Memory \u5f15\u64ce\u91c7\u7528\u7684\u662f\u628a\u6570\u636e\u5355\u72ec\u5b58\u653e\uff0c\u7d22\u5f15\u4e0a\u4fdd\u5b58\u6570\u636e\u4f4d\u7f6e\u7684\u6570\u636e\u7ec4\u7ec7\u5f62\u5f0f\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a**\u5806\u7ec4\u7ec7\u8868**\uff08Heap Organizied Table\uff09\u3002</li>\n</ul>\n<p>\u4ece\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e24\u4e2a\u5f15\u64ce\u7684\u4e00\u4e9b\u5178\u578b\u4e0d\u540c\uff1a</p>\n<ol>\n<li>InnoDB \u8868\u7684\u6570\u636e\u603b\u662f\u6709\u5e8f\u5b58\u653e\u7684\uff0c\u800c\u5185\u5b58\u8868\u7684\u6570\u636e\u5c31\u662f\u6309\u7167\u5199\u5165\u987a\u5e8f\u5b58\u653e\u7684\uff1b</li>\n<li>\u5f53\u6570\u636e\u6587\u4ef6\u6709\u7a7a\u6d1e\u7684\u65f6\u5019\uff0cInnoDB \u8868\u5728\u63d2\u5165\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u6709\u5e8f\u6027\uff0c\u53ea\u80fd\u5728\u56fa\u5b9a\u7684\u4f4d\u7f6e\u5199\u5165\u65b0\u503c\uff0c\u800c\u5185\u5b58\u8868\u627e\u5230\u7a7a\u4f4d\u5c31\u53ef\u4ee5\u63d2\u5165\u65b0\u503c\uff1b</li>\n<li>\u6570\u636e\u4f4d\u7f6e\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0cInnoDB \u8868\u53ea\u9700\u8981\u4fee\u6539\u4e3b\u952e\u7d22\u5f15\uff0c\u800c\u5185\u5b58\u8868\u9700\u8981\u4fee\u6539\u6240\u6709\u7d22\u5f15\uff1b</li>\n<li>InnoDB \u8868\u7528\u4e3b\u952e\u7d22\u5f15\u67e5\u8be2\u65f6\u9700\u8981\u8d70\u4e00\u6b21\u7d22\u5f15\u67e5\u627e\uff0c\u7528\u666e\u901a\u7d22\u5f15\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u9700\u8981\u8d70\u4e24\u6b21\u7d22\u5f15\u67e5\u627e\u3002\u800c\u5185\u5b58\u8868\u6ca1\u6709\u8fd9\u4e2a\u533a\u522b\uff0c\u6240\u6709\u7d22\u5f15\u7684\u201c\u5730\u4f4d\u201d\u90fd\u662f\u76f8\u540c\u7684\u3002</li>\n<li>InnoDB \u652f\u6301\u53d8\u957f\u6570\u636e\u7c7b\u578b\uff0c\u4e0d\u540c\u8bb0\u5f55\u7684\u957f\u5ea6\u53ef\u80fd\u4e0d\u540c\uff1b\u5185\u5b58\u8868\u4e0d\u652f\u6301 Blob \u548c Text \u5b57\u6bb5\uff0c\u5e76\u4e14\u5373\u4f7f\u5b9a\u4e49\u4e86 varchar(N)\uff0c\u5b9e\u9645\u4e5f\u5f53\u4f5c char(N)\uff0c\u4e5f\u5c31\u662f\u56fa\u5b9a\u957f\u5ea6\u5b57\u7b26\u4e32\u6765\u5b58\u50a8\uff0c\u56e0\u6b64\u5185\u5b58\u8868\u7684\u6bcf\u884c\u6570\u636e\u957f\u5ea6\u76f8\u540c\u3002</li>\n</ol>\n<p>\u7531\u4e8e\u5185\u5b58\u8868\u7684\u8fd9\u4e9b\u7279\u6027\uff0c\u6bcf\u4e2a\u6570\u636e\u884c\u88ab\u5220\u9664\u4ee5\u540e\uff0c\u7a7a\u51fa\u7684\u8fd9\u4e2a\u4f4d\u7f6e\u90fd\u53ef\u4ee5\u88ab\u63a5\u4e0b\u6765\u8981\u63d2\u5165\u7684\u6570\u636e\u590d\u7528\u3002\u6bd4\u5982\uff0c\u5982\u679c\u8981\u5728\u8868 t1 \u4e2d\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span><span class=\"mi\">10</span><span class=\"p\">);</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u5c31\u4f1a\u770b\u5230\u8fd4\u56de\u7ed3\u679c\u91cc\uff0cid=10 \u8fd9\u4e00\u884c\u51fa\u73b0\u5728 id=4 \u4e4b\u540e\uff0c\u4e5f\u5c31\u662f\u539f\u6765 id=5 \u8fd9\u884c\u6570\u636e\u7684\u4f4d\u7f6e\u3002</p>\n<p>\u9700\u8981\u6307\u51fa\u7684\u662f\uff0c\u8868 t1 \u7684\u8fd9\u4e2a\u4e3b\u952e\u7d22\u5f15\u662f\u54c8\u5e0c\u7d22\u5f15\uff0c\u56e0\u6b64\u5982\u679c\u6267\u884c\u8303\u56f4\u67e5\u8be2\uff0c\u6bd4\u5982</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">&lt;</span><span class=\"mi\">5</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u662f\u7528\u4e0d\u4e0a\u4e3b\u952e\u7d22\u5f15\u7684\uff0c\u9700\u8981\u8d70\u5168\u8868\u626b\u63cf\u3002\u90a3\u5982\u679c\u8981\u8ba9\u5185\u5b58\u8868\u652f\u6301\u8303\u56f4\u626b\u63cf\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462 \uff1f</p>\n<h3 id=\"hash-b-tree\">hash \u7d22\u5f15\u548c B-Tree \u7d22\u5f15<a class=\"headerlink\" href=\"#hash-b-tree\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b9e\u9645\u4e0a\uff0c\u5185\u5b58\u8868\u4e5f\u662f\u652f B-Tree \u7d22\u5f15\u7684\u3002\u5728 id \u5217\u4e0a\u521b\u5efa\u4e00\u4e2a B-Tree \u7d22\u5f15\uff0cSQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">alter</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">add</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">a_btree_index</span><span class=\"w\"> </span><span class=\"k\">using</span><span class=\"w\"> </span><span class=\"n\">btree</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u4f5c\u4e3a\u5bf9\u6bd4\uff0c\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u8fd9\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\u4f7f\u7528 B-Tree \u548c hash \u7d22\u5f15\u67e5\u8be2\u8fd4\u56de\u7ed3\u679c\u5bf9\u6bd4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n</code></pre></div>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">primary</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u6267\u884c <code>select * from t1 where id&lt;5</code> \u7684\u65f6\u5019\uff0c\u4f18\u5316\u5668\u4f1a\u9009\u62e9 B-Tree \u7d22\u5f15\uff0c\u6240\u4ee5\u8fd4\u56de\u7ed3\u679c\u662f 0 \u5230 4\u3002 \u4f7f\u7528 force index \u5f3a\u884c\u4f7f\u7528\u4e3b\u952e id \u8fd9\u4e2a\u7d22\u5f15\uff0cid=0 \u8fd9\u4e00\u884c\u5c31\u5728\u7ed3\u679c\u96c6\u7684\u6700\u672b\u5c3e\u4e86\u3002</p>\n<p>\u5176\u5b9e\uff0c\u4e00\u822c\u5728\u6211\u4eec\u7684\u5370\u8c61\u4e2d\uff0c\u5185\u5b58\u8868\u7684\u4f18\u52bf\u662f\u901f\u5ea6\u5feb\uff0c\u5176\u4e2d\u7684\u4e00\u4e2a\u539f\u56e0\u5c31\u662f Memory \u5f15\u64ce\u652f\u6301 hash \u7d22\u5f15\u3002\u5f53\u7136\uff0c\u66f4\u91cd\u8981\u7684\u539f\u56e0\u662f\uff0c\u5185\u5b58\u8868\u7684\u6240\u6709\u6570\u636e\u90fd\u4fdd\u5b58\u5728\u5185\u5b58\uff0c\u800c\u5185\u5b58\u7684\u8bfb\u5199\u901f\u5ea6\u603b\u662f\u6bd4\u78c1\u76d8\u5feb\u3002</p>\n<p>\u4f46\u662f\uff0c\u63a5\u4e0b\u6765\u6211\u8981\u8ddf\u4f60\u8bf4\u660e\uff0c\u4e3a\u4ec0\u4e48\u6211\u4e0d\u5efa\u8bae\u4f60\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u4f7f\u7528\u5185\u5b58\u8868\u3002\u8fd9\u91cc\u7684\u539f\u56e0\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u65b9\u9762\uff1a</p>\n<ol>\n<li>\u9501\u7c92\u5ea6\u95ee\u9898\uff1b</li>\n<li>\u6570\u636e\u6301\u4e45\u5316\u95ee\u9898\u3002</li>\n</ol>\n<h3 id=\"_22\">\u5185\u5b58\u8868\u7684\u9501<a class=\"headerlink\" href=\"#_22\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u5148\u6765\u8bf4\u8bf4\u5185\u5b58\u8868\u7684\u9501\u7c92\u5ea6\u95ee\u9898\u3002</p>\n<p>\u5185\u5b58\u8868\u4e0d\u652f\u6301\u884c\u9501\uff0c\u53ea\u652f\u6301\u8868\u9501\u3002\u56e0\u6b64\uff0c\u4e00\u5f20\u8868\u53ea\u8981\u6709\u66f4\u65b0\uff0c\u5c31\u4f1a\u5835\u4f4f\u5176\u4ed6\u6240\u6709\u5728\u8fd9\u4e2a\u8868\u4e0a\u7684\u8bfb\u5199\u64cd\u4f5c\u3002</p>\n<p>\u8ddf\u884c\u9501\u6bd4\u8d77\u6765\uff0c\u8868\u9501\u5bf9\u5e76\u53d1\u8bbf\u95ee\u7684\u652f\u6301\u4e0d\u591f\u597d\u3002\u6240\u4ee5\uff0c\u5185\u5b58\u8868\u7684\u9501\u7c92\u5ea6\u95ee\u9898\uff0c\u51b3\u5b9a\u4e86\u5b83\u5728\u5904\u7406\u5e76\u53d1\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u6027\u80fd\u4e5f\u4e0d\u4f1a\u592a\u597d\u3002</p>\n<h3 id=\"_23\">\u6570\u636e\u6301\u4e45\u6027\u95ee\u9898<a class=\"headerlink\" href=\"#_23\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u6570\u636e\u6301\u4e45\u6027\u7684\u95ee\u9898\u3002</p>\n<p>\u6570\u636e\u653e\u5728\u5185\u5b58\u4e2d\uff0c\u662f\u5185\u5b58\u8868\u7684\u4f18\u52bf\uff0c\u4f46\u4e5f\u662f\u4e00\u4e2a\u52a3\u52bf\u3002\u56e0\u4e3a\uff0c\u6570\u636e\u5e93\u91cd\u542f\u7684\u65f6\u5019\uff0c\u6240\u6709\u7684\u5185\u5b58\u8868\u90fd\u4f1a\u88ab\u6e05\u7a7a\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u6570\u636e\u5e93\u5f02\u5e38\u91cd\u542f\uff0c\u5185\u5b58\u8868\u88ab\u6e05\u7a7a\u4e5f\u5c31\u6e05\u7a7a\u4e86\uff0c\u4e0d\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u554a\u3002\u4f46\u662f\uff0c\u5728\u9ad8\u53ef\u7528\u67b6\u6784\u4e0b\uff0c\u5185\u5b58\u8868\u7684\u8fd9\u4e2a\u7279\u70b9\u7b80\u76f4\u53ef\u4ee5\u5f53\u505a bug \u6765\u770b\u5f85\u4e86\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p>\n<p><strong>\u6211\u4eec\u5148\u770b\u770b M-S \u67b6\u6784\u4e0b\uff0c\u4f7f\u7528\u5185\u5b58\u8868\u5b58\u5728\u7684\u95ee\u9898\u3002</strong></p>\n<p>\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u65f6\u5e8f\uff1a</p>\n<ol>\n<li>\u4e1a\u52a1\u6b63\u5e38\u8bbf\u95ee\u4e3b\u5e93\uff1b</li>\n<li>\u5907\u5e93\u786c\u4ef6\u5347\u7ea7\uff0c\u5907\u5e93\u91cd\u542f\uff0c\u5185\u5b58\u8868 t1 \u5185\u5bb9\u88ab\u6e05\u7a7a\uff1b</li>\n<li>\u5907\u5e93\u91cd\u542f\u540e\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u4e00\u6761 update \u8bed\u53e5\uff0c\u4fee\u6539\u8868 t1 \u7684\u6570\u636e\u884c\uff0c\u8fd9\u65f6\u5907\u5e93\u5e94\u7528\u7ebf\u7a0b\u5c31\u4f1a\u62a5\u9519\u201c\u627e\u4e0d\u5230\u8981\u66f4\u65b0\u7684\u884c\u201d\u3002</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002\u5f53\u7136\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u53d1\u751f\u4e3b\u5907\u5207\u6362\u7684\u8bdd\uff0c\u5ba2\u6237\u7aef\u4f1a\u770b\u5230\uff0c\u8868 t1 \u7684\u6570\u636e\u201c\u4e22\u5931\u201d\u4e86\u3002</p>\n<p>\u5728\u56fe 8 \u4e2d\u8fd9\u79cd\u6709 proxy \u7684\u67b6\u6784\u91cc\uff0c\u5927\u5bb6\u9ed8\u8ba4\u4e3b\u5907\u5207\u6362\u7684\u903b\u8f91\u662f\u7531\u6570\u636e\u5e93\u7cfb\u7edf\u81ea\u5df1\u7ef4\u62a4\u7684\u3002\u8fd9\u6837\u5bf9\u5ba2\u6237\u7aef\u6765\u8bf4\uff0c\u5c31\u662f\u201c\u7f51\u7edc\u65ad\u5f00\uff0c\u91cd\u8fde\u4e4b\u540e\uff0c\u53d1\u73b0\u5185\u5b58\u8868\u6570\u636e\u4e22\u5931\u4e86\u201d\u3002</p>\n<p>\u4f60\u53ef\u80fd\u8bf4\u8fd9\u8fd8\u597d\u554a\uff0c\u6bd5\u7adf\u4e3b\u5907\u53d1\u751f\u5207\u6362\uff0c\u8fde\u63a5\u4f1a\u65ad\u5f00\uff0c\u4e1a\u52a1\u7aef\u80fd\u591f\u611f\u77e5\u5230\u5f02\u5e38\u3002</p>\n<p>\u4f46\u662f\uff0c\u63a5\u4e0b\u6765\u5185\u5b58\u8868\u7684\u8fd9\u4e2a\u7279\u6027\u5c31\u4f1a\u8ba9\u4f7f\u7528\u73b0\u8c61\u663e\u5f97\u66f4\u201c\u8be1\u5f02\u201d\u4e86\u3002\u7531\u4e8e MySQL \u77e5\u9053\u91cd\u542f\u4e4b\u540e\uff0c\u5185\u5b58\u8868\u7684\u6570\u636e\u4f1a\u4e22\u5931\u3002\u6240\u4ee5\uff0c\u62c5\u5fc3\u4e3b\u5e93\u91cd\u542f\u4e4b\u540e\uff0c\u51fa\u73b0\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0cMySQL \u5728\u5b9e\u73b0\u4e0a\u505a\u4e86\u8fd9\u6837\u4e00\u4ef6\u4e8b\u513f\uff1a\u5728\u6570\u636e\u5e93\u91cd\u542f\u4e4b\u540e\uff0c\u5f80 binlog \u91cc\u9762\u5199\u5165\u4e00\u884c DELETE FROM t1\u3002</p>\n<p><strong>\u5982\u679c\u4f60\u4f7f\u7528\u662f\u53cc M \u7ed3\u6784\u7684\u8bdd\uff1a</strong></p>\n<p>\u5728\u5907\u5e93\u91cd\u542f\u7684\u65f6\u5019\uff0c\u5907\u5e93 binlog \u91cc\u7684 delete \u8bed\u53e5\u5c31\u4f1a\u4f20\u5230\u4e3b\u5e93\uff0c\u7136\u540e\u628a\u4e3b\u5e93\u5185\u5b58\u8868\u7684\u5185\u5bb9\u5220\u9664\u3002\u8fd9\u6837\u4f60\u5728\u4f7f\u7528\u7684\u65f6\u5019\u5c31\u4f1a\u53d1\u73b0\uff0c\u4e3b\u5e93\u7684\u5185\u5b58\u8868\u6570\u636e\u7a81\u7136\u88ab\u6e05\u7a7a\u4e86\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5185\u5b58\u8868\u5e76\u4e0d\u9002\u5408\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u4f5c\u4e3a\u666e\u901a\u6570\u636e\u8868\u4f7f\u7528\u3002</p>\n<p>\u6709\u540c\u5b66\u4f1a\u8bf4\uff0c\u4f46\u662f\u5185\u5b58\u8868\u6267\u884c\u901f\u5ea6\u5feb\u5440\u3002\u8fd9\u4e2a\u95ee\u9898\uff0c\u5176\u5b9e\u4f60\u53ef\u4ee5\u8fd9\u4e48\u5206\u6790\uff1a</p>\n<ol>\n<li>\u5982\u679c\u4f60\u7684\u8868\u66f4\u65b0\u91cf\u5927\uff0c\u90a3\u4e48\u5e76\u53d1\u5ea6\u662f\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u53c2\u8003\u6307\u6807\uff0cInnoDB \u652f\u6301\u884c\u9501\uff0c\u5e76\u53d1\u5ea6\u6bd4\u5185\u5b58\u8868\u597d\uff1b</li>\n<li>\u80fd\u653e\u5230\u5185\u5b58\u8868\u7684\u6570\u636e\u91cf\u90fd\u4e0d\u5927\u3002\u5982\u679c\u4f60\u8003\u8651\u7684\u662f\u8bfb\u7684\u6027\u80fd\uff0c\u4e00\u4e2a\u8bfb QPS \u5f88\u9ad8\u5e76\u4e14\u6570\u636e\u91cf\u4e0d\u5927\u7684\u8868\uff0c\u5373\u4f7f\u662f\u4f7f\u7528 InnoDB\uff0c\u6570\u636e\u4e5f\u662f\u90fd\u4f1a\u7f13\u5b58\u5728 InnoDB Buffer Pool \u91cc\u7684\u3002\u56e0\u6b64\uff0c\u4f7f\u7528 InnoDB \u8868\u7684\u8bfb\u6027\u80fd\u4e5f\u4e0d\u4f1a\u5dee\u3002</li>\n</ol>\n<p>\u6240\u4ee5\uff0c**\u6211\u5efa\u8bae\u4f60\u628a\u666e\u901a\u5185\u5b58\u8868\u90fd\u7528 InnoDB \u8868\u6765\u4ee3\u66ff\u3002**\u4f46\u662f\uff0c\u6709\u4e00\u4e2a\u573a\u666f\u5374\u662f\u4f8b\u5916\u7684\u3002</p>\n<p>\u8fd9\u4e2a\u573a\u666f\u5c31\u662f\uff0c\u6211\u4eec\u5728\u7b2c 35 \u548c 36 \u7bc7\u8bf4\u5230\u7684\u7528\u6237\u4e34\u65f6\u8868\u3002\u5728\u6570\u636e\u91cf\u53ef\u63a7\uff0c\u4e0d\u4f1a\u8017\u8d39\u8fc7\u591a\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u5185\u5b58\u8868\u3002</p>\n<p>\u5185\u5b58\u4e34\u65f6\u8868\u521a\u597d\u53ef\u4ee5\u65e0\u89c6\u5185\u5b58\u8868\u7684\u4e24\u4e2a\u4e0d\u8db3\uff0c\u4e3b\u8981\u662f\u4e0b\u9762\u7684\u4e09\u4e2a\u539f\u56e0\uff1a</p>\n<ol>\n<li>\u4e34\u65f6\u8868\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u8bbf\u95ee\uff0c\u6ca1\u6709\u5e76\u53d1\u6027\u7684\u95ee\u9898\uff1b</li>\n<li>\u4e34\u65f6\u8868\u91cd\u542f\u540e\u4e5f\u662f\u9700\u8981\u5220\u9664\u7684\uff0c\u6e05\u7a7a\u6570\u636e\u8fd9\u4e2a\u95ee\u9898\u4e0d\u5b58\u5728\uff1b</li>\n<li>\u5907\u5e93\u7684\u4e34\u65f6\u8868\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u4e3b\u5e93\u7684\u7528\u6237\u7ebf\u7a0b\u3002</li>\n</ol>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u56de\u8fc7\u5934\u518d\u770b\u4e00\u4e0b\u7b2c 35 \u7bc7 join \u8bed\u53e5\u4f18\u5316\u7684\u4f8b\u5b50\uff0c\u5f53\u65f6\u6211\u5efa\u8bae\u7684\u662f\u521b\u5efa\u4e00\u4e2a InnoDB \u4e34\u65f6\u8868\uff0c\u4f7f\u7528\u7684\u8bed\u53e5\u5e8f\u5217\u662f\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">))</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">temp_t</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u4e86\u89e3\u4e86\u5185\u5b58\u8868\u7684\u7279\u6027\uff0c\u4f60\u5c31\u77e5\u9053\u4e86\uff0c \u5176\u5b9e\u8fd9\u91cc\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u7684\u6548\u679c\u66f4\u597d\uff0c\u539f\u56e0\u6709\u4e09\u4e2a\uff1a</p>\n<ol>\n<li>\u76f8\u6bd4\u4e8e InnoDB \u8868\uff0c\u4f7f\u7528\u5185\u5b58\u8868\u4e0d\u9700\u8981\u5199\u78c1\u76d8\uff0c\u5f80\u8868 <code>temp_t</code> \u7684\u5199\u6570\u636e\u7684\u901f\u5ea6\u66f4\u5feb\uff1b</li>\n<li>\u7d22\u5f15 b \u4f7f\u7528 hash \u7d22\u5f15\uff0c\u67e5\u627e\u7684\u901f\u5ea6\u6bd4 B-Tree \u7d22\u5f15\u5feb\uff1b</li>\n<li>\u4e34\u65f6\u8868\u6570\u636e\u53ea\u6709 2000 \u884c\uff0c\u5360\u7528\u7684\u5185\u5b58\u6709\u9650\u3002</li>\n</ol>\n<p>\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u5bf9[\u7b2c 35 \u7bc7\u6587\u7ae0]\u7684\u8bed\u53e5\u5e8f\u5217\u505a\u4e00\u4e2a\u6539\u5199\uff0c\u5c06\u4e34\u65f6\u8868 t1 \u6539\u6210\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u5728\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u4e00\u4e2a hash \u7d22\u5f15\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">))</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">memory</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&gt;=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">&lt;=</span><span class=\"mi\">2000</span><span class=\"p\">;</span>\n<span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t1</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">temp_t</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u8bba\u662f\u5bfc\u5165\u6570\u636e\u7684\u65f6\u95f4\uff0c\u8fd8\u662f\u6267\u884c join \u7684\u65f6\u95f4\uff0c\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u7684\u901f\u5ea6\u90fd\u6bd4\u4f7f\u7528 InnoDB \u4e34\u65f6\u8868\u8981\u66f4\u5feb\u4e00\u4e9b\u3002</p>\n<h3 id=\"_24\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_24\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4ece\u201c\u8981\u4e0d\u8981\u4f7f\u7528\u5185\u5b58\u8868\u201d\u8fd9\u4e2a\u95ee\u9898\u5c55\u5f00\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86 Memory \u5f15\u64ce\u7684\u51e0\u4e2a\u7279\u6027\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e\u91cd\u542f\u4f1a\u4e22\u6570\u636e\uff0c\u5982\u679c\u4e00\u4e2a\u5907\u5e93\u91cd\u542f\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\uff1b\u5982\u679c\u4e3b\u5e93\u8ddf\u8fd9\u4e2a\u5907\u5e93\u662f\u53cc M \u67b6\u6784\uff0c\u8fd8\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5e93\u7684\u5185\u5b58\u8868\u6570\u636e\u88ab\u5220\u6389\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5728\u751f\u4ea7\u4e0a\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u4f7f\u7528\u666e\u901a\u5185\u5b58\u8868\u3002</p>\n<p>\u5982\u679c\u4f60\u662f DBA\uff0c\u53ef\u4ee5\u5728\u5efa\u8868\u7684\u5ba1\u6838\u7cfb\u7edf\u4e2d\u589e\u52a0\u8fd9\u7c7b\u89c4\u5219\uff0c\u8981\u6c42\u4e1a\u52a1\u6539\u7528 InnoDB \u8868\u3002\u6211\u4eec\u5728\u6587\u4e2d\u4e5f\u5206\u6790\u4e86\uff0c\u5176\u5b9e InnoDB \u8868\u6027\u80fd\u8fd8\u4e0d\u9519\uff0c\u800c\u4e14\u6570\u636e\u5b89\u5168\u4e5f\u6709\u4fdd\u969c\u3002\u800c\u5185\u5b58\u8868\u7531\u4e8e\u4e0d\u652f\u6301\u884c\u9501\uff0c\u66f4\u65b0\u8bed\u53e5\u4f1a\u963b\u585e\u67e5\u8be2\uff0c\u6027\u80fd\u4e5f\u672a\u5fc5\u5c31\u5982\u60f3\u8c61\u4e2d\u90a3\u4e48\u597d\u3002</p>\n<p>\u57fa\u4e8e\u5185\u5b58\u8868\u7684\u7279\u6027\uff0c\u6211\u4eec\u8fd8\u5206\u6790\u4e86\u5b83\u7684\u4e00\u4e2a\u9002\u7528\u573a\u666f\uff0c\u5c31\u662f\u5185\u5b58\u4e34\u65f6\u8868\u3002\u5185\u5b58\u8868\u652f\u6301 hash \u7d22\u5f15\uff0c\u8fd9\u4e2a\u7279\u6027\u5229\u7528\u8d77\u6765\uff0c\u5bf9\u590d\u6742\u67e5\u8be2\u7684\u52a0\u901f\u6548\u679c\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\u3002</p>\n<h2 id=\"39\">39 \u81ea\u589e\u4e3b\u952e\u4e3a\u4ec0\u4e48\u4e0d\u662f\u8fde\u7eed\u7684\uff1f<a class=\"headerlink\" href=\"#39\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728[\u7b2c 4 \u7bc7\u6587\u7ae0]\u4e2d\uff0c\u6211\u4eec\u63d0\u5230\u8fc7\u81ea\u589e\u4e3b\u952e\uff0c\u7531\u4e8e\u81ea\u589e\u4e3b\u952e\u53ef\u4ee5\u8ba9\u4e3b\u952e\u7d22\u5f15\u5c3d\u91cf\u5730\u4fdd\u6301\u9012\u589e\u987a\u5e8f\u63d2\u5165\uff0c\u907f\u514d\u4e86\u9875\u5206\u88c2\uff0c\u56e0\u6b64\u7d22\u5f15\u66f4\u7d27\u51d1\u3002</p>\n<p>\u4e4b\u524d\u6211\u89c1\u8fc7\u6709\u7684\u4e1a\u52a1\u8bbe\u8ba1\u4f9d\u8d56\u4e8e\u81ea\u589e\u4e3b\u952e\u7684\u8fde\u7eed\u6027\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u8bbe\u8ba1\u5047\u8bbe\u81ea\u589e\u4e3b\u952e\u662f\u8fde\u7eed\u7684\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u6837\u7684\u5047\u8bbe\u662f\u9519\u7684\uff0c\u56e0\u4e3a\u81ea\u589e\u4e3b\u952e\u4e0d\u80fd\u4fdd\u8bc1\u8fde\u7eed\u9012\u589e\u3002</p>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u6765\u8bf4\u8bf4\u8fd9\u4e2a\u95ee\u9898\uff0c\u770b\u770b\u4ec0\u4e48\u60c5\u51b5\u4e0b\u81ea\u589e\u4e3b\u952e\u4f1a\u51fa\u73b0 \u201c\u7a7a\u6d1e\u201d\uff1f</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u8868 t\uff0c\u5176\u4e2d id \u662f\u81ea\u589e\u4e3b\u952e\u5b57\u6bb5\u3001c \u662f\u552f\u4e00\u7d22\u5f15\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_25\">\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u54ea\u513f\uff1f<a class=\"headerlink\" href=\"#_25\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8fd9\u4e2a\u7a7a\u8868 t \u91cc\u9762\u6267\u884c <code>insert into t values(null, 1, 1);</code> \u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u518d\u6267\u884c show create table \u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u56fe\u6240\u793a\u7684\u7ed3\u679c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">       </span><span class=\"k\">Table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"k\">Create</span><span class=\"w\"> </span><span class=\"k\">Table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"n\">CHARSET</span><span class=\"o\">=</span><span class=\"n\">utf8mb4</span><span class=\"w\"> </span><span class=\"k\">COLLATE</span><span class=\"o\">=</span><span class=\"n\">utf8mb4_general_ci</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8868\u5b9a\u4e49\u91cc\u9762\u51fa\u73b0\u4e86\u4e00\u4e2a <code>AUTO_INCREMENT=2</code>\uff0c\u8868\u793a\u4e0b\u4e00\u6b21\u63d2\u5165\u6570\u636e\u65f6\uff0c\u5982\u679c\u9700\u8981\u81ea\u52a8\u751f\u6210\u81ea\u589e\u503c\uff0c\u4f1a\u751f\u6210 id=2\u3002</p>\n<p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u8f93\u51fa\u7ed3\u679c\u5bb9\u6613\u5f15\u8d77\u8fd9\u6837\u7684\u8bef\u89e3\uff1a\u81ea\u589e\u503c\u662f\u4fdd\u5b58\u5728\u8868\u7ed3\u6784\u5b9a\u4e49\u91cc\u7684\u3002\u5b9e\u9645\u4e0a\uff0c<strong>\u8868\u7684\u7ed3\u6784\u5b9a\u4e49\u5b58\u653e\u5728\u540e\u7f00\u540d\u4e3a.frm \u7684\u6587\u4ef6\u4e2d\uff0c\u4f46\u662f\u5e76\u4e0d\u4f1a\u4fdd\u5b58\u81ea\u589e\u503c\u3002</strong></p>\n<p>\u4e0d\u540c\u7684\u5f15\u64ce\u5bf9\u4e8e\u81ea\u589e\u503c\u7684\u4fdd\u5b58\u7b56\u7565\u4e0d\u540c\u3002</p>\n<ul>\n<li>MyISAM \u5f15\u64ce\u7684\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u6570\u636e\u6587\u4ef6\u4e2d\u3002</li>\n<li>InnoDB \u5f15\u64ce\u7684\u81ea\u589e\u503c\uff0c\u5176\u5b9e\u662f\u4fdd\u5b58\u5728\u4e86\u5185\u5b58\u91cc\uff0c\u5e76\u4e14\u5230\u4e86 MySQL 8.0 \u7248\u672c\u540e\uff0c\u624d\u6709\u4e86\u201c\u81ea\u589e\u503c\u6301\u4e45\u5316\u201d\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u662f\u624d\u5b9e\u73b0\u4e86\u201c\u5982\u679c\u53d1\u751f\u91cd\u542f\uff0c\u8868\u7684\u81ea\u589e\u503c\u53ef\u4ee5\u6062\u590d\u4e3a MySQL \u91cd\u542f\u524d\u7684\u503c\u201d\uff0c\u5177\u4f53\u60c5\u51b5\u662f\uff1a </li>\n<li>\u5728 MySQL 5.7 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u5185\u5b58\u91cc\uff0c\u5e76\u6ca1\u6709\u6301\u4e45\u5316\u3002\u6bcf\u6b21\u91cd\u542f\u540e\uff0c\u7b2c\u4e00\u6b21\u6253\u5f00\u8868\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u53bb\u627e\u81ea\u589e\u503c\u7684\u6700\u5927\u503c <code>max(id)</code>\uff0c\u7136\u540e\u5c06 <code>max(id)+1</code> \u4f5c\u4e3a\u8fd9\u4e2a\u8868\u5f53\u524d\u7684\u81ea\u589e\u503c\u3002 \u4e3e\u4f8b\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a\u8868\u5f53\u524d\u6570\u636e\u884c\u91cc\u6700\u5927\u7684 id \u662f 10\uff0c<code>AUTO_INCREMENT=11</code>\u3002\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5220\u9664 id=10 \u7684\u884c\uff0c<code>AUTO_INCREMENT</code> \u8fd8\u662f 11\u3002\u4f46\u5982\u679c\u9a6c\u4e0a\u91cd\u542f\u5b9e\u4f8b\uff0c\u91cd\u542f\u540e\u8fd9\u4e2a\u8868\u7684 AUTO_INCREMENT \u5c31\u4f1a\u53d8\u6210 10\u3002 \u4e5f\u5c31\u662f\u8bf4\uff0cMySQL \u91cd\u542f\u53ef\u80fd\u4f1a\u4fee\u6539\u4e00\u4e2a\u8868\u7684 <code>AUTO_INCREMENT</code> \u7684\u503c\u3002</li>\n<li>\u5728 MySQL 8.0 \u7248\u672c\uff0c\u5c06\u81ea\u589e\u503c\u7684\u53d8\u66f4\u8bb0\u5f55\u5728\u4e86 redo log \u4e2d\uff0c\u91cd\u542f\u7684\u65f6\u5019\u4f9d\u9760 redo log \u6062\u590d\u91cd\u542f\u4e4b\u524d\u7684\u503c\u3002</li>\n</ul>\n<p>\u7406\u89e3\u4e86 MySQL \u5bf9\u81ea\u589e\u503c\u7684\u4fdd\u5b58\u7b56\u7565\u4ee5\u540e\uff0c\u6211\u4eec\u518d\u770b\u770b\u81ea\u589e\u503c\u4fee\u6539\u673a\u5236\u3002</p>\n<h3 id=\"_26\">\u81ea\u589e\u503c\u4fee\u6539\u673a\u5236<a class=\"headerlink\" href=\"#_26\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 MySQL \u91cc\u9762\uff0c\u5982\u679c\u5b57\u6bb5 id \u88ab\u5b9a\u4e49\u4e3a <code>AUTO_INCREMENT</code>\uff0c\u5728\u63d2\u5165\u4e00\u884c\u6570\u636e\u7684\u65f6\u5019\uff0c\u81ea\u589e\u503c\u7684\u884c\u4e3a\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u5982\u679c\u63d2\u5165\u6570\u636e\u65f6 id \u5b57\u6bb5\u6307\u5b9a\u4e3a 0\u3001null \u6216\u672a\u6307\u5b9a\u503c\uff0c\u90a3\u4e48\u5c31\u628a\u8fd9\u4e2a\u8868\u5f53\u524d\u7684 <code>AUTO_INCREMENT</code> \u503c\u586b\u5230\u81ea\u589e\u5b57\u6bb5\uff1b</li>\n<li>\u5982\u679c\u63d2\u5165\u6570\u636e\u65f6 id \u5b57\u6bb5\u6307\u5b9a\u4e86\u5177\u4f53\u7684\u503c\uff0c\u5c31\u76f4\u63a5\u4f7f\u7528\u8bed\u53e5\u91cc\u6307\u5b9a\u7684\u503c\u3002</li>\n</ol>\n<p>\u6839\u636e\u8981\u63d2\u5165\u7684\u503c\u548c\u5f53\u524d\u81ea\u589e\u503c\u7684\u5927\u5c0f\u5173\u7cfb\uff0c\u81ea\u589e\u503c\u7684\u53d8\u66f4\u7ed3\u679c\u4e5f\u4f1a\u6709\u6240\u4e0d\u540c\u3002\u5047\u8bbe\uff0c\u67d0\u6b21\u8981\u63d2\u5165\u7684\u503c\u662f X\uff0c\u5f53\u524d\u7684\u81ea\u589e\u503c\u662f Y\u3002</p>\n<ol>\n<li>\u5982\u679c X\\&lt;Y\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8868\u7684\u81ea\u589e\u503c\u4e0d\u53d8\uff1b</li>\n<li>\u5982\u679c X\u2265Y\uff0c\u5c31\u9700\u8981\u628a\u5f53\u524d\u81ea\u589e\u503c\u4fee\u6539\u4e3a\u65b0\u7684\u81ea\u589e\u503c\u3002</li>\n</ol>\n<p><strong>\u65b0\u7684\u81ea\u589e\u503c\u751f\u6210\u7b97\u6cd5\u662f</strong>\uff1a\u4ece <code>auto_increment_offset</code> \u5f00\u59cb\uff0c\u4ee5 <code>auto_increment_increment</code> \u4e3a\u6b65\u957f\uff0c\u6301\u7eed\u53e0\u52a0\uff0c\u76f4\u5230\u627e\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e X \u7684\u503c\uff0c\u4f5c\u4e3a\u65b0\u7684\u81ea\u589e\u503c\u3002</p>\n<p>\u5176\u4e2d\uff0c<code>auto_increment_offset</code> \u548c <code>auto_increment_increment</code> \u662f\u4e24\u4e2a\u7cfb\u7edf\u53c2\u6570\uff0c\u5206\u522b\u7528\u6765\u8868\u793a\u81ea\u589e\u7684\u521d\u59cb\u503c\u548c\u6b65\u957f\uff0c\u9ed8\u8ba4\u503c\u90fd\u662f 1\u3002</p>\n<blockquote>\n<p>\u5907\u6ce8\uff1a\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u4f7f\u7528\u7684\u5c31\u4e0d\u5168\u662f\u9ed8\u8ba4\u503c\u3002\u6bd4\u5982\uff0c\u53cc M \u7684\u4e3b\u5907\u7ed3\u6784\u91cc\u8981\u6c42\u53cc\u5199\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u80fd\u4f1a\u8bbe\u7f6e\u6210 auto_increment_increment=2\uff0c\u8ba9\u4e00\u4e2a\u5e93\u7684\u81ea\u589e id \u90fd\u662f\u5947\u6570\uff0c\u53e6\u4e00\u4e2a\u5e93\u7684\u81ea\u589e id \u90fd\u662f\u5076\u6570\uff0c\u907f\u514d\u4e24\u4e2a\u5e93\u751f\u6210\u7684\u4e3b\u952e\u53d1\u751f\u51b2\u7a81\u3002</p>\n</blockquote>\n<p>\u5f53 <code>auto_increment_offset</code> \u548c <code>auto_increment_increment</code> \u90fd\u662f 1 \u7684\u65f6\u5019\uff0c\u65b0\u7684\u81ea\u589e\u503c\u751f\u6210\u903b\u8f91\u5f88\u7b80\u5355\uff0c\u5c31\u662f\uff1a</p>\n<ol>\n<li>\u5982\u679c\u51c6\u5907\u63d2\u5165\u7684\u503c &gt;= \u5f53\u524d\u81ea\u589e\u503c\uff0c\u65b0\u7684\u81ea\u589e\u503c\u5c31\u662f\u201c\u51c6\u5907\u63d2\u5165\u7684\u503c +1\u201d\uff1b</li>\n<li>\u5426\u5219\uff0c\u81ea\u589e\u503c\u4e0d\u53d8\u3002</li>\n</ol>\n<p>\u8fd9\u5c31\u5f15\u5165\u4e86\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u63d0\u5230\u7684\u95ee\u9898\uff0c\u5728\u8fd9\u4e24\u4e2a\u53c2\u6570\u90fd\u8bbe\u7f6e\u4e3a 1 \u7684\u65f6\u5019\uff0c\u81ea\u589e\u4e3b\u952e id \u5374\u4e0d\u80fd\u4fdd\u8bc1\u662f\u8fde\u7eed\u7684\uff0c\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f</p>\n<h3 id=\"_27\">\u81ea\u589e\u503c\u7684\u4fee\u6539\u65f6\u673a<a class=\"headerlink\" href=\"#_27\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8981\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5c31\u8981\u770b\u4e00\u4e0b\u81ea\u589e\u503c\u7684\u4fee\u6539\u65f6\u673a\u3002</p>\n<p>\u5047\u8bbe\uff0c\u8868 t \u91cc\u9762\u5df2\u7ecf\u6709\u4e86 (1,1,1) \u8fd9\u6761\u8bb0\u5f55\uff0c\u8fd9\u65f6\u6211\u518d\u6267\u884c\u4e00\u6761\u63d2\u5165\u6570\u636e\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span><span class=\"w\"> </span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u662f\uff1a</p>\n<ol>\n<li>\u6267\u884c\u5668\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\u5199\u5165\u4e00\u884c\uff0c\u4f20\u5165\u7684\u8fd9\u4e00\u884c\u7684\u503c\u662f (0,1,1);</li>\n<li>InnoDB \u53d1\u73b0\u7528\u6237\u6ca1\u6709\u6307\u5b9a\u81ea\u589e id \u7684\u503c\uff0c\u83b7\u53d6\u8868 t \u5f53\u524d\u7684\u81ea\u589e\u503c 2\uff1b</li>\n<li>\u5c06\u4f20\u5165\u7684\u884c\u7684\u503c\u6539\u6210 (2,1,1);</li>\n<li>\u5c06\u8868\u7684\u81ea\u589e\u503c\u6539\u6210 3\uff1b</li>\n<li>\u7ee7\u7eed\u6267\u884c\u63d2\u5165\u6570\u636e\u64cd\u4f5c\uff0c\u7531\u4e8e\u5df2\u7ecf\u5b58\u5728 c=1 \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u62a5 Duplicate key error\uff0c\u8bed\u53e5\u8fd4\u56de\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8868\u7684\u81ea\u589e\u503c\u6539\u6210 3\uff0c\u662f\u5728\u771f\u6b63\u6267\u884c\u63d2\u5165\u6570\u636e\u7684\u64cd\u4f5c\u4e4b\u524d\u3002\u8fd9\u4e2a\u8bed\u53e5\u771f\u6b63\u6267\u884c\u7684\u65f6\u5019\uff0c\u56e0\u4e3a\u78b0\u5230\u552f\u4e00\u952e c \u51b2\u7a81\uff0c\u6240\u4ee5 id=2 \u8fd9\u4e00\u884c\u5e76\u6ca1\u6709\u63d2\u5165\u6210\u529f\uff0c\u4f46\u4e5f\u6ca1\u6709\u5c06\u81ea\u589e\u503c\u518d\u6539\u56de\u53bb\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5728\u8fd9\u4e4b\u540e\uff0c\u518d\u63d2\u5165\u65b0\u7684\u6570\u636e\u884c\u65f6\uff0c\u62ff\u5230\u7684\u81ea\u589e id \u5c31\u662f 3\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u51fa\u73b0\u4e86\u81ea\u589e\u4e3b\u952e\u4e0d\u8fde\u7eed\u7684\u60c5\u51b5\u3002</p>\n<p>\u5982\u56fe 3 \u6240\u793a\u5c31\u662f\u5b8c\u6574\u7684\u6f14\u793a\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"n\">CHARSET</span><span class=\"o\">=</span><span class=\"n\">utf8mb4</span><span class=\"w\"> </span><span class=\"k\">COLLATE</span><span class=\"o\">=</span><span class=\"n\">utf8mb4_general_ci</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"n\">OK</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"n\">affected</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"n\">ERROR</span><span class=\"w\"> </span><span class=\"mi\">1062</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">23000</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"n\">Duplicate</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"s1\">&#39;1&#39;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\"> </span><span class=\"s1\">&#39;c&#39;</span>\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"n\">OK</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"n\">affected</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+------+------+</span>\n<span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u5e8f\u5217\u590d\u73b0\u4e86\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e id \u4e0d\u8fde\u7eed\u7684\u73b0\u573a (\u6ca1\u6709 id=2 \u7684\u884c\uff09\u3002\u53ef\u89c1\uff0c<strong>\u552f\u4e00\u952e\u51b2\u7a81\u662f\u5bfc\u81f4\u81ea\u589e\u4e3b\u952e id \u4e0d\u8fde\u7eed\u7684\u7b2c\u4e00\u79cd\u539f\u56e0\u3002</strong></p>\n<p>\u540c\u6837\u5730\uff0c\u4e8b\u52a1**\u56de\u6eda\u4e5f\u4f1a\u4ea7\u751f\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u8fd9\u5c31\u662f\u7b2c\u4e8c\u79cd\u539f\u56e0\u3002**</p>\n<p>\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\u5c31\u53ef\u4ee5\u6784\u9020\u4e0d\u8fde\u7eed\u7684\u81ea\u589e id\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"k\">begin</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"k\">rollback</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"c1\">-- \u63d2\u5165\u7684\u884c\u662f (3,2,2)</span>\n</code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u5728\u51fa\u73b0\u552f\u4e00\u952e\u51b2\u7a81\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\uff0cMySQL \u6ca1\u6709\u628a\u8868 t \u7684\u81ea\u589e\u503c\u6539\u56de\u53bb\u5462\uff1f\u5982\u679c\u628a\u8868 t \u7684\u5f53\u524d\u81ea\u589e\u503c\u4ece 3 \u6539\u56de 2\uff0c\u518d\u63d2\u5165\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u4e0d\u5c31\u53ef\u4ee5\u751f\u6210 id=2 \u7684\u4e00\u884c\u6570\u636e\u4e86\u5417\uff1f</p>\n<p>\u5176\u5b9e\uff0cMySQL \u8fd9\u4e48\u8bbe\u8ba1\u662f\u4e3a\u4e86\u63d0\u5347\u6027\u80fd\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u8ddf\u4f60\u5206\u6790\u4e00\u4e0b\u8fd9\u4e2a\u8bbe\u8ba1\u601d\u8def\uff0c\u770b\u770b**\u81ea\u589e\u503c\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u56de\u9000\u3002**</p>\n<p>\u5047\u8bbe\u6709\u4e24\u4e2a\u5e76\u884c\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u5728\u7533\u8bf7\u81ea\u589e\u503c\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u907f\u514d\u4e24\u4e2a\u4e8b\u52a1\u7533\u8bf7\u5230\u76f8\u540c\u7684\u81ea\u589e id\uff0c\u80af\u5b9a\u8981\u52a0\u9501\uff0c\u7136\u540e\u987a\u5e8f\u7533\u8bf7\u3002</p>\n<ol>\n<li>\u5047\u8bbe\u4e8b\u52a1 A \u7533\u8bf7\u5230\u4e86 id=2\uff0c \u4e8b\u52a1 B \u7533\u8bf7\u5230 id=3\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u8868 t \u7684\u81ea\u589e\u503c\u662f 4\uff0c\u4e4b\u540e\u7ee7\u7eed\u6267\u884c\u3002</li>\n<li>\u4e8b\u52a1 B \u6b63\u786e\u63d0\u4ea4\u4e86\uff0c\u4f46\u4e8b\u52a1 A \u51fa\u73b0\u4e86\u552f\u4e00\u952e\u51b2\u7a81\u3002</li>\n<li>\u5982\u679c\u5141\u8bb8\u4e8b\u52a1 A \u628a\u81ea\u589e id \u56de\u9000\uff0c\u4e5f\u5c31\u662f\u628a\u8868 t \u7684\u5f53\u524d\u81ea\u589e\u503c\u6539\u56de 2\uff0c\u90a3\u4e48\u5c31\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u8868\u91cc\u9762\u5df2\u7ecf\u6709 id=3 \u7684\u884c\uff0c\u800c\u5f53\u524d\u7684\u81ea\u589e id \u503c\u662f 2\u3002</li>\n<li>\u63a5\u4e0b\u6765\uff0c\u7ee7\u7eed\u6267\u884c\u7684\u5176\u4ed6\u4e8b\u52a1\u5c31\u4f1a\u7533\u8bf7\u5230 id=2\uff0c\u7136\u540e\u518d\u7533\u8bf7\u5230 id=3\u3002\u8fd9\u65f6\uff0c\u5c31\u4f1a\u51fa\u73b0\u63d2\u5165\u8bed\u53e5\u62a5\u9519\u201c\u4e3b\u952e\u51b2\u7a81\u201d\u3002</li>\n</ol>\n<p>\u800c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u4e3b\u952e\u51b2\u7a81\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u6bcf\u6b21\u7533\u8bf7 id \u4e4b\u524d\uff0c\u5148\u5224\u65ad\u8868\u91cc\u9762\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u8fd9\u4e2a id\u3002\u5982\u679c\u5b58\u5728\uff0c\u5c31\u8df3\u8fc7\u8fd9\u4e2a id\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6210\u672c\u5f88\u9ad8\u3002\u56e0\u4e3a\uff0c\u672c\u6765\u7533\u8bf7 id \u662f\u4e00\u4e2a\u5f88\u5feb\u7684\u64cd\u4f5c\uff0c\u73b0\u5728\u8fd8\u8981\u518d\u53bb\u4e3b\u952e\u7d22\u5f15\u6811\u4e0a\u5224\u65ad id \u662f\u5426\u5b58\u5728\u3002</li>\n<li>\u628a\u81ea\u589e id \u7684\u9501\u8303\u56f4\u6269\u5927\uff0c\u5fc5\u987b\u7b49\u5230\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\u5e76\u63d0\u4ea4\uff0c\u4e0b\u4e00\u4e2a\u4e8b\u52a1\u624d\u80fd\u518d\u7533\u8bf7\u81ea\u589e id\u3002\u8fd9\u4e2a\u65b9\u6cd5\u7684\u95ee\u9898\uff0c\u5c31\u662f\u9501\u7684\u7c92\u5ea6\u592a\u5927\uff0c\u7cfb\u7edf\u5e76\u53d1\u80fd\u529b\u5927\u5927\u4e0b\u964d\u3002</li>\n</ol>\n<p>\u53ef\u89c1\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u90fd\u4f1a\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u3002\u9020\u6210\u8fd9\u4e9b\u9ebb\u70e6\u7684\u7f6a\u9b41\u7978\u9996\uff0c\u5c31\u662f\u6211\u4eec\u5047\u8bbe\u7684\u8fd9\u4e2a\u201c\u5141\u8bb8\u81ea\u589e id \u56de\u9000\u201d\u7684\u524d\u63d0\u5bfc\u81f4\u7684\u3002</p>\n<p>\u56e0\u6b64\uff0cInnoDB \u653e\u5f03\u4e86\u8fd9\u4e2a\u8bbe\u8ba1\uff0c\u8bed\u53e5\u6267\u884c\u5931\u8d25\u4e5f\u4e0d\u56de\u9000\u81ea\u589e id\u3002\u4e5f\u6b63\u662f\u56e0\u4e3a\u8fd9\u6837\uff0c\u6240\u4ee5\u624d\u53ea\u4fdd\u8bc1\u4e86\u81ea\u589e id \u662f\u9012\u589e\u7684\uff0c\u4f46\u4e0d\u4fdd\u8bc1\u662f\u8fde\u7eed\u7684\u3002</p>\n<h3 id=\"_28\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_28\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\uff0c\u6211\u4eec\u4ece\u201c\u81ea\u589e\u4e3b\u952e\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u4e0d\u8fde\u7eed\u7684\u503c\u201d\u8fd9\u4e2a\u95ee\u9898\u5f00\u59cb\uff0c\u9996\u5148\u8ba8\u8bba\u4e86\u81ea\u589e\u503c\u7684\u5b58\u50a8\u3002</p>\n<p>\u5728 MyISAM \u5f15\u64ce\u91cc\u9762\uff0c\u81ea\u589e\u503c\u662f\u88ab\u5199\u5728\u6570\u636e\u6587\u4ef6\u4e0a\u7684\u3002\u800c\u5728 InnoDB \u4e2d\uff0c\u81ea\u589e\u503c\u662f\u88ab\u8bb0\u5f55\u5728\u5185\u5b58\u7684\u3002MySQL \u76f4\u5230 8.0 \u7248\u672c\uff0c\u624d\u7ed9 InnoDB \u8868\u7684\u81ea\u589e\u503c\u52a0\u4e0a\u4e86\u6301\u4e45\u5316\u7684\u80fd\u529b\uff0c\u786e\u4fdd\u91cd\u542f\u524d\u540e\u4e00\u4e2a\u8868\u7684\u81ea\u589e\u503c\u4e0d\u53d8\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["mysql", "tuning"]}, {"id": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-5/", "url": "https://wgzhao.github.io/notes/courses/mysql-lecture/mysql-practices-lecture-45-5/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e94\u90e8\u5206", "content_html": "<h1 id=\"mysql-45\">\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e94\u90e8\u5206<a class=\"headerlink\" href=\"#mysql-45\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"http://learn.lianglianglee.com/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2.md\" title=\"Permalink to MySQL\u5b9e\u621845\u8bb2.md\">Source</a></p>\n<p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e94\u90e8\u5206</p>\n<h2 id=\"40-insert\">40 insert\u8bed\u53e5\u7684\u9501\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u591a\uff1f<a class=\"headerlink\" href=\"#40-insert\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u63d0\u5230 MySQL \u5bf9\u81ea\u589e\u4e3b\u952e\u9501\u505a\u4e86\u4f18\u5316\uff0c\u5c3d\u91cf\u5728\u7533\u8bf7\u5230\u81ea\u589e id \u4ee5\u540e\uff0c\u5c31\u91ca\u653e\u81ea\u589e\u9501\u3002</p>\n<p>\u56e0\u6b64\uff0cinsert \u8bed\u53e5\u662f\u4e00\u4e2a\u5f88\u8f7b\u91cf\u7684\u64cd\u4f5c\u3002\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u7ed3\u8bba\u5bf9\u4e8e\u201c\u666e\u901a\u7684 insert \u8bed\u53e5\u201d\u624d\u6709\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd8\u6709\u4e9b insert \u8bed\u53e5\u662f\u5c5e\u4e8e\u201c\u7279\u6b8a\u60c5\u51b5\u201d\u7684\uff0c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u9700\u8981\u7ed9\u5176\u4ed6\u8d44\u6e90\u52a0\u9501\uff0c\u6216\u8005\u65e0\u6cd5\u5728\u7533\u8bf7\u5230\u81ea\u589e id \u4ee5\u540e\u5c31\u7acb\u9a6c\u91ca\u653e\u81ea\u589e\u9501\u3002</p>\n<p>\u90a3\u4e48\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u3002</p>\n<h3 id=\"insert-select\">insert \u2026 select \u8bed\u53e5<a class=\"headerlink\" href=\"#insert-select\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6211\u4eec\u5148\u4ece\u6628\u5929\u7684\u95ee\u9898\u8bf4\u8d77\u5427\u3002\u8868 t \u548c t2 \u7684\u8868\u7ed3\u6784\u3001\u521d\u59cb\u5316\u6570\u636e\u8bed\u53e5\u5982\u4e0b\uff0c\u4eca\u5929\u7684\u4f8b\u5b50\u6211\u4eec\u8fd8\u662f\u9488\u5bf9\u8fd9\u4e24\u4e2a\u8868\u5c55\u5f00\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"n\">t</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">NOT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"n\">AUTO_INCREMENT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"o\">`</span><span class=\"n\">d</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">DEFAULT</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"n\">id</span><span class=\"o\">`</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"k\">UNIQUE</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">`</span><span class=\"k\">c</span><span class=\"o\">`</span><span class=\"p\">)</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ENGINE</span><span class=\"o\">=</span><span class=\"n\">InnoDB</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"mi\">3</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"mi\">4</span><span class=\"p\">);</span><span class=\"w\"> </span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u4e3a\u4ec0\u4e48\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c<code>binlog_format=statement</code> \u65f6\u6267\u884c\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u65f6\uff0c\u9700\u8981\u5bf9\u8868 t \u7684\u6240\u6709\u884c\u548c\u95f4\u9699\u52a0\u9501\u5462\uff1f</p>\n<p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u9700\u8981\u8003\u8651\u7684\u8fd8\u662f\u65e5\u5fd7\u548c\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u6211\u4eec\u770b\u4e0b\u8fd9\u4e2a\u6267\u884c\u5e8f\u5217\uff1a</p>\n<ul>\n<li>session A: <code>insert into t values(-1, -1, -1)</code></li>\n<li>session B: <code>insert into t2(c, d) select c, d from t</code></li>\n</ul>\n<p>\u5b9e\u9645\u7684\u6267\u884c\u6548\u679c\u662f\uff0c\u5982\u679c session B \u5148\u6267\u884c\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u5bf9\u8868 t \u4e3b\u952e\u7d22\u5f15\u52a0\u4e86 (-\u221e,1] \u8fd9\u4e2a next-key lock\uff0c\u4f1a\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0c\u624d\u5141\u8bb8 session A \u7684 insert \u8bed\u53e5\u6267\u884c\u3002</p>\n<p>\u4f46\u5982\u679c\u6ca1\u6709\u9501\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0 session B \u7684 insert \u8bed\u53e5\u5148\u6267\u884c\uff0c\u4f46\u662f\u540e\u5199\u5165 binlog \u7684\u60c5\u51b5\u3002\u4e8e\u662f\uff0c\u5728 <code>binlog_format=statement</code> \u7684\u60c5\u51b5\u4e0b\uff0cbinlog \u91cc\u9762\u5c31\u8bb0\u5f55\u4e86\u8fd9\u6837\u7684\u8bed\u53e5\u5e8f\u5217\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u5230\u4e86\u5907\u5e93\u6267\u884c\uff0c\u5c31\u4f1a\u628a id=-1 \u8fd9\u4e00\u884c\u4e5f\u5199\u5230\u8868 t2 \u4e2d\uff0c\u51fa\u73b0\u4e3b\u5907\u4e0d\u4e00\u81f4\u3002</p>\n<h3 id=\"insert\">insert \u5faa\u73af\u5199\u5165<a class=\"headerlink\" href=\"#insert\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f53\u7136\u4e86\uff0c\u6267\u884c <code>insert \u2026 select</code> \u7684\u65f6\u5019\uff0c\u5bf9\u76ee\u6807\u8868\u4e5f\u4e0d\u662f\u9501\u5168\u8868\uff0c\u800c\u662f\u53ea\u9501\u4f4f\u9700\u8981\u8bbf\u95ee\u7684\u8d44\u6e90\u3002</p>\n<p>\u5982\u679c\u73b0\u5728\u6709\u8fd9\u4e48\u4e00\u4e2a\u9700\u6c42\uff1a\u8981\u5f80\u8868 t2 \u4e2d\u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u8fd9\u4e00\u884c\u7684 c \u503c\u662f\u8868 t \u4e2d c \u503c\u7684\u6700\u5927\u503c\u52a0 1\u3002</p>\n<p>\u6b64\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u4e48\u5199\u8fd9\u6761 SQL \u8bed\u53e5 \uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\uff0c\u5c31\u662f\u8868 t \u7d22\u5f15 c \u4e0a\u7684 (3,4] \u548c (4,supremum] \u8fd9\u4e24\u4e2a next-key lock\uff0c\u4ee5\u53ca\u4e3b\u952e\u7d22\u5f15\u4e0a id=4 \u8fd9\u4e00\u884c\u3002</p>\n<p>\u5b83\u7684\u6267\u884c\u6d41\u7a0b\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u4ece\u8868 t \u4e2d\u6309\u7167\u7d22\u5f15 c \u5012\u5e8f\uff0c\u626b\u63cf\u7b2c\u4e00\u884c\uff0c\u62ff\u5230\u7ed3\u679c\u5199\u5165\u5230\u8868 t2 \u4e2d\u3002</p>\n<p>\u56e0\u6b64\u6574\u6761\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u662f 1\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u662f\u8981\u628a\u8fd9\u6837\u7684\u4e00\u884c\u6570\u636e\u63d2\u5165\u5230\u8868 t \u4e2d\u7684\u8bdd\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u600e\u6837\u7684\uff1f\u626b\u63cf\u884c\u6570\u53c8\u662f\u591a\u5c11\u5462\uff1f</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u518d\u770b\u6162\u67e5\u8be2\u65e5\u5fd7\u5c31\u4f1a\u53d1\u73b0\u4e0d\u5bf9\u4e86\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"o\">#</span><span class=\"w\"> </span><span class=\"n\">Query_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">001429</span><span class=\"w\">  </span><span class=\"n\">Lock_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">000213</span><span class=\"w\"> </span><span class=\"n\">Rows_sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"n\">Rows_examined</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"k\">SET</span><span class=\"w\"> </span><span class=\"k\">timestamp</span><span class=\"o\">=</span><span class=\"mi\">1675306887</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u7684 Rows_examined \u7684\u503c\u662f 5\u3002</p>\n<p>\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u63d0\u5230\u8fc7\uff0c\u5e0c\u671b\u4f60\u90fd\u80fd\u591f\u5b66\u4f1a\u7528 explain \u7684\u7ed3\u679c\u6765\u201c\u8111\u8865\u201d\u6574\u6761\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u4e00\u8d77\u8bd5\u8bd5\u3002</p>\n<p>\u5982\u56fe 4 \u6240\u793a\u5c31\u662f\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">explain</span><span class=\"w\"> </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">select_type</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">partitions</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">possible_keys</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">key_len</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">rows</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Extra</span><span class=\"w\">                                </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">INSERT</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">ALL</span><span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">                                 </span><span class=\"o\">|</span>\n<span class=\"o\">|</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">SIMPLE</span><span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\">     </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">       </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">NULL</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"mi\">100</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">Backward</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"w\"> </span><span class=\"n\">scan</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">Using</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+</span>\n</code></pre></div>\n<p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\u201cUsing temporary\u201d\u5b57\u6837\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u7528\u5230\u4e86\u4e34\u65f6\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u628a\u8868 t \u7684\u5185\u5bb9\u8bfb\u51fa\u6765\uff0c\u5199\u5165\u4e34\u65f6\u8868\u3002</p>\n<p>\u56fe\u4e2d rows \u663e\u793a\u7684\u662f 1\uff0c\u6211\u4eec\u4e0d\u59a8\u5148\u5bf9\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u505a\u4e00\u4e2a\u731c\u6d4b\uff1a\u5982\u679c\u8bf4\u662f\u628a\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u8bfb\u51fa\u6765\uff08\u626b\u63cf 1 \u884c\uff09\uff0c\u5199\u5165\u4e34\u65f6\u8868\uff0c\u7136\u540e\u518d\u4ece\u4e34\u65f6\u8868\u8bfb\u51fa\u6765\uff08\u626b\u63cf 1 \u884c\uff09\uff0c\u5199\u56de\u8868 t \u4e2d\u3002\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u5c31\u5e94\u8be5\u662f 2\uff0c\u800c\u4e0d\u662f 5\u3002</p>\n<p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u731c\u6d4b\u4e0d\u5bf9\u3002\u5b9e\u9645\u4e0a\uff0cExplain \u7ed3\u679c\u91cc\u7684 rows=1 \u662f\u56e0\u4e3a\u53d7\u5230\u4e86 limit 1 \u7684\u5f71\u54cd\u3002</p>\n<p>\u4ece\u53e6\u4e00\u4e2a\u89d2\u5ea6\u8003\u8651\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b InnoDB \u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002\u5982\u56fe 5 \u6240\u793a\uff0c\u662f\u5728\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u524d\u540e\u67e5\u770b <code>Innodb_rows_read</code> \u7684\u7ed3\u679c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_rows_read&#39;</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Variable_name</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Innodb_rows_read</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">221600</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\">  </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"n\">OK</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"n\">affected</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">warnings</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n<span class=\"n\">Records</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"n\">Duplicates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"n\">Warnings</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"s1\">&#39;Innodb_rows_read&#39;</span><span class=\"p\">;</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Variable_name</span><span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Innodb_rows_read</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">221601</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"o\">+</span><span class=\"c1\">------------------+--------+</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">sec</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u628a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u7406\u6e05\u695a\u4e86\uff1a</p>\n<ol>\n<li>\u521b\u5efa\u4e34\u65f6\u8868\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5 c \u548c d\u3002</li>\n<li>\u6309\u7167\u7d22\u5f15 c \u626b\u63cf\u8868 t\uff0c\u4f9d\u6b21\u53d6 c=4\u30013\u30012\u30011\uff0c\u7136\u540e\u56de\u8868\uff0c\u8bfb\u5230 c \u548c d \u7684\u503c\u5199\u5165\u4e34\u65f6\u8868\u3002\u8fd9\u65f6\uff0cRows_examined=4\u3002</li>\n<li>\u7531\u4e8e\u8bed\u4e49\u91cc\u9762\u6709 limit 1\uff0c\u6240\u4ee5\u53ea\u53d6\u4e86\u4e34\u65f6\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u518d\u63d2\u5165\u5230\u8868 t \u4e2d\u3002\u8fd9\u65f6\uff0cRows_examined \u7684\u503c\u52a0 1\uff0c\u53d8\u6210\u4e86 5\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u5bfc\u81f4\u5728\u8868 t \u4e0a\u505a\u5168\u8868\u626b\u63cf\uff0c\u5e76\u4e14\u4f1a\u7ed9\u7d22\u5f15 c \u4e0a\u7684\u6240\u6709\u95f4\u9699\u90fd\u52a0\u4e0a\u5171\u4eab\u7684 next-key lock\u3002\u6240\u4ee5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u671f\u95f4\uff0c\u5176\u4ed6\u4e8b\u52a1\u4e0d\u80fd\u5728\u8fd9\u4e2a\u8868\u4e0a\u63d2\u5165\u6570\u636e\u3002</p>\n<p>\u81f3\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u4e3a\u4ec0\u4e48\u9700\u8981\u4e34\u65f6\u8868\uff0c\u539f\u56e0\u662f\u8fd9\u7c7b\u4e00\u8fb9\u904d\u5386\u6570\u636e\uff0c\u4e00\u8fb9\u66f4\u65b0\u6570\u636e\u7684\u60c5\u51b5\uff0c\u5982\u679c\u8bfb\u51fa\u6765\u7684\u6570\u636e\u76f4\u63a5\u5199\u56de\u539f\u8868\uff0c\u5c31\u53ef\u80fd\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u8bfb\u5230\u521a\u521a\u63d2\u5165\u7684\u8bb0\u5f55\uff0c\u65b0\u63d2\u5165\u7684\u8bb0\u5f55\u5982\u679c\u53c2\u4e0e\u8ba1\u7b97\u903b\u8f91\uff0c\u5c31\u8ddf\u8bed\u4e49\u4e0d\u7b26\u3002</p>\n<p>\u7531\u4e8e\u5b9e\u73b0\u4e0a\u8fd9\u4e2a\u8bed\u53e5\u6ca1\u6709\u5728\u5b50\u67e5\u8be2\u4e2d\u5c31\u76f4\u63a5\u4f7f\u7528 limit 1\uff0c\u4ece\u800c\u5bfc\u81f4\u4e86\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u9700\u8981\u904d\u5386\u6574\u4e2a\u8868 t\u3002\u5b83\u7684\u4f18\u5316\u65b9\u6cd5\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u662f\u7528\u524d\u9762\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u5148 insert into \u5230\u4e34\u65f6\u8868 temp_t\uff0c\u8fd9\u6837\u5c31\u53ea\u9700\u8981\u626b\u63cf\u4e00\u884c\uff1b\u7136\u540e\u518d\u4ece\u8868 temp_t \u91cc\u9762\u53d6\u51fa\u8fd9\u884c\u6570\u636e\u63d2\u5165\u8868 t1\u3002</p>\n<p>\u5f53\u7136\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u6d89\u53ca\u7684\u6570\u636e\u91cf\u5f88\u5c0f\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u6765\u505a\u8fd9\u4e2a\u4f18\u5316\u3002\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u4f18\u5316\u65f6\uff0c\u8bed\u53e5\u5e8f\u5217\u7684\u5199\u6cd5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">temporary</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">memory</span><span class=\"p\">;</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">force</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"k\">c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">order</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"k\">c</span><span class=\"w\"> </span><span class=\"k\">desc</span><span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">;</span>\n<span class=\"k\">drop</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">temp_t</span><span class=\"p\">;</span>\n</code></pre></div>\n<h3 id=\"_1\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u51e0\u79cd\u7279\u6b8a\u60c5\u51b5\u4e0b\u7684 insert \u8bed\u53e5\u3002</p>\n<p>insert \u2026 select \u662f\u5f88\u5e38\u89c1\u7684\u5728\u4e24\u4e2a\u8868\u4e4b\u95f4\u62f7\u8d1d\u6570\u636e\u7684\u65b9\u6cd5\u3002\u4f60\u9700\u8981\u6ce8\u610f\uff0c\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u7ed9 select \u7684\u8868\u91cc\u626b\u63cf\u5230\u7684\u8bb0\u5f55\u548c\u95f4\u9699\u52a0\u8bfb\u9501\u3002</p>\n<p>\u800c\u5982\u679c insert \u548c select \u7684\u5bf9\u8c61\u662f\u540c\u4e00\u4e2a\u8868\uff0c\u5219\u6709\u53ef\u80fd\u4f1a\u9020\u6210\u5faa\u73af\u5199\u5165\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u5f15\u5165\u7528\u6237\u4e34\u65f6\u8868\u6765\u505a\u4f18\u5316\u3002</p>\n<p>insert \u8bed\u53e5\u5982\u679c\u51fa\u73b0\u552f\u4e00\u952e\u51b2\u7a81\uff0c\u4f1a\u5728\u51b2\u7a81\u7684\u552f\u4e00\u503c\u4e0a\u52a0\u5171\u4eab\u7684 next-key lock(S \u9501)\u3002\u56e0\u6b64\uff0c\u78b0\u5230\u7531\u4e8e\u552f\u4e00\u952e\u7ea6\u675f\u5bfc\u81f4\u62a5\u9519\u540e\uff0c\u8981\u5c3d\u5feb\u63d0\u4ea4\u6216\u56de\u6eda\u4e8b\u52a1\uff0c\u907f\u514d\u52a0\u9501\u65f6\u95f4\u8fc7\u957f\u3002</p>\n<h2 id=\"41\">41 \u600e\u4e48\u6700\u5feb\u5730\u590d\u5236\u4e00\u5f20\u8868\uff1f<a class=\"headerlink\" href=\"#41\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u6700\u540e\uff0c\u7ed9\u4f60\u7559\u4e0b\u7684\u95ee\u9898\u662f\u600e\u4e48\u5728\u4e24\u5f20\u8868\u4e2d\u62f7\u8d1d\u6570\u636e\u3002\u5982\u679c\u53ef\u4ee5\u63a7\u5236\u5bf9\u6e90\u8868\u7684\u626b\u63cf\u884c\u6570\u548c\u52a0\u9501\u8303\u56f4\u5f88\u5c0f\u7684\u8bdd\uff0c\u6211\u4eec\u7b80\u5355\u5730\u4f7f\u7528 <code>insert \u2026 select</code> \u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u3002</p>\n<p>\u5f53\u7136\uff0c\u4e3a\u4e86\u907f\u514d\u5bf9\u6e90\u8868\u52a0\u8bfb\u9501\uff0c\u66f4\u7a33\u59a5\u7684\u65b9\u6848\u662f\u5148\u5c06\u6570\u636e\u5199\u5230\u5916\u90e8\u6587\u672c\u6587\u4ef6\uff0c\u7136\u540e\u518d\u5199\u56de\u76ee\u6807\u8868\u3002\u8fd9\u65f6\uff0c\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u6cd5\u3002\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\uff0c\u6211\u4f1a\u548c\u4f60\u8be6\u7ec6\u5c55\u5f00\u4e00\u4e0b\u8fd9\u4e24\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u8fd8\u662f\u5148\u521b\u5efa\u4e00\u4e2a\u8868 db1.t\uff0c\u5e76\u63d2\u5165 1000 \u884c\u6570\u636e\uff0c\u540c\u65f6\u521b\u5efa\u4e00\u4e2a\u76f8\u540c\u7ed3\u6784\u7684\u8868 db2.t\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">database</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">;</span>\n<span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">;</span><span class=\"w\"> </span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"w\"> </span><span class=\"k\">primary</span><span class=\"w\"> </span><span class=\"k\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">index</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">))</span><span class=\"n\">engine</span><span class=\"o\">=</span><span class=\"n\">innodb</span><span class=\"p\">;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;;</span>\n<span class=\"w\">  </span><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">procedure</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">()</span>\n<span class=\"w\">  </span><span class=\"k\">begin</span>\n<span class=\"w\">    </span><span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">&lt;=</span><span class=\"mi\">1000</span><span class=\"p\">)</span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">insert</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">values</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"n\">i</span><span class=\"p\">);</span>\n<span class=\"w\">      </span><span class=\"k\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">end</span><span class=\"p\">;;</span>\n<span class=\"k\">delimiter</span><span class=\"w\"> </span><span class=\"p\">;</span>\n<span class=\"k\">call</span><span class=\"w\"> </span><span class=\"n\">idata</span><span class=\"p\">();</span><span class=\"w\"> </span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">database</span><span class=\"w\"> </span><span class=\"n\">db2</span><span class=\"p\">;</span>\n<span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">db2</span><span class=\"p\">.</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">like</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">.</span><span class=\"n\">t</span>\n</code></pre></div>\n<p>\u5047\u8bbe\uff0c\u6211\u4eec\u8981\u628a db1.t \u91cc\u9762 a&gt;900 \u7684\u6570\u636e\u884c\u5bfc\u51fa\u6765\uff0c\u63d2\u5165\u5230 db2.t \u4e2d\u3002</p>\n<h3 id=\"mysqldump\">mysqldump \u65b9\u6cd5<a class=\"headerlink\" href=\"#mysqldump\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\uff0c\u4f7f\u7528 mysqldump \u547d\u4ee4\u5c06\u6570\u636e\u5bfc\u51fa\u6210\u4e00\u7ec4 INSERT \u8bed\u53e5\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"err\">$</span><span class=\"w\"> </span><span class=\"n\">mysqldump</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h$host</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P$port</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u$user</span><span class=\"w\"> </span><span class=\"c1\">--add-locks=0 --no-create-info --single-transaction  \\</span>\n<span class=\"w\">  </span><span class=\"c1\">--set-gtid-purged=OFF db1 t --where=&quot;a&gt;900&quot; --result-file=/tmp/t.sql</span>\n</code></pre></div>\n<p>\u628a\u7ed3\u679c\u8f93\u51fa\u5230\u4e34\u65f6\u6587\u4ef6\u3002</p>\n<p>\u8fd9\u6761\u547d\u4ee4\u4e2d\uff0c\u4e3b\u8981\u53c2\u6570\u542b\u4e49\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>\u2013-single-transaction</code> \u7684\u4f5c\u7528\u662f\uff0c\u5728\u5bfc\u51fa\u6570\u636e\u7684\u65f6\u5019\u4e0d\u9700\u8981\u5bf9\u8868 db1.t \u52a0\u8868\u9501\uff0c\u800c\u662f\u4f7f\u7528 START TRANSACTION WITH CONSISTENT SNAPSHOT \u7684\u65b9\u6cd5\uff1b</li>\n<li><code>\u2013-add-locks</code> \u8bbe\u7f6e\u4e3a 0\uff0c\u8868\u793a\u5728\u8f93\u51fa\u7684\u6587\u4ef6\u7ed3\u679c\u91cc\uff0c\u4e0d\u589e\u52a0 <code>LOCK TABLES t WRITE;</code> \uff1b</li>\n<li><code>\u2013-no-create-info</code> \u7684\u610f\u601d\u662f\uff0c\u4e0d\u9700\u8981\u5bfc\u51fa\u8868\u7ed3\u6784\uff1b</li>\n<li><code>-\u2013set-gtid-purged=off</code> \u8868\u793a\u7684\u662f\uff0c\u4e0d\u8f93\u51fa\u8ddf GTID \u76f8\u5173\u7684\u4fe1\u606f\uff1b</li>\n<li><code>-\u2013result-file</code> \u6307\u5b9a\u4e86\u8f93\u51fa\u6587\u4ef6\u7684\u8def\u5f84\u3002</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e00\u6761 INSERT \u8bed\u53e5\u91cc\u9762\u4f1a\u5305\u542b\u591a\u4e2a value \u5bf9\uff0c\u8fd9\u662f\u4e3a\u4e86\u540e\u7eed\u7528\u8fd9\u4e2a\u6587\u4ef6\u6765\u5199\u5165\u6570\u636e\u7684\u65f6\u5019\uff0c\u6267\u884c\u901f\u5ea6\u53ef\u4ee5\u66f4\u5feb\u3002</p>\n<p>\u5982\u679c\u4f60\u5e0c\u671b\u751f\u6210\u7684\u6587\u4ef6\u4e2d\u4e00\u6761 INSERT \u8bed\u53e5\u53ea\u63d2\u5165\u4e00\u884c\u6570\u636e\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728\u6267\u884c mysqldump \u547d\u4ee4\u65f6\uff0c\u52a0\u4e0a\u53c2\u6570 <code>\u2013-skip-extended-insert</code>\u3002</p>\n<p>\u7136\u540e\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff0c\u5c06\u8fd9\u4e9b INSERT \u8bed\u53e5\u653e\u5230 db2 \u5e93\u91cc\u53bb\u6267\u884c\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h127</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P13000</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">uroot</span><span class=\"w\"> </span><span class=\"n\">db2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"ss\">&quot;source /client_tmp/t.sql&quot;</span>\n</code></pre></div>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0csource \u5e76\u4e0d\u662f\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u800c\u662f\u4e00\u4e2a\u5ba2\u6237\u7aef\u547d\u4ee4\u3002mysql \u5ba2\u6237\u7aef\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u6253\u5f00\u6587\u4ef6\uff0c\u9ed8\u8ba4\u4ee5\u5206\u53f7\u4e3a\u7ed3\u5c3e\u8bfb\u53d6\u4e00\u6761\u6761\u7684 SQL \u8bed\u53e5\uff1b</li>\n<li>\u5c06 SQL \u8bed\u53e5\u53d1\u9001\u5230\u670d\u52a1\u7aef\u6267\u884c\u3002</li>\n</ol>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u670d\u52a1\u7aef\u6267\u884c\u7684\u5e76\u4e0d\u662f\u8fd9\u4e2a <code>source t.sql</code> \u8bed\u53e5\uff0c\u800c\u662f INSERT \u8bed\u53e5\u3002\u6240\u4ee5\uff0c\u4e0d\u8bba\u662f\u5728\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\uff0c\u8fd8\u662f\u5728 binlog\uff0c\u8bb0\u5f55\u7684\u90fd\u662f\u8fd9\u4e9b\u8981\u88ab\u771f\u6b63\u6267\u884c\u7684 INSERT \u8bed\u53e5\u3002</p>\n<h3 id=\"csv\">\u5bfc\u51fa CSV \u6587\u4ef6<a class=\"headerlink\" href=\"#csv\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u76f4\u63a5\u5c06\u7ed3\u679c\u5bfc\u51fa\u6210.csv \u6587\u4ef6\u3002MySQL \u63d0\u4f9b\u4e86\u4e0b\u9762\u7684\u8bed\u6cd5\uff0c\u7528\u6765\u5c06\u67e5\u8be2\u7ed3\u679c\u5bfc\u51fa\u5230\u670d\u52a1\u7aef\u672c\u5730\u76ee\u5f55\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">.</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">&gt;</span><span class=\"mi\">900</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"n\">outfile</span><span class=\"w\"> </span><span class=\"s1\">&#39;/server_tmp/t.csv&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u6211\u4eec\u5728\u4f7f\u7528\u8fd9\u6761\u8bed\u53e5\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u5982\u4e0b\u51e0\u70b9\u3002</p>\n<ol>\n<li>\u8fd9\u6761\u8bed\u53e5\u4f1a\u5c06\u7ed3\u679c\u4fdd\u5b58\u5728\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6267\u884c\u547d\u4ee4\u7684\u5ba2\u6237\u7aef\u548c MySQL \u670d\u52a1\u7aef\u4e0d\u5728\u540c\u4e00\u4e2a\u673a\u5668\u4e0a\uff0c\u5ba2\u6237\u7aef\u673a\u5668\u7684\u4e34\u65f6\u76ee\u5f55\u4e0b\u662f\u4e0d\u4f1a\u751f\u6210 t.csv \u6587\u4ef6\u7684\u3002</li>\n<li>into outfile \u6307\u5b9a\u4e86\u6587\u4ef6\u7684\u751f\u6210\u4f4d\u7f6e\uff08<code>/server_tmp/</code>\uff09\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5fc5\u987b\u53d7\u53c2\u6570 <code>secure_file_priv</code> \u7684\u9650\u5236\u3002\u53c2\u6570 <code>secure_file_priv</code> \u7684\u53ef\u9009\u503c\u548c\u4f5c\u7528\u5206\u522b\u662f\uff1a </li>\n<li>\u5982\u679c\u8bbe\u7f6e\u4e3a empty\uff0c\u8868\u793a\u4e0d\u9650\u5236\u6587\u4ef6\u751f\u6210\u7684\u4f4d\u7f6e\uff0c\u8fd9\u662f\u4e0d\u5b89\u5168\u7684\u8bbe\u7f6e\uff1b</li>\n<li>\u5982\u679c\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8868\u793a\u8def\u5f84\u7684\u5b57\u7b26\u4e32\uff0c\u5c31\u8981\u6c42\u751f\u6210\u7684\u6587\u4ef6\u53ea\u80fd\u653e\u5728\u8fd9\u4e2a\u6307\u5b9a\u7684\u76ee\u5f55\uff0c\u6216\u8005\u5b83\u7684\u5b50\u76ee\u5f55\uff1b</li>\n<li>\u5982\u679c\u8bbe\u7f6e\u4e3a NULL\uff0c\u5c31\u8868\u793a\u7981\u6b62\u5728\u8fd9\u4e2a MySQL \u5b9e\u4f8b\u4e0a\u6267\u884c <code>select \u2026 into outfile</code> \u64cd\u4f5c\u3002</li>\n<li>\u8fd9\u6761\u547d\u4ee4\u4e0d\u4f1a\u5e2e\u4f60\u8986\u76d6\u6587\u4ef6\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u786e\u4fdd <code>/server_tmp/t.csv</code> \u8fd9\u4e2a\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5426\u5219\u6267\u884c\u8bed\u53e5\u65f6\u5c31\u4f1a\u56e0\u4e3a\u6709\u540c\u540d\u6587\u4ef6\u7684\u5b58\u5728\u800c\u62a5\u9519\u3002</li>\n<li>\u8fd9\u6761\u547d\u4ee4\u751f\u6210\u7684\u6587\u672c\u6587\u4ef6\u4e2d\uff0c\u539f\u5219\u4e0a\u4e00\u4e2a\u6570\u636e\u884c\u5bf9\u5e94\u6587\u672c\u6587\u4ef6\u7684\u4e00\u884c\u3002\u4f46\u662f\uff0c\u5982\u679c\u5b57\u6bb5\u4e2d\u5305\u542b\u6362\u884c\u7b26\uff0c\u5728\u751f\u6210\u7684\u6587\u672c\u4e2d\u4e5f\u4f1a\u6709\u6362\u884c\u7b26\u3002\u4e0d\u8fc7\u7c7b\u4f3c\u6362\u884c\u7b26\u3001\u5236\u8868\u7b26\u8fd9\u7c7b\u7b26\u53f7\uff0c\u524d\u9762\u90fd\u4f1a\u8ddf\u4e0a <code>\u201c\\\u201d</code>\u8fd9\u4e2a\u8f6c\u4e49\u7b26\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u8ddf\u5b57\u6bb5\u4e4b\u95f4\u3001\u6570\u636e\u884c\u4e4b\u95f4\u7684\u5206\u9694\u7b26\u533a\u5206\u5f00\u3002</li>\n</ol>\n<p>\u5f97\u5230.csv \u5bfc\u51fa\u6587\u4ef6\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u7528\u4e0b\u9762\u7684 load data \u547d\u4ee4\u5c06\u6570\u636e\u5bfc\u5165\u5230\u76ee\u6807\u8868 db2.t \u4e2d\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"k\">data</span><span class=\"w\"> </span><span class=\"n\">infile</span><span class=\"w\"> </span><span class=\"s1\">&#39;/server_tmp/t.csv&#39;</span><span class=\"w\"> </span><span class=\"k\">into</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">db2</span><span class=\"p\">.</span><span class=\"n\">t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\u3002</p>\n<ol>\n<li>\u6253\u5f00\u6587\u4ef6 <code>/server_tmp/t.csv</code>\uff0c\u4ee5\u5236\u8868\u7b26 ( <code>\\t</code>) \u4f5c\u4e3a\u5b57\u6bb5\u95f4\u7684\u5206\u9694\u7b26\uff0c\u4ee5\u6362\u884c\u7b26\uff08 <code>\\n</code>\uff09\u4f5c\u4e3a\u8bb0\u5f55\u4e4b\u95f4\u7684\u5206\u9694\u7b26\uff0c\u8fdb\u884c\u6570\u636e\u8bfb\u53d6\uff1b</li>\n<li>\u542f\u52a8\u4e8b\u52a1\u3002</li>\n<li>\u5224\u65ad\u6bcf\u4e00\u884c\u7684\u5b57\u6bb5\u6570\u4e0e\u8868 db2.t \u662f\u5426\u76f8\u540c\uff1a </li>\n<li>\u82e5\u4e0d\u76f8\u540c\uff0c\u5219\u76f4\u63a5\u62a5\u9519\uff0c\u4e8b\u52a1\u56de\u6eda\uff1b</li>\n<li>\u82e5\u76f8\u540c\uff0c\u5219\u6784\u9020\u6210\u4e00\u884c\uff0c\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\uff0c\u5199\u5165\u5230\u8868\u4e2d\u3002</li>\n<li>\u91cd\u590d\u6b65\u9aa4 3\uff0c\u76f4\u5230 <code>/server_tmp/t.csv</code> \u6574\u4e2a\u6587\u4ef6\u8bfb\u5165\u5b8c\u6210\uff0c\u63d0\u4ea4\u4e8b\u52a1\u3002</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u6709\u4e00\u4e2a\u7591\u95ee\uff0c<strong>\u5982\u679c binlog_format=statement\uff0c\u8fd9\u4e2a load \u8bed\u53e5\u8bb0\u5f55\u5230 binlog \u91cc\u4ee5\u540e\uff0c\u600e\u4e48\u5728\u5907\u5e93\u91cd\u653e\u5462\uff1f</strong></p>\n<p>\u7531\u4e8e <code>/server_tmp/t.csv</code> \u6587\u4ef6\u53ea\u4fdd\u5b58\u5728\u4e3b\u5e93\u6240\u5728\u7684\u4e3b\u673a\u4e0a\uff0c\u5982\u679c\u53ea\u662f\u628a\u8fd9\u6761\u8bed\u53e5\u539f\u6587\u5199\u5230 binlog \u4e2d\uff0c\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u5907\u5e93\u7684\u672c\u5730\u673a\u5668\u4e0a\u6ca1\u6709\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c31\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002</p>\n<p>\u6240\u4ee5\uff0c\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u5176\u5b9e\u662f\u4e0b\u9762\u8fd9\u6837\u7684\u3002</p>\n<ol>\n<li>\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c06 <code>/server_tmp/t.csv</code> \u6587\u4ef6\u7684\u5185\u5bb9\u76f4\u63a5\u5199\u5230 binlog \u6587\u4ef6\u4e2d\u3002</li>\n<li>\u5f80 binlog \u6587\u4ef6\u4e2d\u5199\u5165\u8bed\u53e5 <code>load data local infile '/tmp/SQL_LOAD_MB-1-0' INTO TABLE db2.t</code>\u3002</li>\n<li>\u628a\u8fd9\u4e2a binlog \u65e5\u5fd7\u4f20\u5230\u5907\u5e93\u3002</li>\n<li>\u5907\u5e93\u7684 apply \u7ebf\u7a0b\u5728\u6267\u884c\u8fd9\u4e2a\u4e8b\u52a1\u65e5\u5fd7\u65f6\uff1a </li>\n<li>\u5148\u5c06 binlog \u4e2d t.csv \u6587\u4ef6\u7684\u5185\u5bb9\u8bfb\u51fa\u6765\uff0c\u5199\u5165\u5230\u672c\u5730\u4e34\u65f6\u76ee\u5f55 <code>/tmp/SQL_LOAD_MB-1-0</code>\u4e2d\uff1b </li>\n<li>\u518d\u6267\u884c load data \u8bed\u53e5\uff0c\u5f80\u5907\u5e93\u7684 db2.t \u8868\u4e2d\u63d2\u5165\u8ddf\u4e3b\u5e93\u76f8\u540c\u7684\u6570\u636e\u3002</li>\n</ol>\n<p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u5907\u5e93\u6267\u884c\u7684 load data \u8bed\u53e5\u91cc\u9762\uff0c\u591a\u4e86\u4e00\u4e2a <code>local</code>\u3002\u5b83\u7684\u610f\u601d\u662f\u201c\u5c06\u6267\u884c\u8fd9\u6761\u547d\u4ee4\u7684\u5ba2\u6237\u7aef\u6240\u5728\u673a\u5668\u7684\u672c\u5730\u6587\u4ef6 <code>/tmp/SQL_LOAD_MB-1-0</code> \u7684\u5185\u5bb9\uff0c\u52a0\u8f7d\u5230\u76ee\u6807\u8868 db2.t \u4e2d\u201d\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<strong>load data \u547d\u4ee4\u6709\u4e24\u79cd\u7528\u6cd5</strong>\uff1a</p>\n<ol>\n<li>\u4e0d\u52a0 <code>local</code>\uff0c\u662f\u8bfb\u53d6\u670d\u52a1\u7aef\u7684\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6587\u4ef6\u5fc5\u987b\u5728 <code>secure_file_priv</code> \u6307\u5b9a\u7684\u76ee\u5f55\u6216\u5b50\u76ee\u5f55\u4e0b\uff1b</li>\n<li>\u52a0\u4e0a <code>local</code>\uff0c\u8bfb\u53d6\u7684\u662f\u5ba2\u6237\u7aef\u7684\u6587\u4ef6\uff0c\u53ea\u8981 mysql \u5ba2\u6237\u7aef\u6709\u8bbf\u95ee\u8fd9\u4e2a\u6587\u4ef6\u7684\u6743\u9650\u5373\u53ef\u3002\u8fd9\u65f6\u5019\uff0cMySQL \u5ba2\u6237\u7aef\u4f1a\u5148\u628a\u672c\u5730\u6587\u4ef6\u4f20\u7ed9\u670d\u52a1\u7aef\uff0c\u7136\u540e\u6267\u884c\u4e0a\u8ff0\u7684 load data \u6d41\u7a0b\u3002</li>\n</ol>\n<p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<strong>select \u2026into outfile \u65b9\u6cd5\u4e0d\u4f1a\u751f\u6210\u8868\u7ed3\u6784\u6587\u4ef6</strong>, \u6240\u4ee5\u6211\u4eec\u5bfc\u6570\u636e\u65f6\u8fd8\u9700\u8981\u5355\u72ec\u7684\u547d\u4ee4\u5f97\u5230\u8868\u7ed3\u6784\u5b9a\u4e49\u3002mysqldump \u63d0\u4f9b\u4e86\u4e00\u4e2a<code>-\u2013tab</code> \u53c2\u6570\uff0c\u53ef\u4ee5\u540c\u65f6\u5bfc\u51fa\u8868\u7ed3\u6784\u5b9a\u4e49\u6587\u4ef6\u548c csv \u6570\u636e\u6587\u4ef6\u3002\u8fd9\u6761\u547d\u4ee4\u7684\u4f7f\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysqldump</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">h$host</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P$port</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u$user</span><span class=\"w\"> </span><span class=\"c1\">---single-transaction  --set-gtid-purged=OFF db1 t --where=&quot;a&gt;900&quot; --tab=$secure_file_priv</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u4f1a\u5728 <code>$secure_file_priv</code> \u5b9a\u4e49\u7684\u76ee\u5f55\u4e0b\uff0c\u521b\u5efa\u4e00\u4e2a <code>t.sql</code> \u6587\u4ef6\u4fdd\u5b58\u5efa\u8868\u8bed\u53e5\uff0c\u540c\u65f6\u521b\u5efa\u4e00\u4e2a <code>t.txt</code> \u6587\u4ef6\u4fdd\u5b58 CSV \u6570\u636e\u3002</p>\n<h3 id=\"_2\">\u7269\u7406\u62f7\u8d1d\u65b9\u6cd5<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u6211\u4eec\u63d0\u5230\u7684 mysqldump \u65b9\u6cd5\u548c\u5bfc\u51fa CSV \u6587\u4ef6\u7684\u65b9\u6cd5\uff0c\u90fd\u662f\u903b\u8f91\u5bfc\u6570\u636e\u7684\u65b9\u6cd5\uff0c\u4e5f\u5c31\u662f\u5c06\u6570\u636e\u4ece\u8868 db1.t \u4e2d\u8bfb\u51fa\u6765\uff0c\u751f\u6210\u6587\u672c\uff0c\u7136\u540e\u518d\u5199\u5165\u76ee\u6807\u8868 db2.t \u4e2d\u3002</p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u6709\u7269\u7406\u5bfc\u6570\u636e\u7684\u65b9\u6cd5\u5417\uff1f\u6bd4\u5982\uff0c\u76f4\u63a5\u628a db1.t \u8868\u7684 <code>.frm</code> \u6587\u4ef6\u548c <code>.ibd</code> \u6587\u4ef6\u62f7\u8d1d\u5230 db2 \u76ee\u5f55\u4e0b\uff0c\u662f\u5426\u53ef\u884c\u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\u4e0d\u884c\u7684\u3002</p>\n<p>\u56e0\u4e3a\uff0c\u4e00\u4e2a InnoDB \u8868\uff0c\u9664\u4e86\u5305\u542b\u8fd9\u4e24\u4e2a\u7269\u7406\u6587\u4ef6\u5916\uff0c\u8fd8\u9700\u8981\u5728\u6570\u636e\u5b57\u5178\u4e2d\u6ce8\u518c\u3002\u76f4\u63a5\u62f7\u8d1d\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684\u8bdd\uff0c\u56e0\u4e3a\u6570\u636e\u5b57\u5178\u4e2d\u6ca1\u6709 db2.t \u8fd9\u4e2a\u8868\uff0c\u7cfb\u7edf\u662f\u4e0d\u4f1a\u8bc6\u522b\u548c\u63a5\u53d7\u5b83\u4eec\u7684\u3002</p>\n<p>\u4e0d\u8fc7\uff0c\u5728 MySQL 5.6 \u7248\u672c\u5f15\u5165\u4e86**\u53ef\u4f20\u8f93\u8868\u7a7a\u95f4**(transportable tablespace) \u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u901a\u8fc7\u5bfc\u51fa + \u5bfc\u5165\u8868\u7a7a\u95f4\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u7269\u7406\u62f7\u8d1d\u8868\u7684\u529f\u80fd\u3002</p>\n<p>\u5047\u8bbe\u6211\u4eec\u73b0\u5728\u7684\u76ee\u6807\u662f\u5728 db1 \u5e93\u4e0b\uff0c\u590d\u5236\u4e00\u4e2a\u8ddf\u8868 t \u76f8\u540c\u7684\u8868 r\uff0c\u5177\u4f53\u7684\u6267\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6267\u884c <code>create table r like t</code>\uff0c\u521b\u5efa\u4e00\u4e2a\u76f8\u540c\u8868\u7ed3\u6784\u7684\u7a7a\u8868\uff1b</li>\n<li>\u6267\u884c <code>alter table r discard tablespace</code>\uff0c\u8fd9\u65f6\u5019 r.ibd \u6587\u4ef6\u4f1a\u88ab\u5220\u9664\uff1b</li>\n<li>\u6267\u884c <code>flush table t for export</code>\uff0c\u8fd9\u65f6\u5019 db1 \u76ee\u5f55\u4e0b\u4f1a\u751f\u6210\u4e00\u4e2a t.cfg \u6587\u4ef6\uff1b</li>\n<li>\u5728 db1 \u76ee\u5f55\u4e0b\u6267\u884c <code>cp t.cfg r.cfg; cp t.ibd r.ibd\uff1b</code>\u8fd9\u4e24\u4e2a\u547d\u4ee4\uff08\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u62f7\u8d1d\u5f97\u5230\u7684\u4e24\u4e2a\u6587\u4ef6\uff0cMySQL \u8fdb\u7a0b\u8981\u6709\u8bfb\u5199\u6743\u9650\uff09\uff1b</li>\n<li>\u6267\u884c <code>unlock tables</code>\uff0c\u8fd9\u65f6\u5019 t.cfg \u6587\u4ef6\u4f1a\u88ab\u5220\u9664\uff1b</li>\n<li>\u6267\u884c <code>alter table r import tablespace</code>\uff0c\u5c06\u8fd9\u4e2a <code>r.ibd</code> \u6587\u4ef6\u4f5c\u4e3a\u8868 r \u7684\u65b0\u7684\u8868\u7a7a\u95f4\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6587\u4ef6\u7684\u6570\u636e\u5185\u5bb9\u548c t.ibd \u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u8868 r \u4e2d\u5c31\u6709\u4e86\u548c\u8868 t \u76f8\u540c\u7684\u6570\u636e\u3002</li>\n</ol>\n<p>\u81f3\u6b64\uff0c\u62f7\u8d1d\u8868\u6570\u636e\u7684\u64cd\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002\u8fd9\u4e2a\u6d41\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u56fe\u5982\u4e0b\uff1a</p>\n<p>\u5173\u4e8e\u62f7\u8d1d\u8868\u7684\u8fd9\u4e2a\u6d41\u7a0b\uff0c\u6709\u4ee5\u4e0b\u51e0\u4e2a\u6ce8\u610f\u70b9\uff1a</p>\n<ol>\n<li>\u5728\u7b2c 3 \u6b65\u6267\u884c\u5b8c <code>flsuh table</code> \u547d\u4ee4\u4e4b\u540e\uff0c<code>db1.t</code> \u6574\u4e2a\u8868\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\uff0c\u76f4\u5230\u6267\u884c <code>unlock tables</code> \u547d\u4ee4\u540e\u624d\u91ca\u653e\u8bfb\u9501\uff1b</li>\n<li>\u5728\u6267\u884c <code>import tablespace</code> \u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u8ba9\u6587\u4ef6\u91cc\u7684\u8868\u7a7a\u95f4 id \u548c\u6570\u636e\u5b57\u5178\u4e2d\u7684\u4e00\u81f4\uff0c\u4f1a\u4fee\u6539 r.ibd \u7684\u8868\u7a7a\u95f4 id\u3002\u800c\u8fd9\u4e2a\u8868\u7a7a\u95f4 id \u5b58\u5728\u4e8e\u6bcf\u4e00\u4e2a\u6570\u636e\u9875\u4e2d\u3002\u56e0\u6b64\uff0c\u5982\u679c\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u6587\u4ef6\uff08\u6bd4\u5982 TB \u7ea7\u522b\uff09\uff0c\u6bcf\u4e2a\u6570\u636e\u9875\u90fd\u9700\u8981\u4fee\u6539\uff0c\u6240\u4ee5\u4f60\u4f1a\u770b\u5230\u8fd9\u4e2a import \u8bed\u53e5\u7684\u6267\u884c\u662f\u9700\u8981\u4e00\u4e9b\u65f6\u95f4\u7684\u3002\u5f53\u7136\uff0c\u5982\u679c\u662f\u76f8\u6bd4\u4e8e\u903b\u8f91\u5bfc\u5165\u7684\u65b9\u6cd5\uff0cimport \u8bed\u53e5\u7684\u8017\u65f6\u662f\u975e\u5e38\u77ed\u7684\u3002</li>\n</ol>\n<h3 id=\"_3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e09\u79cd\u5c06\u4e00\u4e2a\u8868\u7684\u6570\u636e\u5bfc\u5165\u5230\u53e6\u5916\u4e00\u4e2a\u8868\u4e2d\u7684\u65b9\u6cd5\u3002</p>\n<p>\u6211\u4eec\u6765\u5bf9\u6bd4\u4e00\u4e0b\u8fd9\u4e09\u79cd\u65b9\u6cd5\u7684\u4f18\u7f3a\u70b9\u3002</p>\n<ol>\n<li>\u7269\u7406\u62f7\u8d1d\u7684\u65b9\u5f0f\u901f\u5ea6\u6700\u5feb\uff0c\u5c24\u5176\u5bf9\u4e8e\u5927\u8868\u62f7\u8d1d\u6765\u8bf4\u662f\u6700\u5feb\u7684\u65b9\u6cd5\u3002\u5982\u679c\u51fa\u73b0\u8bef\u5220\u8868\u7684\u60c5\u51b5\uff0c\u7528\u5907\u4efd\u6062\u590d\u51fa\u8bef\u5220\u4e4b\u524d\u7684\u4e34\u65f6\u5e93\uff0c\u7136\u540e\u518d\u628a\u4e34\u65f6\u5e93\u4e2d\u7684\u8868\u62f7\u8d1d\u5230\u751f\u4ea7\u5e93\u4e0a\uff0c\u662f\u6062\u590d\u6570\u636e\u6700\u5feb\u7684\u65b9\u6cd5\u3002\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7684\u4f7f\u7528\u4e5f\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\uff1a </li>\n<li>\u5fc5\u987b\u662f\u5168\u8868\u62f7\u8d1d\uff0c\u4e0d\u80fd\u53ea\u62f7\u8d1d\u90e8\u5206\u6570\u636e\uff1b</li>\n<li>\u9700\u8981\u5230\u670d\u52a1\u5668\u4e0a\u62f7\u8d1d\u6570\u636e\uff0c\u5728\u7528\u6237\u65e0\u6cd5\u767b\u5f55\u6570\u636e\u5e93\u4e3b\u673a\u7684\u573a\u666f\u4e0b\u65e0\u6cd5\u4f7f\u7528\uff1b</li>\n<li>\u7531\u4e8e\u662f\u901a\u8fc7\u62f7\u8d1d\u7269\u7406\u6587\u4ef6\u5b9e\u73b0\u7684\uff0c\u6e90\u8868\u548c\u76ee\u6807\u8868\u90fd\u662f\u4f7f\u7528 InnoDB \u5f15\u64ce\u65f6\u624d\u80fd\u4f7f\u7528\u3002</li>\n<li>\u7528 mysqldump \u751f\u6210\u5305\u542b INSERT \u8bed\u53e5\u6587\u4ef6\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728 where \u53c2\u6570\u589e\u52a0\u8fc7\u6ee4\u6761\u4ef6\uff0c\u6765\u5b9e\u73b0\u53ea\u5bfc\u51fa\u90e8\u5206\u6570\u636e\u3002\u8fd9\u4e2a\u65b9\u5f0f\u7684\u4e0d\u8db3\u4e4b\u4e00\u662f\uff0c\u4e0d\u80fd\u4f7f\u7528 join \u8fd9\u79cd\u6bd4\u8f83\u590d\u6742\u7684 where \u6761\u4ef6\u5199\u6cd5\u3002</li>\n<li>\u7528 <code>select \u2026 into outfile</code> \u7684\u65b9\u6cd5\u662f\u6700\u7075\u6d3b\u7684\uff0c\u652f\u6301\u6240\u6709\u7684 SQL \u5199\u6cd5\u3002\u4f46\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u7f3a\u70b9\u4e4b\u4e00\u5c31\u662f\uff0c\u6bcf\u6b21\u53ea\u80fd\u5bfc\u51fa\u4e00\u5f20\u8868\u7684\u6570\u636e\uff0c\u800c\u4e14\u8868\u7ed3\u6784\u4e5f\u9700\u8981\u53e6\u5916\u7684\u8bed\u53e5\u5355\u72ec\u5907\u4efd\u3002</li>\n</ol>\n<p>\u540e\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u903b\u8f91\u5907\u4efd\u65b9\u5f0f\uff0c\u662f\u53ef\u4ee5\u8de8\u5f15\u64ce\u4f7f\u7528\u7684\u3002</p>\n<h2 id=\"42-grantflush-privileges\">42 grant\u4e4b\u540e\u8981\u8ddf\u7740flush privileges\u5417\uff1f<a class=\"headerlink\" href=\"#42-grantflush-privileges\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 MySQL \u91cc\u9762\uff0cgrant \u8bed\u53e5\u662f\u7528\u6765\u7ed9\u7528\u6237\u8d4b\u6743\u7684\u3002\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u89c1\u8fc7\u4e00\u4e9b\u64cd\u4f5c\u6587\u6863\u91cc\u9762\u63d0\u5230\uff0cgrant \u4e4b\u540e\u8981\u9a6c\u4e0a\u8ddf\u7740\u6267\u884c\u4e00\u4e2a flush privileges \u547d\u4ee4\uff0c\u624d\u80fd\u4f7f\u8d4b\u6743\u8bed\u53e5\u751f\u6548\u3002\u6211\u6700\u5f00\u59cb\u4f7f\u7528 MySQL \u7684\u65f6\u5019\uff0c\u5c31\u662f\u7167\u7740\u4e00\u4e2a\u64cd\u4f5c\u6587\u6863\u7684\u8bf4\u660e\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\u64cd\u4f5c\u7684\u3002</p>\n<p>\u90a3\u4e48\uff0cgrant \u4e4b\u540e\u771f\u7684\u9700\u8981\u6267\u884c flush privileges \u5417\uff1f\u5982\u679c\u6ca1\u6709\u6267\u884c\u8fd9\u4e2a flush \u547d\u4ee4\u7684\u8bdd\uff0c\u8d4b\u6743\u8bed\u53e5\u771f\u7684\u4e0d\u80fd\u751f\u6548\u5417\uff1f</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e0b grant \u8bed\u53e5\u548c flush privileges \u8bed\u53e5\u5206\u522b\u505a\u4e86\u4ec0\u4e48\u4e8b\u60c5\uff0c\u7136\u540e\u518d\u4e00\u8d77\u6765\u5206\u6790\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u5148\u521b\u5efa\u4e00\u4e2a\u7528\u6237\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">user</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"n\">identified</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"s1\">&#39;pa&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u505a\u4e86\u4e24\u4e2a\u52a8\u4f5c\uff1a</p>\n<ol>\n<li>\u78c1\u76d8\u4e0a\uff0c\u5f80 <code>mysql.user</code> \u8868\u91cc\u63d2\u5165\u4e00\u884c\uff0c\u7531\u4e8e\u6ca1\u6709\u6307\u5b9a\u6743\u9650\uff0c\u6240\u4ee5\u8fd9\u884c\u6570\u636e\u4e0a\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u662f N\uff1b</li>\n<li>\u5185\u5b58\u91cc\uff0c\u5f80\u6570\u7ec4 <code>acl_users</code> \u91cc\u63d2\u5165\u4e00\u4e2a <code>acl_user</code> \u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7684 access \u5b57\u6bb5\u503c\u4e3a 0\u3002</li>\n</ol>\n<p>\u56fe 1 \u5c31\u662f\u8fd9\u4e2a\u65f6\u523b\u7528\u6237 ua \u5728 user \u8868\u4e2d\u7684\u72b6\u6001\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"p\">.</span><span class=\"k\">user</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">user</span><span class=\"o\">=</span><span class=\"s1\">&#39;ua&#39;</span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">                    </span><span class=\"k\">Host</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">%</span>\n<span class=\"w\">                    </span><span class=\"k\">User</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">ua</span>\n<span class=\"w\">             </span><span class=\"n\">Select_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">             </span><span class=\"n\">Insert_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">             </span><span class=\"n\">Update_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">             </span><span class=\"n\">Delete_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">             </span><span class=\"n\">Create_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">               </span><span class=\"n\">Drop_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">             </span><span class=\"n\">Reload_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">           </span><span class=\"n\">Shutdown_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">            </span><span class=\"n\">Process_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">               </span><span class=\"n\">File_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">              </span><span class=\"n\">Grant_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">         </span><span class=\"n\">References_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">              </span><span class=\"n\">Index_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">              </span><span class=\"n\">Alter_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">            </span><span class=\"n\">Show_db_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">              </span><span class=\"n\">Super_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">   </span><span class=\"n\">Create_tmp_table_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">        </span><span class=\"n\">Lock_tables_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">            </span><span class=\"n\">Execute_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">         </span><span class=\"n\">Repl_slave_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">        </span><span class=\"n\">Repl_client_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">        </span><span class=\"n\">Create_view_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">          </span><span class=\"n\">Show_view_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">     </span><span class=\"n\">Create_routine_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">      </span><span class=\"n\">Alter_routine_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">        </span><span class=\"n\">Create_user_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">              </span><span class=\"n\">Event_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">            </span><span class=\"n\">Trigger_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"n\">Create_tablespace_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">                </span><span class=\"n\">ssl_type</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"n\">ssl_cipher</span><span class=\"p\">:</span>\n<span class=\"w\">             </span><span class=\"n\">x509_issuer</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"n\">x509_subject</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"n\">max_questions</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">             </span><span class=\"n\">max_updates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">         </span><span class=\"n\">max_connections</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">max_user_connections</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">                  </span><span class=\"n\">plugin</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">caching_sha2_password</span>\n<span class=\"w\">   </span><span class=\"n\">authentication_string</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"err\">$</span><span class=\"n\">A$005$</span>\n<span class=\"o\">%</span><span class=\"n\">P</span><span class=\"p\">:</span><span class=\"n\">eJ8</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"mi\">7</span><span class=\"n\">_</span><span class=\"err\">{</span><span class=\"n\">P</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"n\">QQ3BFIVgLLcQ6MWmI61WcjMGnKMpgk9RGdANON2Pn6NB</span>\n<span class=\"w\">        </span><span class=\"n\">password_expired</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">   </span><span class=\"n\">password_last_changed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">:</span><span class=\"mi\">33</span><span class=\"p\">:</span><span class=\"mi\">19</span>\n<span class=\"w\">       </span><span class=\"n\">password_lifetime</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">          </span><span class=\"n\">account_locked</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">        </span><span class=\"n\">Create_role_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">          </span><span class=\"n\">Drop_role_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"n\">Password_reuse_history</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">     </span><span class=\"n\">Password_reuse_time</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"n\">Password_require_current</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n<span class=\"w\">         </span><span class=\"n\">User_attributes</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">NULL</span>\n</code></pre></div>\n<p>\u5728 MySQL \u4e2d\uff0c\u7528\u6237\u6743\u9650\u662f\u6709\u4e0d\u540c\u7684\u8303\u56f4\u7684\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u6309\u7167\u7528\u6237\u6743\u9650\u8303\u56f4\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u4f9d\u6b21\u548c\u4f60\u8bf4\u660e\u3002</p>\n<h3 id=\"_4\">\u5168\u5c40\u6743\u9650<a class=\"headerlink\" href=\"#_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5168\u5c40\u6743\u9650\uff0c\u4f5c\u7528\u4e8e\u6574\u4e2a MySQL \u5b9e\u4f8b\uff0c\u8fd9\u4e9b\u6743\u9650\u4fe1\u606f\u4fdd\u5b58\u5728 mysql \u5e93\u7684 user \u8868\u91cc\u3002\u5982\u679c\u6211\u8981\u7ed9\u7528\u6237 ua \u8d4b\u4e00\u4e2a\u6700\u9ad8\u6743\u9650\u7684\u8bdd\uff0c\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">all</span><span class=\"w\"> </span><span class=\"k\">privileges</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">option</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u4e2a grant \u547d\u4ee4\u505a\u4e86\u4e24\u4e2a\u52a8\u4f5c\uff1a</p>\n<ol>\n<li>\u78c1\u76d8\u4e0a\uff0c\u5c06 <code>mysql.user</code> \u8868\u91cc\uff0c\u7528\u6237 <code>'ua'@'%'</code>\u8fd9\u4e00\u884c\u7684\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u4fee\u6539\u4e3a <code>Y</code>\uff1b</li>\n<li>\u5185\u5b58\u91cc\uff0c\u4ece\u6570\u7ec4 <code>acl_users</code> \u4e2d\u627e\u5230\u8fd9\u4e2a\u7528\u6237\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5c06 access \u503c\uff08\u6743\u9650\u4f4d\uff09\u4fee\u6539\u4e3a\u4e8c\u8fdb\u5236\u7684\u201c\u5168 1\u201d\u3002</li>\n</ol>\n<p>\u5728\u8fd9\u4e2a grant \u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5982\u679c\u6709\u65b0\u7684\u5ba2\u6237\u7aef\u4f7f\u7528\u7528\u6237\u540d ua \u767b\u5f55\u6210\u529f\uff0cMySQL \u4f1a\u4e3a\u65b0\u8fde\u63a5\u7ef4\u62a4\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u7136\u540e\u4ece <code>acl_users</code> \u6570\u7ec4\u91cc\u67e5\u5230\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\uff0c\u5e76\u5c06\u6743\u9650\u503c\u62f7\u8d1d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\u3002\u4e4b\u540e\u5728\u8fd9\u4e2a\u8fde\u63a5\u4e2d\u6267\u884c\u7684\u8bed\u53e5\uff0c\u6240\u6709\u5173\u4e8e\u5168\u5c40\u6743\u9650\u7684\u5224\u65ad\uff0c\u90fd\u76f4\u63a5\u4f7f\u7528\u7ebf\u7a0b\u5bf9\u8c61\u5185\u90e8\u4fdd\u5b58\u7684\u6743\u9650\u4f4d\u3002</p>\n<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u5206\u6790\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff1a</p>\n<ol>\n<li>grant \u547d\u4ee4\u5bf9\u4e8e\u5168\u5c40\u6743\u9650\uff0c\u540c\u65f6\u66f4\u65b0\u4e86\u78c1\u76d8\u548c\u5185\u5b58\u3002\u547d\u4ee4\u5b8c\u6210\u540e\u5373\u65f6\u751f\u6548\uff0c\u63a5\u4e0b\u6765\u65b0\u521b\u5efa\u7684\u8fde\u63a5\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u3002</li>\n<li>\u5bf9\u4e8e\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\uff0c\u5b83\u7684\u5168\u5c40\u6743\u9650\u4e0d\u53d7 grant \u547d\u4ee4\u7684\u5f71\u54cd\u3002</li>\n</ol>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c<strong>\u4e00\u822c\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u8981\u5408\u7406\u63a7\u5236\u7528\u6237\u6743\u9650\u7684\u8303\u56f4</strong>\u3002\u6211\u4eec\u4e0a\u9762\u7528\u5230\u7684\u8fd9\u4e2a grant \u8bed\u53e5\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u9519\u8bef\u793a\u8303\u3002\u5982\u679c\u4e00\u4e2a\u7528\u6237\u6709\u6240\u6709\u6743\u9650\uff0c\u4e00\u822c\u5c31\u4e0d\u5e94\u8be5\u8bbe\u7f6e\u4e3a\u6240\u6709 IP \u5730\u5740\u90fd\u53ef\u4ee5\u8bbf\u95ee\u3002</p>\n<p>\u5982\u679c\u8981\u56de\u6536\u4e0a\u9762\u7684 grant \u8bed\u53e5\u8d4b\u4e88\u7684\u6743\u9650\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">revoke</span><span class=\"w\"> </span><span class=\"k\">all</span><span class=\"w\"> </span><span class=\"k\">privileges</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6761 revoke \u547d\u4ee4\u7684\u7528\u6cd5\u4e0e grant \u7c7b\u4f3c\uff0c\u505a\u4e86\u5982\u4e0b\u4e24\u4e2a\u52a8\u4f5c\uff1a</p>\n<ol>\n<li>\u78c1\u76d8\u4e0a\uff0c\u5c06 <code>mysql.user</code> \u8868\u91cc\uff0c\u7528\u6237 <code>'ua'@'%'</code> \u8fd9\u4e00\u884c\u7684\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u4fee\u6539\u4e3a <code>N</code>\uff1b</li>\n<li>\u5185\u5b58\u91cc\uff0c\u4ece\u6570\u7ec4 acl_users \u4e2d\u627e\u5230\u8fd9\u4e2a\u7528\u6237\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5c06 access \u7684\u503c\u4fee\u6539\u4e3a 0\u3002</li>\n</ol>\n<h3 id=\"db\">db \u6743\u9650<a class=\"headerlink\" href=\"#db\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86\u5168\u5c40\u6743\u9650\uff0cMySQL \u4e5f\u652f\u6301\u5e93\u7ea7\u522b\u7684\u6743\u9650\u5b9a\u4e49\u3002\u5982\u679c\u8981\u8ba9\u7528\u6237 ua \u62e5\u6709\u5e93 db1 \u7684\u6240\u6709\u6743\u9650\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">all</span><span class=\"w\"> </span><span class=\"k\">privileges</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">option</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u57fa\u4e8e\u5e93\u7684\u6743\u9650\u8bb0\u5f55\u4fdd\u5b58\u5728 mysql.db \u8868\u4e2d\uff0c\u5728\u5185\u5b58\u91cc\u5219\u4fdd\u5b58\u5728\u6570\u7ec4 acl_dbs \u4e2d\u3002\u8fd9\u6761 grant \u547d\u4ee4\u505a\u4e86\u5982\u4e0b\u4e24\u4e2a\u52a8\u4f5c\uff1a</p>\n<ol>\n<li>\u78c1\u76d8\u4e0a\uff0c\u5f80 <code>mysql.db</code> \u8868\u4e2d\u63d2\u5165\u4e86\u4e00\u884c\u8bb0\u5f55\uff0c\u6240\u6709\u6743\u9650\u4f4d\u5b57\u6bb5\u8bbe\u7f6e\u4e3a <code>Y</code>\uff1b</li>\n<li>\u5185\u5b58\u91cc\uff0c\u589e\u52a0\u4e00\u4e2a\u5bf9\u8c61\u5230\u6570\u7ec4 <code>acl_dbs</code> \u4e2d\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7684\u6743\u9650\u4f4d\u4e3a\u201c\u5168 1\u201d\u3002</li>\n</ol>\n<p>\u56fe 2 \u5c31\u662f\u8fd9\u4e2a\u65f6\u523b\u7528\u6237 ua \u5728 db \u8868\u4e2d\u7684\u72b6\u6001\u3002</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"n\">mysql</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">mysql</span><span class=\"p\">.</span><span class=\"n\">db</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">user</span><span class=\"o\">=</span><span class=\"s1\">&#39;ua&#39;</span><span class=\"err\">\\</span><span class=\"k\">G</span><span class=\"p\">;</span>\n<span class=\"o\">***************************</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">row</span><span class=\"w\"> </span><span class=\"o\">***************************</span>\n<span class=\"w\">                 </span><span class=\"k\">Host</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">%</span>\n<span class=\"w\">                   </span><span class=\"n\">Db</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">db1</span>\n<span class=\"w\">                 </span><span class=\"k\">User</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">ua</span>\n<span class=\"w\">          </span><span class=\"n\">Select_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">          </span><span class=\"n\">Insert_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">          </span><span class=\"n\">Update_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">          </span><span class=\"n\">Delete_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">          </span><span class=\"n\">Create_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">            </span><span class=\"n\">Drop_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">           </span><span class=\"n\">Grant_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">      </span><span class=\"n\">References_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">           </span><span class=\"n\">Index_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">           </span><span class=\"n\">Alter_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"n\">Create_tmp_table_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">     </span><span class=\"n\">Lock_tables_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">     </span><span class=\"n\">Create_view_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">       </span><span class=\"n\">Show_view_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">  </span><span class=\"n\">Create_routine_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">   </span><span class=\"n\">Alter_routine_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">         </span><span class=\"n\">Execute_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">           </span><span class=\"n\">Event_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">         </span><span class=\"n\">Trigger_priv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n</code></pre></div>\n<p>\u6bcf\u6b21\u9700\u8981\u5224\u65ad\u4e00\u4e2a\u7528\u6237\u5bf9\u4e00\u4e2a\u6570\u636e\u5e93\u8bfb\u5199\u6743\u9650\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u904d\u5386\u4e00\u6b21 <code>acl_dbs</code> \u6570\u7ec4\uff0c\u6839\u636e user\u3001host \u548c db \u627e\u5230\u5339\u914d\u7684\u5bf9\u8c61\uff0c\u7136\u540e\u6839\u636e\u5bf9\u8c61\u7684\u6743\u9650\u4f4d\u6765\u5224\u65ad\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0cgrant \u4fee\u6539 db \u6743\u9650\u7684\u65f6\u5019\uff0c\u662f\u540c\u65f6\u5bf9\u78c1\u76d8\u548c\u5185\u5b58\u751f\u6548\u7684\u3002</p>\n<p>grant \u64cd\u4f5c\u5bf9\u4e8e\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\u7684\u5f71\u54cd\uff0c\u5728\u5168\u5c40\u6743\u9650\u548c\u57fa\u4e8e db \u7684\u6743\u9650\u6548\u679c\u662f\u4e0d\u540c\u7684\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u505a\u4e00\u4e2a\u5bf9\u7167\u8bd5\u9a8c\u6765\u5206\u522b\u770b\u4e00\u4e0b\u3002</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>session A</th>\n<th>session B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>connect(root, root);<br />create databse db1;<br />create user 'ua'@'%' identified by 'pa';<br />grant super on *.* to 'ua'@'%';<br />grant all privileges on db1.* to 'ua'@'%';</td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>connect(ua,pa);<br />set global sync_binlog=1;<br />(Query OK)<br />create table db1.t(c int);<br />(Query OK)</td>\n</tr>\n<tr>\n<td>T3</td>\n<td>revoke super on <em>.</em> from 'ua'@'%';</td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td>set global sync_binlog=1;<br />(Query OK)<br />alter table db1.t engine=innodb;<br />(Query OK)</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>revoke all privileges on db1.* from 'ua'@'%';</td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td></td>\n<td>set global sync_binlog=1;<br />(Query OK)<br />alter table db1.t engine=innodb;<br />(ALTER command denied)</td>\n</tr>\n</tbody>\n</table>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u56fe\u4e2d <code>set global sync_binlog</code> \u8fd9\u4e2a\u64cd\u4f5c\u662f\u9700\u8981 super \u6743\u9650\u7684\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u867d\u7136\u7528\u6237 ua \u7684 super \u6743\u9650\u5728 T3 \u65f6\u523b\u5df2\u7ecf\u901a\u8fc7 revoke \u8bed\u53e5\u56de\u6536\u4e86\uff0c\u4f46\u662f\u5728 T4 \u65f6\u523b\u6267\u884c set global \u7684\u65f6\u5019\uff0c\u6743\u9650\u9a8c\u8bc1\u8fd8\u662f\u901a\u8fc7\u4e86\u3002\u8fd9\u662f\u56e0\u4e3a super \u662f\u5168\u5c40\u6743\u9650\uff0c\u8fd9\u4e2a\u6743\u9650\u4fe1\u606f\u5728\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\uff0c\u800c revoke \u64cd\u4f5c\u5f71\u54cd\u4e0d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\u3002</p>\n<p>\u800c\u5728 T5 \u65f6\u523b\u53bb\u6389 ua \u5bf9 db1 \u5e93\u7684\u6240\u6709\u6743\u9650\u540e\uff0c\u5728 T6 \u65f6\u523b session B \u518d\u64cd\u4f5c db1 \u5e93\u7684\u8868\uff0c\u5c31\u4f1a\u62a5\u9519\u201c\u6743\u9650\u4e0d\u8db3\u201d\u3002\u8fd9\u662f\u56e0\u4e3a <code>acl_dbs</code> \u662f\u4e00\u4e2a\u5168\u5c40\u6570\u7ec4\uff0c\u6240\u6709\u7ebf\u7a0b\u5224\u65ad db \u6743\u9650\u90fd\u7528\u8fd9\u4e2a\u6570\u7ec4\uff0c\u8fd9\u6837 revoke \u64cd\u4f5c\u9a6c\u4e0a\u5c31\u4f1a\u5f71\u54cd\u5230 session B\u3002</p>\n<h3 id=\"_5\">\u8868\u6743\u9650\u548c\u5217\u6743\u9650<a class=\"headerlink\" href=\"#_5\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86 db \u7ea7\u522b\u7684\u6743\u9650\u5916\uff0cMySQL \u652f\u6301\u66f4\u7ec6\u7c92\u5ea6\u7684\u8868\u6743\u9650\u548c\u5217\u6743\u9650\u3002\u5176\u4e2d\uff0c\u8868\u6743\u9650\u5b9a\u4e49\u5b58\u653e\u5728\u8868 <code>mysql.tables_priv</code> \u4e2d\uff0c\u5217\u6743\u9650\u5b9a\u4e49\u5b58\u653e\u5728\u8868 <code>mysql.columns_priv</code> \u4e2d\u3002\u8fd9\u4e24\u7c7b\u6743\u9650\uff0c\u7ec4\u5408\u8d77\u6765\u5b58\u653e\u5728\u5185\u5b58\u7684 hash \u7ed3\u6784 <code>column_priv_hash</code> \u4e2d\u3002</p>\n<p>\u8fd9\u4e24\u7c7b\u6743\u9650\u7684\u8d4b\u6743\u547d\u4ee4\u5982\u4e0b\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">create</span><span class=\"w\"> </span><span class=\"k\">table</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">.</span><span class=\"n\">t1</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"nb\">int</span><span class=\"p\">);</span><span class=\"w\"> </span>\n<span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">all</span><span class=\"w\"> </span><span class=\"k\">privileges</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"n\">db1</span><span class=\"p\">.</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">option</span><span class=\"p\">;</span>\n<span class=\"k\">GRANT</span><span class=\"w\"> </span><span class=\"k\">SELECT</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">INSERT</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">mydb</span><span class=\"p\">.</span><span class=\"n\">mytbl</span><span class=\"w\"> </span><span class=\"k\">TO</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"k\">option</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8ddf db \u6743\u9650\u7c7b\u4f3c\uff0c\u8fd9\u4e24\u4e2a\u6743\u9650\u6bcf\u6b21 grant \u7684\u65f6\u5019\u90fd\u4f1a\u4fee\u6539\u6570\u636e\u8868\uff0c\u4e5f\u4f1a\u540c\u6b65\u4fee\u6539\u5185\u5b58\u4e2d\u7684 hash \u7ed3\u6784\u3002\u56e0\u6b64\uff0c\u5bf9\u8fd9\u4e24\u7c7b\u6743\u9650\u7684\u64cd\u4f5c\uff0c\u4e5f\u4f1a\u9a6c\u4e0a\u5f71\u54cd\u5230\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\u3002</p>\n<p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u4e00\u5b9a\u4f1a\u95ee\uff0c\u770b\u6765 grant \u8bed\u53e5\u90fd\u662f\u5373\u65f6\u751f\u6548\u7684\uff0c\u90a3\u8fd9\u4e48\u770b\u5e94\u8be5\u5c31\u4e0d\u9700\u8981\u6267\u884c <code>flush privileges</code> \u8bed\u53e5\u4e86\u5440\u3002</p>\n<p>\u7b54\u6848\u4e5f\u786e\u5b9e\u662f\u8fd9\u6837\u7684\u3002</p>\n<p>flush privileges \u547d\u4ee4\u4f1a\u6e05\u7a7a <code>acl_users</code> \u6570\u7ec4\uff0c\u7136\u540e\u4ece <code>mysql.user</code> \u8868\u4e2d\u8bfb\u53d6\u6570\u636e\u91cd\u65b0\u52a0\u8f7d\uff0c\u91cd\u65b0\u6784\u9020\u4e00\u4e2a <code>acl_users</code> \u6570\u7ec4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4ee5\u6570\u636e\u8868\u4e2d\u7684\u6570\u636e\u4e3a\u51c6\uff0c\u4f1a\u5c06\u5168\u5c40\u6743\u9650\u5185\u5b58\u6570\u7ec4\u91cd\u65b0\u52a0\u8f7d\u4e00\u904d\u3002</p>\n<p>\u540c\u6837\u5730\uff0c\u5bf9\u4e8e db \u6743\u9650\u3001\u8868\u6743\u9650\u548c\u5217\u6743\u9650\uff0cMySQL \u4e5f\u505a\u4e86\u8fd9\u6837\u7684\u5904\u7406\u3002</p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5185\u5b58\u7684\u6743\u9650\u6570\u636e\u548c\u78c1\u76d8\u6570\u636e\u8868\u76f8\u540c\u7684\u8bdd\uff0c\u4e0d\u9700\u8981\u6267\u884c flush privileges\u3002\u800c\u5982\u679c\u6211\u4eec\u90fd\u662f\u7528 grant/revoke \u8bed\u53e5\u6765\u6267\u884c\u7684\u8bdd\uff0c\u5185\u5b58\u548c\u6570\u636e\u8868\u672c\u6765\u5c31\u662f\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\u7684\u3002</p>\n<p><strong>\u56e0\u6b64\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0cgrant \u547d\u4ee4\u4e4b\u540e\uff0c\u6ca1\u6709\u5fc5\u8981\u8ddf\u7740\u6267\u884c flush privileges \u547d\u4ee4\u3002</strong></p>\n<h3 id=\"flush-privileges\">flush privileges \u4f7f\u7528\u573a\u666f<a class=\"headerlink\" href=\"#flush-privileges\" title=\"Permanent link\">&para;</a></h3>\n<p>\u90a3\u4e48\uff0cflush privileges \u662f\u5728\u4ec0\u4e48\u65f6\u5019\u4f7f\u7528\u5462\uff1f\u663e\u7136\uff0c\u5f53\u6570\u636e\u8868\u4e2d\u7684\u6743\u9650\u6570\u636e\u8ddf\u5185\u5b58\u4e2d\u7684\u6743\u9650\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\uff0cflush privileges \u8bed\u53e5\u53ef\u4ee5\u7528\u6765\u91cd\u5efa\u5185\u5b58\u6570\u636e\uff0c\u8fbe\u5230\u4e00\u81f4\u72b6\u6001\u3002</p>\n<p>\u8fd9\u79cd\u4e0d\u4e00\u81f4\u5f80\u5f80\u662f\u7531\u4e0d\u89c4\u8303\u7684\u64cd\u4f5c\u5bfc\u81f4\u7684\uff0c\u6bd4\u5982\u76f4\u63a5\u7528 DML \u8bed\u53e5\u64cd\u4f5c\u7cfb\u7edf\u6743\u9650\u8868\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u573a\u666f\uff1a</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>client A</th>\n<th>client B</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T1</td>\n<td>connect(root, root);<br />create user 'ua'@'%' identified by 'pa';</td>\n<td></td>\n</tr>\n<tr>\n<td>T2</td>\n<td></td>\n<td>connect(ua,pa);<br />(connect ok)<br />disconnect</td>\n</tr>\n<tr>\n<td>T3</td>\n<td>delete from mysql.user where user = 'ua';</td>\n<td></td>\n</tr>\n<tr>\n<td>T4</td>\n<td></td>\n<td>connect(ua, pa)<br />(connect ok)<br />disconnect</td>\n</tr>\n<tr>\n<td>T5</td>\n<td>flush privileges;</td>\n<td></td>\n</tr>\n<tr>\n<td>T6</td>\n<td></td>\n<td>connect(ua, pa)<br />(Access Denied)</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cT3 \u65f6\u523b\u867d\u7136\u5df2\u7ecf\u7528 delete \u8bed\u53e5\u5220\u9664\u4e86\u7528\u6237 ua\uff0c\u4f46\u662f\u5728 T4 \u65f6\u523b\uff0c\u4ecd\u7136\u53ef\u4ee5\u7528 ua \u8fde\u63a5\u6210\u529f\u3002\u539f\u56e0\u5c31\u662f\uff0c\u8fd9\u65f6\u5019\u5185\u5b58\u4e2d <code>acl_users</code> \u6570\u7ec4\u4e2d\u8fd8\u6709\u8fd9\u4e2a\u7528\u6237\uff0c\u56e0\u6b64\u7cfb\u7edf\u5224\u65ad\u65f6\u8ba4\u4e3a\u7528\u6237\u8fd8\u6b63\u5e38\u5b58\u5728\u3002</p>\n<p>\u5728 T5 \u65f6\u523b\u6267\u884c\u8fc7 flush \u547d\u4ee4\u540e\uff0c\u5185\u5b58\u66f4\u65b0\uff0cT6 \u65f6\u523b\u518d\u8981\u7528 ua \u6765\u767b\u5f55\u7684\u8bdd\uff0c\u5c31\u4f1a\u62a5\u9519\u201c\u65e0\u6cd5\u8bbf\u95ee\u201d\u4e86\u3002</p>\n<p>\u76f4\u63a5\u64cd\u4f5c\u7cfb\u7edf\u8868\u662f\u4e0d\u89c4\u8303\u7684\u64cd\u4f5c\uff0c\u8fd9\u4e2a\u4e0d\u4e00\u81f4\u72b6\u6001\u4e5f\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u66f4\u201c\u8be1\u5f02\u201d\u7684\u73b0\u8c61\u53d1\u751f\u3002\u6bd4\u5982\uff0c\u524d\u9762\u8fd9\u4e2a\u901a\u8fc7 delete \u8bed\u53e5\u5220\u9664\u7528\u6237\u7684\u4f8b\u5b50\uff0c\u5c31\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684\u60c5\u51b5\uff1a</p>\n<h3 id=\"_6\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#_6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7528\u6237\u6743\u9650\u5728\u6570\u636e\u8868\u548c\u5185\u5b58\u4e2d\u7684\u5b58\u5728\u5f62\u5f0f\uff0c\u4ee5\u53ca grant \u548c revoke \u547d\u4ee4\u7684\u6267\u884c\u903b\u8f91\u3002</p>\n<p>grant \u8bed\u53e5\u4f1a\u540c\u65f6\u4fee\u6539\u6570\u636e\u8868\u548c\u5185\u5b58\uff0c\u5224\u65ad\u6743\u9650\u7684\u65f6\u5019\u4f7f\u7528\u7684\u662f\u5185\u5b58\u6570\u636e\u3002\u56e0\u6b64\uff0c\u89c4\u8303\u5730\u4f7f\u7528 grant \u548c revoke \u8bed\u53e5\uff0c\u662f\u4e0d\u9700\u8981\u968f\u540e\u52a0\u4e0a flush privileges \u8bed\u53e5\u7684\u3002</p>\n<p>flush privileges \u8bed\u53e5\u672c\u8eab\u4f1a\u7528\u6570\u636e\u8868\u7684\u6570\u636e\u91cd\u5efa\u4e00\u4efd\u5185\u5b58\u6743\u9650\u6570\u636e\uff0c\u6240\u4ee5\u5728\u6743\u9650\u6570\u636e\u53ef\u80fd\u5b58\u5728\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u518d\u4f7f\u7528\u3002\u800c\u8fd9\u79cd\u4e0d\u4e00\u81f4\u5f80\u5f80\u662f\u7531\u4e8e\u76f4\u63a5\u7528 DML \u8bed\u53e5\u64cd\u4f5c\u7cfb\u7edf\u6743\u9650\u8868\u5bfc\u81f4\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u8fd9\u7c7b\u8bed\u53e5\u3002</p>\n<p>\u53e6\u5916\uff0c\u5728\u4f7f\u7528 grant \u8bed\u53e5\u8d4b\u6743\u65f6\uff0c\u4f60\u53ef\u80fd\u8fd8\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u5199\u6cd5\uff1a</p>\n<div class=\"highlight\"><pre><span></span><code><span class=\"k\">grant</span><span class=\"w\"> </span><span class=\"n\">super</span><span class=\"w\"> </span><span class=\"k\">on</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">.</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"s1\">&#39;ua&#39;</span><span class=\"o\">@</span><span class=\"s1\">&#39;%&#39;</span><span class=\"w\"> </span><span class=\"n\">identified</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"s1\">&#39;pa&#39;</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>\u8fd9\u6761\u547d\u4ee4\u52a0\u4e86 identified by \u2018\u5bc6\u7801\u2019\uff0c \u8bed\u53e5\u7684\u903b\u8f91\u91cc\u9762\u9664\u4e86\u8d4b\u6743\u5916\uff0c\u8fd8\u5305\u542b\u4e86\uff1a</p>\n<ol>\n<li>\u5982\u679c\u7528\u6237 <code>\u2019ua\u2019@\u2019%'</code>\u4e0d\u5b58\u5728\uff0c\u5c31\u521b\u5efa\u8fd9\u4e2a\u7528\u6237\uff0c\u5bc6\u7801\u662f pa\uff1b</li>\n<li>\u5982\u679c\u7528\u6237 ua \u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u5c06\u5bc6\u7801\u4fee\u6539\u6210 pa\u3002</li>\n</ol>\n<p>\u8fd9\u4e5f\u662f\u4e00\u79cd\u4e0d\u5efa\u8bae\u7684\u5199\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u79cd\u5199\u6cd5\u5f88\u5bb9\u6613\u5c31\u4f1a\u4e0d\u614e\u628a\u5bc6\u7801\u7ed9\u6539\u4e86\u3002</p>\n<p>\u201cgrant \u4e4b\u540e\u968f\u624b\u52a0 flush privileges\u201d\uff0c\u6211\u81ea\u5df1\u662f\u8fd9\u4e48\u4f7f\u7528\u4e86\u4e24\u4e09\u5e74\u4e4b\u540e\uff0c\u5728\u770b\u4ee3\u7801\u7684\u65f6\u5019\u624d\u53d1\u73b0\u5176\u5b9e\u5e76\u4e0d\u9700\u8981\u8fd9\u6837\u505a\uff0c\u90a3\u5df2\u7ecf\u662f 2011 \u5e74\u7684\u4e8b\u60c5\u4e86\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": ["mysql", "tuning"]}, {"id": "https://wgzhao.github.io/notes/courses/time-series-analysis/01-basic/", "url": "https://wgzhao.github.io/notes/courses/time-series-analysis/01-basic/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication", "title": "\u57fa\u7840\u7bc7", "content_html": "<h1 id=\"_1\">\u57fa\u7840\u7bc7<a class=\"headerlink\" href=\"#_1\" title=\"Permanent link\">&para;</a></h1>\n<p><a href=\"https://zhuanlan.zhihu.com/p/38320827\" title=\"Permalink to \u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\uff1a\u57fa\u7840\u7bc7\">Source</a></p>\n<h2 id=\"1\">1 \u524d\u8a00<a class=\"headerlink\" href=\"#1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\uff08time series analysis\uff09\u662f\u91cf\u5316\u6295\u8d44\u4e2d\u7684\u4e00\u95e8\u57fa\u672c\u6280\u672f\u3002\u65f6\u95f4\u5e8f\u5217\u662f\u6307\u5728\u4e00\u5b9a\u65f6\u95f4\u5185\u6309\u65f6\u95f4\u987a\u5e8f\u6d4b\u91cf\u7684\u67d0\u4e2a\u53d8\u91cf\u7684\u53d6\u503c\u5e8f\u5217\u3002\u6bd4\u5982\u53d8\u91cf\u662f\u80a1\u7968\u4ef7\u683c\uff0c\u90a3\u4e48\u5b83\u968f\u65f6\u95f4\u7684\u53d8\u5316\u5c31\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff1b\u540c\u6837\u7684\uff0c\u5982\u679c\u53d8\u91cf\u662f\u80a1\u7968\u7684\u6536\u76ca\u7387\uff0c\u5219\u5b83\u968f\u65f6\u95f4\u7684\u53d8\u5316\u4e5f\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u3002\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5c31\u662f\u4f7f\u7528\u7edf\u8ba1\u7684\u624b\u6bb5\u5bf9\u8fd9\u4e2a\u5e8f\u5217\u7684\u8fc7\u53bb\u8fdb\u884c\u5206\u6790\uff0c\u4ee5\u6b64\u5bf9\u8be5\u53d8\u91cf\u7684\u53d8\u5316\u7279\u6027\u5efa\u6a21\u3001\u5e76\u5bf9\u672a\u6765\u8fdb\u884c\u9884\u6d4b\u3002</p>\n<p><strong>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8bd5\u56fe\u901a\u8fc7\u7814\u7a76\u8fc7\u53bb\u6765\u9884\u6d4b\u672a\u6765\u3002</strong></p>\n<p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u5de5\u7a0b\u5b66\u3001\u7ecf\u6d4e\u5b66\u3001\u6c14\u8c61\u5b66\u3001\u91d1\u878d\u5b66\u7b49\u4f17\u591a\u9886\u57df\u6709\u7740\u5e7f\u6cdb\u7684\u5e94\u7528\u3002\u5728\u91d1\u878d\u5b66\u9886\u57df\uff0c\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4f18\u79c0\u4e66\u7c4d\u5c42\u51fa\u4e0d\u7a77\u3002\u5176\u4e2d\u6700\u5bb6\u55bb\u6237\u6653\u4e4b\u4e00\u7684\u8981\u6570\u7f8e\u56fd\u829d\u52a0\u54e5\u5927\u5b66\u5546\u5b66\u9662 Ruey S. Tsay \u6559\u6388\u64b0\u5199\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790 \u2014\u2014 Analysis of Financial Time Series\uff08\u4e0b\u56fe\uff0c\u8be5\u4e66\u4e5f\u540c\u65f6\u6709\u4e2d\u6587\u7248\uff09\u3002</p>\n<p><img alt=\"IMAGE\" src=\"../../../images/time-series/6BE06889B5CB75DDA809830213D1BAD9.jpg\" /></p>\n<p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8981\u6c42\u4f7f\u7528\u8005\u5177\u5907\u4e00\u5b9a\u7684\u9ad8\u7b49\u6570\u5b66\u77e5\u8bc6\u3002\u7279\u522b\u662f\u5176\u4e2d\u4e00\u4e9b\u9ad8\u7ea7\u7684\u6a21\u578b\uff0c\u5982\u5206\u6790\u6ce2\u52a8\u7387\u7684 ARCH/GARCH \u6a21\u578b\u3001\u6781\u503c\u7406\u8bba\u3001\u8fde\u7eed\u968f\u673a\u8fc7\u7a0b\u3001\u72b6\u6001\u7a7a\u95f4\u6a21\u578b\u7b49\u90fd\u5bf9\u4f7f\u7528\u8005\u7684\u6570\u5b66\u6c34\u5e73\u6709\u7740\u6781\u9ad8\u7684\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u5728\u5f88\u591a\u4eba\u773c\u4e2d\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u65e0\u7591\u5e26\u7740\u539a\u539a\u7684\u9762\u7eb1\uff0c\u4ee4\u4eba\u671b\u800c\u5374\u6b65\u3002</p>\n<p>\u7136\u800c\uff0c\u5982\u679c\u5b66\u4e60\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u89e3\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u70b9\u3001\u719f\u6089\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\u3001\u5e76\u4f7f\u7528\u7ebf\u6027\u4f46\u975e\u5e38\u5b9e\u7528\u7684\u6a21\u578b\uff08\u6bd4\u5982 ARMA \u6a21\u578b\uff09\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u9884\u6d4b\u5e76\u4ee5\u6b64\u5236\u5b9a\u91cf\u5316\u7b56\u7565\uff0c\u90a3\u4e48\u53ea\u8981\u5177\u5907\u7b80\u5355\u7684\u7edf\u8ba1\u5b66\u57fa\u7840\uff0c\u5c31\u5b8c\u5168\u80fd\u591f\u5b9e\u73b0\u8fd9\u4e9b\u76ee\u6807\u3002</p>\n<p>\u51fa\u4e8e\u8fd9\u4e2a\u76ee\u7684\uff0c\u4ece\u672c\u5468\u5f00\u59cb\uff0c\u91cf\u5316\u6838\u6b66\u7814\u7a76\u8fd9\u4e2a\u4e13\u9898\u4e0b\u5c06\u63a8\u51fa\u56db\u7bc7\u6587\u7ae0\uff0c\u6df1\u5165\u6d45\u51fa\u7684\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76f8\u5173\u77e5\u8bc6\u3002\u8be5\u7cfb\u5217\u4e0d\u4f1a\u6d89\u53ca\u4e0a\u9762\u63d0\u5230\u7684\u90a3\u4e9b\u9ad8\u7ea7\u6a21\u578b\uff1b\u76f8\u53cd\u7684\uff0c<strong>\u672c\u7cfb\u5217\u4ee5\u5bf9\u80a1\u7968\u6536\u76ca\u7387\u5efa\u6a21\u5e76\u6784\u5efa\u6295\u8d44\u7b56\u7565\u4e3a\u76ee\u6807\uff0c\u6309\u90e8\u5c31\u73ed\u7684\u628a\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u6807\u6240\u9700\u8981\u7684\u6bcf\u4e00\u5757\u201c\u79ef\u6728\u201d\u6e05\u6670\u5730\u5448\u732e\u7ed9\u8bfb\u8005</strong>\u3002\u8fd9\u56db\u7bc7\u6587\u7ae0\u7684\u7ed3\u6784\u4e3a\uff1a</p>\n<ul>\n<li>\u57fa\u7840\u7bc7\uff08\u672c\u6587\uff09\uff1a\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u6027\u548c\u8fdb\u884c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u5e8f\u5217\u76f8\u5173\u6027\uff08\u53c8\u79f0\u81ea\u76f8\u5173\u6027\uff09\u3002</li>\n<li>\u521d\u7ea7\u7bc7\uff1a\u8bf4\u660e\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u8fc7\u7a0b\uff1b\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6700\u57fa\u672c\u6a21\u578b\uff1a\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u3002</li>\n<li>\u8fdb\u9636\u7bc7\uff1a\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u5e38\u7528\u7684\u7ebf\u6027\u6a21\u578b\uff1aAR\u3001MA\u3001ARMA \u7b49\u3002</li>\n<li>\u5e94\u7528\u7bc7\uff1a\u5229\u7528 ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u6295\u8d44\u7b56\u7565\uff0c\u4ee5\u6b64\u5c55\u793a\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\u7684\u5e94\u7528\u3002</li>\n</ul>\n<p><strong>\u672c\u7cfb\u5217\u6587\u7ae0\u4f1a\u907f\u514d\u8fc7\u591a\u7f57\u5217\u6666\u6da9\u96be\u61c2\u7684\u5927\u6570\u5b66\uff08\u4f46\u4f1a\u6d89\u53ca\u5fc5\u8981\u7684\u6570\u5b66\u77e5\u8bc6\uff09\uff0c\u5e0c\u671b\u5e26\u4f60\u8d70\u5165\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u5927\u95e8\uff0c\u4e3a\u4f60\u4eca\u540e\u5b66\u4e60\u66f4\u9ad8\u7ea7\u7684\u6a21\u578b\u5960\u5b9a\u4e00\u4e9b\u57fa\u7840\u3002</strong></p>\n<p>\u8fd9\u662f\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u3002</p>\n<h2 id=\"2\">2 \u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790<a class=\"headerlink\" href=\"#2\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e3a\u4e86\u907f\u514d\u4e0b\u6587\u4e2d\u6d89\u53ca\u7684\u6982\u5ff5\u8fc7\u4e8e\u62bd\u8c61\uff0c\u6211\u4eec\u5047\u8bbe\u672c\u6587\u8ba8\u8bba\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e3a\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u5e8f\u5217\u3002</p>\n<p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8003\u8651\u7684\u662f\u91d1\u878d\u53d8\u91cf\uff08\u6bd4\u5982\u6295\u8d44\u54c1\u6536\u76ca\u7387\uff09\u968f\u65f6\u95f4\u6f14\u53d8\u7684\u7406\u8bba\u548c\u5b9e\u8df5\u3002\u4efb\u4f55\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u90fd\u5305\u542b\u4e0d\u786e\u5b9a\u56e0\u7d20\uff0c\u56e0\u6b64\u7edf\u8ba1\u5b66\u7684\u7406\u8bba\u548c\u65b9\u6cd5\u5728\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u81f3\u5173\u91cd\u8981\u3002\u91d1\u878d\u8d44\u4ea7\u7684\u65f6\u95f4\u5e8f\u5217\u5e38\u88ab\u770b\u4f5c\u662f\u672a\u77e5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u968f\u65f6\u95f4\u53d8\u5316\u7684\u4e00\u4e2a\u5b9e\u73b0\u3002\u901a\u5e38\u5047\u8bbe\u8be5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u4ec5\u5728\u65f6\u95f4\u8f74\u4e0a\u7684\u79bb\u6563\u70b9\u6709\u5b9a\u4e49\uff0c\u5219\u8be5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u5c31\u662f\u4e00\u4e2a\u79bb\u6563\u968f\u673a\u8fc7\u7a0b\u3002\u6bd4\u5982\u80a1\u7968\u7684\u65e5\u6536\u76ca\u7387\u5c31\u662f\u79bb\u6563\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p>\n<p>\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\uff0c\u6211\u4eec\u7684\u76ee\u6807\u662f\u901a\u8fc7\u7edf\u8ba1\u624b\u6bb5\u5bf9\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u8fd9\u4e2a\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\uff0c\u4ee5\u6b64\u63a8\u65ad\u5e8f\u5217\u4e2d\u4e0d\u540c\u4ea4\u6613\u65e5\u7684\u6536\u76ca\u7387\u4e4b\u95f4\u6709\u65e0\u4efb\u4f55\u7279\u5f81\uff0c\u4ee5\u6b64\u6765\u9884\u6d4b\u672a\u6765\u7684\u6536\u76ca\u7387\u5e76\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3002</p>\n<p>\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u53ef\u80fd\u5b58\u5728\u7684\u7279\u5f81\u5305\u62ec\u4ee5\u4e0b\u51e0\u79cd\uff1a</p>\n<ul>\n<li>\u8d8b\u52bf\uff1a\u8d8b\u52bf\u662f\u65f6\u95f4\u5e8f\u5217\u5728\u67d0\u4e00\u65b9\u5411\u4e0a\u6301\u7eed\u8fd0\u52a8\uff08\u6bd4\u5982\u725b\u5e02\u65f6\u80a1\u5e02\u6bcf\u5929\u90fd\u5728\u4e0a\u6da8\uff0c\u80a1\u7968\u6536\u76ca\u7387\u6301\u7eed\u4e3a\u6b63\uff1b\u718a\u5e02\u65f6\u80a1\u5e02\u6bcf\u5929\u90fd\u5728\u4e0b\u8dcc\uff0c\u80a1\u7968\u6536\u76ca\u7387\u6301\u7eed\u4e3a\u8d1f\uff09\u3002\u8d8b\u52bf\u7ecf\u5e38\u51fa\u73b0\u5728\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e2d\uff0c\u7279\u522b\u662f\u5927\u5b97\u5546\u54c1\u4ef7\u683c\uff1b\u8bb8\u591a\u5546\u54c1\u4ea4\u6613\u987e\u95ee\uff08CTA\uff09\u57fa\u91d1\u5728\u4ed6\u4eec\u7684\u4ea4\u6613\u7b97\u6cd5\u4e2d\u90fd\u4f7f\u7528\u4e86\u590d\u6742\u7684\u8d8b\u52bf\u8bc6\u522b\u6a21\u578b\u3002</li>\n<li>\u5b63\u8282\u53d8\u5316\uff1a\u8bb8\u591a\u65f6\u95f4\u5e8f\u5217\u4e2d\u5305\u542b\u5b63\u8282\u53d8\u5316\u3002\u5728\u91d1\u878d\u9886\u57df\uff0c\u6211\u4eec\u7ecf\u5e38\u770b\u5230\u5546\u54c1\u4ef7\u683c\u7684\u5b63\u8282\u6027\u53d8\u5316\uff0c\u7279\u522b\u662f\u90a3\u4e9b\u4e0e\u751f\u957f\u5b63\u8282\u6216\u6e29\u5ea6\u53d8\u5316\u6709\u5173\u7684\u5546\u54c1\uff0c\u6bd4\u5982\u5929\u7136\u6c14\u3002</li>\n<li>\n<p>\u5e8f\u5217\u76f8\u5173\u6027\uff1a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u4e00\u4e2a\u6700\u91cd\u8981\u7279\u5f81\u662f\u5e8f\u5217\u76f8\u5173\u6027\uff08serial correlation\uff09\uff0c\u53c8\u79f0\u4e3a\u81ea\u76f8\u5173\u6027\uff08autocorrelation\uff09\u3002\u4ee5\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u5e8f\u5217\u4e3a\u4f8b\uff0c\u6211\u4eec\u4f1a\u7ecf\u5e38\u89c2\u5bdf\u5230\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6536\u76ca\u7387\u4e4b\u95f4\u5b58\u5728\u6b63\u76f8\u5173\u6216\u8005\u8d1f\u76f8\u5173\u3002\u6b64\u5916\uff0c\u6ce2\u52a8\u805a\u7c7b\uff08volatility clustering\uff09\u4e5f\u662f\u4e00\u79cd\u5e8f\u5217\u76f8\u5173\u6027\uff0c\u5b83\u610f\u5473\u7740\u9ad8\u6ce2\u52a8\u7684\u9636\u6bb5\u5f80\u5f80\u4f34\u968f\u7740\u9ad8\u6ce2\u52a8\u7684\u9636\u6bb5\u51fa\u73b0\u3001\u4f4e\u6ce2\u52a8\u7684\u9636\u6bb5\u5f80\u5f80\u4f34\u968f\u7740\u4f4e\u6ce2\u52a8\u7684\u9636\u6bb5\u51fa\u73b0\uff0c\u8fd9\u5728\u91cf\u5316\u6295\u8d44\u4e2d\u5c24\u4e3a\u91cd\u8981\u3002\u6bd4\u5982\u4e0b\u56fe\u4e3a 2001 \u5e74\u5230 2017 \u5e74\u4e0a\u8bc1\u6307\u6570\u65e5\u6536\u76ca\u7387\u7684\u6807\u51c6\u5dee\uff0c\u4ece\u4e2d\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u6ce2\u52a8\u805a\u7c7b\u3002</p>\n<p><img alt=\"IMAGE\" src=\"../../../images/time-series/6EA93C0BB263DA344D13CB964597F1DA.jpg\" /></p>\n</li>\n<li>\n<p>\u968f\u673a\u566a\u58f0\uff1a\u5b83\u662f\u65f6\u95f4\u5e8f\u5217\u4e2d\u9664\u53bb\u8d8b\u52bf\u3001\u5b63\u8282\u53d8\u5316\u548c\u81ea\u76f8\u5173\u6027\u4e4b\u540e\u7684\u5269\u4f59\u968f\u673a\u6270\u52a8\u3002\u7531\u4e8e\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u4e0d\u786e\u5b9a\u6027\uff0c\u968f\u673a\u566a\u58f0\u603b\u662f\u5939\u6742\u5728\u65f6\u95f4\u5e8f\u5217\u4e2d\uff0c\u81f4\u4f7f\u65f6\u95f4\u5e8f\u5217\u8868\u73b0\u51fa\u67d0\u79cd\u9707\u8361\u5f0f\u7684\u65e0\u89c4\u5f8b\u8fd0\u52a8\u3002</p>\n</li>\n</ul>\n<p>\u91cf\u5316\u6295\u8d44\u7684\u4ea4\u6613\u8005\u7684\u76ee\u6807\u662f\u5229\u7528\u7edf\u8ba1\u5efa\u6a21\u6765\u8bc6\u522b\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e2d\u6f5c\u5728\u7684\u8d8b\u52bf\u3001\u5b63\u8282\u53d8\u5316\u548c\u5e8f\u5217\u76f8\u5173\u6027\u3002\u5229\u7528\u4e00\u4e2a\u597d\u7684\u6a21\u578b\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4e3b\u8981\u5e94\u7528\u5305\u62ec\uff1a</p>\n<ul>\n<li>\u9884\u6d4b\u672a\u6765\uff1a\u4e3a\u4e86\u6210\u529f\u4ea4\u6613\uff0c\u6211\u4eec\u9700\u8981\u5728 <strong>\u7edf\u8ba1\u4e0a</strong> \u201c\u51c6\u786e\u201d\u9884\u6d4b\u672a\u6765\u7684\u6295\u8d44\u54c1\u4ef7\u683c\u6216\u8005\u6536\u76ca\u7387\u3002</li>\n<li>\u5e8f\u5217\u6a21\u62df\uff1a\u4e00\u65e6\u53d1\u73b0\u4e86\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7edf\u8ba1\u7279\u5f81\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u6765\u6a21\u62df\u65f6\u95f4\u5e8f\u5217\u5e76\u8fdb\u884c\u573a\u666f\u5206\u6790\u3002\u8fd9\u5bf9\u4e8e\u4f30\u8ba1\u4ea4\u6613\u6b21\u6570\u3001\u671f\u671b\u4ea4\u6613\u6210\u672c\u3001\u671f\u671b\u6536\u76ca\u7387\u81f3\u5173\u91cd\u8981\uff0c\u4ece\u800c\u6700\u7ec8\u5b9a\u91cf\u7684\u8ba1\u7b97\u4e00\u4e2a\u7b56\u7565\u6216\u8005\u6295\u8d44\u7ec4\u5408\u7684\u98ce\u9669\u5206\u5e03\u548c\u76c8\u5229\u6c34\u5e73\u3002</li>\n</ul>\n<p>\u4e0a\u6587\u8bf4\u5230\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u5173\u7cfb\u4e2d\uff0c\u6700\u91cd\u8981\u7684\u5f53\u5c5e\u81ea\u76f8\u5173\u6027\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5f88\u5bb9\u6613\u4ece\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e2d\u8bc6\u522b\u51fa\u8d8b\u52bf\u4ee5\u53ca\u5b63\u8282\u53d8\u6362\u3002\u5f53\u9664\u53bb\u8fd9\u4e9b\u5173\u7cfb\u540e\uff0c\u5269\u4e0b\u7684\u65f6\u95f4\u5e8f\u5217\u5f80\u5f80\u770b\u6765\u5341\u5206\u968f\u673a\u3002\u7136\u800c\u5bf9\u4e8e\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\uff0c\u6bd4\u5982\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\uff0c\u770b\u4f3c\u968f\u673a\u7684\u65f6\u95f4\u5e8f\u5217\u4e2d\u5f80\u5f80\u5b58\u5728\u7740\u60ca\u4eba\u7684\u81ea\u76f8\u5173\u3002<strong>\u5bf9\u81ea\u76f8\u5173\u5efa\u6a21\u5e76\u52a0\u4ee5\u5229\u7528\u80fd\u591f\u5927\u5e45\u63d0\u9ad8\u4ea4\u6613\u4fe1\u53f7\u7684\u51c6\u786e\u6027</strong> \u914d\u5bf9\u4ea4\u6613\u7684\u5747\u503c\u56de\u590d\u7b56\u7565\u5c31\u662f\u8fd9\u4e48\u4e00\u4e2a\u4f8b\u5b50\u3002\u5747\u503c\u56de\u590d\u7b56\u7565\u5229\u7528\u4e00\u5bf9\u6295\u8d44\u54c1\u4ef7\u5dee\u5e8f\u5217\u7684 <strong>\u8d1f\u76f8\u5173\u6027</strong> \u8fdb\u884c\u6295\u8d44\uff0c\u4ea7\u751f\u505a\u591a\u6216\u8005\u505a\u7a7a\u7684\u4ea4\u6613\u4fe1\u53f7\uff0c\u5b9e\u73b0\u76c8\u5229\u3002</p>\n<h3 id=\"_2\">\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u6838\u5fc3\u5c31\u662f\u6316\u6398\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\u3002<a class=\"headerlink\" href=\"#_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u672c\u6587\u7684\u4e0b\u9762\u51e0\u8282\u5c31\u6765\u4ecb\u7ecd\u5982\u4f55\u8ba1\u7b97\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002\u4e3a\u6b64\uff0c\u9996\u5148\u6765\u770b\u4e24\u4e2a\u57fa\u7840\u6982\u5ff5\uff1a\u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570\u3002\u4e4b\u540e\u4f1a\u8c08\u53ca\u65f6\u95f4\u5e8f\u5217\u7684\u7a33\u5b9a\u6027\uff0c\u5b83\u662f\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4e00\u4e2a\u5fc5\u8981\u524d\u63d0\u3002\u6700\u540e\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002</p>\n<h2 id=\"3\">3 \u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570<a class=\"headerlink\" href=\"#3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u672c\u8282\u4ecb\u7ecd\u6982\u7387\u8bba\u4e2d\u7684\u57fa\u7840\u6982\u5ff5\uff1a\u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570\u3002\u719f\u6089\u5b83\u4eec\u7684\u8bfb\u8005\u53ef\u8df3\u8fc7\u3002</p>\n<p>\u5047\u8bbe\u4e24\u4e2a\u968f\u673a\u53d8\u91cf <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u6ee1\u8db3\u672a\u77e5\u7684\u6982\u7387\u5206\u5e03\uff08\u53ef\u4ee5\u662f\u540c\u5206\u5e03\u4e5f\u53ef\u4ee5\u662f\u4e0d\u540c\u7684\u5206\u5e03\uff09\u3002 <span class=\"arithmatex\">\\(E[\\cdot]\\)</span> \u4e3a\u6c42\u89e3\u6570\u5b66\u671f\u671b\u7684\u8fd0\u7b97\u7b26\u3002<span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u603b\u4f53\u534f\u65b9\u5dee\uff08population covariance\uff09\u4e3a\uff1a</p>\n<div class=\"arithmatex\">\\[ Cov(X,Y) = E[(X-\\mu_X)(Y-\\mu_Y)] \\]</div>\n<p>\u5176\u4e2d\uff0c <span class=\"arithmatex\">\\(\\mu_X\\)</span> \u548c <span class=\"arithmatex\">\\(\\mu_Y\\)</span> \u5206\u522b\u4e3a <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684 <strong>\u603b\u4f53\u5747\u503c\uff08population mean\uff09</strong>\u3002</p>\n<p><strong>\u534f\u65b9\u5dee\u544a\u8bc9\u6211\u4eec\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u662f\u5982\u4f55\u4e00\u8d77\u79fb\u52a8\u7684\u3002</strong></p>\n<p>\u5728\u5b9e\u9645\u4e2d\uff0c\u7531\u4e8e\u603b\u4f53\u7684\u6982\u7387\u5206\u5e03\u672a\u77e5\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u89c2\u6d4b\u503c\u6765\u8ba1\u7b97 <strong>\u6837\u672c\u5747\u503c\uff08sample mean\uff09</strong>\u3002\u5047\u8bbe\u6211\u4eec\u5404\u6709 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u89c2\u6d4b\u503c <span class=\"arithmatex\">\\(n\\)</span> \u4e2a\uff0c\u5219\u5b83\u4eec\u7684**\u6837\u672c\u534f\u65b9\u5dee\uff08sample covariance\uff09** \u4e3a\uff1a</p>\n<div class=\"arithmatex\">\\[\\frac{1}{n-1}\\sum_{i=1}^n{(X_i - \\bar{X})(Y_i - \\bar{Y})}\\]</div>\n<p>\u5176\u4e2d\uff0c<span class=\"arithmatex\">\\(\\bar{X}\\)</span> \u548c<span class=\"arithmatex\">\\(\\bar{Y}\\)</span> \u4e3a <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u6837\u672c\u5747\u503c\u3002\u4e0a\u9762\u516c\u5f0f\u4e2d\u53f3\u4fa7\u4e4b\u6240\u4ee5\u9664\u4ee5 <span class=\"arithmatex\">\\(n-1\\)</span> \u800c\u975e <span class=\"arithmatex\">\\(n\\)</span> \u7684\u539f\u56e0\u662f\uff0c\u8fd9\u4e48\u505a\u53ef\u4ee5\u4fdd\u8bc1\u6837\u672c\u534f\u65b9\u5dee\u662f\uff08\u672a\u77e5\uff09\u603b\u4f53\u534f\u65b9\u5dee\u7684\u4e00\u4e2a**\u65e0\u504f\u4f30\u8ba1\uff08unbiased estimator\uff09**\u3002</p>\n<p>\u5047\u8bbe\u6211\u4eec\u968f\u673a\u751f\u6210\u4e24\u4e2a\u968f\u673a\u53d8\u91cf <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u5e8f\u5217\uff0c\u5b83\u4eec\u7684\u6563\u70b9\u56fe\u5982\u4e0b\u3002</p>\n<p><img alt=\"IMAGE\" src=\"../../../images/time-series/53E6D3A345ED1B71113A9E8D9ADF0129.jpg\" /></p>\n<p>\u6309\u7167\u4e0a\u9762\u7684\u516c\u5f0f\uff0c<span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u6837\u672c\u534f\u65b9\u5dee\u4e3a 893.215203\u3002\u5b83\u6709\u4ec0\u4e48\u610f\u4e49\u5462\uff1f\u5728\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u518d\u6765\u770b\u53e6\u5916\u4e24\u4e2a\u53d8\u91cf\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a<span class=\"arithmatex\">\\(X100\\)</span> \u548c<span class=\"arithmatex\">\\(Y100\\)</span> \u3002\u5b83\u4eec\u5206\u522b\u5b9a\u4e49\u4e3a$X100 = 100\\times X $ \u548c <span class=\"arithmatex\">\\(Y100 = 100\\times Y\\)</span> \u3002\u53ef\u89c1\uff0c\u5b83\u4eec\u4ec5\u4ec5\u662f <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u5404\u4e58\u4ee5 100 \u5f97\u5230\u7684\u3002 <span class=\"arithmatex\">\\(X100\\)</span> \u548c<span class=\"arithmatex\">\\(Y100\\)</span> \u7684\u6837\u672c\u534f\u65b9\u5dee\u4e3a 8932152.03\uff0c\u8fd9\u662f <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u534f\u65b9\u5dee\u7684 10000 \u500d\u3002<strong>\u7136\u800c\uff0c\u5982\u679c\u4ec5\u4ec5\u56e0\u6b64\u5c31\u5f97\u51fa <span class=\"arithmatex\">\\(X100\\)</span> \u548c <span class=\"arithmatex\">\\(Y100\\)</span> \u7684\u76f8\u5173\u6027\u9ad8\u4e8e <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u76f8\u5173\u6027\u5c31\u5927\u9519\u7279\u9519\u4e86\u3002</strong>\n\u4e8b\u5b9e\u4e0a\uff0c\u7531\u4e8e <span class=\"arithmatex\">\\(X100\\)</span> \u548c <span class=\"arithmatex\">\\(Y100\\)</span> \u662f\u7531 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u5206\u522b\u4e58\u4ee5 100 \u5f97\u5230\u7684\uff0c\u56e0\u6b64\u5b83\u4eec\u4e4b\u95f4\u7684\u76f8\u5173\u6027\u663e\u7136\u548c <span class=\"arithmatex\">\\(X\\)</span> \u4e0e <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u76f8\u5173\u6027\u76f8\u540c\u3002</p>\n<p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\u4f7f\u7528\u534f\u65b9\u5dee\u8861\u91cf\u53d8\u91cf\u76f8\u5173\u6027\u7684**\u81f4\u547d\u7f3a\u70b9\uff1a\u534f\u65b9\u5dee\u662f\u6709\u91cf\u7eb2\u7684\uff0c\u56e0\u6b64\u5b83\u7684\u5927\u5c0f\u53d7\u968f\u673a\u53d8\u91cf\u672c\u8eab\u6ce2\u52a8\u8303\u56f4\u7684\u5f71\u54cd**\u3002\u5728\u4e0a\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5f53\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u7684\u6ce2\u52a8\u8303\u56f4\u6269\u5927 100 \u500d\u540e\uff0c\u5b83\u4eec\u7684\u534f\u65b9\u5dee\u6269\u5927\u4e86 10000 \u500d\u3002\u56e0\u6b64\uff0c\u4eba\u4eec\u5e0c\u671b\u4f7f\u7528\u67d0\u4e2a\u548c\u534f\u65b9\u5dee\u6709\u5173\uff0c\u4f46\u662f\u53c8\u662f**\u65e0\u91cf\u7eb2**\u7684\u6d4b\u91cf\u6765\u63cf\u8ff0\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u7684\u76f8\u5173\u6027\u3002<strong>\u6700\u7b80\u5355\u7684\u505a\u6cd5\u5c31\u662f\u7528\u53d8\u91cf\u81ea\u8eab\u7684\u6ce2\u52a8\u5bf9\u534f\u65b9\u5dee\u8fdb\u884c\u6807\u51c6\u5316\u3002\u76f8\u5173\u7cfb\u6570\uff08correlation \u6216\u8005 correlation coefficient\uff09\u4fbf\u7531\u6b64\u5f97\u6765\u3002</strong></p>\n<p>\u4ee4 <span class=\"arithmatex\">\\(\\rho\\)</span> \u8868\u793a<span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684**\u603b\u4f53\u76f8\u5173\u7cfb\u6570\uff08population correlation\uff09**\uff0c\u5b83\u7684\u5b9a\u4e49\u4e3a\uff1a</p>\n<div class=\"arithmatex\">\\[\\rho(X,Y) = \\frac{E[(X-\\mu_x)(Y-\\mu_Y)]}{\\sigma_X\\sigma_Y} = \\frac{Cov(X,Y)}{\\sigma_X\\sigma_Y}\\]</div>\n<p>\u5176\u4e2d <span class=\"arithmatex\">\\(\\sigma_X\\)</span> \u548c <span class=\"arithmatex\">\\(\\sigma_Y\\)</span> \u5206\u522b\u4e3a <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684**\u603b\u4f53\u6807\u51c6\u5dee\uff08population standard deviation\uff09**\u3002\u901a\u8fc7\u4f7f\u7528 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684\u6807\u51c6\u5dee\u5bf9\u5b83\u4eec\u7684\u534f\u65b9\u5dee\u5f52\u4e00\u5316\uff0c<span class=\"arithmatex\">\\(\\rho\\)</span> \u7684\u53d6\u503c\u8303\u56f4\u5728 -1 \u5230 +1 \u4e4b\u95f4\uff0c\u5373 [-1, +1]\uff1a</p>\n<ul>\n<li>$\\rho(X,Y) = 1 $ \u8868\u793a<span class=\"arithmatex\">\\(X\\)</span> \u548c<span class=\"arithmatex\">\\(Y\\)</span> \u4e4b\u95f4\u5b58\u5728\u786e\u5207\u7684\u7ebf\u6027\u6b63\u76f8\u5173\uff1b</li>\n<li>$\\rho(X,Y) = 0 $ \u8868\u793a <span class=\"arithmatex\">\\(X\\)</span> <span class=\"arithmatex\">\\(Y\\)</span> \u4e4b\u95f4\u4e0d\u5b58\u5728\u4efb\u4f55\u7ebf\u6027\u76f8\u5173\u6027\uff1b</li>\n<li>$\\rho(X,Y) = -1 $ \u8868\u793a <span class=\"arithmatex\">\\(X\\)</span> <span class=\"arithmatex\">\\(Y\\)</span> \u4e4b\u95f4\u5b58\u5728\u786e\u5207\u7684\u7ebf\u6027\u8d1f\u76f8\u5173\u3002</li>\n</ul>\n<p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c<strong>\u76f8\u5173\u7cfb\u6570\u4ec5\u4ec5\u523b\u753b<span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u4e4b\u95f4\u7684\u7ebf\u6027\u76f8\u5173\u6027\uff1b\u5b83\u4e0d\u63cf\u8ff0\u5b83\u4eec\u4e4b\u95f4\u7684\uff08\u4efb\u4f55\uff09\u975e\u7ebf\u6027\u5173\u7cfb</strong>\u3002\u5728\u5b9e\u9645\u4e2d\uff0c\u7531\u4e8e\u603b\u4f53\u7684\u6982\u7387\u5206\u5e03\u672a\u77e5\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7<span class=\"arithmatex\">\\(X\\)</span> \u548c<span class=\"arithmatex\">\\(Y\\)</span> \u7684\u89c2\u6d4b\u503c\u6765\u8ba1\u7b97 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u7684**\u6837\u672c\u76f8\u5173\u7cfb\u6570\uff08sample correlation\uff09**\uff1a</p>\n<div class=\"arithmatex\">\\[\n\\hat\\rho(X,Y) = \\frac{\\sum_{i=1}^n{(X_i - \\bar{X})(Y_i - \\bar{Y})} }{\\sqrt{\\sum_{i=1}^n{(X_i - \\bar{X})^2}\\sum_{i=1}^n{(Y_i - \\bar{Y})^2}}}\n\\]</div>\n<p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u65e0\u8bba\u8003\u8651<span class=\"arithmatex\">\\(X\\)</span> \u548c<span class=\"arithmatex\">\\(Y\\)</span> \u8fd8\u662f<span class=\"arithmatex\">\\(X100\\)</span> \u548c<span class=\"arithmatex\">\\(Y100\\)</span> \uff08\u5373\u65e0\u8bba\u5982\u4f55\u7f29\u653e <span class=\"arithmatex\">\\(X\\)</span> \u548c<span class=\"arithmatex\">\\(Y\\)</span> \uff09\uff0c\u5b83\u4eec\u7684\u76f8\u5173\u7cfb\u6570\u90fd\u662f 0.894655\uff0c\u8fd9\u548c\u6211\u4eec\u7684\u9884\u671f\u76f8\u7b26\u3002\u7531\u4e8e\u8fd9\u4e2a\u6570\u503c\u975e\u5e38\u63a5\u8fd1 1\uff0c\u5b83\u610f\u5473\u7740 <span class=\"arithmatex\">\\(X\\)</span> \u548c <span class=\"arithmatex\">\\(Y\\)</span> \u4e4b\u95f4\u5b58\u5728\u5f88\u5f3a\u7684\u7ebf\u6027\u6b63\u76f8\u5173\u3002</p>\n<h2 id=\"4\">4 \u65f6\u95f4\u5e8f\u5217\u7684\u5e73\u7a33\u6027<a class=\"headerlink\" href=\"#4\" title=\"Permanent link\">&para;</a></h2>\n<p><strong>\u5e73\u7a33\u6027\uff08stationarity\uff09\u662f\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u57fa\u7840\u3002</strong></p>\n<p>\u4e3a\u4e86\u901a\u4fd7\u7684\u7406\u89e3\u5e73\u7a33\u6027\uff0c\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u7c7b\u6bd4\uff08\u8fd9\u662f\u6211\u80fd\u60f3\u5230\u7684\u6700\u597d\u7684\u4f8b\u5b50\uff09\u3002\u5047\u5982\u67d0\u80a1\u7968\u7684\u65e5\u6536\u76ca\u7387\u7531\u8f6c\u8f6e\u76d8\u8d4c\u51b3\u5b9a\uff1a\u8f6c\u5230\u4e0d\u540c\u6570\u5b57\u5c31\u5bf9\u5e94\u4e0d\u540c\u7684\u6536\u76ca\u7387\u3002\u5728\u6bcf\u4e2a\u65f6\u523b <span class=\"arithmatex\">\\(t\\)</span> \uff0c\u6211\u4eec\u90fd\u8f6c\u540c\u4e00\u4e2a\u8f6e\u76d8\u8d4c\u5e76\u786e\u5b9a\u6536\u76ca\u7387 <span class=\"arithmatex\">\\(r_t\\)</span> \u3002\u53ea\u8981\u8fd9\u4e2a\u8f6e\u76d8\u4e0d\u53d8\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6240\u6709\u7684 <span class=\"arithmatex\">\\(t\\)</span> \uff0c<span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u6982\u7387\u5206\u5e03\u90fd\u662f\u4e00\u6837\u7684\u3001\u4e0d\u968f\u65f6\u95f4\u53d8\u5316\u3002\u8fd9\u6837\u7684\u65f6\u95f4\u5e8f\u5217 <span class=\"arithmatex\">\\(\\{r_t\\}\\)</span> \u5c31\u662f\uff08\u4e25\u683c\uff09\u5e73\u7a33\u7684\u3002\u5982\u679c\u4ece\u67d0\u4e2a\u65f6\u523b <span class=\"arithmatex\">\\(t'\\)</span> \u5f00\u59cb\uff0c\u8f6e\u76d8\u53d1\u751f\u4e86\u53d8\u5316\uff08\u6bd4\u5982\u8f6e\u76d8\u4e0a\u9762\u7684\u6570\u5b57\u53d8\u591a\u4e86\uff09\uff0c\u90a3\u4e48\u663e\u7136\u4ece <span class=\"arithmatex\">\\(t+ \\ge t'\\)</span> \u5f00\u59cb\uff0c <span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u5206\u5e03\u5c31\u4fbf\u968f\u4e4b\u53d1\u751f\u53d8\u5316\uff0c\u56e0\u6b64\u65f6\u95f4\u5e8f\u5217 <span class=\"arithmatex\">\\(\\{r_t\\}\\)</span> \u5c31\u4e0d\u662f\u5e73\u7a33\u7684\u3002</p>\n<p>\u5728\u6570\u5b66\u4e0a\uff0c\u65f6\u95f4\u5e8f\u5217\u7684**\u4e25\u5e73\u7a33\uff08strictly stationary\uff09<strong>\u6709\u7740\u66f4\u7cbe\u786e\u7684\u5b9a\u4e49\uff1a\u5b83\u8981\u6c42\u65f6\u95f4\u5e8f\u5217\u4e2d\u4efb\u610f\u7ed9\u5b9a\u957f\u5ea6\u7684\u4e24\u6bb5\u5b50\u5e8f\u5217\u90fd\u6ee1\u8db3\u76f8\u540c\u7684\u8054\u5408\u5206\u5e03\u3002**\u8fd9\u662f\u4e00\u4e2a\u5f88\u5f3a\u7684\u6761\u4ef6\uff0c\u5728\u5b9e\u9645\u4e2d\u51e0\u4e4e\u4e0d\u53ef\u80fd\u88ab\u6ee1\u8db3\u3002**\u56e0\u6b64\u6211\u4eec\u8fd8\u6709**\u5f31\u5e73\u7a33\uff08weakly stationary\uff09**\u7684\u5b9a\u4e49</strong>\uff0c\u5b83\u8981\u6c42\u65f6\u95f4\u5e8f\u5217\u6ee1\u8db3\u5747\u503c\u5e73\u7a33\u6027\uff08stationary in mean\uff09\u548c\u4e8c\u9636\u5e73\u7a33\u6027\uff08secondary order stationary\uff09**\u3002</p>\n<p>\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217 <span class=\"arithmatex\">\\(\\{r_t\\}\\)</span> \u6ee1\u8db3\u4ee5\u4e0b\u4e24\u4e2a\u6761\u4ef6\uff0c\u5219\u5b83\u662f\u5f31\u5e73\u7a33\u7684\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e\u6240\u6709\u7684\u65f6\u523b <span class=\"arithmatex\">\\(t\\)</span> \uff0c\u6709 <span class=\"arithmatex\">\\(E[r_t] = \\mu\\)</span> \uff0c\u5176\u4e2d <span class=\"arithmatex\">\\(\\mu\\)</span> \u662f\u4e00\u4e2a\u5e38\u6570\u3002</li>\n<li>\u5bf9\u4e8e\u6240\u6709\u7684\u65f6\u523b $$ \u548c\u4efb\u610f\u7684\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \uff0c<span class=\"arithmatex\">\\(r_t\\)</span> \u548c <span class=\"arithmatex\">\\(r_{t-k}\\)</span> \u7684\u534f\u65b9\u5dee <span class=\"arithmatex\">\\(\\sigma(r_t,r_{t-k})\\)</span>\uff0c\u5176\u4e2d<span class=\"arithmatex\">\\(\\gamma_k\\)</span> \u4e0e\u65f6\u95f4<span class=\"arithmatex\">\\(t\\)</span> \u65e0\u5173\uff0c\u5b83\u4ec5\u4ec5\u4f9d\u8d56\u4e8e\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \u3002\u7279\u522b\u7684\uff0c\u5f53 <span class=\"arithmatex\">\\(k=0\\)</span> \u65f6\uff0c\u8fd9\u4e2a\u7279\u6027\u610f\u5473\u7740 <span class=\"arithmatex\">\\(\\sigma(r_t,r_t)\\)</span> \u2014\u2014 <span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u65b9\u5dee \u2014\u2014 \u4e0d\u968f\u65f6\u95f4\u53d8\u5316\uff0c\u7b49\u4e8e\u4e00\u4e2a\u4e0e\u65f6\u95f4 <span class=\"arithmatex\">\\(t\\)</span> \u65e0\u5173\u7684\u5e38\u6570<span class=\"arithmatex\">\\(\\gamma_0\\)</span>\uff0c\u8fd9\u79f0\u4e3a**\u65b9\u5dee\u5e73\u7a33\u6027\uff08stationary in variance\uff09**\u3002</li>\n</ol>\n<p><strong>\u5f31\u5e73\u7a33\u5047\u8bbe\u5bf9\u4e8e\u5206\u6790\u6295\u8d44\u54c1\u6536\u76ca\u7387\u81f3\u5173\u91cd\u8981\u3002</strong></p>\n<p>\u4e3a\u4e86\u89e3\u91ca\u8fd9\u4e00\u70b9\uff0c\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\u3002\u5047\u8bbe\u6211\u4eec\u60f3\u77e5\u9053 2017 \u5e74 5 \u6708 16 \u65e5\u8fd9\u5929\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u7684\u5747\u503c\u662f\u591a\u5c11\uff0c\u800c\u6211\u4eec\u7684\u731c\u60f3\u662f\u5b83\u6765\u81ea\u4e00\u4e2a\u672a\u77e5\u7684\u5206\u5e03\u3002\u4e5f\u8bb8\u4f60\u4f1a\u9a6c\u4e0a\u8bf4\u201c\u67e5\u4e00\u4e0b Wind \u4e0d\u5c31\u77e5\u9053\u4e86\uff1f\u4e0a\u8bc1\u6307\u6570\u90a3\u5929\u7684\u6536\u76ca\u7387\u662f 0.74%\u201d\u3002\u6ce8\u610f\uff0c<strong>0.74% \u8fd9\u4e2a\u6570\u503c\u4ec5\u4ec5\u662f\u90a3\u5929\u4e0a\u8bc1\u6307\u6570\u672a\u77e5\u6536\u76ca\u7387\u5206\u5e03\u7684\u4e00\u4e2a\u5b9e\u73b0\uff08realization\uff09</strong>\uff01\u5b83\u4e0d\u662f\u5747\u503c\uff0c\u56e0\u6b64\u4ece\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u89d2\u5ea6\u6765\u8bf4\u4ec5\u4ec5\u77e5\u9053 0.74% \u8fdc\u8fdc\u4e0d\u591f\u3002</p>\n<p><strong>\u5bf9\u4e8e\u4e00\u822c\u7684\u672a\u77e5\u6982\u7387\u5206\u5e03\uff0c\u53ea\u8981\u901a\u8fc7\u8fdb\u884c\u5927\u91cf\u91cd\u590d\u6027\u5b9e\u9a8c\uff0c\u5c31\u53ef\u4ee5\u6709\u8db3\u591f\u591a\u7684\u72ec\u7acb\u89c2\u6d4b\u70b9\u6765\u8fdb\u884c\u7edf\u8ba1\u63a8\u65ad\uff08\u8ba1\u7b97\u5747\u503c\u548c\u65b9\u5dee\u8fd9\u4e9b\u7edf\u8ba1\u91cf\uff09\u3002**\u6309\u7167\u8fd9\u4e2a\u601d\u8def\uff0c\u6211\u4eec\u5fc5\u987b\u628a 2017 \u5e74 5 \u6708 16 \u65e5\u8fd9\u4e00\u5929\u7ecf\u5386\u8bb8\u591a\u904d\uff0c\u5f97\u5230\u8bb8\u591a\u4e2a\u90a3\u5929\u7684\u6536\u76ca\u7387\u89c2\u6d4b\u503c\uff0c\u7136\u540e\u7528\u8fd9\u4e9b\u89c2\u6d4b\u503c\u8ba1\u7b97\u51fa\u6536\u76ca\u7387\u7684\u5747\u503c\u3002**\u4e0d\u5e78\u7684\u662f\uff0c\u5386\u53f2\u53ea\u53d1\u751f\u4e00\u6b21\uff0c\u65f6\u95f4\u4e5f\u4e00\u53bb\u4e0d\u590d\u8fd4\uff0c\u6211\u4eec\u53ea\u80fd\u5b9e\u5b9e\u5728\u5728\u7684\u7ecf\u5386\u4e00\u904d 2017 \u5e74 5 \u6708 16 \u65e5\uff0c\u53ea\u80fd\u5f97\u5230\u4e00\u4e2a\u6536\u76ca\u7387\u7684\u89c2\u6d4b\u70b9\uff0c\u5373 0.74%\u3002\u56e0\u6b64\u8fd9\u4e2a\u65b9\u6cd5\u5bf9\u4e8e\u91d1\u878d\u6570\u636e\u662f\u884c\u4e0d\u901a\u7684\u3002</strong></p>\n<p><strong>\u7136\u800c\uff0c\u5982\u679c\u6211\u4eec\u5047\u8bbe\u4e0a\u8bc1\u6307\u6570\u7684\u6536\u76ca\u7387\u5e8f\u5217\u6ee1\u8db3\u5f31\u5e73\u7a33\uff0c\u5c31\u67f3\u6697\u82b1\u660e\u4e86\u3002\u6839\u636e\u5f31\u5e73\u7a33\u5047\u8bbe\uff0c\u4e0a\u8bc1\u6307\u6570\u7684\u65e5\u6536\u76ca\u7387\u5e8f\u5217<span class=\"arithmatex\">\\(\\{r_t\\}\\)</span> \u7684\u5747\u503c\u662f\u4e00\u4e2a\u4e0e\u65f6\u95f4\u65e0\u5173\u7684\u5e38\u6570\uff0c\u5373 <span class=\"arithmatex\">\\(E[r_t] = \\mu\\)</span> \u3002\u8fd9\u6837\u4fbf\u53ef\u4ee5\u5229\u7528\u4e00\u6bb5\u65f6\u95f4\u7684\u5386\u53f2\u6570\u636e\u6765\u8ba1\u7b97\u51fa\u65e5\u6536\u76ca\u7387\u7684\u5747\u503c\u3002</strong>\n\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e0a\u8bc1\u6307\u6570\u5728 2017 \u5e74\u4ea4\u6613\u65e5\u7684\u65e5\u6536\u76ca\u7387\u5e8f\u5217\u53d6\u5e73\u5747\uff0c\u628a\u5b83\u4f5c\u4e3a\u5bf9\u603b\u4f53\u5747\u503c <span class=\"arithmatex\">\\(\\mu\\)</span> \u7684\u4e00\u4e2a\u4f30\u8ba1\u3002\u6839\u636e\u5f31\u5e73\u7a33\u6027\uff0c\u8be5\u5e73\u5747\u503c\u4e5f\u6b63\u662f 2017 \u5e74 5 \u6708 16 \u65e5\u7684\u6536\u76ca\u7387\u5747\u503c\u3002</p>\n<p>\u540c\u6837\u7684\u9053\u7406\uff0c\u5728\u5f31\u5e73\u7a33\u7684\u5047\u8bbe\u4e0b\uff0c\u53ef\u4ee5\u6839\u636e\u5386\u53f2\u6570\u636e\u65b9\u4fbf\u7684\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u8bf8\u591a\u7edf\u8ba1\u91cf\u8fdb\u884c\u63a8\u65ad\u3002<strong>\u5728\u91d1\u878d\u6587\u732e\u4e2d\uff0c\u4e5f\u901a\u5e38\u5047\u5b9a\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217\u662f\u5f31\u5e73\u7a33\u7684\u3002\u53ea\u8981\u6709\u8db3\u591f\u591a\u7684\u5386\u53f2\u6570\u636e\uff0c\u8fd9\u4e2a\u5047\u5b9a\u53ef\u4ee5\u7528\u5b9e\u8bc1\u65b9\u6cd5\u9a8c\u8bc1\u3002\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6570\u636e\u5206\u6210\u82e5\u5e72\u4e2a\u5b50\u96c6\uff0c\u5e76\u5206\u522b\u8ba1\u7b97\u6bcf\u4e2a\u5b50\u96c6\u7684\u7edf\u8ba1\u91cf\uff0c\u7136\u540e\u901a\u8fc7\u7edf\u8ba1\u7684\u624b\u6bb5\u68c0\u9a8c\u8fd9\u4e9b\u6765\u81ea\u4e0d\u540c\u5b50\u96c6\u7684\u7edf\u8ba1\u91cf\u7684\u4e00\u81f4\u6027\u3002</strong></p>\n<p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5373\u4fbf\u662f\u5f31\u5e73\u7a33\u6027\uff0c\u6709\u65f6\u91d1\u878d\u6570\u636e\u4e5f\u65e0\u6cd5\u6ee1\u8db3\u3002\u56de\u60f3\u7b2c\u4e8c\u8282\u4e2d\u90a3\u4e2a\u4e0a\u8bc1\u6307\u6570\u65e5\u6536\u76ca\u7387\u6807\u51c6\u5dee\u7684\u56fe\uff0c\u5b83\u6e05\u6670\u7684\u8bf4\u660e\uff0c\u5728 2001 \u5230 2017 \u5e74\u4e4b\u95f4\uff0c\u6807\u51c6\u5dee\u662f\u968f\u65f6\u95f4\u53d8\u5316\u7684\u3002\u8fd9\u610f\u5473\u7740\u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u6536\u76ca\u7387\u5e8f\u5217\u4e0d\u6ee1\u8db3\u4e8c\u9636\u5e73\u7a33\u6027\u3002\u5bf9\u4e8e\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u66f4\u590d\u6742\u7684\u975e\u7ebf\u6027\u6a21\u578b\u5bf9\u6ce2\u52a8\u7387\u5efa\u6a21\uff08\u6bd4\u5982 GARCH\uff09\uff0c\u53c8\u6216\u8005\u53ef\u4ee5\u628a\u65f6\u95f4\u6bb5\u7ec6\u5206\u4e3a\u66f4\u77ed\u7684\u533a\u95f4\uff0c\u4f7f\u5f97\u5728\u6bcf\u4e2a\u5c0f\u533a\u95f4\u5185\u7684\u6536\u76ca\u7387\u5e8f\u5217\u5c3d\u91cf\u6ee1\u8db3\u5f31\u5e73\u7a33\u6027\u3002</p>\n<p>\u6709\u4e86\u4e0a\u4e00\u8282\u548c\u672c\u8282\u7684\u5185\u5bb9\u505a\u94fa\u57ab\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u53ef\u4ee5\u804a\u804a\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u4e86\u3002</p>\n<h2 id=\"5\">5 \u81ea\u76f8\u5173\u6027\u548c\u81ea\u76f8\u5173\u51fd\u6570<a class=\"headerlink\" href=\"#5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5047\u8bbe\u6211\u4eec\u6709\u5f31\u5e73\u7a33\u7684\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217 <span class=\"arithmatex\">\\(\\{r_t\\}\\)</span> \u3002\u81ea\u76f8\u5173\u6027\u8003\u5bdf\u7684\u662f <span class=\"arithmatex\">\\(t\\)</span> \u65f6\u523b\u7684\u6536\u76ca\u7387 <span class=\"arithmatex\">\\(r_t\\)</span> \u548c\u8ddd\u5f53\u524d\u4efb\u610f\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \u65f6\u523b\u7684\u6536\u76ca\u7387<span class=\"arithmatex\">\\(r_{t-k}\\)</span> \u4e4b\u95f4\u7684\u7ebf\u6027\u76f8\u4f9d\u5173\u7cfb\uff08<span class=\"arithmatex\">\\(k\\)</span> \u7684\u53d6\u503c\u662f\u6240\u6709 <span class=\"arithmatex\">\\(\\ge 0\\)</span> \u7684\u6574\u6570\uff09\u3002\u7531\u4e8e <span class=\"arithmatex\">\\(r_t\\)</span> \u548c <span class=\"arithmatex\">\\(r_{t-k}\\)</span> \u6765\u81ea\u540c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u7b2c\u4e09\u8282\u4e2d\u7684\u76f8\u5173\u7cfb\u6570\u7684\u6982\u5ff5\u5e94\u7528\u5230 <span class=\"arithmatex\">\\(r_t\\)</span> \u548c <span class=\"arithmatex\">\\(r_{t-k}\\)</span> \u4e0a\uff0c\u4fbf\u63a8\u5e7f\u51fa\u81ea\u76f8\u5173\u7cfb\u6570\uff08autocorrelation\uff09\u3002</p>\n<p><strong>\u5b9a\u4e49\uff1a<span class=\"arithmatex\">\\(r_t\\)</span> \u548c <span class=\"arithmatex\">\\(r_{t-k}\\)</span> \u7684\u76f8\u5173\u7cfb\u6570\u79f0\u4e3a <span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u95f4\u9694\u4e3a <span class=\"arithmatex\">\\(k\\)</span>  \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u3002</strong></p>\n<p>\u5728\u5f31\u5e73\u7a33\u5047\u8bbe\u4e0b\uff0c\u8fd9\u4e2a\u95f4\u9694\u4e3a <span class=\"arithmatex\">\\(k\\)</span> \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e0e\u65f6\u95f4 <span class=\"arithmatex\">\\(t\\)</span>  \u65e0\u5173\uff0c\u800c\u4ec5\u4ec5\u4e0e\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \u6709\u5173\uff0c\u7531 <span class=\"arithmatex\">\\(\\rho_k\\)</span> \u8868\u793a\u3002\u7531\u7b2c\u4e09\u8282\u4e2d\u4ecb\u7ecd\u7684\u76f8\u5173\u7cfb\u6570\u7684\u5b9a\u4e49\u53ef\u77e5\uff1a</p>\n<div class=\"arithmatex\">\\[\n\\rho_k = \\frac{Cov(r_t,r_{t-k})}{\\sigma_{r_t}\\sigma_{r_{t-k}}} = \\frac{Cov(r_t,r_{t-k})}{\\sigma_{r_t}\\sigma_{r_t}} = \\frac{\\gamma_k}{\\gamma_0}\n\\]</div>\n<p>\u4e0a\u9762\u7684\u63a8\u5bfc\u4e2d\u7528\u5230\u4e86\u5f31\u5e73\u7a33\u7684\u6027\u8d28\uff0c\u5373\u534f\u65b9\u5dee\u548c\u65b9\u5dee\u5e73\u7a33\u6027\uff08\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e8c\u9636\u5e73\u7a33\u6027\uff09\u3002\u4ece\u8fd9\u4e2a\u5b9a\u4e49\u4e0d\u96be\u770b\u51fa\uff0c\u5f53 <span class=\"arithmatex\">\\(k=0\\)</span> \u65f6\u6709\uff1a</p>\n<div class=\"arithmatex\">\\[\\rho_0 = \\frac{\\gamma_0}{\\gamma_0} = 1\\]</div>\n<p>\u8fd9\u8868\u793a <span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u95f4\u9694\u4e3a 0 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u6052\u5b9a\u4e3a 1\u3002\u6b64\u5916\uff0c <span class=\"arithmatex\">\\(\\rho_k\\)</span> \u8fd8\u6709\u5982\u4e0b\u7684\u6027\u8d28\uff1a</p>\n<div class=\"arithmatex\">\\[\n\\rho_k = \\rho_{-k} \\\\\n-1 \\le \\rho_k \\le 1 \n\\]</div>\n<p>\u548c\u7b2c\u4e09\u8282\u4e00\u6837\uff0c\u4e0a\u9762\u5b9a\u4e49\u7684<span class=\"arithmatex\">\\(\\rho_k\\)</span> \u662f\u603b\u4f53\u7684\u7edf\u8ba1\u7279\u6027\u3002\u5b9e\u9645\u4e2d\uff0c\u6211\u4eec\u4ecd\u7136\u53ea\u80fd\u901a\u8fc7\u6709\u9650\u7684\u6837\u672c\u6570\u636e\u6765\u8ba1\u7b97\u6837\u672c\u7684\u7edf\u8ba1\u7279\u6027\u3002\u4ee4 <span class=\"arithmatex\">\\(\\zeta_k\\)</span> \u4e3a\u4e0e $rho_k$ \u5bf9\u5e94\u7684\u6837\u672c\u7edf\u8ba1\u91cf\uff0c\u5219\u6709\uff1a</p>\n<div class=\"arithmatex\">\\[\n\\zeta_k = \\frac{c_k}{c_0} \\\\\nc_k = \\frac{1}{n}\\sum_{t=1}^{n-k}{(r_t - \\bar{r})(r_{t+k} - \\bar{r})}\n\\]</div>\n<p>\u4e0a\u5f0f\u4e2d\uff0c <span class=\"arithmatex\">\\(c_k\\)</span> \u662f <span class=\"arithmatex\">\\(r_t\\)</span> \u7684\u95f4\u9694\u4e3a <span class=\"arithmatex\">\\(k\\)</span> \u7684\u6837\u672c\u81ea\u534f\u65b9\u5dee\uff08sample autocovariance of lag  <span class=\"arithmatex\">\\(k\\)</span>)\uff1b <span class=\"arithmatex\">\\(\\zeta_k\\)</span> \u4e3a <span class=\"arithmatex\">\\(r_t\\)</span> \u7684**\u95f4\u9694\u4e3a <span class=\"arithmatex\">\\(k\\)</span> \u7684\u6837\u672c\u81ea\u76f8\u5173\u7cfb\u6570\uff08sample autocorrelation of lag <span class=\"arithmatex\">\\(k\\)</span>\uff09**\u3002</p>\n<p><strong>\u5982\u679c\u628a <span class=\"arithmatex\">\\(\\zeta_k\\)</span> \u770b\u4f5c\u662f <span class=\"arithmatex\">\\(k\\)</span> \u7684\u65b9\u7a0b\uff0c\u5219\u5b83\u901a\u5e38\u88ab\u79f0\u4e3a\u6837\u672c\u81ea\u76f8\u5173\u65b9\u7a0b\uff08sample autocorrelation function\uff1b\u540c\u6837\u7684\uff0c<span class=\"arithmatex\">\\(\\rho_k\\)</span> \u4e3a\u603b\u4f53\u81ea\u76f8\u5173\u65b9\u7a0b\uff09\uff0c\u5b83\u523b\u753b\u4e86\u65f6\u95f4\u5e8f\u5217\u7684\u91cd\u8981\u7279\u6027\u3002\u5229\u7528\u76f8\u5173\u56fe\uff08correlogram\uff09\u53ef\u4ee5\u6e05\u6670\u5730\u770b\u5230 <span class=\"arithmatex\">\\(\\zeta_k\\)</span> \u662f\u5982\u4f55\u968f\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \u53d8\u5316\u7684\u3002</strong></p>\n<p>\u4e0b\u56fe\u4e3a\u4e24\u4e2a\u5047\u60f3\u65f6\u95f4\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u3002\u5b83\u4eec\u5448\u73b0\u51fa\u5b8c\u5168\u4e0d\u540c\u7ed3\u6784\u7684\u81ea\u76f8\u5173\u6027\u3002\u4e8b\u5b9e\u4e0a\uff0c\u7b2c\u4e00\u4e2a\u76f8\u5173\u56fe\u7684\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u660e\u663e\u7684\u8d8b\u52bf\uff1b\u800c\u7b2c\u4e8c\u4e2a\u76f8\u5173\u56fe\u7684\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u660e\u663e\u7684\u5468\u671f\u6027\u3002\u8fd9\u4e24\u4e2a\u4f8b\u5b50\u8bf4\u660e\u76f8\u5173\u56fe\u53ef\u4ee5\u544a\u8bc9\u6211\u4eec\u5f88\u591a\u65f6\u95f4\u5e8f\u5217\u7684\u5185\u5728\u7279\u6027\u3002</p>\n<p><img alt=\"IMAGE\" src=\"../../../images/time-series/35CEB420B00FCDE53879C7E4CDAF0D28.jpg\" /></p>\n<p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u867d\u7136\u8fdc\u6ca1\u6709\u8fd9\u4e24\u4e2a\u5047\u8c61\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u8fd9\u4e48\u6709\u7ed3\u6784\uff0c<strong>\u4f46\u76f8\u5173\u56fe\u5728\u6211\u4eec\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u65f6\u81f3\u5173\u91cd\u8981</strong>\u3002\u4e4b\u524d\u5df2\u7ecf\u8bf4\u8fc7\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\uff0c\u7279\u522b\u662f\u6536\u76ca\u7387\u5e8f\u5217\uff0c\u6700\u91cd\u8981\u7684\u7279\u6027\u662f\u4e00\u4e9b\u4e0d\u5bb9\u6613\u88ab\u53d1\u73b0\u7684\u81ea\u76f8\u5173\u6027\u3002\uff08\u901a\u5e38\u80a1\u7968\u7684\u6536\u76ca\u7387\u5e8f\u5217\u6ca1\u6709\u5b63\u8282\u6027\u6216\u8005\u660e\u663e\u7684\u8d8b\u52bf\u6027\uff1b\u5373\u4fbf\u662f\u5f31\u8d8b\u52bf\u4e5f\u53ef\u4ee5\u7531\u81ea\u76f8\u5173\u6027\u53cd\u5e94\u3002\uff09\u56e0\u6b64\uff0c\u62ff\u6765\u4e00\u4e2a\u6536\u76ca\u7387\u5e8f\u5217\uff0c<strong>\u53ea\u8981\u753b\u51fa\u76f8\u5173\u56fe\uff0c\u5c31\u53ef\u4ee5\u68c0\u6d4b\u8be5\u5e8f\u5217\u5728\u4efb\u4f55\u95f4\u9694<span class=\"arithmatex\">\\(k\\)</span> \u6709\u65e0\u7edf\u8ba1\u4e0a\u663e\u8457\u7684\u81ea\u76f8\u5173\u6027\u3002</strong></p>\n<p><strong>\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\uff0c\u6700\u91cd\u8981\u7684\u5c31\u662f\u6316\u6398\u51fa\u8be5\u5e8f\u5217\u4e2d\u7684\u4e0d\u540c\u95f4\u9694 <span class=\"arithmatex\">\\(k\\)</span> \u7684\u81ea\u76f8\u5173\u6027\u3002\u76f8\u5173\u56fe\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5224\u65ad\u6a21\u578b\u662f\u5426\u5408\u9002\u3002</strong> \u8fd9\u662f\u56e0\u4e3a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u4e2d\u5f80\u5f80\u5305\u62ec\u76f8\u5173\u6027\u548c\u968f\u673a\u566a\u58f0\u3002<strong>\u5982\u679c\u6a21\u578b\u5f88\u597d\u7684\u6355\u6349\u4e86\u81ea\u76f8\u5173\u6027\uff0c\u90a3\u4e48\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e0e\u6a21\u578b\u62df\u5408\u7684\u65f6\u95f4\u5e8f\u5217\u4e4b\u95f4\u7684\u6b8b\u5dee\u5e94\u8be5\u8fd1\u4f3c\u7684\u7b49\u4e8e\u968f\u673a\u566a\u58f0\u3002</strong> \u6b8b\u5dee\u5e8f\u5217\u81ea\u7136\u4e5f\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u56e0\u6b64\u53ef\u4ee5\u5bf9\u5b83\u753b\u51fa\u76f8\u5173\u56fe\u3002**\u4e00\u4e2a\u6807\u51c6\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u6ee1\u8db3 <span class=\"arithmatex\">\\(\\rho_0 = 1\\)</span> \u4ee5\u53ca <span class=\"arithmatex\">\\(\\rho_k = 0, k=1,2,3,\\cdots\\)</span> \u5373\u5bf9\u4e8e\u4efb\u610f\u4e0d\u4e3a 0 \u7684\u95f4\u9694\uff0c\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u5747\u4e3a 0\u3002**\u4e0b\u56fe\u4e3a\u4e00\u4e2a\u968f\u673a\u566a\u58f0\u7684\u76f8\u5173\u56fe\uff08\u6211\u4eec\u662f\u7528\u6807\u51c6\u6b63\u6001\u5206\u5e03\u6784\u9020\u4e86\u6709 500 \u4e2a\u70b9\u7684\u968f\u673a\u566a\u58f0\u5e8f\u5217\uff09\uff1a</p>\n<p><img alt=\"IMAGE\" src=\"../../../images/time-series/87B32640B420D4CFF269A471134DBC4D.jpg\" /></p>\n<p>\u5173\u4e8e\u8fd9\u4e2a\u56fe\uff1a</p>\n<ol>\n<li>\u663e\u7136\uff0c\u95f4\u9694\u4e3a 0 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 1\uff1b</li>\n<li>\u5bf9\u4e8e\u4efb\u610f\u7684 <span class=\"arithmatex\">\\(k \\ge 1\\)</span> \uff0c\u84dd\u8272\u7684\u9634\u5f71\u533a\u57df\u4e3a 95% \u7684\u7f6e\u4fe1\u533a\u95f4\u3002\u56e0\u6b64\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u53ea\u8981\u6ca1\u6709\u8d85\u8fc7\u84dd\u8272\u9634\u5f71\u533a\u57df\uff0c\u6211\u4eec\u5c31\u65e0\u6cd5\u5728 5% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\uff08\u539f\u5047\u8bbe\u4e3a\u95f4\u9694\u4e3a <span class=\"arithmatex\">\\(k\\)</span> \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 0\uff09\u3002\u4e0a\u56fe\u7684\u7ed3\u679c\u8bf4\u660e\u5f53 <span class=\"arithmatex\">\\(k\\)</span> \u4e0d\u4e3a 0 \u65f6\uff0c\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 0\u3002</li>\n</ol>\n<p>\u56e0\u6b64\uff0c\u5728\u8bc4\u4ef7\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u5efa\u6a21\u662f\u5426\u5408\u9002\u65f6\uff0c\u6211\u4eec\u9996\u5148\u627e\u5230\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u548c\u5b83\u7684\u62df\u5408\u5e8f\u5217\u4e4b\u95f4\u7684\u6b8b\u5dee\u5e8f\u5217\uff1b\u7136\u540e\u53ea\u8981\u753b\u51fa\u8fd9\u4e2a**\u6b8b\u5dee\u5e8f\u5217**\u7684\u76f8\u5173\u56fe\u5c31\u53ef\u4ee5\u770b\u5230\u5b83\u662f\u5426\u542b\u6709\u4efb\u4f55\u6a21\u578b\u672a\u8003\u8651\u7684\u989d\u5916\u81ea\u76f8\u5173\u6027\uff1a</p>\n<p><strong>\u5982\u679c\u6b8b\u5dee\u7684\u76f8\u5173\u56fe\u548c\u4e0a\u9762\u8fd9\u4e2a\u56fe\u76f8\u4f3c\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u6b8b\u5dee\u662f\u4e00\u4e2a\u968f\u673a\u566a\u58f0\uff0c\u800c\u6a21\u578b\u5df2\u7ecf\u5f88\u597d\u7684\u6355\u6349\u4e86\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\uff1b</strong></p>\n<p><strong>\u5982\u679c\u6b8b\u5dee\u7684\u76f8\u5173\u56fe\u4f53\u73b0\u4e86\u989d\u5916\u7684\u81ea\u76f8\u5173\u6027\uff0c\u5b83\u4eec\u5c06\u4e3a\u6211\u4eec\u6539\u8fdb\u5df2\u6709\u7684\u6a21\u578b\u63d0\u4f9b\u4f9d\u636e\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u989d\u5916\u7684\u81ea\u76f8\u5173\u8bf4\u660e\u5df2\u6709\u6a21\u578b\u6ca1\u6709\u8003\u8651\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u5728\u67d0\u4e9b\u7279\u5b9a\u95f4\u9694\u4e0a\u7684\u81ea\u76f8\u5173\u3002</strong></p>\n<h2 id=\"6\">6 \u4e0b\u6587\u9884\u544a<a class=\"headerlink\" href=\"#6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4f5c\u4e3a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7cfb\u5217\u7684\u5f00\u7bc7\uff0c\u672c\u6587\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u6027\u548c\u8fdb\u884c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u5e76\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u81ea\u76f8\u5173\u6027\u3002\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u6838\u5fc3\u5c31\u662f\u6355\u6349\u8be5\u5e8f\u5217\u4e2d\u4e0d\u540c\u95f4\u9694\u4e0a\u7684\u81ea\u76f8\u5173\u6027\u3002\u76f8\u5173\u56fe\u53ef\u4ee5\u6e05\u6670\u5730\u523b\u753b\u4efb\u4f55\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5728\u4e0d\u540c\u95f4\u9694\u7684\u81ea\u76f8\u5173\u6027\u3002</p>\n<p>\u5728\u4e0b\u4e00\u7bc7\u4e2d\uff0c\u6211\u4eec\u5c06\u4f1a\u4ece\u6700\u7b80\u5355\u7684\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u51fa\u53d1\uff0c\u8bf4\u660e\u5b83\u4eec\u65e0\u6cd5\u6709\u6548\u523b\u753b\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u4f53\u73b0\u51fa\u6765\u7684\u81ea\u76f8\u5173\u6027\u3002\u8fd9\u4f1a\u4fc3\u4f7f\u6211\u4eec\u63d0\u51fa\u66f4\u9ad8\u7ea7\u7684\u6a21\u578b\uff0c\u5305\u62ec AR\uff0cMA\uff0c\u4ee5\u53ca ARMA\u3002\u8fd9\u4e9b\u6a21\u578b\u80cc\u540e\u7684\u7406\u8bba\u662f\u4ec0\u4e48\uff1f\u5982\u4f55\u6b63\u786e\u7684\u6311\u9009\u6a21\u578b\u7684\u53c2\u6570\u4ee5\u6784\u5efa\u6700\u9002\u5f53\u7684\u6a21\u578b\uff1f\u8fd9\u4e9b\u5c06\u4f1a\u5728\u672c\u7cfb\u5217\u540e\u9762\u51e0\u7bc7\u6587\u7ae0\u4e2d\u63a2\u8ba8\u3002</p>\n<p>\uff08\u5168\u6587\u5b8c\uff09</p>\n<p><strong>\u514d\u8d23\u58f0\u660e\uff1a</strong> \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>", "image": null, "date_modified": "2025-02-01T13:56:21+08:00", "authors": [], "tags": []}]}