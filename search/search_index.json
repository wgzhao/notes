{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Home","text":"<p>\u8ba1\u5212\u5728\u8fd9\u91cc\u8bb0\u5f55\u81ea\u5df1\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u9047\u5230\u95ee\u9898\u7684\u89e3\u51b3\u529e\u6cd5\uff0c\u64b0\u5199\u7684\u4e00\u4e9b\u53ef\u5f00\u653e\u7684\u6587\u6863\uff0c\u4ee5\u53ca\u5e73\u65e5\u5b66\u4e60\u7684\u6587\u6863\u3002 \u6536\u85cf\u770b\u5230\u7684\u4e00\u4e9b\u597d\u7684\uff0c\u6709\u8da3\u3001\u6709\u7528\u7684\u8d44\u6e90\u3002</p>"},{"location":"#_1","title":"\u6761\u76ee","text":"<ul> <li>bigdata: \u4e00\u4e9b\u548c\u5927\u6570\u636e\u6709\u5173\u7684\u5185\u5bb9\uff0c\u5305\u62ec Hadoop, Spark, Flink, Hive \u7b49</li> <li>courses: \u4e00\u4e9b\u8bfe\u7a0b\u7b14\u8bb0\uff0c\u7cfb\u5217\u6587\u7ae0\u6216\u8005\u6458\u5f55\u7684\u4e13\u680f\u7b49</li> <li>database: RDBMS \u76f8\u5173\u7684\u4e00\u4e9b\u5185\u5bb9</li> <li>kubernetes: \u4e91\u539f\u751f\uff0ckubernetes \u751f\u6001\u7b49\u76f8\u5173\u5185\u5bb9</li> <li>programming: \u7f16\u7a0b\u8bed\u8a00\u76f8\u5173\u7684\u4e00\u4e9b\u6280\u5de7\uff0c\u7406\u8bba\u548c\u7b14\u8bb0</li> <li>troubleshooting: \u81ea\u5df1\u9047\u5230\u7684\u6216\u8005\u5728\u7f51\u7edc\u770b\u5230\u7684\u6709\u4e9b\u6709\u4ee3\u8868\u610f\u4e49\u7684\u6545\u969c\u6392\u67e5\u6848\u4f8b</li> <li>tips: \u5947\u6280\u6deb\u5de7\u4e4b\u7c7b\u7280\u5229\u800c\u65e0\u7528\u7684\u4e00\u4e9b\u5185\u5bb9</li> </ul>"},{"location":"tags/","title":"Tags","text":"<p>Following is a list of relevant tags:</p>"},{"location":"tags/#tag:abs","title":"abs","text":"<ul> <li>            BASH \u7684\u4e00\u4e9b\u6280\u5de7          </li> </ul>"},{"location":"tags/#tag:ambari","title":"ambari","text":"<ul> <li>            \u4f7f\u7528 Ambari API \u6765\u64cd\u4f5c Hadoop \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:android","title":"android","text":"<ul> <li>            Setup Gitlab CI For Android          </li> </ul>"},{"location":"tags/#tag:api","title":"api","text":"<ul> <li>            \u4f7f\u7528 Python \u548c Flask \u8bbe\u8ba1 RESTful API          </li> </ul>"},{"location":"tags/#tag:awk","title":"awk","text":"<ul> <li>            Understanding AWK          </li> </ul>"},{"location":"tags/#tag:bash","title":"bash","text":"<ul> <li>            BASH \u7684\u4e00\u4e9b\u6280\u5de7          </li> <li>            Pure Bash Bible          </li> </ul>"},{"location":"tags/#tag:bcprov","title":"bcprov","text":"<ul> <li>            \u8ba9 Oracle JDK 1.6 TLSv1.2          </li> </ul>"},{"location":"tags/#tag:bctls","title":"bctls","text":"<ul> <li>            \u8ba9 Oracle JDK 1.6 TLSv1.2          </li> </ul>"},{"location":"tags/#tag:benchmark","title":"benchmark","text":"<ul> <li>            \u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u4e3a\u4ec0\u4e48 MySQL 8.0 \u6bd4 MySQL 5.7 \u6162          </li> </ul>"},{"location":"tags/#tag:calico","title":"calico","text":"<ul> <li>            Calico Node \u65e0\u6cd5\u542f\u52a8\u7684\u6392\u67e5          </li> <li>            Migrate kubernetes cluster from Flannel to Calico          </li> </ul>"},{"location":"tags/#tag:cdc","title":"cdc","text":"<ul> <li>            Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790          </li> </ul>"},{"location":"tags/#tag:chinse","title":"chinse","text":"<ul> <li>            \u8ba9 Python \u4e2d matplotlib \u56fe\u652f\u6301\u4e2d\u6587          </li> </ul>"},{"location":"tags/#tag:ci","title":"ci","text":"<ul> <li>            Setup Gitlab CI For Android          </li> <li>            gitlab-ci.yml \u8be6\u89e3          </li> </ul>"},{"location":"tags/#tag:cli","title":"cli","text":"<ul> <li>            \u4f7f\u7528 Ambari API \u6765\u64cd\u4f5c Hadoop \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:clickhouse","title":"clickhouse","text":"<ul> <li>            \u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72 ClickHouse \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:cluster","title":"cluster","text":"<ul> <li>            HAProxy + Percona XtraDB Cluster \u90e8\u7f72          </li> <li>            MySQL Cluster \u914d\u7f6e          </li> <li>            \u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72 ClickHouse \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:commands","title":"commands","text":"<ul> <li>            Linux \u547d\u4ee4\u5b66\u4e60          </li> </ul>"},{"location":"tags/#tag:contact","title":"contact","text":"<ul> <li>            \u5fae\u4fe1\u901a\u8baf\u5f55\u5907\u4efd          </li> </ul>"},{"location":"tags/#tag:controlfile","title":"controlfile","text":"<ul> <li>            \u4fee\u590d Oracle ORA-00227 \u9519\u8bef          </li> </ul>"},{"location":"tags/#tag:coredns","title":"coredns","text":"<ul> <li>            CoreDNS \u652f\u6301\u89e3\u6790\u5bbf\u4e3b\u673a\u7684 hosts \u6587\u4ef6          </li> </ul>"},{"location":"tags/#tag:dashboard","title":"dashboard","text":"<ul> <li>            \u5728 Kubernetes Dashboard \u521b\u5efa\u57fa\u4e8e RBAC \u7684\u6388\u6743\u7528\u6237          </li> </ul>"},{"location":"tags/#tag:distributed-version-control","title":"distributed version control","text":"<ul> <li>            Git\u4ece\u5165\u95e8\u5230\u5e94\u4ed8\u65e5\u5e38\u5de5\u4f5c          </li> </ul>"},{"location":"tags/#tag:dns","title":"dns","text":"<ul> <li>            \u5916\u90e8\u673a\u5668\u5982\u4f55\u76f4\u63a5\u76f4\u63a5\u8bbf\u95ee kubernetes \u96c6\u7fa4\u5185\u670d\u52a1          </li> </ul>"},{"location":"tags/#tag:docker","title":"docker","text":"<ul> <li>            Docker \u8fd0\u884c\u5bb9\u5668\u62a5\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u7684\u9519\u8bef          </li> <li>            \u5982\u4f55\u5220\u9664 nexus \u79c1\u670d\u4e0a\u7684 Docker \u955c\u50cf          </li> <li>            \u7528\u5947\u602a\u7684\u65b9\u5f0f\u6784\u5efa\u7b80\u5355 k8s \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:dummy","title":"dummy","text":"<ul> <li>            \u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u865a\u5047 RPM \u5305          </li> </ul>"},{"location":"tags/#tag:edw","title":"edw","text":"<ul> <li>            \u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5          </li> </ul>"},{"location":"tags/#tag:elk","title":"elk","text":"<ul> <li>            \u57fa\u4e8e ELK \u7684 \u65e5\u5fd7\u6536\u96c6\u4e0e\u81ea\u52a8\u7d22\u5f15\u521b\u5efa          </li> </ul>"},{"location":"tags/#tag:etcd","title":"etcd","text":"<ul> <li>            \u7528\u5947\u602a\u7684\u65b9\u5f0f\u6784\u5efa\u7b80\u5355 k8s \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:evdev","title":"evdev","text":"<ul> <li>            Ubuntu \u4e0b\u4fee\u6539\u952e\u76d8\u6620\u5c04          </li> </ul>"},{"location":"tags/#tag:exp","title":"exp","text":"<ul> <li>            Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c          </li> </ul>"},{"location":"tags/#tag:expdp","title":"expdp","text":"<ul> <li>            Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c          </li> </ul>"},{"location":"tags/#tag:flannel","title":"flannel","text":"<ul> <li>            Migrate kubernetes cluster from Flannel to Calico          </li> </ul>"},{"location":"tags/#tag:flask","title":"flask","text":"<ul> <li>            \u4f7f\u7528 Python \u548c Flask \u8bbe\u8ba1 RESTful API          </li> </ul>"},{"location":"tags/#tag:flink","title":"flink","text":"<ul> <li>            Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790          </li> </ul>"},{"location":"tags/#tag:forward","title":"forward","text":"<ul> <li>            SSH examples, tips and tunnels          </li> </ul>"},{"location":"tags/#tag:git","title":"git","text":"<ul> <li>            Git \u5185\u90e8\u539f\u7406\u56fe\u89e3 -- \u5bf9\u8c61\u3001\u5206\u652f\u4ee5\u53ca\u5982\u4f55\u4ece\u96f6\u5f00\u59cb\u5efa\u4ed3\u5e93          </li> <li>            Git\u4ece\u5165\u95e8\u5230\u5e94\u4ed8\u65e5\u5e38\u5de5\u4f5c          </li> <li>            How to change git author name and email          </li> <li>            git \u4e0d\u5e38\u89c1\u7684\u64cd\u4f5c\u6280\u5de7          </li> </ul>"},{"location":"tags/#tag:gitlab","title":"gitlab","text":"<ul> <li>            Setup Gitlab CI For Android          </li> <li>            gitlab-ci.yml \u8be6\u89e3          </li> </ul>"},{"location":"tags/#tag:gitlab-ci","title":"gitlab-ci","text":"<ul> <li>            Setup Gitlab CI For Android          </li> <li>            gitlab-ci.yml \u8be6\u89e3          </li> </ul>"},{"location":"tags/#tag:hadoop","title":"hadoop","text":"<ul> <li>            free IPA setup          </li> </ul>"},{"location":"tags/#tag:haproxy","title":"haproxy","text":"<ul> <li>            HAProxy + Percona XtraDB Cluster \u90e8\u7f72          </li> </ul>"},{"location":"tags/#tag:hbase","title":"hbase","text":"<ul> <li>            Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1          </li> </ul>"},{"location":"tags/#tag:hdp","title":"hdp","text":"<ul> <li>            free IPA setup          </li> </ul>"},{"location":"tags/#tag:hive","title":"hive","text":"<ul> <li>            Integrating Apache Hive with Apache Spark          </li> </ul>"},{"location":"tags/#tag:imp","title":"imp","text":"<ul> <li>            Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c          </li> </ul>"},{"location":"tags/#tag:impdp","title":"impdp","text":"<ul> <li>            Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c          </li> </ul>"},{"location":"tags/#tag:ipa","title":"ipa","text":"<ul> <li>            free IPA setup          </li> </ul>"},{"location":"tags/#tag:jdk","title":"jdk","text":"<ul> <li>            \u8ba9 Oracle JDK 1.6 TLSv1.2          </li> </ul>"},{"location":"tags/#tag:k8s","title":"k8s","text":"<ul> <li>            \u5916\u90e8\u673a\u5668\u5982\u4f55\u76f4\u63a5\u76f4\u63a5\u8bbf\u95ee kubernetes \u96c6\u7fa4\u5185\u670d\u52a1          </li> <li>            \u7528\u5947\u602a\u7684\u65b9\u5f0f\u6784\u5efa\u7b80\u5355 k8s \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:kerberos","title":"kerberos","text":"<ul> <li>            MIT Kerberos  \u5b89\u88c5\u53ca\u7ef4\u62a4\u624b\u518c          </li> <li>            free IPA setup          </li> </ul>"},{"location":"tags/#tag:keybord","title":"keybord","text":"<ul> <li>            Ubuntu \u4e0b\u4fee\u6539\u952e\u76d8\u6620\u5c04          </li> </ul>"},{"location":"tags/#tag:kubectl","title":"kubectl","text":"<ul> <li>            \u7528\u5947\u602a\u7684\u65b9\u5f0f\u6784\u5efa\u7b80\u5355 k8s \u96c6\u7fa4          </li> </ul>"},{"location":"tags/#tag:kubernetes","title":"kubernetes","text":"<ul> <li>            Calico Node \u65e0\u6cd5\u542f\u52a8\u7684\u6392\u67e5          </li> <li>            CoreDNS \u652f\u6301\u89e3\u6790\u5bbf\u4e3b\u673a\u7684 hosts \u6587\u4ef6          </li> <li>            Migrate kubernetes cluster from Flannel to Calico          </li> <li>            \u5728 Kubernetes Dashboard \u521b\u5efa\u57fa\u4e8e RBAC \u7684\u6388\u6743\u7528\u6237          </li> <li>            \u57fa\u4e8e ELK \u7684 \u65e5\u5fd7\u6536\u96c6\u4e0e\u81ea\u52a8\u7d22\u5f15\u521b\u5efa          </li> </ul>"},{"location":"tags/#tag:latex","title":"latex","text":"<ul> <li>            \u7528\u4e8e LateX \u7684\u6570\u5b66\u7b26\u53f7          </li> </ul>"},{"location":"tags/#tag:layout","title":"layout","text":"<ul> <li>            Ubuntu \u4e0b\u4fee\u6539\u952e\u76d8\u6620\u5c04          </li> </ul>"},{"location":"tags/#tag:linux","title":"linux","text":"<ul> <li>            Linux \u547d\u4ee4\u5b66\u4e60          </li> </ul>"},{"location":"tags/#tag:math","title":"math","text":"<ul> <li>            \u7528\u4e8e LateX \u7684\u6570\u5b66\u7b26\u53f7          </li> </ul>"},{"location":"tags/#tag:matplot","title":"matplot","text":"<ul> <li>            \u5341\u5206\u949f\u638c\u63e1 Seaborn          </li> <li>            \u8ba9 Python \u4e2d matplotlib \u56fe\u652f\u6301\u4e2d\u6587          </li> </ul>"},{"location":"tags/#tag:mysql","title":"mysql","text":"<ul> <li>            HAProxy + Percona XtraDB Cluster \u90e8\u7f72          </li> <li>            MySQL Cluster \u914d\u7f6e          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e00\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e09\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e8c\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e94\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u56db\u90e8\u5206          </li> <li>            \u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u4e3a\u4ec0\u4e48 MySQL 8.0 \u6bd4 MySQL 5.7 \u6162          </li> </ul>"},{"location":"tags/#tag:ndb","title":"ndb","text":"<ul> <li>            MySQL Cluster \u914d\u7f6e          </li> </ul>"},{"location":"tags/#tag:network","title":"network","text":"<ul> <li>            Calico Node \u65e0\u6cd5\u542f\u52a8\u7684\u6392\u67e5          </li> </ul>"},{"location":"tags/#tag:nexus","title":"nexus","text":"<ul> <li>            \u5982\u4f55\u5220\u9664 nexus \u79c1\u670d\u4e0a\u7684 Docker \u955c\u50cf          </li> </ul>"},{"location":"tags/#tag:opensource","title":"opensource","text":"<ul> <li>            \u8d85\u7ea7\u60c5\u62a5\u624b\u673a\u5de5\u5177\u5e93\uff1a\u5f00\u6e90\u9a8c\u8bc1\u548c\u8c03\u67e5\u5de5\u5177\u53ca\u4f7f\u7528\u65b9\u6cd5          </li> </ul>"},{"location":"tags/#tag:ora-00227","title":"ora-00227","text":"<ul> <li>            \u4fee\u590d Oracle ORA-00227 \u9519\u8bef          </li> </ul>"},{"location":"tags/#tag:oracle","title":"oracle","text":"<ul> <li>            Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c          </li> <li>            Oracle \u9759\u9ed8\u5b89\u88c5          </li> <li>            \u4fee\u590d Oracle ORA-00227 \u9519\u8bef          </li> </ul>"},{"location":"tags/#tag:osint","title":"osint","text":"<ul> <li>            \u8d85\u7ea7\u60c5\u62a5\u624b\u673a\u5de5\u5177\u5e93\uff1a\u5f00\u6e90\u9a8c\u8bc1\u548c\u8c03\u67e5\u5de5\u5177\u53ca\u4f7f\u7528\u65b9\u6cd5          </li> </ul>"},{"location":"tags/#tag:pdf","title":"pdf","text":"<ul> <li>            Windows \u4e0b\u6279\u91cf\u8f6c\u6362 word \u6587\u6863\u4e3a pdf \u7684\u65b9\u6cd5          </li> </ul>"},{"location":"tags/#tag:percona","title":"percona","text":"<ul> <li>            HAProxy + Percona XtraDB Cluster \u90e8\u7f72          </li> </ul>"},{"location":"tags/#tag:performance","title":"performance","text":"<ul> <li>            zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18          </li> <li>            \u300aPostgreSQL 9 High Performance\u300b\u8bfb\u4e66\u7b14\u8bb0          </li> <li>            \u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u4e3a\u4ec0\u4e48 MySQL 8.0 \u6bd4 MySQL 5.7 \u6162          </li> </ul>"},{"location":"tags/#tag:phoenix","title":"phoenix","text":"<ul> <li>            Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1          </li> </ul>"},{"location":"tags/#tag:postgresql","title":"postgresql","text":"<ul> <li>            \u300aPostgreSQL 9 High Performance\u300b\u8bfb\u4e66\u7b14\u8bb0          </li> </ul>"},{"location":"tags/#tag:powershell","title":"powershell","text":"<ul> <li>            Windows \u4e0b\u6279\u91cf\u8f6c\u6362 word \u6587\u6863\u4e3a pdf \u7684\u65b9\u6cd5          </li> </ul>"},{"location":"tags/#tag:presto","title":"presto","text":"<ul> <li>            Presto SSL \u914d\u7f6e          </li> </ul>"},{"location":"tags/#tag:prestodb","title":"prestodb","text":"<ul> <li>            Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1          </li> </ul>"},{"location":"tags/#tag:proxy","title":"proxy","text":"<ul> <li>            SSH examples, tips and tunnels          </li> </ul>"},{"location":"tags/#tag:python","title":"python","text":"<ul> <li>            \u5341\u5206\u949f\u638c\u63e1 Seaborn          </li> <li>            \u8ba9 Python \u4e2d matplotlib \u56fe\u652f\u6301\u4e2d\u6587          </li> </ul>"},{"location":"tags/#tag:rbac","title":"rbac","text":"<ul> <li>            \u5728 Kubernetes Dashboard \u521b\u5efa\u57fa\u4e8e RBAC \u7684\u6388\u6743\u7528\u6237          </li> </ul>"},{"location":"tags/#tag:registry","title":"registry","text":"<ul> <li>            \u5982\u4f55\u5220\u9664 nexus \u79c1\u670d\u4e0a\u7684 Docker \u955c\u50cf          </li> </ul>"},{"location":"tags/#tag:respone","title":"respone","text":"<ul> <li>            Oracle \u9759\u9ed8\u5b89\u88c5          </li> </ul>"},{"location":"tags/#tag:restful","title":"restful","text":"<ul> <li>            \u4f7f\u7528 Python \u548c Flask \u8bbe\u8ba1 RESTful API          </li> </ul>"},{"location":"tags/#tag:rpm","title":"rpm","text":"<ul> <li>            \u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u865a\u5047 RPM \u5305          </li> </ul>"},{"location":"tags/#tag:rpmbuild","title":"rpmbuild","text":"<ul> <li>            \u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u865a\u5047 RPM \u5305          </li> </ul>"},{"location":"tags/#tag:seaborn","title":"seaborn","text":"<ul> <li>            \u5341\u5206\u949f\u638c\u63e1 Seaborn          </li> </ul>"},{"location":"tags/#tag:security","title":"security","text":"<ul> <li>            MIT Kerberos  \u5b89\u88c5\u53ca\u7ef4\u62a4\u624b\u518c          </li> <li>            Presto SSL \u914d\u7f6e          </li> </ul>"},{"location":"tags/#tag:sed","title":"sed","text":"<ul> <li>            SED \u5355\u884c\u811a\u672c\u5feb\u901f\u53c2\u8003          </li> </ul>"},{"location":"tags/#tag:service","title":"service","text":"<ul> <li>            \u5916\u90e8\u673a\u5668\u5982\u4f55\u76f4\u63a5\u76f4\u63a5\u8bbf\u95ee kubernetes \u96c6\u7fa4\u5185\u670d\u52a1          </li> </ul>"},{"location":"tags/#tag:session","title":"session","text":"<ul> <li>            \u628a\u4e00\u4e2a\u8fd0\u884c\u7684\u8fdb\u7a0b\u653e\u5230 tmux \u4f1a\u8bdd\u4e2d          </li> </ul>"},{"location":"tags/#tag:shell","title":"shell","text":"<ul> <li>            Pure Bash Bible          </li> </ul>"},{"location":"tags/#tag:spark","title":"spark","text":"<ul> <li>            Integrating Apache Hive with Apache Spark          </li> </ul>"},{"location":"tags/#tag:ssh","title":"ssh","text":"<ul> <li>            SSH examples, tips and tunnels          </li> <li>            ssh\u7684\u4e09\u677f\u65a7          </li> </ul>"},{"location":"tags/#tag:ssl","title":"ssl","text":"<ul> <li>            Presto SSL \u914d\u7f6e          </li> </ul>"},{"location":"tags/#tag:symbol","title":"symbol","text":"<ul> <li>            \u7528\u4e8e LateX \u7684\u6570\u5b66\u7b26\u53f7          </li> </ul>"},{"location":"tags/#tag:tcp","title":"tcp","text":"<ul> <li>            \u8be6\u89e3 TCP \u534a\u8fde\u63a5\u961f\u5217\u4e0e\u5168\u8fde\u63a5\u961f\u5217          </li> </ul>"},{"location":"tags/#tag:tcpdump","title":"tcpdump","text":"<ul> <li>            TCPDump Capture HTTP GET/POST requests          </li> </ul>"},{"location":"tags/#tag:tlsv12","title":"tlsv1.2","text":"<ul> <li>            \u8ba9 Oracle JDK 1.6 TLSv1.2          </li> </ul>"},{"location":"tags/#tag:tmux","title":"tmux","text":"<ul> <li>            How to save tmux session          </li> <li>            \u628a\u4e00\u4e2a\u8fd0\u884c\u7684\u8fdb\u7a0b\u653e\u5230 tmux \u4f1a\u8bdd\u4e2d          </li> </ul>"},{"location":"tags/#tag:trino","title":"trino","text":"<ul> <li>            Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1          </li> <li>            Presto SSL \u914d\u7f6e          </li> </ul>"},{"location":"tags/#tag:tuning","title":"tuning","text":"<ul> <li>            zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e00\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e09\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e8c\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e94\u90e8\u5206          </li> <li>            \u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u56db\u90e8\u5206          </li> </ul>"},{"location":"tags/#tag:tunnel","title":"tunnel","text":"<ul> <li>            SSH examples, tips and tunnels          </li> </ul>"},{"location":"tags/#tag:ubuntu","title":"ubuntu","text":"<ul> <li>            Ubuntu \u4e0b\u4fee\u6539\u952e\u76d8\u6620\u5c04          </li> </ul>"},{"location":"tags/#tag:version-control","title":"version control","text":"<ul> <li>            Git\u4ece\u5165\u95e8\u5230\u5e94\u4ed8\u65e5\u5e38\u5de5\u4f5c          </li> </ul>"},{"location":"tags/#tag:vim","title":"vim","text":"<ul> <li>            \u65e0\u63d2\u4ef6Vim\u7f16\u7a0b\u6280\u5de7          </li> </ul>"},{"location":"tags/#tag:warehouse","title":"warehouse","text":"<ul> <li>            \u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5          </li> </ul>"},{"location":"tags/#tag:wechat","title":"wechat","text":"<ul> <li>            \u5fae\u4fe1\u901a\u8baf\u5f55\u5907\u4efd          </li> </ul>"},{"location":"tags/#tag:word","title":"word","text":"<ul> <li>            Windows \u4e0b\u6279\u91cf\u8f6c\u6362 word \u6587\u6863\u4e3a pdf \u7684\u65b9\u6cd5          </li> </ul>"},{"location":"tags/#tag:xtradb","title":"xtradb","text":"<ul> <li>            HAProxy + Percona XtraDB Cluster \u90e8\u7f72          </li> </ul>"},{"location":"tags/#tag:zookeeper","title":"zookeeper","text":"<ul> <li>            zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18          </li> </ul>"},{"location":"bigdata/ambari-cli/","title":"\u4f7f\u7528 Ambari API \u6765\u64cd\u4f5c Hadoop \u96c6\u7fa4","text":"<p>Ambari \u7ba1\u7406\u7684hadoop\u96c6\u7fa4\uff0c\u5927\u90e8\u5206\u64cd\u4f5c\u90fd\u53ef\u4ee5\u5728\u5176\u7ba1\u7406\u9875\u9762\u4e0a\u5b8c\u6210\u60f3\u8981\u7684\u64cd\u4f5c\uff0c\u4f46\u662f\u6709\u4e9b\u64cd\u4f5c\u5374\u4e0d\u884c\uff0c\u6bd4\u5982\u4e00\u4e9b\u670d\u52a1\u5e76\u4e0d\u63d0\u4f9b\u5220\u9664\u64cd\u4f5c\uff0c\u53e6\u5916\u5f53\u4e00\u4e2a\u8282\u70b9\u5904\u4e8e\u5fc3\u8df3\u4e22\u5931\u60c5\u51b5\u4e0b\uff0c\u4e5f\u65e0\u6cd5\u5728\u9875\u9762\u4e0a\u5c06\u5176\u4ece\u96c6\u7fa4\u4e2d\u5265\u79bb\u51fa\u6765\u3002</p> <p>\u56e0\u6b64\uff0c\u6709\u4e9b\u7279\u522b\u7684\u64cd\u4f5c\u8fd8\u662f\u9700\u8981\u76f4\u63a5\u4f7f\u7528Amabri \u63d0\u4f9b\u7684API \u63a5\u53e3\u3002</p> <p>\u8fd9\u91cc\u5047\u5b9a\u8bbf\u95eeAmbari API\u6240\u5fc5\u8981\u7684\u51e0\u4e2a\u53c2\u6570</p> <pre><code>export AMBARI_URL=http://hadoop1.wgzhao.com:8080\nexport AMBARI_USER=admin\nexport AMBARI_PASS=admin\nexport AMBARI_CLUSTER=cluster\n</code></pre> <p>\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u5e38\u7528\u64cd\u4f5c</p>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_1","title":"\u67e5\u770b\u67d0\u4e2a\u8282\u70b9\u4e0a\u6240\u5b89\u88c5\u7684\u670d\u52a1","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -H \"X-Requested-By: ambari\" -X GET \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop3.wgzhao.com\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_2","title":"\u5220\u9664\u67d0\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684\u6307\u5b9a\u670d\u52a1\u6216\u7ec4\u4ef6","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS}  -H \"X-Requested-By: ambari\" -X DELETE \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop3.wgzhao.com/host_components/JOURNALNODE\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_3","title":"\u5220\u9664\u67d0\u4e2a\u8282\u70b9","text":"<p>\u6ce8\u610f\uff0c\u5220\u9664\u67d0\u4e00\u4e2a\u8282\u70b9\u4e4b\u524d\uff0c\u9700\u8981\u5148\u5220\u9664\u8282\u70b9\u4e0a\u7684\u6240\u6709\u670d\u52a1</p> <pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -H \"X-Requested-By: ambari\" -X DELETE \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop3.wgzhao.com\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_4","title":"\u589e\u52a0\u8282\u70b9\u5230\u96c6\u7fa4","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -H \"X-Requested-By: ambari\"  -X GET \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop25.wgzhao.com\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_5","title":"\u65b0\u65b0\u589e\u7684\u8282\u70b9\u4e0a\u5b89\u88c5\u5236\u5b9a\u670d\u52a1","text":"<p><pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS}  -H \"X-Requested-By: ambari\" -X PUT -d '{\"HostRoles\": {\"state\": \"INSTALLED\"}}' \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop25.wgzhao.com/host_components/DATANODE\n</code></pre> \u53d1\u51fa\u5b89\u88c5\u547d\u4ee4\u540e\uff0c\u4f1a\u7ed9\u51fa\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u53cd\u9988\u4fe1\u606f</p> <pre><code>{\n  \"href\" : \" ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/requests/9\",\n  \"Requests\" : {\n    \"id\" : 9,\n    \"status\" : \"InProgress\"\n  }\n}\n</code></pre> <p>\u6839\u636e\u8f93\u51fa\u7684ID\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u5b89\u88c5\u72b6\u6001</p> <pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS}  -H \"X-Requested-By: ambari\" -X GET ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/requests/9\ncurl -u ${AMBARI_USER}:${AMBARI_PASS} -H \"X-Requested-By: ambari\"  -X GET ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/requests/9/tasks/101\n\n{\n  \"href\" : \"${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/requests/9/tasks/101\",\n  \"Tasks\" : {\n    ...\n    \"status\" : \"COMPLETED\",\n    ...\n  }\n}\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#_6","title":"\u542f\u52a8\u521a\u5b89\u88c5\u7684\u670d\u52a1","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -H \"X-Requested-By: ambari\"  -X PUT -d  '{\"HostRoles\": {\"state\": \"STARTED\"}}' \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/hosts/hadoop25.wgzhao.com/host_components/DATANODE\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#hdfs","title":"\u505c\u6b62 HDFS \u670d\u52a1","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -i -H 'X-Requested-By: ambari' -X PUT \\\n  -d '{\"RequestInfo\": {\"context\" :\"Stop HDFS via REST\"}, \"Body\": {\"ServiceInfo\": {\"state\": \"INSTALLED\"}}}' \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/services/HDFS\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/ambari-cli/#hdfs_1","title":"\u542f\u52a8 HDFS \u670d\u52a1","text":"<pre><code>curl -u ${AMBARI_USER}:${AMBARI_PASS} -i -H 'X-Requested-By: ambari' -X PUT \\\n  -d '{\"RequestInfo\": {\"context\" :\"Start HDFS via REST\"}, \"Body\": {\"ServiceInfo\": {\"state\": \"STARTED\"}}}' \\\n  ${AMBARI_URL}/api/v1/clusters/${AMBARI_CLUSTER}/services/HDFS\n</code></pre>","tags":["ambari","cli"]},{"location":"bigdata/flink-cdc-practices/","title":"Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790","text":"<p>Source</p> <p>\u672c\u6587\u7531\u6c11\u751f\u94f6\u884c\u738b\u5065\u3001\u6587\u4e54\u5206\u4eab\uff0c\u4e3b\u8981\u4ecb\u7ecd\u6c11\u751f\u94f6\u884c Flink SQL CDC \u5b9e\u8df5\u4ee5\u53ca\u4e00\u81f4\u6027\u5206\u6790\u3002\u5185\u5bb9\u5305\u62ec\uff1a</p> <ol> <li>\u80cc\u666f</li> <li>\u4ec0\u4e48\u662f Flink SQL CDC Connectors</li> <li>Flink SQL CDC \u539f\u7406\u4ecb\u7ecd</li> <li>\u4e09\u79cd\u6570\u636e\u540c\u6b65\u65b9\u6848</li> <li>Flink SQL CDC + JDBC Connector \u540c\u6b65\u65b9\u6848\u9a8c\u8bc1</li> <li>Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5206\u6790</li> <li>Flink SQL CDC \u76ee\u524d\u5b58\u5728\u7684\u7f3a\u9677</li> </ol>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#_1","title":"\u4e00. \u80cc\u666f","text":"<p>\u6570\u636e\u51c6\u5b9e\u65f6\u590d\u5236\uff08CDC\uff09\u662f\u76ee\u524d\u884c\u5185\u5b9e\u65f6\u6570\u636e\u9700\u6c42\u5927\u91cf\u4f7f\u7528\u7684\u6280\u672f\uff0c\u968f\u7740\u56fd\u4ea7\u5316\u7684\u9700\u6c42\uff0c\u6211\u4eec\u4e5f\u9010\u6b65\u8003\u8651\u57fa\u4e8e\u5f00\u6e90\u4ea7\u54c1\u8fdb\u884c\u51c6\u5b9e\u65f6\u6570\u636e\u540c\u6b65\u5de5\u5177\u7684\u76f8\u5173\u5f00\u53d1\uff0c\u9010\u6b65\u5b9e\u73b0\u5bf9\u5546\u4e1a\u4ea7\u54c1\u7684\u66ff\u4ee3\u3002\u6211\u4eec\u8bc4\u4f30\u4e86\u51e0\u79cd\u5f00\u6e90\u4ea7\u54c1\uff0cCanal\u3001Debezium\u3001Flink CDC \u7b49\u4ea7\u54c1\u3002\u4f5c\u4e86\u5982\u4e0b\u7684\u5bf9\u6bd4\uff1a</p> <p></p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#flink-sql-cdc-connectors","title":"\u4e8c.\u4ec0\u4e48\u662f Flink SQL CDC Connectors","text":"<p>\u5728 Flink 1.11 \u5f15\u5165\u4e86 CDC \u673a\u5236\uff0cCDC \u7684\u5168\u79f0\u662f Change Data Capture\uff0c\u7528\u4e8e\u6355\u6349\u6570\u636e\u5e93\u8868\u7684\u589e\u5220\u6539\u67e5\u64cd\u4f5c\uff0c\u662f\u76ee\u524d\u975e\u5e38\u6210\u719f\u7684\u540c\u6b65\u6570\u636e\u5e93\u53d8\u66f4\u65b9\u6848\u3002</p> <p>Flink CDC Connectors \u662f Apache Flink \u7684\u4e00\u7ec4\u6e90\u8fde\u63a5\u5668\uff0c\u662f\u53ef\u4ee5\u4ece MySQL\u3001PostgreSQL \u6570\u636e\u76f4\u63a5\u8bfb\u53d6\u5168\u91cf\u6570\u636e\u548c\u589e\u91cf\u6570\u636e\u7684 Source Connectors\uff0c\u5f00\u6e90\u5730\u5740\uff1ahttps://github.com/ververica/flink-cdc-connectors\u3002</p> <p>\u76ee\u524d(1.11\u7248\u672c)\u652f\u6301\u7684 Connectors \u5982\u4e0b\uff1a</p> <p></p> <p>\u53e6\u5916\u652f\u6301\u89e3\u6790 Kafka \u4e2d debezium-json \u548c canal-json \u683c\u5f0f\u7684 Change Log\uff0c\u901a\u8fc7Flink \u8fdb\u884c\u8ba1\u7b97\u6216\u8005\u76f4\u63a5\u5199\u5165\u5230\u5176\u4ed6\u5916\u90e8\u6570\u636e\u5b58\u50a8\u7cfb\u7edf(\u6bd4\u5982 Elasticsearch)\uff0c\u6216\u8005\u5c06 Changelog Json \u683c\u5f0f\u7684 Flink \u6570\u636e\u5199\u5165\u5230 Kafka:</p> <p></p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#flink-sql-cdc","title":"\u4e09. Flink SQL CDC \u539f\u7406\u4ecb\u7ecd","text":"<p>\u5728\u516c\u5f00\u7684 CDC \u8c03\u7814\u62a5\u544a\u4e2d\uff0cDebezium \u548c Canal \u662f\u6700\u6d41\u884c\u4f7f\u7528\u7684 CDC \u5de5\u5177\uff0c\u8fd9\u4e9b CDC \u5de5\u5177\u7684\u6838\u5fc3\u539f\u7406\u662f\u62bd\u53d6\u6570\u636e\u5e93\u65e5\u5fd7\u83b7\u53d6\u53d8\u66f4\u3002\u5728\u7ecf\u8fc7\u4e00\u7cfb\u5217\u8c03\u7814\u540e\uff0c\u6211\u884c\u91c7\u7528\u7684\u662f Debezium (\u652f\u6301\u5168\u91cf\u3001\u589e\u91cf\u540c\u6b65\uff0c\u540c\u65f6\u652f\u6301 MySQL\u3001PostgreSQL\u3001Oracle \u7b49\u6570\u636e\u5e93)\u3002</p> <p>Flink SQL CDC \u5185\u7f6e\u4e86 Debezium \u5f15\u64ce\uff0c\u5229\u7528\u5176\u62bd\u53d6\u65e5\u5fd7\u83b7\u53d6\u53d8\u66f4\u7684\u80fd\u529b\uff0c\u5c06 changelog \u8f6c\u6362\u4e3a Flink SQL \u8ba4\u8bc6\u7684 RowData \u6570\u636e\u3002\uff08\u4ee5\u4e0b\u53f3\u4fa7\u662f Debezium \u7684\u6570\u636e\u683c\u5f0f\uff0c\u5de6\u4fa7\u662f Flink \u7684 RowData \u6570\u636e\u683c\u5f0f\uff09\u3002</p> <p></p> <p>RowData \u4ee3\u8868\u4e86\u4e00\u884c\u7684\u6570\u636e\uff0c\u5728 RowData \u4e0a\u9762\u4f1a\u6709\u4e00\u4e2a\u5143\u6570\u636e\u7684\u4fe1\u606f RowKind\uff0cRowKind \u91cc\u9762\u5305\u62ec\u4e86\u63d2\u5165(+I)\u3001\u66f4\u65b0\u524d(-U)\u3001\u66f4\u65b0\u540e(+U)\u3001\u5220\u9664(-D)\uff0c\u8fd9\u6837\u548c\u6570\u636e\u5e93\u91cc\u9762\u7684 binlog \u6982\u5ff5\u5341\u5206\u7c7b\u4f3c\u3002\u901a\u8fc7 Debezium \u91c7\u96c6\u7684\u6570\u636e\uff0c\u5305\u542b\u4e86\u65e7\u6570\u636e(before)\u548c\u65b0\u6570\u636e\u884c(after)\u4ee5\u53ca\u539f\u6570\u636e\u4fe1\u606f(source)\uff0cop \u7684 u \u8868\u793a\u662f update \u66f4\u65b0\u64cd\u4f5c\u6807\u8bc6\u7b26\uff08op \u5b57\u6bb5\u7684\u503c c\uff0cu\uff0cd\uff0cr \u5206\u522b\u5bf9\u5e94 create\uff0cupdate\uff0cdelete\uff0creade\uff09\uff0cts_ms \u8868\u793a\u540c\u6b65\u7684\u65f6\u95f4\u6233\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#_2","title":"\u56db. \u4e09\u79cd\u6570\u636e\u540c\u6b65\u65b9\u6848","text":"","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#41-debeziumkafka","title":"4.1 \u65b9\u6848\u4e00\uff1aDebezium+Kafka+\u8ba1\u7b97\u7a0b\u5e8f+\u5b58\u50a8\u7cfb\u7edf","text":"<p>\u76ee\u524d\u6211\u884c\u5728\u751f\u4ea7\u4e0a\u91c7\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u65b9\u6848\uff0c\u91c7\u7528 Debezium \u8ba2\u9605 MySQL \u7684 Binlog \u4f20\u8f93\u5230 Kafka\uff0c\u540e\u7aef\u662f\u7531\u8ba1\u7b97\u7a0b\u5e8f\u4ece Kafka \u91cc\u6d88\u8d39\uff0c\u6700\u540e\u5c06\u6570\u636e\u5199\u5165\u5230\u5176\u4ed6\u5b58\u50a8\uff0c\u67b6\u6784\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <p></p> <p>\u8fd9\u79cd\u65b9\u6848\u4e2d\u5229\u7528 Kafka \u6d88\u606f\u961f\u5217\u505a\u89e3\u8026\uff0cChange Log \u53ef\u4f9b\u4efb\u4f55\u5176\u4ed6\u4e1a\u52a1\u7cfb\u7edf\u4f7f\u7528\uff0c\u6d88\u8d39\u7aef\u53ef\u91c7\u7528 Kafka Sink Connector \u6216\u8005\u81ea\u5b9a\u4e49\u6d88\u8d39\u7a0b\u5e8f\uff0c\u4f46\u662f\u7531\u4e8e\u539f\u751f Debezium \u4e2d\u7684 Producer \u7aef\u672a\u91c7\u7528\u5e42\u7b49\u7279\u6027\uff0c\u56e0\u6b64\u6d88\u606f\u53ef\u80fd\u5b58\u5728\u91cd\u590d\uff0c\u53e6\u5916 Kafka Sink Connector(\u6bd4\u5982 JDBC Sink Connector \u53ea\u80fd\u4fdd\u8bc1 At least once)\u6216\u8005\u81ea\u5b9a\u4e49\u6d88\u8d39\u7a0b\u5e8f\u5728\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u4e0a\u4e5f\u6709\u96be\u5ea6\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#42-debeziumkafkaflink-sql","title":"4.2 \u65b9\u6848\u4e8c\uff1aDebezium+Kafka+Flink SQL+\u5b58\u50a8\u7cfb\u7edf","text":"<p>\u4ece\u7b2c\u4e8c\u7ae0\u8282\u6211\u4eec\u77e5\u9053 Flink SQL \u5177\u5907\u89e3\u6790 Kafka \u4e2d debezium-json \u548c canal-json \u683c\u5f0f\u7684 Change Log \u80fd\u529b\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u7528\u5982\u4e0b\u540c\u6b65\u67b6\u6784\uff1a</p> <p></p> <p>\u4e0e\u65b9\u6848\u4e00\u7684\u533a\u522b\u5c31\u662f\uff0c\u91c7\u7528 Flink \u901a\u8fc7\u521b\u5efa Kafka \u8868\uff0c\u6307\u5b9a format \u683c\u5f0f\u4e3a debezium-json\uff0c\u7136\u540e\u901a\u8fc7 Flink \u8fdb\u884c\u8ba1\u7b97\u540e\u6216\u8005\u76f4\u63a5\u63d2\u5165\u5230\u5176\u4ed6\u5916\u90e8\u6570\u636e\u5b58\u50a8\u7cfb\u7edf\u3002\u65b9\u6848\u4e8c\u548c\u65b9\u6848\u4e00\u7c7b\u4f3c\uff0c\u7ec4\u4ef6\u591a\u7ef4\u62a4\u7e41\u6742\uff0c\u800c\u524d\u8ff0\u6211\u4eec\u77e5\u9053 Flink 1.11 \u4e2d CDC Connectors \u5185\u7f6e\u4e86 Debezium \u5f15\u64ce\uff0c\u53ef\u4ee5\u66ff\u6362 Debezium+Kafka \u65b9\u6848\uff0c\u56e0\u6b64\u6709\u4e86\u66f4\u7b80\u5316\u7684\u65b9\u6848\u4e09\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#43-flink-sql-cdc-jdbc-connector","title":"4.3 \u65b9\u6848\u4e09\uff1aFlink SQL CDC + JDBC Connector","text":"<p>\u5c06\u5982\u4e0b\u67b6\u6784\u865a\u7ebf\u90e8\u5206\u7528 Flink SQL \u66ff\u6362\uff1a</p> <p></p> <p>\u6211\u4eec\u5f97\u5230\u5982\u4e0b\u6539\u8fdb\u7684\u540c\u6b65\u65b9\u6848\u67b6\u6784\uff1a</p> <p></p> <p>\u4ece\u5b98\u65b9\u7684\u63cf\u8ff0\u4e2d\uff0c\u901a\u8fc7 Flink CDC connectors \u66ff\u6362 Debezium+Kafka \u7684\u6570\u636e\u91c7\u96c6\u6a21\u5757\uff0c\u5b9e\u73b0 Flink SQL \u91c7\u96c6+\u8ba1\u7b97+\u4f20\u8f93(ETL)\u4e00\u4f53\u5316\uff0c\u4f18\u70b9\u5f88\u591a\uff1a</p> <ul> <li>\u5f00\u7bb1\u5373\u7528\uff0c\u7b80\u5355\u6613\u4e0a\u624b</li> <li>\u51cf\u5c11\u7ef4\u62a4\u7684\u7ec4\u4ef6\uff0c\u7b80\u5316\u5b9e\u65f6\u94fe\u8def\uff0c\u51cf\u8f7b\u90e8\u7f72\u6210\u672c</li> <li>\u51cf\u5c0f\u7aef\u5230\u7aef\u5ef6\u8fdf</li> <li>Flink \u81ea\u8eab\u652f\u6301 Exactly Once \u7684\u8bfb\u53d6\u548c\u8ba1\u7b97</li> <li>\u6570\u636e\u4e0d\u843d\u5730\uff0c\u51cf\u5c11\u5b58\u50a8\u6210\u672c</li> <li>\u652f\u6301\u5168\u91cf\u548c\u589e\u91cf\u6d41\u5f0f\u8bfb\u53d6</li> <li>binlog \u91c7\u96c6\u4f4d\u70b9\u53ef\u56de\u6eaf</li> </ul>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#flink-sql-cdc-jdbc-connector","title":"\u4e94. Flink SQL CDC + JDBC Connector\u540c\u6b65\u65b9\u6848\u9a8c\u8bc1","text":"","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#51","title":"5.1 \u6d4b\u8bd5\u73af\u5883\u548c\u811a\u672c","text":"<p>\u6d4b\u8bd5\u73af\u5883\u6d4b\u8bd5\u573a\u666f \u4f7f\u7528 Flink SQL CDC \u4ece MySQL \u6570\u636e\u5e93\u540c\u6b65\u6570\u636e\u5230\u76ee\u6807 MySQL\uff0cKafka\u3002</p> <pre><code>CREATE TABLE sbtest1 (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING\n) WITH (\n  'connector' = 'mysql-cdc',\n  'hostname' = '197.XXX.XXX.XXX',\n  'port' = '3306',\n  'username' = 'debezium',\n  'password' = 'PASSWORD',\n  'database-name' = 'cdcdb',\n  'table-name' = 'sbtest1',\n  'debezium.snapshot.mode' = 'initial'\n);\n\n\u5230DB\uff1a\ncreate table printSinkTable (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING,\n  primary key (id) NOT ENFORCED\n) with (\n 'connector' = 'jdbc',\n 'url' = 'jdbc:mysql://197.XXX.XXX.XXX:3306/mydb?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=UTC',\n 'username' = 'debezium',\n 'password' = 'PASSWORD',\n 'table-name' = 'sbtest',\n 'driver' = 'com.mysql.cj.jdbc.Driver',\n 'sink.buffer-flush.interval' = '3s',\n 'sink.buffer-flush.max-rows' = '1',\n 'sink.max-retries' = '5');\n INSERT INTO printSinkTable SELECT * FROM sbtest1;\n\n \u5230KAFKA\uff1a\n CREATE TABLE kafka_gmv (\n  id INT,\n  k INT,\n  c STRING,\n  pad STRING\n) WITH (\n    'connector' = 'kafka-0.11',\n    'topic' = 'kafka_gmv',\n    'scan.startup.mode' = 'earliest-offset',\n    'properties.bootstrap.servers' = '197.XXX.XXX.XXX:9092',\n    'format' = 'changelog-json'\n);\n\nINSERT INTO kafka_gmv SELECT * FROM sbtest1;\n</code></pre>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#52","title":"5.2 \u6d4b\u8bd5\u7ed3\u8bba","text":"","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#521","title":"\u25a0 5.2.1 \u529f\u80fd\u6d4b\u8bd5","text":"","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#522","title":"\u25a0 5.2.2 \u5f02\u5e38\u6d4b\u8bd5","text":"<ul> <li>\u5e38\u89c4\u529f\u80fd\u6d4b\u8bd5</li> </ul> <ul> <li>\u57fa\u4e8e DNS \u7684\u6570\u636e\u5e93\u5207\u6362\u6d4b\u8bd5</li> </ul> <p>\u6d4b\u8bd5\u793a\u610f\u56fe\uff1a</p> <p></p> <p>\u25cb Flink \u9700\u8981\u914d\u7f6e\u7684\u53c2\u6570\uff1a\u4efb\u52a1\u5931\u8d25\u540e\u5ef6\u8fdf 5 \u79d2\u91cd\u542f\uff0c\u91cd\u8bd5 10 \u6b21\u3002restart-strategy: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 5s\u3002 \u25cb MySQL \u73af\u5883\u4fe1\u606f\uff1a\u4e00\u4e3b\u5e93\u4e24\u4e2a\u4ece\u5e93\u3002 \u25cb DNS \u914d\u7f6e\uff1aDNS \u7533\u8bf7\u4e86\u4e00\u4e2a\u57df\u540d\uff1aXX.XX.cmbc.cn \u7b56\u7565\uff1a\u5f53\u524d\u57df\u540d\u6307\u5411\u5176\u4e2d\u4e00\u4e2a\u4ece\u5e93\uff0c\u63a2\u6d4b\u6570\u636e\u5e93\u670d\u52a1\u7aef\u53e3\uff0c\u6bcf\u4e2a 2 \u5206\u949f\u81ea\u52a8\u63a2\u6d4b\u4e00\u6b21\u3002\u5f53\u524d\u6570\u636e\u5e93\u5f02\u5e38\u540e DNS \u4fee\u6539\u6307\u5411\u5230\u7b2c\u4e8c\u4e2a\u4ece\u5e93\u3002 \u25cb \u64cd\u4f5c\u7cfb\u7edf\u548c JVM \u7f13\u5b58\u914d\u7f6e\uff1aJVM \u7f13\u5b58\u914d\u7f6e 30 \u79d2\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58 30 \u79d2\u3002</p> <p>\u6d4b\u8bd5\u7ed3\u679c\uff1a</p> <ol> <li>\u5f53 Flink \u53c2\u6570\u672a\u8bbe\u7f6e\u4e0a\u8ff0\u53c2\u6570\u7684\u60c5\u51b5\u4e0b\uff0ckill \u5f53\u524d\u8bbf\u95ee\u6570\u636e\u5e93\uff0cFlink \u4efb\u52a1\u62a5\u9519\u9000\u51fa\uff0c\u67e5\u770b DNS \u6ca1\u6709\u8bbf\u95ee\u8bb0\u5f55\u3002</li> <li> <p>Flink \u914d\u7f6e\u4e0a\u8ff0\u53c2\u6570\u540e\uff0cFlink \u540e\u53f0\u5c1d\u8bd5\u8bbf\u95ee\u4e0a\u8ff0\u6570\u636e\u5e93\uff0c\u672c\u5730 DNS \u7f13\u5b58\u5728\u8bbf\u95ee\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u5931\u6548\uff0c\u91cd\u65b0\u8bf7\u6c42 DNS \u57df\u540d\u670d\u52a1\u5668\u83b7\u53d6\u65b0\u6570\u636e\u5e93\u8bbf\u95ee\u4fe1\u606f\uff0c\u4efb\u52a1\u7ee7\u7eed\u590d\u5236\u3002</p> </li> <li> <p>Flink \u9ad8\u53ef\u7528\u6d4b\u8bd5</p> </li> </ol> <p>\u5728 Flink \u9ad8\u53ef\u7528\u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 Standalone \u96c6\u7fa4\u9ad8\u53ef\u7528\u6027\u65b9\u6848\u8fdb\u884c\u6d4b\u8bd5\uff0c\u4e00\u4e2a\u4e3b JobManager\uff0c\u4e00\u4e2a\u4ece JobManager\uff0c\u5f53\u4e3b\u8282\u70b9\u5f02\u5e38\u4e4b\u540e\uff0c\u5907\u9009\u8282\u70b9\u6210\u4e3a\u65b0\u7684 leader\uff0c\u5e76\u63a5\u7ba1 Flink \u96c6\u7fa4\u3002\u65b0 JobManager \u6210\u4e3a\u65b0\u7684 leader \u540e\uff0c\u96c6\u7fa4\u6062\u590d\u6b63\u5e38\uff0c\u5e76\u53ef\u4ee5\u8fdb\u884c\u4efb\u52a1\u7684\u8c03\u5ea6\uff0c\u5f02\u5e38\u7684\u4efb\u52a1\u6062\u590d\u8fd0\u884c\u3002</p> <p>\u8fd9\u91cc\u5907\u9009\u548c\u4e3b\u8282\u70b9\u662f\u4e00\u6837\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a JobManager \u90fd\u53ef\u4ee5\u5145\u5f53\u5907\u9009\u548c\u4e3b\u8282\u70b9\u3002\u5b98\u7f51\u7684\u4e0b\u56fe\u5c55\u793a\u4e86\u8fd9\u4e00\u8fc7\u7a0b\uff1a</p> <p></p> <p>\u5f02\u5e38\u6d4b\u8bd5\u6b65\u9aa4\u548c\u7ed3\u679c\u5982\u4e0b\uff1a</p> <p></p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#523","title":"\u25a0 5.2.3 \u6027\u80fd\u6d4b\u8bd5","text":"<p>\u6027\u80fd\u6d4b\u8bd5\u8fdb\u884c\u4e86\u7d2f\u8ba1\u6d4b\u8bd5\uff0c\u7528\u4ee5\u68c0\u6d4b Flink cdc \u7684\u6781\u9650\u6027\u80fd\uff0c\u5206\u522b\u6d4b\u8bd5\u4e86 kafka \u548c MySQL \u4f5c\u4e3a\u76ee\u6807\u7684\u573a\u666f\u3002</p> <ul> <li>\u6d4b\u8bd5\u63cf\u8ff0</li> </ul> <p>\u4f7f\u7528 sysbench \u8fdb\u884c\u538b\u6d4b\uff0c\u63d2\u5165 200 \u4f59\u4e07\u6570\u636e\uff0c\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>CREATE TABLE `sbtest1` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n  `k` int(10) unsigned NOT NULL DEFAULT '0',\n  `c` char(120) NOT NULL DEFAULT '',\n  `pad` char(60) NOT NULL DEFAULT '',\n  PRIMARY KEY (`id`),\n  KEY `k_1` (`k`)\n)\uff1b\n</code></pre> <p>\u7d2f\u8ba1\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\uff1a</p> <p></p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#flink-sql-cdc-jdbc-connector_1","title":"\u516d. Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5206\u6790","text":"<p>Flink SQL CDC + JDBC Connector \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a Source \u548c Sink \u5e76\u884c\u5ea6\u4e3a 1 \u7684Flink Stream Application\uff0cSource \u548c Sink \u4e4b\u95f4\u65e0 Operator\uff0c\u4e0b\u9762\u6211\u4eec\u9010\u6b65\u5206\u6790 Flink SQL CDC + JDBC Connector \u7aef\u5230\u7aef\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#61","title":"6.1 \u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5b9e\u73b0\u6761\u4ef6","text":"<p>\u4e00\u81f4\u6027\u5c31\u662f\u4e1a\u52a1\u6b63\u786e\u6027\uff0c\u5728\u201c\u6d41\u7cfb\u7edf\u4e2d\u95f4\u4ef6\u201d\u8fd9\u4e2a\u4e1a\u52a1\u9886\u57df\uff0c\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5c31\u4ee3\u8868 Exacly Once Msg Processing(\u7b80\u79f0 EOMP)\uff0c\u5373\u4e00\u4e2a\u6d88\u606f\u53ea\u88ab\u5904\u7406\u4e00\u6b21\uff0c\u9020\u6210\u4e00\u6b21\u6548\u679c\u3002\u5373\u4f7f\u673a\u5668\u6216\u8f6f\u4ef6\u51fa\u73b0\u6545\u969c\uff0c\u65e2\u6ca1\u6709\u91cd\u590d\u6570\u636e\uff0c\u4e5f\u4e0d\u4f1a\u4e22\u6570\u636e\u3002</p> <p>\u5e42\u7b49\u5c31\u662f\u4e00\u4e2a\u76f8\u540c\u7684\u64cd\u4f5c\uff0c\u65e0\u8bba\u91cd\u590d\u591a\u5c11\u6b21\uff0c\u9020\u6210\u7684\u6548\u679c\u548c\u53ea\u64cd\u4f5c\u4e00\u6b21\u76f8\u7b49\u3002 \u6d41\u7cfb\u7edf\u7aef\u5230\u7aef\u94fe\u8def\u8f83\u957f\uff0c\u6d89\u53ca\u5230\u4e0a\u6e38 Source \u5c42\u3001\u4e2d\u95f4\u8ba1\u7b97\u5c42\u548c\u4e0b\u6e38 Sink \u5c42\u4e09\u90e8\u5206\uff0c\u8981\u5b9e\u73b0\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\uff0c\u9700\u8981\u5b9e\u73b0\u4ee5\u4e0b\u6761\u4ef6\uff1a</p> <ul> <li>\u4e0a\u6e38\u53ef\u4ee5 replay\uff0c\u5426\u5219\u4e2d\u95f4\u8ba1\u7b97\u5c42\u6536\u5230\u6d88\u606f\u540e\u672a\u8ba1\u7b97\uff0c\u5374\u53d1\u751f failure \u800c\u91cd\u542f\uff0c\u6d88\u606f\u5c31\u4f1a\u4e22\u5931\u3002</li> <li>\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751f failure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751f failure\uff0c\u5c31\u4f1a replay \u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002</li> <li>\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751f failure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684 DataStore\u91cc\u3002</li> <li>\u4e0b\u6e38\u53bb\u91cd\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</li> </ul> <p>\u5728 Flink SQL CDC + JDBC Connector \u65b9\u6848\u4e2d\uff0c\u4e0a\u6e38\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u65e5\u5fd7\uff0c\u662f\u53ef\u4ee5 replay \u7684\uff0c\u6ee1\u8db3\u6761\u4ef61\u201c\u4e0a\u6e38\u53ef replay\u201d\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5206\u522b\u5206\u6790 Flink SQL CDC \u5982\u4f55\u5b9e\u73b0\u6761\u4ef6 2 \u548c 3\uff0cJDBCConnector \u5982\u4f55\u5b9e\u73b0\u6761\u4ef6 4\uff0c\u6700\u7ec8\u5b9e\u73b0\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\u3002\u4ee5 MySQL-&gt;MySQL \u4e3a\u4f8b\uff0c\u67b6\u6784\u56fe\u5982\u4e0b\uff08\u76ee\u524d Flink SQL \u662f\u4e0d\u652f\u6301 Source/Sink \u5e76\u884c\u5ea6\u914d\u7f6e\u7684\uff0cFlink SQL \u4e2d\u5404\u7b97\u5b50\u5e76\u884c\u5ea6\u9ed8\u8ba4\u662f\u6839\u636e Source \u7684 Partition \u6570\u6216\u6587\u4ef6\u6570\u6765\u51b3\u5b9a\u7684\uff0c\u800c DebeziumSource \u7684\u5e76\u884c\u5ea6\u662f 1\uff0c\u56e0\u6b64\u6574\u4e2a Flink Task \u7684\u5e76\u884c\u5ea6\u4e3a 1\uff09\uff1a</p> <p></p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#62-flink-sql-cdc","title":"6.2 Flink SQL CDC \u7684\u4e00\u81f4\u6027\u4fdd\u8bc1","text":"<p>Flink SQL CDC \u7528\u4e8e\u83b7\u53d6\u6570\u636e\u5e93\u53d8\u66f4\u65e5\u5fd7\u7684 Source \u51fd\u6570\u662f DebeziumSourceFunction\uff0c\u4e14\u6700\u7ec8\u8fd4\u56de\u7684\u7c7b\u578b\u662f RowData\uff0c\u8be5\u51fd\u6570\u5b9e\u73b0\u4e86 CheckpointedFunction\uff0c\u5373\u901a\u8fc7 Checkpoint \u673a\u5236\u6765\u4fdd\u8bc1\u53d1\u751f failure \u65f6\u4e0d\u4f1a\u4e22\u6570\uff0c\u5b9e\u73b0 exactly once \u8bed\u4e49\uff0c\u8fd9\u90e8\u5206\u5728\u51fd\u6570\u7684\u6ce8\u91ca\u4e2d\u6709\u660e\u786e\u7684\u89e3\u91ca\u3002</p> <pre><code>/**\n * The {@link DebeziumSourceFunction} is a streaming data source that pulls captured change data\n * from databases into Flink.\n * \u901a\u8fc7Checkpoint\u673a\u5236\u6765\u4fdd\u8bc1\u53d1\u751ffailure\u65f6\u4e0d\u4f1a\u4e22\u6570\uff0c\u5b9e\u73b0exactly once\u8bed\u4e49\n * &lt;p&gt;The source function participates in checkpointing and guarantees that no data is lost\n * during a failure, and that the computation processes elements \"exactly once\".\n * \u6ce8\u610f\uff1a\u8fd9\u4e2aSource Function\u4e0d\u80fd\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u5b9e\u4f8b\n * &lt;p&gt;Note: currently, the source function can't run in multiple parallel instances.\n *\n * &lt;p&gt;Please refer to Debezium's documentation for the available configuration properties:\n * https://debezium.io/documentation/reference/1.2/development/engine.html#engine-properties&lt;/p&gt;\n */\n@PublicEvolving\npublic class DebeziumSourceFunction&lt;T&gt; extends RichSourceFunction&lt;T&gt; implements\n  CheckpointedFunction,\n  ResultTypeQueryable&lt;T&gt; {\n</code></pre> <p>\u4e3a\u5b9e\u73b0 CheckpointedFunction\uff0c\u9700\u8981\u5b9e\u73b0\u4ee5\u4e0b\u4e24\u4e2a\u65b9\u6cd5\uff1a</p> <pre><code>public interface CheckpointedFunction {\n  //\u505a\u5feb\u7167\uff0c\u628a\u5185\u5b58\u4e2d\u7684\u6570\u636e\u4fdd\u5b58\u5728checkpoint\u72b6\u6001\u4e2d\n  void snapshotState(FunctionSnapshotContext var1) throws Exception;\n\n  //\u7a0b\u5e8f\u5f02\u5e38\u6062\u590d\u540e\u4ececheckpoint\u72b6\u6001\u4e2d\u6062\u590d\u6570\u636e\n  void initializeState(FunctionInitializationContext var1) throws Exception;\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770b DebeziumSourceFunction \u4e2d\u90fd\u8bb0\u5f55\u4e86\u54ea\u4e9b\u72b6\u6001\u3002</p> <pre><code>/** Accessor for state in the operator state backend. \n    offsetState\u4e2d\u8bb0\u5f55\u4e86\u8bfb\u53d6\u7684binlog\u6587\u4ef6\u548c\u4f4d\u79fb\u4fe1\u606f\u7b49\uff0c\u5bf9\u5e94Debezium\u4e2d\u7684\n*/\n private transient ListState&lt;byte[]&gt; offsetState;\n\n/**\n * State to store the history records, i.e. schema changes.\n * historyRecordsState\u8bb0\u5f55\u4e86schema\u7684\u53d8\u5316\u7b49\u4fe1\u606f\n * @see FlinkDatabaseHistory\n*/\n private transient ListState&lt;String&gt; historyRecordsState;\n</code></pre> <p>\u518d\u56de\u5230\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u7684\u6761\u4ef6 2 \u548c 3</p> <p>2.\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751ffailure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751ffailure\uff0c\u5c31\u4f1areplay\u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002 </p> <p>3.\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751ffailure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684DataStore\u91cc\u3002</p> <p>\u6211\u4eec\u53d1\u73b0\u5728 Flink SQL CDC \u662f\u4e00\u4e2a\u76f8\u5bf9\u7b80\u6613\u7684\u573a\u666f\uff0c\u6ca1\u6709\u4e2d\u95f4\u7b97\u5b50\uff0c\u662f\u901a\u8fc7 Checkpoint \u6301\u4e45\u5316 binglog \u6d88\u8d39\u4f4d\u79fb\u548c schema \u53d8\u5316\u4fe1\u606f\u7684\u5feb\u7167\uff0c\u6765\u5b9e\u73b0 Exactly Once\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5206\u6790 Sink \u7aef\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#621-jdbc-sink-connector","title":"\u25a0 6.2.1 JDBC Sink Connector \u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027","text":"<p>\u6211\u4eec\u5728\u5b98\u7f51\u4e0a\u53d1\u73b0\u5bf9\u4e8e JDBC Sink Connector \u7684\u5e42\u7b49\u6027\u4e2d\u6709\u5982\u4e0b\u89e3\u91ca\uff1a</p> <p>\u5982\u679c\u5b9a\u4e49\u4e86\u4e3b\u952e\uff0cJDBC \u5199\u5165\u65f6\u662f\u80fd\u591f\u4fdd\u8bc1 Upsert \u8bed\u4e49\u7684\uff0c \u5982\u679c DB \u4e0d\u652f\u6301 Upsert \u8bed\u6cd5\uff0c\u5219\u4f1a\u9000\u5316\u6210 DELETE + INSERT \u8bed\u4e49\u3002Upsert query \u662f\u539f\u5b50\u6267\u884c\u7684\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5e42\u7b49\u6027\u3002</p> <p>\u8fd9\u4e2a\u5728\u5b98\u65b9\u6587\u6863\u4e2d\u4e5f\u8be6\u7ec6\u63cf\u8ff0\u4e86\u66f4\u65b0\u5931\u8d25\u6216\u8005\u5b58\u5728\u6545\u969c\u65f6\u5019\u5982\u4f55\u505a\u51fa\u7684\u5904\u7406\uff0c\u4e0b\u9762\u7684\u8868\u683c\u662f\u4e0d\u540c\u7684 DB \u5bf9\u5e94\u4e0d\u540c\u7684 Upsert \u8bed\u6cd5\uff1a</p> <pre><code>Database    Upsert Grammar\nMySQL    INSERT .. ON DUPLICATE KEY UPDATE ..\nPostgreSQL    INSERT .. ON CONFLICT .. DO UPDATE SET ..\n</code></pre> <p>\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5199\u5165\u65f6\u4fdd\u8bc1 Upsert \u8bed\u4e49\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e0b\u6e38 Sink \u7aef\u7684\u5e42\u7b49\u6027\uff0c\u518d Review \u4e00\u6b21\u5230\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u5b9e\u73b0\u6761\u4ef6 4\uff0c\u4e0b\u6e38\u53bb\u91cd\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0\u5e42\u7b49\u4ece\u800c\u5b9e\u73b0\u4e0b\u6e38\u7684 Exactly Once \u8bed\u4e49\u3002</p> <p>4.\u4e0b\u6e38\u53bb\u91cd\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#622-flink-sql-cdc-jdbc-sink-connector","title":"\u25a0 6.2.2 Flink SQL CDC + JDBC Sink Connector \u7ec4\u5408\u540e\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027","text":"<p>\u5728\u524d\u4e24\u5c0f\u8282\u6211\u4eec\u5206\u6790\u4e86\u7ec4\u4ef6\u5404\u81ea\u5982\u4f55\u4fdd\u8bc1\u4e00\u81f4\u6027\uff0c\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5206\u6790\u7ec4\u5408\u540e\u5728\u6e90\u5e93\u5f02\u5e38\u3001Flink \u4f5c\u4e1a\u5f02\u5e38\u3001\u76ee\u6807\u5e93\u5f02\u5e38\u4e09\u79cd\u5f02\u5e38\u573a\u666f\u4e0b\u5982\u4f55\u4fdd\u8bc1\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u3002</p> <p></p> <ul> <li>Debezium Source \u5bf9 MySQL \u8fdb\u884c Snapshot \u65f6\u53d1\u751f\u5f02\u5e38</li> </ul> <p>\u5728 Flink Task \u542f\u52a8\u540e\uff0c\u9996\u5148\u4f1a\u8fdb\u884c MySQL \u5168\u8868\u626b\u63cf\uff0c\u4e5f\u5c31\u662f\u505a Snapshot\uff0c\u8fd9\u91cc\u6709\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u5c31\u662f\uff0c\u5728 Snapshot \u9636\u6bb5\uff0c\u5728\u626b\u63cf\u5168\u8868\u6570\u636e\u65f6\uff0c\u6ca1\u6709\u53ef\u7528\u4e8e\u6062\u590d\u7684\u4f4d\u70b9\uff0c\u6240\u4ee5\u65e0\u6cd5\u5728\u5168\u8868\u626b\u63cf\u9636\u6bb5\u53bb\u6267\u884c Checkpoint\u3002\u4e3a\u4e86\u4e0d\u6267\u884c Checkpoint\uff0cMySQL \u7684 CDC \u6e90\u8868\u4f1a\u8ba9\u6267\u884c\u4e2d\u7684 Checkpoint \u4e00\u76f4\u7b49\u5f85\uff08\u901a\u8fc7\u6301\u6709 checkpoint \u9501\u5b9e\u73b0\uff09\uff0c\u751a\u81f3 Checkpoint \u8d85\u65f6\uff08\u5982\u679c\u8868\u8d85\u7ea7\u5927\uff0c\u626b\u63cf\u8017\u65f6\u975e\u5e38\u957f\uff09\u3002\u8fd9\u5757\u53ef\u4ee5\u4ece DebeziumChangeConsumer \u7684\u4ee3\u7801\u4e2d\u770b\u5230\uff1a</p> <pre><code>@Override\n public void handleBatch(\n   List&lt;ChangeEvent&lt;SourceRecord, SourceRecord&gt;&gt; changeEvents,\n   DebeziumEngine.RecordCommitter&lt;ChangeEvent&lt;SourceRecord, SourceRecord&gt;&gt; committer) throws InterruptedException {\n  try {\n   for (ChangeEvent&lt;SourceRecord, SourceRecord&gt; event : changeEvents) {\n    SourceRecord record = event.value();\n    deserialization.deserialize(record, debeziumCollector);\n\n    if (isInDbSnapshotPhase) {\n     if (!lockHold) {\n      MemoryUtils.UNSAFE.monitorEnter(checkpointLock);\n      lockHold = true;\n            //\u5728snapshot\u9636\u6bb5\u4e0d\u505acheckpoint\n      LOG.info(\"Database snapshot phase can't perform checkpoint, acquired Checkpoint lock.\");\n     }\n     if (!isSnapshotRecord(record)) {\n      MemoryUtils.UNSAFE.monitorExit(checkpointLock);\n      isInDbSnapshotPhase = false;\n      LOG.info(\"Received record from streaming binlog phase, released checkpoint lock.\");\n     }\n    }\n\n    // emit the actual records. this also updates offset state atomically\n    emitRecordsUnderCheckpointLock(debeziumCollector.records, record.sourcePartition(), record.sourceOffset());\n   }\n      ...\n</code></pre> <p>\u5728\u505a Snapshot \u9636\u6bb5\uff0c\u53ef\u80fd\u4f1a\u78b0\u5230\u6e90\u5e93 MySQL \u5f02\u5e38\u6216\u8005 Flink \u4efb\u52a1\u672c\u8eab\u5f02\u5e38\uff0c\u90a3\u6211\u4eec\u5206\u522b\u5206\u6790\u4e0b\u5f02\u5e38\u540e\u5982\u4f55\u6062\u590d\uff1a</p> <ol> <li>\u82e5\u9047\u5230\u6e90\u5e93 MySQL \u5f02\u5e38\uff0cFlink Task \u53d1\u73b0\u65e0\u6cd5\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u9000\u51fa\uff0c\u91cd\u65b0\u542f\u52a8 Flink Task\uff08\u6216\u8005 retry\uff09\uff0c\u56e0\u4e3a\u6ca1\u6709\u505a snapshot \u6ca1\u505a checkpoint\uff0c\u90a3\u4e48\u4f1a\u91cd\u65b0\u518d\u505a\u4e00\u6b21 Snapshot\uff0c\u8fd9\u4e9b\u5168\u91cf\u6570\u636e\u6700\u540e\u53d1\u9001\u5230\u76ee\u7684 MySQL\uff0c\u7531\u4e8e\u4e0b\u6e38 MySQL \u5b9e\u73b0\u4e86\u5199\u5e42\u7b49\uff0c\u56e0\u6b64\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li> <li>\u82e5\u9047\u5230 Flink \u4efb\u52a1\u5f02\u5e38\uff0c\u91cd\u65b0\u542f\u52a8\uff08\u6216\u8005 retry\uff09\uff0c\u540c\u4e0a\u9762\u60c5\u51b5\u4e00\u6837\uff0c\u91cd\u65b0\u505a\u4e00\u6b21 Snapshot\uff0c\u6700\u7ec8\u4e5f\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li> <li> <p>\u82e5\u9047\u5230\u76ee\u6807\u5e93 MySQL \u5f02\u5e38\uff0c\u540c\u573a\u666f\u4e00\u4e00\u81f4\uff0cFlink Task \u65e0\u6cd5\u5f80\u76ee\u6807\u6570\u636e\u5e93\u5199\u5165\u5f02\u5e38\u9000\u51fa\uff0c\u5728\u9700\u8981\u91cd\u65b0\u542f\u52a8\u6216 retry \u540e\uff0c\u91cd\u65b0\u505a\u4e00\u6b21 Snapshot\uff0c\u5168\u91cf\u6570\u636e\u6700\u540e\u53d1\u9001\u5230\u76ee\u7684 MySQL\uff0c\u7531\u4e8e\u76ee\u7684\u4e0b\u6e38 M \u6709 SQL \u5b9e\u73b0\u4e86\u5199\u5e42\u7b49\uff0c\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</p> </li> <li> <p>Snapshot \u5b8c\u6210\u540e\u8bfb\u53d6 binlog \u65f6\u53d1\u751f\u5f02\u5e38</p> </li> </ol> <p>\u5728\u5168\u91cf\u6570\u636e\u5b8c\u6210\u540c\u6b65\u540e\uff0c\u5f00\u59cb\u8fdb\u884c\u589e\u91cf\u83b7\u53d6\uff0c\u6b64\u65f6 Flink \u4f1a\u8fdb\u884c\u5b9a\u65f6 Checkpoint\uff0c\u5c06\u8bfb\u53d6 binlog \u7684\u4f4d\u79fb\u4fe1\u606f\u548c schema \u4fe1\u606f\u5b58\u5165\u5230 StateBackend\uff0c\u82e5\u6b64\u65f6\u53d1\u751f\u5f02\u5e38\uff0c\u90a3\u6211\u4eec\u5206\u6790\u4e0b\u5f02\u5e38\u540e\u5982\u4f55\u6062\u590d\uff1a</p> <ol> <li>\u82e5\u6e90 MySQL \u5f02\u5e38\uff0cFlink Task \u53d1\u73b0\u65e0\u6cd5\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u9000\u51fa\uff0c\u91cd\u65b0\u542f\u52a8 Flink Task\uff08\u6216\u8005 retry\uff09\uff0c\u5c06\u4f1a\u4ece\u6700\u8fd1\u4e00\u6b21 Checkpoint \u7684\u6570\u636e\u8fdb\u884c\u6062\u590d\uff0c\u7531\u4e8e\u53ef\u4ee5\u8bfb\u53d6\u5230 mysql binlog \u4f4d\u79fb\u4fe1\u606f\uff0c\u5b9e\u73b0\u7ee7\u7eed\u540c\u6b65\uff0c\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u6700\u7ec8\u4e5f\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li> <li>\u82e5 Flink \u4efb\u52a1\u5f02\u5e38\uff0c\u91cd\u65b0\u542f\u52a8\u6216 retry \u540e\uff0c\u540c\u573a\u666f 1 \u4e00\u81f4\uff0c\u7ee7\u7eed\u8bfb\u53d6 binlog\uff0c\u80fd\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li> <li>\u82e5\u76ee\u7684 MySQL \u5f02\u5e38\uff0cjdbc connector \u65e0\u6cd5\u5f80\u76ee\u6807\u6570\u636e\u5e93\u5199\u5165\uff0ccdc connector \u8bfb\u53d6\u5230\u7684 binlog \u4f4d\u79fb\u4fe1\u606f\u4e5f\u4e0d\u518d\u66f4\u65b0\uff0c\u4e24\u4e2a\u64cd\u4f5c\u662f\u4e00\u4e2a\u539f\u5b50\u6027\u64cd\u4f5c\uff0c\u5728 Flink Task \u6062\u590d\u540e\uff0c\u4ece\u6700\u8fd1\u4e00\u6b21 Checkpoint \u8fdb\u884c\u6062\u590d\uff0c\u6700\u7ec8\u4fdd\u6301\u4e00\u81f4\u6027\u3002</li> </ol>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#63","title":"6.3 \u603b\u7ed3","text":"<p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u7aef\u5230\u7aef\u4e00\u81f4\u6027\u9700\u8981\u5404\u4e2a\u7ec4\u4ef6\u53c2\u4e0e\u5b9e\u73b0\uff0cFlink SQL CDC + JDBC Connector \u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u6cd5\u4fdd\u8bc1\u7aef\u5230\u7aef\u7684\u4e00\u81f4\u6027\uff1a</p> <ul> <li>\u6e90\u7aef\u662f\u6570\u636e\u5e93\u7684 binlog \u65e5\u5fd7\uff0c\u5168\u91cf\u540c\u6b65\u505a Snapshot \u5f02\u5e38\u540e\u53ef\u4ee5\u518d\u6b21\u505a Snapshot\uff0c\u589e\u91cf\u540c\u6b65\u65f6\uff0cFlink SQL CDC \u4e2d\u4f1a\u8bb0\u5f55\u8bfb\u53d6\u7684\u65e5\u5fd7\u4f4d\u79fb\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5 replay</li> <li>Flink SQL CDC \u4f5c\u4e3a Source \u7ec4\u4ef6\uff0c\u662f\u901a\u8fc7 Flink Checkpoint \u673a\u5236\uff0c\u5468\u671f\u6027\u6301\u4e45\u5316\u5b58\u50a8\u6570\u636e\u5e93\u65e5\u5fd7\u6587\u4ef6\u6d88\u8d39\u4f4d\u79fb\u548c\u72b6\u6001\u7b49\u4fe1\u606f\uff08StateBackend \u5c06 checkpoint \u6301\u4e45\u5316\uff09\uff0c\u8bb0\u5f55\u6d88\u8d39\u4f4d\u79fb\u548c\u5199\u5165\u76ee\u6807\u5e93\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u4fdd\u8bc1\u53d1\u751f failure \u65f6\u4e0d\u4e22\u6570\u636e\uff0c\u5b9e\u73b0 Exactly Once</li> <li>JDBC Sink Connecotr \u662f\u901a\u8fc7\u5199\u5165\u65f6\u4fdd\u8bc1 Upsert \u8bed\u4e49\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e0b\u6e38\u7684\u5199\u5165\u5e42\u7b49\u6027\uff0c\u5b9e\u73b0 Exactly Once</li> </ul> <p>\u518d\u6765\u56de\u987e\u4e00\u4e0b\u7aef\u5230\u7aef\u4fdd\u6301\u4e00\u81f4\u6027\u7684\u6761\u4ef6\uff0c\u53d1\u73b0\u5168\u90fd\u80fd\u6ee1\u8db3\u3002</p> <p>1.\u4e0a\u6e38\u53ef\u4ee5 replay\uff0c\u5426\u5219\u4e2d\u95f4\u8ba1\u7b97\u5c42\u6536\u5230\u6d88\u606f\u540e\u672a\u8ba1\u7b97\uff0c\u5374\u53d1\u751f failure \u800c\u91cd\u542f\uff0c\u6d88\u606f\u5c31\u4f1a\u4e22\u5931\u3002</p> <p>2.\u8bb0\u5f55\u6d88\u606f\u5904\u7406\u8fdb\u5ea6\uff0c\u5e76\u4fdd\u8bc1\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u51fa\u73b0\u91cd\u590d\uff0c\u4e8c\u8005\u662f\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6216\u8005\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u662f\u4e2a\u5e42\u7b49\u64cd\u4f5c\uff0c\u5426\u5219\u82e5\u5148\u8bb0\u5f55\u5904\u7406\u8fdb\u5ea6\uff0c\u518d\u5b58\u50a8\u8ba1\u7b97\u7ed3\u679c\u65f6\u53d1\u751f failure\uff0c\u8ba1\u7b97\u7ed3\u679c\u4f1a\u4e22\u5931\uff0c\u6216\u8005\u662f\u8bb0\u5f55\u5b8c\u8ba1\u7b97\u7ed3\u679c\u518d\u53d1\u751f failure\uff0c\u5c31\u4f1a replay \u751f\u6210\u591a\u4e2a\u8ba1\u7b97\u7ed3\u679c\u3002</p> <p>3.\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u9ad8\u53ef\u7528\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5728\u63a5\u5230\u8ba1\u7b97\u7ed3\u679c\u540e\u53d1\u751f failure\uff0c\u5e76\u672a\u6210\u529f\u5904\u7406\u8be5\u7ed3\u679c\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u4e2d\u95f4\u8ba1\u7b97\u7ed3\u679c\u653e\u5728\u9ad8\u53ef\u7528\u7684 DataStore \u91cc\u3002</p> <p>4.\u4e0b\u6e38\u53bb\u91cd\uff0c\u5e94\u5bf9\u4e0b\u6e38\u5904\u7406\u5b8c\u6d88\u606f\u540e\u53d1\u751f failure\uff0c\u91cd\u590d\u63a5\u6536\u6d88\u606f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u53ef\u901a\u8fc7\u7ed9\u6d88\u606f\u8bbe\u7f6e SequcenceId \u5b9e\u73b0\u53bb\u91cd\uff0c\u6216\u8005\u4e0b\u6e38\u5b9e\u73b0\u5e42\u7b49\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/flink-cdc-practices/#flink-sql-cdc_1","title":"\u4e03. Flink SQL CDC \u76ee\u524d\u5b58\u5728\u7684\u7f3a\u9677","text":"<ul> <li>\u4f7f\u7528\u6b63\u5219\u5339\u914d\u539f\u8868\u540e\uff08\u591a\u4e2a\u6e90\u7aef\u8868\uff09\uff0c\u5230\u76ee\u6807\u8868\u65e0\u6cd5\u8fdb\u884c\u4e00\u5bf9\u4e00\u7684\u6620\u5c04\u3002\u9700\u8981\u9010\u4e2a\u5339\u914d\u3002</li> <li>CDC source \u7aef\u5b9a\u4e49\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u6240\u6709\u5b57\u6bb5\uff0c\u76ee\u524d\u4e0d\u652f\u6301\u7701\u7565\u5b57\u6bb5\u5b9a\u4e49\u3002</li> <li>CDC \u5230 KAFKA \u65f6\u65e0\u6cd5\u6309\u7167\u4e3b\u952e\u8fdb\u884c\u81ea\u52a8\u5206\u533a\u5206\u53d1\u3001\u65e0\u6cd5\u6307\u5b9a\u5206\u533a\u952e\u5206\u53d1\u6570\u636e\u3002\u5230 KAFKA \u7684\u6570\u636e\u683c\u5f0f\u6307\u5b9a\uff08JSON\uff0cAVRO JSON\u7b49\uff09\u3002</li> <li>\u76ee\u6807\u7aef\u652f\u6301\u9700\u6c42\uff1aDB2\u3001ADB/GreenPlum\u3001Oracle \u6682\u4e0d\u652f\u6301\u3002\u4e0d\u652f\u6301 DDL\u540c\u6b65\uff0c\u4e0d\u652f\u6301\u8868\u7684\u521b\u5efa\u3002</li> <li>\u4efb\u52a1\u7ba1\u7406\u548c\u76d1\u63a7\u7684 REST API \u4e0d\u5b8c\u5584\u3002</li> </ul> <p>\u53c2\u8003\u8d44\u6599\uff1a</p> <p>\u7aef\u5230\u7aef\u4e00\u81f4\u6027\uff0c\u6d41\u7cfb\u7edf Spark/Flink/Kafka/DataFlow \u5bf9\u6bd4\u603b\u7ed3https://zhuanlan.zhihu.com/p/77677075 \u57fa\u4e8e Flink SQL CDC \u7684\u5b9e\u65f6\u6570\u636e\u540c\u6b65\u65b9\u6848https://developer.aliyun.com/article/777502 Flink SQL 1.11 \u65b0\u529f\u80fd\u4e0e\u6700\u4f73\u5b9e\u8df5https://developer.aliyun.com/article/771773 \u5206\u5e03\u5f0f\u5feb\u7167\u7b97\u6cd5 https://zhuanlan.zhihu.com/p/53482103</p> <p>\u4f5c\u8005\u4ecb\u7ecd\uff1a</p> <p>\u6587\u4e54\uff1a2012 \u5e74\u7855\u58eb\u6bd5\u4e1a\u540e\u52a0\u5165\u6c11\u751f\u94f6\u884c\u751f\u4ea7\u8fd0\u8425\u90e8\u7cfb\u7edf\u7ba1\u7406\u4e2d\u5fc3\uff0c\u5929\u773c\u65e5\u5fd7\u5e73\u53f0\u4e3b\u8981\u53c2\u4e0e\u4eba\uff0c\u76ee\u524d\u5728\u5f00\u6e90\u5de5\u5177\u7ec4\u8d1f\u8d23 Flume\u3001Kafka \u7684\u6e90\u7801\u7814\u7a76\u548c\u5de5\u5177\u5f00\u53d1\u7b49\u76f8\u5173\u5de5\u4f5c\u3002</p> <p>\u738b\u5065\uff1a2011 \u5e74\u52a0\u5165\u6c11\u751f\u94f6\u884c\u79d1\u6280\u90e8\uff0c\u6570\u636e\u5e93\u7ba1\u7406\u5458\uff08\u8d1f\u8d23 DB2\uff0cOracle\uff0cMySQL \u7b49\u8fd0\u7ef4\u5de5\u4f5c\uff0c\u5bf9 MPP \u7b49\u6570\u636e\u5e93\u6709\u5f88\u957f\u7684\u7ef4\u62a4\u548c\u5b9e\u65bd\u7ecf\u9a8c\uff0c\u64c5\u957f\u6570\u636e\u8fc1\u79fb\u7b49\u7b49\uff09\uff0c\u540c\u65f6\u8d1f\u8d23\u884c\u5185 KAFKA \u96c6\u7fa4\u8fd0\u7ef4\u548c\u5b9e\u65bd\u5de5\u4f5c\uff0c\u8d1f\u8d23\u884c\u5185\u6570\u636e\u5e93\u5b9e\u65f6\u590d\u5236\u7b49\u5de5\u4f5c\u3002</p>","tags":["flink","cdc"]},{"location":"bigdata/integrating-hive-with-spark/","title":"Integrating Apache Hive with Apache Spark - HWAR","text":"<p>Source</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#article","title":"Article","text":"<p>Short Description: This article targets to describe and demonstrate Apache Hive Warehouse Connector which is a newer generation to read and write data between Apache Spark and Apache Hive.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#1-motivation","title":"1. Motivation","text":"<p>Apache Spark and Apache Hive integration has always been an important use case and continues to be so. Both provide their own efficient ways to process data by the use of SQL, and is used for data stored in distributed file systems. Both provide compatibilities for each other. As both systems evolve, it is critical to find a solution that provides the best of both worlds for data processing needs.</p> <p>In case of Apache Spark, it provides a basic Hive compatibility. It allows an access to tables in Apache Hive and some basic use cases can be achieved by this. However, not all the modern features from Apache Hive are supported, for instance, ACID table in Apache Hive, Ranger integration, Live Long And Process (LLAP), etc. as of Spark 2.</p> <p>Apache Spark supports a pluggable approach for various data sources and Apache Hive itself can be also considered as one data source. Therefore, this library, Hive Warehouse Connector, was implemented as a data source to overcome the limitations and provide those modern functionalities in Apache Hive to Apache Spark users.</p> <p>Note: From HDP 3.0, catalogs for Apache Hive and Apache Spark are separated, and they use their own catalog; namely, they are mutually exclusive - Apache Hive catalog can only be accessed by Apache Hive or this library, and Apache Spark catalog can only be accessed by existing APIs in Apache Spark . In other words, some features such as ACID tables or Apache Ranger with Apache Hive table are only available via this library in Apache Spark. Those tables in Hive should not directly be accessible within Apache Spark APIs themselves.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#2-introduction","title":"2. Introduction","text":"<p>This library provides both Scala (Java compatible) and Python APIs for:</p> <ul> <li>SQL / DataFrame APIs interacting with both transactional and non-transactional tables in Apache Hive</li> <li>SQL / DataFrame read support</li> <li>SQL / DataFrame and Structured Streaming write support</li> </ul>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#21-sql-dataframe-read-support","title":"2.1. SQL / DataFrame Read Support","text":"<ul> <li>Live Long And Process (LLAP) is fully utilized which Apache Hive introduced for faster performance</li> <li>Apache Spark's Apache Arrow integration is fully utilized for vectorized operations, faster and compact data interactions</li> <li>It is implemented by Data Source V2 which has a columnar format support and various functionalities</li> </ul> <p>Note: This diagram shows read execution path to illustrate the key points.</p> <p>For instance, it is able to read an Apache Hive table in Apache Spark as below:</p> <pre><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\nval df = hive.executeQuery(\"SELECT * FROM tableA\")\n</code></pre> <p>It leverages Apache Hive LLAP and retrieves data from Hive table into Spark DataFrame.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#22-sql-dataframe-structured-streaming-write-support","title":"2.2. SQL / DataFrame &amp; Structured Streaming Write Support","text":"<ul> <li>Hive Streaming API is used in both batch and streaming write, which Apache Hive introduced to continuously digest data.</li> <li>Since it is implemented by Data Source V2, it supports a commit protocol and supports atomic write operation.</li> <li>Native Apache ORC writer is used instead, which has many important fixes in terms of performance and stability.</li> </ul> <p>The code below illustrate writing data from Apache Spark to Apache Hive table in Structured Streaming.</p> <pre><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\ndf.writeStream\n  .format(HiveWarehouseSession.STREAM_TO_STREAM)\n  .option(\"table\", \"hwx_table\").start()\n</code></pre> <p>Internally this fully utilizes Apache Hive\u2019s Streaming API to write Apache\u2019s DataFrame out to Apache Hive\u2019s table.</p> <p>** Note**: This does not need Hive LLAP daemons to be running.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#3-prerequisites","title":"3. Prerequisites","text":"<p>In Apache Hive:</p> <ul> <li>\u2018Interactive Query' (LLAP) should be enabled (see 7. Appendix for Apache Ambari UI)</li> </ul> <p>In Apache Spark:</p> <ul> <li><code>spark.hadoop.hive.llap.daemon.service.hosts</code> should be set for the application name of the LLAP service since this library utilizes LLAP. For example, <code>@llap0</code>.</li> <li>HiveServer2's JDBC URL should be specified in <code>spark.sql.hive.hiveserver2.jdbc.url</code> as well as configured in the cluster. For example, <code>jdbc:hive2://localhost:10000</code>. Use the HiveServer2 Interactive JDBC URL, rather than the traditional HiveServer2's JDBC URL.</li> <li>Make sure <code>spark.datasource.hive.warehouse.load.staging.dir</code> is pointed into a suitable HDFS-compatible staging directory, e.g. <code>/tmp</code>.</li> <li>Also, ensure <code>spark.datasource.hive.warehouse.metastoreUri</code> is configured properly. For example, <code>thrift://localhost:9083</code> to indicate Metastore URI.</li> <li>Note that <code>spark.security.credentials.hiveserver2.enabled</code> should be set to <code>false</code> for YARN client deploy mode, and <code>true</code> for YARN cluster deploy mode (by default). This configuration is required for a Kerberized cluster.</li> <li>When <code>spark.security.credentials.hiveserver2.enabled</code> is set to <code>false</code>, <code>spark.sql.hive.hiveserver2.jdbc.url.principal</code> can be optionally set if <code>spark.sql.hive.hiveserver2.jdbc.url</code> does not contain <code>principal</code>, for example, <code>hive/_HOST@EXAMPLE.COM</code>.</li> <li>When <code>spark.security.credentials.hiveserver2.enabled</code> is set to <code>true</code>, <code>spark.sql.hive.hiveserver2.jdbc.url.principal</code> should be set, for example, <code>hive/_HOST@EXAMPLE.COM</code>. Also, <code>spark.sql.hive.hiveserver2.jdbc.url</code> should not contain <code>principal</code>.</li> </ul>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#4-user-scenarios","title":"4. User Scenarios","text":"<p>In this chapter, HDP 3.0.1.0 with Spark2, Hive and Ranger on a Kerberized cluster is used. Note that If you are running the examples on Kerberized cluster, for instance in HDP, make sure to obtain (or renew) the Kerberos ticket-granting ticket by kinit with an appropriate keytab.</p> <p>The following scenarios are run by Spark shell as below. For other interaction paradigms, like spark-submit, Livy, Zeppelin etc. please see the subsequent sections for specific setup steps.</p> <p>In case of Scala:</p> <pre><code>$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre> <p>In case of Python:</p> <pre><code>$ pyspark --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#41-sql-dataframe-read","title":"4.1. SQL / DataFrame Read","text":"<p>This scenario targets to demonstrate a bulk read operation, as a batch job, from Hive table to Spark DataFrame with SQL expression. For this scenario, data from FBI crime rate is used (see 7. Appendix for <code>SQL INSERT</code> queries).</p> <p>Before we start, we should initialize <code>HiveWarehouseSession</code> instance.</p> <p>In case of Scala:</p> <pre><code>import com.hortonworks.hwc.HiveWarehouseSession\nval hive = HiveWarehouseSession.session(spark).build()\n</code></pre> <p>In case of Python:</p> <pre><code>from pyspark_llap.sql.session import HiveWarehouseSession\nhive = HiveWarehouseSession.session(spark).build()\n</code></pre> <p>In this scenarios, it uses hwc_db database. The code below shows the decreasing crime rate (per 100,000 Inhabitants) between 2000 and 2010 in USA:</p> <pre><code>hive.setDatabase(\"hwc_db\")\nhive.table(\"crimes\").filter(\"year = 2000 OR year = 2010\").show()\n+----+----------+\n|year|crime_rate|\n+----+----------+\n|2010|     404.5|\n|2000|     506.5|\n+----+----------+\n</code></pre> <p>SQL queries can be also directly executed via executeQuery API, which directly interacts with Hive LLAP daemons.</p> <pre><code>hive.executeQuery(\"SELECT avg(crime_rate) AS average_crime_rate FROM crimes\").show()\n+------------------+\n|average_crime_rate|\n+------------------+\n|456.33500000000004|\n+------------------+\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#42-sql-dataframe-read-apache-ranger-integration","title":"4.2. SQL / DataFrame Read (Apache Ranger Integration)","text":"<p>As of HDP 2.6, Row/Column Level Access Control for Apache Spark is available that enables fine grained security control leveraged by Apache Ranger. This feature can also be leveraged by this library - Apache Spark APIs do not support this.</p> <p>For instance, the scenarios below demonstrate row level control with users, <code>billing</code>, and <code>datascience</code>. <code>billing</code> principal can access all rows and columns while <code>datascience</code> principal can access some of filtered and masked data.</p> <p>Firstly, we destroy existing ticket and obtains a ticket as <code>billing</code> principal. Then, it executes a Spark shell.</p> <pre><code>$ kdestroy\n$ kinit billing/billing@EXAMPLE.COM\n$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre> <p>Since <code>billing</code> principal can access every row, it shows all data as are.</p> <pre><code>sql(\"select * from db_spark.t_spark\").show()\n+------+-------+\n|fruits|  color|\n+------+-------+\n| apple|    red|\n| grape| purple|\n|orange|scarlet|\n+------+-------+\n</code></pre> <p>Now, we try the same query as <code>datascience</code>, principal.</p> <pre><code>$ kdestroy\n$ kinit datascience/datascience@EXAMPLE.COM\n$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre> <p>Since <code>datascience</code>, principal can only access to filtered and masked rows, it only shows partial values.</p> <pre><code>sql(\"select * from db_spark.t_spark\").show()\n+------+-----+\n|fruits|color|\n+------+-----+\n| apxxx|  red|\n+------+-----+\n</code></pre> <p>For more information, please see 'Introducing Row/ Column Level Access Control for Apache Spark' in 7. Appendix. The Ranger security features previously available in the spark-llap connector are now covered by the Hive Warehouse Connector. Apache Hive and Apache Spark configurations should be followed as described in 3. Prerequisites.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#43-sql-dataframe-write","title":"4.3. SQL / DataFrame Write","text":"<p>This scenario targets to demonstrate a bulk write operation, as a batch job, between Apache Hive table and Apache Spark DataFrame with SQL expression.</p> <p>A table in Hive can be created as below:</p> <pre><code>hive.createTable(\"crimes_2010\")\n  .column(\"year\", \"int\")\n  .column(\"crime_rate\", \"double\")\n  .create()\n</code></pre> <p>Here, crimes table (from 4.1 SQL / DataFrame Read) is written into a different Hive table after filtering the data in Spark. The code below writes the crime rate at 2010 into the table created above:</p> <pre><code>hive.table(\"crimes\").filter(\"year = 2010\")\n  .write\n  .format(HiveWarehouseSession.HIVE_WAREHOUSE_CONNECTOR)\n  .option(\"table\", \"crimes_2010\")\n  .save()\n</code></pre> <p>The data can also be written in a stream manner as below:</p> <pre><code>hive.table(\"crimes\").filter(\"year = 2010\")\n  .write\n  .format(HiveWarehouseSession.DATAFRAME_TO_STREAM)\n  .option(\"table\", \"crimes_2010\")\n  .save()\n</code></pre> <p>Note: In this API, the job at Apache Spark side is a batch write job but it writes out data internally by Apache Hive Streaming API.</p> <p>Of course, we can write data from Apache Hive table via Apache Spark data sources:</p> <pre><code>hive.table(\"crimes\")\n  .write\n  .format(\"csv\")\n  .option(\"header\", \"true\")\n  .save(\"/tmp/zoo\")\n</code></pre> <p>Likewise, Apache Spark DataFrame can directly write out to Apache Hive table as well:</p> <pre><code>spark.read.format(\"csv\").option(\"inferSchema\", \"true\").option(\"header\", \"true\").load(\"/tmp/zoo\")\n  .filter(\"year = 2010\")\n  .write\n  .format(HiveWarehouseSession.HIVE_WAREHOUSE_CONNECTOR)\n  .option(\"table\", \"crimes_2010\")\n  .save()\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#44-structured-streaming-write","title":"4.4. Structured Streaming Write","text":"<p>This scenario demonstrates a streaming write operation, as a micro batch job, from Apache Spark DataFrame to Apache Hive table with SQL expression.</p> <p>In this scenario, socket structured streaming is used as test data.</p> <p>In case of Scala:</p> <pre><code>val lines = spark.readStream\n  .format(\"socket\")\n  .option(\"host\", \"localhost\")\n  .option(\"port\", 9999)  .load()\n</code></pre> <p>In case of Python:</p> <pre><code>lines = spark.readStream \\\n  .format(\"socket\") \\\n  .option(\"host\", \"localhost\") \\\n  .option(\"port\", 9999) \\\n  .load()\n</code></pre> <p>In another terminal, execute below command to insert test data:</p> <pre><code>$ nc -lk 9999\n</code></pre> <p>We create a target table to store the stream data. Note that this table can be created in Hive side as well, for instance, <code>CREATE TABLE hwx_table(value STRING);</code></p> <pre><code>hive.createTable(\"hwx_table\").column(\"value\", \"string\").create()\n</code></pre> <p>Now, the stream data is ready. After that, import the library so that we can easily specify the format.</p> <p>Before we start, we should initialize <code>HiveWarehouseSession</code> instance.</p> <p>In case of Scala:</p> <pre><code>import com.hortonworks.hwc.HiveWarehouseSession\n</code></pre> <p>In case of Python:</p> <pre><code>from pyspark_llap.sql.session import HiveWarehouseSession\n</code></pre> <p>Next, it starts the structured streaming job. At the terminal which opened <code>nc -lk 9999</code> we can insert arbitrary data and when the terminal inserts Hortonworks, it saves the data into the <code>hwx_table</code> table.</p> <pre><code>lines.filter(\"value = 'Hortonworks'\")\n  .writeStream\n  .format(HiveWarehouseSession.STREAM_TO_STREAM)\n  .option(\"database\", \"hwc_db\")\n  .option(\"table\", \"hwx_table\")\n  .option(\n    \"metastoreUri\",\n    spark.conf.get(\"spark.datasource.hive.warehouse.metastoreUri\"))\n  .option(\"checkpointLocation\", \"/tmp/checkpoint\").start()\n</code></pre> <p>Note: There is an issue about interpreting <code>spark.datasource.*</code> configurations into options internally in Apache Spark, which currently makes this library require to set <code>metastoreUri</code> and <code>database</code> options manually. See SPARK-25460 for more details. As soon as this issue is resolved, both <code>metastoreUri</code> and <code>database</code> can be omitted likewise.</p> <p>After that, type Hortonworks and also arbitrary words in the terminal opening <code>nc -lk 9999</code></p> <pre><code>Foo\nBar\nHortonworks\n</code></pre> <p>This continuously inserts the word Hortonworks into the table <code>hwx_table</code> .</p> <pre><code>hive.table(\"hwx_table\").show()\n+------------+\n|       value|\n+------------+\n| Hortonworks|\n+------------+\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#5-interaction-paradigms","title":"5. Interaction Paradigms","text":"<p>This library can be interacted with, of course, Apache Spark but also Apache Zeppelin and Apache Livy. This chapter demonstrates entry points of those interaction paradigms in order to leverage this library to utilize provided functionalities.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#51-spark-shell","title":"5.1. Spark Shell:","text":"<pre><code>$ spark-shell --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#52-pyspark-shell","title":"5.2. PySpark Shell:","text":"<pre><code>$ pyspark --master yarn \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#53-scala-java-application-submission","title":"5.3. Scala / Java Application Submission:","text":"<p>** In case of client mode:**</p> <pre><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.security.credentials.hiveserver2.enabled=false [JAR_NAME]\n</code></pre> <p>If 3. Prerequisites at Apache Spark side was not globally configured, use the command with specifying all configurations, for instance:</p> <pre><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.hadoop.hive.llap.daemon.service.hosts=@llap0 \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url=\"jdbc:hive2://ctr-e138-1518143905142-509736-01-000007.hwx.site:2181,ctr-e138-1518143905142-509736-01-000009.hwx.site:2181,ctr-e138-1518143905142-509736-01-000006.hwx.site:2181,ctr-e138-1518143905142-509736-01-000005.hwx.site:2181,ctr-e138-1518143905142-509736-01-000008.hwx.site:2181/default;principal=hive/_HOST@HWX.COM;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2-interactive\" \\\n  --conf spark.security.credentials.hiveserver2.enabled=false \\\n  --conf spark.datasource.hive.warehouse.load.staging.dir=/tmp \\\n  --conf spark.datasource.hive.warehouse.metastoreUri=thrift://ctr-e138-1518143905142-509736-01-000003.hwx.site:9083,thrift://ctr-e138-1518143905142-509736-01-000004.hwx.site:9083 [JAR_NAME]\n</code></pre> <p>In case of cluster mode:</p> <pre><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar [JAR_NAME]\n</code></pre> <p>If 3. Prerequisites at Apache Spark side was not globally configured with HWC, use the command with specifying all configurations, for instance:</p> <pre><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --conf spark.hadoop.hive.llap.daemon.service.hosts=@llap0 \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url=\"jdbc:hive2://ctr-e138-1518143905142-509736-01-000007.hwx.site:2181,ctr-e138-1518143905142-509736-01-000009.hwx.site:2181,ctr-e138-1518143905142-509736-01-000006.hwx.site:2181,ctr-e138-1518143905142-509736-01-000005.hwx.site:2181,ctr-e138-1518143905142-509736-01-000008.hwx.site:2181/default;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2-interactive\" \\\n  --conf spark.sql.hive.hiveserver2.jdbc.url.principal=\"hive/_HOST@EXAMPLE.COM\" \\\n  --conf spark.datasource.hive.warehouse.load.staging.dir=/tmp \\\n  --conf spark.datasource.hive.warehouse.metastoreUri=thrift://ctr-e138-1518143905142-509736-01-000003.hwx.site:9083,thrift://ctr-e138-1518143905142-509736-01-000004.hwx.site:9083 [JAR_NAME]\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#54-python-application-submission","title":"5.4. Python Application Submission:","text":"<p>** In case of client mode:**</p> <pre><code>$ spark-submit --master yarn --deploy-mode client \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip \\\n  --conf spark.security.credentials.hiveserver2.enabled=false [PY_FILE]\n</code></pre> <p>** In case of cluster mode:**</p> <pre><code>$ spark-submit --master yarn --deploy-mode cluster \\\n  --jars /usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar \\\n  --py-files /usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip [PY_FILE]\n</code></pre>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#55-apache-zeppelin","title":"5.5. Apache Zeppelin","text":"<p>Go to the interpreter setting.</p> <p></p> <p>Find the interpreter settings and set the configuration accordingly.</p> <p>** In case of Spark interpreter:**</p> <p></p> <p>Add <code>spark.jars</code> for instance:</p> <pre><code>spark.jars=/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar\n</code></pre> <p>For Python usage, the configuration below should also be added. For instance:</p> <pre><code>spark.submit.pyFiles=/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip\n</code></pre> <p>If the interpreter is set to YARN client mode, <code>spark.security.credentials.hiveserver2.enabled</code> should be set to false as below:</p> <pre><code>spark.security.credentials.hiveserver2.enabled=false\n</code></pre> <p>If you use a Kerberized cluster, do not forget to set:</p> <pre><code>spark.yarn.keytab\nspark.yarn.principal\n</code></pre> <p>** In case of Livy interpreter:**</p> <p></p> <p>Add <code>livy.spark.jars</code> for instance:</p> <pre><code>livy.spark.jars=file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar\n</code></pre> <p>For Python usage, the configuration below should also be added. For instance:</p> <pre><code>livy.spark.submit.pyFiles=file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip\n</code></pre> <p>Note: Local directories are disallowed by default for security reasons. Set the local directory to <code>livy.file.local-dir-whitelist</code> to allow a specific directory to allow to read. To avoid this setting, please use HDFS path after uploading the JAR and zipped file.</p> <p>If the interpreter is set to YARN client mode (see <code>livy.spark.master</code> and <code>livy.spark.submit.deployMode</code>), <code>livy.spark.security.credentials.hiveserver2.enabled</code> should be set to <code>false</code> as below:</p> <pre><code>livy.spark.security.credentials.hiveserver2.enabled=false\n</code></pre> <p>If you use a Kerberized cluster, do not forget to set:</p> <pre><code>zeppelin.livy.keytab\nzeppelin.livy.principal\n</code></pre> <p>Note: To use HWC with Livy in a secure cluster please follow the documentation here.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#56-apache-livy","title":"5.6. Apache Livy","text":"<p>The code below describes an example to submit Python application by Livy request with <code>curl</code> .</p> <pre><code>$ curl -X POST -H \"Content-Type: application/json\" -H \"X-Requested-By: hive\" --negotiate  \\\n  -u : `hostname`:8999/batches --data '{\n  \"conf\": {\n    \"spark.master\": \"yarn-cluster\",\n    \"spark.jars\": \"file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/hive-warehouse-connector-assembly-1.0.0.3.0.1.0-183.jar\", \n    \"spark.submit.pyFiles\": \"file:/usr/hdp/3.0.1.0-183/hive_warehouse_connector/pyspark_hwc-1.0.0.3.0.1.0-183.zip\"\n  }, \n  \"file\": \"[PY_FILE]\"}' | python -m json.tool\n</code></pre> <p>It shows the job information.</p> <pre><code>{\n  \"appId\": null,\n  \"appInfo\": {\n    \"driverLogUrl\": null,\n    \"sparkUiUrl\": null\n  },\n  \"id\": 1,\n  \"log\": [\n    \"stdout: \",\n    \"\\nstderr: \",\n    \"\\nYARN Diagnostics: \"\n  ],\n  \"state\": \"starting\"\n}\n</code></pre> <p>To patch job information, GET <code>batches/[ID]</code> is used.</p> <pre><code>$ curl --negotiate -u : `hostname`:8999/batches/1 | python -m json.tool\n</code></pre> <p>This request shows an output, for example, as below. </p> <pre><code>{\n  \"appId\": \"application_1539107884019_0071\",\n  \"appInfo\": {\n    \"driverLogUrl\": \"http://ctr-e138-1518143905142-512381-01-000003.hwx.site:8188/applicationhistory/logs/ctr-e138-1518143905142-512381-01-000006.hwx.site:25454/container_e02_1539107884019_0071_01_000001/container_e02_1539107884019_0071_01_000001/hive\",\n    \"sparkUiUrl\": \"http://ctr-e138-1518143905142-512381-01-000004.hwx.site:8088/proxy/application_1539107884019_0071/\"\n  },\n  \"id\": 1,\n  \"log\": [\n    \"\\t queue: default\",\n    \"\\t start time: 1539151855183\",\n    \"\\t final status: UNDEFINED\",\n    \"\\t tracking URL: http://ctr-e138-1518143905142-512381-01-000004.hwx.site:8088/proxy/application_1539107884019_0071/\",\n    \"\\t user: hive\",\n    \"18/10/10 06:10:55 INFO ShutdownHookManager: Shutdown hook called\",\n    \"18/10/10 06:10:55 INFO ShutdownHookManager: Deleting directory /tmp/spark-6e254b5c-50f9-40d0-af06-c37d8c1a6428\",\n    \"18/10/10 06:10:55 INFO ShutdownHookManager: Deleting directory /tmp/spark-253eac26-e86e-4699-82e6-ad281702fb85\",\n    \"\\nstderr: \",\n    \"\\nYARN Diagnostics: \"\n  ],\n  \"state\": \"success\"\n}\n</code></pre> <p>Note: The example above used Kerberized cluster; therefore, <code>--negotiate</code> option is used in <code>curl</code>.</p> <p>Note: Local directories are disallowed by default for security reasons. Set the local directory to <code>livy.file.local-dir-whitelist</code> to allow a specific directory to allow to read. To avoid this setting, please use HDFS path after uploading the JAR and zipped file.</p> <p>Note: To use HWC with Livy in a secure cluster please follow the documentation here.</p>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#6-limitations","title":"6. Limitations","text":"<ul> <li>Missing SQL support including USING syntax: currently Data Source V2 implementation does not support SQL syntax including USING syntax</li> <li>Missing R library support: this library currently supports only Scala, Java, and Python APIs.</li> <li>Limitations in Apache Arrow integration and Data Source V2 are inherited. See SPARK-22386 for Data Source V2 and SPARK-21187 for Apache Arrow integration in Apache Spark to track ongoing efforts and limitations.</li> <li>Supported/unsupported data types and their mapping between Apache Hive and Apache Spark can be found at this link.</li> </ul>","tags":["hive","spark"]},{"location":"bigdata/integrating-hive-with-spark/#7-appendix","title":"7. Appendix","text":"<ul> <li>HDP 3.0.1 documentation</li> <li>Hive Warehouse Connector Github</li> <li>Apache Ambari UI for enabling \u2018Interactive Query\u2019 in Hive</li> <li>Introducing Row/ Column Level Access Control for Apache Spark</li> <li> <p><code>SQL INSERT</code> queries to insert https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/topic-pages/tables/table-1</p> <p>CREATE DATABASE hwc_db; USE hwc_db; CREATE TABLE crimes(year INT, crime_rate DOUBLE); INSERT INTO crimes VALUES (1997, 611.0), (1998, 567.6), (1999, 523.0), (2000, 506.5), (2001, 504.5), (2002, 494.4), (2003, 475.8); INSERT INTO crimes VALUES (2004, 463.2), (2005, 469.0), (2006, 479.3), (2007, 471.8), (2008, 458.6), (2009, 431.9), (2010, 404.5); INSERT INTO crimes VALUES (2011, 387.1), (2012, 387.8), (2013, 369.1), (2014, 361.6), (2015, 373.7), (2016, 386.3);</p> </li> </ul>","tags":["hive","spark"]},{"location":"bigdata/integrating-phoenix-with-kerberos/","title":"Phoenix \u96c6\u6210 HBase \u5e76\u652f\u6301 Kerberos \u8ba4\u8bc1","text":"","tags":["hbase","phoenix","prestodb","trino"]},{"location":"bigdata/integrating-phoenix-with-kerberos/#_1","title":"\u964d\u7ea7","text":"<p>HDP \u81ea\u5e26\u7684hbase\u548cphoenix\u56e0\u4e3a\u4e0epresto \u4e0d\u517c\u5bb9\uff0c\u53ea\u80fd\u5168\u90e8\u964d\u7ea7\uff0c\u5176\u4e2d HBASE \u964d\u7ea7\u5230 1.4\u7248\u672c\u3002phoenix\u964d\u7ea7\u5230\u5bf9\u5e94\u7684 4.14.3 \u7248\u672c\u3002</p> <p>\u964d\u7ea7\u7684\u7b80\u5355\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u6309\u6b63\u5e38\u65b9\u5f0f\u901a\u8fc7Ambari\u5b89\u88c5HBASE</li> <li>\u5220\u9664\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684 <code>/usr/hdp/&lt;version&gt;/hbase</code> \u548c <code>/usr/hdp/&lt;version&gt;/phoenix</code> \u76ee\u5f55</li> <li>\u4ece\u5b98\u65b9\u4e0b\u8f7d\u5bf9\u5e94\u7684\u8f6f\u4ef6\uff0c\u5e76\u590d\u5236\u5230\u4e0a\u8ff0\u4e24\u4e2a\u76ee\u5f55\u4e2d\uff08\u5148\u521b\u5efa\u76ee\u5f55\uff09</li> <li><code>/usr/hdp/&lt;version&gt;/phoenix</code> \u91cc\u9700\u8981\u521b\u5efa\u5982\u4e0b\u8f6f\u8fde\u63a5\uff1a     <pre><code># ln -sf phoenix-hive-4.14.3-HBase-1.4.jar phoenix-hive.jar\n# ln -sf phoenix-4.14.3-HBase-1.4-client.jar phoenix-client.jar\n# ln -sf phoenix-4.14.3-HBase-1.4-thin-client.jar phoenix-thin-client.jar\n# ln -sf phoenix-4.14.3-HBase-1.4-server.jar  phoenix-server.jar\n</code></pre></li> <li><code>/usr/hdp/&lt;version&gt;/hbase</code> \u91cc\u521b\u5efa\u5982\u4e0b\u8f6f\u8fde\u63a5     <pre><code>ln -sf /usr/hdp/&lt;version&gt;/phoenix/phoenix-server.jar .\n</code></pre></li> <li>\u589e\u52a0 <code>/bin/hbase-config.sh</code> \u7684\u8f6f\u8fde\u63a5     <pre><code>ln -sf /usr/hdp/current/hbase-client/bin/hbase-config /bin/hbase-config.sh\n</code></pre></li> </ol>","tags":["hbase","phoenix","prestodb","trino"]},{"location":"bigdata/integrating-phoenix-with-kerberos/#namespace","title":"\u589e\u52a0namespace\u7684\u6620\u5c04\u914d\u7f6e","text":"<p>\u4e3a\u4e86\u8ba9phoenix\u80fd\u770b\u5230hbase\u5df2\u7ecf\u5b58\u5728\u7684\u8868\uff0c\u9700\u8981\u5728hbase\u91cc\u589e\u52a0\u5982\u4e0b\u914d\u7f6e(Ambari-&gt;HBase-&gt;Config-&gt;Custom hbase-site.xml) <pre><code>phoenix.schema.mapSystemTablesToNamespace=true\nphoenix.schema.isNamespaceMappingEnabled=true\n</code></pre> \u91cd\u542fhbase\uff0c\u8ba9\u65b0\u914d\u7f6e\u751f\u6548</p>","tags":["hbase","phoenix","prestodb","trino"]},{"location":"bigdata/integrating-phoenix-with-kerberos/#_2","title":"\u8d4b\u6743","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u7a7a\u95f4\u53ea\u6709hbase\u8d26\u53f7\u624d\u6709\u6743\u9650\uff0c\u800c\u6211\u4eec\u5e0c\u671bhive\u8d26\u53f7\u4e5f\u6709\u6743\u9650\uff0c\u9700\u8981\u901a\u8fc7\u6267\u884c <code>hbase shell</code> \u547d\u4ee4\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4 </p> <pre><code>hbase(main):008:0&gt; grant 'hive', 'RWXCA'\n0 row(s) in 1.0180 seconds\n</code></pre>","tags":["hbase","phoenix","prestodb","trino"]},{"location":"bigdata/integrating-phoenix-with-kerberos/#_3","title":"\u521d\u59cb\u5316","text":"<p>\u5207\u6362\u5230 <code>hbase</code> \u6216 <code>hive</code> \u8d26\u53f7\uff0c\u6267\u884c <code>/usr/hdp/current/phoenix-client/bin/sqlline.py</code></p> <p>\u56e0\u4e3a\u7b2c\u4e00\u6b21\u8981\u521b\u5efa\u7cfb\u7edf\u8868\uff0c\u4f1a\u6bd4\u8f83\u6162\uff0c\u5176\u8f93\u51fa\u5982\u679c\u548c\u4e0b\u9762\u7c7b\u4f3c\uff0c\u5219\u8868\u793a\u521d\u59cb\u5316\u6210\u529f\uff1a</p> <pre><code>$ /usr/hdp/current/phoenix-client/bin/sqlline.py\nSetting property: [incremental, false]\nSetting property: [isolation, TRANSACTION_READ_COMMITTED]\nissuing: !connect jdbc:phoenix: none none org.apache.phoenix.jdbc.PhoenixDriver\nConnecting to jdbc:phoenix:\nSLF4J: Class path contains multiple SLF4J bindings.\nSLF4J: Found binding in [jar:file:/usr/hdp/3.0.1.0-187/phoenix/phoenix-4.14.3-HBase-1.4-client.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: Found binding in [jar:file:/usr/hdp/3.0.1.0-187/hadoop/lib/slf4j-log4j12-1.7.25.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.\nConnected to: Phoenix (version 4.14)\nDriver: PhoenixEmbeddedDriver (version 4.14)\nAutocommit status: true\nTransaction isolation: TRANSACTION_READ_COMMITTED\nBuilding list of tables and columns for tab-completion (set fastconnect to true to skip)...\n133/133 (100%) Done\nDone\nsqlline version 1.2.0\n</code></pre>","tags":["hbase","phoenix","prestodb","trino"]},{"location":"bigdata/ipa-setup/","title":"free IPA setup","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#instuctions-for-ipa-lab","title":"Instuctions for IPA Lab","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#pre-reqs","title":"Pre-reqs","text":"<ul> <li>HDP 3.x / Ambari 2.7.1 cluster</li> <li>Access to an IPA server that has been setup as descibed in Hortonworks documentation. See sample script to set up</li> </ul> <p>Lab Topics 0. Accessing your Cluster 1. Register cluster nodes as IPA Clients 2. Secure Ambari via ambari-server setup-security 3. Enable Kerberos for cluster services 4. Enable LDAP for ambari</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-1","title":"Lab 1","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#accessing-your-cluster","title":"Accessing your Cluster","text":"<p>Credentials will be provided for these services by the instructor:</p> <ul> <li>SSH</li> <li>Ambari</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#use-your-cluster","title":"Use your Cluster","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#to-connect-using-putty-from-windows-laptop","title":"To connect using Putty from Windows laptop","text":"<ul> <li>Right click to download this ppk key &gt; Save link as &gt; save to Downloads folder</li> <li>Use putty to connect to your node using the ppk key:</li> <li> <p>Connection &gt; SSH &gt; Auth &gt; Private key for authentication &gt; Browse... &gt; Select training-keypair.ppk </p> </li> <li> <p>Make sure to click \"Save\" on the session page before logging in</p> </li> <li>When connecting, it will prompt you for username. Enter <code>centos</code></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#to-connect-from-linuxmacosx-laptop","title":"To connect from Linux/MacOSX laptop","text":"<ul> <li>SSH into Ambari node of your cluster using below steps:</li> <li>Right click to download this pem key  &gt; Save link as &gt; save to Downloads folder</li> <li>Copy pem key to ~/.ssh dir and correct permissions   <pre><code>cp ~/Downloads/training-keypair.pem ~/.ssh/\nchmod 400 ~/.ssh/training-keypair.pem\n</code></pre></li> <li>Login to the Ambari node of the cluster you have been assigned by replacing IP_ADDRESS_OF_AMBARI_NODE below with Ambari node IP Address (your instructor will provide this)  <pre><code>ssh -i  ~/.ssh/training-keypair.pem centos@IP_ADDRESS_OF_AMBARI_NODE\n</code></pre></li> <li> <p>To change user to root you can:   <pre><code>sudo su -\n</code></pre></p> </li> <li> <p>Similarly login via SSH to each of the other nodes in your cluster as you will need to run commands on each node in a future lab</p> </li> <li> <p>Tip: Since in the next labs you will be required to run the same set of commands on each of the cluster hosts, now would be a good time to setup your favorite tool to do so: examples here</p> </li> <li>On OSX, an easy way to do this is to use iTerm: open multiple tabs/splits and then use 'Broadcast input' feature (under Shell -&gt; Broadcast input)</li> <li>If you are not already familiar with such a tool, you can also just run the commands on the cluster, one host at a time</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#login-to-ambari","title":"Login to Ambari","text":"<ul> <li> <p>Login to Ambari web UI by opening http://AMBARI_PUBLIC_IP:8080 and log in with admin/BadPass#1</p> </li> <li> <p>You will see a list of Hadoop components running on your cluster on the left side of the page</p> </li> <li>They should all show green (ie started) status. If not, start them by Ambari via 'Service Actions' menu for that service</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#finding-internalexternal-hosts","title":"Finding internal/external hosts","text":"<ul> <li> <p>Following are useful techniques you can use in future labs to find your cluster specific details:</p> </li> <li> <p>From SSH terminal, how can I find the cluster name?   <pre><code>#run on ambari node to fetch cluster name via Ambari API\nPASSWORD=BadPass#1\noutput=`curl -u admin:$PASSWORD -i -H 'X-Requested-By: ambari'  http://localhost:8080/api/v1/clusters`\ncluster=`echo $output | sed -n 's/.*\"cluster_name\" : \"\\([^\\\"]*\\)\".*/\\1/p'`\necho $cluster\n</code></pre></p> </li> <li> <p>From SSH terminal, how can I find internal hostname (aka FQDN) of the node I'm logged into?   <pre><code>$ hostname -f\nip-172-30-0-186.us-west-2.compute.internal  \n</code></pre></p> </li> <li> <p>From Ambari how do I check the cluster name?</p> <ul> <li>It is displayed on the top left of the Ambari dashboard, next to the Ambari logo. If the name appears truncated, you can hover over it to produce a helptext dialog with the full name </li> </ul> </li> <li> <p>From Ambari how can I find external hostname of node where a component (e.g. Resource Manager or Hive) is installed?</p> <ul> <li>Click the parent service (e.g. YARN) and hover over the name of the component. The external hostname will appear. </li> </ul> </li> <li> <p>From Ambari how can I find internal hostname of node where a component (e.g. Resource Manager or Hive) is installed?</p> <ul> <li>Click the parent service (e.g. YARN) and click on the name of the component. It will take you to hosts page of that node and display the internal hostname on the top.  </li> </ul> </li> <li> <p>In future labs you may need to provide private or public hostname of nodes running a particular component (e.g. YARN RM or Mysql or HiveServer)</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#import-sample-data-into-hive","title":"Import sample data into Hive","text":"<ul> <li>Run below on the node where HiveServer2 is installed to download data and import it into a Hive table for later labs</li> <li>You can either find the node using Ambari as outlined in Lab 1</li> <li>Download and import data   <pre><code>cd /tmp\nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/sample_07.csv\nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/sample_08.csv\n</code></pre></li> <li>Create user dir for admin, sales1 and hr1   <pre><code> sudo -u hdfs hdfs dfs  -mkdir /user/admin\n sudo -u hdfs hdfs dfs  -chown admin:hadoop /user/admin\n\n sudo -u hdfs hdfs dfs  -mkdir /user/sales1\n sudo -u hdfs hdfs dfs  -chown sales1:hadoop /user/sales1\n\n sudo -u hdfs hdfs dfs  -mkdir /user/hr1\n sudo -u hdfs hdfs dfs  -chown hr1:hadoop /user/hr1   \n</code></pre></li> <li>Copy csv's into HDFS   <pre><code>sudo -u hdfs hdfs dfs -mkdir -p /hive_data/salary\nsudo -u hdfs hdfs dfs -put /tmp/sample*  /hive_data/salary\nsudo -u hdfs hdfs dfs -chown -R hive:hive /hive_data/\n</code></pre></li> <li> <p>Now create Hive table in default database by </p> <ul> <li>Start beeline shell from the node where Hive is installed:  <pre><code>beeline -n hive -u \"jdbc:hive2://localhost:10000/default\"\n</code></pre></li> </ul> </li> <li> <p>At beeline prompt, run below:</p> </li> </ul> <p><pre><code>CREATE EXTERNAL TABLE sample_07 (\ncode string ,\ndescription string ,  \ntotal_emp int ,  \nsalary int )\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' STORED AS TextFile\nLOCATION '/hive_data/salary';\n</code></pre> <pre><code>CREATE EXTERNAL TABLE sample_08 (\ncode string ,\ndescription string ,  \ntotal_emp int ,  \nsalary int )\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' STORED AS TextFile\nLOCATION '/hive_data/salary';\n</code></pre> <pre><code>!q\n</code></pre></p> <ul> <li>Notice that in the JDBC connect string for connecting to an unsecured Hive while its running in default (ie binary) transport mode :</li> <li>port is 10000</li> <li> <p>no kerberos principal was needed </p> </li> <li> <p>This will change after we:</p> </li> <li>enable kerberos</li> <li>configure Hive for http transport mode (to go through Knox)</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#why-is-security-needed","title":"Why is security needed?","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#hdfs-access-on-unsecured-cluster","title":"HDFS access on unsecured cluster","text":"<ul> <li> <p>On your unsecured cluster try to access a restricted dir in HDFS <pre><code>hdfs dfs -ls /tmp/hive   \n## this should fail with Permission Denied\n</code></pre></p> </li> <li> <p>Now try again after setting HADOOP_USER_NAME env var <pre><code>export HADOOP_USER_NAME=hdfs\nhdfs dfs -ls /tmp/hive   \n## this shows the file listing!\n</code></pre></p> </li> <li>Unset the env var and it will fail again <pre><code>unset HADOOP_USER_NAME\nhdfs dfs -ls /tmp/hive  \n</code></pre></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#webhdfs-access-on-unsecured-cluster","title":"WebHDFS access on unsecured cluster","text":"<ul> <li> <p>From node running NameNode, make a WebHDFS request using below command: <pre><code>curl -sk -L \"http://$(hostname -f):50070/webhdfs/v1/user/?op=LISTSTATUS\"\n</code></pre></p> </li> <li> <p>In the absence of Knox, notice it goes over HTTP (not HTTPS) on port 50070 and no credentials were needed</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#web-ui-access-on-unsecured-cluster","title":"Web UI access on unsecured cluster","text":"<ul> <li>From Ambari notice you can open the WebUIs without any authentication</li> <li>HDFS &gt; Quicklinks &gt; NameNode UI</li> <li>Mapreduce &gt; Quicklinks &gt; JobHistory UI</li> <li> <p>YARN &gt; Quicklinks &gt; ResourceManager UI</p> </li> <li> <p>This should tell you why kerberos (and other security) is needed on Hadoop :)</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-2","title":"Lab 2","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#review-use-case","title":"Review use case","text":"<p>Use case: Customer has an existing cluster which they would like you to secure for them</p> <ul> <li>Current setup:</li> <li>The customer has multiple organizational groups (i.e. sales, hr, legal) which contain business users (sales1, hr1, legal1 etc) and hadoopadmin</li> <li>These groups and users are defined in Active Directory (AD) under its own Organizational Unit (OU) called CorpUsers </li> <li>There are empty OUs created in AD to store hadoop principals/hadoop nodes (HadoopServices, HadoopNodes)</li> <li>Hadoopadmin user has administrative credentials with delegated control of \"Create, delete, and manage user accounts\" on above OUs</li> <li> <p>Hadoop cluster running HDP has already been setup using Ambari (including HDFS, YARN, Hive, Hbase, Solr, Zookeeper)</p> </li> <li> <p>Goals:</p> </li> <li>Integrate Ambari with AD - so that hadoopadmin can administer the cluster</li> <li>Integrate Hadoop nodes OS with AD - so business users are recognized and can submit Hadoop jobs</li> <li>Enable kerberos - to secured the cluster and enable authentication</li> <li>Install Ranger and enable Hadoop plugins - to allow admin to setup authorization policies and review audits across Hadoop components</li> <li>Install Ranger KMS and enable HDFS encryption - to be able to create encryption zones</li> <li>Encrypt Hive backing dirs - to protect hive tables</li> <li>Configure Ranger policies to:<ul> <li>Protect /sales HDFS dir - so only sales group has access to it</li> <li>Protect sales hive table - so only sales group has access to it</li> <li>Fine grained access: sales users should only have access to code, description columns in default.sample_07, but only for rows where total_emp&lt;5000. Also total_emp column should be masked</li> <li>Protect sales HBase table - so only sales group has access to it</li> </ul> </li> <li>Install Knox and integrate with AD - for perimeter security and give clients access to APIs w/o dealing with kerberos</li> <li>Enable Ambari views to work on secured cluster</li> </ul> <p>We will run through a series of labs and step by step, achieve all of the above goals</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#1-register-cluster-nodes-as-ipa-clients","title":"1. Register cluster nodes as IPA clients","text":"<ul> <li>Run below on all nodes of HDP cluster (replace $INTERNAL_IP_OF_IPA)</li> </ul> <pre><code>echo \"$INTERNAL_IP_OF_IPA ipa.us-west-2.compute.internal ipa\" &gt;&gt; /etc/hosts\n</code></pre> <ul> <li> <p>Install yum packages <pre><code>sudo yum install -y ipa-client\n</code></pre></p> </li> <li> <p>Update /etc/resolve.conf (replace INTERNAL_IP_OF_IPA) <pre><code>mv /etc/resolv.conf /etc/resolv.conf.bak \necho \"search us-west-2.compute.internal\" &gt; /etc/resolv.conf\necho \"nameserver $INTERNAL_IP_OF_IPA\" &gt;&gt; /etc/resolv.conf\n</code></pre></p> </li> <li>Install IPA client</li> </ul> <p><pre><code>  sudo ipa-client-install \\\n  --server=ipa.us-west-2.compute.internal \\\n  --realm=US-WEST-2.COMPUTE.INTERNAL \\\n  --domain=us-west-2.compute.internal \\\n  --mkhomedir \\\n  --principal=admin -w BadPass#1 \\\n  --unattended\n</code></pre> Note: restarting dbus seems to be required sometimes <code>service dbus restart</code></p> <ul> <li> <p>Make sure you don't see below message from the output of previous command <pre><code>Missing A/AAAA record(s) for host xxxxxxxxx\n</code></pre></p> </li> <li> <p>If you do, uninstall and try again: <pre><code>service dbus restart\nsudo ipa-client-install --uninstall\n</code></pre></p> </li> <li> <p>Note by changing the DNS, its possible the node may not be able to connect to public internet. When you need to do so (e.g. for yum install, you can temporarily revert back the /etc/resolv.conf.bak)</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#verify","title":"Verify","text":"<ul> <li> <p>By registering as a client of the IPA server, SSSD is automatically setup. So now the host recognizes users defined in IPA <pre><code>id hadoopadmin\n</code></pre></p> </li> <li> <p>You can also authenticate and get a kerberos ticket (password is BadPass#1) <pre><code>kinit -V hadoopadmin\n</code></pre></p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#2-secure-ambari-via-ambari-server-setup-security","title":"2. Secure Ambari via ambari-server setup-security","text":"<p>Lets use FreeIPA Generated certificate for Options 1 and 4 in <code>ambari-server setup-security</code></p> <p><code>Security setup options... =========================================================================== Choose one of the following options:   *[1] Enable HTTPS for Ambari server.   *[2] Encrypt passwords stored in ambari.properties file.   [3] Setup Ambari kerberos JAAS configuration.   *[4] Setup truststore.   [5] Import certificate to truststore. ===========================================================================</code></p> <p>Preparation: Create certificates on all ipa-client hosts (run this on each node)</p> <p>Ensure SELinux is not enforcing, else requesting a certificate as the root user with admin's kerberos ticket will be denied by the system and certificate will not be created. </p> <pre><code>getenforce\n# If result is \"Enforcing\", run the following\nsudo su\nsetenforce 0\n</code></pre> <p>Obtain kerberos ticket as admin(or an IPA Privileged User), and request a x509 certificate pair saved as \"host.key\" and \"host.crt\" on each host. </p> <pre><code>echo BadPass#1 | kinit admin \nmkdir /etc/security/certificates/\ncd /etc/security/certificates/\nipa-getcert request -v -f /etc/security/certificates/host.crt -k /etc/security/certificates/host.key\n</code></pre> <p>List the directory to verify certificates are created. </p> <pre><code>[root@demo certificates]# ls -ltr /etc/security/certificates/\ntotal 8\n-rw------- 1 root root 1704 Sep 30 04:56 host.key\n-rw------- 1 root root 1724 Sep 30 04:56 host.crt\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#21-enable-https-for-ambari-server","title":"2.1 Enable HTTPS for Ambari server","text":"<p>If you are running Knox on this host (which is highly not recommended) changing the default port from 8443 will avoid the port conflict. </p> <pre><code>[root@demo ~]$ambari-server setup-security\n\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\n\n# Enable SSL\nEnter choice, (1-5): 1\nDo you want to configure HTTPS [y/n] (y)? y\nSSL port [8443] ? 8444\nEnter path to Certificate: /etc/security/certificates/host.crt\nEnter path to Private Key: /etc/security/certificates/host.key\nPlease enter password for Private Key: changeit\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#verify_1","title":"Verify","text":"<p>Restart ambari-server. Curl Ambari on the new https port without specifying the \"-k\" flag. <pre><code>[root@demo ~]$ curl -u admin:\"password\" https://`hostname -f`:8444/api/v1/clusters\n</code></pre></p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#22-encrypt-passwords-stored-in-ambariproperties-file","title":"2.2 Encrypt passwords stored in ambari.properties file.","text":"<p>This step is required for the kerberos wizard to persist the KDC credentials (<code>hadoopadmin</code>). It is also required for persisting the <code>ldapbind</code> password, without which, enabling ldaps in Ambari 2.7.1 seems to have some challenges.  </p> <pre><code>[root@demo ~]# ambari-server setup-security\nUsing python  /usr/bin/python\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\nEnter choice, (1-5): 2\nPlease provide master key for locking the credential store:\nRe-enter master key:\nDo you want to persist master key. If you choose not to persist, you need to provide the Master Key while starting the ambari server as an env variable named AMBARI_SECURITY_MASTER_KEY or the start will prompt for the master key. Persist [y/n] (y)? y\nAdjusting ambari-server permissions and ownership...\nAmbari Server 'setup-security' completed successfully.\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#23-setup-truststore","title":"2.3 Setup truststore.","text":"<p>Setting up the truststore ahead of time and restarting Ambari seems to make the ldap integration happier.  Ambari can leverage the <code>/etc/pki/java/cacerts</code> truststore managed by IPA Clients on the hosts. This truststore contains the public CAs, along with the IPA CA, which should be the only certificates needed.    </p> <pre><code># Example for ipa hostname: ipa.us-west-2.compute.internal\n\n[root@demo ~]# /usr/java/default/bin/keytool -list \\\n-keystore /etc/pki/java/cacerts \\\n-v -storepass changeit | grep ipa\n\nAlias name: hortonworks.comipaca\n   accessLocation: URIName: http://ipa-ca.us-west-2.compute.internal/ca/ocsp\n</code></pre> <pre><code>[root@demo certificates]# ambari-server setup-security\nUsing python  /usr/bin/python\nSecurity setup options...\n===========================================================================\nChoose one of the following options:\n  [1] Enable HTTPS for Ambari server.\n  [2] Encrypt passwords stored in ambari.properties file.\n  [3] Setup Ambari kerberos JAAS configuration.\n  [4] Setup truststore.\n  [5] Import certificate to truststore.\n===========================================================================\nEnter choice, (1-5): 4\nDo you want to configure a truststore [y/n] (y)? y\nTrustStore type [jks/jceks/pkcs12] (jks):\nPath to TrustStore file :/etc/pki/java/cacerts\nPassword for TrustStore: changeit\nRe-enter password: changeit\nAmbari Server 'setup-security' completed successfully.\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#24-restart-ambari-for-changes-to-take-effect","title":"2.4 Restart Ambari for changes to take effect","text":"<pre><code>ambari-server restart\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#3-enable-kerberos-on-the-cluster","title":"3. Enable kerberos on the cluster","text":"<p>Enable Kerberos for cluster services via the wizard in Ambari, located in the Cluster Admin menu in the bottom left navigation panel. https://demo.us-west-2.compute.internal:8444/#/main/admin/kerberos</p> <p></p> <p>At this point, requirements are met.The ambari-managed principals group is not required and password expiration policies should not affect the service keytabs as they have not been given passwords. The <code>hadoopadmin</code> and <code>ldapbind</code> user password will expire and need to be changed in 90 days (along with the rest of the users), but that's a good thing. See the docs for explanations https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/authentication-with-kerberos/content/kerberos_optional_use_an_existing_ipa.html </p> <ul> <li>KDC host: <code>ipa.us-west-2.compute.internal</code></li> <li>Realm name: <code>US-WEST-2.COMPUTE.INTERNAL</code></li> <li> <p>Domain: <code>us-west-2.compute.internal</code></p> </li> <li> <p>Kadmin host: <code>ipa.us-west-2.compute.internal</code></p> </li> <li>Admin principal: <code>hadoopadmin</code></li> <li>Admin password: <code>BadPass#1</code></li> <li>Save Admin Credentials: true</li> </ul> <p></p> <p>If all goes well, go grab a beer. </p> <p></p> <p>Useful CLI for verifying the newly created Service Principals:</p> <pre><code>#Usage: ipa service-show &lt;principal&gt;\n[root@demo ~]# ipa service-show spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Principal name: spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Principal alias: spark/demo.us-west-2.compute.internal@US-WEST-2.COMPUTE.INTERNAL\n  Keytab: True\n  Managed by: demo.us-west-2.compute.internal\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#4-enable-ldap-for-ambari","title":"4. Enable LDAP For Ambari","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#freeipa-tips-for-determining-ldap-search-properties","title":"FreeIPA Tips for determining LDAP Search Properties","text":"<ul> <li> <p>IPA Clients contain <code>/etc/ipa/default.conf</code> with various ldap server properties </p> <pre><code>[root@demo ~]# cat /etc/ipa/default.conf \nbasedn = dc=us-west-2,dc=compute,dc=internal\nrealm = US-WEST-2.COMPUTE.INTERNAL\ndomain = us-west-2.compute.internal\nserver = ipa.us-west-2.compute.internal\n</code></pre> </li> <li> <p>Determining valid user attributes (posixaccount, uid, etc):</p> <pre><code>ipa user-show hadoopadmin --raw --all\n</code></pre> </li> <li> <p>Determining valid group attributes (posixgroup, member, memberUid, etc)</p> <pre><code>ipa group-show admins --raw --all\n</code></pre> </li> <li> <p>Verifying ldapbind account and search base via <code>ldapsearch</code></p> <pre><code>[root@demo ~]# yum install -y openldap-clients\n\n# Test ldap bind properties\nAM_LDAP_SEARCHBASE=\"cn=accounts,dc=us-west-2,dc=compute,dc=internal\"\nAM_LDAP_BINDDN=\"uid=ldapbind,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal\"\nAM_LDAP_BINDDN_PW=\"BadPass#1\"\nAM_LDAP_URL=ldaps://ipa.us-west-2.compute.internal:636\n\n# Search for a valid uid and ensure the searchbase, bind dn, and ldapurl resolve properly\n[root@demo ~]# ldapsearch -D ${AM_LDAP_BINDDN} \\\n-w ${AM_LDAP_BINDDN_PW} \\\n-b ${AM_LDAP_SEARCHBASE} \\\n-H ${AM_LDAP_URL} uid=hadoopadmin\n\n# Tail results of a valid ldapsearch for a single uid:\nnumResponses: 2\nnumEntries: 1\n</code></pre> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#41-enable-ldap-for-ambari-server","title":"4.1 Enable LDAP for Ambari Server","text":"<p>Ambari 2.7.1 offers a CLI option in <code>ambari-server setup-ldap</code> for choosing ldap type as IPA, which attempts to set some of the defaults required for integration. It seems to still have a few challenges, so few of the defaults need to be change. </p> <p>On the ambari-server host:</p> <p><pre><code>[root@demo certificates]# ambari-server setup-ldap\nCurrently 'no auth method' is configured, do you wish to use LDAP instead [y/n] (y)?  \nPlease select the type of LDAP you want to use (AD, IPA, Generic LDAP):IPA\nPrimary LDAP Host (ipa.ambari.apache.org): ipa.us-west-2.compute.internal\nPrimary LDAP Port (636):\nSecondary LDAP Host &lt;Optional&gt;:\nSecondary LDAP Port &lt;Optional&gt;:\nUse SSL [true/false] (true):\nDo you want to provide custom TrustStore for Ambari [y/n] (y)?\nTrustStore type [jks/jceks/pkcs12] (jks):\nPath to TrustStore file (/etc/pki/java/cacerts):\nPassword for TrustStore: changeit\nRe-enter password: changeit\nUser object class (posixUser): posixaccount\nUser ID attribute (uid):\nGroup object class (posixGroup):\nGroup name attribute (cn):\nGroup member attribute (memberUid): member\nDistinguished name attribute (dn):\nSearch Base (dc=ambari,dc=apache,dc=org): cn=accounts,dc=us-west-2,dc=compute,dc=internal\nReferral method [follow/ignore] (follow):\nBind anonymously [true/false] (false):\nBind DN (uid=ldapbind,cn=users,cn=accounts,dc=ambari,dc=apache,dc=org): uid=ldapbind,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal\nEnter Bind DN Password: BadPass#1\nConfirm Bind DN Password: BadPass#1\nHandling behavior for username collisions [convert/skip] for LDAP sync (skip):\nForce lower-case user names [true/false]:\nResults from LDAP are paginated when requested [true/false]:\n</code></pre> - Then enter Ambari credentials (admin/BadPass#1)</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#42-sync-users","title":"4.2 Sync users","text":"<p>LDAP Users must be synced by invoked a command on the Ambari Server host. User additions, and group associations made on the LDAP server will not propagate to Ambari automatically, only when this command is invoked. </p> <pre><code>[root@demo ~]# ambari-server sync-ldap --all\nUsing python  /usr/bin/python\nSyncing with LDAP...\nEnter Ambari Admin login: admin\nEnter Ambari Admin password:\n\nFetching LDAP configuration from DB.\nSyncing all...\n\nCompleted LDAP Sync.\nSummary:\n  memberships:\n    removed = 0\n    created = 16\n  users:\n    skipped = 1\n    removed = 0\n    updated = 0\n    created = 15\n  groups:\n    updated = 0\n    removed = 0\n    created = 26\n\nAmbari Server 'sync-ldap' completed successfully.\n</code></pre> <ul> <li>Now restart ambari-server</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#421-verify-user-group-associations-in-ambari","title":"4.2.1 Verify user group associations in Ambari","text":"<p>Log in to Ambari as an Admin and Navigate to Manage Ambari &gt; Users. Example user/groups from this lab:</p> <p></p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#enabling-spnego-authentication-for-hadoop","title":"Enabling SPNEGO Authentication for Hadoop","text":"<ul> <li> <p>This is needed to secure the Hadoop components webUIs (e.g. Namenode UI, JobHistory UI, Yarn ResourceManager UI etc...)</p> </li> <li> <p>As of HDP 3.0, this is taken care of as part of setting up Kerberos via Ambari Security Wizard</p> </li> <li> <p>Now when you try to open any of the web UIs like below you will get <code>401: Authentication required</code></p> </li> <li>HDFS: Namenode UI</li> <li>Mapreduce: Job history UI</li> <li>YARN: Resource Manager UI</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-5","title":"Lab 5","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-install","title":"Ranger install","text":"<p>Goal: In this lab we will install Apache Ranger via Ambari and setup Ranger plugins for Hadoop components: HDFS, Hive, Hbase, YARN, Knox. We will also enable Ranger audits to Solr and HDFS</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-prereqs","title":"Ranger prereqs","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#create-confirm-mysql-user-root","title":"Create &amp; confirm MySQL user 'root'","text":"<p>Prepare MySQL DB for Ranger use.</p> <ul> <li>Run these steps on the node where MySQL/Hive is located. To find this, you can either:</li> <li>use Ambari UI or</li> <li> <p>Just run <code>mysql</code> on each node: if it returns <code>mysql: command not found</code>, move onto next node</p> </li> <li> <p><code>sudo mysql</code></p> </li> <li> <p>Execute following in the MySQL shell to create \"Ranger DB root User\" in MySQL. Ambari will use this user to create rangeradmin user. <pre><code>CREATE USER 'root'@'%';\nGRANT ALL PRIVILEGES ON *.* to 'root'@'%' WITH GRANT OPTION;\nSET PASSWORD FOR 'root'@'%' = PASSWORD('BadPass#1');\nSET PASSWORD = PASSWORD('BadPass#1');\nFLUSH PRIVILEGES;\nexit\n</code></pre></p> </li> <li> <p>Confirm MySQL user: <code>mysql -u root -h $(hostname -f) -p -e \"select count(user) from mysql.user;\"</code></p> </li> <li>Output should be a simple count. </li> <li>In case of errors, check the previous step for errors. </li> <li>If you encounter below error, modeify /etc/my.conf by removing <code>skip-grant-tables</code> and then restarting the service by <code>service mysqld restart</code></li> </ul> <p><code>ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement</code></p> <ul> <li>If it still does not work, try creating user admin instead. If you do this, make sure to enter admin insted of root when prompted for \"Ranger DB root User\" in Ambari</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#prepare-ambari-for-mysql","title":"Prepare Ambari for MySQL","text":"<ul> <li>Run this on Ambari node</li> <li>Add MySQL JAR to Ambari:</li> <li><code>sudo ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar</code><ul> <li>If the file is not present, it is available on RHEL/CentOS with: <code>sudo yum -y install mysql-connector-java</code></li> </ul> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#setup-solr-for-ranger-audit","title":"Setup Solr for Ranger audit","text":"<ul> <li>Starting HDP 2.5, if you have deployed Ambari Infra service installed, this can be used for Ranger audits.</li> <li> <p>Make sure Ambari Infra service is installed and started before starting Ranger install</p> </li> <li> <p>TODO: add steps to install/configure Banana dashboard for Ranger Audits</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-install_1","title":"Ranger install","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#install-ranger","title":"Install Ranger","text":"<ul> <li> <p>Start the Ambari 'Add Service' wizard and select Ranger</p> </li> <li> <p>When prompted for where to install it, choose any node you like</p> </li> <li> <p>On the Ranger Requirements popup windows, you can check the box and continue as we have already completed the pre-requisite steps</p> </li> <li> <p>On the 'Customize Services' page of the wizard there are a number of tabs that need to be configured as below</p> </li> <li> <p>Go through each Ranger config tab, making below changes:</p> </li> <li> <p>Ranger Admin tab:</p> </li> <li>Ranger DB Host = FQDN of host where Mysql is running (e.g. ip-172-30-0-242.us-west-2.compute.internal)</li> <li>Enter passwords: BadPass#1</li> <li> <p>Click 'Test Connection' button  </p> </li> <li> <p>Ranger User info tab</p> </li> <li>'Sync Source' = LDAP/AD </li> <li> <p>Common configs subtab</p> <ul> <li>Enter password: BadPass#1</li> </ul> </li> <li> <p>Ranger User info tab </p> </li> <li> <p>User configs subtab</p> <ul> <li>User Search Base = <code>cn=accounts,dc=us-west-2,dc=compute,dc=internal</code></li> <li>User Search Filter = <code>(objectcategory=posixaccount)</code></li> </ul> </li> <li> <p>Ranger User info tab </p> </li> <li> <p>Group configs subtab</p> <ul> <li>Make sure Group sync is disabled </li> </ul> </li> <li> <p>Ranger plugins tab</p> </li> <li> <p>Enable all plugins </p> </li> <li> <p>Ranger Audits tab </p> </li> <li>SolrCloud = ON  </li> </ul> <p>7.Advanced tab   - No changes needed (skipping configuring Ranger authentication against AD for now) </p> <ul> <li> <p>Click Next &gt; Proceed Anyway to proceed</p> </li> <li> <p>If prompted, on Configure Identities page, you may have to enter your AD admin credentials:</p> </li> <li>Admin principal: <code>hadoopadmin@LAB.HORTONWORKS.NET</code></li> <li>Admin password: BadPass#1</li> <li> <p>Notice that you can now save the admin credentials. Check this box too   </p> </li> <li> <p>Click Next &gt; Deploy to install Ranger</p> </li> <li> <p>Once installed, restart components that require restart (e.g. HDFS, YARN, Hive etc)</p> </li> <li> <p>(Optional) In case of failure (usually caused by incorrectly entering the Mysql nodes FQDN in the config above), delete Ranger service from Ambari and retry.</p> </li> </ul> <p>8 - (Optional) Enable Deny Conditions in Ranger </p> <p>The deny condition in policies is optional by default and must be enabled for use.</p> <ul> <li> <p>From Ambari&gt;Ranger&gt;Configs&gt;Advanced&gt;Custom ranger-admin-site, add :  <code>ranger.servicedef.enableDenyAndExceptionsInPolicies=true</code></p> </li> <li> <p>Restart Ranger</p> </li> </ul> <p>https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.1/bk_security/content/about_ranger_policies.html</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#check-ranger","title":"Check Ranger","text":"<ul> <li>Open Ranger UI at http://RANGERHOST_PUBLIC_IP:6080 using admin/admin</li> <li> <p>Confirm that repos for HDFS, YARN, Hive, HBase, Knox appear under 'Access Manager tab' </p> </li> <li> <p>Confirm that audits appear under 'Audit' &gt; 'Access' tab </p> </li> <li> <p>If audits do not show up here, you may need to restart Ambari Infra Solr from Ambari</p> </li> <li> <p>In case audits still don't show up and Ranger complains that audit collection not found: try these steps</p> </li> <li> <p>Confirm that plugins for HDFS, YARN, Hive etc appear under 'Audit' &gt; 'Plugins' tab  </p> </li> <li> <p>Confirm users/group sync from AD into Ranger are working by clicking 'Settings' &gt; 'Users/Groups tab' in Ranger UI and noticing AD users/groups are present </p> </li> <li> <p>Confirm HDFS audits working by querying the audits dir in HDFS:</p> </li> </ul> <pre><code>#### 1 authenticate\nexport PASSWORD=BadPass#1\n\n#detect name of cluster\noutput=`curl -u hadoopadmin:$PASSWORD -k -i -H 'X-Requested-By: ambari'  https://localhost:8443/api/v1/clusters`\ncluster=`echo $output | sed -n 's/.*\"cluster_name\" : \"\\([^\\\"]*\\)\".*/\\1/p'`\n\necho $cluster\n## this should show the name of your cluster\n\n## if not you can manully set this as below\n## cluster=Security-HWX-LabTesting-XXXX\n\n#then kinit as hdfs using the headless keytab and the principal name\nsudo -u hdfs kinit -kt /etc/security/keytabs/hdfs.headless.keytab \"hdfs-${cluster,,}\"\n\n#### 2 read audit dir in hdfs \nsudo -u hdfs hdfs dfs -cat /ranger/audit/hdfs/*/*\n</code></pre>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-6a","title":"Lab 6a","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-kmsdata-encryption-setup","title":"Ranger KMS/Data encryption setup","text":"<ul> <li> <p>Goal: In this lab we will install Ranger KMS via Ambari. Next we will create some encryption keys and use them to create encryption zones (EZs) and copy files into them. Reference: docs</p> </li> <li> <p>In this section we will have to setup proxyusers. This is done to enable impersonation whereby a superuser can submit jobs or access hdfs on behalf of another user (e.g. because superuser has kerberos credentials but user joe doesn\u2019t have any)</p> </li> <li> <p>For more details on this, refer to the doc</p> </li> <li> <p>Before starting KMS install, find and note down the below piece of information. These will be used during KMS install</p> </li> <li> <p>Find the internal hostname of host running Mysql and note it down</p> <ul> <li>From Ambari &gt; Hive &gt; Mysql &gt; click the 'Mysql Server' hyperlink. The internal hostname should appear in upper left of the page.</li> </ul> </li> <li> <p>Open Ambari &gt; start 'Add service' wizard &gt; select 'Ranger KMS'.</p> </li> <li>Pick any node to install on</li> <li>Keep the default configs except for </li> <li> <p>under Ambari &gt; Ranger KMS &gt; Settings tab :</p> <ul> <li>Ranger KMS DB host:  <li>Ranger KMS DB password: <code>BadPass#1</code> </li> <li>DBA password: <code>BadPass#1</code></li> <li>KMS master secret password: <code>BadPass#1</code> </li> <li> <p>Under Advanced &gt; Custom kms-site, enter below configs (Tip: to avoid adding one at a time, you can use 'bulk add' mode):</p> <ul> <li>hadoop.kms.proxyuser.oozie.users=*</li> <li>hadoop.kms.proxyuser.ambari.users=*</li> <li>hadoop.kms.proxyuser.oozie.hosts=*</li> <li>hadoop.kms.proxyuser.ambari.hosts=*</li> <li>hadoop.kms.proxyuser.keyadmin.groups=*</li> <li>hadoop.kms.proxyuser.keyadmin.hosts=*</li> <li>hadoop.kms.proxyuser.keyadmin.users=*    </li> </ul> </li> <li> <p>Click Next &gt; Proceed Anyway to proceed with the wizard</p> </li> <li> <p>If prompted, on Configure Identities page, you may have to enter your AD admin credentials:</p> </li> <li>Admin principal: <code>hadoopadmin@LAB.HORTONWORKS.NET</code></li> <li>Admin password: BadPass#1</li> <li> <p>Check the \"Save admin credentials\" checkbox</p> </li> <li> <p>Click Next &gt; Deploy to install RangerKMS</p> </li> <li> <p>Confirm these properties got populated to kms://http@(kmshostname):9292/kms</p> </li> <li>HDFS &gt; Configs &gt; Advanced core-site:<ul> <li>hadoop.security.key.provider.path</li> </ul> </li> <li> <p>HDFS &gt; Configs &gt; Advanced hdfs-site:</p> <ul> <li>dfs.encryption.key.provider.uri  </li> </ul> </li> <li> <p>Restart the services that require it e.g. HDFS, Mapreduce, YARN via Actions &gt; Restart All Required</p> </li> <li> <p>Restart Ranger and RangerKMS services.</p> </li> <li> <p>(Optional) Add another KMS:</p> </li> <li>Ambari &gt; Ranger KMS &gt; Service Actions &gt; Add Ranger KMS Server &gt; Pick any host    </li> <li> <p>After it is installed, you can start it by:</p> <ul> <li>Ambari &gt; Ranger KMS &gt; Service Actions &gt; Start</li> </ul> </li> <li> <p>Once started you will see multiple KMS Servers running in Ambari: </p> </li>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-6b","title":"Lab 6b","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-kmsdata-encryption-exercise","title":"Ranger KMS/Data encryption exercise","text":"<ul> <li>Before we can start exercising HDFS encryption, we will need to set:</li> <li>policy for hadoopadmin access to HDFS</li> <li>policy for hadoopadmin access to Hive  </li> <li> <p>policy for hadoopadmin access to the KMS keys we created</p> </li> <li> <p>Add the user hadoopadmin to the Ranger HDFS global policies. </p> <ul> <li>Access Manager &gt; HDFS &gt; (clustername)_hdfs   </li> <li>This will open the list of HDFS policies     </li> <li>Edit the 'all - path' global policy (the first one) and add hadoopadmin to global HDFS policy and Save   </li> <li>Your policy now includes hadoopadmin  </li> </ul> </li> <li> <p>Add the user hadoopadmin to the Ranger Hive global policies. (Hive has two global policies: one on Hive tables, and one on Hive UDFs)</p> <ul> <li>Access Manager &gt; HIVE &gt; (clustername)_hive   </li> <li>This will open the list of HIVE policies Image </li> <li>Edit the 'all - database, table, column' global policy (the first one) and add hadoopadmin to global HIVE policy and Save </li> <li>Edit the 'all - database, udf' global policy (the second one) and add hadoopadmin to global HIVE policy and Save   </li> <li>Your policies now includes hadoopadmin   </li> </ul> </li> <li> <p>Give keyadmin permission to view Audits screen in Ranger:</p> <ul> <li>Settings tab &gt; Permissions  </li> <li>Click 'Audit' to change users who have access to Audit screen</li> <li>Under 'Select User', add 'keyadmin' user  </li> <li>Save</li> </ul> </li> <li> <p>Logout of Ranger</p> </li> <li>Top right &gt; admin &gt; Logout      </li> <li>Login to Ranger as keyadmin/keyadmin</li> <li>Confirm the KMS repo was setup correctly</li> <li>Under Service Manager &gt; KMS &gt; Click the Edit icon (next to the trash icon) to edit the KMS repo    </li> <li> <p>Click 'Test connection' and confirm it works</p> </li> <li> <p>Create a key called testkey - for reference: see doc</p> </li> <li>Select Encryption &gt; Key Management</li> <li>Select KMS service &gt; pick your kms &gt; Add new Key<ul> <li>if an error is thrown, go back and test connection as described in previous step</li> </ul> </li> <li> <p>Create a key called <code>testkey</code> &gt; Save   </p> </li> <li> <p>Similarly, create another key called <code>testkey2</code></p> </li> <li>Select Encryption &gt; Key Management</li> <li>Select KMS service &gt; pick your kms &gt; Add new Key</li> <li> <p>Create a key called <code>testkey2</code> &gt; Save  </p> </li> <li> <p>Add user <code>hadoopadmin</code> to default KMS key policy</p> </li> <li>Click Access Manager tab</li> <li> <p>Click Service Manager &gt; KMS &gt; (clustername)_kms link   </p> </li> <li> <p>Edit the default policy   </p> </li> <li> <p>Under 'Select User', Add <code>hadoopadmin</code> user and click Save    </p> <ul> <li>Note that:</li> <li><code>hdfs</code> user  needs <code>GetMetaData</code> and <code>GenerateEEK</code> privilege - HDP 2.5</li> <li><code>nn</code> user  needs <code>GetMetaData</code> and <code>GenerateEEK</code> privilege - HDP 2.4</li> <li><code>hive</code> user needs <code>GetMetaData</code> and <code>DecryptEEK</code> privilege</li> </ul> </li> <li> <p>Run below to create a zone using the key and perform basic key and encryption zone (EZ) exercises </p> </li> <li>Create EZs using keys</li> <li>Copy file to EZs</li> <li>Delete file from EZ</li> <li>View contents for raw file</li> <li>Prevent access to raw file</li> <li>Copy file across EZs</li> <li>move hive warehouse dir to EZ</li> </ul> <pre><code>#run below on Ambari node\n\nexport PASSWORD=BadPass#1\n\n#detect name of cluster\noutput=`curl -u hadoopadmin:$PASSWORD -k -i -H 'X-Requested-By: ambari'  https://localhost:8443/api/v1/clusters`\ncluster=`echo $output | sed -n 's/.*\"cluster_name\" : \"\\([^\\\"]*\\)\".*/\\1/p'`\n\necho $cluster\n## this should show the name of your cluster\n\n## if not you can manully set this as below\n## cluster=Security-HWX-LabTesting-XXXX\n\n#first we will run login 3 different users: hdfs, hadoopadmin, sales1\n\n#kinit as hadoopadmin and sales using BadPass#1 \nsudo -u hadoopadmin kinit\n## enter BadPass#1\nsudo -u sales1 kinit\n## enter BadPass#1\n\n#then kinit as hdfs using the headless keytab and the principal name\nsudo -u hdfs kinit -kt /etc/security/keytabs/hdfs.headless.keytab \"hdfs-${cluster,,}\"\n\n#as hadoopadmin list the keys and their metadata\nsudo -u hadoopadmin hadoop key list -metadata\n\n#as hadoopadmin create dirs for EZs\nsudo -u hadoopadmin hdfs dfs -mkdir /zone_encr\nsudo -u hadoopadmin hdfs dfs -mkdir /zone_encr2\n\n#as hdfs create 2 EZs using the 2 keys\nsudo -u hdfs hdfs crypto -createZone -keyName testkey -path /zone_encr\nsudo -u hdfs hdfs crypto -createZone -keyName testkey2 -path /zone_encr2\n# if you get 'RemoteException' error it means you have not given namenode user permissions on testkey by creating a policy for KMS in Ranger\n\n#check EZs got created\nsudo -u hdfs hdfs crypto -listZones  \n\n#create test files\nsudo -u hadoopadmin echo \"My test file1\" &gt; /tmp/test1.log\nsudo -u hadoopadmin echo \"My test file2\" &gt; /tmp/test2.log\n\n#copy files to EZs\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test1.log /zone_encr\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test2.log /zone_encr\n\nsudo -u hadoopadmin hdfs dfs -copyFromLocal /tmp/test2.log /zone_encr2\n\n#Notice that hadoopadmin allowed to decrypt EEK but not sales user (since there is no Ranger policy allowing this)\nsudo -u hadoopadmin hdfs dfs -cat /zone_encr/test1.log\nsudo -u hadoopadmin hdfs dfs -cat /zone_encr2/test2.log\n#this should work\n\nsudo -u sales1      hdfs dfs -cat /zone_encr/test1.log\n## this should give you below error\n## cat: User:sales1 not allowed to do 'DECRYPT_EEK' on 'testkey'\n</code></pre> <ul> <li> <p>Check the Ranger &gt; Audit page and notice that the request from hadoopadmin was allowed but the request from sales1 was denied </p> </li> <li> <p>Now lets test deleting and copying files between EZs - (Reference doc) <pre><code>#try to remove file from EZ using usual -rm command \nsudo -u hadoopadmin hdfs dfs -rm /zone_encr/test2.log\n## This works because as of HDP2.4.3 -skipTrash option no longer needs to be specified\n\n#confirm that test2.log was deleted and that zone_encr only contains test1.log\nsudo -u hadoopadmin hdfs dfs -ls  /zone_encr/\n\n#copy a file between EZs using distcp with -skipcrccheck option\nsudo -u hadoopadmin hadoop distcp -skipcrccheck -update /zone_encr2/test2.log /zone_encr/\n</code></pre></p> </li> <li> <p>Lets now look at the contents of the raw file <pre><code>#View contents of raw file in encrypted zone as hdfs super user. This should show some encrypted characters\nsudo -u hdfs hdfs dfs -cat /.reserved/raw/zone_encr/test1.log\n\n#Prevent user hdfs from reading the file by setting security.hdfs.unreadable.by.superuser attribute. Note that this attribute can only be set on files and can never be removed.\nsudo -u hdfs hdfs dfs -setfattr -n security.hdfs.unreadable.by.superuser  /.reserved/raw/zone_encr/test1.log\n\n# Now as hdfs super user, try to read the files or the contents of the raw file\nsudo -u hdfs hdfs dfs -cat /.reserved/raw/zone_encr/test1.log\n\n## You should get below error\n##cat: Access is denied for hdfs since the superuser is not allowed to perform this operation.\n</code></pre></p> </li> <li> <p>Configure Hive for HDFS Encryption using testkey. Reference <pre><code>sudo -u hadoopadmin hdfs dfs -mv /apps/hive /apps/hive-old\nsudo -u hadoopadmin hdfs dfs -mkdir /apps/hive\nsudo -u hdfs hdfs crypto -createZone -keyName testkey -path /apps/hive\nsudo -u hadoopadmin hadoop distcp -skipcrccheck -update /apps/hive-old/warehouse /apps/hive/warehouse\n</code></pre></p> </li> <li> <p>To configure the Hive scratch directory (hive.exec.scratchdir) so that it resides inside the encryption zone:</p> </li> <li>Ambari &gt; Hive &gt; Configs &gt; Advanced <ul> <li>hive.exec.scratchdir = /apps/hive/tmp</li> </ul> </li> <li> <p>Restart Hive</p> </li> <li> <p>Make sure that the permissions for /apps/hive/tmp are set to 1777 <pre><code>sudo -u hdfs hdfs dfs -chmod -R 1777 /apps/hive/tmp\n</code></pre></p> </li> <li> <p>Confirm permissions by accessing the scratch dir as sales1 <pre><code>sudo -u sales1 hdfs dfs -ls /apps/hive/tmp\n## this should provide listing\n</code></pre></p> </li> <li> <p>Destroy ticket for sales1 <pre><code>sudo -u sales1 kdestroy\n</code></pre></p> </li> <li> <p>Logout of Ranger as keyadmin user</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-7a","title":"Lab 7a","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#secured-hadoop-exercises","title":"Secured Hadoop exercises","text":"<p>In this lab we will see how to interact with Hadoop components (HDFS, Hive, Hbase, Sqoop) running on a kerborized cluster and create Ranger appropriate authorization policies for access.</p> <ul> <li>We will Configure Ranger policies to:</li> <li>Protect /sales HDFS dir - so only sales group has access to it</li> <li>Protect sales hive table - so only sales group has access to it</li> <li>Protect sales HBase table - so only sales group has access to it</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#access-secured-hdfs","title":"Access secured HDFS","text":"<ul> <li> <p>Goal: Create a /sales dir in HDFS and ensure only users belonging to sales group (and admins) have access</p> </li> <li> <p>Login to Ranger (using admin/admin) and confirm the HDFS repo was setup correctly in Ranger</p> </li> <li>In Ranger &gt; Under Service Manager &gt; HDFS &gt; Click the Edit icon (next to the trash icon) to edit the HDFS repo</li> <li>Click 'Test connection' </li> <li>if it fails re-enter below fields and re-try:<ul> <li>Username: <code>rangeradmin@LAB.HORTONWORKS.NET</code></li> <li>Password: BadPass#1</li> <li>RPC Protection type: Authentication</li> </ul> </li> <li> <p>Once the test passes, click Save  </p> </li> <li> <p>Create /sales dir in HDFS as hadoopadmin <pre><code>#authenticate\nsudo -u hadoopadmin kinit\n# enter password: BadPass#1\n\n#create dir and set permissions to 000\nsudo -u hadoopadmin hdfs dfs -mkdir /sales\nsudo -u hadoopadmin hdfs dfs -chmod 000 /sales\n</code></pre></p> </li> <li> <p>Now login as sales1 and attempt to access it before adding any Ranger HDFS policy <pre><code>sudo su - sales1\n\nhdfs dfs -ls /sales\n</code></pre></p> </li> <li> <p>This fails with <code>GSSException: No valid credentials provided</code> because the cluster is kerberized and we have not authenticated yet</p> </li> <li> <p>Authenticate as sales1 user and check the ticket <pre><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></p> </li> <li>Now try accessing the dir again as sales1 <pre><code>hdfs dfs -ls /sales\n</code></pre></li> <li>This time it fails with authorization error: </li> <li> <p><code>Permission denied: user=sales1, access=READ_EXECUTE, inode=\"/sales\":hadoopadmin:hdfs:d---------</code></p> </li> <li> <p>Login into Ranger UI e.g. at http://RANGER_HOST_PUBLIC_IP:6080/index.html as admin/admin</p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p> </li> <li>Service Type: <code>HDFS</code></li> <li> <p>User: <code>sales1</code></p> </li> <li> <p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was \"Denied\" </p> </li> <li> <p>To create an HDFS Policy in Ranger, follow below steps:</p> </li> <li>On the 'Access Manager' tab click HDFS &gt; (clustername)_hadoop   </li> <li>This will open the list of HDFS policies   </li> <li> <p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>/sales</code> dir:</p> <ul> <li>Policy Name: <code>sales dir</code></li> <li>Resource Path: <code>/sales</code></li> <li>Group: <code>sales</code></li> <li>Permissions : <code>Execute Read Write</code></li> <li>Add   </li> </ul> </li> <li> <p>Wait 30s for policy to take effect</p> </li> <li> <p>Now try accessing the dir again as sales1 and now there is no error seen <pre><code>hdfs dfs -ls /sales\n</code></pre></p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p> </li> <li>Service Type: HDFS</li> <li> <p>User: sales1</p> </li> <li> <p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code> </p> </li> <li> <p>You can also see the details that were captured for each request:</p> <ul> <li>Policy that allowed the access</li> <li>Time</li> <li>Requesting user</li> <li>Service type (e.g. hdfs, hive, hbase etc)</li> <li>Resource name </li> <li>Access type (e.g. read, write, execute)</li> <li>Result (e.g. allowed or denied)</li> <li>Access enforcer (i.e. whether native acl or ranger acls were used)</li> <li>Client IP</li> <li>Event count</li> </ul> </li> <li> <p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column  </p> </li> <li> <p>Now let's check whether non-sales users can access the directory</p> </li> <li> <p>Logout as sales1 and log back in as hr1 <pre><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></p> </li> <li> <p>Try to access the same dir as hr1 and notice it fails <pre><code>hdfs dfs -ls /sales\n## ls: Permission denied: user=hr1, access=READ_EXECUTE, inode=\"/sales\":hadoopadmin:hdfs:d---------\n</code></pre></p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and this time filter by 'Resource Name'</p> </li> <li>Service Type: <code>HDFS</code></li> <li> <p>Resource Name: <code>/sales</code></p> </li> <li> <p>Notice you can see the history/details of all the requests made for /sales directory:</p> </li> <li>created by hadoopadmin </li> <li>initial request by sales1 user was denied </li> <li>subsequent request by sales1 user was allowed (once the policy was created)</li> <li> <p>request by hr1 user was denied  </p> </li> <li> <p>Logout as hr1 <pre><code>kdestroy\nlogout\n</code></pre></p> </li> <li>We have successfully setup an HDFS dir which is only accessible by sales group (and admins)</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#access-secured-hive","title":"Access secured Hive","text":"<ul> <li> <p>Goal: Setup Hive authorization policies to ensure sales users only have access to code, description columns in default.sample_07</p> </li> <li> <p>Enable Hive on tez by setting below and restarting Hive </p> </li> <li> <p>Ambari &gt; Hive &gt; Configs     </p> <ul> <li>Execution Engine = Tez</li> </ul> </li> <li> <p>Confirm the HIVE repo was setup correctly in Ranger</p> </li> <li>In Ranger &gt; Service Manager &gt; HIVE &gt; Click the Edit icon (next to the trash icon) to edit the HIVE repo</li> <li>Click 'Test connection' </li> <li>if it fails re-enter below fields and re-try:<ul> <li>Username: <code>rangeradmin@LAB.HORTONWORKS.NET</code></li> <li>Password: BadPass#1</li> </ul> </li> <li> <p>Once the test passes, click Save  </p> </li> <li> <p>Now run these steps from node where Hive (or client) is installed </p> </li> <li> <p>Login as sales1 and attempt to connect to default database in Hive via beeline and access sample_07 table</p> </li> <li> <p>Notice that in the JDBC connect string for connecting to an secured Hive while its running in default (ie binary) transport mode :</p> </li> <li>port remains 10000</li> <li> <p>now a kerberos principal needs to be passed in</p> </li> <li> <p>Login as sales1 without kerberos ticket and try to open beeline connection: <pre><code>sudo su - sales1\nkdestroy\nbeeline -u \"jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET\"\n</code></pre></p> </li> <li> <p>This fails with <code>GSS initiate failed</code> because the cluster is kerberized and we have not authenticated yet</p> </li> <li> <p>To exit beeline: <pre><code>!q\n</code></pre></p> </li> <li>Authenticate as sales1 user and check the ticket <pre><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></li> <li> <p>Now try connect to Hive via beeline as sales1 <pre><code>beeline -u \"jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET\"\n</code></pre></p> </li> <li> <p>If you get the below error, it is because you did not add hive to the global KMS policy in an earlier step (along with nn, hadoopadmin). Go back and add it in. <pre><code>org.apache.hadoop.security.authorize.AuthorizationException: User:hive not allowed to do 'GET_METADATA' on 'testkey'\n</code></pre></p> </li> <li> <p>This time it connects. Now try to run a query <pre><code>beeline&gt; select code, description from sample_07;\n</code></pre></p> </li> <li>Now it fails with authorization error: </li> <li> <p><code>HiveAccessControlException Permission denied: user [sales1] does not have [SELECT] privilege on [default/sample_07]</code></p> </li> <li> <p>Login into Ranger UI e.g. at http://RANGER_HOST_PUBLIC_IP:6080/index.html as admin/admin</p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p> </li> <li>Service Type: <code>Hive</code></li> <li> <p>User: <code>sales1</code></p> </li> <li> <p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was <code>Denied</code> </p> </li> <li> <p>To create an HIVE Policy in Ranger, follow below steps:</p> </li> <li>On the 'Access Manager' tab click HIVE &gt; (clustername)_hive   </li> <li>This will open the list of HIVE policies   </li> <li> <p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>code</code>, <code>description</code> and <code>total_emp</code> columns in <code>sample_07</code> dir:</p> <ul> <li>Policy Name: <code>sample_07</code></li> <li>Hive Database: <code>default</code></li> <li>table: <code>sample_07</code></li> <li>Hive Column: <code>code</code> <code>description</code> <code>total_emp</code></li> <li>Group: <code>sales</code></li> <li>Permissions : <code>select</code></li> <li>Add   </li> </ul> </li> <li> <p>Notice that as you typed the name of the DB and table, Ranger was able to look these up and autocomplete them</p> </li> <li> <p>This was done using the rangeradmin principal we provided during Ranger install</p> </li> <li> <p>Also, notice that permissions are only configurable for allowing access, and you are not able to explicitly deny a user/group access to a resource unless you have enabled Deny Conditions during your Ranger install (step 8).</p> </li> <li> <p>Wait 30s for the new policy to be picked up</p> </li> <li> <p>Now try accessing the columns again and now the query works <pre><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></p> </li> <li> <p>Note though, that if instead you try to describe the table or query all columns, it will be denied - because we only gave sales users access to two columns in the table</p> </li> <li><code>beeline&gt; desc sample_07;</code></li> <li> <p><code>beeline&gt; select * from sample_07;</code></p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p> </li> <li>Service Type: HIVE</li> <li> <p>User: sales1</p> </li> <li> <p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code> </p> </li> <li> <p>You can also see the details that were captured for each request:</p> <ul> <li>Policy that allowed the access</li> <li>Time</li> <li>Requesting user</li> <li>Service type (e.g. hdfs, hive, hbase etc)</li> <li>Resource name </li> <li>Access type (e.g. read, write, execute)</li> <li>Result (e.g. allowed or denied)</li> <li>Access enforcer (i.e. whether native acl or ranger acls were used)</li> <li>Client IP</li> <li>Event count</li> </ul> </li> <li> <p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column  </p> </li> <li> <p>We are also able to limit sales1's access to only subset of data by using row-level filter.  Suppose we only want to allow the sales group access to data where <code>total_emp</code> is less than 5000. </p> </li> <li> <p>On the Hive Policies page, select the 'Row Level Filter' tab and click on 'Add New Policy'  </p> <ul> <li>Please note that in order to apply a row level filter policy the user/group must already have 'select' permissions on the table. </li> </ul> </li> <li> <p>Create a policy restricting access to only rows where <code>total_emp</code> is less than 5000:</p> <ul> <li>Policy Name: <code>sample_07_filter_total_emp</code></li> <li>Hive Database: <code>default</code></li> <li>table: <code>sample_07</code></li> <li>Group: <code>sales</code></li> <li>Permissions : <code>select</code></li> <li>Row Level Filter : <code>total_emp&lt;5000</code><ul> <li>The filter syntax is similar to what you would write after a 'WHERE' clause in a SQL query</li> </ul> </li> <li>Add   </li> </ul> </li> <li> <p>Wait 30s for the new policy to be picked up</p> </li> <li> <p>Now try accessing the columns again and notice how only rows that match the filter criteria are shown <pre><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></p> </li> <li> <p>Go back to the Ranger Audits page and notice how the filter policy was applied to the query</p> </li> <li> <p>Suppose we would now like to mask <code>total_emp</code> column from sales1.  This is different from denying/dis-allowing access in that the user can query the column but cannot see the actual data </p> </li> <li> <p>On the Hive Policies page, select the 'Masking' tab and click on 'Add New Policy'  </p> <ul> <li>Please note that in order to mask a column, the user/group must already have 'select' permissions to that column.  Creating a masking policy on a column that a user does not have access to will deny the user access</li> </ul> </li> <li> <p>Create a policy masking the  <code>total_emp</code> column for <code>sales</code> group users:</p> <ul> <li>Policy Name: <code>sample_07_total_emp</code></li> <li>Hive Database: <code>default</code></li> <li>table: <code>sample_07</code></li> <li>Hive Column: <code>total_emp</code></li> <li>Group: <code>sales</code></li> <li>Permissions : <code>select</code></li> <li> <p>Masking Option : <code>redact</code></p> <ul> <li>Notice the different masking options available</li> <li>The 'Custom' masking option can use any Hive UDF as long as it returns the same data type as that of the column </li> </ul> </li> <li> <p>Add   </p> </li> </ul> </li> <li> <p>Wait 30s for the new policy to be picked up</p> </li> <li> <p>Now try accessing the columns again and notice how the results for the <code>total_emp</code> column is masked <pre><code>beeline&gt; select code, description, total_emp from sample_07;\n</code></pre></p> </li> <li> <p>Go back to the Ranger Audits page and notice how the masking policy was applied to the query.</p> </li> <li> <p>Exit beeline <pre><code>!q\n</code></pre></p> </li> <li> <p>Now let's check whether non-sales users can access the table</p> </li> <li> <p>Logout as sales1 and log back in as hr1 <pre><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></p> </li> <li>Try to access the same table as hr1 and notice it fails <pre><code>beeline -u \"jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET\"\n</code></pre> <pre><code>beeline&gt; select code, description from sample_07;\n</code></pre></li> <li>In Ranger, click on 'Audit' to open the Audits page and filter by 'Service Type' = 'Hive'</li> <li> <p>Service Type: <code>HIVE</code></p> </li> <li> <p>Here you can see the request by sales1 was allowed but hr1 was denied</p> </li> </ul> <p> </p> <ul> <li>Exit beeline <pre><code>!q\n</code></pre></li> <li> <p>Logoff as hr1 <pre><code>logout\n</code></pre></p> </li> <li> <p>We have setup Hive authorization policies to ensure only sales users have access to code, description columns in default.sample_07</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#access-secured-hbase","title":"Access secured HBase","text":"<ul> <li> <p>Goal: Create a table called 'sales' in HBase and setup authorization policies to ensure only sales users have access to the table</p> </li> <li> <p>Run these steps from any node where Hbase Master or RegionServer services are installed </p> </li> <li> <p>Login as sales1 <pre><code>sudo su - sales1\n</code></pre></p> </li> <li>Start the hbase shell <pre><code>hbase shell\n</code></pre></li> <li>List tables in default database <pre><code>hbase&gt; list 'default'\n</code></pre></li> <li> <p>This fails with <code>GSSException: No valid credentials provided</code> because the cluster is kerberized and we have not authenticated yet</p> </li> <li> <p>To exit hbase shell: <pre><code>exit\n</code></pre></p> </li> <li>Authenticate as sales1 user and check the ticket <pre><code>kinit\n# enter password: BadPass#1\n\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre></li> <li>Now try connect to Hbase shell and list tables as sales1 <pre><code>hbase shell\nhbase&gt; list 'default'\n</code></pre></li> <li>This time it works. Now try to create a table called <code>sales</code> with column family called <code>cf</code> <pre><code>hbase&gt; create 'sales', 'cf'\n</code></pre></li> <li>Now it fails with authorization error: </li> <li><code>org.apache.hadoop.hbase.security.AccessDeniedException: Insufficient permissions for user 'sales1@LAB.HORTONWORKS.NET' (action=create)</code></li> <li> <p>Note: there will be a lot of output from above. The error will be on the line right after your create command</p> </li> <li> <p>Login into Ranger UI e.g. at http://RANGER_HOST_PUBLIC_IP:6080/index.html as admin/admin</p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below. </p> </li> <li>Service Type: <code>Hbase</code></li> <li> <p>User: <code>sales1</code></p> </li> <li> <p>Notice that Ranger captured the access attempt and since there is currently no policy to allow the access, it was <code>Denied</code> </p> </li> <li> <p>To create an HBASE Policy in Ranger, follow below steps:</p> </li> <li>On the 'Access Manager' tab click HBASE &gt; (clustername)_hbase   </li> <li>This will open the list of HBASE policies   </li> <li> <p>Click 'Add New Policy' button to create a new one allowing <code>sales</code> group users access to <code>sales</code> table in HBase:</p> <ul> <li>Policy Name: <code>sales</code></li> <li>Hbase Table: <code>sales</code></li> <li>Hbase Column Family: <code>*</code></li> <li>Hbase Column: <code>*</code></li> <li>Group : <code>sales</code> </li> <li>Permissions : <code>Admin</code> <code>Create</code> <code>Read</code> <code>Write</code></li> <li>Add   </li> </ul> </li> <li> <p>Wait 30s for policy to take effect</p> </li> <li> <p>Now try creating the table and now it works <pre><code>hbase&gt; create 'sales', 'cf'\n</code></pre></p> </li> <li> <p>In Ranger, click on 'Audit' to open the Audits page and filter by below:</p> </li> <li>Service Type: HBASE</li> <li> <p>User: sales1</p> </li> <li> <p>Notice that Ranger captured the access attempt and since this time there is a policy to allow the access, it was <code>Allowed</code> </p> </li> <li> <p>You can also see the details that were captured for each request:</p> <ul> <li>Policy that allowed the access</li> <li>Time</li> <li>Requesting user</li> <li>Service type (e.g. hdfs, hive, hbase etc)</li> <li>Resource name </li> <li>Access type (e.g. read, write, execute)</li> <li>Result (e.g. allowed or denied)</li> <li>Access enforcer (i.e. whether native acl or ranger acls were used)</li> <li>Client IP</li> <li>Event count</li> </ul> </li> <li> <p>For any allowed requests, notice that you can quickly check the details of the policy that allowed the access by clicking on the policy number in the 'Policy ID' column  </p> </li> <li> <p>Exit hbase shell <pre><code>hbase&gt; exit\n</code></pre></p> </li> <li> <p>Now let's check whether non-sales users can access the table</p> </li> <li> <p>Logout as sales1 and log back in as hr1 <pre><code>kdestroy\n#logout as sales1\nlogout\n\n#login as hr1 and authenticate\nsudo su - hr1\n\nkinit\n# enter password: BadPass#1\n\nklist\n## Default principal: hr1@LAB.HORTONWORKS.NET\n</code></pre></p> </li> <li>Try to access the same dir as hr1 and notice this user does not even see the table <pre><code>hbase shell\nhbase&gt; describe 'sales'\nhbase&gt; list 'default'\n</code></pre></li> </ul> <p></p> <ul> <li>Try to create a table as hr1 and it fails with <code>org.apache.hadoop.hbase.security.AccessDeniedException: Insufficient permissions</code> <pre><code>hbase&gt; create 'sales', 'cf'\n</code></pre></li> <li>In Ranger, click on 'Audit' to open the Audits page and filter by:</li> <li>Service Type: <code>HBASE</code></li> <li> <p>Resource Name: <code>sales</code></p> </li> <li> <p>Here you can see the request by sales1 was allowed but hr1 was denied</p> </li> </ul> <p> </p> <ul> <li> <p>Exit hbase shell <pre><code>hbase&gt; exit\n</code></pre></p> </li> <li> <p>Logout as hr1 <pre><code>kdestroy\nlogout\n</code></pre></p> </li> <li> <p>We have successfully created a table called 'sales' in HBase and setup authorization policies to ensure only sales users have access to the table</p> </li> <li> <p>This shows how you can interact with Hadoop components on kerberized cluster and use Ranger to manage authorization policies and audits</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#optional-use-sqoop-to-import","title":"(Optional) Use Sqoop to import","text":"<ul> <li>If Sqoop is not already installed, install it via Ambari on same node where Mysql/Hive are installed:</li> <li>Admin &gt; Stacks and Versions &gt; Sqoop &gt; Add service &gt; select node where Mysql/Hive are installed and accept all defaults and finally click \"Proceed Anyway\"</li> <li> <p>You will be asked to enter admin principal/password:</p> <ul> <li><code>hadoopadmin@LAB.HORTONWORKS.NET</code></li> <li>BadPass#1</li> </ul> </li> <li> <p>On the host running Mysql: change user to root and download a sample csv and login to Mysql <pre><code>sudo su - \nwget https://raw.githubusercontent.com/HortonworksUniversity/Security_Labs/master/labdata/PII_data_small.csv\nmysql -u root -pBadPass#1\n</code></pre></p> </li> <li> <p>At the <code>mysql&gt;</code> prompt run below to: </p> </li> <li>create a table in Mysql</li> <li>give access to sales1</li> <li>import the data from csv</li> <li> <p>test that table was created <pre><code>create database people;\nuse people;\ncreate table persons (people_id INT PRIMARY KEY, sex text, bdate DATE, firstname text, lastname text, addresslineone text, addresslinetwo text, city text, postalcode text, ssn text, id2 text, email text, id3 text);\nGRANT ALL PRIVILEGES ON people.* to 'sales1'@'%' IDENTIFIED BY 'BadPass#1';\nLOAD DATA LOCAL INFILE '~/PII_data_small.csv' REPLACE INTO TABLE persons FIELDS TERMINATED BY ',' LINES TERMINATED BY '\\n';\n\nselect people_id, firstname, lastname, city from persons where lastname='SMITH';\nexit\n</code></pre></p> </li> <li> <p>logoff as root <pre><code>logout\n</code></pre></p> </li> <li> <p>Create Ranger policy to allow <code>sales</code> group <code>all permissions</code> on <code>persons</code> table in Hive</p> </li> <li>Access Manager &gt; Hive &gt; (cluster)_hive &gt; Add new policy</li> <li> <p>Create new policy as below and click Add:  </p> </li> <li> <p>Create Ranger policy to allow <code>sales</code> group <code>all permissions</code> on <code>/ranger/audit/kms</code> dir in HDFS</p> </li> <li>Access Manager &gt; HDFS &gt; (cluster)_hdfs &gt; Add new policy</li> <li> <p>Create new policy as below and click Add:   TODO: add screenshot</p> </li> <li> <p>Log out of Ranger</p> </li> <li> <p>Create Ranger policy to allow <code>sales</code> group <code>Get Metadata</code> <code>GenerateEEK</code> <code>DecryptEEK</code> permissions on <code>testkey</code> (i.e. the key used to encrypt Hive warehouse directories)</p> </li> <li>Login to Ranger http://RANGER_PUBLIC_IP:6080 with keyadmin/keyadmin</li> <li>Access Manager &gt; KMS &gt; (cluster)_KMS &gt; Add new policy</li> <li>Create new policy as below and click Add:    </li> <li> <p>Log out of Ranger and re-login as admin/admin</p> </li> <li> <p>Login as sales1 <pre><code>sudo su - sales1\n</code></pre></p> </li> <li> <p>As sales1 user, kinit and run sqoop job to create persons table in Hive (in ORC format) and import data from MySQL. Below are the details of the arguments passed in:</p> </li> <li>Table: MySQL table name</li> <li>username: Mysql username</li> <li>password: Mysql password</li> <li>hcatalog-table: Hive table name</li> <li>create-hcatalog-table: hive table should be created first</li> <li>driver: classname for Mysql driver</li> <li>m: number of mappers</li> </ul> <p><pre><code>kinit\n## enter BadPass#1 as password\n\nsqoop import --verbose --connect \"jdbc:mysql://$(hostname -f)/people\" --table persons --username sales1 --password BadPass#1 --hcatalog-table persons --hcatalog-storage-stanza \"stored as orc\" -m 1 --create-hcatalog-table  --driver com.mysql.jdbc.Driver\n</code></pre> - This will start a mapreduce job to import the data from Mysql to Hive in ORC format</p> <ul> <li> <p>Note: if the mapreduce job fails with below, most likely you have not given sales group all the permissions needed on the EK used to encrypt Hive directories  <pre><code> java.lang.RuntimeException: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure\n</code></pre></p> </li> <li> <p>Also note: if the mapreduce job fails saying sales user does not have write access to /apps/hive/warehouse, you will need to create HDFS policy allowing sales1 user and hive access on /apps/hive/warehouse dir </p> </li> <li> <p>Login to beeline <pre><code>beeline -u \"jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET\"\n</code></pre></p> </li> <li> <p>Query persons table in beeline <pre><code>beeline&gt; select * from persons;\n</code></pre></p> </li> <li> <p>Since the authorization policy is in place, the query should work</p> </li> <li> <p>Ranger audit should show the request was allowed:</p> </li> <li>Under Ranger &gt; Audit &gt; query for<ul> <li>Service type: HIVE </li> </ul> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#drop-encrypted-hive-tables","title":"Drop Encrypted Hive tables","text":"<ul> <li>From beeline, try to drop the persons table.  <pre><code>beeline&gt; drop table persons;\n</code></pre></li> <li> <p>You will get error similar to below <pre><code>message:Unable to drop default.persons because it is in an encryption zone and trash is enabled.  Use PURGE option to skip trash.\n</code></pre></p> </li> <li> <p>To drop a Hive table (when Hive directories are located in EncryptionZone), you need to include <code>purge</code> as below: <pre><code>beeline&gt; drop table persons purge;\n</code></pre></p> </li> <li> <p>Destroy the ticket and logout as sales1 <pre><code>kdestroy\nlogout\n</code></pre></p> </li> <li> <p>This completes the lab. You have now interacted with Hadoop components in secured mode and used Ranger to manage authorization policies and audits</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-7b","title":"Lab 7b","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#tag-based-policies-atlasranger-integration","title":"Tag-Based Policies (Atlas+Ranger Integration)","text":"<p>Goal: In this lab we will explore how Atlas and Ranger integrate to enhance data access and authorization through tags </p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#atlas-preparation","title":"Atlas Preparation","text":"<p>To create Tag-Based Policies, we will first need to create tags in Atlas and associate them to entities</p> <ul> <li> <p>Go to https://localhost:21000 and login to the Atlas UI using admin/admin for the username and pass </p> </li> <li> <p>Select the \"TAGS\" tab and click on \"Create Tag\" </p> </li> <li> <p>Create a new tag by inputing</p> <ul> <li>Name: <code>Private</code></li> <li>Create </li> </ul> </li> <li> <p>Repeat the tag creation process above and create an additional tag named \"Restricted\" </p> </li> <li> <p>Create a third tag named \"Sensitive\", however, during creation, click on \"Add New Attributes\" and input:</p> <ul> <li>Attribute Name: <code>level</code></li> <li>Type: <code>int</code> </li> </ul> </li> <li> <p>Create a fourth tag named \"EXPIRES_ON\", and during creation, click on \"Add New Attributes\" and input:</p> <ul> <li>Attribute Name: <code>expiry_date</code></li> <li>Type: <code>int</code> </li> </ul> </li> <li> <p>Under the \"Tags\" tab in the main screen you should see the list of newly created tags </p> </li> <li> <p>In the search tab search using the following:</p> <ul> <li>Search By Type: <code>hive_table</code></li> <li>Search By Text: <code>sample_08</code></li> <li>Search </li> </ul> </li> <li> <p>To associate a tag to the \"sample_08\" table, click on the \"+\" under the Tags column in the search results for \"sample_08\" </p> </li> <li> <p>From the dropdown select <code>Private</code> and click <code>Add</code> </p> </li> <li> <p>You should see that the \"Private\" tag has been associated to the \"sample_08\" table </p> </li> <li> <p>Now, in the same manner, associate the \"EXPIRES_ON\" tag to the \"sample_08\" table     When prompted, select a date in the past for \"expiry_date\" </p> </li> <li> <p>In the search results panel, click on the \"sample_08\" link </p> </li> <li> <p>Scroll down and select the \"Schema\" tab </p> </li> <li> <p>Select the \"+\" button under the Tag column for \"salary\" and associate the <code>Restricted</code> tag to it</p> </li> <li> <p>Select the \"+\" button under the Tag column for \"total_emp\" and associate the <code>Sensitive</code> tag to it</p> <ul> <li>When prompted, input <code>5</code> for the \"level\" </li> </ul> </li> <li> <p>On the \"sample_08\" table schema page you should see the table columns with the associated tags </p> </li> </ul> <p>We have now completed our preparation work in Atlas and have created the following tags and associations:     - \"Private\" tag associated to \"sample_08\" table     - \"Sensitive\" tag with a \"level\" of '5', associated to \"sample_08.total_emp\" column     - \"Restricted\" tag associated to \"sample_08.salary\" column</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-preparation","title":"Ranger Preparation","text":"<p>To enable Ranger for Tag-Based Policies complete the following:</p> <ul> <li> <p>Select \"Access Manager\" and then \"Tag Based Policies\" from the upper left hand corner of the main Ranger UI page </p> </li> <li> <p>Click on the \"+\" to create a new tag service </p> </li> <li> <p>In the tag service page input:</p> <ul> <li>Service Name: <code>tags</code></li> <li>Save </li> </ul> </li> <li> <p>On the Ranger UI main page, select the edit button next to your (clustername)_hive service </p> </li> <li> <p>In the Edit Service page add the below and then click save</p> <ul> <li>Select Tag Service: <code>tags</code> </li> </ul> </li> </ul> <p>We should now be able to create Tag-Based Policies for Hive</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#tag-based-access-control","title":"Tag-Based Access Control","text":"<p>Goal: Create a Tag-Based policy for sales to access all entities tagged as \"Private\"</p> <ul> <li> <p>Select \"Access Manager\" and then \"Tag Based Policies\" from the upper left hand corner of the main Ranger UI page </p> </li> <li> <p>Select the \"tags\" service that you had previously created</p> </li> <li> <p>On the \"tags Policies\" page, click on \"Add New Policy\" </p> </li> <li> <p>Input the following to create the new policy</p> <ul> <li>Policy Name: <code>Private Data Access</code></li> <li>TAG: <code>Private</code></li> <li>Under \"Allow Conditions\"<ul> <li>Select Group: <code>sales</code></li> <li>Component Permissions: (select <code>Hive</code> and enable all actions)</li> </ul> </li> <li>Add  </li> </ul> </li> <li> <p>Run these steps from node where Hive (or client) is installed </p> </li> <li> <p>From node where Hive (or client) is installed, login as sales1 and connect to beeline: <pre><code>su - sales1\nklist\n## Default principal: sales1@LAB.HORTONWORKS.NET\n</code></pre> <pre><code>beeline -u \"jdbc:hive2://localhost:10000/default;principal=hive/$(hostname -f)@LAB.HORTONWORKS.NET\"\n</code></pre></p> </li> <li>Now try accessing table \"sample_08\" and notice how you have access to all the contents of the table <pre><code>beeline&gt; select * from sample_08;\n</code></pre></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#attribute-based-access-control","title":"Attribute-Based Access Control","text":"<p>Goal: Disallow everybody's access to data tagged as \"Sensitive\" and has an attribute \"level\" 5 or above</p> <ul> <li> <p>Return to the Ranger \"tags Policies\" page and \"Add New Policy\" with the below parameters</p> <ul> <li>Policy Name: <code>Sensitive Data Access</code></li> <li>TAG: <code>Sensitive</code></li> <li>Under \"Deny Conditions\" <ul> <li>Select Group: <code>public</code></li> <li>Policy Conditions/Enter boolean expression: <code>level&gt;=5</code><ul> <li>Note: Boolean expressions are written in Javascript</li> </ul> </li> <li>Component Permissions: (select <code>Hive</code> and enable all actions)</li> </ul> </li> <li>Add  </li> </ul> </li> <li> <p>Wait 30 seconds before trying to access the \"total_emp\" column in table \"sample_08\" and notice how you are denied access <pre><code>beeline&gt; select total_emp from sample_08;\n</code></pre></p> </li> <li> <p>Now try to access the other columns and notice how you are allowed access to them access <pre><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#tag-based-masking","title":"Tag-Based Masking","text":"<p>Goal: Mask data tagged as \"Restricted\"</p> <ul> <li> <p>Return to the Ranger \"tags Policies\" page, click on the \"Masking\" tab in the upper right hand  </p> </li> <li> <p>Click on \"Add New Policy\" and input the below parameters</p> <ul> <li>Policy Name: <code>Restricted Data Access</code></li> <li>TAG: <code>Restricted</code></li> <li>Under \"Mask Conditions\" <ul> <li>Select Group: <code>public</code></li> <li>Component Permissions: (select <code>Hive</code> and enable all actions)</li> <li>Select Masking Option: <code>Redact</code> </li> </ul> </li> <li>Add</li> </ul> </li> <li> <p>Wait 30 seconds and try run the below query.  Notice how salary data has been masked <pre><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#location-based-access-control","title":"Location-Based Access Control","text":"<p>Goal: Restrict access to data based on a user's physical location at the time.</p> <ul> <li> <p>Return to the Ranger \"tags Policies\" page (\"Access\" tab) and \"Add New Policy\" with the below parameters</p> <ul> <li>Policy Name: <code>Geo-Location Access</code></li> <li>TAG: <code>Restricted</code></li> <li>Under \"Deny Conditions\" <ul> <li>Select Group: <code>public</code></li> <li>Policy Conditions/Enter boolean expression: <code>country_code=='USA'</code><ul> <li>If you are outside of USA use <code>country_code!='USA'</code> instead</li> </ul> </li> <li>Component Permissions: (select <code>Hive</code> and enable all actions)</li> </ul> </li> <li>Add  </li> </ul> </li> <li> <p>Wait 30 seconds and try run the below query.  Notice how you are now denied access to the \"salary\" column because of your location <pre><code>beeline&gt; select code, description, salary from sample_08;\n</code></pre></p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#time-based-policies","title":"Time-Based Policies","text":"<p>Goal: To place an expiry date on sales' access policy to data tagged as \"Private\" after which access will be denied</p> <ul> <li> <p>Return to the Ranger \"tags Policies\" page (\"Access\" tab)and \"Add New Policy\" with the below parameters.  You may already have default policy named \"EXPIRES_ON\", if so, please delete it before clicking \"Add New Policy\" </p> <ul> <li>Policy Name: <code>EXPIRES_ON</code></li> <li>TAG: <code>EXPIRES_ON</code></li> <li>Under \"Deny Conditions\" <ul> <li>Select Group: <code>public</code></li> <li>Policy Conditions/Accessed after expiry_date: <code>yes</code></li> <li>Component Permissions: (select <code>Hive</code> and enable all actions)</li> </ul> </li> <li>Add  </li> </ul> </li> <li> <p>Wait 30 seconds and try run the below query.  Notice how you are now denied access to the entire \"sample_08\" table because it is accessed after the expiry date tagged in Atlas <pre><code>beeline&gt; select code, description from sample_08;\n</code></pre></p> </li> <li> <p>Exit beeline <pre><code>!q\n</code></pre></p> </li> <li>Logoff as sales1 <pre><code>logout\n</code></pre></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#policy-evaluation-and-precedence","title":"Policy Evaluation and Precedence","text":"<p>Notice how in the policies above, ones that deny access always take precedence over ones that allow access.  For example, even though sales had access to \"Private\" data in the Tag-Based Access Control section, they were gradually disallowed access over the following sections as we set up \"Deny\" policies.  This applies to both, Tag-Based as well as Resource-Based policies.  To understand better the sequence of policy evaluation, take a look at the following flow-chart. </p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#lab-8","title":"Lab 8","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#knox","title":"Knox","text":"<p>Goal: In this lab we will configure Apache Knox for AD authentication and make WebHDFS, Hive requests over Knox (after setting the appropriate Ranger authorization polices for access)</p>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#knox-configuration","title":"Knox Configuration","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#knox-configuration-for-ad-authentication","title":"Knox Configuration for AD authentication","text":"<ul> <li> <p>Run these steps on the node where Knox was installed earlier</p> </li> <li> <p>To configure Knox for AD authentication we need to enter AD related properties in topology xml via Ambari</p> </li> <li> <p>The problem is it requires us to enter LDAP bind password, but we do not want it exposed as plain text in the Ambari configs</p> </li> <li> <p>The solution? Create keystore alias for the ldap manager user (which you will later pass in to the topology via the 'systemUsername' property)</p> </li> <li>Read password for use in following command (this will prompt you for a password and save it in knoxpass environment variable). Enter BadPass#1:    <pre><code>read -s -p \"Password: \" knoxpass\n</code></pre></li> <li> <p>This is a handy way to set an env var without storing the command in your history</p> </li> <li> <p>Create password alias for Knox called knoxLdapSystemPassword    <pre><code>sudo -u knox /usr/hdp/current/knox-server/bin/knoxcli.sh create-alias knoxLdapSystemPassword --cluster default --value ${knoxpass}\nunset knoxpass\n</code></pre></p> </li> <li> <p>Now lets configure Knox to use our AD for authentication. Replace below content in Ambari &gt; Knox &gt; Config &gt; Advanced topology. </p> </li> <li> <p>How to tell what configs were changed from defaults? </p> <ul> <li>Default configs remain indented below</li> <li>Configurations that were added/modified are not indented <pre><code>&lt;topology&gt;\n\n            &lt;gateway&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;authentication&lt;/role&gt;\n                    &lt;name&gt;ShiroProvider&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;sessionTimeout&lt;/name&gt;\n                        &lt;value&gt;30&lt;/value&gt;\n                    &lt;/param&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;main.ldapRealm&lt;/name&gt;\n                        &lt;value&gt;org.apache.hadoop.gateway.shirorealm.KnoxLdapRealm&lt;/value&gt;\n                    &lt;/param&gt;\n\n&lt;!-- changes for AD/user sync --&gt;\n\n&lt;param&gt;\n    &lt;name&gt;main.ldapContextFactory&lt;/name&gt;\n    &lt;value&gt;org.apache.hadoop.gateway.shirorealm.KnoxLdapContextFactory&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- main.ldapRealm.contextFactory needs to be placed before other main.ldapRealm.contextFactory* entries  --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory&lt;/name&gt;\n    &lt;value&gt;$ldapContextFactory&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- IPA url --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.url&lt;/name&gt;\n    &lt;value&gt;ldap://ipa.us-west-2.compute.internal:389&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- system user --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.systemUsername&lt;/name&gt;\n    &lt;value&gt;uid=hadoopadmin,cn=users,cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- pass in the password using the alias created earlier --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.contextFactory.systemPassword&lt;/name&gt;\n    &lt;value&gt;${ALIAS=knoxLdapSystemPassword}&lt;/value&gt;\n&lt;/param&gt;\n\n                    &lt;param&gt;\n                        &lt;name&gt;main.ldapRealm.contextFactory.authenticationMechanism&lt;/name&gt;\n                        &lt;value&gt;simple&lt;/value&gt;\n                    &lt;/param&gt;\n                    &lt;param&gt;\n                        &lt;name&gt;urls./**&lt;/name&gt;\n                        &lt;value&gt;authcBasic&lt;/value&gt;\n                    &lt;/param&gt;\n\n&lt;!--  AD groups of users to allow --&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.searchBase&lt;/name&gt;\n    &lt;value&gt;cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.userObjectClass&lt;/name&gt;\n    &lt;value&gt;posixAccount&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.userSearchAttributeName&lt;/name&gt;\n    &lt;value&gt;uid&lt;/value&gt;\n&lt;/param&gt;\n\n&lt;!-- changes needed for group sync--&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.authorizationEnabled&lt;/name&gt;\n    &lt;value&gt;true&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupSearchBase&lt;/name&gt;\n    &lt;value&gt;cn=accounts,dc=us-west-2,dc=compute,dc=internal&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupObjectClass&lt;/name&gt;\n    &lt;value&gt;posixGroup&lt;/value&gt;\n&lt;/param&gt;\n&lt;param&gt;\n    &lt;name&gt;main.ldapRealm.groupIdAttribute&lt;/name&gt;\n    &lt;value&gt;cn&lt;/value&gt;\n&lt;/param&gt;\n\n\n                &lt;/provider&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;identity-assertion&lt;/role&gt;\n                    &lt;name&gt;Default&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                &lt;/provider&gt;\n\n                &lt;provider&gt;\n                    &lt;role&gt;authorization&lt;/role&gt;\n                    &lt;name&gt;XASecurePDPKnox&lt;/name&gt;\n                    &lt;enabled&gt;true&lt;/enabled&gt;\n                &lt;/provider&gt;\n\n&lt;!--\n  Knox HaProvider for Hadoop services\n  --&gt;\n&lt;provider&gt;\n     &lt;role&gt;ha&lt;/role&gt;\n     &lt;name&gt;HaProvider&lt;/name&gt;\n     &lt;enabled&gt;true&lt;/enabled&gt;\n     &lt;param&gt;\n         &lt;name&gt;OOZIE&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;HBASE&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;WEBHCAT&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n         &lt;name&gt;WEBHDFS&lt;/name&gt;\n         &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;maxRetryAttempts=300;retrySleep=1000;enabled=true&lt;/value&gt;\n     &lt;/param&gt;\n     &lt;param&gt;\n        &lt;name&gt;HIVE&lt;/name&gt;\n        &lt;value&gt;maxFailoverAttempts=3;failoverSleep=1000;enabled=true;zookeeperEnsemble=machine1:2181,machine2:2181,machine3:2181;\n       zookeeperNamespace=hiveserver2&lt;/value&gt;\n     &lt;/param&gt;\n&lt;/provider&gt;\n&lt;!--\n  END Knox HaProvider for Hadoop services\n  --&gt;\n\n\n            &lt;/gateway&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;NAMENODE&lt;/role&gt;\n                &lt;url&gt;hdfs://{{namenode_host}}:{{namenode_rpc_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;JOBTRACKER&lt;/role&gt;\n                &lt;url&gt;rpc://{{rm_host}}:{{jt_rpc_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHDFS&lt;/role&gt;\n                &lt;url&gt;http://{{namenode_host}}:{{namenode_http_port}}/webhdfs&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHCAT&lt;/role&gt;\n                &lt;url&gt;http://{{webhcat_server_host}}:{{templeton_port}}/templeton&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;OOZIE&lt;/role&gt;\n                &lt;url&gt;http://{{oozie_server_host}}:{{oozie_server_port}}/oozie&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;WEBHBASE&lt;/role&gt;\n                &lt;url&gt;http://{{hbase_master_host}}:{{hbase_master_port}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;HIVE&lt;/role&gt;\n                &lt;url&gt;http://{{hive_server_host}}:{{hive_http_port}}/{{hive_http_path}}&lt;/url&gt;\n            &lt;/service&gt;\n\n            &lt;service&gt;\n                &lt;role&gt;RESOURCEMANAGER&lt;/role&gt;\n                &lt;url&gt;http://{{rm_host}}:{{rm_port}}/ws&lt;/url&gt;\n            &lt;/service&gt;\n        &lt;/topology&gt;\n</code></pre></li> </ul> </li> <li> <p>Then restart Knox via Ambari</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#hdfs-configuration-for-knox","title":"HDFS Configuration for Knox","text":"<ul> <li>Tell Hadoop to allow our users to access Knox from any node of the cluster. Modify the below properties under Ambari &gt; HDFS &gt; Config &gt; Custom core-site  ('users' group should already part of the groups so just add the rest)</li> <li>hadoop.proxyuser.knox.groups=users,hadoop-admins,sales,hr,legal</li> <li>hadoop.proxyuser.knox.hosts=*<ul> <li>(better would be to put a comma separated list of the FQDNs of the hosts)</li> </ul> </li> <li>Now restart HDFS</li> <li>Without this step you will see an error like below when you run the WebHDFS request later on:   <pre><code> org.apache.hadoop.security.authorize.AuthorizationException: User: knox is not allowed to impersonate sales1\"\n</code></pre></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-configuration-for-webhdfs-over-knox","title":"Ranger Configuration for WebHDFS over Knox","text":"<ul> <li>Setup a Knox policy for sales group for WEBHDFS by:</li> <li>Login to Ranger &gt; Access Manager &gt; KNOX &gt; click the cluster name link &gt; Add new policy</li> <li>Policy name: webhdfs</li> <li>Topology name: default</li> <li>Service name: WEBHDFS</li> <li>Group permissions: sales </li> <li>Permission: check Allow</li> <li>Add</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#webhdfs-over-knox-exercises","title":"WebHDFS over Knox exercises","text":"<ul> <li>Now we can post some requests to WebHDFS over Knox to check its working. We will use curl with following arguments:</li> <li>-i (aka \u2013include): used to output HTTP response header information. This will be important when the content of the HTTP Location header is required for subsequent requests.</li> <li>-k (aka \u2013insecure) is used to avoid any issues resulting from the use of demonstration SSL certificates.</li> <li>-u (aka \u2013user) is used to provide the credentials to be used when the client is challenged by the gateway.</li> <li> <p>Note that most of the samples do not use the cookie features of cURL for the sake of simplicity. Therefore we will pass in user credentials with each curl request to authenticate.</p> </li> <li> <p>From the host where Knox is running, send the below curl request to 8443 port where Knox is running to run <code>ls</code> command on <code>/</code> dir in HDFS: <pre><code>curl -ik -u sales1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></p> </li> <li> <p>This should return json object containing list of dirs/files located in root dir and their attributes</p> </li> <li> <p>To avoid passing password on command prompt you can pass in just the username (to avoid having the password captured in the shell history). In this case, you will be prompted for the password <pre><code>curl -ik -u sales1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n\n## enter BadPass#1\n</code></pre></p> </li> <li> <p>For the remaining examples below, for simplicity, we are passing in the password on the command line, but feel free to remove the password and enter it in manually when prompted</p> </li> <li> <p>Try the same request as hr1 and notice it fails with <code>Error 403 Forbidden</code> :</p> </li> <li> <p>This is expected since in the policy above, we only allowed sales group to access WebHDFS over Knox <pre><code>curl -ik -u hr1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></p> </li> <li> <p>Notice that to make the requests over Knox, a kerberos ticket is not needed - the user authenticates by passing in AD/LDAP credentials</p> </li> <li> <p>Check in Ranger Audits to confirm the requests were audited:</p> </li> <li>Ranger &gt; Audit &gt; Service type: KNOX</li> </ul> <p></p> <ul> <li> <p>Other things to access WebHDFS with Knox</p> </li> <li> <p>A. Use cookie to make request without passing in credentials</p> <ul> <li>When you ran the previous curl request it would have listed HTTP headers as part of output. One of the headers will be 'Set Cookie'</li> <li>e.g. <code>Set-Cookie: JSESSIONID=xxxxxxxxxxxxxxx;Path=/gateway/default;Secure;HttpOnly</code></li> <li>You can pass in the value from your setup and make the request without passing in credentials:</li> <li>Make sure you copy the JSESSIONID from a request that worked (i.e the one from sales1 not hr1)   <pre><code>curl -ik --cookie \"JSESSIONID=xxxxxxxxxxxxxxx;Path=/gateway/default;Secure;HttpOnly\" -X GET https://localhost:8443/gateway/default/webhdfs/v1/?op=LISTSTATUS\n</code></pre></li> </ul> </li> <li> <p>B. Open file via WebHDFS</p> <ul> <li>Sample command to list files under /tmp: <pre><code>curl -ik -u sales1:BadPass#1 https://localhost:8443/gateway/default/webhdfs/v1/tmp?op=LISTSTATUS\n</code></pre></li> <li>You can run below command to create a test file into /tmp</li> </ul> <pre><code>echo \"Test file\" &gt; /tmp/testfile.txt\nsudo -u sales1 kinit\n## enter BadPass#1\nsudo -u sales1 hdfs dfs -put /tmp/testfile.txt /tmp\nsudo -u sales1 kdestroy\n</code></pre> <ul> <li>Open this file via WebHDFS  <pre><code>curl -ik -u sales1:BadPass#1 -X GET https://localhost:8443/gateway/default/webhdfs/v1/tmp/testfile.txt?op=OPEN\n</code></pre></li> <li> <p>Look at value of Location header. This will contain a long url    </p> </li> <li> <p>Access contents of file /tmp/testfile.txt by passing the value from the above Location header <pre><code>curl -ik -u sales1:BadPass#1 -X GET '{https://localhost:8443/gateway/default/webhdfs/data/v1/webhdfs/v1/tmp/testfile.txt?_=AAAACAAAABAAAAEwvyZNDLGGNwahMYZKvaHHaxymBy1YEoe4UCQOqLC7o8fg0z6845kTvMQN_uULGUYGoINYhH5qafY_HjozUseNfkxyrEo313-Fwq8ISt6MKEvLqas1VEwC07-ihmK65Uac8wT-Cmj2BDab5b7EZx9QXv29BONUuzStCGzBYCqD_OIgesHLkhAM6VNOlkgpumr6EBTuTnPTt2mYN6YqBSTX6cc6OhX73WWE6atHy-lv7aSCJ2I98z2btp8XLWWHQDmwKWSmEvtQW6Aj-JGInJQzoDAMnU2eNosdcXaiYH856zC16IfEucdb7SA_mqAymZuhm8lUCvL25hd-bd8p6mn1AZlOn92VySGp2TaaVYGwX-6L9by73bC6sIdi9iKPl3Iv13GEQZEKsTm1a96Bh6ilScmrctk3zmY4vBYp2SjHG9JRJvQgr2XzgA}'\n</code></pre></p> </li> </ul> </li> <li> <p>C. Use groovy scripts to access WebHDFS</p> <ul> <li>Edit the groovy script to set:</li> <li>gateway = \"https://localhost:8443/gateway/default\" <pre><code>sudo vi /usr/hdp/current/knox-server/samples/ExampleWebHdfsLs.groovy\n</code></pre></li> <li>Run the script and enter credentials when prompted username: sales1 and password: BadPass#1 <pre><code>sudo java -jar /usr/hdp/current/knox-server/bin/shell.jar /usr/hdp/current/knox-server/samples/ExampleWebHdfsLs.groovy\n</code></pre></li> <li>Notice output show list of dirs in HDFS <pre><code>[app-logs, apps, ats, hdp, mapred, mr-history, ranger, tmp, user, zone_encr]\n</code></pre></li> </ul> </li> <li> <p>D. Access via browser </p> <ul> <li>Take the same url we have been hitting via curl and replace localhost with public IP of Knox node (remember to use https!) e.g. https://PUBLIC_IP_OF_KNOX_HOST:8443/gateway/default/webhdfs/v1?op=LISTSTATUS</li> <li>Open the URL via browser</li> <li>Login as sales1/BadPass#1</li> </ul> <p> </p> </li> <li> <p>We have shown how you can use Knox to avoid the end user from having to know about internal details of cluster</p> </li> <li>whether its kerberized or not</li> <li>what the cluster topology is (e.g. what node WebHDFS was running)</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#hive-over-knox","title":"Hive over Knox","text":"","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#configure-hive-for-knox","title":"Configure Hive for Knox","text":"<ul> <li>In Ambari, under Hive &gt; Configs &gt; set the below and restart Hive component.</li> <li>hive.server2.transport.mode = http</li> <li>Give users access to jks file.</li> <li>This is only for testing since we are using a self-signed cert.</li> <li>This only exposes the truststore, not the keys. <pre><code>sudo chmod o+x /usr/hdp/current/knox-server /usr/hdp/current/knox-server/data /usr/hdp/current/knox-server/data/security /usr/hdp/current/knox-server/data/security/keystores\nsudo chmod o+r /usr/hdp/current/knox-server/data/security/keystores/gateway.jks\n</code></pre></li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#ranger-configuration-for-hive-over-knox","title":"Ranger Configuration for Hive over Knox","text":"<ul> <li>Setup a Knox policy for sales group for HIVE by:</li> <li>Login to Ranger &gt; Access Manager &gt; KNOX &gt; click the cluster name link &gt; Add new policy</li> <li>Policy name: hive</li> <li>Topology name: default</li> <li>Service name: HIVE</li> <li>Group permissions: sales </li> <li>Permission: check Allow</li> <li>Add</li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/ipa-setup/#use-hive-for-knox","title":"Use Hive for Knox","text":"<ul> <li> <p>By default Knox will use a self-signed (untrusted) certificate. To trust the certificate:</p> <ul> <li>First on Knox node, create the /tmp/knox.crt certificate</li> </ul> </li> </ul> <p><pre><code>knoxserver=$(hostname -f)\nopenssl s_client -connect ${knoxserver}:8443 &lt;&lt;&lt;'' | openssl x509 -out /tmp/knox.crt\n</code></pre>   - On node where beeline will be run from (e.g. Hive node):       - copy over the /tmp/knox.crt         - easiest option is to just open it in <code>vi</code> and copy/paste the contents over:         <code>vi /tmp/knox.crt</code>       - trust the certificate by running the command below      </p> <pre><code>sudo keytool -import -trustcacerts -keystore /etc/pki/java/cacerts -storepass changeit -noprompt -alias knox -file /tmp/knox.crt\n</code></pre> <ul> <li>Now connect via beeline, making sure to replace KnoxserverInternalHostName first below:</li> </ul> <pre><code>beeline -u \"jdbc:hive2://&lt;KnoxserverInternalHostName&gt;:8443/;ssl=true;transportMode=http;httpPath=gateway/default/hive\" -n sales1 -p BadPass#1\n</code></pre> <ul> <li>Notice that in the JDBC connect string for connecting to an secured Hive running in http transport mode:</li> <li>port changes to Knox's port 8443</li> <li>traffic between client and Knox is over HTTPS</li> <li> <p>a kerberos principal not longer needs to be passed in</p> </li> <li> <p>Test these users:</p> </li> <li>sales1/BadPass#1 should work</li> <li> <p>hr1/BadPass#1 should not work</p> <ul> <li>Will fail with: <pre><code>Could not create http connection to jdbc:hive2://&lt;hostname&gt;:8443/;ssl=true;transportMode=http;httpPath=gateway/default/hive. HTTP Response code: 403 (state=08S01,code=0)\n</code></pre></li> </ul> </li> <li> <p>Check in Ranger Audits to confirm the requests were audited:</p> </li> <li> <p>Ranger &gt; Audit &gt; Service type: KNOX   </p> </li> <li> <p>This shows how Knox helps end users access Hive securely over HTTPS using Ranger to set authorization policies and for audits</p> </li> </ul>","tags":["ipa","kerberos","hdp","hadoop"]},{"location":"bigdata/kerberos-setup/","title":"MIT Kerberos  \u5b89\u88c5\u53ca\u7ef4\u62a4\u624b\u518c","text":"","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_1","title":"\u6982\u8ff0","text":"<p>\u7ef4\u62a4 Kerberos \u9700\u8981\u5bf9 Kerberos \u7684\u57fa\u672c\u6982\u5ff5\u548c\u5e38\u89c1\u7684\u51e0\u4e2a\u672f\u8bed\u6709\u6240\u4e86\u89e3\uff0c\u4ee5\u4e0b\u662f\u51e0\u4e2a\u91cd\u8981\u7684\u6982\u5ff5</p> <ul> <li>Principal\uff08\u5b89\u5168\u4e2a\u4f53\uff0c\u4e3b\u4f53\uff09\uff1a\u88ab\u8ba4\u8bc1\u7684\u4e2a\u4f53\uff0c\u6709\u4e00\u4e2a\u540d\u5b57(name)\u548c\u53e3\u4ee4(password)</li> <li>KDC(Key Distribution Center)\uff1a \u4e00\u4e2a\u7f51\u7edc\u670d\u52a1\uff0c\u63d0\u4f9b\u7968\u636e(ticket)\u548c\u4e34\u65f6\u4f1a\u8bdd\u5bc6\u94a5</li> <li>Ticket\uff08\u7968\u636e\uff09\uff1a\u4e00\u4e2a\u8bb0\u5f55\uff0c\u5ba2\u6237\u53ef\u4ee5\u7528\u5b83\u6765\u5411\u670d\u52a1\u5668\u8bc1\u660e\u81ea\u5df1\u7684\u8eab\u4efd\uff0c\u5305\u62ec\u5ba2\u6237\u6807\u8bc6\u3001\u4f1a\u8bdd\u5bc6\u94a5\u3001\u65f6\u95f4\u6233\u7b49</li> <li>Credentials\uff08\u51ed\u8bc1\uff09\uff1a \u4e00\u4e2a Ticket \u52a0\u4e0a\u4e00\u4e2a\u79d8\u5bc6\u7684\u4f1a\u8bdd\u5bc6\u94a5</li> </ul> <p>\u8ba4\u8bc1\u539f\u7406\u5982\u4e0b\uff1a</p> <p></p>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#kdc-server","title":"\u90e8\u7f72 KDC Server","text":"","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_2","title":"\u5b89\u88c5\u8f6f\u4ef6\u5305","text":"<p>\u7528 root \u8d26\u53f7\u767b\u9646\u670d\u52a1\uff0c\u7136\u540e\u5b89\u88c5\u9700\u8981\u7684\u8f6f\u4ef6\u5305</p> <p><code>yum install krb5-server krb5-libs krb5-workstation</code></p> <p>\u7f16\u8f91 <code>/etc/krb5.conf</code> ,\u4fee\u6539 <code>[realms]</code> \u90e8\u5206\uff0c\u6539\u6210\u7b26\u5408\u81ea\u5df1\u73af\u5883\u7684\u914d\u7f6e\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>includedir /etc/krb5.conf.d/\n\n[libdefaults]\n  renew_lifetime = 7d\n  forwardable = true\n  default_realm = WGZHAO.COM\n  ticket_lifetime = 24h\n  dns_lookup_realm = false\n  dns_lookup_kdc = false\n  default_ccache_name = /tmp/krb5cc_%{uid}\n  #default_tgs_enctypes = aes des3-cbc-sha1 rc4 des-cbc-md5\n  #default_tkt_enctypes = aes des3-cbc-sha1 rc4 des-cbc-md5\n\n[domain_realm]\n  WGZHAO.com = WGZHAO.COM\n\n[logging]\n  default = FILE:/var/log/krb5kdc.log\n  admin_server = FILE:/var/log/kadmind.log\n  kdc = FILE:/var/log/krb5kdc.log\n\n[realms]\n  WGZHAO.COM = {\n    admin_server = hadoop2.WGZHAO.com\n    kdc = hadoop2.WGZHAO.com\n  }\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_3","title":"\u521b\u5efa\u6570\u636e\u5e93","text":"<p>\u5728\u670d\u52a1\u7aef\u670d\u52a1\u5668\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <p><code>kdb5_util create -s</code></p> <p>\u63d0\u793a\u8f93\u5165\u5bc6\u7801\u65f6\uff0c\u8f93\u5165\u5bc6\u7801\uff0c\u4e00\u5b9a\u8981\u7262\u7262\u8bb0\u4f4f\u8be5\u5bc6\u7801</p>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#kdc","title":"\u542f\u52a8 KDC","text":"<pre><code>systemctl start krb5kdc\nsystemctl start kadmin\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#kerberos-admin","title":"\u914d\u7f6e Kerberos Admin \u8d26\u53f7","text":"<ol> <li>\u521b\u5efa KDC admin\u8d26\u53f7 <code>kadmin.local -q \"addprinc admin/admin\"</code></li> <li>\u7f16\u8f91 <code>/var/kerberos/krb5kdc/kadm5.acl</code> \u6587\u4ef6\uff0c\u589e\u52a0\u914d\u7f6e\u7684realms\u7684\u8ba4\u8bc1\uff0c\u7c7b\u4f3c\u5982\u4e0b <code>*/admin@WGZHAO.COM    *</code></li> <li>\u91cd\u542f kadmin <code>systemctl start kadmin</code></li> </ol>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#kadmin","title":"kadmin","text":"<p>kadmin\u662f KDC\u7684\u7ba1\u7406\u547d\u4ee4\uff0c\u7528\u6765\u7ba1\u7406 Kerberos \u6570\u636e\u5e93\uff0c\u5177\u6709\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li>\u663e\u793a Principal \u7684\u5c5e\u6027</li> <li>\u83b7\u5f97 Principal \u5217\u8868</li> <li>\u589e\u52a0\u3001\u5220\u9664\u6216\u8005\u4fee\u6539 principal</li> <li>\u4fee\u6539\u53e3\u4ee4</li> <li>\u7b56\u7565\u7ba1\u7406</li> </ul> <p>\u4ee5\u4e0b\u662f kadmin \u7684\u4e00\u4e2a\u57fa\u672c\u8f93\u51fa</p> <pre><code>% kadmin\nkadmin: getprinc hive/hadoop1.WGZHAO.com\nPrincipal: hive/hadoop1.WGZHAO.com@WGZHAO.COM\nKey version: 3\nMaximum life: 1 day 00:00:00\nMaximum renewable life: 7 days 00:00:00\nMaster key version: 1\nExpires: Mon Jan 18 22:14:07 EDT 2038\nPassword expires: Mon Sep 19 14:40:00 EDT 1996\nPassword last changed: Mon Jan 31 02:06:40 EDT 1996\nLast modified: by joeadmin/admin@ATHENA.MIT.EDU\n    on Wed Jul 13 18:27:08 EDT 1996\nAttributes: DISALLOW_FORWARDABLE, DISALLOW_PROXIABLE,REQUIRES_HW_AUTH\nSalt type: DEFAULT\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_4","title":"\u65e5\u5e38\u7ef4\u62a4","text":"","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_5","title":"\u5217\u51fa\u51ed\u8bc1","text":"<p>klist \u547d\u4ee4\u53ef\u4ee5\u5217\u51fa\u4e00\u4e2a\u51ed\u8bc1\u7684\u65e5\u5e38\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p> <pre><code> klist  -kt /etc/security/keytabs/hive.service.keytab \nKeytab name: FILE:/etc/security/keytabs/hive.service.keytab\nKVNO Timestamp           Principal\n---- ------------------- ------------------------------------------------------\n   1 08/04/2017 09:12:48 hive/hadoop5.wgzhao.com@WGZHAO.COM\n   1 08/04/2017 09:12:48 hive/hadoop5.wgzhao.com@WGZHAO.COM\n   1 08/04/2017 09:12:48 hive/hadoop5.wgzhao.com@WGZHAO.COM\n   1 08/04/2017 09:12:48 hive/hadoop5.wgzhao.com@WGZHAO.COM\n   1 08/04/2017 09:12:48 hive/hadoop5.wgzhao.com@WGZHAO.COM\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_6","title":"\u83b7\u5f97\u51ed\u636e","text":"<p>\u83b7\u5f97\u51ed\u636e\u53ef\u4ee5\u901a\u8fc7\u8d26\u53f7\u5bc6\u7801\u65b9\u5f0f\u5411\u670d\u52a1\u5668\u83b7\u53d6\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u51ed\u8bc1\u6587\u4ef6\u83b7\u53d6\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff1a</p> <pre><code># klist\nklist: Credentials cache file '/tmp/krb5cc_0' not found\n# kinit  -kt /etc/security/keytabs/hive.service.keytab hive/hadoop5.wgzhao.com@WGZHAO.COM\n# klist\nTicket cache: FILE:/tmp/krb5cc_0\nDefault principal: hive/hadoop5.wgzhao.com@WGZHAO.COM\n\nValid starting       Expires              Service principal\n12/20/2018 14:32:17  12/21/2018 14:32:17  krbtgt/WGZHAO.COM@WGZHAO.COM\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_7","title":"\u521b\u5efa\u51ed\u8bc1","text":"<p>\u521b\u5efa\u51ed\u8bc1\u9700\u8981\u7528 root \u8d26\u53f7\u767b\u9646\u5230 KDC \u670d\u52a1\u5668\uff0c\u7136\u540e\u4f7f\u7528kadmin.local\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff0c\u8be5\u547d\u4ee4\u53ef\u4ee5\u4ea4\u4e92\u5f0f\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u6279\u5904\u7406\u65b9\u5f0f\uff0c\u8fd9\u91cc\u7ed9\u51fa\u6279\u5904\u7406\u7684\u65b9\u5f0f\u3002 \u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u51ed\u8bc1</p> <pre><code>kadmin.local -q \"addprinc -randkey gphdfs/bjzxsdw3@WGZHAO.COM\"\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u9700\u8981\u5bfc\u51fa\u51ed\u8bc1\u6587\u4ef6\u5e76\u62f7\u8d1d\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u5bfc\u51fa\uff1a</p> <p><code>kadmin.local -q \"xst -k gphdfs.service.keytab  gphdfs/bjzxsdw3@WGZHAO.COM\"</code></p>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#_8","title":"\u4fee\u6539\u51ed\u8bc1","text":"<p>\u4fee\u6539\u51ed\u8bc1\u9700\u8981\u7528 root \u8d26\u53f7\u767b\u9646\u5230 KDC \u670d\u52a1\u5668\uff0c\u7136\u540e\u4f7f\u7528 <code>kadmin.local</code> \u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff0c\u8be5\u547d\u4ee4\u53ef\u4ee5\u4ea4\u4e92\u5f0f\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u6279\u5904\u7406\u65b9\u5f0f\uff0c\u8fd9\u91cc\u7ed9\u51fa\u6279\u5904\u7406\u7684\u65b9\u5f0f</p> <pre><code>kadmin.local -q \"modprinc -maxlife 7days -maxrenewlife 7days +allow_renewable infa/bjzx-etl-infa1@WGZHAO.COM\"\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/kerberos-setup/#kdc_1","title":"\u589e\u52a0 KDC \u670d\u52a1\u5e76\u53d1","text":"<p>\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\uff0c\u9ed8\u8ba4\u7684 KDC \u914d\u7f6e\u4f1a\u5bfc\u81f4\u8bf7\u6c42\u6ca1\u6709\u54cd\u5e94\uff0c\u4f1a\u51fa\u73b0\u8be1\u5f02\u7684 \"UnKnown Hostname\" \u5f02\u5e38\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u589e\u52a0 KDC \u7684\u670d\u52a1\u8fdb\u7a0b\u3002</p> <p>\u7528 root \u8d26\u53f7\u767b\u9646 KDC \u670d\u52a1\u5668\uff0c\u7f16\u8f91 /etc/sysconfig/krb5kdc \u6587\u4ef6\uff0c\u4fee\u6539 <code>KRB5KDC_ARGS</code> \u9009\u9879\uff0c\u589e\u52a0<code>-w 32</code>\u53c2\u6570\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <p><code>KRB5KDC_ARGS=-w 32</code></p> <p>\u7136\u540e\u91cd\u542f\u670d\u52a1</p> <pre><code>systemctl restart kadmin\nsystemctl restart krb5kdc\n</code></pre>","tags":["kerberos","security"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/","title":"\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u8bbe\u8ba1\u4e0e\u5b9e\u8df5","text":"<p>Source</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part1","title":"Part.1 \u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u4e0e\u6570\u636e\u4e2d\u53f0","text":"<p>\u6700\u8fd1\u51e0\u5e74\uff0c\u6570\u636e\u4e2d\u53f0\u6982\u5ff5\u7684\u70ed\u5ea6\u4e00\u76f4\u4e0d\u51cf\u30022018 \u5e74\u8d77\uff0c\u9a6c\u8702\u7a9d\u4e5f\u5f00\u59cb\u4e86\u81ea\u5df1\u7684\u6570\u636e\u4e2d\u53f0\u63a2\u7d22\u4e4b\u8def\u3002</p> <p>\u6570\u636e\u4e2d\u53f0\u5230\u5e95\u662f\u4ec0\u4e48\uff1f\u8981\u4e0d\u8981\u5efa\uff1f\u548c\u6570\u636e\u4ed3\u5e93\u6709\u4ec0\u4e48\u672c\u8d28\u7684\u533a\u522b\uff1f\u76f8\u4fe1\u5f88\u591a\u4f01\u4e1a\u90fd\u5728\u5173\u6ce8\u8fd9\u4e9b\u95ee\u9898\u3002</p> <p>\u6211\u8ba4\u4e3a\u6570\u636e\u4e2d\u53f0\u7684\u6982\u5ff5\u975e\u5e38\u63a5\u8fd1\u4f20\u7edf\u6570\u636e\u4ed3\u5e93+\u5927\u6570\u636e\u5e73\u53f0\u7684\u7ed3\u5408\u4f53\u3002\u5b83\u662f\u5728\u4f01\u4e1a\u7684\u6570\u636e\u5efa\u8bbe\u7ecf\u5386\u4e86\u6570\u636e\u4e2d\u5fc3\u3001\u6570\u636e\u4ed3\u5e93\u7b49\u79ef\u7d2f\u4e4b\u540e\uff0c\u501f\u52a9\u5e73\u53f0\u5316\u7684\u601d\u8def\uff0c\u5c06\u6570\u636e\u66f4\u597d\u5730\u8fdb\u884c\u6574\u5408\u4e0e\u7edf\u4e00\uff0c\u4ee5\u7ec4\u4ef6\u5316\u7684\u65b9\u5f0f\u5b9e\u73b0\u7075\u6d3b\u7684\u6570\u636e\u52a0\u5de5\u4e0e\u5e94\u7528\uff0c\u4ee5\u66f4\u6e05\u6670\u7684\u6570\u636e\u804c\u80fd\u7ec4\u7ec7\u5e94\u5bf9\u4e1a\u52a1\u7684\u5feb\u901f\u53d8\u5316\uff0c\u4ee5\u670d\u52a1\u7684\u65b9\u5f0f\u66f4\u597d\u5730\u91ca\u653e\u6570\u636e\u4ef7\u503c\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p> <p>\u6240\u4ee5\uff0c\u6570\u636e\u4e2d\u53f0\u66f4\u591a\u7684\u662f\u4f53\u73b0\u4e00\u79cd\u7ba1\u7406\u601d\u8def\u548c\u67b6\u6784\u7ec4\u7ec7\u4e0a\u7684\u53d8\u9769\u3002\u5728\u8fd9\u6837\u7684\u601d\u60f3\u4e0b\uff0c\u6211\u4eec\u7ed3\u5408\u81ea\u8eab\u4e1a\u52a1\u7279\u70b9\u5efa\u8bbe\u4e86\u9a6c\u8702\u7a9d\u7684\u6570\u636e\u4e2d\u53f0\uff0c\u6838\u5fc3\u67b6\u6784\u5982\u4e0b\uff1a</p> <p></p> <p>\u5728\u4e2d\u53f0\u5efa\u8bbe\u4e4b\u524d\uff0c\u9a6c\u8702\u7a9d\u5df2\u7ecf\u5efa\u7acb\u4e86\u81ea\u5df1\u7684\u5927\u6570\u636e\u5e73\u53f0\uff0c\u5e76\u79ef\u7d2f\u4e86\u4e00\u4e9b\u901a\u7528\u3001\u7ec4\u4ef6\u5316\u7684\u5de5\u5177\uff0c\u8fd9\u4e9b\u53ef\u4ee5\u652f\u6491\u6570\u636e\u4e2d\u53f0\u7684\u5feb\u901f\u642d\u5efa\u3002\u4f5c\u4e3a\u4e2d\u53f0\u7684\u53e6\u4e00\u5927\u6838\u5fc3\u90e8\u5206\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u4e3b\u8981\u627f\u62c5\u6570\u636e\u7edf\u4e00\u5316\u5efa\u8bbe\u7684\u5de5\u4f5c\uff0c\u5305\u62ec\u7edf\u4e00\u6570\u636e\u6a21\u578b\uff0c\u7edf\u4e00\u6307\u6807\u4f53\u7cfb\u7b49\u3002\u4e0b\u9762\u4ecb\u7ecd\u9a6c\u8702\u7a9d\u5728\u6570\u636e\u4ed3\u5e93\u5efa\u8bbe\u65b9\u9762\u7684\u5177\u4f53\u5b9e\u8df5\u3002</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part2","title":"Part.2 \u6570\u636e\u4ed3\u5e93\u6838\u5fc3\u67b6\u6784","text":"<p>\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u9075\u5faa\u6807\u51c6\u7684\u4e09\u5c42\u67b6\u6784\uff0c\u5bf9\u6570\u636e\u5206\u5c42\u7684\u5b9a\u4f4d\u4e3b\u8981\u91c7\u53d6\u7ef4\u5ea6\u6a21\u578b\u8bbe\u8ba1\uff0c\u4e0d\u4f1a\u5bf9\u6570\u636e\u8fdb\u884c\u62bd\u8c61\u6253\u6563\u5904\u7406\uff0c\u66f4\u591a\u6ce8\u91cd\u4e1a\u52a1\u8fc7\u7a0b\u6570\u636e\u6574\u5408\u3002\u73b0\u6709\u6570\u4ed3\u4e3b\u8981\u4ee5\u79bb\u7ebf\u4e3a\u4e3b\uff0c\u6574\u4f53\u67b6\u6784\u5982\u4e0b\uff1a</p> <p></p> <p>\u5982\u56fe\u6240\u793a\uff0c\u5171\u5206\u4e3a 3 \u5c42\uff1a\u4e1a\u52a1\u6570\u636e\u5c42\u3001\u516c\u5171\u6570\u636e\u5c42\u4e0e\u5e94\u7528\u6570\u636e\u5c42\uff0c\u6bcf\u5c42\u5b9a\u4f4d\u3001\u76ee\u6807\u4ee5\u53ca\u5efa\u8bbe\u539f\u5219\u5404\u4e0d\u76f8\u540c\u3002</p> <p>\uff081\uff09\u4e1a****\u52a1\u6570\u636e\u5c42\uff1a\u5305\u542b STG\uff08\u6570\u636e\u7f13\u51b2\u5c42\uff09\u4e0e ODS\uff08\u64cd\u4f5c\u6570\u636e\u5c42\uff09\u4e24\u5c42\uff0c\u8fd9\u4e24\u5c42\u6570\u636e\u7ed3\u6784\u4e0e\u4e1a\u52a1\u6570\u636e\u51e0\u4e4e\u4e00\u81f4\u3002</p> <ul> <li>STG\uff1a\u4e5f\u53eb\u6570\u636e\u51c6\u5907\u533a\uff0c\u5b9a\u4f4d\u662f\u7f13\u5b58\u6765\u81ea DB \u62bd\u53d6\u3001\u6d88\u606f\u3001\u65e5\u5fd7\u89e3\u6790\u843d\u5730\u7684\u4e34\u65f6\u6570\u636e\uff0c\u7ed3\u6784\u4e0e\u4e1a\u52a1\u7cfb\u7edf\u4fdd\u6301\u4e00\u81f4\uff1b\u8d1f\u8d23\u5bf9\u5783\u573e\u6570\u636e\u3001\u4e0d\u89c4\u8303\u6570\u636e\u8fdb\u884c\u6e05\u6d17\u8f6c\u6362\uff1b\u8be5\u5c42\u53ea\u4e3a ODS \u5c42\u670d\u52a1\uff1b</li> <li>ODS\uff1a\u64cd\u4f5c\u6570\u636e\u5c42\u5b9a\u4f4d\u4e8e\u4e1a\u52a1\u660e\u7ec6\u6570\u636e\u4fdd\u7559\u533a\uff0c\u8d1f\u8d23\u4fdd\u7559\u6570\u636e\u63a5\u5165\u65f6\u70b9\u540e\u5386\u53f2\u53d8\u66f4\u6570\u636e\uff0c\u6570\u636e\u539f\u5219\u4e0a\u5168\u91cf\u4fdd\u7559\u3002\u6a21\u578b\u8bbe\u8ba1\u4f9d\u636e\u4e1a\u52a1\u8868\u6570\u636e\u53d8\u66f4\u7279\u6027\u91c7\u53d6\u62c9\u94fe\u3001\u6d41\u6c34\u8868\u4e24\u79cd\u5f62\u5f0f\u3002</li> </ul> <p>\uff082\uff09\u516c\u5171\u6570\u636e\u5c42\uff1a\u7ec6\u5206\u4e3a DWD\uff08\u660e\u7ec6\u6570\u636e\u5c42\uff09\u3001DWS\uff08\u6c47\u603b\u6570\u636e\u5c42\uff09\u3001DIM\uff08\u516c\u5171\u7ef4\u5ea6\u5c42\uff09 \u4e09\u5c42\uff0c\u4e3b\u8981\u7528\u4e8e\u52a0\u5de5\u5b58\u653e\u6574\u5408\u540e\u7684\u660e\u7ec6\u4e1a\u52a1\u8fc7\u7a0b\u6570\u636e\uff0c\u4ee5\u53ca\u7ecf\u8fc7\u8f7b\u5ea6\u6216\u91cd\u5ea6\u6c47\u603b\u7c92\u5ea6\u516c\u5171\u7ef4\u5ea6\u6307\u6807\u6570\u636e\u3002\u516c\u5171\u6570\u636e\u5c42\u4f5c\u4e3a\u4ed3\u5e93\u6838\u5fc3\u5c42\uff0c\u5b9a\u4f4d\u4e8e\u4e1a\u52a1\u89c6\u89d2\uff0c\u63d0\u70bc\u51fa\u5bf9\u6570\u636e\u4ed3\u5e93\u5177\u6709\u5171\u6027\u7684\u6570\u636e\u8bbf\u95ee\u3001\u7edf\u8ba1\u9700\u6c42\uff0c\u4ece\u800c\u6784\u5efa\u9762\u5411\u652f\u6301\u5e94\u7528\u3001\u63d0\u4f9b\u5171\u4eab\u6570\u636e\u8bbf\u95ee\u670d\u52a1\u7684\u516c\u5171\u6570\u636e\u3002</p> <ul> <li>DWD\uff1a\u8fd9\u4e00\u5c42\u662f\u6574\u5408\u540e\u7684\u4e1a\u52a1\u8fc7\u7a0b\u660e\u7ec6\u6570\u636e\uff0c\u8d1f\u8d23\u5404\u4e1a\u52a1\u573a\u666f\u5782\u76f4\u4e0e\u6c34\u5e73\u6570\u636e\u6574\u5408\u3001\u5e38\u7528\u516c\u5171\u7ef4\u5ea6\u5197\u4f59\u52a0\u5de5\uff0c\u4ee5\u53ca\u660e\u7ec6\u4e1a\u52a1\u6807\u7b7e\u4fe1\u606f\u52a0\u5de5\uff1b</li> <li>DWS\uff1a\u6c47\u603b\u6570\u636e\u5c42\u6309\u7167\u4e3b\u9898\u5bf9\u5171\u6027\u7ef4\u5ea6\u6307\u6807\u6570\u636e\u8fdb\u884c\u8f7b\u5ea6\u3001\u9ad8\u5ea6\u805a\u5408\uff1b</li> <li>DIM\uff1a\u5bf9\u7ef4\u5ea6\u8fdb\u884c\u7edf\u4e00\u6807\u51c6\u5316\u5b9a\u4e49\uff0c\u5b9e\u73b0\u7ef4\u5ea6\u4fe1\u606f\u5171\u4eab\u3002</li> </ul> <p>\uff083\uff09\u5e94\u7528\u6570\u636e\u5c42\uff1aDWA \u5c42\uff0c\u4e3b\u8981\u7528\u4e8e\u5404\u4ea7\u54c1\u6216\u5404\u4e1a\u52a1\u6761\u7ebf\u4e2a\u6027\u5316\u7684\u6570\u636e\u52a0\u5de5\uff0c\u4f8b\u5982\u5546\u4e1a\u5316\u4ea7\u54c1\u6570\u636e\u3001\u641c\u7d22\u63a8\u8350\uff0c\u98ce\u63a7\u7b49\u3002</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part3","title":"Part.3 \u6570\u636e\u6a21\u578b\u8bbe\u8ba1","text":"","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#31","title":"3.1 \u65b9\u6cd5\u9009\u62e9","text":"<p>\u6570\u636e\u6a21\u578b\u662f\u5bf9\u73b0\u5b9e\u4e16\u754c\u6570\u636e\u7279\u5f81\u7684\u62bd\u8c61\uff0c\u6570\u636e\u6a21\u578b\u7684\u8bbe\u8ba1\u65b9\u6cd5\u5c31\u662f\u5bf9\u6570\u636e\u8fdb\u884c\u5f52\u7eb3\u548c\u6982\u62ec\u7684\u65b9\u6cd5\u3002\u76ee\u524d\u4e1a\u754c\u4e3b\u8981\u7684\u6a21\u578b\u8bbe\u8ba1\u65b9\u6cd5\u8bba\u6709\u4e24\u79cd\uff0c\u4e00\u662f\u6570\u636e\u4ed3\u5e93\u4e4b\u7236 Bill Inmon \u63d0\u51fa\u7684**\u8303\u5f0f\u5efa\u6a21**\u65b9\u6cd5\uff0c\u53c8\u53eb ER \u5efa\u6a21\uff0c\u4e3b\u5f20\u7ad9\u5728\u4f01\u4e1a\u89d2\u5ea6\u81ea\u4e0a\u800c\u4e0b\u8fdb\u884c\u6570\u636e\u6a21\u578b\u6784\u5efa\uff1b\u4e8c\u662f Ralph Kimball \u5927\u5e08\u5021\u5bfc\u7684**\u7ef4\u5ea6\u5efa\u6a21**\u65b9\u6cd5\uff0c\u4e3b\u5f20\u4ece\u4e1a\u52a1\u9700\u6c42\u51fa\u53d1\u81ea\u4e0b\u800c\u4e0a\u6784\u5efa\u6570\u636e\u6a21\u578b\u3002</p> <p>\u5927\u6570\u636e\u73af\u5883\u4e0b\uff0c\u4e1a\u52a1\u7cfb\u7edf\u6570\u636e\u4f53\u7cfb\u5e9e\u6742\uff0c\u6570\u636e\u7ed3\u6784\u591a\u6837\u3001\u53d8\u66f4\u9891\u7e41\uff0c\u5e76\u4e14\u9700\u8981\u5feb\u901f\u54cd\u5e94\u5404\u79cd\u590d\u6742\u7684\u4e1a\u52a1\u9700\u6c42\uff0c\u4ee5\u4e0a\u4e24\u79cd\u4f20\u7edf\u7684\u7406\u8bba\u90fd\u5df2\u65e0\u6cd5\u6ee1\u8db3\u4e92\u8054\u7f51\u6570\u4ed3\u9700\u6c42\u3002\u5728\u6b64\u80cc\u666f\u4e0b\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u91c7\u53d6\u4e86\u300c\u4ee5\u9700\u6c42\u9a71\u52a8\u4e3a\u4e3b\u3001\u6570\u636e\u9a71\u52a8\u4e3a\u8f85\u300d\u7684\u6df7\u5408\u6a21\u578b\u8bbe\u8ba1\u65b9\u5f0f\uff0c\u6765\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u5c42\u6b21\u9009\u62e9\u6a21\u578b\u3002\u4e3b\u8981\u4ece\u4ee5\u4e0b\u56db\u4e2a\u65b9\u9762\u7efc\u5408\u8003\u8651\uff1a</p> <p>1. \u9762\u5411\u4e3b\u9898\uff1a\u91c7\u7528\u8303\u5f0f\u6a21\u578b\u7406\u8bba\u4e2d\u7684\u4e3b\u9898\u5212\u5206\u65b9\u6cd5\u5bf9\u4e1a\u52a1\u6570\u636e\u8fdb\u884c\u5206\u7c7b\u3002</p> <p>**2. \u4e00\u81f4\u6027\u4fdd\u8bc1\uff1a**\u91c7\u7528\u7ef4\u5ea6\u6a21\u578b\u7406\u8bba\u4e2d\u7684\u603b\u7ebf\u7ed3\u6784\u601d\u60f3\uff0c\u5efa\u7acb\u7edf\u4e00\u7684\u4e00\u81f4\u6027\u7ef4\u5ea6\u8868\u548c\u4e00\u81f4\u6027\u4e8b\u5b9e\u8868\u6765\u4fdd\u8bc1\u4e00\u81f4\u6027\u3002</p> <p>3. \u6570\u636e\u8d28\u91cf\u4fdd\u8bc1\uff1a\u65e0\u8bba\u8303\u5f0f\u5efa\u6a21\u8fd8\u662f\u7ef4\u5ea6\u5efa\u6a21\u90fd\u975e\u5e38\u91cd\u89c6\u6570\u636e\u8d28\u91cf\u95ee\u9898\uff0c\u7efc\u5408\u4f7f\u7528\u4e24\u4e2a\u7406\u8bba\u4e2d\u7684\u65b9\u6cd5\u4fdd\u8bc1\u6570\u636e\u8d28\u91cf\u3002</p> <p>4. \u6548\u7387\u4fdd\u8bc1\uff1a\u5408\u7406\u91c7\u53d6\u7ef4\u5ea6\u9000\u5316\u3001\u53d8\u5316\u7ef4\u3001\u589e\u52a0\u5197\u4f59\u7b49\u65b9\u6cd5\uff0c\u4fdd\u8bc1\u6570\u636e\u7684\u8ba1\u7b97\u548c\u67e5\u8be2\u6548\u7387\u3002</p> <p></p> <p>\u5176\u4e2d\uff0cODS \u9009\u62e9\u4fdd\u6301\u8d34\u6e90\u7684\u8303\u5f0f\u6a21\u578b\uff0c\u4e0d\u505a\u8fdb\u4e00\u6b65\u6a21\u578b\u62bd\u8c61\uff0c\u53ea\u662f\u4ece\u8282\u7701\u5b58\u50a8\u89d2\u5ea6\u8003\u8651\uff0c\u5bf9\u8be5\u5c42\u91c7\u53d6\u62c9\u94fe\u5904\u7406\u3002DWD \u4e0e DWS \u57fa\u4e8e\u5bf9\u6784\u5efa\u6210\u672c\u3001\u6027\u80fd\uff0c\u6613\u7528\u6027\u89d2\u5ea6\u7684\u8003\u8651\uff0c\u4e3b\u8981\u91c7\u53d6\u7ef4\u5ea6\u6a21\u578b\u548c\u4e00\u4e9b\u5bbd\u8868\u6a21\u578b\u3002\u5bbd\u8868\u6a21\u578b\u7684\u672c\u8d28\u662f\u57fa\u4e8e\u7ef4\u5ea6\u6a21\u578b\u7684\u6269\u5c55\uff0c\u5bf9\u6574\u4e2a\u4e1a\u52a1\u4ee5\u53ca\u5168\u8282\u70b9\u4fe1\u606f\u8fdb\u884c\u5782\u76f4\u4e0e\u6c34\u5e73\u65b9\u5f0f\u6574\u5408\uff1b\u540c\u65f6\u91c7\u7528\u9000\u5316\u7ef4\u5ea6\u7684\u65b9\u5f0f\uff0c\u5c06\u4e0d\u540c\u7ef4\u5ea6\u7684\u5ea6\u91cf\u653e\u5165\u6570\u636e\u8868\u7684\u4e0d\u540c\u5217\u4e2d\uff0c\u5b9e\u73b0\u4e1a\u52a1\u5168\u6d41\u7a0b\u89c6\u56fe\u7684\u6784\u5efa\uff0c\u6765\u63d0\u5347\u5bbd\u8868\u6a21\u578b\u7684\u6613\u7528\u6027\u3001\u67e5\u8be2\u6548\u7387\uff0c\u4e14\u6613\u4e8e\u6a21\u578b\u7684\u6269\u5c55\u3002</p> <ul> <li>\u6c34\u5e73\u6574\u5408\uff1a\u6c34\u5e73\u6574\u5408\u5c31\u662f\u5c06\u540c\u4e00\u4e1a\u52a1\u591a\u6570\u636e\u6e90\u7684\u6570\u636e\u6574\u5408\u5230\u4e00\u4e2a\u6a21\u578b\u4e2d\uff0c\u5982\u679c\u591a\u6570\u636e\u6e90\u4e1a\u52a1\u6570\u636e\u5b58\u5728\u4ea4\u96c6\uff0c\u5219\u9700\u8981\u6309\u7167\u9884\u8bbe\u7684\u4e1a\u52a1\u89c4\u5219\u9009\u53d6\u4e00\u4efd\u4fdd\u7559\uff0c\u907f\u514d\u6574\u5408\u540e\u7684\u4e1a\u52a1\u6570\u636e\u4ea4\u53c9\u3002\u4f8b\u5982\u5546\u54c1\u6570\u636e\u5982\u679c\u672a\u8fdb\u884c\u4e3b\u6570\u636e\u7ba1\u7406\uff0c\u4e0d\u540c\u4e1a\u52a1\u7ebf\u7684\u5546\u54c1\u4fe1\u606f\u5c31\u4f1a\u6563\u843d\u5728\u5404\u4e1a\u52a1\u7cfb\u7edf\u8868\u4e2d\uff0c\u65e0\u6cd5\u6ee1\u8db3\u4f01\u4e1a\u7ea7\u7684\u6570\u636e\u5206\u6790\u9700\u6c42\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5c06\u8fd9\u4e9b\u5546\u54c1\u6570\u636e\u6309\u7167\u4e1a\u52a1\u4e3b\u9898\u8fdb\u884c\u6c34\u5e73\u6574\u5408\u3002</li> <li>\u5782\u76f4\u6574\u5408\uff1a\u4e00\u6b21\u5b8c\u6574\u7684\u4e1a\u52a1\u6d41\u8f6c\u901a\u5e38\u8981\u7ecf\u5386\u591a\u4e2a\u73af\u8282\uff0c\u5404\u8282\u70b9\u4fe1\u606f\u4ea7\u751f\u7684\u65f6\u70b9\u4e0d\u540c\u3001\u50a8\u5b58\u7684\u6570\u636e\u8868\u4e0d\u540c\u3002\u5782\u76f4\u6574\u5408\u5c31\u662f\u5c06\u540c\u4e00\u4e1a\u52a1\u4e2d\u5404\u5173\u952e\u8282\u70b9\u4fe1\u606f\u6574\u5408\u81f3\u4e1a\u52a1\u5168\u6d41\u7a0b\u5bbd\u8868\u6a21\u578b\u4e2d\u3002\u9a6c\u8702\u7a9d\u8ba2\u5355\u4ea4\u6613\u6a21\u578b\u7684\u6784\u5efa\u5c31\u91c7\u7528\u4e86\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e0b\u6587\u5c06\u8fdb\u884c\u8be6\u7ec6\u4ecb\u7ecd\u3002</li> </ul>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#32","title":"3.2 \u8bbe\u8ba1\u76ee\u6807","text":"<p>\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5728\u6a21\u578b\u8bbe\u8ba1\u4e0a\u4ee5\u51c6\u786e\u6027\u3001\u6613\u7528\u6027\u3001\u53ca\u65f6\u6027\u4e3a\u8bbe\u8ba1\u76ee\u6807\uff0c\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u4eba\u5458\u5bf9\u6570\u636e\u7684\u591a\u6837\u9700\u6c42\u3002</p> <ul> <li>\u51c6\u786e\u6027\uff1a\u6570\u636e\u8d28\u91cf\u7ba1\u63a7\u8981\u5728\u5efa\u6a21\u8fc7\u7a0b\u4e2d\u843d\u5730\uff0c\u4e3a\u6570\u636e\u51c6\u786e\u6027\u4fdd\u9a7e\u62a4\u822a\u3002</li> <li>\u6613\u7528\u6027\uff1a\u517c\u987e\u6a21\u578b\u7684\u53ef\u6269\u5c55\u6027\u548c\u53ef\u7406\u89e3\u6027\u3002</li> <li>\u53ca\u65f6\u6027\uff1a\u5145\u5206\u8003\u8651\u6a21\u578b\u7684\u4f7f\u7528\u6548\u7387\uff0c\u63d0\u4f9b\u65b9\u4fbf\u5feb\u6377\u7684\u6570\u636e\u67e5\u8be2\u548c\u6570\u636e\u8ba1\u7b97\u670d\u52a1\u3002</li> </ul>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#33","title":"3.3 \u8bbe\u8ba1\u6d41\u7a0b","text":"<p>\u9a6c\u8702\u7a9d\u6570\u4ed3\u6a21\u578b\u8bbe\u8ba1\u7684\u6574\u4f53\u6d41\u7a0b\u6d89\u53ca\u9700\u6c42\u8c03\u7814\u3001\u6a21\u578b\u8bbe\u8ba1\u3001\u5f00\u53d1\u6d4b\u8bd5\u3001\u6a21\u578b\u4e0a\u7ebf\u56db\u4e2a\u4e3b\u8981\u73af\u8282\uff0c\u4e14\u89c4\u8303\u8bbe\u8ba1\u4e86\u6bcf\u4e2a\u9636\u6bb5\u7684\u8f93\u51fa\u4e0e\u8f93\u5165\u6587\u6863\u3002</p> <p></p> <ol> <li>\u9700\u6c42\u8c03\u7814\uff1a\u6536\u96c6\u548c\u7406\u89e3\u4e1a\u52a1\u65b9\u9700\u6c42\uff0c\u5c31\u7279\u5b9a\u9700\u6c42\u7684\u53e3\u5f84\u8fbe\u6210\u7edf\u4e00\uff0c\u5728\u5bf9\u9700\u6c42\u4e2d\u6d89\u53ca\u5230\u7684\u4e1a\u52a1\u7cfb\u7edf\u6216\u7cfb\u7edf\u6a21\u5757\u6240\u627f\u62c5\u7684\u529f\u80fd\u8fdb\u884c\u68b3\u7406\u540e\u8fdb\u884c\u8868\u5b57\u6bb5\u7ea7\u5206\u6790\uff0c\u5e76\u5bf9\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\uff0c\u786e\u4fdd\u73b0\u6709\u6570\u636e\u80fd\u591f\u652f\u6301\u4e1a\u52a1\u9700\u6c42\u3002</li> <li>\u6a21\u578b\u8bbe\u8ba1\uff1a\u6839\u636e\u9700\u6c42\u548c\u4e1a\u52a1\u8c03\u7814\u7ed3\u679c\u5bf9\u6a21\u578b\u8fdb\u884c\u521d\u6b65\u5f52\u7c7b\uff0c\u9009\u62e9\u5408\u9002\u7684\u4e3b\u9898\u57df\u8fdb\u884c\u6a21\u578b\u5b58\u653e\uff1b\u786e\u5b9a\u4e3b\u9898\u540e\u8fdb\u5165\u6570\u636e\u6a21\u578b\u7684\u8bbe\u8ba1\u9636\u6bb5\uff0c\u903b\u8f91\u6a21\u578b\u8bbe\u8ba1\u8fc7\u7a0b\u8981\u8003\u8651\u603b\u7ebf\u7ed3\u6784\u6784\u5efa\u3001\u6a21\u578b\u89c4\u8303\u5b9a\u4e49\u7b49\u5173\u952e\u95ee\u9898\uff1b\u7269\u7406\u6a21\u578b\u8bbe\u8ba1\u4ee5\u903b\u8f91\u6a21\u578b\u4e3a\u57fa\u7840\uff0c\u517c\u987e\u5b58\u50a8\u6027\u80fd\u7b49\u56e0\u7d20\u5bf9\u903b\u8f91\u6a21\u578b\u505a\u7684\u7269\u7406\u5316\u7684\u8fc7\u7a0b\uff0c\u662f\u903b\u8f91\u6a21\u578b\u7684\u6700\u7ec8\u7269\u7406\u5b9e\u73b0.\u7269\u7406\u6a21\u578b\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u4e0e\u903b\u8f91\u6a21\u578b\u4fdd\u6301\u4e00\u81f4\uff0c\u6a21\u578b\u8bbe\u8ba1\u5b8c\u6210\u540e\u9700\u8981\u8fdb\u5165\u8bc4\u5ba1\u4e0e Mapping \u8bbe\u8ba1\u3002</li> <li>\u6a21\u578b\u5f00\u53d1\uff1a\u5c31\u662f\u5bf9\u6a21\u578b\u8ba1\u7b97\u811a\u672c\u7684\u4ee3\u7801\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u6570\u636e\u6620\u5c04\u3001\u811a\u672c\u5b9e\u73b0\u3001\u6d4b\u8bd5\u9a8c\u8bc1\u7b49\u5f00\u53d1\u8fc7\u7a0b\u3002\u5355\u5143\u6d4b\u8bd5\u5b8c\u6210\u540e\u9700\u8981\u901a\u77e5\u4e1a\u52a1\u65b9\u4e00\u8d77\u5bf9\u6a21\u578b\u6570\u636e\u8fdb\u884c\u4e1a\u52a1\u9a8c\u8bc1\uff0c\u5bf9\u9a8c\u8bc1\u95ee\u9898\u505a\u6536\u96c6\uff0c\u8fd4\u56de\u9a8c\u8bc1\u6a21\u578b\u8bbe\u8ba1\u7684\u5408\u7406\u6027\u3002</li> <li>\u6a21\u578b\u4e0a\u7ebf\uff1a\u5b8c\u6210\u9a8c\u8bc1\u540e\u7684\u6a21\u578b\u5c31\u53ef\u4ee5\u5728\u7ebf\u4e0a\u751f\u4ea7\u73af\u5883\u8fdb\u884c\u90e8\u7f72\u3002\u4e0a\u7ebf\u540e\u9700\u8981\u4e3a\u6a21\u578b\u914d\u7f6e\u76d1\u63a7\uff0c\u53ca\u65f6\u638c\u63e1\u4e3a\u4e1a\u52a1\u63d0\u4f9b\u6570\u636e\u670d\u52a1\u7684\u72b6\u51b5\u3002\u6211\u4eec\u8fd8\u5c06\u6a21\u578b\u7684\u5b9e\u4f53\u548c\u5c5e\u6027\u8bf4\u660e\u6587\u6863\u53d1\u5e03\u7ed9\u4ed3\u5e93\u6570\u636e\u7684\u4f7f\u7528\u8005\uff0c\u4f7f\u6a21\u578b\u5f97\u5230\u66f4\u597d\u5730\u5e94\u7528\u3002</li> </ol>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#34","title":"3.4 \u4e3b\u9898\u5206\u7c7b","text":"<p>\u57fa\u4e8e\u5bf9\u76ee\u524d\u5404\u4e2a\u90e8\u95e8\u548c\u4e1a\u52a1\u7cfb\u7edf\u7684\u68b3\u7406\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5171\u8bbe\u8ba1\u4e86 4 \u4e2a\u5927\u6570\u636e\u57df(\u4ea4\u6613\u3001\u6d41\u91cf\u3001\u5185\u5bb9\u3001\u53c2\u4e0e\u4eba)\uff0c\u7ec6\u5206\u4e3a 11 \u4e2a\u4e3b\u9898\uff1a</p> <p></p> <p>\u4ee5\u9a6c\u8702\u7a9d\u8ba2\u5355\u4ea4\u6613\u6a21\u578b\u7684\u5efa\u8bbe\u4e3a\u4f8b\uff0c\u57fa\u4e8e\u4e1a\u52a1\u751f\u4ea7\u603b\u7ebf\u7684\u8bbe\u8ba1\u662f\u5e38\u89c1\u7684\u6a21\u5f0f\uff0c\u5373\u9996\u5148\u8c03\u7814\u8ba2\u5355\u4ea4\u6613\u7684\u5b8c\u6574\u8fc7\u7a0b\uff0c\u5b9a\u4f4d\u8fc7\u7a0b\u4e2d\u7684\u5173\u952e\u8282\u70b9\uff0c\u786e\u8ba4\u5404\u8282\u70b9\u4e0a\u53d1\u751f\u7684\u6838\u5fc3\u4e8b\u5b9e\u4fe1\u606f\u3002\u6a21\u578b\u662f\u6570\u636e\u7684\u8f7d\u4f53\uff0c\u6211\u4eec\u8981\u505a\u7684\u5c31\u662f\u901a\u8fc7\u6a21\u578b\uff08\u6216\u8005\u8bf4\u6a21\u578b\u4f53\u7cfb\uff09\u5f52\u7eb3\u751f\u4ea7\u603b\u7ebf\u4e2d\u5404\u4e2a\u8282\u70b9\u53d1\u751f\u7684\u4e8b\u5b9e\u4fe1\u606f\u3002</p> <p>\u8ba2\u5355\u751f\u4ea7\u603b\u7ebf\uff1a</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u6211\u4eec\u9700\u8981\u63d0\u70bc\u5404\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u4e3a\u4e86\u907f\u514d\u9057\u6f0f\u5173\u952e\u4fe1\u606f\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u62bd\u8c61\u8ba4\u4e3a\u8282\u70b9\u7684\u53c2\u4e0e\u4eba\u3001\u53d1\u751f\u65f6\u95f4\u3001\u53d1\u751f\u4e8b\u4ef6\u3001\u53d1\u751f\u534f\u8bae\u5c5e\u4e8e\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u9700\u8981\u91cd\u70b9\u83b7\u53d6\u3002\u4ee5\u4e0b\u5355\u8282\u70b9\u4e3a\u4f8b\uff0c\u53c2\u4e0e\u4eba\u5305\u62ec\u4e0b\u5355\u7528\u6237\u3001\u670d\u52a1\u5546\u5bb6\u3001\u5e73\u53f0\u8fd0\u8425\u4eba\u5458\u7b49\uff1b\u53d1\u751f\u65f6\u95f4\u5305\u62ec\u7528\u6237\u7684\u4e0b\u5355\u65f6\u95f4\u3001\u5546\u5bb6\u7684\u786e\u8ba4\u65f6\u95f4\u7b49\uff1b\u53d1\u751f\u7684\u4e8b\u4ef6\u5373\u7528\u6237\u8d2d\u4e70\u4e86\u5546\u54c1\uff0c\u9700\u8981\u8bb0\u5f55\u56f4\u7ed5\u8fd9\u4e00\u4e8b\u4ef6\u4ea7\u751f\u7684\u76f8\u5173\u4fe1\u606f\uff1b\u53d1\u751f\u534f\u8bae\u5373\u4ea7\u751f\u7684\u8ba2\u5355\uff0c\u8ba2\u5355\u91d1\u989d\u3001\u7ea6\u5b9a\u5185\u5bb9\u7b49\u90fd\u662f\u6211\u4eec\u9700\u8981\u8bb0\u5f55\u7684\u534f\u8bae\u4fe1\u606f\u3002</p> <p>\u5728\u8fd9\u6837\u7684\u601d\u8def\u4e0b\uff0c\u603b\u7ebf\u67b6\u6784\u53ef\u4ee5\u5728\u6a21\u578b\u4e2d\u4e0d\u65ad\u6dfb\u52a0\u5404\u4e2a\u8282\u70b9\u7684\u6838\u5fc3\u4fe1\u606f\uff0c\u4f7f\u6a21\u578b\u652f\u6491\u7684\u5e94\u7528\u8303\u56f4\u9010\u6b65\u6269\u5c55\u3001\u8d8b\u4e8e\u5b8c\u5584\u3002\u56e0\u6b64\uff0c\u5bf9\u4e1a\u52a1\u6d41\u7a0b\u7684\u7406\u89e3\u7a0b\u5ea6\u5c06\u76f4\u63a5\u5f71\u54cd\u4ea7\u51fa\u6a21\u578b\u7684\u8d28\u91cf\u3002</p> <p>\u6d89\u53ca\u7684\u4e1a\u52a1\u8282\u70b9\u8d8a\u591a\uff0c\u4e1a\u52a1\u6d41\u7a0b\u4e5f\u5c31\u8d8a\u590d\u6742\u3002\u4ece\u6570\u636e\u7684\u89d2\u5ea6\u770b\uff0c\u8fd9\u4e9b\u4e1a\u52a1\u8fc7\u7a0b\u4f1a\u4ea7\u751f\u4e24\u79cd\u57fa\u672c\u7684\u573a\u666f\u5f62\u6001\uff0c\u5373\u6570\u636e\u7684\u62c6\u5206\u548c\u6c47\u805a\u3002\u968f\u7740\u6d41\u7a0b\u7684\u63a8\u8fdb\uff0c\u524d\u4e00\u8282\u70b9\u7684\u539f\u5b50\u4e1a\u52a1\u5355\u4f4d\u5728\u65b0\u8282\u70b9\u4e2d\u53ef\u80fd\u9700\u8981\u62c6\u5206\u51fa\u66f4\u591a\u4fe1\u606f\uff0c\u6216\u8005\u53c2\u4e0e\u5230\u65b0\u8282\u70b9\u7684\u591a\u5411\u6d41\u7a0b\u3002\u540c\u6837\uff0c\u4e5f\u53ef\u80fd\u53d1\u751f\u6570\u636e\u7684\u6c47\u805a\u3002\u4ee5\u67d0\u4e2a\u8ba2\u5355\u4e3a\u4f8b\uff0c\u4e0b\u5355\u8282\u70b9\u6570\u636e\u662f\u8ba2\u5355\u7c92\u5ea6\u7684\uff0c\u800c\u5230\u652f\u4ed8\u8282\u70b9\u5c31\u53d1\u751f\u4e86\u6570\u636e\u62c6\u5206\u3002\u6570\u636e\u7684\u62c6\u5206\u3001\u6c47\u805a\u4f34\u968f\u7740\u603b\u7ebf\u7684\u5404\u8282\u70b9\uff0c\u53ef\u80fd\u4f1a\u4e00\u76f4\u53d1\u6563\u4e0b\u53bb\u3002</p> <p></p> <p>\u9274\u4e8e\u4e0a\u8ff0\u60c5\u51b5\uff0c\u5728\u6a21\u578b\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u4e0d\u80fd\u628a\u5404\u8282\u70b9\u4e0d\u540c\u7c92\u5ea6\u7684\u6570\u636e\u4fe1\u606f\u90fd\u5806\u780c\u5728\u4e00\u8d77\uff0c\u90a3\u6837\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u5197\u4f59\u4fe1\u606f\uff0c\u4e5f\u4f1a\u4f7f\u6a21\u578b\u672c\u8eab\u7684\u5b9a\u4f4d\u4e0d\u6e05\u6670\uff0c\u5f71\u54cd\u4f7f\u7528\u3002\u56e0\u6b64\uff0c\u9700\u8981\u8f93\u51fa\u4e0d\u540c\u7c92\u5ea6\u7684\u6a21\u578b\u6765\u6ee1\u8db3\u5404\u7c7b\u5e94\u7528\u9700\u6c42\u3002\u4f8b\u5982\u65e2\u4f1a\u5b58\u5728\u8ba2\u5355\u7c92\u5ea6\u7684\u6570\u636e\u6a21\u578b\uff0c\u4e5f\u4f1a\u5b58\u5728\u5206\u6790\u5404\u4e2a\u8ba2\u5355\u5728\u4e0d\u540c\u65f6\u95f4\u8282\u70b9\u72b6\u6001\u4fe1\u606f\u7684\u6570\u636e\u6a21\u578b\u3002</p> <p></p> <p></p> <p>\u57fa\u4e8e\u7ef4\u5ea6\u5efa\u6a21\u7684\u601d\u8def\uff0c\u5728\u6a21\u578b\u6574\u5408\u751f\u4ea7\u603b\u7ebf\u5404\u8282\u70b9\u6838\u5fc3\u4fe1\u606f\u4e4b\u540e\uff0c\u4f1a\u6839\u636e\u8fd9\u4e9b\u8282\u70b9\u4fe1\u606f\u8fdb\u4e00\u6b65\u6269\u5c55\u5e38\u7528\u7684\u5206\u6790\u7ef4\u5ea6\uff0c\u4ee5\u51cf\u5c11\u5e94\u7528\u5c42\u9762\u9891\u7e41\u5173\u8054\u76f8\u5173\u5206\u6790\u7ef4\u5ea6\u5e26\u6765\u7684\u8d44\u6e90\u6d88\u8017\uff0c\u6a21\u578b\u4f1a\u53cd\u8303\u5f0f\u5197\u4f59\u76f8\u5173\u7ef4\u5ea6\u4fe1\u606f\uff0c\u4ee5\u83b7\u53d6\u5e94\u7528\u5c42\u7684\u4f7f\u7528\u4fbf\u6377\u3002\u6700\u7ec8\u5efa\u7acb\u4e00\u4e2a\u6574\u5408\u65c5\u6e38\u3001\u4ea4\u901a\u3001\u9152\u5e97\u7b49\u5404\u4e1a\u52a1\u7ebf\u4e0e\u5404\u4e1a\u52a1\u8282\u70b9\u4fe1\u606f\u7684\u9a6c\u8702\u7a9d\u5168\u6d41\u7a0b\u8ba2\u5355\u6a21\u578b\u3002</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part4","title":"Part.4 \u6570\u636e\u4ed3\u5e93\u5de5\u5177\u94fe\u5efa\u8bbe","text":"<p>\u4e3a\u63d0\u5347\u6570\u636e\u751f\u4ea7\u529b\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u5efa\u7acb\u4e86\u4e00\u5957\u5de5\u5177\u94fe\uff0c\u6765\u5b9e\u73b0\u91c7\u96c6\u3001\u7814\u53d1\u3001\u7ba1\u7406\u6d41\u7a0b\u7684\u81ea\u52a8\u5316\u3002\u73b0\u9636\u6bb5\u6bd4\u8f83\u91cd\u8981\u7684\u6709\u4ee5\u4e0b\u4e09\u5927\u5de5\u5177\uff1a</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#1","title":"1. \u6570\u636e\u540c\u6b65\u5de5\u5177","text":"<p>\u540c\u6b65\u5de5\u5177\u4e3b\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li>\u4ece\u6e90\u7cfb\u7edf\u540c\u6b65\u6570\u636e\u5230\u6570\u636e\u4ed3\u5e93</li> <li>\u5c06\u6570\u636e\u4ed3\u5e93\u7684\u6570\u636e\u540c\u6b65\u81f3\u5176\u4ed6\u73af\u5883</li> </ul> <p>\u4e0b\u9762\u91cd\u70b9\u4ecb\u7ecd\u4ece\u6e90\u7cfb\u7edf\u540c\u6b65\u6570\u636e\u5230\u6570\u636e\u4ed3\u5e93\u3002</p> <p>\u9a6c\u8702\u7a9d\u7684\u6570\u636e\u540c\u6b65\u8bbe\u8ba1\u652f\u6491\u7075\u6d3b\u7684\u6570\u636e\u63a5\u5165\u65b9\u5f0f\uff0c\u53ef\u4ee5\u9009\u62e9\u62bd\u53d6\u65b9\u5f0f\u4ee5\u53ca\u52a0\u5de5\u65b9\u5f0f\u3002\u62bd\u53d6\u65b9\u5f0f\u4e3b\u8981\u5305\u62ec\u589e\u91cf\u62bd\u53d6\u6216\u8005\u5168\u91cf\u62bd\u53d6\uff0c\u52a0\u5de5\u65b9\u5f0f\u9762\u5411\u6570\u636e\u7684\u5b58\u50a8\u65b9\u5f0f\uff0c\u662f\u9700\u8981\u5bf9\u6570\u636e\u8fdb\u884c\u62c9\u94fe\u5f0f\u4fdd\u5b58\uff0c\u6216\u8005\u4ee5\u6d41\u6c34\u65e5\u5fd7\u7684\u65b9\u5f0f\u8fdb\u884c\u5b58\u50a8\u3002</p> <p>\u63a5\u5165\u65f6\uff0c\u53ea\u9700\u8981\u586b\u5199\u6570\u636e\u8868\u4fe1\u606f\u914d\u7f6e\uff0c\u4ee5\u53ca\u5177\u4f53\u7684\u5b57\u6bb5\u914d\u7f6e\u4fe1\u606f\uff0c\u6570\u636e\u5c31\u53ef\u4ee5\u81ea\u52a8\u63a5\u5165\u5230\u6570\u636e\u4ed3\u5e93\uff0c\u5f62\u6210\u6570\u4ed3\u7684 ODS \u5c42\u6570\u636e\u6a21\u578b\uff0c\u5982\u4e0b\uff1a</p> <p></p> <p></p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#2","title":"2. \u4efb\u52a1\u8c03\u5ea6\u5e73\u53f0","text":"<p>\u6211\u4eec\u4f7f\u7528 Airflow \u914d\u5408\u81ea\u7814\u7684\u4efb\u52a1\u8c03\u5ea6\u7cfb\u7edf\uff0c\u4e0d\u4ec5\u80fd\u652f\u6301\u5e38\u89c4\u7684\u4efb\u52a1\u8c03\u5ea6\uff0c\u8fd8\u53ef\u4ee5\u652f\u6301\u4efb\u52a1\u8c03\u5ea6\u7cfb\u7edf\u5404\u7c7b\u6570\u636e\u91cd\u8dd1\uff0c\u5386\u53f2\u8865\u6570\u7b49\u9700\u6c42\u3002</p> <p>\u522b\u5c0f\u770b\u6570\u636e\u91cd\u8dd1\u3001\u5386\u53f2\u8865\u6570\uff0c\u8fd9\u4e24\u9879\u529f\u80fd\u662f\u5728\u9009\u62e9\u8c03\u5ea6\u5de5\u5177\u4e2d\u91cd\u8981\u7684\u53c2\u8003\u9879\u3002\u505a\u6570\u636e\u7684\u4eba\u90fd\u6e05\u695a\uff0c\u5728\u5b9e\u9645\u6570\u636e\u5904\u7406\u8fc7\u7a0b\u4e2d\u4f1a\u9762\u4e34\u8bf8\u591a\u7684\u6570\u636e\u53e3\u5f84\u53d8\u5316\u3001\u6570\u636e\u5f02\u5e38\u7b49\uff0c\u9700\u8981\u8fdb\u884c\u6570\u636e\u91cd\u8dd1\u3001\u5237\u65b0\u3001\u8865\u6570\u7b49\u64cd\u4f5c\u3002</p> <p>\u6211\u4eec\u8bbe\u8ba1\u7684\u300c\u4e00\u952e\u91cd\u8dd1\u300d\u529f\u80fd\uff0c\u53ef\u4ee5\u5c06\u76f8\u5173\u4efb\u52a1\u4f9d\u8d56\u7684\u540e\u7f6e\u4efb\u52a1\u5168\u90e8\u5e26\u51fa\uff0c\u5e76\u652f\u6301\u9009\u62e9\u6027\u5730\u5220\u9664\u6216\u865a\u62df\u6267\u884c\u4efb\u610f\u8282\u70b9\u7684\u4efb\u52a1\uff1a</p> <ul> <li>\u5982\u679c\u9009\u62e9\u5220\u9664\uff0c\u8fd9\u8be5\u4efb\u52a1\u4e4b\u540e\u6240\u4f9d\u8d56\u7684\u4efb\u52a1\u5747\u4e0d\u6267\u884c</li> <li>\u5982\u679c\u9009\u62e9\u865a\u62df\u6267\u884c\uff0c\u5219\u4f1a\u5ffd\u7565\uff08\u7a7a\u8dd1\uff09\u6389\u8be5\u4efb\u52a1\uff0c\u540e\u7f6e\u7684\u6240\u6709\u4f9d\u8d56\u4efb\u52a1\u8fd8\u662f\u4f1a\u6b63\u5e38\u6267\u884c\u3002</li> </ul> <p>\u5982\u4e0b\u662f\u57fa\u4e8e\u67d0\u4e00\u4e2a\u4efb\u52a1\u91cd\u8dd1\u4e0b\u6e38\u6240\u6709\u4efb\u52a1\u6240\u5217\u51fa\u7684\u5173\u7cfb\u56fe\uff0c\u9009\u4e2d\u5177\u4f53\u7684\u6267\u884c\u8282\u70b9\uff0c\u5c31\u53ef\u4ee5\u6267\u884c\u5ffd\u7565\u6216\u8005\u5220\u9664\u3002</p> <p></p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#3","title":"3. \u5143\u6570\u636e\u7ba1\u7406\u5de5\u5177","text":"<p>\u5143\u6570\u636e\u8303\u7574\u5305\u62ec\u6280\u672f\u5143\u6570\u636e\u3001\u4e1a\u52a1\u5143\u6570\u636e\u3001\u7ba1\u7406\u5143\u6570\u636e\uff0c\u5728\u6982\u5ff5\u4e0a\u4e0d\u505a\u8fc7\u591a\u9610\u8ff0\u4e86\u3002\u5143\u6570\u636e\u7ba1\u7406\u5728\u6570\u636e\u5efa\u8bbe\u8d77\u7740\u4e3e\u8db3\u8f7b\u91cd\u7684\u4f5c\u7528\uff0c\u8fd9\u90e8\u5206\u5728\u6570\u4ed3\u5e94\u7528\u4e2d\u4e3b\u8981\u6709 2 \u4e2a\u70b9\uff1a</p> <p>\uff081\uff09\u8840\u7f18\u7ba1\u7406</p> <p>\u8840\u7f18\u7ba1\u7406\u53ef\u4ee5\u8ffd\u6eaf\u6570\u636e\u52a0\u5de5\u6574\u4f53\u94fe\u8def\uff0c\u89e3\u6790\u8868\u7684\u6765\u9f99\u53bb\u8109\uff0c\u7528\u4e8e\u652f\u6491\u5404\u7c7b\u573a\u666f\uff0c\u5982\uff1a</p> <ul> <li>\u652f\u6301\u4e0a\u6e38\u53d8\u66f4\u5bf9\u4e0b\u6e38\u5f71\u54cd\u7684\u5206\u6790\u4e0e\u8c03\u6574</li> <li>\u76d1\u63a7\u5404\u8282\u70b9\u3001\u5404\u94fe\u8def\u4efb\u52a1\u8fd0\u884c\u6210\u672c\uff0c\u6548\u7387</li> <li>\u76d1\u63a7\u6570\u636e\u6a21\u578b\u7684\u4f9d\u8d56\u6570\u91cf\uff0c\u786e\u8ba4\u54ea\u4e9b\u662f\u91cd\u70b9\u6a21\u578b</li> </ul> <p>\u5982\u4e0b\u662f\u67d0\u4e00\u4e2a\u6570\u636e\u6a21\u578b\u4e2d\u7684\u8840\u7f18\u56fe\uff0c\u4e0a\u4e0b\u6e38\u4ee5\u4e0d\u540c\u989c\u8272\u8fdb\u884c\u5448\u73b0\uff1a</p> <p></p> <p>\uff082\uff09\u6570\u636e\u77e5\u8bc6\u7ba1\u7406</p> <p>\u901a\u8fc7\u5bf9\u6280\u672f\u3001\u4e1a\u52a1\u5143\u6570\u636e\u8fdb\u884c\u6e05\u6670\u3001\u8be6\u5c3d\u5730\u63cf\u8ff0\uff0c\u5f62\u6210\u6570\u636e\u77e5\u8bc6\uff0c\u7ed9\u6570\u636e\u4eba\u5458\u63d0\u4f9b\u66f4\u597d\u7684\u4f7f\u7528\u5411\u5bfc\u3002\u6211\u4eec\u7684\u6570\u636e\u77e5\u8bc6\u4e3b\u8981\u5305\u62ec\u5b9e\u4f53\u8bf4\u660e\u4e0e\u5c5e\u6027\u8bf4\u660e\uff0c\u5177\u4f53\u5982\u4e0b\uff1a</p> <p></p> <p></p> <p>\u5f53\u7136\uff0c\u6570\u4ed3\u5de5\u5177\u94fe\u6761\u4e2d\u8fd8\u6709\u975e\u5e38\u591a\u5de5\u5177\uff0c\u4f8b\u5982\u81ea\u52a8\u5316\u5efa\u6a21\u5de5\u5177\uff0c\u6570\u636e\u8d28\u91cf\u7ba1\u7406\u5de5\u5177\uff0c\u6570\u636e\u5f00\u53d1\u5de5\u5177\u7b49\uff0c\u90fd\u5df2\u7ecf\u5f97\u5230\u4e86\u5f88\u597d\u5730\u5b9e\u73b0\u3002</p>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part5","title":"Part.5 \u6570\u4ed3\u5e94\u7528\u2014\u2014\u6307\u6807\u5e73\u53f0","text":"<p>\u6709\u4e86\u5408\u7406\u7684\u6570\u4ed3\u67b6\u6784\u3001\u5de5\u5177\u94fe\u6761\u652f\u6491\u6570\u636e\u7814\u53d1\uff0c\u63a5\u4e0b\u6765\uff0c\u5c31\u8981\u8003\u8651\u5982\u4f55\u628a\u4ea7\u51fa\u7684\u6570\u636e\u5bf9\u5916\u8d4b\u80fd\u3002\u4e0b\u9762\u4ee5\u9a6c\u8702\u7a9d\u6570\u636e\u5e94\u7528\u5229\u5668-\u6307\u6807\u5e73\u53f0\uff0c\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd\u3002</p> <p>\u51e0\u4e4e\u6240\u6709\u7684\u4f01\u4e1a\u90fd\u4f1a\u6784\u5efa\u81ea\u5df1\u7684\u6307\u6807\u5e73\u53f0\uff0c\u6bcf\u4e2a\u4f01\u4e1a\u5efa\u7acb\u7684\u6807\u51c6\u90fd\u4e0d\u4e00\u6837\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u4f1a\u9047\u5230\u6307\u6807\u7e41\u591a\u3001\u5b9a\u4e49\u4e0d\u6e05\u695a\u3001\u67e5\u8be2\u7f13\u6162\u7b49\u95ee\u9898\u3002\u4e3a\u5c3d\u91cf\u907f\u514d\u8fd9\u4e9b\u95ee\u9898\uff0c\u6307\u6807\u5e73\u53f0\u5728\u8bbe\u8ba1\u65f6\u9700\u8981\u9075\u5faa\u51e0\u5927\u539f\u5219\uff1a</p> <ol> <li>\u6307\u6807\u5b9a\u4e49\u6807\u51c6\uff0c\u6e05\u6670\uff0c\u5bb9\u6613\u7406\u89e3\uff0c\u4e14\u4e0d\u5b58\u5728\u4e8c\u4e49\u6027\uff0c\u5206\u7c7b\u660e\u786e</li> <li>\u6307\u6807\u751f\u4ea7\u8fc7\u7a0b\u7b80\u5355\u3001\u900f\u660e\u3001\u53ef\u914d\u7f6e\u5316</li> <li>\u6307\u6807\u67e5\u8be2\u6548\u7387\u9700\u8981\u6ee1\u8db3\u5feb\u901f\u54cd\u5e94</li> <li>\u6307\u6807\u6743\u9650\u7ba1\u7406\u7075\u6d3b\u53ef\u63a7</li> </ol> <p>\u57fa\u4e8e\u4ee5\u4e0a\u539f\u5219\uff0c\u9a6c\u8702\u7a9d\u7684\u6307\u6807\u5e73\u53f0\u6309\u7167\u7cbe\u7ec6\u5316\u7684\u8bbe\u8ba1\u8fdb\u884c\u6253\u9020\uff0c\u6307\u6807\u5e73\u53f0\u7ec4\u6210\u67b6\u6784\u5982\u4e0b\u56fe\uff1a</p> <p></p> <p>\u5176\u4e2d\uff1a</p> <ol> <li>\u6570\u636e\u4ed3\u5e93\u662f\u6307\u6807\u6570\u636e\u7684\u6765\u6e90\uff0c\u6240\u6709\u6307\u6807\u76ee\u524d\u90fd\u662f\u901a\u8fc7\u6570\u636e\u4ed3\u5e93\u7edf\u4e00\u52a0\u5de5\u7684</li> <li>\u6307\u6807\u7ba1\u7406\u5305\u62ec\u6307\u6807\u521b\u5efa\u4e0e\u6307\u6807\u5143\u6570\u636e\u7ba1\u7406\uff1a\u6570\u4ed3\u8d1f\u8d23\u751f\u4ea7\u5e76\u521b\u5efa\u6700\u6838\u5fc3\u3001\u6700\u57fa\u7840\u7684\u6307\u6807\uff1b\u5176\u4ed6\u4eba\u5458\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e9b\u6307\u6807\uff0c\u6309\u7167\u89c4\u5219\u8fdb\u884c\u6307\u6807\u7684\u6d3e\u751f\uff1b\u5143\u6570\u636e\u7ba1\u7406\u8bb0\u5f55\u6307\u6807\u7684\u5177\u4f53\u6765\u6e90\u8def\u5f84\uff0c\u8bf4\u660e\u6307\u6807\u7684\u6570\u636e\u6765\u6e90\u662f\u6570\u4ed3\u8868\uff0c\u6216\u8005\u662f Kylin\uff0cMySQL \u6216 ES</li> <li>\u6307\u6807\u5b57\u5178\u5bf9\u5916\u5448\u73b0\u6307\u6807\u7684\u5b9a\u4e49\u3001\u53e3\u5f84\u3001\u8bf4\u660e\u7b49\uff0c\u4fdd\u8bc1\u6307\u6807\u7684\u900f\u660e\u5316\u53ca\u53ef\u89e3\u91ca\u6027</li> <li>\u6570\u636e\u670d\u52a1\u63a5\u53d7\u6307\u6807\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u9488\u5bf9\u4e0d\u540c\u573a\u666f\u5224\u65ad\u67e5\u8be2\u7684\u6210\u672c\uff0c\u9009\u62e9\u6700\u4f18\u94fe\u8def\u8fdb\u884c\u6307\u6807\u67e5\u8be2\uff0c\u5e76\u8fd4\u56de\u6307\u6807\u67e5\u8be2\u7684\u7ed3\u679c</li> <li>\u591a\u7ef4\u67e5\u8be2\u5c06\u53ef\u4ee5\u63d0\u4f9b\u67e5\u8be2\u670d\u52a1\u7684\u6307\u6807\u4e0e\u7ef4\u5ea6\u901a\u8fc7\u754c\u9762\u5448\u73b0\uff0c\u7528\u6237\u53ef\u4ee5\u57fa\u4e8e\u7ef4\u5ea6\u9009\u62e9\u6307\u6807\u6216\u57fa\u4e8e\u6307\u6807\u9009\u62e9\u7ef4\u5ea6\uff0c\u67e5\u8be2\u5177\u4f53\u9700\u8981\u7684\u6570\u636e</li> <li>\u6743\u9650\u7ba1\u7406\u8d2f\u5f7b\u59cb\u7ec8\uff0c\u53ef\u4ee5\u652f\u6301\u8868\u7ea7\u3001\u6307\u6807\u7ea7\u3001\u7ef4\u503c\u7ea7\u522b\u7684\u6743\u9650\u7ba1\u7406</li> </ol>","tags":["warehouse","edw"]},{"location":"bigdata/mafengwo-warehouse-design-and-practices/#part6","title":"Part.6 \u603b\u7ed3","text":"<p>\u4f01\u4e1a\u7684\u6570\u636e\u5efa\u8bbe\u9700\u8981\u7ecf\u5386\u51e0\u4e2a\u5927\u7684\u6b65\u9aa4\uff1a</p> <ul> <li>\u7b2c\u4e00\u6b65\uff0c\u4e1a\u52a1\u6570\u636e\u5316\uff1a\u987e\u540d\u601d\u4e49\uff0c\u4e00\u5207\u4e1a\u52a1\u90fd\u80fd\u901a\u8fc7\u6570\u636e\u53cd\u6620\uff0c\u4e3b\u8981\u6307\u7684\u662f\u5c06\u4f20\u7edf\u7ebf\u4e0b\u6d41\u7a0b\u7ebf\u4e0a\u5316\uff1b</li> <li>\u7b2c\u4e8c\u6b65\uff0c\u6570\u636e\u667a\u80fd\u5316\uff1a\u5149\u6709\u6570\u636e\u8fd8\u4e0d\u884c\uff0c\u8fd8\u9700\u8981\u8db3\u591f\u7684\u667a\u80fd\uff0c\u5982\u4f55\u901a\u8fc7\u667a\u80fd\u5316\u7684\u6570\u636e\u652f\u6491\u8fd0\u8425\u3001\u8425\u9500\u53ca\u5404\u7c7b\u4e1a\u52a1\uff0c\u8fd9\u662f\u6570\u636e\u4e2d\u53f0\u5f53\u524d\u89e3\u51b3\u7684\u4e3b\u8981\u95ee\u9898\uff1b</li> <li>\u7b2c\u4e09\u6b65\uff0c\u6570\u636e\u4e1a\u52a1\u5316\uff1a\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u6570\u636e\u9a71\u52a8\u4e1a\u52a1\uff0c\u6570\u636e\u4e0d\u80fd\u53ea\u662f\u6570\u636e\uff0c\u6570\u636e\u4ef7\u503c\u6700\u5927\u5316\u5728\u4e8e\u53ef\u4ee5\u9a71\u52a8\u65b0\u7684\u4e1a\u52a1\u521b\u65b0\uff0c\u5e26\u52a8\u4f01\u4e1a\u589e\u957f\u3002</li> </ul> <p>\u76ee\u524d\u5927\u90e8\u4f01\u4e1a\u76ee\u524d\u90fd\u505c\u7559\u5728\u7b2c\u4e8c\u4e2a\u9636\u6bb5\uff0c\u56e0\u4e3a\u8fd9\u4e00\u6b65\u9700\u8981\u8db3\u591f\u592f\u5b9e\uff0c\u624d\u80fd\u4e3a\u7b2c\u4e09\u6b65\u6253\u597d\u57fa\u7840\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u5404\u5927\u4f01\u4e1a\u8981\u6295\u5165\u5f88\u5927\u6210\u672c\u5230\u5927\u6570\u636e\u5e73\u53f0\u3001\u6570\u636e\u4ed3\u5e93\u4e43\u81f3\u6570\u636e\u4e2d\u53f0\u7684\u5efa\u8bbe\u4e2d\u3002</p> <p>\u9a6c\u8702\u7a9d\u6570\u636e\u4e2d\u53f0\u7684\u5efa\u8bbe\u624d\u521a\u521a\u8d77\u6b65\u3002\u6211\u4eec\u8ba4\u4e3a\uff0c\u7406\u60f3\u7684\u6570\u636e\u4e2d\u53f0\u9700\u8981\u5177\u5907**\u6570\u636e\u6807\u51c6\u5316\u3001\u5de5\u5177\u7ec4\u4ef6\u5316\u3001\u7ec4\u7ec7\u6e05\u6670\u5316**\u8fd9\u4e09\u4e2a\u6838\u5fc3\u524d\u63d0\u3002\u4e3a\u4e86\u5411\u8fd9\u4e00\u76ee\u6807\u8fc8\u8fdb\uff0c\u6211\u4eec\u5c06\u5efa\u7acb\u7edf\u4e00\u3001\u6807\u51c6\u5316\u7684\u6570\u636e\u4ed3\u5e93\u4f5c\u4e3a\u5f53\u4e0b\u6570\u636e\u4e2d\u53f0\u7684\u91cd\u70b9\u5de5\u4f5c\u4e4b\u4e00\u3002</p> <p>\u6570\u636e\u6765\u6e90\u4e8e\u4e1a\u52a1\uff0c\u6700\u7ec8\u4e5f\u5c06\u5e94\u7528\u4e8e\u4e1a\u52a1\u3002\u53ea\u6709\u5bf9\u6570\u636e\u8db3\u591f\u91cd\u89c6\uff0c\u4e0e\u4e1a\u52a1\u5145\u5206\u8854\u63a5\uff0c\u624d\u80fd\u5b9e\u73b0\u6570\u636e\u4ef7\u503c\u7684\u6700\u5927\u5316\u3002\u5728\u9a6c\u8702\u7a9d\uff0c\u4ece\u7ba1\u7406\u5c42\uff0c\u5230\u516c\u53f8\u7814\u53d1\u3001\u4ea7\u54c1\u3001\u8fd0\u8425\u3001\u9500\u552e\u7b49\u5404\u89d2\u8272\uff0c\u5bf9\u6570\u636e\u975e\u5e38\u91cd\u89c6\uff0c\u6570\u636e\u4ea7\u54c1\u7684\u4f7f\u7528\u4eba\u6570\u5360\u516c\u53f8\u5458\u5de5\u6bd4\u4f8b\u9ad8\u8fbe 75%\u3002</p> <p>\u5927\u91cf\u7528\u6237\u7684\u4f7f\u7528\uff0c\u9a71\u52a8\u7740\u6211\u4eec\u5728\u6570\u636e\u4e2d\u53f0\u5efa\u8bbe\u7684\u8def\u4e0a\u4e0d\u65ad\u524d\u8fdb\u3002\u5982\u4f55\u5c06\u65b0\u5174\u6280\u672f\u80fd\u529b\u5e94\u7528\u5230\u6570\u636e\u4ed3\u5e93\u7684\u5efa\u8bbe\uff0c\u5982\u4f55\u4ee5\u6709\u9650\u7684\u6210\u672c\u9ad8\u6548\u89e3\u51b3\u4f01\u4e1a\u5728\u6570\u636e\u5efa\u8bbe\u4e2d\u9762\u4e34\u7684\u95ee\u9898\uff0c\u5c06\u662f\u9a6c\u8702\u7a9d\u6570\u4ed3\u5efa\u8bbe\u4e00\u76f4\u7684\u601d\u8003\u3002</p> <p>\u672c\u6587\u4f5c\u8005\uff1a\u989c\u535a\uff0c\u9a6c\u8702\u7a9d\u6570\u636e\u4ed3\u5e93\u7814\u53d1\u8d1f\u8d23\u4eba\u3002</p>","tags":["warehouse","edw"]},{"location":"bigdata/presto-with-ssl/","title":"Presto SSL \u914d\u7f6e","text":"<p>\u8981\u542f\u7528Presto\u7684\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u524d\u63d0\u662f\u8981\u914d\u7f6ePresto\u8282\u70b9\u95f4\u7684\u901a\u8baf\u4e3a\u52a0\u5bc6\u6a21\u5f0f\u3002</p> <p>\u6709\u5173\u52a0\u5bc6\u901a\u8baf\u66f4\u8be6\u7ec6\u7684\u8bf4\u660e\u548c\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863</p> <p>\u8fd9\u91cc\u4ec5\u8bb0\u5f55\u5728\u5b9e\u9645\u73af\u5883\u4e2d\u5982\u4f55\u914d\u7f6e\uff0c\u4ee5\u4e0b\u914d\u7f6e\u548c\u5206\u53d1\u4f7f\u7528prestoadmin\u5de5\u5177</p> <p>\u6ce8\u610f\u4ee5\u4e0b\u64cd\u4f5c\u5747\u5728\u914d\u7f6e\u6709 <code>prestoadmin</code> \u8282\u70b9\u7684 <code>.prestoadmin</code> \u76ee\u5f55\u4e0b\u64cd\u4f5c</p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#_1","title":"\u524d\u63d0\u8981\u6c42","text":"<p>\u6240\u6709\u8282\u70b9\u4e3b\u673a\u540d\u9700\u8981\u6ee1\u8db3FQDN\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u4e3b\u673a\u540d\u52a0\u57df\u540d\uff0c\u6211\u4eec\u751f\u4ea7\u73af\u5883\u7684\u57df\u540d\u662f <code>bigdata.wgzhao.com</code>, \u9884\u53d1\u5e03\u73af\u5883\u4e3a <code>ds.wgzhao.com</code></p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#java-keystore-file","title":"\u751f\u6210  Java Keystore File \u6587\u4ef6","text":"<p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u751f\u4ea7</p> <pre><code>keytool -genkeypair -keyalg RSA -keysize 2048 -validity 365 \\\n-dname \"CN=*.bigdata.wgzhao.com, OU=cfzq,O=com, L=Changsha, ST=Hunan, C=CN\" \\\n-alias presto_prod -keypass JksPassword -keystore presto.jks -storepass JksPassword\n</code></pre> <p>\u8fd9\u4e86\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f <code>CN</code> \u7684\u914d\u7f6e\uff0c\u5fc5\u987b\u662f\u6cdb\u57df\u540d\u65b9\u5f0f\uff0c\u800c\u4e14\u57df\u540d\u548c\u5f53\u524d\u8282\u70b9\u7684\u57df\u540d\u76f8\u5339\u914d\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u8bc1\u4e66\u6821\u9a8c\u65e0\u6cd5\u901a\u8fc7\u7684\u9519\u8bef\uff0c\u5bfc\u81f4\u8282\u70b9\u95f4\u901a\u8baf\u5931\u8d25</p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#_2","title":"\u5c06\u6587\u4ef6\u53d1\u5e03\u5230\u6240\u6709\u8282\u70b9","text":"<p><code>presto-admin file copy ./presto.jks /etc/presto/</code></p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#worker","title":"\u914d\u7f6e worker \u8282\u70b9","text":"<p>\u9996\u5148\u914d\u7f6e  <code>config.properties</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <p><pre><code>coordinator=false\nhttp-server.http.port=59999\ndiscovery.uri=http://nn01.bigdata.wgzhao.com:59999\n##SSL\ninternal-communication.shared-secret=UcGm5mjqgDPZ8ojxQ0c9pB\nnode.internal-address-source=FQDN\nhttp-server.https.enabled=true\nhttp-server.https.port=15999\nhttp-server.https.keystore.path=/etc/presto/presto.jks\nhttp-server.https.keystore.key=JksPassword\ndiscovery.uri=https://nn01.bigdata.wgzhao.com:15999\ninternal-comunication.https.required=true\ninternal-communication.https.keystore.path=/etc/presto/presto.jks\ninternal-communication.https.keystore.key=JksPassword\nhttp-server.https.secure-random-algorithm=SHA1PRNG\n</code></pre> \u7136\u540e\u914d\u7f6e <code>jvm.config</code> \u6587\u4ef6\uff0c\u5728\u6700\u540e\u589e\u52a0\u4e00\u884c</p> <p><code>-Djava.security.egd=file:/dev/urandom</code></p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#coordinator","title":"\u914d\u7f6e Coordinator \u8282\u70b9","text":"<p>\u9996\u5148\u914d\u7f6e  <code>config.properties</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>node-scheduler.include-coordinator=false\ndiscovery.uri=http://nn01.bigdata.wgzhao.com:59999\ndiscovery-server.enabled=true\nhttp-server.http.port=59999\ncoordinator=true\n#query.max-memory-per-node=8GB\n# auth setup\n#http-server.authentication.type=PASSWORD\n\n##SSL\ninternal-communication.shared-secret=UcGm5mjqgDPZ8ojxQ0c9pB\nnode.internal-address-source=FQDN\nhttp-server.https.enabled=true\nhttp-server.https.port=15999\nhttp-server.https.keystore.path=/etc/presto/presto.jks\nhttp-server.https.keystore.key=JksPassword\ndiscovery.uri=https://nn01.bigdata.wgzhao.com:15999\ninternal-comunication.https.required=true\ninternal-communication.https.keystore.path=/etc/presto/presto.jks\ninternal-communication.https.keystore.key=JksPassword\nhttp-server.https.secure-random-algorithm=SHA1PRNG\n</code></pre> <p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u6211\u4eec\u4f9d\u7136\u542f\u7528\u4e86http\u534f\u8bae\uff0c\u8fd9\u662f\u8003\u8651\u5230\u4e00\u4e9b\u5de5\u5177\u94fe\u63a5Presto\u5728SSL\u65b9\u5f0f\u4e0b\u51fa\u73b0\u95ee\u9898\uff0c\u540e\u9762\u4f1a\u7981\u6b62http\u534f\u8bae\uff0c\u4ec5\u542f\u7528https\u534f\u8bae\u3002</p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#_3","title":"\u5206\u53d1\u914d\u7f6e\u6587\u4ef6","text":"<p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u91cd\u65b0\u5206\u53d1\u914d\u7f6e\u6587\u4ef6</p> <p><code>presto-admin configuration deploy</code></p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#_4","title":"\u91cd\u542f\u670d\u52a1","text":"<p>\u91cd\u542f\u670d\u52a1\u4f7f\u5f97\u914d\u7f6e\u751f\u6548</p> <p><code>presto-admin server restart</code></p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/presto-with-ssl/#_5","title":"\u67e5\u770b","text":"<p>\u8bbf\u95ee https://nn01.bigdata.wgzhao.com:15999/ui \u53ef\u4ee5\u770b\u5230\u901a\u8fc7HTTPS\u65b9\u5f0f\u94fe\u63a5\u7684Presto\u670d\u52a1\u3002</p>","tags":["presto","trino","security","ssl"]},{"location":"bigdata/zookeeper-optimize/","title":"zookeeper\u96c6\u7fa4\u5e94\u5bf9\u4e07\u7ea7\u5e76\u53d1\u7684\u8c03\u4f18","text":"<p>Source</p> <ul> <li>tickTime\uff0c\u8fd9\u4e2a\u53c2\u6570\u53eb\u5404\u8282\u70b9\u524d\u5fc3\u8df3\u4fdd\u6301\u7684\u9891\u7387\uff0c\u4f60\u5373\u4e0d\u80fd\u592a\u9ad8\u4e5f\u4e0d\u80fd\u592a\u4f4e\uff0c\u592a\u9ad8\u4e86\u5404zk\u8282\u70b9\u95f4\u4e07\u4e00\u6709\u4e00\u4e2a\u6302\u4e86\u90a3\u4e48\u6574\u4e2azk\u7684master\u7fa4\u6765\u4e0d\u53ca\u9009\u4e3e\u51fa\u6765\u4e86\u5c31\u4f1a\u5f71\u54cd\u5230\u6574\u4eba\u672c\u4e1a\u52a1\u3002\u5982\u679c\u592a\u4f4e\u4e86\uff0c\u90a3\u4e48zk\u7fa4\u95f4\u56e0\u4e3a\u9891\u7e41\u5fc3\u8df3\u800c\u5bfc\u81f4\u7f51\u7edc\u5f00\u9500\u8fc7\u5927\uff1b</li> <li>initLimit\uff0c\u8fd9\u4e2a\u503c\u662f\u8fd9\u6837\u7684\uff0c\u8981\u770b\u771f\u5b9e\u7684\u5e76\u53d1\u8fde\u63a5\u7684\u3002\u7c7b\u4f3c\u8fd9\u79cdinitXXX\u503c\u6709\u4e00\u4e2a\u901a\u5219\uff0c\u90a3\u5c31\u662f\u7406\u8bba\u4e0a\u8981\u628a\u5b83\u8bbe\u6210\u548cmaxXXX\u4e00\u6837\uff0c\u5927\u5bb6\u8bbe\u60f3\u4e00\u4e0b\uff0c\u4e00\u5f00\u59cb\u4f60\u8bbe\u62101\uff0c\u7136\u540e\u6574\u4e2aconnection pool\u53d1\u89c9\u4e0d\u591f\u4e86\u5f00\u59cb+1\uff0c+1\u64cd\u4f5c\uff0c\u8fd9\u79cd\u201c+1\u201d\u64cd\u4f5c\u662f\u6709\u7cfb\u7edf\u5f00\u9500\u7684\uff0c\u5b83\u4f1a\u5f71\u54cd\u6574\u4f53\u7cfb\u7edf\u7684\u6027\u80fd\u3001\u5410\u541e\u3001\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u3002\u4f46\u662f\u8fd9\u4e2a\u901a\u5219\u4e5f\u4e0d\u662f\u4e00\u6210\u4e0d\u53d8\uff0c\u5982\u679c\u4f60\u5f00\u4e86\u591a\u4f1a\u9020\u6210\u6d6a\u8d39\uff0c\u56e0\u6b64\u62ff\u8fd9\u8fb9\u7684\u6848\u4f8b\u6765\u8bf4\uff0c\u6211\u4eec\u7684pool\u670934\u4e2a\uff0c\u6bcf\u4e2a\u542f\u52a8\u90fd\u8981\u53bb\u8fdezk\uff0c\u90a3\u4e48\u6211\u4eec\u628a\u8fd9\u4e2a\u6700\u5c0f\u503c\u8bbe\u621050\u662f\u5408\u7406\u7684\uff0c\u5982\u679c\u201c\u5f39\u6027\u6269\u5145\u4e86pool\u201d\u540e\uff0c\u90a3\u4e48\u518d\u8ba9\u5b83\u81ea\u589e\u201c1\u201d\uff1b</li> <li>syncLimit\uff0c\u8be5\u53c2\u6570\u6709\u9ed8\u8ba4\u503c5\uff0c\u5373\u8868\u793a\u662f\u53c2\u6570tickTime\u503c\u76845\u500d\uff0c\u5fc5\u987b\u914d\u7f6e\uff0c\u4e14\u9700\u8981\u914d\u7f6e\u4e00\u4e2a\u6b63\u6574\u6570\uff0c\u4e0d\u652f\u6301\u7cfb\u7edf\u5c5e\u6027\u65b9\u5f0f\u914d\u7f6e\u3002 </li> </ul> <p>\u8be5\u53c2\u6570\u7528\u4e8e\u914d\u7f6eLeader\u670d\u52a1\u5668\u548cFollower\u4e4b\u95f4\u8fdb\u884c\u5fc3\u8df3\u68c0\u6d4b\u7684\u6700\u5927\u5ef6\u65f6\u65f6\u95f4\u3002\u5728ZooKeeper\u96c6\u7fa4\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0cLeader\u670d\u52a1\u5668\u4f1a\u4e0e\u6240\u6709\u7684Follower\u8fdb\u884c\u5fc3\u8df3\u68c0\u6d4b\u6765\u786e\u5b9a\u8be5\u670d\u52a1\u5668\u662f\u5426\u5b58\u6d3b\u3002\u5982\u679cLeader\u670d\u52a1\u5668\u5728syncLimit\u65f6\u95f4\u5185\u65e0\u6cd5\u83b7\u53d6\u5230Follower\u7684\u5fc3\u8df3\u68c0\u6d4b\u54cd\u5e94\uff0c\u90a3\u4e48Leader\u5c31\u4f1a\u8ba4\u4e3a\u8be5Follower\u5df2\u7ecf\u8131\u79bb\u4e86\u548c\u81ea\u5df1\u7684\u540c\u6b65\u3002\u56e0\u6b64\u8fd9\u8fb9\u6211\u4eec\u8ba4\u4e3a30\u79d2\u6ca1\u6709\u53cd\u9988\uff0c\u90a3\u4e48\u6211\u4eec\u8ba4\u4e3aLeader\u548cFollower\u95f4\u5df2\u7ecf\u201c\u6302\u201d\u4e86\uff1b * leaderServers=no\uff0c\u8fd9\u4e2a\u53c2\u6570\u662f\u76f8\u5f53\u6709\u7528\u7684\uff0c\u5728\u751f\u4ea7\u4e0a\u662f\u5fc5\u5f00\u542f\u7684\u3002\u5b83\u4ee3\u8868Leader\u7684\u4e3b\u673a\u8282\u70b9\u4e0d\u63a5\u53d7\u8fde\u63a5\uff0c\u56e0\u4e3aLeader\u662f\u4f5c\u4e3a\u534f\u8c03\u7528\u7684\uff0c\u800c\u4e0d\u662f\u4f9b\u5bf9\u5916\u670d\u52a1\u5b83\u53ea\u662f\u5bf9\u5185\u3002\u5b83\u7684\u8bbe\u7f6e\u4f1a\u76f4\u63a5\u63d0\u5347zk\u7fa4\u7684\u6027\u80fd\uff1b * maxClientCnxns\uff0c\u5728\u538b\u6d4b\u73af\u5883\u5efa\u8bae\u8bbe\u4e3a1000\uff0c\u751f\u4ea7\u4e0a\u4ee5\u538b\u6d4b\u5b9e\u9645\u7ed3\u679c\u4e3a\u51c6\u518d\u505a\u8c03\u6574\u6216\u8005\u4e5f\u4e0d\u8c03\u6574\uff1b * forceSync=no\uff0c\u8be5\u53c2\u6570\u6709\u9ed8\u8ba4\u503c\uff1ayes\uff0c\u53ef\u4ee5\u4e0d\u914d\u7f6e\uff0c\u53ef\u9009\u914d\u7f6e\u9879\u4e3a\u201cyes\u201d\u548c\u201cno\u201d\uff0c\u4ec5\u652f\u6301\u7cfb\u7edf\u5c5e\u6027\u65b9\u5f0f\u914d\u7f6e\uff1azookeeper.forceSync\u3002 </p> <p>\u8be5\u53c2\u6570\u7528\u4e8e\u914d\u7f6eZooKeeper\u670d\u52a1\u5668\u662f\u5426\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u5c06\u65e5\u5fd7\u5199\u5165\u64cd\u4f5c\u5f3a\u5236\u5237\u5165\u78c1\u76d8\uff08\u5373\u8c03\u7528java.nio.channels.FileChannel.force\u63a5\u53e3\uff09\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u201cyes\u201d\uff0c\u5373\u6bcf\u6b21\u4e8b\u52a1\u65e5\u5fd7\u5199\u5165\u64cd\u4f5c\u90fd\u4f1a\u5b9e\u65f6\u5237\u5165\u78c1\u76d8\u3002\u5982\u679c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u201cno\u201d\uff0c\u5219\u80fd\u4e00\u5b9a\u7a0b\u5ea6\u7684\u63d0\u9ad8ZooKeeper\u7684\u5199\u6027\u80fd\uff0c\u4f46\u540c\u65f6\u4e5f\u4f1a\u5b58\u5728\u7c7b\u4f3c\u4e8e\u673a\u5668\u65ad\u7535\u8fd9\u6837\u7684\u5b89\u5168\u98ce\u9669\u3002\u5728\u6b64\u5904\u6211\u662f\u5efa\u8bae\u8bbe\u6210no\uff0c\u5b83\u4f1a\u76f4\u63a5\u5e26\u6765zk\u7fa4\u7684\u6027\u80fd\u63d0\u5347\u3002\u6211\u4eec\u7684zk\u76ee\u524d\u770b\u6765\u6682\u65e0\u4e8b\u65e0\u63d0\u4ea4\uff0c\u6709\u4e00\u4e9b\u62ffzk\u505a\u201ctcc\u6216\u8005\u662f2pC\u63d0\u4ea4\u201d\u7684global transaction\u4e00\u7c7b\u7684\u662f\u4f1a\u7528\u5230zk\u4e8b\u52a1\u7684\uff0c\u6211\u4eec\u7684\u73af\u5883\u6682\u65e0\u56e0\u6b64\u6b64\u503c\u8bbe\u6210no\uff0c\u589e\u52a0\u5176\u8bfb\u5199\u901f\u5ea6\uff1b</p>","tags":["zookeeper","tuning","performance"]},{"location":"bigdata/zookeeper-optimize/#zk1","title":"zk1","text":"<pre><code># The number of milliseconds of each tick\n#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)\ntickTime=5000\n# The number of ticks that the initial\n# synchronization phase can take\n# floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236\n#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570\ninitLimit=50\n# The number of ticks that can pass between\n# sending a request and getting an acknowledgement\nsyncLimit=6\ndataDir=/Users/chrishu123126.com/opt/zookeeper/data/zk1\ndataLogDir=/Users/chrishu123126.com/opt/zookeeper/logs/zk1\nclientPort=2181\nserver.1=localhost:2187:2887\nserver.2=localhost:2188:2888\nserver.3=localhost:2189:2889\n#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49\nleaderServes=no\nmaxClientCnxns=1000\nforceSync=no\n</code></pre>","tags":["zookeeper","tuning","performance"]},{"location":"bigdata/zookeeper-optimize/#zk2","title":"zk2","text":"<pre><code># The number of milliseconds of each tick\n#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)\ntickTime=5000\n# The number of ticks that the initial\n# synchronization phase can take\n# floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236\n#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570\ninitLimit=50\n# The number of ticks that can pass between\n# sending a request and getting an acknowledgement\nsyncLimit=6\ndataDir=/Users/chrishu123126.com/opt/zookeeper/data/zk2\ndataLogDir=/Users/chrishu123126.com/opt/zookeeper/logs/zk2\nclientPort=2182\nserver.1=localhost:2187:2887\nserver.2=localhost:2188:2888\nserver.3=localhost:2189:2889\n#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49\nleaderServes=no\nmaxClientCnxns=1000\nforceSync=no\n</code></pre>","tags":["zookeeper","tuning","performance"]},{"location":"bigdata/zookeeper-optimize/#zk3","title":"zk3","text":"<pre><code># The number of milliseconds of each tick\n#zk\u65f6\u95f4\u5355\u5143(\u6beb\u79d2)\ntickTime=5000\n# The number of ticks that the initial\n# synchronization phase can take\n# floower\u542f\u52a8\u8fc7\u7a0b\u4e2d\u4eceleader\u540c\u90e8\u6570\u636e\u7684\u65f6\u95f4\u9650\u5236\n#\u5982\u679c\u96c6\u7fa4\u89c4\u6a21\u5927\uff0c\u6570\u636e\u91cf\u591a\u7684\u8bdd\uff0c\u9002\u5f53\u8c03\u5927\u6b64\u53c2\u6570\ninitLimit=50\n# The number of ticks that can pass between\n# sending a request and getting an acknowledgement\nsyncLimit=6\ndataDir=/Users/chrishu123126.com/opt/zookeeper/data/zk3\ndataLogDir=/Users/chrishu123126.com/opt/zookeeper/logs/zk3\nclientPort=2183\nserver.1=localhost:2187:2887\nserver.2=localhost:2188:2888\nserver.3=localhost:2189:2889\n#leader\u4e0d\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5,\u4e13\u6ce8\u4e8e\u901a\u4fe1\u548c\u9009\u4e3e\u7b49\nleaderServes=no\nmaxClientCnxns=1000\nforceSync=no\n</code></pre>","tags":["zookeeper","tuning","performance"]},{"location":"bigdata/zookeeper-optimize/#zk","title":"zk\u7fa4\u201c\u56db\u5b57\u201d\u771f\u8a00","text":"<ol> <li><code>echo stat|nc 127.0.0.1 2181</code> \u6765\u67e5\u770b\u54ea\u4e2a\u8282\u70b9\u88ab\u9009\u62e9\u4f5c\u4e3afollower\u6216\u8005leader</li> <li><code>echo ruok|nc 127.0.0.1 2181</code> \u6d4b\u8bd5\u662f\u5426\u542f\u52a8\u4e86\u8be5Server\uff0c\u82e5\u56de\u590dimok\u8868\u793a\u5df2\u7ecf\u542f\u52a8\u3002</li> <li><code>echo dump| nc 127.0.0.1 2181</code> ,\u5217\u51fa\u672a\u7ecf\u5904\u7406\u7684\u4f1a\u8bdd\u548c\u4e34\u65f6\u8282\u70b9\u3002</li> <li><code>echo kill | nc 127.0.0.1 2181</code> ,\u5173\u6389server</li> <li><code>echo conf | nc 127.0.0.1 2181</code> ,\u8f93\u51fa\u76f8\u5173\u670d\u52a1\u914d\u7f6e\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li> <li><code>echo cons | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u6240\u6709\u8fde\u63a5\u5230\u670d\u52a1\u5668\u7684\u5ba2\u6237\u7aef\u7684\u5b8c\u5168\u7684\u8fde\u63a5 / \u4f1a\u8bdd\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li> <li><code>echo envi |nc 127.0.0.1 2181</code> ,\u8f93\u51fa\u5173\u4e8e\u670d\u52a1\u73af\u5883\u7684\u8be6\u7ec6\u4fe1\u606f\uff08\u533a\u522b\u4e8e conf \u547d\u4ee4\uff09\u3002</li> <li><code>echo reqs | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u672a\u7ecf\u5904\u7406\u7684\u8bf7\u6c42\u3002</li> <li><code>echo wchs | nc 127.0.0.1 2181</code> ,\u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li> <li><code>echo wchc | nc 127.0.0.1 2181</code> ,\u901a\u8fc7 session \u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5b83\u7684\u8f93\u51fa\u662f\u4e00\u4e2a\u4e0e watch \u76f8\u5173\u7684\u4f1a\u8bdd\u7684\u5217\u8868\u3002</li> <li><code>echo wchp | nc 127.0.0.1 2181</code> ,\u901a\u8fc7\u8def\u5f84\u5217\u51fa\u670d\u52a1\u5668 watch \u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u5b83\u8f93\u51fa\u4e00\u4e2a\u4e0e session \u76f8\u5173\u7684\u8def\u5f84\u3002</li> </ol>","tags":["zookeeper","tuning","performance"]},{"location":"courses/commands-in-sbin/","title":"Linux \u547d\u4ee4\u5b66\u4e60","text":"<p>\u8fd9\u5176\u5b9e\u5f88\u65e9\u5f88\u65e9\u524d\u6211\u5728\u81ea\u5df1\u535a\u5ba2\u4e0a\u8d34\u7684\u5185\u5bb9\u4e86\uff0c\u662f\u6211 2007 \u5e74 1 \u6708\u5f00\u59cb\u5230\u5f53\u5e74 7 \u6708\uff0c\u534a\u5e74\u591a\u7684\u65f6\u95f4\u7cfb\u7edf\u5b66\u4e60 Linux \u4e0b <code>/sbin</code> \u4ee5\u53ca <code>/usr/sbin/</code> \u7684\u6bcf\u4e2a\u547d\u4ee4\uff0c\u8fd9\u4e2a\u7684\u7f18\u8d77\u8fd8\u662f\u4e4b\u524d\u5728 2007 \u5e74\u7684\u65f6\u5019\uff0c\u82e6\u4e8e\u81ea\u5df1\u5bf9 Linux \u6df1\u5165\u5b66\u4e60\u8fdb\u5165\u4e86\u4e00\u4e2a\u74f6\u9888\uff0c\u4e0d\u77e5\u9053\u4ece\u90a3\u4e2a\u65b9\u9762\u53ef\u4ee5\u5165\u624b\uff0c\u4e8e\u662f\u53bb\u8bf7\u6559\u5f53\u65f6\u516c\u53f8\u7684 Linux \u5185\u6838\u7814\u53d1\u7ecf\u7406\uff0c\u5e94\u8be5\u4ece\u54ea\u91cc\u65b9\u9762\u5165\u624b\uff0c\u4ed6\u56de\u7b54\u8bf4\uff0c\u4ed6\u4e4b\u524d\u5728 Linux \u4f0a\u7538\u56ed\uff08\u77e5\u9053\u8fd9\u4e2a\u8bba\u575b\u7684\u4f30\u8ba1\u5e74\u7ea7\u90fd\u4e0d\u5c0f\u4e86\uff09\u4e0a\u540d\u4e3a <code>nntp</code> \u7684\u7248\u4e3b\u8bf4\uff0c\u4e00\u4e2a\u4f18\u79c0\u7684 Linux \u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u90fd\u5e94\u8be5\u8ba4\u771f\u5b66\u4e60<code>/sbin/</code> <code>/usr/sbin</code> \u4e0b\u7684\u6240\u6709\u547d\u4ee4\uff0c\u4f60\u53ef\u4ee5\u4ece\u8fd9\u91cc\u5165\u624b\u3002</p> <p>\u4e4b\u524d\u662f\u5206\u7c7b\u8bb0\u5f55\u7684\uff0c\u73b0\u5728\u6211\u628a\u4ed6\u6574\u7406\u5728\u4e00\u5757\uff0c\u8fd9\u4e9b\u547d\u4ee4\u8fd8\u662f\u57fa\u4e8e RedHat Enterprise 5.0 \uff0c\u5df2\u7ecf\u5f88\u53e4\u8001\u4e86\uff0c\u4e0d\u8fc7\u5f88\u591a\u547d\u4ee4\u4e5f\u5f88\u4e45\u6ca1\u6709\u66f4\u65b0\u4e86\uff0c\u6240\u4ee5\u7528\u6cd5\u4e00\u76f4\u4fdd\u7559\u4e86\u4e0b\u6765\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-a","title":"/sbin \u4e0b a \u5f00\u5934\u7684\u547d\u4ee4","text":"<p><code>/sbin</code> \u4e0b a \u5f00\u5934\u7684\u547d\u4ee4\u5e76\u4e0d\u591a\uff0c\u5927\u6982\u662f\u8fd9\u4e9b</p> <p>accton adsl-setup adsl-stop arping auditd addpart adsl-start agetty asianux-support-check adsl-connect adsl-status arp auditctl</p> <p>\u5176\u4e2d adsl \u5f00\u5934\u7684\u547d\u4ee4\u5360\u4e86\u4e00\u534a\u3002</p> <p>\u5206\u522b\u7b80\u5355\u4ecb\u7ecd\uff1a</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#accton","title":"accton","text":"<p>\u6253\u5f00\u6216\u8005\u5173\u95ed\u8fdb\u7a0b\u7edf\u8ba1\uff08account)\uff0c\u5982\u679c\u4e0d\u52a0\u4efb\u4f55\u53c2\u6570\uff0c\u7f3a\u7701\u7684\u60c5\u51b5\u4e0b\u662f\u5173\u95ed\u8fdb\u7a0b\u7edf\u8ba1\u3002</p> <p>\u8981\u7406\u89e3\u8fd9\u4e2a\u547d\u4ee4\uff0c\u5c31\u9700\u8981\u770b\u770b\u5176\u4ed6\u51e0\u4e2a\u547d\u4ee4\u4e86\u3002 \u9996\u5148\u6211\u4eec\u770b\u770b accton \u5c5e\u4e8e\u54ea\u4e2a\u5305</p> <pre><code># rpm -qf accton\npsacct-6.3.2-35.rhel4\n# rpm -qi psacct\n....\nDescription :\nThe psacct package contains several utilities for monitoring process\nactivities, including ac, lastcomm, accton and sa. The ac command\ndisplays statistics about how long users have been logged on. The\nlastcomm command displays information about previous executed\ncommands. The accton command turns process accounting on or off. The\nsa command summarizes information about previously executed\ncommmands.\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u63cf\u8ff0\u6765\u770b\uff0c\u6211\u4eec\u77e5\u9053 accton \u4ee5\u53ca ac,lastcomm,sa \u90fd\u662f\u7528\u6765\u76d1\u63a7\u8fdb\u7a0b\u7684\u6d3b\u52a8\u6027\u7684\u3002</p> <p>\u5176\u4e2d ac \u547d\u4ee4\u663e\u793a\u67d0\u4e2a\u7528\u6237\u5df2\u7ecf\u767b\u5f55\u591a\u4e45\u4e86\uff08\u5355\u4f4d\u662f\u5c0f\u65f6\uff09\uff0c\u6bd4\u5982</p> <pre><code># ac root\n\ntotal 9.13\n\n# ac mlsx\n\ntotal 0.00\n# ac -d\nJan 11 total 0.98\nJan 12 total 0.49\nJan 13 total 1.79\nJan 15 total 3.97\nJan 16 total 0.03\nJan 22 total 1.60\nToday total 0.54\n\n# ac \u2013-reboots\ntotal 28.81\n</code></pre> <p>ac \u53ef\u4ee5\u63a5\u53d7\u7684\u53c2\u6570\u7684\u5e76\u4e0d\u662f\u5f88\u591a\uff0c\u800c\u4e14\u4e5f\u6bd4\u8f83\u5bb9\u6613\u7406\u89e3\u3002\u53ea\u662f\u8fd9\u4e2a <code>reboots</code> \u6211\u6709\u70b9\u4e0d\u597d\u7406\u89e3\u4ed6\uff0c\u6682\u65f6\u6211\u7684\u7406\u89e3\u662f\u672c\u6b21\u8fdb\u5165\u7cfb\u7edf\u4e8e\u4e0a\u6b21\u8fdb\u5165\u7cfb\u7edf\u7684\u65f6\u95f4\u5dee\uff08\u5c0f\u65f6\uff09\uff0c\u4e5f\u5c31\u662f\u6700\u8fd1\u4e24\u6b21\u8fdb\u5165\u7cfb\u7edf\u7684\u65f6\u95f4\u95f4\u9694\u3002 \u800c <code>lastcomm</code> \u5219\u663e\u793a\u4e4b\u524d\u6267\u884c\u7684\u90a3\u4e9b\u547d\u4ee4\u7684\u4fe1\u606f\u3002</p> <pre><code># lastcomm | head\nlastcomm S X root pts/0 0.29 secs Wed Jan 24 21:38\nscim-helper-lau SF root __ 4.26 secs Wed Jan 24 21:37\nscim-helper-lau S root __ 0.01 secs Wed Jan 24 21:37\nac S root pts/1 0.00 secs Wed Jan 24 21:35\nac S root pts/1 0.00 secs Wed Jan 24 21:35\nac S root pts/1 0.00 secs Wed Jan 24 21:35\nac S root pts/1 0.00 secs Wed Jan 24 21:35\ncrond SF root __ 0.00 secs Wed Jan 24 21:35\nmrtg S root __ 0.83 secs Wed Jan 24 21:35\nac S root pts/1 0.00 secs Wed Jan 24 21:34\n</code></pre> <p>\u8fd9\u91cc\u4e9b\u5217\u5206\u522b\u8868\u793a\u547d\u4ee4\u7684\u540d\u79f0\uff0c\u6807\u8bc6\uff0c\u6267\u884c\u5e10\u53f7\uff0c\u6267\u884c\u7ec8\u7aef\uff0c\u5df2\u7ecf\u7a0b\u5e8f\u9000\u51fa\u7684\u65f6\u95f4\u3002 \u5176\u4e2d\u8868\u793a\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <ul> <li>S: \u8be5\u547d\u4ee4\u7531\u8d85\u7ea7\u7528\u6237\u6267\u884c\u3002</li> <li>F: \u547d\u4ee4\u662f\u5728 fork \u540e\u6267\u884c\u7684\uff0c\u4f46\u662f\u63a5\u4e0b\u6765\u6ca1\u6709\u6267\u884c exec</li> <li>C: \u547d\u4ee4\u8fd0\u884c\u5728 PDP\uff0d11 \u517c\u5bb9\u6a21\u5f0f\u4e0b\uff08\u8fd9\u4e2a\u5411\u4e0b\u517c\u5bb9\u4e5f\u592a\u957f\u65f6\u95f4\u4e86\u5427\uff09</li> <li>D: \u547d\u4ee4\u4e2d\u65ad\uff0c\u4e14\u4ea7\u751f\u4e86 core \u6587\u4ef6\u3002</li> <li>X: \u547d\u4ee4\u53d7\u5230 SIGTERM \u4fe1\u53f7\u800c\u4e2d\u65ad</li> </ul> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u4e9b\u4fe1\u606f\u662f\u5426\u5b58\u5728\u5c31\u770b accton \u7684\u547d\u4ee4\u64cd\u4f5c\u4e86\uff0c\u5982\u679c\u4ed6\u5173\u95ed\u8fdb\u7a0b\u4fe1\u606f\u7edf\u8ba1\uff0c\u90a3\u4e48\u8fd9\u4e9b\u547d\u4ee4\u5c31\u65e0\u6cd5\u5f97\u5230\u4e0a\u8ff0\u4fe1\u606f\u3002 \u51fa\u4e86\u8fd0\u884c accton \u547d\u4ee4\u5916\uff0c\u4e5f\u4f7f\u7528\u4f7f\u7528</p> <p><code>/etc/init.d/psacct [start|stop]</code></p> <p>\u5f00\u542f\u6216\u8005\u505c\u6b62\u8fdb\u7a0b\u4fe1\u606f\u7edf\u8ba1\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#adsl-","title":"adsl-*","text":"<p>\u8fd9\u4e9b\u547d\u4ee4\u4e00\u770b\u5c31\u77e5\u9053\u662f\u4e0e ADSL \u6709\u5173\u7684\u3002</p> <p><code>adsl-setup</code> \u7528\u6765\u8bbe\u7f6e\u5bf9\u5e94\u7684\u4fe1\u606f\uff0c\u91c7\u7528\u4ea4\u4e92\u6a21\u5f0f\uff0c\u975e\u5e38\u7684\u50bb\u74dc\u5316\u3002</p> <p><code>adsl-connect</code> \u662f\u7ba1\u7406\u4e00\u4e2a PPPoE \u8fde\u63a5\u7684\u547d\u4ee4\u3002</p> <p><code>adsl-start</code> \u5f00\u59cb\u62e8\u53f7 <code>adsl-stop</code> \u65ad\u5f00 <code>adsl-status</code> \u67e5\u770b\u72b6\u6001</p> <p>\u8fd9\u91cc ADSL \u7684\u8bbe\u7f6e\u548c windows \u4e0b\u6709\u4e00\u4e2a\u5c0f\u7684\u533a\u522b\uff0c\u90a3\u5c31\u662f windows \u662f\u81ea\u52a8\u83b7\u53d6 DNS \u7684\uff0c\u4f46\u662f\u5728 Linux \u5374\u4e0d\u662f\u8fd9\u6837\uff0c\u56e0\u6b64\u4f60\u8981\u5148\u586b\u5199 DNS \u5730\u5740\u624d\u80fd\u6b63\u5e38\u4e0a\u7f51\u3002</p> <p><code>agetty</code> alternative Linux getty\uff0c\u4e00\u4e2a Linux \u4e0b getty \u7a0b\u5e8f\u7684\u66ff\u6362\u8005\u3002\u4e00\u822c\u4e0d\u624b\u5de5\u6267\u884c\u3002</p> <p><code>arp</code>,<code>arping</code> \u4e0e ARP \u76f8\u5173\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u6e05\u7a7a ARP \u8868\uff0c\u5237\u65b0 ARP \u8868\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u5728\u9ad8\u53ef\u7528\u7684\u73af\u5883\u4e0b\u53ef\u4ee5\u5f97\u5230\u91cd\u7528\u3002</p> <p><code>auditctl</code>,<code>auditd</code> \u5ba1\u8ba1\u7a0b\u5e8f\uff0c\u6309\u7167 RPM \u5305\u7684\u8bf4\u660e\uff0c\u4ed6\u4eec\u7684\u4e3b\u8981\u7528\u5904\u662f\u5b58\u50a8\u548c\u5904\u7406\u6709\u5185\u6838\u5ba1\u8ba1\u5b50\u7cfb\u7edf\u4ea7\u751f\u7684\u5ba1\u8ba1\u8bb0\u5f55\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-b","title":"/sbin \u4e0b b \u5f00\u59cb\u7684\u547d\u4ee4","text":"","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#badblocks","title":"badblocks","text":"<p>\u5bf9\u6307\u5b9a\u7684\u8bbe\u5907\u627e\u51fa\u574f\u5757,\u4ed6\u63a5\u53d7\u7684\u53c2\u6570\u4e0d\u662f\u592a\u591a\uff0c\u4f60\u53ef\u4ee5\u6307\u5b9a\u5f00\u59cb\u5757\u4e5f\u7ed3\u675f\u5757\u3002\u8fd8\u80fd\u7528 <code>-f</code> \u6765\u6307\u5b9a\u662f\u5426\u9700\u8981\u5bf9\u67e5\u627e\u7684\u5206\u533a\u8fdb\u884c\u4fee\u590d\uff0c\u4e0d\u8fc7\u5728 man \u4e2d\u5bf9 <code>-f</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u63cf\u8ff0\u662f\uff0c \u6c38\u8fdc\u90fd\u4e0d\u8981\u4f7f\u7528 <code>-f</code>\uff0c\u9664\u975e\u4f60\u6bd4\u8fd9\u4e2a\u547d\u4ee4\u66f4\u806a\u660e\u3002</p> <pre><code>]# badblocks /dev/hda5\n</code></pre> <p>man \u624b\u518c\u4e2d\u63d0\u5230\u4e00\u822c\u4e0d\u8981\u76f4\u63a5\u6267\u884c badblocks \u547d\u4ee4\uff0c\u800c\u662f\u5e94\u8be5\u7528 <code>e2fsck</code> \u547d\u4ee4\u7684 <code>\uff0dc</code> \u53c2\u6570\u6765\u81ea\u52a8\u8c03\u7528 <code>badblocks</code> \u547d\u4ee4\uff0c\u4ed6\u4f1a\u67e5\u627e\u574f\u5757\u5e76\u6807\u8bb0\u8d77\u6765\uff0c\u4ee5\u4fbf\u4e0b\u6b21\u5b58\u50a8\u6570\u636e\u65f6\uff0c\u4e0d\u4f1a\u5b58\u50a8\u5728\u8fd9\u4e9b\u574f\u5757\u4e0a\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#blkid","title":"blkid","text":"<p>\u7528\u6765\u5b9a\u4f4d\u6216\u8005\u6253\u5370\u5757\u8bbe\u5907\u5c5e\u6027\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u4ed6\u4e00\u822c\u548c libuuid(3) \u7a0b\u5e8f\u5e93\u4e00\u8d77\u4f7f\u7528\u3002\u4ed6\u53ef\u4ee5\u63a8\u6d4b\u51fa\u4e00\u4e2a\u5757\u8bbe\u5907\u5185\u5bb9\u7684\u7c7b\u578b\uff08\u6bd4\u5982\u662f\u6587\u4ef6\u7cfb\u7edf\uff0c\u662f swap\uff09\u548c\u5176\u4ed6\u5c5e\u6027\u3002</p> <pre><code># blkid /dev/hda5\n     /dev/hda5: LABEL=\"/\" UUID=\"74e3bf86-ce24-411d-ac35-c4bc49964f36\" SEC_TYPE=\"ext3\" TYPE=\"ext2\"\n# blkid /dev/hda1 /dev/hda1: UUID=\"6C2B-F039\" TYPE=\"vfat\"\n</code></pre> <p>UUID \u5728 RAID \u548c LVM \u4e2d\u6709\u6bd4\u8f83\u5e7f\u6cdb\u7684\u4f7f\u7528\uff0c\u5728 RAID \u4e2d\uff0c\u5bfb\u627e\u67d0\u4e00\u4e2a\u8bbe\u5907\u6216\u8005\u5206\u533a\u4e0d\u662f\u6839\u636e\u4f60\u7684\u8bbe\u5907\u53f7\uff08\u6bd4\u5982 hda3\uff09\uff0c\u4e5f\u4e0d\u662f\u6807\u7b7e\uff08\u6bd4\u5982 <code>/HOME</code>)\uff0c\u56e0\u4e3a\u624b\u5de5\u521b\u5efa\u7684\u5206\u533a\u9ed8\u8ba4\u6ca1\u6709\u6807\u7b7e\uff0c\u800c\u662f\u6839\u636e UUID \u53f7\uff0c\u6bd4\u5982\u4f60\u7684\u7b2c\u4e00\u4e2a SCSI \u8bbe\u5907\u56e0\u4e3a\u69fd\u4f4d\u7684\u53d8\u5316\uff0c\u90a3\u4e48\u5728 linux \u4e2d\u8bbe\u5907\u597d\u4e5f\u53d1\u751f\u4e86\u53d8\u5316\uff08\u6bd4\u5982\u4ece sda \u53d8\u6210 sdb)\uff0c\u4f46\u662f\u7cfb\u7edf\u4f9d\u7136\u80fd\u591f\u8bc6\u522b\u51fa\u6765\u3002</p> <p>\u800c\u69fd\u4f4d\u7684\u6539\u53d8\u5728\u670d\u52a1\u5668\u4e0a\u5f88\u5bb9\u6613\u53d1\u751f\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u90fd\u662f\u652f\u6301\u70ed\u63d2\u62d4\u7684\u3002\u5728 LVM \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u4f60\u66f4\u80fd\u975e\u5e38\u6e05\u695a\u7684\u770b\u5230 UUID \u53f7\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#blockdev","title":"blockdev","text":"<p>\u5728\u547d\u4ee4\u884c\u8c03\u7528\u8bbe\u5907\u7684 <code>ioctl</code> \u51fd\u6570\u3002\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c\u4f3c\u4e4e\u5bf9\u8bbe\u5907\u7684\u76f4\u63a5\u64cd\u4f5c\u53ea\u6709 <code>ioctl</code> \u51fd\u6570\u4e86\u3002\u4ed6\u63a5\u53d7\u7684\u53c2\u6570\u4e0d\u662f\u592a\u591a\uff0c\u800c\u4e14\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u3002</p> <pre><code>--setro \u8bbe\u7f6e\u8bbe\u5907\u4e3a\u53ea\u8bfb\n--getro \u8bfb\u53d6\u8bbe\u5907\u662f\u5426\u4e3a\u53ea\u8bfb\uff08\u6210\u529f\u4e3a 1\uff0c0 \u5219\u4e3a\u53ef\u8bfb\u5199\uff09\n--setrw \u8bbe\u7f6e\u8bbe\u522b\u4e3a\u53ef\u8bfb\u5199\n--getss \u6253\u5370\u8bbe\u5907\u7684\u6247\u533a\u5927\u5c0f\uff0c\u901a\u5e38\u662f 512\n--getsize \u6253\u5370\u8bbe\u522b\u7684\u5bb9\u91cf\uff0c\u6309\u7167\u4e00\u4e2a\u6247\u533a 512 \u4e2a\u5b57\u8282\u8ba1\u7b97\n--setra N Set readahead to N 512-byte sectors.\n--getra \u6253\u5370 readahead\n--flushbufs \u5237\u65b0\u7f13\u51b2\n--rereadpt \u91cd\u8bfb\u5206\u533a\u8868\u3002\n</code></pre> <p>\u4e2a\u4eba\u89c9\u5f97 <code>--setro</code>, <code>--setrw</code> \u6bd4\u8f83\u6709\u7528\uff0c\u8fd9\u4e2a <code>mount -o ro(rw)</code>\u662f\u6709\u533a\u522b\u7684\uff0cmount \u662f\u5728\u6587\u4ef6\u7cfb\u7edf\u8fd9\u4e2a\u7ea7\u522b\u4e0a\u5bf9\u67d0\u4e2a\u5206\u533a\u6302\u8f7d\u4e3a\u53ea\u8bfb\u6216\u53ef\u8bfb\u5199\u3002</p> <p>\u800c blockdev \u5219\u662f\u5728\u8bbe\u522b\u8fd9\u4e2a\u7ea7\u522b\u4e0a\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u548c\u53ef\u8bfb\u5199\u3002</p> <p>\u770b\u4e0b\u9762\u7684\u547d\u4ee4\u8f93\u51fa\u7ed3\u679c\u5c31\u4e00\u76ee\u4e86\u7136\u4e86\u3002</p> <pre><code># blockdev \u2013setro /dev/hda4\n# blockdev \u2013getro /dev/hda4\n    1\n# mount /dev/hda4 /misc -o rw\n    mount: block device /dev/hda4 is write-protected, mounting read-only\n# umount /dev/hda4\n# blockdev \u2013setrw /dev/hda4\n# blockdev \u2013getro /dev/hda4\n    0\n# mount /dev/hda4 /misc -o rw\n# touch /misc/one\n# umount /dev/hda4\n# mount /dev/hda4 /misc -o ro\n# rm -f /misc/one\n    rm: \u65e0\u6cd5\u5220\u9664\u2018/misc/one\u2019: \u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u5728\u9ad8\u53ef\u7528\u73af\u5883\u6bd4\u8f83\u5b9e\u7528\u3002\u6bd4\u5982\u7ea2\u65d7\u7684 HA \u4ea7\u54c1\u5c31\u4f7f\u7528\u4e86\u7c7b\u4f3c\u7684\u547d\u4ee4\u6765\u9632\u6b62\uff0c\u7ea2\u65d7 HA \u505c\u6b62\u65f6\uff0c\u4f1a\u81ea\u52a8\u5c06\u4ed6\u76d1\u7ba1\u7684\u8bbe\u5907\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\uff0c\u9632\u6b62\u7528\u6237\u7684\u6539\u5199\uff0c\u9664\u975e\u4f60\u624b\u5de5\u8bbe\u7f6e\u4e3a\u53ef\u8bfb\u5199\uff08\u7ea2\u65d7 HA \u4f7f\u7528\u4e86 <code>clproset</code> \u547d\u4ee4\uff0c\u5176\u4f5c\u7528\u5e94\u8be5\u548c\u8fd9\u4e2a\u5dee\u4e0d\u591a\uff09</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-c","title":"/sbin \u4e0b c \u5f00\u59cb\u7684\u547d\u4ee4","text":"<p>/sbin \u76ee\u5f55\u4e0b c \u5f00\u5934\u7684\u547d\u4ee4\u4e5f\u6ca1\u6709\u591a\u5c11\uff0c\u5217\u51fa\u5982\u4e0b</p> <p>cardctl cardmgr change_console chkconfig clock consoletype cryptsetup ctrlaltdel</p> <p>\u5176\u4e2d <code>clock</code> \u8fd8\u662f\u8f6f\u8fde\u63a5\u3002</p> <pre><code># ls -l clock\nlrwxrwxrwx 1 root root 7 9\u6708 7 12:07 clock -&gt; hwclock\n</code></pre> <p><code>cardctl</code> \u548c <code>cardmgr</code> \u662f\u5bf9 PCMCIA \u8bbe\u5907\u7684\u64cd\u4f5c\uff0c\u4e0d\u8fc7\u4f3c\u4e4e\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e24\u4e2a\u547d\u4ee4\u6765\u7ba1\u7406 PCMCIA \u8bbe\u522b\u7684\u673a\u4f1a\u5e94\u8be5\u5f88\u5c11\u3002\u4e00\u6765 PCMCIA \u63d2\u69fd\u53ea\u5728\u7b14\u8bb0\u672c\u4e0a\u6709\uff0c\u4e8c\u6765\u76ee\u524d Linux \u4e0b\u80fd\u652f\u6301\u7684 PCMCIA \u8bbe\u5907\u8fd8\u771f\u4e0d\u591a\uff0c\u4f3c\u4e4e\u9664\u4e86\u4e00\u4e9b\u65e0\u7ebf\u7f51\u5361\u548c\u5f88\u5c11\u7684\u65e0\u7ebf\u4e0a\u7f51\u5361\u652f\u6301\u5916\uff0c\u5176\u4ed6\u7684\u6211\u5c31\u4e0d\u6e05\u695a\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a\u547d\u4ee4\u6211\u6ca1\u7528\u8fc7\uff0c\u770b\u4e86 man \u624b\u518c\uff0c\u4e5f\u6ca1\u6709\u770b\u51fa\u540d\u5802\uff0c\u5ffd\u7565\u4e4b\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#change_console","title":"change_console","text":"<p>\u6539\u53d8\u7ec8\u7aef\uff0c\u8fd9\u4e2a\u547d\u4ee4\u662f init \u6765\u7528\u7684\uff0c\u6211\u600e\u4e48\u52a0\u53c2\u6570\u6765\u6267\u884c\uff0c\u4e5f\u6ca1\u6709\u770b\u51fa\u4ec0\u4e48\u53d8\u5316\uff0cman \u624b\u518c\u8bf4\u7684\u5f88\u5c11\uff0c\u5ffd\u7565\u4e4b\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#chkconfig","title":"chkconfig","text":"<p>\u66f4\u65b0\u548c\u67e5\u8be2\u7cfb\u7edf\u670d\u52a1\u7684\u8fd0\u884c\u7ea7\u522b\u4fe1\u606f\u3002\u6211\u4eec\u77e5\u9053\u5927\u90e8\u5206\u7684 Linux \u53d1\u884c\u7248\u672c\u90fd\u6709 0-6 \u5171 7 \u4e2a\u7ea7\u522b\u7684\u8fd0\u884c\u6a21\u5f0f\uff0c\u5148\u629b\u5f00\u5173\u673a\u7684 0 \u7ea7\u522b\u548c\u91cd\u542f\u7684 6 \u7ea7\u522b\uff0c\u90a3\u4e48\u5c31\u8fd8\u6709 1\uff0d5 \u5171 5 \u4e2a\u8fd0\u884c\u7ea7\u522b\uff0cLinux \u7cfb\u7edf\u5141\u8bb8\u4f60\u5b9a\u4e49\u5728\u4e0d\u52a8\u7684\u8fd0\u884c\u7ea7\u522b\u9ed8\u8ba4\u542f\u52a8\u4e0d\u52a8\u7684\u7cfb\u7edf\u670d\u52a1\u3002</p> <p>\u800c\u5b9e\u9645\u4e0a\u6240\u6709\u7684\u6267\u884c\u811a\u672c\u90fd\u662f\u5728<code>/etc/rc.d/init.d/</code>\u4e0b\u9762\u3002</p> <p>\u800c\u6bcf\u4e2a\u4e0d\u540c\u7ea7\u522b\u7684\u53ef\u4ee5\u8fd0\u884c\u7684\u7cfb\u7edf\u670d\u52a1\u5b9a\u4e49\u5728<code>/etc/rc.d/rc[0-6].d</code>\u91cc\uff0c\u91cc\u9762\u53ea\u6709\u8f6f\u8fde\u63a5\u3002\u8f6f\u8fde\u63a5\u5206\u6210\u4e86\u4e24\u79cd\u7c7b\u578b\uff0c\u4e00\u79cd\u662f K \u5f00\u59cb\u7684\u8f6f\u8fde\u63a5\uff0c\u4e00\u79cd\u662f S \u5f00\u5934\u7684\u8f6f\u8fde\u63a5\u3002\u5206\u522b\u8868\u793a\u9700\u8981\u505c\u6b62\u7684\u670d\u52a1\u548c\u542f\u52a8\u7684\u670d\u52a1\u3002</p> <p>\u5176\u4e2d\u542f\u52a8\u987a\u5e8f\u6709\u8fde\u63a5\u540d\u4e2d\u7684\u6570\u5b57\u51b3\u5b9a\uff0c\u6570\u5b57\u8d8a\u5c0f\uff0c\u542f\u52a8\u7684\u4f18\u5148\u7ea7\u5c31\u8d8a\u9ad8\u3002</p> <p>\u5f88\u663e\u7136\u5982\u679c\u8981\u6211\u4eec\u624b\u5de5\u6765\u7ba1\u7406\u8fd9\u4e9b\u8fde\u63a5\uff0c\u6050\u6015\u8868\u793a\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\u60c5\u3002\u4e5f\u662f <code>chkconfig</code> \u5c31\u51fa\u73b0\u4e86\u3002</p> <p>\u76ee\u524d Linux \u4e0b\u7684 <code>chkconfig</code> \u4e3b\u8981\u5b8c\u6210 5 \u4e2a\u65b9\u9762\u7684\u529f\u80fd\uff1a</p> <ol> <li>\u589e\u52a0\u53ef\u4ee5\u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1</li> <li>\u79fb\u8d70\u53ef\u4ee5\u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1</li> <li>\u5217\u51fa\u5f53\u524d\u670d\u52a1\u5668\u7684\u542f\u52a8\u4fe1\u606f</li> <li>\u6539\u53d8\u7cfb\u7edf\u670d\u52a1\u7684\u542f\u52a8\u4fe1\u606f</li> <li>\u68c0\u67e5\u7279\u5b9a\u670d\u52a1\u7684\u542f\u52a8\u72b6\u6001</li> </ol> <p>\u6211\u4eec\u4e3e\u4e00\u4e2a\u4f8b\u5b50\u9610\u8ff0\u4e0a\u9762\u7684 5 \u4e2a\u529f\u80fd</p> <p>\u5047\u8bbe\u6211\u4eec\u5199\u4e86\u4e00\u4e2a\u670d\u52a1\u7a0b\u5e8f\uff0c\u6211\u4eec\u5e0c\u671b\u50cf\u5176\u4ed6\u7cfb\u7edf\u670d\u52a1\u90a3\u6837\u53ef\u4ee5\u5b9a\u4e49\u4e0d\u540c\u7ea7\u522b\u7684\u542f\u52a8\u505c\u6b62\u65b9\u5f0f\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u7684\u52a0\u5165\u5230 <code>/etc/rc.d/rc.local</code> \u6587\u4ef6\u4e2d\u3002\u90a3\u4e48\u6211\u4eec\u9996\u5148\u8981\u521b\u5efa\u4e00\u4e2a\u8fd0\u884c\u811a\u672c\u653e\u5230 <code>/etc/rc.d/init.d</code> \u76ee\u5f55\u4e0b\uff0c\u5e76\u8bbe\u7f6e\u597d\u6743\u9650\u3002\u5982\u679c\u4f60\u4e0d\u77e5\u9053\u5982\u4f55\u4fee\u6539\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u8003\u53c2 <code>init.d</code> \u76ee\u5f55\u4e0b\u7684\u4efb\u4f55\u4e00\u4e2a\u8fd0\u884c\u811a\u672c\u3002\u4e0b\u9762\u7684\u662f\u6211\u7684\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u811a\u672c</p> <pre><code># cat /etc/rc.d/init.d/test\n#! /bin/sh\n#\n# test simple test system service for management by chkconfig\n#\n\n# Source function library.\n. /etc/rc.d/init.d/functions\n\n# Set defaults\n\nstart(){\n    echo -n \u201cStarting test: \u201d\n    /usr/local/bin/tmy start\n    RETAL=$?\n    echo\n}\n\nstop(){\n    echo -n \u201cStopping test: \u201d\n    /usr/local/bin/tmy stop\n    RETVAL=$?\n    echo\n}\n\nrestart(){\n    stop\n    start\n}\n\n# See how we were called.\ncase \u201c$1\u2033 in\n    start)\n    start\n    ;;\n    stop)\n    stop\n    ;;\n*)\necho \u201cUsage: test {start|stop|}\u201d\nRETVAL=1\nesac\n\nexit $RETVAL\n</code></pre> <pre><code># cat /usr/local/bin/tmy\n#!/bin/bash\nif [ $1 = \u201cstart\u201d ];then\necho \u201chave started my services\u201d\nelif [ $1 = \u201cstop\u201d ]; then\necho \u201chave stoped myservices\u201d\nfi\nexit 0\n</code></pre> <p>\u73b0\u5728\u4f60\u53ef\u4ee5\u4f7f\u7528<code>/etc/init.d/test start|stop</code>\u7684\u65b9\u5f0f\u542f\u52a8\u8fd9\u4e2a\u670d\u52a1\u3002\u4f46\u662f</p> <p><code>chkconfig --list test test</code> \u670d\u52a1\u4e0d\u652f\u6301 chkconfig</p> <p>\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u628a\u8fd9\u4e2a\u670d\u52a1\u5668\u52a0\u5165\u5230\u53ef\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u5728\u6267\u884c\u811a\u672c\u4e2d\u52a0\u5165\u4e24\u884c\u8ba9 chkconfig \u8bc6\u522b\u7684\u6ce8\u91ca</p> <pre><code># chkconfig:2345 20 80\n# description: test simple test system service for management by chkconfig\n</code></pre> <p>\u8fd9\u4e24\u884c\u6ce8\u91ca\u662f\u544a\u8bc9 <code>chkconfig</code> \u547d\u4ee4\uff0c\u8fd9\u811a\u672c\u5e94\u8be5\u5728 2\uff0c3\uff0c4\uff0c5 \u8fd9 4 \u4e2a\u7ea7\u522b\u542f\u52a8\uff0c\u4e14\u542f\u52a8\u4f18\u5148\u7ea7\u662f 20\uff0c\u800c\u5bf9\u5e94\u7684\u505c\u6b62\u4f18\u5148\u7ea7\u662f 80\u3002 \u52a0\u5165\u540e\uff0c\u6211\u4eec\u518d\u8bd5\u8bd5 chkconfig \u547d\u4ee4</p> <pre><code># chkconfig --list test\ntest \u670d\u52a1\u652f\u6301 chkconfig\uff0c\u4f46\u5b83\u5728\u4efb\u4f55\u7ea7\u522b\u4e2d\u90fd\u6ca1\u6709\u88ab\u5f15\u7528(\u8fd0\u884c\u201cchkconfig --add test\u201d)\n</code></pre> <p>\u6069\uff0c\u81f3\u5c11 chkconfig \u8ba4\u8bc6\u51fa\u4e86 test\uff0c\u800c\u4e14\u4e5f\u8bf4\u4e86\u53ef\u4ee5\u88ab\u7ba1\u7406\uff0c\u53ea\u662f\u6ca1\u6709\u52a0\u5165\u3002</p> <p>\u6839\u636e\u63d0\u793a\uff0c\u6211\u4eec\u9700\u8981\u52a0\u5165\u4ed6</p> <pre><code># chkconfig --add test\n# echo $?\n0\n# chkconfig --list test test\n    0:\u5173\u95ed 1:\u5173\u95ed 2:\u542f\u7528 3:\u542f\u7528 4:\u542f\u7528 5:\u542f\u7528 6:\u5173\u95ed\n</code></pre> <p>\u8fd9\u548c\u6211\u4eec\u671f\u671b\u7684\u662f\u4e00\u6837\u7684\u3002\u7136\u540e\u6211\u4eec\u770b\u770b test \u8f6f\u8fde\u63a5</p> <pre><code># ls -l /etc/rc.d/rc6.d/K80test\nlrwxrwxrwx 1 root root 14 1\u6708 27 20:47 /etc/rc.d/rc6.d/K80test -&gt; ../init.d/test\n# ls -l /etc/rc.d/rc3.d/S20test\nlrwxrwxrwx 1 root root 14 1\u6708 27 20:47 /etc/rc.d/rc3.d/S20test -&gt; ../init.d/test\n</code></pre> <p>\u5230\u6b64\uff0ctest \u670d\u52a1\u5df2\u7ecf\u52a0\u5165\u4e86\u53ef\u88ab chkconfig \u7ba1\u7406\u7684\u7cfb\u7edf\u670d\u52a1\u8303\u56f4\u5185\u3002\u90a3\u4e48\u6211\u4eec\u4e8b\u5b9e\u4fee\u6539\u548c\u5220\u9664\u770b\u770b\u3002</p> <pre><code># chkconfig --list test test\n0:\u5173\u95ed 1:\u5173\u95ed 2:\u542f\u7528 3:\u542f\u7528\n4:\u542f\u7528 5:\u542f\u7528 6:\u5173\u95ed\n# chkconfig --level 3 test off\n# chkconfig --list test test\n0:\u5173\u95ed 1:\u5173\u95ed 2:\u542f\u7528 3:\u5173\u95ed     4:\u542f\u7528 5:\u542f\u7528 6:\u5173\u95ed\n# ls -l /etc/rc.d/rc3.d/K80test\nlrwxrwxrwx 1 root root 14 1\u6708 27 20:54 /etc/rc.d/rc3.d/K80test -&gt;    ../init.d/test\n# chkconfig --del test\n# chkconfig --list test\ntest \u670d\u52a1\u652f\u6301 chkconfig\uff0c\u4f46\u5b83\u5728\u4efb\u4f55\u7ea7\u522b\u4e2d\u90fd\u6ca1\u6709\u88ab\u5f15\u7528(\u8fd0\u884c\u201cchkconfig --add test\u201d)\n</code></pre> <p>\u5982\u679c\u8981\u5f7b\u5e95\u5220\u9664 test \u670d\u52a1\uff0c\u90a3\u4e48\u5c31\u53ea\u8981\u5220\u9664 test \u6267\u884c\u811a\u672c\u5c31\u884c\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#consoletype","title":"consoletype","text":"<p>\u6253\u5370\u8fde\u63a5\u5230\u6807\u6ce8\u8f93\u5165\u7684\u7ec8\u7aef\u7c7b\u578b\uff1b\u8fd9\u662f Asianux \u7279\u6709\u7684\u547d\u4ee4\uff0c\u4ed6\u6839\u636e\u7ec8\u7aef\u7684\u4e0d\u540c\u7c7b\u578b\u6253\u5370\u51fa\u4e0d\u540c\u7684\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u662f\u865a\u62df\u7ec8\u7aef(/dev/tty* \u6216\u8005\u4e0d\u662f\u4e32\u884c\u7ec8\u7aef\u7684<code>/dev/console</code>)\uff0c\u6253\u5370\u51fa vt</p> <p>\u5982\u679c\u6807\u51c6\u8f93\u5165\u662f\u4e32\u884c\u7ec8\u7aef(<code>/dev/console</code> \u548c\u6216\u8005<code>/dev/ttyS*</code>)\uff0c\u6253\u5370 serial</p> <p>\u5982\u679c\u6807\u51c6\u8f93\u5165\u662f\u4f2a\u7ec8\u7aef\uff08<code>/dev/pts/\\*</code>)\uff0c\u6253\u5370 pty</p> <pre><code># who\nroot pts/0 Jan 27 19:41 (:0.0)\n\n# consoletype\npty\n\n# who\nroot tty1 Jan 27 21:05\n\n# consoletype\nvt\n\n# cat test.c\n#include\n#include\nint main()\n{\n    int fd1,fd2;\n    fd1=open(\u201ctest.sh\u201d,O_RDONLY);\n    if (!fd1)\n    {\n    perror(\u201cerror open test.sh\u201d);\n    exit(65);\n}\nfd2=dup2(fd1,0);\nsystem(\u201c/sbin/consoletype &gt;/tmp/a\u201d);\nreturn 0;\n}\n# gcc test.c -o test\n# ./test\n# cat a\nserial\n# consoletype\npty\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#cryptsetup","title":"cryptsetup","text":"<p>\u5bf9\u6307\u5b9a\u7684\u8bbe\u522b\u8fdb\u884c\u52a0\u5bc6\uff0c\u8fd9\u91cc\u7684\u8bbe\u522b\u5fc5\u987b\u662f <code>/dev/mapper</code> \u4e0b\u7684\u8bbe\u5907\uff0c\u90a3\u8fd9\u6837\u770b\u6765 2.4 \u7684\u5185\u6838\u662f\u6ca1\u6709\u8fd9\u4e2a\u547d\u4ee4\u4e86\u3002 \u4ed6\u5bf9\u5e94\u7684\u5e94\u8be5\u6709\u53e6\u5916\u4e00\u4e2a\u547d\u4ee4 <code>dm-crypt</code>\uff0c\u4f46\u662f\u6211\u7684\u7cfb\u7edf\u4e0a\u627e\u4e0d\u5230\u3002 \u8be5\u547d\u4ee4\u6ca1\u6709 man \u624b\u518c\uff0c\u5176 help \u5e2e\u52a9\u5982\u4e0b\uff1a</p> <pre><code># cryptsetup \u2013help\nUsage: cryptsetup [OPTION\u2026] []\n-v, \u2013verbose Shows more detailed error messages\n-c, \u2013cipher=STRING The cipher used to encrypt the disk (see\n/proc/crypto) (default: \u201caes\u201d)\n-h, \u2013hash=STRING The hash used to create the encryption key from\nthe passphrase (default: \u201cripemd160\u2033)\n-y, \u2013verify-passphrase Verifies the passphrase by asking for it twice\n-d, \u2013key-file=STRING Read the key from a file (can be /dev/random)\n-s, \u2013key-size=BITS The size of the encryption key (default: 256)\n-b, \u2013size=SECTORS The size of the device\n-o, \u2013offset=SECTORS The start offset in the backend device\n-p, \u2013skip=SECTORS How many sectors of the encrypted data to skip\nat the beginning\n\nHelp options:\n-?, \u2013help Show this help message\n\u2013usage Show this help message\n\nis one of:\ncreate \u2013 create device\nremove \u2013 remove device\nreload \u2013 modify active device\nresize \u2013 resize active device\nstatus \u2013 show device status\nis the device to create under /dev/mapper\nis the encrypted device\n</code></pre> <p>\u8fd9\u4e2a help \u4f3c\u4e4e\u4e5f\u4e0d\u80fd\u5e2e\u6211\u4eec\u4e86\u89e3\u66f4\u591a\u7684\u5185\u5bb9\u3002\u53ea\u597d\u4f5c\u6d4b\u8bd5\u4e86\u3002</p> <p>\u6211\u7528\u4e86\u4e00\u4e2a U \u76d8\u6765\u521b\u5efa LVM\uff0c\u8fd9\u6837\u5728<code>/dev/mapper</code> \u4e0b\u9762\u5c31\u6709\u5bf9\u5e94\u7684\u8bbe\u5907\u4e86\u3002</p> <pre><code># ls -l /dev/mapper/vg0-lv0\n    brw-rw\u2014- 1 root disk 253, 0 1\u6708 27 22:13 /dev/mapper/vg0-lv0\n\n# mount /dev/mapper/vg0-lv0 /misc\n\n# ls -l /misc\n    \u603b\u7528\u91cf 12\n    drwx\u2014\u2014 2 root root 12288 1\u6708 27 22:21 lost+found\n\n# touch /misc/one\n\n# ls -l /misc\n    \u603b\u7528\u91cf 12\n    drwx\u2014\u2014 2 root root 12288 1\u6708 27 22:21 lost+found\n    -rw-r\u2013r\u2013 1 root root 0 1\u6708 27 22:22 one\n\n# umount /misc\n\n# cryptsetup create cytest /dev/mapper/vg0-lv0\n    Enter passphrase:mypassword\n\n# ls -l /dev/mapper/vg0-lv0\n    brw-rw\u2014- 1 root disk 253, 0 1\u6708 27 22:13 /dev/mapper/vg0-lv0\n\n# mount /dev/mapper/vg0-lv0 /misc\n    mount: /dev/mapper/vg0-lv0 already mounted or /misc busy\n\n# cryptsetup remove cytest\n\n# mount /dev/mapper/vg0-lv0 /misc\n\n# ls -l /misc\n    \u603b\u7528\u91cf 12\n    drwx\u2014\u2014 2 root root 12288 1\u6708 27 22:21 lost+found\n    -rw-r\u2013r\u2013 1 root root 0 1\u6708 27 22:22 one\n</code></pre> <p>\u52a0\u5bc6\u524d\u7684\u8bbe\u5907\u548c\u52a0\u5bc6\u540e\u7684\u8bbe\u5907\u6211\u7528 <code>od</code> \u547d\u4ee4\u67e5\u770b\u4e86\u8f93\u51fa\u503c\uff0c\u53d1\u73b0\u6ca1\u6709\u4e0d\u540c\uff0c\u770b\u4e86\u4ed6\u4e0d\u662f\u6839\u636e\u5185\u5bb9\u52a0\u5bc6\u7684\uff0c\u5177\u4f53\u60c5\u51b5\u9700\u8981\u67e5\u5b98\u65b9\u7f51\u7ad9\u624d\u77e5\u9053\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#ctrlaltdel","title":"ctrlaltdel","text":"<p>\u8bbe\u7f6e <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u7684\u529f\u80fd\uff0c\u8fd9\u91cc\u6709\u4e24\u79cd\u65b9\u5f0f hard \u548c soft\u3002</p> <p>hard \u8868\u793a\u5f53\u63a5\u53d7 <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u65f6\uff0c\u7cfb\u7edf\u7acb\u523b\u91cd\u542f\u8ba1\u7b97\u673a\uff0c\u800c\u4e0d\u4f1a\u8c03\u7528 <code>sync(2)</code>\u547d\u4ee4\uff0c\u4e5f\u4e0d\u4f1a\u4f5c\u5176\u4ed6\u4e00\u4e9b\u51c6\u5907\uff0c\u8fd9\u6709\u70b9\u7c7b\u4f3c\u4e0d\u5ef6\u65f6\u7684 reset \u6309\u94ae\u3002</p> <p>\u800c soft \u5219\u8868\u793a <code>Ctrl-Alt-Del</code> \u7ec4\u5408\u952e\u6309\u4e0b\u65f6\uff0c\u4ed6\u53d1\u9001 SIGINT \u4fe1\u53f7\u7ed9 init \u8fdb\u7a0b\uff0c\u90a3\u5269\u4e0b\u7684\u4e8b\u60c5\u5c31\u662f\u770b init \u5982\u4f55\u505a\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-d","title":"/sbin \u4e0b d \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u547d\u4ee4\u5982\u4e0b</p> <p>debugfs delpart dhclient-script dmsetup dump dump.static debugfs.ocfs2 depmod dhcp6c dmsetup.static dump_cis debugreiserfs dhclient dmraid dosfsck dumpe2fs</p> <p>\u5176\u4e2d <code>dump.static</code> \u8f6f\u8fde\u63a5\u5230 dump \u547d\u4ee4\uff0c\u800c dump \u7a0b\u5e8f\u662f\u4e00\u4e2a\u9759\u6001\u7f16\u8bd1\u7684\u547d\u4ee4\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#debugfs","title":"debugfs","text":"<p>debugfs, debufs.ocfs2, debugreiserfs \u662f\u6587\u4ef6\u7cfb\u7edf\u8c03\u8bd5\u5de5\u5177\uff0c\u5176\u4e2d debugfs \u6211\u4f7f\u7528\u8fc7\u4e00\u6b21\uff0c\u5176\u76ee\u7684\u662f\u5e0c\u671b\u6062\u590d\u5220\u9664\u7684\u67d0\u4e2a\u6587\u4ef6\u3002</p> <p>\u4f46\u662f\u5b9e\u9a8c\u8868\u660e\uff0cext2 \u7684\u6587\u4ef6\u7cfb\u7edf\u6709\u6062\u590d\u7684\u53ef\u80fd\u6027\uff0c\u4f46\u662f ext3 \u5374\u6ca1\u6709\u53ef\u80fd\u3002\u5728 ext3 \u6587\u4ef6\u7cfb\u7edf\u5b98\u65b9\u7ad9\u70b9\u7684 FAQ \u4e2d\uff0c\u5c31\u6709\u4e00\u4e2a\u8fd9\u6837\u7684\u95ee\u9898\uff0c\u5176\u4e2d\u7b54\u6848\u5c31\u662f\u544a\u8bc9\u4f60\uff0c\u91c7\u7528 <code>rm -f</code> \u65b9\u5f0f\u5220\u9664\u7684\u547d\u4ee4\u662f\u6ca1\u6709\u529e\u6cd5\u6062\u590d\u7684\uff0c\u56e0\u4e3a\u4ed6\u4e0d\u4ec5\u4ec5\u53ea\u662f\u4f5c\u5220\u9664\u7684\u6807\u8bb0\u3002</p> <p>\u800c <code>ocfs2</code> \u76ee\u524d\u5e76\u4e0d\u7a33\u5b9a\uff0c\u8fd9\u662f Oracle \u63a8\u51fa\u7684\u4e00\u79cd\u6587\u4ef6\u7cfb\u7edf\uff0c\u662f\u4e3a Oracle \u6570\u636e\u5e93\u7684\u9ad8\u53ef\u7528\u670d\u52a1\u7684\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u7684\u9879\u76ee\u4e2d\uff0cocfs \u8868\u73b0\u7684\u5e76\u5982\u4eba\u610f\u3002\u8d77\u6587\u4ef6\u7cfb\u7edf\u90fd\u7528\u5f97\u5c11\uff0c\u90a3\u4e48\u8c03\u8bd5\u5c31\u66f4\u5c11\u4e86\u3002</p> <p><code>reiserfs</code> \u662f SuSe \u53d1\u884c\u7248\u672c\u4e2d\u9ed8\u8ba4\u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\uff0cRedHat \u7f3a\u7701\u662f ext2/ext3 \u7684\u6587\u4ef6\u7cfb\u7edf\u3002 \u6240\u4ee5 debugreiserfs \u4e5f\u5c31\u6ca1\u6709\u7528\u8fc7\u4e86\uff0c\u52a0\u4e0a reiserfs \u7684\u5f00\u53d1\u8005\u56e0\u4e3a\u8c0b\u6740\u59bb\u5b50\u7684\u7f6a\u540d\u88ab\u902e\u6355\uff0c\u56e0\u6b64\u8fd9\u4e2d\u6587\u4ef6\u7cfb\u7edf\u524d\u9014\u8fd8\u4e0d\u77e5\u9053\u600e\u4e48\u6837\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#depart","title":"depart","text":"<p><code>delpart</code> \u8fd9 \u4e2a\u547d\u4ee4\u5f88\u5947\u602a\uff0c\u6ca1\u6709 man \u624b\u518c\uff0c\u6ca1\u6709 info \u4fe1\u606f\uff0c\u5e2e\u52a9\u4e5f\u662f\u5c11\u5f97\u53ef\u601c\uff0c\u4f3c\u4e4e\u5f88\u4e0d\u7b26\u5408 <code>*nix</code> \u4e0b\u7a0b\u5e8f\u5f00\u53d1\u7684\u4e60\u60ef\u3002\u800c\u4ed6\u6240\u5c5e\u7684 rpm \u5305\u53c8\u662f <code>util-linux</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u5de5\u5177\u96c6\uff0c\u56e0\u6b64 <code>rpm -qi</code> \u4e5f\u4e0d\u80fd\u627e\u5230\u6709\u7528\u7684\u4fe1\u606f\u3002\u90a3\u5c31\u53ea\u80fd\u4ece\u5e2e\u52a9\u548c\u8d77\u7a0b\u5e8f\u547d\u4ee4\u6765\u770b\u4e86\u3002</p> <p>\u521a\u770b\u5230\u8fd9\u4e2a\u540d\u5b57\uff0c\u6211\u4ee5\u4e3a\u4ed6\u662f <code>parted</code> \u7a0b\u5e8f\u7684\u4e00\u90e8\u5206\uff0c\u7ed3\u679c\u4e0d\u662f\u3002\u770b\u5e2e\u52a9</p> <pre><code># delpart  \u2013help\nusage: delpart diskdevice partitionnr\n</code></pre> <p>\u4f3c\u4e4e\u4e5f\u5e94\u8be5\u662f\u548c\u5206\u533a\u6709\u5173\u7cfb\u3002\u6211\u7684\u731c\u60f3\u662f\u4ed6\u5e94\u8be5\u662f\u5220\u9664\u4e00\u4e2a\u6307\u5b9a\u7684\u5206\u533a\u3002\u4e0b\u9762\u662f\u6211\u7684\u5b9e\u9a8c\u8fc7\u7a0b</p> <p>\u9996\u5148\u628a\u6211\u7684 U \u76d8\u5206\u4e00\u4e2a\u5206\u533a\u51fa\u6765</p> <pre><code># fdisk -l /dev/sda\n\nDisk /dev/sda: 252 MB, 252968960 bytes\n8 heads, 61 sectors/track, 1012 cylinders\nUnits = cylinders of 488 * 512 = 249856 bytes\n\nDevice Boot Start End Blocks Id System\n/dev/sda1 1 81 19733+ 83 Linux\n\n# delpart /dev/sda 1\n\n# fdisk -l /dev/sda\n\nDisk /dev/sda: 252 MB, 252968960 bytes\n8 heads, 61 sectors/track, 1012 cylinders\nUnits = cylinders of 488 * 512 = 249856 bytes\n\nDevice Boot Start End Blocks Id System\n/dev/sda1 1 81 19733+ 83 Linux\n\n# delpart /dev/sda 1\nBLKPG: No such device or address\n</code></pre> <p>\u4ece\u5b9e\u9a8c\u6765\u770b\uff0c\u4ed6\u5e94\u8be5\u662f\u5220\u9664\u4e00\u4e2a\u5206\u533a\u7684\uff0c\u800c\u4e14\u6211\u4eec\u4ece delpart \u7a0b\u5e8f\u53cd\u9988\u4fe1\u606f\u6765\u770b\uff0c\u4ed6\u8ba4\u4e3a\u4ed6\u5220\u9664\u4e86 sda1\uff0c\u4f46\u662f fdisk \u547d\u4ee4\u5374\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u8fd8\u5728\u3002 \u63a5\u4e0b\u6765\u6211\u6d4b\u8bd5\u8fd9\u4e2a\u5206\u533a\u662f\u5426\u80fd mkfs</p> <pre><code># mkfs.ext2 /dev/sda1\nmke2fs 1.35 (28-Feb-2004)\nCould not stat /dev/sda1 \u2014 \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n\nThe device apparently does not exist; did you specify it correctly?\n</code></pre> <p>\u770b\u6765\u771f\u7684\u5df2\u7ecf\u5220\u9664\u4e86\uff0c\u4f46\u662f\u4e3a\u4ec0\u4e48 fdisk \u4e0d\u8fd9\u4e48\u8ba4\u4e3a\u5462\uff1f\u800c\u4e14 parted \u4e5f\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u662f\u5b58\u5728\u7684</p> <pre><code># parted /dev/sda\nGNU Parted 1.6.19\nCopyright (C) 1998 \u2013 2004 Free Software Foundation, Inc.\nThis program is free software, covered by the GNU General Public License.\n\nThis program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without\neven the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\nGeneral Public License for more details.\n\n\u4f7f\u7528 /dev/sda\n(parted) print\n/dev/sda \u7684\u78c1\u76d8\u51e0\u4f55\u7ed3\u6784\uff1a0.000-241.250 \u5146\u5b57\u8282\n\u78c1\u76d8\u6807\u7b7e\u7c7b\u578b\uff1amsdos\nMinor \u8d77\u59cb\u70b9 \u7ec8\u6b62\u70b9 \u7c7b\u578b \u6587\u4ef6\u7cfb\u7edf \u6807\u5fd7\n1 0.030 19.300 \u4e3b\u5206\u533a\n</code></pre> <p>\u4f46\u662f\u5185\u6838\u5374\u8ba4\u4e3a\u8fd9\u4e2a\u5206\u533a\u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86</p> <pre><code># cat /proc/partitions\nmajor minor #blocks name\n\n3 0 29302560 hda\n3 1 5246608 hda1\n3 2 5178600 hda2\n3 3 1 hda3\n3 4 13267768 hda4\n3 5 5606653 hda5\n8 0 247040 sda\n</code></pre> <p>\u800c\u4f7f\u7528 sfdisk \u547d\u4ee4\u540c\u6837\u4e5f\u8ba4\u4e3a sda1 \u5b58\u5728\uff0c\u4f46\u662f\u5728\u626b\u63cf sda1 \u65f6\u505c\u6b62</p> <pre><code># sfdisk /dev/sda\nChecking that no-one is using this disk right now \u2026\nOK\n\nDisk /dev/sda: 1012 cylinders, 8 heads, 61 sectors/track\nOld situation:\nUnits = cylinders of 249856 bytes, blocks of 1024 bytes, counting from 0\n\nDevice Boot Start End #cyls #blocks Id System\n/dev/sda1 0+ 80 81- 19733+ 83 Linux\n/dev/sda2 0 \u2013 0 0 0 Empty\n/dev/sda3 0 \u2013 0 0 0 Empty\n/dev/sda4 0 \u2013 0 0 0 Empty\nInput in the following format; absent fields get a default value.\n\nUsually you only need to specify and (and perhaps ).\n\n/dev/sda1 :\n</code></pre> <p>\u540e\u9762\u662f <code>Ctrl+C</code> \u9000\u51fa\u7684\u3002</p> <p>strace \u4e86\u4e00\u4e0b fdisk \u7a0b\u5e8f\uff0c\u6ca1\u6709\u627e\u5230\u539f\u56e0\u3002\u8fd9\u4e2a\u95ee\u9898\u4e5f\u6682\u65f6\u7559\u4e0b\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#depmod","title":"depmod","text":"<p>\u4e3a modprobe \u5de5\u5177\u63d0\u4f9b\u4e00\u4e2a\u6b63\u786e\u7684\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\uff08modules.dep)\u3002 \u8fd9\u4e2a\u547d\u4ee4\u5bf9\u4e8e\u65b0\u52a0\u5165\u7684\u6a21\u5757\u80fd\u591f\u50cf\u5df2\u7ecf\u6709\u7684\u6a21\u5757\u90a3\u6837\u6dfb\u52a0\u548c\u5220\u9664\u8d77\u5230\u4e86\u5f88\u597d\u7684\u4f5c\u7528\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u5728 Linux \u4e2d\uff0c\u5185\u6838\u6a21\u5757\u662f\u662f\u5728<code>/lib/modules/</code>\u4e0b\u9762\u7684\u3002\u4f7f\u7528 <code>insmod/modprobe</code> \u9ed8\u8ba4\u4e5f\u662f\u4ece\u8fd9\u4e2a\u76ee\u5f55\u53bb\u627e\u4f60\u8981\u52a0\u8f7d\u7684\u6a21\u5757\uff0c\u9664\u975e\u4f60\u7528 <code>-f</code> \u6765\u6307\u5b9a\u6a21\u5757\u7684\u8def\u5f84\u3002</p> <p>\u800c\u5bf9\u4e8e\u7f16\u8bd1\u7684\u5185\u6838\u6a21\u5757\uff0c\u5982\u679c\u5e0c\u671b modprobe \u7a0b\u5e8f\u80fd\u591f\u4ec5\u4ec5\u63d0\u4f9b\u6a21\u5757\u540d\u5c31\u53ef\u4ee5\u52a0\u8f7d\u7684\u8bdd\uff0c\u90a3\u4e48\u81f3\u5c11\u8981\u505a\u4e24\u4ef6\u4e8b\u60c5\u3002</p> <ol> <li>\u5c06\u65b0\u7684\u6a21\u5757\u590d\u5236\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u3002</li> <li>\u4f7f\u7528<code>depmod -A</code> \u6216\u8005<code>depmod -a</code>\u6765\u751f\u4ea7\u6a21\u5757\u4f9d\u8d56\u6027\u6bd4\u5217\u8868\u3002</li> </ol> <p>\u5176\u4e2d <code>\uff0da</code> \u662f\u8868\u793a\u6240\u6709\u6a21\u5757\u90fd\u626b\u63cf\u4e00\u6b21\uff0c\u7136\u540e\u751f\u6210\u5217\u8868\uff0c\u800c <code>\uff0dA</code> \u8868\u793a\u8fdb\u626b\u63cf\u65b0\u589e\u7684\u6216\u8005\u66f4\u65b0\u7684\u6a21\u5757\uff0c\u7136\u540e\u66f4\u65b0\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\u3002</p> <p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u662f\u6700\u5e38\u7528\u7684\u4e86\u3002\u6211\u76ee\u524d\u4e5f\u5c31\u4ec5\u4ec5\u7528\u8fc7\u8fd9\u4e24\u4e2a\u53c2\u6570\u3002</p> <p>\u521a\u624d\u770b\u4e86 man \u624b\u518c\uff0c\u8fd8\u6709\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982 <code>\uff0db</code> \u8868\u793a\u6a21\u5757\u7684\u57fa\u672c\u8def\u5f84\u5728\u54ea\u91cc\uff0c\u5229\u7528\u8fd9\u4e2a\u53c2\u6570\u4f60\u53ef\u4ee5\u5c06\u6a21\u5757\u4ece <code>/lib/modules/</code> \u4e2d\u8fc1\u79fb\u51fa\u6765\u3002\u800c <code>-n</code> \u53c2\u6570\u8868\u793a\u4ec5\u4ec5\u53ea\u662f\u6253\u5370\u51fa\u6a21\u5757\u4f9d\u8d56\u6027\u5217\u8868\uff0c\u800c\u4e0d\u5199\u5165\uff0c\u76f8\u5f53\u4e8e\u4ec5\u4ec5\u662f\u6f14\u793a\uff0c\u800c\u4e0d\u4f1a\u4ea7\u751f\u5b9e\u9645\u6548\u679c\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dhclient","title":"dhclient","text":"<p>dhclient\uff0c dhclient-script, dhcp6 \u8fd9\u662f DHCP \u534f\u8bae\u4e2d\u7528\u7684\uff0c\u4e00\u822c\u6211\u4eec\u90fd\u4e0d\u4f1a\u76f4\u63a5\u53bb\u6267\u884c\u8fd9\u51e0\u4e2a\u547d\u4ee4\uff0c\u800c\u662f\u914d\u7f6e\u4ed6\u7684\u914d\u7f6e\u6587\u4ef6\u548c\u8fd0\u884c <code>/etc/rc.d/init.d/dhcpd</code> \u547d\u4ee4\u3002\u6240\u4ee5\u8fd9\u91cc\u4e5f\u4e0d\u6df1\u5165\u7814\u7a76\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dmraid","title":"dmraid","text":"<p>device-Mapper \u8f6f RAID \u5de5\u5177\uff0c\u4ed6\u4e3b\u8981\u662f\u7528\u6765\u6267\u884c\u8bbe\u5907\u53d1\u73b0\uff0cRAID \u6fc0\u6d3b\u548c ATARAID \u5c5e\u6027\u663e\u793a\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u548c RAID \u5236\u4f5c\u5de5\u5177\u4e00\u8d77\u6765\u8bb2\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dmsetup","title":"dmsetup","text":"<p>\u5e95\u5c42\u903b\u8f91\u5377\u7ba1\u7406(LVM)\uff0c\u8fd9\u662f device-mapper \u5305\u4e2d\u5e26\u7684\u552f\u4e00\u4e00\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f\uff0c\u9664\u4e86\u90a3\u4e2a\u9759\u6001\u7248\u7684 <code>dmsetup.static</code>\u3002\u8fd9\u4e2a\u547d\u4ee4\u6211\u60f3\u7559\u5230\u548c <code>device-mapper-multipath</code> \u4e00\u8d77\u6765\u7814\u7a76\uff0c\u8fd9\u91cc\u5c31\u4e0d\u9610\u8ff0\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dosfsck","title":"dosfsck","text":"<p>\u68c0\u67e5\u548c\u4fee\u590d MSDOS \u6587\u4ef6\u7cfb\u7edf\uff0cLinux \u8fd8\u771f\u7684\u6709\u610f\u601d\uff0c\u5c45\u7136\u6765\u4e00\u4e2a\u8fd9\u6837\u7684\u5de5\u5177\uff0c\u4e0d\u8fc7\u6211\u4ece\u672a\u5728 Linux \u4e0b\u4fee\u590d\u8fc7 MS \u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u603b\u662f\u611f\u89c9\u6709\u70b9\u7384\u3002</p> <p>\u800c\u4e14\u6211\u89c9\u5f97\u4e5f\u6ca1\u6709\u673a\u4f1a\u3002\u670d\u52a1\u5668\u4e0a\u5427\uff0cMS \u7684\u6587\u4ef6\u7cfb\u7edf\u548c Linux \u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u4e0d\u4f1a\u5b58\u5728\u4e00\u4e2a\u786c\u76d8\u4e0a\u7684\uff0c\u670d\u52a1\u5668\u4e0a\u9700\u8981\u53cc\u7cfb\u7edf\u5417\uff1f\u81ea\u5df1\u7684\u673a\u5668\u4e0a\uff0c\u5982\u679c\u6709 MS \u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u90a3\u4e48\u5c31\u5e94\u8be5\u6709\u5176\u64cd\u4f5c\u7cfb\u7edf\uff0c\u90a3\u4e48\u81ea\u5df1\u7684\u5de5\u5177\u4fee\u590d\u81ea\u5df1\u7684\u4e1c\u897f\u5c31\u597d\u4e86\u3002\u5f53\u7136\u4e5f\u4e0d\u6392\u9664\u8fd9\u79cd\u53ef\u80fd\u6027\uff1a\u4ee5\u524d\u662f\u6709\u53cc\u7cfb\u7edf\uff0c\u800c\u4e00\u4e9b\u6570\u636e\u662f\u653e\u5728 MS \u7684\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\uff0c\u540e\u6765\u89c9\u5f97 MS \u7684\u7cfb\u7edf\u4e0d\u723d\uff0c\u4e8e\u662f\u5494\u5693\u6389\u4e86\u3002</p> <p>\u4f46\u662f\u56e0\u4e3a\u6570\u636e\u592a\u591a\uff0c\u5176\u4ed6\u5206\u533a\u4e5f\u5c31\u4e0d\u61c2\u4e86\uff0c\u4e8e\u662f\u5c31\u51fa\u73b0\u4e86\u6ca1\u6709 MS \u7684\u7cfb\u7edf\uff0c\u4f46\u662f\u6709 MS \u7684\u5206\u533a\u3002\u8fd9\u4e2a\u65f6\u5019\u662f\u4e0d\u662f dosfsck \u80fd\u6d3e\u4e0a\u7528\u573a\u5462\uff1f</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dump","title":"dump","text":"<p>ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u5907\u4efd\u3002dump \u7a0b\u5e8f\u68c0\u67e5 ext\u2154 \u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\uff0c\u7136\u540e\u731c\u6d4b\u90a3\u4e9b\u6587\u4ef6\u9700\u8981\u5907\u4efd\u3002\u8fd9\u4e9b\u6587\u4ef6\u88ab\u590d\u5236\u5230\u6307\u5b9a\u7684\u78c1\u76d8\uff0c\u78c1\u5e26\u6216\u8005\u5176\u4ed6\u5b58\u50a8\u4ecb\u8d28\u4e0a\u3002\u4ed6\u8fd8\u53ef\u4ee5\u4f5c\u8fdc\u7a0b\u7684\u5907\u4efd\u3002</p> <p>\u5982\u679c dump \u51fa\u6765\u7684\u6570\u636e\u5927\u4e8e\u6307\u5b9a\u7684\u5907\u4efd\u5b58\u50a8\u4ecb\u8d28\uff0c\u4ed6\u5c06\u5206\u5377\u3002dump \u652f\u6301\u7684\u53c2\u6570\u6bd4\u8f83\u591a\u3002</p> <ul> <li><code>-level#</code> dump \u7ea7\u522b\uff0c0 \u662f\u5168\u5907\u4efd\uff0c0 \u4ee5\u4e0a\u7684\u6570\u5b57\u662f\u589e\u91cf\u5907\u4efd\u3002\u5386\u53f2\u539f\u56e0\uff0cdump \u7a0b\u5e8f\u4e00\u822c\u53ea\u4f7f\u7528 0-9 \u8fd9\u51e0\u4e2a\u6570\u5b57\uff0c\u4e0d\u8fc7\u73b0\u5728\u7684 dump \u7248\u672c\u652f\u6301 9 \u4ee5\u4e0a\u7684\u6570\u5b57\uff08\u4f46\u662f\uff0c\u4e0d\u540c\u7684\u6570\u5b57\u610f\u5473\u7740\u4ec0\u4e48\uff0cman \u624b\u518c\u4e2d\u5e76\u6ca1\u6709\u8bf4\uff09</li> <li><code>-a</code> \u201c\u81ea\u52a8\u5927\u5c0f(auto-size)\u201d. \u5ffd\u7565\u6240\u6709\u78c1\u5e26\u7684\u957f\u5ea6\u8ba1\u7b97\u3002\u4ed6\u5c06\u4e00\u76f4\u5199\u5230\u78c1\u5e26\u7ed3\u675f\uff0c\u5bf9\u4e8e\u5927\u90e8\u5206\u73b0\u5728\u7684\u78c1\u5e26\u673a\uff0c\u8fd9\u4e2d\u5de5\u4f5c\u65b9\u5f0f\u662f\u6700\u4f73\u7684\uff0c\u4e5f\u662f\u7f3a\u7701\u6a21\u5f0f\u3002\u8fd9\u79cd\u65b9\u5f0f\u7279\u522b\u662f\u5728\u589e\u52a0\u6570\u636e\u5230\u4e00\u4e2a\u78c1\u5e26\u4e0a\u6216\u8005\u5177\u6709\u786c\u4ef6\u538b\u7f29\u529f\u80fd\u7684\u78c1\u5e26\u673a\u6548\u679c\u66f4\u597d\u3002</li> <li><code>-A</code> \u5f52\u6863\u6587\u4ef6\uff0c\u5728\u6307\u5b9a\u7684\u5f52\u6863\u6587\u4ef6\u4e0a\u521b\u5efa\u4e00\u4e2a dump \u5185\u5bb9\u8868(table-of-contents)\uff0c\u5c06\u6765\u53ef\u4ee5\u88ab restore(8)\u7a0b\u5e8f\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u6b63\u51c6\u5907\u56de\u590d\u7684\u6587\u4ef6\u662f\u5426\u5728 dump \u6587\u4ef6\u4e2d.</li> <li><code>-b</code> \u5757\u5927\u5c0f.\u6bcf\u4e2a dump \u8bb0\u5f55\u7684 KB \u6570.\u7f3a\u7701\u662f 10.\u6700\u5927\u503c\u662f 1024,\u4e0d\u8fc7\u4e0e\u4f60\u7684\u5185\u6838\u9650\u5236\u6709\u5173\u7cfb.</li> <li><code>-B</code> \u8bb0\u5f55\u6570,\u6bcf\u5377\u7684\u5feb\u6570(\u6bcf\u5757 1KB).\u5f53 dump \u7a0b\u5e8f\u53d1\u73b0\u5230\u4e86\u5b58\u50a8\u4ecb\u8d28\u7684\u7ed3\u5c3e\u65f6,\u4ed6\u4f1a\u8981\u6c42\u4f60\u66f4\u6362\u5377.</li> <li><code>-D</code> \u6587\u4ef6.\u8bbe\u7f6e\u5b58\u50a8\u4e4b\u524d\u5148\u524d\u5b8c\u5168\u6216\u8005\u589e\u91cf dump \u4fe1\u606f\u7684\u6587\u4ef6\u8def\u5f84.</li> <li><code>-e</code> inode \u5217\u8868,\u4e0d\u51c6\u5907 dump \u7684 inode \u5217\u8868,\u591a\u4e2a inode \u4e4b\u95f4\u7528\u9017\u53f7\u5206\u9694,\u4f60\u53ef\u4ee5\u4f7f\u7528 stat(1)\u547d\u4ee4\u6765\u627e\u5230\u6587\u4ef6\u6216\u8005\u76ee\u5f55\u7684 inode \u503c.</li> <li><code>-E</code> \u6587\u4ef6,\u4ece\u6587\u4ef6\u4e2d\u6392\u9664\u4e0d dump \u7684 inode,\u6587\u4ef6\u683c\u5f0f\u91c7\u7528\u4e00\u884c\u4e00\u4e2a inode,\u800c\u4e14\u5e94\u8be5\u662f\u6392\u5e8f\u7684.</li> <li><code>-f</code> \u6587\u4ef6.\u5199\u5907\u4efd\u5230\u6587\u4ef6;\u8fd9\u53ef\u4ee5\u662f\u7279\u5b9a\u7684\u8bbe\u5907\u6587\u4ef6,\u6bd4\u5982/dev/st0,/dev/fd0,/dev/sdc,\u6216\u8005\u662f\u4e00\u4e2a\u666e\u901a\u6587\u4ef6,\u6216\u8005\u662f\u6807\u51c6\u8f93\u51fa(<code>-</code>)\uff0c \u591a\u4e2a\u6587\u4ef6\u91c7\u7528\u9017\u53f7\u5206\u9694.\u6bcf\u4e00\u4e2a\u6587\u4ef6\u5c06\u5b58\u50a8\u4e00\u4e2a dump \u5377.\u5982\u679c\u6587\u4ef6\u547d\u91c7\u7528 host:file \u6216\u8005 user@host:file \u683c\u5f0f,dump \u5c06\u4f7f\u7528 rmt(8)\u7a0b\u5e8f\u5c06\u6570\u636e\u5199\u5165\u5230\u8fdc\u7a0b\u673a\u5668\u6307\u5b9a\u7684\u6587\u4ef6\u4e0a(\u6539\u6587\u4ef6\u5e94\u8be5\u5b58\u5728,dump \u4e0d\u4f1a\u4f7f\u7528\u521b\u5efa\u4e00\u4e2a\u8fdc\u7a0b- `\u6587\u4ef6).</li> <li><code>-F</code> \u811a\u672c,\u5728\u6bcf\u4e00\u4e2a\u78c1\u5e26\u7684\u6700\u540e\u6267\u884c\u8fd9\u4e2a\u811a\u672c(\u9664\u4e86\u6700\u540e\u4e00\u76d8\u78c1\u5e26)</li> <li><code>-L</code> \u6807\u7b7e,\u4f7f\u7528\u7528\u6237\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a\u6807\u7b7e\u5199\u5165\u5230 dump \u90fd,\u8fd9\u6837\u4e00\u6765,\u50cf restore(8)\u548c file(8)\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5b83.\u6807\u7b7e\u7684\u6700\u5927\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7 LBLSIZE(\u5f53\u524d\u662f 16)\u4e2a\u5b57\u7b26,\u800c\u4e14\u5b57\u7b26\u4e32\u5fc5\u987b\u662f <code>\\0</code> \u7ed3\u5c3e.</li> <li><code>-S</code> \u5927\u5c0f\u8bc4\u4f30\u3002\u7528\u6765\u8ba1\u7b97 dump \u9700\u8981\u7684\u7a7a\u95f4\uff0c\u4f46\u662f\u5e76\u4e0d\u771f\u6b63\u6267\u884c dump \u64cd\u4f5c\u3002\u8fd9\u5bf9\u589e\u91cf\u5907\u4efd\u6709\u597d\u5904\uff0c\u56e0\u4e3a\u53ef\u4ee5\u77e5\u9053\u9700\u8981\u591a\u5c11\u5b58\u50a8\u4ecb\u8d28\u3002</li> <li><code>-T</code> \u65f6\u95f4\u3002\u4f7f\u7528\u6307\u5b9a\u7684\u65f6\u95f4\u6765\u4f5c\u4e3a dump \u7684\u65f6\u95f4\uff0c\u800c\u4e0d\u662f\u4ece <code>/etc/dumpdates</code> \u91cc\u8bfb\u53d6\u3002\u8fd9\u91cc\u65f6\u95f4\u7684\u683c\u5f0f\u548c ctime(3) \u7684\u683c\u5f0f\u76f8\u540c\uff0c\u9075\u5b88 RFC822 \u65f6\u533a\u89c4\u8303\u3002\u4ed6\u4e0e <code>-u</code> \u53c2\u6570\u662f\u4e92\u65a5\u7684\u3002</li> <li><code>-u</code> \u6210\u529f dump \u540e\uff0c\u66f4\u65b0 <code>/etc/dumpdates</code> \u6587\u4ef6\u3002/etc/dumpdates \u6587\u4ef6\u683c\u5f0f\u662f\u4eba\u53ef\u4ee5\u9605\u8bfb\u7684\uff0c\u6bcf\u884c\u8bb0\u5f55\u4e00\u4e2a\u65f6\u95f4\uff0c\u91c7\u53d6\u4e86\u53eb\u5bbd\u677e\u7684\u683c\u5f0f\u3002</li> <li><code>-y</code> \u5199\u5165\u78c1\u5e26\u65f6\u538b\u7f29\u5757\uff0c\u91c7\u7528 lzo \u94fe\u63a5\u5e93\u3002</li> <li><code>-z</code> \u538b\u7f29\u7ea7\u522b\uff0c\u91c7\u7528 zlib \u5e93\uff0c\u8fd9\u4e2a\u53c2\u6570\u4ec5\u5728\u5c06\u6570\u636e dump \u5230\u6587\u4ef6\uff0c\u7ba1\u9053\u6216\u8005\u78c1\u5e26\u673a\u65f6\u624d\u6709\u7528\uff0c\u7f3a\u7701\u503c\u662f 2.\u6ce8\u610f\u6307\u5b9a\u8fd9\u4e2a\u503c\u7684\u65f6\u5019\uff0c\u53c2\u6570\u548c\u503c\u4e4b\u95f4\u5e94\u8be5\u6ca1\u6709\u53c2\u6570</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u538b\u7f29\u5230\u6587\u4ef6\u7684\u7b80\u5355\u4f8b\u5b50</p> <pre><code># dump -0 -f /tmp/rootdump /root\nDUMP: Date of this level 0 dump: Sun Jan 28 22:06:46 2007\nDUMP: Dumping /dev/hda5 (/ (dir root)) to /tmp/rootdump\nDUMP: Label: /\nDUMP: Writing 10 Kilobyte records\nDUMP: mapping (Pass I) [regular files]\nDUMP: mapping (Pass II) [directories]\nDUMP: estimated 15509 blocks.\nDUMP: Volume 1 started with block 1 at: Sun Jan 28 22:06:48 2007\nDUMP: dumping (Pass III) [directories]\nDUMP: ACLs in inode #2 won't be dumped\nDUMP: ACLs in inode #187672 won't be dumped\nDUMP: ACLs in inode #204060 won't be dumped\nDUMP: ACLs in inode #674281 won't be dumped\nDUMP: dumping (Pass IV) [regular files]\nDUMP: ACLs in inode #505922 won't be dumped\nDUMP: ACLs in inode #505923 won't be dumped\nDUMP: ACLs in inode #505924 won't be dumped\nDUMP: ACLs in inode #505925 won't be dumped\nDUMP: ACLs in inode #505926 won't be dumped\nDUMP: ACLs in inode #505927 won't be dumped\n...\nDUMP: Closing /tmp/rootdump\nDUMP: Volume 1 completed at: Sun Jan 28 22:06:59 2007\nDUMP: Volume 1 15340 blocks (14.98MB)\nDUMP: Volume 1 took 0:00:11\nDUMP: Volume 1 transfer rate: 1394 kB/s\nDUMP: 15340 blocks (14.98MB) on 1 volume(s)\nDUMP: finished in 11 seconds, throughput 1394 kBytes/sec\nDUMP: Date of this level 0 dump: Sun Jan 28 22:06:46 2007\nDUMP: Date this dump completed: Sun Jan 28 22:06:59 2007\nDUMP: Average transfer rate: 1394 kB/s\nDUMP: DUMP IS DONE\n</code></pre> <p>\u6211\u4eec\u6765\u770b\u770b dump \u51fa\u6765\u7684\u6587\u4ef6\u662f\u6709\u4ec0\u4e48\u7279\u5f81</p> <pre><code># file /tmp/rootdump\n/tmp/rootdump: new-fs dump file (little endian), This dump Sun Jan 28 22:06:46 2007, Previous dump Thu Jan 1 08:00:00 1970, Volume 1, Level zero, type: tape header, Label /, Filesystem / (dir root), Device /dev/hda5, Host lancy, Flags 3\n\n# du -sh /tmp/rootdump\n15M /tmp/rootdump\n\n# du -sh /root\n15M /root\n</code></pre> <p>\u5728\u4e0d\u6307\u5b9a <code>-z</code> \u53c2\u6570\u65f6\uff0cdump \u662f\u6ca1\u6709\u538b\u7f29\u6548\u679c\u7684\u3002</p> <p>\u518d\u770b\u770b\u538b\u7f29\u6548\u679c</p> <pre><code># dump -0 -z9 -f /tmp/rootdump.z9 /root\n......\n#ls -h /tmp/rootdump.z9\n-rw-r--r-- 1 root root 7.4M\nJan 30 20:56 /tmp/rootdump.z9\n</code></pre> <p>\u770b\u4e0a\u53bb\u6548\u679c\u8fd8\u4e0d\u9519</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dump_cis","title":"dump_cis","text":"<p>\u663e\u793a PCMCIA \u8bbe\u522b\u7684\u4fe1\u606f\u3002\u56e0\u4e3a\u6211\u7684\u65e0\u7ebf\u4e0a\u7f51\u5361\u4e0d\u8fd9\u6b21\uff0c\u56e0\u6b64\u4ed6\u4ec5\u4ec5\u7ed9\u51fa\u4e86\u4e0b\u9762\u7684\u4fe1\u606f</p> <pre><code># dump_cis no pcmcia driver in /proc/devices\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dumpe2fs","title":"dumpe2fs","text":"<p>\u5bfc\u51fa ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u4fe1\u606f\uff0c\u663e\u7136\u8fd9\u4e5f\u662f\u4e00\u4e2a\u91cd\u91cf\u7ea7\u7684\u5de5\u5177\uff0c\u5728\u6587\u4ef6\u7cfb\u7edf\u51fa\u73b0\u635f\u574f\u7684\u60c5\u51b5\u4e0b\u7528\u5f97\u7740\u3002</p> <p>\u4ed6\u6253\u5370\u51fa\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757\u548c\u5757\u7ec4\u4fe1\u606f\u3002\u6211\u4eec\u5148\u770b\u4e00\u4e2a\u5177\u4f53\u7684\u4f8b\u5b50\uff0c\u4e0b\u9762\u662f\u5bf9\u6211\u521a\u521b\u5efa\u4e2a\u4e00\u4e2a\u5206\u533a\u7684 dump \u4fe1\u606f\u3002</p> <pre><code># dumpe2fs /dev/sda1\ndumpe2fs 1.35 (28-Feb-2004)\nFilesystem volume name:\nLast mounted on:\nFilesystem UUID: f74b41c6-637f-436f-ab9c-e1cbd532abf8\nFilesystem magic number: 0xEF53\nFilesystem revision #: 1 (dynamic)\nFilesystem features: has_journal resize_inode filetype sparse_super\nDefault mount options: (none)\nFilesystem state: clean\nErrors behavior: Continue\nFilesystem OS type: Linux\nInode count: 4944\nBlock count: 19732\nReserved block count: 986\nFree blocks: 17905\nFree inodes: 4933\nFirst block: 1\nBlock size: 1024\nFragment size: 1024\nReserved GDT blocks: 77\nBlocks per group: 8192\nFragments per group: 8192\nInodes per group: 1648\nInode blocks per group: 206\nFilesystem created: Sun Jan 28 21:43:19 2007\nLast mount time: n/a\nLast write time: Sun Jan 28 21:43:19 2007\nMount count: 0\nMaximum mount count: 26\nLast checked: Sun Jan 28 21:43:19 2007\nCheck interval: 15552000 (6 months)\nNext check after: Fri Jul 27 21:43:19 2007\nReserved blocks uid: 0 (user root)\nReserved blocks gid: 0 (group root)\nFirst inode: 11\nInode size: 128\nJournal inode: 8\nDefault directory hash: tea\nDirectory Hash Seed: d1aef805-54e4-4d41-90f7-e509a85a7028\nJournal backup: inode blocks\n\nGroup 0: (Blocks 1-8192)\nPrimary superblock at 1, Group descriptors at 2-2\nBlock bitmap at 80 (+79), Inode bitmap at 81 (+80)\nInode table at 82-287 (+81)\n6861 free blocks, 1637 free inodes, 2 directories\nFree blocks: 1332-8192\nFree inodes: 12-1648\nGroup 1: (Blocks 8193-16384)\nBackup superblock at 8193, Group descriptors at 8194-8194\nBlock bitmap at 8272 (+79), Inode bitmap at 8273 (+80)\nInode table at 8274-8479 (+81)\n7905 free blocks, 1648 free inodes, 0 directories\nFree blocks: 8480-16384\nFree inodes: 1649-3296\nGroup 2: (Blocks 16385-19731)\nBlock bitmap at 16385 (+0), Inode bitmap at 16386 (+1)\nInode table at 16387-16592 (+2)\n3139 free blocks, 1648 free inodes, 0 directories\nFree blocks: 16593-19731\nFree inodes: 3297-4944\n</code></pre> <p>\u4ece\u8fd9\u4e2a dump \u4fe1\u606f\u6211\u4eec\u80fd\u591f\u5f97\u5230\u51e0\u4e2a\u5f88\u91cd\u8981\u7684\u4fe1\u606f\uff0c\u65e0\u8bba\u5bf9\u4e8e\u4f60\u5c06\u6765\u7684\u6b63\u5728\u5907\u4efd\uff0c\u6062\u590d\u8fd8\u662f\u6587\u4ef6\u7cfb\u7edf\u4fee\u590d\u90fd\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002</p> <pre><code>Free blocks: 17905 //\u80fd\u591f\u5b58\u50a8\u6570\u636e\u7684\u5757\u5927\u5c0f\nFree inodes: 4933 //\u80fd\u591f\u4f7f\u7528\u7684 i \u8282\u70b9 Block\nsize: 1024 //\u5757\u5927\u5c0f\nPrimary superblock at 1\uff0cBackup superblock at 8193 //\u4e3b\u8d85\u7ea7\u5757\u4ee5\u53ca\u5907\u4efd\u8d85\u7ea7\u5757\u7684\u4f4d\u7f6e\n</code></pre> <p>free blocks \u548c block size \u51b3\u5b9a\u4e86\u5b58\u50a8\u6570\u636e\u7684\u7a7a\u95f4\u5927\u5c0f\uff0c\u540c\u65f6 block size \u5728\u67d0\u4e9b\u5907\u4efd\u8f6f\u4ef6\u4e2d\u662f\u9700\u8981\u6307\u5b9a\u7684\u3002 \u800c free inode \u8868\u8bf4\u660e\u80fd\u591f\u521b\u5efa\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u603b\u548c\u3002</p> <p>\u56e0\u4e3a\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u9700\u8981\u5360\u7528\u4e00\u4e2a inode \u8282\u70b9\u3002\u56e0\u6b64\u5373\u4f7f\u4f60\u7684\u7a7a\u95f4\u8fd8\u8db3\u591f\uff0c\u4f46\u662f\u4f60\u4f1a\u53d1\u73b0\u4f60\u65e0\u6cd5\u521b\u5efa\u6587\u4ef6\u6216\u8005\u76ee\u5f55\uff0c\u800c\u63d0\u793a\u5374\u662f\u7a7a\u95f4\u4e0d\u591f\uff0c \u8fd9\u4e2a\u65f6\u5019\u4f60\u53ef\u4ee5\u7528 dumpe2fs \u6765\u770b\u770b\u4f60\u8fd8\u6709\u591a\u5c11 free inode\u3002\u5f53\u7136\u4ec5\u4ec5\u4e3a\u4e86\u67e5\u770b inode \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u4e0d\u4ec5\u4ec5\u53ea\u6709 dumpe2fs \u80fd\u591f \u505a\u5f97\u5230\u3002</p> <p><code>df -i</code> \u547d\u4ee4\u4e5f\u53ef\u4ee5\u67e5\u770b\u5230 inode \u8282\u70b9\u7684\u4f7f\u7528\u4fe1\u606f\u3002</p> <p>\u800c\u9002\u5f53\u7684\u6539\u53d8 block size \u53ef\u4ee5\u5728\u540c\u6837\u7a7a\u95f4\u91cc\u83b7\u5f97\u66f4\u591a\u7684 inode\uff0c\u8fd9\u4e2a\u6211\u4eec\u5728\u8bf4 mkfs \u7684\u65f6\u5019\u518d\u8ba8\u8bba\u3002</p> <p>superblock \u65e0\u7591\u662f\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u6838\u5fc3\uff0c\u7c7b\u4f3c\u901a\u5f80\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8\u7a7a\u95f4\u7684\u94a5\u5319\uff0c\u6ca1\u6709\u4e86\u94a5\u5319\uff0c\u4f60\u65e2\u65e0\u6cd5\u7ee7\u7eed\u5b58\u50a8\u6570\u636e\uff0c\u4e5f\u65e0\u6cd5\u53d6\u51fa\u539f\u6765\u7684\u6570\u636e\u3002</p> <p>\u6b63\u662f\u56e0\u4e3a\u4ed6\u662f\u5982\u6b64\u7684\u91cd\u8981\uff0c\u6240\u4ee5\u6587\u4ef6\u7cfb\u7edf\u5728\u4e00\u521b\u5efa\u7684\u5c31\u505a\u4e86\u82e5\u5e72\u5907\u4efd\u3002\u800c\u4e14\u7a7a\u95f4\u8d8a\u5927\uff0c\u5907\u4efd\u7684\u6570\u76ee\u8d8a\u591a\uff0c\u4ee5\u6211\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u5927\u5c0f\u662f<code>5.3G</code>.</p> <p>\u5176\u4e2d\u8d85\u7ea7\u5757\u4e00\u5171 8 \u4e2a\u3002\u4e00\u65e6\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757\u635f\u574f\uff0c\u6211\u4eec\u7acb\u523b\u53ef\u4ee5\u4f7f\u7528 <code>e2fsck -b xxxx</code> \u7684\u65b9\u5f0f\u542f\u7528\u5907\u7528\u7684\u8d85\u7ea7\u5757\u3002</p> <p>\u8fd9\u91cc\u7684 xxx \u5c31\u662f\u4f60\u7684\u5907\u4efd\u8d85\u7ea7\u5757\u7684\u4f4d\u7f6e\uff0c\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u7b2c\u4e00\u4e2a\u8d85\u7ea7\u5757\u5907\u4efd\u4f4d\u7f6e\u662f 8193\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u4f7f\u7528</p> <p><code>e2fsck -b 8193 /dev/sda1</code></p> <p>\u6765\u6062\u590d\u8d85\u7ea7\u5757\u3002</p> <p>\u9664\u4e86\u8fd9\u4e9b\u91cd\u8981\u4fe1\u606f\u5916\uff0c\u5bf9 dumpe2fs \u7684\u6df1\u5165\u5206\u6790\uff0c\u751a\u81f3\u53ef\u4ee5\u5c06\u4e00\u4e2a\u4e00\u7ecf\u65e0\u6cd5\u901a\u8fc7\u6062\u590d\u8d85\u7ea7\u5757\u6765\u8bbf\u95ee\u7684\u6587\u4ef6\u7cfb\u7edf\u7684\u6570\u636e\u5bfc\u51fa\u6765\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-e","title":"/sbin/ \u4e0b e \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>/sbin/ \u4e0b e \u5f00\u5934\u7684\u547d\u4ee4\u6bd4\u8f83\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p> <pre><code>e2fsck ela_remove elvtune evlfacility evlogmgr evSubagent\ne2image ela_remove_all ether-wake evlgentmpls evlogrmtd\ne2label ela_show ethtool evlnotify evlsend\nela_add ela_show_all evlactiond evlnotifyd evltc\nela_get_atts ela_sig_send evlconfig evlogd evlview\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#e2fsck","title":"e2fsck","text":"<p>\u68c0\u67e5\u548c\u4fee\u590d ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd9\u4f3c\u4e4e\u662f\u76ee\u524d Linux \u4e0b\u552f\u4e00\u4e00\u4e2a\u5bf9\u6587\u4ef6\u7cfb\u7edf\u505a\u4fee\u590d\u7684\u5de5\u5177\u3002</p> <p>\u4ed6\u540c\u65f6\u4e5f\u662f\u4e00\u4e2a\u53cc\u5203\u5251\u3002\u5728\u5b9e\u9645\u7684\u6587\u4ef6\u7cfb\u7edf\u4fee\u590d\u7ecf\u9a8c\u4e2d\uff0c\u6211\u9047\u5230\u4e86\u4e24\u96be\u7684\u95ee\u9898\u3002\u6839\u6587\u4ef6\u7cfb\u7edf\u635f\u574f\u4e86\uff0c\u9700\u8981\u4fee\u590d\uff0c\u7cfb\u7edf\u4f1a\u63d0\u793a\u4f60\u8981\u7528 e2fsck \u6765\u4fee\u590d\u3002 \u5f53\u7136\u4f60\u53ef\u4ee5\u6309\u7167\u4ed6\u7684\u63d0\u793a\u53bb\u505a\uff0c\u4f46\u662f\u5f88\u53ef\u80fd\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u7b49\u4f60\u4fee\u590d\u5b8c\u4e86\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e5f\u80fd\u6b63\u5e38\u5de5\u4f5c\u4e86\uff0c\u4f46\u662f\u5f80\u5f80\u6700\u91cd\u8981\u7684\u6587\u4ef6\u88ab\u4fee\u590d\u5f97\u4e0d\u52a0\u4e86\u3002 \u8fd9\u4e0d\u662f\u5f00\u73a9\u7b11\uff0c\u800c\u662f\u6709\u5927\u91cf\u7684\u6848\u4f8b\u3002\u5982\u679c\u5728\u4fee\u590d\u548c\u635f\u574f\u4e4b\u95f4\u53d6\u5f97\u4e00\u79cd\u5e73\u8861\u9700\u8981\u6839\u636e\u5177\u4f53\u7684\u60c5\u51b5\u6765\u5b9a\u593a\u3002</p> <p>e2fsck \u63a5\u53d7\u7684\u53c2\u6570\u6bd4\u8f83\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p> <ul> <li><code>-a</code>: \u4e0d\u8be2\u95ee\u4f7f\u7528\u8005\u610f\u89c1\uff0c\u4fbf\u81ea\u52a8\u4fee\u590d\u6587\u4ef6\u7cfb\u7edf</li> <li><code>-b</code>: \u6307\u5b9a superblock\uff0c\u800c\u4e0d\u4f7f\u7528\u9884\u8bbe\u7684 superblock</li> <li><code>-B</code>: \u6307\u5b9a\u533a\u5757\u7684\u5927\u5c0f\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282</li> <li><code>-c</code>: \u4e00\u5e76\u6267\u884c badblocks\uff0c\u4ee5\u6807\u793a\u635f\u574f\u7684\u533a\u5757</li> <li><code>-C</code>: \u5c06\u68c0\u67e5\u8fc7\u7a0b\u7684\u4fe1\u606f\u5b8c\u6574\u8bb0\u5f55\u5728 file descriptor \u4e2d\uff0c\u4f7f\u5f97\u6574\u4e2a\u68c0\u67e5\u8fc7\u7a0b\u90fd\u80fd\u5b8c\u6574\u76d1\u63a7</li> <li><code>-d</code>: \u663e\u793a\u6392\u9519\u4fe1\u606f</li> <li><code>-f</code>: \u5373\u4f7f\u6587\u4ef6\u7cfb\u7edf\u6ca1\u6709\u9519\u8bef\u8ff9\u8c61\uff0c\u4ecd\u5f3a\u5236\u5730\u68c0\u67e5\u6b63\u786e\u6027</li> <li><code>-F</code>: \u6267\u884c\u524d\u5148\u6e05\u9664\u8bbe\u5907\u7684\u7f13\u51b2\u533a</li> <li><code>-l</code>: \u5c06\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u52a0\u5230\u635f\u574f\u533a\u5757\u5217\u8868</li> <li><code>-L</code>: \u5148\u6e05\u9664\u635f\u574f\u533a\u5757\u5217\u8868\uff0c\u518d\u5c06\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u52a0\u5230\u635f\u574f\u533a\u5757\u5217\u8868\u3002\u56e0\u6b64\u635f\u574f\u533a\u5757\u5217\u8868\u7684\u533a\u5757\u8ddf\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u533a\u5757\u662f\u4e00\u6837\u7684</li> <li><code>-n</code>: \u4ee5\u53ea\u8bfb\u6a21\u5f0f\u5f00\u542f\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u91c7\u53d6\u975e\u4e92\u52a8\u65b9\u5f0f\u6267\u884c\uff0c\u6240\u6709\u7684\u95ee\u9898\u5bf9\u8bdd\u5747\u8bbe\u7f6e\u4ee5\"no\"\u56de\u7b54</li> <li><code>-p</code>: \u4e0d\u8be2\u95ee\u4f7f\u7528\u8005\u610f\u89c1\uff0c\u4fbf\u81ea\u52a8\u4fee\u590d\u6587\u4ef6\u7cfb\u7edf</li> <li><code>-r</code>: \u6b64\u53c2\u6570\u53ea\u4e3a\u4e86\u517c\u5bb9\u6027\u800c\u5b58\u5728\uff0c\u5e76\u65e0\u5b9e\u9645\u4f5c\u7528</li> <li><code>-s</code>: \u5982\u679c\u6587\u4ef6\u7cfb\u7edf\u7684\u5b57\u8282\u987a\u5e8f\u4e0d\u9002\u5f53\uff0c\u5c31\u4ea4\u6362\u5b57\u8282\u987a\u5e8f\uff0c\u5426\u5219\u4e0d\u505a\u4efb\u4f55\u52a8\u4f5c</li> <li><code>-S</code>: \u4e0d\u7ba1\u6587\u4ef6\u7cfb\u7edf\u7684\u5b57\u8282\u987a\u5e8f\uff0c\u4e00\u5f8b\u4ea4\u6362\u5b57\u8282\u987a\u5e8f</li> <li><code>-t</code>: \u663e\u793a\u65f6\u95f4\u4fe1\u606f</li> <li><code>-v</code>: \u6267\u884c\u65f6\u663e\u793a\u8be6\u7ec6\u7684\u4fe1\u606f</li> <li><code>-V</code>: \u663e\u793a\u7248\u672c\u4fe1\u606f</li> <li><code>-y</code>: \u91c7\u53d6\u975e\u4e92\u52a8\u65b9\u5f0f\u6267\u884c\uff0c\u6240\u6709\u7684\u95ee\u9898\u5747\u8bbe\u7f6e\u4ee5\"yes\"\u56de\u7b54\u3002</li> </ul> <p>e2fsck \u6267\u884c\u540e\u7684\u4f20\u56de\u503c\u53ca\u4ee3\u8868\u610f\u4e49\u5982\u4e0b\uff1a</p> <ul> <li>0: \u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u53d1\u751f\u3002</li> <li>1: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u5e76\u4e14\u5df2\u7ecf\u4fee\u6b63\u3002</li> <li>2: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u5e76\u4e14\u5df2\u7ecf\u4fee\u6b63\u3002</li> <li>4: \u6587\u4ef6\u7cfb\u7edf\u53d1\u751f\u9519\u8bef\uff0c\u4f46\u6ca1\u6709\u4fee\u6b63\u3002</li> <li>8: \u8fd0\u4f5c\u65f6\u53d1\u751f\u9519\u8bef\u3002</li> <li>16: \u4f7f\u7528\u7684\u8bed\u6cd5\u53d1\u751f\u9519\u8bef\u3002</li> <li>128: \u5171\u4eab\u7684\u51fd\u6570\u5e93\u53d1\u751f\u9519\u8bef\u3002</li> </ul>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#e2image","title":"e2image","text":"<p>\u4fdd\u5b58\u5173\u952e\u7684 ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u5230\u6587\u4ef6\u3002 e2image \u53ef\u4ee5\u7528\u6765\u521b\u5efa ext2 \u548c ext3 \u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002 e2image \u53ea\u89e3\u91ca\u9700\u8981\u88ab\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u800c\u4e0d\u662f\u4fdd\u5b58\u539f\u59cb bit\u3002 e2image \u53ef\u4ee5\u521b\u5efa <code>raw</code> \u548c <code>nomal</code> \u955c\u50cf\uff0c\u8fd9\u4e24\u79cd\u65b9\u6cd5\u90fd\u53ef\u4ee5\u8282\u7ea6\u7a7a\u95f4\u3002</p> <p>\u56e0\u6b64\uff0c\u7528 e2image \u521b\u5efa\u7684\u955c\u50cf\u540c\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u6709\u4e0d\u540c\u7684 hash\uff0c\u4ece\u8fd9\u70b9\u4e0a\u770b\uff0c\u4ed6\u662f\u548c dd \u547d\u4ee4\u4e0d\u540c\u7684\u3002</p> <p>\u4f46\u662f\u5982\u4f55\u5c06 e2image \u521b\u5efa\u7684\u5907\u4efd\u6062\u590d\u51fa\u6765\u5462\uff1f\u8fd9\u70b9\u5728 e2image \u7684 help \u548c man \u624b\u518c\u4e2d\u90fd\u6ca1\u6709\u63d0\u5230</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50\uff0c\u5206\u90e8\u521b\u5efa\u4e86 <code>raw</code> \u548c <code>normal</code> \u955c\u50cf</p> <pre><code># e2image /dev/sda1 /tmp/e2image.data\ne2image 1.35 (28-Feb-2004)\n\n# ls -lh /tmp/e2image.data\n-rw\u2014\u2014- 1 root root 625K 1\u6708 31 21:18 /tmp/e2image.data\n\n# file /tmp/e2image.data\n/tmp/e2image.data: Linux rev 1.0 ext3 filesystem data\n\n# mount /tmp/e2image.data /misc -oloop\nmount: wrong fs type, bad option, bad superblock on /dev/loop0,\nor too many mounted file systems\n(could this be the IDE device where you in fact use\nide-scsi so that sr0 or sda or so is needed?)\n\n# mount -r /tmp/e2image.data /tmp/e2image_raw_data\nmount: mount point /tmp/e2image_raw_data does not exist\n\n# e2image -r /dev/sda1 /tmp/e2image_raw_data\ne2image 1.35 (28-Feb-2004)\n\n# ls -lh /tmp/e2image_raw_data\n-rw\u2014\u2014- 1 root root 20M 1\u6708 31 21:20 /tmp/e2image_raw_data\n\n# file /tmp/e2image_raw_data\n/tmp/e2image_raw_data: Linux rev 1.0 ext3 filesystem data\n\n# mount /tmp/e2image_raw_data /misc -oloop\n\n# df -h\nFilesystem            \u5bb9\u91cf \u5df2\u7528 \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/tmp/e2image_raw_data 19M 1.2M 17M 7% /misc\n\n# mount /dev/sda1 /misc\n\n# df -h\nFilesystem \u5bb9\u91cf \u5df2\u7528 \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/sda1 19M 1.2M 17M 7% /misc\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#e2label","title":"e2label","text":"<p>\u663e\u793a\u6216\u8005\u4fee\u6539 ext2/ext3 \u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u7b7e\u3002\u6ca1\u6709\u6ce8\u610f\u8fc7\u4ece\u54ea\u4e2a\u7248\u672c\u5f00\u59cb\uff0c<code>/etc/fstab</code> \u6587\u4ef6\u91cc\u7684\u6302\u8f7d\u8bbe\u5907\u540d\u4e0d\u518d\u662f\u5b9e\u9645\u7684\u8bbe\u5907\u540d\u79f0\u4e86\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u5176\u6807\u7b7e\uff0c\u8fd9\u589e\u52a0\u4e86\u5176\u7075\u6d3b\u6027\uff0c \u7279\u522b\u662f\u5f53\u5220\u9664\u5e76\u4e0d\u662f\u6700\u540e\u4e00\u4e2a\u53bb\u5206\u533a\u65f6\uff0c\u5728\u6b64\u5206\u533a\u524d\u7684\u8bbe\u5907\u53f7\u90fd\u4f1a\u63d0\u524d\u4e00\u4f4d\uff0c\u5982\u679c <code>/etc/fstab</code> \u5199\u5165\u7684\u662f\u5b9e\u9645\u7684\u8bbe\u5907\u540d\u79f0\uff0c\u90a3\u663e\u7136\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c \u7cfb\u7edf\u4e5f\u8bb8\u627e\u4e0d\u5230\u9700\u8981\u7684\u8bbe\u5907\u3002\u800c\u91c7\u7528\u6807\u7b7e\u7684\u8bdd\uff0c\u53ea\u8981\u6807\u7b7e\u4e0d\u91cd\u590d\uff0c\u5373\u4f7f\u8bbe\u5907\u6709 sda \u53d8\u6210\u4e86 sdb\uff0cLinux \u7cfb\u7edf\u4f9d\u7136\u80fd\u6b63\u5e38\u542f\u52a8\u3002</p> <p>\u8fd9\u4e2a\u547d\u4ee4\u975e\u5e38\u7b80\u5355\u3002\u770b\u4e0b\u9762\u7684\u5b9e\u4f8b\u5c31\u660e\u767d\u4e86</p> <pre><code># e2label /dev/sda1\n\n# e2label /dev/sda1 newlabel\n\n# e2label /dev/sda1\nnewlabel\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#elvtune","title":"elvtune","text":"<p>I/O \u7535\u68af\u8c03\u8bd5\u5668\uff0c\u5141\u8bb8\u4f60\u8c03\u8bd5\u6bcf\u4e00\u4e2a\u5757\u8bbe\u5907\u7684 I\uff0fO \u7535\u68af\u7b97\u6cd5\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u5b9e\u73b0\u4e00\u8def\u548c\u4e8c\u8def\u7535\u68af\u7b97\u6cd5\u3002</p> <p>\u540c\u65f6\u5bf9\u4e8e LVM \u800c\u8a00\uff0c\u8c03\u8bd5\u5668\u4ec5\u4ec5\u5728\u7269\u7406\u5377(PV)\u4e0a\u6709\u6548\u679c\uff0c\u5bf9\u903b\u8f91\u5377\uff08LV\uff09\u6ca1\u6709\u7528\u3002</p> <p>\u4e0d\u8fc7\u8fd9\u4e2a\u547d\u4ee4\u8981\u6c42\u7684\u8bbe\u5907\u53c2\u6570\u662f/dev/blkdevX (X \u8868\u793a\u6570\u5b57\uff09\uff0c\u6211\u5c1d\u8bd5\u4f20\u9012 /dev/sda1,/dev/hda1\uff0c\u5747\u62a5\u544a\u65e0\u6548\u7684\u53c2\u6570\u3002</p> <p>\u6240\u4ee5\u6ca1\u6709\u89c9\u5f97\u8fd9\u4e2a\u547d\u4ee4\u5230\u5e95\u80fd\u7ed9\u6211\u4eec\u5e26\u6765\u4ec0\u4e48\uff0c\u7279\u522b\u662f\u5728 man \u624b\u518c\u7684\u5386\u53f2\u4e00\u9879\u4e2d\u8fd9\u6837\u5199\u9053\uff1a</p> <p>Ioctls for tuning elevator behaviour were added in Linux 2.3.99-pre1.</p> <p>\u611f\u89c9\u5e94\u8be5\u662f\u4e00\u4e2a\u4e34\u65f6\u5de5\u5177\uff0c\u4f46\u662f\u4ed6\u5c5e\u4e8e util-linux \u5de5\u5177\u5305\uff0c\u4e0d\u89e3\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#ether-wake","title":"ether-wake","text":"<p>\u8fd9\u4e2a\u547d\u4ee4\u7528\u6765\u4ea7\u751f\u548c\u53d1\u9001\u4e00\u4e2a Wake-On-LAN(WOL)\u6570\u636e\u5305(MagicPacker)\u5305\uff0c\u7528\u6765\u91cd\u542f\u8f6f\u5173\u673a\u7684\u673a\u5668\u3002\u8fd9\u4e2a\u73a9\u610f\u6ca1\u6709\u529e\u6cd5\u6d4b\u8bd5\uff0c\u4e5f\u4e0d\u77e5\u9053\u5b9e\u9645\u73af\u5883\u4e2d\u662f\u5426\u7528\u5f97\u591a\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#ethtool","title":"ethtool","text":"<p>\u663e\u793a\u6216\u4fee\u6539\u4ee5\u592a\u7f51\u5361\u7684\u8bbe\u7f6e\uff0c\u8fd9\u91cc\u7684\u8bbe\u7f6e\u771f\u7684\u662f\u786c\u4ef6\u65b9\u9762\u7684\uff0c\u6bd4\u5982\u5f3a\u5236\u4e3a\u534a\u53cc\u5de5\u7b49\u3002</p> <p>\u6700\u5f00\u59cb\u6211\u7528\u8fd9\u4e2a\u547d\u4ee4\u662f\u6709\u4e00\u4e2a\u7528\u6237\u8bf4\u4ed6\u7684\u7f51\u5361\u660e\u660e\u662f\u5168\u53cc\u5de5\u7684\uff0c\u4e3a\u4ec0\u4e48\u7cfb\u7edf\u91cc\u770b\u5230\u7684\u662f\u534a\u53cc\u5de5\u5440\uff0c\u6709\u4ec0\u4e48\u529e\u6cd5\u6539\u5417\uff1fifconfig \u547d\u4ee4\u770b\u4e86\u534a\u5929\u540e\u6ca1\u6709\u627e\u5230\u597d\u7684\u8bbe\u7f6e\u65b9\u5f0f\uff0c \u540e\u6765\u627e\u5230\u4e86\u8fd9\u4e2a ethtool\uff0c\u89e3\u51b3\u4e86\u95ee\u9898\u3002\u5176\u5b9e mii-tool \u4e5f\u80fd\u505a\u5230\u8fd9\u70b9\uff0c\u4f46\u662f\u6709\u4e9b\u7f51\u5361\u9a71\u52a8\u76ee\u524d\u8fd8\u4e0e\u652f\u6301 mii-tool \u5de5\u5177\u3002</p> <p>ethtool \u7684\u547d\u4ee4\u6bd4\u8f83\u590d\u6742\uff0c\u53c2\u6570\u4e5f\u591a\uff0c\u6211\u4eec\u770b\u51e0\u4e2a\u4f8b\u5b50\uff0c\u7136\u540e\u5217\u51fa man \u624b\u518c\u3002</p> <p>\u6253\u5370\u5f53\u524d\u7f51\u5361\u7684\u914d\u7f6e\u4fe1\u606f</p> <pre><code># ethtool eth0\nSettings for eth0:\nSupported ports: [ TP MII ]\nSupported link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nSupports auto-negotiation: Yes\nAdvertised link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nAdvertised auto-negotiation: No \u6ce8\uff1a\u81ea\u52a8\u534f\u5546\u5173\u95ed\nSpeed: 100Mb/s // 100Mb\nDuplex: Full //\u5168\u53cc\u5de5\nPort: MII /\u652f\u6301mii\u6a21\u5f0f\nPHYAD: 32\nTransceiver: internal\nAuto-negotiation: off\nSupports Wake-on: pumbg\nWake-on: d\nCurrent message level: 0\u00d700000007 (7)\nLink detected: yes\n</code></pre> <p>\u5c06\u7f51\u5361\u4fee\u6539\u6210 10Mbps\uff0c\u534a\u53cc\u5de5</p> <pre><code># ethtool -s eth1 speed 10 duplex half\n# ethtool eth1\nSettings for eth1:\nSupported ports: [ TP MII ]\nSupported link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nSupports auto-negotiation: Yes\nAdvertised link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nAdvertised auto-negotiation: No\nSpeed: 10Mb/s # 10Mbps\nDuplex: Half #\u5df2\u7ecf\u4fee\u6539\u4e3a\u534a\u53cc\u5de5\u4e86\nPort: MII\nPHYAD: 32\nTransceiver: internal\nAuto-negotiation: off\nSupports Wake-on: pumbg\nWake-on: d\nCurrent message level: 0\u00d700000007 (7)\nLink detected: no\n</code></pre> <p>\u5c06\u7f51\u5361\u4fee\u6539\u4e3a 100M\uff0c\u5168\u53cc\u5de5</p> <pre><code># ethtool -s eth1 speed 100 duplex full\n# ethtool eth1\nSettings for eth1:\nSupported ports: [ TP MII ]\nSupported link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nSupports auto-negotiation: Yes\nAdvertised link modes: 10baseT/Half 10baseT/Full\n100baseT/Half 100baseT/Full\nAdvertised auto-negotiation: No\nSpeed: 100Mb/s #\nDuplex: Full #\nPort: MII\nPHYAD: 32\nTransceiver: internal\nAuto-negotiation: off\nSupports Wake-on: pumbg\nWake-on: d\nCurrent message level: 0\u00d700000007 (7)\nLink detected: no\n</code></pre> <p>\u6211\u4eec\u518d\u770b\u770b man \u624b\u518c</p> <pre><code> ethtool ethX #\u663e\u793a\u7f51\u5361\u7684\n ethtool -h #\u6253\u5370\u5e2e\u52a9\n ethtool -a ethX #\u67e5\u8be2\u6307\u5b9a\u7f51\u5361\u7684\u6682\u505c(pause)\u53c2\u6570\u4fe1\u606f\n ethtool -A ethX [autoneg on|off] [rx on|off] [tx on|off] #\u8bbe\u7f6e\u6682\u505c\u53c2\u6570\n ethtool -c ethX #\u67e5\u8be2\u6307\u5b9a\u7f51\u5361\u7684\u8054\u5408(coalesc)\u4fe1\u606f\n\n ethtool -C ethX [adaptive-rx on|off] [adaptive-tx on|off] [rx-usecs N]\n [rx-frames N] [rx-usecs-irq N] [rx-frames-irq N] [tx-usecs N] [tx-\n frames N] [tx-usecs-irq N] [tx-frames-irq N] [stats-block-usecs N]\n [pkt-rate-low N] [rx-usecs-low N] [rx-frames-low N] [tx-usecs-low N]\n [tx-frames-low N] [pkt-rate-high N] [rx-usecs-high N] [rx-frames-high\n N] [tx-usecs-high N] [tx-frames-high N] [sample-interval N] #\u8bbe\u7f6e\u6307\u5b9a\u7f51\u5361\u7684\u8054\u5408\u4fe1\u606f\n\n ethtool -g ethX #\u67e5\u8be2\u7f51\u5361\u7684RX/TX\u53c2\u6570\u4fe1\u606f\n ethtool -G ethX [rx N] [rx-mini N] [rx-jumbo N] [tx N] #\u8bbe\u7f6e\u7f51\u5361\u7684RX/TX\u53c2\u6570\n ethtool -i ethX #\u67e5\u8be2\u4e0e\u7f51\u5361\u5173\u8054\u7684\u9a71\u52a8\u4fe1\u606f\n ethtool -d ethX #\u91cd\u65b0\u83b7\u53d6\u548c\u6253\u5370\u4e00\u4e2a\u7f51\u5361\u7684\u6ce8\u518cdump\u4fe1\u606f\n ethtool -e ethX [raw on|off] [offset N] [length N] #\u91cd\u65b0\u83b7\u53d6\u548c\u6253\u5370\u7f51\u5361\u7684EEPROMdump\u4fe1\u606f\n ethtool -E ethX [magic N] [offset N] [value N] #\u4fee\u6539\u7f51\u5361\u7684EEPROM\u5b57\u8282\n ethtool -k ethX #\u67e5\u8be2\u7f51\u5361\u7684\u5378\u8f7d(offload)\u4fe1\u606f\n ethtool -K ethX [rx on|off] [tx on|off] [sg on|off] [tso on|off] #\u4fee\u6539\u7f51\u5361\u7684\u5378\u8f7d\u53c2\u6570\n ethtool -r ethX #\u91cd\u542f\u7f51\u5361\u7684\u81ea\u52a8\u534f\u5546(auto-negotiation)\u529f\u80fd\uff0c\u5982\u679c\u8fd9\u4e2a\u529f\u80fd\u8bbe\u7f6e\u4f4d\u53ef\u7528\u7684\u8bdd\n ethtool -t ethX [offline|online] #\u6267\u884c\u7f51\u5361\u81ea\u68c0\u7a0b\u5e8f\n ethtool -s ethX [speed 10|100|1000] [duplex half|full]\n [port tp|aui|bnc|mii] [autoneg on|off] [phyad N] [xcvr internal|exter-\n nal] [wol p|u|m|b|a|g|s|d...] [sopass xx:yy:zz:aa:bb:cc] [msglvl N] #\u53ef\u4ee5\u4fee\u6539\u7684\u53c2\u6570\u503c\uff0c\u7528-s\u6765\u6807\u5fd7\n</code></pre> <p>\u8fd9\u4e9b\u8bbe\u7f6e\u4ec5\u4ec5\u5728\u5f53\u524d\u751f\u6548\uff0c\u4e00\u65e6\u91cd\u542f\u7f51\u7edc\u6216\u8005\u91cd\u542f\u7cfb\u7edf\uff0cethtool \u7684\u8bbe\u7f6e\u5c06\u4f1a\u5931\u6548\u3002\u6211\u4eec\u53ef\u4ee5\u628a ethtool \u7684\u8bbe\u7f6e\u547d\u4ee4\u52a0\u5165\u5230 ifcfg-ethX \u914d\u7f6e\u6587\u4ef6\u4e2d\u3002 \u6bd4\u5982\uff0c\u4f60\u5e0c\u671b\u628a\u7b2c\u4e00\u5757\u7f51\u5361\u8bbe\u7f6e\u4e3a\u5168\u53cc\u5de5\uff0c\u81ea\u9002\u5e94\u548c 100M \u7684\u65b9\u5f0f\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u5728\u4f60\u7684 <code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> \u6587\u4ef6\u4e2d\u52a0\u5165\u4e0b\u9762\u4e00\u884c\uff1a</p> <pre><code>ETHTOOL_OPTS=\"speed 100 duplex full autoneg off\"\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-f","title":"/sbin \u4e0b f \u5f00\u5934\u7684\u547d\u4ee4\u5982\u4e0b","text":"<p>fdisk fixfiles fsck.cramfs fsck.ext3 fsck.ocfs2 fsck.vfat fuser findfs fsck fsck.ext2 fsck.msdos fsck.reiserfs fsck.xfs fxload</p> <p>\u5176\u4e2d<code>fsck.reiserfs</code> \u662f <code>reiserfsck</code> \u547d\u4ee4\u7684\u8f6f\u8fde\u63a5\uff0cf \u5f00\u5934\u7684\u547d\u4ee4\u4e2d fsck \u547d\u4ee4\u5957\u4ef6\u5360\u4e86\u7edd\u5927\u90e8\u5206\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#findfs","title":"findfs","text":"<p>\u6839\u636e\u6807\u7b7e(label)\u6216\u8005 UUID \u53f7\u6765\u67e5\u8be2\u6587\u4ef6\u7cfb\u7edf\u3002\u4ed6\u4f1a\u641c\u7d22\u6574\u4e2a\u78c1\u76d8\uff0c\u770b\u662f\u5426\u6709\u5339\u914d\u7684\u6807\u7b7e\u6216\u8005 UUID \u6ca1\u6709\uff0c\u5982\u679c\u6709\uff0c\u5219\u6253\u5370\u5230\u6807\u6ce8\u8f93\u51fa\u4e0a\u3002\u4ed6\u4e5f\u662fe2fsprogs\u9879\u76ee\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p> <pre><code># findfs \u2013help\nUsage: findfs LABEL=|UUID=\n\n# findfs LABEL=/\n/dev/hda5\n\n# findfs LABEL=/home\nfindfs: Unable to resolve 'LABEL=/home'\n</code></pre> <p>\u6211\u6ca1\u6709\u641e\u6e05\u695a\u8fd9\u4e2a\u547d\u4ee4\u5230\u5e95\u6709\u4ec0\u4e48\u7528\u6216\u8005\u5e94\u8be5\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f7f\u7528\uff1f\u56e0\u4e3a\u77e5\u9053 LABEL \u6216\u8005 UUID \u5e76\u4e0d\u50cf\u5e73\u5e38\u77e5\u9053\u67d0\u4e00\u4e2a\u6587\u4ef6\u90a3\u6837\u5bb9\u6613\u8bb0\u4f4f\u3002\u6240\u4ee5\u4ed6\u548c find \u7684\u4f7f\u7528\u8303\u56f4\u76f8\u6bd4\uff0c\u5c31\u5c0f\u4e86\u5f88\u591a\u4e86\uff0c\u96be\u9053\u4ed6\u6709\u610f\u60f3\u4e0d\u5230\u7684\u7528\u9014\uff1f</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#fixfiles","title":"fixfiles","text":"<p>\u4fee\u590d\u6587\u4ef6\u5b89\u5168\u4e0a\u4e0b\u6587(security contexts)\u3002\u8fd9\u662f\u4e00\u4e2a shell \u811a\u672c\uff0c\u4e3b\u8981\u662f\u7528\u6765\u6821\u6b63\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u5b89\u5168\u4e0a\u4e0b\u6587\u6570\u636e\u5e93\uff08\u6269\u5c55\u5c5e\u6027\uff09\u3002 \u4ed4\u7ec6\u770b\u4e86\u5e2e\u52a9\uff0c\u4e5f\u4f5c\u4e86\u4e00\u4e9b\u6d4b\u8bd5\uff0c\u6ca1\u6709\u660e\u767d\u4ed6\u8981\u8868\u8fbe\u4ec0\u4e48\uff0c\u521a\u5f00\u59cb\u4ee5\u4e3a\u662f\u4ed6\u4f1a\u6062\u590d\u6211\u539f\u6765\u4fee\u6539\u8fc7\u67d0\u4e9b\u914d\u7f6e\u6587\u4ef6\u5230\u521d\u59cb\u72b6\u6001\uff0c\u5f53\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u4f3c\u4e4e\u4e0d\u662f\u8fd9\u56de\u4e8b\u3002 \u6240\u5c5e\u4e8e policycoreutils RPM \u5305\uff0c\u8fd9\u662f SELinux \u7684\u4e00\u90e8\u5206\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#fuser","title":"fuser","text":"<p>\u4f7f\u7528\u6587\u4ef6\u6216\u8005\u5957\u8282\u5b57\u6765\u8868\u793a\u8bc6\u522b\u8fdb\u7a0b\u3002\u6211\u5e38\u7528\u7684\u4ed6\u7684\u4e24\u4e2a\u529f\u80fd\uff1a\u67e5\u770b\u6211\u9700\u8981\u7684\u8fdb\u7a0b\u548c\u6211\u8981\u6740\u6b7b\u6211\u67e5\u5230\u7684\u8fdb\u7a0b\u3002</p> <p>\u6bd4\u5982\u5f53\u4f60\u60f3 umount \u5149\u9a71\u7684\u65f6\u5019\uff0c\u7ed3\u679c\u7cfb\u7edf\u63d0\u793a\u4f60\u8bbe\u5907\u6b63\u5728\u4f7f\u7528\u6216\u8005\u6b63\u5fd9\uff0c\u53ef\u662f\u4f60\u53c8\u627e\u4e0d\u5230\u5230\u5e95\u8c01\u4f7f\u7528\u4e86\u4ed6\u3002\u8fd9\u4e2a\u65f6\u5019 fuser \u53ef\u6d3e\u4e0a\u7528\u573a\u4e86\u3002</p> <pre><code># eject\numount: /media/cdrom: device is busy\numount: /media/cdrom: device is busy\neject: unmount of '/media/cdrom' failed\n\n# fuser /mnt/cdrom\n/mnt/cdrom: 4561c 5382c\n\n# ps -ef |egrep '(4561|5382)' |grep -v grep\n\nroot 4561 4227 0 20:13 pts/1 00:00:00 bash\nroot 5382 4561 0 21:42 pts/1 00:00:00 vim Autorun.inf\n</code></pre> <p>\u793a\u4f8b\u4e2d\uff0c\u6211\u60f3\u5f39\u51fa\u5149\u9a71\uff0c\u7cfb\u7edf\u544a\u8bc9\u6211\u8bbe\u5907\u5fd9\u7740\uff0c\u4e8e\u662f\u91c7\u7528 fuser \u547d\u4ee4\uff0c\u53c2\u6570\u662f\u4f60\u6587\u4ef6\u6216 scoket\uff0cfuser \u5c06\u67e5\u51fa\u90a3\u4e9b\u4f7f\u7528\u4e86\u4ed6\u3002</p> <p><code>4561c,5382c</code> \u8868\u793a\u76ee\u524d\u7528\u4e24\u4e2a\u8fdb\u7a0b\u5728\u5360\u7528\u7740 <code>/mnt/cdrom</code>\uff0c\u5206\u522b\u662f 4561,5382,\u8fdb\u7a0b ID \u540e\u7684\u5b57\u6bcd\u8868\u793a\u5360\u7528\u8d44\u6e90\u7684\u65b9\u5f0f\uff0c\u6709\u4e0b\u9762\u51e0\u79cd\u8868\u793a\uff1a</p> <ul> <li>c \u5f53\u524d\u8def\u5f84(current directory.)\u6211\u7684\u7406\u89e3\u662f\u8868\u793a\u8fd9\u4e2a\u8d44\u6e90\u7684\u5360\u7528\u662f\u4ee5\u6587\u4ef6\u76ee\u5f55\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8fdb\u8fdb\u5165\u4e86\u9700\u8981\u91ca\u653e\u7684\u8d44\u6e90\u7684\u8def\u5f84\uff0c\u8fd9\u662f\u6700\u5e38\u7528\u7684\u8d44\u6e90\u5360\u7528\u65b9\u5f0f\u3002</li> <li>e \u6b63\u5728\u8fd0\u884c\u53ef\u6267\u884c\u6587\u4ef6\uff08executable being run.\uff09\uff0c\u6bd4\u5982\u8fd0\u884c\u4e86\u5149\u76d8\u4e0a\u7684\u67d0\u4e2a\u7a0b\u5e8f</li> <li>f \u6253\u5f00\u6587\u4ef6\uff08 open file\uff09\uff0c\u7f3a\u7701\u6a21\u5f0f\u4e0b f \u5ffd\u7565\u3002</li> <li>m mmap \u6587\u4ef6\u6216\u8005\u5171\u4eab\u5e93( mmap\u2019ed file or shared library)</li> <li>\u6240\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u867d\u7136\u662f\u5f00\u6253\u4e86\u5149\u76d8\u4e0a\u7684 Autorun.inf \u6587\u4ef6\uff0c\u4f46\u662f\u7ed9\u51fa\u7684\u6807\u8bc6\u662f c\uff0c\u800c\u4e0d\u662f f\u3002   root \u76ee\u5f55\uff08root directory\uff09.\u6ca1\u6709\u660e\u767d\u4ec0\u4e48\u610f\u601d\uff0c\u96be\u9053\u662f\u8bf4\u8fdb\u5165\u4e86/root \u8fd9\u4e2a\u7279\u5b9a\u76ee\u5f55\uff1f   .\u8fd9\u5e94\u8be5\u662f\u8bf4\u67d0\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u4e86\u4f60\u8981\u91ca\u653e\u7684\u8d44\u6e90\u7684\u67d0\u4e2a\u5171\u4eab\u6587\u4ef6\u3002</li> </ul> <p>\u5728\u67e5\u627e\u7684\u540c\u65f6\uff0c\u4f60\u8fd8\u53ef\u5b9a\u6307\u5b9a\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982</p> <ul> <li><code>-k</code>: \u6740\u6b7b\u8fd9\u4e9b\u6b63\u5728\u8bbf\u95ee\u8fd9\u4e9b\u6587\u4ef6\u7684\u8fdb\u7a0b\u3002\u9664\u975e\u4f7f\u7528-signal \u4fee\u6539\u4fe1\u53f7\uff0c\u5426\u5219\u5c06\u53d1\u9001 SIGKILL \u4fe1\u53f7\u3002</li> <li><code>-i</code>: \u4ea4\u4e92\u6a21\u5f0f</li> <li><code>-l</code>: \u5217\u51fa\u6240\u6709\u5df2\u77e5\u7684\u4fe1\u53f7\u540d\u79f0\u3002</li> <li><code>-n</code>: \u7a7a\u95f4\uff0c\u9009\u62e9\u4e0d\u540c\u7684\u540d\u5b57\u7a7a\u95f4\uff0c\u53ef\u662f file,udp,tcp\u3002\u9ed8\u8ba4\u662f file\uff0c\u4e5f\u5c31\u662f\u6587\u4ef6\u3002</li> <li><code>-signal</code>: \u6307\u5b9a\u53d1\u9001\u7684\u4fe1\u53f7\uff0c\u800c\u4e0d\u662f\u7f3a\u7701\u7684 SIGKILL</li> <li><code>-4</code>: \u4ec5\u67e5\u8be2 IPV4 \u5957\u63a5\u5b57</li> <li><code>-6</code>: \u4ec5\u67e5\u8be2 IPV6 \u5957\u63a5\u5b57</li> </ul> <p>\u518d\u770b\u4e0b\u9762\u7684\u4f8b\u5b50</p> <pre><code># fuser -l\nHUP INT QUIT ILL TRAP ABRT IOT BUS FPE KILL USR1 SEGV USR2 PIPE ALRM TERM\nSTKFLT CHLD CONT STOP TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH IO PWR SYS\nUNUSED\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u8bd5\u8bd5 fuser -k \u7684\u5a01\u529b\uff1a</p> <pre><code># fuser -k /mnt/cdrom\n/mnt/cdrom: 4561c 5382c\n\nkill 5382: \u6ca1\u6709\u90a3\u4e2a\u8fdb\u7a0b\nNo automatic removal. Please use umount /media/cdrom\n\n# eject\n</code></pre> <p>\u5957\u8282\u5b57\u65b9\u5f0f\u7684\u4f7f\u7528\uff1a</p> <pre><code># fuser -4 -n tcp 3306\nhere: 3306\n3306/tcp: 5595\n\n# ps -ef |grep 5595 |grep -v grep\n\nmysql 5595 5563 0 22:24 pts/0 00:00:00 /usr/libexec/mysqld \u2013defaults-file=/etc/my.cnf \u2013basedir=/usr \u2013datadir=/var/lib/mysql \u2013user=mysql \u2013pid-file=/var/run/mysqld/mysqld.pid \u2013skip-locking \u2013socket=/var/lib/mysql/mysql.sock\n\n\n# fuser -4 -n tcp 80\nhere: 80\n80/tcp: 5685 5688 5689 5690 5691 5692 5693 5694 5695\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#fxload","title":"fxload","text":"<p>\u4e3a EZ-USB \u8bbe\u522b\u4e0b\u8f7d firmware\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-g","title":"/sbin \u4e0b g \u5f00\u5934\u7684\u547d\u4ee4\uff1a","text":"<p>generate-modprobe.conf getkey grub grub-install grub-terminfo genhostid getmd grubby grub-md5-crypt</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#generate-modprobeconf","title":"generate-modprobe.conf","text":"<p>\u5c06\u539f\u6765\u7684 module.conf \u6587\u4ef6\u8fc1\u79fb\u5230 modprobe.conf \u6587\u4ef6\u3002\u8fd9\u662f 2.4 \u5185\u6838\u5230 2.6 \u5185\u6838\u540e\u9a71\u52a8\u6a21\u5757\u914d\u7f6e\u7684\u4e00\u4e2a\u6539\u53d8\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#getkey","title":"getkey","text":"<p>\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u5185\u7b49\u5f85\u6309\u952e\uff0c\u9ed8\u8ba4\u65f6\u95f4\u5355\u4f4d\u662f\u79d2\u3002\u6bd4\u5982\uff1a</p> <pre><code># getkey -c 5 -m \"Please input a number within 5s[%d]:\"\nPlease input a number within 5s[5]\n</code></pre> <p>\u540e\u9762\u7684<code>[]</code>\u5185\u7684\u65f6\u95f4\u662f\u53d8\u5316\u7684\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#grub","title":"grub","text":"<p>grub, grub-install ,grub-terminfo, grub-md5-crypt,grubby \u8fd9\u8fd9\u4e9b\u547d\u4ee4\u90fd\u662f\u548c grub \u6709\u5173\u7684\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#genhostid","title":"genhostid","text":"<p>\u968f\u673a\u751f\u6210\u4e00\u4e2a hostid \u53f7\uff0c\u5982\u679c <code>/etc/hostid</code> \u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u4ed6\u548c\u6211\u4eec\u901a\u5e38\u4f7f\u7528\u7684 hostid(1)\u6709\u4e9b\u5fae\u5999\u7684\u5173\u7cfb\u3002</p> <p>\u5982\u679c <code>/etc/hostid</code> \u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219 hostid \u547d\u4ee4\u6253\u5370\u51fa\u5f53\u524d\u673a\u5668\u7684\u6807\u5fd7\u53f7\uff0c\u53ea\u8981\u4f60\u7684\u673a\u5668\u786c\u4ef6\u8bbe\u5907\u6ca1\u6709\u66f4\u6362\uff0c\u8fd9\u4e2a ID \u53f7\u5c31\u4e0d\u4f1a\u6539\u53d8\uff0c\u5f88\u591a\u60c5\u51b5\u4e0b\u8fd9\u4e2a\u53f7\u7801\u548c\u4f60\u7684\u7f51\u5361\u6709\u4e00\u5b9a\u7684\u5173\u7cfb\u3002  </p> <p>\u4e8e\u662f\u5728 Linux \u4e0b\uff0c\u5f88\u591a\u8f6f\u4ef6\u7684\u6388\u6743\u53f7\u7801\u5c31\u4e8e hostid \u6709\u5173\u7cfb\uff0c\u56e0\u4e3a\u4e0d\u540c\u7684\u673a\u5668 hostid \u4e0d\u540c\uff0c\u8fd9\u6837\u80fd\u4fdd\u8bc1\u53ea\u6709\u6388\u6743\u7684\u673a\u5668\u624d\u80fd\u5b89\u88c5\u5bf9\u5e94\u7684\u8f6f\u4ef6\u3002  </p> <p>\u4f46\u662f\u5982\u679c <code>/etc/hostid</code> \u6587\u4ef6\u5b58\u5728, hostid \u547d\u4ee4\u5219\u53ea\u662f\u6253\u5370\u51fa\u8be5\u53f7\u7801\uff0c\u800c <code>/etc/hostid</code> \u7684\u751f\u6210\u5c31\u662f\u4f9d\u8d56 genhostid \u547d\u4ee4\u3002  </p> <p>\u4f46\u662f\u6211\u521a\u624d\u8bf4\u4e86\uff0cgenhostid \u662f\u968f\u673a\u4ea7\u751f\u4e00\u4e2a hostid \u53f7\u3002 \u56e0\u6b64\u5982\u679c\u4f60\u5e0c\u671b hostid \u547d\u4ee4\u6bcf\u6b21\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c\uff0c\u90a3\u4e48\u4f60\u5c31\u5e94\u8be5\u6bcf\u6b21\u90fd\u91cd\u65b0\u751f\u6210 /etc/hostid \u6587\u4ef6\u3002\u4e0d\u8fc7\u8981\u6ce8\u610f\u7684\u662f hostid \u547d\u4ee4\u751f\u6210\u7684 hostid \u53f7\u53ea\u6709 6 \u4f4d\uff0c\u800c genhostid \u4ea7\u751f\u7684\u662f 8 \u4f4d\u3002</p> <pre><code># hostid\n7f0100\n\n# genhostid\n# hostid\n804937a4\n\n# rm -f /etc/hostid\n# hostid\n7f0100\n\n# genhostid\n# hostid\n106a8419\n\n# hexdump /etc/hostid\n0000000 8419 106a\n0000004\n</code></pre> <p>\u4ece hexdump \u547d\u4ee4\u7684\u7ed3\u679c\u6765\u770b\uff0c<code>/etc/hostid</code> \u6587\u4ef6\u7ed3\u6784\u4f3c\u4e4e\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u5c1d\u8bd5\u83b7\u5f97\u4e00\u4e2a\u6211\u4eec\u9700\u8981\u7684\u201c\u968f\u673a\u201dhostid \u53f7\u8bd5\u8bd5\u3002</p> <pre><code>// myhostid.c\n#include\n#include\nint main()\n{\n    int fd1;\n    int a=0\u00d712345678; //my hostid\n    fd1=open(\u201chostid\u201d,O_CREAT|O_WRONLY,0220);\n    if (!fd1)\n    {\n        perror(\u201cerror open \u201c);\n        exit(65);\n    }\n    write(fd1,&amp;a,sizeof(a));\n    close(fd1);\n    return 0;\n}\n</code></pre> <pre><code># gcc myhostid.c -o myhostid\n# ./myhostid\n\n# #cp -f hostid /etc/hostid\n# hostid\nd2bdd8ed\n\n# cp -f hostid /etc/hostid\n# hostid\n12345678\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#getmd","title":"getmd","text":"<p>\u5206\u6790<code>/etc/raidtab</code>\u6587\u4ef6\uff0c\u5b83\u662f scsirastools \u5305\u4e2d\u4e00\u4e2a\u547d\u4ee4\uff0c\u8fd9\u4e2a\u5305\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u589e\u52a0\u4e00\u4e9b\u7ba1\u7406 scsi \u8bbe\u5907\u7684\u547d\u4ee4\uff0c\u6709\u4e0b\u9762\u4e00\u4e9b\uff1a</p> <ul> <li><code>sgdskfl</code>:   to load disk firmware to disks under Linux  </li> <li><code>sgmode</code>:   to get and set SCSI mode pages  </li> <li><code>sgdefects</code>:   to read the primary and grown defect lists  </li> <li><code>sgdiag</code>:   to perform format &amp; other test functions  </li> <li><code>sgraidmon</code>:   to monitor software RAID disks for hot-insertion/removal  </li> <li><code>getmd</code>:   to parse /etc/raidtab for devices (used in mdmon only)  </li> <li><code>mdadm</code>:   to administer the md raid configuration  </li> <li><code>alarms</code>:   to set disk fault LEDs on mBMC platforms</li> </ul>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-h","title":"/sbin \u4e0b h \u5f00\u5934\u7684\u547d\u4ee4","text":"","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#halt","title":"halt","text":"<p>\u505c\u6b62\u7cfb\u7edf\uff0c\u4ed6\u548c reboot\uff0cpoweroff \u7b49\u547d\u4ee4\u5c5e\u4e8e\u540c\u4e00\u4e2a\u529f\u80fd\u96c6\u3002</p> <p>halt \u547d\u4ee4\u4e0d\u4e0d\u63a5\u53c2\u6570\uff0c\u4ec5\u4ec5\u6709\u51e0\u4e2a\u9009\u9879\u6765\u51b3\u5b9a\u5982\u4f55\u505c\u6b62\u7cfb\u7edf</p> <ul> <li><code>-n</code>: \u505c\u6b62\u7cfb\u7edf\u524d\u4e0d\u505a\u540c\u6b65(sync)\uff0c\u9002\u5408\u5feb\u901f\u5173\u673a\u548c\u90a3\u4e9b\u4ec5\u4ec5\u53ea\u6709\u53ea\u8bfb\u8bbf\u95ee\u7684\u7cfb\u7edf\u3002  </li> <li><code>-w</code>: \u4ec5\u5728 wtmp \u6587\u4ef6\u4e2d\u5199\u4e00\u6761 reboot \u8bb0\u5f55\uff0c\u7136\u540e\u9000\u51fa\uff0c\u4ed6\u7684\u7528\u5904\u662f\u4ec0\u4e48\uff1f  </li> <li><code>-d</code>: \u4e0d\u5199 reboot \u8bb0\u5f55\u5230 wtmp \u6587\u4ef6\u4e2d  </li> <li><code>-f</code>: \u5f3a\u5236\u505c\u673a/\u91cd\u542f\uff0c\u4f46\u4e0d\u8c03\u7528 shutdown.shutdown \u662f\u4e00\u79cd\u5b89\u5168\u7684\u5173\u95ed\u7cfb\u7edf\u7684\u65b9\u5f0f\u3002  </li> <li><code>-p</code>: \u5982\u679c\u652f\u6301\uff0c\u7cfb\u7edf\u5173\u95ed\u540e\u6389\u7535\u3002\u5426\u5219\u53ea\u662f\u505c\u6b62\u7cfb\u7edf.</li> </ul>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#hdparm","title":"hdparm","text":"<p>\u83b7\u53d6\u548c\u8bbe\u7f6e\u786c\u76d8\u53c2\u6570\uff0c\u5f53\u6211\u4e00\u6b21\u770b\u5230 hdparm \u547d\u4ee4\u548c\u5176\u8bf4\u660e\u65f6\uff0c\u6211\u4ee5\u4e3a\u6211\u53d1\u73b0\u4e86\u4e00\u4e2a\u79d8\u7b08\uff0c\u56e0\u4e3a\u8bf4\u660e\u4e2d\u63d0\u5230\uff0c\u4ed6\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e9b\u5173\u952e\u7684\u53c2\u6570\uff0c\u8ba9\u4f60\u7684\u786c\u76d8\u63d0\u901f\u3002 \u540c\u65f6\u5728\u7f51\u4e0a\u4e5f\u627e\u5230\u4e86\u4e0d\u5c11\u6709\u5173\u8fd9\u4e2a\u547d\u4ee4\u7684\u4ecb\u7ecd\uff0c\u5927\u591a\u6570\u90fd\u8bf4\u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u786c\u76d8\u54cd\u5e94\u901f\u5ea6\uff0c\u8fd8\u6709\u5f88\u591a\u4eba\u7684\u6807\u9898\u5e72\u8106\u662f\u201c\u77ac\u95f4\u63d0\u9ad8\u4f60\u7684 Linux \u7684\u901f\u5ea6\u201d\u3002 \u5176\u5b9e\u5927\u90e8\u5206\u4ecb\u7ecd\u4e2d\uff0c\u4e3b\u8981\u662f\u4fee\u6539\u4e24\u4e2a\u53c2\u6570\uff0c\u4e00\u4e2a\u662f\u8bbe\u7f6e DMA \u4e3a enable\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u8bbe\u7f6e I/0 \u4e3a 32 \u4f4d\u3002 \u6211\u6d4b\u8bd5\u8fc7\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u5bf9\u786c\u76d8\u7684\u54cd\u5e94\u901f\u5ea6\u786e\u5b9e\u6709\u5f88\u5927\u7684\u5f71\u54cd\uff0c\u7279\u522b\u662f DMA \u7684\u8bbe\u7f6e\uff0c\u6709\u76f8\u5dee\u597d\u51e0\u500d\u7684\u6548\u679c\u3002  </p> <p>\u7136\u540e\u5b9e\u9645\u4e0a\uff0c\u540e\u6765\u7684 Linux \u5206\u53d1\u7248\u672c\uff0c\u5bf9\u4e8e\u786c\u76d8\u7684\u4f18\u5316\u65e9\u5728\u7cfb\u7edf\u542f\u52a8\u4e2d\u5c31\u5df2\u7ecf\u505a\u597d\u4e86\u3002  </p> <p>\u800c\u6211\u77e5\u9053\u7684\u662f\uff0c\u4ec5\u4ec5\u53ea\u6709 2.2 \u7684\u5185\u6838\u9ed8\u8ba4\u662f\u4e0d\u6253\u5f00 DMA \u6a21\u5f0f\u7684\uff0c\u56e0\u6b64\u5728 2.2 \u7684\u5185\u6838\uff0c\u5229\u7528<code>hdparm -c 1 /dev/hdx</code>\u7684\u65b9\u5f0f\u6765\u63d0\u9ad8\u786c\u76d8\u54cd\u5e94\u901f\u5ea6\u662f\u6709\u6548\u679c\u7684\uff0c\u4f46\u662f 2.2 \u7684\u5185\u6838\u6bd5\u7adf\u662f\u53e4\u8463\u4e86\u3002  </p> <p>\u53e6\u5916 hdparm \u7684 man \u63d0\u5230 hdparm \u4ec5\u4ec5\u53ea\u662f\u8bbe\u7f6e ATA/IDE \u786c\u76d8\u53c2\u6570\uff0c\u800c\u5bf9 SCSI \u786c\u76d8\u662f\u6ca1\u6709\u7528\u7684\uff0c\u5f53\u7136\u4e5f\u5bf9\u540e\u6765\u51fa\u73b0\u7684 SATA,SAS \u786c\u76d8\u65e0\u6548\u4e86\u3002  \u6211\u6ca1\u6709\u6d4b\u8bd5\u8fc7 SCSI \u786c\u76d8\uff0c\u4e5f\u6ca1\u6709\u6d4b\u8bd5\u8fc7 SATA,SAS \u786c\u76d8\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u4e0d\u80fd\u7ed9\u51fa\u4e00\u4e2a\u786e\u5207\u7684\u7b54\u6848\u3002</p> <p>\u6211\u4eec\u770b\u770b\u540e\u6765\u7684 linux \u7248\u672c\u662f\u5982\u4f55\u5728\u542f\u52a8\u662f\u9488\u5bf9\u4e0d\u540c\u786c\u76d8\u505a\u7684\u4f18\u5316\u7684\uff0c\u4e0b\u9762\u7684\u811a\u672c\u7247\u6bb5\u6765\u81ea <code>/etc/rc.d/rc.sysinit</code> \u6587\u4ef6</p> <pre><code># Turn on harddisk optimization\n# There is only one file /etc/sysconfig/harddisks for all disks\n# after installing the hdparm-RPM. If you need different hdparm parameters\n# for each of your disks, copy /etc/sysconfig/harddisks to\n# /etc/sysconfig/harddiskhda (hdb, hdc\u2026) and modify it.\n# Each disk which has no special parameters will use the defaults.\n# Each non-disk which has no special parameters will be ignored.\n#\n\ndisk[0]=s;\ndisk[1]=hda; disk[2]=hdb; disk[3]=hdc; disk[4]=hdd;\ndisk[5]=hde; disk[6]=hdf; disk[7]=hdg; disk[8]=hdh;\ndisk[9]=hdi; disk[10]=hdj; disk[11]=hdk; disk[12]=hdl;\ndisk[13]=hdm; disk[14]=hdn; disk[15]=hdo; disk[16]=hdp;\ndisk[17]=hdq; disk[18]=hdr; disk[19]=hds; disk[20]=hdt;\n\nif [ -x /sbin/hdparm ]; then\n    for device in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20; do\n        unset MULTIPLE_IO USE_DMA EIDE_32BIT LOOKAHEAD EXTRA_PARAMS\n        if [ -f /etc/sysconfig/harddisk${disk[$device]} ]; then\n            . /etc/sysconfig/harddisk${disk[$device]}\n            HDFLAGS[$device]=\n            if [ -n \u201c$MULTIPLE_IO\u201d ]; then\n            HDFLAGS[$device]=\u201d-q -m$MULTIPLE_IO\u201d\n            fi\n            if [ -n \u201c$USE_DMA\u201d ]; then\n            HDFLAGS[$device]=\u201d${HDFLAGS[$device]} -q -d$USE_DMA\u201d\n            fi\n            if [ -n \u201c$EIDE_32BIT\u201d ]; then\n            HDFLAGS[$device]=\u201d${HDFLAGS[$device]} -q -c$EIDE_32BIT\u201d\n            fi\n            if [ -n \u201c$LOOKAHEAD\u201d ]; then\n            HDFLAGS[$device]=\u201d${HDFLAGS[$device]} -q -A$LOOKAHEAD\u201d\n            fi\n            if [ -n \u201c$EXTRA_PARAMS\u201d ]; then\n            HDFLAGS[$device]=\u201d${HDFLAGS[$device]} $EXTRA_PARAMS\u201d\n            fi\n        else\n            HDFLAGS[$device]=\u201d${HDFLAGS[0]}\u201d\n        fi\n\n        if [ -e \u201c/proc/ide/${disk[$device]}/media\u201d ]; then\n            hdmedia=`cat /proc/ide/${disk[$device]}/media`\n            if [ \u201c$hdmedia\u201d = \u201cdisk\u201d -o -f \u201c/etc/sysconfig/harddisk${disk[$device]}\u201d ]; then\n                if [ -n \u201c${HDFLAGS[$device]}\u201d ]; then\n                    action $\u201dSetting hard drive parameters for ${disk[$device]}: \u201d \\\n                        /sbin/hdparm ${HDFLAGS[$device]} /dev/${disk[$device]}\n                fi\n            fi\n        fi\n    done\nfi\n</code></pre> <p>\u8fd9\u6bb5\u811a\u672c\u662f\u6240\u6709\u7684 IDE \u786c\u76d8\uff0c\u6839\u636e <code>/etc/sysconfig/harddisks</code> \u6587\u4ef6\u7684\u7b56\u7565\u800c\u8bbe\u7f6e\u786c\u76d8\u7684\u53c2\u6570.  \u4ece\u8fd9\u91cc\u6211\u4eec\u4f3c\u4e4e\u53ef\u4ee5\u770b\u51fa\uff0csdx \u8bbe\u5907\u5e76\u4e0d\u518d\u8bbe\u7f6e\u4e4b\u5185\uff0c\u7531\u6b64\u662f\u4e0d\u662f\u53ef\u4ee5\u80af\u5b9a hdparm \u5bf9 SCSI \u8bbe\u5907\u4e0d\u652f\u6301\u5462\uff1f \u6211\u4eec\u518d\u770b\u770b harddisks \u6587\u4ef6</p> <pre><code>#\n# WARNING !!!\n#\n# The kernel will autodetect the correct settings for most drives.\n# Overriding these settings with hdparm can cause data corruption and/or\n# data loss.\n# Leave this file as it is unless you know exactly what you're doing !!\n#\n#\n#\n# These options are used to tune the hard drives -\n# read the hdparm man page for more information\n\n# Set this to 1 to enable DMA. This might cause some\n# data corruption on certain chipset / hard drive\n# combinations. This is used with the \u201c-d\u201d option\n\n# USE_DMA=1\n\n# Multiple sector I/O. a feature of most modern IDE hard drives,\n# permitting the transfer of multiple sectors per I/O interrupt,\n# rather than the usual one sector per interrupt. When this feature\n# is enabled, it typically reduces operating system overhead for disk\n# I/O by 30-50%. On many systems, it also provides increased data\n# throughput of anywhere from 5% to 50%. Some drives, however (most\n# notably the WD Caviar series), seem to run slower with multiple mode\n# enabled. Under rare circumstances, such failures can result in\n# massive filesystem corruption. USE WITH CAUTION AND BACKUP.\n# This is the sector count for multiple sector I/O \u2013 the \u201c-m\u201d option\n#\n# MULTIPLE_IO=16\n\n# (E)IDE 32-bit I/O support (to interface card)\n#\n# EIDE_32BIT=3\n\n# Enable drive read-lookahead\n#\n# LOOKAHEAD=1\n\n# Add extra parameters here if wanted\n# On reasonably new hardware, you may want to try -X66, -X67 or -X68\n# Other flags you might want to experiment with are -u1, -a and -m\n# See the hdparm manpage (man hdparm) for details and more options.\n#\nEXTRA_PARAMS=\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u6587\u4ef6\u7684\u6ce8\u91ca\u6211\u4eec\u80fd\u591f\u770b\u51fa\uff0c\u5b83\u5c06\u5f71\u54cd\u786c\u76d8\u6548\u679c\u6700\u660e\u663e\u7684\u53c2\u6570\u5355\u72ec\u5217\u4e86\u51fa\u6765\uff0c\u800c\u5c06\u5176\u4ed6\u53c2\u6570\u653e\u5230\u4e86 EXTRA_PARAMS \u91cc\u3002  </p> <p>\u56e0\u6b64\u5bf9\u4e8e hdparm \u547d\u4ee4\u7684\u4f17\u591a\u53c2\u6570\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u53bb\u4e86\u89e3\u7684\u4e0d\u592a\u591a\u3002  </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#hotplug","title":"hotplug","text":"<p>Linux \u4e0b\u70ed\u63d2\u62d4\u652f\u6301\u811a\u672c\u3002  </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#hwclock","title":"hwclock","text":"<p>\u67e5\u8be2\u548c\u8bbe\u7f6e\u786c\u4ef6\u65f6\u949f(RTC).\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u9700\u8981\u4ece\u786c\u4ef6\u65f6\u949f\u4e2d\u8bfb\u51fa\u65f6\u95f4\u6765\u8bbe\u7f6e\u7cfb\u7edf\u7cfb\u7edf\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5728<code>/etc/rc.d/rc.sysinit</code> \u811a\u672c\u4e2d\u91c7\u7528<code>hwclock $CLOCKFLAGS</code>\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u3002</p> <p>\u8fd9\u91cc\u7684\u53c2\u6570 <code>$CLOCKFLAGS</code> \u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f <code>--hctosys</code>,\u8868\u793a\u540c\u6b65\u7684\u65b9\u5f0f\u662f\u786c\u4ef6\u65f6\u949f\u5230\u7cfb\u7edf\u65f6\u949f\u3002\u53e6\u5916\u4e00\u90e8\u5206\u53c2\u6570\u662f\u65f6\u95f4\u8bbe\u7f6e\u7684\u6807\u51c6\uff0c\u662f\u6807\u51c6\u65f6\u95f4\uff08utc\uff09\uff0c\u8fd8\u662f\u672c\u5730\u65f6\u95f4(localtim). </p> <p>\u800c\u5173\u95ed\u7cfb\u7edf\u65f6\uff0c\u5219\u76f8\u53cd\uff0c\u4f3c\u4e4e\u7528 <code>-systohc</code> \u7684\u53c2\u6570\u6765\u5c06\u7cfb\u7edf\u65f6\u949f\u540c\u6b65\u5230\u786c\u4ef6\u65f6\u949f\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-l","title":"/sbin/\u4e0b l \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u4e0d\u591a\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p> <p>ldconfig lilo logsave loopctrl losetup lsmod lspci lsusb lvm lvm.static</p> <p>\u5176\u4e2d lvm \u662f lvm.static \u7684\u8f6f\u8fde\u63a5\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#ldconfig","title":"ldconfig","text":"<p>\u914d\u7f6e\u52a8\u6001\u8fde\u63a5\u5e93\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u5728\u7f16\u8bd1\u548c\u8fd0\u884c\u4e2d\u52a8\u6001\u8fde\u63a5\u8fd9\u4e9b\u7a0b\u5e8f\u5e93\u3002\u4e0e\u6b64\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u4fbf\u662f <code>/etc/ld.so.conf</code>\uff0c \u540e\u6765\u7684 ldconfig \u7684\u914d\u7f6e\u6587\u4ef6\u91c7\u53d6\u4e86\u73b0\u5728\u6d41\u884c\u7684\u8bfb\u53d6\u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u6240\u4ee5 <code>/etc/ld.so.conf.d</code>\u76ee\u5f55\u4fbf\u662f\u540e\u6765\u589e\u52a0\u7684\u3002</p> <p>\u6211\u4ec5\u4ec5\u4f7f\u7528 ldconfig \u7684\u4e00\u4e2a\u53c2\u6570-f\uff0c\u5c31\u662f\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u6837\u7684\u597d\u5904\u662f\uff0c\u5f53\u6211\u9700\u8981\u589e\u52a0\u67d0\u4e00\u4e2a\u76ee\u5f55\u7684\u52a8\u6001\u5e93\u65f6\uff0c\u6211\u4e0d\u8981\u5168\u90e8\u91cd\u5efa\u52a8\u6001\u5e93\u7f13\u5b58\uff0c\u547d\u4ee4\u7a0b\u5e8f\u8fd0\u884c\u65f6\u95f4\u77ed\u4e86\u5f88\u591a\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#lilo","title":"lilo","text":"<p>grub \u4e4b\u524d\u7684\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u4e0d\u77e5\u9053\u73b0\u5728\u8fd8\u6709\u591a\u5c11\u53d1\u884c\u7248\u672c\u4f7f\u7528\u4ed6,\u7559\u7740\u4ed6\u7684\u4e00\u4e2a\u597d\u5904\u662f\uff0c\u5f53\u6211\u4e22\u5931\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u800c grub \u53c8\u5b89\u88c5\u4e0d\u4e0a\u65f6\uff0clilo \u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u51fa\u9a6c\u4e86\uff0c\u800c lilo \u6bcf\u6b21\u90fd\u6ca1\u6709\u8ba9\u6211\u5931\u671b\uff0c\u6240\u4ee5\u6211\u5bf9\u4ed6\u7684\u5370\u8c61\u4e0d\u9519\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#logsave","title":"logsave","text":"<p>\u65e5\u5fd7\u8bb0\u5f55\u7a0b\u5e8f\uff0c\u53c2\u6570\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>logsave [ -asv ] logfile cmd_prog [ ... ]\n</code></pre> <ul> <li><code>-a</code>: \u662f\u91c7\u7528\u9644\u52a0\u7684\u6a21\u5f0f\u5199\u5165\u65e5\u5fd7\u6587\u4ef6 logfile  </li> <li><code>-s</code>: \u5199\u65e5\u5fd7\u5230\u7528\u6237\u7ec8\u7aef  </li> <li><code>-v</code>: \u5c31\u662f\u5197\u4f59\u8f93\u51fa</li> </ul> <p>\u7ed9\u6211\u7684\u611f\u89c9\u4ed6\u7684\u4f5c\u7528\u7c7b\u4f3c\u91cd\u5b9a\u5411\uff0c\u6bd4\u5982</p> <pre><code>cmd_prog &gt;logfile 2&gt;&amp;1\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#loopctrl","title":"loopctrl","text":"<p>\u914d\u7f6e isdnloop ISDN \u9a71\u52a8\uff0c\u8fd9\u5e94\u8be5\u7b97\u662f\u4e00\u4e2a\u7528\u6237\u9057\u7559\u4ea7\u54c1\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#lsmod","title":"lsmod","text":"<p>\u663e\u793a\u76ee\u524d\u52a0\u8f7d\u7684\u5185\u6838\u6a21\u5757\u72b6\u6001</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#lspci","title":"lspci","text":"<p>\u5217\u51fa\u6240\u6709\u7684 PCI \u8bbe\u5907\uff0c\u8fd9\u4e2a\u547d\u4ee4\u6211\u7528\u5f97\u6bd4\u8f83\u5c11</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#lsusb","title":"lsusb","text":"<p>\u5217\u51fa\u6240\u6709\u7684 usb \u9a71\u52a8</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#lvm","title":"lvm","text":"<p>lvm,lvm.static \u903b\u8f91\u5377\u7ba1\u7406\u7a0b\u5e8f\u7a0b\u5e8f, \u4ed6\u5176\u5b9e\u5305\u62ec\u4e86\u4e00\u7cfb\u5217\u7684\u5b50\u547d\u4ee4\uff0c\u6bd4\u5982 </p> <ul> <li>pvscan</li> <li>pvcreate</li> <li>pvdisplay</li> <li>vgscan</li> <li>vgcreate</li> <li>vgchange</li> <li>vgdisplay</li> <li>lvscan</li> <li>lvcreate</li> <li>lvdisplay </li> </ul> <p>\u7b49\uff0c\u8fd9\u4e9b\u5b50\u547d\u4ee4\u4e5f\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4ece\u4e00\u4e2a\u521d\u59cb\u7684\u786c\u76d8\u5f00\u59cb\u5230\u521b\u5efa\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u5e76\u6302\u8f7d\u7684\u7b80\u5355\u6b65\u9aa4\u662f:(\u6211\u8fd9\u91cc\u7528 /dev/ram0 \u6765\u66ff\u4ee3\u786c\u76d8)</p> <pre><code># pvcreate /dev/ram0\nPhysical volume \u201c/dev/ram0\u2033 successfully created\n\n# vgcreate vgname /dev/ram0\nVolume group \u201cvgname\u201d successfully created\n\n# vgchange -a y vgname\n0 logical volume(s) in volume group \u201cvgname\u201d now active\n\n# lvcreate -L20M -n lvname vgname\nLogical volume \u201clvname\u201d created\n\n# mkfs.ext3 /dev/mapper/vgname-lvname\nmke2fs 1.39 (29-May-2006)\nFilesystem label=\nOS type: Linux\nBlock size=1024 (log=0)\nFragment size=1024 (log=0)\n5136 inodes, 20480 blocks\n1024 blocks (5.00%) reserved for the super user\nFirst data block=1\nMaximum filesystem blocks=20971520\n3 block groups\n8192 blocks per group, 8192 fragments per group\n1712 inodes per group\nSuperblock backups stored on blocks:\n8193\n\nWriting inode tables: done\nCreating journal (1024 blocks): done\nWriting superblocks and filesystem accounting information: done\n\nThis filesystem will be automatically checked every 39 mounts or\n180 days, whichever comes first. Use tune2fs -c or -i to override.\n\n# mount /dev/mapper/vgname-lvname /misc\n\n# df -h\n\u6587\u4ef6\u7cfb\u7edf \u5bb9\u91cf \u5df2\u7528 \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/hda5 6.7G 2.2G 4.2G 35% /\n/dev/hda1 99M 23M 71M 25% /boot\n/dev/shm 248M 0 248M 0% /dev/shm\n/dev/hda3 6.8G 5.3G 1.2G 83% /dc50\n/dev/mapper/vgdata-data\n20G 831M 18G 5% /data\n/dev/mapper/vgname-lvname\n20M 1.2M 18M 7% /misc\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-m","title":"/sbin \u76ee\u5f55\u4e0b m \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u53ef\u4e0d\u5c11</p> <pre><code>mdadm          mii-tool    mkfs.cramfs    mkfs.xfs    mounted.ocfs2  mpath_get_name          multipath.static\nmdadm.static   mingetty    mkfs.ext2      mkinitrd    mount.ncp      mpath_prio_alua\nmdassemble     minilogd    mkfs.ext3      mkreiserfs  mount.ncpfs    mpath_prio_emc\nmdevt          mkbootdisk  mkfs.msdos     mkswap      mount.ocfs2    mpath_prio_hds_modular\nmdmpd          mkdosfs     mkfs.ocfs2     mkzonedb    mount.smb      mpath_prio_netapp\nmgetty         mke2fs      mkfs.reiserfs  modinfo     mount.smbfs    multipath\nmicrocode_ctl  mkfs        mkfs.vfat      modprobe    mpath_ctl      multipathd\n</code></pre> <p>mkfs \u7cfb\u5217\u547d\u4ee4\u5360\u4e86\u5f88\u5927\u4e00\u90e8\u5206\u3002 </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mdadm","title":"mdadm","text":"<p>mdadm, mdadm.static \u8fd9\u662f\u548c RAID \u76f8\u5173\u7684\u7a0b\u5e8f\uff0c\u4ed6\u7528\u6765\u7ba1\u7406 Linux \u4e0b\u7684\u8f6f RAID\u3002</p> <p>\u5f53\u524d Linux \u63d0\u4f9b\u7684 RAID \u7ea7\u522b\u6709 </p> <ul> <li>LINEAR md \u8bbe\u5907</li> <li>RAID0 (striping)</li> <li>RAID1 (mirroring)</li> <li>RAID4</li> <li>RAID5</li> <li>RAID6</li> <li>MULTIPATH</li> <li>FAULTY</li> </ul> <p>\u8fd9\u91cc\u8bf4\u7684 multipath \u5176\u5b9e\u5e76\u4e0d\u662f\u8f6f RAID \u673a\u5236\u4e2d\u7684\u4e00\u90e8\u5206\uff0c\u4f46\u662f\u4ed6\u4f1a\u53bb\u8c03\u7528\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mdmpd","title":"mdmpd","text":"<p>\u76d1\u63a7 MD multipath \u8bbe\u5907\u7684 daemon \u7a0b\u5e8f\u3002  </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mii-tool","title":"mii-tool","text":"<p>\u67e5\u770b\uff0c\u7ba1\u7406\u72ec\u7acb\u4ecb\u8d28\u63a5\u53e3\u72b6\u6001\uff0c\u8fd9\u662f\u4e00\u4e2a\u8fc7\u65f6\u7684\u7a0b\u5e8f\u4e86\uff0c\u76ee\u524d\u4ee3\u66ff\u4ed6\u529f\u80fd\u7684\u7a0b\u5e8f\u662f eth-tool\u3002  </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mkbootdisk","title":"mkbootdisk","text":"<p>\u5236\u4f5c\u542f\u52a8\u78c1\u76d8\uff0c\u4e0d\u77e5\u9053\u73b0\u5728\u8fd8\u6709\u591a\u5c11\u4eba\u4f7f\u7528\u4ed6\uff0c\u73b0\u5728\u770b\u5230\u7684\u670d\u52a1\u5668\u4f3c\u4e4e\u90fd\u6ca1\u6709\u8f6f\u9a71\u4e86\u3002  </p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mkfs","title":"mkfs.*\uff1a","text":"<p>\u8fd9\u662f\u5236\u4f5c\u6587\u4ef6\u7cfb\u7edf\u7684\u7a0b\u5e8f\u96c6\uff0c\u5982\u679c\u4ec0\u4e48\u90fd\u4e0d\u8003\u8651\uff0c\u4ec5\u4ec5\u662f\u5236\u4f5c\u6587\u4ef6\u7cfb\u7edf\u7684\u8bdd\uff0c\u90a3\u76f4\u63a5 mkfs \u4e86\u3002\u4f46\u662f\u5982\u679c\u4f60\u8981\u4ece\u5b58\u50a8\u6570\u636e\u7684\u6027\u8d28\uff0c\u8bfb\u5199\u901f\u5ea6\uff0c\u5b58\u653e\u6587\u4ef6\u4e2a\u6570\u7b49\u65b9\u9762\u7740\u60f3\uff0c\u90a3\u5c31\u4e0d\u5f97\u4e0d\u8003\u8651 mkfs \u547d\u4ee4\u96c6\u7684\u4e00\u4e9b\u53c2\u6570\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mkinitrd","title":"mkinitrd","text":"<p>\u91cd\u505a\u955c\u50cf\u6587\u4ef6\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5728\u66f4\u65b0\u4e86\u4e00\u4e9b\u6838\u5fc3\u9a71\u52a8\u6a21\u5757\u7684\u65f6\u5019\uff0c\u7528\u5f97\u7740\u3002 \u6bd4\u5982\u66f4\u65b0\u4e86 SCSI \u5361\u7684\u9a71\u52a8\uff0c\u589e\u52a0\u9a71\u52a8\u6a21\u5757\u7684\u4e00\u4e9b\u53c2\u6570\u7b49\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4fee\u6539\u4e86<code>/etc/modprobe.conf</code> \u4e2d\u5757\u8bbe\u5907\u6587\u4ef6\u7684\u914d\u7f6e\u53c2\u6570\uff0c\u5c31\u5e94\u8be5\u91cd\u65b0\u5236\u4f5c\u955c\u50cf\u6587\u4ef6\uff0c</p> <p>\u65b9\u6cd5\u5012\u662f\u5f88\u7b80\u5355 </p> <pre><code>mkinitrd /boot/newinitrd.img `uname -r`\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#modinfo","title":"modinfo","text":"<p>\u663e\u793a\u5185\u6838\u6a21\u5757\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5305\u62ec\u4f5c\u8005\uff0c\u63cf\u8ff0\uff0c\u6388\u6743\u65b9\u5f0f\uff0c\u6838\u5fc3\u53c2\u6570\u7b49\uff0c\u5176\u4e2d\u6709\u7684\u8fd8\u5305\u62ec\u4e86\u6a21\u5757\u4f9d\u8d56\u6027\u7684\u63cf\u8ff0\uff0c\u6bd4\u5982:</p> <pre><code># modinfo e100.ko\nfilename:       /lib/modules/2.6.9-42.7AX/kernel/drivers/net/e100.ko\ndescription:    Intel(R) PRO/100 Network Driver\nauthor:         Copyright(c) 1999-2005 Intel Corporation\nlicense:        GPL\nversion:        3.5.10-k2-NAPI 6481838CE42D9570A7D35AF\nparm:           debug:Debug level (0=none,...,16=all)\nvermagic:       2.6.9-42.7AX 686 REGPARM 4KSTACKS gcc-3.4\ndepends:        mii\nalias:          pci:v00008086d00001029sv*sd*bc02sc00i*\nalias:          pci:v00008086d00001030sv*sd*bc02sc00i*\nalias:          pci:v00008086d00001031sv*sd*bc02sc00i*\nalias:          pci:v00008086d00001032sv*sd*bc02sc00i*\nalias:          pci:v00008086d00001033sv*sd*bc02sc00i*\nalias:          pci:v00008086d00001034sv*sd*bc02sc00i*\n.........................................\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u6211\u4eec\u53ef\u4ee5\u770b\u51fa <code>e100.ko</code> \u8fd9\u4e2a\u6a21\u5757\u76ee\u524d\u7684\u7248\u672c\u662f 3.5.10\uff0c\u4ed6\u4f9d\u8d56\u6a21\u5757 <code>mii.ko</code>\uff0c\u540c\u65f6\uff0c\u53ef\u4ee5\u4f20\u9012\u4e00\u4e2a\u53c2\u6570 debug\uff0c\u7528\u4e8e\u8c03\u8bd5\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#mount","title":"mount.*","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u547d\u4ee4\uff0c\u8fd9\u4e9b\u547d\u4ee4\u7684\u524d\u7aef\u7a0b\u5e8f\u5c31\u662f mount,\u7c7b\u4f3c mkfs \u4e00\u6837\u3002  </p> <p>\u8fd9\u4e2a\u547d\u4ee4\u6050\u6015\u662f linux \u4e0b\u6700\u5e38\u7528\u7684\u547d\u4ee4\u4e4b\u4e00\u4e86\u3002\u6240\u4ee5\u5927\u5bb6\u90fd\u6bd4\u8f83\u719f\u6089\uff0c\u6211\u8fd9\u91cc\u4ec5\u4ec5\u8bb0\u5f55\u51e0\u4e2a\u5e73\u5e38\u4e0d\u600e\u4e48\u5e38\u7528\u7684\u51e0\u4e2a\u53c2\u6570</p> <p>\u91cd\u65b0\u6302\u8f7d\u4e3a\u53ea\u8bfb(\u53ef\u5199)</p> <pre><code># mount hd /misc -oloop\n# touch /misc/one\n# ls /misc\nlost+found  one\n# mount -o remount,ro hd /misc -oloop\n# touch /misc/two\ntouch: cannot touch `/misc/two': Read-only file system\n</code></pre> <p>\u731c\u6d4b\u67d0\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u7c7b\u578b</p> <pre><code># mount --guess-fs /dev/hda3\next3\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-n","title":"/sbin \u4e0b n \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u4e0d\u591a\uff0c\u800c\u4e14\u57fa\u672c\u4e0a\u4e0d\u5e38\u7528</p> <p>nameif nash netplugd netreport new-kernel-pkg nologin</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#nameif","title":"nameif","text":"<p>\u57fa\u4e8e MAC \u5730\u5740\u547d\u540d\u7f51\u7edc\u63a5\u53e3\uff0c\u4ed6\u9700\u8981\u7684\u914d\u7f6e\u6587\u4ef6\u662f <code>/etc/mactab</code>\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#nash","title":"nash","text":"<p>\u53e6\u5916\u4e00\u79cd shell\uff0c\u4e3b\u8981\u7528\u5728\u5f15\u5bfc\u955c\u50cf\u4e2d\u7684\u811a\u672c\u4e2d\uff0c\u6bd4\u5982<code>initrd.img</code>\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#netplugd","title":"netplugd","text":"<p>\u7f51\u7edc\u70ed\u63d2\u62d4\u7ba1\u7406\u540e\u53f0\u7a0b\u5e8f\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#new-kernel-pkg","title":"new-kernel-pkg","text":"<p>\u5b89\u88c5\u65b0\u5185\u6838\uff0c\u4ed6\u80fd\u5b8c\u6210\u7684\u529f\u80fd\u6709\uff1a  </p> <ol> <li>\u521b\u5efa\uff0c\u5220\u9664\u4e00\u4e2a initrd  </li> <li>\u8fd0\u884c depmod \u6216\u8005\u5220\u9664 depmod \u751f\u6210\u7684\u6587\u4ef6  </li> <li>\u4ece grub/lilo \u914d\u7f6e\u6587\u4ef6\u4e2d\u589e\u52a0\u6216\u8005\u5220\u9664\u4e00\u4e2a\u5185\u6838\u955c\u50cf\uff08\u901a\u8fc7 grubby\uff09\u3002</li> </ol>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#nolog","title":"nolog","text":"<p>\u60f3\u62d2\u7edd\u4e00\u4e2a\u5e10\u53f7\u767b\u5f55\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u4ed6\u4e86\uff0cman \u624b\u518c\u4e2d\u63cf\u8ff0\u7684\u662f\u4f18\u96c5\u7684\u62d2\u7edd\u7528\u6237\u767b\u5f55\u3002</p> <p>\u8df3\u8fc7 o \u5f00\u5934\u7684\u547d\u4ee4\u662f\u56e0\u4e3a o \u5f00\u5934\u53ea\u6709\u4e09\u4e2a\u547d\u4ee4\uff0c\u800c\u4e14\u90fd\u662f\u548c Oracle \u7684 ocfs \u6709\u5173\uff0c\u6240\u4ee5\u8fd9\u91cc\u5c31\u4e0d\u7814\u7a76\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbinp","title":"/sbin/p \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>p \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u5c11\uff0c\u8fd1 20 \u4e2a\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#pack_cis","title":"pack_cis","text":"<p>\u4e0e PCMCIA \u6709\u5173\uff0c\u7f16\u8bd1 PCMCIA \u5361\u4fe1\u606f\u7ed3\u6784\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#pam_cosonle_apply","title":"pam_cosonle_apply","text":"<p>\u5728\u7cfb\u7edf\u7ec8\u7aef\u4e0a\uff0c\u9488\u5bf9\u7528\u6237\u8bbe\u7f6e\u6216\u8005\u6536\u56de\u6743\u9650\u3002\u4ed6\u662f PAM \u76f8\u5173\u7684\u5de5\u5177\u3002</p> <p>\u5982\u679c<code>/var/run/console.lock</code>\u5b58\u5728\uff0c\u5219\u9488\u5bf9\u8be5\u6587\u4ef6\u7684\u7528\u6237\u6388\u6743;\u5982\u679c\u6ca1\u6709\uff0c\u5219\u6839\u636e\u7f3a\u7701\u6587\u4ef6 <code>/etc/security/console.perms</code>\u7684\u89c4\u5219\u6765\u6388\u6743\u3002  </p> <p>\u8fd9\u4e2a\u547d\u4ee4\u4ee5\u53ca<code>pam_timestamp_check</code>,<code>pam_tally</code>\u90fd\u5c5e\u4e8e PAM \u7a0b\u5e8f</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#pam_console_setowner","title":"pam_console_setowner","text":"<p>\u8bbe\u7f6e console \u7684\u5c5e\u4e3b\uff0c\u4ed6\u5c5e\u4e8e UDEV \u5305.</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#parted","title":"parted","text":"<p>\u5f3a\u5927\u7684\u78c1\u76d8\u7ba1\u7406\u5de5\u5177\uff0c\u7c7b\u4f3c fdisk \u529f\u80fd\uff0c\u4f46\u662f\u4e2a\u4eba\u89c9\u5f97\u5176\u529f\u80fd\u6bd4 fdisk \u5f3a\u5927\u3002 \u5176\u4e2d\u503c\u5f97\u8bf4\u7684\u4e00\u70b9\u5c31\u662f\u5728\u5df2\u7ecf\u5360\u7528\u7684\u78c1\u76d8\u4e0a\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e0d\u9700\u8981\u91cd\u542f\u751f\u6548\uff0c\u8fd9\u70b9\u5c31\u6bd4 fdisk \u5f3a\u3002\u6bd4\u5982\u4f60\u7684 hda \u5df2\u7ecf\u5728\u4f7f\u7528\u4e86\uff08\u4f60\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u8fd9\u65f6\u4f60\u5e0c\u671b\u5728 hda \u4e0a\u518d\u521b\u5efa\u4e00\u4e2a\u5206\u533a\uff0c\u5982\u679c\u4f7f\u7528 fdisk \u5de5\u5177\uff0c\u4fdd\u5b58\u7684\u65f6\u5019\u80af\u5b9a\u4f1a\u63d0\u793a\u8981\u4f60\u91cd\u542f\u624d\u751f\u6548\uff0c\u56e0\u4e3a\u8bbe\u5907 busy\u3002 \u4f46\u662f parted \u5374\u4e0d\u4f1a\u3002 \u53e6\u5916\u4e00\u70b9\u662f fdisk \u7a0b\u5e8f\u53ea\u6709\u5728\u4f60\u8f93\u5165 <code>w</code> \u547d\u4ee4\u540e\uff0c\u6240\u6709\u7684\u547d\u4ee4\u624d\u771f\u5b9e\u751f\u6548\uff0c\u800c parted \u4e0d\u662f\u8fd9\u6837\uff0c\u6267\u884c\u540e\uff0c\u7acb\u523b\u751f\u6548\uff08\u4e5f\u8bb8\u6211\u8fd8\u6ca1\u6709\u627e\u5230 undo \u7684\u529f\u80fd\uff09\uff0c\u6240\u4ee5\u8fd9\u70b9\u8981\u6ce8\u610f\u3002</p> <p>\u53d1\u73b0\u4e00\u4e2a\u6709\u610f\u601d\u7684\u73b0\u8c61\uff1aaddpart\uff0cdelpart \u7684\u529f\u80fd\u662f\u5220\u9664\u5206\u533a\u548c\u589e\u52a0\u5206\u533a\uff0c\u90a3\u4e48\u5f88\u81ea\u7136\u7684\u5e94\u8be5\u5c5e\u4e8e parted \u7a0b\u5e8f\u7684\u529f\u80fd\uff0c\u56e0\u6b64\u6309\u7406\uff0c\u8fd9\u4e24\u4e2a\u547d\u4ee4\u8fde\u5e26 partprobe \u548c parted \u5c5e\u4e8e\u540c\u4e00\u4e2a\u5305\u3002 \u4f46\u4e8b\u5b9e\u662f addpart,delpart \u5c5e\u4e8e util-linux \u5305\u3002\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u6765\u5f52\u7c7b\uff1f</p> <p>Linux \u4e0b\u6ca1\u6709\u56fe\u5f62\u5316\u7684\u78c1\u76d8\u7ba1\u7406\u5de5\u5177\u4e00\u76f4\u662f\u666e\u901a\u7528\u6237\u62b1\u6028\u7684\u5730\u65b9\uff0c\u56e0\u4e3a\u4e0d\u8981\u671f\u671b\u6240\u6709\u4eba\u90fd\u6765\u4f7f\u7528 fdisk\uff0cparted \u8fd9\u6837\u7684\u547d\u4ee4\u3002\u4e0d\u8fc7\u73b0\u5728\u597d\u4e86\uff0c\u7ed9\u4e88 parted \u7684qtparted\u5c31\u662f\u4e00\u4e2a GUI \u7684\u7a0b\u5e8f\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#partx","title":"partx","text":"<p>partx \u540c\u6837\u5c5e\u4e8e parted \u7684\u5305\uff0c\u800c\u662f linux-util,\u867d\u7136\u957f\u50cf parted \u4e4b\u7c7b\u7684\u3002\u8fd9\u4e2a\u547d\u4ee4\u548c addpart\uff0cdelpart \u4e00\u6837\uff0c\u6ca1\u6709 man \u624b\u518c\uff0c\u6ca1\u6709 info \u4fe1\u606f\uff0c\u6ca1\u6709 <code>--help</code>\u3002</p> <p>\u53ea\u597d\u627e google\uff0c\u5f97\u5230\u8fd9\u4e2a\u8fd9\u4e48\u4e00\u7bc7\u6587\u7ae0\u3002\u53ef\u4ee5\u770b\u770b\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#pivot_root","title":"pivot_root","text":"<p>\u6539\u53d8\u6839\u6587\u4ef6\u7cfb\u7edf\u3002\u4ed6\u7684\u57fa\u672c\u7528\u6cd5\u662f\uff1a<code>pivot_root new_root put_old</code> </p> <p>\u8868\u793a\u628a\u5f53\u524d\u5904\u7406\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u79fb\u5230<code>put_old</code>\u76ee\u5f55\uff0c\u7136\u540e\u628a<code>new_root</code>\u4f5c\u4e3a\u5f53\u524d\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u3002  </p> <p>\u8fd9\u4e2a\u547d\u4ee4\u66f4\u591a\u7684\u65f6\u5019\u7528\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u3002\u6211\u4eec\u77e5\u9053\u73b0\u5728\u7684 Linux \u542f\u52a8\u65f6\uff0c\u90fd\u9700\u8981\u4e00\u4e2a initrd \u7684\u6838\u5fc3\u53c2\u6570\uff0c\u8fd9\u4e2a initrd \u540e\u9762\u63a5\u7740\u7684\u538b\u7f29\u6587\u4ef6\u5f88\u591a\u60c5\u51b5\u4e0b\u5c31\u662f\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002  </p> <p>\u5185\u6838\u5f15\u5bfc\u540e\uff0c\u4f1a\u9996\u5148\u628a initrd \u7684\u53c2\u6570\u6302\u8f7d\uff0c\u628a\u4ed6\u5f53\u6210\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u5904\u7406\u5b8c\u5fc5\u8981\u7684\u4e8b\u52a1\u540e\uff0c\u518d\u628a\u6838\u5fc3\u53c2\u6570 root \u7f6e\u9876\u7684\u8bbe\u5907\u6302\u8f7d\u4e0a\u6765\uff0c\u7136\u540e\u4f7f\u7528<code>pivot_root</code>\u547d\u4ee4\u5207\u6362\u6574\u4e2a\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c \u63a5\u7740\u6267\u884c/sbin/init \u7a0b\u5e8f\u6765\u7ee7\u7eed\u5f15\u5bfc\u7cfb\u7edf\u3002</p> <p>LSB \u7684 linux \u53d1\u884c\u7248\u672c\uff0c\u5f15\u5bfc\u65f6\u4f1a\u628a initrd \u955c\u50cf\u6302\u8f7d\u5230 <code>/initrd</code> \u76ee\u5f55\u4e0b\u3002\u6240\u4ee5\u4f60\u4f1a\u53d1\u73b0\u6839\u76ee\u5f55\u4e0b\u6709\u4e00\u4e2a initrd \u76ee\u5f55\uff0c\u4f46\u662f\u4ed6\u662f\u7a7a\u7684\uff0c\u5982\u679c\u6211\u5220\u9664\u4ed6\uff0c\u7cfb\u7edf\u5f15\u5bfc\u7684\u65f6\u5019\u5c31\u4f1a\u62a5\u9519\uff0c\u6211\u600e\u4e48\u77e5\u9053\u7684\uff1f\u56e0\u4e3a\u6211\u5e72\u8fc7\u8fd9\u6837\u7684\u50bb\u4e8b\u3002</p> <p>man \u624b\u518c\u4e2d\u4e3e\u4e86\u51e0\u4e2a\u4f8b\u5b50\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u89e3\u91ca<code>pivot_root</code>\u7684\u4f5c\u7528\u3002\u4e0d\u8fc7\u5bf9\u4e8e\u6539\u53d8\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u6211\u4eec\u53ef\u80fd\u9996\u5148\u60f3\u5230\u7684\u662f chroot\uff0cchroot \u4f3c\u4e4e\u4e5f\u6709\u8fd9\u4e2a\u529f\u80fd\uff0c\u90a3\u4e48\u4ed6\u548c<code>pivot_root</code>\u6709\u4ec0\u4e48\u5dee\u522b\u5462\uff1f \u4e3b\u8981\u7684\u5dee\u522b\u662f<code>pivot_root</code>\u6709\u610f\u8bc6\u7684\u5207\u6362\u4e00\u4e2a\u5b8c\u6574\u7684\u7cfb\u7edf\u5230\u65b0\u7684\u6839\u76ee\u5f55\uff0c\u7136\u540e\u53ef\u4ee5\u79fb\u8d70\u4e4b\u524d\u9700\u8981\u4f9d\u8d56\u7684\u8001\u7684\u7cfb\u7edf\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5 umount \u6389\u4e4b\u524d\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c31\u5f53\u505a\u4e4b\u524d\u6ca1\u6709\u53d1\u751f\u8fc7\u539f\u6765\u5b83\u662f\u8fd0\u884c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e00\u6837\u3002</p> <p>\u800c chroot \u5219\u6709\u610f\u8bc6\u7684\u7533\u8bf7\u4e00\u4e2a\u5355\u72ec\u8fdb\u7a0b\u7684\u5168\u90e8\u751f\u547d\u5468\u671f\uff0c\u4ed6\u548c\u7cfb\u7edf\u7684\u5176\u4ed6\u90e8\u5206\u4e00\u8d77\u5728\u8001\u7684\u6839\u76ee\u5f55\u4e0b\u4e00\u8d77\u8fd0\u884c\uff0c\u5f53 chrooted \u8fdb\u7a0b\u9000\u51fa\u540e\uff0c\u7cfb\u7edf\u4e0d\u4f1a\u53d1\u751f\u6539\u53d8\u3002</p> <p>\u6ce8\uff1a\u4e0d\u5efa\u8bae\u5927\u5bb6\u6d4b\u8bd5\u8fd9\u4e2a\u547d\u4ee4\uff0c\u8fd9\u65f6\u6211\u6d4b\u8bd5\u540e\u5f97\u51fa\u7684\u7ed3\u679c\u3002\u81f3\u5c11\u6211\u505a\u5b8c\u540e\uff0c\u6211\u662f\u9760\u91cd\u542f\u7cfb\u7edf\u6765\u6062\u590d\u539f\u72b6\u7684(\u771f\u5b9e\u539f\u56e0\u662f\u5bf9\u8fd9\u4e2a\u547d\u4ee4\u8fd8\u662f\u4e86\u89e3\u5f97\u4e0d\u592a\u591a\u3002)</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#portmap","title":"portmap","text":"<p>DARPA(\u7f8e\u56fd\u56fd\u9632\u90e8\u9ad8\u7ea7\u7814\u7a76\u8ba1\u5212\u5c40)\u7aef\u53e3\u5230 RPC \u7a0b\u5e8f\u53f7\u7684\u6620\u5c04\u3002\u4e5f\u5c31\u662f\u63d0\u4f9b\u628a RPC \u7a0b\u5e8f\u53f7\u8f6c\u6362\u6210 DARPA \u534f\u8bae\u7aef\u53e3\u7684\u670d\u52a1\u3002\u66f4\u7edf\u5c5e\u7684\u79f0\u547c\u5e94\u8be5\u5c31\u662f\u7aef\u53e3\u6620\u5c04(\u8c01\u5173\u5fc3\u5230\u5e95\u4ece\u4ec0\u4e48\u534f\u8bae\u8f6c\u4ec0\u4e48\u534f\u8bae\u5462\uff1f)\u3002 </p> <p>\u5f53\u4e00\u4e2a RPC \u670d\u52a1\u5f00\u59cb\u65f6\uff0c\u5b83\u544a\u8bc9 portmap \u5b83\u5c06\u4fa6\u542c\u54ea\u4e2a\u7aef\u53e3\u53f7\uff0c\u4ee5\u53ca\u5b83\u51c6\u5907\u4e3a\u4ec0\u4e48 RPC \u7a0b\u5e8f\u53f7\u63d0\u4f9b\u670d\u52a1\u3002 \u4f46\u4e00\u4e2a\u5ba2\u6237\u7aef\u5e0c\u671b\u5bf9\u6307\u5b9a\u7684\u7a0b\u5e8f\u53f7\u505a RPC \u8c03\u7528\u65f6\uff0c\u4ed6\u5c06\u9996\u5148\u94fe\u63a5\u670d\u52a1\u5668\u4e0a\u7684 portmap \u7a0b\u5e8f(\u670d\u52a1)\u6765\u51b3\u5b9a RPC \u5305\u5e94\u8be5\u53d1\u5f80\u54ea\u4e2a\u7aef\u53e3\u3002 portmap \u5e94\u8be5\u5728 RPC \u670d\u52a1\u8c03\u7528\u4e4b\u524d\u542f\u52a8\u3002  </p> <p>\u5178\u578b\u7684\u5e94\u7528\u5e94\u8be5\u662f NFS \u4e86\u3002\u8fd0\u884c\u4e00\u4e2a NFS \u670d\u52a1\u5f53\u524d\u9700\u8981\u542f\u52a8\u7684\u670d\u52a1\u6709\uff1aportmap\uff0cnfs \u548c nfslock\u3002\u4e0d\u542f\u52a8 portmap \u800c\u5355\u72ec\u542f\u52a8 nfs\uff0c fslock \u670d\u52a1\u63d0\u4f9b NFS \u670d\u52a1\u65f6\uff0c\u6211\u9047\u5230\u8fc7\u4e24\u79cd\u9519\u8bef\uff1a</p> <ol> <li>\u975e\u5e38\u957f\u7684\u65f6\u95f4\u624d\u80fd mount \u4e0a  </li> <li>\u76f4\u63a5\u62a5\u7ed9\u51fa\u7684\u670d\u52a1\u4e0d\u53ef\u7528\u3002</li> </ol>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-q","title":"/sbin \u4e0b\u7684 q \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u53ea\u6709\u4e24\u4e2a\uff0cquotacheck \u548c quotaon\uff0c\u5176\u4e2d quotaoff \u662f quotaon \u7684\u8f6f\u8fde\u63a5\u3002</p> <p>\u8fd9\u662f\u548c\u78c1\u76d8\u914d\u989d\u6709\u5173\u7684\u547d\u4ee4\uff0c\u8be6\u7ec6\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003 Linux \u4e0b\u7684\u914d\u989d\u914d\u7f6e\u624b\u518c\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin-r","title":"/sbin \u4e0b r \u5f00\u5934\u7684\u547d\u4ee4","text":"<p>\u7a0d\u5fae\u591a\u4e9b\uff0c\u6709 25 \u4e2a\uff0c\u4e0d\u8fc7\u6709 7 \u4e2a\u662f\u8f6f\u8fde\u63a5\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#restore","title":"restore","text":"<p>\u4ece dump \u51fa\u6765\u7684\u5907\u4efd\u6062\u590d\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6211\u4ec5\u6d4b\u8bd5\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u770b\u4e0a\u53bb\u4e00\u5207\u6b63\u5e38\uff0c\u4e0d\u8fc7\u4ece\u8fd9\u4e2a\u4f8b\u5b50\u3002\u5982\u679c\u4e0d\u8003\u8651\u4e00\u4e9b\u7279\u522b\u56e0\u7d20\uff0c\u90a3\u4e48 dump/restore \u7684\u4f7f\u7528\u65b9\u6cd5\u662f\u5f88\u7b80\u5355\u7684\uff0c\u4e0b\u9762\u662f\u6211\u6d4b\u8bd5\u7684\u4f8b\u5b50</p> <pre><code>#mount /dev/mapper/vgdata-lvtest /misc\n\n#cp -a /boot/* /misc/\n\n#umount /misc\n\n#dump z9 -f /tmp/lvtest.dump /dev/mapper/vgdata-lvtest\nDUMP: Date of this level dump: Mon May 21 10:34:31 2007\nDUMP: Dumping /dev/mapper/vgdata-lvtest (an unlisted file system) to /tmp/lvtest.dump\nDUMP: Label: none\nDUMP: Writing 10 Kilobyte records\nDUMP: Compressing output at compression level 9 (zlib)\nDUMP: mapping (Pass I) [regular files]\nDUMP: mapping (Pass II) [directories]\nDUMP: estimated 40454 blocks.\nDUMP: Volume 1 started with block 1 at: Mon May 21 10:34:33 2007\nDUMP: dumping (Pass III) [directories]\nDUMP: dumping (Pass IV) [regular files]\nDUMP: Closing /tmp/lvtest.dump\nDUMP: Volume 1 completed at: Mon May 21 10:34:44 2007\nDUMP: Volume 1 took 0:00:11\nDUMP: Volume 1 transfer rate: 3056 kB/s\nDUMP: Volume 1 40530kB uncompressed, 33626kB compressed, 1.206:1\nDUMP: 40530 blocks (39.58MB) on 1 volume(s)\nDUMP: finished in 11 seconds, throughput 3684 kBytes/sec\nDUMP: Date of this level dump: Mon May 21 10:34:31 2007\nDUMP: Date this dump completed: Mon May 21 10:34:44 2007\nDUMP: Average transfer rate: 3056 kB/s\nDUMP: Wrote 40530kB uncompressed, 33626kB compressed, 1.206:1\nDUMP: DUMP IS DONE\n\n# ls -lh /tmp/lvtest.dump\n-rw-r--r-- 1 root root 33M 05-21 10:34 /tmp/lvtest.dump\n\n# mkfs.ext3 /dev/mapper/vgdata-lvtest\n# mount /dev/mapper/vgdata-lvtest /misc\n# cd /misc\n\n# restore rf /tmp/lvtest.dump\nDump tape is compressed.\n/dc50/sbin/restore: ./lost+found: File exists\n[root@mlsx misc]# ls\nboot.b initrd-2.6.18.3-52.img memtest86+-1.65 System.map-2.6.18.3-52smp\nvmlinuz-2.6.18.3-52smp\nchain.b initrd-2.6.18.3-52smp.img message System.map-2.6.20.6-2\nvmlinuz-2.6.20.6-2\nconfig-2.6.18.3-52 initrd-2.6.20.6-2.img module-info\nSystem.map-2.6.20-ovz005.1 vmlinuz-2.6.20-ovz005.1\nconfig-2.6.18.3-52smp initrd-2.6.20-ovz005.1.img newinitrd.img\nSystem.map-2.6.9-42.7AX vmlinuz-2.6.9-42.7AX\nconfig-2.6.20.6-2 initrd-2.6.9-42.7AX.img os2_d.b\nvmlinux-2.6.20-ovz005.1\nconfig-2.6.9-42.7AX initrd.img restoresymtable vmlinuz\ngrub lost+found System.map-2.6.18.3-52 vmlinuz-2.6.18.3-52\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u6765\u770b\uff0c\u4f3c\u4e4e dump/restore \u7684\u4f7f\u7528\u65b9\u5f0f\u548c tar \u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u6ca1\u6709 tar \u90a3\u4e48\u5177\u6709\u4eb2\u548c\u529b\uff0c\u6bd5\u7adf tar \u662f\u66f4\u52a0\u901a\u4fd7\u7684\u5907\u4efd\u5de5\u5177\u3002 \u4f46\u662f\u4ece\u6280\u672f\u89d2\u5ea6\u6765\u8bf4\uff0cdump/restore \u548c tar \u5b58\u5728\u8d28\u7684\u533a\u522b\uff1adump/restore \u662f\u57fa\u4e8e\u5757\u8bbe\u5907\u7684\u5907\u4efd\u65b9\u5f0f\uff0c\u800c tar \u5219\u662f\u540c\u65f6\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u7406\u8bba\u4e0adump \u7684\u901f\u5ea6\u5e94\u8be5\u6bd4 tar \u7684\u901f\u5ea6\u8981\u5757\u5199\u3002\u800c\u4e14\u56e0\u4e3a\u662f\u4ece\u5757\u8bbe\u5907\u5907\u4efd\uff0c\u56e0\u6b64\u4e5f\u66f4\u7075\u6d3b\uff0c\u63d0\u4f9b\u7684\u53c2\u6570\u4e5f\u7279\u522b\u591a\u3002</p> <p>\u5f53\u65f6\u8bf4\u5230\u5907\u4efd\u6062\u590d\uff0c\u5728 Unix \u548c Linux \u7cfb\u7edf\u4e2d\uff0c\u6709\u592a\u591a\u7684\u5de5\u5177\u4e86\u3002</p> <p>\u9664\u4e86\u8fd9\u4e24\u8005\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u4e0d\u592a\u5e38\u89c1\u7684\uff0c\u6bd4\u5982 cpio\uff0c\u8fd9\u4e2a\u6587\u4ef6\u683c\u5f0f\u5728 Oracle \u5b98\u65b9\u63d0\u4f9b\u7684\u4ecb\u8d28\u4e0b\u8f7d\u4e2d\u80fd\u770b\u5230\uff0c\u8fd8\u6709\u4e00\u4e2apax\uff0cPortable Archive eXchange \u7684\u7f29\u5199\u3002</p> <p>\u6709\u5173\u5907\u4efd\u7684\u5de5\u5177\uff0c\u6211\u627e\u5230\u4e00\u7bc7\u6587\u6863\uff0c\u5927\u5bb6\u53ef\u4ee5\u770b\u770b</p> <p>Unix \u7cfb\u7d71\u57fa\u672c\u7684\u5099\u4efd\u8207\u56de\u5fa9\u5de5\u5177\u2014dump \u53ca restorerunuser: \u7528\u6307\u5b9a\u7684\u8d26\u53f7\u6216\u8005\u7ec4\u6765\u8fd0\u884c\u4e00\u4e2a shell\uff0c\u7c7b\u4f3c su \u7a0b\u5e8f\uff0c\u4f46\u662f\u4ed6\u6ca1\u6709\u5bc6\u7801\u63d0\u793a\u3002\u4e0a\u9762\u7684\u89e3\u91ca\u662f man \u624b\u518c\u4e2d\u7684\u7ffb\u8bd1\uff0c\u540e\u9762\u7684\u54ea\u4e2a\u5bc6\u7801\u63d0\u793a\u4e0d\u600e\u4e48\u597d\u7406\u89e3\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u77e5\u9053 su \u7a0b\u5e8f\u4ece root \u8d26\u53f7\u5207\u6362\u5230\u5176\u4ed6\u8d26\u53f7\u662f\u4e0d\u9700\u8981\u5bc6\u7801\u7684\uff0c\u800c\u666e\u901a\u8d26\u53f7\u4e4b\u524d\u7684\u5207\u6362\u6216\u8005\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u5230 root \u8d26\u53f7\uff0c\u4f60\u9700\u8981\u63d0\u4f9b\u5bc6\u7801\u7684\u3002 \u56e0\u4e3a\u80fd\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u5230 root \u8d26\u53f7\uff0c\u56e0\u6b64\u610f\u5473\u7740 su \u547d\u4ee4\u662f\u5177\u6709 setuid \u7684\uff0c\u800c runuser \u5374\u6ca1\u6709\u3002\u6240\u4ee5\u5f53\u5728 root \u8d26\u53f7\u4e0b\u6267\u884c runuser test \u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u7acb\u523b\u5207\u6362\u5230\u8d26\u53f7 test \u73af\u5883\u4e0b\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u4f60\u662f\u65e0\u6cd5\u4ece test \u8d26\u53f7\u5207\u6362\u5207\u6362\u5230\u4efb\u4f55\u8d26\u53f7\u7684\uff0c\u4ed6\u4f1a\u7ed9\u4f60\u6743\u9650\u4e0d\u591f\u7684\u63d0\u793a\u3002\u5f53\u7136\u5373\u4fbf\u63d0\u4f9b\u8f93\u5165\u5bc6\u7801\uff0c\u4e5f\u6ca1\u620f\uff0c\u56e0\u4e3a runuser \u662f\u4e00\u4e2a\u666e\u901a\u547d\u4ee4\uff0c\u6ca1\u6709 setuid \u4f4d\uff0c\u90a3\u5c31\u65e0\u6cd5\u4ece\u666e\u901a\u8d26\u53f7\u5207\u6362\u4e86\u3002\u6240\u4ee5\u6211\u4e0d\u6e05\u695a\u4e86\u6709 su \u8fd9\u6837\u7684\u547d\u4ee4\u540e\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 runuser \u8fd9\u6837\u7684\u547d\u4ee4\uff0c\u5386\u53f2\u539f\u56e0\uff1f\u5411\u540e\u517c\u5bb9\uff1fUnix \u6709\uff1fr \u5f00\u5934\u7684\u5176\u4ed6\u547d\u4ee4\u8fd9\u91cc\u4e0d\u8bf4\u4e86\uff0c\u6709\u597d\u51e0\u4e2a\u662f\u4e8e reiser \u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u547d\u4ee4\uff0c\u81ea\u4ece reiser \u6587\u4ef6\u7cfb\u7edf\u7684\u4f5c\u8005\u80cc\u53db\u8c0b\u6740\u59bb\u5b50\u7f6a\u6210\u7acb\u540e\uff0creiser \u6587\u4ef6\u7cfb\u7edf\u7684\u547d\u8fd0\u5c31\u4e0d\u597d\u8bf4\u4e86\uff0c\u636e\u8bf4\u4f5c\u8005\u51c6\u5907\u51fa\u552e reiser \u6587\u4ef6\u7cfb\u7edf\u7684\u7248\u6743\u6765\u6253\u5b98\u53f8\u3002\u5509\uff0c\u8fd8\u662f\u7b49\u7b49\u770b\u5427\u3002\u53e6\u5916\u5c31\u662f rmmod \u547d\u4ee4\uff0c\u8fd9\u662f\u5185\u6838\u9a71\u52a8\u5378\u8f7d\u547d\u4ee4\uff0c\u6211\u8bb0\u5f97\u5f88\u65e9\u524d\u7684 rmmod \u662f insmod \u547d\u4ee4\u7684\u4e00\u4e2a\u8f6f\u8fde\u63a5\uff0c\u73b0\u5728\u4e0d\u662f\u4e86\uff0c\u770b\u6765\u4ed6\u4eec\u5206\u5bb6\u4e86\u3002\u4f46\u662f\u5206\u5bb6\u7684\u539f\u56e0\u672a\u77e5\u3002rfmond \u662f RedFlag \u7cfb\u7edf\u7279\u6709\u7684\uff0c\u662f\u7ea2\u65d7\u7cfb\u7edf\u65e5\u5fd7\u6536\u96c6\u540e\u53f0\u7a0b\u5e8f\uff0c\u524d\u53f0\u662f GUI \u754c\u9762\u7684\u3002rpc \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u5c11\uff0c\u8fd9\u4e9b\u547d\u4ee4\u66f4\u591a\u7684\u5e94\u8be5\u662f\u88ab\u5176\u4ed6 rpc \u5e94\u7528\u7a0b\u5e8f\u6765\u8c03\u7528\uff0c\u6bd4\u5982 smb\uff0c\u6bd4\u5982 nfs\u3002runlevel \u6bd4\u8f83\u719f\u6089\uff0c\u53c2\u6570\u4e5f\u4ec5\u6709\u4e00\u4e2a\uff0c\u5b83\u662f\u4ece/var/run/utmp \u6587\u4ef6\u4e2d\u731c\u7740\u5f53\u524d\u8fd0\u884c\u7684\u7ea7\u522b\u548c\u4e4b\u524d\u8fd0\u884c\u7684\u7ea7\u522b\u3002\u6bd4\u5982\u4f60\u662f\u5728 3 \u7ea7\u522b\u767b\u5f55\u7684\uff0c\u7136\u540e\u6267\u884c startx\uff0c\u7136\u540e\u4f60\u8fd0\u884c runlevel\uff0c\u90a3\u4e48\u4ed6\u7ed9\u51fa\u7684\u7b54\u6848\u662f 5 3 \u8868\u793a\u73b0\u5728\u662f 5 \u7ea7\u522b\uff0c\u4e4b\u524d\u662f 3 \u7ea7\u522b\u3002\u5176\u5b9e\u4ece 3 \u7ea7\u522b\u6267\u884c startx \u6765\u542f\u52a8\u56fe\u5f62\u7ea7\u522b\uff0c\u6211\u66f4\u613f\u610f\u8bf4\u662f\u5728 3 \u7ea7\u522b\u542f\u52a8\u4e86\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u662f\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6bd4\u8f83\u7279\u522b\uff0c\u662f\u4e00\u4e2a X-windows\uff0c\u4ece\u547d\u4ee4\u89d2\u5ea6\u6765\u8bf4\uff0c\u4ed6\u5e94\u8be5\u548c\u5728 3 \u7ea7\u522b\u6267\u884c ls \u7b49\u547d\u4ee4\u6ca1\u6709\u4ec0\u4e48\u5dee\u522b\u3002\u6240\u4ee5\u6211\u5012\u4e0d\u5e0c\u671b startx \u540e\uff0c\u8fd0\u884c runlevel \u7ed9\u51fa\u662f\u7b54\u6848\u662f 5 3,\u6211\u671f\u671b\u662f 3.\u8fd9\u6837 startx \u8fd9\u4e2a\u547d\u4ee4\u672c\u8eab\u5c31\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u6027\u4e86\u3002\u6211\u8fd9\u91cc\u6765\u8bf4\uff0c\u662f\u6bd4\u8f83\u597d\u5411 Linux \u65b0\u624b\u89e3\u91ca Linux \u7684 X-windows\u3002\u6211\u7406\u89e3\u7684\u4ece 3 \u7ea7\u522b\u5230 5 \u7ea7\u522b\u5e94\u8be5\u91c7\u7528\u6700\u539f\u59cb\uff0c\u6700\u4f20\u7edf\u7684 init 5 \u547d\u4ee4\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sfdisk","title":"sfdisk","text":"<p>\u6709\u56db\u4e2a\u4e3b\u8981\u7684\u529f\u80fd\uff1a\u5217\u51fa\u4e00\u4e2a\u5206\u533a\u7684\u5927\u5c0f\uff08\u5757\u4e3a\u5355\u4f4d\uff09\uff0c\u4e00\u4e2a\u8bbe\u5907\u7684\u6240\u6709\u5206\u533a\uff0c\u68c0\u67e5\u4e00\u4e2a\u8bbe\u5907\u7684\u5206\u533a\u8868\uff0c\u91cd\u65b0\u5206\u533a\u4e00\u4e2a\u8bbe\u5907\u3002</p> <p>\u5176\u5b9e\u6211\u5728\u5e73\u65f6\u7528\u7684\u6700\u591a\u7684\u662f\u7b2c\u4e8c\u4e2a--\u5217\u51fa\u4e00\u4e2a\u8bbe\u5907\u7684\u5206\u533a\u8868\u3002\u6709\u4e86 fdisk \u547d\u4ee4\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u6709 sfdisk \u547d\u4ee4\u5462\uff1f\u6211\u7b2c\u4e00\u6b21\u5177\u4f53\u4f7f\u7528 sfdisk \u547d\u4ee4\uff0c\u8fd8\u662f\u5728 HP DL \u7cfb\u5217\u673a\u5668\u4e0a\u3002 HP \u673a\u5668\u4f7f\u7528\u4e86 Smart Array \u9635\u5217\u5361\uff0c\u5176\u94fe\u63a5\u7684 SCSI \u5728 linux \u4e2d\u8bc6\u522b\u51fa\u6765\u7684\u4e0d\u662f\u5e73\u5e38\u6211\u4eec\u5e38\u8ba4\u4e3a\u7684 sdx \u8bbe\u5907\uff0c\u800c\u662f <code>cciss/c0d0px</code> \u8fd9\u6837\u7684\u6837\u5b50\u3002</p> <p>\u800c\u8fd9\u6837\u7684\u5206\u533a\u4fe1\u606f\uff0c\u4f7f\u7528 fdisk -l \u662f\u6ca1\u6709\u529e\u6cd5\u6253\u5370\u51fa\u6765\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u4f7f\u7528<code>sfdisk -l</code>\u547d\u4ee4\u4e86\u3002\u8fd9\u5c31\u4f7f\u7528\u5230\u4e86 sfdisk \u7684\u7b2c\u4e8c\u4e2a\u529f\u80fd\u4e86\u3002</p> <p>\u4ed6\u7684\u7b2c\u4e09\u4e2a\u529f\u80fd\u548c\u7b2c\u56db\u4e2a\u6ca1\u6709\u4f7f\u7528\u8fc7\uff0c\u4e0d\u8fc7\u521a\u624d\u770b man \u624b\u518c\uff0c\u53d1\u73b0\u5176\u5907\u4efd\u548c\u6062\u590d\u5206\u533a\u8868\u7684\u65b9\u5f0f\u5012\u662f\u5f88\u7b80\u5355\u3002</p> <p>\u5907\u4efd\u5206\u533a\u8868\uff1a</p> <pre><code>sfdisk /dev/hdd -O hdd-partition-sectors.save\n</code></pre> <p>\u6062\u590d\u5206\u533a\u8868\uff1a</p> <pre><code>    sfdisk /dev/hdd -I hdd-partition-sectors.save\n</code></pre> <p>\u4e0b\u9762\u662f\u6211\u7684\u5177\u4f53\u6d4b\u8bd5\uff1a</p> <pre><code>fdisk -l /dev/mdp0\n# fdisk -l /dev/mdp0\n\nDisk /dev/mdp0: 419 MB, 419299328 bytes\n2 heads, 4 sectors/track, 102368 cylinders\nUnits = cylinders of 8 * 512 = 4096 bytes\n\nDevice Boot Start End Blocks Id System\n/dev/mdp0p1 1 24415 97658 83 Linux\n/dev/mdp0p2 24416 102368 311812 83 Linux\n# ls /misc\nboot.b\n# df\n\u6587\u4ef6\u7cfb\u7edf        1K-\u5757 \u5df2\u7528 \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/mdp0p2 301959 50763 235606 18% /misc\n\n#sfdisk /dev/mdp0 -O /tmp/mdp0-partition.save\n\n# ls -l /tmp/mdp0-partition.save\n-r\u2013r\u2013r\u2013 1 root root 516 05-28 00:06 /tmp/mdp0-partition.save\n\n# dd if=/dev/zero of=/dev/mdp0 bs=512 count=1\n1+0 records in\n1+0 records out\n512 bytes (512 B) copied, 7.9619e-05 seconds, 6.4 MB/s\n\n# fdisk -l /dev/mdp0\n\nDisk /dev/mdp0: 419 MB, 419299328 bytes\n2 heads, 4 sectors/track, 102368 cylinders\nUnits = cylinders of 8 * 512 = 4096 bytes\n\nDisk /dev/mdp0 doesnt contain a valid partition table\n# sfdisk /dev/mdp0 -I /tmp/mdp0-partition.save\nRe-reading the partition table \u2026\n# fdisk -l /dev/mdp0\n\nDisk /dev/mdp0: 419 MB, 419299328 bytes\n2 heads, 4 sectors/track, 102368 cylinders\nUnits = cylinders of 8 * 512 = 4096 bytes\n\nDevice Boot Start End Blocks Id System\n/dev/mdp0p1 1 24415 97658 83 Linux\n/dev/mdp0p2 24416 102368 311812 83 Linux\n\n# mount /dev/mdp0p2 /misc\n# ls /misc\nboot.b\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\uff0csfdisk \u786e\u5b9e\u53ef\u4ee5\u505a\u5230\u5206\u533a\u7684\u5907\u4efd\u548c\u6062\u590d\uff0c\u800c\u4e14\u5206\u533a\u5df2\u6709\u6570\u636e\u5e76\u4e0d\u4f1a\u4e22\u5931\u3002  </p> <p>\u8fd9\u5176\u5b9e\u548c\u62ff\u7740\u4e00\u7247\u539f\u59cb\u94a5\u5319\u53bb\u914d\u94a5\u5319\u7684\u5730\u65b9\u590d\u5236\u4e00\u7247\u51fa\u6765\uff0c\u67d0\u5929\u539f\u59cb\u7684\u4e22\u4e86\uff0c\u7528\u8fd9\u7247\u590d\u5236\u7684\u6253\u5f00\u623f\u95e8\uff0c\u623f\u5b50\u7684\u6446\u8bbe\u5f53\u7136\u4ec0\u4e48\u90fd\u6ca1\u6709\u6539\u53d8\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#sbin","title":"/sbin \u4e0b\u5269\u4f59\u7684\u547d\u4ee4","text":"<p>\u4ece t \u5230 z \u5f00\u5934\u7684\u547d\u4ee4\u4e0d\u592a\u591a\uff0c\u800c\u4e14\u5f88\u591a\u4e5f\u662f\u5e38\u7528\u7684\uff0c\u4e5f\u53ea\u6709\u90a3\u4e9b\u57fa\u672c\u7528\u6cd5\uff0c\u56e0\u6b64\u6211\u5c31\u4e0d\u8bb0\u5f55\u5230\u8fd9\u91cc\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#tune2fs","title":"tune2fs","text":"<p>\u8fd9\u65e0\u7591\u662f\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5f3a\u52b2\u7684\u547d\u4ee4\u4e86\uff0c\u867d\u7136\u6211\u6211\u6700\u5e38\u7528\u7684\u662f\u4fee\u6539\u9700\u8981\u505a fsck \u4e4b\u524d\u7684\u6700\u5927\u6302\u8f7d\u6b21\u6570\u3002\u521a\u770b\u4e86 man \u624b\u518c\uff0c\u5176\u5b9e\u4ed6\u7684\u53c2\u6570\u591a\u7740\u5462\uff0c\u5f88\u591a\u6587\u4ef6\u7cfb\u7edf\u5143\u6570\u636e\u90fd\u53ef\u4ee5\u4fee\u6539\uff0c\u6bd4\u5982\u4fdd\u7559\u5757\u5927\u5c0f\uff0c\u65e5\u5fd7\u5927\u5c0f\uff0c\u6302\u8f7d\u9009\u9879\u7b49\u3002</p> <p>\u8fd8\u53d1\u73b0\u4e00\u4e2a<code>-L</code>\u7684\u53c2\u6570\u662f\u7ed9\u6587\u4ef6\u7cfb\u7edf\u8bbe\u7f6e\u5377\u8868\uff0c\u4ee5\u524d\u6211\u90fd\u662f\u7528 e2lable \u6765\u5e72\u8fd9\u4e2a\u6d3b\u7684\uff0c\u6ca1\u6709\u60f3\u5230 tune2fs \u4e5f\u80fd\u505a\u3002\u770b\u6765\u4e0b\u6b21\u53ef\u4ee5\u4e0d\u7528\u9700\u8981 e2label \u4e86\u3002</p> <p><code>u</code> \u5f00\u5934\u7684\u57fa\u672c\u4e0a\u90fd\u662f\u548c udev \u76f8\u5173\u7684\uff0c\u8fd9\u65b9\u9762\uff0c\u6211\u8d34\u8fc7\u4e00\u4e2a\u7406\u89e3 udev \u7684\u6587\u7ae0\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d34\u4e86\u3002</p> <p><code>v</code> \u5f00\u5934\u6709\u4e24\u4e2a\u547d\u4ee4\uff0cvboxd\uff0cvchange\uff0c\u662f\u548c ISDN \u6709\u5173\u7684\uff0c\u8fd9\u5e94\u8be5\u7b97\u662f\u4e00\u6bb5\u5386\u53f2\u5427\u3002</p> <p><code>w</code> \u5f00\u5934\u53ea\u6709\u4e00\u4e2a\u547d\u4ee4: wait_for_sysfs\uff0c\u662f udev \u7684 rpm \u5305\u91cc\u7684\uff0c\u7528\u5728 udev \u89c4\u5219\u91cc\u3002</p> <p><code>x</code> \u5f00\u5934\u7684\u4e0e xfs \u6587\u4ef6\u7cfb\u7edf\u6709\u5173\u7684\uff0c\u53ef\u60dc\u76ee\u524d\u6211\u53d1\u73b0\u5728 DC \u4e0a xfs \u652f\u6301\u5f97\u5e76\u4e0d\u662f\u592a\u597d\u3002</p> <p><code>y</code> \u5f00\u5934\u53ea\u6709\u4e00\u4e2a\u547d\u4ee4\uff1aypbind\uff0c\u662f NIS \u7684\u76f8\u5173\u547d\u4ee4\uff0c\u8fd9\u4e2a\u4ece Solaris \u4e0a\u8fc1\u79fb\u8fc7\u6765\u7684\u4e1c\u897f\uff0c\u4e0d\u77e5\u9053\u6709\u6ca1\u6709\u5728 Linux \u8fd0\u884c\u7684\u6848\u4f8b\u3002</p> <p><code>z</code> \u5f00\u5934\u7684\u5c31\u6ca1\u6709\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#usrsbin","title":"/usr/sbin \u4e0b\u7684\u547d\u4ee4","text":"<p><code>/usr/sbin</code>\u4e0b\u7684\u547d\u4ee4\u660e\u663e\u6bd4/sbin \u4e0b\u7684\u547d\u4ee4\u591a\u4e86\u5f88\u591a\uff0c\u56e0\u6b64<code>/usr/sbin</code>\u5e94\u8be5\u662f\u4e00\u4e2a\u6bd4\u8f83\u957f\u7684\u5b66\u4e60\u8fc7\u7a0b\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#alternatives","title":"alternatives","text":"<p>\u7528\u6765\u5bf9\u7cfb\u7edf\u4e2d\u4e0d\u540c\u7248\u672c\u7684\u540c\u4e2a\u8f6f\u4ef6\u8fdb\u884c\u7ba1\u7406\u7684\u5de5\u5177\uff0c\u6bd4\u5982\u7cfb\u7edf\u91cc\u9ed8\u8ba4\u6709\u591a\u4e2a java \u7248\u672c\uff0c\u5230\u5e95\u4f7f\u7528\u90a3\u4e2a\u7248\u672c\u7684 java \u7a0b\u5e8f\uff0c\u8fd9\u65f6\u5c31\u9700\u8981 alternatives \u6765\u7ba1\u7406\u4e86\u3002</p> <p><code>etc/alternatives</code>\u76ee\u5f55\u5c31\u662f\u5b83\u7684\u5927\u672c\u8425\uff0c\u91cc\u9762\u5168\u662f\u94fe\u63a5\u6587\u4ef6\u3002  </p> <p>\u8fd9\u4e2a\u547d\u4ee4\u7f51\u4e0a\u6709\u5f88\u591a\u5e16\u5b50\u8be6\u7ec6\u8bf4\u660e\u4e86\u7528\u6cd5\uff0c\u90a3\u6211\u5c31\u4f7f\u7528\u62ff\u6765\u4e3b\u4e49\u4e86LINUX alternatives howto\u7528\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50\u63cf\u8ff0\u4e86 alternatives \u7684\u7528\u6cd5\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#am-eject","title":"am-eject","text":"<p>\u8fd9\u662f am-utils \u5305\u7684\u4e00\u4e2a\u547d\u4ee4\uff0cam-utils \u662f\u4e00\u4e2a BSD \u7684 automount \u7a0b\u5e8f\uff0c\u7528\u6765\u81ea\u52a8\u6302\u8f7d\u4e00\u4e9b\u6587\u4ef6\u7cfb\u7edf\u3002 \u4ece <code>amd.conf</code> \u7684 man \u624b\u518c\u6765\u770b\uff0c\u4f3c\u4e4e am-utils \u81ea\u80fd\u81ea\u52a8\u6302\u8f7d NFS \u7684\u6587\u4ef6\u7cfb\u7edf\u3002 \u7cfb\u7edf\u540c\u65f6\u4e5f\u5e26\u4e86 autofs \u8fd9\u4e2a\u81ea\u52a8\u6302\u8f7d\u7a0b\u5e8f\uff0c\u4e0e am-utils \u4e0d\u540c\u7684\u662f\uff0cautofs \u662f\u5185\u6838\u7ea7\u522b\u7684\uff0c\u5b83\u9700\u8981\u5185\u6838\u7684\u652f\u6301\uff0c\u53e6\u5916\u5b83\u652f\u6301\u5404\u79cd\u6587\u4ef6\u7cfb\u7edf\u7684\u6302\u8f7d\u3002 \u800c am-utils \u5219\u662f\u7528\u6237\u7a7a\u95f4\u7684\uff0c\u5185\u6838\u5e76\u4e0d\u77e5\u9053\u9700\u8981\u6302\u8f7d\u54ea\u4e9b\u6587\u4ef6\u7cfb\u7edf\u3002\u5206\u522b\u6709\u4e24\u7bc7\u6587\u7ae0\u8be6\u7ec6\u63cf\u8ff0\u4e86 autofs \u548c am-utils \u7684\u7528\u6cd5\uff0c\u5206\u522b\u662f Am-utils (4.4BSD Automounter Utilities)\u548c autofs-HOWTO\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#anaconda","title":"anaconda","text":"<p>\u76ee\u524d\u901a\u7528\u7684 linux \u7cfb\u7edf\u5b89\u88c5\u5411\u5bfc\u7a0b\u5e8f\uff0c\u5e94\u8be5\u7b97\u662f python \u7684\u4ee3\u8868\u4f5c\u5427\u3002\u5230\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u627e\u5230\u7684\u6587\u7ae0\u7adf\u7136\u662f\u73b0\u5728\u7684\u540c\u4e8b\u67cf\u751f\u5728 2005 \u5e74\u53d1\u8868\u5728 IBM \u5f00\u53d1\u7f51\u7ad9\u7684\u6587\u7ae0\uff0c\u56e0\u6b64\u5c31\u76f4\u63a5\u62ff\u8fc7\u6765\u4e86</p> <p>redhat \u5b89\u88c5\u7a0b\u5e8f anaconda\u5206\u6790\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#anacron","title":"anacron","text":"<p>anacron \u662f\u548c cron \u76f8\u4f3c\u7684\u4efb\u52a1\u8c03\u5ea6\u5668\uff0c\u53ea\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u8981\u6c42\u7cfb\u7edf\u6301\u7eed\u8fd0\u884c\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u8fd0\u884c\u901a\u5e38\u7531 cron \u8fd0\u884c\u7684\u6bcf\u65e5\u3001\u6bcf\u5468\u3001\u548c\u6bcf\u6708\u7684\u4f5c\u4e1a\u3002</p> <p>\u7f51\u4e0a\u540c\u6837\u7684\u8be6\u7ec6\u7684\u5e16\u5b50\u4ecb\u7ecd\uff0canacron</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#bgpd","title":"bgpd","text":"<p>Quagga\u8f6f\u4ef6\u5305\u7684\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u7528\u6765\u5b9e\u73b0 BGPv4 \u7b49\u8def\u7531\u534f\u8bae\u7684\u7a0b\u5e8f\u3002 Quagga \u662f\u4e00\u4e2a\u8def\u7531\u7a0b\u5e8f\u5957\u4ef6\uff0c\u5b83\u63d0\u4f9b\u4e86 OSPFv2, OSPFv3, RIP v1 and v2, RIPng and BGP-4 \u7b49\u534f\u8bae\u7684\u5b9e\u73b0\u3002 \u7528\u5b83\uff0c\u5c31\u53ef\u4ee5\u628a\u4e00\u4e2a Linux \u7cfb\u7edf\u6539\u9020\u6210\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u8def\u7531\u5668\uff0c\u548c\u90a3\u4e9b\u52a8\u5219\u4e0a\u5341\u4e07\u767e\u4e07\u7684\u786c\u4ef6\u8def\u7531\u5668\u529f\u80fd\u76f8\u5f53\uff0c\u5bf9\u4e8e SMB(Small Middle Business)\u800c\u8a00,\u5e94\u8be5\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9\u3002</p> <p>Quagga \u8fd8\u5305\u62ec\u4e0b\u9762\u4e00\u4e9b\u547d\u4ee4\uff1a <code>bgpd ospf6d ospfclient ospfd ripd ripngd watchquagga zebra</code></p> <p>quagga \u7684\u4f7f\u7528\u65b9\u5f0f\u548c\u4f7f\u7528 cisco \u7b49\u7f51\u7edc\u8bbe\u5907\u5382\u5546\u7684\u8bbe\u5907\u5dee\u4e0d\u591a\uff0c\u53ef\u60dc\u6211\u5bf9\u8fd9\u4e9b\u4ea7\u54c1\u4e00\u7a8d\u4e0d\u901a\uff0c\u56e0\u6b64 quagga \u8fd9\u4e48\u597d\u7528\u7684\u8f6f\u4ef6\uff0c\u5bf9\u6211\u6765\u8bf4\uff0c\u4e5f\u5c31\u7528\u5904\u4e0d\u5927\u4e86\uff0c\u4e8e\u662f\u7565\u8fc7\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#bmc-config","title":"bmc-config","text":"<p>bmc-config, bmc-info IPMI BMC \u914d\u7f6e\u5de5\u5177\u7a0b\u5e8f\uff0cIPMI(Intelligent Platform Management Interface\uff09\u5373\u667a\u80fd\u5e73\u53f0\u7ba1\u7406\u63a5\u53e3\u662f\u4f7f\u786c\u4ef6\u7ba1\u7406\u5177\u5907\u201c\u667a\u80fd\u5316\u201d\u7684\u65b0\u4e00\u4ee3\u901a\u7528\u63a5\u53e3\u6807\u51c6\u3002</p> <p>\u7528\u6237\u53ef\u4ee5\u5229\u7528 IPMI\u76d1\u89c6\u670d\u52a1\u5668\u7684\u7269\u7406\u7279\u5f81\uff0c\u5982\u6e29\u5ea6\u3001\u7535\u538b\u3001\u7535\u6247\u5de5\u4f5c\u72b6\u6001\u3001\u7535\u6e90\u4f9b\u5e94\u4ee5\u53ca\u673a\u7bb1\u5165\u4fb5\u7b49\u3002Ipmi \u6700\u5927\u7684\u4f18\u52bf\u5728\u4e8e\u5b83\u662f\u72ec\u7acb\u4e8e CPU BIOS \u548c OS\u7684\uff0c \u6240\u4ee5\u7528\u6237\u65e0\u8bba\u5728\u5f00\u673a\u8fd8\u662f\u5173\u673a\u7684\u72b6\u6001\u4e0b\uff0c\u53ea\u8981\u63a5\u901a\u7535\u6e90\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u670d\u52a1\u5668\u7684\u76d1\u63a7\u3002Ipmi \u662f\u4e00\u79cd\u89c4\u8303\u7684\u6807\u51c6\uff0c\u5176\u4e2d\u6700\u91cd\u8981\u7684\u7269\u7406\u90e8\u4ef6\u5c31\u662f BMC(Baseboard Management Controller \u5982\u56fe 1)\uff0c\u4e00\u79cd\u5d4c\u5165\u5f0f\u7ba1\u7406\u5fae\u63a7\u5236\u5668\uff0c\u5b83\u76f8\u5f53\u4e8e\u6574\u4e2a\u5e73\u53f0\u7ba1\u7406\u7684\u201c\u5927\u8111\u201d\uff0c\u901a\u8fc7\u5b83 ipmi\u53ef\u4ee5\u76d1\u63a7\u5404\u4e2a\u4f20\u611f\u5668\u7684\u6570\u636e\u5e76\u8bb0\u5f55\u5404\u79cd\u4e8b\u4ef6\u7684\u65e5\u5fd7\u3002 \u8be6\u7ec6\u7684\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003 IBM \u5f00\u53d1\u7f51\u7684\u4e00\u7bc7\u6587\u6863--\u4f7f\u7528 ipmitool \u5b9e\u73b0 Linux\u7cfb\u7edf\u4e0b\u5bf9\u670d\u52a1\u5668\u7684 ipmi \u7ba1\u7406\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#brctl","title":"brctl","text":"<p>\u7f51\u6865\u7ba1\u7406\u7a0b\u5e8f\uff0c\u7528\u6765\u8bbe\u7f6e\uff0c\u7ef4\u62a4\u76d1\u63a7 linux \u5185\u6838\u7f51\u6865\u914d\u7f6e\u4fe1\u606f\u3002 \u8bf4\u5b9e\u5728\u7684\u6211\u4e0d\u592a\u6e05\u695a\u7f51\u6865\u548c hub \u4e4b\u95f4\u5230\u5e95\u6709\u591a\u5c11\u533a\u522b\uff0c\u6240\u4ee5\u4e5f\u5c31\u4e0d\u77e5\u9053\u6865\u63a5\u662f\u4ec0\u4e48\u6982\u5ff5\u4e86 \u3002\u4e8e\u662f\u6211\u4e5f\u6ca1\u6709\u4ece\u6765\u6ca1\u6709\u4f7f\u7528\u8fc7\u7f51\u6865\u7684\u529f\u80fd\u3002\u8fd9\u91cc\u6709\u7bc7\u6587\u6863\u8be6\u7ec6\u8bf4\u660e\u4e86\u7f51\u6865\u7684\u6982\u5ff5\uff0c\u7528\u9014\uff0c\u5c40\u9650\u6027\u3002</p> <p>\u6587\u7ae0\u63d0\u5230\u7f51\u6865\u9002\u5408\u5c0f\u578b\u8f83\u7b80\u5355\u7684\u7f51\u7edc\uff0c\u90a3\u6211\u76f4\u63a5\u7528\u4e00\u4e2a HUB \u5c31\u884c\u4e86\uff0c100 \u5757\u4e0d\u5230\u5c31\u641e\u5b9a\u4e86\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#chroot","title":"chroot","text":"<p>\u6307\u5b9a\u6839\u6587\u4ef6\u7cfb\u7edf\uff08/\uff09\uff0c\u5f53\u6211\u7b2c\u4e00\u6b21\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u6211\u624d\u53d1\u73b0 Linux \u539f\u6765\u5982\u6b64\u5f3a\u5927\uff0c\u4ec5\u4ec5\u53ea\u9700\u8981\u8fd9\u6837\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u5df2\u7ecf\u5b58\u5728\u7684\u591a\u4e2a\u7cfb\u7edf\u3002 \u6bd4\u5982\u6211\u5e73\u5e38\u4f7f\u7528\u7684\u7cfb\u7edf\u662f Everest\uff0c\u4ed6\u9002\u5408\u684c\u9762\u529e\u516c\uff0c\u4f46\u662f\u6211\u5728\u51fa\u53bb\u57f9\u8bad\u548c\u81ea\u5df1\u8054\u7cfb\u4e00\u4e9b\u6709\u5173\u4f01\u4e1a\u5e94\u7528\u7684\u65f6\u5019\uff0c\u6211\u9700\u8981 DC5 \u7684\u73af\u5883\uff0c\u8fd9\u4e2a\u65f6\u5019 chroot \u5c31\u5e2e\u4e0a\u6211\u7684\u5927\u5fd9\u4e86\uff0c\u4ec5\u4ec5\u53ea\u9700\u8981\u628a DC5 \u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u4e0a\u6765\uff0c\u7136\u540e chroot \u5230\u8fd9\u4e2a\u6302\u8f7d\u70b9\uff0cDC5 \u7684\u73af\u5883\u5c31\u6709\u4e86\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u548c\u76f4\u63a5\u4f7f\u7528 DC5 \u6ca1\u6709\u5dee\u522b\uff0c\u53ea\u662f\u8fd9\u4e2a\u7cfb\u7edf\u7cfb\u7edf\u4f7f\u7528\u8fd8\u662f Everest \u7684\u6838\u5fc3\uff0c\u56e0\u6b64\u5f53\u9700\u8981\u6267\u884c\u4e0e\u6838\u5fc3\u6709\u5173\u7684\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u6b64\u65f6 chroot \u5c31\u6709\u70b9\u65e0\u80fd\u4e3a\u529b\u4e86\uff0c\u4e0d\u8fc7\u597d\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0d\u592a\u591a\u3002Chroot\uff0c\u5f88\u4f1f\u5927\u7684\u521b\u9020\uff01</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#chpasswd","title":"chpasswd","text":"<p>\u6279\u91cf\u4fee\u6539\u5bc6\u7801\uff0c\u8fd9\u5bf9\u7ef4\u62a4\u62e5\u6709\u5927\u91cf\u7528\u6237\u8d26\u53f7\u7684\u7ba1\u7406\u5458\u800c\u8a00\uff0c\u65e0\u7591\u6709\u5e2e\u52a9\uff0c\u867d\u7136\u4f5c\u4e3a\u4e00\u4e2a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u5199\u4e00\u4e2a\u7a0b\u5e8f\u6765\u8fbe\u5230\u6279\u91cf\u4fee\u6539\u8d26\u53f7\u5bc6\u7801\u7684\u76ee\u7684\uff0c\u4f46\u662f\u65e2\u7136\u7cfb\u7edf\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u90a3\u6211\u4eec\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u4f7f\u7528\u5462\uff1f \u4ed6\u4ece\u6807\u6ce8\u8f93\u5165\u8bfb\u53d6\u6bcf\u884c\u7528\u6237\u4fe1\u606f\uff0c\u6bcf\u884c\u7531 <code>username:password</code> \u7ec4\u6210\u3002 \u5bf9\u4e8e password \u7684\u683c\u5f0f\uff0cchpasswd \u7a0b\u5e8f\u7ed9\u51fa\u8d34\u5fc3\u7684\u4e00\u9762\uff0c\u53ef\u4ee5\u4f7f\u7528\u660e\u6587\u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u5c31\u514d\u9664\u4e86\u6211\u4eec\u81ea\u5df1\u53bb\u751f\u6210\u5bc6\u6587\u7684\u70e6\u6270\uff0c\u540c\u65f6\u65e5\u540e\u4e5f\u77e5\u9053\u7528\u6237\u7684\u521d\u59cb\u5bc6\u7801\u662f\u591a\u5c11\u3002 \u53e6\u5916\u4e00\u4e2a\u65b9\u9762\uff0c\u5982\u679c\u4f60\u4ece\u5b8c\u5168\u8003\u8651\uff0c\u5e0c\u671b\u8fd9\u4e2a\u6587\u4ef6\u91cc\u4e0d\u8981\u51fa\u73b0\u660e\u6587\u7684\u5bc6\u7801\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u4f7f\u7528\u52a0\u5bc6\u7684\u5bc6\u7801\u586b\u5145 password \u8fd9\u4e2a\u5b57\u6bb5\uff0c\u53ea\u662f\u4f7f\u7528\u8fd9\u4e2a chpasswd \u547d\u4ee4\u7684\u65f6\u5019\uff0c\u9700\u8981\u4f7f\u7528 <code>-e</code> \u7684\u53c2\u6570\u3002  </p> <pre><code># cat /tmp/chpwd.txt\nwork:test oracle:test\n# chpasswd  \n</code></pre> <p>\u5e94\u8be5\u8bf4\u662f\u975e\u5e38\u65b9\u4fbf\u7684\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dhcrelay","title":"dhcrelay","text":"<p>DHCP \u670d\u52a1\u5668\u4e2d\u8f6c\u5668\u3002\u5f53\u4f60\u7684\u7f51\u7edc\u6709\u4e24\u4e2a VLAN\uff0c\u4f46\u662f\u53ea\u5728 VLAN A \u91cc\u653e\u7f6e\u4e86\u4e00\u4e2a DHCP \u670d\u52a1\u5668\uff0c\u90a3\u4e48\u5982\u4f55\u8ba9 VLAN B \u7684\u673a\u5668\u4e5f\u80fd\u81ea\u52a8\u83b7\u5f97 IP \u5730\u5740\u5462\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c \u4f60\u9700\u8981 dhcrelay \u4e86\u3002\u8fd9\u65b9\u9762\u7684\u6587\u6863\uff0c\u7f51\u7edc\u4e0a\u6bd4\u8f83\u591a\uff0c\u7ed9\u51fa\u4e24\u7bc7\uff1a  </p> <ul> <li>DHCP relay agent </li> <li>dhcp server \u53ef\u4e0d\u53ef\u4ee5\u8de8\u7f51\u6bb5\u6765\u5de5\u4f5c\u3002</li> </ul>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dovecot","title":"dovecot","text":"<p>\u4e00\u4e2a\u7b80\u5355\u4f46\u662f\u5b89\u5168\u7684 IMAP \u670d\u52a1\u5668\uff0c\u4e5f\u5305\u62ec\u4e86 POP3 \u670d\u52a1\uff0c\u652f\u6301 mbox \u548c maildir \u4e24\u79cd\u90ae\u4ef6\u5b58\u50a8\u683c\u5f0f\u3002  \u4ee5\u524d\u6211\u8fd8\u4e0d\u77e5\u9053\u7cfb\u7edf\u81ea\u5e26\u4e86\u8fd9\u4e48\u597d\u7684\u4e1c\u897f\uff0c\u4e5f\u8fd8\u7b80\u5355\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dump-acct","title":"dump-acct","text":"<p>\u5bfc\u51fa\u8fdb\u7a0b\u8bb0\u8d26\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662f<code>/var/account/pacct</code>\uff0c\u4ed6\u548c accton \u547d\u4ee4\u662f\u914d\u5408\u8d77\u6765\u7528\u7684\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dump-utmp","title":"dump-utmp","text":"<p>\u5bfc\u51fa\u767b\u5f55\u8bb0\u8d26\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662f <code>/var/log/wtmp</code>\uff0c\u5176\u529f\u80fd\u548c last \u547d\u4ee4\u76f8\u4f3c\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#dumpcap","title":"dumpcap","text":"<p>dump \u7f51\u7edc\u5305\uff0c\u4ed6\u6293\u83b7\u7f51\u7edc\u6570\u636e\u5305\u5e76\u5199\u5165\u6587\u4ef6\uff0c\u6587\u4ef6\u683c\u5f0f\u53ef\u4ee5\u662f libcap \u7684\uff0c\u4e5f\u53ef\u4ee5\u662f ethereal \u7684\uff0c\u5f53\u7136\u4e5f\u80fd\u662f tcpdump \u7684\u3002 \u4f46\u662f\u6211\u4e0d\u77e5\u9053\u4ed6\u548c tcpdump \u6709\u4ec0\u4e48\u4e0d\u540c,Google \u4e86\u4e00\u4e0b\uff0c\u4e5f\u6ca1\u6709\u53d1\u73b0\u4ec0\u4e48\uff0c\u6211\u89c9\u5f97\u8fd9\u4e0d\u91cd\u8981\uff0cLinux \u4e0b\u4e0d\u662f\u7ecf\u5e38\u5bf9\u67d0\u4e00\u4e2a\u529f\u80fd\uff0c\u6709\u4e00\u6253\u7684\u547d\u4ee4\u53ef\u4ee5\u5b9e\u73b0\u5417\uff1f</p> <p>man \u624b\u518c\u7ed9\u51fa\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>#dumpcap -i eth1 -a duration:60 -w output.pcap\n</code></pre> <p>\u8868\u793a\u6293\u53d6\u901a\u8fc7 eth1,60 \u79d2\u5185\u7684\u6570\u636e\u5305\uff0c\u5e76\u5230\u6587\u4ef6<code>output.cap</code>\u3002\u6293\u51fa\u7684\u5305\u5185\u5bb9\u5927\u81f4\u5982\u4e0b\uff1a</p> <pre><code># cat output.pcap |more\nAccept: */*\nAccept-Language: en-us\nUser-Agent: MSMSGS\nHost: 207.46.106.77\nProxy-Connection: Keep-Alive\nConnection: Keep-Alive\nPragma: no-cache\nContent-Type: application/x-msn-messenger\nContent-Length: 0\n\n0F\ufffd\n2^ english | onclick=\"return top.js.OpenExtLink(window,event,this)\"&gt;\nother\n&amp;nbsp;\n</code></pre>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#filefrag","title":"filefrag","text":"<p>Linux \u4e0b\u7684\u6587\u4ef6\u7cfb\u7edf\u76f8\u6bd4 Windows \u7684\u6587\u4ef6\u7cfb\u7edf\u8981\u4f18\u8d8a\uff0c\u5176\u4e2d\u4e00\u70b9\u5c31\u662f\u4e0d\u7528\u505a\u78c1\u76d8\u788e\u7247\u6574\u7406\uff0c\u4f46\u662f\u8fd9\u5e76\u4e0d\u610f\u5473\u7740 Linux \u4e0b\u7684\u78c1\u76d8\u8bfb\u5199\u5c31\u4e0d\u4f1a\u4ea7\u751f\u788e\u7247\u3002</p> <p>filefrag \u8fd9\u4e2a\u547d\u4ee4\u5c31\u662f\u7528\u6765\u62a5\u544a\u4e00\u4e2a\u6587\u4ef6\u662f\u5426\u6709\u788e\u7247\u7684\u7a0b\u5e8f\u3002\u770b\u51e0\u4e2a\u4f8b\u5b50</p> <pre><code># filefrag /etc/passwd -v\nChecking /etc/passwd\nFilesystem type is: ef53\nFilesystem cylinder groups is approximately 848\nBlocksize of file /etc/passwd is 1024\nFile size of /etc/passwd is 1534 (2 blocks)\nFirst block: 4245865\nLast block: 4245866\n/etc/passwd: 1 extent found\n\n# filefrag /data/tools/db2_v9.iso\n/data/tools/db2_v9.iso: 73 extents found, perfection would be 3 extents\n\n# filefrag /data/tools/db2_v9.iso -v\nChecking /data/tools/db2_v9.iso\nFilesystem type is: ef53\nFilesystem cylinder groups is approximately 245\nBlocksize of file /data/tools/db2_v9.iso is 4096\nFile size of /data/tools/db2_v9.iso is 330647552 (80725 blocks)\nFirst block: 3851518\nLast block: 3954148\nDiscontinuity: Block 769 is at 3852400 (was 3852287)\nDiscontinuity: Block 811 is at 3852471 (was 3852441)\nDiscontinuity: Block 844 is at 3852560 (was 3852503)\nDiscontinuity: Block 2617 is at 3854368 (was 3854335)\nDiscontinuity: Block 2636 is at 3854528 (was 3854386)\nDiscontinuity: Block 2662 is at 3854610 (was 3854553)\n......\n/data/tools/db2_v9.iso: 73 extents found, perfection would be 3 extents\n</code></pre> <p>\u7b2c\u4e00\u4e2a\u6587\u4ef6<code>/etc/passwd</code>\u6ca1\u6709\u4ea7\u751f\u788e\u7247\uff0c\u4f46\u662f\u7b2c\u4e8c\u4e2a\u6587\u4ef6\u5c31\u4e0d\u540c\u4e86\uff0c\u4e00\u5171\u6709 73 \u4e2a\u4e0d\u8fde\u8d2f\u7684\u5730\u65b9\uff08\u8f93\u51fa\u7701\u7565\u4e86\u4e00\u4e9b\uff09\u3002  </p> <p>\u65e2\u7136\u6709\u663e\u793a\u78c1\u76d8\u788e\u7247\u7684\u7a0b\u5e8f\uff0c\u90a3\u6211\u5c31\u60f3\u662f\u5426\u6709\u6574\u7406\u78c1\u76d8\u788e\u7247\u7684\u7a0b\u5e8f\u5462\uff0c\u5230\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\uff0c\u6709\u4eba\u8bf4\u7cfb\u7edf\u4e0a\u6709 defrag \u547d\u4ee4\uff0c\u4f46\u662f\u6211\u7684\u7cfb\u7edf\u663e\u7136\u6ca1\u6709\u3002</p> <p>\u8fd8\u6709\u4eba\u8bf4\uff0cLinux \u6839\u672c\u7528\u4e0d\u7740\u505a\u78c1\u76d8\u788e\u7247\u6574\u7406\u3002\u662f\u554a\uff0c\u8bb0\u5f97\u7b2c\u4e00\u6b21\u89e3\u9664 Linux \u7684\u65f6\u5019\uff0c\u5c31\u770b\u5230\u6709\u8fd9\u6837\u7684\u8bdd--Linux \u4e0d\u9700\u8981\u78c1\u76d8\u6574\u7406--\u4e0d\u8fc7\u5982\u679c\u4f60\u771f\u7684\u60f3\u89e3\u51b3\u8fd9\u4e2a\u5176\u5b9e\u4e0d\u662f\u95ee\u9898\u7684\u95ee\u9898\uff0c\u90a3\u4f60\u53ef\u4ee5\u5c1d\u8bd5 fsck\uff0c \u7f51\u4e0a\u8bf4\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u6587\u4ef6\u5e26\u6765\u7684\u78c1\u76d8\u788e\u7247\uff0c\u4f46\u662f\u6211\u73b0\u5728\u6ca1\u6709\u505a\u8fd9\u4e2a\u6d4b\u8bd5\u3002\u7b49\u6709\u673a\u4f1a\u5e94\u8be5\u8bd5\u8bd5\u3002</p> <p>\u8fd9\u4e2a\u547d\u4ee4\u7684\u6700\u540e\u8f93\u51fa\u201cperfection would be 3 extents\u201d\u6ca1\u6709\u592a\u660e\u767d\u4ed6\u7684\u610f\u601d\uff0c\u662f\u4e0d\u662f\u8bf4\u5982\u679c\u6211\u91c7\u7528\u67d0\u4e2a\u65b9\u5f0f\uff0c\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e9b\u78c1\u76d8\u788e\u7247\u7684\u4e2a\u6570\u7531 73 \u4e2a\u964d\u4f4e\u5230 3 \u4e2a\u5462\uff1f\u7528\u4ec0\u4e48\u6837\u7684\u65b9\u6cd5\u5462\uff1f\u6ca1\u6709\u627e\u5230\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#wireshark","title":"wireshark","text":"<p>wireshark\uff1a\u4e4d\u4e00\u770b\uff0c\u4e0d\u77e5\u9053\u8fd9\u4e2a\u547d\u4ee4\u505a\u4ec0\u4e48\u7528\u7684\uff0cman \u4e86\u4e00\u4e0b\u624b\u518c\uff0c\u5230\u7f51\u7edc\u4e0a\u641c\u5bfb\u4e86\u4e00\u628a\uff0c\u624d\u77e5\u9053\u539f\u6765\u5b83\u662f\u5927\u540d\u9f0e\u9f0e\u7684 Ethereal \u7684\u5316\u8eab\u5440\uff0cethereal \u4f30\u8ba1\u5f88\u591a\u7528\u8fc7 Linux \u7684\u4eba\u90fd\u77e5\u9053\uff0c\u5b83\u662f\u4e16\u754c\u4e0a\u6700\u6d41\u884c\u7684\u7f51\u7edc\u5206\u6790\u5de5\u5177\u4e4b\u4e00\uff0c\u8fd9\u4e2a\u5f3a\u5927\u7684\u5de5\u5177\u53ef\u4ee5\u6355\u6349\u7f51\u7edc\u4e2d\u7684\u6570\u636e\uff0c\u5e76\u672a\u7528\u6237\u63d0\u4f9b\u7f51\u7edc\u548c\u4e0a\u5c42\u534f\u8bae\u7684\u5404\u79cd\u4fe1\u606f\uff0c\u5b83\u5177\u6709\u5b89\u88c5\u7b80\u4fbf\uff0c\u7b80\u5355\u6613\u7528\uff0c\u529f\u80fd\u4e30\u5bcc\u7b49\u7279\u5f81\u3002</p> <p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5b83\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u5bb9\u6613\u64cd\u4f5c\u7684\u56fe\u5f62\u754c\u9762\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f CLI \u7684\u6b7b\u5fe0\u5206\u6790\uff0c\u4e5f\u8bb8 tshark \u4f1a\u6210\u4e3a\u4f60\u7684\u6700\u7231\uff0ctshark \u662f wireshark \u7684 CLI \u5b9e\u73b0\u3002</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#tripwire","title":"tripwire","text":"<p>tripwire\uff1a<code>*nix</code> \u7cfb\u7edf\u4e0b\u6700\u8457\u540d\u7684\u6587\u4ef6\u7cfb\u7edf\u5b8c\u6574\u6027\u68c0\u67e5\u5de5\u5177\uff0c\u8fd9\u4e2a\u8f6f\u4ef6\u91c7\u53d6\u7684\u6838\u5fc3\u6280\u672f\u5c31\u662f\u5bf9\u6bcf\u4e2a\u8981\u76d1\u63a7\u7684\u6587\u4ef6\u4ea7\u751f\u4e00\u4e2a\u6570\u5b57\u7b7e\u540d\u5e76\u4fdd\u7559\u4e0b\u6765\u3002</p> <p>\u5f53\u6570\u5b57\u7b7e\u540d\u4e0d\u4e00\u81f4\u65f6\uff0c\u5fc5\u5b9a\u6587\u4ef6\u88ab\u4fee\u6539\u8fc7\u3002\u5f53\u4f60\u8981\u4e3a\u4f60\u7684\u7cfb\u7edf\u5b89\u5168\u7740\u60f3\u7684\u65f6\u5019\uff0c\u4f60\u5e94\u8be5\u60f3\u8d77\u5b83\uff01</p>","tags":["linux","commands"]},{"location":"courses/commands-in-sbin/#vipw","title":"vipw","text":"<p>\u4e0d\u662f\u591a\u4e48\u795e\u5947\u548c\u9ad8\u6df1\u7684\u547d\u4ee4\uff0c\u4e0d\u5e26\u4efb\u4f55\u53c2\u6570\uff0c\u8fd0\u884c\u540e\uff0c\u76f4\u63a5\u6253\u5f00 <code>/etc/passwd</code>\uff0c\u4e8e\u662f\u6211\u77e5\u9053\u8fd9\u4e2a\u547d\u4ee4\u7684\u610f\u601d\u4e86<code>vipw = vi /etc/passwd</code>\uff0c\u4ee5\u4e3a\u662f\u4e00\u4e2a\u811a\u672c\uff0c\u7136\u540e vipw \u662f\u4e00\u4e2a\u5730\u5730\u9053\u9053\u7684 ELF \u6587\u4ef6\uff0c\u5b9e\u9645\u4e0a\u4ed6\u662f VIM \u7684 tiny \u7248\u7684\u5b9e\u73b0\u3002 \u4e0d\u6653\u5f97\u4f5c\u8005\u5199\u8fd9\u4e2a\u7a0b\u5e8f\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f\u4ec5\u4ec5\u662f\u4e3a\u4e86\u65b9\u4fbf\u7f16\u8f91<code>/etc/passwd</code>\uff1f\u8fd8\u662f\u8bf4\u4e07\u4e00\u7cfb\u7edf\u6ca1\u6709\u5b89\u88c5\u7f16\u8f91\u5668\uff0c\u6211\u8fd8\u7528\u5b83\u5f53\u505a\u7f16\u8f91\u5668\u7528\uff0c  </p>","tags":["linux","commands"]},{"location":"courses/linux-cfs-scheduler/","title":"Linux CFS \u8c03\u5ea6\u5668\uff1a\u539f\u7406\u3001\u8bbe\u8ba1\u4e0e\u5185\u6838\u5b9e\u73b0","text":"<p>Source</p> <p>\u6574\u7406\u4e00\u4e9b Linux \u9ed8\u8ba4\u8c03\u5ea6\u5668 CFS \u76f8\u5173\u7684\u4e1c\u897f\u3002CFS\u3001cgroup \u7b49\u5185\u6838\u6280\u672f\u5408\u529b\u5b9e\u73b0\u4e86\u8fdb\u7a0b\u7684 CPU \u8d44\u6e90\u9650\u989d\uff08CPU \u5e26\u5bbd\u63a7\u5236\uff09\uff0c\u8fd9\u662f\u5bb9\u5668\u7684\u57fa\u7840\u4e4b\u4e00\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#1","title":"1 \u6982\u5ff5\u53ca\u5173\u7cfb","text":"<p>\u9996\u5148\u7406\u6e05\u51e0\u4e2a\u6982\u5ff5\u548c\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#11-cfstask","title":"1.1 CFS\uff1a\u8fdb\u7a0b\uff08task\uff09\u7684\u516c\u5e73\u8c03\u5ea6","text":"<p>CFS\uff08Completely Fair Scheduler\uff09\u662f Linux \u5185\u7f6e\uff08\u4e5f\u662f\u76ee\u524d\u9ed8\u8ba4\uff09\u7684\u4e00\u4e2a**\u5185\u6838\u8c03\u5ea6\u5668**\uff0c \u5982\u540d\u5b57\u6240\u793a\uff0c\u5b83\u5b9e\u73b0\u4e86\u6240\u8c13\u7684\u201c\u5b8c\u5168\u516c\u5e73\u201d\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5c06 CPU \u8d44\u6e90\u5747\u5300\u5730\u5206\u914d\u7ed9\u5404\u8fdb\u7a0b\uff08 \u5728\u5185\u6838\u4ee3\u7801\u4e2d\u79f0\u4e3a\u201c\u4efb\u52a1\u201d\uff0ctask\uff09\u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u53f0\u673a\u5668\u6709\u4e00\u4e2a CPU \u591a\u4e2a\uff08\u8ba1\u7b97\u5bc6\u96c6\u578b\uff09\u8fdb\u7a0b\uff0c\u90a3\u91c7\u7528 CFS \u8c03\u5ea6\u5668\u65f6\uff0c</p> <p></p> <ul> <li>\u4e24\u4e2a\u8fdb\u7a0b\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u4f1a\u5404\u5360 50% CPU \u65f6\u95f4\uff1b</li> <li>\u56db\u4e2a\u8fdb\u7a0b\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u4f1a\u5404\u5360 25% CPU \u65f6\u95f4\uff1b</li> </ul> <p>\u8fd9\u4e2a\u5f88\u597d\u7406\u89e3\u3002\u63a5\u4e0b\u6765\u770b\u7b2c\u4e8c\u4e2a\u6982\u5ff5\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#12-cfs","title":"1.2 CFS \u6269\u5c55","text":"<p>\u6700\u521d\u7684 CFS \u7ba1\u7406\u7684\u662f\u5355\u4e2a\u4efb\u52a1\uff08\u8fdb\u7a0b\uff09\u7684\u8c03\u5ea6\uff0c\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u914d\u516c\u5e73\u7684 CPU \u65f6\u95f4\u3002 \u4f46\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u4f1a\u7ec4\u7ec7\u6210\u8fdb\u7a0b\u7ec4\uff08task group\uff09\u7684\u5f62\u5f0f\uff0c \u7528\u6237\u5e0c\u671b\u5148\u5bf9\u8fdb\u7a0b\u7ec4\u5206\u914d CPU \u4efd\u989d\uff0c\u518d**\u5728\u6bcf\u4e2a\u8fdb\u7a0b\u7ec4\u91cc\u9762\u5b9e\u73b0\u516c\u5e73\u8c03\u5ea6**\u3002</p> <p>\u4e3e\u4e2a\u5177\u4f53\u4f8b\u5b50\uff0c\u591a\u4e2a\u7528\u6237\u4f7f\u7528\u540c\u4e00\u53f0\u673a\u5668\u65f6\uff0c\u53ef\u80fd\u5e0c\u671b\uff0c</p> <ul> <li>\u9996\u5148\u6309 user \u516c\u5e73\uff08\u4e5f\u53ef\u4ee5\u4e0d\u516c\u5e73\uff09\u5206\u914d CPU\uff1b</li> <li>\u9488\u5bf9\u6bcf\u4e2a user\uff0c\u518d\u5bf9\u5176\u6240\u6709\u8fdb\u7a0b\u516c\u5e73\u5206\u914d\u8fd9\u4e2a user \u7684\u603b CPU \u65f6\u95f4\u3002</li> </ul> <p>\u4e3a\u6b64\uff0cCFS \u5f15\u5165\u4e86\u51e0\u9879\u6269\u5c55\uff0c\u4f8b\u5982</p> <ul> <li>\u5b9e\u65f6\u4efb\u52a1\u7684\u7ec4\u8c03\u5ea6\uff08RT group\uff09</li> <li>\u5e38\u89c4\u8fdb\u7a0b\u7684\u7ec4\u8c03\u5ea6\uff08task group\uff09</li> </ul> <p>\u4f46\u5b9e\u73b0\u8fd9\u51e0\u4e2a\u6269\u5c55\u662f\u9700\u8981\u4e00\u4e9b\u524d\u63d0\u7684\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#121-config_cgroups","title":"1.2.1 \u524d\u63d0\uff1a<code>CONFIG_CGROUPS</code>","text":"<p>\u8981\u5b9e\u73b0\u6309\u8fdb\u7a0b\u7ec4\u5206\u914d\u548c\u7ba1\u7406 CPU \u4efd\u989d\u7684\u529f\u80fd\uff0c\u9996\u5148\u8981\u80fd\u591f\u63a7\u5236\uff08control\uff09 \u8fdb\u7a0b\u7ec4\uff08task group\uff09\u7684\u8d44\u6e90\u9650\u989d\uff0c \u8fd9\u79cd\u6280\u672f\u5728 Linux \u5185\u6838\u4e2d\u5df2\u7ecf\u6709\u4e86\uff0c\u53eb**\u63a7\u5236\u7ec4\uff08control group\uff09\uff0c\u7f29\u5199\u662f cgroup\u3002 \uff08<code>CONFIG_CGROUPS</code>**\uff09\u3002</p> <ul> <li>cgroup \u6709\u4e24\u4e2a\u7248\u672c\uff0c\u5206\u522b\u79f0\u4e3a cgroup v1 \u548c cgroup v2\u3002\u8fd9\u4e24\u4e2a\u7248\u672c**\u4e0d\u517c\u5bb9**\uff0c\u73b0\u5728\u9ed8\u8ba4\u90fd\u662f\u7528\u7684 v1\uff1b</li> <li>\u6709\u4e86 <code>cgroup</code>\uff0c\u8c03\u5ea6\u5668\u5c31\u80fd\u901a\u8fc7 <code>cgroup</code> \u4f2a\u6587\u4ef6\u7cfb\u7edf\u6765\u7ba1\u7406\u8fdb\u7a0b\u7ec4\u5360\u7528\u7684\u8d44\u6e90\uff08\u6211\u4eec\u8fd9\u91cc\u5173\u5fc3\u7684\u662fCPU \u8d44\u6e90\uff09\u4e86\uff1b</li> <li>\u66f4\u591a\u4fe1\u606f\u89c1 Documentation/admin-guide/cgroup-v1/cgroups.rst\u3002</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#122-config_cgroup_sched","title":"1.2.2 \u524d\u63d0\uff1a<code>CONFIG_CGROUP_SCHED</code>","text":"<p>cgroup \u662f\u6309\u8d44\u6e90\u7c7b\u578b\uff08cpu/memory/device/hugetlb/\u2026\uff09\u6765\u505a\u8d44\u6e90\u9650\u989d\u7684\uff0c\u6bcf\u79cd\u8d44\u6e90 \u7c7b\u578b\u4f1a\u6709\u4e00\u79cd\u5bf9\u5e94\u7684\u63a7\u5236\u5668\uff08controller\uff09\uff0c\u6709\u72ec\u7acb\u7684\u5f00\u5173\u3002 \u63a7\u5236**\u8fdb\u7a0b\u6216\u8fdb\u7a0b\u7ec4\u80fd\u4f7f\u7528\u7684 CPU \u65f6\u95f4**\uff0c\u5bf9\u5e94\u7684\u5f00\u5173\u662f <code>CONFIG_CGROUP_SCHED</code>\u3002</p> <p>\u81f3\u6b64\uff0c\u652f\u6301\u8fdb\u7a0b\u7ec4\u7ea7\u522b\u8d44\u6e90\u63a7\u5236\u7684\u57fa\u7840\u5c31\u5177\u5907\u4e86\u3002\u63a5\u4e0b\u6765\u5c31\u662f CFS \u6269\u5c55\u4ee3\u7801\u7684\u5b9e\u73b0\uff0c \u6dfb\u52a0\u5bf9\u4e8e realtime/conventional task group \u7684\u652f\u6301\u3002\u4e0b\u9762\u5206\u522b\u6765\u770b\u4e0b\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#123-config_rt_group_sched","title":"1.2.3 \u6269\u5c55\uff1a\u652f\u6301\u5b9e\u65f6\u8fdb\u7a0b\u7ec4\uff08<code>CONFIG_RT_GROUP_SCHED</code>\uff09","text":"<p><code>CONFIG_RT_GROUP_SCHED</code> \u652f\u6301\u5bf9 real-time (SCHED_FIFO and SCHED_RR) \u4efb\u52a1\u8fdb\u884c\u5206\u7ec4 CFS\u3002</p> <p>\u5b9e\u65f6\u8fdb\u7a0b\u6709\u4e25\u683c\u7684\u54cd\u5e94\u65f6\u95f4\u9650\u5236\uff0c\u4e0d\u7ba1\u673a\u5668\u7684 load \u6709\u591a\u9ad8\uff0c\u90fd\u5e94\u8be5\u786e\u4fdd\u8fd9\u4e9b\u8fdb\u7a0b\u7684\u54cd\u5e94\u5b9e\u65f6\u6027\u3002 \u4f8b\u5b50\uff1a\u5185\u6838\u4e2d\u7684 <code>migration</code> \u8fdb\u7a0b\uff0c\u8d1f\u8d23\u5728\u4e0d\u540c CPU \u4e4b\u95f4\u5206\u53d1\u4efb\u52a1\uff08\u8fdb\u7a0b\u8d1f\u8f7d\u5747\u8861\uff09\u3002</p> <pre><code>$ ps -ef | grep migration\nroot          12       2  0       00:00:01 [migration/0]\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#124-config_fair_group_sched","title":"1.2.4 \u6269\u5c55\uff1a\u652f\u6301\u5e38\u89c4\u8fdb\u7a0b\u7ec4\uff08<code>CONFIG_FAIR_GROUP_SCHED</code>\uff09","text":"<p>\u5b9e\u65f6\u8fdb\u7a0b\u4e4b\u5916\u7684\u8fdb\u7a0b\u5c31\u662f\u6240\u8c13\u7684**\u5e38\u89c4\u8fdb\u7a0b**\uff0c\u5b83\u4eec\u6ca1\u6709\u4e25\u683c\u7684\u54cd\u5e94\u65f6\u95f4\u9650\u5236\uff0c \u5f53\u7cfb\u7edf\u7e41\u5fd9\u65f6\uff0c\u54cd\u5e94\u5ef6\u8fdf\u5c31\u4f1a\u589e\u52a0\u3002</p> <p>\u5728 cgroup \u6280\u672f\u57fa\u7840\u4e0a\u4e0a\uff0c\u518d\u5bf9 CFS \u4ee3\u7801\u505a\u4e00\u4e9b\u589e\u5f3a\uff0c\u5c31\u80fd\u591f\u652f\u6301\u8fdb\u7a0b\u7ec4\u5185\u7684\u516c\u5e73\u8c03\u5ea6\u4e86\u3002 \u8fd9\u4e9b\u589e\u5f3a\u4ee3\u7801\u662f\u901a\u8fc7\u7f16\u8bd1\u9009\u9879 <code>CONFIG_FAIR_GROUP_SCHED</code> \u63a7\u5236\u7684\u3002 \u652f\u6301\u5bf9\u666e\u901a CFS (SCHED_NORMAL, SCHED_BATCH) \u4efb\u52a1\u8fdb\u884c\u5206\u7ec4\u3002</p> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u5bf9\u8fdb\u7a0b\u548c\u8fdb\u7a0b\u7ec4\u8fdb\u884c CFS \u8c03\u5ea6\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#13-cfs-cpu","title":"1.3 \u5e38\u89c4\u8fdb\u7a0b\u7ec4 CFS \u518d\u6269\u5c55\uff1a\u652f\u6301 CPU \u5e26\u5bbd\u63a7\u5236\uff08\u9650\u989d\uff09","text":""},{"location":"courses/linux-cfs-scheduler/#131-cfs","title":"1.3.1 CFS \u5b58\u5728\u7684\u95ee\u9898","text":"<p>CFS \u81ea\u5df1\u4e5f\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\u6216\u9650\u5236\uff1a</p> <ol> <li>\u67d0\u4e9b\u60c5\u51b5\u4e0b\u505a\u4e0d\u5230\u771f\u6b63\u7684\u516c\u5e73\u3002</li> </ol> <p>CFS \u672c\u8d28\u4e0a\u662f\u4f1a\u628a CPU \u7528\u6ee1\u7684\uff08work-conserving\uff09\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a CPU \u4e0a \u6709\u4e24\u4e2a\u4efb\u52a1\uff0c\u7406\u8bba\u4e0a\u5e94\u8be5\u5404\u5360\u7528 50% \u7684 CPU\uff1b\u4f46\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u4efb\u52a1\u6709\u5f88\u591a sleep/wait \u65f6\u95f4\uff0c CFS \u5c31\u4f1a\u628a\u591a\u4f59\u7684\u65f6\u95f4\u7ed9\u5230\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\uff0c\u5bfc\u81f4\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u95f4\u8d85\u8fc7\u4e00\u534a\u3002 2. \u4f18\u5148\u7ea7\u9ad8\u7684\u8fdb\u7a0b\u4ecd\u7136\u53ef\u80fd\u83b7\u5f97\u66f4\u5927\u7684\u65f6\u95f4\u7247\u3002</p> <p>\u5185\u6838\u4e2d\u6709\u4e24\u4e2d\u8c03\u5ea6\u7c7b\uff08scheduling class\uff09\uff1aSCHED_RT \u548c SCHED_NORMAL\uff0c\u524d\u8005\u7684\u4f18\u5148\u7ea7\u66f4\u5927\u3002 \u5f53\u4e00\u4e2a CPU \u4e0a\u6709 RT \u7c7b\u578b\u4efb\u52a1\u65f6\uff0c\u6c38\u8fdc\u662f\u5b83\u4eec\u5148\u6267\u884c\u3002\u4f18\u5148\u7ea7\u53ef\u4ee5\u901a\u8fc7 <code>nice(2)</code> \u63a7\u5236\u3002 3. \u65e0\u6cd5\u8bbe\u7f6e CPU \u4f7f\u7528\u4e0a\u9650\u3002</p> <p>CFS \u53ea\u5173\u6ce8 CPU \u5e73\u5747\u5206\u914d\uff0c\u5e76\u4e0d\u4fdd\u8bc1 CPU \u65f6\u95f4\uff08\u4e0a\u4e0b\u9650\uff09\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0cCPU share/quota \u53ea\u6709\u76f8\u5bf9\u610f\u4e49\uff0cshare \u5927\u7684\u4e00\u5b9a\u6bd4 share \u5c0f\u7684\u80fd\u5206\u5230\u66f4\u591a CPU\uff0c\u4ec5\u6b64\u800c\u5df2\u3002 \u8fdb\u7a0b\u8d8a\u591a\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u5230\u7684 CPU \u65f6\u95f4\u8d8a\u5c11\u3002 CPU \u9650\u989d\uff08\u4e0a\u9650\uff09\u5bf9**\u6309 CPU \u65f6\u95f4\u8ba1\u8d39**\u7684\u573a\u666f\u975e\u5e38\u5173\u952e\uff0c\u4f8b\u5982\u516c\u6709\u4e91\u3002</p> <pre><code>%%{ init: { 'flowchart': { 'curve': 'bumpX' } } }%%\ngraph TB\nrg([\"Root group/&lt;br&gt;(no tasks directrly under root)&lt;br/&gt; CPU:100%&lt;br/&gt;shares: 1024\"])\nprof[\"professor&lt;br&gt;CPU:50%&lt;br&gt;shares:1024\"]\nstu[\"students&lt;br&gt;CPU:25%&lt;br&gt;shares:1024\"]\nsys[\"system_tasks&lt;br&gt;CPU:25%&lt;br&gt;shares:1024\"]\ne1[\"Electronics Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne2[\"Electronics Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne3[\"Computers Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\ne4[\"Other Students&lt;br&gt;CPU:30%&lt;br/&gt;shares:3072\"]\n\nrg ---&gt; prof &amp; stu &amp; sys\nstu ---&gt; e1 &amp; e2 &amp; e3 &amp; e</code></pre> <p>\u56fe\u7247\u6765\u81ea google paper [5]\u3002\u6ce8\u610f\uff1a\u4e25\u683c\u6765\u8bf4\uff0c\u8fd9\u91cc\u7684\u76f8\u5bf9\u65f6\u95f4\u8fd8\u53ea\u662f\u5728 SCHED_NORMAL \u91cc\u7684\u65f6\u95f4\uff0c\u4e0d\u5305\u62ec SCHED_RT \u8fdb\u7a0b\u5360\u6389\u7684 CPU \u65f6\u95f4\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#132-config_cfs_bandwidth","title":"1.3.2 <code>CONFIG_CFS_BANDWIDTH</code>","text":"<p>\u4e25\u683c\u6765\u8bf4\uff0cLinux \u4e2d\u7684\u8c03\u5ea6\u5355\u4f4d\u662f\u7ebf\u7a0b\uff08thread\uff09\uff0c\u56e0\u6b64\u5728\u8c03\u5ea6\u4e0a\u4e0b\u6587\u4e2d\u5e76\u6ca1\u6709\u8fdb\u7a0b\uff08process\uff09\u7684\u6982\u5ff5\u3002</p> <p>\u57fa\u4e8e\u4ee5\u4e0a\u539f\u56e0\uff0cGoogle \u63d0\u51fa\u4e86 CFS CPU \u5e26\u5bbd\u63a7\u5236\uff08CFS bandwidth control\uff09\u65b9\u6848\uff0c\u5e76\u5408\u5e76\u5230\u4e86\u4e3b\u7ebf\u5185\u6838\u3002 \u8fd9\u91cc\u7684\u201cCPU \u5e26\u5bbd\u201d\u6307\u7684\u5c31\u662f CPU \u4efd\u989d\uff0c\u6216\u8005\u8bf4\u7684\u66f4\u6e05\u695a\u70b9\uff0cCPU \u6bd4\u4f8b\u3002 SCHED_RT \u4e2d\u5176\u5b9e\u5df2\u7ecf\u6709\u8fd9\u4e2a\u529f\u80fd\uff0c\u8fd9\u91cc\u6307\u7684\u662f SCHED_NORMAL \u652f\u6301\u8fd9\u4e2a\u529f\u80fd\u3002</p> <p>\u8fd9\u4e2a\u529f\u80fd\u7684\u597d\u5904\u4e3b\u8981\u662f\u7ed9\u670d\u52a1\u5668\uff0c\u4e0d\u662f\u7ed9\u684c\u9762\u7535\u8111\u3002 \u597d\u5904\uff1a</p> <ul> <li>\u80fd\u7cbe\u786e\u63a7\u5236\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684 CPU \u5e26\u5bbd\u4e0a\u9650\uff1b\u6bd4\u5982\u8bbe\u7f6e\u4e00\u4e2a\u5bb9\u5668\u53ea\u80fd\u4f7f\u7528 0.2 CPU\uff0c \u90a3\u5b83\u7684\u603b\u65f6\u95f4\u5c31\u4e0d\u80fd\u8d85\u8fc7\u8fd9\u4e2a\u6bd4\u4f8b\uff0c\u5373\u4f7f\u8fd9\u4e2a CPU \u975e\u5e38\u7a7a\u95f2\uff1b</li> <li>\u5bf9\u5bb9\u91cf\u89c4\u5212\u975e\u5e38\u6709\u7528\uff08\u4f8b\u5982 OpenStack \u8c03\u5ea6 VM\uff0ck8s \u8c03\u5ea6 pod\uff09\uff1b</li> <li>\u5ef6\u8fdf\u66f4\u6709\u4fdd\u8bc1\uff1b</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#14-cfs-bandwith","title":"1.4 CFS BANDWITH \u8fd1\u51e0\u5e74\u6539\u8fdb","text":"<ul> <li>burst \u7279\u6027\uff1a\u5141\u8bb8\u501f\u7528\u524d\u4e00\u4e2a\u8fdb\u7a0b\u5269\u4e0b\u7684\u5e26\u5bbd\u3002</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#15-cfs","title":"1.5 \u5c0f\u7ed3\uff1aCFS \u76f8\u5173\u5185\u6838\u7f16\u8bd1\u9009\u9879\u7684\u5173\u7cfb","text":"<p>\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u63d0\u5230\u7684 CFS \u76f8\u5173\u529f\u80fd\uff0c\u5b83\u4eec\u7684\u914d\u7f6e\u9009\u9879\u6216\u4f9d\u8d56\u5173\u7cfb\u5982\u4e0b\uff1a</p> <pre><code>CONFIG_CGROUPS                     # 1. \u662f\u5426\u652f\u6301 cgroup\uff0c\u4e0b\u9762\u8fdb\u4e00\u6b65\u533a\u5206 cpu/memory/hugetlb/...\n  |-CONFIG_MEMCG                   #   1.1 \u662f\u5426\u652f\u6301 memory cgroup\n  |-CONFIG_BLK_CGROUP              #   1.2 \u662f\u5426\u652f\u6301 blkio cgroup\n  |-CONFIG_CGROUP_SCHED            #   1.3 \u662f\u5426\u652f\u6301 cpu cgroup\n  |   |-CONFIG_RT_GROUP_SCHED      #     1.3.1 \u662f\u5426\u652f\u6301 realtime scheduler cpu cgroup\n  |   |-CONFIG_FAIR_GROUP_SCHED    #     1.3.2 \u662f\u5426\u652f\u6301 cfs for task cgroup\n  |       |-CONFIG_CFS_BANDWIDTH   #       1.3.2.1 \u662f\u5426\u652f\u6301 cfs cpu bandwidth\n  |\n  |-CONFIG_CGROUP_PIDS             #   1.4 \u662f\u5426\u652f\u6301 pid cgroup\n  |-CONFIG_CPUSETS                 #   1.5 \u662f\u5426\u652f\u6301 cpuset cgroup\n  |-CONFIG_CGROUP_DEVICE           #   1.6 \u662f\u5426\u652f\u6301 device cgroup\n  |-CONFIG_CGROUP_CPUACCT          #   1.7 \u662f\u5426\u652f\u6301 cpu,acc cgroup\n  |-...                            #   1.8 \u662f\u5426\u652f\u6301 ... cgroup\n</code></pre> <p>\u8fd9\u4e9b\u5b8f\u5b9a\u4e49\uff08\u7f16\u8bd1\u5f00\u5173\uff09\u7684\u5c42\u6b21\u5173\u7cfb\u5728 <code>init/Kconfig</code> \u4e2d\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5728\u7236\u4e00\u7ea7\u5f00\u5173\u4e3a yes \u7684\u6761\u4ef6\u4e0b\uff0c\u624d\u4f1a\u6709\u5b50\u4e00\u7ea7\u7684\u5f00\u5173\u3002 \u4f8b\u5982\uff0c\u8981\u542f\u7528 CFS CPU \u5e26\u5bbd\u63a7\u5236\u529f\u80fd\uff0c\u5c31\u5fc5\u987b\u8981\u6709\uff1a <code>CONFIG_CGROUPS=y &amp;&amp; CONFIG_CGROUP_SCHED=y &amp;&amp; CONFIG_FAIR_GROUP_SCHED=y &amp;&amp; CONFIG_CFS_BANDWIDTH=y</code> \u8fd9\u662f\u672c\u6587\u63a5\u4e0b\u6765\u5c06\u91cd\u70b9\u5173\u6ce8\u7684\u90e8\u5206\uff08<code>1 -&gt; 1.3 -&gt; 1.3.2 -&gt; 1.3.2.1</code>\uff09\u3002</p> <p>\u5404\u5f00\u5173\u7684\u8be6\u7ec6\u89e3\u91ca\uff1a</p> <pre><code>// init/Kconfig\n\nmenuconfig CGROUPS\n    bool \"Control Group support\"\n    help\n      This option adds support for grouping sets of processes together, for\n      use with process control subsystems such as Cpusets, CFS, memory controls or device isolation.\n      See\n        - Documentation/scheduler/sched-design-CFS.rst    (CFS)\n        - Documentation/admin-guide/cgroup-v1/ (features for grouping, isolation and resource control)\n\nif CGROUPS\n    config MEMCG\n        bool \"Memory controller\"\n        select PAGE_COUNTER\n        help\n          Provides control over the memory footprint of tasks in a cgroup.\n    config BLK_CGROUP\n        bool \"IO controller\"\n        depends on BLOCK\n        help\n          Generic block IO controller cgroup interface. This is the common\n          cgroup interface which should be used by various IO controlling policies.\n\n          Currently, CFQ IO scheduler uses it to recognize task groups and\n          control disk bandwidth allocation (proportional time slice allocation)\n          to such task groups. It is also used by bio throttling logic in\n          block layer to implement upper limit in IO rates on a device.\n\n          This option only enables generic Block IO controller infrastructure.\n          One needs to also enable actual IO controlling logic/policy. For\n          enabling proportional weight division of disk bandwidth in CFQ, set\n          CONFIG_BFQ_GROUP_IOSCHED=y; for enabling throttling policy, set\n          CONFIG_BLK_DEV_THROTTLING=y.\n\n          See Documentation/admin-guide/cgroup-v1/blkio-controller.rst for more information.\n\n    menuconfig CGROUP_SCHED\n        bool \"CPU controller\"\n        help\n          This feature lets CPU scheduler recognize task groups and control CPU\n          bandwidth allocation to such task groups. It uses cgroups to group tasks.\n    if CGROUP_SCHED\n        config FAIR_GROUP_SCHED\n            bool \"Group scheduling for SCHED_OTHER\"\n            depends on CGROUP_SCHED\n            default CGROUP_SCHED\n\n            config CFS_BANDWIDTH\n                bool \"CPU bandwidth provisioning for FAIR_GROUP_SCHED\"\n                depends on FAIR_GROUP_SCHED\n                help\n                  This option allows users to define CPU bandwidth rates (limits) for\n                  tasks running within the fair group scheduler.  Groups with no limit\n                  set are considered to be unconstrained and will run with no restriction.\n                  See Documentation/scheduler/sched-bwc.rst for more information.\n        config RT_GROUP_SCHED\n            bool \"Group scheduling for SCHED_RR/FIFO\"\n            depends on CGROUP_SCHED\n            help\n              This feature lets you explicitly allocate real CPU bandwidth\n              to task groups. If enabled, it will also make it impossible to\n              schedule realtime tasks for non-root users until you allocate realtime bandwidth for them.\n              See Documentation/scheduler/sched-rt-group.rst for more information.\n    endif #CGROUP_SCHED\n\n    config CGROUP_PIDS\n        bool \"PIDs controller\"\n    config CPUSETS\n        bool \"Cpuset controller\"\n        help\n          This option will let you create and manage CPUSETs which\n          allow dynamically partitioning a system into sets of CPUs and\n          Memory Nodes and assigning tasks to run only within those sets.\n          This is primarily useful on large SMP or NUMA systems.\n    config CGROUP_DEVICE\n        bool \"Device controller\"\n        help\n          Provides a cgroup controller implementing whitelists for\n          devices which a process in the cgroup can mknod or open.\n    config CGROUP_CPUACCT\n        bool \"Simple CPU accounting controller\"\n        help\n          Provides a simple controller for monitoring the total CPU consumed by the tasks in a cgroup.\nendif # CGROUPS\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#2-cfs","title":"2 CFS \u76f8\u5173\u8bbe\u8ba1","text":""},{"location":"courses/linux-cfs-scheduler/#21","title":"2.1 \u8bbe\u8ba1\u76ee\u6807\u548c\u57fa\u672c\u539f\u7406","text":"<p>CFS \u65e9\u5728 2007 \u5e74\u5c31\u5408\u5e76\u5230 Linux \u5185\u6838\uff08<code>2.6.23</code>\uff09 1\uff0c\u53d6\u4ee3\u4e86\u4e4b\u524d\u8c03\u5ea6\u5668\u4e2d\u7684 SCHED_OTHER \u5b9e\u73b0\u3002 CFS 80% \u7684\u8bbe\u8ba1\u90fd\u53ef\u4ee5\u603b\u7ed3\u4e3a\u4e00\u53e5\u8bdd\uff1a\u5c06\u771f\u5b9e CPU \u5efa\u6a21\u4e3a\u4e00\u4e2a\u201c\u7406\u60f3\u3001\u7cbe\u786e\u7684\u591a\u4efb\u52a1 CPU\u201d\u3002 \u201c\u7406\u60f3\u591a\u4efb\u52a1 CPU\u201d \u638c\u63a7 100% \u7269\u7406\u8d44\u6e90\uff0c\u80fd\u7cbe\u786e\u5730\u4ee5\u76f8\u540c\u901f\u5ea6\u5e76\u884c\u6267\u884c\u591a\u4e2a\u8fdb\u7a0b\uff0c \u6bcf\u4e2a\u4efb\u52a1\u7684\u901f\u5ea6\u90fd\u662f <code>1/nr_running</code>\u3002</p> <p>\u5185\u6838\u4e3a\u6bcf\u4e2a CPU \u7ef4\u62a4\u4e86\u4e00\u4e2a\u53ef\u8fd0\u884c\u8fdb\u7a0b\u7684\u961f\u5217\uff08runqueue\uff09\uff1b CFS \u6709\u4e00\u4e2a\u53ef\u914d\u7f6e\u7684\u8c03\u5ea6\u5468\u671f <code>sched_latency</code>\uff1b\u63a5\u4e0b\u6765\u7684\u57fa\u672c\u8c03\u5ea6\u8fc7\u7a0b\uff1a</p> <ul> <li>CFS \u6839\u636e\u5f53\u524d\u53ef\u8fd0\u884c\u8fdb\u7a0b\u7684\u6570\u91cf N\uff0c\u8ba1\u7b97\u5f97\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u5e94\u8be5\u6267\u884c\u7684\u65f6\u95f4 sched_latency/N\uff1b</li> <li>\u4f9d\u6b21\u53d6\u51fa\u8fdb\u7a0b\u6267\u884c\u4ee5\u4e0a\u8ba1\u7b97\u51fa\u7684\u65f6\u95f4\uff1b</li> <li>\u5982\u679c runqueue \u6709\u53d8\u5316\uff0c\u518d\u91cd\u65b0\u8ba1\u7b97\u53ef\u6267\u884c\u65f6\u95f4\u3002</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#22","title":"2.2 \u6838\u5fc3\u6982\u5ff5","text":""},{"location":"courses/linux-cfs-scheduler/#221-vruntime","title":"2.2.1 <code>vruntime</code>","text":"<p>\u5728\u771f\u5b9e CPU \u4e0a\uff0c\u4efb\u610f\u65f6\u95f4\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2a\u4efb\u52a1\uff1b\u4e3a\u4e86\u5b9e\u73b0\u201c\u516c\u5e73\u201d\uff0cCFS \u5f15\u5165\u4e86 \u201cvirtual runtime\u201d\uff08\u865a\u62df\u8fd0\u884c\u65f6\u95f4\uff09\u7684\u6982\u5ff5\u3002</p> <ul> <li>vruntime \u8868\u793a\u8fdb\u7a0b\u771f\u6b63\u5728 CPU \u4e0a\u6267\u884c\u7684\u65f6\u95f4\uff0c\u4e0d\u5305\u62ec\u4efb\u4f55\u5f62\u5f0f\u7684\u7b49\u5f85\u65f6\u95f4\uff1b</li> <li>\u6ce8\u610f\u673a\u5668\u4e00\u822c\u90fd\u662f\u591a\u6838\u7684\uff0c\u56e0\u6b64 vruntime \u662f\u5728\u591a\u4e2a CPU \u4e0a\u6267\u884c\u65f6\u95f4\u7684\u7d2f\u52a0\u3002</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#222-runqueue","title":"2.2.2 <code>runqueue</code>","text":"<p>\u521a\u624d\u5176\u5b9e\u5df2\u7ecf\u63d0\u5230\u4e86\uff0c\u662f\u6bcf\u4e2a CPU \u4e0a\u7684\u53ef\u8fd0\u884c\u8fdb\u7a0b\u961f\u5217\uff0c\u4e4b\u524d\u5c31\u5df2\u7ecf\u5b58\u5728\uff0c\u5e76\u4e0d\u662f CFS \u5f15\u5165\u7684\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#223","title":"2.2.3 \u57fa\u4e8e\u65f6\u5e8f\u7684\u7ea2\u9ed1\u6811","text":"<p>\u54ea\u4e2a\u8fdb\u7a0b vruntime \u6700\u5c0f\uff0c\u8bf4\u660e\u7d2f\u8ba1\u6267\u884c\u65f6\u95f4\u6700\u5c11\uff0c\u4ece\u201c\u516c\u5e73\u201d\u7684\u89d2\u5ea6\u6765\u8bf4\uff0c\u5c31\u9700\u8981\u6267\u884c\u5b83\u3002</p> <ul> <li>CFS \u7528\u7ea2\u9ed1\u6811\u6765\u7ec4\u7ec7\u8fd9\u4e9b\u8fdb\u7a0b\uff08\u63cf\u8ff0 runqueue\uff09\uff0c\u7528 vruntime \u505a key\uff0c \u6240\u4ee5\u8fd9\u662f\u4e00\u4e2a**\u57fa\u4e8e\u65f6\u5e8f\u7684\u7ea2\u9ed1\u6811**\uff08time-ordered rbtree\uff09\uff0c \u6240\u6709 runnable \u7684\u8fdb\u7a0b\u90fd\u662f\u7528 <code>p-&gt;se.vruntime</code> \u4f5c\u4e3a key \u6765\u6392\u5e8f\u7684\u3002</li> <li>CFS \u6bcf\u6b21\u53d6\u51fa\u6700\u5de6\u8fb9\u7684\u8fdb\u7a0b\uff08\u7ea2\u9ed1\u6811\u7279\u6027\uff09\uff0c\u6267\u884c\u5b8c\u6210\u540e\u63d2\u5165\u8d8a\u6765\u8d8a\u53f3\u8fb9\uff0c\u8fd9\u6837\u6bcf\u4e2a\u4efb\u52a1\u90fd\u6709\u673a\u4f1a\u6210\u4e3a\u6700\u5de6\u8fb9\u7684\u8282\u70b9\uff0c \u5728\u4e00\u6bb5\u786e\u5b9a\u662f\u65f6\u95f4\u5185\u603b\u5f97\u5f97\u5230 CPU \u8d44\u6e90\u3002</li> </ul> <p>\u5b9e\u9645\u4e0a CFS \u8fd8\u7ef4\u62a4\u4e86 min/max vruntime\uff0c</p> <ul> <li>min vruntime \u7528\u9014\uff1a\u65b0\u8fdb\u7a0b\u6216\u91cd\u65b0\u56de\u5230 ready \u72b6\u6001\u7684\u8fdb\u7a0b\uff0c\u7528 vruntime=min_vruntime \u6765\u521d\u59cb\u5316\uff0c\u653e\u5230\u6700\u5de6\u8fb9\uff1b\u8fd9\u5bf9\u9632\u6b62\u8fdb\u7a0b\u9965\u997f\u975e\u5e38\u5173\u952e\uff1b</li> <li>max vruntime \u7528\u9014\uff1a\u9650\u989d\uff1f</li> </ul> <p>\u67e5\u8be2\u590d\u6742\u5ea6\uff1a<code>O(1)</code> \u63d2\u5165\u590d\u6742\u5ea6 <code>O(logN)</code></p>"},{"location":"courses/linux-cfs-scheduler/#23-scheduling-policy","title":"2.3 \u8c03\u5ea6\u7b56\u7565\uff08scheduling policy\uff09","text":""},{"location":"courses/linux-cfs-scheduler/#231","title":"2.3.1 \u5b9e\u65f6\u8fdb\u7a0b\u8c03\u5ea6\u7b56\u7565","text":"<p>\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\u90fd\u653e\u5230\u4e86\u4e00\u4e2a runqueue\uff08\u8fd0\u884c\u961f\u5217\uff09\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u8c03\u5ea6\u5668\u6839\u636e\u8c03\u5ea6\u7b56\u7565\u4ece\u91cc\u9762\u53d6\u51fa\u8fdb\u7a0b\u653e\u5230 CPU \u4e0a\u6267\u884c\u3002 \u6709\u4e24\u79cd\u8c03\u5ea6\u7b56\u7565\uff1aSCHED_RR \u548c SCHED_FIFO\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#sched_fifo","title":"<code>SCHED_FIFO</code>","text":"<p>\u5f88\u7b80\u5355\uff0c\u5148\u8fdb\u5148\u51fa\u3002</p> <p>\u8fdb\u7a0b\u5728\u4e0b\u9762\u7684\u6761\u4ef6\u4e0b\u4f1a\u653e\u5f03 CPU\uff1a</p> <ol> <li>\u8fdb\u7a0b\u5728\u7b49\u5f85\uff0c\u4f8b\u5982 IO \u64cd\u4f5c\u3002\u5f53\u8fdb\u7a0b**\u518d\u56de\u5230 ready \u72b6\u6001\u65f6**\uff0c\u5b83\u4f1a\u88ab\u653e\u5230 runqueue \u961f\u5c3e\u3002</li> <li>\u8fdb\u7a0b\u901a\u8fc7 <code>sched_yield</code> yield\uff08\u4e3b\u52a8\u8ba9\u51fa\uff09 CPU\u3002\u8fdb\u7a0b**\u7acb\u5373**\u8fdb\u5165 runqueue \u961f\u5c3e\u3002</li> </ol>"},{"location":"courses/linux-cfs-scheduler/#sched_rr","title":"<code>SCHED_RR</code>","text":"<p>\u5728\u8fd9\u79cd\u8c03\u5ea6\u7b56\u7565\u4e2d\uff0crunqueue \u4e2d\u7684\u6bcf\u4e2a\u8fdb\u7a0b\u8f6e\u6d41\u83b7\u5f97\u65f6\u95f4\u7247\uff08quantum\uff09\u3002</p> <p>\u8c03\u5ea6\u7b56\u7565\uff1a\u5f71\u54cd\u7684\u662f runqueue \u5982\u4f55\u5de5\u4f5c\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u80fd\u83b7\u5f97\u591a\u5c11\u6267\u884c\u65f6\u95f4\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#232","title":"2.3.2 \u5e38\u89c4\u8fdb\u7a0b\u8c03\u5ea6\u7b56\u7565","text":"<p>CFS \u5b9e\u73b0\u4e86\u4e09\u79cd\u8c03\u5ea6\u7b56\u7565\uff1a</p>"},{"location":"courses/linux-cfs-scheduler/#sched_normal","title":"<code>SCHED_NORMAL</code>","text":"<p>\u5386\u53f2\u4e0a\u53eb <code>SCHED_OTHER</code>\uff0c\u9002\u7528\u4e8e\u666e\u901a\u4efb\u52a1\u7684\u8c03\u5ea6\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#sched_batch","title":"<code>SCHED_BATCH</code>","text":"<p>\u9002\u5408\u6279\u91cf\u4efb\u52a1\u3002\u4e0d\u50cf\u666e\u901a\u4efb\u52a1\u90a3\u6837\u5bb9\u6613\u88ab\u62a2\u5360\uff0c\u56e0\u6b64\u6bcf\u4e2a\u4efb\u52a1\u8fd0\u884c\u7684\u65f6\u95f4\u53ef\u4ee5\u66f4\u957f\uff0c\u7f13\u5b58\u6548\u7387\u66f4\u9ad8\uff0c\u4f46\u4ea4\u4e92\u6027\u53d8\u5dee\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#sched_idle","title":"<code>SCHED_IDLE</code>","text":"<p>This is even weaker than nice 19, but its not a true idle timer scheduler in order to avoid to get into priority inversion problems which would deadlock the machine.</p>"},{"location":"courses/linux-cfs-scheduler/#233-sched_normal-sched_rr","title":"2.3.3 \u5e38\u89c4\u8fdb\u7a0b <code>SCHED_NORMAL</code> \u548c\u5b9e\u65f6\u8fdb\u7a0b <code>SCHED_RR</code> \u8c03\u5ea6\u7b56\u7565\u7684\u533a\u522b","text":"<p>\u4e8c\u8005\u90fd\u662f\u6309\u8fdb\u7a0b\u516c\u5e73\u5206\u914d CPU\uff0c\u8ba1\u7b97\u597d\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u65f6\u95f4\uff08\u65f6\u957f\u90fd\u4e00\u6837\uff09\uff0c\u7136\u540e\u4f9d\u6b21\u53d6\u51fa\u8fdb\u7a0b\u6267\u884c\uff0c \u542c\u8d77\u6765\u6709\u70b9\u50cf\uff0c\u4f46\u4e0d\u4e00\u6837\uff1a</p> <p>SCHED_RRSCHED_NORMAL\u8c03\u5ea6\u7684\u8fdb\u7a0b\u7c7b\u578b\u5b9e\u65f6\u8fdb\u7a0b\u666e\u901a\u8fdb\u7a0b\u65f6\u95f4\u7247\u9759\u6001\uff0c\u4e0d\u4f9d\u8d56\u7cfb\u7edf\u4e2d\u7684\u8fdb\u7a0b\u6570\u91cf\u52a8\u6001\uff0c\u6839\u636e\u7cfb\u7edf\u4e2d\u8fdb\u7a0b\u7684\u6570\u91cf\u4f1a\u53d1\u751f\u53d8\u5316\u4e0b\u4e00\u4e2a\u8fdb\u7a0b\u7684\u9009\u62e9\u4ece runqueue \u4e2d\u6309 RR \u9009\u4e0b\u4e00\u4e2a\u4ece\u7ea2\u9ed1\u6811\u4e2d\u9009 vruntime \u6700\u5c0f\u7684\u4e00\u4e2a</p>"},{"location":"courses/linux-cfs-scheduler/#234","title":"2.3.4 \u67e5\u770b\u6216\u4fee\u6539\u8fdb\u7a0b\u7684\u8c03\u5ea6\u5c5e\u6027","text":"<p><code>chrt</code> \u53ef**\u67e5\u770b\u6216\u4fee\u6539\u8fdb\u7a0b\u7684\u8c03\u5ea6\u5c5e\u6027**\uff1a</p> <pre><code>$ chrt --help\nShow or change the real-time scheduling attributes of a process.\n...\n</code></pre> <p>\u67e5\u770b\u8c03\u5ea6\u5c5e\u6027\uff1a</p> <pre><code>$ chrt -p 219027\npid 219027's current scheduling policy: SCHED_OTHER\npid 219027's current scheduling priority: 0\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#24-scheduling-class","title":"2.4 \u8c03\u5ea6\u7c7b\uff08scheduling class\uff09","text":"<p>CFS \u5f15\u5165\u4e86 \u201cScheduling Class\u201d \u6982\u5ff5\uff0c\u5c06\u8c03\u5ea6\u7b56\u7565\u5c01\u88c5\u5230\u4e00\u4e2a\u8c03\u5ea6\u7c7b\u578b\uff0c\u4f7f\u5f97 CFS \u8c03\u5ea6\u5668\u6838\u5fc3\u4ee3\u7801\u4e0d\u7528\u5904\u7406\u8c03\u5ea6\u7b56\u7565\u7ec6\u8282\u3002</p> <p>\u8fd9\u4e9b\u8c03\u5ea6\u7c7b\u7ec4\u6210\u4e00\u4e2a\u53ef\u6269\u5c55\u7684\u8c03\u5ea6\u6a21\u5757\u5c42\u7ea7\uff08an extensible hierarchy of scheduler modules\uff09\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#25-group-scheduler-extensions","title":"2.5 \u8fdb\u7a0b\u7ec4\u8c03\u5ea6\u5668\u6269\u5c55\uff08group scheduler extensions\uff09","text":"<p><code>CONFIG_FAIR_GROUP_SCHED</code> \u542f\u7528\u540e\uff0c\u4f1a\u4e3a\u6bcf\u4e2a task group \u5728\u5bf9\u5e94\u7684 cgroup \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>cpu.shares</code> \u7684\u6587\u4ef6\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#26-cfs","title":"2.6 CFS \u914d\u7f6e\u9879","text":"<p>CFS \u7684\u65f6\u95f4\u7c92\u5ea6\u662f <code>ns</code>\uff0c\u5e76\u4e0d\u4f9d\u8d56\u4efb\u4f55 jiffies \u6216 HZ \u4fe1\u606f\u3002 \u6709\u4e00\u4e2a\u53ef\u8c03\u4f18\u7684\u914d\u7f6e\uff0c\uff08\u9700\u8981\u5728\u7f16\u8bd1\u5185\u6838\u65f6\u6253\u5f00 CONFIG_SCHED_DEBUG\uff09\uff1a</p> <ul> <li>kernel <code>&lt; 5.15</code>: <code>/proc/sys/kernel/sched_min_granularity_ns</code></li> <li>kernel <code>&gt;= 5.15</code>: <code>/sys/kernel/debug/sched/min_granularity_ns</code></li> </ul> <p>\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u8fd9\u4e2a\u53c2\u6570\u6765\u8ba9\u8c03\u5ea6\u5668\u4ece \u201cdesktop\u201d\uff08\u4f4e\u5ef6\u8fdf\uff09\u5230\u201cserver\u201d\uff08\u9ad8\u5e76\u53d1\uff09workloads\u3002 \u9ed8\u8ba4\u914d\u7f6e\u9002\u5408\u7684\u662f desktop workloads\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#_1","title":"\u4f8b\u5b50","text":"<p>\u4e0b\u9762\u662f\u4e2a\u4f8b\u5b50\uff0c\u521b\u5efa\u8fdb\u7a0b\u7ec4\uff0c\u901a\u8fc7 cgroup \u6587\u4ef6\u7cfb\u7edf\u8bbe\u7f6e CPU shares\uff0c</p> <pre><code># 1. \u6302\u8f7d cgroup \u6587\u4ef6\u7cfb\u7edf\n$ mount -t tmpfs cgroup_root /sys/fs/cgroup\n$ mkdir /sys/fs/cgroup/cpu                       # \u521b\u5efa cpu \u76ee\u5f55\uff0c\u7528\u4e8e\u63a7\u5236 cpu \u8d44\u6e90\u4efd\u989d\n$ mount -t cgroup -ocpu none /sys/fs/cgroup/cpu\n$ cd /sys/fs/cgroup/cpu\n\n# 2. \u521b\u5efa\u8fdb\u7a0b\u7ec4\u5bf9\u5e94\u7684 cgroup \u76ee\u5f55\n$ mkdir multimedia     # create \"multimedia\" group of tasks\n$ mkdir browser        # create \"browser\" group of tasks\n\n# 3. \u8bbe\u7f6e\u8fdb\u7a0b\u7ec4\u7684 CPU \u4efd\u989d\uff1a multimedia \u53ef\u4ee5\u6bd4 browser \u591a\u7528\u4e00\u500d\n$ echo 2048 &gt; multimedia/cpu.shares\n$ echo 1024 &gt; browser/cpu.shares\n\n# 4. \u542f\u52a8\u6d4f\u89c8\u5668\u8fdb\u7a0b firefox \u5e76\u653e\u5230 \"browser\" \u8fdb\u7a0b\u7ec4\n$ firefox &amp;\n$ echo &lt;firefox_pid&gt; &gt; browser/tasks\n\n# \u542f\u52a8\u591a\u5a92\u4f53\u8fdb\u7a0b gmplayer \u5e76\u653e\u5230 \"multimedia\" \u8fdb\u7a0b\u7ec4\n$ gmplayer &amp;\n$ echo &lt;movie_player_pid&gt; &gt; multimedia/tasks\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#27-cpu-config_cfs_bandwidth","title":"2.7 CPU \u5e26\u5bbd\u63a7\u5236\u8bbe\u8ba1\uff08<code>CONFIG_CFS_BANDWIDTH</code>\uff09","text":""},{"location":"courses/linux-cfs-scheduler/#_2","title":"\u65b0\u914d\u7f6e\u9879","text":"<p>\u7ed9 cpu cgroup \u5f15\u5165\u4e86\u4e24\u4e2a\u65b0\u914d\u7f6e\u9879\uff1a</p> <ul> <li><code>cpu.cfs_period_us</code>: \u5468\u671f\uff08period\uff09\uff0c\u6bcf\u4e2a\u5468\u671f\u5355\u72ec\u8ba1\u7b97\uff0c\u5468\u671f\u7ed3\u675f\u4e4b\u540e\u72b6\u6001\uff08quota \u7b49\uff09\u6e05\u96f6\uff1b\u9ed8\u8ba4 100ms</li> <li><code>cpu.cfs_quota_us</code>: \u5728\u4e00\u4e2a\u5468\u671f\u91cc\u7684\u4efd\u989d\uff08quota\uff09\uff0c\u9ed8\u8ba4 5ms\u3002</li> </ul> <p>\u6700\u5927 1s\uff0c\u6700\u5c0f 1ms\uff1a</p> <pre><code> const u64 max_cfs_quota_period = 1 * NSEC_PER_SEC; /* 1s */\nconst u64 min_cfs_quota_period = 1 * NSEC_PER_MSEC; /* 1ms */\n</code></pre> <p>\u6b64\u5916\u8fd8\u6709\u4e00\u4e2a\u7edf\u8ba1\u8f93\u51fa\uff1a</p> <ul> <li><code>cpu.stat</code>\uff1a\u8f93\u51fa throttling statistics</li> </ul> <p>\u540e\u6765\u8fd8\u5f15\u5165\u4e86\u4e00\u4e2a\u4f18\u5316\u9879\uff1a</p> <ul> <li>cpu.cfs_burst_us: the maximum accumulated run-time\u3002\u4e0a\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u7528\u5b8c\u7684\u4efd\u989d\uff0c\u53ef\u4ee5\u7ed9\u4e0b\u4e00\u4e2a CPU \u7528\u3002</li> </ul> <p>\u9ed8\u8ba4\u503c\uff1a</p> <pre><code>cpu.cfs_period_us=100ms\ncpu.cfs_quota_us=-1\ncpu.cfs_burst_us=0  # 5.15+\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#k8s-pod-cpu-throttle","title":"\u67e5\u770b k8s pod \u7684 CPU throttle \u7edf\u8ba1","text":"<p>\u5728\u4e00\u4e2a k8s node \u4e0a\u67e5\u770b\u67d0\u4e2a pod \u7684 CPU throttle \u7edf\u8ba1\uff1a</p> <pre><code>$ cat /sys/fs/cgroup/cpu/kubepods/pod&lt;pod_id&gt;/cpu.stat\nnr_periods 1312889\nnr_throttled 100714\nthrottled_time 22081774986248\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#_3","title":"\u66f4\u591a\u8bbe\u8ba1\u7ec6\u8282","text":"<p>The skeleton of our approach is as follows:</p> <ul> <li>We maintain a global pool (per-tg) pool of unassigned quota. Within it we track the bandwidth period, quota per period, and runtime remaining in the current period. As bandwidth is used within a period it is decremented from runtime. Runtime is currently synchronized using a spinlock, in the current implementation there\u2019s no reason this couldn\u2019t be done using atomic ops instead however the spinlock allows for a little more flexibility in experimentation with other schemes.</li> <li>When a cfs_rq participating in a bandwidth constrained task_group executes it acquires time in sysctl_sched_cfs_bandwidth_slice (default currently 10ms) size chunks from the global pool, this synchronizes under rq-&gt;lock and is part of the update_curr path.</li> <li>Throttled entities are dequeued, we protect against their re-introduction to the scheduling hierarchy via checking for a, per cfs_rq, throttled bit.</li> </ul> <p>After received a slice, sched_entities in cfs_rq would start running, and keep applying after every slice is used up. If there are no more slices, which means the cfs_rq used up all the allowable quota in this period, it will be throttled, at the meanwhile tasks couldn\u2019t run anymore. The throttling statistics could be checked with Cgroup cpu.stat. After this period, global quota pool will be refreshed and cfs_rq get out of throttled state, tasks continue running.</p>"},{"location":"courses/linux-cfs-scheduler/#29","title":"2.9 \u95ee\u9898","text":""},{"location":"courses/linux-cfs-scheduler/#cpu-throttle","title":"CPU throttle \u662f\u600e\u4e48\u6765\u7684","text":"<p>\u591a\u6838\u60c5\u51b5\u4e0b\uff1a\u53ef\u4ee5\u5728\u4e00\u4e2a\u6838\u4e0a\u8fd0\u884c\u5f88\u957f\u65f6\u95f4\uff0c\u4e5f\u53ef\u4ee5\u5728\u591a\u4e2a\u6838\u4e0a\u8fd0\u884c\u5f88\u77ed\u65f6\u95f4\u3002 \u540e\u4e00\u79cd\u60c5\u51b5\u4f1a\u5bfc\u81f4\u8fdb\u7a0b\u5728\u5f88\u77ed\u7684\u65f6\u95f4\u5185\u7528\u5b8c\u4e86\u5168\u90e8 quota\uff0c\u5728\u8c03\u5ea6\u5468\u671f\u5185\u5269\u4e0b\u7684\u65f6\u95f4\u91cc\uff0c\u53ea\u80fd\u7b49\u5f85\u3002\u8fd9\u5c31\u662f throttle\uff08\u5173\u95ed\u9600\u95e8\uff0c\u8282\u6d41\uff09\u3002</p> <p>\u5178\u578b\u573a\u666f\uff1a\u591a\u6838\uff0c\u591a\u7ebf\u7a0b\uff08\u4f8b\u5982\u7ebf\u7a0b\u6c60\uff09\u8fdb\u7a0b\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#_4","title":"\u4e0a\u4e0b\u6587\u5207\u6362\u5f00\u9500","text":"<p>\u8fc7\u8f7d\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u80fd\u5206\u5230\u7684\u65f6\u95f4\u7247\u5f88\u77ed\uff0c\u4f8b\u5982 1ms\uff0c\u5bfc\u81f4\u5927\u90e8\u5206 CPU \u5f00\u9500\u90fd\u82b1\u5728\u4e86\u4e0a\u4e0b\u6587\u5207\u6362\u4e0a\u3002</p> <p>\u4e0a\u4e0b\u6587\u5207\u6362\u505a\u7684\u4e8b\u60c5\uff1a</p> <ol> <li>\u4fdd\u5b58\u5f53\u524d\u8fdb\u7a0b\u6216\u7ebf\u7a0b\u7684\u72b6\u6001\uff1b</li> <li>\u6062\u590d\u4e0b\u4e00\u4e2a\u8fdb\u7a0b\u6216\u7ebf\u7a0b\u7684\u72b6\u6001\uff1b</li> <li>\u6267\u884c\u540e\u4e00\u4e2a\u8fdb\u7a0b\u3002</li> </ol> <p>\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u7247\u662f 6ms\uff0c\u5207\u6362\u5360 1ms\uff0c\u90a3\u6211\u4eec\u8fd8\u67095ms \u53ef\u4ee5\u6267\u884c\uff1b \u5982\u679c 1.5ms\uff0c\u90a3\u53ea\u6709 0.5ms \u53ef\u4ee5\u6267\u884c\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0c\u5f15\u5165 <code>min_granularity</code>\uff1b\u53cd\u8fc7\u6765\uff0c\u8fd9\u4e5f\u4f1a\u5f71\u54cd sched_latency \u7684\u9009\u53d6\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#3","title":"3 \u5185\u6838\u5b9e\u73b0","text":"<p>SCHED_FIFO/_RR are implemented in sched/rt.c and are as specified by POSIX.</p> <p>sched/rt.c implements SCHED_FIFO and SCHED_RR semantics. It uses 100 runqueues (for all 100 RT priority levels, instead of 140 in the previous scheduler) and it needs no expired array.</p>"},{"location":"courses/linux-cfs-scheduler/#31-cfs","title":"3.1 CFS \u7b2c\u4e00\u7248\u5b9e\u73b0","text":"<p>\u89c1 1\uff0c\u4ee3\u7801\u4e0d\u592a\u591a\u3002\u60f3\u5feb\u901f\u4e86\u89e3\u6574\u4f53\u5b9e\u73b0\u7684\u53ef\u4ee5\u6d4f\u89c8\u4e00\u4e0b\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#32","title":"3.2 \u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<p>\u63a5\u4e0b\u6765\u7684\u90e8\u5206\u90fd\u662f\u53c2\u8003 5.10 \u4ee3\u7801\u3002</p> <p>\u4ecb\u7ecd\u51e0\u4e2a\u6838\u5fc3\u7684\u6570\u636e\u7ed3\u6784\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#321-struct-task_struct","title":"3.2.1 <code>struct task_struct</code>","text":"<p>\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u7ed3\u6784\u4f53\u8868\u793a\u662f <code>struct task</code>\uff0c</p> <pre><code>// include/linux/sched.h\n\nstruct task_struct {\n    struct thread_info        thread_info;\n    volatile long            state; /* -1 unrunnable, 0 runnable, &gt;0 stopped: */\n\n    void                  *stack;\n    refcount_t             usage;\n    unsigned int           flags; /* Per task flags (PF_*), defined further below: */\n    unsigned int           ptrace;\n\n    int                on_cpu;\n    struct __call_single_node    wake_entry;\n    unsigned int            cpu; /* Current CPU: */\n    unsigned int            wakee_flips;\n    unsigned long           wakee_flip_decay_ts;\n    struct task_struct     *last_wakee;\n\n    int                recent_used_cpu;\n    int                wake_cpu;\n    int                on_rq;\n\n    int                prio;\n    int                static_prio;\n    int                normal_prio;\n\n    const struct sched_class    *sched_class;\n    struct sched_entity          se;             // schedule entity, including vruntime\n#ifdef CONFIG_CGROUP_SCHED\n    struct task_group           *sched_task_group;\n#endif\n    ...\n};\n</code></pre> <p>\u5176\u4e2d\u6709\u4e2a\u8c03\u5ea6\u76f8\u5173\u7684\u5b57\u6bb5\u662f <code>struct sched_entity se</code>\u3002\u53ef\u4ee5\u662f\u4e00\u4e2a\u8fdb\u7a0b\u3001\u4e00\u4e2a\u8fdb\u7a0b\u7ec4\u6216\u4e00\u4e2a\u7528\u6237\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#322-struct-task_group","title":"3.2.2 <code>struct task_group</code>","text":"<p>\u540c\u7406\uff0c\u8fdb\u7a0b\u7ec4\u4e2d\u4e5f\u6709\u4e00\u4e2a <code>struct sched_entity se</code> \u5b57\u6bb5\uff1a</p> <pre><code>// https://github.com/torvalds/linux/blob/v5.10/kernel/sched/sched.h#L383\n\n/* Task group related information */\nstruct task_group {\n    struct cgroup_subsys_state css;\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    struct sched_entity  **se; /* schedulable entities of this group on each CPU */\n    struct cfs_rq        **cfs_rq; /* runqueue \"owned\" by this group on each CPU */\n    unsigned long          shares;\n\n    atomic_long_t        load_avg ____cacheline_aligned;\n#endif\n\n#ifdef CONFIG_RT_GROUP_SCHED\n    struct sched_rt_entity    **rt_se;\n    struct rt_rq        **rt_rq;\n\n    struct rt_bandwidth    rt_bandwidth;\n#endif\n\n    struct rcu_head        rcu;\n    struct list_head    list;\n\n    struct task_group    *parent;\n    struct list_head    siblings;\n    struct list_head    children;\n\n#ifdef CONFIG_SCHED_AUTOGROUP\n    struct autogroup    *autogroup;\n#endif\n\n    struct cfs_bandwidth    cfs_bandwidth;\n\n#ifdef CONFIG_UCLAMP_TASK_GROUP\n    /* The two decimal precision [%] value requested from user-space */\n    unsigned int        uclamp_pct[UCLAMP_CNT];\n    /* Clamp values requested for a task group */\n    struct uclamp_se    uclamp_req[UCLAMP_CNT];\n    /* Effective clamp values used for a task group */\n    struct uclamp_se    uclamp[UCLAMP_CNT];\n#endif\n\n};\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#323-struct-sched_entity","title":"3.2.3 <code>struct sched_entity</code>","text":"<p>scheduling entities \u901a\u8fc7\u4e00\u4e2a\u7ea2\u9ed1\u6811\u7ec4\u7ec7\u5230\u4e00\u8d77\uff0c\u6839\u636e <code>vruntime</code> \u6392\u5e8f\uff0c\u901a\u8fc7 <code>cfs_rq</code> \u6765\u7ba1\u7406.</p> <p>\u6240\u4ee5 virtual runtime\uff08<code>vruntime</code>\uff09\u5c31\u5b9a\u4e49\u5728\u8fd9\u4e2a\u7ed3\u6784\u4f53\u91cc\u9762\uff0c\u5355\u4f4d\u662f <code>ns</code>\uff0c</p> <pre><code>// https://github.com/torvalds/linux/blob/v5.10/include/linux/sched.h#L451\n\nstruct sched_entity {\n    struct load_weight      load; // For load-balancing\n    struct rb_node          run_node;\n    struct list_head        group_node;\n    unsigned int            on_rq;\n\n    u64                exec_start;\n    u64                sum_exec_runtime;\n    u64                vruntime;              // unit: ns\n    u64                prev_sum_exec_runtime;\n\n    u64                nr_migrations;\n\n    struct sched_statistics        statistics;\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    int                   depth;\n    struct sched_entity  *parent;\n    struct cfs_rq        *cfs_rq; // rq on which this entity is (to be) queued\n    struct cfs_rq        *my_q;   // rq \"owned\" by this entity/group\n    unsigned long         runnable_weight; /* cached value of my_q-&gt;h_nr_running */\n#endif\n\n    // Per entity load average tracking.\n    // Put into separate cache line so it does not collide with read-mostly values above.\n    struct sched_avg        avg;\n};\n</code></pre> <p>\u6709\u4e86\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5c31\u80fd\u7cbe\u786e\u5730\u901a\u8fc7\u65f6\u95f4\u6233\u6765\u4fdd\u8bc1\u4e00\u4e2a\u4efb\u52a1\u5e94\u8be5\u83b7\u5f97\u7684 \u201cexpected CPU time\u201d\u3002</p> <p>\u524d\u9762\u5df2\u7ecf\u63d0\u5230\uff0cCFS \u5c31\u662f\u57fa\u4e8e <code>p-&gt;se.vruntime</code> \u6765\u9009\u62e9\uff08\u8c03\u5ea6\uff09\u8fdb\u7a0b\u7684\uff0c\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff1a \u6c38\u8fdc\u9009\u62e9 <code>p-&gt;se.vruntime</code> \u6700\u5c0f\uff08\u8bf4\u660e\u8fd9\u4e2a\u8fdb\u7a0b\u5230\u76ee\u524d\u4e3a\u6b62\u7d2f\u79ef\u6267\u884c\u7684\u65f6\u95f4\u6700\u5c11\uff09\u7684\u8fdb\u7a0b\u6765\u8fd0\u884c\u3002 CFS \u4f1a\u4e0d\u65ad\u5c1d\u8bd5\u5747\u8861\u5404\u8fdb\u7a0b\u7684 CPU \u65f6\u95f4\uff0c\u5c3d\u91cf\u63a5\u8fd1\u201c\u7406\u60f3\u591a\u4efb\u52a1 CPU\u201d\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#324-struct-cfs_rq","title":"3.2.4 <code>struct cfs_rq</code>","text":"<pre><code>// https://github.com/torvalds/linux/blob/v5.10/kernel/sched/sched.h#L518\n\n/* CFS-related fields in a runqueue (rq) */\nstruct cfs_rq {\n    struct load_weight    load;\n    unsigned int        nr_running;\n    unsigned int        h_nr_running;      /* SCHED_{NORMAL,BATCH,IDLE} */\n    unsigned int        idle_h_nr_running; /* SCHED_IDLE */\n\n    u64            exec_clock;\n    u64            min_vruntime;\n    u64            min_vruntime_copy;\n\n    struct rb_root_cached    tasks_timeline; // rbtree\n\n    /*\n     * 'curr' points to currently running entity on this cfs_rq.\n     * It is set to NULL otherwise (i.e when none are currently running).\n     */\n    struct sched_entity    *curr;\n    struct sched_entity    *next;\n    struct sched_entity    *last;\n    struct sched_entity    *skip;\n\n    /*\n     * CFS load tracking\n     */\n    struct sched_avg    avg;\n#ifndef CONFIG_64BIT\n    u64            load_last_update_time_copy;\n#endif\n    struct {\n        raw_spinlock_t    lock ____cacheline_aligned;\n        int        nr;\n        unsigned long    load_avg;\n        unsigned long    util_avg;\n        unsigned long    runnable_avg;\n    } removed;\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    unsigned long        tg_load_avg_contrib;\n    long            propagate;\n    long            prop_runnable_sum;\n\n    /*\n     *   h_load = weight * f(tg)\n     *\n     * Where f(tg) is the recursive weight fraction assigned to\n     * this group.\n     */\n    unsigned long        h_load;\n    u64            last_h_load_update;\n    struct sched_entity    *h_load_next;\n#endif /* CONFIG_FAIR_GROUP_SCHED */\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    //  the main per-CPU runqueue structure, which cfs_rq would attached to\n    struct rq        *rq;    /* CPU runqueue to which this cfs_rq is attached */\n\n    /*\n     * leaf cfs_rqs are those that hold tasks (lowest schedulable entity in\n     * a hierarchy). Non-leaf lrqs hold other higher schedulable entities\n     * (like users, containers etc.)\n     *\n     * leaf_cfs_rq_list ties together list of leaf cfs_rq's in a CPU.\n     * This list is used during load balance.\n     */\n    int            on_list;\n    struct list_head    leaf_cfs_rq_list;\n    struct task_group    *tg;    /* group that \"owns\" this runqueue */\n\n#ifdef CONFIG_CFS_BANDWIDTH\n    int            runtime_enabled;\n    s64            runtime_remaining;\n\n    u64            throttled_clock;\n    u64            throttled_clock_task;\n    u64            throttled_clock_task_time;\n    int            throttled;\n    int            throttle_count;\n    struct list_head    throttled_list;\n#endif /* CONFIG_CFS_BANDWIDTH */\n#endif /* CONFIG_FAIR_GROUP_SCHED */\n};\n</code></pre> <p>\u5176\u4e2d\u7684 CFS \u7ea2\u9ed1\u6811\uff1a</p> <pre><code>// include/linux/rbtree.h\n\n// Leftmost-cached rbtrees.\nstruct rb_root_cached {\n    struct rb_root  rb_root;\n    struct rb_node *rb_leftmost;\n};\n</code></pre> <p>\u5728 cfs_rq \u4e2d\u58f0\u660e\u4e86\u8fd9\u4e2a rbtree \u53d8\u91cf\uff1a</p> <p>CFS \u7ef4\u62a4\u4e86 <code>rq-&gt;cfs.min_vruntime</code> \u503c\uff0c\u8fd9\u662f\u4e00\u4e2a\u5355\u8c03\u9012\u589e\u503c\uff0c\u8ddf\u8e2a runqueue \u6240\u6709\u8fdb\u7a0b\u4e2d\u6700\u5c0f\u7684 vruntime\u3002</p> <ul> <li>\u7cfb\u7edf\u5b8c\u6210\u7684\u603b work \u91cf\u7528 <code>min_vruntime</code> \u8868\u793a\uff0c\u65b0\u6fc0\u6d3b\u7684\u8fdb\u7a0b\uff0c\u4f1a\u7528\u8fd9\u4e2a\u503c\u6765\u521d\u59cb\u5316\uff0c\u653e\u5230 rbtree \u5c3d\u91cf\u6700\u5de6\u8fb9\uff1b</li> <li>runqueue \u4e2d\u7684\u603b running \u8fdb\u7a0b\u6570\u91cf\u7528 <code>rq-&gt;cfs.load</code> \u8868\u793a\uff0c\u662f runqueue \u4e2d\u6240\u6709\u8fdb\u7a0b\u7684 weights \u603b\u548c\uff1b</li> </ul> <p>\u603b\u7ed3\u4e00\u4e0b CFS \u7684\u5de5\u4f5c\u539f\u7406\uff1a</p> <ul> <li>runs a task a bit, \u5f53\u8fdb\u7a0b\u88ab\u8c03\u5ea6\uff08\u6216 scheduler tick \u5230\u6765\u65f6\uff09\uff0c\u66f4\u65b0\u8fd9\u4e2a\u8fdb\u7a0b\u7684 CPU usage\uff1a \u8fd9\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684\u7269\u7406 CPU \u65f6\u95f4\u4f1a\u7d2f\u52a0\u5230 <code>p-&gt;se.vruntime</code>\uff1b</li> <li>\u5f53 <code>p-&gt;se.vruntime</code> \uff08\u52a0\u4e0a\u4e00\u4e2a\u5f88\u5c0f\u7684\u201dgranularity\u201d distance\uff0c\u4ee5\u907f\u514d\u8fc7\u5ea6\u8c03\u5ea6\u8fdb\u7a0b\uff0ctrash the cache\uff09\u5927\u5230\u5df2\u7ecf\u4e0d\u662f\u6700\u5de6\u4fa7\u8282\u70b9\u65f6\uff0c \u65b0\u7684\u6700\u5de6\u4fa7\u8282\u70b9\u5c31\u4f1a\u88ab\u9009\u4e2d\uff0c\u5f53\u524d\u8fdb\u7a0b\u88ab\u5f3a\u5360\uff08current task is preempted\uff09\u3002</li> </ul>"},{"location":"courses/linux-cfs-scheduler/#325-struct-sched_class","title":"3.2.5 <code>struct sched_class</code>","text":"<p>Scheduling class \u662f\u901a\u8fc7 <code>struct sched_class</code> \u5b9e\u73b0\u7684\uff0c</p> <pre><code>// kernel/sched/sched.h\n\nstruct sched_class {\n    int uclamp_enabled;\n\n    void (*enqueue_task) (struct rq *rq, struct task_struct *p, int flags);\n    void (*dequeue_task) (struct rq *rq, struct task_struct *p, int flags);\n    void (*yield_task)   (struct rq *rq);\n    bool (*yield_to_task)(struct rq *rq, struct task_struct *p);\n\n    void (*check_preempt_curr)(struct rq *rq, struct task_struct *p, int flags);\n\n    struct task_struct *(*pick_next_task)(struct rq *rq);\n\n    void (*put_prev_task)(struct rq *rq, struct task_struct *p);\n    void (*set_next_task)(struct rq *rq, struct task_struct *p, bool first);\n\n    int (*balance)(struct rq *rq, struct task_struct *prev, struct rq_flags *rf);\n    int  (*select_task_rq)(struct task_struct *p, int task_cpu, int sd_flag, int flags);\n    void (*migrate_task_rq)(struct task_struct *p, int new_cpu);\n\n    void (*task_woken)(struct rq *this_rq, struct task_struct *task);\n\n    void (*set_cpus_allowed)(struct task_struct *p, const struct cpumask *newmask);\n\n    void (*rq_online)(struct rq *rq);\n    void (*rq_offline)(struct rq *rq);\n\n    void (*task_tick)(struct rq *rq, struct task_struct *p, int queued);\n    void (*task_fork)(struct task_struct *p);\n    void (*task_dead)(struct task_struct *p);\n\n    /*\n     * The switched_from() call is allowed to drop rq-&gt;lock, therefore we\n     * cannot assume the switched_from/switched_to pair is serliazed by\n     * rq-&gt;lock. They are however serialized by p-&gt;pi_lock.\n     */\n    void (*switched_from)(struct rq *this_rq, struct task_struct *task);\n    void (*switched_to)  (struct rq *this_rq, struct task_struct *task);\n    void (*prio_changed) (struct rq *this_rq, struct task_struct *task, int oldprio);\n\n    unsigned int (*get_rr_interval)(struct rq *rq, struct task_struct *task);\n\n    void (*update_curr)(struct rq *rq);\n\n#define TASK_SET_GROUP        0\n#define TASK_MOVE_GROUP        1\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    void (*task_change_group)(struct task_struct *p, int type);\n#endif\n} __aligned(STRUCT_ALIGNMENT); /* STRUCT_ALIGN(), vmlinux.lds.h */\n</code></pre> <p>\u521d\u59cb\u5316\uff1a</p> <pre><code>// kernel/sched/fair.c\n\n/*\n * All the scheduling class methods:\n */\nconst struct sched_class fair_sched_class\n    __section(\"__fair_sched_class\") = {\n    .enqueue_task        = enqueue_task_fair,\n    .dequeue_task        = dequeue_task_fair,\n    .yield_task        = yield_task_fair,\n    .yield_to_task        = yield_to_task_fair,\n\n    .check_preempt_curr    = check_preempt_wakeup,\n\n    .pick_next_task        = __pick_next_task_fair,\n    .put_prev_task        = put_prev_task_fair,\n    .set_next_task          = set_next_task_fair,\n\n#ifdef CONFIG_SMP\n    .balance        = balance_fair,\n    .select_task_rq        = select_task_rq_fair,\n    .migrate_task_rq    = migrate_task_rq_fair,\n\n    .rq_online        = rq_online_fair,\n    .rq_offline        = rq_offline_fair,\n\n    .task_dead        = task_dead_fair,\n    .set_cpus_allowed    = set_cpus_allowed_common,\n#endif\n\n    .task_tick        = task_tick_fair,\n    .task_fork        = task_fork_fair,\n\n    .prio_changed        = prio_changed_fair,\n    .switched_from        = switched_from_fair,\n    .switched_to        = switched_to_fair,\n\n    .get_rr_interval    = get_rr_interval_fair,\n\n    .update_curr        = update_curr_fair,\n\n#ifdef CONFIG_FAIR_GROUP_SCHED\n    .task_change_group    = task_change_group_fair,\n#endif\n\n#ifdef CONFIG_UCLAMP_TASK\n    .uclamp_enabled        = 1,\n#endif\n};\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#33-cfs-cpu","title":"3.3 CFS CPU \u5e26\u5bbd\u63a7\u5236\u5b9e\u73b0","text":"<p>\u5185\u6838\u6587\u6863\uff1aCFS bandwidth control\u3002</p> <pre><code>$ cat /proc/sys/kernel/sched_cfs_bandwidth_slice_us\n5000\n\n$ sysctl -a | grep cfs_\nkernel.sched_cfs_bandwidth_slice_us = 5000\n</code></pre> <p>\u7b2c\u4e00\u7248\u5b9e\u73b0\uff1a https://github.com/torvalds/linux/commit/ab84d31e15502fb626169ba2663381e34bf965b2</p> <pre><code>sched: Introduce primitives to account for CFS bandwidth tracking\nIn this patch we introduce the notion of CFS bandwidth, partitioned into\nglobally unassigned bandwidth, and locally claimed bandwidth.\n\n - The global bandwidth is per task_group, it represents a pool of unclaimed\n   bandwidth that cfs_rqs can allocate from.\n - The local bandwidth is tracked per-cfs_rq, this represents allotments from\n   the global pool bandwidth assigned to a specific cpu.\n\nBandwidth is managed via cgroupfs, adding two new interfaces to the cpu subsystem:\n - cpu.cfs_period_us : the bandwidth period in usecs\n - cpu.cfs_quota_us : the cpu bandwidth (in usecs) that this tg will be allowed\n   to consume over period above.\n</code></pre> <ul> <li>cpu.cfs_period_us: \u5468\u671f\uff08period\uff09\uff0c\u6bcf\u4e2a\u5468\u671f\u5355\u72ec\u8ba1\u7b97\uff0c\u5468\u671f\u7ed3\u675f\u4e4b\u540e\u72b6\u6001\uff08quota \u7b49\uff09\u6e05\u96f6\uff1b\u9ed8\u8ba4 100ms</li> <li>cpu.cfs_quota_us: \u5728\u4e00\u4e2a\u5468\u671f\u91cc\u7684\u4efd\u989d\uff08quota\uff09\uff0c\u9ed8\u8ba4 5ms\u3002</li> </ul> <p>\u6700\u5927 1s\uff0c\u6700\u5c0f 1ms\uff1a</p> <p>```c   const u64 max_cfs_quota_period = 1 * NSEC_PER_SEC; /* 1s /   const u64 min_cfs_quota_period = 1 * NSEC_PER_MSEC; / 1ms */   static int tg_set_cfs_bandwidth(struct task_group *tg, u64 period, u64 quota)     {         int i;         struct cfs_bandwidth *cfs_b = tg_cfs_bandwidth(tg);         static DEFINE_MUTEX(mutex);</p> <pre><code>    if (tg == &amp;root_task_group)\n        return -EINVAL;\n\n    /*\n     * Ensure we have at some amount of bandwidth every period.  This is\n     * to prevent reaching a state of large arrears when throttled via\n     * entity_tick() resulting in prolonged exit starvation.\n     */\n    if (quota &lt; min_cfs_quota_period || period &lt; min_cfs_quota_period)\n        return -EINVAL;\n\n    /*\n     * Likewise, bound things on the otherside by preventing insane quota\n     * periods.  This also allows us to normalize in computing quota\n     * feasibility.\n     */\n    if (period &gt; max_cfs_quota_period)\n        return -EINVAL;\n\n    mutex_lock(&amp;mutex);\n    raw_spin_lock_irq(&amp;cfs_b-&gt;lock);\n    cfs_b-&gt;period = ns_to_ktime(period);\n    cfs_b-&gt;quota = quota;\n    raw_spin_unlock_irq(&amp;cfs_b-&gt;lock);\n\n    for_each_possible_cpu(i) {\n        struct cfs_rq *cfs_rq = tg-&gt;cfs_rq[i];\n        struct rq *rq = rq_of(cfs_rq);\n\n        raw_spin_lock_irq(&amp;rq-&gt;lock);\n        cfs_rq-&gt;runtime_enabled = quota != RUNTIME_INF;\n        cfs_rq-&gt;runtime_remaining = 0;\n        raw_spin_unlock_irq(&amp;rq-&gt;lock);\n    }\n    mutex_unlock(&amp;mutex);\n\n    return 0;\n}\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#4","title":"4 \u4f7f\u7528","text":""},{"location":"courses/linux-cfs-scheduler/#41-throttle","title":"4.1 \u6a21\u62df throttle \u573a\u666f","text":"<p>\u7528 Overly aggressive CFS \u4e2d\u7684\u7a0b\u5e8f\u6d4b\u8bd5 CFS CPU throttle\uff1a</p> <pre><code>package main\n\nimport (\n    \"crypto/sha512\"\n    \"flag\"\n    \"log\"\n    \"syscall\"\n    \"time\"\n)\n\nfunc main() {\n    sleep := flag.Duration(\"sleep\", time.Second, \"sleep between iterations\")\n    interations := flag.Int(\"iterations\", 100, \"number of iterations\")\n    flag.Parse()\n\n    time.Sleep(time.Second)\n\n    b := time.Now()\n    for i := 0; i &lt; *interations; i++ {\n        s := time.Now()\n        burn(time.Millisecond * 5)\n        e := time.Now().Sub(s)\n\n        log.Printf(\"[%d] burn took %dms, real time so far: %dms, cpu time so far: %dms\", i, ms(e), ms(time.Since(b)), ms(usage()))\n        time.Sleep(*sleep)\n    }\n}\n\nfunc ms(duration time.Duration) int {\n    return int(duration.Nanoseconds() / 1000 / 1000)\n}\n\nfunc burn(duration time.Duration) {\n    s := time.Now()\n\n    for {\n        sum := sha512.New()\n        sum.Write([]byte(\"banana\"))\n        sum.Sum([]byte{})\n\n        if time.Since(s) &gt; duration {\n            break\n        }\n    }\n}\n\nfunc usage() time.Duration {\n    r := syscall.Rusage{}\n    syscall.Getrusage(syscall.RUSAGE_SELF, &amp;r)\n    return time.Duration(r.Stime.Nano() + r.Utime.Nano())\n}\n</code></pre> <p>\u7a0b\u5e8f\u6bcf\u4e2a iteration \u4f1a\u6267\u884c 5ms\uff0c\u7136\u540e sleep \u4e00\u6bb5\u65f6\u95f4\u3002</p> <p>\u7528 docker container \u6765\u6267\u884c\uff0c\u907f\u514d\u6c61\u67d3\u672c\u673a\u914d\u7f6e\u3002</p> <p><code>period=100ms,quota=5m,sleep=10ms</code> \u60c5\u51b5\u4e0b\uff0c\u4e0d\u4f1a\u4ea7\u751f throttle\uff1a</p> <pre><code>$ dk run --rm -it -v $(pwd):$(pwd) -w $(pwd) golang:1.19.4 go run cfs.go -iterations 20 -sleep 10ms\n2023/02/05 09:50:35 [0] burn took 5ms, real time so far: 5ms, cpu time so far: 7ms\n2023/02/05 09:50:35 [1] burn took 5ms, real time so far: 20ms, cpu time so far: 12ms\n2023/02/05 09:50:35 [2] burn took 5ms, real time so far: 37ms, cpu time so far: 17ms\n...\n2023/02/05 09:50:35 [18] burn took 5ms, real time so far: 338ms, cpu time so far: 102ms\n2023/02/05 09:50:35 [19] burn took 5ms, real time so far: 355ms, cpu time so far: 108ms\n</code></pre> <p><code>period=100ms,quota=25m,sleep=10ms</code> \u60c5\u51b5\u4e0b\uff0c\u4f1a\u4ea7\u751f throttle\uff1a</p> <pre><code>$ dk run --rm -it --cpu-quota 25000 --cpu-period 100000 -v $(pwd):$(pwd) -w $(pwd) golang:1.19.4 go run cfs.go -iterations 20 -sleep 10ms\n2023/02/05 09:48:38 [0] burn took 5ms, real time so far: 5ms, cpu time so far: 6ms\n2023/02/05 09:48:38 [1] burn took 11ms, real time so far: 35ms, cpu time so far: 19ms\n2023/02/05 09:48:38 [2] burn took 5ms, real time so far: 51ms, cpu time so far: 24ms\n2023/02/05 09:48:38 [3] burn took 20ms, real time so far: 83ms, cpu time so far: 28ms\n2023/02/05 09:48:38 [4] burn took 5ms, real time so far: 100ms, cpu time so far: 33ms\n2023/02/05 09:48:38 [5] burn took 5ms, real time so far: 115ms, cpu time so far: 38ms\n2023/02/05 09:48:38 [6] burn took 5ms, real time so far: 131ms, cpu time so far: 43ms\n2023/02/05 09:48:38 [7] burn took 5ms, real time so far: 147ms, cpu time so far: 49ms\n2023/02/05 09:48:38 [8] burn took 24ms, real time so far: 182ms, cpu time so far: 51ms\n2023/02/05 09:48:38 [9] burn took 5ms, real time so far: 197ms, cpu time so far: 56ms\n...\n</code></pre>"},{"location":"courses/linux-cfs-scheduler/#42-k8s","title":"4.2 k8s","text":"<p>\u7814\u7a76\u8fd9\u4e9b\u4e1c\u897f\u662f\u4e3a\u4e86\u66f4\u597d\u7406\u89e3\u4e00\u4e9b\u5bb9\u5668\u95ee\u9898\u3002</p>"},{"location":"courses/linux-cfs-scheduler/#_5","title":"\u53c2\u8003\u8d44\u6599","text":"<ol> <li>CFS \u7b2c\u4e00\u7248\u5b9e\u73b0\uff0c kernel/sched_fair.c\uff0ckernel v2.6.23, 2007</li> <li>CFS scheduler design (kernel 5.10), kernel doc, 2023</li> <li>The burstable CFS bandwidth controller, lwn.net, 2021</li> <li>CFS bandwidth control, lwn.net, 2011</li> <li>CPU bandwidth control for CFS, google, 2009</li> <li>CPU bandwidth control warmup, 2021</li> <li>Overly aggressive CFS, 2018</li> <li>Process Scheduling In Linux, 2021</li> </ol>"},{"location":"courses/pg9_high_performance_notes/","title":"\u300aPostgreSQL 9 High Performance\u300b\u8bfb\u4e66\u7b14\u8bb0","text":"<p>\u8fd9\u662f\u5f88\u65e9\u524d\u9605\u8bfb \u300aPostgreSQL 9 High Performance\u300b \u505a\u7684\u4e00\u4e9b\u7b14\u8bb0</p> <p>\u5206\u7ae0\u8282\u8bb0\u5f55</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_1","title":"\u6570\u636e\u5e93\u7248\u672c","text":"<p>\u8fd9\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u4e86 PostgreSQL \u7684\u5386\u53f2\uff0c\u611f\u5174\u8da3\u7684\uff0c\u53ef\u4ee5\u770b\u770b\uff0c\u548c\u6280\u672f\u5173\u7cfb\u4e0d\u5927</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_2","title":"\u786c\u4ef6\u9009\u578b","text":"<ol> <li> <p>\u4e0d\u7528 SSD \u786c\u76d8\u7684\u4e09\u4e2a\u4e3b\u8981\u539f\u56e0</p> <ol> <li>\u5f53\u524d\u786c\u76d8\u5bb9\u91cf\u4e0d\u5927\uff0c\u800c\u6570\u636e\u5e93\u4e00\u5411\u90fd\u5360\u7528\u78c1\u76d8\u8f83\u591a</li> <li>\u5b58\u50a8\u8fd9\u5757\u7684\u8d39\u7528\u4f1a\u76f8\u5f53\u9ad8</li> <li>\u5927\u90e8\u5206 SSD \u8bbe\u8ba1\u65f6\u5e76\u6ca1\u6709\u5f88\u597d\u7684\u8003\u8651\u5199\u7f13\u5b58(write-cache)</li> </ol> </li> <li> <p>write-back cache \u65b9\u5f0f\u5e76\u4e0d\u662f\u9002\u5408\u7528\u4e8e\u5b58\u50a8\u6570\u636e\u7684\u6587\u4ef6\u7cfb\u7edf</p> </li> <li> <p>\u78c1\u76d8\u9635\u5217\u4e00\u822c\u90fd\u7528 wirte-back cache\uff0c\u56e0\u4e3a\u5b83\u914d\u7f6e\u4e86\u7535\u6c60\uff0c\u4e00\u822c\u79f0\u4e3a     battery-backed write cache(BBC or BBWC)</p> </li> <li> <p>\u51e0\u6761\u9884\u9632 write-back cache \u51fa\u6545\u969c\u7684\u57fa\u672c\u6cd5\u5219</p> <ol> <li> <p>\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u5b8c\u6574\u5b9e\u73b0\u4e86 fsync \u8c03\u7528\u6216\u8005\u7c7b\u4f3c\u673a\u5236\u7684\u529f\u80fd</p> </li> <li> <p>\u76d1\u63a7\u78c1\u76d8\u63a7\u5236\u5668\u7535\u6c60\u3002\u6709\u4e9b\u63a7\u5236\u5361\u81ea\u8eab\u4f1a\u76d1\u63a7\u5176\u72b6\u6001\uff0c\u5982\u679c\u53d1\u73b0\u6389\u7535\u6216\u8005\u5de5\u4f5c\u4e0d\u6b63\u5e38\u65f6\uff0c\u4f1a\u4ece write-back     \u6539\u6210 write-through \u6a21\u5f0f\uff0c\u5f53\u7136\uff0c\u5176\u6027\u80fd\u4f1a\u4e0b\u964d</p> </li> <li> <p>\u7981\u6b62\u4efb\u4f55\u78c1\u76d8\u7684 write-cache \u6a21\u5f0f\u3002\u5927\u90e8\u5206 RAID \u5361\u4f1a\u6765\u505a\u8fd9\u70b9\uff0c\u4ed6\u4eec\u4f1a\u4f18\u5148\u4f7f\u7528     BBC \u6a21\u5f0f</p> </li> </ol> </li> <li> <p>\u78c1\u76d8\u8f6c\u901f\u4ee5\u53ca\u6bcf\u79d2\u63d0\u4ea4\u7684\u5199\u901f\u5173\u7cfb\\</p> <p>\u8f6c\u901f(RPM) \u8f6c\u65f6(ms) \u6700\u5927\u63d0\u4ea4\u6570(/s)</p> <pre><code> 5400        11.1           90\n 7200        8.3           120\n 10000       6.0           166\n 15000       4.0           250\n</code></pre> <p>\u4e0a\u8ff0\u56fe\u8868\u5173\u7cfb\u610f\u5473\u7740\u4e00\u4e2a\u666e\u901a\u7684 7200 \u8f6c\u7684\u786c\u76d8\uff0c\u5355\u4e2a\u5ba2\u6237\u7aef\u63d0\u4ea4\u7684\u4e8b\u52a1\u4e0d\u53ef\u80fd\u8d85\u8fc7 120/sec.</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_3","title":"\u786c\u4ef6\u6027\u80fd\u6d4b\u8bd5","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_4","title":"\u5185\u5b58\u6027\u80fd\u6d4b\u8bd5","text":"<ul> <li> <p>memtest86+ \u5927\u90e8\u5206 Linux \u53d1\u578b\u7248\u672c\u90fd\u81ea\u5e26\u4e86 memtest86+\u5185\u5b58\u6d4b\u8bd5\u5de5\u5177\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4e5f\u53ef\u4ee5\u4ecehttp://www.memtest.org\u4e0b\u8f7d\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5305\u542b memtest86+\u5f15\u5bfc CD \u8fdb\u884c\u6d4b\u8bd5</p> </li> <li> <p>STREAM \u5185\u5b58\u6d4b\u8bd5 STEAM \u662f\u4e00\u4e2a\u5185\u5b58\u5e26\u5bbd\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u4ecehttp://www.cs.virginia.edu/stream\u4e0b\u8f7d\uff0c\u7f51\u7ad9\u4e0a\u4e5f\u6709\u5f88\u591a\u6d4b\u8bd5\u62a5\u544a\u4e8b\u4f8b.\\</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#cpu","title":"CPU \u6027\u80fd\u6d4b\u8bd5","text":"<p>\u76f4\u63a5\u4f7f\u7528\u6570\u636e\u5e93\u6765\u505a\u4e00\u4e9b\u67e5\u8be2\u64cd\u4f5c\u5c31\u662f\u6d4b\u8bd5 CPU \u6027\u80fd\u7684\u6700\u597d\u5de5\u5177\uff0c\u5728 psql \u91cc\u5f00\u542f\\timing \u529f\u80fd\uff0c\u5229\u7528*generate_series*\u51fd\u6570\u6765\u521b\u5efa\u5de8\u91cf\u7684\u6570\u5217\uff0c\u4fbf\u80fd\u770b\u51fa CPU \u7684\u6027\u80fd\u3002\u6bd4\u5982\u7c7b\u4f3c\u4e0b\u9762\u7684\u4e00\u4e9b\u6307\u4ee4\uff1a</p> <pre><code>postgres=#\\timing\npostgres=#SELECT sum(generate_series) FROM generate_series(1,1000000);\npostgres=#CREATE TABLE test (id INTEGER PRIMARY KEY);\nINSERT INTO test VALUES (generate series(1,100000));\npostgres=#EXPLAIN ANALYZE SELECT COUNT(*) FROM test;\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#cpu_1","title":"\u5185\u5b58\u548c CPU \u6162\u7684\u6839\u6e90","text":"<p>\u5927\u90e8\u5206\u5185\u5b58\u8bbe\u7f6e\u4e3a\u53cc\u901a\u9053\u6a21\u5f0f\uff0c\u4e00\u5bf9\u5185\u5b58\u5e94\u8be5\u63d2\u5165\u5230\u7279\u5b9a\u7684\u63d2\u69fd\u5185\uff0c\u5982\u679c\u5b89\u88c5\u4e0d\u6b63\u786e\uff0c\u5185\u5b58\u5c06\u4f1a\u8fd0\u884c\u5728\u5355\u901a\u9053\u6a21\u5f0f\u3002memtest86+\u7a0b\u5e8f\u6709\u6b21\u63d0\u793a\uff0c\u53e6\u5916 BIOS \u91cc\u4e5f\u80fd\u4fa6\u6d4b\u5230\u8fd9\u79cd\u60c5\u51b5\\ \u52a3\u8d28\u7684\u5185\u5b58\u9897\u7c92\u4f1a\u4e25\u91cd\u62d6\u7d2f\u7cfb\u7edf\u6027\u80fd\uff0c\u56e0\u4e3a\u4e3b\u677f\u5e76\u4e0d\u80fd\u5145\u5206\u5229\u7528\u5185\u5b58\u6240\u5ba3\u79f0\u7684\u9ad8\u901f\u3002\u5927\u90e8\u5206\u7cfb\u7edf\u7684\u7f3a\u7701\u914d\u7f6e\u90fd\u662f\u4fdd\u5b88\u7684\uff0c\u5b83\u4e00\u822c\u4f1a\u4ece\u5185\u5b58\u63d0\u4f9b\u7684 SPD\uff08Serial Presence Detect\uff09\u4fe1\u606f\u4e2d\u67e5\u8be2\u5b83\u5e94\u8be5\u8fd0\u884c\u7684\u901f\u5ea6\uff0c\u4f46\u8fd9\u5f80\u5f80\u4e0d\u662f\u5176\u6700\u9ad8\u6027\u80fd\uff0c\u56e0\u6b64\u9700\u8981\u4eba\u5de5\u8c03\u6574\u5185\u5b58\u65f6\u949f\u3002\\ \u9ad8\u6027\u80fd\u7684\u5185\u5b58\u4f7f\u7528\u4e86\u79f0\u4e3a\"Extreme Memory Profile(XMP)\\\"\u534f\u8bae\uff0c\u5b83\u53ef\u4ee5\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u5411 BIOS \u4f20\u9012\u5b83\u53ef\u4ee5\u8fd0\u884c\u7684\u6700\u9ad8\u901f\u7387\u3002\u4f46\u662f BIOS \u7f3a\u7701\u60c5\u51b5\u4e0b\u5e76\u4e0d\u8fdb\u68c0\u67e5\u548c\u4f7f\u7528 XMP\uff0c\u8fd9\u5c31\u4f7f\u5f97\u4f60\u7684\u5185\u5b58\u770b\u4e0a\u53bb\u6ca1\u6709\u5e76\u6ca1\u6709\u90a3\u4e48\u5feb\u3002\\ \u53e6\u5916\u4e00\u4e2a\u539f\u56e0\u5c31\u662f\u5185\u5b58\u548c\u5904\u7406\u5668\u7684\u65f6\u949f\u9891\u7387\u4e0d\u80fd\u5f88\u597d\u7684\u5408\u4f5c\uff0c\u4e00\u65b9\u9762\u9700\u8981\u6ce8\u610f\u4e3b\u677f\u548c BIOS \u7684\u8bbe\u7f6e\uff0c\u4ee5\u4fdd\u8bc1 CPU \u548c\u5185\u5b58\u7684\u65f6\u949f\u9891\u7387\u80fd\u53d1\u6325\u6700\u5927\u529f\u6548\u3002\u53e6\u5916\u4e00\u4e2a\u65b9\u9762\u5c31\u662f\u5f53\u524d\u5927\u90e8\u5206\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4e86\u8282\u7701\uff0c\u90fd\u6709 CPU \u8c03\u901f\u7684\u529f\u80fd\uff0c\u5728\u7a7a\u95f2\u65f6\uff0c\u4f1a\u5c06 CPU \u7684\u4e3b\u9891\u8c03\u7684\u5f88\u4f4e\uff0c\u6bd4\u5982\u4e00\u4e2a 2.4GHz \u7684 CPU\uff0c\u5728\u7a7a\u95f2\u65f6\u8c03\u6574\u4e3a 1GHz \u662f\u5f88\u5e38\u89c1\u7684\u4e8b\u60c5\uff0c\u5982\u679c\u65f6 Linux \u7cfb\u7edf\uff0c\u53ef\u4ee5\u67e5\u770b/proc/cpuinfo \u6765\u83b7\u53d6\u5f53\u524d CPU \u7684\u8fd0\u884c\u9891\u7387\u3002\u5728\u6d4b\u8bd5\u6027\u80fd\u65f6\uff0c\u5e94\u8be5\u5173\u95ed CPU \u8c03\u901f\u7684\u529f\u80fd\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_5","title":"\u78c1\u76d8\u6027\u80fd","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#iops","title":"\u968f\u673a\u8bbf\u95ee\u53ca IOPS","text":"<p>IOPS(Input/Outpu Per Second) \u662f\u8861\u91cf\u4e00\u4e2a\u78c1\u76d8\u6027\u80fd\u7684\u91cd\u8981\u53c2\u6570\uff0c\u5b83\u7efc\u5408\u8861\u91cf\u4e86\u78c1\u76d8\u968f\u673a\u8bfb\u5bfb\u9053\u65f6\u95f4\uff0c\u5e73\u5747\u5ef6\u8fdf\u65f6\u95f4\u7b49\u5f71\u54cd\u6027\u80fd\u7684\u56e0\u7d20\u3002</p> <p>\u6839\u636e\u78c1\u76d8\u5e38\u89c1\u5bf9\u78c1\u76d8\u7ed9\u51fa\u7684\u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u7b97\u51fa\u4e00\u4e2a\u78c1\u76d8\u7684 IOPS\u3002\u6bd4\u5982 seagate \u51fa\u54c1\u7684 Momentus 7200.4 \u684c\u9762\u578b\u78c1\u76d8\u89c4\u683c\u53c2\u6570\u5982\u4e0b\uff1a</p> <p>\u8f6c\u901f\uff1a7200 RPM</p> <p>\u5e73\u5747\u5ef6\u8fdf\uff1a4.17ms</p> <p>\u968f\u673a\u8bfb\u5bfb\u9053\u65f6\u95f4\uff1a11.0ms</p> <p>\u5b9e\u9645\u4e0a\u901a\u8fc7\u8f6c\u901f\uff0c\u6211\u4eec\u5c31\u80fd\u5927\u81f4\u8ba1\u7b97\u51fa\u6765\u5e73\u5747\u5ef6\u8fdf\uff0c\u6bd4\u5982 7200 \u8f6c\u7684\u78c1\u76d8\uff0c\u5c31\u610f\u5473\u7740\uff0c\u8f6c\u4e00\u5708\u9700\u8981\\(1*60/7200 = 8.33ms\\)\u3002 \u6700\u5dee\u7684\u60c5\u51b5\u5c31\u662f\u4f60\u6bcf\u6b21\u7b49\u5f85\u90fd\u9700\u8981\u78c1\u76d8\u8f6c\u4e00\u5708\uff0c\u4f46\u8fd9\u79cd\u51e0\u7387\u4e0d\u5927\uff0c\u5927\u90e8\u5206\u7b49\u5f85\u90fd\u4e0d\u60f3\u8981\u7b49\u5f85\u4e00\u5708\uff0c\u56e0\u6b64\u6211\u4eec\u53d6\u7b97\u672f\u5e73\u5747\uff0c\u6bcf\u6b21\u7b49\u5f85\u4f20\u534a\u5708\u7684\u65f6\u95f4\uff0c\u4e5f\u5c31\u662f\\(8.33/2 = 4.17ms\\)\u3002 \u7531\u6b64\u770b\u51fa\uff0c\u6240\u6709 7200 RPM \u7684\u78c1\u76d8\uff0c\u5176\u5e73\u5747\u5ef6\u8fdf\u90fd\u5e94\u8be5\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u968f\u673a\u8bfb\u53d6\u5bfb\u9053\u65f6\u95f4\u5219\u4f9d\u8d56\u4e8e\u78c1\u76d8\u7684\u5927\u5c0f\u3001\u8d28\u91cf\u4ee5\u53ca\u5176\u4ed6\u56e0\u7d20\u4e86\u3002</p> <p>\u5e73\u5747\u5ef6\u8fdf\u65f6\u95f4 \\(RL = 1/ RPM / 60 / 2 = 4.17 ms\\)</p> <p>\u5bfb\u9053\u65f6\u95f4 \\(S = 11.0 ms\\)</p> <p>\\(IOPS =  1 / (RL + S)  = 1 / (4.17ms + 11ms) = 65.9 IOPS\\)\\</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#zcav","title":"\u987a\u5e8f\u8bbf\u95ee\u53ca ZCAV","text":"<p>CAV(Constant Anular Velocity)\uff0c\u5c31\u6052\u5b9a\u89d2\u901f\u5ea6\u3002\u6307\u7684\u662f\u78c1\u76d8\u5728\u4efb\u610f\u65f6\u523b\uff0c\u8f6c\u901f\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u56e0\u4e3a\u78c1\u76d8\u7684\u76d8\u9762\u662f\u4e00\u4e2a\u5706\u5f62\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u5728\u76f8\u540c\u65f6\u95f4\u5185\uff0c\u8d8a\u9760\u8fd1\u78c1\u76d8\u5916\u5c42\uff0c\u626b\u8fc7\u7684\u9762\u79ef\u7684\u4e5f\u5c31\u8d8a\u5927\u3002\u8fd9\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\uff0c\u78c1\u76d8\u5916\u9053\u7684\u8bfb\u53d6\u901f\u5ea6\u8981\u5feb\u4e8e\u78c1\u76d8\u5185\u9053\u3002</p> <p>\u6709\u5173 CAV\uff0c\u4ee5\u53ca\u76f8\u5173\u5de5\u5177\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684\u94fe\u63a5\uff1a http://www.coker.com.au/bonnie++/zcav/</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#short-stroking","title":"\u77ed\u51b2\u7a0b(short stroking)","text":"<p>\u6211\u4eec\u77e5\u9053\u78c1\u76d8\u7684\u5916\u9053\u8bfb\u5199\u901f\u5ea6\u8981\u5feb\uff0c\u56e0\u6b64\u6709\u4e13\u95e8\u7684\u6280\u672f\u6765\u4fdd\u8bc1\u4f60\u7684\u6570\u636e\u53ea\u5b58\u653e\u5728\u5916\u9053\u4e0a\uff0c\u8fd9\u5c31\u662f\u6210\u4e3a Short stroking \u7684\u6280\u672f\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_6","title":"\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177","text":"<p>Windows \u4e0b\u4f7f\u7528hdtune\u514d\u8d39\u7248\u5373\u53ef\\ Unix \u4e0b\uff0c\u7cfb\u7edf\u518d\u5e26\u7684 dd \u6307\u4ee4\u5c31\u53ef\u4ee5\u4f5c\u4e3a\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u7684\u57fa\u672c\u5de5\u5177\u3002\u4e00\u822c dd \u6d4b\u8bd5\u8bfb\u5199\u7684\u6587\u4ef6\u5927\u5c0f\u81f3\u5c11\u662f\u7269\u7406\u5185\u5b58\u7684\u4e24\u500d\uff0c\u4ee5\u4fdd\u8bc1\u7cfb\u7edf\u4e0d\u4f1a\u628a\u5b9e\u9645\u9700\u8981\u5199\u5165\u78c1\u76d8\u7684\u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58\u4e0a\u3002\u8003\u8651\u5230 postgresql \u9ed8\u8ba4\u7684\u5757\u5927\u5c0f\u662f 8KB\uff0c\u56e0\u6b64 dd \u6d4b\u8bd5\u9700\u8981\u7684\u5757\u5927\u5c0f\u4e3a\uff1a</p> <p>\\(blocks = 250,000 * (gigabytes of RAM)\\)</p> <p>\u6d4b\u8bd5\u65b9\u6cd5\u4e00\u822c\u5982\u4e0b\uff1a</p> <pre><code>time sh -c \"dd if=/dev/zero of=bigfile bs=8k count=blocks &amp;&amp; sync\"\ntime dd if=bigfile of=/dev/null bs=8k\n</code></pre> <p>Unix \u4e0b\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5f00\u6e90\u7684 bonnie++\u5de5\u5177\\ 1\uff09Bonnie++</p> <p>\u5f53\u524d\u6700\u65b0\u7684\u7248\u672c\u662f 1.96\uff0c\u4e5f\u5c31\u662f\u6240\u8c13\u7684 2.0 \u7248\u672c</p> <pre><code>bonnie++ -f -n 0 | tee `hostname`.bonnie\ncat `hostname`.bonnie |grep \",\" | bon_csv2html &gt;`hostname`.htm\n</code></pre> <p>-n 0 \u8868\u793a\u8df3\u8fc7\u6587\u4ef6\u521b\u5efa\u6d4b\u8bd5</p> <p>-f \u8868\u793a\u5feb\u901f\u6a21\u5f0f\uff0c\u8df3\u8fc7\u6bcf\u5b57\u7b26\u7684 I/0 \u6d4b\u8bd5</p> <p>2\uff09bonnie++ zcav</p> <p>zcav \u662f Bonnie \u9879\u76ee\u4e2d\u72ec\u7acb\u51fa\u6765\u7684\u7a0b\u5e8f\uff0c\u7528\u4e8e\u8ddf\u8e2a\u6574\u4e2a\u78c1\u76d8\u7684\u4f20\u8f93\u7387\uff0c\u53ef\u4ee5\u5229\u7528 gnuplot \u6765\u7ed8\u5236\u51fa\u6f02\u4eae\u7684\u56fe\u5f62\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>zcav -lsda.zcav -f /dev/sda\nzcav -lsdb.zcav -f /dev/sdb\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u9700\u8981 root \u6743\u9650\uff0c\u5c06\u4f1a\u4ea7\u751f\u4e24\u4e2a\u65e5\u5fd7\u6587\u4ef6 sda.zcav \u548c sdb.zcav</p> <p>\u800c\u540e\uff0c\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\u751f\u6210\u56fe\u5f62</p> <pre><code>unset autoscale x\nset autoscale xmax\nunset autoscale y\nset autoscale ymax\nset xlabel \"Position MB\"\nset ylabel \"KB/s\"\nset key right bottom\nplot \"sda.zcav\" title \"Dell E6410 laptop\", \"sub\" title \"Huawei SSD\"\nset terminal png\nset output \"disks.png\"\nreplot\n</code></pre> <p>sysbench \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u5e93\u6d4b\u8bd5\u5de5\u5177\uff0c\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u6d4b\u8bd5\u6570\u636e\u5e93\u672c\u8eab\u7684\u6027\u80fd\uff0c\u4e5f\u80fd\u901a\u8fc7\u6570\u636e\u5e93\u6765\u505a\u786c\u4ef6\u6d4b\u8bd5\uff0c\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e9b\u6d4b\u8bd5\u4f8b\u5b50\uff1a\\</p> <p><code>sysbench --test=cpu run</code>\\</p> <pre><code>#!/bin/sh\nTHREADS=1\nGBSIZE=4\nMODE=rndrd\nsysbench --test=fileio --num-threads=$THREADS --file-num=$GBSIZE \\\n--file-total-size=${GBSIZE}G --file-block-size=8K --file-test-mode=${MODE} \\\n--file-fsync-freq=0 --file-fsync-end=no prepare\n\nsysbench --test=fileio --num-threads=$THREADS --file-num=$GBSIZE \\\n--file-total-size=${GBSIZE}G --file-block-size=8K --file-test-mode=${MODE} \\\n--file-fsync-freq=0 --file-fsync-end=no run --max-time=60\n\nsysbench --test=fileio --num-threads=$THREADS --file-num=$GBSIZE \\\n--file-total-size=${GBSIZE}G --file-block-size=8K --file-test-mode=${MODE} \\\n--file-fsync-freq=0 --file-fsync-end=no cleanup\n</code></pre> <p>\u6d4b\u8bd5\u5206\u4e3a 3 \u4e2a\u6b65\u9aa4\uff0c\u9996\u5148\u521b\u5efa\u6d4b\u8bd5\u6587\u4ef6\uff0c\u7136\u540e\u6d4b\u8bd5\u8fd0\u884c\uff0c\u6700\u540e\u6e05\u7406\u6d4b\u8bd5\u6587\u4ef6\u3002 \u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u6574\u6d4b\u8bd5\u6587\u4ef6\u7684\u5927\u5c0f\uff0c\u6d4b\u8bd5\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u4ee5\u53ca\u91c7\u53d6\u4f55\u79cd\u8bfb\u5199\u6a21\u5f0f\u3002\\</p> <pre><code>#!/bin/sh\nDRIVE=\"/dev/sda\"\n## Disable write cache\nhdparm -W 0 $DRIVE\necho fsync with write cache disabled, look for \"Requests/sec\"\nsysbench --test=fileio --file-fsync-freq=1 --file-num=1 --file-total-size=16384\n--file-test-mode=rndwr run\n## Enable write cache (returning it to the usual default)\nhdparm -W 1 $DRIVE\necho fsync with write cache enabled, look for \"Requests/sec\"\nsysbench --test=fileio --file-fsync-freq=1 --file-num=1 --file-total-size=16384\n--file-test-mode=rndwr run\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_7","title":"\u5176\u4ed6\u590d\u6742\u7684\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177","text":"<ol> <li> <p>iozone \u53ef\u4ee5\u6d4b\u8bd5\u5404\u79cd\u78c1\u76d8\u4f7f\u7528\u573a\u666f</p> </li> <li> <p>fio     \u901a\u8fc7\u811a\u672c\u6765\u6784\u5efa\u548c\u6d4b\u8bd5\u5404\u79cd\u4f60\u60f3\u6d4b\u8bd5\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u770b\u8fd9\u4e2a\u4f8b\u5b50\uff1a     http://wiki.postgresql.org/wiki/HP_ProLiant_DL380_G5_Tuning_Guide</p> </li> <li> <p>pgiosim</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_8","title":"\u78c1\u76d8\u8bbe\u7f6e","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_9","title":"\u6587\u4ef6\u7cfb\u7edf","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#ext2","title":"ext2","text":"<p>Linux \u4e0a\u539f\u751f\u7684\u6700\u53e4\u8001\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u6ca1\u6709\u65e5\u5fd7\uff0c\u56e0\u6b64\u5927\u90e8\u5206\u573a\u666f\u4e0b\u90fd\u4e0d\u9002\u5408\u7528\u8be5\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u4e0d\u8fc7\u56e0\u4e3a\u6ca1\u6709\u65e5\u5fd7\uff0c\u6240\u5f97\u5b83\u7684\u8bfb\u5199\u901f\u5ea6\u5f88\u5feb\uff0c\u6709\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u628a ext2 \u6587\u4ef6\u7cfb\u7edf\u7528\u5728 PostgreSQL WAL \u4e0a\u3002</p> <p>\u4f46\u662f\u8981\u6ce8\u610f\u7cfb\u7edf\u91cd\u542f\u540e\uff0c\u81ea\u52a8\u6267\u884c fsck \u6240\u5e26\u6765\u7684\u98ce\u9669\u3002\u56e0\u6b64\u53ea\u6709\u660e\u786e WAL \u6210\u4e3a\u74f6\u9888\u65f6\uff0c\u53ef\u4ee5\u8003\u4e0a\u4f7f\u7528\u66f4\u5feb\u4f46\u662f\u6709\u4e00\u5b9a\u98ce\u9669\u7684 ext2 \u6587\u4ef6\u7cfb\u7edf\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#ext3","title":"ext3","text":"<p>ext3 \u5728 ext2 \u7684\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u65e5\u5fd7\u529f\u80fd\uff0c\u5b83\u5411\u540e\u517c\u5bb9 ext2\u3002\u800c\u4e14 ext2 \u548c ext3 \u4e24\u79cd\u6587\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u53ef\u4ee5\u4e92\u8f6c\u3002</p> <p>\u76ee\u524d\uff0c\u5728 ext3 \u4e0a\uff0c\u6709\u4e09\u79cd\u5199\u65e5\u5fd7\u7684\u65b9\u6cd5\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7\u6302\u8f7d\u65f6\u4f20\u9012 data \u53c2\u6570\u6765\u6307\u5b9a\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li> <p>data=writeback   \u6570\u636e\u6539\u53d8\u4e0d\u4f1a\u8bb0\u5f55\u5728\u65e5\u5fd7\u3002\u5143\u6570\u636e\u6539\u53d8\u8bb0\u5f55\u5728\u65e5\u5fd7\uff0c\u4e0d\u4fdd\u8bc1\u6570\u636e\u5757\u5199\u5165\u7684\u76f8\u5173\u987a\u5e8f\u3002\u5f53\u5d29\u6e83\u540e\uff0c\u6587\u4ef6\u53ef\u4ee5\u6062\u590d\uff0c\u4e0d\u8fc7\u6587\u4ef6\u7ed3\u5c3e\u53ef\u80fd\u6709\u4e9b\u65e0\u7528\u7684\u6570\u636e\uff0c\u53e6\u5916\uff0c\u6587\u4ef6\u7684\u5185\u5bb9\u53ef\u80fd\u662f\u65b0\u65e7\u6570\u636e\u6df7\u5408.</p> </li> <li> <p>data=ordered   \u5143\u6570\u636e\u8bb0\u5f55\u5728\u65e5\u5fd7\uff0c\u6570\u636e\u6539\u53d8\u4e0d\u8fdb\u65e5\u5fd7\u3002\u53ea\u6709\u5f53\u76f8\u5173\u8054\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\uff0c\u624d\u5199\u5143\u6570\u636e\uff0c\u4e5f\u662f\\\"ordered\\\"\u7684\u7531\u6765\u3002</p> </li> <li> <p>data=journal \u6570\u636e\u548c\u5143\u6570\u636e\u7684\u6539\u53d8\u90fd\u5199\u5165\u65e5\u5fd7</p> </li> </ul> <p>\u76f8\u6bd4 WAL \u5b58\u50a8\u5728 ext2 \u4e0a\u83b7\u5f97\u6027\u80fd\u7684\u4f18\u52bf\uff0cext3 + data=writeback \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u66ff\u6362\u9009\u62e9\uff0c\u4e00\u6765\u6027\u80fd\u4e0d\u4f1a\u592a\u5dee\uff0c\u800c\u6765\u6709\u65e5\u5fd7\u7684\u4fdd\u8bc1\uff0c\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u5927\u5927\u7f29\u77ed\u3002\u53ea\u662f\u8981\u8003\u8651\u6587\u4ef6\u81a8\u80c0\u7684\u95ee\u9898\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#ext4","title":"ext4","text":"<p>ext4 \u771f\u6b63\u5f00\u59cb\u80fd\u5728\u4ea7\u54c1\u4e2d\u4f7f\u7528\u662f\u4ece kernel2.6.28 \u5f00\u59cb\uff0c\u4e0d\u8fc7\u56e0\u4e3a\u4e00\u4e9b\u8c03\u7528 fsync \u5904\u7406\u7684 bug\uff0c\u5bf9\u4e8e PostgreSQL \u800c\u8a00\uff0ckernel &gt; 2.6.32 \u7684\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 ext4\u3002\u4e5f\u5c31\u662f RedHat 6 \u548c Ubuntu 10.04 \u53ef\u4ee5\u5f00\u59cb\u7528\u4e86\u3002</p> <p>\u5c3d\u7ba1\u7406\u8bba\u4e0a\uff0cext4 \u4e0d\u5b58\u5728\u4e4b\u524d ext3 \u6587\u4ef6\u7cfb\u7edf 16TB \u7684\u5927\u5c0f\u9650\u5236\uff0c\u4f46\u662f mkfs \u5de5\u5177\u76ee\u524d\u4f9d\u7136\u8fd8\u662f\u6709\u8fd9\u4e2a\u9650\u5236\u3002</p> <p>\u4ece PostgreSQL \u7684\u89d2\u5ea6\u6765\u770b\uff0cext4 \u76f8\u6bd4 ext3 \u7684\u4e3b\u8981\u63d0\u5347\u5728\u4e8e\u80fd\u591f\u66f4\u597d\u7684\u5904\u7406 write barriers \u548c fsync \u64cd\u4f5c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#xfs","title":"XFS","text":"<p>XFS \u662f SGI \u8bbe\u8ba1\u7684\u4e00\u6b3e\u9ad8\u6548\u7387\u65e5\u5fd7\u6587\u4ef6\u7cfb\u7edf\uff0c\u5b83\u6bd4 ext3 \u901f\u5ea6\u7a0d\u5feb\uff0c\u4ece\u539f\u7406\u4e0a\u6765\u8bb2\uff0c\u5b83\u66f4\u50cf\u662f ext3+data=writeback \u8fd0\u884c\u6a21\u5f0f\u3002\u56e0\u6b64\u5982\u679c\u60f3\u4f7f\u7528 XFS,\u8981\u8bb0\u5f97\u8bbe\u7f6e PostgreSQL \u7684*full_page_writes*\u53c2\u6570</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a XFS \u548c ext3 \u7684\u901f\u5ea6\u6bd4\u8f83\u8868\uff0c\u53ef\u4ee5\u5927\u81f4\u770b\u51fa XFS \u7684\u4f18\u52bf</p> <pre><code>  Filesystem       Sequential write(MB/s)   Sequential read(MB/s)\n</code></pre> <p>ext3 data=ordered 39-58 44-72 ext3 data=journal 25-30 49067 XFS 68-72 72-77</p> <p>RHEL5 \u521d\u6b65\u5f00\u59cb\u652f\u6301 XFS\uff0cRHEL6 \u5df2\u7ecf\u5b8c\u5168\u652f\u6301 XFS\u3002\u56e0\u6b64\u5728\u7279\u522b\u5927\u7684\u78c1\u76d8\u7a7a\u95f4\u4e0a\uff0c\u6bd4\u5982\u5e0c\u671b\u6587\u4ef6\u7cfb\u7edf\u8d85\u8fc7 16TB \u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528 XFS\uff0c\u800c\u4e14\u6587\u4ef6\u7cfb\u7edf\u8d8a\u5927\uff0cXFS \u76f8\u6bd4 ext3/ext4 \u8d8a\u6709\u4f18\u52bf\u3002</p> <p>\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0cXFS \u4f7f\u7528 write barriers\uff0cXFS \u4e5f\u504f\u6267\u7684\u8ba4\u4e3a\u6613\u5931\u7f13\u5b58(volatile write cache)\u7684\u78c1\u76d8\u4f1a\u4e22\u5931\u6570\u636e\u3002\u4e3a\u4e86\u9632\u6b62\u8fd9\u70b9\uff0cXFS \u603b\u662f\u79ef\u6781\u7684\u7ed9\u78c1\u76d8\u53d1\u9001\u5237\u76d8(flush)\u6307\u4ee4\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u6709\u975e\u6613\u5931\u7f13\u5b58\u8bbe\u5907\uff0c\u6bd4\u5982\u5e26\u540e\u5907\u7535\u6c60\u7684\u5199\u63a7\u5236\u5668\uff0c\u90a3\u4e48\u7f13\u5b58\u5237\u76d8\u5c31\u662f\u6d6a\u8d39\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6302\u8f7d XFS \u63a8\u8350\u4f7f\u7528 nobarriers \u9009\u9879\u6765\u786e\u4fdd\u7981\u6b62\u7f13\u5b58\u5237\u76d8\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#linux","title":"\u5176\u4ed6 Linux \u6587\u4ef6\u7cfb\u7edf","text":"JFS <p>\u548c XFS \u7c7b\u4f3c\uff0c\u53ea\u662f CPU \u4f7f\u7528\u66f4\u5c11\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u5f97\u5230\u4e3b\u6d41\u53d1\u578b\u7248\u672c\u7684\u5b8c\u6574\u652f\u6301\u3002</p> ReiserFS <p>\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u8fdb\u5165 Linux kernel \u7684\u65e5\u5fd7\u6587\u4ef6\u7cfb\u7edf\uff0c\u800c\u4e14 SuSE \u8fd8\u628a\u5b83\u4f5c\u4e3a\u7f3a\u7701\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f46\u662f\u968f\u7740\u4f5c\u8005\u7684\u88ab\u6355\uff0c\u5176\u524d\u666f\u582a\u5fe7\u3002</p> Btrfs <p>Oracle \u6350\u8d60\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u88ab\u8ba4\u4e3a\u662f\u672a\u6765 Linux \u7684\u4e3b\u8981\u6587\u4ef6\u7cfb\u7edf\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u5230\u7a33\u5b9a\u7248\uff0c\u57fa\u4e8e\u5b83\u7684\u4e00\u4e9b\u72ec\u4e00\u7279\u6027\uff0c\u6bd4\u5982\u5feb\u7167\uff0c\u6821\u9a8c\u548c\u3002\u5b83\u5c06\u6765\u5f88\u6709\u53ef\u80fd\u662f\u6781\u5177\u7ade\u4e89\u529b\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#solaris-ufs","title":"Solaris UFS","text":"<p>Solaris UFS \u7528\u4e8e PostgreSQL \u5e76\u4e0d\u592a\u597d\u3002\u4e00\u4e2a\u4e3b\u8981\u7684\u95ee\u9898\u662f\u5b83\u4ec5\u80fd\u7f13\u5b58\u5c0f\u6587\u4ef6\uff0c\u800c\u6570\u636e\u5e93\u671f\u671b\u7684\u662f\u80fd\u7f13\u5b58\u5927\u6587\u4ef6\u3002\u53e6\u5916\uff0c\u80fd\u7528\u4e8e\u7f13\u5b58\u7684\u5185\u5b58\u5927\u5c0f\u5f88\u5c0f\uff0c\u5bf9\u4e8e SPARC \u7cfb\u7edf\u800c\u8a00\uff0c\u53ea\u80fd\u7528\u5230\u5185\u5b58\u7684 12%\u3002\u800c Intel/AMD x64 \u53ea\u53ea\u6709\u53ef\u601c\u7684 64MB\u3002\u5bf9\u4e8e\u6700\u540e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u6574\u53c2\u6570\u6765\u4fee\u590d\uff0c\u4e00\u4e2a\u662f\u6389\u6b63\u7c7b\u4f3c\u9884\u8bfb\u53d6\u7684\u5927\u5c0f\uff0c\u4e00\u4e2a\u662f\u7c7b\u4f3c\u8bfb\u5199\u5230\u4ea4\u6362\u7a7a\u95f4\u7684\u5927\u5c0f</p> <pre><code>set maxphys=1048576\nset klustsize=1048576\n</code></pre> <p>\u5728 SPARC Solaris \u7cfb\u7edf\u4e0a\uff0c\u8fd8\u53ef\u4ee5\u8c03\u6574\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>set freebebind=0\nset segmap_percent=60\n</code></pre> <p>\u5bf9\u4e8e Intel/AMD x64 Solaris \u7cfb\u7edf\uff0c\u5219\u8bbe\u7f6e\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>set ufs:freebehind=0\nset segmapsize=1073741824\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#freebsd-ufs2","title":"FreeBSD UFS2","text":"<p>\u548c Linux \u7c7b\u4f3c\uff0c\u901a\u8fc7\u4fee\u6539 read-ahead \u80fd\u663e\u8457\u63d0\u5347\u987a\u5e8f\u8bfb\u7684\u901f\u5ea6\u3002\u53c2\u6570\u7684\u5355\u4f4d\u662f\u6587\u4ef6\u7cfb\u7edf\u5757\u5927\u5c0f\uff0c\u9ed8\u8ba4\u662f 8KB\u3002 \u8fd9\u4e2a\u53c2\u6570\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u5728 32 \u5230 256 \u4e4b\u95f4\uff0c\u901a\u8fc7\u4fee\u6539/etc/sysctl.conf \u6587\u4ef6\uff0c\u589e\u52a0\u7c7b\u4f3c\u4e0b\u9762\u7684\u8fd9\u884c\uff1a\\ vfs.read_max = 32\\ \u7136\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\uff0c\u4f7f\u5176\u751f\u6548\uff1a\\ /etc/rc.d/sysctl start</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#zfs","title":"ZFS","text":"<p>\u5f88\u5c11\u6709\u6587\u4ef6\u7cfb\u7edf\u80fd\u50cf ZFS \u4e00\u6837\u62e5\u6709\u4f17\u591a\u7684\u62e5\u62a4\u8005\uff0c\u5f53\u7136\u5b83\u7684\u5f88\u591a\u5148\u8fdb\u7279\u6027\uff0c\u7279\u522b\u662f\u81ea\u5e26\u7684\u5377\u7ba1\u7406\u548c\u5b9e\u65f6\u5feb\u7167\u529f\u80fd\u6211\u4eec\u5728\u5f88\u591a\u5730\u65b9\u90fd\u80fd\u770b\u5230\u5176\u4ecb\u7ecd\u3002 ZFS \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528 128KB \u5927\u5c0f\u7684\u8bb0\u5f55\u5757\uff0c\u5bf9 PostgreSQL \u800c\u8a00\uff0c\u8fd9\u4e2a\u6570\u6709\u70b9\u5927\uff0c\u53cd\u800c\u4f7f\u5f97\u6548\u7387\u4e0d\u9ad8\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u8bbe\u7f6e\u6765\u4f7f\u5f97\u6587\u4ef6\u7cfb\u7edf\u7684\u5757\u5927\u5c0f\u548c PostgreSQL \u7684\u5757\u5927\u5c0f\u4e00\u81f4\uff1a\\ <code>zfs set recordsize=8K zp1/data</code>\\ \u8fd9\u4e2a\u5927\u5c0f\u5bf9 WAL \u5e76\u4e0d\u662f\u4f18\u5316\u503c\uff0c\u76f8\u53cd\uff0c\u5176\u7f3a\u7701\u7684 128KB \u5e94\u8be5\u66f4\u597d\u3002ZFS \u5c3d\u53ef\u80fd\u6d88\u8017\u6389\u6240\u6709\u7684\u5185\u5b58\u7528\u4e8e\u5b83\u7684\u81ea\u9002\u5e94\u53ef\u66ff\u6362\u7f13\u5b58(Adaptive Replacement Cache aka ARC)\uff0c\u5bf9\u4e8e PostgreSQL \u800c\u8a00\uff0c\u9700\u8981\u964d\u4f4e\u8be5\u503c\uff0c\u4e0d\u540c\u7684 Soloris \u53d1\u578b\u7248\u672c\uff0c\u5176\u8c03\u6574 ARC \u7684\u65b9\u5f0f\u6709\u6240\u4e0d\u540c\uff0c\u5177\u4f53\u7684\u53ef\u4ee5\u53c2\u8003http://www.solarisinternals.com/wiki/index.php/ZFS_Evil_Tuning_Guide\u6587\u7ae0\u91cc\u7684\\\"Limiting the ARC Cache\\\"\u7ae0\u8282\u3002</p> <p>\u5bf9\u4e8e FreeBSD \u7cfb\u7edf\u800c\u8a00\uff0c\u53ef\u4ee5\u53c2\u8003http://wiki.freebsd.org/ZFSTuningGuide\uff0c\u8fd9\u7247\u6587\u6863\u91cc\u63d0\u5230\u4e86\u4e00\u4e2a*arc_summary.pl*\u7684\u6709\u7528\u811a\u672c\uff0c\u5b83\u53ef\u4ee5\u5728 FreeBSD \u548c Solari \u4e0a\u8fd0\u884c\u3002</p> <p>ZFS \u4f7f\u7528\u4e00\u79cd\u79f0\u4e3a\\\"intent log\\\"\u7684\u7ed3\u6784\u6765\u5904\u7406\u65e5\u5fd7\uff0c\u5728\u5177\u6709\u591a\u4e2a\u78c1\u76d8\u7684\u9ad8\u6027\u80fd\u7cfb\u7edf\u4e0a\uff0c\u9488\u5bf9\u6570\u636e\u5e93\u78c1\u76d8\uff0c\u4e00\u822c\u5bf9\u5206\u914d\u51fa\u4e13\u95e8\u7528\u6765\u5b58\u50a8\\\"intent log\\\"\u7684\u5b58\u50a8\u6c60\u3002\u800c\u5bf9\u4e8e\u7528\u4e8e\u5b58\u50a8 WAL \u7684\u78c1\u76d8\uff0c\u5c31\u4e0d\u9700\u8981\u4e13\u95e8\u7684\u5b58\u50a8\u6c60\u6765\u5b58\u50a8\\\"intent log\"\u3002\u6709\u5173\u66f4\u5177\u4f53\u7684\u5982\u4f55\u4e3a\u6570\u636e\u5e93\u4f18\u5316 ZFS \u7684\u6307\u5357\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u8fd9\u4e2a\u94fe\u63a5\uff1a\\ http://www.solarisinternals.com/wiki/index.php/ZFS_for_Databases</p> <p>\u548c XFS \u76f8\u4f3c\uff0c\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u6709\u975e\u6613\u5931\u5199\u7f13\u5b58\uff0cZFS \u63d0\u4f9b\u7684\u7f13\u5b58\u5237\u76d8\u4f1a\u5f71\u54cd\u6027\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e zfs_nocacheflush \u53c2\u6570\u6765\u7981\u6b62\u5b83\u3002\u5728/etc/system \u91cc\u589e\u52a0\u4e0b\u9762\u7684\u8fd9\u884c\uff1a\\ <code>set zfs:zfs_nocacheflush=1</code>\\ \u56e0\u4e3a ZFS \u7684\\\"intent log\\\"\u7684\u5065\u58ee\u6027\u4ee5\u53ca\u5757\u6821\u9a8c\u548c\u7684\u7279\u6027\uff0c\u5f53\u5b83\u7528\u4e8e PostgreSQL \u65f6\uff0c\u53ef\u4ee5\u7981\u6b62 full_page_writes \u53c2\u6570\u6765\u83b7\u5f97\u6027\u80fd\u63d0\u5347\uff0c\u4e14\u5c11\u6709\u98ce\u9669\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#fat32","title":"FAT32","text":"<p>\u76ee\u524d\u5df2\u7ecf\u4e0d\u63a8\u8350\u5728\u6570\u636e\u5e93\u4e0a\u4f7f\u7528 FAT32 \u6587\u4ef6\u7cfb\u7edf\u4e0a\u4e86\uff0c\u65e0\u65e5\u5fd7\u3001\u975e\u6b63\u5e38\u5173\u673a\u9700\u8981\u6267\u884c chkdsk \u6062\u590d\u3002\u57fa\u4e8e\u8fd9\u4e9b\u539f\u56e0\uff0cPostgreSQL \u5b89\u88c5\u7a0b\u5e8f\u4e0d\u652f\u6301\u628a\u6570\u636e\u5e93\u96c6\u7fa4\u76f4\u63a5\u5b89\u88c5\u5230 FAT32 \u7cfb\u7edf\u4e0a\u3002\u5f53\u7136\uff0c\u4f60\u624b\u5de5\u6267\u884c initdb \u8fd8\u662f\u53ef\u884c\u7684\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#ntfs","title":"NTFS","text":"<p>NTFS \u662f\u5fae\u8f6f\u7684\u65d7\u8230\u6587\u4ef6\u7cfb\u7edf\uff0c\u5b83\u4f7f\u7528\u975e\u6709\u5e8f\u5143\u6570\u636e\u65e5\u5fd7\u8bb0\u5f55\u3002\u6709\u70b9\u7c7b\u4f3c Linux \u4e0b\u7684 writeback \u65e5\u5fd7\u6a21\u5f0f\u3002\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u5b83\u503c\u5f97\u4fe1\u8d56\uff0c\u4f46\u5728\u4e00\u4e9b\u7f55\u89c1\u7684\u60c5\u51b5\u4e0b\uff0c\u6709\u53ef\u80fd\u5fc5\u987b\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c chkdsk \u6307\u4ee4\u624d\u80fd\u6302\u8f7d\u4e0a\u6765\u3002\u5c31\u50cf\u8f83\u65e9\u7684 PostgreSQL \u5b89\u88c5\u7a0b\u5e8f\u6240\u63cf\u8ff0\u7684\u90a3\u6837\uff0c\u5f53\u4f7f\u7528 NTFS \u662f\uff0c\u504f\u5411\u4e8e\u4f7f\u7528\u4e0b\u9762\u7684\u6570\u636e\u5e93\u914d\u7f6e\u53c2\u6570\uff1a</p> <p><code>open_datasync=fsync_writethrough</code>\\ NTFS \u4f7f\u7528\u79f0\u4e3a\"filesystem junction\\\"\u7684\u529f\u80fd\u6765\u5141\u8bb8\u5728\u5176\u4e0a\u521b\u5efa\u529f\u80fd\u7b49\u4ef7\u7684\u7b26\u53f7\u94fe\u63a5\uff0cJunction \u5de5\u5177\u53ef\u4ee5\u4ecehttp://technet.microsoft.com/en-us/sysinternals/bb896768\u4e0b\u8f7d\u3002\u8fd9\u5c31\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u5728 NTFS \u5377\u4e0a\u4fdd\u7559\u76ee\u5f55\u7ed3\u6784\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\u628a pg_xlog \u5b58\u653e\u5230\u53e6\u5916\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0a\u3002\u8fd9\u4e2a\u529f\u80fd\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5728\u8868\u7a7a\u95f4\u4e0a\u3002</p> <p>\u548c\u7c7b\u4f3c UNIX \u7684 noatime \u53c2\u6570\u76f8\u4f3c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 NTFS \u5377\u4e0a\u5173\u95ed\u5bf9\u5e94\u7684\u529f\u80fd\u3002\\ <code>fsutil behavior set disablelastaccess 1</code>\\ \u56e0\u4e3a\u5386\u53f2\u539f\u56e0\uff0cNTFS \u6700\u81ea\u52a8\u751f\u6210\u7b26\u5408 8.3 \u683c\u5f0f\u7684\u6587\u4ef6\u540d\uff0c\u4ee5\u4fbf\u5411\u540e\u517c\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u53c2\u6570\u7981\u6b62\u8fd9\u4e2a\u529f\u80fd\uff1a\\ <code>fsutil behavior set disable8dot3 1</code>\\ \u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u8bbe\u7f6e\u4e86 disable8to3 \u53c2\u6570\uff0c\u53ef\u80fd\u6709\u6709\u4e9b\u610f\u5916\u7684\u60c5\u51b5\u53d1\u751f\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u7684%TEMP%\u6216%TMP%\u73af\u5883\u53d8\u91cf\u4f7f\u7528\u4e86\u77ed\u540d\u6765\u8bbf\u95ee\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5173\u95ed\u8fd9\u4e2a\u53c2\u6570\u540e\uff0c\u4f1a\u5bfc\u81f4\u76ee\u5f55\u627e\u4e0d\u5230\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u66f4\u65b0\u6240\u6709\u4f7f\u7528\u77ed\u540d\u7684\u73af\u5883\u53d8\u91cf\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#write-barriers","title":"Write barriers","text":"<p>\u7edd\u5927\u90e8\u5206\u78c1\u76d8\u90fd\u6709\u6613\u5931\u7f13\u5b58\uff0c\u56e0\u6b64 PostgreSQL \u7684 WAL \u5199\u6a21\u5f0f\u4e0e\u6b64\u5e76\u4e0d\u517c\u5bb9\uff0c\u8fd9\u91cc\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u8981\u6c42\u5c31\u662f\u5f53\u4e00\u4e2a\u6587\u4ef6\u540c\u6b65\u64cd\u4f5c\u53d1\u751f\u65f6\uff08fsync)\uff0c\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u786e\u4fdd\u6240\u6709\u76f8\u5173\u6570\u636e\u90fd\u5199\u5165\u975e\u6613\u5931\u7f13\u5b58\u6216\u78c1\u76d8\u672c\u8eab\u3002 \u6587\u4ef6\u7cfb\u7edf\u5143\u6570\u636e\u5199\u64cd\u4f5c\u4e5f\u6709\u540c\u6837\u7684\u8981\u6c42\uff0c\u5bf9\u6570\u636e\u66f4\u65b0\u7684\u5199\u64cd\u4f5c\u8981\u6c42\u65e5\u5fd7\u66f4\u65b0\u9996\u5148\u6309\u7167\u6b63\u786e\u7684\u987a\u5e8f\u5199\u5165\u5b89\u5168\u533a\u57df\u3002</p> <p>Linux Kernel \u4e3a\u4e86\u652f\u6301\u8fd9\u4e9b\u573a\u666f\uff0c\u5f00\u53d1\u79f0\u4e4b\u4e3a\u5199\u5c4f\u969c(write barrios)\u7684\u529f\u80fd\u3002\u5185\u6838\u6587\u6863\u662f\u5982\u6b64\u63cf\u8ff0 write barries \u7684\uff1a</p> <p>All requests queued before a barrier request must be finished (made it to the physical medium) before the barrier request is started, and all requests queued after the barrier request must be started only after the barrier request is finished (again, made it to the physical medium).</p> <p>\u610f\u601d\u662f\u5f53\u4e00\u4e2a barrier \u8bf7\u6c42\u5230\u6765\u65f6\uff0c\u6240\u6709\u5728\u8fd9\u4e2a\u4e4b\u524d\u7684\u8bf7\u6c42\u961f\u5217\u6bd4\u5982\u5b8c\u6210\uff08\u5199\u5165\u7269\u7406\u4ecb\u8d28\uff09\uff0c\u7136\u540e\u8fd9\u4e2a barrier \u8bf7\u6c42\u624d\u80fd\u54cd\u5e94\uff0c\u800c barries \u4e4b\u540e\u7684\u6240\u6709\u8bf7\u6c42\u961f\u5217\u53ea\u6709\u5f53\u8fd9\u4e2a barries \u5b8c\u6210\u540e\uff08\u5199\u5165\u7269\u7406\u4ecb\u8d28\uff09\u624d\u80fd\u5f00\u59cb\u3002</p> <p>\u8fd9\u76f8\u5f53\u4e8e\u5728\u4e00\u4e2a\u8f83\u957f\u7684\u8bf7\u6c42\u961f\u5217\u91cc\u5f3a\u884c\u63d2\u5165\u4e00\u4e2a\u6805\u680f\uff0c\u53ea\u6709\u6805\u680f\u524d\u7684\u961f\u5217\u90fd\u5b8c\u6210\uff0c\u540e\u9762\u7684\u624d\u80fd\u53d1\u8d77\u3002\u53ef\u4ee5\u60f3\u8c61\u7c7b\u4f3c\u8d85\u5e02\u6392\u961f\u7ed3\u8d26\u65f6\u7684\u573a\u666f\uff0c\u5f53\u961f\u5217\u8fc7\u957f\u65f6\uff0c\u4fdd\u5b89\u4f1a\u8fc7\u6765\u5e72\u6d89\uff0c\u5b83\u7ad9\u5728\u961f\u4f0d\u7684\u4e2d\u95f4\uff0c\u7136\u540e\u8bf4\uff0c\"\u540e\u9762\u7684\u7a0d\u5fae\u7b49\u4e00\u4e0b\uff0c\u4e3a\u4e86\u9632\u6b62\u62e5\u6324\uff0c\u7b49\u524d\u9762\u7684\u90fd\u7ed3\u7b97\u5b8c\u540e\uff0c\u4f60\u4eec\u518d\u8fc7\u53bb\"\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#barriers","title":"\u78c1\u76d8\u5bf9 barriers \u7684\u652f\u6301","text":"<p>SCSI/SAS \u78c1\u76d8\u5141\u8bb8\u8bfb\u5199\u64cd\u4f5c\u6307\u5b9a\u5f3a\u5236\u5355\u5143\u8bbf\u95ee(Force Unit Access aka FUA)\uff0c\u5b83\u53ef\u4ee5\u4e0d\u901a\u8fc7\u7f13\u5b58\u76f4\u63a5\u8bbf\u95ee\u78c1\u76d8\u4ecb\u8d28\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u5199\u900f(write-through)\u3002\u540c\u65f6\u4e5f\u652f\u6301 SYNCHRONIZE CACHE \u8c03\u7528\u6765\u5237\u76d8\u3002</p> <p>\u65e9\u671f\u7684 IDE \u78c1\u76d8\u5b9e\u73b0\u4e86\u79f0\u4e4b\u4e3a FLUSH CACHE \u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u4e0d\u8fc7\u78c1\u76d8\u5927\u5c0f\u9650\u5236\u4e3a 137GB\u3002ATA-6 \u89c4\u8303\u4e2d\u589e\u52a0\u4e86\u5bf9\u5927\u78c1\u76d8\u7684\u652f\u6301\uff0c\u5e76\u589e\u52a0\u4e86\u65b0\u7684 FLUSH CACHE EXT \u7cfb\u7edf\u8c03\u7528\u3002</p> <p>\u652f\u6301\u539f\u751f\u547d\u4ee4\u961f\u5217\uff08Native Command Queuing)\u7684 SATA \u78c1\u76d8\u4e5f\u80fd\u5904\u7406 FUA\u3002Linux \u4ece 2.6.19 \u5185\u6838\u5f00\u59cb\u5bf9\u5176 NCQ \u7684\u652f\u6301\u653e\u5728\u4e86 libata \u9a71\u52a8\u529b\uff0c\u4e0d\u8fc7\u6709\u4e00\u4e9b\u53d1\u578b\u7248\u672c\uff08\u6bd4\u5982 RedHat\uff09\u4e3a\u4e86\u5411\u540e\u517c\u5bb9\uff0c\u8fd8\u662f\u628a\u5bf9 NCQ \u7684\u652f\u6301\u9a71\u52a8\u653e\u5728\u5185\u6838\u91cc\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#barriers_1","title":"\u6587\u4ef6\u7cfb\u7edf\u5bf9 barriers \u7684\u652f\u6301","text":"<p>ext3 \u6587\u4ef6\u7cfb\u7edf\u5982\u679c\u53ea\u4f7f\u7528\u7b80\u5355\u5377\uff0c\u7406\u8bba\u4e0a\u662f\u652f\u6301 barriers \u7684\u3002\u5982\u679c\u4f7f\u7528\u8f6f RAID \u6216\u8005 LVM\uff0c\u5219 barriers \u6839\u672c\u65e0\u6548\u3002</p> <p>XFS \u80fd\u591f\u6b63\u786e\u5904\u7406 write barriers\uff0c\u800c\u4e14\u7f3a\u7701\u60c5\u51b5\u4e0b\u662f\u542f\u52a8\u8fd9\u4e2a\u529f\u80fd\u7684\u3002</p> <p>ext4 \u540c\u6837\u652f\u6301 barriers\uff0c\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u4e5f\u662f\u542f\u52a8\u6b64\u529f\u80fd\u7684\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#linux_1","title":"\u901a\u7528 Linux \u6587\u4ef6\u7cfb\u7edf\u8c03\u4f18\u65b9\u6848","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#read-ahead","title":"Read-ahead","text":"<p>\u5c06 read-ahead \u53ef\u8c03\u8303\u56f4\u4e00\u822c\u4e3a 4096\u00a016384\uff0c\u7f3a\u7701\u503c\u4e00\u822c\u662f 256\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\u67e5\u770b\u7f3a\u7701\u503c</p> <p><code>blockdev--getra /dev/sda</code></p> <p>\u8bbe\u7f6e read-ahead \u7684\u6307\u4ee4\u5982\u4e0b\uff1a</p> <p><code>blockdev --setra 4096 /dev/sda</code></p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#file-access-times","title":"File access times","text":"<p>\u5173\u95ed atime\uff0c\u5728 fstab \u91cc\u5bf9\u5e94\u7684\u8bbe\u5907\u6302\u8f7d\u9009\u9879\u4e0a\u52a0\u4e0a noatime\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p> <p><code>/dev/sda1     /     ext3     noatime,errors=remount-ro 0 1</code></p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#read-caching-and-swapping","title":"Read caching and swapping","text":"<p>\u8bbe\u7f6e vm.swappiness=0\uff0c\u8868\u793a\u5185\u6838\u5c3d\u53ef\u80fd\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf cache \u800c\u4e0d\u662f swap</p> <p>\u5173\u95ed overcommit \u884c\u4e3a\uff0c\u4e5f\u5c31\u662f\u8bbe\u7f6e vm.overcommit_memory=2</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#write-caching-size","title":"write caching size","text":"<p>\u6709\u4e24\u4e2a\u53c2\u6570\u53ef\u4ee5\u8c03\u6574\u4e0a\u8ff0\u884c\u4e3a</p> <p>/proc/sys/vm/dirty_background_ratio: \u8fd9 \u4e2a\u53c2\u6570\u63a7\u5236\u6587\u4ef6\u7cfb\u7edf\u7684 pdflush \u8fdb\u7a0b\uff0c\u5728\u4f55\u65f6\u5237\u65b0\u78c1\u76d8\u3002\u5355\u4f4d\u662f\u767e\u5206\u6bd4\uff0c\u8868\u793a\u7cfb\u7edf\u5185\u5b58\u7684\u767e\u5206\u6bd4\uff0c\u610f\u601d\u662f\u5f53\u5199\u7f13\u51b2\u4f7f\u7528\u5230\u7cfb\u7edf\u5185\u5b58\u591a\u5c11\u7684\u65f6\u5019\uff0cpdflush \u5f00\u59cb\u5411\u78c1\u76d8\u5199\u51fa\u6570\u636e\u3002\u589e\u5927\u4e4b\u4f1a\u4f7f\u7528\u66f4\u591a\u7cfb\u7edf\u5185\u5b58\u7528\u4e8e\u78c1\u76d8\u5199\u7f13\u51b2\uff0c\u4e5f\u53ef\u4ee5\u6781\u5927\u63d0\u9ad8\u7cfb\u7edf\u7684\u5199\u6027\u80fd\u3002\u4f46\u662f\uff0c\u5f53\u4f60\u9700\u8981\u6301\u7eed\u3001\u6052\u5b9a\u7684\u5199\u5165\u573a\u5408\u65f6\uff0c\u5e94\u8be5\u964d\u4f4e\u5176\u6570\u503c\uff0c\u4e00\u822c\u542f\u52a8\u4e0a\u7f3a\u7701\u662f 5\u3002</p> <p>/proc/sys/vm/dirty_ratio: \u8fd9\u4e2a\u53c2\u6570\u63a7\u5236\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u7cfb\u7edf\u5199\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff0c\u5355\u4f4d\u662f\u767e\u5206\u6bd4\uff0c\u8868\u793a\u7cfb\u7edf\u5185\u5b58\u7684\u767e\u5206\u6bd4\uff0c\u8868\u793a\u5f53\u5199\u7f13\u51b2\u4f7f\u7528\u5230\u7cfb\u7edf\u5185\u5b58\u591a\u5c11\u7684\u65f6\u5019\uff0c\u5f00\u59cb\u5411\u78c1\u76d8\u5199\u51fa\u6570\u636e\u3002\u589e\u5927\u4e4b\u4f1a\u4f7f\u7528\u66f4\u591a\u7cfb\u7edf\u5185\u5b58\u7528\u4e8e\u78c1\u76d8\u5199\u7f13\u51b2\uff0c\u4e5f\u53ef\u4ee5\u6781\u5927\u63d0\u9ad8\u7cfb\u7edf\u7684\u5199\u6027\u80fd\u3002\u4f46\u662f\uff0c\u5f53\u4f60\u9700\u8981\u6301\u7eed\u3001\u6052\u5b9a\u7684\u5199\u5165\u573a\u5408\u65f6\uff0c\u5e94\u8be5\u964d\u4f4e\u5176\u6570\u503c\uff0c\u4e00\u822c\u542f\u52a8\u4e0a\u7f3a\u7701\u662f 10</p> <p>\u5bf9\u4e8e\u8d85\u8fc7 8G \u7684\u5185\u5b58\u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u8003\u8651\u5c06 dirty_background_ratio \u8bbe\u7f6e\u4e3a 1\uff0c\u628a dirty_ratio \u8bbe\u7f6e\u4e3a 2</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#io","title":"I/O \u8c03\u5ea6\u7b97\u6cd5","text":"elevator=cfq <p>\u5b8c\u5168\u516c\u5e73\u961f\u5217\uff0c\u5b83\u8bd5\u56fe\u628a I/O \u5e26\u5bbd\u5e73\u5206\u7ed9\u6240\u6709\u7684\u8bf7\u6c42\u3002\u8fd9\u662f Linux \u9ed8\u8ba4\u8c03\u5ea6\u7b97\u6cd5</p> elevator=deadline <p>\u76ee\u7684\u5728\u4e8e\u5e73\u8861 I/O \u548c\u8bf7\u6c42\u65f6\u95f4\uff0c\u786e\u4fdd\u4e0d\u4f1a\u51fa\u73b0\u56e0\u7b49\u5f85\u65f6\u95f4\u592a\u957f\u800c\"\u997f\u6b7b\"\u7684\u8bf7\u6c42\u3002</p> elevator=noop <p>\u4e0d\u505a\u4efb\u4f55\u590d\u6742\u7684\u8c03\u5ea6\uff0c\u5b83\u53ea\u662f\u7b80\u5355\u7684\u5904\u7406\u5757\u8bf7\u6c42\u5408\u5e76\uff0c\u5e76\u4f9d\u636e\u5e95\u5c42\u8bbe\u5907\u987a\u5e8f\u5bf9\u8bf7\u6c42\u6392\u5e8f\u3002</p> elevator=as <p>Anticipatory \u8c03\u5ea6\u6709\u610f\u5ef6\u8fdf I/O \u8bf7\u6c42\uff0c\u4ee5\u671f\u80fd\u5408\u5e76\u4e00\u4e9b\u8bf7\u6c42\uff0c\u800c\u4ece\u53ef\u4ee5\u6279\u5904\u7406\u3002</p> <p>\u76ee\u524d\u56db\u79cd\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5176\u5b9e\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u4e0d\u5982\u4e0a\u8ff0\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u60f3\u63d0\u5347\u8bfb\u7684\u6027\u80fd\uff0c\u90a3\u4e48\u8003\u8651\u8c03\u6574 read ahead \u53c2\u6570\uff0c\u5982\u679c\u60f3\u63d0\u5347\u5199\u7684\u6027\u80fd\uff0c\u8c03\u6574 write chaching size\u3002</p> <p>\u4e0b\u9762\u63cf\u8ff0\u4e00\u79cd\u8c03\u5ea6\u7b97\u6cd5\u5f71\u54cd\u7cfb\u7edf\u6548\u7387\u7684\u4f8b\u5b50\uff1a</p> <p>\u5bf9\u4e8e\u6709\u5927\u91cf\u78c1\u76d8\u8bfb\u5199\u7684\u7cfb\u7edf\uff0c\u6bd4\u5982 RAID \u6216\u8005 SAN\uff0c\u4f7f\u7528 noop \u8c03\u5ea6\u7b97\u6cd5\u53ef\u4ee5\u5feb\u901f\u7684\u628a\u8bf7\u6c42\u6570\u636e\u8f6c\u53d1\u7ed9\u786c\u4ef6\uff0c\u5982\u679c\u786c\u4ef6\u6709\u5927 cache \u7684\u8bdd\uff0c\u662f\u53ef\u4ee5\u63d0\u5347\u6027\u80fd</p> <p>\u5bf9\u4e8e\u684c\u9762\u7cfb\u7edf\uff0c\u78c1\u76d8 I/O \u80fd\u529b\u6709\u9650\uff0cas \u8c03\u5ea6\u7b97\u6cd5\u80fd\u591f\u66f4\u597d\u7684\u6392\u5e8f\u8bfb\u5199\u8bf7\u6c42\u5230\u6279\u5904\u7406\u91cc\uff0c\u4e0d\u8fc7\u5f88\u663e\u7136\uff0c\u4e0d\u9002\u5408\u5178\u578b\u7684\u6570\u636e\u5e93\u670d\u52a1\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_10","title":"\u6587\u4ef6\u7cfb\u7edf\u65b9\u9762\u7684\u8c03\u4f18\u603b\u7ed3","text":"<ol> <li> <p>\u5f53\u524d\u5199\u65e5\u5fd7\u662f\u5927\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\u7528\u4e8e\u5d29\u6e83\u540e\u6062\u590d\u7684\u4e00\u79cd\u673a\u5236</p> </li> <li> <p>\u5bf9\u4e8e Linux\uff0cext3 \u6587\u4ef6\u5b58\u5728\u66f4\u591a\u7684\u53ef\u8c03\u4f18\u7684\u53ef\u80fd\u6027\u3002XFS \u548c ext4 \u76ee\u524d\u8fd8\u7b97\u662f\u5728\u4ea7\u54c1\u65e9\u671f\u9636\u6bb5\uff0c\u4f46\u76f8\u4fe1\u5c06\u6765\u662f ext3 \u7684\u4e00\u4e2a\u5f88\u597d\u7684\u66ff\u4ee3\u65b9\u6848</p> </li> <li> <p>Solaris \u548c FreeBSD     \u90fd\u6709\u8f83\u8001\u7248\u672c\u7684 UFS \u6587\u4ef6\u7cfb\u7edf\u548c\u8f83\u65b0\u7684 ZFS \u6587\u4ef6\u7cfb\u7edf\u3002ZFS \u7684\u4e00\u4e9b\u7279\u6027\u4f7f\u5f97\u5b83\u5f88\u9002\u5408\u5927\u578b\u6570\u636e\u5e93</p> </li> <li> <p>Windows \u7684 NTFS \u501f\u9274\u4e86\u5f88\u591a UNIX \u4e0a\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u6027</p> </li> <li> <p>\u589e\u52a0 read-ahead\uff0c\u505c\u6b62 atime \u7684\u66f4\u65b0\uff0c\u8c03\u6574\u7528\u4e8e\u5199\u7f13\u5b58\u7684\u6570\u503c\u90fd\u662f\u901a\u7528\u7684\u8c03\u4f18\u6280\u5de7\uff0c\u800c\u4e14\u901a\u5e38\u90fd\u80fd\u63d0\u9ad8\u6570\u636e\u5e93\u7684\u6027\u80fd</p> </li> <li> <p>PostgreSQL \u53ef\u4ee5\u5c06\u6570\u636e\u8fc1\u79fb\u4f4d\u7f6e\uff0c\u65b9\u6cd5\u662f\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u7b26\u53f7\u94fe\u63a5\u6216\u8005\u521b\u5efa\u8868\u7a7a\u95f4</p> </li> <li> <p>\u662f\u5426\u9700\u8981\u5c06\u6570\u636e\u5e93\u7684\u5404\u7ec4\u6210\u90e8\u5206\u5206\u4e0d\u5230\u4e0d\u540c\u7684\u78c1\u76d8\u4e0a\uff0c\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u51b3\u4e8e\u5e94\u7528\u7a0b\u5e8f\u548c\u4f7f\u7528\u65b9\u5f0f</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#postgresql","title":"\u9488\u5bf9 PostgreSQL \u7684\u78c1\u76d8\u5e03\u5c40","text":"<p>\u56e0\u4e3a PostgreSQL \u5bf9\u6240\u6709\u7684\u6587\u4ef6\u90fd\u4f7f\u7528\u6807\u51c6\u6587\u4ef6\u7cfb\u7edf\uff0c\u6570\u636e\u5e93\u7684\u6709\u51e0\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u5206\u914d\u8def\u5f84\uff0c\u6709\u4e00\u4e9b\u901a\u8fc7\u76f4\u63a5\u79fb\u52a8\u76f8\u5173\u6587\u4ef6\uff0c\u6709\u4e9b\u5219\u901a\u8fc7\u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u6765\u5b9e\u73b0\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_11","title":"\u7b26\u53f7\u94fe\u63a5","text":"<p>\u6211\u4eec\u53ef\u4ee5\u628a WAL \u5b58\u653e\u5230\u72ec\u7acb\u7684\u7279\u522b\u4e3a\u5176\u4f18\u5316\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u7136\u540e\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u6765\u4fdd\u6301\u5176\u6570\u636e\u5e93\u76ee\u5f55\u7ed3\u6784\u4e0d\u53d8\uff1a</p> <pre><code>$ cd $PGDATA\n$ mv pg_xlog /disk\n$ ln -s /disk/pg_xlog pg_xlog\n</code></pre> <p>\u4ece PostgreSQL 8.3 \u4ee5\u540e\uff0c\u5728\u6267\u884c initdb \u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a--xlogdir \u53c2\u6570\u6765\u6307\u5b9a xlog \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u4e0d\u8fc7\u5176\u5de5\u4f5c\u539f\u6765\u548c\u4e0a\u4e00\u81f4\uff0c\u4e5f\u662f\u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_12","title":"\u8868\u7a7a\u95f4","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u8868\u7a7a\u95f4\u65f6\u8bbe\u7f6e location \u53c2\u6570\u6765\u6307\u5b9a\u5176\u8868\u7a7a\u95f4\u5185\u7684\u6570\u636e\u6587\u4ef6\u548c\u8868\u5b58\u5230\u5230\u4e0d\u540c\u7684\u4f4d\u7f6e\uff1a</p> <pre><code>$ mkdir /disk/pgdata\n$ psql\npostgres=# CREATE TABLESPACE disk LOCATION '/disk/pgdata';\npostgres=# CREATE TABLE t(i int) TABLESPACE disk;\n</code></pre> <p>\u5728\u6570\u636e\u5e93\u5185\u90e8\uff0c\u8fd9\u4e2a\u529f\u80fd\u4e5f\u662f\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u6765\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u4e0a\u8ff0\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u9700\u8981\u6587\u4ef6\u7cfb\u7edf\u7684\u652f\u6301\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_13","title":"\u6570\u636e\u5e93\u76ee\u5f55\u6811","text":"<p>\u901a\u8fc7 initdb \u6307\u4ee4\uff0cPostgreSQL \u521b\u5efa\u4e86\u4e0b\u9762\u7684\u4e3b\u8981\u76ee\u5f55\u7ed3\u6784\uff0c\u5206\u522b\u63cf\u8ff0\u5982\u4e0b\uff1a</p> base <p>\u8fd9\u662f\u5b58\u50a8 pg_default \u7684\u4f4d\u7f6e\uff0c\u5305\u62ec\u7f3a\u7701\u7684\u8868\u7a7a\u95f4\u3001\u6a21\u677f\u6570\u636e\u5e93\u4ee5\u53ca\u4efb\u4f55\u4e0d\u901a\u8fc7\u663e\u793a\u6307\u5b9a\u4f4d\u7f6e\u7684\u8868\u7a7a\u95f4\u6587\u4ef6\u5b58\u653e\u4f4d\u7f6e\u3002</p> global <p>\u5b58\u653e pg_global \u91cc\u8bbe\u7f6e\u7684\u865a\u62df\u8868\u7a7a\u95f4\uff0c\u8fd9\u91cc\u662f\u5728\u4e00\u4e2a\u96c6\u7fa4\u91cc\u80fd\u88ab\u6240\u6709\u6570\u636e\u5e93\u5171\u4eab\u7684\u7cfb\u7edf\u8868\uff0c\u6bd4\u5982\u6570\u636e\u5e93\u89d2\u8272\u548c\u5176\u4ed6\u7cfb\u7edf\u6761\u76ee</p> pg_clog <p>\u4e8b\u52a1\u63d0\u4ea4\u65e5\u5fd7\u5b58\u653e\u70b9\u3002\u8fd9\u4e9b\u6570\u636e\u88ab VACUUM \u6307\u4ee4\u8bfb\u53d6\uff0c\u56e0\u6b64\u8fd9\u4e9b\u6587\u4ef6\u4e0d\u518d\u9700\u8981\uff0c\u5c31\u88ab\u5220\u9664\u3002\u5982\u679c pg_clog \u6240\u5728\u6587\u4ef6\u7cfb\u7edf\u5728\u6302\u8f7d\u65f6\u7ed5\u8fc7\u4e86\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\uff0c\u5219\u5b83\u4f1a\u79f0\u4e3a\u4e25\u91cd\u62d6\u7d2f\u6570\u636e\u5e93\u6027\u80fd\u7684\u7f6a\u9b41\u7978\u9996\u3002</p> pg_stat_tmp <p>\u8fd9\u4e2a\u76ee\u5f55\u7528\u4e8e\u5b58\u50a8\u90a3\u4e9b\u7528\u4e8e\u6570\u636e\u5e93\u7edf\u8ba1\u7684\u6587\u4ef6\u3002\u8fd9\u4e9b\u6587\u4ef6\u90fd\u4e0d\u4f1a\u592a\u5927\u3002</p> pg_tblspc <p>\u5f53\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8868\u7a7a\u95f4\u65f6\uff0c\u4f1a\u5728\u8fd9\u4e2a\u76ee\u5f55\u521b\u5efa\u4e00\u4e2a\u6307\u5411\u8868\u7a7a\u95f4\u76ee\u5f55\u7684\u7b26\u53f7\u94fe\u63a5\u6587\u4ef6\u3002\u5220\u9664\u8868\u7a7a\u95f4\u65f6\uff0c\u5219\u5220\u9664\u5bf9\u5e94\u7684\u7b26\u53f7\u94fe\u63a5\u6587\u4ef6\u3002</p> pg_xlog <p>\u5b58\u653e WAL \u7528\u4e8e\u5d29\u6e83\u540e\u56de\u6062\u590d\u7684\u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u91cd\u505a\u65e5\u5fd7</p> pg_subtrans <p>\u5b58\u653e\u4e0e\u5b50\u4e8b\u52a1\u76f8\u5173\u7684\u6570\u636e</p> pg_multixact <p>\u5b58\u653e\u591a\u4e8b\u52a1\u72b6\u6001\u6570\u636e\u3002\u5f53\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u5927\u91cf\u4f7f\u7528\u5171\u4eab\u884c\u7ea7\u9501\u65f6\uff0c\u8fd9\u4e2a\u76ee\u5f55\u5c31\u4f1a\u88ab\u5927\u91cf\u4f7f\u7528</p> pg_twophase <p>\u5b58\u653e\u548c\u4e24\u9636\u6bb5\u63d0\u4ea4\u76f8\u5173\u7684\u6570\u636e</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_14","title":"\u4e34\u65f6\u6587\u4ef6","text":"<p>PostgreSQL \u6709\u51e0\u4e2a\u9700\u8981\u4fdd\u5b58\u4e34\u65f6\u6587\u4ef6\u7684\u5e94\u7528\u573a\u666f\uff0c\u4e00\u4e2a\u662f\u4f7f\u7528 create temporary table \u6765\u521b\u5efa\u8868\u4ee5\u53ca\u5bf9\u5e94\u7684\u7d22\u5f15\uff1b\u4e00\u4e2a\u662f\u5f53\u4e00\u4e2a\u67e5\u8be2\u91cc\u5305\u542b\u6392\u5e8f\u64cd\u4f5c\u65f6\uff0c\u5176\u6570\u636e\u8d85\u8fc7\u4e86 work_mem \u8bbe\u7f6e\u7684\u5927\u5c0f\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e34\u65f6\u5bf9\u8c61\u5b58\u653e\u5728 base/pgsql_tmp \u76ee\u5f55\uff0c\u9664\u975e\u91cd\u65b0\u6307\u5b9a\u4e86\u4f4d\u7f6e\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#raid","title":"\u78c1\u76d8\u7ec4\u3001RAID \u4ee5\u53ca\u78c1\u76d8\u5e03\u5c40","text":"<p>\u5982\u679c\u4f60\u78c1\u76d8\u5f88\u591a\uff0c\u800c\u4e14\u78c1\u76d8\u7a7a\u95f4\u5229\u7528\u4e0d\u662f\u95ee\u9898\uff0c\u90a3\u4e48\u4e0b\u9762\u7684\u4e00\u4e2a\u5e03\u5c40\u5bf9\u63d0\u5347\u6027\u80fd\u8fd8\u662f\u5f88\u6709\u5e2e\u52a9\u7684\uff1a\\</p> <pre><code>   Location       Disks   RAID Level       Purpose\n</code></pre> <pre><code>   /(root)          2         1              OS\n   \\$PGDATA        6+         10          Database\n</code></pre> <p>$PGDATA/pg_xlog 2 1 WAL Tablespace 1+ None Temporary files</p> <p>\\ \u9488\u5bf9\u4e0a\u9762\u7684\u78c1\u76d8\u5e03\u5c40\u6a21\u5f0f\uff0c\u7136\u540e\u8003\u8651\u5230\u4e0d\u540c\u7ec4\u4ef6\u5bf9\u7f13\u5b58\u5237\u76d8\u7684\u9700\u6c42\u4e0d\u540c\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4e0b\u9762\u7684 cache \u8bbe\u7f6e\u65b9\u5f0f\uff1a\\</p> <pre><code>  Function       Cache Flushes           Access Pattern\n</code></pre> <pre><code>     OS              Rare         Mix of sequential and random\n  Database         Regularly      Mix of sequential and random\n     WAL           Constant                Sequential\n</code></pre> <p>Temporary files Never More random as client increases</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_15","title":"\u78c1\u76d8\u5e03\u5c40\u6307\u5357","text":"<ul> <li> <p>\u907f\u514d\u628a WAL \u548c\u64cd\u4f5c\u7cfb\u7edf\u653e\u5728\u4e00\u4e2a\u78c1\u76d8\u4e0a\uff0c\u4ed6\u4eec\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u8bbf\u95ee\u6a21\u5f0f</p> </li> <li> <p>\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u4f60\u7684\u6570\u636e\u5e93\u4e0d\u4f1a\u6709\u5927\u6570\u636e\u91cf\u6392\u5e8f\uff0c\u4f60\u53ef\u4ee5\u8ba9\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u5728\u9ed8\u8ba4\u7684\u4f4d\u7f6e</p> </li> <li> <p>\u5728\u4f7f\u7528 ext3 \u7684 Linux \u7cfb\u7edf\u4e0a\uff0c\u5c3d\u53ef\u80fd\u628a WAL \u5b58\u653e\u5230\u53e6\u5916\u7684\u78c1\u76d8\u4e0a\uff0c\u4e0d\u8981\u548c\u6570\u636e\u5e93\u6587\u4ef6\u6405\u548c\u5728\u4e00\u4e2a\u78c1\u76d8\u4e0a</p> </li> <li> <p>\u6587\u4ef6\u7cfb\u7edf\u7edd\u5927\u90e8\u5206\u90fd\u662f\u901a\u8fc7\u5199\u65e5\u5fd7\u6765\u4fdd\u8bc1\u5d29\u6e83\u540e\u53ef\u4ee5\u6062\u590d\uff0c\u65e5\u5fd7\u867d\u7136\u589e\u52a0\u4e86\u5f00\u9500\uff0c\u4f46\u4f7f\u5f97\u6062\u590d\u65f6\u95f4\u53ef\u4ee5\u5728\u9884\u671f\u4e4b\u5185</p> </li> <li> <p>\u5bf9\u4e8e Linux \u7cfb\u7edf\uff0c\u867d\u7136 ext3 \u53ef\u4ee5\u6ee1\u8db3\u5404\u7c7b\u573a\u666f\uff0c\u4f46\u5e76\u4e0d\u662f\u6700\u4f73\u9009\u62e9\u3002\u867d\u7136 XFS \u548c ext4 \u8fd8\u6ca1\u6709\u8fbe\u5230\u4ea7\u54c1\u7ea7\u8d28\u91cf\uff0c\u4f46\u662f\u4ed6\u4eec\u5e94\u8be5\u5f88\u5feb\u53ef\u4ee5\u66ff\u4ee3 ext3(\u6211\u89c9\u5f97 ext4 \u5df2\u7ecf\u5f88\u7a33\u5b9a\u4e86\u5440\uff09</p> </li> <li> <p>Solaris \u548c FreeBSD \u90fd\u62e5\u6709\u8001\u7684 UFS \u6587\u4ef6\u7cfb\u7edf\u548c\u66f4\u65b0\u7684 ZFS \u6587\u4ef6\u7cfb\u7edf\u3002ZFS \u7684\u4e00\u4e9b\u7279\u6027\u4f7f\u5f97\u5b83\u79f0\u4e3a\u5927\u6570\u636e\u7684\u552f\u4e00\u5408\u9002\u9009\u62e9</p> </li> <li> <p>Windows \u5e73\u53f0\u7684 NTFS \u501f\u9274\u4e86\u5f88\u591a\u57fa\u4e8e UNIX \u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u6027\uff0c\u4f7f\u5f97\u5176\u79f0\u4e3a\u53ef\u4fe1\u8d56\u7684\u6587\u4ef6\u7cfb\u7edf</p> </li> <li> <p>\u63d0\u9ad8\u9884\u8bfb(read-ahead)\u503c\uff0c\u7981\u6b62\u66f4\u65b0\u6587\u4ef6\u8bbf\u95ee\u65f6\u95f4\u6233\uff0c\u8c03\u6574\u7528\u4e8e cache \u7684\u5185\u5b58\u6570\u91cf\uff0c\u8fd9\u4e9b\u6280\u5de7\u90fd\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd</p> </li> <li> <p>PostgreSQL \u5141\u8bb8\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u548c\u521b\u5efa\u8868\u7a7a\u95f4\u6765\u91cd\u65b0\u5206\u914d\u6570\u636e\u67d0\u4e9b\u90e8\u4ef6\u7684\u8def\u5f84\u3002</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_16","title":"\u7528\u4e8e\u6570\u636e\u5e93\u7f13\u5b58\u7684\u5185\u5b58","text":"<p>\u8fd9\u7ae0\u4e3b\u8981\u662f\u8ba8\u8bba shared_buffers \u53c2\u6570\u8bbe\u7f6e\u7684\u5185\u5b58\u662f\u5982\u4f55\u4f7f\u7528\u7684\uff0c\u901a\u8fc7\u76d1\u63a7\u548c\u4f18\u5316\u6765\u8fd9\u90e8\u5206\u5185\u5b58\u6765\u83b7\u5f97\u9ad8\u6027\u80fd\uff0c\u8fd9\u4e5f\u662f PostgreSQL \u91cc\u6700\u91cd\u8981\u7684\u6027\u80fd\u53c2\u6570\u3002\\</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#postgresqlconf","title":"postgresql.conf \u91cc\u7684\u5185\u5b58\u5355\u5143","text":"<p>\u65e9\u671f\u7684 PostgreSQL \u7248\u672c\uff0cpostgresql.conf \u6587\u4ef6\u91cc\u7684\u5173\u4e8e\u5185\u5b58\u7684\u8bbe\u7f6e\u53c2\u6570\u7684\u8bbe\u7f6e\uff0c\u4f60\u9700\u8981\u77e5\u9053\u6bcf\u4e00\u4e2a\u53c2\u6570\u7684\u5355\u4f4d\u3002\u6709\u7684\u53ef\u80fd\u662f 1KB\uff0c\u6709\u7684\u53ef\u80fd\u662f 8KB\u3002\\ \u4ece PostgreSQL 8.2 \u4ee5\u540e\uff0c\u5173\u4e8e\u5185\u5b58\u6570\u503c\u7684\u8bbe\u7f6e\u5c31\u7b80\u5316\u4e86\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u5e26\u5355\u4f4d\u7684\u6570\u503c\uff0c\u6bd4\u5982\u5047\u5b9a\u4f60\u8bbe\u7f6e\u4e0b\u9762\u7684\u53c2\u6570\uff1a\\ <code>wal_buffers = 64KB</code>\\ \u4f60\u767b\u9646\u6570\u636e\u5e93\uff0c\u901a\u8fc7 show \u6307\u4ee4\uff0c\u53ef\u4ee5\u770b\u5230 wal_buffers \u7684\u5927\u5c0f\u5c31\u662f\u4f60\u6240\u8bbe\u7f6e\u7684\u53c2\u6570\uff1a</p> <pre><code>wgzhao=# show wal_buffers;\n wal_buffers\n-------------\n 64kB\n(1 row)\n</code></pre> <p>\u4e0d\u8fc7 PostgreSQL \u5185\u90e8\u8fd8\u662f\u4f1a\u628a\u53c2\u6570\u503c\u8f6c\u5316\u4e3a\u5b83\u81ea\u5df1\u5185\u90e8\u5355\u4f4d\uff0c\u6bd4\u5982 wal_buffers \u7684\u5185\u90e8\u5355\u4f4d\u662f\u5757\u5927\u5c0f(8k)\uff0c\u56e0\u6b64\uff0c\u5728 PostgreSQL \u770b\u6765\uff0cwal_buffers \u7684\u503c\u5176\u5b9e\u662f 8\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u8bc1\u5b9e\uff1a</p> <pre><code>wgzhao=# select name,setting,unit,current_setting(name)\nfrom pg_settings where name = 'wal_buffers';\n    name     | setting | unit | current_setting\n-------------+---------+------+-----------------\n wal_buffers | 8       | 8kB  | 64kB\n(1 row)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#unix","title":"\u4e3a\u5927\u7f13\u5b58\u589e\u52a0 UNIX \u5171\u4eab\u5185\u5b58\u53c2\u6570\u503c","text":"<p>initdb \u9ed8\u8ba4\u8bbe\u7f6e\u7684 shared_buffers \u4e00\u822c\u90fd\u5f88\u5c0f\uff0c\u8fd9\u662f\u8003\u8651\u5230 initdb \u9700\u8981\u5728\u5404\u79cd\u5e73\u53f0\u4fdd\u8bc1\u6267\u884c\u6210\u529f\uff0c\u800c\u5f88\u591a UNIX \u7cfb\u7edf\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5141\u8bb8\u5206\u914d\u7684\u5185\u5b58\u90fd\u5f88\u5c0f\uff0c\u4e00\u822c\u4e0d\u8d85\u8fc7 32MB\u3002 \u6240\u4ee5 initdb \u6240\u8bbe\u7f6e\u7684 shared_buffers \u4e0d\u9002\u5408\u4efb\u4f55\u573a\u666f\uff0c\u5b83\u4ec5\u4ec5\u53ea\u662f\u4fdd\u8bc1\u6267\u884c\u6210\u529f\uff0c\u4ee5\u53ca\u6570\u636e\u5e93\u670d\u52a1\u80fd\u591f\u542f\u52a8\u3002\\ \u8fd9\u7bc7\u6587\u7ae0\u91cc\u63cf\u8ff0\u4e86\u5404\u79cd\u4e8e\u5171\u4eab\u5185\u5b58\u76f8\u5173\u542f\u52a8\u9519\u8bef\u4fe1\u606f\uff0c\u5176\u4e2d\u4e00\u79cd\u53ef\u80fd\u7684\u9519\u8bef\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837:</p> <pre><code>FATAL: could not create shared memory segment: Invalid argument\nDETAIL: Failed system call was shmget(key=5440001, size=4011376640, 03600)\n</code></pre> <p>\u8fd9\u7bc7\u6587\u6863\u63cf\u8ff0\u4e86\u7edd\u5927\u90e8\u5206\u7cfb\u7edf\u4e0a\u5982\u4f55\u8c03\u6574\u548c shared_buffers \u76f8\u5173\u7684\u5185\u6838\u53c2\u6570.\\ \u5bf9\u4e8e\u652f\u6301 getconf \u6307\u4ee4\u7684 UNIX \u7cfb\u7edf\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u4e00\u4e2a\u811a\u672c\uff08\u5047\u8bbe\u540d\u4e3a*shmsetup.sh*)\u6765\u63d0\u9ad8\u53ef\u5206\u914d\u5185\u5b58\u7684\u5927\u5c0f.\\</p> <pre><code>#!/bin/bash\n## simple shmsetup script\npage_size=`getconf PAGE_SIZE`\nphys_pages=`getconf _PHYS_PAGES`\nshmall=`expr $phys_pages / 2`\nshmmax=`expr $shmall \\* $page_size`\necho kernel.shmmax = $shmmax\necho kernel.shmall =$shmall\n</code></pre> <p>\u8be5\u811a\u672c\u8bbe\u7f6e\u6700\u5927\u5171\u4eab\u5757\u5927\u5c0f\u4e3a\u7269\u7406\u5185\u5b58\u7684\u4e00\u534a\u3002\u5bf9\u4e8e Linux \u7cfb\u7edf\uff0c\u6211\u4eec\u628a\u4e0a\u8ff0\u811a\u672c\u7684\u8f93\u51fa\u5199\u5165/etc/sysctl.conf\\ <code>$ sudo ./shmsetup.sh &gt;&gt;/etc/sysctl.conf</code></p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_17","title":"\u5185\u6838\u4fe1\u53f7\u91cf","text":"<p>\u9664\u4e86\u5171\u4eab\u5185\u5b58\u5916\uff0c\u53e6\u5916\u4e00\u4e2a\u9700\u8981\u8c03\u6574\u7684\u53c2\u6570\u662f\u7cfb\u7edf\u53ef\u6709\u6548\u4f7f\u7528\u7684\u4fe1\u53f7\u91cf\u6570\u3002\u7f3a\u7701\u7684 Linux \u7cfb\u7edf\u770b\u4e0a\u53bb\u5927\u6982\u662f\u8fd9\u4e2a\u6837\u5b50\uff1a\\</p> <pre><code>$ ipcs -l\n...\n------ Semaphore Limits --------\nmax number of arrays = 128\nmax semaphores per array = 250\nmax semaphores system wide = 32000\nmax ops per semop call = 32\nsemaphore max value = 32767\n\n...\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2 kernel.sem \u53c2\u6570\u4e5f\u80fd\u83b7\u5f97\u4e0a\u8ff0\u503c\uff0c\u6bd4\u5982\uff1a</p> <pre><code>## sysctl kernel.sem\nkernel.sem = 250 32000 32 128\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_18","title":"\u8bc4\u4f30\u5171\u4eab\u5185\u5b58\u5206\u914d","text":"<p>\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u9884\u6d4b PostgreSQL \u9700\u8981\u4f7f\u7528\u591a\u5c11\u5185\u5b58\uff0c\u8fd9\u7bc7\u6587\u6863 \u7ed3\u5c3e\u5904\u7684\u4e00\u4e2a\u8868\u683c\u7ed9\u51fa\u4e86\u4e00\u4e2a\u5927\u81f4\u7684\u5185\u5b58\u6d88\u8017\u8bc4\u4f30\u8868\uff0c\u6458\u5f55\u5982\u4e0b\uff1a\\</p> <p>\u7528\u9014 \u5927\u81f4\u9700\u8981\u7684\u5185\u5b58(v8.3)</p> <p>Connections (1800 + 270 * max_locks_per_transaction) * max_connections Autovacuum workers (1800 + 270 * max_locks_per_transaction) * autovacuum_max_works Prepared transactions (770 + 270 * max_locks_per_transaction) * max_prepared_transactions Shared disk buffers (block_size + 208) * shared_buffers WAL buffers (wal_block_size + 8) * wal_buffers Fixed space requirements 770 KB</p> <p>\\ \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPostgreSQL \u8bbe\u7f6e\u7684\u4e0a\u8ff0\u53c2\u6570\u5927\u81f4\u662f\uff1a\\</p> <p>\u53c2\u6570 \u7f3a\u7701\u503c</p> <p>max_locks_per_transaction 64  max_connections 100  autovacuum_max_works 3  max_prepared_transactions 0  block_size 8192  wal_block_size 8192  wal_buffers 8</p> <p>\\ \u901a\u8fc7\u8fd9\u4e9b\u53c2\u6570\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7b80\u5316\u7b2c\u4e00\u4e2a\u8868\u683c\u7684\u7ed3\u679c\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a\\</p> <p>\u7528\u9014 \u5927\u81f4\u5185\u5b58</p> <p>Connections + AV workers 1.9MB  Shared disk buffers 8400 * shared_buffers  WAL buffers 64 KB  Fixed space requirements 770 KB</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_19","title":"\u68c0\u9a8c\u6570\u636e\u5e93\u7f13\u5b58","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 pg_buffercache \u6a21\u5757\u6765\u68c0\u9a8c shared_buffers \u8bbe\u7f6e\u7684\u7f13\u5b58\u91cc\u4fdd\u5b58\u7684\u5185\u5bb9\u3002 \u6709\u5173 pg_buffercache \u7684\u4ecb\u7ecd\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u94fe\u63a5\uff1ahttp://www.postgresql.org/docs/current/static/pgbuffercache.html\\ \u4e00\u65e6\u5b89\u88c5\u4e86 pg_buffercache \u6a21\u5757\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u5f53\u6570\u636e\u5e93\u6d3b\u52a8\u65f6\uff0c\u5185\u5b58\u91cc\u7684\u5757\u662f\u5982\u4f55\u6539\u53d8\u7684\u3002\u8fd9\u662f\u7406\u89e3\u6570\u636e\u5e93\u76f8\u5173\u5de5\u4f5c\u539f\u7406\u7684\u6700\u4f73\u65b9\u6cd5\u3002 \u5728\u751f\u4ea7\u670d\u52a1\u5668\u4e0a\uff0c\u4e5f\u8bb8 pg_buffercache \u6a21\u5757\u4e0d\u4f1a\u663e\u5f97\u81f3\u5173\u91cd\u8981\uff0c\u4f46\u662f\u5bf9\u4e8e\u6211\u4eec\u5b66\u4e60\u6570\u636e\u5e93\u5982\u4f55\u5229\u7528\u5171\u4eab\u5185\u5b58\u662f\u6709\u6781\u5927\u5e2e\u52a9\u7684\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pg_buffercache","title":"\u5b89\u88c5 pg_buffercache \u6a21\u5757","text":"<p>pg_buffercache \u7531 C \u8bed\u8a00\u7f16\u5199\u7684\u52a8\u6001\u5e93\u548c\u4e00\u7ec4 sql \u8bed\u53e5\u7ec4\u6210\u3002\u5bf9\u6bcf\u4e2a\u4f60\u9700\u8981\u89c2\u5bdf\u7684\u6570\u636e\u5e93\uff0c\u90fd\u9700\u8981\u5b89\u88c5\u8be5\u6a21\u5757(\u5bfc\u5165\u5176 sql \u8bed\u53e5)\u3002\u65b9\u6cd5\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>createdb pgbench\npsql -d pgbench -f /usr/share/postgresql/contrib/pg_buffercache.sql\nSET\nCREATE FUNCTION\nCREATE VIEW\nREVOKE\nREVOKE\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2 shared_buffers \u503c\u6765\u9a8c\u8bc1 pg_buffercache \u5b89\u88c5\u6ca1\u6709\u95ee\u9898\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>pgbench=# select name,setting,unit,current_setting(name)\nfrom pg_settings where name = 'shared_buffers';\n      name      | setting | unit | current_setting\n----------------+---------+------+-----------------\n shared_buffers | 65536   | 8kB  | 512MB\n(1 row)\n\npgbench=# select count(*) from pg_buffercache;\n count\n-------\n 65536\n(1 row)\n</code></pre> <p>\u8fd9\u4e00\u7ae0\u7684\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u4f1a\u5229\u7528\u8be5\u6a21\u5757\u7ed9\u51fa\u4e00\u4e9b\u6709\u7528\u7684\u62a5\u8868</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#vs","title":"\u6570\u636e\u5e93\u7f13\u5b58 vs \u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58","text":"<p>\u548c\u5176\u4ed6\u4f20\u7edf\u7684\u6570\u636e\u5e93\u4ea7\u54c1\u4e0d\u540c\uff0cPostgreSQL \u4e0d\u91c7\u53d6\u751a\u81f3\u4e0d\u504f\u5411\u5c06\u5185\u5b58\u7684\u5927\u90e8\u5206\u5212\u4e3a\u81ea\u5df1\u6240\u7528\u3002\u6570\u636e\u5e93\u7684\u5927\u90e8\u5206\u8bfb\u5199\u90fd\u4f7f\u7528\u4e86\u6807\u51c6\u7684\u7cfb\u7edf\u6761\u8c03\u7528\uff0c\u56e0\u6b64\u5b83\u5141\u8bb8\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f13\u5b58\u6309\u7167\u81ea\u5df1\u7684\u65b9\u5f0f\u6765\u4f7f\u7528\u3002\u5728\u67d0\u4e9b WAL \u7684\u914d\u7f6e\u4e2d\uff0c\u5982\u679c\u7ed5\u8fc7\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f13\u5b58\uff0c\u90a3\u4f1a\u662f\u4e2a\u95ee\u9898\u3002\\ \u5982\u679c\u4f60\u4ee5\u524d\u4f7f\u7528\u7684\u6570\u636e\u5e93\u662f\u7684\u914d\u7f6e\u7b56\u7565\u662f\u628a\u7edd\u5927\u90e8\u5206\u5185\u5b58\u5212\u7ed9\u6570\u636e\u5e93\uff0c\u4e14\u6570\u636e\u5e93\u7684\u8bfb\u5199\u64cd\u4f5c\u901a\u8fc7\u540c\u6b65(synchronouse)\u6216\u76f4\u63a5 IO(direct-io)\u65b9\u5f0f\u7ed5\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u3002\u90a3\u4e48\u8fd9\u79cd\u7b56\u7565\u4e0d\u8981\u7528\u5728 PostgreSQL \u4e0a\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_20","title":"\u91cd\u590d\u7684\u7f13\u5b58\u6570\u636e","text":"<p>shared_buffers \u4e0d\u8981\u8bbe\u7f6e\u5f97\u592a\u5927\u7684\u5176\u4e2d\u4e00\u4e2a\u539f\u56e0\u662f\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u4e5f\u88ab\u7528\u4e8e\u8bfb\u5199\u64cd\u4f5c\uff0c\u6781\u7aef\u7684\u60c5\u51b5\u4e0b\uff0c\u4e24\u8005\u7684\u6570\u636e\u6709\u53ef\u80fd\u91cd\u53e0\u800c\u5bfc\u81f4\u6d6a\u8d39\u3002\\ \u6bd4\u5982\uff0c\u5f53\u4f60\u53d1\u8d77\u4e00\u4e2a\u5b8c\u5168\u65b0\u7684\u8bf7\u6c42\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u670d\u52a1\u9700\u8981\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u5757\uff0c\u8fd9\u4e9b\u5757\u9996\u5148\u4f1a\u8fdb\u5165\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\uff0c\u7136\u540e\u62f7\u8d1d\u5230\u6570\u636e\u5e93\u7f13\u5b58\u3002\u867d\u7136\u6700\u7ec8\uff0c\u8fd9\u4e9b\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u90fd\u4f1a\u88ab\u5237\u51fa\u53bb\uff0c\u4f46\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\uff0c\u5b83\u5728\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u548c\u6570\u636e\u5e93\u7f13\u5b58\u4e2d\u90fd\u5b58\u5728\uff0c\u56e0\u6b64\u8bbe\u7f6e shared_buffers \u4e00\u4e2a\u6070\u5f53\u7684\u503c\u53ef\u4ee5\u51cf\u5c11\u91cd\u590d\u6570\u636e\u7684\u6570\u91cf\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#shared_buffers","title":"shared_buffers \u7684\u8d77\u70b9\u8bbe\u7f6e","text":"<p>\u8bbe\u5b9a\u4e00\u4e2a\u597d\u7684 shared_buffers \u503c\u5f88\u96be\uff0c\u901a\u5e38\u6211\u4eec\u90fd\u4f1a\u8bf4\u4e00\u4e2a\u76f8\u5bf9\u5185\u5b58\u7684\u6bd4\u7387\u3002\u6709\u90e8\u5206\u4eba\u4e3b\u5f20\u4ec5\u4f7f\u7528\u5185\u5b58\u7684 10-15%\u3002\u8bba\u6587Tuning Database Configuration Parameters with iTuned\u975e\u5e38\u8be6\u5c3d\u7684\u7ed9\u51fa\u4e86\u4e00\u4e2a\u6709\u5173\u8be5\u503c\u7684\u5b66\u672f\u89e3\u91ca\u3002\u8fd9\u7247\u6587\u6863\u63d0\u5230\u4ed6\u4eec\u5728\u4e00\u53f0 1G \u5185\u5b58\u7684\u673a\u5668\u4e0a\uff0c\u53d1\u73b0\u8bbe\u7f6e shared_buffers \u8bbe\u7f6e\u4e3a\u5185\u5b58\u7684 40%\u4e3a\u5176\u6700\u4f73\u503c\uff0c\u5e76\u636e\u6b64\u8fdb\u884c\u4e86\u975e\u5e38\u5e7f\u6cdb\u7684\u67e5\u8be2\u6d4b\u8bd5\u3002\\ \u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u670d\u52a1\u5668\u4e0a OS \u5bf9\u5185\u5b58\u5f00\u9500\u5f88\u5c0f\uff0c\u90a3\u4e48 shared_buffers \u8bbe\u7f6e\u4e3a\u5185\u5b58\u7684 25%\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u8d77\u70b9\uff0c\u867d\u7136\u4e0d\u662f\u6700\u4f73\u8bbe\u7f6e\uff0c\u4f46\u662f\u4e00\u65b9\u9762\u5b83\u53ef\u4ee5\u6709\u6548\u51cf\u5c11\u91cd\u590d\u7684\u7f13\u5b58\u6570\u636e\uff0c\u53e6\u5916\u4e00\u65b9\u9762\uff0c\u5b83\u4e5f\u6bd4\u7f3a\u7701\u8bbe\u7f6e\u503c\u8981\u9ad8\u5f88\u9ad8\uff0c\u76f8\u6bd4\u6548\u7387\u4e5f\u6709\u8f83\u5927\u63d0\u5347\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_21","title":"\u7f13\u5b58\u67e5\u8be2\u68c0\u6d4b","text":"<p>\u4e0b\u9762\u7528\u4e00\u4e2a\u5b9e\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u5229\u7528 pg_buffercache \u6765\u6a21\u5757\u6765\u68c0\u6d4b\u7f13\u5b58\u7684\u4f7f\u7528 \u6211\u4eec\u8bbe\u7f6e shared_buffers \u4e3a 512M\uff0c\u7136\u540e\u4f7f\u7528 pgbench \u521b\u5efa\u4e00\u4e2a\u6bd4\u4f8b\u4e3a 50 \u7684\u6570\u636e\u5e93\uff0c\u5176\u76ee\u7684\u662f\u6570\u636e\u5e93\u5927\u5c0f\u8d85\u8fc7 shared_buffers \u7684\u503c\uff0c\u4ee5\u514d\u6240\u6709\u7684\u67e5\u8be2\u6570\u636e\u90fd\u80fd\u7f13\u5b58\u5230\u5185\u5b58\u91cc\u3002\\</p> <pre><code>pgbench -i -s 50 pgbench\npsql -hlocalhost -x -c \"select pg_size_pretty(pg_database_size('pgbench')) as db_size\"\n\n-[ RECORD 1 ]---\ndb_size | 754 MB\n\npgbench -h localhost -S -c 8 -t 25000 pgbench\nstarting vacuum...end.\n\ntransaction type: SELECT only\nscaling factor: 50\nquery mode: simple\nnumber of clients: 8\nnumber of threads: 1\nnumber of transactions per client: 25000\nnumber of transactions actually processed: 200000/200000\ntps = 540.590358 (including connections establishing)\ntps = 540.624004 (excluding connections establishing)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_22","title":"\u7f13\u5b58\u91cc\u7684\u6700\u5927\u8868","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u7684 SQL \u8bed\u53e5\u6765\u67e5\u8be2\u5728\u7f13\u5b58\u4e2d\u7684\u524d 10 \u4e2a\u8868\u662f\u54ea\u4e9b</p> <pre><code>pgbench=# SELECT\n  c.relname,\n  count(*) AS buffers\nFROM pg_class c\n  INNER JOIN pg_buffercache b\n    ON b.relfilenode=c.relfilenode\n  INNER JOIN pg_database d\n    ON (b.reldatabase=d.oid AND d.datname=current_database())\nGROUP BY c.relname\nORDER BY 2 DESC\nLIMIT 10;\n             relname              | buffers\n----------------------------------+---------\n pgbench_accounts                 |   51346\n pgbench_accounts_pkey            |   13713\n pg_depend_reference_index        |      11\n pg_depend                        |       9\n pg_rewrite                       |       5\n pg_extension                     |       5\n pg_depend_depender_index         |       5\n pg_description                   |       5\n pg_statistic                     |       4\n pg_statistic_relid_att_inh_index |       4\n(10 rows)\n</code></pre> <p>\u9664\u6389\u7cfb\u7edf\u8868\u4ee5\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u7f13\u5b58\u7684\u7edd\u5927\u90e8\u5206\u90fd\u7528\u5728\u4e86 pgbench_accounts \u8868\u4ee5\u53ca\u5b83\u7684\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u8fd9\u4e5f\u5e94\u8be5\u662f\u6211\u4eec\u671f\u671b\u7684\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_23","title":"\u7f13\u5b58\u5185\u5bb9\u7edf\u8ba1","text":"<p>\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u67e5\u770b\u5230\uff0c\u76ee\u524d\u7f13\u5b58\u91cc\uff0c\u6570\u636e\u91cf\u5c45\u524d 10 \u4f4d\u7684\u5bf9\u8c61\u662f\u54ea\u4e9b\uff0c\u5360\u7528\u7f13\u5b58\u6bd4\u7387\u662f\u591a\u5c11\uff0c\u4ee5\u53ca\u76f8\u6bd4\u5bf9\u8c61\u5927\u5c0f\u7684\u6bd4\u7387\u662f\u591a\u5c11</p> <pre><code>pgbench=#SELECT\n  c.relname,\n  pg_size_pretty(count(*) * 8192) as buffered,\n  round(100.0 * count(*) /\n    (SELECT setting FROM pg_settings\n      WHERE name='shared_buffers')::integer,1)\n    AS buffers_pct,\n  round(100.0 * count(*) * 8192 /\n    pg_relation_size(c.oid),1)\n    AS pct_of_rel\nFROM pg_class c\n  INNER JOIN pg_buffercache b\n    ON b.relfilenode = c.relfilenode\n  INNER JOIN pg_database d\n    ON (b.reldatabase = d.oid AND d.datname = current_database())\nGROUP BY c.oid,c.relname\nORDER BY 3 DESC\nLIMIT 10;\n            relname              |  buffered  | buffers_pct | pct_of_rel\n----------------------------------+------------+------------+-------------\n pgbench_accounts                 | 402 MB     |       78.5 |      62.8\n pgbench_accounts_pkey            | 107 MB     |       20.9 |     100.0\n pg_operator_oid_index            | 32 kB      |        0.0 |     100.0\n pg_opclass_oid_index             | 16 kB      |        0.0 |     100.0\n pg_namespace                     | 8192 bytes |        0.0 |     100.0\n pg_operator                      | 88 kB      |        0.0 |      78.6\n pg_amproc_fam_proc_index         | 24 kB      |        0.0 |      75.0\n pg_index                         | 24 kB      |        0.0 |     100.0\n pg_statistic_relid_att_inh_index | 32 kB      |        0.0 |     100.0\n pg_index_indrelid_index          | 16 kB      |        0.0 |     100.0\n(10 rows)\n</code></pre> <p>\u6ce8\u610f\uff0c\u51fd\u6570 pg_relation_size()\u4e0d\u5305\u542b\u5b58\u50a8\u5728 TOAST \u8868\u4e2d\u7684\u6570\u636e\u3002\u5982\u679c\u4f60\u7684 PostgreSQL \u662f 9.0 \u4ee5\u4e0a\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 pg_table_size()\u51fd\u6570\u6765\u4ee3\u66ff\uff0c\u5b83\u5305\u542b\u4e86 TOAST \u8868\u6570\u636e\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_24","title":"\u603b\u7ed3","text":"<p>\u4e00\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u53ef\u80fd\u4f1a\u9047\u5230\u5404\u79cd\u5de5\u4f5c\u6a21\u5f0f\uff0c\u6240\u4ee5\u5f88\u96be\u6709\u4e00\u4e2a\u6b7b\u89c4\u5219\u6765\u8bf4\u6839\u636e\u786c\u4ef6\u6761\u4ef6\u5c31\u53ef\u4ee5\u914d\u7f6e\u51fa\u4f18\u5316\u7684\u53c2\u6570\u3002\\ \u6709\u4e9b\u5e94\u7528\u7a0b\u5e8f\u504f\u5411\u628a\u5927\u90e8\u5206\u5185\u5b58\u4e13\u7528\u4e8e\u6570\u636e\u5e93\uff0c\u5e76\u4ece\u4e2d\u83b7\u5f97\u597d\u5904\uff0c\u800c\u6709\u4e9b\u5e94\u7528\u7a0b\u5e8f\u5219\u4f1a\u56e0\u4e3a\u8fd9\u6837\u7684\u914d\u7f6e\u9047\u5230 checkpoint \u5cf0\u503c\u95ee\u9898\u3002\\ PostgreSQL 8.3 \u4ee5\u540e\u7684\u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5de5\u5177\u5e2e\u6211\u4eec\u76d1\u63a7\u7f13\u5b58\u8fd9\u90e8\u5206\u533a\u57df\u662f\u5982\u4f55\u4f7f\u7528\u7684\uff0c\u518d\u8054\u5408\u5305\u62ec OS \u5982\u4f55\u4f7f\u7528\u7f13\u5b58\u7b49\u6280\u672f\u624b\u6bb5\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u914d\u7f6e\u51fa\u4e00\u4e2a\u9760\u8c31\u7684\u4f18\u5316\u53c2\u6570\u6765\u3002\\ \u4e0b\u9762\u662f\u4e00\u4e2a\u9488\u5bf9\u6570\u636e\u5e93\u5185\u5b58\u4f7f\u7528\u7684\u89c4\u5219\uff1a\\</p> <ul> <li> <p>\u5728\u670d\u52a1\u542f\u52a8\u65f6\uff0cPostgreSQL \u5206\u522b\u4e00\u5927\u5757\u5185\u5b58\u7528\u6237\u628a\u6570\u636e\u5e93\u78c1\u76d8\u5757\u5bfc\u5165\u5185\u5b58\uff0c\u5e76\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c</p> </li> <li> <p>\u6570\u636e\u5e93\u7f13\u5b58\u548c\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u662f\u534f\u4f5c\u5173\u7cfb\u800c\u975e\u66ff\u4ee3\u5173\u7cfb\uff0c\u56e0\u6b64\u5176\u5927\u5c0f\u5e94\u8be5\u662f\u4e00\u4e2a\u6070\u5f53\u7684\u503c\u800c\u975e\u4e00\u5473\u7684\u6c42\u5927</p> </li> <li> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5206\u914d\u7ed9\u6570\u636e\u5e93\u7684\u5171\u4eab\u5185\u5b58\u90fd\u5f88\u5c0f\uff0c\u56e0\u6b64\u9700\u8981\u8c03\u6574</p> </li> <li> <p>\u5d29\u6e83\u540e\u6062\u590d\u662f\u901a\u8fc7\u6539\u53d8\u6570\u636e\u5e93\u6587\u4ef6\u4e4b\u524d\u5c06\u4fee\u6539\u7684\u5185\u5bb9\u5148\u5199\u5165 WAL \u6765\u505a\u5230\u7684</p> </li> <li> <p>Checkpoint \u9700\u8981\u5c0f\u5fc3\u8c03\u6574\uff0c\u65e2\u8981\u9650\u5236\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u53c8\u8981\u8003\u8651\u4e0d\u5f71\u54cd\u7cfb\u7edf\u7684\u6027\u80fd</p> </li> <li> <p>\u7cfb\u7edf\u89c6\u56fe pg_stat_bgwriter \u8ddf\u8e2a\u6240\u6709\u7f13\u5b58\u7684\u5237\u5165\u5237\u51fa\u60c5\u51b5</p> </li> <li> <p>pg_buffercache   \u6a21\u5757\u7528\u6765\u67e5\u770b\u7f13\u5b58\u5185\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u5e76\u636e\u6b64\u5224\u65ad\u7f13\u5b58\u662f\u592a\u5927\u8fd8\u662f\u592a\u5c0f</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_25","title":"\u670d\u52a1\u5668\u914d\u7f6e\u8c03\u4f18","text":"<p>\u8fd9\u4e00\u7ae0\u4e3b\u8981\u56f4\u7ed5$PGDATA/postgresql.conf \u6587\u4ef6\u91cc\u7684\u914d\u7f6e\u53c2\u6570\u5c55\u5f00\uff0c\u57fa\u672c\u4e0a\u7b97\u662f\u5bf9http://www.postgresql.org/docs/current/static/runtime-config.html \u4e00\u6587\u7684\u62f7\u8d1d\uff0c\u4e0d\u8fc7\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u4e00\u4e9b\u91cd\u8981\u53c2\u6570\u7684\u914d\u7f6e\u6307\u5bfc\u5927\u7eb2\uff0c\u800c\u4e0d\u662f\u4ecb\u7ecd\u6bcf\u4e2a\u53c2\u6570\u7684\u542b\u4e49\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u6709\u5173\u8c03\u4f18\u7684\u5728\u7ebf\u8d44\u6e90\u662f\u5b98\u65b9 wiki \u4e0a\u7684\u4e00\u7bc7\u6587\u7ae0:Tuning Your PostgreSQL Server\uff0c\u8fd9\u7bc7\u6587\u7ae0\u4e00\u76f4\u5728\u66f4\u65b0\u4ee5\u4fdd\u6301\u548c\u5f53\u524d\u4e3b\u6d41\u7248\u672c\u7684\u914d\u7f6e\u53c2\u6570\u4e00\u81f4\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_26","title":"\u4fee\u6539\u53c2\u6570","text":"<p>PostgreSQL \u53c2\u6570\u53ef\u4ee5\u6709\u51e0\u79cd\u4fee\u6539\u65b9\u5f0f\uff0c\u6709\u7684\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u76f4\u63a5\u4fee\u6539\uff0c\u6709\u7684\u53c2\u6570\u4fee\u6539\u540e\uff0c\u9700\u8981\u53d1\u51fa SIGHUP \u4fe1\u53f7\u4ee5\u4fbf\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\u6765\u6765\u751f\u6548\uff0c \u6709\u7684\u4fee\u6539\u540e\u5219\u9700\u8981\u91cd\u542f\u6570\u636e\u5e93\u670d\u52a1\u624d\u751f\u6548\uff0c\u8fd8\u6709\u4e00\u4e9b\u6839\u672c\u5c31\u4e0d\u80fd\u4fee\u6539\u3002</p> <p>\u5982\u679c\u786e\u5b9a\u8fd9\u4e9b\u53c2\u6570\u5c5e\u4e8e\u54ea\u79cd\u7c7b\u578b\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\u7684\u5b57\u5178\u6765\u83b7\u5f97\u76f8\u5173\u4fe1\u606f\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>pgbench=# select name,context from pg_settings;\n              name               |  context\n---------------------------------+------------\n application_name                | user\n archive_command                 | sighup\n archive_mode                    | postmaster\n archive_timeout                 | sighup\n block_size                      | internal\n dynamic_library_path            | superuser\n</code></pre> <p>context \u5b57\u6bb5\u6240\u8868\u793a\u7684\u5177\u4f53\u542b\u4e49\uff0c\u5728\u5b98\u65b9\u6587\u6863\u91cc\u5e76\u6ca1\u6709\u8be6\u7ec6\u7ed9\u51fa\uff0c\u8fd9\u91cc\u6211\u4eec\u6309\u7167\u4ece\u96be\u5230\u6613\u6765\u4ecb\u7ecd\u8fd9\u4e9b\u503c\u7684\u610f\u601d:\\</p> internal <p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u90fd\u662f\u7f16\u8bd1\u65f6\u8bbe\u7f6e\u597d\u7684\uff0c\u4f60\u53ef\u4ee5\u67e5\u770b\u8fd9\u4e9b\u53c2\u6570\u7684\u503c\uff0c\u4f46\u662f\u9664\u975e\u91cd\u65b0\u7f16\u8bd1\uff0c\u5426\u5219\u65e0\u6cd5\u4fee\u6539.</p> postmaster <p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u53ea\u6709\u5b8c\u5168\u91cd\u542f\u6570\u636e\u5e93\u670d\u52a1\u624d\u80fd\u751f\u6548\uff0c\u6240\u6709\u7684\u5171\u4eab\u5185\u5b58\u8bbe\u7f6e\u53c2\u6570\u90fd\u5c5e\u4e8e\u8fd9\u7c7b.</p> sighup <p>\u7ed9\u670d\u52a1\u53d1\u9001 HUP \u4fe1\u53f7\uff0c\u4f7f\u5f97\u670d\u52a1\u53ef\u4ee5\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\uff0c\u4ece\u800c\u4f7f\u5f97\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u751f\u6548.</p> backend <p>\u8fd9\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u548c sighup \u8be6\u7ec6\uff0c\u53ea\u662f\u5b83\u4e0d\u5bf9\u5df2\u7ecf\u8fde\u63a5\u5230\u670d\u52a1\u5668\u4e0a\u7684\u4f1a\u8bdd\u751f\u6548\uff0c\u53ea\u6709\u65b0\u7684\u4f1a\u8bdd\u624d\u4f1a\u542f\u7528\u4fee\u6539\u540e\u7684\u53c2\u6570\uff0c \u5c5e\u4e8e\u8fd9\u7c7b\u7684\u53c2\u6570\u8f83\u5c11\uff0clog_connections \u5c5e\u4e8e\u8fd9\u7c7b</p> superuser <p>\u987e\u540d\u601d\u4e49\uff0c\u8fd9\u7c7b\u53c2\u6570\u53ea\u6709\u6570\u636e\u5e93\u8d85\u7ea7\u7528\u6237\uff08\u9ed8\u8ba4\u4e00\u822c\u662f\u521b\u5efa postgres \u6570\u636e\u5e93\u7684\u7528\u6237\uff09\u624d\u80fd\u4fee\u6539\uff0c\u8fd9\u7c7b\u53c2\u6570\u5927\u90e8\u5206\u4fee\u6539\u540e\u5373\u751f\u6548.</p> user <p>\u6bcf\u4e2a\u4f1a\u8bdd\u90fd\u53ef\u4ee5\u4fee\u6539\u7684\u53c2\u6570\uff0c\u4e14\u4e0d\u4e92\u76f8\u5f71\u54cd\uff0c\u5927\u90e8\u5206\u7684\u53c2\u6570\u90fd\u5c5e\u4e8e\u8fd9\u8fd9\u79cd\u7c7b\u578b\u3002</p> <p>\u5c31\u6211\u76ee\u524d\u4f7f\u7528\u7684 PostgreSQL 9.3 \u7248\u672c\u6765\u8bf4\uff0c\u5404\u79cd\u7c7b\u578b\u7684\u53c2\u6570\u7edf\u8ba1\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>pgbench=# select context,count(context) as count\nfrom pg_settings group by context;\n  context   | count\n------------+-------\n backend    |     5\n user       |    91\n internal   |    14\n postmaster |    37\n superuser  |    25\n sighup     |    52\n(6 rows)\n</code></pre> <p>\u6709\u51e0\u79cd\u529e\u6cd5\u53ef\u4ee5\u8ba9\u6570\u636e\u5e93\u91cd\u65b0\u52a0\u8f7d postgresql.conf \u6587\u4ef6\uff0c\u4e00\u79cd\u662f\u4f7f\u7528\u6570\u636e\u5e93\u81ea\u5e26\u7684\u51fd\u6570\uff0c\u5c31\u50cf\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p> <pre><code>pgbench=# select pg_reload_conf();\n pg_reload_conf\n----------------\n t\nLOG:  received SIGHUP, reloading configuration files\n(1 row)\n</code></pre> <p>\u4e00\u79cd\u662f\u76f4\u63a5\u7ed9\u6570\u636e\u5e93\u8fdb\u7a0b\u53d1\u9001 HUP \u4fe1\u53f7</p> <pre><code>lancy-imac:~ wgzhao$ ps -ef |grep /usr/bin/postgres\n  501  2827     1   0 11:08\u4e0a\u5348 ttys000    0:00.61 /usr/bin/postgres\nlancy-imac:~ wgzhao$ kill -HUP 2827\n</code></pre> <p>\u4ece\u547d\u4ee4\u884c\u6765\u770b\u4e0d\u4f1a\u6709\u4efb\u4f55\u8f93\u51fa\uff0c\u4e0d\u8fc7\u67e5\u770b\u4f60\u7684\u65e5\u5fd7\uff0c\u6216\u8005\u7ec8\u7aef\uff0c\u5e94\u8be5\u6709\u4e0b\u9762\u7c7b\u4f3c\u7684\u8bb0\u5f55\uff1a\\ <code>LOG:  received SIGHUP, reloading configuration files</code></p> <p>\u6700\u540e\u4e00\u79cd\u662f\u901a\u8fc7 pg_ctl \u6307\u4ee4\u6765\u53d1\u9001 SIGHUP \u4fe1\u53f7</p> <pre><code>pg_ctl reload\nserver signaled\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_27","title":"\u670d\u52a1\u7aef\u8bbe\u7f6e","text":"<p>\\</p> listen_addresses <p>\u9ed8\u8ba4\u662f\u4ec5\u5141\u8bb8\u672c\u5730\u94fe\u63a5\uff0c\u4e00\u822c\u901a\u8fc7\u8bbe\u7f6e\u4e3a'*'\u6765\u5141\u8bb8\u4efb\u4f55\u94fe\u63a5</p> max_connections <p>\u4e00\u822c\u8bbe\u7f6e\u4e3a 100\uff0c\u6bcf\u8fdb\u6765\u4e00\u4e2a\u94fe\u63a5\uff0c\u90fd\u9700\u8981\u5360\u7528\u4e00\u90e8\u5206\u5171\u4eab\u5185\u5b58\uff0c\u56e0\u6b64\u5176\u6700\u5927\u503c\u548c shared_buffers \u5173\u7cfb\u5bc6\u5207\uff0c \u800c\u4e14\u4e5f\u6709\u5176\u4ed6\u53c2\u6570\u6709\u5173\u7cfb\uff0c\u6bd4\u5982 work_mem</p> <p>\\</p> shared_buffers <p>\u8fd9\u4e2a\u53c2\u6570\u5728\u6700\u540e\u4e00\u7ae0\u8be6\u7ec6\u8bb2\u89e3\uff0c\u8fd9\u662f\u4e00\u4e2a\u76f8\u5f53\u91cd\u8981\u7684\u53c2\u6570</p> FSM <p>\u8fd9\u91cc\u5305\u62ec\u4e24\u4e2a\u53c2\u6570 max_fsm_pages \u548c max_fsm_relations\uff0c\u5728\u540e\u9762\u7684\u7ae0\u8282\u4f1a\u8be6\u7ec6\u63cf\u8ff0</p> <p>\\</p> log_line_prefix <p>\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a\u7a7a\uff0c\u4e00\u4e2a\u8f83\u597d\u7684\u5efa\u8bae\u503c\u5982\u4e0b\uff1a\\  <code>log_line_prefix='%t:%r:%u@%d:[%p]: '</code>\\  \u5176\u53c2\u6570\u89e3\u91ca\u5982\u4e0b\uff1a</p> %t <p>\u65f6\u95f4\u6233</p> %u <p>\u6570\u636e\u5e93\u7528\u6237\u540d</p> %r <p>\u94fe\u63a5\u7684\u8fdc\u7a0b\u4e3b\u673a\u540d</p> %d <p>\u94fe\u63a5\u7684\u6570\u636e\u5e93\u540d</p> %p <p>\u94fe\u63a5\u7684\u8fdb\u7a0bID</p> log_statement <p>\u6709\u4e0b\u9762\u56db\u4e2a\u53ef\u9009\u503c\u6765\u8bbe\u7f6e\uff1a\\</p> none <p>\u4e0d\u8bb0\u5f55\u4efb\u4f55\u8bed\u53e5\u7ea7\u4fe1\u606f</p> ddl <p>\u4ec5\u8bb0\u5f55\u6570\u636e\u5b9a\u4e49\u8bed\u8a00(Data Definition Language a.k.a DDL),\u6bd4\u5982create,drop\uff0c\u5728\u751f\u4ea7\u7cfb\u7edf\u4e0a\u4e5f\u53ef\u4ee5\u4f7f\u7528 \u8fd9\u4e2a\u53c2\u6570\uff0c\u4ed6\u8bb0\u5f55\u7684\u4fe1\u606f\u5f88\u5c11</p> mod <p>\u8bb0\u5f55\u6240\u6709\u5bf9\u503c\u6709\u4fee\u6539\u7684\u8bed\u53e5\uff0c\u57fa\u672c\u4e0a\u628a\u9664select\u8bed\u53e5\u4ee5\u5916\u7684\u8bed\u53e5\u90fd\u8bb0\u5f55\u4e86\uff0c\u91cf\u6bd4\u8f83\u5927</p> all <p>\u8bb0\u5f55\u6240\u6709\u7684\u8bed\u53e5\uff0c\u6709\u76f8\u5f53\u5927\u7684\u5f00\u9500\uff0c\u5efa\u8bae\u4ec5\u5728\u8c03\u8bd5\u65f6\u4f7f\u7528</p> log_min_duration_statement <p>\u8bb0\u5f55\u90a3\u4e9b\u6267\u884c\u65f6\u95f4\u8d85\u8fc7\u8be5\u53c2\u6570\u503c\u7684\u8bed\u53e5\uff0c\u5355\u4f4d\u662f ms\uff0c\u5982\u679c\u662f 8.4 \u4ee5\u540e\u7684\u7248\u672c\uff0c\u5efa\u8bae\u4f18\u5148\u4f7f\u7528auto_explain \u6a21\u5757</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_28","title":"\u4e13\u7528\u6570\u636e\u5e93\u670d\u52a1\u5668\u53c2\u6570\u8bbe\u7f6e","text":"<p>\u5bf9\u4e8e\u4e00\u53f0\u65b0\u7684\u4e13\u7528\u4e8e\u6570\u636e\u5e93\u670d\u52a1\u7684\u8bbe\u5907\uff0c\u6211\u4eec\u5efa\u8bae\u9996\u5148\u8c03\u6574\u4ee5\u4e0b\u53c2\u6570\uff0c\u7136\u540e\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\uff0c\u518d\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8c03\u6574\uff1a</p> <ol> <li> <p>\u8c03\u6574\u7f3a\u7701\u7684\u65e5\u5fd7\u53c2\u6570\uff0c\u4ee5\u8bb0\u5f55\u7a0d\u591a\u4e00\u70b9\u4fe1\u606f</p> </li> <li> <p>shared_buffers \u8bbe\u7f6e\u4e3a\u7269\u7406\u5185\u5b58\u7684 25%\uff0c\u5f80\u4e0a\u8c03\u6574\u9700\u8981\u8003\u8651\u5230 checkpoint \u7684\u989d\u5916\u5f00\u9500</p> </li> <li> <p>\u8bc4\u4f30\u6700\u5927\u8fde\u63a5\u6570\uff0c\u8fd9\u662f\u4e00\u4e2a\u786c\u6027\u9650\u5236\uff0c\u4e00\u65e6\u8d85\u8fc7\u6700\u5927\u8fde\u63a5\u6570\uff0c\u5219\u4f1a\u88ab\u62d2\u7edd</p> </li> <li> <p>\u7528\u4e0a\u8ff0\u53c2\u6570\u542f\u52a8\u670d\u52a1\uff0c\u6ce8\u610f\u770b\u8fd8\u6709\u591a\u5c11\u5185\u5b58\u53ef\u7528\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58</p> </li> <li> <p>\u8c03\u6574 effective_cache_size \u4e3a shared_buffers + OS cache</p> </li> <li> <p>OS cache / max_connections / 2     \u5176\u7ed3\u679c\u8bbe\u7f6e\u4e3a work_mem \u7684\u4e0a\u9650\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4f9d\u8d56\u4e8e\u6392\u5e8f\u6027\u80fd\uff0c\u53ef\u8bbe\u7f6e\u5f97\u66f4\u5c0f</p> </li> <li> <p>maintenance_work_mem \u8bbe\u7f6e\u4e3a\u6bcf GB \u5185\u5b58 50MB</p> </li> <li> <p>checkpoint_segments \u4e0d\u5c0f\u4e8e 10\uff0c\u5982\u679c\u4f60\u670d\u52a1\u5668\u786c\u4ef6\u5177\u6709 BBWC(Battery-backed     write cache)\u529f\u80fd\uff0c\u8bbe\u7f6e\u4e3a 32 \u4f1a\u66f4\u597d</p> </li> <li> <p>\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u5bf9 wal_sync_method \u7684\u7f3a\u7701\u8bbe\u7f6e\u65b9\u5f0f\u4e0d\u5b89\u5168\uff0c\u66f4\u6362\u5b89\u5168\u7684\u53c2\u6570\uff0c\u4e00\u822c\u90fd\u4e0d\u9700\u8981\u4fee\u6539</p> </li> <li> <p>\u4fee\u6539 wal_bufffers \u4e3a 16MB</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_29","title":"\u603b\u7ed3","text":"<p>PostgreSQL \u91cc\u53ef\u4ee5\u8c03\u6574\u7684\u53c2\u6570\u5dee\u4e0d\u591a\u6709 200 \u4e2a\uff0c\u9488\u5bf9\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u60f3\u628a\u8fd9\u4e9b\u53c2\u6570\u90fd\u8bbe\u7f6e\u4e3a\u6700\u4f73\u51e0\u4e4e\u662f\u4e00\u4ef6\u4e0d\u53ef\u80fd\u7684\u4efb\u52a1\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7684\u6307\u5357 \u4e5f\u53ea\u662f\u4e00\u4e2a\u901a\u5e38\u7684\u8003\u8651\uff0c\u4ee5\u907f\u514d\u5e38\u89c1\u7684\u74f6\u9888\u3002</p> <ul> <li> <p>\u670d\u52a1\u5668\u7684\u7f3a\u7701\u914d\u7f6e\u53c2\u6570\u4f7f\u7528\u975e\u5e38\u5c11\u7684\u5185\u5b58\u4ee5\u53ca\u8bb0\u5f55\u5f88\u5c11\u7684\u4fe1\u606f\uff0c\u8fd9\u4e24\u70b9\u662f\u5fc5\u987b\u8981\u8c03\u6574\u7684</p> </li> <li> <p>\u4e0e\u5185\u5b58\u6709\u5173\u7684\u8c03\u6574\u4e3b\u8981\u662f shared_buffers \u548c work_mem\uff0c\u4ed4\u7ec6\u8c03\u6574\uff0c\u4e3b\u8981\u4e0d\u8981\u51fa\u73b0 OOM(Out   of memory)\u73b0\u8c61</p> </li> <li> <p>\u67e5\u8be2\u8ba1\u5212\u9700\u8981\u77e5\u9053\u5185\u5b58\u72b6\u6001\uff0c\u6709\u597d\u7684\u8868\u4fe1\u606f\u7edf\u8ba1\u6709\u52a9\u4e8e\u67e5\u8be2\u8ba1\u5212\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad</p> </li> <li> <p>autovacuum \u8fdb\u7a0b\u5f88\u5173\u952e\uff0c\u5b83\u786e\u4fdd\u67e5\u8be2\u8ba1\u5212\u80fd\u83b7\u5f97\u6b63\u786e\u7684\u4fe1\u606f</p> </li> <li> <p>\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u53c2\u6570\u7684\u8c03\u6574\u90fd\u4e0d\u9700\u8981\u91cd\u542f\u670d\u52a1\uff0c\u5f88\u591a\u53c2\u6570\u4fee\u6539\u540e\u76f4\u63a5\u751f\u6548</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_30","title":"\u4f8b\u884c\u7ef4\u62a4","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_31","title":"\u6570\u636e\u5e93\u6027\u80fd\u6d4b\u8bd5","text":"<p>\u8fd9\u4e00\u7ae0\u4e3b\u8981\u8ba8\u8bba PostgreSQL \u81ea\u5e26\u7684 pgbench \u7684\u4f7f\u7528</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pgbench","title":"pgbench \u7f3a\u7701\u6d4b\u8bd5","text":"<p>pgbench \u6700\u5f00\u59cb\u662f\u9762\u5411 TPC \u6d4b\u8bd5\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u6d4b\u8bd5TPC-B\uff0c1990 \u5e74\u5f00\u59cb\u5f00\u53d1\uff0c\u5176\u6a21\u578b\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u94f6\u884c \u5e94\u7528\u7a0b\u5e8f\uff0c\u5305\u62ec\u652f\u884c\u3001\u67dc\u5458\u548c\u8d26\u6237\u7b49\u4fe1\u606f\u3002\\ \u5176\u4e3b\u8981\u7684\u8868\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>CREATE TABLE pgbench_branches(bid int not null, bbalance int, filler\nchar(88));\nALTER TABLE pgbench_branches add primary key (bid);\nCREATE TABLE pgbench_tellers(tid int not null,bid int, tbalance\nint,filler char(84));\nALTER TABLE pgbench_tellers add primary key (tid);\nCREATE TABLE pgbench_accounts(aid int not null,bid int, abalance\nint,filler char(84));\nALTER TABLE pgbench_accounts add primary key (aid);\nCREATE TABLE pgbench_history(tid int,bid int,aid int,delta int, mtime\ntimestamp,filler char(22));\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_32","title":"\u89c4\u6a21\u68c0\u6d4b","text":"<p>\u6a21\u578b\u4e2d\uff0c\u652f\u884c\u7684\u6570\u91cf\u88ab\u79f0\u4e3a\u6570\u636e\u5e93\u89c4\u6a21\uff0c\u6bcf\u4e2a\u652f\u884c\u5305\u62ec 10 \u4e2a\u67dc\u5458\u548c 100,000 \u4e2a\u8d26\u6237\uff0c\u521d\u59cb\u5316\u6570\u636e\u5e93\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u53c2\u6570\u6765\u8bbe\u5b9a\u6570\u636e\u5e93\u7684\u89c4\u6a21\uff0c\u6bd4\u5982:</p> <pre><code>    $ createdb pgbench\n    $ pgbench -i -s 10 pgbench\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u8868\u793a\u7528 10 \u4e2a\u652f\u884c\u7684\u6570\u636e\u5e93\u89c4\u6a21\u586b\u5145\u6570\u636e\u5e93 pgbench\uff0c\u8fd0\u884c\u6d4b\u8bd5\u65f6\uff0c\u5982\u679c\u6267\u884c-s \u7684\u53c2\u6570\uff0c\u5219 pgbench \u91c7\u7eb3\u8fd9\u4e2a\u53c2\u6570\uff0c\u5982\u679c\u6ca1\u6709\u63d0\u4f9b\uff0c\u5219\u901a\u8fc7\u4e0b\u9762\u7684 SQL \u6307\u4ee4\u731c\u6d4b\u6570\u636e\u5e93\u89c4\u6a21: /select count(*) from pgbench_branches;/</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_33","title":"\u67e5\u8be2\u811a\u672c\u5b9a\u4e49","text":"<p>pgbench \u5185\u5efa\u7684\u6807\u51c6\u6d4b\u8bd5\u6240\u9700\u8981\u7684\u811a\u672c\u548c SQL \u8bed\u53e5\u76f4\u63a5\u7f16\u8bd1\u8fdb\u4e86\u7a0b\u5e8f\u4e2d\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9a\u5236\u81ea\u5df1\u9700\u8981\u6d4b\u8bd5\u7684\u811a\u672c\uff0c\u5176\u8be6\u7ec6\u60c5\u51b5\uff0c\u53ef\u4ee5\u53c2\u8003\u5bf9\u5e94\u7684\u6587\u6863\\ \u7f3a\u7701\u7684\u4ea4\u6613\u811a\u672c\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\"TPC-B\"\u4ea4\u6613\uff0c\u5927\u81f4\u7c7b\u4f3c\u4e0b\u9762\u7684\u8bed\u53e5\u7ec4\u6210:</p> <pre><code>\\set nbranches :scale\n\\set ntellers 10 * :scale\n\\set naccounts 100000 * :scale\n\\setrandom aid 1 :naccounts\n\\setrandom bid 1 :nbranches\n\\setrandom tid 1 :ntellers\n\\setrandom delta -5000 5000\nBEGIN;\nUPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;\nSELECT abalance FROM pgbench_accounts WHERE aid = :aid;\nUPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;\nUPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;\nINSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);\nEND;\n</code></pre> <p>\u811a\u672c\u7684\u524d 3 \u884c\u4f9d\u636e:scale \u53d8\u91cf\u8ba1\u7b97\u6709\u591a\u5c11\u652f\u884c\u3001\u67dc\u5458\u4ee5\u53ca\u8d26\u6237\u3002\u63a5\u4e0b\u6765 4 \u884c\u521b\u5efa\u968f\u673a\u6570\uff0c\u6a21\u62df\u94f6\u884c\u4ea4\u6613\u3002\u811a\u672c\u7684\u6838\u5fc3\u4ee3\u7801\u662f\u7531 5 \u4e2a\u8bed\u53e5\u7ec4\u6210\u7684\u4e8b\u52a1\uff0c\u6bcf\u4e2a\u8bed\u53e5\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u90fd\u4e0d\u540c:\\</p> update pgbench_accounts <p>\u4f5c\u4e3a\u6570\u636e\u5e93\u4e2d\u6700\u5927\u7684\u8868\uff0c\u5b83\u6700\u6709\u53ef\u80fd\u5f15\u53d1\u78c1\u76d8 I/0 \u74f6\u9888</p> select abalance <p>\u56e0\u4e3a\u4e4b\u524d\u7684 update \u8bed\u53e5\u5df2\u7ecf\u628a\u8be5\u8bed\u53e5\u9700\u8981\u67e5\u8be2\u7684\u4fe1\u606f\u90fd\u7f13\u5b58\u8d77\u6765\u4e86\uff0c\u56e0\u6b64\u5b83\u589e\u52a0\u7684\u5f00\u9500\u5f88\u5c0f</p> update pgbench_tellers <p>\u76f8\u6bd4 accounts \u8868\uff0c\u8fd9\u4e2a\u8868\u5c0f\u5f88\u591a\uff0c\u80fd\u591f\u5728\u7f13\u5b58\u5230\u5185\u5b58\uff0c\u56e0\u6b64\u5b83\u53ef\u80fd\u5bf9\u5f15\u53d1\u9501\u7684\u95ee\u9898</p> update pgbench_branches <p>\u8fd9\u4e2a\u8868\u76f8\u5f53\u5c0f\uff0c\u6574\u4e2a\u5185\u5bb9\u90fd\u53ef\u4ee5\u88ab\u7f13\u5b58\uff0c\u6240\u4ee5\u8bbf\u95ee\u901f\u5ea6\u4e0d\u662f\u95ee\u9898\uff0c\u4f46\u662f\u6b63\u56e0\u4e3a\u5c0f\uff0c\u9501\u6709\u53ef\u80fd\u79f0\u4e3a\u5176\u8bbf\u95ee\u74f6\u9888</p> insert into pgbench_history <p>\u5386\u53f2\u8868\u4f5c\u4e3a\u53ea\u8ffd\u52a0\u8868\uff0c\u8868\u4e0a\u65e0\u7d22\u5f15</p> <p>\u8fd9\u662f\u7f3a\u7701\u6d4b\u8bd5\uff0c\u8fd8\u6709\u4e24\u4e2a\u522b\u7684\u53c2\u6570\u53ef\u4ee5\u7a0d\u5fae\u6539\u53d8\u6d4b\u8bd5\u884c\u4e3a:</p> -N <p>\u548c\u4e0a\u9762\u7684\u6d4b\u8bd5\u76f8\u540c\uff0c\u53ea\u662f\u8df3\u8fc7\u4e24\u4e2a\u5c0f\u8868(tellers,branches)\u7684\u66f4\u65b0\u53c2\u6570\uff0c\u8fd9\u964d\u7ea7\u7684\u9501\u7684\u6f5c\u5728\u95ee\u9898</p> -S <p>\u53ea\u5bf9 accounts \u8868\u505a\u67e5\u8be2\u64cd\u4f5c\uff0c\u56e0\u6b64\u5b83\u4e0d\u9700\u8981\u628a\u8bed\u53e5\u7ec4\u6210\u4e00\u4e2a\u4e8b\u52a1</p> <p>\u4ec5\u505a\u67e5\u8be2\u64cd\u4f5c\u800c\u8df3\u8fc7\u6240\u6709\u7684\u66f4\u65b0\u64cd\u4f5c\u5bf9\u4e8e\u68c0\u67e5\u7f13\u5b58\u5927\u5c0f\uff0c\u6d4b\u8bd5\u6700\u5927 CPU \u901f\u5ea6\u5f88\u6709\u5e2e\u52a9\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pgbench_1","title":"\u4e3a pgbench \u914d\u7f6e\u6570\u636e\u5e93","text":"<p>\u5185\u5efa\u7684\u6d4b\u8bd5\u884c\u4e3a\uff0c\u5176\u4ed6\u8bed\u53e5\u90fd\u5f88\u7b80\u5355\uff1a\u7edd\u5927\u90e8\u5206\u662f\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u67e5\u8be2\uff0c\u6ca1\u6709\u8868\u94fe\u63a5\uff0c\u4e5f\u6ca1\u7528\u8d1f\u8d23\u67e5\u8be2\u7c7b\u578b\u3002\\ \u4f46\u8fd9\u4e9b\u8bed\u53e5\u90fd\u4f1a\u4ea7\u751f\u5f88\u91cd\u7684\u5199\u538b\u529b\uff0c\u9700\u8981\u7f13\u5b58\u80fd\u8ddf\u5f97\u4e0a\\ \u57fa\u4e8e\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u53ef\u4ee5\u8c03\u6574\u7684\u53c2\u6570\u5206\u4e3a\u4e09\u4e2a\u4e3b\u8981\u7c7b\u578b:</p> <ul> <li> <p>\u91cd\u70b9\u5173\u6ce8\u548c\u8c03\u6574\u7684\u53c2\u6570:   shared_buffers,checkpoint_segments,autovacuum,wal_buffers,checkpoint_completion_target</p> </li> <li> <p>\u663e\u8457\u5f71\u54cd\u6d4b\u8bd5\u7ed3\u679c\u7684\u53c2\u6570:   wal_sync_method,synchronouse_commit,wal_writer_delay</p> </li> <li> <p>\u65e0\u5173\u7684:   effective_cache_size,default_statistics_target,work_mem,random_page_cost \u7b49</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_34","title":"\u6570\u636e\u5e93\u7d22\u5f15","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_35","title":"\u67e5\u8be2\u4f18\u5316","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_36","title":"\u586b\u5145\u6837\u4f8b\u6570\u636e","text":"<p>\u4e3a\u4e86\u6f14\u793a\u67e5\u8be2\u4f18\u5316\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u9700\u8981\u586b\u5145\u4e00\u4e9b\u6837\u4f8b\u6570\u636e\uff0cPostgreSQL \u7684 wiki \u4e0a\u7ed9\u51fa\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u6837\u4f8b\u6570\u636e\u5217\u8868\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u94fe\u63a5\uff1ahttp://wiki.postgresql.org/wiki/ Sample_Databases \u8fd9\u91cc\u9009\u53d6 Dell Store 2 \u8fd9\u4e2a\u6709 Dell \u8d21\u732e\u7684\u6837\u4f8b\uff0c\u5b89\u88c5\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <pre><code>wget http://pgfoundry.org/frs/download.php/543/dellstore2-normal-1.0.tar.gz\ntar xvfz dellstore2-normal-1.0.tar.gz\ncd dellstore2-normal-1.0/\ncreatedb dellstore2\ncreatelang plpgsql dellstore2\npsql -f dellstore2-normal-1.0.sql -d dellstore2\npsql -d dellstore2 -c \"VACUUM VERBOSE ANALYZE\"\n</code></pre> <p>\u8be5\u6837\u4f8b\u6570\u636e\u5e93\u5927\u6982 23MB</p> <pre><code>psql -hlocalhost -d dellstore2 -c \"select pg_size_pretty(pg_database_size('dellstore2'))\"\n pg_size_pretty\n----------------\n 23 MB\n(1 row)\n</code></pre> <p>\u5176\u4e3b\u8981\u7684\u8868\u548c\u7d22\u5f15\u5982\u4e0b\uff1a</p> <pre><code>dellstore2=# \\dt+\n        List of relations\n Schema |    Name    |  Size   |\n--------+------------+---------+\n public | categories | 40 kB   |\n public | cust_hist  | 2648 kB |\n public | customers  | 3944 kB |\n public | inventory  | 472 kB  |\n public | orderlines | 3112 kB |\n public | orders     | 832 kB  |\n public | products   | 840 kB  |\n public | reorder    | 0 bytes |\n(8 rows)\n\n\ndellstore2=# \\di+\n            List of relations\n Schema |          Name          |  Size   |\n--------+------------------------+---------+\n public | categories_pkey        | 16 kB   |\n public | customers_pkey         | 456 kB  |\n public | inventory_pkey         | 240 kB  |\n public | ix_cust_hist_customerid| 1336 kB |\n public | ix_cust_username       | 624 kB  |\n public | ix_order_custid        | 280 kB  |\n public | ix_orderlines_orderid  | 1336 kB |\n public | ix_prod_category       | 240 kB  |\n public | ix_prod_special        | 240 kB  |\n public | orders_pkey            | 280 kB  |\n public | products_pkey          | 240 kB  |\n(11 rows)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_37","title":"\u6570\u636e\u5e93\u6d3b\u52a8\u548c\u7edf\u8ba1","text":"<p>PostgreSQL \u6709\u4e00\u4e2a\u7edf\u8ba1\u6536\u96c6\u7684\u5b50\u7cfb\u7edf\uff0c\u5b83\u53ef\u4ee5\u76d1\u63a7\u6570\u636e\u5e93\u5185\u90e8\u5404\u65b9\u9762\u7684\u4fe1\u606f\u3002\u670d\u52a1\u5668\u7684\u6bcf\u4e2a\u5904\u7406\u4f1a\u53d1\u9001\u7edf\u8ba1\u6d88\u606f\u7ed9\u6536\u96c6\u5668\uff0c\u6700\u540e\u7edf\u8ba1\u5668\u6c47\u603b\u6d88\u606f\u5e76\u53d1\u5e03\u3002 \u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u7edf\u8ba1\u5668\u6ca1\u534a\u79d2(\u7f16\u8bd1\u65f6\u6307\u5b9a\u7684\u503c)\u66f4\u65b0\u7edf\u8ba1\u5e76\u53d1\u5e03\uff0c\u6bcf\u4e00\u4e2a\u7edf\u8ba1\u503c\u53ef\u4ee5\u901a\u8fc7\u4e00\u5957\u51fd\u6570\u6765\u8fd4\u56de\uff0c\u8be6\u7ec6\u60c5\u51b5\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u6587\u6863\uff1ahttp://www.postgresql.org/docs/current/static/monitoring-stats.html</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_38","title":"\u7edf\u8ba1\u89c6\u56fe","text":"<p>\u901a\u8fc7\u7ec4\u7ec7\u4e00\u7cfb\u5217\u7684\u89c6\u56fe\uff0c\u4ee5\u65b9\u4fbf\u4eba\u4eec\u80fd\u591f\u5feb\u901f\u8bbf\u95ee\u7edf\u8ba1\u6536\u96c6\u5668\u7684\u8f93\u51fa\uff0c\u9605\u8bfb\u6709\u5173\u89c6\u56fe\u7684\u6e90\u4ee3\u7801\u5bf9\u4e8e\u7406\u89e3\u5176\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u975e\u5e38\u6709\u5e2e\u52a9\uff0c\u5982\u679c\u4f60\u6709 PostgreSQL \u7684\u6e90\u4ee3\u7801\uff0c\u90a3\u4e48\u53ef\u4ee5\u9605\u8bfb src/backend/catalog/system_views.sql \u6587\u4ef6\u3002\u5982\u679c\u4f60\u5df2\u7ecf\u5b89\u88c5\u4e86\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u9605\u8bfb share/system_views.sql\uff0c\u6216\u8005\u4f60\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\u5176\u6e90\u4ee3\u7801:http://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/catalog/system_views.sql \u6211\u4eec\u53ef\u4ee5\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u89c6\u56fe\u6765\u7406\u89e3\u5b83\u4e00\u822c\u662f\u5982\u4f55\u7ec4\u7ec7\u7684\uff0c\u4e0b\u9762\u662f 8.3 \u7248\u672c\u4e2d pg_stat_bgwriter \u89c6\u56fe\u6e90\u4ee3\u7801\uff1a</p> <pre><code>CREATE VIEW pg_stat_bgwriter AS\nSELECT\npg_stat_get_bgwriter_timed_checkpoints() AS checkpoints_timed,\npg_stat_get_bgwriter_requested_checkpoints() AS checkpoints_req,\npg_stat_get_bgwriter_buf_written_checkpoints() AS buffers_checkpoint,\npg_stat_get_bgwriter_buf_written_clean() AS buffers_clean,\npg_stat_get_bgwriter_maxwritten_clean() AS maxwritten_clean,\npg_stat_get_buf_written_backend() AS buffers_backend,\npg_stat_get_buf_alloc() AS buffers_alloc;\n</code></pre> <p>\u8fd9\u4e2a\u89c6\u56fe\u5176\u5b9e\u53ea\u662f\u628a\u5404\u79cd\u72ec\u7acb\u7684\u7edf\u8ba1\u51fd\u6570\u7ec4\u7ec7\u5728\u4e00\u8d77\uff0c\u4ece\u800c\u8f93\u51fa\u4e00\u4e2a\u5b8c\u6574\u7684\u4fe1\u606f\uff0c\u5176\u4ed6\u7edf\u8ba1\u89c6\u56fe\u7ed3\u6784\u4e0a\u4e5f\u548c\u8fd9\u7c7b\u4f3c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_39","title":"\u7d2f\u79ef\u89c6\u56fe\u548c\u5b9e\u65f6\u89c6\u56fe","text":"<p>\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u4fe1\u606f\u53ef\u4ee5\u4ece\u6570\u636e\u5e93\u83b7\u5f97\u76d1\u63a7\u4fe1\u606f\u3002\u4e3b\u8981\u7684\u7edf\u8ba1\u4fe1\u606f\u4fdd\u5b58\u5728\u8ba1\u6570\u5668\u91cc\u3002\u5f53\u4f60\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5e93\u65f6\uff0c\u8ba1\u6570\u5668\u8bbe\u7f6e\u4e3a 0\uff0c\u968f\u7740\u548c\u7edf\u8ba1\u76f8\u5173\u7684\u6d3b\u52a8\u589e\u52a0\u800c\u589e\u52a0\u3002 \u8ba1\u6570\u5668\u5305\u62ec pg_stat_database,pg_stat_bgwriter \u4ee5\u53ca\u6240\u6709\u547d\u540d\u4ee5 pg_stat \u5f00\u5934\u7684\u89c6\u56fe\u3002\\ \u6709\u786e\u5207\u7684\u65b9\u6cd5\u628a\u8ba1\u6570\u5668\u6e05\u96f6\uff0c\u4e0d\u8fc7 PostgreSQL \u7248\u672c\u4e0d\u540c\uff0c\u65b9\u6cd5\u4e0d\u540c\uff1a</p> Version 8.1 <p>pg_stat_reset()\u91cd\u7f6e\u6240\u6709\u7edf\u8ba1\uff0c\u5728 postgresql.conf \u8bbe\u7f6e stats_reset_on_server_start=on \u4f1a\u4f7f\u5f97\u6bcf\u6b21\u6570\u636e\u5e93\u670d\u52a1\u91cd\u542f\u90fd\u5145\u503c\u7edf\u8ba1</p> Version 8.2 <p>pg_stat_reset()\u4ec5\u91cd\u7f6e\u5757\u4ee5\u53ca\u884c\u7ea7\u522b\u7edf\u8ba1\uff0c\u800c stats_reset_on_server_start=on \u5219\u91cd\u7f6e\u6240\u6709\u7edf\u8ba1,\u5305\u62ec\u6570\u636e\u5e93\u7aef\u548c\u96c6\u7fa4\u7aef\u3002</p> Version 8.3,8.4 <p>pg_stat_reset()\u53ea\u91cd\u7f6e\u5f53\u524d\u6570\u636e\u5e93\u7684\u6240\u6709\u7edf\u8ba1\uff0c\u6ca1\u6cd5\u529e\u6cd5\u53ef\u4ee5\u91cd\u7f6e\u96c6\u7fa4\u6bb5\u7684\u7edf\u8ba1\uff0c\u6bd4\u5982 pg_stat_bgwriter\u3002</p> Version 9.0 <p>pg_stat_reset()\u4ec5\u91cd\u7f6e\u5f53\u524d\u6570\u636e\u5e93\u7684\u6240\u6709\u7edf\u8ba1\u3002pg_stat_reset_shared('bgwriter')\u53ef\u4ee5\u91cd\u7f6e pg_stat_bgwriter. pg_stat_reset_single_table_counters() \uff0c pg_stat_reset_single_function_counters()\u53ef\u4ee5\u91cd\u7f6e\u5355\u72ec\u7684\u8868\u3001\u7d22\u5f15\u4ee5\u53ca\u51fd\u6570\u7edf\u8ba1</p> <p>\u77e5\u9053\u7edf\u8ba1\u89c6\u56fe\u91cc\u54ea\u4e9b\u662f\u7d2f\u52a0\u7684\uff0c\u54ea\u4e9b\u662f\u56fa\u5b9a\u7684\uff08\u6bd4\u5982\u8868\u540d\uff09\u5f88\u91cd\u8981\u3002\u4e3a\u4e86\u641e\u6e05\u695a\u7d2f\u52a0\u7684\u5b57\u6bb5\uff0c\u4f60\u53ef\u4ee5\u7528\u5e26\u65f6\u95f4\u6233\u7684\u65b9\u5f0f\u5b9a\u671f\u6293\u53d6\u6570\u636e\uff0c\u7136\u540e\u89c2\u5bdf\u8fd9\u4e9b\u6570\u636e\u5728\u8fd9\u4e2a\u65f6\u95f4\u6bb5\u5185\u662f\u5982\u4f55\u53d8\u5316\u7684\uff0c\u8fd9\u7ae0\u7684\u6700\u540e\u4f1a\u7ed9\u51fa\u4eba\u5de5\u6293\u53d6 pg_stat_bgwriter \u6570\u636e\u3002\\ \u9664\u4e86\u8fd9\u4e9b\u76f4\u89c2\u7684\u7edf\u8ba1\u8ba1\u6570\u5668\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u6570\u636e\u5e93\u6d3b\u52a8\u7684\u5b9e\u65f6\u89c6\u56fe\uff0c\u5b83\u7ed9\u51fa\u4e86\u6570\u636e\u5e93\u6b64\u523b\u6240\u53d1\u751f\u7684\u6d3b\u52a8\u7684\u5feb\u7167\u3002\u8fd9\u4e9b\u89c6\u56fe\u5305\u62ec pg_stat_activity,pg_locks,pg_prepared_xacts.</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_40","title":"\u8868\u7edf\u8ba1","text":"<p>\u6bcf\u4e2a\u8868\u7684\u57fa\u672c\u7edf\u8ba1\u89c6\u56fe\u4e3a pg_stat_all_tables\uff0c\u8fd9\u4e2a\u89c6\u56fe\u4e3a\u4e86\u65b9\u4fbf\u6709\u5206\u6210\u4e86\u4e24\u4e2a\uff0c\u4e00\u4e2a\u662f\u548c\u7cfb\u7edf\u8868\u6709\u5173\u7684 pg_stat_sys_tables\uff0c\u4e00\u4e2a\u662f\u548c\u7528\u6237\u8868 pg_stat_user_tables\u3002\u540e\u8005\u662f\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u7684\u3002\\ \u89c6\u56fe\u7684\u7b2c\u4e00\u4e2a\u7528\u5904\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6570\u636e\u6765\u76d1\u63a7 vacuum \u5728\u4f60\u6570\u636e\u5e93\u91cc\u8fd0\u4f5c\u5f97\u5982\u4f55\u3002\\ \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89c6\u56fe\u6765\u5224\u65ad\u8fd9\u4e9b\u8868\u662f\u5426\u901a\u8fc7\u987a\u5e8f\u626b\u63cf\u6216\u8005\u7d22\u5f15\u626b\u63cf\u8bbf\u95ee\u8fc7</p> <pre><code>pgbench=# select schemaname,relname,seq_scan,idx_scan,\n          cast(idx_scan as numeric) / (idx_scan + seq_scan)\n          as idx_scan_pct from pg_stat_user_tables\n          where (idx_scan + seq_scan) &gt; 0 order by idx_scan_pct;\n\n schemaname |     relname      | seq_scan | idx_scan | idx_scan_pct\n -----------+------------------+----------+----------+---------------\n public     | pgbench_tellers  |        1 |        0 | 0.000000\n public     | pgbench_branches |        4 |        0 | 0.000000\n public     | pgbench_accounts |        1 |   600000 | 0.999998\n(3 rows)\n</code></pre> <p>\u5728\u6781\u5c0f\u7684 pgbench \u6570\u636e\u5e93\u91cc\uff0c\u8bbf\u95ee pgbench_branches \u548c pgbench_tellers \u662f\u901a\u8fc7\u987a\u5e8f\u626b\u63cf\u8bbf\u95ee\u7684\uff0c\u56e0\u4e3a\u4ed6\u4eec\u90fd\u5f88\u5c0f\uff0c\u53ef\u4ee5\u8f7d\u5165\u5230\u4e00\u4e2a\u6570\u636e\u9875\u5185\u3002\u800c pgbench_accounts \u5c31\u5f88\u5927\u4e86\uff0c\u56e0\u6b64 select \u8bed\u53e5\u8bbf\u95ee\u65f6\uff0c\u9700\u8981\u901a\u8fc7\u7d22\u5f15\u6765\u67e5\u8be2\u6570\u636e\u3002\\ \u6211\u4eec\u5bf9\u8868\u66f4\u611f\u5174\u8da3\u7684\u662f\u786e\u5207\u7684\u77e5\u9053\u8fd9\u4e2a\u8868\u88ab\u8fd9\u4e9b\u626b\u9762\u6240\u5904\u7406\u8fc7\u7684\u5143\u7ec4,\u4e0b\u9762\u7684\u89c6\u56fe\u67e5\u8be2\u53ef\u4ee5\u83b7\u5f97\u8fd9\u4e9b\u4fe1\u606f\uff1a</p> <pre><code>pgbench=# select relname,seq_tup_read,idx_tup_fetch,\n          cast(idx_tup_fetch as numeric) / (idx_tup_fetch + seq_tup_read)\n          as idx_tup_pct\n          from pg_stat_user_tables\n          where (idx_tup_fetch +seq_tup_read) &gt; 0 order by idx_tup_pct;\n\n     relname      | seq_tup_read | idx_tup_fetch | idx_tup_pct\n------------------+--------------+---------------+--------------\n pgbench_tellers  |          500 |             0 | 0.000000\n pgbench_branches |          200 |             0 | 0.000000\n pgbench_accounts |      5000000 |        600000 | 0.107143\n(3 rows)\n</code></pre> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u7528\u6765\u67e5\u8be2\u70ed(HOT)\u6570\u636e\u591a\u957f\u65f6\u95f4\u88ab\u7528\u6765\u66f4\u65b0:</p> <pre><code>pgbench=# select relname,n_tup_upd,n_tup_hot_upd,\n          cast(n_tup_hot_upd as numeric) / n_tup_upd as hot_pct\n          from pg_stat_user_tables\n          where n_tup_upd &gt; 0 order by hot_pct;\n\n     relname      | n_tup_upd | n_tup_hot_upd | hot_pct\n------------------+-----------+---------------+-----------\n pgbench_accounts |     24681 |          3431 | 0.139014\n pgbench_tellers  |     24681 |         24428 | 0.989749\n pgbench_branches |     24680 |         24680 | 1.000000\n(3 rows)\n</code></pre> <p>\u4ece\u8f93\u51fa\u6765\u770b\uff0cpgbench_tellers \u548c pgbench_branches \u7684\u6570\u636e\u66f4\u65b0\u51e0\u4e4e\u5168\u90e8\u5728\u70ed\u6570\u636e\u4e2d\u5b8c\u6210\uff0c\u8fd9\u6709\u7740\u5f88\u9ad8\u7684\u6548\u7387\uff0c\u4f46\u662f\u5bf9\u4e8e\u5927\u8868 pgbench_accounts \u800c\u8a00\uff0c\u70ed\u6570\u636e\u7684\u66f4\u65b0\u76f8\u6bd4\u6240\u6709\u6570\u636e\u7684\u66f4\u65b0\uff0c\u6bd4\u7387\u5f88\u4f4e\uff0c\u4ece\u800c\u6027\u80fd\u4e0d\u9ad8\uff0c\u56e0\u6b64\u9700\u8981\u8c03\u6574\u3002\\ \u6700\u540e\u4e00\u4e2a\u597d\u5904\u662f\u53ef\u4ee5\u901a\u8fc7\u89c6\u56fe\u6765\u601d\u8003\u5728\u8868\u4e0a\u63d2\u5165/\u66f4\u65b0/\u5220\u9664\u7684\u7279\u5f81:</p> <pre><code>pgbench=# SELECT relname,\n(cast(n_tup_ins AS numeric)/(n_tup_ins + n_tup_upd + n_tup_del))::numeric(6,5) AS ins_pct,\n(cast(n_tup_upd AS numeric)/(n_tup_ins + n_tup_upd + n_tup_del))::numeric(6,5) AS upd_pct,\n(cast(n_tup_del AS numeric)/(n_tup_ins+ n_tup_upd + n_tup_del))::numeric(6,5) AS del_pct\nFROM pg_stat_user_tables ORDER BY relname;\n\n     relname      | ins_pct | upd_pct | del_pct\n------------------+---------+---------+---------\n pgbench_accounts | 0.97916 | 0.02084 | 0.00000\n pgbench_branches | 0.00052 | 0.99948 | 0.00000\n pgbench_history  | 1.00000 | 0.00000 | 0.00000\n pgbench_tellers  | 0.00516 | 0.99484 | 0.00000\n(4 rows)\n</code></pre> <p>\u8fd9\u4e2a\u8f93\u51fa\u8bc1\u5b9e\u4e86 pgbench_history \u662f\u6211\u4eec\u4e4b\u524d\u79f0\u4e4b\u4e3a\u7684\u53ea\u9644\u52a0\u8868\uff0c\u5728\u8fd9\u4e2a\u8868\u4e0a\u53ea\u6709\u63d2\u5165\uff0c\u6c38\u8fdc\u90fd\u4e0d\u4f1a\u6709\u66f4\u65b0\u548c\u5220\u9664\u3002\u5b83\u4e5f\u6697\u793a\u4e86 pgbench_branches \u548c pgbench_tellers \u6709\u5927\u91cf\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u800c\u63d2\u5165\u64cd\u4f5c\u5fae\u4e4e\u5176\u5fae\uff0c\u5220\u9664\u64cd\u4f5c\u5219\u6839\u672c\u5c31\u6ca1\u6709\u3002 \u8fd9\u4e9b\u4fe1\u606f\u5bf9\u4e8e\u6211\u4eec\u5224\u65ad\u8868\u662f\u5426\u9700\u8981\u5468\u671f\u6027\u7684\u6267\u884c reindex \u64cd\u4f5c\u5f88\u6709\u5e2e\u52a9\u3002 \u540c\u6837\u7684\uff0c\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\u7684\u6bd4\u7387\u89c2\u5bdf\uff0c\u4e5f\u53ef\u4ee5\u8ba9\u6211\u4eec\u601d\u8003\u5982\u679c\u8fd9\u4e2a\u6bd4\u8f83\u8f83\u9ad8\uff0c\u5219\u53ef\u4ee5\u6267\u884c\u8bf8\u5982 CLUSTER \u64cd\u4f5c\u6765\u6e05\u7406\u7a7a\u95f4\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#io_1","title":"\u8868 I/O","text":"<p>pg_statio_all_tables(pg_statio_user_tables/pg_statio_sys_tables)\u7528\u6765\u96c6\u4e2d\u7edf\u8ba1\u6570\u636e\u5e93\u4e0a\u7684\u7269\u7406 I/O\u3002 \u7b2c\u4e00\u5bf9\u8981\u76d1\u63a7\u7684\u5b57\u6bb5\u662f\u7528 shared_buffers \u6765\u7f13\u5b58\u8868\u6570\u636e\u7684\u7ed3\u6784\uff0c\u5728\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u91cc\u79f0\u4e3a\u5806(heap)\uff0c\u5f53\u53d1\u751f\u4e00\u4e2a\u8bfb\u64cd\u4f5c\u65f6\uff0c\u6570\u636e\u5224\u65ad\u662f\u8bfb\u53d6\u6570\u636e\u5e93\u7f13\u5b58(heap block hit)\u5757\u8fd8\u662f\u8981\u6c42\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u8bfb(heap block read)\u624d\u80fd\u6ee1\u8db3\u8981\u6c42\u3002</p> <pre><code>pgbench=# select relname,\n(cast(heap_blks_hit as numeric)/(heap_blks_hit + heap_blks_read))::numeric(6,5) as hit_pct,\nheap_blks_hit,heap_blks_read\nfrom pg_statio_user_tables\nwhere (heap_blks_hit + heap_blks_read) &gt; 0 order by hit_pct;\n\n     relname      | hit_pct | heap_blks_hit | heap_blks_read\n------------------+---------+---------------+----------------\n pgbench_accounts | 0.59564 |        906335 |         615280\n pgbench_history  | 0.99316 |        109787 |            756\n pgbench_tellers  | 0.99977 |        197282 |             46\n pgbench_branches | 0.99988 |        280172 |             34\n(4 rows)\n</code></pre> <p>\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684 heap blocks read \u90fd\u4f1a\u8f6c\u5316\u4e3a\u7269\u7406\u78c1\u76d8 I/O\uff0c\u4ed6\u4eec\u6709\u53ef\u80fd\u662f\u4ece\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\u8bfb\u53d6\u3002\u5f53\u524d\uff0c\u6570\u636e\u5e93\u6ca1\u6709\u529e\u6cd5\u77e5\u9053\u5230\u5e95\u662f\u54ea\u79cd\u8bfb\u53d6\u65b9\u5f0f\u3002 \u4e0d\u8fc7\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\\\"Dtrace\\\"\u8fd9\u6837\u7684\u5de5\u5177\u6765\u8ddf\u8e2a\u8bfb\u64cd\u4f5c\uff0c\u800c\u4ece\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad\u3002\\ \u67e5\u8be2\u8868\u4e0a\u6bcf\u4e2a\u7d22\u5f15\u6240\u7528\u5230\u7684\u78c1\u76d8 I/O \u8bed\u53e5\u5982\u4e0b\uff1a</p> <pre><code>pgbench=# select relname,\n(cast(idx_blks_hit as numeric)/(idx_blks_hit + idx_blks_read))::numeric(6,5) as hit_pct,\nidx_blks_hit,idx_blks_read\nfrom pg_statio_user_tables\nwhere (idx_blks_hit + idx_blks_read) &gt; 0 order by hit_pct;\n\n     relname      | hit_pct | idx_blks_hit | idx_blks_read\n------------------+---------+--------------+---------------\n pgbench_branches | 0.91667 |           77 |             7\n pgbench_accounts | 0.97414 |      2555866 |         67839\n pgbench_tellers  | 0.99990 |       194106 |            19\n(3 rows)\n</code></pre> <p>\u8fd9\u91cc\u770b\u4e0d\u5230 pgbench_history \u8868\u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u8868\u6ca1\u6709\u7d22\u5f15\u3002\\ \u8868 I/O \u7edf\u8ba1\u4e5f\u53ef\u4ee5\u5305\u62ec TOAST \u8868\u7684\u7edf\u8ba1\uff0c\u67e5\u8be2\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>pgbench=#select relname,\n(heap_blks_read + toast_blks_read + tidx_blks_read) as total_blks_read,\n(heap_blks_hit + toast_blks_hit + tidx_blks_hit) as total_blks_hit\nfrom pg_statio_user_tables;\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_41","title":"\u7d22\u5f15\u7edf\u8ba1","text":"<p>pg_stat_all_indexes(pg_stat_user_indexes/pg_stat_sys_indexes)\u89c6\u56fe\u7528\u4e8e\u7edf\u8ba1\u7d22\u5f15\u4fe1\u606f\uff0c\u5b83\u7ed9\u51fa\u7684\u5305\u62ec\u5305\u62ec\u6709\u591a\u5c11\u7d22\u5f15\u626b\u63cf\u88ab\u5904\u7406\u4ee5\u53ca\u901a\u8fc7\u7d22\u5f15\u626b\u63cf\u8fd4\u56de\u4e86\u591a\u5c11\u884c\u6570\u636e\u3002\\ \u8fd9\u4e2a\u89c6\u56fe\u7684\u5b57\u6bb5\u540d\u5b57\u5f88\u590d\u6742\uff0c\u5f88\u96be\u533a\u5206\u3002\u6bd4\u5982\u4e0b\u9762\u4e24\u4e2a\u5b57\u6bb5\u540d\u5b57\u5dee\u4e0d\u591a\uff0c\u5dee\u522b\u4e5f\u5f88\u7ec6\u5fae\uff1a</p> idx_tup_read <p>\u901a\u8fc7\u7d22\u5f15\u626b\u63cf\u8fd4\u56de\u7684\u7d22\u5f15\u6761\u76ee\u6570</p> idx_tup_fetch <p>\u901a\u8fc7\u8be5\u7d22\u5f15\u6267\u884c\u7b80\u5355\u7d22\u5f15\u626b\u63cf\u540e\u83b7\u53d6\u7684\u8868\u8bb0\u5f55\u6570\u3002\u8fd9\u4e2a\u6570\u901a\u5e38\u6bd4 idx_tup_read \u5c0f\u4e00\u70b9\uff0c\u56e0\u4e3a\u5b83\u4e0d\u5305\u62ec\u6b7b\u7684\u6216\u8005\u8fd8\u6ca1\u6709\u63d0\u4ea4\u7684\u884c\u3002 \u53e6\u5916\uff0c\u8fd9\u91cc\u7684\"\u7b80\u5355\"\u610f\u601d\u662f\u8bf4\u7d22\u5f15\u8bbf\u95ee\u4e0d\u662f\u4f4d\u56fe\u7d22\u5f15\u626b\u63cf(bitmap index scan)</p> <p>\u56e0\u4e3a\u6709\u592a\u591a\u7684\u573a\u666f\u662f idx_tup_fetch \u4e0d\u8bb0\u5f55\u7684\uff0c\u56e0\u6b64\u5982\u679c\u4f60\u60f3\u8ffd\u8e2a\u4e00\u4e2a\u7d22\u5f15\u5230\u5e95\u88ab\u7cfb\u7edf\u4f7f\u7528\u7684\u9891\u7387\u5ea6\u6709\u591a\u5c11\uff0cidx_tup_read \u4f1a\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002\\ \u901a\u8fc7\u8fd9\u4e2a\u89c6\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u8be5\u7d22\u5f15\u626b\u5893\u6240\u8fd4\u56de\u7684\u884c\u8bb0\u5f55\u5e73\u5747\u6570\u4ee5\u53ca\u7d22\u5f15\u662f\u5982\u4f55\u88ab\u4f7f\u7528\u7684:</p> <pre><code>pgbench=# select indexrelname,\n(cast(idx_tup_read as numeric) / idx_scan)::numeric(6,5) as avg_tuples,\nidx_scan,idx_tup_read\nfrom pg_stat_user_indexes\nwhere idx_scan &gt; 0 ;\n\n     indexrelname      | avg_tuples | idx_scan | idx_tup_read\n-----------------------+------------+----------+--------------\n pgbench_tellers_pkey  |    1.00280 |    96437 |        96707\n pgbench_accounts_pkey |    1.07489 |   812874 |       873753\n(2 rows)\n</code></pre> <p>\u8f93\u51fa\u663e\u793a\u57fa\u672c\u4e0a\u6bcf\u6b21\u7d22\u5f15\u626b\u9762\u8fd4\u56de\u4e00\u6761\u8bb0\u5f55\uff0c\u8fd9\u5bf9\u4e8e\u4e3b\u952e\u7d22\u5f15\u800c\u8a00\u5e76\u4e0d\u5947\u602a\u3002avg_tuples \u6bd4 1.0 \u7a0d\u5927\u4e00\u70b9\u70b9\uff0c\u53cd\u6620\u51fa\u7d22\u5f15\u626b\u63cf\u5076\u6709\u626b\u63cf\u5230\u65e0\u6548\u884c\u3002\\ pg_stat_user_indexes \u6240\u7edf\u8ba1\u7684\u4fe1\u606f\u6700\u5927\u7684\u7528\u5904\u662f\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u6240\u6709\u662f\u5426\u88ab\u4f60\u7684\u5e94\u7528\u771f\u6b63\u4f7f\u7528\u3002\u56e0\u4e3a\u7d22\u5f15\u4f1a\u589e\u52a0\u7cfb\u7edf\u7684\u800c\u5916\u5f00\u9500\uff0c\u56e0\u6b64\u5982\u679c\u4e00\u4e2a\u7d22\u5f15\u5e76\u4e0d\u662f\u88ab\u4f7f\u7528\uff0c\u90a3\u5c31\u5e94\u8be5\u5220\u9664\u3002 \u67e5\u627e\u8fd9\u6837\u7684\u7d22\u5f15\u7684\u6700\u7b80\u5355\u529e\u6cd5\u5c31\u662f\u67e5\u8be2 idx_scan \u503c\u5f88\u5c0f\u7684\u6240\u4ee5\u4f60\uff0c\u6bd4\u5982\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>pgbench=# select schemaname,relname,indexrelname,idx_scan,\n          pg_size_pretty(pg_relation_size(i.indexrelid)) as idx_size\n          from pg_stat_user_indexes i join pg_index using (indexrelid)\n          where indisunique is false order by idx_scan,relname;\n\n schemaname | relname | indexrelname | idx_scan | idx_size\n------------+---------+--------------+----------+-----------\n(0 rows)\n</code></pre> <p>\u8fd9\u91cc\u7279\u610f\u6392\u9664\u4e86\u5f3a\u5236\u552f\u4e00\u7ea6\u675f\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u7d22\u5f15\u5373\u4fbf\u5f88\u5c11\u4f7f\u7528\uff0c\u4e5f\u4e0d\u5e94\u8be5\u5220\u9664\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#io_2","title":"\u7d22\u5f15 I/O","text":"<p>\u548c\u8868 I/O \u89c6\u56fe\u7c7b\u4f3c\uff0c\u4e5f\u662f\u5206\u4e3a\u4e09\u4e2a\u89c6\u56fe,\u7528\u6cd5\u4e5f\u5dee\u4e0d\u591a</p> <pre><code>pgbench=# select indexrelname,\n(cast(idx_blks_hit as numeric)/(idx_blks_hit + idx_blks_read))::numeric(6,5) as hit_pct,\nidx_blks_hit,idx_blks_read from pg_statio_user_indexes\nwhere (idx_blks_hit + idx_blks_read) &gt;0 order by hit_pct;\n\n     indexrelname      | hit_pct | idx_blks_hit | idx_blks_read\n-----------------------+---------+--------------+---------------\n pgbench_branches_pkey | 0.91667 |           77 |             7\n pgbench_accounts_pkey | 0.97414 |      2555866 |         67839\n pgbench_tellers_pkey  | 0.99990 |       194106 |            19\n(3 rows)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_42","title":"\u6570\u636e\u5e93\u7edf\u8ba1","text":"<p>\u89c6\u56fe pg_stat_database \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u83b7\u53d6\u6709\u5173\u6570\u636e\u5e93\u7ea7\u522b\u7684\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <pre><code>pgbench=# select datname,blks_read,blks_hit,tup_returned,\n          tup_fetched,tup_inserted as tup_ins,\n          tup_updated as tup_upd,tup_deleted as tup_del\n          from pg_stat_database\n          where datname = 'pgbench';\n\n datname | blks_read | blks_hit | tup_returned | tup_fetched | tup_ins | tup_upd | tup_del\n---------+-----------+----------+--------------+-------------+---------+---------+-------------\n pgbench |    689749 | 11227681 |     19441670 |     1515691 | 5319222 |  635663 |  100\n(1 row)\n</code></pre> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u8bd5\u56fe\u8fd8\u6709\u4e00\u4e9b\u6709\u7528\u7684\u4e8b\u52a1\u63d0\u4ea4\u7edf\u8ba1\u4fe1\u606f\u3002</p> <pre><code>pgbench=# select datname,numbackends,xact_commit,xact_rollback\n          from pg_stat_database;\n  datname   | numbackends | xact_commit | xact_rollback\n------------+-------------+-------------+---------------\n template1  |           0 |       26616 |             2\n template0  |           0 |           0 |             0\n postgres   |           0 |       27441 |           337\n wgzhao     |           0 |       31578 |           302\n test       |           0 |       27711 |            45\n pgbench    |           1 |      840155 |            25\n db1        |           0 |           0 |             0\n db2        |           0 |           0 |             0\n dellstore2 |           0 |        1317 |             1\n(9 rows)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_43","title":"\u8fde\u63a5\u548c\u6d3b\u52a8","text":"<p>pg_stat_activity \u63d0\u4f9b\u4e86\u6bcf\u4e00\u4e2a\u5ba2\u6237\u7aef\u5f53\u524d\u5728\u670d\u52a1\u5668\u4e0a\u7684\u6d3b\u52a8\u5feb\u7167\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89c6\u56fe\u6765\u67e5\u770b\u4e00\u4e2a\u540e\u53f0\u8fdb\u7a0b\u8fd0\u884c\u4e86\u591a\u4e45\u5df2\u7ecf\u6b64\u523b\u662f\u5426\u6b63\u5728\u7b49\u5f85\u4ec0\u4e48:</p> <pre><code>pgbench=# select pid,waiting,\n          current_timestamp - least(query_start,xact_start) as runtime,\n          substr(query,1,25) as current_query\n          from pg_stat_activity\n          where not pid = pg_backend_pid();\n\n  pid  | waiting |     runtime     |       current_query\n-------+---------+-----------------+---------------------------\n 11987 | f       | 00:00:00.005063 | END;\n 11989 | f       | 00:00:00.00341  | UPDATE pgbench_tellers SE\n 11988 | f       | 00:00:00.017561 | END;\n 11991 | f       | 00:00:00.002855 | UPDATE pgbench_tellers SE\n 11990 | f       | 00:00:00.002629 | UPDATE pgbench_accounts S\n 11992 | f       | 00:00:00.002998 | UPDATE pgbench_tellers SE\n 11993 | f       | 00:00:00.002823 | UPDATE pgbench_accounts S\n 11994 | f       | 00:00:00.003072 | UPDATE pgbench_branches S\n 11995 | f       | 00:00:00.002469 | UPDATE pgbench_tellers SE\n 11996 | f       | 00:00:00.002852 | UPDATE pgbench_tellers SE\n(10 rows)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_44","title":"\u78c1\u76d8\u4f7f\u7528","text":"<p>\u83b7\u5f97\u4e00\u4e2a\u8868\u6216\u8005\u7d22\u5f15\u4f7f\u7528\u4e86\u591a\u5c11\u78c1\u76d8\u7a7a\u95f4\u7684\u6700\u57fa\u672c\u65b9\u6cd5\u662f\u8fd0\u884c pg_relation_size()\u51fd\u6570\uff0c\u5b83\u7ecf\u5e38\u548c pg_size_pretty()\u51fd\u6570\u8054\u5408\uff0c\u4ee5\u4fbf\u8f93\u51fa\u65b9\u4fbf\u9605\u8bfb\u7684\u5927\u5c0f\u3002</p> <p>\u6bd4\u5982\u4e0b\u7684\u4f8b\u5b50\u5c31\u662f\u67e5\u8be2\u5f53\u524d\u6570\u636e\u5e93\u4e0b\u6240\u6709\u7684\u8868\u6240\u4f7f\u7528\u7684\u78c1\u76d8\u5927\u5c0f\uff1a</p> <pre><code>pgbench=# select relname,\n       pg_size_pretty(pg_relation_size(C.oid)) as \"size\"\n       from pg_class C\n       left join pg_namespace N on (N.oid = C.relnamespace)\n       where relnamespace not in\n       (select oid from pg_namespace where nspname = 'pg_catalog'\n            or nspname = 'informantion_schema')\n       order by pg_relation_size(C.oid) desc limit 10;\n\n        relname        |  size\n-----------------------+---------\n pgbench_accounts      | 650 MB\n pgbench_accounts_pkey | 107 MB\n pgbench_history       | 3088 kB\n pg_toast_2618         | 320 kB\n sql_features          | 56 kB\n pgbench_tellers       | 40 kB\n pgbench_tellers_pkey  | 40 kB\n pgbench_branches      | 24 kB\n pg_toast_2619         | 16 kB\n pgbench_branches_pkey | 16 kB\n(10 rows)\n</code></pre> <p>\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u4e3b\u8981\u95ee\u9898\u662f\u8868\u5927\u5c0f\u91cc\u6ca1\u6709\u5305\u542b TOAST \u8868\u7684\u5927\u7b11\uff0c\u867d\u7136\u53ef\u4ee5\u4f7f\u7528 pg_total_relation_size()\uff0c\u4f46\u662f\u5979\u53c8\u5305\u542b\u4e86\u7d22\u5f15\u5927\u5c0f\u3002</p> <p>PostgreSQL 9.0 \u4ee5\u540e\uff0c\u6709\u4e00\u4e2a\u540d\u4e3a pg_table_size()\u7684\u51fd\u6570\u5305\u62ec\u4e86\u9664\u7d22\u5f15\u5916\u7684\u6240\u6709\u5176\u4ed6\u8868\u4fe1\u606f\u3002\u800c pg_indexes_size()\u5219\u7ed9\u51fa\u4e86\u4e00\u4e2a\u8868\u7684\u6240\u6709\u7d22\u5f15\u5927\u5c0f\u3002 \u8fd9\u4e9b\u51fd\u6570\u6240\u8ba1\u7b97\u7684\u5927\u5c0f\u5173\u7cfb\u5982\u4e0b\uff1a</p> <pre><code>    pg_total_relation_size = pg_table_size + pg_indexes_size\n    pg_table_size = pg_relation_size + toast table + toast indexes + FSM\n</code></pre> <p>\u4e0b\u9762\u7684\u67e5\u8be2\u663e\u793a\u4e86 TOAST \u548c\u7d22\u5f15\u5927\u5c0f:</p> <pre><code>pgbench=# select relname,relkind as \"type\",pg_size_pretty(pg_table_size(C.oid)) as size,\n          pg_size_pretty(pg_indexes_size(C.oid)) as idxsize,\n          pg_size_pretty(pg_total_relation_size(C.oid)) as \"total\"\n          from pg_class C left join pg_namespace N on (N.oid= C.relnamespace)\n          where C.relnamespace not in (11,11728,99) and relkind in ('r','i')\n          order by pg_total_relation_size(C.oid) desc limit 20;\n\n        relname        | type |  size   | idxsize |  total\n-----------------------+------+---------+---------+---------\n pgbench_accounts      | r    | 650 MB  | 107 MB  | 757 MB\n pgbench_accounts_pkey | i    | 107 MB  | 0 bytes | 107 MB\n pgbench_history       | r    | 3112 kB | 0 bytes | 3112 kB\n pgbench_tellers       | r    | 72 kB   | 40 kB   | 112 kB\n pgbench_branches      | r    | 56 kB   | 16 kB   | 72 kB\n pgbench_tellers_pkey  | i    | 40 kB   | 0 bytes | 40 kB\n pgbench_branches_pkey | i    | 16 kB   | 0 bytes | 16 kB\n(7 rows)\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#checkpoint","title":"\u7f13\u5b58,\u540e\u53f0\u5199\u4ee5\u53ca checkpoint","text":"<p>pg_stat_bgwriter \u53ef\u4ee5\u8ba9\u6211\u4eec\u8ffd\u8e2a\u6bcf\u4e2a\u6570\u636e\u9875\u5728\u7f13\u5b58\u5185\u5916\u7684\u6d41\u5411\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8be5\u89c6\u56fe\u56de\u7b54\u4e0b\u9762\u7684\u95ee\u9898\uff1a</p> <ul> <li> <p>\u6267\u884c checkpoint \u7684\u65f6\u95f4\u4e2d\uff0c\u57fa\u4e8e\u6d3b\u52a8\u7684\u8bf7\u6c42\u5360\u6bd4\u591a\u5c11\uff0c\u57fa\u4e8e\u65f6\u95f4\u95f4\u9694\u7684\u6bd4\u4f8b\u53c8\u662f\u591a\u5c11\uff1f</p> </li> <li> <p>\u5e73\u5747 checkpoint \u5199\u51fa\u591a\u5c11\u6570\u636e\uff1f</p> </li> <li> <p>\u5199\u51fa\u7684\u6570\u636e\u4e2d\uff0ccheckpoint \u548c\u540e\u53f0\u5199\u5206\u522b\u5360\u6bd4\u591a\u5c11\uff1f</p> </li> </ul> <pre><code>pgbench#SELECT\n  (100 * checkpoints_req) / (checkpoints_timed + checkpoints_req)\n    AS checkpoints_req_pct,\n  pg_size_pretty(buffers_checkpoint * block_size / (checkpoints_timed +\n       checkpoints_req))\n    AS avg_checkpoint_write,\n  pg_size_pretty(block_size * (buffers_checkpoint + buffers_clean +\n       buffers_backend)) AS total_written,\n  100 * buffers_checkpoint / (buffers_checkpoint + buffers_clean +\n      buffers_backend) AS checkpoint_write_pct,\n  100 * buffers_backend / (buffers_checkpoint + buffers_clean +\n        buffers_backend) AS backend_write_pct,\n  *\nFROM pg_stat_bgwriter,(SELECT cast(current_setting('block_size') AS integer)\n     AS block_size) AS bs;\n\n-[ RECORD 1 ]---------+------------------------------\ncheckpoints_req_pct   | 1\navg_checkpoint_write  | 742 kB\ntotal_written         | 4588 MB\ncheckpoint_write_pct  | 43\nbackend_write_pct     | 56\ncheckpoints_timed     | 2713\ncheckpoints_req       | 38\ncheckpoint_write_time | 2475096\ncheckpoint_sync_time  | 253253\nbuffers_checkpoint    | 255206\nbuffers_clean         | 0\nmaxwritten_clean      | 0\nbuffers_backend       | 332040\nbuffers_backend_fsync | 0\nbuffers_alloc         | 503829\nstats_reset           | 2012-08-14 17:00:19.529427+08\nblock_size            | 8192\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u6765\u770b\uff0c\u53ea\u6709 1%\u7684 checkpoint \u662f\u56e0\u4e3a\u8fbe\u5230\u4e86 WAL \u8fbe\u5230\u4e86\u9700\u8981\u5199\u51fa\u7684\u8981\u6c42\uff0c\u800c\u7edd\u5927\u90e8\u5206 checkpoint \u90fd\u662f\u56e0\u4e3a checkpoint_timeout \u53c2\u6570\u6240\u8bbe\u7f6e\u7684 \u95f4\u9694\u65f6\u95f4\u6765\u4e34\u800c\u6267\u884c\u7684\u3002</p> <p>checkpoint \u5e73\u5747\u5199\u51fa\u7684\u6570\u636e\u662f 742KB\uff0c\u76f8\u5f53\u5c0f\u3002</p> <p>56%\u7684\u6570\u636e\u5199\u51fa\u662f\u540e\u53f0\u5199\u8fdb\u7a0b\uff0c\u8fd9\u6697\u793a\u8fd9\u7cfb\u7edf\u7684\u914d\u7f6e\u8fd8\u4e0d\u8db3\u591f\u597d\uff0c\u6211\u4eec\u5e94\u8be5\u66f4\u591a\u4f7f\u7528 checkpoint \u6765\u5199\u51fa\u6570\u636e\u3002\u53d1\u751f\u8fd9\u4e2a\u60c5\u51b5\u7684\u539f\u56e0\u53ef\u80fd\u662f shared_buffers \u914d\u5f97\u5c0f\u4e86\u70b9\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pg_stat_bgwriter","title":"\u4fdd\u5b58 pg_stat_bgwriter \u5feb\u7167","text":"<p>\u4e3a\u4e86\u4f7f\u4e0a\u8ff0\u7edf\u8ba1\u6570\u636e\u66f4\u6709\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u671f\u4fdd\u5b58\u5feb\u7167\uff0c\u6211\u4eec\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u8868\uff0c\u7136\u540e\u628a\u5feb\u7167\u5199\u5165\u8868\u5373\u53ef\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>pgbench=# create table pg_stat_bgwriter_snapshot as\n          select current_timestamp,* from pg_stat_bgwriter;\nSELECT 1\npgbench=# insert into pg_stat_bgwriter_snapshot\n         (select current_timestamp,* from pg_stat_bgwriter);\nINSERT 0 1\n</code></pre> <p>\u6211\u4eec\u5e94\u8be5\u81f3\u5c11\u4fdd\u5b58\u4e00\u4e2a\u5c0f\u65f6\u7684\u5feb\u7167\u4fe1\u606f\uff0c\u4e00\u5929\u66f4\u597d\u3002\u8fd9\u6837\u6211\u4eec\u624d\u6709\u53ef\u80fd\u901a\u8fc7\u8fd9\u4e9b\u5feb\u7167\u83b7\u5f97\u4e00\u4e9b\u66f4\u6709\u7528\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a</p> <pre><code>SELECT\n  cast(date_trunc('minute',start) AS timestamp) AS start,\n  date_trunc('second',elapsed) AS elapsed,\n  date_trunc('second',elapsed / (checkpoints_timed + checkpoints_req)) AS\n    avg_checkpoint_interval,\n  (100 * checkpoints_req) / (checkpoints_timed + checkpoints_req)\n    AS checkpoints_req_pct,\n  100 * buffers_checkpoint / (buffers_checkpoint + buffers_clean +\n     buffers_backend) AS checkpoint_write_pct,\n  100 * buffers_backend / (buffers_checkpoint + buffers_clean +\n       buffers_backend) AS backend_write_pct,\n  pg_size_pretty(buffers_checkpoint * block_size / (checkpoints_timed +\n      checkpoints_req))\n    AS avg_checkpoint_write,\n  pg_size_pretty(cast(block_size * (buffers_checkpoint + buffers_clean +\n      buffers_backend) / extract(epoch FROM elapsed) AS int8))\n          AS written_per_sec,\n  pg_size_pretty(cast(block_size * (buffers_alloc) / extract(epoch FROM\n      elapsed) AS int8)) AS alloc_per_sec\nFROM\n( SELECT\n  one.now AS start,\n  two.now - one.now AS elapsed,\n  two.checkpoints_timed - one.checkpoints_timed AS checkpoints_timed,\n  two.checkpoints_req - one.checkpoints_req AS checkpoints_req,\n  two.buffers_checkpoint - one.buffers_checkpoint AS buffers_checkpoint,\n  two.buffers_clean - one.buffers_clean AS buffers_clean,\n  two.maxwritten_clean - one.maxwritten_clean AS maxwritten_clean,\n  two.buffers_backend - one.buffers_backend AS buffers_backend,\n  two.buffers_alloc - one.buffers_alloc AS buffers_alloc,\n  (SELECT cast(current_setting('block_size') AS integer)) AS block_size\n  FROM pg_stat_bgwriter_snapshot one\n  INNER JOIN pg_stat_bgwriter_snapshot two\n    ON two.now &gt; one.now\n) bgwriter_diff\nWHERE (checkpoints_timed + checkpoints_req) &gt; 0;\n\nstart                   | 2010-04-09 19:52:00\nelapsed                 | 00:17:54\navg_checkpoint_interval | 00:03:34\ncheckpoints_req_pct     | 80\ncheckpoint_write_pct    | 85\nbackend_write_pct       | 14\navg_checkpoint_write    | 17 MB\nwritten_per_sec         | 94 kB\nalloc_per_sec           | 13 kB\n</code></pre> <p>\u4ece\u8f93\u51fa\u6765\u770b\uff0c\u6709 80%\u7684 checkpoint \u88ab\u8c03\u7528\uff0c\u56e0\u4e3a\u7cfb\u7edf\u5199\u6ee1\u4e86 WAL,checkpoint \u7684\u8c03\u7528\u5e73\u5747\u95f4\u9694\u65f6\u95f4\u4e3a 3.5 \u5206\u949f\uff0c\u76f8\u5f53\u9891\u7e41\u3002\u5e78\u8fd0\u7684\u662f\uff0c\u5927\u90e8\u5206\u7f13\u5b58\u90fd\u88ab\u5199\u51fa\uff1b 85%\u7684\u7f13\u5b58\u6709 checkpoint \u5199\u51fa\uff0c\u8fd9\u5f88\u597d\uff0c\u56e0\u4e3a checkpoint \u5199\u7b97\u662f\u6700\u6709\u6548\u7387\u7684\u4e00\u79cd\u3002\u6bcf\u4e00\u4e2a checkpint \u5e73\u5747\u5199\u51fa 17MB \u6570\u636e\u3002\u4f46\u662f\u4f60\u8ba1\u7b97\u6240\u6709\u7684\u5199\u64cd\u4f5c\uff0c\u8fd4\u73b0\u5199\u5230\u78c1\u76d8\u7684\u901f\u7387 \u53ea\u6709 94kB/s\uff0c\u8fd9\u76f8\u5f53\u4f4e\u3002\u5728\u8bfb\u65b9\u9762\uff0c\u7f13\u5b58\u4e2d 13kB/s \u7684\u901f\u5ea6\u88ab\u6570\u636e\u5e93\u5206\u914d\u7528\u6765\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u6301\u7eed 46 \u5206\u949f\u7684\u5feb\u7167\u8f93\u51fa\u5982\u4e0b,\u8fd9\u4e2a\u9636\u6bb5\u57fa\u672c\u4e0a\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001:</p> <pre><code>start                   | 2010-04-09 20:10:00\nelapsed                 | 00:46:26\navg_checkpoint_interval | 00:05:09\ncheckpoints_req_pct     | 0\ncheckpoint_write_pct    | 100\nbackend_write_pct       | 0\navg_checkpoint_write    | 910 bytes\nwritten_per_sec         | 3 bytes\nalloc_per_sec           | 0 bytes\n</code></pre> <p>\u6ce8\u610f\u5230 checkpoint \u7684\u5e73\u5747\u95f4\u9694\u662f 5 \u5206\u949f\uff0c\u800c\u8fd9\u6070\u597d\u662f checkpoint_timeout \u503c\uff0c\u8fd9\u8bf4\u660e\u8fd9\u4e9b checkpoint \u5b8c\u5168\u662f\u7531\u8d85\u65f6\u9a71\u52a8\u3002</p> <p>\u8fd9\u91cc\u7684 alloc_per_sec \u6bd4\u7387\u5e76\u4e0d\u6b63\u597d\u540c\u7b49\u4e8e\u4ece OS \u7f13\u5b58\u7684\u8bfb\u53d6\u7387\uff0c\u4e0d\u8fc7\u5b83\u6697\u793a\u4e86\u5185\u90e8\u7f13\u5b58\u88ab\u91cd\u7528\u7684\u9891\u7387\u3002</p> <p>written_per_sec \u503c\u662f\u628a\u6570\u636e\u5e93\u8868\u548c\u7d22\u5f15\u5199\u5165\u5230\u78c1\u76d8\u7684\u5e73\u5747\u503c\uff0c\u5b83\u5e94\u8be5\u975e\u5e38\u63a5\u8fd1\u64cd\u4f5c\u7cfb\u7edf\u7cfb\u7edf\u7684\u5e73\u5747\u5199\u5165\u78c1\u76d8\u7684\u6570\u503c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_45","title":"\u4f7f\u7528\u540e\u53f0\u5199\u7edf\u8ba1\u8c03\u4f18","text":"<p>\u5229\u7528\u540e\u53f0\u5199\u7edf\u8ba1\u4fe1\u606f\u6765\u8c03\u6574\u548c checkpoint \u4ee5\u53ca\u7f13\u5b58\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u5b9a\u671f\u6536\u96c6 pg_stat_bgwriter \u5feb\u7167\uff0c\u8fd9\u6837\u5c31\u83b7\u5f97\u4e00\u4e2a\u6027\u80fd\u57fa\u7ebf\uff0c\u6b64\u540e\uff0c\u6bcf\u6b21\u4fee\u6539\u53c2\u6570\uff0c\u91cd\u65b0\u4ea7\u751f\u5feb\u7167\uff0c\u8fdb\u884c\u5bf9\u6bd4\u3002\u4f9d\u6b21\u5faa\u73af\uff0c\u627e\u5230\u6700\u4f18\u53c2\u6570</p> </li> <li> <p>\u589e\u52a0 checkpoint_segments \u503c\u76f4\u5230\u51e0\u4e4e\u6240\u6709\u7684 checkpoints \u90fd\u662f\u6309\u8d85\u65f6\u9a71\u52a8\u7684\uff0c\u800c\u4e0d\u662f\u6309 activity \u9a71\u52a8\u3002\u6700\u7ec8\uff0c90%\u4ee5\u4e0a\u5e94\u8be5\u57fa\u4e8e\u8d85\u65f6     \u800c avg_checkpoint_interval \u5e94\u8be5\u63a5\u8fd1 5 \u5206\u949f\uff08\u6216\u8005\u662f\u4f60\u8bbe\u7f6e\u7684 checkpoint_timeout \u503c\uff09</p> </li> <li> <p>\u589e\u52a0 shared_buffers \u503c\u5728\u7269\u7406\u5185\u5b58\u7684 25%\u4ee5\u4e0a\uff0c\u800c\u540e\u53c2\u8003\u5feb\u7167\uff0c\u4fee\u6539\u8be5\u53c2\u6570</p> </li> <li> <p>\u5f53\u4f60\u7684\u7cfb\u7edf\u6709\u6548\u7684\u4f7f\u7528\u5927\u7f13\u5b58\u65f6\uff0ccheckpoint(\u4e0d\u662f backends \u6216 background     writer)\u6267\u884c\u65f6\uff0c\u7f13\u5b58\u7684\u767e\u5206\u6bd4\u4e5f\u5e94\u8be5\u589e\u52a0\uff0c\u800c\u603b\u7684 I/O     written_per_sec \u53c2\u6570\u5e94\u8be5\u4e0b\u964d\u3002     \u5982\u679c\u6700\u540e\u662f\u901a\u8fc7\u4fee\u6539 shared_buffers \u6765\u8fbe\u5230\u8fd9\u4e2a\u6807\u51c6\uff0c\u5219\u9700\u8981\u8fd4\u56de\u6b65\u9aa4 3\uff0c\u91cd\u590d\u8fd9\u4e9b\u6b65\u9aa4\uff0c\u77e5\u9053\u6027\u80fd\u66f2\u7ebf\u8d8b\u5e73\u3002</p> </li> <li> <p>\u5982\u679c shared_buffers \u4fee\u6539\u7684\u503c\u4e0d\u662f\u90a3\u4e48\u663e\u8457\uff0c\u5219\u8bf4\u660e\u4e4b\u524d\u7684\u503c\u5bf9\u76ee\u524d\u7684\u5de5\u4f5c\u8d1f\u8377\u8db3\u591f\u4e86\u3002</p> </li> <li> <p>\u73b0\u5728\u4f60\u6709\u4e86\u8f83\u597d\u7684 checkpoint_segements \u548c shared_buffers \u503c\u3002\u5982\u679c\u5199\u51fa\u6570\u636e\u7684\u5927\u90e8\u5206\u90fd\u6765\u81ea buffers_checkpoint\uff0c\u4e14 written_per_sec \u663e\u793a\u7684\u5e73\u5747 I/O \u770b\u4e0a\u53bb\u6bd4\u8f83\u9ad8\uff08\u6216\u8005\u662f\u6267\u884c\u5199\u64cd\u4f5c\u65f6\uff0c\u7cfb\u7edf\u660e\u663e\u663e\u5f97\u6162\uff09\uff0c     \u5e94\u8003\u8651\u589e\u52a0 checkpoint_timeout \u503c\uff0c\u5982\u679c\u589e\u52a0\u4e86\uff0c\u5219\u9700\u8981\u91cd\u590d\u4e0a\u8ff0\u6d41\u7a0b\u3002</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_46","title":"\u76d1\u63a7\u548c\u8d8b\u52bf\u5206\u6790","text":"<p>\u6570\u636e\u7684\u6027\u80fd\u76f4\u63a5\u548c\u5b83\u5e95\u5c42\u7684\u64cd\u4f5c\u7cfb\u7edf\u6027\u6709\u5173\u8054\uff0c\u800c\u64cd\u4f5c\u7cfb\u7edf\u7684\u6027\u80fd\u53c8\u548c\u5e95\u5c42\u7684\u786c\u4ef6\u6709\u5173\u8054\u3002\u56e0\u6b64\u53ea\u6709\u8fd9\u4e09\u8005\u90fd\u5904\u4e8e\u5de5\u4f5c\u826f\u597d\u7684\u72b6\u6001\uff0c\u624d\u4f1a\u6709\u597d\u7684\u6027\u80fd\u3002</p> <p>\u8fd9\u5c31\u9700\u8981\u4f60\u6709\u4e00\u4e2a\u597d\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u7528\u6765\u83b7\u53d6\u6240\u6709\u5c42\u9762\u7684\u6b63\u786e\u4fe1\u606f\uff0c\u7136\u540e\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad\uff0c\u5e76\u4e14\u53ef\u4ee5\u9884\u6d4b\u4ec0\u4e48\u7cfb\u7edf\u7cfb\u7edf\u4f1a\u8fbe\u5230\u5176\u8d1f\u8f7d\u6781\u9650\uff0c\u53c2\u6570\u7684\u6539\u53d8\u662f\u5426\u5bf9\u7cfb\u7edf\u7684\u63d0\u5347\u957f\u751f\u4e86\u6548\u679c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#unix_1","title":"unix \u76d1\u63a7\u5de5\u5177","text":"<p>\u8fd9\u91cc\u4e3b\u8981\u4ecb\u7ecd\u4e86 vmstat,iostat \u5de5\u5177\u7684\u4ecb\u7ecd\u548c\u4f7f\u7528\uff0c\u8fd9\u90e8\u5206\u53ef\u4ee5\u53c2\u8003Linux \u4e0b\u7684\u4e00\u4e9b I/O \u7edf\u8ba1\u5de5\u5177\u4e00\u6587</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_47","title":"\u8d85\u8d1f\u8377\u7684\u7cfb\u7edf\u4f8b\u5b50","text":"<p>\u4e0b\u9762\u7ed9\u51fa\u7684\u4f8b\u5b50\u4e2d\uff0c\u6570\u636e\u5e93\u76ee\u5f55\u5bf9\u5e94\u7684\u78c1\u76d8\u5e03\u5c40\u662f:</p> <ul> <li> <p>pg_xlog: /dev/sdf1</p> </li> <li> <p>data: /dev/md0 Linux \u8f6f RAID0\uff0c\u7531 sdc1,sdd1 \u548c sde1 \u7ec4\u6210</p> </li> </ul> <p>\u4e3a\u4e86\u52a0\u5927\u7cfb\u7edf\u7684\u8d1f\u8f7d\uff0c\u6211\u4eec\u8fd8\u662f\u7528 pgbench \u505a\u6d4b\u8bd5\uff0c\u628a scale \u8bbe\u5230 1000\uff0c\u5ba2\u6237\u7aef\u6570\u8bbe\u7f6e\u5230 64:</p> <pre><code>$ pgbench -i -s 1000 pgbench\n$ pgbench -j 4 -c 64 -T 300 pgbench\n</code></pre> <p>\u5728\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u6293\u53d6 vmstat \u4e00\u6bb5\u65f6\u95f4\u7684\u8f93\u51fa:</p> <pre><code>procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa\n 2 45      0 128464   5608 2787264    0    0  1462 17739 1586 2984  4  4  0 93\n 0 31      0 125356   5616 2789904    0    0  1232  1384 1591 3020  4  2  0 95\n 0 44      0 121628   5616 2793660    0    0  1712  2152 1984 3953  4  3  0 93\n 0 39      0 117164   5616 2797724    0    0  2144  1856 2270 4414  4  2  0 94\n 0 43      0 112452   5616 2802036    0    0  2128  2224 2252 4514  4  3  0 93\n 0 53      0 107376   5620 2806572    0    0  2576  2101 2060 4149  4  4  0 93\n 0  1      0 119412   5520 2791864    0    0  1322 17266 2028 3780  4  3 13 81\n 0  3      0 119048   5552 2789328    0    0    72  2426  801 1151  2  2 36 61\n 0 26      0 103904   5628 2809296    0    0  1400  1396 2048 3909  5  3  0 93\n 0 56      0 128208   5516 2785068    0    0  1808  1952 1546 3110  3  3 10 84\n 0 59      0 124148   5516 2789132    0    0  2008  2240 2251 4595  3  2  0 95\n</code></pre> <p>\u4ece\u8f93\u51fa\u6765\u770b\uff0ccs \u503c\u7684\u663e\u8457\u964d\u4f4e\u4f7f\u5f97\u6574\u4e2a\u7cfb\u7edf\u7684\u541e\u5410\u4e5f\u4e0b\u6765\u4e86\u3002\u8fd9\u91cc\u6709\u70b9\u56f0\u60d1\u7684\u662f\uff0c\u4e0e\u6b64\u540c\u65f6\uff0cwa \u503c\u4e5f\u4e0b\u6765\u4e86\u4e5f\u4e0b\u6765\u4e86\uff0c\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u573a\u666f\uff0c\u5f53\u7cfb\u7edf\u8d1f\u8f7d\u592a\u9ad8\u65f6\uff0c\u5b83\u4f1a\u56e0\u4e3a \u7d22\u8d44\u6e90\u7ade\u4e89\u7684\u539f\u56e0\u800c\u62d2\u7edd\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u3002\u6211\u4eec\u4ece cs \u7684\u6700\u4f4e\u70b9(1151)\u4e5f\u80fd\u770b\u51fa\uff0c\u5176\u5ba2\u6237\u7aef\u8fdb\u7a0b\u975e\u5e38\u5c11\uff0c\u4ec5\u6709 1 \u4e2a(\u5bf9\u5e94\u884c\u7684 b \u5217\u663e\u793a)\u3002\u8fd9\u5f88\u6709\u53ef\u80fd\u7684\u539f\u56e0\u662f\u78c1\u76d8\u63a7\u5236\u5668\u7684 cache \u5df2\u7ecf\u586b\u6ee1\u4e86\uff0c\u5ba2\u6237\u7aef\u90fd\u5728\u7b49\u5f85 WAL \u6570\u636e\u5199\u56de\u78c1\u76d8\u3002</p> <p>\u6709\u65f6\uff0c\u7cfb\u7edf\u6162\u6709\u53ef\u80fd\u5355\u7eaf\u662f I/O \u541e\u5410\u539f\u56e0\uff0c\u6bd4\u5982\u50cf\u4e0b\u9762\u7684\u8f93\u51fa\uff1a</p> <pre><code># iostat \u2013x 5\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           5.21    0.00    2.80   91.74    0.25    0.00\nDevice rsec/s    wsec/s avgrq-sz avgqu-sz   await  svctm  %util\nsdc1  2625.60   2057.60    14.67    38.79  101.47   3.14 100.08\nsdd1  2614.40   2000.00    14.90    57.96  162.95   3.23 100.08\nsde1  2736.00   1963.20    14.64    48.50  135.26   3.12 100.00\nmd0   7916.80   7206.40    10.60     0.00    0.00   0.00   0.00\nsdf1     0.00  22190.40    50.20     0.84    1.79   1.34  59.20\n</code></pre> <p>WAL \u7684\u5199\u901f\u5927\u7ea6 11MB/s\u3002\u4e0e\u6b64\u540c\u65f6\uff0c\u6570\u636e\u5e93\u78c1\u76d8(md0)\u5229\u7528\u7387\u8fbe\u5230 100%\uff0c\u7136\u800c\u8bfb\u5199\u901f\u5ea6\u53ea\u6709 8MB/s(\u8bfb+\u5199)\uff0c\u8fd9\u5f88\u53ef\u80fd\u6b64\u65f6\u6570\u636e\u5e93\u6709\u5f88\u7e41\u91cd\u968f\u673a I/O\uff0c \u800c\u5e95\u5c42\u78c1\u76d8\u7684\u968f\u673a I/O \u80fd\u529b\u4e5f\u5c31\u662f 2MB/s \u7684\u6837\u5b50\u3002</p> <p>\u8fd9\u4e2a\u6570\u636e\u5e93\u8fc7\u7a0b\u5f88\u6709\u53ef\u80fd\u662f checkpoint \u540c\u6b65\u9636\u6bb5\uff0c\u5f53\u5927\u91cf\u7684\u968f\u673a I/O \u5199\u6ee1\u78c1\u76d8\u7f13\u5b58\u540e\uff0c\u5f00\u59cb\u5f3a\u5236\u5199\u5165\u5230\u78c1\u76d8\u3002</p> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u770b\u4e0b\u9762\u66f4\u6781\u7aef\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u628a scale \u8bbe\u7f6e\u5230 4000</p> <pre><code>$ pgbench -i -s 4000 pgbench\n$ pgbench -j 4 -c 64 -T 300 pgbench\n</code></pre> <p>\u6267\u884c\u671f\u95f4\uff0c\u6293\u53d6\u4e00\u6bb5\u65f6\u95f4\u7684 vmstat \u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code># vmstat 1\nprocs ----io---- --system--- -----cpu-------\n\ufffcr  b   bi    bo    in    cs    us sy id  wa st\n1  63  5444  9864   8576 18268  4   3  0   92  0\n0  42  4784  13916  7969 16716  4   2  3   90  0\n0  59  464   4704   1279  1695  0   0 25   75  0\n0  54  304   4736   1396  2147  0   0 25   74  0\n0  42  264   5000   1391  1796  0   0 10   90  0\n0  42  296   4756   1444  1996  1   0 10   89  0\n0  29  248   5112   1331  1720  0   0 25   75  0\n0  47  368   4696   1359  2113  0   0 23   76  0\n1  48  344   5352   1287  1875  0   0  0   100 0\n0  64  2692  12084  5604  9474  8   2  0   90  0\n1  63  5376  9944   8346 18003  4   3  20  74  0\n0  64  5404  10128  8890 18847  4   3  25  67  0\n</code></pre> <p>\u8fd9\u91cc\u6709 8 \u79d2\u7684\u65f6\u95f4\u95f4\u9694\u5185\uff0c\u7cfb\u7edf\u6027\u80fd\u4e25\u91cd\u4e0b\u964d\u3002cpu \u8017\u65f6\u4e2d\uff0c\u51e0\u4e4e\u6ca1\u6709 user time\u3002\u8fd9\u7b26\u5408\u6240\u6709\u5ba2\u6237\u7aef\u6574\u7b49\u5f85\u67d0\u4e9b\u8d44\u6e90\u7684\u573a\u666f\u3002\u8fd9\u4e2a\u573a\u666f\u51fa\u73b0\u7684\u539f\u56e0 \u5728\u8fd9\u513f\u5f88\u663e\u7136\uff0cwa \u503c\u5f88\u9ad8\uff0c\u751a\u81f3\u5230 100%\uff0c\u8fd9\u8bf4\u660e\u670d\u52a1\u5668\u65e0\u6cd5\u8ddf\u4e0a\u78c1\u76d8 I/O \u52a0\u8f7d\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 iostat \u7684\u6269\u5c55\u9009\u9879\u67e5\u8be2\u6b64\u65f6\u78c1\u76d8\u8d1f\u8f7d\u5728\u505a\u4e9b\u4ec0\u4e48\uff1a</p> <pre><code># iostat \u2013x 5\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           2.35    0.00    1.85   85.49    0.15   10.16\nDevice rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util\nsdc1  2310.40  1169.60    14.63    39.85  147.59   4.21 100.00\nsdd1  2326.40  1216.00    14.53    71.41  264.60   4.10 100.00\nsde1  2438.40  1230.40    14.77    47.88  157.12   4.01  99.60\nmd0   7044.80  4820.80    11.12     0.00    0.00   0.00   0.00\nsdf1     0.00 19040.00    70.31     4.20   15.31   2.10  56.88\n</code></pre> <p>\u8f93\u51fa\u663e\u793a\u8bfb\u5199\u901f\u5ea6\u5f88\u4f4e\uff0c\u4f46\u662f\u78c1\u76d8\u5229\u7528\u7387\u8fbe\u5230\u4e86 100%\uff0c\u6ce8\u610f await \u6307\u6807\uff0c\u8fd9\u4e48\u9ad8\u7684\u503c\u8868\u660e\u78c1\u76d8\u7b49\u5f85\u65f6\u95f4\u8fc7\u957f\uff0c\u8bf4\u660e\u78c1\u76d8\u5bfb\u9053\u65f6\u95f4\u5360\u6bd4\u5f88\u5927\uff0c\u56e0\u800c\u53ef\u4ee5\u63a8\u65ad \u968f\u673a\u8bfb\u5199\u5360\u6bd4\u5f88\u9ad8\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#windows","title":"windows \u76d1\u63a7\u5de5\u5177","text":"<p>\u4efb\u52a1\u7ba1\u7406\u5668\u662f Windows \u7cfb\u7edf\u4e0b\u6700\u7b80\u5355\u548c\u5e38\u7528\u7684\u7cfb\u7edf\u76d1\u63a7\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u7c7b\u4f3c UNIX top \u5de5\u5177\u7684\u8f93\u51fa\u89c6\u56fe\u3002</p> <p>\u5982\u679c\u9700\u8981\u529f\u80fd\u5f3a\u5927\u4e00\u70b9\u7684\uff0c\u53ef\u4ee5\u4ece\u5fae\u8f6f\u5185\u90e8\u5de5\u5177\u7bb1\u4e0b\u8f7d\u8fdb\u7a0b\u6d4f\u89c8\u5de5\u5177\u4ee5\u53ca \u8fdb\u7a0b\u76d1\u63a7\u5de5\u5177\u3002\u76f8\u5173\u7528\u6cd5\u53ef\u4ee5\u53c2\u8003\u5de5\u5177\u81ea\u5e26\u7684\u624b\u518c\u3002</p> <p>\u5982\u679c\u9700\u8981\u4fdd\u5b58\u8fd9\u4e9b\u76d1\u63a7\u4fe1\u606f\uff0c\u7c7b\u4f3c UNIX \u7684 sar \u5de5\u5177\u4e00\u6837\uff0c\u5fae\u8f6f\u4e5f\u63d0\u4f9b\u8be6\u7ec6\u7684\u6307\u5357\uff0c\u4e0d\u540c\u7cfb\u7edf\u7248\u672c\u63d0\u4f9b\u7684\u65b9\u5f0f\u4e0d\u540c\uff0c\u5206\u5217\u5982\u4e0b\uff1a</p> <ul> <li> <p>Windows 2000,XP,Server 2003:   http://support.microsoft.com/kb/248345</p> </li> <li> <p>Vista:   http://technet.microsoft.com/en-us/library/cc722173(WS.10).aspx</p> </li> <li> <p>Windows 7,Windows Server 2008 R2:   http://technet.microsoft.com/en-us/library/dd744567(WS.10).aspx</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_48","title":"\u8d8b\u52bf\u5206\u6790\u8f6f\u4ef6","text":"<p>\u5217\u4e3e\u5982\u4e0b\uff0c\u5177\u4f53\u7684\u7528\u6cd5\u53c2\u8003\u5bf9\u5e94\u5de5\u5177\u7684\u95ee\u9898\uff1a</p> <ul> <li> <p>MRTG,RRDTool:   \u8fd9\u4e24\u4e2a\u7b97\u662f\u57fa\u7840\u5de5\u5177\uff0c\u7528\u4e8e\u6570\u636e\u7684\u5c55\u73b0\uff0c\u53ef\u4f5c\u4e3a\u5176\u4ed6\u8f6f\u4ef6\u7684\u9644\u52a0\u7ec4\u4ef6</p> </li> <li> <p>Nagios:   \u6700\u5e38\u7528\u7684\u76d1\u63a7 PostgreSQL \u7684\u5de5\u5177\uff0c\u5185\u7f6e\u4e86\u5bf9 PostgreSQL \u7684\u76d1\u63a7\u63d2\u4ef6check_postgres</p> </li> <li> <p>Cacti:   \u4e5f\u662f\u975e\u5e38\u6d41\u884c\u7684\u5f00\u6e90\u76d1\u63a7\u8f6f\u4ef6\uff0c\u5b83\u4e25\u91cd\u4f9d\u8d56 web \u5e94\u7528\u6280\u672f\u4ee5\u53ca RRDTool \u5de5\u5177\uff0c\u76ee\u524d\u5b83\u5185\u7f6e\u7684 PostgreSQL \u76d1\u63a7\u5de5\u5177\u8fd8\u6bd4\u8f83\u7c97\u9020\uff0c\u4e14\u8fd8\u5728\u5f00\u53d1\u4e2d\u3002\u8be6\u7ec6\u7684\u53ef\u4ee5   \u53c2\u8003\u8fd9\u4e2a\u6587\u6863http://wiki.postgresql.org/wiki/Cacti</p> </li> <li> <p>Munin:   \u76f8\u6bd4 Nagios \u548c Cacti\uff0cMunin \u66f4\u5c0f\u800c\u4e14\u66f4\u65b0\uff0c\u5b83\u91c7\u7528\u4e86\u548c Cacti \u76f8\u540c\u7684 RRDTool \u6570\u636e\u5206\u6790\u7ed3\u6784\uff0c\u5b83\u8fd8\u53ef\u4ee5\u96c6\u6210\u5230 Nagios \u7684\u62a5\u8b66\u7ed3\u6784\u4e2d\u3002\u9488\u5bf9 PostgreSQL \u7684\u76d1\u63a7\u63d2\u4ef6   \u662fhttp://muninpgplugins.projects.postgresql.org/</p> </li> <li> <p>pgstatspack:   \u8fd9\u7b97\u662f\u9488\u5bf9 PostgreSQL \u7684\u4e00\u4e2a\u7ec4\u4ef6\u5305\uff0c\u5b83\u7684\u529f\u80fd\u7c7b\u4f3c pg_stat_bgwriter \u8bd5\u56fe--\u7528\u4e8e\u4fdd\u5b58 PostgreSQL \u5b9a\u671f\u7684\u7edf\u8ba1\u563b\u563b\u5230\u6570\u636e\u5e93\u8868\u91cc--\u4ee5\u4fbf\u4ee5\u540e\u5206\u6790\u3002\u5b83\u7684\u8bbe\u8ba1\u6765\u6e90\u4e8e   \u9488\u5bf9 Oracle \u7684\u4e00\u4e2a\u975e\u5e38\u6d41\u7a0b\u7684\u5de5\u5177\u5305 statspack\u3002\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u7f51\u7ad9\u4e86\u89e3\u66f4\u591a\uff0c\u8fd9\u91cc\u6709\u4e00\u7bc7\u4e0d\u9519\u7684\u4ecb\u7ecd\u6587\u7ae0\u3002</p> </li> <li> <p>Zenoss:   Zenoss \u76f8\u6bd4\u4e0a\u9762\u63d0\u5230\u7684\u4ea7\u54c1\u914d\u7f6e\u8d77\u6765\u9ebb\u70e6\u4e00\u70b9\uff0c\u5b83\u7684\u6838\u5fc3\u662f\u4e00\u5957\u5f00\u6e90\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u516c\u53f8\u4e5f\u63d0\u4f9b\u4e86\u5546\u4e1a\u6388\u6743\u7684\u4f01\u4e1a\u7248\u3002\u5b83\u901a\u8fc7\u79f0\u4e3a Zenpack \u7684\u6346\u7ed1\u6269\u5c55\u7ec4\u5efa\u6765   \u63d0\u4f9b\u5bf9\u670d\u52a1\u63d0\u4f9b\u76d1\u63a7\u548c\u5206\u6790\u529f\u80fd\u3002\u6700\u65b0\u53d1\u5e03\u7684 PostgreSQL   ZenPack \u53ef\u4ee5\u4ece\u4e0b\u9762\u7684\u94fe\u63a5\u627e\u5230\uff1ahttp://community.zenoss.org/docs/DOC-3389</p> </li> <li> <p>Hyperic HQ:   \u5546\u4e1a\u4ea7\u54c1\uff0c\u96c6\u6210\u4e86 PostgreSQL \u76d1\u63a7,\u4f46\u652f\u6301\u7684\u7248\u672c\u5f88\u4f4e\uff0c\u76ee\u524d\u4ec5\u652f\u6301\u5230 8.3\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cchttp://www.hyperic.com/products/postgresql-monitoring</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_49","title":"\u603b\u7ed3","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_50","title":"\u8fde\u63a5\u6c60\u548c\u7f13\u5b58","text":"","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_51","title":"\u8fde\u63a5\u6c60","text":"<p>\u8fde\u63a5\u6c60\u4f4d\u4e8e\u5e94\u7528\u7a0b\u5e8f\u548c\u6570\u636e\u5e93\u4e2d\u95f4\uff0c\u8fde\u63a5\u5230\u6570\u636e\u5e93\u7684\u4f1a\u8bdd\u6570\u56fa\u5b9a\uff0c\u4e00\u822c\u4f4e\u4e8e 100\uff0c\u8fd0\u884c\u671f\u95f4\uff0c\u8fd9\u4e9b\u8fde\u63a5\u4e00\u76f4\u90fd\u4fdd\u6301\u3002\u5f53\u5e94\u7528\u7a0b\u5e8f\u6709\u65b0\u7684\u8bf7\u6c42\u65f6\uff0c\u8fde\u63a5\u6c60\u7684\u8fde\u63a5\u53ef\u4ee5\u88ab\u91cd\u7528\u3002 PostgreSQL \u91cc\u7684 DISCARD ALL \u547d\u4ee4\u53ef\u4ee5\u5237\u65b0\u4e00\u4e2a\u65b0\u8fde\u63a5\u3002\u5f53\u5ba2\u6237\u7aef\u65ad\u5f00\u65f6\uff0c\u8fde\u63a5\u6c60\u53ea\u662f\u91cd\u7f6e\u4f1a\u8bdd\uff0c\u5e76\u4e0d\u5b9e\u9645\u4ece\u6570\u636e\u5e93\u65ad\u5f00\u3002</p> <p>\u8fde\u63a5\u6c60\u7684\u6570\u91cf\u5728\u7edd\u5927\u90e8\u5206\u573a\u666f\u4e0b\u4f9d\u8d56\u4e8e CPU \u7684\u6838\u6570\u3001\u6570\u636e\u5e93\u4f7f\u7528\u591a\u5c11\u5185\u5b58\u4f5c\u4e3a\u7f13\u5b58\u4ee5\u53ca\u5e95\u5c42\u78c1\u76d8\u7684\u901f\u5ea6\u3002</p> <p>\u5927\u90e8\u5206\u7528\u6237\u8ba4\u4e3a\u6700\u4f73\u7684\u8fde\u63a5\u6c60\u6570\u91cf\u5728 CPU \u6838\u6570\u7684 2 \u5230 3 \u500d\u4e2d\u95f4\uff0c\u5982\u679c\u4f60\u7cfb\u7edf\u6240\u5e26\u7684\u78c1\u76d8\u5f88\u591a\uff0c\u53ef\u4ee5\u8003\u8651\u6bd4\u8fd9\u4e2a\u6570\u5927\u4e00\u70b9\u3002</p> <p>\u4e00\u822c\u7684\u4e00\u4e2a\u8fed\u4ee3\u6280\u672f\u5c31\u662f\u5148\u628a\u8fde\u63a5\u6570\u8bbe\u7f6e\u4e3a 100\uff0c\u7136\u540e\u6839\u636e\u7cfb\u7edf\u7684\u8d1f\u8f7d\u505a\u8c03\u6574\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pgpool-ii","title":"pgpool-II","text":"<p>pgpool\u662f PostgreSQL \u4e0a\u6700\u8001\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\uff0c\u76ee\u524d\u8fd8\u5728\u6301\u7eed\u5f00\u53d1\u4e2d\u3002pgpool-II \u76f8\u6bd4\u539f\u6765\u7684\u7248\u672c\u5728\u5404\u65b9\u9762\u90fd\u6709\u4e86\u6539\u8fdb\u3002</p> <p>\u5b83\u7684\u4e3b\u8981\u76ee\u7684\u4e0d\u4ec5\u4ec5\u662f\u505a\u8fde\u63a5\u6c60\uff0c\u5b83\u8fd8\u53ef\u4ee5\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u4ee5\u53ca\u590d\u5236\u76f8\u5173\u7684\u529f\u80fd\u3002\u5b83\u751a\u81f3\u8fd8\u652f\u6301\u67d0\u4e9b\u5e76\u884c\u67e5\u8be2\u8bbe\u7f6e\u3002\u4ee5\u4e0b\u662f\u5b83\u63d0\u4f9b\u7684\u4e00\u4e9b\u529f\u80fd\u7684\u63cf\u8ff0\uff1a</p> \u8fde\u63a5\u6c60 <p>pgpool-II \u4fdd\u6301\u5df2\u7ecf\u8fde\u63a5\u5230 PostgreSQL \u670d\u52a1\u5668\u7684\u8fde\u63a5\uff0c \u5e76\u5728\u4f7f\u7528\u76f8\u540c\u53c2\u6570\uff08\u4f8b\u5982\uff1a\u7528\u6237\u540d\uff0c\u6570\u636e\u5e93\uff0c\u534f\u8bae\u7248\u672c\uff09 \u8fde\u63a5\u8fdb\u6765\u65f6\u91cd\u7528\u5b83\u4eec\u3002 \u5b83\u51cf\u5c11\u4e86\u8fde\u63a5\u5f00\u9500\uff0c\u5e76\u589e\u52a0\u4e86\u7cfb\u7edf\u7684\u603b\u4f53\u541e\u5410\u91cf\u3002</p> \u590d\u5236 <p>pgpool-II \u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a PostgreSQL \u670d\u52a1\u5668\u3002 \u6fc0\u6d3b\u590d\u5236\u529f\u80fd\u5e76\u4f7f\u5728 2 \u53f0\u6216\u8005\u66f4\u591a PostgreSQL \u8282\u70b9\u4e2d\u5efa\u7acb\u4e00\u4e2a\u5b9e\u65f6\u5907\u4efd\u6210\u4e3a\u53ef\u80fd\uff0c \u8fd9\u6837\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u53f0\u8282\u70b9\u5931\u6548\uff0c\u670d\u52a1\u53ef\u4ee5\u4e0d\u88ab\u4e2d\u65ad\u7ee7\u7eed\u8fd0\u884c\u3002</p> \u8d1f\u8f7d\u5747\u8861 <p>\u5982\u679c\u6570\u636e\u5e93\u8fdb\u884c\u4e86\u590d\u5236\uff08\u53ef\u80fd\u8fd0\u884c\u5728\u590d\u5236\u6a21\u5f0f\u6216\u8005\u4e3b\u5907\u6a21\u5f0f\u4e0b\uff09\uff0c \u5219\u5728\u4efb\u4f55\u4e00\u53f0\u670d\u52a1\u5668\u4e2d\u6267\u884c\u4e00\u4e2a SELECT \u67e5\u8be2\u5c06\u8fd4\u56de\u76f8\u540c\u7684\u7ed3\u679c\u3002 pgpool-II \u5229\u7528\u4e86\u590d\u5236\u7684\u529f\u80fd\u4ee5\u964d\u4f4e\u6bcf\u53f0 PostgreSQL \u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u3002 \u5b83\u901a\u8fc7\u5206\u53d1 SELECT \u67e5\u8be2\u5230\u6240\u6709\u53ef\u7528\u7684\u670d\u52a1\u5668\u4e2d\uff0c\u589e\u5f3a\u4e86\u7cfb\u7edf\u7684\u6574\u4f53\u541e\u5410\u91cf\u3002 \u5728\u7406\u60f3\u7684\u60c5\u51b5\u4e0b\uff0c\u8bfb\u6027\u80fd\u5e94\u8be5\u548c PostgreSQL \u670d\u52a1\u5668\u7684\u6570\u91cf\u6210\u6b63\u6bd4\u3002 \u8d1f\u8f7d\u5747\u5f88\u529f\u80fd\u5728\u6709\u5927\u91cf\u7528\u6237\u540c\u65f6\u6267\u884c\u5f88\u591a\u53ea\u8bfb\u67e5\u8be2\u7684\u573a\u666f\u4e2d\u5de5\u4f5c\u7684\u6548\u679c\u6700\u597d\u3002</p> \u9650\u5236\u8d85\u8fc7\u9650\u5ea6\u7684\u8fde\u63a5 <p>PostgreSQL \u4f1a\u9650\u5236\u5f53\u524d\u7684\u6700\u5927\u8fde\u63a5\u6570\uff0c\u5f53\u5230\u8fbe\u8fd9\u4e2a\u6570\u91cf\u65f6\uff0c\u65b0\u7684\u8fde\u63a5\u5c06\u88ab\u62d2\u7edd\u3002 \u589e\u52a0\u8fd9\u4e2a\u6700\u5927\u8fde\u63a5\u6570\u4f1a\u589e\u52a0\u8d44\u6e90\u6d88\u8017\u5e76\u4e14\u5bf9\u7cfb\u7edf\u7684\u5168\u5c40\u6027\u80fd\u6709\u4e00\u5b9a\u7684\u8d1f\u9762\u5f71\u54cd\u3002 pgpoo-II \u4e5f\u652f\u6301\u9650\u5236\u6700\u5927\u8fde\u63a5\u6570\uff0c\u4f46\u5b83\u7684\u505a\u6cd5\u662f\u5c06\u8fde\u63a5\u653e\u5165\u961f\u5217\uff0c\u800c\u4e0d\u662f\u7acb\u5373\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002</p> \u5e76\u884c\u67e5\u8be2 <p>\u4f7f\u7528\u5e76\u884c\u67e5\u8be2\u65f6\uff0c\u6570\u636e\u53ef\u4ee5\u88ab\u5206\u5272\u5230\u591a\u53f0\u670d\u52a1\u5668\u4e0a\uff0c \u6240\u4ee5\u4e00\u4e2a\u67e5\u8be2\u53ef\u4ee5\u5728\u591a\u53f0\u670d\u52a1\u5668\u4e0a\u540c\u65f6\u6267\u884c\uff0c\u4ee5\u51cf\u5c11\u603b\u4f53\u6267\u884c\u65f6\u95f4\u3002 \u5e76\u884c\u67e5\u8be2\u5728\u67e5\u8be2\u5927\u89c4\u6a21\u6570\u636e\u7684\u65f6\u5019\u975e\u5e38\u6709\u6548\u3002</p> <p>pgpool-II \u4f7f\u7528 PostgreSQL \u7684\u524d\u540e\u53f0\u7a0b\u5e8f\u4e4b\u95f4\u7684\u534f\u8bae\uff0c\u5e76\u4e14\u5728\u524d\u540e\u53f0\u4e4b\u95f4\u4f20\u9012\u6d88\u606f\u3002 \u56e0\u6b64\uff0c\u4e00\u4e2a\uff08\u524d\u7aef\u7684\uff09\u6570\u636e\u5e93\u5e94\u7528\u7a0b\u5e8f\u8ba4\u4e3a pgpool-II \u5c31\u662f\u5b9e\u9645\u7684 PostgreSQL \u6570\u636e\u5e93\uff0c \u800c\u540e\u7aef\u7684\u670d\u52a1\u8fdb\u7a0b\u5219\u8ba4\u4e3a pgpool-II \u662f\u5b83\u7684\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002 \u56e0\u4e3a pgpool-II \u5bf9\u4e8e\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u6765\u8bf4\u662f\u900f\u660e\u7684\uff0c \u73b0\u6709\u7684\u6570\u636e\u5e93\u5e94\u7528\u7a0b\u5e8f\u57fa\u672c\u4e0a\u53ef\u4ee5\u4e0d\u9700\u8981\u4fee\u6539\u5c31\u53ef\u4ee5\u4f7f\u7528 pgpool-II \u4e86\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#pgbouncer","title":"pgBouncer","text":"<p>pgBouncer \u662f PostgreSQL \u91cc\u80fd\u63d0\u9ad8\u6700\u9ad8\u6548\u7387\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u6700\u521d\u662f Skype \u4f5c\u4e3a\u6570\u636e\u5e93\u6269\u5c55\u529f\u80fd\u5f00\u53d1\u7684\u3002</p> <p>pgBouncer \u662f\u5355\u8fdb\u7a0b\u7a0b\u5e8f\uff0c\u9488\u5bf9\u6bcf\u4e2a\u8fde\u63a5\u5e76\u4e0d\u957f\u751f\u65b0\u8fdb\u7a0b\uff0c\u5176\u5e95\u5c42\u67b6\u6784\u4e0a\u4f9d\u8d56 UNIX \u5e73\u53f0\u7684 libevent \u52a8\u6001\u5e93\uff0c\u5176\u5185\u90e8\u7684\u961f\u5217\u7ba1\u7406\u53ef\u4ee5\u914d\u7f6e\uff0c\u4ee5\u907f\u514d\u51fa\u73b0\u8d85\u65f6\u73b0\u8c61\u3002</p> <p>pgBouncer \u4f1a\u521b\u5efa pgbouncer \u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u4f7f\u7528\u6807\u51c6\u7684 pgsql \u5de5\u5177\u8fde\u63a5\u5230\u8be5\u5e93\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 SHOW \u547d\u4ee4\u6765\u83b7\u5f97\u6709\u5173\u8fde\u63a5\u6c60\u7684\u5185\u90e8\u4fe1\u606f\u3002\u5176\u7ec8\u7aef\u63a5\u53e3\u63a5\u53d7\u50cf PAUSE\uff0cRESUME \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u63a7\u5236\u8fde\u63a5\u6c60\u3002</p> <p>pgBouncer \u7684\u53e6\u5916\u4e00\u4e2a\u7279\u6027\u662f\u5b83\u652f\u6301\u5bf9\u591a\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5668\u7684\u8fde\u63a5\u3002\u8fd9\u5c31\u4f7f\u5f97\u4f60\u7684\u7cfb\u7edf\u8d1f\u8f7d\u6709\u53ef\u80fd\u5206\u6563\u5230\u591a\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5668\u8282\u70b9\u4e0a\u3002</p> <p>\u5982\u679c\u4f60\u7684\u6709\u51e0\u767e\u6216\u8005\u4e0a\u5343\u7684\u8fde\u63a5\u6570\uff0c\u4ed6\u4eec\u8d85\u8fc7\u4e86\u4f60\u670d\u52a1\u5668\u4e0a CPU \u7684\u4e2a\u6570\uff0c\u90a3\u4e48 pgBouncer \u662f\u4f60\u7684\u7b2c\u4e00\u8003\u8651\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_52","title":"\u5e94\u7528\u670d\u52a1\u5668\u8fde\u63a5\u6c60","text":"<p>\u6709\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u5e76\u4e0d\u9700\u8981\u6570\u636e\u5e93\u5c42\u9762\u7684\u8fde\u63a5\u6c60\uff0c\u5b83\u504f\u5411\u4e8e\u4f7f\u7528\u81ea\u5df1\u7684\u8fde\u63a5\u6c60\uff0c\u5927\u90e8\u5206\u6d41\u884c\u7684 Java \u5e94\u7528\u670d\u52a1\uff0c\u5305\u62ec Tomcat,JBoss \u7b49\uff0c\u90fd\u6709\u81ea\u5df1\u7684\u8fde\u63a5\u6c60\u7ec4\u4ef6\u3002 \u6bd4\u5982 Tomcat \u5c31\u4f7f\u7528\u79f0\u4e3a DBCP(Database Connection Pool)\u7684\u7ec4\u4ef6\uff0c\u53e6\u5916\uff0c\u57fa\u4e8e Java \u7684\u5f00\u6e90\u8fde\u63a5\u6c60\u8f6f\u4ef6\u4e5f\u5f88\u591a\uff0c\u8fd9\u4e2a\u94fe\u63a5\u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u4e9b\u63cf\u8ff0\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_53","title":"\u590d\u5236\u6269\u5c55","text":"<p>\u590d\u5236\u53ef\u4ee5\u4f7f\u5f97\u6570\u636e\u5e93\u6570\u636e\u5b58\u5728\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff0c\u81f3\u4e8e\u5199\uff0cPostgres-XC \u9879\u76ee\u8fd9\u81f4\u529b\u4e8e\u8fd9\u70b9\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_54","title":"\u70ed\u5907","text":"<p>PostgreSQL \u4ece 8.2 \u7248\u672c\u5f00\u59cb\u5c31\u5df2\u7ecf\u5185\u7f6e\u4e86\u5907\u673a(standby)\u7279\u6027\uff0c\u5b83\u5141\u8bb8\u521b\u5efa\u4e3b\u5907(master/standby)\u8282\u70b9,\u5907\u673a\u5b9a\u671f\u4ece\u4e3b\u673a\u63a5\u6536\u6570\u636e\u5e93\u66f4\u65b0\u65e5\u5fd7\u5e76\u5e94\u7528\u8fd9\u4e9b\u65e5\u5fd7\u3002 \u5982\u679c\u4e3b\u673a\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u5931\u6548\uff0c\u5907\u673a\u53ef\u4ee5\u5feb\u901f\u66ff\u4ee3\u4e3b\u673a\u3002</p> <p>\u66f4\u6df1\u5165\u7406\u89e3\u70ed\u5907\uff0c\u9700\u8981\u6211\u4eec\u5148\u4e86\u89e3\u4e0b\u9762\u7684\u4e00\u4e9b\u672f\u8bed\uff1a</p> Write-ahead log(WAL) <p>: \u9884\u5199\u65e5\u5fd7\uff0c\u6bcf\u4e2a WAL \u5927\u5c0f\u4e3a 16MB\u3002\u5982\u679c\u6709\u4e24\u53f0\u6570\u636e\u5e93\u5f00\u59cb\u90fd\u662f\u4e00\u6837\uff0c\u7136\u540e\u5e94\u7528\u76f8\u540c\u7684 WAL \u540e\uff0c\u4ed6\u4eec\u8fd8\u662f\u76f8\u540c\u7684\uff0c\u56e0\u4e3a WAL \u5305\u542b\u4e86\u6240\u6709\u6539\u53d8\u7684\u6570\u636e\u3002</p> Base backup <p>\u5305\u62ec\u6240\u6709\u6570\u636e\u5e93\u5d29\u6e83\u540e\u80fd\u591f\u5b8c\u6574\u6062\u590d\u7684\u6570\u636e\u5e93\u5907\u4efd\u3002\u5b83\u4e00\u822c\u4f7f\u7528 pg_start_backup \u548c pg_stop_backup \u6307\u4ee4\u6765\u8fdb\u884c\u60b2\u6124\uff0c\u5b83\u7b49\u4e8e\u628a\u6574\u4e2a\u6570\u636e\u5e93\u4ee5\u53ca\u5728\u5907\u4efd\u671f\u95f4\u6709\u6240\u6539\u53d8\u800c\u5199\u5165 WAL \u6587\u4ef6\u5168\u90e8\u5907\u4efd\u4e00\u5957\u3002</p> Point-in-time recovery(PITR) <p>\u5982\u679c\u4f60\u6709\u57fa\u672c\u5907\u4efd(base backup)\u4ee5\u53ca\u4e00\u7cfb\u5217 WAL \u6587\u4ef6\uff0c\u90a3\u4f60\u5c31\u5e94\u7528\u57fa\u7840\u5907\u4efd\u4ee5\u53ca\u4e00\u90e8\u5206 WAL \u6587\u4ef6\u4ece\u800c\u5b9e\u73b0\u6309\u65f6\u70b9\u6062\u590d\u7279\u6027\u3002</p> File-based log shipping <p>\u5982\u679c\u4f60\u6570\u636e\u5e93\u505a\u4e00\u4e2a\u57fa\u7840\u5907\u4efd(base backup)\uff0c\u7136\u540e\u628a\u6240\u6709\u7684 WAL \u6587\u4ef6\u4f20\u8f93\u5230\u53e6\u5916\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\uff0c\u90a3\u4e48\u65b0\u7684\u670d\u52a1\u5668\u53ef\u4ee5\u548c\u539f\u6765\u90a3\u53f0\u4fdd\u6301\u540c\u6b65</p> standby <p>\u6709\u5b8c\u6574\u7684\u57fa\u7840\u5907\u4efd(base backup)\u4ee5\u53ca\u673a\u9047\u6587\u4ef6\u7684\u65e5\u5fd7\u6d41\u4f20\u8f93\uff0c\u8fd9\u4e2a\u7cfb\u7edf\u79f0\u4e4b\u4e3a\u5907\u673a(standby),\u53ea\u8981 WAL \u53ef\u4ee5\u6301\u7eed\u4f20\u8f93\uff0cstandby \u53ef\u4ee5\u548c\u4e3b\u673a\u4fdd\u6301\u540c\u6b65\u3002</p> Failover <p>\u628a\u5907\u673a\u4ece\u6062\u590d\u6a21\u5f0f\u5207\u6362\u5230 active \u72b6\u6001\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u5931\u6548\u5207\u6362\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_55","title":"\u603b\u7ed3","text":"<p>Program Relication Method Synchronization</p> <p>WAL Shipping Master/Slave Async Slony Master/Slave Async Londiste Master/Slave Async Mammoth Master/Slave Async Bucardo Master/Slave or Master/Master Async Rubyrep Master/Slave or Master/Master Async PgCluster Master/Master Sync Postgres-XC Master/Master Sync pgpool-II Statement-based middleware Sync</p> <p>\u4e0a\u8ff0\u8fd9\u4e48\u591a\u4e3b/\u4ece\u590d\u5236\u89e3\u51b3\u65b9\u6848\u4e2d\u7684\u4e3b\u8981\u4e0d\u540c\u5728\u4e8e\u6570\u636e\u5e93\u7684\u4fee\u6539\u6570\u636e\u5982\u4f55\u4f20\u9012</p> <ul> <li> <p>PostgreSQL 9.0 \u7684 Hot Standby \u4e3b\u8981\u7528\u4e8e\u9ad8\u53ef\u7528\u5931\u6548\u5207\u6362</p> </li> <li> <p>WAL \u7528\u4e8e\u4e3a\u5907\u673a\u6570\u636e\u5e93\u521b\u5efa\u4fee\u6539\u7684\u65e5\u5fd7\u5757\uff0c\u5b83\u53ea\u80fd\u5b8c\u6574\u5e94\u7528\uff0c\u4e0d\u7528\u5e94\u7528 WAL \u5b50\u96c6</p> </li> <li> <p>\u4f7f\u7528\u65e5\u5fd7\u4f20\u8f93\u590d\u5236\u4f1a\u5728\u4e3b\u673a\u548c\u5907\u673a\u4e2d\u4ea7\u751f\u5f52\u6863\u5ef6\u8fdf\uff0c\u867d\u7136\u8fd9\u70b9\u5728 Postgresql   9.0 \u91cc\u4f7f\u7528\u6d41\u590d\u5236(Stream Replication)\u7279\u65b0\u5f97\u4ee5\u4f18\u5316\uff0c\u4f46\u8fd8\u65e0\u6cd5\u5b8c\u5168\u907f\u514d\u3002</p> </li> <li> <p>Hot   Standby \u7cfb\u7edf\u53ef\u4ee5\u9488\u5bf9\u5feb\u901f\u5931\u6548\u5207\u6362\uff0c\u957f\u65f6\u95f4\u67e5\u8be2\u6267\u884c\u4ee5\u53ca\u5bf9\u4e3b\u673a\u6700\u5c0f\u5f71\u54cd\u4e09\u4e2a\u65b9\u9762\u8fdb\u884c\u4f18\u5316\u3002\u4f46\u540c\u4e00\u65f6\u523b\u53ea\u80fd\u4f18\u5316\u8fd9\u4e09\u79cd\u7684\u4e24\u79cd\u3002</p> </li> <li> <p>\u57fa\u4e8e\u8bed\u53e5\u7684\u6570\u636e\u5e93\u590d\u5236\u53cd\u800c\u66f4\u7075\u6d3b\uff0c\u8fd8\u80fd\u7528\u6765\u5347\u7ea7\u7248\u672c\u3002\u4f46\u6709\u4e9b\u8bed\u53e5\u5e76\u4e0d\u5bb9\u6613\u590d\u5236\uff0c\u800c\u4e14\u76f8\u6bd4 WAL \u4f20\u8f93\u6709\u66f4\u9ad8\u7684\u5f00\u9500\u3002</p> </li> <li> <p>Slony \u548c Londiste \u90fd\u662f\u4f7f\u7528\u89e6\u53d1\u5668\u63d0\u53d6\u66f4\u65b0\u8bed\u53e5\u7684\u6210\u719f\u89e3\u51b3\u65b9\u6848\u3002</p> </li> <li> <p>pgpool-II \u53ef\u4ee5\u7528\u6765\u505a\u591a\u4ece\u8282\u70b9\u7684\u53ea\u8bfb\u8d1f\u8f7d\u5747\u8861\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u505a\u67d0\u4e9b\u540c\u6b65\u590d\u5236</p> </li> <li> <p>Bucardo \u652f\u6301\u591a\u4e3b\u7ed3\u6784\uff0c\u4e0d\u7ba1\u8fd9\u4e9b\u8282\u70b9\u662f\u5426\u4e00\u76f4\u90fd\u5728\u7ebf\u3002</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_56","title":"\u6570\u636e\u5206\u533a","text":"<p>\u5f53\u8868\u4e00\u4e2a\u81ea\u8eab\u6bd4\u7269\u7406\u5185\u5b58\u8fd8\u5927\u65f6\uff0c\u5373\u4fbf\u7d22\u5f15\u5f88\u597d\uff0c\u67e5\u8be2\u8be5\u8868\u7684\u65f6\u95f4\u4e5f\u4f1a\u663e\u8457\u589e\u52a0\u3002\u6b64\u65f6\u4e00\u4e2a\u81ea\u7136\u7684\u529e\u6cd5\u662f\u628a\u8fd9\u4e2a\u8868\u5212\u5206\u6210\u51e0\u4e2a\u5c0f\u7684\u76f8\u5173\u8868\u3002\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4fee\u6539\u4fee\u6539\uff0c\u8fd8\u662f\u67e5\u8be2\u539f\u6765\u7684\u8868\u3002 \u4f46\u5230\u6570\u636e\u5e93\u5c42\uff0c\u5219\u53ea\u662f\u67e5\u8be2\u8be5\u8868\u7684\u5b50\u96c6\u800c\u4e0d\u662f\u5168\u90e8\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_57","title":"\u8303\u56f4\u5206\u533a","text":"<p>\u6211\u4eec\u4f7f\u7528\u7b2c10{reference-type=\"ref\" reference=\"sec:query optimization\"}\u7ae0\u91cc\u63d0\u5230\u7684 Dell Store 2 \u6570\u636e\u5e93\u505a\u4f8b\u5b50\uff0c\u8003\u8651 orders \u8868\u7684\u7ed3\u6784\uff1a</p> <pre><code>dellstore2=# \\d orders\n Table \"public.orders\"\n   Column    |     Type      |                        Modifiers\n-------------+---------------+----------------------------------------------------------\n orderid     | integer       | not null default nextval('orders_orderid\n                                _seq'::regclass)\n orderdate   | date          | not null\n customerid  | integer       |\n netamount   | numeric(12,2) | not null\n tax         | numeric(12,2) | not null\n totalamount | numeric(12,2) | not null\nIndexes:\n    \"orders_pkey\" PRIMARY KEY, btree (orderid)\n    \"ix_order_custid\" btree (customerid)\nForeign-key constraints:\n    \"fk_customerid\" FOREIGN KEY (customerid) REFERENCES customers(customerid)\n    ON DELETE SET NULL\nReferenced by:\n    TABLE \"orderlines\" CONSTRAINT \"fk_orderid\" FOREIGN KEY (orderid)\n    REFERENCES orders(orderid) ON DELETE CASCADE\n</code></pre> <p>\u5047\u8bbe\u8fd9\u4e2a\u8868\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u8be5\u8868\u8fc5\u901f\u81a8\u80c0\uff0c\u6bd4\u5982\u8fbe\u5230\u4e00\u4ebf\u6761\u8bb0\u5f55\uff0c\u6216\u8005\u8bf4\u5176\u5927\u5c0f\u8d85\u8fc7\u4e86\u7269\u7406\u5185\u5b58\uff0c\u6b64\u65f6\u6211\u4eec\u8981\u8003\u8651\u5bf9\u6b64\u8868\u8fdb\u884c\u5206\u533a\u3002 \u8fd9\u91cc\u91cd\u70b9\u8981\u8003\u8651\u7684\u662f\u4f9d\u636e\u90a3\u4e2a\u5b57\u6bb5\u8fdb\u884c\u5206\u533a\uff0c\u6bd4\u5982\u8fd9\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5\u53ef\u4ee5\u5206\u533a\uff0c\u4e00\u4e2a\u662f orderid\uff0c\u4e00\u4e2a\u662f orderdate\u3002\u4f3c\u4e4e\u4e24\u4e2a\u90fd\u53ef\u884c\u3002 \u4f46\u662f\u8003\u8651\u5230\u4e00\u4e2a\u95ee\u9898\uff0c\u8ba2\u5355\u53ea\u4fdd\u7559\u4e00\u6bb5\u65f6\u95f4\uff0c\u6bd4\u5982 1\uff0c2 \u5e74\u3002\u8001\u7684\u8ba2\u5355\u5c31\u9700\u8981\u5220\u9664\u3002\u5f53\u5927\u91cf\u7684\u8001\u8ba2\u5355\u5220\u9664\u65f6\uff0c\u5fc5\u7136\u5c31\u9700\u8981\u6267\u884c vacuum\u3002\u4ece\u800c\u5bfc\u81f4\u5f00\u9500\u589e\u52a0\u3002 \u5982\u679c\u662f\u4f9d\u636e orderdate \u5206\u533a\uff0c\u5f53\u9700\u8981\u5220\u9664\u8001\u6570\u636e\u65f6\uff0c\u76f4\u63a5 DROP \u6389\u5305\u542b\u8001\u6570\u636e\u7684\u5206\u533a\u5c31\u597d\u4e86\uff0c\u8fd9\u6837\u6548\u7387\u5c31\u9ad8\u5f88\u591a\u3002 \u56e0\u6b64\u8fd9\u91cc\u9009\u62e9 orderdate \u4f5c\u4e3a\u5206\u533a\u5b57\u6bb5\u66f4\u597d\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u8981\u8ba1\u7b97\u4e00\u4e2a\u5206\u533a\u91cc\u5e94\u8be5\u5305\u542b\u591a\u5c11\u6570\u636e\uff0c\u9996\u5148\u770b\u770b\u8fd9\u4e2a\u8868\u7684\u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>dellstore2=# select min(orderdate),max(orderdate) from orders;\n    min     |    max\n------------+------------\n 2004-01-01 | 2004-12-31\n(1 row)\n</code></pre> <p>\u4f5c\u4e3a\u6f14\u793a\u6570\u636e\uff0c\u8fd9\u91cc\u7684\u6570\u636e\u53ea\u6709 1 \u5e74\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u6309\u7167\u6708\u6765\u5206\u533a\u3002</p> <pre><code>create table orders_2004_01 (\n   check (orderdate&gt;= DATE '2004-01-01' AND orderdate &lt; DATE '2004-02-01')\n) inherits(orders);\n\n...\n\ncreate table orders_2004_12(\n   check(orderdate&gt;= DATE '2004-12-01' AND orderdate &lt; DATE '2005-01-01')\n) inherits(orders);\n</code></pre> <p>\u8fd9\u4e9b\u5206\u533a\u8868\u53ea\u662f\u7ee7\u627f\u4e86\u4e3b\u8868\u7684\u5b57\u6bb5\uff0c\u8fd8\u9700\u8981\u589e\u52a0\u7d22\u5f15\uff0c\u7ea6\u675f\u4ee5\u53ca\u8c03\u6574\u548c\u4e3b\u8868\u76f8\u5339\u914d\u7684\u6743\u9650\u3002</p> <pre><code>ALTER TABLE ONLY orders_2004_01\n    ADD CONSTRAINT orders_2004_01_pkey PRIMARY KEY (orderid);\n...\n\nALTER TABLE ONLY orders_2004_12\n    ADD CONSTRAINT orders_2004_12_pkey PRIMARY KEY (orderid);\n\nCREATE INDEX idx_orders_2004_01_custid ON orders_2004_01\n    USING btree (customerid);\n\n....\n\nCREATE INDEX idx_orders_2004_12_custid ON orders_2004_12\n    USING btree (customerid);\n\nALTER TABLE ONLY orders_2004_01 ADD CONSTRAINT fk_2004_01_customerid FOREIGN KEY (customerid)\n    REFERENCES customers(customerid) ON DELETE SET NULL;\n\n...\n\nALTER TABLE ONLY orders_2004_12 ADD CONSTRAINT fk_2004_12_customerid FOREIGN KEY (customerid)\n   REFERENCES customers(customerid) ON DELETE SET NULL;\n</code></pre> <p>\u5230\u6b64\u4e3a\u6b62\uff0c\u8868\u7ed3\u6784\u90fd\u5df2\u7ecf\u6709\u4e86\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u786e\u4fdd\u63d2\u5165\u5230\u4e3b\u8868\u7684\u6570\u636e\u90fd\u63d2\u5165\u5230\u5bf9\u5e94\u7684\u5206\u533a\u8868\u4e2d\uff0c\u6211\u4eec\u5efa\u8bae\u4f7f\u7528\u89e6\u53d1\u5668\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff1a</p> <pre><code>CREATE OR REPLACE FUNCTION orders_insert_trigger()\nRETURNS TRIGGER AS  $body$\nBEGIN\nIF    ( NEW.orderdate &gt;= DATE '2004-12-01' AND\n          NEW.orderdate &lt; DATE '2005-01-01' ) THEN\n         INSERT INTO orders_2004_12 VALUES (NEW.*);\n ELSIF ( NEW.orderdate &gt;= DATE '2004-11-01' AND\n          NEW.orderdate &lt; DATE '2004-12-01' ) THEN\n         INSERT INTO orders_2004_11 VALUES (NEW.*);\n\n...\n\n ELSIF ( NEW.orderdate &gt;= DATE '2004-00-01' AND\n         NEW.orderdate &lt; DATE '2004-01-01' ) THEN\n         INSERT INTO orders_2004_11 VALUES (NEW.*);\n\nELSE\n         RAISE EXCEPTION 'Error in orders_insert_trigger():    date out of range';\n     END IF;\n     RETURN NULL;\n END;\n $body$\n LANGUAGE plpgsql;\n</code></pre> <p>\u8fd9\u4e2a\u89e6\u53d1\u5668\u662f\u9759\u6001\u7684\uff0c\u6bcf\u6b21\u90fd\u4f1a\u6267\u884c\u76f8\u540c\u7684\u8bed\u53e5\uff0c\u800c\u4e14\u4e0d\u5bb9\u6613\u6269\u5c55\uff0c\u6211\u4eec\u53ef\u4ee5\u6539\u9020\u4e3a\u52a8\u6001\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>CREATE OR REPLACE FUNCTION orders_insert_trigger()\nRETURNS TRIGGER AS $body$\nDECLARE\n    ins_sql TEXT;\nBEGIN\nins_sql :=\n        'INSERT INTO orders_'|| to_char(NEW.orderdate, 'YYYY_MM') ||\n        '(orderid,orderdate,customerid,netamount,tax,totalamount)\n          VALUES ' ||\n        '('|| NEW.orderid || ',' || quote_literal(NEW.orderdate) || ','\n           || NEW.customerid ||','||\n        NEW.netamount ||','|| NEW.tax || ',' || NEW.totalamount || ')';\n    EXECUTE ins_sql;\n    RETURN NULL;\nEND\n$body$\nLANGUAGE plpgsql;\n</code></pre> <p>\u800c\u540e\u628a\u8fd9\u4e2a\u89e6\u53d1\u5668\u5e94\u7528\u5230\u4e3b\u8868 orders \u4e0a:</p> <pre><code>CREATE TRIGGER insert_orders_trigger\n    BEFORE INSERT ON orders\n    FOR EACH ROW EXECUTE PROCEDURE orders_insert_trigger();\n</code></pre> <p>\u9664\u4e86\u7528\u89e6\u53d1\u5668\u8fd9\u79cd\u65b9\u6cd5\u6765\u91cd\u5b9a\u5411\u6570\u636e\u7684\u63d2\u5165\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5229\u7528\u89c4\u5219(rule)\u6765\u505a\u5230\u8fd9\u70b9\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>CREATE RULE orders_2004_01_insert AS\n  ON INSERT TO orders WHERE\n         ( orderdate&gt;=DATE '2004-01-01' AND orderdate &lt; DATE '2004-02-01' )\n  DO INSTEAD\n         INSERT INTO orders_2004_01 VALUES(NEW.*);\n</code></pre> <p>\u5728\u6570\u636e\u6279\u91cf\u52a0\u8f7d\u65f6\uff0c\u89c4\u5219\u76f8\u6bd4\u89e6\u53d1\u5668\u66f4\u5feb\u3002\u4e0d\u8fc7\u4f7f\u7528\u89c4\u5219\u7684\u662f\u4e2a\u5f31\u70b9\u5c31\u662f\u65e0\u6cd5\u4f7f\u7528 COPY \u6307\u4ee4\u6765\u52a0\u8f7d\u6570\u636e\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_58","title":"\u73b0\u573a\u8fc1\u79fb\u5230\u5206\u533a\u8868","text":"<p>\u73b0\u5728\u6240\u6709\u7684\u5206\u533a\u8868\u4ee5\u53ca\u8868\u4e0a\u7d22\u5f15\u3001\u7ea6\u675f\u4ee5\u53ca\u4e3b\u8868\u4e0a\u9700\u8981\u7684\u89e6\u53d1\u5668\u90fd\u5df2\u7ecf\u521b\u5efa\u597d\uff0c\u4f46\u662f\u76ee\u524d\u6240\u6709\u7684\u6570\u636e\u90fd\u8fd8\u5728\u4e3b\u8868\u4e0a\uff0c\u5982\u4f55\u628a\u6570\u636e\u5206\u5e03\u5230\u5206\u533a\u8868\u5462\uff1f</p> <p>\u6709\u4e24\u4e2a\u529e\u6cd5\uff0c\u4e00\u4e2a\u6700\u5bb9\u6613\u4e5f\u662f\u6700\u7b80\u5355\u7684\u529e\u6cd5\u662f\u5148\u628a\u4e3b\u8868\u4e0a\u7684\u6570\u636e\u5bfc\u51fa\uff0c\u800c\u540e\u6e05\u7a7a\u4e3b\u8868\uff0c\u7136\u540e\u5bfc\u5165\u521a\u624d\u5bfc\u51fa\u7684\u6570\u636e\u3002\u8fd9\u4e2a\u505a\u6cd5\u9700\u8981\u4e00\u5b9a\u7684\u505c\u670d\u52a1\u65f6\u95f4\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u529e\u6cd5\u662f\u8003\u8651\u4f7f\u7528\u66f4\u65b0\u89e6\u53d1\u5668\uff0c\u901a\u8fc7\u66f4\u65b0\u4e3b\u8868\u4e0a\u7684\u6240\u6709\u6570\u636e\uff0c\u4ece\u800c\u4f7f\u5f97\u6570\u636e\u91cd\u65b0\u5206\u914d\u3002\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6d41\u7a0b\u548c\u4f7f\u5f97\u63d2\u5165\u6570\u636e\u91cd\u5b9a\u5411\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u4e3b\u8868\u66f4\u65b0\u51fd\u6570\u3002 \u800c\u540e\u5728\u4e3b\u8868\u4e0a\u9488\u5bf9\u66f4\u65b0\u521b\u5efa\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>CREATE OR REPLACE FUNCTION orders_update_trigger()\nRETURNS TRIGGER AS $body$\nBEGIN\n   DELETE FROM orders WHERE OLD.orderid=orderid;\n    INSERT INTO orders values(NEW.*);\n    RETURN NULL;\nEND;\n$body$\nLANGUAGE plpgsql;\n\nCREATE TRIGGER update_orders\n     BEFORE UPDATE ON orders\n     FOR EACH ROW\n     EXECUTE PROCEDURE orders_update_trigger();\n</code></pre> <p>\u800c\u540e\u6211\u4eec\u628a\u5bf9\u4e3b\u8868\u7684\u66f4\u65b0\u8bed\u53e5\u653e\u5728\u4e00\u4e2a\u4e8b\u7269\u91cc\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>dellstore2=# BEGIN;\nBEGIN\ndellstore2=# SELECT count(*) FROM orders;\n count\n-------\n 12000\n(1 row)\n\ndellstore2=# SELECT count(*) FROM  orders_2004_01;\n count\n-------\n     0\n(1 row)\n\ndellstore2=# SELECT count(*) FROM  orders_2004_12;\n count\n-------\n     0\n(1 row)\n\ndellstore2=# UPDATE orders SET orderid=orderid;\nUPDATE 0\ndellstore2=# SELECT count(*) FROM orders;\n count\n-------\n 12000\n(1 row)\n\ndellstore2=# SELECT count(*) FROM orders_2004_01;\n count\n-------\n  1000\n(1 row)\n\ndellstore2=# SELECT count(*) FROM orders_2004_12;\n count\n-------\n  1000\n(1 row)\n\ndellstore2=# COMMIT;\nCOMMIT\n</code></pre> <p>\u786e\u4fdd\u6240\u6709\u7684\u6570\u636e\u90fd\u5df2\u7ecf\u91cd\u65b0\u5206\u5e03\u540e\uff0c\u8bb0\u5f97\u505a\u5584\u540e\u5de5\u4f5c</p> <pre><code>dellstore2=# CLUSTER orders;\nERROR:  there is no previously clustered index for table \"orders\"\nSTATEMENT:  CLUSTER orders;\nERROR:  there is no previously clustered index for table \"orders\"\ndellstore2=# DROP TRIGGER update_orders ON orders;\nDROP TRIGGER\ndellstore2=# DROP FUNCTION orders_update_trigger();\nDROP FUNCTION\n</code></pre>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_59","title":"\u5206\u533a\u67e5\u8be2","text":"<p>\u5230\u6b64\u4e3a\u6b62\uff0c\u6570\u636e\u90fd\u5728\u5206\u533a\u8868\u91cc\u4e86\uff0c\u6b64\u65f6\u5e94\u8be5\u66f4\u65b0\u653b\u51fb\u3002\u540c\u65f6\u4e5f\u5e94\u8be5\u786e\u8ba4 constraint_exclusion \u7279\u6027\u662f\u5426\u6253\u5f00:</p> <pre><code>dellstore2=# ANALYZE ;\nANALYZE\ndellstore2=# SHOW constraint_exclusion ;\n constraint_exclusion\n----------------------\n partition\n(1 row)\n</code></pre> <p>\u6392\u4ed6\u6027\u7ea6\u675f\u53ef\u4ee5\u8ba9\u67e5\u8be2\u8ba1\u5212\u907f\u514d\u5305\u542b\u8fdb\u5e76\u4e0d\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\u884c\u7684\u5206\u533a\u8868\u8fdb\u6765\u3002PostgreSQL 8.4 \u53ca\u4ee5\u540e\u7248\u672c\u9ed8\u8ba4\u662f\u6253\u5f00\u7684\uff0c\u4e4b\u524d\u5219\u662f\u5173\u95ed\u3002</p> <p>\u901a\u8fc7\u5bf9\u4e3b\u8868\u7684\u67e5\u8be2\u6d4b\u8bd5\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u8ba1\u5212\u5df2\u7ecf\u5728\u5206\u533a\u8868\u4e0a\u8d77\u4f5c\u7528\u4e86:</p> <pre><code>dellstore2=# EXPLAIN ANALYZE SELECT * FROM orders;\n  QUERY PLAN\n------------------\n Result  (cost=0.00..228.00 rows=12001 width=30) (actual time=0.010..4.648\n                                                      rows=12000 loops=1)\n   -&gt;  Append  (cost=0.00..228.00 rows=12001 width=30)\n                            (actual time=0.009..2.464 rows=12000 loops=1)\n         -&gt;  Seq Scan on orders  (cost=0.00..0.00 rows=1 width=30)\n                            (actual time=0.002..0.002 rows=0 loops=1)\n         -&gt;  Seq Scan on orders_2004_01 orders  (cost=0.00..19.00 rows=1000 width=30)\n            (actual time=0.007..0.118 rows=1000 loops=1)\n         -&gt;  Seq Scan on orders_2004_02 orders  (cost=0.00..19.00 rows=1000 width=30)\n            (actual time=0.006..0.111 rows=1000 loops=1)\n        ...\n         -&gt;  Seq Scan on orders_2004_11 orders  (cost=0.00..19.00 rows=1000 width=30)\n             (actual time=0.003..0.096 rows=1000 loops=1)\n         -&gt;  Seq Scan on orders_2004_12 orders  (cost=0.00..19.00 rows=1000 width=30)\n             (actual time=0.003..0.105 rows=1000 loops=1)\n Total runtime: 5.339 ms\n(16 rows)\n\ndellstore2=# EXPLAIN ANALYZE SELECT * FROM orders WHERE orderdate='2004-11-16';\n  QUERY PLAN\n---------------\n Result  (cost=0.00..21.50 rows=36 width=30) (actual time=0.012..0.136 rows=35 loops=1)\n   -&gt;  Append  (cost=0.00..21.50 rows=36 width=30)\n                (actual time=0.011..0.127 rows=35 loops=1)\n         -&gt;  Seq Scan on orders  (cost=0.00..0.00 rows=1 width=30)\n                (actual time=0.001..0.001 rows=0 loops=1)\n               Filter: (orderdate = '2004-11-16'::date)\n         -&gt;  Seq Scan on orders_2004_11 orders  (cost=0.00..21.50 rows=35 width=30)\n                (actual time=0.009..0.122 rows=35 loops=1)\n               Filter: (orderdate = '2004-11-16'::date)\n               Rows Removed by Filter: 965\n Total runtime: 0.165 ms\n(8 rows)\n</code></pre> <p>\u6211\u4eec\u518d\u770b\u770b\u9488\u5bf9 orderid \u5b57\u6bb5\u67e5\u8be2\u7684\u4f8b\u5b50\uff1a</p> <pre><code>dellstore2=# EXPLAIN ANALYZE SELECT * FROM orders WHERE orderid&lt;2000;\n  QUERY PLAN\n-----------------------\n Result  (cost=0.00..258.00 rows=2011 width=30) (actual time=11.433..39.440 rows=1999 loops=1)\n   -&gt;  Append  (cost=0.00..258.00 rows=2011 width=30) (actual time=11.431..38.878 rows=1999 loops=1)\n         -&gt;  Seq Scan on orders  (cost=0.00..0.00 rows=1 width=30) (actual time=0.001..0.001 rows=0 loops=1)\n               Filter: (orderid &lt; 2000)\n         -&gt;  Seq Scan on orders_2004_01 orders  (cost=0.00..21.50 rows=1000 width=30)\n              (actual time=11.429..14.192 rows=1000 loops=1)\n               Filter: (orderid &lt; 2000)\n       ...\n         -&gt;  Seq Scan on orders_2004_12 orders  (cost=0.00..21.50 rows=1 width=30)\n              (actual time=1.739..1.739 rows=0 loops=1)\n               Filter: (orderid &lt; 2000)\n               Rows Removed by Filter: 1000\n Total runtime: 39.880 ms\n(40 rows)\n</code></pre> <p>\u4ece\u7ed3\u679c\u6765\u770b\uff0c\u9488\u5bf9 orderid \u7684\u67e5\u8be2\u5e76\u6ca1\u6709\u592a\u591a\u4f18\u5316\uff0c\u6240\u6709\u7684\u5b50\u8868\u90fd\u5728\u626b\u63cf\u8303\u56f4\u5185\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_60","title":"\u5e38\u89c1\u7684\u5206\u533a\u8bef\u533a","text":"<ul> <li> <p>\u6ca1\u6709\u6253\u5f00 constraint_exclustion\uff0c\u4ece\u800c\u5bfc\u81f4\u6bcf\u6b21\u67e5\u8be2\u90fd\u5305\u542b\u6240\u6709\u7684\u5206\u533a\u8868</p> </li> <li> <p>\u5728\u6bcf\u4e2a\u5206\u533a\u8868\u4e0a\u589e\u52a0\u4e3b\u8868\u4e0a\u5df2\u7ecf\u6709\u7684\u7d22\u5f15\u6216\u8005\u7ea6\u675f\u65f6\u4f1a\u62a5\u9519</p> </li> <li> <p>\u5fd8\u8bb0\u7ed9\u6bcf\u4e2a\u5206\u533a\u8868\u8d4b\u4e88\u548c\u4e3b\u8868\u76f8\u540c\u7684\u6743\u9650</p> </li> <li> <p>\u67e5\u8be2\u8bed\u53e5\u6ca1\u6709\u5305\u62ec\u5206\u533a\u5b57\u6bb5\u7684\u8fc7\u6ee4\uff0cWHERE \u5b50\u53e5\u9700\u8981\u7528\u5e38\u91cf\u6765\u8fc7\u6ee4\uff0c\u5f53\u53c2\u6570\u7684\u67e5\u8be2\u6839\u672c\u5c31\u4e0d\u4f1a\u4f18\u5316\u3002   \u51fd\u6570\u91cc\u901a\u8fc7\u4f7f\u7528\u7c7b\u4f3c CURREN_DATE \u8fd9\u6837\u7684\u8bed\u53e5\u4fee\u6539\u8fc7\u6ee4\u503c\u4e5f\u4e0d\u4f1a\u83b7\u5f97\u597d\u7684\u4f18\u5316\u6548\u679c\u3002\u4e00\u822c\u6765\u8bf4\uff0cWHERE \u5b50\u53e5\u5c3d\u53ef\u80fd\u7b80\u5355\u3002</p> </li> <li> <p>\u9488\u5bf9\u5206\u533a\u7684\u67e5\u8be2\u5f00\u9500\u548c\u5206\u533a\u6570\u91cf\u6210\u6b63\u6bd4\uff0c\u5982\u679c\u53ea\u6709 10 \uff5e 20 \u4e2a\u5206\u533a\u8868\uff0c\u90a3\u5f00\u9500\u4e0d\u660e\u663e\uff0c\u5982\u679c\u4e0a\u767e\u4e2a\uff0c\u90a3\u5c31\u5f88\u660e\u663e\u4e86\uff0c\u56e0\u6b64\u4fdd\u6301\u4f60\u7684\u5206\u533a\u8868\u6570\u91cf\u5728 2 \u4f4d\u6570\u4e4b\u5185\u65f6\u6700\u597d\u7684\u6027\u80fd\u3002</p> </li> <li> <p>\u5982\u679c\u4f60\u624b\u5de5\u5bf9\u4e3b\u8868\u6267\u884c vacuum/analyze \u64cd\u4f5c\uff0c\u5b83\u5e76\u4e0d\u4f1a\u6267\u884c\u5230\u5206\u533a\u8868\u4e0a\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u9488\u5bf9\u6bcf\u4e2a\u5206\u533a\u8868\u505a\u540c\u6837\u7684\u64cd\u4f5c\u3002</p> </li> <li> <p>\u63d2\u5165\u8d85\u8fc7\u65e5\u671f\u8303\u56f4(\u6bd4\u5982 2005 \u5e74\u7684)\u7684\u6570\u636e\u4f1a\u5bfc\u81f4\u51fd\u6570\u62a5\u9519\uff0c\u7c7b\u4f3c ERROR:   relation \\\"orders_2013_03\\\" does not exist\u3002</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#plproxy","title":"\u7528 PL/Proxy \u505a\u6c34\u5e73\u5206\u533a","text":"<p>PL/Proxy\u7684\u7406\u8bba\u662f\u8ba4\u4e3a\u628a\u4e00\u4e2a\u5927\u8868\u5206\u6210\u591a\u4e2a\u5b50\u8868\u4f1a\u6bd4\u5c06\u5927\u8868\u5206\u5230\u76f8\u540c\u7684\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\u66f4\u6709\u6548\u7387\u3002</p> <p>PL/Proxy \u662f Skype \u8bbe\u8ba1\u7528\u6765\u6ee1\u8db3\u6570\u636e\u5e93\u6269\u5c55\u6240\u9700\uff0c\u5b83\u5176\u4e2d\u7684\u4e00\u4e2a\u76ee\u6807\u662f\u4e00\u6b21\u53ef\u4ee5\u670d\u52a1 10 \u4e2a\u7528\u6237\u8bf7\u6c42\u3002\u5b83\u662f\u7528\u5b58\u50a8\u8fc7\u7a0b\u8bed\u8a00\u5b9e\u73b0\u7684\u6570\u636e\u5e93\u5206\u533a\u7cfb\u7edf\u3002</p> <p>PL/Proxy \u7684\u4e00\u4e2a\u57fa\u672c\u5047\u8bbe\u662f\u901a\u8fc7\u8bbf\u95ee\u51fd\u6570\uff08\u4e5f\u5c31\u662f\u5b58\u50a8\u8fc7\u7a0b\uff09\u6765\u5c4f\u853d\u76f4\u63a5\u8bbf\u95ee\u6570\u636e\u5e93\u3002\u6bd4\u5982\uff0c\u5047\u5b9a\u4f60\u9700\u8981\u6293\u53d6 username \u5b57\u6bb5\u6765\u552f\u4e00\u6807\u8bc6\u4e00\u4e2a\u7528\u6237\uff0c\u4f60\u53ef\u4ee5\u8c03\u7528 \u4e00\u4e2a\u8fd4\u56de username \u5b57\u6bb5\u7684\u51fd\u6570\u800c\u4e0d\u662f\u67e5\u8be2\u8868\u3002\u8fd9\u4e2a\u8bbe\u8ba1\u65b9\u5f0f\u6d41\u884c\u7684\u53e6\u5916\u4e00\u4e2a\u539f\u56e0\u662f\uff0c\u5b83\u4f7f\u5f97\u5f53\u9700\u8981\u91cd\u6784\u6570\u636e\u5e93\u65f6\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7684\u5f71\u54cd\u6700\u5c0f\u3002\u53ea\u8981\u90a3\u4e9b\u79f0\u4e4b\u4e3a\"API\"\u7684\u51fd\u6570\u662f\u7a33\u5b9a\u7684\uff0c \u90a3\u4e48\u51fd\u6570\u6620\u5c04\u5230\u91cd\u6784\u540e\u7684\u6570\u636e\u5e93\u5c31\u8981\u7b80\u5355\u5f97\u591a\u3002</p> <p>\u63a5\u4e0b\u6765\u8981\u505a\u7684\u662f\u5224\u65ad\u7528\u54ea\u79cd\u65b9\u6cd5\u628a\u8d1f\u8f7d\u5206\u7247\uff0c\u4ece\u6280\u672f\u4e0a\u6765\u8bf4\uff0c\u5c31\u662f\u5224\u65ad\u7528\u54ea\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u5206\u533a\u4f9d\u636e\u3002</p> <p>PL/Proxy \u7684\u914d\u7f6e\u5b89\u88c5\u6709\u70b9\u590d\u6742\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u770b\u8fd9\u4e2a\u8fd9\u4e2a\u94fe\u63a5\uff1ahttp://plproxy.projects.postgresql.org/doc/tutorial.html</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_61","title":"\u6563\u5217\u751f\u6210","text":"<p>\u4e0a\u9762\u63d0\u5230 PL/Proxy \u7684\u4e00\u4e2a\u6807\u51c6\u5de5\u4f5c\u5c31\u662f\u8868\u5206\u533a\uff0c\u56e0\u4e3a\u662f\u6c34\u5e73\u5206\u533a\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u8bb0\u5f55\u548c\u5b50\u8868\u5982\u4f55\u5bf9\u5e94\u3002\u4e00\u822c\u6211\u4eec\u91c7\u7528\u5bf9\u7279\u5b9a\u5b57\u6bb5\u505a hash \u7b97\u6cd5\u7684\u65b9\u5f0f\u6620\u5c04\u5230\u5b50\u8868\u4e2d\u3002 \u6211\u4eec\u53ef\u4ee5\u7528 PostgreSQL \u81ea\u5e26\u7684 hashtext \u51fd\u6570\u6765\u5b9e\u73b0 hash \u7b97\u6cd5\u3002\u5b83\u53ef\u4ee5\u63a5\u53d7\u4efb\u4f55\u6587\u672c\u4f5c\u4e3a\u8f93\u5165\uff0c\u800c\u540e\u4ea7\u751f\u4e00\u4e2a\u6574\u6570\u4f5c\u4e3a hash code\u3002\u5982\u679c\u4f60\u628a hash code \u548c\u4e00\u4e2a\u6570\u505a\u4f4d\u4e0e\u64cd\u4f5c\uff0c\u5219\u53ef\u4ee5\u4ea7\u751f\u6700\u4f4e\u7684\u51e0\u4f4d\u6570\u5b57\u3002 \u4e3a\u4e86\u5b9e\u73b0\u8fd9\u70b9\uff0c\u5206\u533a\u8868\u7684\u6570\u91cf\u5fc5\u987b\u662f 2 \u7684\u5e42\u6570(2,4,8,16 \u7b49)\uff0c\u7136\u540e\u628a hash code \u548c\u6bd4\u5206\u533a\u6570\u5c11 1 \u7684\u6570\u8fdb\u884c\u4f4d\u4e0e\u3002\u6bd4\u5982\u4f60\u6709 2 \u4e2a\u5206\u533a\uff0c\u5219\u4e3a\\\"&amp; 1\\\",4 \u4e2a\u5206\u533a\u5219\u662f\\\"&amp; 3\\\"\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p> <p>\u6211\u4eec\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u628a\u524d 10 \u4e2a\u81ea\u7136\u6570\u6620\u5c04\u5230 4 \u4e2a\u5206\u533a\u8868\u4e2d\uff1a</p> <pre><code>select s,hashtext(s::text) &amp; 3 as hash from generate_series(1,10) as s;\n s  | hash\n----+------\n  1 |    1\n  2 |    2\n  3 |    0\n  4 |    0\n  5 |    2\n  6 |    0\n  7 |    1\n  8 |    0\n  9 |    0\n 10 |    3\n(10 rows)\n</code></pre> <p>\u4ece hash \u4f8b\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e2a 10 \u4e2a\u81ea\u7136\u6570\u88ab\u6620\u5c04\u5230(0,1,2,3)\u96c6\u5408\u91cc\u3002</p> <p>hash \u8981\u8003\u8651\u7684\u53e6\u5916\u4e00\u4e2a\u60c5\u51b5\u662f\uff0c\u5bf9\u96c6\u5408\u5230\u5b50\u96c6\u7684\u6620\u5c04\u5c3d\u53ef\u80fd\u5e73\u5747\uff0c\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u524d 10000 \u4e2a\u81ea\u7136\u6570\u6620\u5c04\u5230 4 \u4e2a\u5206\u533a\u91cc\u7684\u7edf\u8ba1\u60c5\u51b5\uff1a</p> <pre><code>select hashtext(s::text) &amp; 3 as hash,count(s) as count from generate_series(1,2000)\n hash | count\n------+-------\n    0 |  2550\n    1 |  2411\n    2 |  2531\n    3 |  2508\n(4 rows)\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u6765\u770b\uff0c\u5b50\u96c6\u5143\u7d20\u7684\u6570\u91cf\u8fd8\u662f\u5f88\u5747\u7b49\u7684\u3002</p> <p>\u8981\u6ce8\u610f\u7684\u662f\uff0cPostgreSQL 8.3 \u7248\u672c\u7684 hashtext \u51fd\u6570\u548c 8.4 \u7248\u672c\u7684 hashtext \u8f93\u51fa\u7ed3\u679c\u4e0d\u540c\uff0c\u56e0\u6b64\u5f53\u4f60\u4ece 8.3 \u7248\u672c\u5347\u7ea7\u65f6\uff0c\u5219\u9700\u8981\u8003\u8651\u8fd9\u70b9\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_62","title":"\u5206\u7247","text":"<p>\u5206\u7247(Sharding)\u662f\u4e00\u79cd\u6c34\u5e73\u5206\u533a\u7684\u5f62\u5f0f\uff0c\u53ef\u4ee5\u7528 PL/Proxy \u6765\u5b9e\u73b0\u3002\u5b83\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u6709\u5206\u7247\u6570\u636e\u7ed3\u6784\uff0c\u56e0\u6b64\u8fd9\u4e9b\u8282\u70b9\u4e2d\u7684\u6bcf\u4e2a\u90fd\u53ef\u4ee5\u72ec\u7acb\u64cd\u4f5c\u3002 \u8fd9\u4e00\u822c\u662f shared-nothing \u67b6\u6784\u6240\u6d89\u53ca\u5230\u7684\u65b9\u6848\uff0c\u6bcf\u4e2a\u5206\u7247\u8282\u70b9\u90fd\u53ef\u4ee5\u72ec\u81ea\u54cd\u5e94\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42--\u53ea\u8981\u6240\u67e5\u8be2\u7684\u6570\u636e\u5728\u5176\u4e2d\u3002</p> <p>\u5206\u7247\u8bbe\u8ba1\u7684\u590d\u6742\u5904\u5305\u62ec\u5982\u4f55\u534f\u540c\u4ee5\u53ca\u5206\u7247\u8282\u70b9\u5982\u4f55\u66f4\u65b0\uff0c\u5b83\u4e00\u822c\u548c\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u76f8\u5173\u3002\u6bd4\u5982 Skype \u5c31\u4f7f\u7528\u4e86 Londiste \u590d\u5236\u7a0b\u5e8f\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_63","title":"\u603b\u7ed3","text":"<p>PostgreSQL \u91cc\u7684\u6bcf\u4e00\u79cd\u5206\u533a\u65b9\u6848\u90fd\u90fd\u4e00\u5b9a\u7684\u624b\u5de5\u914d\u7f6e\u5de5\u4f5c\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u505a\u8fd9\u4e9b\u64cd\u4f5c\u524d\uff0c\u4f60\u9700\u8981\u83b7\u5f97\u8db3\u591f\u7684\u4fe1\u606f\u6765\u5224\u8bfb\u4f7f\u7528\u54ea\u79cd\u5206\u533a\u65b9\u6848\u4ee5\u53ca\u5982\u4f55\u5206\u533a\u3002</p> <p>\u8fd9\u91cc\u6709\u4e9b\u901a\u7528\u6307\u5bfc\u5efa\u8bae\uff1a</p> <ul> <li> <p>\u53ea\u6709\u6570\u636e\u5e93\u8868\u6216\u8005\u8868\u6d3b\u8dc3\u90e8\u5206\u8d85\u8fc7\u670d\u52a1\u5668\u7269\u7406\u5185\u5b58\u65f6\uff0c\u5206\u533a\u624d\u6709\u610f\u4e49\u3002</p> </li> <li> <p>\u9009\u62e9\u54ea\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u5206\u533a\u4f9d\u636e\u9700\u8981\u4ed4\u7ec6\u8bc4\u4f30\u9488\u5bf9\u8be5\u8868\u7684\u6240\u6709\u67e5\u8be2\uff0c\u4ee5\u786e\u4fdd\u4ed6\u4eec\u9488\u5bf9\u8be5\u5b57\u6bb5\u90fd\u6709\u9009\u62e9\u6027\u3002</p> </li> <li> <p>\u6bcf\u4e2a\u5206\u533a\u8868\u90fd\u9700\u8981\u624b\u5de5\u521b\u5efa\uff0c\u5305\u62ec\u7d22\u5f15\u3001\u7ea6\u675f\u4ee5\u53ca(\u6216)\u8868\u6743\u9650\u3002</p> </li> <li> <p>\u91cd\u5b9a\u5411 INSERT\uff0cUPDATE\uff0cDELETE \u8bed\u53e5\u5230\u5206\u533a\u8868\u7684\u6700\u5bb9\u6613\u529e\u6cd5\u662f\u4f7f\u7528\u89e6\u53d1\u5668\u3002</p> </li> <li> <p>\u4ece\u672a\u5206\u533a\u8868\u7684\u6570\u636e\u73b0\u573a\u8fc1\u79fb\u5230\u5206\u533a\u8868\u4e2d\u662f\u53ef\u80fd\u7684\uff0c\u867d\u7136\u4f1a\u5e26\u6765\u4e34\u65f6\u7684\u78c1\u76d8\u4f7f\u7528\u7a7a\u95f4\u7ffb\u500d\u7684\u73b0\u8c61\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u5206\u533a\u8868\uff0c\u9700\u8981\u6253\u5f00 constraint_exclustion \u7279\u6027\uff0c\u67e5\u8be2\u624d\u4f1a\u6b63\u5e38\u5de5\u4f5c</p> </li> <li> <p>WHERE \u5b50\u53e5\u9700\u8981\u7b80\u5355\u503c\u624d\u80fd\u4f7f constraint exclustion \u5de5\u4f5c</p> </li> <li> <p>\u901a\u8fc7\u5206\u533a\u53ef\u4ee5\u6539\u8fdb\u67d0\u4e9b\u6570\u636e\u5e93\u7ef4\u62a4\u64cd\u4f5c\u3002\u5bf9\u5355\u4e2a\u5206\u533a\u8868\u6267\u884c REINDEX \u4f1a\u66f4\u5feb\uff0c\u76f8\u6bd4\u901a\u8fc7 DELETE \u5220\u9664\u8001\u7684\u6570\u636e\uff0c\u901a\u8fc7 DROP \u8001\u7684\u5206\u533a\u8868\u6765\u5220\u9664\u6570\u636e\u51e0\u4e4e\u65f6\u77ac\u65f6\u7684\uff0c</p> </li> <li> <p>\u4f7f\u7528\u524d\u81ea\u52a8\u521b\u5efa\u5206\u533a\u8868\u9700\u8981\u614e\u91cd\u601d\u8003\uff0c\u9700\u8981\u8003\u8651\u5230\u6761\u4ef6\u7ade\u4e89\u60c5\u51b5</p> </li> <li> <p>\u53ef\u4ee5\u6709\u6548\u4f7f\u7528\u7684\u5206\u533a\u8868\u6570\u4e0a\u9650\u662f\u4e24\u4f4d\u6570\u3002\u8d85\u8fc7 100 \u4e2a\u5206\u533a\u8868\u7684\u60c5\u51b5\u4e0b\uff0c\u67e5\u8be2\u4f1a\u9700\u8981\u5f88\u660e\u663e\u7684\u5f00\u9500\u6765\u8bc4\u4f30\u8fd9\u4e9b\u5206\u533a\u7ea6\u675f\u6761\u4ef6</p> </li> <li> <p>PL/Proxy \u53ef\u4ee5\u7528\u6765\u6709\u6548\u7684\u628a\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a\u8282\u70b9\uff0c\u4e14\u6269\u5c55\u8282\u70b9\u65e0\u9650\u5236\uff0c\u5b83\u4e5f\u53ef\u4ee5\u7528\u6765\u90e8\u7f72 shared-nothing \u67b6\u6784</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_64","title":"\u907f\u514d\u5e38\u89c1\u95ee\u9898","text":"<p>PostgreSQL \u5b98\u65b9 wiki \u4e0a\u6709\u4e00\u4e2aFAQ\u5217\u8868\uff0c\u5217\u51fa\u4e86\u4e00\u4e9b\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u6709\u4e9b\u6211\u4eec\u4f1a\u5728\u4e0b\u9762\u63d0\u5230\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_65","title":"\u704c\u6570","text":"<p>\u6570\u636e\u704c\u5165\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u60c5\u5f62\u3002\u7b2c\u4e00\u79cd\u5728\u4e00\u4e2a\u7a7a\u7684\u6570\u636e\u5e93(\u8868)\u91cc\u704c\u5165\u3002\u53e6\u5916\u4e00\u79cd\u662f\u6570\u636e\u5e93(\u8868)\u91cc\u5df2\u7ecf\u6709\u6570\u636e\u4e86\uff0c\u7136\u540e\u518d\u704c\u5165\u3002\u4e24\u79cd\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u533a\u522b\u3002 \u6bd4\u5982\u7528\u4e8e\u7b2c\u4e00\u79cd\u704c\u6570\u60c5\u5f62\u7684\u5220\u9664\u7d22\u5f15\u548c\u7ea6\u675f\u5c31\u4e0d\u9002\u5408\u7b2c\u4e8c\u79cd\u60c5\u5f62\u3002\u6211\u4eec\u5206\u522b\u4ecb\u7ecd\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_66","title":"\u52a0\u8f7d\u65b9\u6cd5","text":"<p>\u6570\u636e\u704c\u5165\u7684\u9996\u9009\u65b9\u6cd5\u662f\u7528 PostgreSQL \u7279\u6709\u7684 COPY \u6307\u4ee4\uff0c\u8fd9\u662f\u63d2\u5165\u5927\u91cf\u884c\u8bb0\u5f55\u7684\u6700\u5feb\u65b9\u6cd5\u3002 \u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4f20\u7edf\u7684 INSERT \u6307\u4ee4\uff0c\u4f46\u5373\u4fbf\u7528\u4e0a BEGIN/COMMIT \u65b9\u5f0f\u5305\u88f9\u591a\u6761 INSERT \u8bed\u53e5\uff0c\u901f\u5ea6\u4e5f\u4e0d\u5982 COPY \u6765\u7684\u5feb\u3002</p> <p>\u4e0b\u9762\u662f\u4ece\u6162\u5230\u5feb\u7684\u4e00\u4e2a\u6570\u636e\u63d2\u5165\u65b9\u6cd5\uff1a</p> <ol> <li> <p>\u4e00\u6b21\u63d2\u5165\u5355\u4e2a\u8bb0\u5f55</p> </li> <li> <p>\u4e00\u6b21\u63d2\u5165\u591a\u6761\u8bb0\u5f55</p> </li> <li> <p>\u4e00\u6b21\u4f7f\u7528\u5355\u4e2a COPY \u6307\u4ee4\uff0c\u8fd9\u4e5f\u662f\u6807\u51c6 pg_restore \u6240\u7528\u65b9\u6cd5</p> </li> <li> <p>\u591a\u6761\u63d2\u5165\u6307\u4ee4\u5e76\u884c\u6267\u884c\uff0c\u6bcf\u6761\u63d2\u5165\u6307\u4ee4\u5305\u62ec\u591a\u6761\u8bb0\u5f55</p> </li> <li> <p>\u4e00\u6b21\u4f7f\u7528\u591a\u4e2a COPY \u6307\u4ee4\u3002\u8fd9\u662f\u5e76\u884c pg_restore \u6240\u7528\u65b9\u6cd5</p> </li> </ol>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_67","title":"\u5916\u90e8\u704c\u6570\u7a0b\u5e8f","text":"<p>\u4f7f\u7528 COPY \u6307\u4ee4\u9700\u8981\u8003\u8651\u7684\u4e00\u70b9\u662f\uff0c\u53ea\u8981\u51fa\u73b0\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u7ec8\u7aef\u6240\u6709\u7684\u5de5\u4f5c\u3002\u60f3\u8c61\u4f60\u4e00\u4e0b\u5c31\u56e0\u4e3a\u6700\u540e\u4e00\u6761\u8bb0\u5f55\u6709\u95ee\u9898\uff0c\u4ece\u800c\u5bfc\u81f4\u4f60\u524d\u9762\u5927\u91cf\u7684\u6570\u636e\u63d2\u5165\u90fd\u5931\u6548\uff0c\u8fd9\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002</p> <p>\u5047\u5b9a\u4f60\u662f\u4ece\u5916\u90e8\u6570\u636e\u6e90\u5012\u5165\u6570\u636e\uff0c\u90a3\u5c31\u5e94\u8be5\u8003\u8651\u5bfc\u5165\u64cd\u4f5c\u5e94\u8be5\u53ef\u4ee5\u6301\u7eed\u5de5\u4f5c\uff0c\u7136\u540e\u628a\u56e0\u4e3a\u9519\u8bef\u62d2\u7edd\u63d2\u5165\u7684\u6570\u636e\u53e6\u5916\u4fdd\u5b58\u8d77\u6765\u3002pgloader\u5c31 \u53ef\u4ee5\u505a\u5230\u8fd9\u70b9\uff0c\u867d\u7136\u5b83\u4e0d\u5982 COPY \u6765\u5f97\u5feb\uff0c\u4f46\u5bf9\u4e8e\u5916\u90e8\u6570\u636e\u683c\u5f0f\u5e76\u4e0d\u90a3\u4e48\u4e25\u683c\u65f6\uff0c\u8fd9\u662f\u6700\u597d\u7684\u65b9\u5f0f\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u7528\u4e8e\u67d0\u4e9b\u7279\u5b9a\u573a\u666f\u4e0b\u7684\u704c\u6570\u7a0b\u5e8f\u662fpg_bulkload\uff0c\u5b83\u6709\u65f6\u751a\u81f3\u6bd4 COPY \u8fd8\u8981\u5feb\uff0c\u8fd9\u5f97\u610f\u4e8e\u5b83\u91c7\u53d6\u79ef\u6781\u7684\u9ad8\u6027\u80fd\u7279\u6027\uff0c\u6bd4\u5982\u7ed5\u8fc7 WAL\u3002 \u5b83\u4e5f\u53ef\u4ee5\u5904\u7406\u574f\u7684\u6570\u636e\u884c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_68","title":"\u4e3a\u704c\u6570\u8c03\u4f18","text":"<p>\u4e3a\u704c\u8f93\u800c\u5173\u95ed\u8868\u4e0a\u7684\u6240\u6709\u7d22\u5f15\u4ee5\u53ca\u7ea6\u675f\u53ea\u6700\u9700\u8981\u505a\u7684\u4e8b\u60c5\uff0c\u704c\u8f93\u540e\u5728\u521b\u5efa\u7d22\u5f15\u4f1a\u66f4\u5feb\uff0c\u66f4\u597d\u7684\u78c1\u76d8\u788e\u7247\u3002\u704c\u8f93\u540e\u505a\u7ea6\u675f\u68c0\u67e5\u8981\u5feb\u5f88\u591a\u3002</p> <p>postgresql.conf \u91cc\u7684\u51e0\u4e2a\u53c2\u6570\u4e5f\u53ef\u4ee5\u5728\u704c\u6570\u65f6\u505a\u4e34\u65f6\u8c03\u6574\uff0c\u53ef\u4ee5\u52a0\u5feb\u704c\u6570\u7684\u901f\u5ea6\uff1a</p> <ul> <li> <p>maintenance_work_mem:   \u5c3d\u53ef\u80fd\u52a0\u5927\u8be5\u503c\uff0c\u5bf9\u4e8e\u8d85\u8fc7 16G \u5185\u5b58\u7684\u670d\u52a1\u5668\uff0c\u914d\u7f6e 1GB \u7684\u8be5\u53c2\u6570\u5c31\u4e0d\u5408\u9053\u7406\u3002CREATE   INDEX \uff0cALTER TABLE ADD FOREIGN KEY \u90fd\u9700\u8981\u5b83\u3002</p> </li> <li> <p>checkpoint_segments:   \u8981\u6bd4\u6b63\u5e38\u4f7f\u7528\u65f6\u7684\u503c\u5927\u5f88\u591a\uff0c\u56e0\u4e3a\u5d29\u6e83\u540e\u6062\u590d\u65f6\u95f4\u4ee5\u53ca\u78c1\u76d8\u7a7a\u95f4\u5728\u8fd9\u4e2a\u65f6\u95f4\u6bb5\u5e76\u4e0d\u662f\u9700\u8981\u5173\u6ce8\u7684\u4e8b\u60c5\u3002\u901a\u5e38\u8bbe\u7f6e\u4e3a 128-256\u3002\u540c\u6837\u53ef\u4ee5\u52a0\u5927 checkpoint_timeout   \u7684\u503c\uff0c\u8bbe\u7f6e\u4e3a 30m \u662f\u5408\u7406\u7684</p> </li> <li> <p>autovacuum: \u704c\u6570\u65f6\u5173\u95ed\u8be5\u7279\u6027</p> </li> <li> <p>wal_buffers: \u5b83\u5f88\u5bb9\u6613\u6210\u4e3a\u704c\u6570\u7684\u74f6\u9888\uff0c\u8bbe\u7f6e\u5230\u5176\u6700\u5927\u503c 16MB\u3002</p> </li> <li> <p>synchronous_commit:   \u5173\u95ed\u8be5\u53c2\u6570\uff0c\u5173\u95ed\u540e\u5982\u679c\u56e0\u4e3a\u5d29\u6e83\u800c\u5bfc\u81f4\u4e22\u5931\u67d0\u4e9b\u4e8b\u52a1\uff0c\u7b80\u5355\u6e05\u7a7a\u5d29\u6e83\u524d\u6700\u540e\u704c\u5165\u7684\u8868\uff0c\u91cd\u65b0\u704c\u5165\u5c31\u597d\u4e86</p> </li> <li> <p>fsync:   \u8be5\u53c2\u6570\u53ea\u6709\u5728\u704c\u6570\u65f6\u53ef\u4ee5\u8003\u8651\u5173\u95ed\u3002\u5e26\u6765\u7684\u4e3b\u8981\u95ee\u9898\u662f\u5f53\u6570\u636e\u5e93\u5d29\u6e83\u65f6\uff0c\u6570\u636e\u53ef\u80fd\u635f\u574f\uff0c\u4f46\u4e0d\u662f\u81f4\u547d\u9519\u8bef\u3002\u53ea\u9700\u8981\u5b8c\u5168\u91cd\u65b0\u704c\u6570\u5c31\u597d</p> </li> <li> <p>vacuum_freeze_min_age: \u8bbe\u7f6e\u4e3a\u6bd4 0 \u5c0f\u7684\u53c2\u6570</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#wal","title":"\u8df3\u8fc7 WAL \u6765\u52a0\u901f","text":"<p>\u5047\u5b9a\u4e00\u4e2a\u704c\u6570\u4ee3\u7801\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>BEGIN;\nCREATE TABLE t ...;\nCOPY t FROM ...;\nCOMMIT;\n</code></pre> <p>\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u4e0a\u8ff0\u4ee3\u7801\u6267\u884c\u4e0d\u4f1a\u4ea7\u751f\u4efb\u4f55 WAL \u8bb0\u5f55\uff0c\u56e0\u6b64\u6267\u884c\u8d77\u6765\u66f4\u5feb\u3002\u540c\u7406\uff0c\u5982\u679c\u4f60\u7528 TRUNCATE \u800c\u4e0d\u662f DELETE \u6e05\u7a7a\u4e00\u4e2a\u8868\u4e5f\u80fd\u83b7\u5f97\u63d0\u901f\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u8bbe\u7f6e\u4e86 archive_command \u53c2\u6570\u6765\u83b7\u5f97 PITR \u7279\u6027\uff0c\u90a3\u4e48\u4e0a\u8ff0\u4f18\u5316\u5c31\u751f\u6548\u4e86\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_69","title":"\u91cd\u5efa\u7d22\u5f15\u548c\u589e\u52a0\u7ea6\u675f","text":"<p>\u7d22\u5f15\u91cd\u5efa\u5f88\u53ef\u80fd\u6210\u4e3a CPU\u3001\u5185\u5b58\u4ee5\u53ca\u78c1\u76d8\u5bc6\u96c6\u578b\u64cd\u4f5c\u3002\u5982\u679c\u4f60\u6709\u4e2a\u5927\u78c1\u76d8\u9635\u5217\uff0c\u90a3\u4e48\u5e76\u884c\u8fd0\u884c\u4e24\u4e2a\u6216\u4ee5\u4e0a\u91cd\u5efa\u6307\u4ee4\u662f\u975e\u5e38\u5408\u7406\u7684\u3002 \u5982\u524d\u6240\u8ff0\uff0c\u589e\u52a0 shared_buffers,checkpoint_segment,checkpoint_timeout,maintenance_work_mem \u53c2\u6570\u503c\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_70","title":"\u5e76\u884c\u6062\u590d","text":"<p>PostgreSQL 8.4 \u5f15\u5165\u4e86\u5e76\u884c\u6062\u590d\u673a\u5236\uff0c\u5b83\u5141\u8bb8\u4f60\u5206\u914d\u670d\u52a1\u5668\u4e0a\u7684\u591a\u4e2a CPU \u6838\u6765\u8fd0\u884c\u4e13\u95e8\u7684\u6570\u636e\u52a0\u8f7d\u8fdb\u7a0b\u3002\u4f7f\u7528\u5e76\u884c\u7248\u672c\u7684 pg_restore\uff0c\u5f88\u7b80\u5355\u4f60\u53ea\u9700\u8981\u6307\u5b9a\u4f60\u4e00\u6b21\u60f3\u8fd0\u884c \u591a\u5c11\u4e2a\"jobs\"\u5c31\u597d\u4e86\uff0c\u5b83\u5bf9\u6570\u636e\u52a0\u8f7d\u4ee5\u53ca\u7d22\u5f15\u91cd\u5efa\u548c\u589e\u52a0\u7ea6\u675f\u90fd\u6709\u63d0\u901f\u6548\u679c\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_71","title":"\u704c\u6570\u540e\u6e05\u7406\u5de5\u4f5c","text":"<p>\u704c\u6570\u5b8c\u6bd5\uff0c\u7d22\u5f15\u91cd\u5efa\u5b8c\u6210\uff0c\u7ea6\u675f\u589e\u52a0\u5b8c\u6bd5\u3002\u628a\u670d\u52a1\u5668\u4e0a\u7ebf\u4e4b\u524d\u8fd8\u6709\u4e24\u4e2a\u7ef4\u62a4\u5de5\u4f5c\u8981\u505a\u3002 \u7b2c\u4e00\u4e2a\u5fc5\u987b\u8981\u505a\u662f\u5bf9\u6bcf\u4e2a\u6570\u636e\u5e93\u6267\u884c ANALYZE \u6307\u4ee4\u3002\u786e\u4fdd\u7edf\u8ba1\u4fe1\u606f\u6709\u6548\u53ef\u7528\u3002\u540c\u65f6\u4e5f\u53ef\u4ee5\u8003\u8651\u8fd0\u884c\u6570\u636e\u5e93\u7ea7\u7684 VACUUM\u3002\u5f53\u7136\u4f60\u76f4\u63a5\u8fd0\u884c VACUUM ANALYZE \u4f1a\u66f4\u597d\u3002 \u7b2c\u4e8c\u4e2a\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u628a postgresql.conf \u91cc\u4fee\u6539\u8fc7\u7684\u53c2\u6570\u6062\u590d\u5230\u6b63\u5e38\u8bbe\u7f6e\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_72","title":"\u5e38\u89c1\u6027\u80fd\u95ee\u9898","text":"<p>\u5f88\u591a\u6027\u80fd\u95ee\u9898\u90fd\u662f\u6765\u81ea\u7cdf\u7cd5\u7684\u8bbe\u8ba1\u6216\u8005\u5b9e\u73b0\uff0c\u4f7f\u5f97 PostgreSQL \u65e0\u6cd5\u4ece\u6839\u672c\u4e0a\u5f88\u597d\u7684\u8fd0\u884c\u3002\u4e0b\u9762\u6211\u4eec\u5217\u4e3e\u4e00\u4e9b PostgreSQL \u65b0\u624b\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u6027\u80fd\u95ee\u9898\uff1a</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_73","title":"\u7edf\u8ba1\u884c\u6570","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u91cc\u5927\u90e8\u5206\u90fd\u6709\u7c7b\u4f3c\u4e0b\u9762\u7684 SQL \u8bed\u53e5\u6765\u8ba1\u7b97\u4e00\u4e2a\u8868\u91cc\u6709\u591a\u5c11\u884c\uff1a</p> <pre><code>    SELECT count(*) FROM t;\n</code></pre> <p>\u6709\u4e9b\u6570\u636e\u5e93\u53ef\u80fd\u6267\u884c\u8fd9\u4e2a\u5f88\u5feb\uff0c\u901a\u5e38\u4ed6\u4eec\u628a\u8fd9\u4e2a\u4fe1\u606f\u4fdd\u5b58\u5230\u4e00\u4e2a\u7d22\u5f15\u91cc\u6216\u8005\u7c7b\u4f3c\u7684\u7ed3\u6784\u91cc\u3002 \u4e0d\u5e78\u7684\u662f\uff0cPostgreSQL \u6ca1\u8fd9\u4e48\u5e72\uff0c\u5b83\u9700\u8981\u6267\u884c\u5168\u8868\u626b\u63cf\u624d\u80fd\u83b7\u5f97\u7ed3\u679c\uff0c\u8fd9\u5c31\u76f8\u5f53\u6162\u4e86\u3002 \u5bf9\u6b64\uff0cPostgreSQL \u63d0\u4f9b\u4e86\u4e24\u4e2a\u66ff\u4ee3\u65b9\u6cd5\u3002\u7b2c\u4e00\u4e2a\u65b9\u6cd5\u662f\u5bf9\u4e8e\u90a3\u4e9b\u5e76\u4e0d\u9700\u8981\u7cbe\u786e\u7684\u8868\u884c\u6570\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u7cfb\u7edf\u8868\u91cc\u67e5\u8be2\u76f8\u5173\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a</p> <p><code>SELECT reltuples FROM pg_class where relname='t'</code></p> <p>\u5982\u679c\u8fd0\u884c\u8be5 SQL \u8bed\u53e5\u4e4b\u524d\u521a\u597d\u8fd0\u884c\u8fc7 VACUUM \u6216\u8005 ANALYZE\uff0c\u5219\u8fd9\u4e2a\u7ed3\u679c\u662f\u51c6\u786e\u7684\uff0c\u800c\u4e0d\u662f\u4f30\u8ba1\u503c\u3002</p> <p>\u5982\u679c\u4f60\u6709\u540c\u540d\u7684\u8868\uff0c\u90a3\u4e48\u5c31\u52a0\u4e0a\u540d\u5b57\u7a7a\u95f4\u9650\u5b9a\uff0c\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>SELECT reltuples\nFROM pg_class C\nLEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)\nWHERE C.relname='t' and N.nspname = 'public';\n</code></pre> <p>\u7b2c\u4e8c\u529e\u6cd5\u662f\u5728\u8868\u4e0a\u521b\u5efa\u4e00\u4e2a\u89e6\u53d1\u5668\uff0c\u8ddf\u8e2a\u8868\u4e0a\u6570\u636e\u7684\u5220\u9664\u548c\u589e\u52a0\u64cd\u4f5c\uff0c\u4ece\u800c\u628a\u7edf\u8ba1\u884c\u6570\u8bb0\u5f55\u4e0b\u6765\u3002 \u5177\u4f53\u7684\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u4f8b\u5b50\uff1ahttp://wiki.postgresql.org/wiki/Slow_Counting</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_74","title":"\u5916\u952e\u5f00\u9500\u9ad8","text":"<p>\u5f53\u66f4\u65b0\u8bed\u53e5\u91cc\u6d89\u53ca\u5230\u5916\u952e\uff0c\u5176\u65f6\u95f4\u5f00\u9500\u5f88\u5927\uff0c\u7279\u522b\u662f\u6bcf\u6b21\u53ea\u505a\u4e00\u884c\u66f4\u65b0\u65f6\u3002\u5bf9\u4e8e\u6279\u91cf\u66f4\u65b0\uff0c\u53ef\u80fd\u7684\u4e00\u4e2a\u6027\u80fd\u63d0\u5347\u529e\u6cd5\u65f6\u628a\u5916\u952e\u7ea6\u675f\u6807\u8bb0\u4e3a DEFERRABLE\uff0c\u7f3a\u7701\u662f NOT DEFERRABLE\u3002\u4e0d\u8fc7\u8fd9\u79cd\u8bbe\u7f6e\u53ea\u5bf9\u628a\u5916\u952e\u548c\u76f8\u4f3c\u7ea6\u675f\u4f5c\u4e3a\u89e6\u53d1\u5668\u5b9e\u73b0\u65f6\u624d\u6709\u6548\uff0c\u800c\u5bf9\u4e8e CHECK \u4ee5\u53ca UNIQUE \u9650\u5b9a\u5219\u65e0\u80fd\u4e3a\u529b\u3002\u540e\u8005\u8981\u6c42\u7acb\u523b\u5904\u7406\uff0c\u4e0d\u80fd\u5ef6\u7f13\u3002</p> <p>\u5373\u4fbf\u5bf9\u4e8e\u7ea6\u675f\u5ef6\u7f13\uff0c\u4e5f\u6709\u4e24\u79cd\u60c5\u51b5\u3002\u5982\u679c\u68c0\u67e5\u6807\u8bb0\u4e3a INITIALLY IMMEDIATE\uff0c\u90a3\u4e5f\u4f1a\u7acb\u523b\u5904\u7406\uff0c\u800c\u4e0d\u662f\u5728\u4e8b\u52a1\u7684\u6700\u540e\u6765\u5904\u7406\u3002\u6b64\u65f6\u4f60\u53ef\u4ee5\u4fee\u6539\u7ea6\u675f\u4e3a INITIALLY DEFERRED\uff0c\u8fd9\u6837\u53ef\u4ee5 \u786e\u4fdd\u68c0\u67e5\u5728\u4e8b\u52a1\u6700\u540e\u5904\u7406\u3002</p> <p>\u5f53\u68c0\u67e5\u6807\u8bb0\u4e3a DEFERRABLE\uff0c\u5b83\u540c\u65f6\u4e3a INITIALLY IMMEDIATE \u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 SET CONSTRAINTS \u6307\u4ee4\u4fee\u6539\u90e8\u5206\u4f1a\u8bdd\u3002\u5176\u6807\u51c6\u505a\u6cd5\u662f\uff0c\u628a\u591a\u6761\u63d2\u5165\u6216\u66f4\u65b0\u8bed\u53e5\u653e\u5728 \u4e00\u4e2a\u4e8b\u52a1\u91cc\uff0c\u4e14\u4e8b\u52a1\u5f00\u5934\u6807\u8bb0\u6240\u6709\u7ea6\u675f\u4e3a\u5ef6\u7f13\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>BEGIN;\nSET CONSTRAINTS ALL DEFERRED;\n[ update or insert statements ]\nCOMMIT;\n</code></pre> <p>\u8fd9\u79cd\u5904\u7406\u65b9\u5f0f\u5bf9\u6279\u91cf\u66f4\u65b0/\u63d2\u5165\u53ef\u4ee5\u63d0\u5347\u6548\u7387\uff0c\u4f46\u662f\u5982\u679c\u91cf\u5f88\u5927\uff0c\u5219\u5728\u505a COMMIT \u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u963b\u585e\u670d\u52a1\u4e00\u6bb5\u65f6\u95f4\uff0c\u4ece\u800c\u5bfc\u81f4\u65e0\u6cd5\u5bf9\u5916\u54cd\u5e94\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_75","title":"\u89e6\u53d1\u5668\u5185\u5b58\u4f7f\u7528","text":"<p>\u5982\u679c\u4e00\u4e2a\u8868\u4e0a\u6709 AFTER \u7c7b\u578b\u89e6\u53d1\u5668\uff0c\u90a3\u4e48\u6bcf\u4e2a\u63d2\u5165\u8bed\u53e5\u90fd\u4f1a\u5728\u4e00\u4e2a\u5185\u5b58\u5217\u8868\u91cc\uff0c\u5982\u679c\u63d2\u5165\u7684\u6570\u91cf\u5f88\u5927\uff0c\u6bd4\u5982\u6279\u91cf\u52a0\u8f7d\u65f6\uff0c\u5c31\u6709\u53ef\u80fd\u51fa\u73b0 OOM\uff0c\u6216\u8005\u8fbe\u5230\u7cfb\u7edf\u8bbe\u7f6e\u7684\u5185\u5b58\u6781\u9650\u3002 \u56e0\u6b64\u5728\u6279\u91cf\u5012\u5165\u573a\u666f\u4e0b\uff0c\u8981\u6ce8\u610f AFTER \u7c7b\u578b\u89e6\u53d1\u5668\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_76","title":"\u6570\u636e\u5e93\u6027\u80fd\u5206\u6790","text":"<p>\u6709\u65f6\u8981\u627e\u51fa\u4f60\u7684\u4ee3\u7801\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u6709\u6548\u7684\u5de5\u4f5c\u7684\u529e\u6cd5\u65f6\u6df1\u5165\u5230\u6570\u636e\u5e93\u672c\u8eab\uff0c\u5e76\u67e5\u5230\u6709\u74f6\u9888\u7684\u4ee3\u7801\u3002\u6211\u4eec\u901a\u8fc7\u4e00\u4e9b\u5de5\u5177\u6765\u505a\u5230\u8fd9\u70b9\uff1a</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#gprof","title":"gprof","text":"<p>gprof \u662f\u4e00\u4e2a\u6807\u51c6\u7684 GNU \u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u53ef\u4ee5\u5728\u5927\u90e8\u5206\u7c7b UNIX \u7cfb\u7edf\u4e0a\u8fd0\u884c\uff0c\u7f16\u8bd1 PostgreSQL \u65f6\uff0c\u589e\u52a0--enable-profiling \u9009\u9879\uff0c\u5b83\u4f1a\u4ea7\u751f\u4e00\u4e2a gmon.out \u6587\u4ef6\uff0c\u8fd9\u6839\u636e\u53ef\u4ee5\u7528\u4e8e gprof \u6765\u505a\u6027\u80fd\u5206\u6790\u3002</p> <p>gprof \u7684\u4e3b\u8981\u95ee\u9898\u65f6\u5b83\u5728\u8ddf\u8e2a\u5230\u53ef\u52a0\u8f7d\u5e93\u7684\u51fd\u6570\u65f6\u4f1a\u51fa\u73b0\u5df2\u77e5\u95ee\u9898\u3002\u53e6\u5916\uff0c\u5b83\u4e5f\u5f88\u80fd\u6839\u636e\u5206\u6790\u4fe1\u606f\u6765\u83b7\u5f97\u4e0b\u5c42\u64cd\u4f5c\u7cfb\u7edf\u6b63\u5728\u505a\u4ec0\u4e48\u3002\u56e0\u6b64\uff0c\u7efc\u5408\u8fd9\u4e24\u4e2a\u9650\u5236\uff0cgprof \u53ea\u9002\u5408\u505a\u4e00\u4e9b\u7b80\u5355\u548c\u5355\u7eaf\u7684\u6570\u636e\u5e93\u64cd\u4f5c\u6027\u80fd\u5206\u6790\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#oprofile","title":"OProfile","text":"<p>OProfile \u53ef\u4ee5\u5206\u6790\u4efb\u4f55\u5728 Linux \u670d\u52a1\u5668\u4e0a\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u68d2\u7684\u5de5\u5177\u3002\u4e5f\u662f\u5f88\u591a\u5728 Linux \u5199\u7684\u7801\u519c\u4eec\u7684\u9996\u9009\u5de5\u5177\u3002http://wiki.postgresql.org/wiki/Profiling_with_OProfile\u4ecb\u7ecd\u7684\u5f88\u8be6\u7ec6\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#visual-studio","title":"Visual Studio","text":"<p>Windows \u5e73\u53f0\u7684\u6700\u4f73\u9009\u62e9(\u6216\u552f\u4e00\u9009\u62e9\uff1f)\uff0c\u4ece PostgreSQL 8.4 \u4ee5\u540e\u6709\u6548\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#dtrace","title":"DTrace","text":"<p>Sun \u516c\u53f8\u5728 2004 \u5e74\u53d1\u5e03\u7684 Solaris 10 \u4e2d\u5f15\u5165 DTrace\uff0c\u53ef\u80fd\u65f6\u6700\u5168\u9762\u7684\u6027\u80fd\u5206\u6790\u5de5\u5177\u3002</p> <p>PostgreSQL \u7f16\u8bd1\u65f6\u9700\u8981\u4f7f\u7528--enable-dtrace \u9009\u9879\u624d\u80fd\u4f7f\u7528 DTrace\uff0c\u5bf9\u4e8e\u5982\u4f55\u4f7f\u7528 DTrace\uff0c\u6050\u6016\u53ef\u4ee5\u7528\u4e00\u672c\u4e66\u7684\u5bb9\u91cf\u6765\u4ecb\u7ecd\u3002\u6211\u4eec\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684\u4e24\u4e2a\u94fe\u63a5\uff1a</p> <ul> <li> <p>http://www.postgresql.org/docs/current/interactive/dynamic-trace.html</p> </li> <li> <p>http://wiki.postgresql.org/wiki/DTrace</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#linux-systemtap","title":"Linux SystemTap","text":"<p>SystemTap \u662f Linux \u5e73\u53f0\u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u5176\u529f\u80fd\u7c7b\u4f3c DTrace\u3002\u5bf9\u4f7f\u7528\u4e86--enable-dtrace \u7f16\u8bd1\u7684 PostgreSQL\uff0cSystemTap \u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>\u76ee\u524d Fedora,RHEL \u7cfb\u7edf\u53d1\u578b\u73ed\u529e\u6cd5\u90fd\u80fd\u652f\u6301 SystemTap,\u4f46 Debian/Ununtu \u5219\u53ef\u80fd\u4f1a\u6709\u4e9b\u95ee\u9898\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_77","title":"\u4e0e\u7248\u672c\u6709\u5173\u7684\u6027\u80fd\u7279\u6027","text":"<p>\u4e66\u4e2d\u63cf\u8ff0\u4e86\u5404\u79cd\u548c\u7248\u672c\u6709\u5173\u7684\u6027\u80fd\u7279\u6027\uff0c\u8fd9\u91cc\u65f6\u6458\u5f55\u4e8e 9.0 \u6709\u5173\u7684\u7279\u6027\u3002</p>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_78","title":"\u590d\u5236","text":"<ul> <li> <p>\u5f02\u6b65\u4e3b\u4ece\u590d\u5236\u5df2\u7ecf\u5185\u7f6e\uff0c\u4e14\u4e0d\u9700\u8981\u914d\u7f6e\u592a\u591a\u989d\u5916\u811a\u672c</p> </li> <li> <p>\u590d\u5236\u7cfb\u7edf\u8fd8\u53ef\u4ee5\u914d\u7f6e\u4e3a HotStandby \u7528\u4e8e\u53ea\u8bfb\u67e5\u8be2</p> </li> <li> <p>\u63a7\u5236 WAL \u5f52\u6863\u53c2\u6570\u5206\u5f00\uff0c\u9664\u4e86\u5df2\u7ecf\u5b58\u5728\u7684 archive_mode \u548c archive_command \u4ee5\u5916\uff0c\u65b0\u589e\u4e86 wal_level \u53c2\u6570\u7528\u4e8e\u8bbe\u7f6e\u5141\u8bb8\u5199\u591a\u5c11\u4fe1\u606f\u5230 WAL \u91cc</p> </li> <li> <p>\u590d\u5236\u8fc7\u7a0b\u7684\u76d1\u63a7\u53ef\u4ee5\u901a\u8fc7 standby \u670d\u52a1\u5668\u4f7f\u7528 pg_last_xlog_receive_location()\u548c pg_last_xlog_replay_location()\u51fd\u6570\u5b9e\u73b0</p> </li> <li> <p>contrib/pg_archivecleanup \u5de5\u5177\u53ef\u4ee5\u7528\u4e8e\u6e05\u9664\u8001\u7684 WAL \u5f52\u6863\u6587\u4ef6\u3002\u8be5\u7a0b\u5e8f\u53ef\u4ee5\u88ab archive_cleanup_command \u53c2\u6570\u8c03\u7528</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_79","title":"\u67e5\u8be2\u548c\u5206\u6790","text":"<ul> <li> <p>EXPLAIN \u53ef\u4ee5\u8f93\u51fa\u4e3a XML\uff0cJSON \u6216 YAML \u683c\u5f0f\uff0c\u65b9\u4fbf\u5916\u90e8\u5de5\u5177\u5206\u6790</p> </li> <li> <p>EXPLAIN \uff08BUFFERS\uff09 \u53ef\u4ee5\u76d1\u63a7\u67d0\u4e2a\u7279\u5b9a\u67e5\u8be2\u7684\u5b9e\u9645 I/O,\u800c\u4e0d\u662f\u663e\u793a\u6210\u672c</p> </li> <li> <p>\u7a97\u53e3\u51fd\u6570\u65b0\u589e\u4e86\u8bf8\u5982 PRECEDING\uff0cFOLLOWING \u9009\u9879\uff0c\u4ee5\u53ca\u7528 CURRENT   ROWS \u5f00\u59cb\u7684\u9009\u9879</p> </li> <li> <p>\u5916\u8054\u63a5\u6240\u5f15\u7528\u5230\u7684\u8868\u5982\u679c\u5e76\u6ca1\u7528\u4e8e\u6ee1\u8db3\u67e5\u8be2\u8981\u6c42\uff0c\u5219\u4f1a\u4ece\u67e5\u8be2\u8ba1\u5212\u4e2d\u79fb\u53bb\u4ee5\u63d0\u5347\u6027\u80fd   \u3002\u4e00\u822c\u8fd9\u7c7b\u67e5\u8be2\u8bed\u53e5\u7531 ORM \u8f6f\u4ef6\u751f\u6210\u3002</p> </li> <li> <p>\u6bcf\u4e2a\u8868\u7a7a\u95f4\u53ef\u4ee5\u901a\u8fc7 ALTER   TABLESPACE \u6765\u5206\u914d\u81ea\u5df1\u7684\u987a\u5e8f\u548c\u968f\u673a\u9875\u67e5\u8be2\u4ee3\u4ef7\uff0c\u5bf9\u4e8e\u4e0d\u540c\u8868\u7a7a\u95f4\u5206\u914d\u5728\u4e0d\u540c\u901f\u5ea6\u7684\u5b58\u50a8\u4ecb\u8d28\u4e0a\u8fd9\u79cd\u60c5\u51b5\uff0c\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u8c03\u6574</p> </li> <li> <p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 ALTER   TABLE \u6765\u624b\u5de5\u8c03\u6574\u4e00\u4e2a\u5b57\u6bb5\u4e0d\u540c\u503c\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u5f53\u81ea\u52a8\u8bc4\u4f30\u6709\u95ee\u9898\u65f6\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u63d0\u5347\u6548\u7387</p> </li> <li> <p>\u4f7f\u7528 IS NOT NULL \u7684\u67e5\u8be2\u8bed\u53e5\u53ef\u4ee5\u4f7f\u7528\u7d22\u5f15</p> </li> <li> <p>\u57fa\u56e0\u67e5\u8be2\u4f18\u5316\u5668(Genetic Query Optimizer a.k.a   GEQO)\u73b0\u5728\u53ef\u4ee5\u5f3a\u5236\u4f7f\u7528\u56fa\u5b9a\u7684\u968f\u673a\u79cd\u5b50\u503c</p> </li> <li> <p>GIN \u7d22\u5f15\u4f7f\u7528\u81ea\u5e73\u8861\u7ea2\u9ed1\u6811(self-balancing Red-Black trees)</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_80","title":"\u6570\u636e\u5e93\u5f00\u53d1","text":"<ul> <li> <p>PL/pgSQL \u8bed\u53e5\u73b0\u5728\u7f3a\u7701\u5b89\u88c5\u5230\u6240\u6709\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u5220\u9664</p> </li> <li> <p>\u89e6\u53d1\u5668\u53ef\u4ee5\u9644\u7740\u5728\u7279\u5b9a\u7684\u5b57\u6bb5\u4e0a\uff0c\u4ee5\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8c03\u7528</p> </li> <li> <p>LISTEN/NOTIFY \u673a\u5236\u4f7f\u5f97\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u76f4\u63a5\u4f20\u9012\u6d88\u606f\u66f4\u5feb\uff0c\u800c\u4e14\u53ef\u4ee5\u53d1\u9001\"payload\"\u5b57\u7b26\u4e32\u4fe1\u606f\uff0c\u8fd9\u4f7f\u5f97\u4f7f\u7528\u6570\u636e\u5e93\u81ea\u8eab\u521b\u5efa\u8de8\u5ba2\u6237\u7aef\u6d88\u606f\u7cfb\u7edf\u6210\u4e3a\u53ef\u80fd</p> </li> <li> <p>\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u4f7f\u7528 application_name \u6765\u8bbe\u7f6e\uff0c\u4f7f\u5f97 pg_stat_activity \u4fe1\u606f\u91cc\u663e\u793a\u51fa\u5e94\u7528\u7a0b\u5e8f\u540d\u5b57</p> </li> <li> <p>\u552f\u4e00\u7ea6\u675f\u8fdd\u4f8b\u53d1\u751f\u65f6\u7ed9\u51fa\u7684\u9519\u8bef\u4fe1\u606f\u91cc\u5305\u62ec\u7684\u8bbe\u8ba1\u5230\u7684\u503c\uff0c\u8fd9\u4f7f\u5f97\u5b9a\u4f4d\u5230\u5e95\u65f6\u90a3\u91cc\u5bfc\u81f4\u53d1\u751f\u9519\u8bef\u53d8\u5f97\u5bb9\u6613</p> </li> <li> <p>\u7ea6\u675f\u68c0\u67e5\u53ef\u4ee5\u6807\u8bb0\u4e3a DEFERRABLE</p> </li> <li> <p>\u65b0\u5f15\u8fdb\u6392\u4ed6\u6027\u7ea6\u675f(exclusion constraints)\uff0c\u548c\u552f\u4e00\u6027\u7ea6\u675f\u7c7b\u4f3c</p> </li> <li> <p>contrib/hstore \u6a21\u5757\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4f4e\u5f00\u9500\u7684\u952e\u503c\u5bf9(key/value)\u5b58\u50a8\u7c7b\u578b</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_81","title":"\u914d\u7f6e\u548c\u76d1\u63a7","text":"<ul> <li> <p>\u670d\u52a1\u5668\u53c2\u6570\u53ef\u4ee5\u88ab\u7528\u6237/\u6570\u636e\u5e93\u7ec4\u5408\u8c03\u6574</p> </li> <li> <p>\u5f53 postgresql.conf \u6587\u4ef6\u88ab\u88ab pg_ctl   reload \u6216\u53d1\u9001 SIGHUP \u4fe1\u53f7\u7ed9\u670d\u52a1\u800c\u91cd\u8f7d\u65f6\uff0c\u670d\u52a1\u5668\u65e5\u5fd7\u4f1a\u6ce8\u610f\u5230\u54ea\u4e9b\u53c2\u6570\u88ab\u4fee\u6539\u4e86</p> </li> <li> <p>\u4f7f\u7528 pg_stat_reset_shared('bgwriter')\u51fd\u6570\u53ef\u4ee5\u91cd\u7f6e\u540e\u53f0\u5199\u7edf\u8ba1</p> </li> <li> <p>\u4f7f\u7528 pg_stat_reset_single_table_counters()\u548c pg_stat_reset_single_function_counters()\u53ef\u4ee5\u5206\u522b\u5355\u72ec\u9488\u5bf9\u8868\u548c\u51fd\u6570\u8ba1\u6570\u5668\u8fdb\u884c\u91cd\u7f6e</p> </li> <li> <p>log_temp_files \u53c2\u6570\u53ef\u4ee5\u7528 KB \u5355\u4f4d\u6765\u6307\u5b9a</p> </li> <li> <p>log_line_prefix \u53ef\u4ee5\u8ffd\u8e2a\u8bf8\u5982\u9519\u8bef\u6d88\u606f\u91cc\u8bbe\u7f6e\u7684 SQLSTATE \u503c\uff0c\u8fd9\u5c31\u4f7f\u5f97\u65e5\u5fd7\u53ef\u4ee5\u66f4\u597d\u7684\u5206\u6790\u5bfc\u81f4\u9519\u8bef\u53d1\u751f\u7684\u786e\u5207\u4ee3\u7801</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_82","title":"\u5de5\u5177","text":"<ul> <li> <p>pgbench \u53ef\u4ee5\u8fd0\u884c\u591a\u8fdb\u7a0b/\u591a\u7ebf\u7a0b\u6a21\u5f0f\u6027\u80fd\u6d4b\u8bd5</p> </li> <li> <p>contrib/auto_explain \u6a21\u5757\u53ef\u4ee5\u8f93\u51fa\u67e5\u8be2\u8bed\u53e5\u4ee5\u53ca\u5b83\u7684\u6267\u884c\u8ba1\u5212</p> </li> <li> <p>contrib/pg_stat_statements \u53ef\u4ee5\u624b\u673a\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\u5305\u62ec\u6bcf\u4e2a\u8bed\u53e5\u6240\u6709\u7684\u6d3b\u52a8\u7f13\u5b58\u4fe1\u606f</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/pg9_high_performance_notes/#_83","title":"\u5185\u90e8","text":"<ul> <li> <p>contrib/pg_upgrade \u5de5\u5177\u53ef\u4ee5\u4ece\u65e9\u671f\u7684 8.\u215c.4 \u7248\u672c\u5e73\u6ed1\u5347\u7ea7\u5230 9.0,\u4e0d\u9700\u8981\u5bfc\u51fa\u5bfc\u5165\u6570\u636e\uff0c\u8fd9\u4e2d\u65b9\u5f0f\u4e00\u822c\u79f0\u4e3a\u5c31\u5730\u66f4\u65b0(\\\"in-place   upgrade\\\")</p> </li> <li> <p>VACUUM   FULL \u4f7f\u7528\u4e86\u65e9\u671f\u7248\u672c\u4e2d CLUSTER \u4e2d\u4f7f\u7528\u7684\u91cd\u5efa\u673a\u5236\u3002\u5b83\u9700\u8981\u66f4\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\uff0c\u4f46\u66f4\u5feb\u800c\u4e14\u53ef\u4ee5\u907f\u514d\u7d22\u5f15\u81a8\u80c0</p> </li> <li> <p>\u7f16\u8bd1\u65f6\u9ed8\u8ba4\u4f7f\u7528--enable-thread-safety\u3002\u8be5\u9009\u9879\u5141\u8bb8\u591a\u7ebf\u7a0b\u5ba2\u6237\u7aef\u7a0b\u5e8f\u4f7f\u7528\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u5e93\u6765\u7f16\u8bd1\uff0c\u4ece\u800c\u5b89\u5168\u8fd0\u884c\u3002\u65e9\u8d77\u7248\u672c\u9ed8\u8ba4\u4e0d\u5f00\u542f\u8be5\u7279\u6027</p> </li> <li> <p>\u6570\u636e\u5e93\u6709\u81ea\u5df1\u66f4\u597d\u7684\u529e\u6cd5\u5904\u7406 OOM \u7684\u95ee\u9898</p> </li> <li> <p>\u6709\u51e0\u4e2a\u6307\u4ee4\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528()\u5305\u62ec\u7684\u5217\u8868\u6765\u4f20\u9012\u9009\u9879\uff0c\u800c\u4e0d\u662f\u4f20\u7edf\u7684 SQL \u8bed\u6cd5\u3002EXPLAIN\uff0cCOPY\uff0cVACUUM \u76ee\u524d\u90fd\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u7279\u6027</p> </li> </ul>","tags":["postgresql","performance"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/","title":"\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e00\u90e8\u5206","text":"<p>Source</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e00\u90e8\u5206</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#00","title":"00\u73af\u5883\u8bf4\u660e","text":"<p>\u8fd95\u7bc7\u5185\u5bb9\u7684\u6d4b\u8bd5\u548c\u9a8c\u8bc1\u5206\u522b\u5728 MySQL 5.7.41 \u4ee5\u53ca MySQL 8.0.32 \u4e0a\u8fdb\u884c\u3002\u4e24\u4e2a\u670d\u52a1\u5206\u522b\u5728\u4e24\u53f0\u914d\u7f6e\u76f8\u540c\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u4fe1\u606f\u5982\u4e0b\uff1a</p> <ul> <li>\u578b\u53f7\uff1aDell R640</li> <li>CPU:  Intel(R) Xeon(R) Silver 4216 CPU @ 2.10GHz 32\u6838</li> <li>\u5185\u5b58\uff1a64G</li> <li>OS: RHEL 7.6 x86_64</li> <li>kernel: 5.19.11-1.el7.elrepo</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#01-sql","title":"01 \u57fa\u7840\u67b6\u6784\uff1a\u4e00\u6761SQL\u67e5\u8be2\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f","text":"<p>\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u6570\u636e\u5e93\uff0c\u770b\u5230\u7684\u901a\u5e38\u90fd\u662f\u4e00\u4e2a\u6574\u4f53\u3002\u6bd4\u5982\uff0c\u4f60\u6709\u4e2a\u6700\u7b80\u5355\u7684\u8868\uff0c\u8868\u91cc\u53ea\u6709\u4e00\u4e2a ID \u5b57\u6bb5\uff0c\u5728\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u65f6\uff1a</p> <pre><code>mysql&gt; select * from T where ID=10\uff1b\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u7684\u53ea\u662f\u8f93\u5165\u4e00\u6761\u8bed\u53e5\uff0c\u8fd4\u56de\u4e00\u4e2a\u7ed3\u679c\uff0c\u5374\u4e0d\u77e5\u9053\u8fd9\u6761\u8bed\u53e5\u5728 MySQL \u5185\u90e8\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p> <p>\u6240\u4ee5\u4eca\u5929\u6211\u60f3\u548c\u4f60\u4e00\u8d77\u628a MySQL \u62c6\u89e3\u4e00\u4e0b\uff0c\u770b\u770b\u91cc\u9762\u90fd\u6709\u54ea\u4e9b\u201c\u96f6\u4ef6\u201d\uff0c\u5e0c\u671b\u501f\u7531\u8fd9\u4e2a\u62c6\u89e3\u8fc7\u7a0b\uff0c\u8ba9\u4f60\u5bf9 MySQL \u6709\u66f4\u6df1\u5165\u7684\u7406\u89e3\u3002\u8fd9\u6837\u5f53\u6211\u4eec\u78b0\u5230 MySQL \u7684\u4e00\u4e9b\u5f02\u5e38\u6216\u8005\u95ee\u9898\u65f6\uff0c\u5c31\u80fd\u591f\u76f4\u6233\u672c\u8d28\uff0c\u66f4\u4e3a\u5feb\u901f\u5730\u5b9a\u4f4d\u5e76\u89e3\u51b3\u95ee\u9898\u3002</p> <p>\u4e0b\u9762\u6211\u7ed9\u51fa\u7684\u662f MySQL \u7684\u57fa\u672c\u67b6\u6784\u793a\u610f\u56fe\uff0c\u4ece\u4e2d\u4f60\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 SQL \u8bed\u53e5\u5728 MySQL \u7684\u5404\u4e2a\u529f\u80fd\u6a21\u5757\u4e2d\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p> <pre><code>graph \n    %%define comment\n    client[\"fa:fa-user \u5ba2\u6237\u7aef\"]\n    subgraph Server\n        direction TB\n        connector(\"\u8fde\u63a5\u5668&lt;br/&gt;\u7ba1\u7406\u8fde\u63a5\uff0c\u6743\u9650\u9a8c\u8bc1\")\n        qc(\"\u67e5\u8be2\u7f13\u5b58&lt;br/&gt;\u547d\u4e2d\u5219\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\")\n        analyzer(\"\u5206\u6790\u5668&lt;br/&gt;\u8bcd\u6cd5\u5206\u6790\uff0c\u8bed\u6cd5\u5206\u6790\")\n        optimizer(\"\u4f18\u5316\u5668&lt;br/&gt;\u6267\u884c\u8ba1\u5212\u751f\u6210\uff0c\u7d22\u5f15\u9009\u62e9\")\n        executor(\"\u6267\u884c\u5668&lt;br/&gt;\u64cd\u4f5c\u5f15\u64ce\uff0c\u8fd4\u56de\u7ed3\u679c\")\n\n        connector --&gt; qc\n        connector --&gt; analyzer --&gt; optimizer --&gt; executor\n        analyzer --&gt; qc\n    end\n\n    subgraph Storage\n        direction LR\n        node1(\u5b58\u50a8\u5f15\u64ce)\n        node2(\u5b58\u50a8\u5f15\u64ce)\n        node3(\u5b58\u50a8\u5f15\u64ce)\n\n        node1:::nolink -.- node2 -.- node3\n\n        linkStyle 5,6 nolink stroke:white,stroke-width:0px;\n    end\n\n    client --&gt; Server\n    Server --&gt; Storage</code></pre> <p>\u5927\u4f53\u6765\u8bf4\uff0cMySQL \u53ef\u4ee5\u5206\u4e3a Server \u5c42\u548c\u5b58\u50a8\u5f15\u64ce\u5c42\u4e24\u90e8\u5206\u3002</p> <p>Server \u5c42\u5305\u62ec\u8fde\u63a5\u5668\u3001\u67e5\u8be2\u7f13\u5b58\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\uff0c\u6db5\u76d6 MySQL \u7684\u5927\u591a\u6570\u6838\u5fc3\u670d\u52a1\u529f\u80fd\uff0c\u4ee5\u53ca\u6240\u6709\u7684\u5185\u7f6e\u51fd\u6570\uff08\u5982\u65e5\u671f\u3001\u65f6\u95f4\u3001\u6570\u5b66\u548c\u52a0\u5bc6\u51fd\u6570\u7b49\uff09\uff0c\u6240\u6709\u8de8\u5b58\u50a8\u5f15\u64ce\u7684\u529f\u80fd\u90fd\u5728\u8fd9\u4e00\u5c42\u5b9e\u73b0\uff0c\u6bd4\u5982\u5b58\u50a8\u8fc7\u7a0b\u3001\u89e6\u53d1\u5668\u3001\u89c6\u56fe\u7b49\u3002</p> <p>\u800c\u5b58\u50a8\u5f15\u64ce\u5c42\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\u3002\u5176\u67b6\u6784\u6a21\u5f0f\u662f\u63d2\u4ef6\u5f0f\u7684\uff0c\u652f\u6301 InnoDB\u3001MyISAM\u3001Memory \u7b49\u591a\u4e2a\u5b58\u50a8\u5f15\u64ce\u3002\u73b0\u5728\u6700\u5e38\u7528\u7684\u5b58\u50a8\u5f15\u64ce\u662f InnoDB\uff0c\u5b83\u4ece MySQL 5.5.5 \u7248\u672c\u5f00\u59cb\u6210\u4e3a\u4e86\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u6267\u884c create table \u5efa\u8868\u7684\u65f6\u5019\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u5f15\u64ce\u7c7b\u578b\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5c31\u662f InnoDB\u3002\u4e0d\u8fc7\uff0c\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u5b58\u50a8\u5f15\u64ce\u7684\u7c7b\u578b\u6765\u9009\u62e9\u522b\u7684\u5f15\u64ce\uff0c\u6bd4\u5982\u5728 create table \u8bed\u53e5\u4e2d\u4f7f\u7528 engine=memory, \u6765\u6307\u5b9a\u4f7f\u7528\u5185\u5b58\u5f15\u64ce\u521b\u5efa\u8868\u3002\u4e0d\u540c\u5b58\u50a8\u5f15\u64ce\u7684\u8868\u6570\u636e\u5b58\u53d6\u65b9\u5f0f\u4e0d\u540c\uff0c\u652f\u6301\u7684\u529f\u80fd\u4e5f\u4e0d\u540c\uff0c\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4f1a\u8ba8\u8bba\u5230\u5f15\u64ce\u7684\u9009\u62e9\u3002</p> <p>\u4ece\u56fe\u4e2d\u4e0d\u96be\u770b\u51fa\uff0c\u4e0d\u540c\u7684\u5b58\u50a8\u5f15\u64ce\u5171\u7528\u4e00\u4e2a**Server \u5c42**\uff0c\u4e5f\u5c31\u662f\u4ece\u8fde\u63a5\u5668\u5230\u6267\u884c\u5668\u7684\u90e8\u5206\u3002\u4f60\u53ef\u4ee5\u5148\u5bf9\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u540d\u5b57\u6709\u4e2a\u5370\u8c61\uff0c\u63a5\u4e0b\u6765\u6211\u4f1a\u7ed3\u5408\u5f00\u5934\u63d0\u5230\u7684\u90a3\u6761 SQL \u8bed\u53e5\uff0c\u5e26\u4f60\u8d70\u4e00\u904d\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\uff0c\u4f9d\u6b21\u770b\u4e0b\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u4f5c\u7528\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_1","title":"\u8fde\u63a5\u5668","text":"<p>\u7b2c\u4e00\u6b65\uff0c\u4f60\u4f1a\u5148\u8fde\u63a5\u5230\u8fd9\u4e2a\u6570\u636e\u5e93\u4e0a\uff0c\u8fd9\u65f6\u5019\u63a5\u5f85\u4f60\u7684\u5c31\u662f\u8fde\u63a5\u5668\u3002\u8fde\u63a5\u5668\u8d1f\u8d23\u8ddf\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\u3001\u83b7\u53d6\u6743\u9650\u3001\u7ef4\u6301\u548c\u7ba1\u7406\u8fde\u63a5\u3002\u8fde\u63a5\u547d\u4ee4\u4e00\u822c\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p> <pre><code>mysql -h$ip -P$port -u$user -p\n</code></pre> <p>\u8f93\u5b8c\u547d\u4ee4\u4e4b\u540e\uff0c\u4f60\u5c31\u9700\u8981\u5728\u4ea4\u4e92\u5bf9\u8bdd\u91cc\u9762\u8f93\u5165\u5bc6\u7801\u3002\u867d\u7136\u5bc6\u7801\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8ddf\u5728 -p \u540e\u9762\u5199\u5728\u547d\u4ee4\u884c\u4e2d\uff0c\u4f46\u8fd9\u6837\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4f60\u7684\u5bc6\u7801\u6cc4\u9732\u3002\u5982\u679c\u4f60\u8fde\u7684\u662f\u751f\u4ea7\u670d\u52a1\u5668\uff0c\u5f3a\u70c8\u5efa\u8bae\u4f60\u4e0d\u8981\u8fd9\u4e48\u505a\u3002</p> <p>\u8fde\u63a5\u547d\u4ee4\u4e2d\u7684 mysql \u662f\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u7528\u6765\u8ddf\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\u3002\u5728\u5b8c\u6210\u7ecf\u5178\u7684 TCP \u63e1\u624b\u540e\uff0c\u8fde\u63a5\u5668\u5c31\u8981\u5f00\u59cb\u8ba4\u8bc1\u4f60\u7684\u8eab\u4efd\uff0c\u8fd9\u4e2a\u65f6\u5019\u7528\u7684\u5c31\u662f\u4f60\u8f93\u5165\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</p> <ul> <li>\u5982\u679c\u7528\u6237\u540d\u6216\u5bc6\u7801\u4e0d\u5bf9\uff0c\u4f60\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\"Access denied for user\"\u7684\u9519\u8bef\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u7a0b\u5e8f\u7ed3\u675f\u6267\u884c\u3002</li> <li>\u5982\u679c\u7528\u6237\u540d\u5bc6\u7801\u8ba4\u8bc1\u901a\u8fc7\uff0c\u8fde\u63a5\u5668\u4f1a\u5230\u6743\u9650\u8868\u91cc\u9762\u67e5\u51fa\u4f60\u62e5\u6709\u7684\u6743\u9650\u3002\u4e4b\u540e\uff0c\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7684\u6743\u9650\u5224\u65ad\u903b\u8f91\uff0c\u90fd\u5c06\u4f9d\u8d56\u4e8e\u6b64\u65f6\u8bfb\u5230\u7684\u6743\u9650\u3002</li> </ul> <p>\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u4e00\u4e2a\u7528\u6237\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u5373\u4f7f\u4f60\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u5bf9\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\u505a\u4e86\u4fee\u6539\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5df2\u7ecf\u5b58\u5728\u8fde\u63a5\u7684\u6743\u9650\u3002\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u53ea\u6709\u518d\u65b0\u5efa\u7684\u8fde\u63a5\u624d\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u8bbe\u7f6e\u3002</p> <p>\u8fde\u63a5\u5b8c\u6210\u540e\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u540e\u7eed\u7684\u52a8\u4f5c\uff0c\u8fd9\u4e2a\u8fde\u63a5\u5c31\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u5728 show processlist \u547d\u4ee4\u4e2d\u770b\u5230\u5b83\u3002\u6587\u672c\u4e2d\u8fd9\u4e2a\u56fe\u662f show processlist \u7684\u7ed3\u679c\uff0c\u5176\u4e2d\u7684 Command \u5217\u663e\u793a\u4e3a\u201cSleep\u201d\u7684\u8fd9\u4e00\u884c\uff0c\u5c31\u8868\u793a\u73b0\u5728\u7cfb\u7edf\u91cc\u9762\u6709\u4e00\u4e2a\u7a7a\u95f2\u8fde\u63a5\u3002</p> <pre><code>mysql&gt; show processlist;\n+----+-----------------+------------------+------+---------+------+------------------------+------------------+\n| Id | User            | Host             | db   | Command | Time | State                  | Info             |\n+----+-----------------+------------------+------+---------+------+------------------------+------------------+\n|  4 | event_scheduler | localhost        | NULL | Daemon  |    7 | Waiting on empty queue | NULL             |\n|  8 | root            | localhost        | NULL | Query   |    0 | starting               | show processlist |\n| 10 | my              | 192.168.1.2:24691| test | Sleep   |   53 |                        | NULL             |\n+----+-----------------+------------------+------+---------+------+------------------------+------------------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u5ba2\u6237\u7aef\u5982\u679c\u592a\u957f\u65f6\u95f4\u6ca1\u52a8\u9759\uff0c\u8fde\u63a5\u5668\u5c31\u4f1a\u81ea\u52a8\u5c06\u5b83\u65ad\u5f00\u3002\u8fd9\u4e2a\u65f6\u95f4\u662f\u7531\u53c2\u6570 <code>wait_timeout</code> \u63a7\u5236\u7684\uff0c\u9ed8\u8ba4\u503c\u662f 8 \u5c0f\u65f6(28800)\u3002</p> <p>\u5982\u679c\u5728\u8fde\u63a5\u88ab\u65ad\u5f00\u4e4b\u540e\uff0c\u5ba2\u6237\u7aef\u518d\u6b21\u53d1\u9001\u8bf7\u6c42\u7684\u8bdd\uff0c\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\u9519\u8bef\u63d0\u9192\uff1a <code>Lost connection to MySQL server during query</code>\u3002\u8fd9\u65f6\u5019\u5982\u679c\u4f60\u8981\u7ee7\u7eed\uff0c\u5c31\u9700\u8981\u91cd\u8fde\uff0c\u7136\u540e\u518d\u6267\u884c\u8bf7\u6c42\u4e86\u3002</p> <p>\u6570\u636e\u5e93\u91cc\u9762\uff0c\u957f\u8fde\u63a5\u662f\u6307\u8fde\u63a5\u6210\u529f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u6301\u7eed\u6709\u8bf7\u6c42\uff0c\u5219\u4e00\u76f4\u4f7f\u7528\u540c\u4e00\u4e2a\u8fde\u63a5\u3002\u77ed\u8fde\u63a5\u5219\u662f\u6307\u6bcf\u6b21\u6267\u884c\u5b8c\u5f88\u5c11\u7684\u51e0\u6b21\u67e5\u8be2\u5c31\u65ad\u5f00\u8fde\u63a5\uff0c\u4e0b\u6b21\u67e5\u8be2\u518d\u91cd\u65b0\u5efa\u7acb\u4e00\u4e2a\u3002</p> <p>\u5efa\u7acb\u8fde\u63a5\u7684\u8fc7\u7a0b\u901a\u5e38\u662f\u6bd4\u8f83\u590d\u6742\u7684\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\u5728\u4f7f\u7528\u4e2d\u8981\u5c3d\u91cf\u51cf\u5c11\u5efa\u7acb\u8fde\u63a5\u7684\u52a8\u4f5c\uff0c\u4e5f\u5c31\u662f\u5c3d\u91cf\u4f7f\u7528\u957f\u8fde\u63a5\u3002</p> <p>\u4f46\u662f\u5168\u90e8\u4f7f\u7528\u957f\u8fde\u63a5\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u6709\u4e9b\u65f6\u5019 MySQL \u5360\u7528\u5185\u5b58\u6da8\u5f97\u7279\u522b\u5feb\uff0c\u8fd9\u662f\u56e0\u4e3a MySQL \u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e34\u65f6\u4f7f\u7528\u7684\u5185\u5b58\u662f\u7ba1\u7406\u5728\u8fde\u63a5\u5bf9\u8c61\u91cc\u9762\u7684\u3002\u8fd9\u4e9b\u8d44\u6e90\u4f1a\u5728\u8fde\u63a5\u65ad\u5f00\u7684\u65f6\u5019\u624d\u91ca\u653e\u3002\u6240\u4ee5\u5982\u679c\u957f\u8fde\u63a5\u7d2f\u79ef\u4e0b\u6765\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u592a\u5927\uff0c\u88ab\u7cfb\u7edf\u5f3a\u884c\u6740\u6389\uff08OOM\uff09\uff0c\u4ece\u73b0\u8c61\u770b\u5c31\u662f MySQL \u5f02\u5e38\u91cd\u542f\u4e86\u3002</p> <p>\u600e\u4e48\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f\u4f60\u53ef\u4ee5\u8003\u8651\u4ee5\u4e0b\u4e24\u79cd\u65b9\u6848\u3002</p> <ol> <li>\u5b9a\u671f\u65ad\u5f00\u957f\u8fde\u63a5\u3002\u4f7f\u7528\u4e00\u6bb5\u65f6\u95f4\uff0c\u6216\u8005\u7a0b\u5e8f\u91cc\u9762\u5224\u65ad\u6267\u884c\u8fc7\u4e00\u4e2a\u5360\u7528\u5185\u5b58\u7684\u5927\u67e5\u8be2\u540e\uff0c\u65ad\u5f00\u8fde\u63a5\uff0c\u4e4b\u540e\u8981\u67e5\u8be2\u518d\u91cd\u8fde\u3002</li> <li>\u5982\u679c\u4f60\u7528\u7684\u662f MySQL 5.7 \u6216\u66f4\u65b0\u7248\u672c\uff0c\u53ef\u4ee5\u5728\u6bcf\u6b21\u6267\u884c\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u64cd\u4f5c\u540e\uff0c\u901a\u8fc7\u6267\u884c <code>mysql_reset_connection</code> \u6765\u91cd\u65b0\u521d\u59cb\u5316\u8fde\u63a5\u8d44\u6e90\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u91cd\u8fde\u548c\u91cd\u65b0\u505a\u6743\u9650\u9a8c\u8bc1\uff0c\u4f46\u662f\u4f1a\u5c06\u8fde\u63a5\u6062\u590d\u5230\u521a\u521a\u521b\u5efa\u5b8c\u65f6\u7684\u72b6\u6001\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_2","title":"\u67e5\u8be2\u7f13\u5b58","text":"<p>\u8fde\u63a5\u5efa\u7acb\u5b8c\u6210\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u6267\u884c select \u8bed\u53e5\u4e86\u3002\u6267\u884c\u903b\u8f91\u5c31\u4f1a\u6765\u5230\u7b2c\u4e8c\u6b65\uff1a\u67e5\u8be2\u7f13\u5b58\u3002</p> <p>MySQL \u62ff\u5230\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u540e\uff0c\u4f1a\u5148\u5230\u67e5\u8be2\u7f13\u5b58\u770b\u770b\uff0c\u4e4b\u524d\u662f\u4e0d\u662f\u6267\u884c\u8fc7\u8fd9\u6761\u8bed\u53e5\u3002\u4e4b\u524d\u6267\u884c\u8fc7\u7684\u8bed\u53e5\u53ca\u5176\u7ed3\u679c\u53ef\u80fd\u4f1a\u4ee5 key-value \u5bf9\u7684\u5f62\u5f0f\uff0c\u88ab\u76f4\u63a5\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u3002key \u662f\u67e5\u8be2\u7684\u8bed\u53e5\uff0cvalue \u662f\u67e5\u8be2\u7684\u7ed3\u679c\u3002\u5982\u679c\u4f60\u7684\u67e5\u8be2\u80fd\u591f\u76f4\u63a5\u5728\u8fd9\u4e2a\u7f13\u5b58\u4e2d\u627e\u5230 key\uff0c\u90a3\u4e48\u8fd9\u4e2a value \u5c31\u4f1a\u88ab\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</p> <p>\u5982\u679c\u8bed\u53e5\u4e0d\u5728\u67e5\u8be2\u7f13\u5b58\u4e2d\uff0c\u5c31\u4f1a\u7ee7\u7eed\u540e\u9762\u7684\u6267\u884c\u9636\u6bb5\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u6267\u884c\u7ed3\u679c\u4f1a\u88ab\u5b58\u5165\u67e5\u8be2\u7f13\u5b58\u4e2d\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u67e5\u8be2\u547d\u4e2d\u7f13\u5b58\uff0cMySQL \u4e0d\u9700\u8981\u6267\u884c\u540e\u9762\u7684\u590d\u6742\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd9\u4e2a\u6548\u7387\u4f1a\u5f88\u9ad8\u3002</p> <p>\u4f46\u662f\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u4e0d\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u56e0\u4e3a\u67e5\u8be2\u7f13\u5b58\u5f80\u5f80\u5f0a\u5927\u4e8e\u5229\u3002</p> <p>\u67e5\u8be2\u7f13\u5b58\u7684\u5931\u6548\u975e\u5e38\u9891\u7e41\uff0c\u53ea\u8981\u6709\u5bf9\u4e00\u4e2a\u8868\u7684\u66f4\u65b0\uff0c\u8fd9\u4e2a\u8868\u4e0a\u6240\u6709\u7684\u67e5\u8be2\u7f13\u5b58\u90fd\u4f1a\u88ab\u6e05\u7a7a\u3002\u56e0\u6b64\u5f88\u53ef\u80fd\u4f60\u8d39\u52b2\u5730\u628a\u7ed3\u679c\u5b58\u8d77\u6765\uff0c\u8fd8\u6ca1\u4f7f\u7528\u5462\uff0c\u5c31\u88ab\u4e00\u4e2a\u66f4\u65b0\u5168\u6e05\u7a7a\u4e86\u3002\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u5927\u7684\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u67e5\u8be2\u7f13\u5b58\u7684\u547d\u4e2d\u7387\u4f1a\u975e\u5e38\u4f4e\u3002\u9664\u975e\u4f60\u7684\u4e1a\u52a1\u5c31\u662f\u6709\u4e00\u5f20\u9759\u6001\u8868\uff0c\u5f88\u957f\u65f6\u95f4\u624d\u4f1a\u66f4\u65b0\u4e00\u6b21\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u7cfb\u7edf\u914d\u7f6e\u8868\uff0c\u90a3\u8fd9\u5f20\u8868\u4e0a\u7684\u67e5\u8be2\u624d\u9002\u5408\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002</p> <p>\u597d\u5728 MySQL \u4e5f\u63d0\u4f9b\u4e86\u8fd9\u79cd\u201c\u6309\u9700\u4f7f\u7528\u201d\u7684\u65b9\u5f0f\u3002\u4f60\u53ef\u4ee5\u5c06\u53c2\u6570 <code>query_cache_type</code> \u8bbe\u7f6e\u6210 DEMAND(\u8be5\u53c2\u6570\u5728<code>5.7.41</code> \u9ed8\u8ba4\u662f <code>OFF</code>)\uff0c\u8fd9\u6837\u5bf9\u4e8e\u9ed8\u8ba4\u7684 SQL \u8bed\u53e5\u90fd\u4e0d\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002\u800c\u5bf9\u4e8e\u4f60\u786e\u5b9a\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u8bed\u53e5\uff0c\u53ef\u4ee5\u7528 SQL_CACHE \u663e\u5f0f\u6307\u5b9a\uff0c\u50cf\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e00\u6837\uff1a</p> <pre><code>mysql&gt; select SQL_CACHE * from T where ID=10\uff1b\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cMySQL 8.0 \u7248\u672c\u76f4\u63a5\u5c06\u67e5\u8be2\u7f13\u5b58\u7684\u6574\u5757\u529f\u80fd\u5220\u6389\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4 8.0.3 \u5f00\u59cb\u5f7b\u5e95\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_3","title":"\u5206\u6790\u5668","text":"<p>\u5982\u679c\u6ca1\u6709\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u5c31\u8981\u5f00\u59cb\u771f\u6b63\u6267\u884c\u8bed\u53e5\u4e86\u3002\u9996\u5148\uff0cMySQL \u9700\u8981\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\uff0c\u56e0\u6b64\u9700\u8981\u5bf9 SQL \u8bed\u53e5\u505a\u89e3\u6790\u3002</p> <p>\u5206\u6790\u5668\u5148\u4f1a\u505a\u201c\u8bcd\u6cd5\u5206\u6790\u201d\u3002\u4f60\u8f93\u5165\u7684\u662f\u7531\u591a\u4e2a\u5b57\u7b26\u4e32\u548c\u7a7a\u683c\u7ec4\u6210\u7684\u4e00\u6761 SQL \u8bed\u53e5\uff0cMySQL \u9700\u8981\u8bc6\u522b\u51fa\u91cc\u9762\u7684\u5b57\u7b26\u4e32\u5206\u522b\u662f\u4ec0\u4e48\uff0c\u4ee3\u8868\u4ec0\u4e48\u3002</p> <p>MySQL \u4ece\u4f60\u8f93\u5165\u7684\"select\"\u8fd9\u4e2a\u5173\u952e\u5b57\u8bc6\u522b\u51fa\u6765\uff0c\u8fd9\u662f\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u3002\u5b83\u4e5f\u8981\u628a\u5b57\u7b26\u4e32\u201cT\u201d\u8bc6\u522b\u6210\u201c\u8868\u540d T\u201d\uff0c\u628a\u5b57\u7b26\u4e32\u201cID\u201d\u8bc6\u522b\u6210\u201c\u5217 ID\u201d\u3002</p> <p>\u505a\u5b8c\u4e86\u8fd9\u4e9b\u8bc6\u522b\u4ee5\u540e\uff0c\u5c31\u8981\u505a\u201c\u8bed\u6cd5\u5206\u6790\u201d\u3002\u6839\u636e\u8bcd\u6cd5\u5206\u6790\u7684\u7ed3\u679c\uff0c\u8bed\u6cd5\u5206\u6790\u5668\u4f1a\u6839\u636e\u8bed\u6cd5\u89c4\u5219\uff0c\u5224\u65ad\u4f60\u8f93\u5165\u7684\u8fd9\u4e2a SQL \u8bed\u53e5\u662f\u5426\u6ee1\u8db3 MySQL \u8bed\u6cd5\u3002</p> <p>\u5982\u679c\u4f60\u7684\u8bed\u53e5\u4e0d\u5bf9\uff0c\u5c31\u4f1a\u6536\u5230\u201cYou have an error in your SQL syntax\u201d\u7684\u9519\u8bef\u63d0\u9192\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5 select \u5c11\u6253\u4e86\u5f00\u5934\u7684\u5b57\u6bcd\u201cs\u201d\u3002</p> <pre><code>mysql&gt; elect * from t where ID=1; \nERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'elect * from t where ID=1' at line 1\n</code></pre> <p>\u4e00\u822c\u8bed\u6cd5\u9519\u8bef\u4f1a\u63d0\u793a\u7b2c\u4e00\u4e2a\u51fa\u73b0\u9519\u8bef\u7684\u4f4d\u7f6e\uff0c\u6240\u4ee5\u4f60\u8981\u5173\u6ce8\u7684\u662f\u7d27\u63a5\u201cuse near\u201d\u7684\u5185\u5bb9\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_4","title":"\u4f18\u5316\u5668","text":"<p>\u7ecf\u8fc7\u4e86\u5206\u6790\u5668\uff0cMySQL \u5c31\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\u4e86\u3002\u5728\u5f00\u59cb\u6267\u884c\u4e4b\u524d\uff0c\u8fd8\u8981\u5148\u7ecf\u8fc7\u4f18\u5316\u5668\u7684\u5904\u7406\u3002</p> <p>\u4f18\u5316\u5668\u662f\u5728\u8868\u91cc\u9762\u6709\u591a\u4e2a\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\uff1b\u6216\u8005\u5728\u4e00\u4e2a\u8bed\u53e5\u6709\u591a\u8868\u5173\u8054\uff08join\uff09\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u5404\u4e2a\u8868\u7684\u8fde\u63a5\u987a\u5e8f\u3002\u6bd4\u5982\u4f60\u6267\u884c\u4e0b\u9762\u8fd9\u6837\u7684\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u662f\u6267\u884c\u4e24\u4e2a\u8868\u7684 join\uff1a</p> <pre><code>mysql&gt; select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;\n</code></pre> <ul> <li>\u65e2\u53ef\u4ee5\u5148\u4ece\u8868 t1 \u91cc\u9762\u53d6\u51fa c=10 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230\u8868 t2\uff0c\u518d\u5224\u65ad t2 \u91cc\u9762 d \u7684\u503c\u662f\u5426\u7b49\u4e8e 20\u3002</li> <li>\u4e5f\u53ef\u4ee5\u5148\u4ece\u8868 t2 \u91cc\u9762\u53d6\u51fa d=20 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230 t1\uff0c\u518d\u5224\u65ad t1 \u91cc\u9762 c \u7684\u503c\u662f\u5426\u7b49\u4e8e 10\u3002</li> </ul> <p>\u8fd9\u4e24\u79cd\u6267\u884c\u65b9\u6cd5\u7684\u903b\u8f91\u7ed3\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u6267\u884c\u7684\u6548\u7387\u4f1a\u6709\u4e0d\u540c\uff0c\u800c\u4f18\u5316\u5668\u7684\u4f5c\u7528\u5c31\u662f\u51b3\u5b9a\u9009\u62e9\u4f7f\u7528\u54ea\u4e00\u4e2a\u65b9\u6848\u3002</p> <p>\u4f18\u5316\u5668\u9636\u6bb5\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u65b9\u6848\u5c31\u786e\u5b9a\u4e0b\u6765\u4e86\uff0c\u7136\u540e\u8fdb\u5165\u6267\u884c\u5668\u9636\u6bb5\u3002\u5982\u679c\u4f60\u8fd8\u6709\u4e00\u4e9b\u7591\u95ee\uff0c\u6bd4\u5982\u4f18\u5316\u5668\u662f\u600e\u4e48\u9009\u62e9\u7d22\u5f15\u7684\uff0c\u6709\u6ca1\u6709\u53ef\u80fd\u9009\u62e9\u9519\u7b49\u7b49\uff0c\u6ca1\u5173\u7cfb\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u5355\u72ec\u5c55\u5f00\u8bf4\u660e\u4f18\u5316\u5668\u7684\u5185\u5bb9\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_5","title":"\u6267\u884c\u5668","text":"<p>MySQL \u901a\u8fc7\u5206\u6790\u5668\u77e5\u9053\u4e86\u4f60\u8981\u505a\u4ec0\u4e48\uff0c\u901a\u8fc7\u4f18\u5316\u5668\u77e5\u9053\u4e86\u8be5\u600e\u4e48\u505a\uff0c\u4e8e\u662f\u5c31\u8fdb\u5165\u4e86\u6267\u884c\u5668\u9636\u6bb5\uff0c\u5f00\u59cb\u6267\u884c\u8bed\u53e5\u3002</p> <p>\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u5148\u5224\u65ad\u4e00\u4e0b\u4f60\u5bf9\u8fd9\u4e2a\u8868 T \u6709\u6ca1\u6709\u6267\u884c\u67e5\u8be2\u7684\u6743\u9650\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u4f1a\u8fd4\u56de\u6ca1\u6709\u6743\u9650\u7684\u9519\u8bef\uff0c\u5982\u4e0b\u6240\u793a (\u5728\u5de5\u7a0b\u5b9e\u73b0\u4e0a\uff0c\u5982\u679c\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u4f1a\u5728\u67e5\u8be2\u7f13\u5b58\u8fd4\u56de\u7ed3\u679c\u7684\u65f6\u5019\uff0c\u505a\u6743\u9650\u9a8c\u8bc1\u3002\u67e5\u8be2\u4e5f\u4f1a\u5728\u4f18\u5316\u5668\u4e4b\u524d\u8c03\u7528 precheck \u9a8c\u8bc1\u6743\u9650)\u3002</p> <pre><code>mysql&gt; select * from T where ID=10; \nERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T'\n</code></pre> <p>\u5982\u679c\u6709\u6743\u9650\uff0c\u5c31\u6253\u5f00\u8868\u7ee7\u7eed\u6267\u884c\u3002\u6253\u5f00\u8868\u7684\u65f6\u5019\uff0c\u6267\u884c\u5668\u5c31\u4f1a\u6839\u636e\u8868\u7684\u5f15\u64ce\u5b9a\u4e49\uff0c\u53bb\u4f7f\u7528\u8fd9\u4e2a\u5f15\u64ce\u63d0\u4f9b\u7684\u63a5\u53e3\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684\u8868 T \u4e2d\uff0cID \u5b57\u6bb5\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u6267\u884c\u5668\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\u53d6\u8fd9\u4e2a\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u5224\u65ad ID \u503c\u662f\u4e0d\u662f 10\uff0c\u5982\u679c\u4e0d\u662f\u5219\u8df3\u8fc7\uff0c\u5982\u679c\u662f\u5219\u5c06\u8fd9\u884c\u5b58\u5728\u7ed3\u679c\u96c6\u4e2d\uff1b</li> <li>\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u53d6\u201c\u4e0b\u4e00\u884c\u201d\uff0c\u91cd\u590d\u76f8\u540c\u7684\u5224\u65ad\u903b\u8f91\uff0c\u76f4\u5230\u53d6\u5230\u8fd9\u4e2a\u8868\u7684\u6700\u540e\u4e00\u884c\u3002</li> <li>\u6267\u884c\u5668\u5c06\u4e0a\u8ff0\u904d\u5386\u8fc7\u7a0b\u4e2d\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u7ec4\u6210\u7684\u8bb0\u5f55\u96c6\u4f5c\u4e3a\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ol> <p>\u81f3\u6b64\uff0c\u8fd9\u4e2a\u8bed\u53e5\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002</p> <p>\u5bf9\u4e8e\u6709\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u7684\u903b\u8f91\u4e5f\u5dee\u4e0d\u591a\u3002\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u662f\u201c\u53d6\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4e4b\u540e\u5faa\u73af\u53d6\u201c\u6ee1\u8db3\u6761\u4ef6\u7684\u4e0b\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a5\u53e3\u90fd\u662f\u5f15\u64ce\u4e2d\u5df2\u7ecf\u5b9a\u4e49\u597d\u7684\u3002</p> <p>\u4f60\u4f1a\u5728\u6570\u636e\u5e93\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\u770b\u5230\u4e00\u4e2a <code>rows_examined</code> \u7684\u5b57\u6bb5\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002\u8fd9\u4e2a\u503c\u5c31\u662f\u5728\u6267\u884c\u5668\u6bcf\u6b21\u8c03\u7528\u5f15\u64ce\u83b7\u53d6\u6570\u636e\u884c\u7684\u65f6\u5019\u7d2f\u52a0\u7684\u3002</p> <p>\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6267\u884c\u5668\u8c03\u7528\u4e00\u6b21\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u5219\u626b\u63cf\u4e86\u591a\u884c\uff0c\u56e0\u6b64 \u5f15\u64ce\u626b\u63cf\u884c\u6570\u8ddf <code>rows_examined</code> \u5e76\u4e0d\u662f\u5b8c\u5168\u76f8\u540c\u7684\u3002\u6211\u4eec\u540e\u9762\u4f1a\u4e13\u95e8\u6709\u4e00\u7bc7\u6587\u7ae0\u6765\u8bb2\u5b58\u50a8\u5f15\u64ce\u7684\u5185\u90e8\u673a\u5236\uff0c\u91cc\u9762\u4f1a\u6709\u8be6\u7ec6\u7684\u8bf4\u660e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_6","title":"\u5c0f\u7ed3","text":"<p>\u6211\u7ed9\u4f60\u7559\u4e00\u4e2a\u95ee\u9898\u5427\uff0c\u5982\u679c\u8868 T \u4e2d\u6ca1\u6709\u5b57\u6bb5 k\uff0c\u800c\u4f60\u6267\u884c\u4e86\u8fd9\u4e2a\u8bed\u53e5 <code>select * from T where k=1</code>, \u90a3\u80af\u5b9a\u662f\u4f1a\u62a5\u201c\u4e0d\u5b58\u5728\u8fd9\u4e2a\u5217\u201d\u7684\u9519\u8bef\uff1a <code>Unknown column \u2018k\u2019 in \u2018where clause</code>\u3002\u4f60\u89c9\u5f97\u8fd9\u4e2a\u9519\u8bef\u662f\u5728\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u54ea\u4e2a\u9636\u6bb5\u62a5\u51fa\u6765\u7684\u5462\uff1f</p> <p>\u6267\u884c\u5668\u9636\u6bb5\u4f1a\u68c0\u67e5\u67e5\u8be2\u7684\u5217\u662f\u5426\u5b58\u5728</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#02-sql","title":"02 \u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761SQL\u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f","text":"<p>\u6211\u4eec\u8fd8\u662f\u4ece\u4e00\u4e2a\u8868\u7684\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u8bf4\u8d77\uff0c\u4e0b\u9762\u662f\u8fd9\u4e2a\u8868\u7684\u521b\u5efa\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8868\u6709\u4e00\u4e2a\u4e3b\u952e ID \u548c\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5 c\uff1a</p> <pre><code>mysql&gt; create table T(ID int primary key, c int);\n</code></pre> <p>\u5982\u679c\u8981\u5c06 ID=2 \u8fd9\u4e00\u884c\u7684\u503c\u52a0 1\uff0cSQL \u8bed\u53e5\u5c31\u4f1a\u8fd9\u4e48\u5199\uff1a</p> <pre><code>mysql&gt; update T set c=c+1 where ID=2;\n</code></pre> <p>\u524d\u9762\u6211\u6709\u8ddf\u4f60\u4ecb\u7ecd\u8fc7 SQL \u8bed\u53e5\u57fa\u672c\u7684\u6267\u884c\u94fe\u8def\uff0c\u8fd9\u91cc\u6211\u518d\u628a\u90a3\u5f20\u56fe\u62ff\u8fc7\u6765\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5148\u7b80\u5355\u770b\u770b\u8fd9\u4e2a\u56fe\u56de\u987e\u4e0b\u3002\u9996\u5148\uff0c\u53ef\u4ee5\u786e\u5b9a\u7684\u8bf4\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u90a3\u4e00\u5957\u6d41\u7a0b\uff0c\u66f4\u65b0\u8bed\u53e5\u4e5f\u662f\u540c\u6837\u4f1a\u8d70\u4e00\u904d\u3002</p> <p>\u4f60\u6267\u884c\u8bed\u53e5\u524d\u8981\u5148\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u8fd9\u662f\u8fde\u63a5\u5668\u7684\u5de5\u4f5c\u3002</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\uff0c\u5728\u4e00\u4e2a\u8868\u4e0a\u6709\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u8ddf\u8fd9\u4e2a\u8868\u6709\u5173\u7684\u67e5\u8be2\u7f13\u5b58\u4f1a\u5931\u6548\uff0c\u6240\u4ee5\u8fd9\u6761\u8bed\u53e5\u5c31\u4f1a\u628a\u8868 T \u4e0a\u6240\u6709\u7f13\u5b58\u7ed3\u679c\u90fd\u6e05\u7a7a\u3002\u8fd9\u4e5f\u5c31\u662f\u6211\u4eec\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u539f\u56e0\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u5206\u6790\u5668\u4f1a\u901a\u8fc7\u8bcd\u6cd5\u548c\u8bed\u6cd5\u89e3\u6790\u77e5\u9053\u8fd9\u662f\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u3002\u4f18\u5316\u5668\u51b3\u5b9a\u8981\u4f7f\u7528 ID \u8fd9\u4e2a\u7d22\u5f15\u3002\u7136\u540e\uff0c\u6267\u884c\u5668\u8d1f\u8d23\u5177\u4f53\u6267\u884c\uff0c\u627e\u5230\u8fd9\u4e00\u884c\uff0c\u7136\u540e\u66f4\u65b0\u3002</p> <p>\u4e0e\u67e5\u8be2\u6d41\u7a0b\u4e0d\u4e00\u6837\u7684\u662f\uff0c\u66f4\u65b0\u6d41\u7a0b\u8fd8\u6d89\u53ca\u4e24\u4e2a\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff0c\u5b83\u4eec\u6b63\u662f\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u4e3b\u89d2\uff1aredo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\u548c binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002\u5982\u679c\u63a5\u89e6 MySQL\uff0c\u90a3\u8fd9\u4e24\u4e2a\u8bcd\u80af\u5b9a\u662f\u7ed5\u4e0d\u8fc7\u7684\uff0c\u6211\u540e\u9762\u7684\u5185\u5bb9\u91cc\u4e5f\u4f1a\u4e0d\u65ad\u5730\u548c\u4f60\u5f3a\u8c03\u3002\u4e0d\u8fc7\u8bdd\u8bf4\u56de\u6765\uff0credo log \u548c binlog \u5728\u8bbe\u8ba1\u4e0a\u6709\u5f88\u591a\u6709\u610f\u601d\u7684\u5730\u65b9\uff0c\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u8def\u4e5f\u53ef\u4ee5\u7528\u5230\u4f60\u81ea\u5df1\u7684\u7a0b\u5e8f\u91cc\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#redo-log","title":"\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1aredo log","text":"<p>\u4e0d\u77e5\u9053\u4f60\u8fd8\u8bb0\u4e0d\u8bb0\u5f97\u300a\u5b54\u4e59\u5df1\u300b\u8fd9\u7bc7\u6587\u7ae0\uff0c\u9152\u5e97\u638c\u67dc\u6709\u4e00\u4e2a\u7c89\u677f\uff0c\u4e13\u95e8\u7528\u6765\u8bb0\u5f55\u5ba2\u4eba\u7684\u8d4a\u8d26\u8bb0\u5f55\u3002\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u4e0d\u591a\uff0c\u90a3\u4e48\u4ed6\u53ef\u4ee5\u628a\u987e\u5ba2\u540d\u548c\u8d26\u76ee\u5199\u5728\u677f\u4e0a\u3002\u4f46\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u591a\u4e86\uff0c\u7c89\u677f\u603b\u4f1a\u6709\u8bb0\u4e0d\u4e0b\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u4e00\u5b9a\u8fd8\u6709\u4e00\u4e2a\u4e13\u95e8\u8bb0\u5f55\u8d4a\u8d26\u7684\u8d26\u672c\u3002</p> <p>\u5982\u679c\u6709\u4eba\u8981\u8d4a\u8d26\u6216\u8005\u8fd8\u8d26\u7684\u8bdd\uff0c\u638c\u67dc\u4e00\u822c\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p> <ul> <li>\u4e00\u79cd\u505a\u6cd5\u662f\u76f4\u63a5\u628a\u8d26\u672c\u7ffb\u51fa\u6765\uff0c\u628a\u8fd9\u6b21\u8d4a\u7684\u8d26\u52a0\u4e0a\u53bb\u6216\u8005\u6263\u9664\u6389\uff1b</li> <li>\u53e6\u4e00\u79cd\u505a\u6cd5\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e0b\u8fd9\u6b21\u7684\u8d26\uff0c\u7b49\u6253\u70ca\u4ee5\u540e\u518d\u628a\u8d26\u672c\u7ffb\u51fa\u6765\u6838\u7b97\u3002</li> </ul> <p>\u5728\u751f\u610f\u7ea2\u706b\u67dc\u53f0\u5f88\u5fd9\u65f6\uff0c\u638c\u67dc\u4e00\u5b9a\u4f1a\u9009\u62e9\u540e\u8005\uff0c\u56e0\u4e3a\u524d\u8005\u64cd\u4f5c\u5b9e\u5728\u662f\u592a\u9ebb\u70e6\u4e86\u3002\u9996\u5148\uff0c\u4f60\u5f97\u627e\u5230\u8fd9\u4e2a\u4eba\u7684\u8d4a\u8d26\u603b\u989d\u90a3\u6761\u8bb0\u5f55\u3002\u4f60\u60f3\u60f3\uff0c\u5bc6\u5bc6\u9ebb\u9ebb\u51e0\u5341\u9875\uff0c\u638c\u67dc\u8981\u627e\u5230\u90a3\u4e2a\u540d\u5b57\uff0c\u53ef\u80fd\u8fd8\u5f97\u5e26\u4e0a\u8001\u82b1\u955c\u6162\u6162\u627e\uff0c\u627e\u5230\u4e4b\u540e\u518d\u62ff\u51fa\u7b97\u76d8\u8ba1\u7b97\uff0c\u6700\u540e\u518d\u5c06\u7ed3\u679c\u5199\u56de\u5230\u8d26\u672c\u4e0a\u3002</p> <p>\u8fd9\u6574\u4e2a\u8fc7\u7a0b\u60f3\u60f3\u90fd\u9ebb\u70e6\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8fd8\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e00\u4e0b\u65b9\u4fbf\u3002\u4f60\u60f3\u60f3\uff0c\u5982\u679c\u638c\u67dc\u6ca1\u6709\u7c89\u677f\u7684\u5e2e\u52a9\uff0c\u6bcf\u6b21\u8bb0\u8d26\u90fd\u5f97\u7ffb\u8d26\u672c\uff0c\u6548\u7387\u662f\u4e0d\u662f\u4f4e\u5f97\u8ba9\u4eba\u96be\u4ee5\u5fcd\u53d7\uff1f</p> <p>\u540c\u6837\uff0c\u5728 MySQL \u91cc\u4e5f\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u6bcf\u4e00\u6b21\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u9700\u8981\u5199\u8fdb\u78c1\u76d8\uff0c\u7136\u540e\u78c1\u76d8\u4e5f\u8981\u627e\u5230\u5bf9\u5e94\u7684\u90a3\u6761\u8bb0\u5f55\uff0c\u7136\u540e\u518d\u66f4\u65b0\uff0c\u6574\u4e2a\u8fc7\u7a0b IO \u6210\u672c\u3001\u67e5\u627e\u6210\u672c\u90fd\u5f88\u9ad8\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cMySQL \u7684\u8bbe\u8ba1\u8005\u5c31\u7528\u4e86\u7c7b\u4f3c\u9152\u5e97\u638c\u67dc\u7c89\u677f\u7684\u601d\u8def\u6765\u63d0\u5347\u66f4\u65b0\u6548\u7387\u3002</p> <p>\u800c\u7c89\u677f\u548c\u8d26\u672c\u914d\u5408\u7684\u6574\u4e2a\u8fc7\u7a0b\uff0c\u5176\u5b9e\u5c31\u662f MySQL \u91cc\u7ecf\u5e38\u8bf4\u5230\u7684 WAL \u6280\u672f\uff0cWAL \u7684\u5168\u79f0\u662f Write-Ahead Logging\uff0c\u5b83\u7684\u5173\u952e\u70b9\u5c31\u662f\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u5199\u78c1\u76d8\uff0c\u4e5f\u5c31\u662f\u5148\u5199\u7c89\u677f\uff0c\u7b49\u4e0d\u5fd9\u7684\u65f6\u5019\u518d\u5199\u8d26\u672c\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u6709\u4e00\u6761\u8bb0\u5f55\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019\uff0cInnoDB \u5f15\u64ce\u5c31\u4f1a\u5148\u628a\u8bb0\u5f55\u5199\u5230 redo log\uff08\u7c89\u677f\uff09\u91cc\u9762\uff0c\u5e76\u66f4\u65b0\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019\u66f4\u65b0\u5c31\u7b97\u5b8c\u6210\u4e86\u3002\u540c\u65f6\uff0cInnoDB \u5f15\u64ce\u4f1a\u5728\u9002\u5f53\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u91cc\u9762\uff0c\u800c\u8fd9\u4e2a\u66f4\u65b0\u5f80\u5f80\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u505a\uff0c\u8fd9\u5c31\u50cf\u6253\u70ca\u4ee5\u540e\u638c\u67dc\u505a\u7684\u4e8b\u3002</p> <p>\u5982\u679c\u4eca\u5929\u8d4a\u8d26\u7684\u4e0d\u591a\uff0c\u638c\u67dc\u53ef\u4ee5\u7b49\u6253\u70ca\u540e\u518d\u6574\u7406\u3002\u4f46\u5982\u679c\u67d0\u5929\u8d4a\u8d26\u7684\u7279\u522b\u591a\uff0c\u7c89\u677f\u5199\u6ee1\u4e86\uff0c\u53c8\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u53ea\u597d\u653e\u4e0b\u624b\u4e2d\u7684\u6d3b\u513f\uff0c\u628a\u7c89\u677f\u4e2d\u7684\u4e00\u90e8\u5206\u8d4a\u8d26\u8bb0\u5f55\u66f4\u65b0\u5230\u8d26\u672c\u4e2d\uff0c\u7136\u540e\u628a\u8fd9\u4e9b\u8bb0\u5f55\u4ece\u7c89\u677f\u4e0a\u64e6\u6389\uff0c\u4e3a\u8bb0\u65b0\u8d26\u817e\u51fa\u7a7a\u95f4\u3002</p> <p>\u4e0e\u6b64\u7c7b\u4f3c\uff0cInnoDB \u7684 redo log \u662f\u56fa\u5b9a\u5927\u5c0f\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u914d\u7f6e\u4e3a\u4e00\u7ec4 4 \u4e2a\u6587\u4ef6\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7684\u5927\u5c0f\u662f 1GB\uff0c\u90a3\u4e48\u8fd9\u5757\u201c\u7c89\u677f\u201d\u603b\u5171\u5c31\u53ef\u4ee5\u8bb0\u5f55 4GB \u7684\u64cd\u4f5c\u3002\u4ece\u5934\u5f00\u59cb\u5199\uff0c\u5199\u5230\u672b\u5c3e\u5c31\u53c8\u56de\u5230\u5f00\u5934\u5faa\u73af\u5199\uff0c\u5982\u4e0b\u9762\u8fd9\u4e2a\u56fe\u6240\u793a\u3002</p> <p></p> <p>write pos \u662f\u5f53\u524d\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u4e00\u8fb9\u5199\u4e00\u8fb9\u540e\u79fb\uff0c\u5199\u5230\u7b2c 3 \u53f7\u6587\u4ef6\u672b\u5c3e\u540e\u5c31\u56de\u5230 0 \u53f7\u6587\u4ef6\u5f00\u5934\u3002checkpoint \u662f\u5f53\u524d\u8981\u64e6\u9664\u7684\u4f4d\u7f6e\uff0c\u4e5f\u662f\u5f80\u540e\u63a8\u79fb\u5e76\u4e14\u5faa\u73af\u7684\uff0c\u64e6\u9664\u8bb0\u5f55\u524d\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u6570\u636e\u6587\u4ef6\u3002</p> <p>write pos \u548c checkpoint \u4e4b\u95f4\u7684\u662f\u201c\u7c89\u677f\u201d\u4e0a\u8fd8\u7a7a\u7740\u7684\u90e8\u5206(\u4e0a\u56fe\u7eff\u8272\u80cc\u666f\u90e8\u5206\uff09\uff0c\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u65b0\u7684\u64cd\u4f5c\u3002\u5982\u679c write pos \u8ffd\u4e0a checkpoint\uff0c\u8868\u793a\u201c\u7c89\u677f\u201d\u6ee1\u4e86\uff0c\u8fd9\u65f6\u5019\u4e0d\u80fd\u518d\u6267\u884c\u65b0\u7684\u66f4\u65b0\uff0c\u5f97\u505c\u4e0b\u6765\u5148\u64e6\u6389\u4e00\u4e9b\u8bb0\u5f55\uff0c\u628a checkpoint \u63a8\u8fdb\u4e00\u4e0b\u3002</p> <p>\u6709\u4e86 redo log\uff0cInnoDB \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5373\u4f7f\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4e4b\u524d\u63d0\u4ea4\u7684\u8bb0\u5f55\u90fd\u4e0d\u4f1a\u4e22\u5931\uff0c\u8fd9\u4e2a\u80fd\u529b\u79f0\u4e3a**crash-safe**\u3002</p> <p>\u8981\u7406\u89e3 crash-safe \u8fd9\u4e2a\u6982\u5ff5\uff0c\u53ef\u4ee5\u60f3\u60f3\u6211\u4eec\u524d\u9762\u8d4a\u8d26\u8bb0\u5f55\u7684\u4f8b\u5b50\u3002\u53ea\u8981\u8d4a\u8d26\u8bb0\u5f55\u8bb0\u5728\u4e86\u7c89\u677f\u4e0a\u6216\u5199\u5728\u4e86\u8d26\u672c\u4e0a\uff0c\u4e4b\u540e\u5373\u4f7f\u638c\u67dc\u5fd8\u8bb0\u4e86\uff0c\u6bd4\u5982\u7a81\u7136\u505c\u4e1a\u51e0\u5929\uff0c\u6062\u590d\u751f\u610f\u540e\u4f9d\u7136\u53ef\u4ee5\u901a\u8fc7\u8d26\u672c\u548c\u7c89\u677f\u4e0a\u7684\u6570\u636e\u660e\u786e\u8d4a\u8d26\u8d26\u76ee\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#binlog","title":"\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1abinlog","text":"<p>\u524d\u9762\u6211\u4eec\u8bb2\u8fc7\uff0cMySQL \u6574\u4f53\u6765\u770b\uff0c\u5176\u5b9e\u5c31\u6709\u4e24\u5757\uff1a\u4e00\u5757\u662f Server \u5c42\uff0c\u5b83\u4e3b\u8981\u505a\u7684\u662f MySQL \u529f\u80fd\u5c42\u9762\u7684\u4e8b\u60c5\uff1b\u8fd8\u6709\u4e00\u5757\u662f\u5f15\u64ce\u5c42\uff0c\u8d1f\u8d23\u5b58\u50a8\u76f8\u5173\u7684\u5177\u4f53\u4e8b\u5b9c\u3002\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u7c89\u677f redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\u65e5\u5fd7\uff0c\u800c Server \u5c42\u4e5f\u6709\u81ea\u5df1\u7684\u65e5\u5fd7\uff0c\u79f0\u4e3a binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002</p> <p>\u6211\u60f3\u4f60\u80af\u5b9a\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4e24\u4efd\u65e5\u5fd7\u5462\uff1f</p> <p>\u56e0\u4e3a\u6700\u5f00\u59cb MySQL \u91cc\u5e76\u6ca1\u6709 InnoDB \u5f15\u64ce\u3002MySQL \u81ea\u5e26\u7684\u5f15\u64ce\u662f MyISAM\uff0c\u4f46\u662f MyISAM \u6ca1\u6709 crash-safe \u7684\u80fd\u529b\uff0cbinlog \u65e5\u5fd7\u53ea\u80fd\u7528\u4e8e\u5f52\u6863\u3002\u800c InnoDB \u662f\u53e6\u4e00\u4e2a\u516c\u53f8\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u5f15\u5165 MySQL \u7684\uff0c\u65e2\u7136\u53ea\u4f9d\u9760 binlog \u662f\u6ca1\u6709 crash-safe \u80fd\u529b\u7684\uff0c\u6240\u4ee5 InnoDB \u4f7f\u7528\u53e6\u5916\u4e00\u5957\u65e5\u5fd7\u7cfb\u7edf\u2014\u2014\u4e5f\u5c31\u662f redo log \u6765\u5b9e\u73b0 crash-safe \u80fd\u529b\u3002</p> <p>\u8fd9\u4e24\u79cd\u65e5\u5fd7\u6709\u4ee5\u4e0b\u4e09\u70b9\u4e0d\u540c\u3002</p> <ol> <li>redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\uff1bbinlog \u662f MySQL \u7684 Server \u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</li> <li>redo log \u662f\u7269\u7406\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u201c\u5728\u67d0\u4e2a\u6570\u636e\u9875\u4e0a\u505a\u4e86\u4ec0\u4e48\u4fee\u6539\u201d\uff1bbinlog \u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684\u539f\u59cb\u903b\u8f91\uff0c\u6bd4\u5982\u201c\u7ed9 ID=2 \u8fd9\u4e00\u884c\u7684 c \u5b57\u6bb5\u52a0 1 \u201d\u3002</li> <li>redo log \u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1bbinlog \u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307 binlog \u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</li> </ol> <p>\u6709\u4e86\u5bf9\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u7684\u6982\u5ff5\u6027\u7406\u89e3\uff0c\u6211\u4eec\u518d\u6765\u770b\u6267\u884c\u5668\u548c InnoDB \u5f15\u64ce\u5728\u6267\u884c\u8fd9\u4e2a\u7b80\u5355\u7684 update \u8bed\u53e5\u65f6\u7684\u5185\u90e8\u6d41\u7a0b\u3002</p> <ol> <li>\u6267\u884c\u5668\u5148\u627e\u5f15\u64ce\u53d6 ID=2 \u8fd9\u4e00\u884c\u3002ID \u662f\u4e3b\u952e\uff0c\u5f15\u64ce\u76f4\u63a5\u7528\u6811\u641c\u7d22\u627e\u5230\u8fd9\u4e00\u884c\u3002\u5982\u679c ID=2 \u8fd9\u4e00\u884c\u6240\u5728\u7684\u6570\u636e\u9875\u672c\u6765\u5c31\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u7ed9\u6267\u884c\u5668\uff1b\u5426\u5219\uff0c\u9700\u8981\u5148\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u518d\u8fd4\u56de\u3002</li> <li>\u6267\u884c\u5668\u62ff\u5230\u5f15\u64ce\u7ed9\u7684\u884c\u6570\u636e\uff0c\u628a\u8fd9\u4e2a\u503c\u52a0\u4e0a 1\uff0c\u6bd4\u5982\u539f\u6765\u662f N\uff0c\u73b0\u5728\u5c31\u662f N+1\uff0c\u5f97\u5230\u65b0\u7684\u4e00\u884c\u6570\u636e\uff0c\u518d\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u5199\u5165\u8fd9\u884c\u65b0\u6570\u636e\u3002</li> <li>\u5f15\u64ce\u5c06\u8fd9\u884c\u65b0\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u4e2d\uff0c\u540c\u65f6\u5c06\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u8bb0\u5f55\u5230 redo log \u91cc\u9762\uff0c\u6b64\u65f6 redo log \u5904\u4e8e prepare \u72b6\u6001\u3002\u7136\u540e\u544a\u77e5\u6267\u884c\u5668\u6267\u884c\u5b8c\u6210\u4e86\uff0c\u968f\u65f6\u53ef\u4ee5\u63d0\u4ea4\u4e8b\u52a1\u3002</li> <li>\u6267\u884c\u5668\u751f\u6210\u8fd9\u4e2a\u64cd\u4f5c\u7684 binlog\uff0c\u5e76\u628a binlog \u5199\u5165\u78c1\u76d8\u3002</li> <li>\u6267\u884c\u5668\u8c03\u7528\u5f15\u64ce\u7684\u63d0\u4ea4\u4e8b\u52a1\u63a5\u53e3\uff0c\u5f15\u64ce\u628a\u521a\u521a\u5199\u5165\u7684 redo log \u6539\u6210\u63d0\u4ea4\uff08commit\uff09\u72b6\u6001\uff0c\u66f4\u65b0\u5b8c\u6210\u3002</li> </ol> <p>\u8fd9\u91cc\u6211\u7ed9\u51fa\u8fd9\u4e2a update \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u56fe\uff0c\u56fe\u4e2d\u6d45\u8272\u6846\u8868\u793a\u662f\u5728 InnoDB \u5185\u90e8\u6267\u884c\u7684\uff0c\u6df1\u8272\u6846\u8868\u793a\u662f\u5728\u6267\u884c\u5668\u4e2d\u6267\u884c\u7684\u3002</p> <pre><code>flowchart TB\n    %% define node\n\n    A[\"\u53d6ID=2\u8fd9\u4e00\u884c\"]:::heavygreen --&gt; B{\"\u6570\u636e\u4e5f\u5728\u5185\u5b58\u4e2d\uff1f\"}\n    B --&gt;|Yes| C[\"\u8fd4\u56de\u6570\u636e\u884c\"]\n    C --&gt;D[\"\u5c06\u8fd9\u884c\u7684\u503c\u52a0\u4e00\"]:::heavygreen --&gt; E[\"\u5199\u5165\u65b0\u884c\"]:::heavygreen --&gt; F[\"\u65b0\u884c\u66f4\u65b0\u5230\u5185\u5b58\"]\n    F --&gt; G[\"\u5199\u5165redolog&lt;br/&gt;\u5904\u4e8eprepare\u9636\u6bb5\"]\n    G --&gt; H[\"\u5199 binlog\"]:::heavygreen --&gt; I[\"\u63d0\u4ea4\u4e8b\u52a1&lt;br/&gt;\u5199\u5165redolog,\u5904\u4e8e commit \u72b6\u6001\"]\n\n    B --&gt;|No| M[\"\u78c1\u76d8\u4e2d\u8bfb\u5165\u5185\u5b58\"] --&gt; C\n\n    classDef heavygreen fill:#558241</code></pre> <p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u6700\u540e\u4e09\u6b65\u770b\u4e0a\u53bb\u6709\u70b9\u201c\u7ed5\u201d\uff0c\u5c06 redo log \u7684\u5199\u5165\u62c6\u6210\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff1aprepare \u548c commit\uff0c\u8fd9\u5c31\u662f\"\u4e24\u9636\u6bb5\u63d0\u4ea4\"\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_7","title":"\u4e24\u9636\u6bb5\u63d0\u4ea4","text":"<p>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u6709\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u5462\uff1f\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e24\u4efd\u65e5\u5fd7\u4e4b\u95f4\u7684\u903b\u8f91\u4e00\u81f4\u3002\u8981\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5f97\u4ece\u6587\u7ae0\u5f00\u5934\u7684\u90a3\u4e2a\u95ee\u9898\u8bf4\u8d77\uff1a\u600e\u6837\u8ba9\u6570\u636e\u5e93\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u4efb\u610f\u4e00\u79d2\u7684\u72b6\u6001\uff1f</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u4e86\uff0cbinlog \u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u903b\u8f91\u64cd\u4f5c\uff0c\u5e76\u4e14\u662f\u91c7\u7528\u201c\u8ffd\u52a0\u5199\u201d\u7684\u5f62\u5f0f\u3002\u5982\u679c\u4f60\u7684 DBA \u627f\u8bfa\u8bf4\u534a\u4e2a\u6708\u5185\u53ef\u4ee5\u6062\u590d\uff0c\u90a3\u4e48\u5907\u4efd\u7cfb\u7edf\u4e2d\u4e00\u5b9a\u4f1a\u4fdd\u5b58\u6700\u8fd1\u534a\u4e2a\u6708\u7684\u6240\u6709 binlog\uff0c\u540c\u65f6\u7cfb\u7edf\u4f1a\u5b9a\u671f\u505a\u6574\u5e93\u5907\u4efd\u3002\u8fd9\u91cc\u7684\u201c\u5b9a\u671f\u201d\u53d6\u51b3\u4e8e\u7cfb\u7edf\u7684\u91cd\u8981\u6027\uff0c\u53ef\u4ee5\u662f\u4e00\u5929\u4e00\u5907\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u5468\u4e00\u5907\u3002</p> <p>\u5f53\u9700\u8981\u6062\u590d\u5230\u6307\u5b9a\u7684\u67d0\u4e00\u79d2\u65f6\uff0c\u6bd4\u5982\u67d0\u5929\u4e0b\u5348\u4e24\u70b9\u53d1\u73b0\u4e2d\u5348\u5341\u4e8c\u70b9\u6709\u4e00\u6b21\u8bef\u5220\u8868\uff0c\u9700\u8981\u627e\u56de\u6570\u636e\uff0c\u90a3\u4f60\u53ef\u4ee5\u8fd9\u4e48\u505a\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u627e\u5230\u6700\u8fd1\u7684\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5982\u679c\u4f60\u8fd0\u6c14\u597d\uff0c\u53ef\u80fd\u5c31\u662f\u6628\u5929\u665a\u4e0a\u7684\u4e00\u4e2a\u5907\u4efd\uff0c\u4ece\u8fd9\u4e2a\u5907\u4efd\u6062\u590d\u5230\u4e34\u65f6\u5e93\uff1b</li> <li>\u7136\u540e\uff0c\u4ece\u5907\u4efd\u7684\u65f6\u95f4\u70b9\u5f00\u59cb\uff0c\u5c06\u5907\u4efd\u7684 binlog \u4f9d\u6b21\u53d6\u51fa\u6765\uff0c\u91cd\u653e\u5230\u4e2d\u5348\u8bef\u5220\u8868\u4e4b\u524d\u7684\u90a3\u4e2a\u65f6\u523b\u3002</li> </ul> <p>\u8fd9\u6837\u4f60\u7684\u4e34\u65f6\u5e93\u5c31\u8ddf\u8bef\u5220\u4e4b\u524d\u7684\u7ebf\u4e0a\u5e93\u4e00\u6837\u4e86\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u628a\u8868\u6570\u636e\u4ece\u4e34\u65f6\u5e93\u53d6\u51fa\u6765\uff0c\u6309\u9700\u8981\u6062\u590d\u5230\u7ebf\u4e0a\u5e93\u53bb\u3002</p> <p>\u597d\u4e86\uff0c\u8bf4\u5b8c\u4e86\u6570\u636e\u6062\u590d\u8fc7\u7a0b\uff0c\u6211\u4eec\u56de\u6765\u8bf4\u8bf4\uff0c\u4e3a\u4ec0\u4e48\u65e5\u5fd7\u9700\u8981\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u3002\u8fd9\u91cc\u4e0d\u59a8\u7528\u53cd\u8bc1\u6cd5\u6765\u8fdb\u884c\u89e3\u91ca\u3002</p> <p>\u7531\u4e8e redo log \u548c binlog \u662f\u4e24\u4e2a\u72ec\u7acb\u7684\u903b\u8f91\uff0c\u5982\u679c\u4e0d\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u8981\u4e48\u5c31\u662f\u5148\u5199\u5b8c redo log \u518d\u5199 binlog\uff0c\u6216\u8005\u91c7\u7528\u53cd\u8fc7\u6765\u7684\u987a\u5e8f\u3002\u6211\u4eec\u770b\u770b\u8fd9\u4e24\u79cd\u65b9\u5f0f\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p> <p>\u4ecd\u7136\u7528\u524d\u9762\u7684 update \u8bed\u53e5\u6765\u505a\u4f8b\u5b50\u3002\u5047\u8bbe\u5f53\u524d ID=2 \u7684\u884c\uff0c\u5b57\u6bb5 c \u7684\u503c\u662f 0\uff0c\u518d\u5047\u8bbe\u6267\u884c update \u8bed\u53e5\u8fc7\u7a0b\u4e2d\u5728\u5199\u5b8c\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u540e\uff0c\u7b2c\u4e8c\u4e2a\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5199\u5b8c\u671f\u95f4\u53d1\u751f\u4e86 crash\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\u5462\uff1f</p> <ol> <li>\u5148\u5199 redo log \u540e\u5199 binlog\u3002\u5047\u8bbe\u5728 redo log \u5199\u5b8c\uff0cbinlog \u8fd8\u6ca1\u6709\u5199\u5b8c\u7684\u65f6\u5019\uff0cMySQL \u8fdb\u7a0b\u5f02\u5e38\u91cd\u542f\u3002\u7531\u4e8e\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\u7684\uff0credo log \u5199\u5b8c\u4e4b\u540e\uff0c\u7cfb\u7edf\u5373\u4f7f\u5d29\u6e83\uff0c\u4ecd\u7136\u80fd\u591f\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u6240\u4ee5\u6062\u590d\u540e\u8fd9\u4e00\u884c c \u7684\u503c\u662f 1\u3002 \u4f46\u662f\u7531\u4e8e binlog \u6ca1\u5199\u5b8c\u5c31 crash \u4e86\uff0c\u8fd9\u65f6\u5019 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u8bed\u53e5\u3002\u56e0\u6b64\uff0c\u4e4b\u540e\u5907\u4efd\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u5b58\u8d77\u6765\u7684 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8fd9\u6761\u8bed\u53e5\u3002 \u7136\u540e\u4f60\u4f1a\u53d1\u73b0\uff0c\u5982\u679c\u9700\u8981\u7528\u8fd9\u4e2a binlog \u6765\u6062\u590d\u4e34\u65f6\u5e93\u7684\u8bdd\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684 binlog \u4e22\u5931\uff0c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u5c31\u4f1a\u5c11\u4e86\u8fd9\u4e00\u6b21\u66f4\u65b0\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 0\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li> <li>\u5148\u5199 binlog \u540e\u5199 redo log\u3002\u5982\u679c\u5728 binlog \u5199\u5b8c\u4e4b\u540e crash\uff0c\u7531\u4e8e redo log \u8fd8\u6ca1\u5199\uff0c\u5d29\u6e83\u6062\u590d\u4ee5\u540e\u8fd9\u4e2a\u4e8b\u52a1\u65e0\u6548\uff0c\u6240\u4ee5\u8fd9\u4e00\u884c c \u7684\u503c\u662f 0\u3002\u4f46\u662f binlog \u91cc\u9762\u5df2\u7ecf\u8bb0\u5f55\u4e86\u201c\u628a c \u4ece 0 \u6539\u6210 1\u201d\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u5728\u4e4b\u540e\u7528 binlog \u6765\u6062\u590d\u7684\u65f6\u5019\u5c31\u591a\u4e86\u4e00\u4e2a\u4e8b\u52a1\u51fa\u6765\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 1\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p> <p>\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\u5728\u5206\u522b\u5199 redo log \u6216 binlog \u540e\u5d29\u6e83\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f\u6570\u636e\u5e93\u5d29\u6e83\u91cd\u542f\u540e\uff0c\u4f1a\u68c0\u67e5 redo log \u91cc\u5904\u4e8e prepare \u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u7136\u540e\u6839\u636e binlog \u6765\u5224\u65ad\u662f\u5426\u8981\u63d0\u4ea4\u6216\u56de\u6eda\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li>\u5982\u679cRedo log\u91cc\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u4f46binlog\u91cc\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8b\u52a1\u53d8\u66f4\u8bb0\u5f55\uff0c\u8bf4\u660e\u4e8b\u52a1\u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u90a3\u4e48\u5c31\u8981\u56de\u6eda\u8fd9\u4e2a\u4e8b\u52a1\u3002</li> <li>\u5982\u679cRedo log\u91cc\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u5e76\u4e14binlog\u91cc\u6709\u5bf9\u5e94\u7684\u4e8b\u52a1\u53d8\u66f4\u8bb0\u5f55\uff0c\u8bf4\u660e\u4e8b\u52a1\u5df2\u7ecf\u63d0\u4ea4\uff0c\u90a3\u4e48\u5c31\u8981\u7ee7\u7eed\u6267\u884c\u8fd9\u4e2a\u4e8b\u52a1\u3002</li> <li>\u5982\u679cRedo log\u91cc\u6ca1\u6709prepare\u72b6\u6001\u7684\u8bb0\u5f55\uff0c\u8bf4\u660e\u6ca1\u6709\u672a\u5b8c\u6210\u7684\u4e8b\u52a1\uff0c\u90a3\u4e48\u5c31\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u64cd\u4f5c\u3002</li> </ul> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u6982\u7387\u662f\u4e0d\u662f\u5f88\u4f4e\uff0c\u5e73\u65f6\u4e5f\u6ca1\u6709\u4ec0\u4e48\u52a8\u4e0d\u52a8\u5c31\u9700\u8981\u6062\u590d\u4e34\u65f6\u5e93\u7684\u573a\u666f\u5440\uff1f</p> <p>\u5176\u5b9e\u4e0d\u662f\u7684\uff0c\u4e0d\u53ea\u662f\u8bef\u64cd\u4f5c\u540e\u9700\u8981\u7528\u8fd9\u4e2a\u8fc7\u7a0b\u6765\u6062\u590d\u6570\u636e\u3002\u5f53\u4f60\u9700\u8981\u6269\u5bb9\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u518d\u591a\u642d\u5efa\u4e00\u4e9b\u5907\u5e93\u6765\u589e\u52a0\u7cfb\u7edf\u7684\u8bfb\u80fd\u529b\u7684\u65f6\u5019\uff0c\u73b0\u5728\u5e38\u89c1\u7684\u505a\u6cd5\u4e5f\u662f\u7528\u5168\u91cf\u5907\u4efd\u52a0\u4e0a\u5e94\u7528 binlog \u6765\u5b9e\u73b0\u7684\uff0c\u8fd9\u4e2a\u201c\u4e0d\u4e00\u81f4\u201d\u5c31\u4f1a\u5bfc\u81f4\u4f60\u7684\u7ebf\u4e0a\u51fa\u73b0\u4e3b\u4ece\u6570\u636e\u5e93\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>\u7b80\u5355\u8bf4\uff0credo log \u548c binlog \u90fd\u53ef\u4ee5\u7528\u4e8e\u8868\u793a\u4e8b\u52a1\u7684\u63d0\u4ea4\u72b6\u6001\uff0c\u800c\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u8ba9\u8fd9\u4e24\u4e2a\u72b6\u6001\u4fdd\u6301\u903b\u8f91\u4e0a\u7684\u4e00\u81f4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_8","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u4ecb\u7ecd\u4e86 MySQL \u91cc\u9762\u6700\u91cd\u8981\u7684\u4e24\u4e2a\u65e5\u5fd7\uff0c\u5373\u7269\u7406\u65e5\u5fd7 redo log \u548c\u903b\u8f91\u65e5\u5fd7 binlog\u3002</p> <p>redo log \u7528\u4e8e\u4fdd\u8bc1 crash-safe \u80fd\u529b\u3002<code>innodb_flush_log_at_trx_commit</code> \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 redo log \u90fd\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 1\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 MySQL \u5f02\u5e38\u91cd\u542f\u4e4b\u540e\u6570\u636e\u4e0d\u4e22\u5931\u3002</p> <p>sync_binlog \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 binlog \u90fd\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u4e5f\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 1\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 MySQL \u5f02\u5e38\u91cd\u542f\u4e4b\u540e binlog \u4e0d\u4e22\u5931\u3002</p> <p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u5728 MySQL 5.7 \u548c 8.0 \u9ed8\u8ba4\u90fd\u662f\u8bbe\u7f6e\u4e3a 1</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#03","title":"03 \u4e8b\u52a1\u9694\u79bb\uff1a\u4e3a\u4ec0\u4e48\u4f60\u6539\u4e86\u6211\u8fd8\u770b\u4e0d\u89c1\uff1f","text":"<p>\u63d0\u5230\u4e8b\u52a1\uff0c\u4f60\u80af\u5b9a\u4e0d\u964c\u751f\uff0c\u548c\u6570\u636e\u5e93\u6253\u4ea4\u9053\u7684\u65f6\u5019\uff0c\u6211\u4eec\u603b\u662f\u4f1a\u7528\u5230\u4e8b\u52a1\u3002\u6700\u7ecf\u5178\u7684\u4f8b\u5b50\u5c31\u662f\u8f6c\u8d26\uff0c\u4f60\u8981\u7ed9\u670b\u53cb\u5c0f\u738b\u8f6c 100 \u5757\u94b1\uff0c\u800c\u6b64\u65f6\u4f60\u7684\u94f6\u884c\u5361\u53ea\u6709 100 \u5757\u94b1\u3002</p> <p>\u8f6c\u8d26\u8fc7\u7a0b\u5177\u4f53\u5230\u7a0b\u5e8f\u91cc\u4f1a\u6709\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u67e5\u8be2\u4f59\u989d\u3001\u505a\u52a0\u51cf\u6cd5\u3001\u66f4\u65b0\u4f59\u989d\u7b49\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5fc5\u987b\u4fdd\u8bc1\u662f\u4e00\u4f53\u7684\uff0c\u4e0d\u7136\u7b49\u7a0b\u5e8f\u67e5\u5b8c\u4e4b\u540e\uff0c\u8fd8\u6ca1\u505a\u51cf\u6cd5\u4e4b\u524d\uff0c\u4f60\u8fd9 100 \u5757\u94b1\uff0c\u5b8c\u5168\u53ef\u4ee5\u501f\u7740\u8fd9\u4e2a\u65f6\u95f4\u5dee\u518d\u67e5\u4e00\u6b21\uff0c\u7136\u540e\u518d\u7ed9\u53e6\u5916\u4e00\u4e2a\u670b\u53cb\u8f6c\u8d26\uff0c\u5982\u679c\u94f6\u884c\u8fd9\u4e48\u6574\uff0c\u4e0d\u5c31\u4e71\u4e86\u4e48\uff1f\u8fd9\u65f6\u5c31\u8981\u7528\u5230\u201c\u4e8b\u52a1\u201d\u8fd9\u4e2a\u6982\u5ff5\u4e86\u3002</p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u4e8b\u52a1\u5c31\u662f\u8981\u4fdd\u8bc1\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u5168\u90e8\u5931\u8d25\u3002\u5728 MySQL \u4e2d\uff0c\u4e8b\u52a1\u652f\u6301\u662f\u5728\u5f15\u64ce\u5c42\u5b9e\u73b0\u7684\u3002\u4f60\u73b0\u5728\u77e5\u9053\uff0cMySQL \u662f\u4e00\u4e2a\u652f\u6301\u591a\u5f15\u64ce\u7684\u7cfb\u7edf\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u4e8b\u52a1\u3002\u6bd4\u5982 MySQL \u539f\u751f\u7684 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u4e8b\u52a1\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u53d6\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p> <p>\u4eca\u5929\u7684\u6587\u7ae0\u91cc\uff0c\u6211\u5c06\u4f1a\u4ee5 InnoDB \u4e3a\u4f8b\uff0c\u5256\u6790 MySQL \u5728\u4e8b\u52a1\u652f\u6301\u65b9\u9762\u7684\u7279\u5b9a\u5b9e\u73b0\uff0c\u5e76\u57fa\u4e8e\u539f\u7406\u7ed9\u51fa\u76f8\u5e94\u7684\u5b9e\u8df5\u5efa\u8bae\uff0c\u5e0c\u671b\u8fd9\u4e9b\u6848\u4f8b\u80fd\u52a0\u6df1\u4f60\u5bf9 MySQL \u4e8b\u52a1\u539f\u7406\u7684\u7406\u89e3\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_9","title":"\u4e8b\u52a1\u9694\u79bb\u7684\u5b9e\u73b0","text":"<p>\u7406\u89e3\u4e86\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u4e8b\u52a1\u9694\u79bb\u5177\u4f53\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u3002\u8fd9\u91cc\u6211\u4eec\u5c55\u5f00\u8bf4\u660e\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u3002</p> <p>\u5728 MySQL \u4e2d\uff0c\u5b9e\u9645\u4e0a\u6bcf\u6761\u8bb0\u5f55\u5728\u66f4\u65b0\u7684\u65f6\u5019\u90fd\u4f1a\u540c\u65f6\u8bb0\u5f55\u4e00\u6761\u56de\u6eda\u64cd\u4f5c\u3002\u8bb0\u5f55\u4e0a\u7684\u6700\u65b0\u503c\uff0c\u901a\u8fc7\u56de\u6eda\u64cd\u4f5c\uff0c\u90fd\u53ef\u4ee5\u5f97\u5230\u524d\u4e00\u4e2a\u72b6\u6001\u7684\u503c\u3002</p> <p>\u5047\u8bbe\u4e00\u4e2a\u503c\u4ece 1 \u88ab\u6309\u987a\u5e8f\u6539\u6210\u4e86 2\u30013\u30014\uff0c\u5728\u56de\u6eda\u65e5\u5fd7\u91cc\u9762\u5c31\u4f1a\u6709\u7c7b\u4f3c\u4e0b\u9762\u7684\u8bb0\u5f55\u3002</p> <pre><code>flowchart LR\n    %% define node\n        A[\"read view A\"] .-&gt; 2to1\n    B[\"read view B\"] .-&gt; 3to2\n\n    curr[\"\u5f53\u524d\u503c4\"] --&gt; 4to3\n    direction TB\n    C[\"read view C\"] .-&gt; curr\n\n    subgraph redo [\"\u56de\u6eda\u6bb5\"]\n        direction RL\n        2to1[\"\u5c062\u6539\u62101\"]:::heavygreen\n        3to2[\"\u5c063\u6539\u62102\"]\n        4to3[\"\u5c064\u6539\u62103\"]:::heavygreen\n\n        4to3  --&gt; 3to2 --&gt; 2to1\n    end\n\n    classDef heavygreen fill:#f8f2</code></pre> <p>\u5f53\u524d\u503c\u662f 4\uff0c\u4f46\u662f\u5728\u67e5\u8be2\u8fd9\u6761\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u4e0d\u540c\u65f6\u523b\u542f\u52a8\u7684\u4e8b\u52a1\u4f1a\u6709\u4e0d\u540c\u7684 read-view\u3002\u5982\u56fe\u4e2d\u770b\u5230\u7684\uff0c\u5728\u89c6\u56fe A\u3001B\u3001C \u91cc\u9762\uff0c\u8fd9\u4e00\u4e2a\u8bb0\u5f55\u7684\u503c\u5206\u522b\u662f 1\u30012\u30014\uff0c\u540c\u4e00\u6761\u8bb0\u5f55\u5728\u7cfb\u7edf\u4e2d\u53ef\u4ee5\u5b58\u5728\u591a\u4e2a\u7248\u672c\uff0c\u5c31\u662f\u6570\u636e\u5e93\u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08MVCC\uff09\u3002\u5bf9\u4e8e read-view A\uff0c\u8981\u5f97\u5230 1\uff0c\u5c31\u5fc5\u987b\u5c06\u5f53\u524d\u503c\u4f9d\u6b21\u6267\u884c\u56fe\u4e2d\u6240\u6709\u7684\u56de\u6eda\u64cd\u4f5c\u5f97\u5230\u3002</p> <p>\u540c\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u5373\u4f7f\u73b0\u5728\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u5c06 4 \u6539\u6210 5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u8ddf read-view A\u3001B\u3001C \u5bf9\u5e94\u7684\u4e8b\u52a1\u662f\u4e0d\u4f1a\u51b2\u7a81\u7684\u3002</p> <p>\u4f60\u4e00\u5b9a\u4f1a\u95ee\uff0c\u56de\u6eda\u65e5\u5fd7\u603b\u4e0d\u80fd\u4e00\u76f4\u4fdd\u7559\u5427\uff0c\u4ec0\u4e48\u65f6\u5019\u5220\u9664\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5728\u4e0d\u9700\u8981\u7684\u65f6\u5019\u624d\u5220\u9664\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7cfb\u7edf\u4f1a\u5224\u65ad\uff0c\u5f53\u6ca1\u6709\u4e8b\u52a1\u518d\u9700\u8981\u7528\u5230\u8fd9\u4e9b\u56de\u6eda\u65e5\u5fd7\u65f6\uff0c\u56de\u6eda\u65e5\u5fd7\u4f1a\u88ab\u5220\u9664\u3002</p> <p>\u4ec0\u4e48\u65f6\u5019\u624d\u4e0d\u9700\u8981\u4e86\u5462\uff1f\u5c31\u662f\u5f53\u7cfb\u7edf\u91cc\u6ca1\u6709\u6bd4\u8fd9\u4e2a\u56de\u6eda\u65e5\u5fd7\u66f4\u65e9\u7684 read-view \u7684\u65f6\u5019\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u5efa\u8bae\u4f60\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u957f\u4e8b\u52a1\u3002</p> <p>\u957f\u4e8b\u52a1\u610f\u5473\u7740\u7cfb\u7edf\u91cc\u9762\u4f1a\u5b58\u5728\u5f88\u8001\u7684\u4e8b\u52a1\u89c6\u56fe\u3002\u7531\u4e8e\u8fd9\u4e9b\u4e8b\u52a1\u968f\u65f6\u53ef\u80fd\u8bbf\u95ee\u6570\u636e\u5e93\u91cc\u9762\u7684\u4efb\u4f55\u6570\u636e\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\uff0c\u6570\u636e\u5e93\u91cc\u9762\u5b83\u53ef\u80fd\u7528\u5230\u7684\u56de\u6eda\u8bb0\u5f55\u90fd\u5fc5\u987b\u4fdd\u7559\uff0c\u8fd9\u5c31\u4f1a\u5bfc\u81f4\u5927\u91cf\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002</p> <p>\u5728 MySQL 5.5 \u53ca\u4ee5\u524d\u7684\u7248\u672c\uff0c\u56de\u6eda\u65e5\u5fd7\u662f\u8ddf\u6570\u636e\u5b57\u5178\u4e00\u8d77\u653e\u5728 ibdata \u6587\u4ef6\u91cc\u7684\uff0c\u5373\u4f7f\u957f\u4e8b\u52a1\u6700\u7ec8\u63d0\u4ea4\uff0c\u56de\u6eda\u6bb5\u88ab\u6e05\u7406\uff0c\u6587\u4ef6\u4e5f\u4e0d\u4f1a\u53d8\u5c0f\u3002\u6211\u89c1\u8fc7\u6570\u636e\u53ea\u6709 20GB\uff0c\u800c\u56de\u6eda\u6bb5\u6709 200GB \u7684\u5e93\u3002\u6700\u7ec8\u53ea\u597d\u4e3a\u4e86\u6e05\u7406\u56de\u6eda\u6bb5\uff0c\u91cd\u5efa\u6574\u4e2a\u5e93\u3002</p> <p>\u9664\u4e86\u5bf9\u56de\u6eda\u6bb5\u7684\u5f71\u54cd\uff0c\u957f\u4e8b\u52a1\u8fd8\u5360\u7528\u9501\u8d44\u6e90\uff0c\u4e5f\u53ef\u80fd\u62d6\u57ae\u6574\u4e2a\u5e93\uff0c\u8fd9\u4e2a\u6211\u4eec\u4f1a\u5728\u540e\u9762\u8bb2\u9501\u7684\u65f6\u5019\u5c55\u5f00\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_10","title":"\u4e8b\u52a1\u7684\u542f\u52a8\u65b9\u5f0f","text":"<p>\u5982\u524d\u9762\u6240\u8ff0\uff0c\u957f\u4e8b\u52a1\u6709\u8fd9\u4e9b\u6f5c\u5728\u98ce\u9669\uff0c\u6211\u5f53\u7136\u662f\u5efa\u8bae\u4f60\u5c3d\u91cf\u907f\u514d\u3002\u5176\u5b9e\u5f88\u591a\u65f6\u5019\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u5e76\u4e0d\u662f\u6709\u610f\u4f7f\u7528\u957f\u4e8b\u52a1\uff0c\u901a\u5e38\u662f\u7531\u4e8e\u8bef\u7528\u6240\u81f4\u3002MySQL \u7684\u4e8b\u52a1\u542f\u52a8\u65b9\u5f0f\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ol> <li>\u663e\u5f0f\u542f\u52a8\u4e8b\u52a1\u8bed\u53e5\uff0c begin \u6216 start transaction\u3002\u914d\u5957\u7684\u63d0\u4ea4\u8bed\u53e5\u662f commit\uff0c\u56de\u6eda\u8bed\u53e5\u662f rollback\u3002</li> <li><code>set autocommit=0</code>\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5c06\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u81ea\u52a8\u63d0\u4ea4\u5173\u6389\u3002\u610f\u5473\u7740\u5982\u679c\u4f60\u53ea\u6267\u884c\u4e00\u4e2a select \u8bed\u53e5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5c31\u542f\u52a8\u4e86\uff0c\u800c\u4e14\u5e76\u4e0d\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002\u8fd9\u4e2a\u4e8b\u52a1\u6301\u7eed\u5b58\u5728\u76f4\u5230\u4f60\u4e3b\u52a8\u6267\u884c commit \u6216 rollback \u8bed\u53e5\uff0c\u6216\u8005\u65ad\u5f00\u8fde\u63a5\u3002</li> </ol> <p>\u6709\u4e9b\u5ba2\u6237\u7aef\u8fde\u63a5\u6846\u67b6\u4f1a\u9ed8\u8ba4\u8fde\u63a5\u6210\u529f\u540e\u5148\u6267\u884c\u4e00\u4e2a <code>set autocommit=0</code> \u7684\u547d\u4ee4\u3002\u8fd9\u5c31\u5bfc\u81f4\u63a5\u4e0b\u6765\u7684\u67e5\u8be2\u90fd\u5728\u4e8b\u52a1\u4e2d\uff0c\u5982\u679c\u662f\u957f\u8fde\u63a5\uff0c\u5c31\u5bfc\u81f4\u4e86\u610f\u5916\u7684\u957f\u4e8b\u52a1\u3002</p> <p>\u56e0\u6b64\uff0c\u6211\u4f1a\u5efa\u8bae\u4f60\u603b\u662f\u4f7f\u7528 <code>set autocommit=1</code>, \u901a\u8fc7\u663e\u5f0f\u8bed\u53e5\u7684\u65b9\u5f0f\u6765\u542f\u52a8\u4e8b\u52a1\u3002</p> <p>\u4f46\u662f\u6709\u7684\u5f00\u53d1\u540c\u5b66\u4f1a\u7ea0\u7ed3\u201c\u591a\u4e00\u6b21\u4ea4\u4e92\u201d\u7684\u95ee\u9898\u3002\u5bf9\u4e8e\u4e00\u4e2a\u9700\u8981\u9891\u7e41\u4f7f\u7528\u4e8b\u52a1\u7684\u4e1a\u52a1\uff0c\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u6bcf\u4e2a\u4e8b\u52a1\u5728\u5f00\u59cb\u65f6\u90fd\u4e0d\u9700\u8981\u4e3b\u52a8\u6267\u884c\u4e00\u6b21 \u201cbegin\u201d\uff0c\u51cf\u5c11\u4e86\u8bed\u53e5\u7684\u4ea4\u4e92\u6b21\u6570\u3002\u5982\u679c\u4f60\u4e5f\u6709\u8fd9\u4e2a\u987e\u8651\uff0c\u6211\u5efa\u8bae\u4f60\u4f7f\u7528 <code>commit work and chain</code> \u8bed\u6cd5\u3002</p> <p>\u5728 autocommit \u4e3a 1 \u7684\u60c5\u51b5\u4e0b\uff0c\u7528 begin \u663e\u5f0f\u542f\u52a8\u7684\u4e8b\u52a1\uff0c\u5982\u679c\u6267\u884c commit \u5219\u63d0\u4ea4\u4e8b\u52a1\u3002\u5982\u679c\u6267\u884c commit work and chain\uff0c\u5219\u662f\u63d0\u4ea4\u4e8b\u52a1\u5e76\u81ea\u52a8\u542f\u52a8\u4e0b\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8fd9\u6837\u4e5f\u7701\u53bb\u4e86\u518d\u6b21\u6267\u884c begin \u8bed\u53e5\u7684\u5f00\u9500\u3002\u540c\u65f6\u5e26\u6765\u7684\u597d\u5904\u662f\u4ece\u7a0b\u5e8f\u5f00\u53d1\u7684\u89d2\u5ea6\u660e\u786e\u5730\u77e5\u9053\u6bcf\u4e2a\u8bed\u53e5\u662f\u5426\u5904\u4e8e\u4e8b\u52a1\u4e2d\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8fd9\u4e2a\u8868\u4e2d\u67e5\u8be2\u957f\u4e8b\u52a1\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7528\u4e8e\u67e5\u627e\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 60s \u7684\u4e8b\u52a1\u3002</p> <pre><code>select * from information_schema.INNODB_TRX where TIME_TO_SEC(timediff(now(),trx_started))&gt;60;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_11","title":"\u5c0f\u7ed3","text":"<p>\u8fd9\u7bc7\u6587\u7ae0\u91cc\u9762\uff0c\u6211\u4ecb\u7ecd\u4e86 MySQL \u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u73b0\u8c61\u548c\u5b9e\u73b0\uff0c\u6839\u636e\u5b9e\u73b0\u539f\u7406\u5206\u6790\u4e86\u957f\u4e8b\u52a1\u5b58\u5728\u7684\u98ce\u9669\uff0c\u4ee5\u53ca\u5982\u4f55\u7528\u6b63\u786e\u7684\u65b9\u5f0f\u907f\u514d\u957f\u4e8b\u52a1\u3002\u5e0c\u671b\u6211\u4e3e\u7684\u4f8b\u5b50\u80fd\u591f\u5e2e\u52a9\u4f60\u7406\u89e3\u4e8b\u52a1\uff0c\u5e76\u66f4\u597d\u5730\u4f7f\u7528 MySQL \u7684\u4e8b\u52a1\u7279\u6027\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#04","title":"04 \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0a\uff09","text":"<p>\u63d0\u5230\u6570\u636e\u5e93\u7d22\u5f15\uff0c\u6211\u60f3\u4f60\u5e76\u4e0d\u964c\u751f\uff0c\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u4f1a\u7ecf\u5e38\u63a5\u89e6\u5230\u3002\u6bd4\u5982\u67d0\u4e00\u4e2a SQL \u67e5\u8be2\u6bd4\u8f83\u6162\uff0c\u5206\u6790\u5b8c\u539f\u56e0\u4e4b\u540e\uff0c\u4f60\u53ef\u80fd\u5c31\u4f1a\u8bf4\u201c\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u52a0\u4e2a\u7d22\u5f15\u5427\u201d\u4e4b\u7c7b\u7684\u89e3\u51b3\u65b9\u6848\u3002\u4f46\u5230\u5e95\u4ec0\u4e48\u662f\u7d22\u5f15\uff0c\u7d22\u5f15\u53c8\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u5462\uff1f\u4eca\u5929\u5c31\u8ba9\u6211\u4eec\u4e00\u8d77\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u5427\u3002</p> <p>\u6570\u636e\u5e93\u7d22\u5f15\u7684\u5185\u5bb9\u6bd4\u8f83\u591a\uff0c\u6211\u5206\u6210\u4e86\u4e0a\u4e0b\u4e24\u7bc7\u6587\u7ae0\u3002\u7d22\u5f15\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u91cc\u9762\u6700\u91cd\u8981\u7684\u6982\u5ff5\u4e4b\u4e00\uff0c\u6240\u4ee5\u6211\u5e0c\u671b\u4f60\u80fd\u591f\u8010\u5fc3\u770b\u5b8c\u3002\u5728\u540e\u9762\u7684\u5b9e\u6218\u6587\u7ae0\u4e2d\uff0c\u6211\u4e5f\u4f1a\u7ecf\u5e38\u5f15\u7528\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u77e5\u8bc6\u70b9\uff0c\u52a0\u6df1\u4f60\u5bf9\u6570\u636e\u5e93\u7d22\u5f15\u7684\u7406\u89e3\u3002</p> <p>\u4e00\u53e5\u8bdd\u7b80\u5355\u6765\u8bf4\uff0c\u7d22\u5f15\u7684\u51fa\u73b0\u5176\u5b9e\u5c31\u662f\u4e3a\u4e86\u63d0\u9ad8\u6570\u636e\u67e5\u8be2\u7684\u6548\u7387\uff0c\u5c31\u50cf\u4e66\u7684\u76ee\u5f55\u4e00\u6837\u3002\u4e00\u672c 500 \u9875\u7684\u4e66\uff0c\u5982\u679c\u4f60\u60f3\u5feb\u901f\u627e\u5230\u5176\u4e2d\u7684\u67d0\u4e00\u4e2a\u77e5\u8bc6\u70b9\uff0c\u5728\u4e0d\u501f\u52a9\u76ee\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u90a3\u6211\u4f30\u8ba1\u4f60\u53ef\u5f97\u627e\u4e00\u4f1a\u513f\u3002\u540c\u6837\uff0c\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u8868\u800c\u8a00\uff0c\u7d22\u5f15\u5176\u5b9e\u5c31\u662f\u5b83\u7684\u201c\u76ee\u5f55\u201d\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#innodb","title":"InnoDB \u7684\u7d22\u5f15\u6a21\u578b","text":"<p>\u5728 InnoDB \u4e2d\uff0c\u8868\u90fd\u662f\u6839\u636e\u4e3b\u952e\u987a\u5e8f\u4ee5\u7d22\u5f15\u7684\u5f62\u5f0f\u5b58\u653e\u7684\uff0c\u8fd9\u79cd\u5b58\u50a8\u65b9\u5f0f\u7684\u8868\u79f0\u4e3a\u7d22\u5f15\u7ec4\u7ec7\u8868\u3002\u53c8\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u63d0\u5230\u7684\uff0cInnoDB \u4f7f\u7528\u4e86 B+ \u6811\u7d22\u5f15\u6a21\u578b\uff0c\u6240\u4ee5\u6570\u636e\u90fd\u662f\u5b58\u50a8\u5728 B+ \u6811\u4e2d\u7684\u3002</p> <p>\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5728 InnoDB \u91cc\u9762\u5bf9\u5e94\u4e00\u68f5 B+ \u6811\u3002</p> <p>\u5047\u8bbe\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u4e3b\u952e\u5217\u4e3a ID \u7684\u8868\uff0c\u8868\u4e2d\u6709\u5b57\u6bb5 k\uff0c\u5e76\u4e14\u5728 k \u4e0a\u6709\u7d22\u5f15\u3002</p> <p>\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u662f\uff1a</p> <pre><code>mysql&gt; create table T(\nid int primary key, \nk int not null, \nname varchar(16),\nindex (k))engine=InnoDB;\n</code></pre> <p>\u8868\u4e2d R1~R5 \u7684 (ID,k) \u503c\u5206\u522b\u4e3a (100,1)\u3001(200,2)\u3001(300,3)\u3001(500,5) \u548c (600,6)\uff0c\u4e24\u68f5\u6811\u7684\u793a\u4f8b\u793a\u610f\u56fe\u5982\u4e0b\u3002</p> <p></p> <p>\u4ece\u56fe\u4e2d\u4e0d\u96be\u770b\u51fa\uff0c\u6839\u636e\u53f6\u5b50\u8282\u70b9\u7684\u5185\u5bb9\uff0c\u7d22\u5f15\u7c7b\u578b\u5206\u4e3a\u4e3b\u952e\u7d22\u5f15\u548c\u975e\u4e3b\u952e\u7d22\u5f15\u3002</p> <p>\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u7684\u662f\u6574\u884c\u6570\u636e\u3002\u5728 InnoDB \u91cc\uff0c\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u805a\u7c07\u7d22\u5f15\uff08clustered index\uff09\u3002</p> <p>\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5185\u5bb9\u662f\u4e3b\u952e\u7684\u503c\u3002\u5728 InnoDB \u91cc\uff0c\u975e\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u4e8c\u7ea7\u7d22\u5f15\uff08secondary index\uff09\u3002</p> <p>\u6839\u636e\u4e0a\u9762\u7684\u7d22\u5f15\u7ed3\u6784\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a\u57fa\u4e8e\u4e3b\u952e\u7d22\u5f15\u548c\u666e\u901a\u7d22\u5f15\u7684\u67e5\u8be2\u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> <ul> <li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where ID=500</code>\uff0c\u5373\u4e3b\u952e\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u53ea\u9700\u8981\u641c\u7d22 ID \u8fd9\u68f5 B+ \u6811\uff1b</li> <li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where k=5</code>\uff0c\u5373\u666e\u901a\u7d22\u5f15\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u9700\u8981\u5148\u641c\u7d22 k \u7d22\u5f15\u6811\uff0c\u5f97\u5230 ID \u7684\u503c\u4e3a 500\uff0c\u518d\u5230 ID \u7d22\u5f15\u6811\u641c\u7d22\u4e00\u6b21\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u56de\u8868\u3002</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u57fa\u4e8e\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u67e5\u8be2\u9700\u8981\u591a\u626b\u63cf\u4e00\u68f5\u7d22\u5f15\u6811\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5728\u5e94\u7528\u4e2d\u5e94\u8be5\u5c3d\u91cf\u4f7f\u7528\u4e3b\u952e\u67e5\u8be2\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_12","title":"\u7d22\u5f15\u7ef4\u62a4","text":"<p>B+ \u6811\u4e3a\u4e86\u7ef4\u62a4\u7d22\u5f15\u6709\u5e8f\u6027\uff0c\u5728\u63d2\u5165\u65b0\u503c\u7684\u65f6\u5019\u9700\u8981\u505a\u5fc5\u8981\u7684\u7ef4\u62a4\u3002\u4ee5\u4e0a\u9762\u8fd9\u4e2a\u56fe\u4e3a\u4f8b\uff0c\u5982\u679c\u63d2\u5165\u65b0\u7684\u884c ID \u503c\u4e3a 700\uff0c\u5219\u53ea\u9700\u8981\u5728 R5 \u7684\u8bb0\u5f55\u540e\u9762\u63d2\u5165\u4e00\u4e2a\u65b0\u8bb0\u5f55\u3002\u5982\u679c\u65b0\u63d2\u5165\u7684 ID \u503c\u4e3a 400\uff0c\u5c31\u76f8\u5bf9\u9ebb\u70e6\u4e86\uff0c\u9700\u8981\u903b\u8f91\u4e0a\u632a\u52a8\u540e\u9762\u7684\u6570\u636e\uff0c\u7a7a\u51fa\u4f4d\u7f6e\u3002</p> <p>\u800c\u66f4\u7cdf\u7684\u60c5\u51b5\u662f\uff0c\u5982\u679c R5 \u6240\u5728\u7684\u6570\u636e\u9875\u5df2\u7ecf\u6ee1\u4e86\uff0c\u6839\u636e B+ \u6811\u7684\u7b97\u6cd5\uff0c\u8fd9\u65f6\u5019\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u9875\uff0c\u7136\u540e\u632a\u52a8\u90e8\u5206\u6570\u636e\u8fc7\u53bb\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u9875\u5206\u88c2\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6027\u80fd\u81ea\u7136\u4f1a\u53d7\u5f71\u54cd\u3002</p> <p>\u9664\u4e86\u6027\u80fd\u5916\uff0c\u9875\u5206\u88c2\u64cd\u4f5c\u8fd8\u5f71\u54cd\u6570\u636e\u9875\u7684\u5229\u7528\u7387\u3002\u539f\u672c\u653e\u5728\u4e00\u4e2a\u9875\u7684\u6570\u636e\uff0c\u73b0\u5728\u5206\u5230\u4e24\u4e2a\u9875\u4e2d\uff0c\u6574\u4f53\u7a7a\u95f4\u5229\u7528\u7387\u964d\u4f4e\u5927\u7ea6 50%\u3002</p> <p>\u5f53\u7136\u6709\u5206\u88c2\u5c31\u6709\u5408\u5e76\u3002\u5f53\u76f8\u90bb\u4e24\u4e2a\u9875\u7531\u4e8e\u5220\u9664\u4e86\u6570\u636e\uff0c\u5229\u7528\u7387\u5f88\u4f4e\u4e4b\u540e\uff0c\u4f1a\u5c06\u6570\u636e\u9875\u505a\u5408\u5e76\u3002\u5408\u5e76\u7684\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u662f\u5206\u88c2\u8fc7\u7a0b\u7684\u9006\u8fc7\u7a0b\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u7d22\u5f15\u7ef4\u62a4\u8fc7\u7a0b\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u6848\u4f8b\uff1a</p> <p>\u4f60\u53ef\u80fd\u5728\u4e00\u4e9b\u5efa\u8868\u89c4\u8303\u91cc\u9762\u89c1\u5230\u8fc7\u7c7b\u4f3c\u7684\u63cf\u8ff0\uff0c\u8981\u6c42\u5efa\u8868\u8bed\u53e5\u91cc\u4e00\u5b9a\u8981\u6709\u81ea\u589e\u4e3b\u952e\u3002\u5f53\u7136\u4e8b\u65e0\u7edd\u5bf9\uff0c\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u54ea\u4e9b\u573a\u666f\u4e0b\u5e94\u8be5\u4f7f\u7528\u81ea\u589e\u4e3b\u952e\uff0c\u800c\u54ea\u4e9b\u573a\u666f\u4e0b\u4e0d\u5e94\u8be5\u3002</p> <p>\u81ea\u589e\u4e3b\u952e\u662f\u6307\u81ea\u589e\u5217\u4e0a\u5b9a\u4e49\u7684\u4e3b\u952e\uff0c\u5728\u5efa\u8868\u8bed\u53e5\u4e2d\u4e00\u822c\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a NOT NULL PRIMARY KEY AUTO_INCREMENT\u3002</p> <p>\u63d2\u5165\u65b0\u8bb0\u5f55\u7684\u65f6\u5019\u53ef\u4ee5\u4e0d\u6307\u5b9a ID \u7684\u503c\uff0c\u7cfb\u7edf\u4f1a\u83b7\u53d6\u5f53\u524d ID \u6700\u5927\u503c\u52a0 1 \u4f5c\u4e3a\u4e0b\u4e00\u6761\u8bb0\u5f55\u7684 ID \u503c\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u81ea\u589e\u4e3b\u952e\u7684\u63d2\u5165\u6570\u636e\u6a21\u5f0f\uff0c\u6b63\u7b26\u5408\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u9012\u589e\u63d2\u5165\u7684\u573a\u666f\u3002\u6bcf\u6b21\u63d2\u5165\u4e00\u6761\u65b0\u8bb0\u5f55\uff0c\u90fd\u662f\u8ffd\u52a0\u64cd\u4f5c\uff0c\u90fd\u4e0d\u6d89\u53ca\u5230\u632a\u52a8\u5176\u4ed6\u8bb0\u5f55\uff0c\u4e5f\u4e0d\u4f1a\u89e6\u53d1\u53f6\u5b50\u8282\u70b9\u7684\u5206\u88c2\u3002</p> <p>\u800c\u6709\u4e1a\u52a1\u903b\u8f91\u7684\u5b57\u6bb5\u505a\u4e3b\u952e\uff0c\u5219\u5f80\u5f80\u4e0d\u5bb9\u6613\u4fdd\u8bc1\u6709\u5e8f\u63d2\u5165\uff0c\u8fd9\u6837\u5199\u6570\u636e\u6210\u672c\u76f8\u5bf9\u8f83\u9ad8\u3002</p> <p>\u9664\u4e86\u8003\u8651\u6027\u80fd\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4ece\u5b58\u50a8\u7a7a\u95f4\u7684\u89d2\u5ea6\u6765\u770b\u3002\u5047\u8bbe\u4f60\u7684\u8868\u4e2d\u786e\u5b9e\u6709\u4e00\u4e2a\u552f\u4e00\u5b57\u6bb5\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u90a3\u5e94\u8be5\u7528\u8eab\u4efd\u8bc1\u53f7\u505a\u4e3b\u952e\uff0c\u8fd8\u662f\u7528\u81ea\u589e\u5b57\u6bb5\u505a\u4e3b\u952e\u5462\uff1f</p> <p>\u7531\u4e8e\u6bcf\u4e2a\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u4e0a\u90fd\u662f\u4e3b\u952e\u7684\u503c\u3002\u5982\u679c\u7528\u8eab\u4efd\u8bc1\u53f7\u505a\u4e3b\u952e\uff0c\u90a3\u4e48\u6bcf\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5360\u7528\u7ea6 20 \u4e2a\u5b57\u8282\uff0c\u800c\u5982\u679c\u7528\u6574\u578b\u505a\u4e3b\u952e\uff0c\u5219\u53ea\u8981 4 \u4e2a\u5b57\u8282\uff0c\u5982\u679c\u662f\u957f\u6574\u578b\uff08bigint\uff09\u5219\u662f 8 \u4e2a\u5b57\u8282\u3002</p> <p>\u663e\u7136\uff0c\u4e3b\u952e\u957f\u5ea6\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5c31\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u4e5f\u5c31\u8d8a\u5c0f\u3002</p> <p>\u6240\u4ee5\uff0c\u4ece\u6027\u80fd\u548c\u5b58\u50a8\u7a7a\u95f4\u65b9\u9762\u8003\u91cf\uff0c\u81ea\u589e\u4e3b\u952e\u5f80\u5f80\u662f\u66f4\u5408\u7406\u7684\u9009\u62e9\u3002</p> <p>\u6709\u6ca1\u6709\u4ec0\u4e48\u573a\u666f\u9002\u5408\u7528\u4e1a\u52a1\u5b57\u6bb5\u76f4\u63a5\u505a\u4e3b\u952e\u7684\u5462\uff1f\u8fd8\u662f\u6709\u7684\u3002\u6bd4\u5982\uff0c\u6709\u4e9b\u4e1a\u52a1\u7684\u573a\u666f\u9700\u6c42\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u53ea\u6709\u4e00\u4e2a\u7d22\u5f15\uff1b</li> <li>\u8be5\u7d22\u5f15\u5fc5\u987b\u662f\u552f\u4e00\u7d22\u5f15\u3002</li> </ol> <p>\u4f60\u4e00\u5b9a\u770b\u51fa\u6765\u4e86\uff0c\u8fd9\u5c31\u662f\u5178\u578b\u7684 KV \u573a\u666f\u3002</p> <p>\u7531\u4e8e\u6ca1\u6709\u5176\u4ed6\u7d22\u5f15\uff0c\u6240\u4ee5\u4e5f\u5c31\u4e0d\u7528\u8003\u8651\u5176\u4ed6\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5927\u5c0f\u7684\u95ee\u9898\u3002</p> <p>\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u8981\u4f18\u5148\u8003\u8651\u4e0a\u4e00\u6bb5\u63d0\u5230\u7684\u201c\u5c3d\u91cf\u4f7f\u7528\u4e3b\u952e\u67e5\u8be2\u201d\u539f\u5219\uff0c\u76f4\u63a5\u5c06\u8fd9\u4e2a\u7d22\u5f15\u8bbe\u7f6e\u4e3a\u4e3b\u952e\uff0c\u53ef\u4ee5\u907f\u514d\u6bcf\u6b21\u67e5\u8be2\u9700\u8981\u641c\u7d22\u4e24\u68f5\u6811\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_13","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u8ddf\u4f60\u5206\u6790\u4e86\u6570\u636e\u5e93\u5f15\u64ce\u53ef\u7528\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ecb\u7ecd\u4e86 InnoDB \u91c7\u7528\u7684 B+ \u6811\u7ed3\u6784\uff0c\u4ee5\u53ca\u4e3a\u4ec0\u4e48 InnoDB \u8981\u8fd9\u4e48\u9009\u62e9\u3002B+ \u6811\u80fd\u591f\u5f88\u597d\u5730\u914d\u5408\u78c1\u76d8\u7684\u8bfb\u5199\u7279\u6027\uff0c\u51cf\u5c11\u5355\u6b21\u67e5\u8be2\u7684\u78c1\u76d8\u8bbf\u95ee\u6b21\u6570\u3002</p> <p>\u7531\u4e8e InnoDB \u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u521b\u5efa\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e\uff0c\u8fd9\u6837\u975e\u4e3b\u952e\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u6700\u5c0f\u3002\u4f46\u4e8b\u65e0\u7edd\u5bf9\uff0c\u6211\u4e5f\u8ddf\u4f60\u8ba8\u8bba\u4e86\u4f7f\u7528\u4e1a\u52a1\u903b\u8f91\u5b57\u6bb5\u505a\u4e3b\u952e\u7684\u5e94\u7528\u573a\u666f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#05","title":"05 \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0b\uff09","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 InnoDB \u7d22\u5f15\u7684\u6570\u636e\u7ed3\u6784\u6a21\u578b\uff0c\u4eca\u5929\u6211\u4eec\u518d\u7ee7\u7eed\u804a\u804a\u8ddf MySQL \u7d22\u5f15\u6709\u5173\u7684\u6982\u5ff5\u3002</p> <p>\u5728\u5f00\u59cb\u8fd9\u7bc7\u6587\u7ae0\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <p>\u5728\u4e0b\u9762\u8fd9\u4e2a\u8868 T \u4e2d\uff0c\u5982\u679c\u6211\u6267\u884c <code>select * from T where k between 3 and 5</code>\uff0c\u9700\u8981\u6267\u884c\u51e0\u6b21\u6811\u7684\u641c\u7d22\u64cd\u4f5c\uff0c\u4f1a\u626b\u63cf\u591a\u5c11\u884c\uff1f</p> <p>\u4e0b\u9762\u662f\u8fd9\u4e2a\u8868\u7684\u521d\u59cb\u5316\u8bed\u53e5\u3002</p> <pre><code>mysql&gt; create table T (\nID int primary key,\nk int NOT NULL DEFAULT 0, \ns varchar(16) NOT NULL DEFAULT '',\nindex k(k))\nengine=InnoDB; \nmysql&gt; insert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg');\n</code></pre> <p></p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u8fd9\u6761 SQL \u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <ol> <li>\u5728 k \u7d22\u5f15\u6811\u4e0a\u627e\u5230 k=3 \u7684\u8bb0\u5f55\uff0c\u53d6\u5f97 ID = 300\uff1b</li> <li>\u518d\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=300 \u5bf9\u5e94\u7684 R3\uff1b</li> <li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=5\uff0c\u53d6\u5f97 ID=500\uff1b</li> <li>\u518d\u56de\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=500 \u5bf9\u5e94\u7684 R4\uff1b</li> <li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=6\uff0c\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u6811\u641c\u7d22\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u79f0\u4e3a\u56de\u8868\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u8bfb\u4e86 k \u7d22\u5f15\u6811\u7684 3 \u6761\u8bb0\u5f55\uff08\u6b65\u9aa4 1\u30013 \u548c 5\uff09\uff0c\u56de\u8868\u4e86\u4e24\u6b21\uff08\u6b65\u9aa4 2 \u548c 4\uff09\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u67e5\u8be2\u7ed3\u679c\u6240\u9700\u8981\u7684\u6570\u636e\u53ea\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u6709\uff0c\u6240\u4ee5\u4e0d\u5f97\u4e0d\u56de\u8868\u3002\u90a3\u4e48\uff0c\u6709\u6ca1\u6709\u53ef\u80fd\u7ecf\u8fc7\u7d22\u5f15\u4f18\u5316\uff0c\u907f\u514d\u56de\u8868\u8fc7\u7a0b\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_14","title":"\u8986\u76d6\u7d22\u5f15","text":"<p>\u5982\u679c\u6267\u884c\u7684\u8bed\u53e5\u662f <code>select ID from T where k between 3 and 5</code>\uff0c\u8fd9\u65f6\u53ea\u9700\u8981\u67e5 ID \u7684\u503c\uff0c\u800c ID \u7684\u503c\u5df2\u7ecf\u5728 k \u7d22\u5f15\u6811\u4e0a\u4e86\uff0c\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u63d0\u4f9b\u67e5\u8be2\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u56de\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u8fd9\u4e2a\u67e5\u8be2\u91cc\u9762\uff0c\u7d22\u5f15 k \u5df2\u7ecf\u201c\u8986\u76d6\u4e86\u201d\u6211\u4eec\u7684\u67e5\u8be2\u9700\u6c42\uff0c\u6211\u4eec\u79f0\u4e3a\u8986\u76d6\u7d22\u5f15\u3002</p> <p>\u7531\u4e8e\u8986\u76d6\u7d22\u5f15\u53ef\u4ee5\u51cf\u5c11\u6811\u7684\u641c\u7d22\u6b21\u6570\uff0c\u663e\u8457\u63d0\u5347\u67e5\u8be2\u6027\u80fd\uff0c\u6240\u4ee5\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\u662f\u4e00\u4e2a\u5e38\u7528\u7684\u6027\u80fd\u4f18\u5316\u624b\u6bb5\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\u5728\u7d22\u5f15 k \u4e0a\u5176\u5b9e\u8bfb\u4e86\u4e09\u4e2a\u8bb0\u5f55\uff0cR3~R5\uff08\u5bf9\u5e94\u7684\u7d22\u5f15 k \u4e0a\u7684\u8bb0\u5f55\u9879\uff09\uff0c\u4f46\u662f\u5bf9\u4e8e MySQL \u7684 Server \u5c42\u6765\u8bf4\uff0c\u5b83\u5c31\u662f\u627e\u5f15\u64ce\u62ff\u5230\u4e86\u4e24\u6761\u8bb0\u5f55\uff0c\u56e0\u6b64 MySQL \u8ba4\u4e3a\u626b\u63cf\u884c\u6570\u662f 2\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u8986\u76d6\u7d22\u5f15\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a\u5728\u4e00\u4e2a\u5e02\u6c11\u4fe1\u606f\u8868\u4e0a\uff0c\u662f\u5426\u6709\u5fc5\u8981\u5c06\u8eab\u4efd\u8bc1\u53f7\u548c\u540d\u5b57\u5efa\u7acb\u8054\u5408\u7d22\u5f15\uff1f</p> <p>\u5047\u8bbe\u8fd9\u4e2a\u5e02\u6c11\u8868\u7684\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>CREATE TABLE `tuser` (\n  `id` int(11) NOT NULL,\n  `id_card` varchar(32) DEFAULT NULL,\n  `name` varchar(32) DEFAULT NULL,\n  `age` int(11) DEFAULT NULL,\n  `ismale` tinyint(1) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `id_card` (`id_card`),\n  KEY `name_age` (`name`,`age`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u6211\u4eec\u77e5\u9053\uff0c\u8eab\u4efd\u8bc1\u53f7\u662f\u5e02\u6c11\u7684\u552f\u4e00\u6807\u8bc6\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u6709\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5e02\u6c11\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u6211\u4eec\u53ea\u8981\u5728\u8eab\u4efd\u8bc1\u53f7\u5b57\u6bb5\u4e0a\u5efa\u7acb\u7d22\u5f15\u5c31\u591f\u4e86\u3002\u800c\u518d\u5efa\u7acb\u4e00\u4e2a\uff08\u8eab\u4efd\u8bc1\u53f7\u3001\u59d3\u540d\uff09\u7684\u8054\u5408\u7d22\u5f15\uff0c\u662f\u4e0d\u662f\u6d6a\u8d39\u7a7a\u95f4\uff1f</p> <p>\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9ad8\u9891\u8bf7\u6c42\uff0c\u8981\u6839\u636e\u5e02\u6c11\u7684\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u4ed6\u7684\u59d3\u540d\uff0c\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u5c31\u6709\u610f\u4e49\u4e86\u3002\u5b83\u53ef\u4ee5\u5728\u8fd9\u4e2a\u9ad8\u9891\u8bf7\u6c42\u4e0a\u7528\u5230\u8986\u76d6\u7d22\u5f15\uff0c\u4e0d\u518d\u9700\u8981\u56de\u8868\u67e5\u6574\u884c\u8bb0\u5f55\uff0c\u51cf\u5c11\u8bed\u53e5\u7684\u6267\u884c\u65f6\u95f4\u3002</p> <p>\u5f53\u7136\uff0c\u7d22\u5f15\u5b57\u6bb5\u7684\u7ef4\u62a4\u603b\u662f\u6709\u4ee3\u4ef7\u7684\u3002\u56e0\u6b64\uff0c\u5728\u5efa\u7acb\u5197\u4f59\u7d22\u5f15\u6765\u652f\u6301\u8986\u76d6\u7d22\u5f15\u65f6\u5c31\u9700\u8981\u6743\u8861\u8003\u8651\u4e86\u3002\u8fd9\u6b63\u662f\u4e1a\u52a1 DBA\uff0c\u6216\u8005\u79f0\u4e3a\u4e1a\u52a1\u6570\u636e\u67b6\u6784\u5e08\u7684\u5de5\u4f5c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_15","title":"\u6700\u5de6\u524d\u7f00\u539f\u5219","text":"<p>\u770b\u5230\u8fd9\u91cc\u4f60\u4e00\u5b9a\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u5982\u679c\u4e3a\u6bcf\u4e00\u79cd\u67e5\u8be2\u90fd\u8bbe\u8ba1\u4e00\u4e2a\u7d22\u5f15\uff0c\u7d22\u5f15\u662f\u4e0d\u662f\u592a\u591a\u4e86\u3002\u5982\u679c\u6211\u73b0\u5728\u8981\u6309\u7167\u5e02\u6c11\u7684\u8eab\u4efd\u8bc1\u53f7\u53bb\u67e5\u4ed6\u7684\u5bb6\u5ead\u5730\u5740\u5462\uff1f\u867d\u7136\u8fd9\u4e2a\u67e5\u8be2\u9700\u6c42\u5728\u4e1a\u52a1\u4e2d\u51fa\u73b0\u7684\u6982\u7387\u4e0d\u9ad8\uff0c\u4f46\u603b\u4e0d\u80fd\u8ba9\u5b83\u8d70\u5168\u8868\u626b\u63cf\u5427\uff1f\u53cd\u8fc7\u6765\u8bf4\uff0c\u5355\u72ec\u4e3a\u4e00\u4e2a\u4e0d\u9891\u7e41\u7684\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\uff08\u8eab\u4efd\u8bc1\u53f7\uff0c\u5730\u5740\uff09\u7684\u7d22\u5f15\u53c8\u611f\u89c9\u6709\u70b9\u6d6a\u8d39\u3002\u5e94\u8be5\u600e\u4e48\u505a\u5462\uff1f</p> <p>\u8fd9\u91cc\uff0c\u6211\u5148\u548c\u4f60\u8bf4\u7ed3\u8bba\u5427\u3002B+ \u6811\u8fd9\u79cd\u7d22\u5f15\u7ed3\u6784\uff0c\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u7684\u201c\u6700\u5de6\u524d\u7f00\u201d\uff0c\u6765\u5b9a\u4f4d\u8bb0\u5f55\u3002</p> <p>\u4e3a\u4e86\u76f4\u89c2\u5730\u8bf4\u660e\u8fd9\u4e2a\u6982\u5ff5\uff0c\u6211\u4eec\u7528 <code>(name\uff0cage)</code>  \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u6765\u5206\u6790\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7d22\u5f15\u9879\u662f\u6309\u7167\u7d22\u5f15\u5b9a\u4e49\u91cc\u9762\u51fa\u73b0\u7684\u5b57\u6bb5\u987a\u5e8f\u6392\u5e8f\u7684\u3002</p> <p>\u5f53\u4f60\u7684\u903b\u8f91\u9700\u6c42\u662f\u67e5\u5230\u6240\u6709\u540d\u5b57\u662f\u201c\u5f20\u4e09\u201d\u7684\u4eba\u65f6\uff0c\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u5230 ID4\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\u5f97\u5230\u6240\u6709\u9700\u8981\u7684\u7ed3\u679c\u3002</p> <p>\u5982\u679c\u4f60\u8981\u67e5\u7684\u662f\u6240\u6709\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u201c\u5f20\u201d\u7684\u4eba\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u7684\u6761\u4ef6\u662f  <code>where name like '\u5f20%'</code>\u3002\u8fd9\u65f6\uff0c\u4f60\u4e5f\u80fd\u591f\u7528\u4e0a\u8fd9\u4e2a\u7d22\u5f15\uff0c\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\u662f ID3\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\uff0c\u76f4\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u4e3a\u6b62\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u53ea\u662f\u7d22\u5f15\u7684\u5168\u90e8\u5b9a\u4e49\uff0c\u53ea\u8981\u6ee1\u8db3\u6700\u5de6\u524d\u7f00\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u6765\u52a0\u901f\u68c0\u7d22\u3002\u8fd9\u4e2a\u6700\u5de6\u524d\u7f00\u53ef\u4ee5\u662f\u8054\u5408\u7d22\u5f15\u7684\u6700\u5de6 N \u4e2a\u5b57\u6bb5\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u7d22\u5f15\u7684\u6700\u5de6 M \u4e2a\u5b57\u7b26\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u5bf9\u6700\u5de6\u524d\u7f00\u7d22\u5f15\u7684\u8bf4\u660e\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a\u5728\u5efa\u7acb\u8054\u5408\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u5982\u4f55\u5b89\u6392\u7d22\u5f15\u5185\u7684\u5b57\u6bb5\u987a\u5e8f\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u7684\u8bc4\u4f30\u6807\u51c6\u662f\uff0c\u7d22\u5f15\u7684\u590d\u7528\u80fd\u529b\u3002\u56e0\u4e3a\u53ef\u4ee5\u652f\u6301\u6700\u5de6\u524d\u7f00\uff0c\u6240\u4ee5\u5f53\u5df2\u7ecf\u6709\u4e86 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u540e\uff0c\u4e00\u822c\u5c31\u4e0d\u9700\u8981\u5355\u72ec\u5728 a \u4e0a\u5efa\u7acb\u7d22\u5f15\u4e86\u3002\u56e0\u6b64\uff0c\u7b2c\u4e00\u539f\u5219\u662f\uff0c\u5982\u679c\u901a\u8fc7\u8c03\u6574\u987a\u5e8f\uff0c\u53ef\u4ee5\u5c11\u7ef4\u62a4\u4e00\u4e2a\u7d22\u5f15\uff0c\u90a3\u4e48\u8fd9\u4e2a\u987a\u5e8f\u5f80\u5f80\u5c31\u662f\u9700\u8981\u4f18\u5148\u8003\u8651\u91c7\u7528\u7684\u3002</p> <p>\u6240\u4ee5\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u8fd9\u6bb5\u5f00\u5934\u7684\u95ee\u9898\u91cc\uff0c\u6211\u4eec\u8981\u4e3a\u9ad8\u9891\u8bf7\u6c42\u521b\u5efa (\u8eab\u4efd\u8bc1\u53f7\uff0c\u59d3\u540d\uff09\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\uff0c\u5e76\u7528\u8fd9\u4e2a\u7d22\u5f15\u652f\u6301\u201c\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5730\u5740\u201d\u7684\u9700\u6c42\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u65e2\u6709\u8054\u5408\u67e5\u8be2\uff0c\u53c8\u6709\u57fa\u4e8e a\u3001b \u5404\u81ea\u7684\u67e5\u8be2\u5462\uff1f\u67e5\u8be2\u6761\u4ef6\u91cc\u9762\u53ea\u6709 b \u7684\u8bed\u53e5\uff0c\u662f\u65e0\u6cd5\u4f7f\u7528 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u7684\uff0c\u8fd9\u65f6\u5019\u4f60\u4e0d\u5f97\u4e0d\u7ef4\u62a4\u53e6\u5916\u4e00\u4e2a\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u9700\u8981\u540c\u65f6\u7ef4\u62a4 (a,b)\u3001(b) \u8fd9\u4e24\u4e2a\u7d22\u5f15\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u8981**\u8003\u8651\u7684\u539f\u5219\u5c31\u662f\u7a7a\u95f4**\u4e86\u3002\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u5e02\u6c11\u8868\u7684\u60c5\u51b5\uff0cname \u5b57\u6bb5\u662f\u6bd4 age \u5b57\u6bb5\u5927\u7684 \uff0c\u90a3\u6211\u5c31\u5efa\u8bae\u4f60\u521b\u5efa\u4e00\u4e2a\uff08name,age) \u7684\u8054\u5408\u7d22\u5f15\u548c\u4e00\u4e2a (age) \u7684\u5355\u5b57\u6bb5\u7d22\u5f15\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_16","title":"\u7d22\u5f15\u4e0b\u63a8","text":"<p>\u4e0a\u4e00\u6bb5\u6211\u4eec\u8bf4\u5230\u6ee1\u8db3\u6700\u5de6\u524d\u7f00\u539f\u5219\u7684\u65f6\u5019\uff0c\u6700\u5de6\u524d\u7f00\u53ef\u4ee5\u7528\u4e8e\u5728\u7d22\u5f15\u4e2d\u5b9a\u4f4d\u8bb0\u5f55\u3002\u8fd9\u65f6\uff0c\u4f60\u53ef\u80fd\u8981\u95ee\uff0c\u90a3\u4e9b\u4e0d\u7b26\u5408\u6700\u5de6\u524d\u7f00\u7684\u90e8\u5206\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f</p> <p>\u6211\u4eec\u8fd8\u662f\u4ee5\u5e02\u6c11\u8868\u7684\u8054\u5408\u7d22\u5f15\uff08name, age\uff09\u4e3a\u4f8b\u3002\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9700\u6c42\uff1a\u68c0\u7d22\u51fa\u8868\u4e2d\u201c\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u5f20\uff0c\u800c\u4e14\u5e74\u9f84\u662f 10 \u5c81\u7684\u6240\u6709\u7537\u5b69\u201d\u3002\u90a3\u4e48\uff0cSQL \u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p> <pre><code>mysql&gt; select * from tuser where name like '\u5f20%' and age=10 and ismale=1;\n</code></pre> <p>\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\u524d\u7f00\u7d22\u5f15\u89c4\u5219\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8bed\u53e5\u5728\u641c\u7d22\u7d22\u5f15\u6811\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u7528 \u201c\u5f20\u201d\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55 ID3\u3002\u5f53\u7136\uff0c\u8fd9\u8fd8\u4e0d\u9519\uff0c\u603b\u6bd4\u5168\u8868\u626b\u63cf\u8981\u597d\u3002</p> <p>\u7136\u540e\u5462\uff1f</p> <p>\u5f53\u7136\u662f\u5224\u65ad\u5176\u4ed6\u6761\u4ef6\u662f\u5426\u6ee1\u8db3\u3002</p> <p>\u5728 MySQL 5.6 \u4e4b\u524d\uff0c\u53ea\u80fd\u4ece ID3 \u5f00\u59cb\u4e00\u4e2a\u4e2a\u56de\u8868\u3002\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u627e\u51fa\u6570\u636e\u884c\uff0c\u518d\u5bf9\u6bd4\u5b57\u6bb5\u503c\u3002</p> <p>\u800c MySQL 5.6 \u5f15\u5165\u7684\u7d22\u5f15\u4e0b\u63a8\u4f18\u5316\uff08index condition pushdown)\uff0c \u53ef\u4ee5\u5728\u7d22\u5f15\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u7d22\u5f15\u4e2d\u5305\u542b\u7684\u5b57\u6bb5\u5148\u505a\u5224\u65ad\uff0c\u76f4\u63a5\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u51cf\u5c11\u56de\u8868\u6b21\u6570\u3002</p> <p>\u56fe 3 \u548c\u56fe 4\uff0c\u662f\u8fd9\u4e24\u4e2a\u8fc7\u7a0b\u7684\u6267\u884c\u6d41\u7a0b\u56fe\u3002</p> <p></p> <p>\u56fe 3 \u65e0\u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p> <p></p> <p>\u56fe 4 \u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p> <p>\u5728\u56fe 3 \u548c 4 \u8fd9\u4e24\u4e2a\u56fe\u91cc\u9762\uff0c\u6bcf\u4e00\u4e2a\u865a\u7ebf\u7bad\u5934\u8868\u793a\u56de\u8868\u4e00\u6b21\u3002</p> <p>\u56fe 3 \u4e2d\uff0c\u5728 <code>(name,age)</code> \u7d22\u5f15\u91cc\u9762\u6211\u7279\u610f\u53bb\u6389\u4e86 age \u7684\u503c\uff0c\u8fd9\u4e2a\u8fc7\u7a0b InnoDB \u5e76\u4e0d\u4f1a\u53bb\u770b age \u7684\u503c\uff0c\u53ea\u662f\u6309\u987a\u5e8f\u628a\u201cname \u7b2c\u4e00\u4e2a\u5b57\u662f\u2019\u5f20\u2019\u201d\u7684\u8bb0\u5f55\u4e00\u6761\u6761\u53d6\u51fa\u6765\u56de\u8868\u3002\u56e0\u6b64\uff0c\u9700\u8981\u56de\u8868 4 \u6b21\u3002</p> <p>\u56fe 4 \u8ddf\u56fe 3 \u7684\u533a\u522b\u662f\uff0cInnoDB \u5728 (name,age) \u7d22\u5f15\u5185\u90e8\u5c31\u5224\u65ad\u4e86 age \u662f\u5426\u7b49\u4e8e 10\uff0c\u5bf9\u4e8e\u4e0d\u7b49\u4e8e 10 \u7684\u8bb0\u5f55\uff0c\u76f4\u63a5\u5224\u65ad\u5e76\u8df3\u8fc7\u3002\u5728\u6211\u4eec\u7684\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u53ea\u9700\u8981\u5bf9 ID4\u3001ID5 \u8fd9\u4e24\u6761\u8bb0\u5f55\u56de\u8868\u53d6\u6570\u636e\u5224\u65ad\uff0c\u5c31\u53ea\u9700\u8981\u56de\u8868 2 \u6b21\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_17","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u7ee7\u7eed\u8ba8\u8bba\u4e86\u6570\u636e\u5e93\u7d22\u5f15\u7684\u6982\u5ff5\uff0c\u5305\u62ec\u4e86\u8986\u76d6\u7d22\u5f15\u3001\u524d\u7f00\u7d22\u5f15\u3001\u7d22\u5f15\u4e0b\u63a8\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u6ee1\u8db3\u8bed\u53e5\u9700\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c \u5c3d\u91cf\u5c11\u5730\u8bbf\u95ee\u8d44\u6e90\u662f\u6570\u636e\u5e93\u8bbe\u8ba1\u7684\u91cd\u8981\u539f\u5219\u4e4b\u4e00\u3002\u6211\u4eec\u5728\u4f7f\u7528\u6570\u636e\u5e93\u7684\u65f6\u5019\uff0c\u5c24\u5176\u662f\u5728\u8bbe\u8ba1\u8868\u7ed3\u6784\u65f6\uff0c\u4e5f\u8981\u4ee5\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\u4f5c\u4e3a\u76ee\u6807\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u95ee\u9898\u5427\u3002</p> <p>\u5b9e\u9645\u4e0a\u4e3b\u952e\u7d22\u5f15\u4e5f\u662f\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u5b57\u6bb5\u7684\u3002DBA \u5c0f\u5415\u5728\u5165\u804c\u65b0\u516c\u53f8\u7684\u65f6\u5019\uff0c\u5c31\u53d1\u73b0\u81ea\u5df1\u63a5\u624b\u7ef4\u62a4\u7684\u5e93\u91cc\u9762\uff0c\u6709\u8fd9\u4e48\u4e00\u4e2a\u8868\uff0c\u8868\u7ed3\u6784\u5b9a\u4e49\u7c7b\u4f3c\u8fd9\u6837\u7684\uff1a</p> <pre><code>CREATE TABLE `geek` (\n  `a` int(11) NOT NULL,\n  `b` int(11) NOT NULL,\n  `c` int(11) NOT NULL,\n  `d` int(11) NOT NULL,\n  PRIMARY KEY (`a`,`b`),\n  KEY `c` (`c`),\n  KEY `ca` (`c`,`a`),\n  KEY `cb` (`c`,`b`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u516c\u53f8\u7684\u540c\u4e8b\u544a\u8bc9\u4ed6\u8bf4\uff0c\u7531\u4e8e\u5386\u53f2\u539f\u56e0\uff0c\u8fd9\u4e2a\u8868\u9700\u8981 a\u3001b \u505a\u8054\u5408\u4e3b\u952e\uff0c\u8fd9\u4e2a\u5c0f\u5415\u7406\u89e3\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u5b66\u8fc7\u672c\u7ae0\u5185\u5bb9\u7684\u5c0f\u5415\u53c8\u7eb3\u95f7\u4e86\uff0c\u65e2\u7136\u4e3b\u952e\u5305\u542b\u4e86 a\u3001b \u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u90a3\u610f\u5473\u7740\u5355\u72ec\u5728\u5b57\u6bb5 c \u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff0c\u5c31\u5df2\u7ecf\u5305\u542b\u4e86\u4e09\u4e2a\u5b57\u6bb5\u4e86\u5440\uff0c\u4e3a\u4ec0\u4e48\u8981\u521b\u5efa\u201cca\u201d\u201ccb\u201d\u8fd9\u4e24\u4e2a\u7d22\u5f15\uff1f</p> <p>\u540c\u4e8b\u544a\u8bc9\u4ed6\uff0c\u662f\u56e0\u4e3a\u4ed6\u4eec\u7684\u4e1a\u52a1\u91cc\u9762\u6709\u8fd9\u6837\u7684\u4e24\u79cd\u8bed\u53e5\uff1a</p> <pre><code>select * from geek where c=N order by a limit 1;\nselect * from geek where c=N order by b limit 1;\n</code></pre> <p>\u6211\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u8fd9\u4f4d\u540c\u4e8b\u7684\u89e3\u91ca\u5bf9\u5417\uff0c\u4e3a\u4e86\u8fd9\u4e24\u4e2a\u67e5\u8be2\u6a21\u5f0f\uff0c\u8fd9\u4e24\u4e2a\u7d22\u5f15\u662f\u5426\u90fd\u662f\u5fc5\u987b\u7684\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u56de\u7b54\uff1a\u7d22\u5f15<code>ca</code> \u53ef\u4ee5\u53bb\u6389\uff0c<code>cb</code> \u9700\u8981\u4fdd\u7559\u3002\u8fd9\u662f\u56e0\u4e3a <code>c=N order by a</code> \u6761\u4ef6\u4e2d <code>c=N</code> \u53ef\u4ee5\u8d70 \u7d22\u5f15 c\uff0c\u800c <code>order by a</code> \u5219\u53ef\u4ee5\u8d70\u4e3b\u952e\u7d22\u5f15 \uff0c\u56e0\u6b64 <code>ca</code> \u5c31\u4e0d\u9700\u8981\u3002\u4f46\u56e0\u4e3a <code>order by b</code> \u8fd9\u4e2a\u63d0\u4ea4\u4e0d\u7b26\u5408\u6700\u5de6\u539f\u5219\uff0c\u56e0\u6b64\u65e0\u6cd5\u4f7f\u7528\u4e3b\u952e\u7d22\u5f15\uff0c\u9700\u8981\u7528\u5230 <code>cb</code> \u7d22\u5f15\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#06","title":"06 \u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u6709\u8fd9\u4e48\u591a\u963b\u788d\uff1f","text":"<p>\u4eca\u5929\u6211\u8981\u8ddf\u4f60\u804a\u804a MySQL \u7684\u9501\u3002\u6570\u636e\u5e93\u9501\u8bbe\u8ba1\u7684\u521d\u8877\u662f\u5904\u7406\u5e76\u53d1\u95ee\u9898\u3002\u4f5c\u4e3a\u591a\u7528\u6237\u5171\u4eab\u7684\u8d44\u6e90\uff0c\u5f53\u51fa\u73b0\u5e76\u53d1\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u6570\u636e\u5e93\u9700\u8981\u5408\u7406\u5730\u63a7\u5236\u8d44\u6e90\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u800c\u9501\u5c31\u662f\u7528\u6765\u5b9e\u73b0\u8fd9\u4e9b\u8bbf\u95ee\u89c4\u5219\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\u3002</p> <p>\u6839\u636e\u52a0\u9501\u7684\u8303\u56f4\uff0cMySQL \u91cc\u9762\u7684\u9501\u5927\u81f4\u53ef\u4ee5\u5206\u6210\u5168\u5c40\u9501\u3001\u8868\u7ea7\u9501\u548c\u884c\u9501\u4e09\u7c7b\u3002\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4f1a\u548c\u4f60\u5206\u4eab\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\u3002\u800c\u5173\u4e8e\u884c\u9501\u7684\u5185\u5bb9\uff0c\u6211\u4f1a\u7559\u7740\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u518d\u548c\u4f60\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u9501\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e0d\u4f1a\u6d89\u53ca\u9501\u7684\u5177\u4f53\u5b9e\u73b0\u7ec6\u8282\uff0c\u4e3b\u8981\u4ecb\u7ecd\u7684\u662f\u78b0\u5230\u9501\u65f6\u7684\u73b0\u8c61\u548c\u5176\u80cc\u540e\u7684\u539f\u7406\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_18","title":"\u5168\u5c40\u9501","text":"<p>\u987e\u540d\u601d\u4e49\uff0c\u5168\u5c40\u9501\u5c31\u662f\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u52a0\u9501\u3002MySQL \u63d0\u4f9b\u4e86\u4e00\u4e2a\u52a0\u5168\u5c40\u8bfb\u9501\u7684\u65b9\u6cd5\uff0c\u547d\u4ee4\u662f Flush tables with read lock (FTWRL)\u3002\u5f53\u4f60\u9700\u8981\u8ba9\u6574\u4e2a\u5e93\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u4e4b\u540e\u5176\u4ed6\u7ebf\u7a0b\u7684\u4ee5\u4e0b\u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff1a\u6570\u636e\u66f4\u65b0\u8bed\u53e5\uff08\u6570\u636e\u7684\u589e\u5220\u6539\uff09\u3001\u6570\u636e\u5b9a\u4e49\u8bed\u53e5\uff08\u5305\u62ec\u5efa\u8868\u3001\u4fee\u6539\u8868\u7ed3\u6784\u7b49\uff09\u548c\u66f4\u65b0\u7c7b\u4e8b\u52a1\u7684\u63d0\u4ea4\u8bed\u53e5\u3002</p> <p>\u5168\u5c40\u9501\u7684\u5178\u578b\u4f7f\u7528\u573a\u666f\u662f\uff0c\u505a\u5168\u5e93\u903b\u8f91\u5907\u4efd\u3002\u4e5f\u5c31\u662f\u628a\u6574\u5e93\u6bcf\u4e2a\u8868\u90fd select \u51fa\u6765\u5b58\u6210\u6587\u672c\u3002</p> <p>\u4ee5\u524d\u6709\u4e00\u79cd\u505a\u6cd5\uff0c\u662f\u901a\u8fc7 FTWRL \u786e\u4fdd\u4e0d\u4f1a\u6709\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u6570\u636e\u5e93\u505a\u66f4\u65b0\uff0c\u7136\u540e\u5bf9\u6574\u4e2a\u5e93\u505a\u5907\u4efd\u3002\u6ce8\u610f\uff0c\u5728\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6574\u4e2a\u5e93\u5b8c\u5168\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u3002</p> <p>\u4f46\u662f\u8ba9\u6574\u5e93\u90fd\u53ea\u8bfb\uff0c\u542c\u4e0a\u53bb\u5c31\u5f88\u5371\u9669\uff1a</p> <ul> <li>\u5982\u679c\u4f60\u5728\u4e3b\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5728\u5907\u4efd\u671f\u95f4\u90fd\u4e0d\u80fd\u6267\u884c\u66f4\u65b0\uff0c\u4e1a\u52a1\u57fa\u672c\u4e0a\u5c31\u5f97\u505c\u6446\uff1b</li> <li>\u5982\u679c\u4f60\u5728\u4ece\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5907\u4efd\u671f\u95f4\u4ece\u5e93\u4e0d\u80fd\u6267\u884c\u4e3b\u5e93\u540c\u6b65\u8fc7\u6765\u7684 binlog\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</li> </ul> <p>\u770b\u6765\u52a0\u5168\u5c40\u9501\u4e0d\u592a\u597d\u3002\u4f46\u662f\u7ec6\u60f3\u4e00\u4e0b\uff0c\u5907\u4efd\u4e3a\u4ec0\u4e48\u8981\u52a0\u9501\u5462\uff1f\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0d\u52a0\u9501\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p> <p>\u5047\u8bbe\u4f60\u73b0\u5728\u8981\u7ef4\u62a4\u201c\u6781\u5ba2\u65f6\u95f4\u201d\u7684\u8d2d\u4e70\u7cfb\u7edf\uff0c\u5173\u6ce8\u7684\u662f\u7528\u6237\u8d26\u6237\u4f59\u989d\u8868\u548c\u7528\u6237\u8bfe\u7a0b\u8868\u3002</p> <p>\u73b0\u5728\u53d1\u8d77\u4e00\u4e2a\u903b\u8f91\u5907\u4efd\u3002\u5047\u8bbe\u5907\u4efd\u671f\u95f4\uff0c\u6709\u4e00\u4e2a\u7528\u6237\uff0c\u4ed6\u8d2d\u4e70\u4e86\u4e00\u95e8\u8bfe\u7a0b\uff0c\u4e1a\u52a1\u903b\u8f91\u91cc\u5c31\u8981\u6263\u6389\u4ed6\u7684\u4f59\u989d\uff0c\u7136\u540e\u5f80\u5df2\u8d2d\u8bfe\u7a0b\u91cc\u9762\u52a0\u4e0a\u4e00\u95e8\u8bfe\u3002</p> <p>\u5982\u679c\u65f6\u95f4\u987a\u5e8f\u4e0a\u662f\u5148\u5907\u4efd\u8d26\u6237\u4f59\u989d\u8868 (<code>u_account</code>)\uff0c\u7136\u540e\u7528\u6237\u8d2d\u4e70\uff0c\u7136\u540e\u5907\u4efd\u7528\u6237\u8bfe\u7a0b\u8868 (<code>u_course</code>)\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u8fd9\u4e2a\u56fe\uff1a</p> <pre><code>graph TB\nbkaccount([\"\u5907\u4efdu_account\"])\nbkcourse([\"\u5907\u4efdu_course\"])\nuserbuy([\"\u7528\u6237\u8d2d\u4e70\u8bfe\u7a0b\"])\nsubgraph db1[\"database\"]\ndirection TB\nua[\"u_account: A | 200\"]\nuc[\"u_course: A | NULL\"]\nend\n\nsubgraph db2[\"database\"]\ndirection TB\nua2[\"u_account: A | 101\"]\nuc2[\"u_course: A | \u5b9e\u621845\u8bb2\"]\nend\ndb1 --&gt; bkaccount\nbkaccount --&gt; userbuy\nuserbuy --&gt; db2 \ndb2 --&gt; bkcourse\nsubgraph bkstatus[\"\u5907\u4efd\u72b6\u6001\"]\n    direction TB\n  subgraph b1[\"\u7b2c\u4e00\u6b21\u5907\u4efd\"]\n  direction TB\n  u_account[\"u_account: A | 200\"]\n  u_course[\"u_course: \u672a\u5907\u4efd\"]\n  end\n  subgraph b2[\"\u7b2c\u4e8c\u6b21\u5907\u4efd\"]\n  direction TB\n  u_account1[\"u_account: A | 200\"]\n  u_course2[\"u_course: A | \u5b9e\u621845\u8bb2\"]\n  end \nend\n\nbkaccount -.-&gt; b1\nbkcourse -.-&gt; b2</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u5907\u4efd\u7ed3\u679c\u91cc\uff0c\u7528\u6237 A \u7684\u6570\u636e\u72b6\u6001\u662f\u201c\u8d26\u6237\u4f59\u989d\u6ca1\u6263\uff0c\u4f46\u662f\u7528\u6237\u8bfe\u7a0b\u8868\u91cc\u9762\u5df2\u7ecf\u591a\u4e86\u4e00\u95e8\u8bfe\u201d\u3002\u5982\u679c\u540e\u9762\u7528\u8fd9\u4e2a\u5907\u4efd\u6765\u6062\u590d\u6570\u636e\u7684\u8bdd\uff0c\u7528\u6237 A \u5c31\u53d1\u73b0\uff0c\u81ea\u5df1\u8d5a\u4e86\u3002</p> <p>\u4f5c\u4e3a\u7528\u6237\u53ef\u522b\u89c9\u5f97\u8fd9\u6837\u53ef\u771f\u597d\u554a\uff0c\u4f60\u53ef\u4ee5\u8bd5\u60f3\u4e00\u4e0b\uff1a\u5982\u679c\u5907\u4efd\u8868\u7684\u987a\u5e8f\u53cd\u8fc7\u6765\uff0c\u5148\u5907\u4efd\u7528\u6237\u8bfe\u7a0b\u8868\u518d\u5907\u4efd\u8d26\u6237\u4f59\u989d\u8868\uff0c\u53c8\u53ef\u80fd\u4f1a\u51fa\u73b0\u4ec0\u4e48\u7ed3\u679c\uff1f</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e0d\u52a0\u9501\u7684\u8bdd\uff0c\u5907\u4efd\u7cfb\u7edf\u5907\u4efd\u7684\u5f97\u5230\u7684\u5e93\u4e0d\u662f\u4e00\u4e2a\u903b\u8f91\u65f6\u95f4\u70b9\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u903b\u8f91\u4e0d\u4e00\u81f4\u7684\u3002</p> <p>\u8bf4\u5230\u89c6\u56fe\u4f60\u80af\u5b9a\u60f3\u8d77\u6765\u4e86\uff0c\u6211\u4eec\u5728\u524d\u9762\u8bb2\u4e8b\u52a1\u9694\u79bb\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u662f\u6709\u4e00\u4e2a\u65b9\u6cd5\u80fd\u591f\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u7684\uff0c\u5bf9\u5427\uff1f</p> <p>\u662f\u7684\uff0c\u5c31\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u5f00\u542f\u4e00\u4e2a\u4e8b\u52a1\u3002</p> <p>\u5907\u6ce8\uff1a\u5982\u679c\u4f60\u5bf9\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u6982\u5ff5\u4e0d\u662f\u5f88\u6e05\u6670\u7684\u8bdd\uff0c\u53ef\u4ee5\u518d\u56de\u987e\u4e00\u4e0b\u7b2c 3 \u7bc7\u6587\u7ae0[\u300a\u4e8b\u52a1\u9694\u79bb\uff1a\u4e3a\u4ec0\u4e48\u4f60\u6539\u4e86\u6211\u8fd8\u770b\u4e0d\u89c1\uff1f\u300b]\u4e2d\u7684\u76f8\u5173\u5185\u5bb9\u3002</p> <p>\u5b98\u65b9\u81ea\u5e26\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u662f mysqldump\u3002\u5f53 mysqldump \u4f7f\u7528\u53c2\u6570 <code>\u2013-single-transaction</code> \u7684\u65f6\u5019\uff0c\u5bfc\u6570\u636e\u4e4b\u524d\u5c31\u4f1a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6765\u786e\u4fdd\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u800c\u7531\u4e8e MVCC \u7684\u652f\u6301\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u6570\u636e\u662f\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u3002</p> <p>\u4f60\u4e00\u5b9a\u5728\u7591\u60d1\uff0c\u6709\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 FTWRL \u5462\uff1f\u4e00\u81f4\u6027\u8bfb\u662f\u597d\uff0c\u4f46\u524d\u63d0\u662f\u5f15\u64ce\u8981\u652f\u6301\u8fd9\u4e2a\u9694\u79bb\u7ea7\u522b\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e MyISAM \u8fd9\u79cd\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u5982\u679c\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6709\u66f4\u65b0\uff0c\u603b\u662f\u53ea\u80fd\u53d6\u5230\u6700\u65b0\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u7834\u574f\u4e86\u5907\u4efd\u7684\u4e00\u81f4\u6027\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 FTWRL \u547d\u4ee4\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c<code>--single-transaction</code> \u65b9\u6cd5\u53ea\u9002\u7528\u4e8e\u6240\u6709\u7684\u8868\u4f7f\u7528\u4e8b\u52a1\u5f15\u64ce\u7684\u5e93\u3002\u5982\u679c\u6709\u7684\u8868\u4f7f\u7528\u4e86\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u4e48\u5907\u4efd\u5c31\u53ea\u80fd\u901a\u8fc7 FTWRL \u65b9\u6cd5\u3002\u8fd9\u5f80\u5f80\u662f DBA \u8981\u6c42\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u4f7f\u7528 InnoDB \u66ff\u4ee3 MyISAM \u7684\u539f\u56e0\u4e4b\u4e00\u3002</p> <p>\u4f60\u4e5f\u8bb8\u4f1a\u95ee\uff0c\u65e2\u7136\u8981\u5168\u5e93\u53ea\u8bfb\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 set global readonly=true \u7684\u65b9\u5f0f\u5462\uff1f\u786e\u5b9e readonly \u65b9\u5f0f\u4e5f\u53ef\u4ee5\u8ba9\u5168\u5e93\u8fdb\u5165\u53ea\u8bfb\u72b6\u6001\uff0c\u4f46\u6211\u8fd8\u662f\u4f1a\u5efa\u8bae\u4f60\u7528 FTWRL \u65b9\u5f0f\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u539f\u56e0\uff1a</p> <ul> <li>\u4e00\u662f\uff0c\u5728\u6709\u4e9b\u7cfb\u7edf\u4e2d\uff0creadonly \u7684\u503c\u4f1a\u88ab\u7528\u6765\u505a\u5176\u4ed6\u903b\u8f91\uff0c\u6bd4\u5982\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u5e93\u662f\u4e3b\u5e93\u8fd8\u662f\u5907\u5e93\u3002\u56e0\u6b64\uff0c\u4fee\u6539 global \u53d8\u91cf\u7684\u65b9\u5f0f\u5f71\u54cd\u9762\u66f4\u5927\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u4f7f\u7528\u3002</li> <li>\u4e8c\u662f\uff0c\u5728\u5f02\u5e38\u5904\u7406\u673a\u5236\u4e0a\u6709\u5dee\u5f02\u3002\u5982\u679c\u6267\u884c FTWRL \u547d\u4ee4\u4e4b\u540e\u7531\u4e8e\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\u65ad\u5f00\uff0c\u90a3\u4e48 MySQL \u4f1a\u81ea\u52a8\u91ca\u653e\u8fd9\u4e2a\u5168\u5c40\u9501\uff0c\u6574\u4e2a\u5e93\u56de\u5230\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u72b6\u6001\u3002\u800c\u5c06\u6574\u4e2a\u5e93\u8bbe\u7f6e\u4e3a readonly \u4e4b\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u6570\u636e\u5e93\u5c31\u4f1a\u4e00\u76f4\u4fdd\u6301 readonly \u72b6\u6001\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5e93\u957f\u65f6\u95f4\u5904\u4e8e\u4e0d\u53ef\u5199\u72b6\u6001\uff0c\u98ce\u9669\u8f83\u9ad8\u3002</li> </ul> <p>\u4e1a\u52a1\u7684\u66f4\u65b0\u4e0d\u53ea\u662f\u589e\u5220\u6539\u6570\u636e\uff08DML)\uff0c\u8fd8\u6709\u53ef\u80fd\u662f\u52a0\u5b57\u6bb5\u7b49\u4fee\u6539\u8868\u7ed3\u6784\u7684\u64cd\u4f5c\uff08DDL\uff09\u3002\u4e0d\u8bba\u662f\u54ea\u79cd\u65b9\u6cd5\uff0c\u4e00\u4e2a\u5e93\u88ab\u5168\u5c40\u9501\u4e0a\u4ee5\u540e\uff0c\u4f60\u8981\u5bf9\u91cc\u9762\u4efb\u4f55\u4e00\u4e2a\u8868\u505a\u52a0\u5b57\u6bb5\u64cd\u4f5c\uff0c\u90fd\u662f\u4f1a\u88ab\u9501\u4f4f\u7684\u3002</p> <p>\u4f46\u662f\uff0c\u5373\u4f7f\u6ca1\u6709\u88ab\u5168\u5c40\u9501\u4f4f\uff0c\u52a0\u5b57\u6bb5\u4e5f\u4e0d\u662f\u5c31\u80fd\u4e00\u5e06\u98ce\u987a\u7684\uff0c\u56e0\u4e3a\u4f60\u8fd8\u4f1a\u78b0\u5230\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u4ecb\u7ecd\u7684\u8868\u7ea7\u9501\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_19","title":"\u8868\u7ea7\u9501","text":"<p>MySQL \u91cc\u9762\u8868\u7ea7\u522b\u7684\u9501\u6709\u4e24\u79cd\uff1a\u4e00\u79cd\u662f\u8868\u9501\uff0c\u4e00\u79cd\u662f\u5143\u6570\u636e\u9501\uff08meta data lock\uff0cMDL)\u3002</p> <p>\u8868\u9501\u7684\u8bed\u6cd5\u662f <code>lock tables \u2026 read/write</code>\u3002\u4e0e FTWRL \u7c7b\u4f3c\uff0c\u53ef\u4ee5\u7528 <code>unlock tables</code> \u4e3b\u52a8\u91ca\u653e\u9501\uff0c\u4e5f\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u65ad\u5f00\u7684\u65f6\u5019\u81ea\u52a8\u91ca\u653e\u3002\u9700\u8981\u6ce8\u610f\uff0c<code>lock tables</code> \u8bed\u6cd5\u9664\u4e86\u4f1a\u9650\u5236\u522b\u7684\u7ebf\u7a0b\u7684\u8bfb\u5199\u5916\uff0c\u4e5f\u9650\u5b9a\u4e86\u672c\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u5bf9\u8c61\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50, \u5982\u679c\u5728\u67d0\u4e2a\u7ebf\u7a0b A \u4e2d\u6267\u884c <code>lock tables t1 read, t2 write;</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u5219\u5176\u4ed6\u7ebf\u7a0b\u5199 t1\u3001\u8bfb\u5199 t2 \u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u963b\u585e\u3002\u540c\u65f6\uff0c\u7ebf\u7a0b A \u5728\u6267\u884c <code>unlock tables</code> \u4e4b\u524d\uff0c\u4e5f\u53ea\u80fd\u6267\u884c\u8bfb t1\u3001\u8bfb\u5199 t2 \u7684\u64cd\u4f5c\u3002\u8fde\u5199 t1 \u90fd\u4e0d\u5141\u8bb8\uff0c\u81ea\u7136\u4e5f\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8868\u3002</p> <p>\u5728\u8fd8\u6ca1\u6709\u51fa\u73b0\u66f4\u7ec6\u7c92\u5ea6\u7684\u9501\u7684\u65f6\u5019\uff0c\u8868\u9501\u662f\u6700\u5e38\u7528\u7684\u5904\u7406\u5e76\u53d1\u7684\u65b9\u5f0f\u3002\u800c\u5bf9\u4e8e InnoDB \u8fd9\u79cd\u652f\u6301\u884c\u9501\u7684\u5f15\u64ce\uff0c\u4e00\u822c\u4e0d\u4f7f\u7528 lock tables \u547d\u4ee4\u6765\u63a7\u5236\u5e76\u53d1\uff0c\u6bd5\u7adf\u9501\u4f4f\u6574\u4e2a\u8868\u7684\u5f71\u54cd\u9762\u8fd8\u662f\u592a\u5927\u3002</p> <p>\u53e6\u4e00\u7c7b\u8868\u7ea7\u7684\u9501\u662f MDL\uff08metadata lock)\u3002MDL \u4e0d\u9700\u8981\u663e\u5f0f\u4f7f\u7528\uff0c\u5728\u8bbf\u95ee\u4e00\u4e2a\u8868\u7684\u65f6\u5019\u4f1a\u88ab\u81ea\u52a8\u52a0\u4e0a\u3002MDL \u7684\u4f5c\u7528\u662f\uff0c\u4fdd\u8bc1\u8bfb\u5199\u7684\u6b63\u786e\u6027\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u6b63\u5728\u904d\u5386\u4e00\u4e2a\u8868\u4e2d\u7684\u6570\u636e\uff0c\u800c\u6267\u884c\u671f\u95f4\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u7ed3\u6784\u505a\u53d8\u66f4\uff0c\u5220\u4e86\u4e00\u5217\uff0c\u90a3\u4e48\u67e5\u8be2\u7ebf\u7a0b\u62ff\u5230\u7684\u7ed3\u679c\u8ddf\u8868\u7ed3\u6784\u5bf9\u4e0d\u4e0a\uff0c\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u56e0\u6b64\uff0c\u5728 MySQL 5.5 \u7248\u672c\u4e2d\u5f15\u5165\u4e86 MDL\uff0c\u5f53\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u8bfb\u9501\uff1b\u5f53\u8981\u5bf9\u8868\u505a\u7ed3\u6784\u53d8\u66f4\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u5199\u9501\u3002</p> <ul> <li>\u8bfb\u9501\u4e4b\u95f4\u4e0d\u4e92\u65a5\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5bf9\u4e00\u5f20\u8868\u589e\u5220\u6539\u67e5\u3002</li> <li>\u8bfb\u5199\u9501\u4e4b\u95f4\u3001\u5199\u9501\u4e4b\u95f4\u662f\u4e92\u65a5\u7684\uff0c\u7528\u6765\u4fdd\u8bc1\u53d8\u66f4\u8868\u7ed3\u6784\u64cd\u4f5c\u7684\u5b89\u5168\u6027\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6709\u4e24\u4e2a\u7ebf\u7a0b\u8981\u540c\u65f6\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u5176\u4e2d\u4e00\u4e2a\u8981\u7b49\u53e6\u4e00\u4e2a\u6267\u884c\u5b8c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002</li> </ul> <p>\u867d\u7136 MDL \u9501\u662f\u7cfb\u7edf\u9ed8\u8ba4\u4f1a\u52a0\u7684\uff0c\u4f46\u5374\u662f\u4f60\u4e0d\u80fd\u5ffd\u7565\u7684\u4e00\u4e2a\u673a\u5236\uff0c\u4e8b\u52a1\u4e2d\u7684 MDL \u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5f00\u59cb\u65f6\u7533\u8bf7\uff0c\u4f46\u662f\u8bed\u53e5\u7ed3\u675f\u540e\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u91ca\u653e\uff0c\u800c\u4f1a\u7b49\u5230\u6574\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\u518d\u91ca\u653e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_20","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\u3002</p> <p>\u5168\u5c40\u9501\u4e3b\u8981\u7528\u5728\u903b\u8f91\u5907\u4efd\u8fc7\u7a0b\u4e2d\u3002\u5bf9\u4e8e\u5168\u90e8\u662f InnoDB \u5f15\u64ce\u7684\u5e93\uff0c\u6211\u5efa\u8bae\u4f60\u9009\u62e9\u4f7f\u7528<code>-\u2013single-transaction</code> \u53c2\u6570\uff0c\u5bf9\u5e94\u7528\u4f1a\u66f4\u53cb\u597d\u3002</p> <p>\u8868\u9501\u4e00\u822c\u662f\u5728\u6570\u636e\u5e93\u5f15\u64ce\u4e0d\u652f\u6301\u884c\u9501\u7684\u65f6\u5019\u624d\u4f1a\u88ab\u7528\u5230\u7684\u3002\u5982\u679c\u4f60\u53d1\u73b0\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u91cc\u6709 lock tables \u8fd9\u6837\u7684\u8bed\u53e5\uff0c\u4f60\u9700\u8981\u8ffd\u67e5\u4e00\u4e0b\uff0c\u6bd4\u8f83\u53ef\u80fd\u7684\u60c5\u51b5\u662f\uff1a</p> <ul> <li>\u8981\u4e48\u662f\u4f60\u7684\u7cfb\u7edf\u73b0\u5728\u8fd8\u5728\u7528 MyISAM \u8fd9\u7c7b\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u8981\u5b89\u6392\u5347\u7ea7\u6362\u5f15\u64ce\uff1b</li> <li>\u8981\u4e48\u662f\u4f60\u7684\u5f15\u64ce\u5347\u7ea7\u4e86\uff0c\u4f46\u662f\u4ee3\u7801\u8fd8\u6ca1\u5347\u7ea7\u3002\u6211\u89c1\u8fc7\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u6700\u540e\u4e1a\u52a1\u5f00\u53d1\u5c31\u662f\u628a lock tables \u548c unlock tables \u6539\u6210 begin \u548c commit\uff0c\u95ee\u9898\u5c31\u89e3\u51b3\u4e86\u3002</li> </ul> <p>MDL \u4f1a\u76f4\u5230\u4e8b\u52a1\u63d0\u4ea4\u624d\u91ca\u653e\uff0c\u5728\u505a\u8868\u7ed3\u6784\u53d8\u66f4\u7684\u65f6\u5019\uff0c\u4f60\u4e00\u5b9a\u8981\u5c0f\u5fc3\u4e0d\u8981\u5bfc\u81f4\u9501\u4f4f\u7ebf\u4e0a\u67e5\u8be2\u548c\u66f4\u65b0\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#07","title":"07 \u884c\u9501\u529f\u8fc7\uff1a\u600e\u4e48\u51cf\u5c11\u884c\u9501\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5168\u5c40\u9501\u548c\u8868\u7ea7\u9501\uff0c\u4eca\u5929\u6211\u4eec\u5c31\u6765\u8bb2\u8bb2 MySQL \u7684\u884c\u9501\u3002</p> <p>MySQL \u7684\u884c\u9501\u662f\u5728\u5f15\u64ce\u5c42\u7531\u5404\u4e2a\u5f15\u64ce\u81ea\u5df1\u5b9e\u73b0\u7684\u3002\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u884c\u9501\uff0c\u6bd4\u5982 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u884c\u9501\u3002\u4e0d\u652f\u6301\u884c\u9501\u610f\u5473\u7740\u5e76\u53d1\u63a7\u5236\u53ea\u80fd\u4f7f\u7528\u8868\u9501\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u5f15\u64ce\u7684\u8868\uff0c\u540c\u4e00\u5f20\u8868\u4e0a\u4efb\u4f55\u65f6\u523b\u53ea\u80fd\u6709\u4e00\u4e2a\u66f4\u65b0\u5728\u6267\u884c\uff0c\u8fd9\u5c31\u4f1a\u5f71\u54cd\u5230\u4e1a\u52a1\u5e76\u53d1\u5ea6\u3002InnoDB \u662f\u652f\u6301\u884c\u9501\u7684\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u66ff\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p> <p>\u6211\u4eec\u4eca\u5929\u5c31\u4e3b\u8981\u6765\u804a\u804a InnoDB \u7684\u884c\u9501\uff0c\u4ee5\u53ca\u5982\u4f55\u901a\u8fc7\u51cf\u5c11\u9501\u51b2\u7a81\u6765\u63d0\u5347\u4e1a\u52a1\u5e76\u53d1\u5ea6\u3002</p> <p>\u987e\u540d\u601d\u4e49\uff0c\u884c\u9501\u5c31\u662f\u9488\u5bf9\u6570\u636e\u8868\u4e2d\u884c\u8bb0\u5f55\u7684\u9501\u3002\u8fd9\u5f88\u597d\u7406\u89e3\uff0c\u6bd4\u5982\u4e8b\u52a1 A \u66f4\u65b0\u4e86\u4e00\u884c\uff0c\u800c\u8fd9\u65f6\u5019\u4e8b\u52a1 B \u4e5f\u8981\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u5219\u5fc5\u987b\u7b49\u4e8b\u52a1 A \u7684\u64cd\u4f5c\u5b8c\u6210\u540e\u624d\u80fd\u8fdb\u884c\u66f4\u65b0\u3002</p> <p>\u5f53\u7136\uff0c\u6570\u636e\u5e93\u4e2d\u8fd8\u6709\u4e00\u4e9b\u6ca1\u90a3\u4e48\u4e00\u76ee\u4e86\u7136\u7684\u6982\u5ff5\u548c\u8bbe\u8ba1\uff0c\u8fd9\u4e9b\u6982\u5ff5\u5982\u679c\u7406\u89e3\u548c\u4f7f\u7528\u4e0d\u5f53\uff0c\u5bb9\u6613\u5bfc\u81f4\u7a0b\u5e8f\u51fa\u73b0\u975e\u9884\u671f\u884c\u4e3a\uff0c\u6bd4\u5982\u4e24\u9636\u6bb5\u9501\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_21","title":"\u4ece\u4e24\u9636\u6bb5\u9501\u8bf4\u8d77","text":"<p>\u6211\u5148\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\u3002\u5728\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\u4e2d\uff0c\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u6267\u884c\u65f6\u4f1a\u662f\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f\u5047\u8bbe\u5b57\u6bb5 id \u662f\u8868 t \u7684\u4e3b\u952e\u3002</p> <pre><code>sequenceDiagram\n    participant T1\n    participant A\n    participant T2\n\n    T1-&gt;&gt;A: begin\n    T1-&gt;&gt;A: update t set k=k+1 where id=1\n    T2-&gt;&gt;A: update t set k=k+1 where id=2\n    T2-&gt;&gt;A: begin\n    T2-&gt;&gt;A: update t set k=k+2 where id=1\n    T2--&gt;&gt;A: waiting lock\n    T1-&gt;&gt;A: commit\n    T2-&gt;&gt;A: execute\n</code></pre> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7ed3\u8bba\u53d6\u51b3\u4e8e\u4e8b\u52a1 A \u5728\u6267\u884c\u5b8c\u4e24\u6761 update \u8bed\u53e5\u540e\uff0c\u6301\u6709\u54ea\u4e9b\u9501\uff0c\u4ee5\u53ca\u5728\u4ec0\u4e48\u65f6\u5019\u91ca\u653e\u3002\u4f60\u53ef\u4ee5\u9a8c\u8bc1\u4e00\u4e0b\uff1a\u5b9e\u9645\u4e0a\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u4e8b\u52a1 A \u6267\u884c commit \u4e4b\u540e\uff0c\u4e8b\u52a1 B \u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</p> <p>\u77e5\u9053\u4e86\u8fd9\u4e2a\u7b54\u6848\uff0c\u4f60\u4e00\u5b9a\u77e5\u9053\u4e86\u4e8b\u52a1 A \u6301\u6709\u7684\u4e24\u4e2a\u8bb0\u5f55\u7684\u884c\u9501\uff0c\u90fd\u662f\u5728 commit \u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728 InnoDB \u4e8b\u52a1\u4e2d\uff0c\u884c\u9501\u662f\u5728\u9700\u8981\u7684\u65f6\u5019\u624d\u52a0\u4e0a\u7684\uff0c\u4f46\u5e76\u4e0d\u662f\u4e0d\u9700\u8981\u4e86\u5c31\u7acb\u523b\u91ca\u653e\uff0c\u800c\u662f\u8981\u7b49\u5230\u4e8b\u52a1\u7ed3\u675f\u65f6\u624d\u91ca\u653e\u3002\u8fd9\u4e2a\u5c31\u662f\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u3002</p> <p>\u77e5\u9053\u4e86\u8fd9\u4e2a\u8bbe\u5b9a\uff0c\u5bf9\u6211\u4eec\u4f7f\u7528\u4e8b\u52a1\u6709\u4ec0\u4e48\u5e2e\u52a9\u5462\uff1f\u90a3\u5c31\u662f\uff0c\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u5c3d\u91cf\u5f80\u540e\u653e\u3002\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\u3002</p> <p>\u5047\u8bbe\u4f60\u8d1f\u8d23\u5b9e\u73b0\u4e00\u4e2a\u7535\u5f71\u7968\u5728\u7ebf\u4ea4\u6613\u4e1a\u52a1\uff0c\u987e\u5ba2 A \u8981\u5728\u5f71\u9662 B \u8d2d\u4e70\u7535\u5f71\u7968\u3002\u6211\u4eec\u7b80\u5316\u4e00\u70b9\uff0c\u8fd9\u4e2a\u4e1a\u52a1\u9700\u8981\u6d89\u53ca\u5230\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u4ece\u987e\u5ba2 A \u8d26\u6237\u4f59\u989d\u4e2d\u6263\u9664\u7535\u5f71\u7968\u4ef7\uff1b</li> <li>\u7ed9\u5f71\u9662 B \u7684\u8d26\u6237\u4f59\u989d\u589e\u52a0\u8fd9\u5f20\u7535\u5f71\u7968\u4ef7\uff1b</li> <li>\u8bb0\u5f55\u4e00\u6761\u4ea4\u6613\u65e5\u5fd7\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u5b8c\u6210\u8fd9\u4e2a\u4ea4\u6613\uff0c\u6211\u4eec\u9700\u8981 update \u4e24\u6761\u8bb0\u5f55\uff0c\u5e76 insert \u4e00\u6761\u8bb0\u5f55\u3002\u5f53\u7136\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u4ea4\u6613\u7684\u539f\u5b50\u6027\uff0c\u6211\u4eec\u8981\u628a\u8fd9\u4e09\u4e2a\u64cd\u4f5c\u653e\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u3002\u90a3\u4e48\uff0c\u4f60\u4f1a\u600e\u6837\u5b89\u6392\u8fd9\u4e09\u4e2a\u8bed\u53e5\u5728\u4e8b\u52a1\u4e2d\u7684\u987a\u5e8f\u5462\uff1f</p> <p>\u8bd5\u60f3\u5982\u679c\u540c\u65f6\u6709\u53e6\u5916\u4e00\u4e2a\u987e\u5ba2 C \u8981\u5728\u5f71\u9662 B \u4e70\u7968\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u51b2\u7a81\u7684\u90e8\u5206\u5c31\u662f\u8bed\u53e5 2 \u4e86\u3002\u56e0\u4e3a\u5b83\u4eec\u8981\u66f4\u65b0\u540c\u4e00\u4e2a\u5f71\u9662\u8d26\u6237\u7684\u4f59\u989d\uff0c\u9700\u8981\u4fee\u6539\u540c\u4e00\u884c\u6570\u636e\u3002</p> <p>\u6839\u636e\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u4e0d\u8bba\u4f60\u600e\u6837\u5b89\u6392\u8bed\u53e5\u987a\u5e8f\uff0c\u6240\u6709\u7684\u64cd\u4f5c\u9700\u8981\u7684\u884c\u9501\u90fd\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u628a\u8bed\u53e5 2 \u5b89\u6392\u5728\u6700\u540e\uff0c\u6bd4\u5982\u6309\u7167 3\u30011\u30012 \u8fd9\u6837\u7684\u987a\u5e8f\uff0c\u90a3\u4e48\u5f71\u9662\u8d26\u6237\u4f59\u989d\u8fd9\u4e00\u884c\u7684\u9501\u65f6\u95f4\u5c31\u6700\u5c11\u3002\u8fd9\u5c31\u6700\u5927\u7a0b\u5ea6\u5730\u51cf\u5c11\u4e86\u4e8b\u52a1\u4e4b\u95f4\u7684\u9501\u7b49\u5f85\uff0c\u63d0\u5347\u4e86\u5e76\u53d1\u5ea6\u3002</p> <p>\u597d\u4e86\uff0c\u73b0\u5728\u7531\u4e8e\u4f60\u7684\u6b63\u786e\u8bbe\u8ba1\uff0c\u5f71\u9662\u4f59\u989d\u8fd9\u4e00\u884c\u7684\u884c\u9501\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u4e0d\u4f1a\u505c\u7559\u5f88\u957f\u65f6\u95f4\u3002\u4f46\u662f\uff0c\u8fd9\u5e76\u6ca1\u6709\u5b8c\u5168\u89e3\u51b3\u4f60\u7684\u56f0\u6270\u3002</p> <p>\u5982\u679c\u8fd9\u4e2a\u5f71\u9662\u505a\u6d3b\u52a8\uff0c\u53ef\u4ee5\u4f4e\u4ef7\u9884\u552e\u4e00\u5e74\u5185\u6240\u6709\u7684\u7535\u5f71\u7968\uff0c\u800c\u4e14\u8fd9\u4e2a\u6d3b\u52a8\u53ea\u505a\u4e00\u5929\u3002\u4e8e\u662f\u5728\u6d3b\u52a8\u65f6\u95f4\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u4f60\u7684 MySQL \u5c31\u6302\u4e86\u3002\u4f60\u767b\u4e0a\u670d\u52a1\u5668\u4e00\u770b\uff0cCPU \u6d88\u8017\u63a5\u8fd1 100%\uff0c\u4f46\u6574\u4e2a\u6570\u636e\u5e93\u6bcf\u79d2\u5c31\u6267\u884c\u4e0d\u5230 100 \u4e2a\u4e8b\u52a1\u3002\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f</p> <p>\u8fd9\u91cc\uff0c\u6211\u5c31\u8981\u8bf4\u5230\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_22","title":"\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b","text":"<p>\u5f53\u5e76\u53d1\u7cfb\u7edf\u4e2d\u4e0d\u540c\u7ebf\u7a0b\u51fa\u73b0\u5faa\u73af\u8d44\u6e90\u4f9d\u8d56\uff0c\u6d89\u53ca\u7684\u7ebf\u7a0b\u90fd\u5728\u7b49\u5f85\u522b\u7684\u7ebf\u7a0b\u91ca\u653e\u8d44\u6e90\u65f6\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8fd9\u51e0\u4e2a\u7ebf\u7a0b\u90fd\u8fdb\u5165\u65e0\u9650\u7b49\u5f85\u7684\u72b6\u6001\uff0c\u79f0\u4e3a\u6b7b\u9501\u3002\u8fd9\u91cc\u6211\u7528\u6570\u636e\u5e93\u4e2d\u7684\u884c\u9501\u4e3e\u4e2a\u4f8b\u5b50\u3002</p> <pre><code>sequenceDiagram\n    participant T1\n    participant A\n    participant T2\n\n    T1-&gt;&gt;A: begin\n    T2-&gt;&gt;A: begin\n    T1-&gt;&gt;A: update t set k=k+1 where id=1\n    T2-&gt;&gt;A: update t set k=k+1 where id=2\n    T1-&gt;&gt;A: update t set k=k+1 where id=2\n    Note over T1,T2: Deadlock!</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u4e8b\u52a1 T1 \u5728\u7b49\u5f85\u4e8b\u52a1 T2 \u91ca\u653e id=2 \u7684\u884c\u9501\uff0c\u800c\u4e8b\u52a1 T2 \u5728\u7b49\u5f85\u4e8b\u52a1 T1 \u91ca\u653e id=1 \u7684\u884c\u9501\u3002 \u4e8b\u52a1 T1 \u548c\u4e8b\u52a1 T2 \u5728\u4e92\u76f8\u7b49\u5f85\u5bf9\u65b9\u7684\u8d44\u6e90\u91ca\u653e\uff0c\u5c31\u662f\u8fdb\u5165\u4e86\u6b7b\u9501\u72b6\u6001\u3002\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u6709\u4e24\u79cd\u7b56\u7565\uff1a</p> <ul> <li>\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u76f4\u63a5\u8fdb\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u8d85\u65f6\u3002\u8fd9\u4e2a\u8d85\u65f6\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570 <code>innodb_lock_wait_timeout</code>\u6765\u8bbe\u7f6e\u3002</li> <li>\u53e6\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u53d1\u8d77\u6b7b\u9501\u68c0\u6d4b\uff0c\u53d1\u73b0\u6b7b\u9501\u540e\uff0c\u4e3b\u52a8\u56de\u6eda\u6b7b\u9501\u94fe\u6761\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8ba9\u5176\u4ed6\u4e8b\u52a1\u5f97\u4ee5\u7ee7\u7eed\u6267\u884c\u3002\u5c06\u53c2\u6570 <code>innodb_deadlock_detect</code> \u8bbe\u7f6e\u4e3a on\uff0c\u8868\u793a\u5f00\u542f\u8fd9\u4e2a\u903b\u8f91\u3002</li> </ul> <p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_lock_wait_timeout</code> \u7684\u9ed8\u8ba4\u503c\u662f 50s\uff0c\u610f\u5473\u7740\u5982\u679c\u91c7\u7528\u7b2c\u4e00\u4e2a\u7b56\u7565\uff0c\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u7b2c\u4e00\u4e2a\u88ab\u9501\u4f4f\u7684\u7ebf\u7a0b\u8981\u8fc7 50s \u624d\u4f1a\u8d85\u65f6\u9000\u51fa\uff0c\u7136\u540e\u5176\u4ed6\u7ebf\u7a0b\u624d\u6709\u53ef\u80fd\u7ee7\u7eed\u6267\u884c\u3002\u5bf9\u4e8e\u5728\u7ebf\u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a\u7b49\u5f85\u65f6\u95f4\u5f80\u5f80\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u53c8\u4e0d\u53ef\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u65f6\u95f4\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5f88\u5c0f\u7684\u503c\uff0c\u6bd4\u5982 1s\u3002\u8fd9\u6837\u5f53\u51fa\u73b0\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u786e\u5b9e\u5f88\u5feb\u5c31\u53ef\u4ee5\u89e3\u5f00\uff0c\u4f46\u5982\u679c\u4e0d\u662f\u6b7b\u9501\uff0c\u800c\u662f\u7b80\u5355\u7684\u9501\u7b49\u5f85\u5462\uff1f\u6240\u4ee5\uff0c\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u592a\u77ed\u7684\u8bdd\uff0c\u4f1a\u51fa\u73b0\u5f88\u591a\u8bef\u4f24\u3002</p> <p>\u6240\u4ee5\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u8fd8\u662f\u8981\u91c7\u7528\u7b2c\u4e8c\u79cd\u7b56\u7565\uff0c\u5373\uff1a\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\uff0c\u800c\u4e14 <code>innodb_deadlock_detect</code> \u7684\u9ed8\u8ba4\u503c\u672c\u8eab\u5c31\u662f on\u3002\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u662f\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u5e76\u8fdb\u884c\u5904\u7406\u7684\uff0c\u4f46\u662f\u5b83\u4e5f\u662f\u6709\u989d\u5916\u8d1f\u62c5\u7684\u3002</p> <p>\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\uff1a\u6bcf\u5f53\u4e00\u4e2a\u4e8b\u52a1\u88ab\u9501\u7684\u65f6\u5019\uff0c\u5c31\u8981\u770b\u770b\u5b83\u6240\u4f9d\u8d56\u7684\u7ebf\u7a0b\u6709\u6ca1\u6709\u88ab\u522b\u4eba\u9501\u4f4f\uff0c\u5982\u6b64\u5faa\u73af\uff0c\u6700\u540e\u5224\u65ad\u662f\u5426\u51fa\u73b0\u4e86\u5faa\u73af\u7b49\u5f85\uff0c\u4e5f\u5c31\u662f\u6b7b\u9501\u3002</p> <p>\u90a3\u5982\u679c\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u6240\u6709\u4e8b\u52a1\u90fd\u8981\u66f4\u65b0\u540c\u4e00\u884c\u7684\u573a\u666f\u5462\uff1f</p> <p>\u6bcf\u4e2a\u65b0\u6765\u7684\u88ab\u5835\u4f4f\u7684\u7ebf\u7a0b\uff0c\u90fd\u8981\u5224\u65ad\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u81ea\u5df1\u7684\u52a0\u5165\u5bfc\u81f4\u4e86\u6b7b\u9501\uff0c\u8fd9\u662f\u4e00\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662f \\(O(n^2)\\) \u7684\u64cd\u4f5c\u3002\u5047\u8bbe\u6709 1000 \u4e2a\u5e76\u53d1\u7ebf\u7a0b\u8981\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u64cd\u4f5c\u5c31\u662f 100 \u4e07\u8fd9\u4e2a\u91cf\u7ea7\u7684\u3002\u867d\u7136\u6700\u7ec8\u68c0\u6d4b\u7684\u7ed3\u679c\u662f\u6ca1\u6709\u6b7b\u9501\uff0c\u4f46\u662f\u8fd9\u671f\u95f4\u8981\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002\u56e0\u6b64\uff0c\u4f60\u5c31\u4f1a\u770b\u5230 CPU \u5229\u7528\u7387\u5f88\u9ad8\uff0c\u4f46\u662f\u6bcf\u79d2\u5374\u6267\u884c\u4e0d\u4e86\u51e0\u4e2a\u4e8b\u52a1\u3002</p> <p>\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e0b\uff0c\u600e\u4e48\u89e3\u51b3\u7531\u8fd9\u79cd\u70ed\u70b9\u884c\u66f4\u65b0\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u5462\uff1f\u95ee\u9898\u7684\u75c7\u7ed3\u5728\u4e8e\uff0c\u6b7b\u9501\u68c0\u6d4b\u8981\u8017\u8d39\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002</p> <p>\u4e00\u79cd\u5934\u75db\u533b\u5934\u7684\u65b9\u6cd5\uff0c\u5c31\u662f\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u8fd9\u4e2a\u4e1a\u52a1\u4e00\u5b9a\u4e0d\u4f1a\u51fa\u73b0\u6b7b\u9501\uff0c\u53ef\u4ee5\u4e34\u65f6\u628a\u6b7b\u9501\u68c0\u6d4b\u5173\u6389\u3002\u4f46\u662f\u8fd9\u79cd\u64cd\u4f5c\u672c\u8eab\u5e26\u6709\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u4e1a\u52a1\u8bbe\u8ba1\u7684\u65f6\u5019\u4e00\u822c\u4e0d\u4f1a\u628a\u6b7b\u9501\u5f53\u505a\u4e00\u4e2a\u4e25\u91cd\u9519\u8bef\uff0c\u6bd5\u7adf\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u56de\u6eda\uff0c\u7136\u540e\u901a\u8fc7\u4e1a\u52a1\u91cd\u8bd5\u4e00\u822c\u5c31\u6ca1\u95ee\u9898\u4e86\uff0c\u8fd9\u662f\u4e1a\u52a1\u65e0\u635f\u7684\u3002\u800c\u5173\u6389\u6b7b\u9501\u68c0\u6d4b\u610f\u5473\u7740\u53ef\u80fd\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u8d85\u65f6\uff0c\u8fd9\u662f\u4e1a\u52a1\u6709\u635f\u7684\u3002</p> <p>\u53e6\u4e00\u4e2a\u601d\u8def\u662f\u63a7\u5236\u5e76\u53d1\u5ea6\u3002\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u4f1a\u53d1\u73b0\u5982\u679c\u5e76\u53d1\u80fd\u591f\u63a7\u5236\u4f4f\uff0c\u6bd4\u5982\u540c\u4e00\u884c\u540c\u65f6\u6700\u591a\u53ea\u6709 10 \u4e2a\u7ebf\u7a0b\u5728\u66f4\u65b0\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u3002\u4e00\u4e2a\u76f4\u63a5\u7684\u60f3\u6cd5\u5c31\u662f\uff0c\u5728\u5ba2\u6237\u7aef\u505a\u5e76\u53d1\u63a7\u5236\u3002\u4f46\u662f\uff0c\u4f60\u4f1a\u5f88\u5feb\u53d1\u73b0\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u592a\u53ef\u884c\uff0c\u56e0\u4e3a\u5ba2\u6237\u7aef\u5f88\u591a\u3002\u6211\u89c1\u8fc7\u4e00\u4e2a\u5e94\u7528\uff0c\u6709 600 \u4e2a\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u5373\u4f7f\u6bcf\u4e2a\u5ba2\u6237\u7aef\u63a7\u5236\u5230\u53ea\u6709 5 \u4e2a\u5e76\u53d1\u7ebf\u7a0b\uff0c\u6c47\u603b\u5230\u6570\u636e\u5e93\u670d\u52a1\u7aef\u4ee5\u540e\uff0c\u5cf0\u503c\u5e76\u53d1\u6570\u4e5f\u53ef\u80fd\u8981\u8fbe\u5230 3000\u3002</p> <p>\u56e0\u6b64\uff0c\u8fd9\u4e2a\u5e76\u53d1\u63a7\u5236\u8981\u505a\u5728\u6570\u636e\u5e93\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6709\u4e2d\u95f4\u4ef6\uff0c\u53ef\u4ee5\u8003\u8651\u5728\u4e2d\u95f4\u4ef6\u5b9e\u73b0\uff1b\u5982\u679c\u4f60\u7684\u56e2\u961f\u6709\u80fd\u4fee\u6539 MySQL \u6e90\u7801\u7684\u4eba\uff0c\u4e5f\u53ef\u4ee5\u505a\u5728 MySQL \u91cc\u9762\u3002\u57fa\u672c\u601d\u8def\u5c31\u662f\uff0c\u5bf9\u4e8e\u76f8\u540c\u884c\u7684\u66f4\u65b0\uff0c\u5728\u8fdb\u5165\u5f15\u64ce\u4e4b\u524d\u6392\u961f\u3002\u8fd9\u6837\u5728 InnoDB \u5185\u90e8\u5c31\u4e0d\u4f1a\u6709\u5927\u91cf\u7684\u6b7b\u9501\u68c0\u6d4b\u5de5\u4f5c\u4e86\u3002</p> <p>\u53ef\u80fd\u4f60\u4f1a\u95ee\uff0c\u5982\u679c\u56e2\u961f\u91cc\u6682\u65f6\u6ca1\u6709\u6570\u636e\u5e93\u65b9\u9762\u7684\u4e13\u5bb6\uff0c\u4e0d\u80fd\u5b9e\u73b0\u8fd9\u6837\u7684\u65b9\u6848\uff0c\u80fd\u4e0d\u80fd\u4ece\u8bbe\u8ba1\u4e0a\u4f18\u5316\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u8003\u8651\u901a\u8fc7\u5c06\u4e00\u884c\u6539\u6210\u903b\u8f91\u4e0a\u7684\u591a\u884c\u6765\u51cf\u5c11\u9501\u51b2\u7a81\u3002\u8fd8\u662f\u4ee5\u5f71\u9662\u8d26\u6237\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u8003\u8651\u653e\u5728\u591a\u6761\u8bb0\u5f55\u4e0a\uff0c\u6bd4\u5982 10 \u4e2a\u8bb0\u5f55\uff0c\u5f71\u9662\u7684\u8d26\u6237\u603b\u989d\u7b49\u4e8e\u8fd9 10 \u4e2a\u8bb0\u5f55\u7684\u503c\u7684\u603b\u548c\u3002\u8fd9\u6837\u6bcf\u6b21\u8981\u7ed9\u5f71\u9662\u8d26\u6237\u52a0\u91d1\u989d\u7684\u65f6\u5019\uff0c\u968f\u673a\u9009\u5176\u4e2d\u4e00\u6761\u8bb0\u5f55\u6765\u52a0\u3002\u8fd9\u6837\u6bcf\u6b21\u51b2\u7a81\u6982\u7387\u53d8\u6210\u539f\u6765\u7684 1/10\uff0c\u53ef\u4ee5\u51cf\u5c11\u9501\u7b49\u5f85\u4e2a\u6570\uff0c\u4e5f\u5c31\u51cf\u5c11\u4e86\u6b7b\u9501\u68c0\u6d4b\u7684 CPU \u6d88\u8017\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6848\u770b\u4e0a\u53bb\u662f\u65e0\u635f\u7684\uff0c\u4f46\u5176\u5b9e\u8fd9\u7c7b\u65b9\u6848\u9700\u8981\u6839\u636e\u4e1a\u52a1\u903b\u8f91\u505a\u8be6\u7ec6\u8bbe\u8ba1\u3002\u5982\u679c\u8d26\u6237\u4f59\u989d\u53ef\u80fd\u4f1a\u51cf\u5c11\uff0c\u6bd4\u5982\u9000\u7968\u903b\u8f91\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u8003\u8651\u5f53\u4e00\u90e8\u5206\u884c\u8bb0\u5f55\u53d8\u6210 0 \u7684\u65f6\u5019\uff0c\u4ee3\u7801\u8981\u6709\u7279\u6b8a\u5904\u7406\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_23","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u884c\u9501\uff0c\u6d89\u53ca\u4e86\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u3001\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u8fd9\u4e24\u5927\u90e8\u5206\u5185\u5bb9\u3002</p> <p>\u5176\u4e2d\uff0c\u6211\u4ee5\u4e24\u9636\u6bb5\u534f\u8bae\u4e3a\u8d77\u70b9\uff0c\u548c\u4f60\u4e00\u8d77\u8ba8\u8bba\u4e86\u5728\u5f00\u53d1\u7684\u65f6\u5019\u5982\u4f55\u5b89\u6392\u6b63\u786e\u7684\u4e8b\u52a1\u8bed\u53e5\u3002\u8fd9\u91cc\u7684\u539f\u5219 / \u6211\u7ed9\u4f60\u7684\u5efa\u8bae\u662f\uff1a\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u7684\u7533\u8bf7\u65f6\u673a\u5c3d\u91cf\u5f80\u540e\u653e\u3002</p> <p>\u4f46\u662f\uff0c\u8c03\u6574\u8bed\u53e5\u987a\u5e8f\u5e76\u4e0d\u80fd\u5b8c\u5168\u907f\u514d\u6b7b\u9501\u3002\u6240\u4ee5\u6211\u4eec\u5f15\u5165\u4e86\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u7684\u6982\u5ff5\uff0c\u4ee5\u53ca\u63d0\u4f9b\u4e86\u4e09\u4e2a\u65b9\u6848\uff0c\u6765\u51cf\u5c11\u6b7b\u9501\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u3002\u51cf\u5c11\u6b7b\u9501\u7684\u4e3b\u8981\u65b9\u5411\uff0c\u5c31\u662f\u63a7\u5236\u8bbf\u95ee\u76f8\u540c\u8d44\u6e90\u7684\u5e76\u53d1\u4e8b\u52a1\u91cf\u3002</p> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u95ee\u9898\u5427\u3002\u5982\u679c\u4f60\u8981\u5220\u9664\u4e00\u4e2a\u8868\u91cc\u9762\u7684\u524d 10000 \u884c\u6570\u636e\uff0c\u6709\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\u53ef\u4ee5\u505a\u5230\uff1a</p> <ul> <li>\u7b2c\u4e00\u79cd\uff0c\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000</code></li> <li>\u7b2c\u4e8c\u79cd\uff0c\u5728\u4e00\u4e2a\u8fde\u63a5\u4e2d\u5faa\u73af\u6267\u884c 20 \u6b21 <code>delete from T limit 500</code></li> <li>\u7b2c\u4e09\u79cd\uff0c\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c <code>delete from T limit 500</code></li> </ul> <p>\u4f60\u4f1a\u9009\u62e9\u54ea\u4e00\u79cd\u65b9\u6cd5\u5462\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u56de\u7b54\uff1a</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\u76f8\u5bf9\u8f83\u597d\u7684\u3002</p> <p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000</code>\uff09\u91cc\u9762\uff0c\u5355\u4e2a\u8bed\u53e5\u5360\u7528\u65f6\u95f4\u957f\uff0c\u9501\u7684\u65f6\u95f4\u4e5f\u6bd4\u8f83\u957f\uff1b\u800c\u4e14\u5927\u4e8b\u52a1\u8fd8\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</p> <p>\u7b2c\u4e09\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c <code>delete from T limit 500</code>\uff09\uff0c\u4f1a\u4eba\u4e3a\u9020\u6210\u9501\u51b2\u7a81\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#08","title":"08 \u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f","text":"<p>\u6211\u5728\u7b2c 3 \u7bc7\u6587\u7ae0\u548c\u4f60\u8bb2\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u65f6\u5019\u63d0\u5230\u8fc7\uff0c\u5982\u679c\u662f\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\uff0c\u4e8b\u52a1 T \u542f\u52a8\u7684\u65f6\u5019\u4f1a\u521b\u5efa\u4e00\u4e2a\u89c6\u56fe read-view\uff0c\u4e4b\u540e\u4e8b\u52a1 T \u6267\u884c\u671f\u95f4\uff0c\u5373\u4f7f\u6709\u5176\u4ed6\u4e8b\u52a1\u4fee\u6539\u4e86\u6570\u636e\uff0c\u4e8b\u52a1 T \u770b\u5230\u7684\u4ecd\u7136\u8ddf\u5728\u542f\u52a8\u65f6\u770b\u5230\u7684\u4e00\u6837\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u597d\u50cf\u4e0e\u4e16\u65e0\u4e89\uff0c\u4e0d\u53d7\u5916\u754c\u5f71\u54cd\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u548c\u4f60\u5206\u4eab\u884c\u9501\u7684\u65f6\u5019\u53c8\u63d0\u5230\uff0c\u4e00\u4e2a\u4e8b\u52a1\u8981\u66f4\u65b0\u4e00\u884c\uff0c\u5982\u679c\u521a\u597d\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u62e5\u6709\u8fd9\u4e00\u884c\u7684\u884c\u9501\uff0c\u5b83\u53c8\u4e0d\u80fd\u8fd9\u4e48\u8d85\u7136\u4e86\uff0c\u4f1a\u88ab\u9501\u4f4f\uff0c\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002\u95ee\u9898\u662f\uff0c\u65e2\u7136\u8fdb\u5165\u4e86\u7b49\u5f85\u72b6\u6001\uff0c\u90a3\u4e48\u7b49\u5230\u8fd9\u4e2a\u4e8b\u52a1\u81ea\u5df1\u83b7\u53d6\u5230\u884c\u9501\u8981\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u5b83\u8bfb\u5230\u7684\u503c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u6211\u7ed9\u4f60\u4e3e\u4e00\u4e2a\u4f8b\u5b50\u5427\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u53ea\u6709\u4e24\u884c\u7684\u8868\u7684\u521d\u59cb\u5316\u8bed\u53e5\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `k` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\ninsert into t(id, k) values(1,1),(2,2); \n</code></pre> <pre><code>sequenceDiagram\n\nparticipant \u4e8b\u52a1A\nparticipant \u4e8b\u52a1B\nparticipant \u4e8b\u52a1C\n\nparticipant \u8868T\n\n\u4e8b\u52a1A-&gt;&gt;\u8868T: start transaction with consistent snapshot\n\u4e8b\u52a1B-&gt;&gt;\u8868T: start transaction with consistent snapshot\n\u4e8b\u52a1C-&gt;&gt;\u8868T: update t set k=k+1 where id=1\n\u4e8b\u52a1B-&gt;&gt;\u8868T: update set k=k+1 where id=1\n\u4e8b\u52a1B-&gt;&gt;+\u8868T: select k from where id=1\n\u8868T--&gt;&gt;-\u4e8b\u52a1B: k=3\n\u4e8b\u52a1A-&gt;&gt;+\u8868T: select from t where id=1\n\u8868T--&gt;&gt;-\u4e8b\u52a1B: k=1\n\u4e8b\u52a1A-&gt;&gt;\u8868T: commit\n\u4e8b\u52a1B-&gt;&gt;\u8868T: commit</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e8b\u52a1\u7684\u542f\u52a8\u65f6\u673a\u3002</p> <p>begin/start transaction \u547d\u4ee4\u5e76\u4e0d\u662f\u4e00\u4e2a\u4e8b\u52a1\u7684\u8d77\u70b9\uff0c\u5728\u6267\u884c\u5230\u5b83\u4eec\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c InnoDB \u8868\u7684\u8bed\u53e5\uff08\u7b2c\u4e00\u4e2a\u5feb\u7167\u8bfb\u8bed\u53e5\uff09\uff0c\u4e8b\u52a1\u624d\u771f\u6b63\u542f\u52a8\u3002\u5982\u679c\u4f60\u60f3\u8981\u9a6c\u4e0a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>start transaction with consistent snapshot</code> \u8fd9\u4e2a\u547d\u4ee4\u3002</p> <p>\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u6574\u4e2a\u4e13\u680f\u91cc\u9762\uff0c\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u90fd\u662f\u9ed8\u8ba4 autocommit=1\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u52a1 C \u6ca1\u6709\u663e\u5f0f\u5730\u4f7f\u7528 begin/commit\uff0c\u8868\u793a\u8fd9\u4e2a update \u8bed\u53e5\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8bed\u53e5\u5b8c\u6210\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002\u4e8b\u52a1 B \u5728\u66f4\u65b0\u4e86\u884c\u4e4b\u540e\u67e5\u8be2 ; \u4e8b\u52a1 A \u5728\u4e00\u4e2a\u53ea\u8bfb\u4e8b\u52a1\u4e2d\u67e5\u8be2\uff0c\u5e76\u4e14\u65f6\u95f4\u987a\u5e8f\u4e0a\u662f\u5728\u4e8b\u52a1 B \u7684\u67e5\u8be2\u4e4b\u540e\u3002</p> <p>\u8fd9\u65f6\uff0c\u5982\u679c\u6211\u544a\u8bc9\u4f60\u4e8b\u52a1 B \u67e5\u5230\u7684 k \u7684\u503c\u662f 3\uff0c\u800c\u4e8b\u52a1 A \u67e5\u5230\u7684 k \u7684\u503c\u662f 1\uff0c\u4f60\u662f\u4e0d\u662f\u611f\u89c9\u6709\u70b9\u6655\u5462\uff1f</p> <p>\u6240\u4ee5\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5176\u5b9e\u5c31\u662f\u60f3\u548c\u4f60\u8bf4\u660e\u767d\u8fd9\u4e2a\u95ee\u9898\uff0c\u5e0c\u671b\u501f\u7531\u628a\u8fd9\u4e2a\u7591\u60d1\u89e3\u5f00\u7684\u8fc7\u7a0b\uff0c\u80fd\u591f\u5e2e\u52a9\u4f60\u5bf9 InnoDB \u7684\u4e8b\u52a1\u548c\u9501\u6709\u66f4\u8fdb\u4e00\u6b65\u7684\u7406\u89e3\u3002</p> <p>\u5728 MySQL \u91cc\uff0c\u6709\u4e24\u4e2a\u201c\u89c6\u56fe\u201d\u7684\u6982\u5ff5\uff1a</p> <ul> <li>\u4e00\u4e2a\u662f view\u3002\u5b83\u662f\u4e00\u4e2a\u7528\u67e5\u8be2\u8bed\u53e5\u5b9a\u4e49\u7684\u865a\u62df\u8868\uff0c\u5728\u8c03\u7528\u7684\u65f6\u5019\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u5e76\u751f\u6210\u7ed3\u679c\u3002\u521b\u5efa\u89c6\u56fe\u7684\u8bed\u6cd5\u662f create view ... \uff0c\u800c\u5b83\u7684\u67e5\u8be2\u65b9\u6cd5\u4e0e\u8868\u4e00\u6837\u3002</li> <li>\u53e6\u4e00\u4e2a\u662f InnoDB \u5728\u5b9e\u73b0 MVCC \u65f6\u7528\u5230\u7684\u4e00\u81f4\u6027\u8bfb\u89c6\u56fe\uff0c\u5373 consistent read view\uff0c\u7528\u4e8e\u652f\u6301 RC\uff08Read Committed\uff0c\u8bfb\u63d0\u4ea4\uff09\u548c RR\uff08Repeatable Read\uff0c\u53ef\u91cd\u590d\u8bfb\uff09\u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0\u3002</li> </ul> <p>\u5b83\u6ca1\u6709\u7269\u7406\u7ed3\u6784\uff0c\u4f5c\u7528\u662f\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u7528\u6765\u5b9a\u4e49\u201c\u6211\u80fd\u770b\u5230\u4ec0\u4e48\u6570\u636e\u201d\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_24","title":"\u5c0f\u7ed3","text":"<p>InnoDB \u7684\u884c\u6570\u636e\u6709\u591a\u4e2a\u7248\u672c\uff0c\u6bcf\u4e2a\u6570\u636e\u7248\u672c\u6709\u81ea\u5df1\u7684 <code>row trx_id</code>\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6216\u8005\u8bed\u53e5\u6709\u81ea\u5df1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u666e\u901a\u67e5\u8be2\u8bed\u53e5\u662f\u4e00\u81f4\u6027\u8bfb\uff0c\u4e00\u81f4\u6027\u8bfb\u4f1a\u6839\u636e <code>row trx_id</code> \u548c\u4e00\u81f4\u6027\u89c6\u56fe\u786e\u5b9a\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u3002</p> <ul> <li>\u5bf9\u4e8e\u53ef\u91cd\u590d\u8bfb\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u4e8b\u52a1\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</li> <li>\u5bf9\u4e8e\u8bfb\u63d0\u4ea4\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u8bed\u53e5\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</li> </ul> <p>\u800c\u5f53\u524d\u8bfb\uff0c\u603b\u662f\u8bfb\u53d6\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6700\u65b0\u7248\u672c\u3002</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u60f3\u4e00\u4e0b\uff0c\u4e3a\u4ec0\u4e48\u8868\u7ed3\u6784\u4e0d\u652f\u6301\u201c\u53ef\u91cd\u590d\u8bfb\u201d\uff1f\u8fd9\u662f\u56e0\u4e3a\u8868\u7ed3\u6784\u6ca1\u6709\u5bf9\u5e94\u7684\u884c\u6570\u636e\uff0c\u4e5f\u6ca1\u6709 <code>row trx_id</code>\uff0c\u56e0\u6b64\u53ea\u80fd\u9075\u5faa\u5f53\u524d\u8bfb\u7684\u903b\u8f91\u3002</p> <p>\u5f53\u7136\uff0cMySQL 8.0 \u5df2\u7ecf\u53ef\u4ee5\u628a\u8868\u7ed3\u6784\u653e\u5728 InnoDB \u5b57\u5178\u91cc\u4e86\uff0c\u4e5f\u8bb8\u4ee5\u540e\u4f1a\u652f\u6301\u8868\u7ed3\u6784\u7684\u53ef\u91cd\u590d\u8bfb\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#09","title":"09 \u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\uff0c\u5e94\u8be5\u600e\u4e48\u9009\u62e9\uff1f","text":"<p>\u5728\u524d\u9762\u7684\u57fa\u7840\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u8fc7\u7d22\u5f15\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u76f8\u4fe1\u4f60\u5df2\u7ecf\u4e86\u89e3\u4e86\u552f\u4e00\u7d22\u5f15\u548c\u666e\u901a\u7d22\u5f15\u7684\u533a\u522b\u3002\u4eca\u5929\u6211\u4eec\u5c31\u7ee7\u7eed\u6765\u8c08\u8c08\uff0c\u5728\u4e0d\u540c\u7684\u4e1a\u52a1\u573a\u666f\u4e0b\uff0c\u5e94\u8be5\u9009\u62e9\u666e\u901a\u7d22\u5f15\uff0c\u8fd8\u662f\u552f\u4e00\u7d22\u5f15\uff1f</p> <p>\u5047\u8bbe\u4f60\u5728\u7ef4\u62a4\u4e00\u4e2a\u5e02\u6c11\u7cfb\u7edf\uff0c\u6bcf\u4e2a\u4eba\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u800c\u4e14\u4e1a\u52a1\u4ee3\u7801\u5df2\u7ecf\u4fdd\u8bc1\u4e86\u4e0d\u4f1a\u5199\u5165\u4e24\u4e2a\u91cd\u590d\u7684\u8eab\u4efd\u8bc1\u53f7\u3002\u5982\u679c\u5e02\u6c11\u7cfb\u7edf\u9700\u8981\u6309\u7167\u8eab\u4efd\u8bc1\u53f7\u67e5\u59d3\u540d\uff0c\u5c31\u4f1a\u6267\u884c\u7c7b\u4f3c\u8fd9\u6837\u7684 SQL \u8bed\u53e5\uff1a</p> <pre><code>select name from CUser where id_card = 'xxxxxxxyyyyyyzzzzz';\n</code></pre> <p>\u6240\u4ee5\uff0c\u4f60\u4e00\u5b9a\u4f1a\u8003\u8651\u5728 <code>id_card</code> \u5b57\u6bb5\u4e0a\u5efa\u7d22\u5f15\u3002</p> <p>\u7531\u4e8e\u8eab\u4efd\u8bc1\u53f7\u5b57\u6bb5\u6bd4\u8f83\u5927\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u628a\u8eab\u4efd\u8bc1\u53f7\u5f53\u505a\u4e3b\u952e\uff0c\u90a3\u4e48\u73b0\u5728\u4f60\u6709\u4e24\u4e2a\u9009\u62e9\uff0c\u8981\u4e48\u7ed9 <code>id_card</code> \u5b57\u6bb5\u521b\u5efa\u552f\u4e00\u7d22\u5f15\uff0c\u8981\u4e48\u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7d22\u5f15\u3002\u5982\u679c\u4e1a\u52a1\u4ee3\u7801\u5df2\u7ecf\u4fdd\u8bc1\u4e86\u4e0d\u4f1a\u5199\u5165\u91cd\u590d\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u9009\u62e9\u903b\u8f91\u4e0a\u90fd\u662f\u6b63\u786e\u7684\u3002</p> <p>\u73b0\u5728\u6211\u8981\u95ee\u4f60\u7684\u662f\uff0c\u4ece\u6027\u80fd\u7684\u89d2\u5ea6\u8003\u8651\uff0c\u4f60\u9009\u62e9\u552f\u4e00\u7d22\u5f15\u8fd8\u662f\u666e\u901a\u7d22\u5f15\u5462\uff1f\u9009\u62e9\u7684\u4f9d\u636e\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u8fd8\u662f\u7528\u7b2c 4 \u7bc7\u6587\u7ae0[\u300a\u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0a\uff09\u300b]\u4e2d\u7684\u4f8b\u5b50\u6765\u8bf4\u660e\uff0c\u5047\u8bbe\u5b57\u6bb5 k \u4e0a\u7684\u503c\u90fd\u4e0d\u91cd\u590d\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e24\u79cd\u7d22\u5f15\u5bf9\u67e5\u8be2\u8bed\u53e5\u548c\u66f4\u65b0\u8bed\u53e5\u7684\u6027\u80fd\u5f71\u54cd\u6765\u8fdb\u884c\u5206\u6790\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_25","title":"\u67e5\u8be2\u8fc7\u7a0b","text":"<p>\u5047\u8bbe\uff0c\u6267\u884c\u67e5\u8be2\u7684\u8bed\u53e5\u662f <code>select id from T where k=5</code>\u3002\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u5728\u7d22\u5f15\u6811\u4e0a\u67e5\u627e\u7684\u8fc7\u7a0b\uff0c\u5148\u662f\u901a\u8fc7 B+ \u6811\u4ece\u6811\u6839\u5f00\u59cb\uff0c\u6309\u5c42\u641c\u7d22\u5230\u53f6\u5b50\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u53f3\u4e0b\u89d2\u7684\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u7136\u540e\u53ef\u4ee5\u8ba4\u4e3a\u6570\u636e\u9875\u5185\u90e8\u901a\u8fc7\u4e8c\u5206\u6cd5\u6765\u5b9a\u4f4d\u8bb0\u5f55\u3002</p> <ul> <li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u67e5\u627e\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u8bb0\u5f55 (5,500) \u540e\uff0c\u9700\u8981\u67e5\u627e\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u76f4\u5230\u78b0\u5230\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3 k=5 \u6761\u4ef6\u7684\u8bb0\u5f55\u3002</li> <li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u7531\u4e8e\u7d22\u5f15\u5b9a\u4e49\u4e86\u552f\u4e00\u6027\uff0c\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\u540e\uff0c\u5c31\u4f1a\u505c\u6b62\u7ee7\u7eed\u68c0\u7d22\u3002</li> </ul> <p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u4e0d\u540c\u5e26\u6765\u7684\u6027\u80fd\u5dee\u8ddd\u4f1a\u6709\u591a\u5c11\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5fae\u4e4e\u5176\u5fae\u3002</p> <p>\u4f60\u77e5\u9053\u7684\uff0cInnoDB \u7684\u6570\u636e\u662f\u6309\u6570\u636e\u9875\u4e3a\u5355\u4f4d\u6765\u8bfb\u5199\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u9700\u8981\u8bfb\u4e00\u6761\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u5e76\u4e0d\u662f\u5c06\u8fd9\u4e2a\u8bb0\u5f55\u672c\u8eab\u4ece\u78c1\u76d8\u8bfb\u51fa\u6765\uff0c\u800c\u662f\u4ee5\u9875\u4e3a\u5355\u4f4d\uff0c\u5c06\u5176\u6574\u4f53\u8bfb\u5165\u5185\u5b58\u3002\u5728 InnoDB \u4e2d\uff0c\u6bcf\u4e2a\u6570\u636e\u9875\u7684\u5927\u5c0f\u9ed8\u8ba4\u662f 16KB\u3002</p> <p>\u56e0\u4e3a\u5f15\u64ce\u662f\u6309\u9875\u8bfb\u5199\u7684\uff0c\u6240\u4ee5\u8bf4\uff0c\u5f53\u627e\u5230 k=5 \u7684\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u5b83\u6240\u5728\u7684\u6570\u636e\u9875\u5c31\u90fd\u5728\u5185\u5b58\u91cc\u4e86\u3002\u90a3\u4e48\uff0c\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u8981\u591a\u505a\u7684\u90a3\u4e00\u6b21\u201c\u67e5\u627e\u548c\u5224\u65ad\u4e0b\u4e00\u6761\u8bb0\u5f55\u201d\u7684\u64cd\u4f5c\uff0c\u5c31\u53ea\u9700\u8981\u4e00\u6b21\u6307\u9488\u5bfb\u627e\u548c\u4e00\u6b21\u8ba1\u7b97\u3002</p> <p>\u5f53\u7136\uff0c\u5982\u679c k=5 \u8fd9\u4e2a\u8bb0\u5f55\u521a\u597d\u662f\u8fd9\u4e2a\u6570\u636e\u9875\u7684\u6700\u540e\u4e00\u4e2a\u8bb0\u5f55\uff0c\u90a3\u4e48\u8981\u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u5fc5\u987b\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u6570\u636e\u9875\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u4f1a\u7a0d\u5fae\u590d\u6742\u4e00\u4e9b\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u4e4b\u524d\u8ba1\u7b97\u8fc7\uff0c\u5bf9\u4e8e\u6574\u578b\u5b57\u6bb5\uff0c\u4e00\u4e2a\u6570\u636e\u9875\u53ef\u4ee5\u653e\u8fd1\u5343\u4e2a key\uff0c\u56e0\u6b64\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u6982\u7387\u4f1a\u5f88\u4f4e\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u8ba1\u7b97\u5e73\u5747\u6027\u80fd\u5dee\u5f02\u65f6\uff0c\u4ecd\u53ef\u4ee5\u8ba4\u4e3a\u8fd9\u4e2a\u64cd\u4f5c\u6210\u672c\u5bf9\u4e8e\u73b0\u5728\u7684 CPU \u6765\u8bf4\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_26","title":"\u66f4\u65b0\u8fc7\u7a0b","text":"<p>\u4e3a\u4e86\u8bf4\u660e\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5bf9\u66f4\u65b0\u8bed\u53e5\u6027\u80fd\u7684\u5f71\u54cd\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u9700\u8981\u5148\u8ddf\u4f60\u4ecb\u7ecd\u4e00\u4e0b change buffer\u3002</p> <p>\u5f53\u9700\u8981\u66f4\u65b0\u4e00\u4e2a\u6570\u636e\u9875\u65f6\uff0c\u5982\u679c\u6570\u636e\u9875\u5728\u5185\u5b58\u4e2d\u5c31\u76f4\u63a5\u66f4\u65b0\uff0c\u800c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u8fd8\u6ca1\u6709\u5728\u5185\u5b58\u4e2d\u7684\u8bdd\uff0c\u5728\u4e0d\u5f71\u54cd\u6570\u636e\u4e00\u81f4\u6027\u7684\u524d\u63d0\u4e0b\uff0cInooDB \u4f1a\u5c06\u8fd9\u4e9b\u66f4\u65b0\u64cd\u4f5c\u7f13\u5b58\u5728 change buffer \u4e2d\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u8fd9\u4e2a\u6570\u636e\u9875\u4e86\u3002\u5728\u4e0b\u6b21\u67e5\u8be2\u9700\u8981\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u7684\u65f6\u5019\uff0c\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u6267\u884c change buffer \u4e2d\u4e0e\u8fd9\u4e2a\u9875\u6709\u5173\u7684\u64cd\u4f5c\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5c31\u80fd\u4fdd\u8bc1\u8fd9\u4e2a\u6570\u636e\u903b\u8f91\u7684\u6b63\u786e\u6027\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u867d\u7136\u540d\u5b57\u53eb\u4f5c change buffer\uff0c\u5b9e\u9645\u4e0a\u5b83\u662f\u53ef\u4ee5\u6301\u4e45\u5316\u7684\u6570\u636e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cchange buffer \u5728\u5185\u5b58\u4e2d\u6709\u62f7\u8d1d\uff0c\u4e5f\u4f1a\u88ab\u5199\u5165\u5230\u78c1\u76d8\u4e0a\u3002</p> <p>\u5c06 change buffer \u4e2d\u7684\u64cd\u4f5c\u5e94\u7528\u5230\u539f\u6570\u636e\u9875\uff0c\u5f97\u5230\u6700\u65b0\u7ed3\u679c\u7684\u8fc7\u7a0b\u79f0\u4e3a merge\u3002\u9664\u4e86\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u4f1a\u89e6\u53d1 merge \u5916\uff0c\u7cfb\u7edf\u6709\u540e\u53f0\u7ebf\u7a0b\u4f1a\u5b9a\u671f merge\u3002\u5728\u6570\u636e\u5e93\u6b63\u5e38\u5173\u95ed\uff08shutdown\uff09\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u4f1a\u6267\u884c merge \u64cd\u4f5c\u3002</p> <p>\u663e\u7136\uff0c\u5982\u679c\u80fd\u591f\u5c06\u66f4\u65b0\u64cd\u4f5c\u5148\u8bb0\u5f55\u5728 change buffer\uff0c\u51cf\u5c11\u8bfb\u78c1\u76d8\uff0c\u8bed\u53e5\u7684\u6267\u884c\u901f\u5ea6\u4f1a\u5f97\u5230\u660e\u663e\u7684\u63d0\u5347\u3002\u800c\u4e14\uff0c\u6570\u636e\u8bfb\u5165\u5185\u5b58\u662f\u9700\u8981\u5360\u7528 buffer pool \u7684\uff0c\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd8\u80fd\u591f\u907f\u514d\u5360\u7528\u5185\u5b58\uff0c\u63d0\u9ad8\u5185\u5b58\u5229\u7528\u7387\u3002</p> <p>\u90a3\u4e48\uff0c\u4ec0\u4e48\u6761\u4ef6\u4e0b\u53ef\u4ee5\u4f7f\u7528 change buffer \u5462\uff1f</p> <p>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u6240\u6709\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u8981\u5148\u5224\u65ad\u8fd9\u4e2a\u64cd\u4f5c\u662f\u5426\u8fdd\u53cd\u552f\u4e00\u6027\u7ea6\u675f\u3002\u6bd4\u5982\uff0c\u8981\u63d2\u5165 (4,400) \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u5c31\u8981\u5148\u5224\u65ad\u73b0\u5728\u8868\u4e2d\u662f\u5426\u5df2\u7ecf\u5b58\u5728 k=4 \u7684\u8bb0\u5f55\uff0c\u800c\u8fd9\u5fc5\u987b\u8981\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\u624d\u80fd\u5224\u65ad\u3002\u5982\u679c\u90fd\u5df2\u7ecf\u8bfb\u5165\u5230\u5185\u5b58\u4e86\uff0c\u90a3\u76f4\u63a5\u66f4\u65b0\u5185\u5b58\u4f1a\u66f4\u5feb\uff0c\u5c31\u6ca1\u5fc5\u8981\u4f7f\u7528 change buffer \u4e86\u3002</p> <p>\u56e0\u6b64\uff0c\u552f\u4e00\u7d22\u5f15\u7684\u66f4\u65b0\u5c31\u4e0d\u80fd\u4f7f\u7528 change buffer\uff0c\u5b9e\u9645\u4e0a\u4e5f\u53ea\u6709\u666e\u901a\u7d22\u5f15\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>change buffer \u7528\u7684\u662f buffer pool \u91cc\u7684\u5185\u5b58\uff0c\u56e0\u6b64\u4e0d\u80fd\u65e0\u9650\u589e\u5927\u3002change buffer \u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570 <code>innodb_change_buffer_max_size</code> \u6765\u52a8\u6001\u8bbe\u7f6e(\u9ed8\u8ba4\u503c\u4e3a25)\u3002\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a 50 \u7684\u65f6\u5019\uff0c\u8868\u793a change buffer \u7684\u5927\u5c0f\u6700\u591a\u53ea\u80fd\u5360\u7528 buffer pool \u7684 50%\u3002</p> <p>\u73b0\u5728\uff0c\u4f60\u5df2\u7ecf\u7406\u89e3\u4e86 change buffer \u7684\u673a\u5236\uff0c\u90a3\u4e48\u6211\u4eec\u518d\u4e00\u8d77\u6765\u770b\u770b\u5982\u679c\u8981\u5728\u8fd9\u5f20\u8868\u4e2d\u63d2\u5165\u4e00\u4e2a\u65b0\u8bb0\u5f55 (4,400) \u7684\u8bdd\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u662f\u600e\u6837\u7684\u3002</p> <p>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a\u8bb0\u5f55\u8981\u66f4\u65b0\u7684\u76ee\u6807\u9875\u5728\u5185\u5b58\u4e2d\u3002\u8fd9\u65f6\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u627e\u5230 3 \u548c 5 \u4e4b\u95f4\u7684\u4f4d\u7f6e\uff0c\u5224\u65ad\u5230\u6ca1\u6709\u51b2\u7a81\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\uff1b</li> <li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u627e\u5230 3 \u548c 5 \u4e4b\u95f4\u7684\u4f4d\u7f6e\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\u3002</li> </ul> <p>\u8fd9\u6837\u770b\u6765\uff0c\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5bf9\u66f4\u65b0\u8bed\u53e5\u6027\u80fd\u5f71\u54cd\u7684\u5dee\u522b\uff0c\u53ea\u662f\u4e00\u4e2a\u5224\u65ad\uff0c\u53ea\u4f1a\u8017\u8d39\u5fae\u5c0f\u7684 CPU \u65f6\u95f4\u3002</p> <p>\u4f46\uff0c\u8fd9\u4e0d\u662f\u6211\u4eec\u5173\u6ce8\u7684\u91cd\u70b9\u3002</p> <p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a\u8bb0\u5f55\u8981\u66f4\u65b0\u7684\u76ee\u6807\u9875\u4e0d\u5728\u5185\u5b58\u4e2d\u3002\u8fd9\u65f6\uff0cInnoDB \u7684\u5904\u7406\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u9700\u8981\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\uff0c\u5224\u65ad\u5230\u6ca1\u6709\u51b2\u7a81\uff0c\u63d2\u5165\u8fd9\u4e2a\u503c\uff0c\u8bed\u53e5\u6267\u884c\u7ed3\u675f\uff1b</li> <li>\u5bf9\u4e8e\u666e\u901a\u7d22\u5f15\u6765\u8bf4\uff0c\u5219\u662f\u5c06\u66f4\u65b0\u8bb0\u5f55\u5728 change buffer\uff0c\u8bed\u53e5\u6267\u884c\u5c31\u7ed3\u675f\u4e86\u3002</li> </ul> <p>\u5c06\u6570\u636e\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u6d89\u53ca\u968f\u673a IO \u7684\u8bbf\u95ee\uff0c\u662f\u6570\u636e\u5e93\u91cc\u9762\u6210\u672c\u6700\u9ad8\u7684\u64cd\u4f5c\u4e4b\u4e00\u3002change buffer \u56e0\u4e3a\u51cf\u5c11\u4e86\u968f\u673a\u78c1\u76d8\u8bbf\u95ee\uff0c\u6240\u4ee5\u5bf9\u66f4\u65b0\u6027\u80fd\u7684\u63d0\u5347\u662f\u4f1a\u5f88\u660e\u663e\u7684\u3002</p> <p>\u4e4b\u524d\u6211\u5c31\u78b0\u5230\u8fc7\u4e00\u4ef6\u4e8b\u513f\uff0c\u6709\u4e2a DBA \u7684\u540c\u5b66\u8ddf\u6211\u53cd\u9988\u8bf4\uff0c\u4ed6\u8d1f\u8d23\u7684\u67d0\u4e2a\u4e1a\u52a1\u7684\u5e93\u5185\u5b58\u547d\u4e2d\u7387\u7a81\u7136\u4ece 99% \u964d\u4f4e\u5230\u4e86 75%\uff0c\u6574\u4e2a\u7cfb\u7edf\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u66f4\u65b0\u8bed\u53e5\u5168\u90e8\u5835\u4f4f\u3002\u800c\u63a2\u7a76\u5176\u539f\u56e0\u540e\uff0c\u6211\u53d1\u73b0\u8fd9\u4e2a\u4e1a\u52a1\u6709\u5927\u91cf\u63d2\u5165\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u800c\u4ed6\u5728\u524d\u4e00\u5929\u628a\u5176\u4e2d\u7684\u67d0\u4e2a\u666e\u901a\u7d22\u5f15\u6539\u6210\u4e86\u552f\u4e00\u7d22\u5f15\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#change-buffer","title":"change buffer \u7684\u4f7f\u7528\u573a\u666f","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u5df2\u7ecf\u6e05\u695a\u4e86\u4f7f\u7528 change buffer \u5bf9\u66f4\u65b0\u8fc7\u7a0b\u7684\u52a0\u901f\u4f5c\u7528\uff0c\u4e5f\u6e05\u695a\u4e86 change buffer \u53ea\u9650\u4e8e\u7528\u5728\u666e\u901a\u7d22\u5f15\u7684\u573a\u666f\u4e0b\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u552f\u4e00\u7d22\u5f15\u3002\u90a3\u4e48\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff1a\u666e\u901a\u7d22\u5f15\u7684\u6240\u6709\u573a\u666f\uff0c\u4f7f\u7528 change buffer \u90fd\u53ef\u4ee5\u8d77\u5230\u52a0\u901f\u4f5c\u7528\u5417\uff1f</p> <p>\u56e0\u4e3a merge \u7684\u65f6\u5019\u662f\u771f\u6b63\u8fdb\u884c\u6570\u636e\u66f4\u65b0\u7684\u65f6\u523b\uff0c\u800c change buffer \u7684\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u5c06\u8bb0\u5f55\u7684\u53d8\u66f4\u52a8\u4f5c\u7f13\u5b58\u4e0b\u6765\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a\u6570\u636e\u9875\u505a merge \u4e4b\u524d\uff0cchange buffer \u8bb0\u5f55\u7684\u53d8\u66f4\u8d8a\u591a\uff08\u4e5f\u5c31\u662f\u8fd9\u4e2a\u9875\u9762\u4e0a\u8981\u66f4\u65b0\u7684\u6b21\u6570\u8d8a\u591a\uff09\uff0c\u6536\u76ca\u5c31\u8d8a\u5927\u3002</p> <p>\u56e0\u6b64\uff0c\u5bf9\u4e8e\u5199\u591a\u8bfb\u5c11\u7684\u4e1a\u52a1\u6765\u8bf4\uff0c\u9875\u9762\u5728\u5199\u5b8c\u4ee5\u540e\u9a6c\u4e0a\u88ab\u8bbf\u95ee\u5230\u7684\u6982\u7387\u6bd4\u8f83\u5c0f\uff0c\u6b64\u65f6 change buffer \u7684\u4f7f\u7528\u6548\u679c\u6700\u597d\u3002\u8fd9\u79cd\u4e1a\u52a1\u6a21\u578b\u5e38\u89c1\u7684\u5c31\u662f\u8d26\u5355\u7c7b\u3001\u65e5\u5fd7\u7c7b\u7684\u7cfb\u7edf\u3002</p> <p>\u53cd\u8fc7\u6765\uff0c\u5047\u8bbe\u4e00\u4e2a\u4e1a\u52a1\u7684\u66f4\u65b0\u6a21\u5f0f\u662f\u5199\u5165\u4e4b\u540e\u9a6c\u4e0a\u4f1a\u505a\u67e5\u8be2\uff0c\u90a3\u4e48\u5373\u4f7f\u6ee1\u8db3\u4e86\u6761\u4ef6\uff0c\u5c06\u66f4\u65b0\u5148\u8bb0\u5f55\u5728 change buffer\uff0c\u4f46\u4e4b\u540e\u7531\u4e8e\u9a6c\u4e0a\u8981\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u4f1a\u7acb\u5373\u89e6\u53d1 merge \u8fc7\u7a0b\u3002\u8fd9\u6837\u968f\u673a\u8bbf\u95ee IO \u7684\u6b21\u6570\u4e0d\u4f1a\u51cf\u5c11\uff0c\u53cd\u800c\u589e\u52a0\u4e86 change buffer \u7684\u7ef4\u62a4\u4ee3\u4ef7\u3002\u6240\u4ee5\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u4e1a\u52a1\u6a21\u5f0f\u6765\u8bf4\uff0cchange buffer \u53cd\u800c\u8d77\u5230\u4e86\u526f\u4f5c\u7528\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_27","title":"\u7d22\u5f15\u9009\u62e9\u548c\u5b9e\u8df5","text":"<p>\u56de\u5230\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5e94\u8be5\u600e\u4e48\u9009\u62e9\u3002\u5176\u5b9e\uff0c\u8fd9\u4e24\u7c7b\u7d22\u5f15\u5728\u67e5\u8be2\u80fd\u529b\u4e0a\u662f\u6ca1\u5dee\u522b\u7684\uff0c\u4e3b\u8981\u8003\u8651\u7684\u662f\u5bf9\u66f4\u65b0\u6027\u80fd\u7684\u5f71\u54cd\u3002\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u4f60\u5c3d\u91cf\u9009\u62e9\u666e\u901a\u7d22\u5f15\u3002</p> <p>\u5982\u679c\u6240\u6709\u7684\u66f4\u65b0\u540e\u9762\uff0c\u90fd\u9a6c\u4e0a\u4f34\u968f\u7740\u5bf9\u8fd9\u4e2a\u8bb0\u5f55\u7684\u67e5\u8be2\uff0c\u90a3\u4e48\u4f60\u5e94\u8be5\u5173\u95ed change buffer\u3002\u800c\u5728\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0cchange buffer \u90fd\u80fd\u63d0\u5347\u66f4\u65b0\u6027\u80fd\u3002</p> <p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u666e\u901a\u7d22\u5f15\u548c change buffer \u7684\u914d\u5408\u4f7f\u7528\uff0c\u5bf9\u4e8e\u6570\u636e\u91cf\u5927\u7684\u8868\u7684\u66f4\u65b0\u4f18\u5316\u8fd8\u662f\u5f88\u660e\u663e\u7684\u3002</p> <p>\u7279\u522b\u5730\uff0c\u5728\u4f7f\u7528\u673a\u68b0\u786c\u76d8\u65f6\uff0cchange buffer \u8fd9\u4e2a\u673a\u5236\u7684\u6536\u6548\u662f\u975e\u5e38\u663e\u8457\u7684\u3002\u6240\u4ee5\uff0c\u5f53\u4f60\u6709\u4e00\u4e2a\u7c7b\u4f3c\u201c\u5386\u53f2\u6570\u636e\u201d\u7684\u5e93\uff0c\u5e76\u4e14\u51fa\u4e8e\u6210\u672c\u8003\u8651\u7528\u7684\u662f\u673a\u68b0\u786c\u76d8\u65f6\uff0c\u90a3\u4f60\u5e94\u8be5\u7279\u522b\u5173\u6ce8\u8fd9\u4e9b\u8868\u91cc\u7684\u7d22\u5f15\uff0c\u5c3d\u91cf\u4f7f\u7528\u666e\u901a\u7d22\u5f15\uff0c\u7136\u540e\u628a change buffer \u5c3d\u91cf\u5f00\u5927\uff0c\u4ee5\u786e\u4fdd\u8fd9\u4e2a\u201c\u5386\u53f2\u6570\u636e\u201d\u8868\u7684\u6570\u636e\u5199\u5165\u901f\u5ea6\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#change-buffer-redo-log","title":"change buffer \u548c redo log","text":"<p>\u7406\u89e3\u4e86 change buffer \u7684\u539f\u7406\uff0c\u4f60\u53ef\u80fd\u4f1a\u8054\u60f3\u5230\u6211\u5728\u524d\u9762\u6587\u7ae0\u4e2d\u548c\u4f60\u4ecb\u7ecd\u8fc7\u7684 redo log \u548c WAL\u3002</p> <p>\u5728\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u4e2d\uff0c\u6211\u53d1\u73b0\u6709\u540c\u5b66\u6df7\u6dc6\u4e86 redo log \u548c change buffer\u3002WAL \u63d0\u5347\u6027\u80fd\u7684\u6838\u5fc3\u673a\u5236\uff0c\u4e5f\u7684\u786e\u662f\u5c3d\u91cf\u51cf\u5c11\u968f\u673a\u8bfb\u5199\uff0c\u8fd9\u4e24\u4e2a\u6982\u5ff5\u786e\u5b9e\u5bb9\u6613\u6df7\u6dc6\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u6211\u628a\u5b83\u4eec\u653e\u5230\u4e86\u540c\u4e00\u4e2a\u6d41\u7a0b\u91cc\u6765\u8bf4\u660e\uff0c\u4fbf\u4e8e\u4f60\u533a\u5206\u8fd9\u4e24\u4e2a\u6982\u5ff5\u3002</p> <p>\u5907\u6ce8\uff1a\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e0b\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\u7684\u76f8\u5173\u5185\u5bb9\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u8981\u5728\u8868\u4e0a\u6267\u884c\u8fd9\u4e2a\u63d2\u5165\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; insert into t(id,k) values(id1,k1),(id2,k2);\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u5047\u8bbe\b\u5f53\u524d k \u7d22\u5f15\u6811\u7684\u72b6\u6001\uff0c\u67e5\u627e\u5230\u4f4d\u7f6e\u540e\uff0ck1 \u6240\u5728\u7684\u6570\u636e\u9875\u5728\u5185\u5b58 (InnoDB buffer pool) \u4e2d\uff0ck2 \u6240\u5728\u7684\u6570\u636e\u9875\u4e0d\u5728\u5185\u5b58\u4e2d\u3002\u5982\u56fe 2 \u6240\u793a\u662f\u5e26 change buffer \u7684\u66f4\u65b0\u72b6\u6001\u56fe\u3002</p> <pre><code>graph TB\nsubgraph buffer[\"InnoDB buffer pool\"]\n    subgraph cb[\"change buffer\"]\n        node1[\"add(id2,k2) to Page 2\"]\n    end\n    p1[\"Page1&lt;br/&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;(a,b)&lt;/td&gt;&lt;td&gt;&lt;font color='red'&gt;(id1,k1)&lt;/font&gt;&lt;/td&gt;&lt;td&gt;(c,d)&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\"]\nend\nsubgraph redolog[\"Redo log(ib_logfileX)\"]\n rn1[\"add(id1,k1) to Page 1\"]\n rn2[\"new change buffer item &lt;br/&gt;'add(id2,k2) to Page2'\"]\nend\nsubgraph tablespace[\"system table space(ibdata1)\"]\n    subgraph cbtb[\"change buffer\"]\n        n[\"add(id2,k2) to Page 2\"]\n    end\nend\nsubgraph data[\"data(t.ibd)\"]\n    dn[\"&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td colspan='2'&gt;Page 1&lt;/td&gt;&lt;td&gt;...&lt;/td&gt;&lt;td colspan='2'&gt;Page 2&lt;/td&gt;&lt;/tr&gt;\n       &lt;tr&gt;&lt;td&gt;(a,b)&lt;/td&gt;&lt;td&gt;(c,d)&lt;/td&gt;&lt;td&gt;...&lt;/td&gt;&lt;td&gt;(e,f)&lt;/td&gt;&lt;td&gt;(g,h)&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;\"]\nend\ncb --&gt;cbtb\np1 --&gt;dn</code></pre> <p>\u5206\u6790\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u6d89\u53ca\u4e86\u56db\u4e2a\u90e8\u5206\uff1a\u5185\u5b58\u3001redo log\uff08<code>ib_logfileX</code>\uff09\u3001 \u6570\u636e\u8868\u7a7a\u95f4\uff08t.ibd\uff09\u3001\u7cfb\u7edf\u8868\u7a7a\u95f4\uff08ibdata1\uff09\u3002</p> <p>\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u505a\u4e86\u5982\u4e0b\u7684\u64cd\u4f5c\uff1a</p> <ol> <li>Page 1 \u5728\u5185\u5b58\u4e2d\uff0c\u76f4\u63a5\u66f4\u65b0\u5185\u5b58\uff1b</li> <li>Page 2 \u6ca1\u6709\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u5728\u5185\u5b58\u7684 change buffer \u533a\u57df\uff0c\u8bb0\u5f55\u4e0b\u201c\u6211\u8981\u5f80 Page 2 \u63d2\u5165\u4e00\u884c\u201d\u8fd9\u4e2a\u4fe1\u606f</li> <li>\u5c06\u4e0a\u8ff0\u4e24\u4e2a\u52a8\u4f5c\u8bb0\u5165 redo log \u4e2d\u3002</li> </ol> <p>\u505a\u5b8c\u4e0a\u9762\u8fd9\u4e9b\uff0c\u4e8b\u52a1\u5c31\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002\u6240\u4ee5\uff0c\u4f60\u4f1a\u770b\u5230\uff0c\u6267\u884c\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u662f\u5199\u4e86\u4e24\u5904\u5185\u5b58\uff0c\u7136\u540e\u5199\u4e86\u4e00\u5904\u78c1\u76d8\uff08\u4e24\u6b21\u64cd\u4f5c\u5408\u5728\u4e00\u8d77\u5199\u4e86\u4e00\u6b21\u78c1\u76d8\uff09\uff0c\u800c\u4e14\u8fd8\u662f\u987a\u5e8f\u5199\u7684\u3002</p> <p>\u90a3\u5728\u8fd9\u4e4b\u540e\u7684\u8bfb\u8bf7\u6c42\uff0c\u8981\u600e\u4e48\u5904\u7406\u5462\uff1f</p> <p>\u6bd4\u5982\uff0c\u6211\u4eec\u73b0\u5728\u8981\u6267\u884c <code>select * from t where k in (k1, k2)</code>\u3002\u8fd9\u91cc\uff0c\u6211\u753b\u4e86\u8fd9\u4e24\u4e2a\u8bfb\u8bf7\u6c42\u7684\u6d41\u7a0b\u56fe\u3002</p> <p>\u5982\u679c\u8bfb\u8bed\u53e5\u53d1\u751f\u5728\u66f4\u65b0\u8bed\u53e5\u540e\u4e0d\u4e45\uff0c\u5185\u5b58\u4e2d\u7684\u6570\u636e\u90fd\u8fd8\u5728\uff0c\u90a3\u4e48\u6b64\u65f6\u7684\u8fd9\u4e24\u4e2a\u8bfb\u64cd\u4f5c\u5c31\u4e0e\u7cfb\u7edf\u8868\u7a7a\u95f4\uff08ibdata1\uff09\u548c redo log\uff08<code>ib_logfileX</code>\uff09\u65e0\u5173\u4e86\u3002\u6240\u4ee5\uff0c\u6211\u5728\u56fe\u4e2d\u5c31\u6ca1\u753b\u51fa\u8fd9\u4e24\u90e8\u5206\u3002</p> <p></p> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff1a</p> <ol> <li>\u8bfb Page 1 \u7684\u65f6\u5019\uff0c\u76f4\u63a5\u4ece\u5185\u5b58\u8fd4\u56de\u3002\u6709\u51e0\u4f4d\u540c\u5b66\u5728\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u4e2d\u95ee\u5230\uff0cWAL \u4e4b\u540e\u5982\u679c\u8bfb\u6570\u636e\uff0c\u662f\u4e0d\u662f\u4e00\u5b9a\u8981\u8bfb\u76d8\uff0c\u662f\u4e0d\u662f\u4e00\u5b9a\u8981\u4ece redo log \u91cc\u9762\u628a\u6570\u636e\u66f4\u65b0\u4ee5\u540e\u624d\u53ef\u4ee5\u8fd4\u56de\uff1f\u5176\u5b9e\u662f\u4e0d\u7528\u7684\u3002\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u56fe 3 \u7684\u8fd9\u4e2a\u72b6\u6001\uff0c\u867d\u7136\u78c1\u76d8\u4e0a\u8fd8\u662f\u4e4b\u524d\u7684\u6570\u636e\uff0c\u4f46\u662f\u8fd9\u91cc\u76f4\u63a5\u4ece\u5185\u5b58\u8fd4\u56de\u7ed3\u679c\uff0c\u7ed3\u679c\u662f\u6b63\u786e\u7684\u3002</li> <li>\u8981\u8bfb Page 2 \u7684\u65f6\u5019\uff0c\u9700\u8981\u628a Page 2 \u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u5e94\u7528 change buffer \u91cc\u9762\u7684\u64cd\u4f5c\u65e5\u5fd7\uff0c\u751f\u6210\u4e00\u4e2a\u6b63\u786e\u7684\u7248\u672c\u5e76\u8fd4\u56de\u7ed3\u679c\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u76f4\u5230\u9700\u8981\u8bfb Page 2 \u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u624d\u4f1a\u88ab\u8bfb\u5165\u5185\u5b58\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u8981\u7b80\u5355\u5730\u5bf9\u6bd4\u8fd9\u4e24\u4e2a\u673a\u5236\u5728\u63d0\u5347\u66f4\u65b0\u6027\u80fd\u4e0a\u7684\u6536\u76ca\u7684\u8bdd\uff0credo log \u4e3b\u8981\u8282\u7701\u7684\u662f\u968f\u673a\u5199\u78c1\u76d8\u7684 IO \u6d88\u8017\uff08\u8f6c\u6210\u987a\u5e8f\u5199\uff09\uff0c\u800c change buffer \u4e3b\u8981\u8282\u7701\u7684\u5219\u662f\u968f\u673a\u8bfb\u78c1\u76d8\u7684 IO \u6d88\u8017\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-1/#_28","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u4ece\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u7684\u9009\u62e9\u5f00\u59cb\uff0c\u548c\u4f60\u5206\u4eab\u4e86\u6570\u636e\u7684\u67e5\u8be2\u548c\u66f4\u65b0\u8fc7\u7a0b\uff0c\u7136\u540e\u8bf4\u660e\u4e86 change buffer \u7684\u673a\u5236\u4ee5\u53ca\u5e94\u7528\u573a\u666f\uff0c\u6700\u540e\u8bb2\u5230\u4e86\u7d22\u5f15\u9009\u62e9\u7684\u5b9e\u8df5\u3002</p> <p>\u7531\u4e8e\u552f\u4e00\u7d22\u5f15\u7528\u4e0d\u4e0a change buffer \u7684\u4f18\u5316\u673a\u5236\uff0c\u56e0\u6b64\u5982\u679c\u4e1a\u52a1\u53ef\u4ee5\u63a5\u53d7\uff0c\u4ece\u6027\u80fd\u89d2\u5ea6\u51fa\u53d1\u6211\u5efa\u8bae\u4f60\u4f18\u5148\u8003\u8651\u975e\u552f\u4e00\u7d22\u5f15\u3002</p> <p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u601d\u8003\u9898\u65f6\u95f4\u3002</p> <p>\u901a\u8fc7\u56fe 2 \u4f60\u53ef\u4ee5\u770b\u5230\uff0cchange buffer \u4e00\u5f00\u59cb\u662f\u5199\u5185\u5b58\u7684\uff0c\u90a3\u4e48\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u673a\u5668\u6389\u7535\u91cd\u542f\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4 change buffer \u4e22\u5931\u5462\uff1fchange buffer \u4e22\u5931\u53ef\u4e0d\u662f\u5c0f\u4e8b\u513f\uff0c\u518d\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u53ef\u5c31\u6ca1\u6709\u4e86 merge \u8fc7\u7a0b\uff0c\u5c31\u7b49\u4e8e\u662f\u6570\u636e\u4e22\u5931\u4e86\u3002\u4f1a\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u628a\u4f60\u7684\u601d\u8003\u548c\u89c2\u70b9\u5199\u5728\u7559\u8a00\u533a\u91cc\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u7684\u672b\u5c3e\u548c\u4f60\u8ba8\u8bba\u8fd9\u4e2a\u95ee\u9898\u3002\u611f\u8c22\u4f60\u7684\u6536\u542c\uff0c\u4e5f\u6b22\u8fce\u4f60\u628a\u8fd9\u7bc7\u6587\u7ae0\u5206\u4eab\u7ed9\u66f4\u591a\u7684\u670b\u53cb\u4e00\u8d77\u9605\u8bfb\u3002</p> <p>\u56de\u7b54\uff1a</p> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u662f\u4e0d\u4f1a\u4e22\u5931\uff0c\u7559\u8a00\u533a\u7684\u5f88\u591a\u540c\u5b66\u90fd\u56de\u7b54\u5bf9\u4e86\u3002\u867d\u7136\u662f\u53ea\u66f4\u65b0\u5185\u5b58\uff0c\u4f46\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u628a change buffer \u7684\u64cd\u4f5c\u4e5f\u8bb0\u5f55\u5230 redo log \u91cc\u4e86\uff0c\u6240\u4ee5\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0cchange buffer \u4e5f\u80fd\u627e\u56de\u6765\u3002</p> <p>\u5728\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u95ee\u5230\uff0cmerge \u7684\u8fc7\u7a0b\u662f\u5426\u4f1a\u628a\u6570\u636e\u76f4\u63a5\u5199\u56de\u78c1\u76d8\uff0c\u8fd9\u662f\u4e2a\u597d\u95ee\u9898\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u4e3a\u4f60\u5206\u6790\u4e00\u4e0b\u3002</p> <p>merge \u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u9875\u5230\u5185\u5b58\uff08\u8001\u7248\u672c\u7684\u6570\u636e\u9875\uff09\uff1b</li> <li>\u4ece change buffer \u91cc\u627e\u51fa\u8fd9\u4e2a\u6570\u636e\u9875\u7684 change buffer \u8bb0\u5f55 (\u53ef\u80fd\u6709\u591a\u4e2a\uff09\uff0c\u4f9d\u6b21\u5e94\u7528\uff0c\u5f97\u5230\u65b0\u7248\u6570\u636e\u9875\uff1b</li> <li>\u5199 redo log\u3002\u8fd9\u4e2a redo log \u5305\u542b\u4e86\u6570\u636e\u7684\u53d8\u66f4\u548c change buffer \u7684\u53d8\u66f4\u3002</li> </ol> <p>\u5230\u8fd9\u91cc merge \u8fc7\u7a0b\u5c31\u7ed3\u675f\u4e86\u3002\u8fd9\u65f6\u5019\uff0c\u6570\u636e\u9875\u548c\u5185\u5b58\u4e2d change buffer \u5bf9\u5e94\u7684\u78c1\u76d8\u4f4d\u7f6e\u90fd\u8fd8\u6ca1\u6709\u4fee\u6539\uff0c\u5c5e\u4e8e\u810f\u9875\uff0c\u4e4b\u540e\u5404\u81ea\u5237\u56de\u81ea\u5df1\u7684\u7269\u7406\u6570\u636e\uff0c\u5c31\u662f\u53e6\u5916\u4e00\u4e2a\u8fc7\u7a0b\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/","title":"\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e8c\u90e8\u5206","text":"<p>Source</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e8c\u90e8\u5206</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#10-mysql","title":"10 MySQL\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u4f1a\u9009\u9519\u7d22\u5f15\uff1f","text":"<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7d22\u5f15\uff0c\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\u5728 MySQL \u4e2d\u4e00\u5f20\u8868\u5176\u5b9e\u662f\u53ef\u4ee5\u652f\u6301\u591a\u4e2a\u7d22\u5f15\u7684\u3002\u4f46\u662f\uff0c\u4f60\u5199 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5e76\u6ca1\u6709\u4e3b\u52a8\u6307\u5b9a\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\u662f\u7531 MySQL \u6765\u786e\u5b9a\u7684\u3002</p> <p>\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u78b0\u5230\u8fc7\u8fd9\u79cd\u60c5\u51b5\uff0c\u4e00\u6761\u672c\u6765\u53ef\u4ee5\u6267\u884c\u5f97\u5f88\u5feb\u7684\u8bed\u53e5\uff0c\u5374\u7531\u4e8e MySQL \u9009\u9519\u4e86\u7d22\u5f15\uff0c\u800c\u5bfc\u81f4\u6267\u884c\u901f\u5ea6\u53d8\u5f97\u5f88\u6162\uff1f</p> <p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\u5427\u3002</p> <p>\u6211\u4eec\u5148\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u8868\uff0c\u8868\u91cc\u6709 a\u3001b \u4e24\u4e2a\u5b57\u6bb5\uff0c\u5e76\u5206\u522b\u5efa\u4e0a\u7d22\u5f15\uff1a</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `b` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `b` (`b`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u5f80\u8868 t \u4e2d\u63d2\u5165 10 \u4e07\u884c\u8bb0\u5f55\uff0c\u53d6\u503c\u6309\u6574\u6570\u9012\u589e\uff0c\u5373\uff1a<code>(1,1,1)\uff0c(2,2,2)\uff0c(3,3,3)</code> \u76f4\u5230 <code>(100000,100000,100000)</code>\u3002</p> <p>\u6211\u662f\u7528\u5b58\u50a8\u8fc7\u7a0b\u6765\u63d2\u5165\u6570\u636e\u7684\uff0c\u8fd9\u91cc\u6211\u8d34\u51fa\u6765\u65b9\u4fbf\u4f60\u590d\u73b0\uff1a</p> <pre><code>delimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=100000)do\n    insert into t values(i, i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\ncall idata();\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5206\u6790\u4e00\u6761 SQL \u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select * from t where a between 10000 and 20000;\n</code></pre> <p>\u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u8fd8\u7528\u5206\u6790\u5417\uff0c\u5f88\u7b80\u5355\u5440\uff0ca \u4e0a\u6709\u7d22\u5f15\uff0c\u80af\u5b9a\u662f\u8981\u4f7f\u7528\u7d22\u5f15 a \u7684\u3002</p> <p>\u4f60\u8bf4\u5f97\u6ca1\u9519\uff0c\u4e0b\u9762\u663e\u793a\u7684\u5c31\u662f\u4f7f\u7528 explain \u547d\u4ee4\u770b\u5230\u7684\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p> <pre><code>mysql&gt; explain select * from t where a between 10000 and 20000;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u4e5f\u786e\u5b9e\u7b26\u5408\u9884\u671f\uff0ckey \u8fd9\u4e2a\u5b57\u6bb5\u503c\u662f <code>a</code>\uff0c\u8868\u793a\u4f18\u5316\u5668\u9009\u62e9\u4e86\u7d22\u5f15 a\u3002</p> <p>\u4e0d\u8fc7\u522b\u6025\uff0c\u8fd9\u4e2a\u6848\u4f8b\u4e0d\u4f1a\u8fd9\u4e48\u7b80\u5355\u3002\u5728\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u7684\u5305\u542b\u4e86 10 \u4e07\u884c\u6570\u636e\u7684\u8868\u4e0a\uff0c\u6211\u4eec\u518d\u505a\u5982\u4e0b\u64cd\u4f5c\u3002</p> <pre><code>%%{init: {\"theme\":\"gray\"}}%%\nsequenceDiagram\nparticipant Session A\nparticipant Session B\nparticipant Table\n\nSession A -&gt;&gt;Table: start transaction with consistent snapshot\nSession B -&gt;&gt;Table: delete from t;\nSession B -&gt;&gt;Table: call ibdata();\n\nSession B -&gt;&gt;Table: explain select * from t where a between 10000 and 20000\nSession A -&gt;&gt;Table: commit\n</code></pre> <p>\u8fd9\u91cc\uff0csession A \u7684\u64cd\u4f5c\u4f60\u5df2\u7ecf\u5f88\u719f\u6089\u4e86\uff0c\u5b83\u5c31\u662f\u5f00\u542f\u4e86\u4e00\u4e2a\u4e8b\u52a1\u3002\u968f\u540e\uff0csession B \u628a\u6570\u636e\u90fd\u5220\u9664\u540e\uff0c\u53c8\u8c03\u7528\u4e86 idata \u8fd9\u4e2a\u5b58\u50a8\u8fc7\u7a0b\uff0c\u63d2\u5165\u4e86 10 \u4e07\u884c\u6570\u636e\u3002</p> <p>\u8fd9\u65f6\u5019\uff0csession B \u7684\u67e5\u8be2\u8bed\u53e5 <code>select * from t where a between 10000 and 20000</code> \u5c31\u4e0d\u4f1a\u518d\u9009\u62e9\u7d22\u5f15 <code>a</code> \u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6765\u67e5\u770b\u4e00\u4e0b\u5177\u4f53\u7684\u6267\u884c\u60c5\u51b5\u3002</p> <p>\u4e3a\u4e86\u8bf4\u660e\u4f18\u5316\u5668\u9009\u62e9\u7684\u7ed3\u679c\u662f\u5426\u6b63\u786e\uff0c\u6211\u589e\u52a0\u4e86\u4e00\u4e2a\u5bf9\u7167\uff0c\u5373\uff1a\u4f7f\u7528 <code>force index(a)</code> \u6765\u8ba9\u4f18\u5316\u5668\u5f3a\u5236\u4f7f\u7528\u7d22\u5f15 <code>a</code></p> <p>\u4e0b\u9762\u7684\u4e09\u6761 SQL \u8bed\u53e5\uff0c\u5c31\u662f\u8fd9\u4e2a\u5b9e\u9a8c\u8fc7\u7a0b\u3002</p> <pre><code>set long_query_time=0;\nselect * from t where a between 10000 and 20000; /*Q1*/\nselect * from t force index(a) where a between 10000 and 20000;/*Q2*/\n</code></pre> <ul> <li>\u7b2c\u4e00\u53e5\uff0c\u662f\u5c06\u6162\u67e5\u8be2\u65e5\u5fd7\u7684\u9608\u503c\u8bbe\u7f6e\u4e3a 0\uff0c\u8868\u793a\u8fd9\u4e2a\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5165\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\uff1b</li> <li>\u7b2c\u4e8c\u53e5\uff0cQ1 \u662f session B \u539f\u6765\u7684\u67e5\u8be2\uff1b</li> <li>\u7b2c\u4e09\u53e5\uff0cQ2 \u662f\u52a0\u4e86 <code>force index(a)</code> \u6765\u548c session B \u539f\u6765\u7684\u67e5\u8be2\u8bed\u53e5\u6267\u884c\u60c5\u51b5\u5bf9\u6bd4\u3002</li> </ul> <p>\u5982\u56fe 3 \u6240\u793a\u662f\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u3002</p> <pre><code># Time: 2018-12-03T10:26:35.711526Z\n# User@Host: root[root] @ localhost [127.0.0.1] Id:\n4\n# Query_time: 0.040877 Lock_time: 0.000151 Rows_sent: 10001 Rows_examined: 100000\nSET timestamp=1543832795;\nselect * from t where a between 10000 and 20000;\n# Time: 2018-12-03T10:26:11.0287037\n# User@Host: root[root] @ localhost [127.0.0.1] Id:\n4\n# Query_time: 0.021076 Lock_time: 0.000163 Rows_sent: 10001 Rows_examined: 10001\nSET timestamp=1543832771;\nselect * from t force index(a) where a between 10000 and 20000;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cQ1 \u626b\u63cf\u4e86 10 \u4e07\u884c\uff0c\u663e\u7136\u662f\u8d70\u4e86\u5168\u8868\u626b\u63cf\uff0c\u6267\u884c\u65f6\u95f4\u662f 40 \u6beb\u79d2\u3002Q2 \u626b\u63cf\u4e86 10001 \u884c\uff0c\u6267\u884c\u4e86 21 \u6beb\u79d2\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u5728\u6ca1\u6709\u4f7f\u7528 <code>force index</code> \u7684\u65f6\u5019\uff0cMySQL \u7528\u9519\u4e86\u7d22\u5f15\uff0c\u5bfc\u81f4\u4e86\u66f4\u957f\u7684\u6267\u884c\u65f6\u95f4\u3002</p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u5e94\u7684\u662f\u6211\u4eec\u5e73\u5e38\u4e0d\u65ad\u5730\u5220\u9664\u5386\u53f2\u6570\u636e\u548c\u65b0\u589e\u6570\u636e\u7684\u573a\u666f\u3002\u8fd9\u65f6\uff0cMySQL \u7adf\u7136\u4f1a\u9009\u9519\u7d22\u5f15\uff0c\u662f\u4e0d\u662f\u6709\u70b9\u5947\u602a\u5462\uff1f\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u5947\u602a\u7684\u7ed3\u679c\u8bf4\u8d77\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_1","title":"\u4f18\u5316\u5668\u7684\u903b\u8f91","text":"<p>\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c31\u63d0\u5230\u8fc7\uff0c\u9009\u62e9\u7d22\u5f15\u662f\u4f18\u5316\u5668\u7684\u5de5\u4f5c\u3002</p> <p>\u800c\u4f18\u5316\u5668\u9009\u62e9\u7d22\u5f15\u7684\u76ee\u7684\uff0c\u662f\u627e\u5230\u4e00\u4e2a\u6700\u4f18\u7684\u6267\u884c\u65b9\u6848\uff0c\u5e76\u7528\u6700\u5c0f\u7684\u4ee3\u4ef7\u53bb\u6267\u884c\u8bed\u53e5\u3002\u5728\u6570\u636e\u5e93\u91cc\u9762\uff0c\u626b\u63cf\u884c\u6570\u662f\u5f71\u54cd\u6267\u884c\u4ee3\u4ef7\u7684\u56e0\u7d20\u4e4b\u4e00\u3002\u626b\u63cf\u7684\u884c\u6570\u8d8a\u5c11\uff0c\u610f\u5473\u7740\u8bbf\u95ee\u78c1\u76d8\u6570\u636e\u7684\u6b21\u6570\u8d8a\u5c11\uff0c\u6d88\u8017\u7684 CPU \u8d44\u6e90\u8d8a\u5c11\u3002</p> <p>\u5f53\u7136\uff0c\u626b\u63cf\u884c\u6570\u5e76\u4e0d\u662f\u552f\u4e00\u7684\u5224\u65ad\u6807\u51c6\uff0c\u4f18\u5316\u5668\u8fd8\u4f1a\u7ed3\u5408\u662f\u5426\u4f7f\u7528\u4e34\u65f6\u8868\u3001\u662f\u5426\u6392\u5e8f\u7b49\u56e0\u7d20\u8fdb\u884c\u7efc\u5408\u5224\u65ad\u3002</p> <p>\u6211\u4eec\u8fd9\u4e2a\u7b80\u5355\u7684\u67e5\u8be2\u8bed\u53e5\u5e76\u6ca1\u6709\u6d89\u53ca\u5230\u4e34\u65f6\u8868\u548c\u6392\u5e8f\uff0c\u6240\u4ee5 MySQL \u9009\u9519\u7d22\u5f15\u80af\u5b9a\u662f\u5728\u5224\u65ad\u626b\u63cf\u884c\u6570\u7684\u65f6\u5019\u51fa\u95ee\u9898\u4e86\u3002</p> <p>\u90a3\u4e48\uff0c\u95ee\u9898\u5c31\u662f\uff1a\u626b\u63cf\u884c\u6570\u662f\u600e\u4e48\u5224\u65ad\u7684\uff1f</p> <p>MySQL \u5728\u771f\u6b63\u5f00\u59cb\u6267\u884c\u8bed\u53e5\u4e4b\u524d\uff0c\u5e76\u4e0d\u80fd\u7cbe\u786e\u5730\u77e5\u9053\u6ee1\u8db3\u8fd9\u4e2a\u6761\u4ef6\u7684\u8bb0\u5f55\u6709\u591a\u5c11\u6761\uff0c\u800c\u53ea\u80fd\u6839\u636e\u7edf\u8ba1\u4fe1\u606f\u6765\u4f30\u7b97\u8bb0\u5f55\u6570\u3002</p> <p>\u8fd9\u4e2a\u7edf\u8ba1\u4fe1\u606f\u5c31\u662f\u7d22\u5f15\u7684\u201c\u533a\u5206\u5ea6\u201d\u3002\u663e\u7136\uff0c\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u8d8a\u591a\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u5c31\u8d8a\u597d\u3002\u800c\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u7684\u4e2a\u6570\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u201c\u57fa\u6570\u201d\uff08cardinality\uff09\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u57fa\u6570\u8d8a\u5927\uff0c\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u8d8a\u597d\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 show index \u65b9\u6cd5\uff0c\u770b\u5230\u4e00\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u3002\u5982\u56fe 4 \u6240\u793a\uff0c\u5c31\u662f\u8868 t \u7684 show index \u7684\u7ed3\u679c \u3002\u867d\u7136\u8fd9\u4e2a\u8868\u7684\u6bcf\u4e00\u884c\u7684\u4e09\u4e2a\u5b57\u6bb5\u503c\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u5728\u7edf\u8ba1\u4fe1\u606f\u4e2d\uff0c\u8fd9\u4e09\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u503c\u5e76\u4e0d\u540c\uff0c\u800c\u4e14\u5176\u5b9e\u90fd\u4e0d\u51c6\u786e\u3002</p> <pre><code>mysql&gt; show index from t;\n+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+\n| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |\n+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+\n| t     |          0 | PRIMARY  |            1 | id          | A         |      100256 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |\n| t     |          1 | a        |            1 | a           | A         |      100256 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |\n| t     |          1 | b        |            1 | b           | A         |       98190 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |\n+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+\n</code></pre> <p>\u90a3\u4e48\uff0cMySQL \u662f\u600e\u6837\u5f97\u5230\u7d22\u5f15\u7684\u57fa\u6570\u7684\u5462\uff1f\u8fd9\u91cc\uff0c\u6211\u7ed9\u4f60\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b MySQL \u91c7\u6837\u7edf\u8ba1\u7684\u65b9\u6cd5\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8981\u91c7\u6837\u7edf\u8ba1\u5462\uff1f\u56e0\u4e3a\u628a\u6574\u5f20\u8868\u53d6\u51fa\u6765\u4e00\u884c\u884c\u7edf\u8ba1\uff0c\u867d\u7136\u53ef\u4ee5\u5f97\u5230\u7cbe\u786e\u7684\u7ed3\u679c\uff0c\u4f46\u662f\u4ee3\u4ef7\u592a\u9ad8\u4e86\uff0c\u6240\u4ee5\u53ea\u80fd\u9009\u62e9\u201c\u91c7\u6837\u7edf\u8ba1\u201d\u3002</p> <p>\u91c7\u6837\u7edf\u8ba1\u7684\u65f6\u5019\uff0cInnoDB \u9ed8\u8ba4\u4f1a\u9009\u62e9 N \u4e2a\u6570\u636e\u9875\uff0c\u7edf\u8ba1\u8fd9\u4e9b\u9875\u9762\u4e0a\u7684\u4e0d\u540c\u503c\uff0c\u5f97\u5230\u4e00\u4e2a\u5e73\u5747\u503c\uff0c\u7136\u540e\u4e58\u4ee5\u8fd9\u4e2a\u7d22\u5f15\u7684\u9875\u9762\u6570\uff0c\u5c31\u5f97\u5230\u4e86\u8fd9\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u3002</p> <p>\u800c\u6570\u636e\u8868\u662f\u4f1a\u6301\u7eed\u66f4\u65b0\u7684\uff0c\u7d22\u5f15\u7edf\u8ba1\u4fe1\u606f\u4e5f\u4e0d\u4f1a\u56fa\u5b9a\u4e0d\u53d8\u3002\u6240\u4ee5\uff0c\u5f53\u53d8\u66f4\u7684\u6570\u636e\u884c\u6570\u8d85\u8fc7 1/M \u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u89e6\u53d1\u91cd\u65b0\u505a\u4e00\u6b21\u7d22\u5f15\u7edf\u8ba1\u3002</p> <p>\u5728 MySQL \u4e2d\uff0c\u6709\u4e24\u79cd\u5b58\u50a8\u7d22\u5f15\u7edf\u8ba1\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u53c2\u6570 <code>innodb_stats_persistent</code> \u7684\u503c\u6765\u9009\u62e9\uff1a</p> <ul> <li>\u8bbe\u7f6e\u4e3a on \u7684\u65f6\u5019\uff0c\u8868\u793a\u7edf\u8ba1\u4fe1\u606f\u4f1a\u6301\u4e45\u5316\u5b58\u50a8\u3002\u8fd9\u65f6\uff0c\u9ed8\u8ba4\u7684 N \u662f 20\uff0cM \u662f 10\u3002</li> <li>\u8bbe\u7f6e\u4e3a off \u7684\u65f6\u5019\uff0c\u8868\u793a\u7edf\u8ba1\u4fe1\u606f\u53ea\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002\u8fd9\u65f6\uff0c\u9ed8\u8ba4\u7684 N \u662f 8\uff0cM \u662f 16\u3002</li> </ul> <p>\u7531\u4e8e\u662f\u91c7\u6837\u7edf\u8ba1\uff0c\u6240\u4ee5\u4e0d\u7ba1 N \u662f 20 \u8fd8\u662f 8\uff0c\u8fd9\u4e2a\u57fa\u6570\u90fd\u662f\u5f88\u5bb9\u6613\u4e0d\u51c6\u7684\u3002</p> <p>\u4f46\uff0c\u8fd9\u8fd8\u4e0d\u662f\u5168\u90e8\u3002</p> <p>\u4f60\u53ef\u4ee5\u4ece\u4e0a\u8868\u4e2d\u770b\u5230\uff0c\u8fd9\u6b21\u7684\u7d22\u5f15\u7edf\u8ba1\u503c\uff08cardinality \u5217\uff09\u867d\u7136\u4e0d\u591f\u7cbe\u786e\uff0c\u4f46\u5927\u4f53\u4e0a\u8fd8\u662f\u5dee\u4e0d\u591a\u7684\uff0c\u9009\u9519\u7d22\u5f15\u4e00\u5b9a\u8fd8\u6709\u522b\u7684\u539f\u56e0\u3002</p> <p>\u5176\u5b9e\u7d22\u5f15\u7edf\u8ba1\u53ea\u662f\u4e00\u4e2a\u8f93\u5165\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5177\u4f53\u7684\u8bed\u53e5\u6765\u8bf4\uff0c\u4f18\u5316\u5668\u8fd8\u8981\u5224\u65ad\uff0c\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u672c\u8eab\u8981\u626b\u63cf\u591a\u5c11\u884c\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b\u4f18\u5316\u5668\u9884\u4f30\u7684\uff0c\u8fd9\u4e24\u4e2a\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u662f\u591a\u5c11\u3002</p> <pre><code>mysql&gt; explain select * from t where a between 10000 and 20000;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+\n|  1 | SIMPLE      | t     | NULL       | ALL   | a             | NULL | NULL    | NULL | 104620|   100.00 | Using where |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+\n1 row in set, 1 warning (0.00 sec)\n\nmysql&gt; explain select * from t force index(a)  where a between 10000 and 20000;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 37116 |   100.00 | Using index condition |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>rows \u8fd9\u4e2a\u5b57\u6bb5\u8868\u793a\u7684\u662f\u9884\u8ba1\u626b\u63cf\u884c\u6570\u3002</p> <p>\u5176\u4e2d\uff0cQ1 \u7684\u7ed3\u679c\u8fd8\u662f\u7b26\u5408\u9884\u671f\u7684\uff0crows \u7684\u503c\u662f 104620\uff1b\u4f46\u662f Q2 \u7684 rows \u503c\u662f 37116\uff0c\u504f\u5dee\u5c31\u5927\u4e86\u3002\u800c\u56fe 1 \u4e2d\u6211\u4eec\u7528 explain \u547d\u4ee4\u770b\u5230\u7684 rows \u662f\u53ea\u6709 10001 \u884c\uff0c\u662f\u8fd9\u4e2a\u504f\u5dee\u8bef\u5bfc\u4e86\u4f18\u5316\u5668\u7684\u5224\u65ad\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u53ef\u80fd\u4f60\u7684\u7b2c\u4e00\u4e2a\u7591\u95ee\u4e0d\u662f\u4e3a\u4ec0\u4e48\u4e0d\u51c6\uff0c\u800c\u662f\u4f18\u5316\u5668\u4e3a\u4ec0\u4e48\u653e\u7740\u626b\u63cf 37000 \u884c\u7684\u6267\u884c\u8ba1\u5212\u4e0d\u7528\uff0c\u5374\u9009\u62e9\u4e86\u626b\u63cf\u884c\u6570\u662f 100000 \u7684\u6267\u884c\u8ba1\u5212\u5462\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a\uff0c\u6bcf\u6b21\u4ece\u7d22\u5f15 a \u4e0a\u62ff\u5230\u4e00\u4e2a\u503c\uff0c\u90fd\u8981\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u67e5\u51fa\u6574\u884c\u6570\u636e\uff0c\u8fd9\u4e2a\u4ee3\u4ef7\u4f18\u5316\u5668\u4e5f\u8981\u7b97\u8fdb\u53bb\u7684\u3002</p> <p>\u800c\u5982\u679c\u9009\u62e9\u626b\u63cf 10 \u4e07\u884c\uff0c\u662f\u76f4\u63a5\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u626b\u63cf\u7684\uff0c\u6ca1\u6709\u989d\u5916\u7684\u4ee3\u4ef7\u3002</p> <p>\u4f18\u5316\u5668\u4f1a\u4f30\u7b97\u8fd9\u4e24\u4e2a\u9009\u62e9\u7684\u4ee3\u4ef7\uff0c\u4ece\u7ed3\u679c\u770b\u6765\uff0c\u4f18\u5316\u5668\u8ba4\u4e3a\u76f4\u63a5\u626b\u63cf\u4e3b\u952e\u7d22\u5f15\u66f4\u5feb\u3002\u5f53\u7136\uff0c\u4ece\u6267\u884c\u65f6\u95f4\u770b\u6765\uff0c\u8fd9\u4e2a\u9009\u62e9\u5e76\u4e0d\u662f\u6700\u4f18\u7684\u3002</p> <p>\u4f7f\u7528\u666e\u901a\u7d22\u5f15\u9700\u8981\u628a\u56de\u8868\u7684\u4ee3\u4ef7\u7b97\u8fdb\u53bb\uff0c\u5728\u56fe 1 \u6267\u884c explain \u7684\u65f6\u5019\uff0c\u4e5f\u8003\u8651\u4e86\u8fd9\u4e2a\u7b56\u7565\u7684\u4ee3\u4ef7 \uff0c\u4f46\u56fe 1 \u7684\u9009\u62e9\u662f\u5bf9\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u7b56\u7565\u5e76\u6ca1\u6709\u95ee\u9898\u3002</p> <p>\u6240\u4ee5\u51a4\u6709\u5934\u503a\u6709\u4e3b\uff0cMySQL \u9009\u9519\u7d22\u5f15\uff0c\u8fd9\u4ef6\u4e8b\u513f\u8fd8\u5f97\u5f52\u548e\u5230\u6ca1\u80fd\u51c6\u786e\u5730\u5224\u65ad\u51fa\u626b\u63cf\u884c\u6570\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u4f1a\u5f97\u5230\u9519\u8bef\u7684\u626b\u63cf\u884c\u6570\uff0c\u8fd9\u4e2a\u539f\u56e0\u5c31\u4f5c\u4e3a\u8bfe\u540e\u95ee\u9898\uff0c\u7559\u7ed9\u4f60\u53bb\u5206\u6790\u4e86\u3002</p> <p>\u65e2\u7136\u662f\u7edf\u8ba1\u4fe1\u606f\u4e0d\u5bf9\uff0c\u90a3\u5c31\u4fee\u6b63\u3002<code>analyze table t</code> \u547d\u4ee4\uff0c\u53ef\u4ee5\u7528\u6765\u91cd\u65b0\u7edf\u8ba1\u7d22\u5f15\u4fe1\u606f\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u6267\u884c\u6548\u679c\u3002</p> <pre><code>mysql&gt; analyze table t;\n+--------+---------+----------+----------+\n| Table  | Op      | Msg_type | Msg_text |\n+--------+---------+----------+----------+\n| test.t | analyze | status   | OK       |\n+--------+---------+----------+----------+\n1 row in set (0.00 sec)\n\nmysql&gt; explain select * from t where a between 10000 and 20000;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u8fd9\u56de\u5bf9\u4e86\u3002</p> <p>\u6240\u4ee5\u5728\u5b9e\u8df5\u4e2d\uff0c\u5982\u679c\u4f60\u53d1\u73b0 explain \u7684\u7ed3\u679c\u9884\u4f30\u7684 rows \u503c\u8ddf\u5b9e\u9645\u60c5\u51b5\u5dee\u8ddd\u6bd4\u8f83\u5927\uff0c\u53ef\u4ee5\u91c7\u7528\u8fd9\u4e2a\u65b9\u6cd5\u6765\u5904\u7406\u3002</p> <p>\u5176\u5b9e\uff0c\u5982\u679c\u53ea\u662f\u7d22\u5f15\u7edf\u8ba1\u4e0d\u51c6\u786e\uff0c\u901a\u8fc7 analyze \u547d\u4ee4\u53ef\u4ee5\u89e3\u51b3\u5f88\u591a\u95ee\u9898\uff0c\u4f46\u662f\u524d\u9762\u6211\u4eec\u8bf4\u4e86\uff0c\u4f18\u5316\u5668\u53ef\u4e0d\u6b62\u662f\u770b\u626b\u63cf\u884c\u6570\u3002</p> <p>\u4f9d\u7136\u662f\u57fa\u4e8e\u8fd9\u4e2a\u8868 t\uff0c\u6211\u4eec\u770b\u770b\u53e6\u5916\u4e00\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>select * from t where (a between 1 and 1000)  \nand (b between 50000 and 100000) order by b limit 1;\n</code></pre> <p>\u4ece\u6761\u4ef6\u4e0a\u770b\uff0c\u8fd9\u4e2a\u67e5\u8be2\u6ca1\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u56e0\u6b64\u4f1a\u8fd4\u56de\u7a7a\u96c6\u5408\u3002</p> <p>\u5728\u5f00\u59cb\u6267\u884c\u8fd9\u6761\u8bed\u53e5\u4e4b\u524d\uff0c\u4f60\u53ef\u4ee5\u5148\u8bbe\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u6765\u9009\u62e9\u7d22\u5f15\uff0c\u4f1a\u9009\u62e9\u54ea\u4e00\u4e2a\u5462\uff1f</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b a\u3001b \u8fd9\u4e24\u4e2a\u7d22\u5f15\u7684\u7ed3\u6784\u56fe\u3002</p> <p></p> <p>\u56fe 7 a\u3001b \u7d22\u5f15\u7684\u7ed3\u6784\u56fe</p> <p>\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a \u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u5c31\u662f\u626b\u63cf\u7d22\u5f15 a \u7684\u524d 1000 \u4e2a\u503c\uff0c\u7136\u540e\u53d6\u5230\u5bf9\u5e94\u7684 id\uff0c\u518d\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u67e5\u51fa\u6bcf\u4e00\u884c\uff0c\u7136\u540e\u6839\u636e\u5b57\u6bb5 b \u6765\u8fc7\u6ee4\u3002\u663e\u7136\u8fd9\u6837\u9700\u8981\u626b\u63cf 1000 \u884c\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u7d22\u5f15 b \u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u5c31\u662f\u626b\u63cf\u7d22\u5f15 b \u7684\u6700\u540e 50001 \u4e2a\u503c\uff0c\u4e0e\u4e0a\u9762\u7684\u6267\u884c\u8fc7\u7a0b\u76f8\u540c\uff0c\u4e5f\u662f\u9700\u8981\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53d6\u503c\u518d\u5224\u65ad\uff0c\u6240\u4ee5\u9700\u8981\u626b\u63cf 50001 \u884c\u3002</p> <p>\u6240\u4ee5\u4f60\u4e00\u5b9a\u4f1a\u60f3\uff0c\u5982\u679c\u4f7f\u7528\u7d22\u5f15 a \u7684\u8bdd\uff0c\u6267\u884c\u901f\u5ea6\u660e\u663e\u4f1a\u5feb\u5f88\u591a\u3002\u90a3\u4e48\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u770b\u770b\u5230\u5e95\u662f\u4e0d\u662f\u8fd9\u4e48\u4e00\u56de\u4e8b\u513f\u3002</p> <p>\u56fe 8 \u662f\u6267\u884c explain \u7684\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain select * from t where (a between 1 and 1000) and (b between 50000 and 100000) order by b limit 1;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                              |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+\n|  1 | SIMPLE      | t     | NULL       | range | a,b           | b    | 5       | NULL | 50128 |     1.00 | Using index condition; Using where |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+------------------------------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd4\u56de\u7ed3\u679c\u4e2d key \u5b57\u6bb5\u663e\u793a\uff0c\u8fd9\u6b21\u4f18\u5316\u5668\u9009\u62e9\u4e86\u7d22\u5f15 b\uff0c\u800c rows \u5b57\u6bb5\u663e\u793a\u9700\u8981\u626b\u63cf\u7684\u884c\u6570\u662f 50128\u3002</p> <p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a\u7ed3\u8bba\uff1a</p> <ol> <li>\u626b\u63cf\u884c\u6570\u7684\u4f30\u8ba1\u503c\u4f9d\u7136\u4e0d\u51c6\u786e\uff1b</li> <li>\u8fd9\u4e2a\u4f8b\u5b50\u91cc MySQL \u53c8\u9009\u9519\u4e86\u7d22\u5f15\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_2","title":"\u7d22\u5f15\u9009\u62e9\u5f02\u5e38\u548c\u5904\u7406","text":"<p>\u5176\u5b9e\u5927\u591a\u6570\u65f6\u5019\u4f18\u5316\u5668\u90fd\u80fd\u627e\u5230\u6b63\u786e\u7684\u7d22\u5f15\uff0c\u4f46\u5076\u5c14\u4f60\u8fd8\u662f\u4f1a\u78b0\u5230\u6211\u4eec\u4e0a\u9762\u4e3e\u4f8b\u7684\u8fd9\u4e24\u79cd\u60c5\u51b5\uff1a\u539f\u672c\u53ef\u4ee5\u6267\u884c\u5f97\u5f88\u5feb\u7684 SQL \u8bed\u53e5\uff0c\u6267\u884c\u901f\u5ea6\u5374\u6bd4\u4f60\u9884\u671f\u7684\u6162\u5f88\u591a\uff0c\u4f60\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p> <p>\u4e00\u79cd\u65b9\u6cd5\u662f\uff0c\u50cf\u6211\u4eec\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u91c7\u7528 force index \u5f3a\u884c\u9009\u62e9\u4e00\u4e2a\u7d22\u5f15\u3002MySQL \u4f1a\u6839\u636e\u8bcd\u6cd5\u89e3\u6790\u7684\u7ed3\u679c\u5206\u6790\u51fa\u53ef\u80fd\u53ef\u4ee5\u4f7f\u7528\u7684\u7d22\u5f15\u4f5c\u4e3a\u5019\u9009\u9879\uff0c\u7136\u540e\u5728\u5019\u9009\u5217\u8868\u4e2d\u4f9d\u6b21\u5224\u65ad\u6bcf\u4e2a\u7d22\u5f15\u9700\u8981\u626b\u63cf\u591a\u5c11\u884c\u3002\u5982\u679c force index \u6307\u5b9a\u7684\u7d22\u5f15\u5728\u5019\u9009\u7d22\u5f15\u5217\u8868\u4e2d\uff0c\u5c31\u76f4\u63a5\u9009\u62e9\u8fd9\u4e2a\u7d22\u5f15\uff0c\u4e0d\u518d\u8bc4\u4f30\u5176\u4ed6\u7d22\u5f15\u7684\u6267\u884c\u4ee3\u4ef7\u3002</p> <p>\u6211\u4eec\u6765\u770b\u770b\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u3002\u521a\u5f00\u59cb\u5206\u6790\u65f6\uff0c\u6211\u4eec\u8ba4\u4e3a\u9009\u62e9\u7d22\u5f15 a \u4f1a\u66f4\u597d\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u770b\u770b\u6267\u884c\u6548\u679c\uff1a</p> <pre><code>mysql&gt; select * from t where a between 1 and 1000 and b between 50000 and 100000 order by b limit 1;\nEmpty set (0.04 sec)\n\nmysql&gt; select * from t force index(a)  where a between 1 and 1000 and b between 50000 and 100000 order by b limit 1;\nEmpty set (0.01 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u539f\u672c\u8bed\u53e5\u9700\u8981\u6267\u884c 0.04 \u79d2\uff0c\u800c\u5f53\u4f60\u4f7f\u7528 <code>force index(a)</code> \u7684\u65f6\u5019\uff0c\u53ea\u7528\u4e86 0.01 \u79d2\uff0c\u6bd4\u4f18\u5316\u5668\u7684\u9009\u62e9\u5feb\u4e86 4 \u500d\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f18\u5316\u5668\u6ca1\u6709\u9009\u62e9\u6b63\u786e\u7684\u7d22\u5f15\uff0cforce index \u8d77\u5230\u4e86\u201c\u77eb\u6b63\u201d\u7684\u4f5c\u7528\u3002</p> <p>\u4e0d\u8fc7\u5f88\u591a\u7a0b\u5e8f\u5458\u4e0d\u559c\u6b22\u4f7f\u7528 force index\uff0c\u4e00\u6765\u8fd9\u4e48\u5199\u4e0d\u4f18\u7f8e\uff0c\u4e8c\u6765\u5982\u679c\u7d22\u5f15\u6539\u4e86\u540d\u5b57\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4e5f\u5f97\u6539\uff0c\u663e\u5f97\u5f88\u9ebb\u70e6\u3002\u800c\u4e14\u5982\u679c\u4ee5\u540e\u8fc1\u79fb\u5230\u522b\u7684\u6570\u636e\u5e93\u7684\u8bdd\uff0c\u8fd9\u4e2a\u8bed\u6cd5\u8fd8\u53ef\u80fd\u4f1a\u4e0d\u517c\u5bb9\u3002</p> <p>\u4f46\u5176\u5b9e\u4f7f\u7528 force index \u6700\u4e3b\u8981\u7684\u95ee\u9898\u8fd8\u662f\u53d8\u66f4\u7684\u53ca\u65f6\u6027\u3002\u56e0\u4e3a\u9009\u9519\u7d22\u5f15\u7684\u60c5\u51b5\u8fd8\u662f\u6bd4\u8f83\u5c11\u51fa\u73b0\u7684\uff0c\u6240\u4ee5\u5f00\u53d1\u7684\u65f6\u5019\u901a\u5e38\u4e0d\u4f1a\u5148\u5199\u4e0a force index\u3002\u800c\u662f\u7b49\u5230\u7ebf\u4e0a\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\uff0c\u4f60\u624d\u4f1a\u518d\u53bb\u4fee\u6539 SQL \u8bed\u53e5\u3001\u52a0\u4e0a force index\u3002\u4f46\u662f\u4fee\u6539\u4e4b\u540e\u8fd8\u8981\u6d4b\u8bd5\u548c\u53d1\u5e03\uff0c\u5bf9\u4e8e\u751f\u4ea7\u7cfb\u7edf\u6765\u8bf4\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u591f\u654f\u6377\u3002</p> <p>\u6240\u4ee5\uff0c\u6570\u636e\u5e93\u7684\u95ee\u9898\u6700\u597d\u8fd8\u662f\u5728\u6570\u636e\u5e93\u5185\u90e8\u6765\u89e3\u51b3\u3002\u90a3\u4e48\uff0c\u5728\u6570\u636e\u5e93\u91cc\u9762\u8be5\u600e\u6837\u89e3\u51b3\u5462\uff1f</p> <p>\u65e2\u7136\u4f18\u5316\u5668\u653e\u5f03\u4e86\u4f7f\u7528\u7d22\u5f15 a\uff0c\u8bf4\u660e a \u8fd8\u4e0d\u591f\u5408\u9002\uff0c\u6240\u4ee5</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5c31\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4fee\u6539\u8bed\u53e5\uff0c\u5f15\u5bfc MySQL \u4f7f\u7528\u6211\u4eec\u671f\u671b\u7684\u7d22\u5f15\u3002</p> <p>\u6bd4\u5982\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u663e\u7136\u628a <code>order by b limit 1</code> \u6539\u6210  <code>order by b,a limit 1</code> \uff0c\u8bed\u4e49\u7684\u903b\u8f91\u662f\u76f8\u540c\u7684\u3002</p> <p>\u6211\u4eec\u6765\u770b\u770b\u6539\u4e4b\u540e\u7684\u6548\u679c\uff1a</p> <pre><code>mysql&gt; explain select * from t where a between 1 and 1000 and b between 50000 and 100000 order by b limit 1;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | \n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+\n|  1 | SIMPLE      | t     | NULL       | range | a,b           | b    | 5       | NULL | 50128 |     1.00 | \n+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+\n1 row in set, 1 warning (0.00 sec)\n\nmysql&gt; explain select * from t where a between 1 and 1000 and b between 50000 and 100000 order by b,a limit 1;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+\n|  1 | SIMPLE      | t     | NULL       | range | a,b           | a    | 5       | NULL | 1000 |    50.00 |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u4e4b\u524d\u4f18\u5316\u5668\u9009\u62e9\u4f7f\u7528\u7d22\u5f15 b\uff0c\u662f\u56e0\u4e3a\u5b83\u8ba4\u4e3a\u4f7f\u7528\u7d22\u5f15 b \u53ef\u4ee5\u907f\u514d\u6392\u5e8f\uff08b \u672c\u8eab\u662f\u7d22\u5f15\uff0c\u5df2\u7ecf\u662f\u6709\u5e8f\u7684\u4e86\uff0c\u5982\u679c\u9009\u62e9\u7d22\u5f15 b \u7684\u8bdd\uff0c\u4e0d\u9700\u8981\u518d\u505a\u6392\u5e8f\uff0c\u53ea\u9700\u8981\u904d\u5386\uff09\uff0c\u6240\u4ee5\u5373\u4f7f\u626b\u63cf\u884c\u6570\u591a\uff0c\u4e5f\u5224\u5b9a\u4e3a\u4ee3\u4ef7\u66f4\u5c0f\u3002</p> <p>\u73b0\u5728 order by b,a \u8fd9\u79cd\u5199\u6cd5\uff0c\u8981\u6c42\u6309\u7167 b,a \u6392\u5e8f\uff0c\u5c31\u610f\u5473\u7740\u4f7f\u7528\u8fd9\u4e24\u4e2a\u7d22\u5f15\u90fd\u9700\u8981\u6392\u5e8f\u3002\u56e0\u6b64\uff0c\u626b\u63cf\u884c\u6570\u6210\u4e86\u5f71\u54cd\u51b3\u7b56\u7684\u4e3b\u8981\u6761\u4ef6\uff0c\u4e8e\u662f\u6b64\u65f6\u4f18\u5316\u5668\u9009\u4e86\u53ea\u9700\u8981\u626b\u63cf 1000 \u884c\u7684\u7d22\u5f15 a\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u79cd\u4fee\u6539\u5e76\u4e0d\u662f\u901a\u7528\u7684\u4f18\u5316\u624b\u6bb5\uff0c\u53ea\u662f\u521a\u597d\u5728\u8fd9\u4e2a\u8bed\u53e5\u91cc\u9762\u6709 limit 1\uff0c\u56e0\u6b64\u5982\u679c\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c order by b limit 1 \u548c order by b,a limit 1 \u90fd\u4f1a\u8fd4\u56de b \u662f\u6700\u5c0f\u7684\u90a3\u4e00\u884c\uff0c\u903b\u8f91\u4e0a\u4e00\u81f4\uff0c\u624d\u53ef\u4ee5\u8fd9\u4e48\u505a\u3002</p> <p>\u5982\u679c\u4f60\u89c9\u5f97\u4fee\u6539\u8bed\u4e49\u8fd9\u4ef6\u4e8b\u513f\u4e0d\u592a\u597d\uff0c\u8fd9\u91cc\u8fd8\u6709\u4e00\u79cd\u6539\u6cd5\uff0c\u4e0b\u9762\u662f\u6267\u884c\u6548\u679c\u3002</p> <pre><code>mysql&gt; select * from  (select * from t where (a between 1 and 1000)  \n       and (b between 50000 and 100000) order by b limit 100) alias limit 1;\n+----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+\n| id | select_type | table      | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered |\n+----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+\n|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL   | NULL          | NULL | NULL    | NULL |  100 |   100.00 |\n|  2 | DERIVED     | t          | NULL       | range | a,b           | a    | 5       | NULL | 1000 |    50.00 |\n+----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+\n2 rows in set, 1 warning (0.00 sec)\n</code></pre> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6211\u4eec\u7528 limit 100 \u8ba9\u4f18\u5316\u5668\u610f\u8bc6\u5230\uff0c\u4f7f\u7528 b \u7d22\u5f15\u4ee3\u4ef7\u662f\u5f88\u9ad8\u7684\u3002\u5176\u5b9e\u662f\u6211\u4eec\u6839\u636e\u6570\u636e\u7279\u5f81\u8bf1\u5bfc\u4e86\u4e00\u4e0b\u4f18\u5316\u5668\uff0c\u4e5f\u4e0d\u5177\u5907\u901a\u7528\u6027\u3002</p> <p>\u7b2c\u4e09\u79cd\u65b9\u6cd5\u662f\uff0c\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u66f4\u5408\u9002\u7684\u7d22\u5f15\uff0c\u6765\u63d0\u4f9b\u7ed9\u4f18\u5316\u5668\u505a\u9009\u62e9\uff0c\u6216\u5220\u6389\u8bef\u7528\u7684\u7d22\u5f15\u3002</p> <p>\u4e0d\u8fc7\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u6ca1\u6709\u627e\u5230\u901a\u8fc7\u65b0\u589e\u7d22\u5f15\u6765\u6539\u53d8\u4f18\u5316\u5668\u884c\u4e3a\u7684\u65b9\u6cd5\u3002\u8fd9\u79cd\u60c5\u51b5\u5176\u5b9e\u6bd4\u8f83\u5c11\uff0c\u5c24\u5176\u662f\u7ecf\u8fc7 DBA \u7d22\u5f15\u4f18\u5316\u8fc7\u7684\u5e93\uff0c\u518d\u78b0\u5230\u8fd9\u4e2a bug\uff0c\u627e\u5230\u4e00\u4e2a\u66f4\u5408\u9002\u7684\u7d22\u5f15\u4e00\u822c\u6bd4\u8f83\u96be\u3002</p> <p>\u5982\u679c\u6211\u8bf4\u8fd8\u6709\u4e00\u4e2a\u65b9\u6cd5\u662f\u5220\u6389\u7d22\u5f15 b\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u597d\u7b11\u3002\u4f46\u5b9e\u9645\u4e0a\u6211\u78b0\u5230\u8fc7\u4e24\u6b21\u8fd9\u6837\u7684\u4f8b\u5b50\uff0c\u6700\u7ec8\u662f DBA \u8ddf\u4e1a\u52a1\u5f00\u53d1\u6c9f\u901a\u540e\uff0c\u53d1\u73b0\u8fd9\u4e2a\u4f18\u5316\u5668\u9519\u8bef\u9009\u62e9\u7684\u7d22\u5f15\u5176\u5b9e\u6839\u672c\u6ca1\u6709\u5fc5\u8981\u5b58\u5728\uff0c\u4e8e\u662f\u5c31\u5220\u6389\u4e86\u8fd9\u4e2a\u7d22\u5f15\uff0c\u4f18\u5316\u5668\u4e5f\u5c31\u91cd\u65b0\u9009\u62e9\u5230\u4e86\u6b63\u786e\u7684\u7d22\u5f15\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_3","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u6211\u4eec\u4e00\u8d77\u804a\u4e86\u804a\u7d22\u5f15\u7edf\u8ba1\u7684\u66f4\u65b0\u673a\u5236\uff0c\u5e76\u63d0\u5230\u4e86\u4f18\u5316\u5668\u5b58\u5728\u9009\u9519\u7d22\u5f15\u7684\u53ef\u80fd\u6027\u3002</p> <p>\u5bf9\u4e8e\u7531\u4e8e\u7d22\u5f15\u7edf\u8ba1\u4fe1\u606f\u4e0d\u51c6\u786e\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u7528 <code>analyze table</code> \u6765\u89e3\u51b3\u3002</p> <p>\u800c\u5bf9\u4e8e\u5176\u4ed6\u4f18\u5316\u5668\u8bef\u5224\u7684\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u5728\u5e94\u7528\u7aef\u7528 <code>force index</code> \u6765\u5f3a\u884c\u6307\u5b9a\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u8bed\u53e5\u6765\u5f15\u5bfc\u4f18\u5316\u5668\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0\u6216\u8005\u5220\u9664\u7d22\u5f15\u6765\u7ed5\u8fc7\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u540e\u9762\u7684\u51e0\u4e2a\u4f8b\u5b50\uff0c\u600e\u4e48\u90fd\u6ca1\u6709\u5c55\u5f00\u8bf4\u660e\u5176\u539f\u7406\u3002\u6211\u8981\u544a\u8bc9\u4f60\u7684\u662f\uff0c\u4eca\u5929\u7684\u8bdd\u9898\uff0c\u6211\u4eec\u9762\u5bf9\u7684\u662f MySQL \u7684 bug\uff0c\u6bcf\u4e00\u4e2a\u5c55\u5f00\u90fd\u5fc5\u987b\u6df1\u5165\u5230\u4e00\u884c\u884c\u4ee3\u7801\u53bb\u91cf\u5316\uff0c\u5b9e\u5728\u4e0d\u662f\u6211\u4eec\u5728\u8fd9\u91cc\u5e94\u8be5\u505a\u7684\u4e8b\u60c5\u3002</p> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u3002\u524d\u9762\u6211\u4eec\u5728\u6784\u9020\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u7684\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 session A \u7684\u914d\u5408\uff0c\u8ba9 session B \u5220\u9664\u6570\u636e\u540e\u53c8\u91cd\u65b0\u63d2\u5165\u4e86\u4e00\u904d\u6570\u636e\uff0c\u7136\u540e\u5c31\u53d1\u73b0 explain \u7ed3\u679c\u4e2d\uff0crows \u5b57\u6bb5\u4ece 10001 \u53d8\u6210 37000 \u591a\u3002</p> <p>\u800c\u5982\u679c\u6ca1\u6709 session A \u7684\u914d\u5408\uff0c\u53ea\u662f\u5355\u72ec\u6267\u884c delete from t \u3001call idata()\u3001explain \u8fd9\u4e09\u53e5\u8bdd\uff0c\u4f1a\u770b\u5230 rows \u5b57\u6bb5\u5176\u5b9e\u8fd8\u662f 10000 \u5de6\u53f3\u3002\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u8fd9\u4e2a\u7ed3\u679c\u3002</p> <p>\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f\u4e5f\u8bf7\u4f60\u5206\u6790\u4e00\u4e0b\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#11","title":"11 \u600e\u4e48\u7ed9\u5b57\u7b26\u4e32\u5b57\u6bb5\u52a0\u7d22\u5f15\uff1f","text":"<p>\u73b0\u5728\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u7cfb\u7edf\u90fd\u652f\u6301\u90ae\u7bb1\u767b\u5f55\uff0c\u5982\u4f55\u5728\u90ae\u7bb1\u8fd9\u6837\u7684\u5b57\u6bb5\u4e0a\u5efa\u7acb\u5408\u7406\u7684\u7d22\u5f15\uff0c\u662f\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\u3002</p> <p>\u5047\u8bbe\uff0c\u4f60\u73b0\u5728\u7ef4\u62a4\u4e00\u4e2a\u652f\u6301\u90ae\u7bb1\u767b\u5f55\u7684\u7cfb\u7edf\uff0c\u7528\u6237\u8868\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a</p> <pre><code>mysql&gt; create table SUser(\nID bigint unsigned primary key,\nemail varchar(64), \n... \n)engine=innodb;\n</code></pre> <p>\u7531\u4e8e\u8981\u4f7f\u7528\u90ae\u7bb1\u767b\u5f55\uff0c\u6240\u4ee5\u4e1a\u52a1\u4ee3\u7801\u4e2d\u4e00\u5b9a\u4f1a\u51fa\u73b0\u7c7b\u4f3c\u4e8e\u8fd9\u6837\u7684\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select f1, f2 from SUser where email='xxx';\n</code></pre> <p>\u4ece\u7b2c 4 \u548c\u7b2c 5 \u7bc7\u8bb2\u89e3\u7d22\u5f15\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u5982\u679c email \u8fd9\u4e2a\u5b57\u6bb5\u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8bed\u53e5\u5c31\u53ea\u80fd\u505a\u5168\u8868\u626b\u63cf\u3002</p> <p>\u540c\u65f6\uff0cMySQL \u662f\u652f\u6301\u524d\u7f00\u7d22\u5f15\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u5b57\u7b26\u4e32\u7684\u4e00\u90e8\u5206\u4f5c\u4e3a\u7d22\u5f15\u3002\u9ed8\u8ba4\u5730\uff0c\u5982\u679c\u4f60\u521b\u5efa\u7d22\u5f15\u7684\u8bed\u53e5\u4e0d\u6307\u5b9a\u524d\u7f00\u957f\u5ea6\uff0c\u90a3\u4e48\u7d22\u5f15\u5c31\u4f1a\u5305\u542b\u6574\u4e2a\u5b57\u7b26\u4e32\u3002</p> <p>\u6bd4\u5982\uff0c\u8fd9\u4e24\u4e2a\u5728 email \u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u7684\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; alter table SUser add index index1(email); -- \u6216\nmysql&gt; alter table SUser add index index2(email(6));\n</code></pre> <p>\u7b2c\u4e00\u4e2a\u8bed\u53e5\u521b\u5efa\u7684 index1 \u7d22\u5f15\u91cc\u9762\uff0c\u5305\u542b\u4e86\u6bcf\u4e2a\u8bb0\u5f55\u7684\u6574\u4e2a\u5b57\u7b26\u4e32\uff1b\u800c\u7b2c\u4e8c\u4e2a\u8bed\u53e5\u521b\u5efa\u7684 index2 \u7d22\u5f15\u91cc\u9762\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8bb0\u5f55\u90fd\u662f\u53ea\u53d6\u524d 6 \u4e2a\u5b57\u8282\u3002</p> <p>\u90a3\u4e48\uff0c\u8fd9\u4e24\u79cd\u4e0d\u540c\u7684\u5b9a\u4e49\u5728\u6570\u636e\u7ed3\u6784\u548c\u5b58\u50a8\u4e0a\u6709\u4ec0\u4e48\u533a\u522b\u5462\uff1f\u5982\u56fe 2 \u548c 3 \u6240\u793a\uff0c\u5c31\u662f\u8fd9\u4e24\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p> <p></p> <p>\u56fe 1 email \u7d22\u5f15\u7ed3\u6784</p> <p></p> <p>\u56fe 2 email(6) \u7d22\u5f15\u7ed3\u6784</p> <p>\u4ece\u56fe\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e email(6) \u8fd9\u4e2a\u7d22\u5f15\u7ed3\u6784\u4e2d\u6bcf\u4e2a\u90ae\u7bb1\u5b57\u6bb5\u90fd\u53ea\u53d6\u524d 6 \u4e2a\u5b57\u8282\uff08\u5373\uff1azhangs\uff09\uff0c\u6240\u4ee5\u5360\u7528\u7684\u7a7a\u95f4\u4f1a\u66f4\u5c0f\uff0c\u8fd9\u5c31\u662f\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u7684\u4f18\u52bf\u3002</p> <p>\u4f46\uff0c\u8fd9\u540c\u65f6\u5e26\u6765\u7684\u635f\u5931\u662f\uff0c\u53ef\u80fd\u4f1a\u589e\u52a0\u989d\u5916\u7684\u8bb0\u5f55\u626b\u63cf\u6b21\u6570\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u5728\u8fd9\u4e24\u4e2a\u7d22\u5f15\u5b9a\u4e49\u4e0b\u5206\u522b\u662f\u600e\u4e48\u6267\u884c\u7684\u3002</p> <pre><code>select id,name,email from SUser where email='zhangssxyz@xxx.com';\n</code></pre> <p>\u5982\u679c\u4f7f\u7528\u7684\u662f index1\uff08\u5373 email \u6574\u4e2a\u5b57\u7b26\u4e32\u7684\u7d22\u5f15\u7ed3\u6784\uff09\uff0c\u6267\u884c\u987a\u5e8f\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u4ece index1 \u7d22\u5f15\u6811\u627e\u5230\u6ee1\u8db3\u7d22\u5f15\u503c\u662f <code>zhangssxyz@xxx.com</code> \u7684\u8fd9\u6761\u8bb0\u5f55\uff0c\u53d6\u5f97 ID2 \u7684\u503c\uff1b</li> <li>\u5230\u4e3b\u952e\u4e0a\u67e5\u5230\u4e3b\u952e\u503c\u662f ID2 \u7684\u884c\uff0c\u5224\u65ad email \u7684\u503c\u662f\u6b63\u786e\u7684\uff0c\u5c06\u8fd9\u884c\u8bb0\u5f55\u52a0\u5165\u7ed3\u679c\u96c6\uff1b</li> <li>\u53d6 index1 \u7d22\u5f15\u6811\u4e0a\u521a\u521a\u67e5\u5230\u7684\u4f4d\u7f6e\u7684\u4e0b\u4e00\u6761\u8bb0\u5f55\uff0c\u53d1\u73b0\u5df2\u7ecf\u4e0d\u6ee1\u8db3 <code>email='zhangssxyz@xxx.com'</code> \u7684\u6761\u4ef6\u4e86\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u9700\u8981\u56de\u4e3b\u952e\u7d22\u5f15\u53d6\u4e00\u6b21\u6570\u636e\uff0c\u6240\u4ee5\u7cfb\u7edf\u8ba4\u4e3a\u53ea\u626b\u63cf\u4e86\u4e00\u884c\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u7684\u662f index2\uff08\u5373 email(6) \u7d22\u5f15\u7ed3\u6784\uff09\uff0c\u6267\u884c\u987a\u5e8f\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u4ece index2 \u7d22\u5f15\u6811\u627e\u5230\u6ee1\u8db3\u7d22\u5f15\u503c\u662f <code>zhangs</code> \u7684\u8bb0\u5f55\uff0c\u627e\u5230\u7684\u7b2c\u4e00\u4e2a\u662f ID1\uff1b</li> <li>\u5230\u4e3b\u952e\u4e0a\u67e5\u5230\u4e3b\u952e\u503c\u662f ID1 \u7684\u884c\uff0c\u5224\u65ad\u51fa email \u7684\u503c\u4e0d\u662f <code>zhangssxyz@xxx.com</code>\uff0c\u8fd9\u884c\u8bb0\u5f55\u4e22\u5f03\uff1b</li> <li>\u53d6 index2 \u4e0a\u521a\u521a\u67e5\u5230\u7684\u4f4d\u7f6e\u7684\u4e0b\u4e00\u6761\u8bb0\u5f55\uff0c\u53d1\u73b0\u4ecd\u7136\u662f <code>zhangs</code>\uff0c\u53d6\u51fa ID2\uff0c\u518d\u5230 ID \u7d22\u5f15\u4e0a\u53d6\u6574\u884c\u7136\u540e\u5224\u65ad\uff0c\u8fd9\u6b21\u503c\u5bf9\u4e86\uff0c\u5c06\u8fd9\u884c\u8bb0\u5f55\u52a0\u5165\u7ed3\u679c\u96c6\uff1b</li> <li>\u91cd\u590d\u4e0a\u4e00\u6b65\uff0c\u76f4\u5230\u5728 idxe2 \u4e0a\u53d6\u5230\u7684\u503c\u4e0d\u662f <code>zhangs</code> \u65f6\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u8981\u56de\u4e3b\u952e\u7d22\u5f15\u53d6 4 \u6b21\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u626b\u63cf\u4e86 4 \u884c\u3002</p> <p>\u901a\u8fc7\u8fd9\u4e2a\u5bf9\u6bd4\uff0c\u4f60\u5f88\u5bb9\u6613\u5c31\u53ef\u4ee5\u53d1\u73b0\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u540e\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u67e5\u8be2\u8bed\u53e5\u8bfb\u6570\u636e\u7684\u6b21\u6570\u53d8\u591a\u3002</p> <p>\u4f46\u662f\uff0c\u5bf9\u4e8e\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u5b9a\u4e49\u7684 index2 \u4e0d\u662f email(6) \u800c\u662f email(7\uff09\uff0c\u4e5f\u5c31\u662f\u8bf4\u53d6 email \u5b57\u6bb5\u7684\u524d 7 \u4e2a\u5b57\u8282\u6765\u6784\u5efa\u7d22\u5f15\u7684\u8bdd\uff0c\u5373\u6ee1\u8db3\u524d\u7f00 <code>zhangss</code> \u7684\u8bb0\u5f55\u53ea\u6709\u4e00\u4e2a\uff0c\u4e5f\u80fd\u591f\u76f4\u63a5\u67e5\u5230 ID2\uff0c\u53ea\u626b\u63cf\u4e00\u884c\u5c31\u7ed3\u675f\u4e86\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4**\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\uff0c\u5b9a\u4e49\u597d\u957f\u5ea6\uff0c\u5c31\u53ef\u4ee5\u505a\u5230\u65e2\u8282\u7701\u7a7a\u95f4\uff0c\u53c8\u4e0d\u7528\u989d\u5916\u589e\u52a0\u592a\u591a\u7684\u67e5\u8be2\u6210\u672c\u3002**</p> <p>\u4e8e\u662f\uff0c\u4f60\u5c31\u6709\u4e2a\u95ee\u9898\uff1a\u5f53\u8981\u7ed9\u5b57\u7b26\u4e32\u521b\u5efa\u524d\u7f00\u7d22\u5f15\u65f6\uff0c\u6709\u4ec0\u4e48\u65b9\u6cd5\u80fd\u591f\u786e\u5b9a\u6211\u5e94\u8be5\u4f7f\u7528\u591a\u957f\u7684\u524d\u7f00\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5728\u5efa\u7acb\u7d22\u5f15\u65f6\u5173\u6ce8\u7684\u662f\u533a\u5206\u5ea6\uff0c\u533a\u5206\u5ea6\u8d8a\u9ad8\u8d8a\u597d\u3002\u56e0\u4e3a\u533a\u5206\u5ea6\u8d8a\u9ad8\uff0c\u610f\u5473\u7740\u91cd\u590d\u7684\u952e\u503c\u8d8a\u5c11\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7edf\u8ba1\u7d22\u5f15\u4e0a\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u503c\u6765\u5224\u65ad\u8981\u4f7f\u7528\u591a\u957f\u7684\u524d\u7f00\u3002</p> <p>\u9996\u5148\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7b97\u51fa\u8fd9\u4e2a\u5217\u4e0a\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u503c\uff1a</p> <pre><code>mysql&gt; select count(distinct email) as L from SUser;\n</code></pre> <p>\u7136\u540e\uff0c\u4f9d\u6b21\u9009\u53d6\u4e0d\u540c\u957f\u5ea6\u7684\u524d\u7f00\u6765\u770b\u8fd9\u4e2a\u503c\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u770b\u4e00\u4e0b 4~7 \u4e2a\u5b57\u8282\u7684\u524d\u7f00\u7d22\u5f15\uff0c\u53ef\u4ee5\u7528\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select \n  count(distinct left(email,4)\uff09as L4,\n  count(distinct left(email,5)\uff09as L5,\n  count(distinct left(email,6)\uff09as L6,\n  count(distinct left(email,7)\uff09as L7,\nfrom SUser;\n</code></pre> <p>\u5f53\u7136\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u5f88\u53ef\u80fd\u4f1a\u635f\u5931\u533a\u5206\u5ea6\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u9884\u5148\u8bbe\u5b9a\u4e00\u4e2a\u53ef\u4ee5\u63a5\u53d7\u7684\u635f\u5931\u6bd4\u4f8b\uff0c\u6bd4\u5982 5%\u3002\u7136\u540e\uff0c\u5728\u8fd4\u56de\u7684 L4~L7 \u4e2d\uff0c\u627e\u51fa\u4e0d\u5c0f\u4e8e L * 95% \u7684\u503c\uff0c\u5047\u8bbe\u8fd9\u91cc L6\u3001L7 \u90fd\u6ee1\u8db3\uff0c\u4f60\u5c31\u53ef\u4ee5\u9009\u62e9\u524d\u7f00\u957f\u5ea6\u4e3a 6\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_4","title":"\u524d\u7f00\u7d22\u5f15\u5bf9\u8986\u76d6\u7d22\u5f15\u7684\u5f71\u54cd","text":"<p>\u524d\u9762\u6211\u4eec\u8bf4\u4e86\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u53ef\u80fd\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\uff0c\u8fd9\u4f1a\u5f71\u54cd\u5230\u6027\u80fd\u3002\u5176\u5b9e\uff0c\u524d\u7f00\u7d22\u5f15\u7684\u5f71\u54cd\u4e0d\u6b62\u5982\u6b64\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u53e6\u5916\u4e00\u4e2a\u573a\u666f\u3002</p> <p>\u4f60\u5148\u6765\u770b\u770b\u8fd9\u4e2a SQL \u8bed\u53e5\uff1a</p> <pre><code>select id, email from SUser where email='zhangssxyz@xxx.com';\n</code></pre> <p>\u4e0e\u524d\u9762\u4f8b\u5b50\u4e2d\u7684 SQL \u8bed\u53e5</p> <pre><code>select id, name, email from SUser where email='zhangssxyz@xxx.com';\n</code></pre> <p>\u76f8\u6bd4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u53ea\u8981\u6c42\u8fd4\u56de id \u548c email \u5b57\u6bb5\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u4f7f\u7528 index1\uff08\u5373 email \u6574\u4e2a\u5b57\u7b26\u4e32\u7684\u7d22\u5f15\u7ed3\u6784\uff09\u7684\u8bdd\uff0c\u53ef\u4ee5\u5229\u7528\u8986\u76d6\u7d22\u5f15\uff0c\u4ece index1 \u67e5\u5230\u7ed3\u679c\u540e\u76f4\u63a5\u5c31\u8fd4\u56de\u4e86\uff0c\u4e0d\u9700\u8981\u56de\u5230 ID \u7d22\u5f15\u518d\u53bb\u67e5\u4e00\u6b21\u3002\u800c\u5982\u679c\u4f7f\u7528 index2\uff08\u5373 email(6) \u7d22\u5f15\u7ed3\u6784\uff09\u7684\u8bdd\uff0c\u5c31\u4e0d\u5f97\u4e0d\u56de\u5230 ID \u7d22\u5f15\u518d\u53bb\u5224\u65ad email \u5b57\u6bb5\u7684\u503c\u3002</p> <p>\u5373\u4f7f\u4f60\u5c06 index2 \u7684\u5b9a\u4e49\u4fee\u6539\u4e3a <code>email(18)</code> \u7684\u524d\u7f00\u7d22\u5f15\uff0c\u8fd9\u65f6\u5019\u867d\u7136 index2 \u5df2\u7ecf\u5305\u542b\u4e86\u6240\u6709\u7684\u4fe1\u606f\uff0c\u4f46 InnoDB \u8fd8\u662f\u8981\u56de\u5230 id \u7d22\u5f15\u518d\u67e5\u4e00\u4e0b\uff0c\u56e0\u4e3a\u7cfb\u7edf\u5e76\u4e0d\u786e\u5b9a\u524d\u7f00\u7d22\u5f15\u7684\u5b9a\u4e49\u662f\u5426\u622a\u65ad\u4e86\u5b8c\u6574\u4fe1\u606f\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u5c31\u7528\u4e0d\u4e0a\u8986\u76d6\u7d22\u5f15\u5bf9\u67e5\u8be2\u6027\u80fd\u7684\u4f18\u5316\u4e86\uff0c\u8fd9\u4e5f\u662f\u4f60\u5728\u9009\u62e9\u662f\u5426\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u65f6\u9700\u8981\u8003\u8651\u7684\u4e00\u4e2a\u56e0\u7d20\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_5","title":"\u5176\u4ed6\u65b9\u5f0f","text":"<p>\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e\u90ae\u7bb1\u8fd9\u6837\u7684\u5b57\u6bb5\u6765\u8bf4\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u7684\u6548\u679c\u53ef\u80fd\u8fd8\u4e0d\u9519\u3002\u4f46\u662f\uff0c\u9047\u5230\u524d\u7f00\u7684\u533a\u5206\u5ea6\u4e0d\u591f\u597d\u7684\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u8981\u600e\u4e48\u529e\u5462\uff1f</p> <p>\u6bd4\u5982\uff0c\u6211\u4eec\u56fd\u5bb6\u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u4e00\u5171 18 \u4f4d\uff0c\u5176\u4e2d\u524d 6 \u4f4d\u662f\u5730\u5740\u7801\uff0c\u6240\u4ee5\u540c\u4e00\u4e2a\u53bf\u7684\u4eba\u7684\u8eab\u4efd\u8bc1\u53f7\u524d 6 \u4f4d\u4e00\u822c\u4f1a\u662f\u76f8\u540c\u7684\u3002</p> <p>\u5047\u8bbe\u4f60\u7ef4\u62a4\u7684\u6570\u636e\u5e93\u662f\u4e00\u4e2a\u5e02\u7684\u516c\u6c11\u4fe1\u606f\u7cfb\u7edf\uff0c\u8fd9\u65f6\u5019\u5982\u679c\u5bf9\u8eab\u4efd\u8bc1\u53f7\u505a\u957f\u5ea6\u4e3a 6 \u7684\u524d\u7f00\u7d22\u5f15\u7684\u8bdd\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u5c31\u975e\u5e38\u4f4e\u4e86\u3002</p> <p>\u6309\u7167\u6211\u4eec\u524d\u9762\u8bf4\u7684\u65b9\u6cd5\uff0c\u53ef\u80fd\u4f60\u9700\u8981\u521b\u5efa\u957f\u5ea6\u4e3a 12 \u4ee5\u4e0a\u7684\u524d\u7f00\u7d22\u5f15\uff0c\u624d\u80fd\u591f\u6ee1\u8db3\u533a\u5206\u5ea6\u8981\u6c42\u3002</p> <p>\u4f46\u662f\uff0c\u7d22\u5f15\u9009\u53d6\u7684\u8d8a\u957f\uff0c\u5360\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u5c31\u8d8a\u5927\uff0c\u76f8\u540c\u7684\u6570\u636e\u9875\u80fd\u653e\u4e0b\u7684\u7d22\u5f15\u503c\u5c31\u8d8a\u5c11\uff0c\u641c\u7d22\u7684\u6548\u7387\u4e5f\u5c31\u4f1a\u8d8a\u4f4e\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u80fd\u591f\u786e\u5b9a\u4e1a\u52a1\u9700\u6c42\u91cc\u9762\u53ea\u6709\u6309\u7167\u8eab\u4efd\u8bc1\u8fdb\u884c\u7b49\u503c\u67e5\u8be2\u7684\u9700\u6c42\uff0c\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u5904\u7406\u65b9\u6cd5\u5462\uff1f\u8fd9\u79cd\u65b9\u6cd5\uff0c\u65e2\u53ef\u4ee5\u5360\u7528\u66f4\u5c0f\u7684\u7a7a\u95f4\uff0c\u4e5f\u80fd\u8fbe\u5230\u76f8\u540c\u7684\u67e5\u8be2\u6548\u7387\u3002</p> <p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p> <p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\u662f\u4f7f\u7528\u5012\u5e8f\u5b58\u50a8\u3002\u5982\u679c\u4f60\u5b58\u50a8\u8eab\u4efd\u8bc1\u53f7\u7684\u65f6\u5019\u628a\u5b83\u5012\u8fc7\u6765\u5b58\uff0c\u6bcf\u6b21\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>mysql&gt; select field_list from t where id_card = reverse('input_id_card_string');\n</code></pre> <p>\u7531\u4e8e\u8eab\u4efd\u8bc1\u53f7\u7684\u6700\u540e 6 \u4f4d\u6ca1\u6709\u5730\u5740\u7801\u8fd9\u6837\u7684\u91cd\u590d\u903b\u8f91\uff0c\u6240\u4ee5\u6700\u540e\u8fd9 6 \u4f4d\u5f88\u53ef\u80fd\u5c31\u63d0\u4f9b\u4e86\u8db3\u591f\u7684\u533a\u5206\u5ea6\u3002\u5f53\u7136\u4e86\uff0c\u5b9e\u8df5\u4e2d\u4f60\u4e0d\u8981\u5fd8\u8bb0\u4f7f\u7528 <code>count(distinct)</code> \u65b9\u6cd5\u53bb\u505a\u4e2a\u9a8c\u8bc1\u3002</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\u4f7f\u7528 hash \u5b57\u6bb5\u3002\u4f60\u53ef\u4ee5\u5728\u8868\u4e0a\u518d\u521b\u5efa\u4e00\u4e2a\u6574\u6570\u5b57\u6bb5\uff0c\u6765\u4fdd\u5b58\u8eab\u4efd\u8bc1\u7684\u6821\u9a8c\u7801\uff0c\u540c\u65f6\u5728\u8fd9\u4e2a\u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u3002</p> <pre><code>mysql&gt; alter table t add id_card_crc int unsigned, add index(id_card_crc);\n</code></pre> <p>\u7136\u540e\u6bcf\u6b21\u63d2\u5165\u65b0\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u90fd\u540c\u65f6\u7528 <code>crc32()</code> \u8fd9\u4e2a\u51fd\u6570\u5f97\u5230\u6821\u9a8c\u7801\u586b\u5230\u8fd9\u4e2a\u65b0\u5b57\u6bb5\u3002\u7531\u4e8e\u6821\u9a8c\u7801\u53ef\u80fd\u5b58\u5728\u51b2\u7a81\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e24\u4e2a\u4e0d\u540c\u7684\u8eab\u4efd\u8bc1\u53f7\u901a\u8fc7 <code>crc32()</code> \u51fd\u6570\u5f97\u5230\u7684\u7ed3\u679c\u53ef\u80fd\u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u4f60\u7684\u67e5\u8be2\u8bed\u53e5 where \u90e8\u5206\u8981\u5224\u65ad id_card \u7684\u503c\u662f\u5426\u7cbe\u786e\u76f8\u540c\u3002</p> <pre><code>mysql&gt; select field_list from t where id_card_crc=crc32('input_id_card_string') and id_card='input_id_card_string'\n</code></pre> <p>\u8fd9\u6837\uff0c\u7d22\u5f15\u7684\u957f\u5ea6\u53d8\u6210\u4e86 4 \u4e2a\u5b57\u8282\uff0c\u6bd4\u539f\u6765\u5c0f\u4e86\u5f88\u591a\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b**\u4f7f\u7528\u5012\u5e8f\u5b58\u50a8\u548c\u4f7f\u7528 hash \u5b57\u6bb5\u8fd9\u4e24\u79cd\u65b9\u6cd5\u7684\u5f02\u540c\u70b9\u3002**</p> <p>\u9996\u5148\uff0c\u5b83\u4eec\u7684\u76f8\u540c\u70b9\u662f\uff0c\u90fd\u4e0d\u652f\u6301\u8303\u56f4\u67e5\u8be2\u3002\u5012\u5e8f\u5b58\u50a8\u7684\u5b57\u6bb5\u4e0a\u521b\u5efa\u7684\u7d22\u5f15\u662f\u6309\u7167\u5012\u5e8f\u5b57\u7b26\u4e32\u7684\u65b9\u5f0f\u6392\u5e8f\u7684\uff0c\u5df2\u7ecf\u6ca1\u6709\u529e\u6cd5\u5229\u7528\u7d22\u5f15\u65b9\u5f0f\u67e5\u51fa\u8eab\u4efd\u8bc1\u53f7\u7801\u5728 <code>[ID_X, ID_Y]</code> \u7684\u6240\u6709\u5e02\u6c11\u4e86\u3002\u540c\u6837\u5730\uff0chash \u5b57\u6bb5\u7684\u65b9\u5f0f\u4e5f\u53ea\u80fd\u652f\u6301\u7b49\u503c\u67e5\u8be2\u3002</p> <p>\u5b83\u4eec\u7684\u533a\u522b\uff0c\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u4e09\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u4ece\u5360\u7528\u7684\u989d\u5916\u7a7a\u95f4\u6765\u770b\uff0c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u4e0d\u4f1a\u6d88\u8017\u989d\u5916\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u800c hash \u5b57\u6bb5\u65b9\u6cd5\u9700\u8981\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\u3002\u5f53\u7136\uff0c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u4f7f\u7528 4 \u4e2a\u5b57\u8282\u7684\u524d\u7f00\u957f\u5ea6\u5e94\u8be5\u662f\u4e0d\u591f\u7684\uff0c\u5982\u679c\u518d\u957f\u4e00\u70b9\uff0c\u8fd9\u4e2a\u6d88\u8017\u8ddf\u989d\u5916\u8fd9\u4e2a hash \u5b57\u6bb5\u4e5f\u5dee\u4e0d\u591a\u62b5\u6d88\u4e86\u3002</li> <li>\u5728 CPU \u6d88\u8017\u65b9\u9762\uff0c\u5012\u5e8f\u65b9\u5f0f\u6bcf\u6b21\u5199\u548c\u8bfb\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u989d\u5916\u8c03\u7528\u4e00\u6b21 reverse \u51fd\u6570\uff0c\u800c hash \u5b57\u6bb5\u7684\u65b9\u5f0f\u9700\u8981\u989d\u5916\u8c03\u7528\u4e00\u6b21 crc32() \u51fd\u6570\u3002\u5982\u679c\u53ea\u4ece\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u8ba1\u7b97\u590d\u6742\u5ea6\u6765\u770b\u7684\u8bdd\uff0creverse \u51fd\u6570\u989d\u5916\u6d88\u8017\u7684 CPU \u8d44\u6e90\u4f1a\u66f4\u5c0f\u4e9b\u3002</li> <li>\u4ece\u67e5\u8be2\u6548\u7387\u4e0a\u770b\uff0c\u4f7f\u7528 hash \u5b57\u6bb5\u65b9\u5f0f\u7684\u67e5\u8be2\u6027\u80fd\u76f8\u5bf9\u66f4\u7a33\u5b9a\u4e00\u4e9b\u3002\u56e0\u4e3a crc32 \u7b97\u51fa\u6765\u7684\u503c\u867d\u7136\u6709\u51b2\u7a81\u7684\u6982\u7387\uff0c\u4f46\u662f\u6982\u7387\u975e\u5e38\u5c0f\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u6bcf\u6b21\u67e5\u8be2\u7684\u5e73\u5747\u626b\u63cf\u884c\u6570\u63a5\u8fd1 1\u3002\u800c\u5012\u5e8f\u5b58\u50a8\u65b9\u5f0f\u6bd5\u7adf\u8fd8\u662f\u7528\u7684\u524d\u7f00\u7d22\u5f15\u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd8\u662f\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_6","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u804a\u4e86\u804a\u5b57\u7b26\u4e32\u5b57\u6bb5\u521b\u5efa\u7d22\u5f15\u7684\u573a\u666f\u3002\u6211\u4eec\u6765\u56de\u987e\u4e00\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684\u65b9\u5f0f\u6709\uff1a</p> <ol> <li>\u76f4\u63a5\u521b\u5efa\u5b8c\u6574\u7d22\u5f15\uff0c\u8fd9\u6837\u53ef\u80fd\u6bd4\u8f83\u5360\u7528\u7a7a\u95f4\uff1b</li> <li>\u521b\u5efa\u524d\u7f00\u7d22\u5f15\uff0c\u8282\u7701\u7a7a\u95f4\uff0c\u4f46\u4f1a\u589e\u52a0\u67e5\u8be2\u626b\u63cf\u6b21\u6570\uff0c\u5e76\u4e14\u4e0d\u80fd\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\uff1b</li> <li>\u5012\u5e8f\u5b58\u50a8\uff0c\u518d\u521b\u5efa\u524d\u7f00\u7d22\u5f15\uff0c\u7528\u4e8e\u7ed5\u8fc7\u5b57\u7b26\u4e32\u672c\u8eab\u524d\u7f00\u7684\u533a\u5206\u5ea6\u4e0d\u591f\u7684\u95ee\u9898\uff1b</li> <li>\u521b\u5efa hash \u5b57\u6bb5\u7d22\u5f15\uff0c\u67e5\u8be2\u6027\u80fd\u7a33\u5b9a\uff0c\u6709\u989d\u5916\u7684\u5b58\u50a8\u548c\u8ba1\u7b97\u6d88\u8017\uff0c\u8ddf\u7b2c\u4e09\u79cd\u65b9\u5f0f\u4e00\u6837\uff0c\u90fd\u4e0d\u652f\u6301\u8303\u56f4\u626b\u63cf\u3002</li> </ol> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u4f60\u8981\u6839\u636e\u4e1a\u52a1\u5b57\u6bb5\u7684\u7279\u70b9\u9009\u62e9\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#12-mysql","title":"12 \u4e3a\u4ec0\u4e48\u6211\u7684MySQL\u4f1a\u201c\u6296\u201d\u4e00\u4e0b\uff1f","text":"<p>\u5e73\u65f6\u7684\u5de5\u4f5c\u4e2d\uff0c\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u573a\u666f\uff0c\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u6b63\u5e38\u6267\u884c\u7684\u65f6\u5019\u7279\u522b\u5feb\uff0c\u4f46\u662f\u6709\u65f6\u4e5f\u4e0d\u77e5\u9053\u600e\u4e48\u56de\u4e8b\uff0c\u5b83\u5c31\u4f1a\u53d8\u5f97\u7279\u522b\u6162\uff0c\u5e76\u4e14\u8fd9\u6837\u7684\u573a\u666f\u5f88\u96be\u590d\u73b0\uff0c\u5b83\u4e0d\u53ea\u968f\u673a\uff0c\u800c\u4e14\u6301\u7eed\u65f6\u95f4\u8fd8\u5f88\u77ed\u3002</p> <p>\u770b\u4e0a\u53bb\uff0c\u8fd9\u5c31\u50cf\u662f\u6570\u636e\u5e93\u201c\u6296\u201d\u4e86\u4e00\u4e0b\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u770b\u4e00\u770b\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#sql","title":"\u4f60\u7684 SQL \u8bed\u53e5\u4e3a\u4ec0\u4e48\u53d8\u201c\u6162\u201d\u4e86","text":"<p>\u5728\u524d\u9762\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\uff0c\u6211\u4e3a\u4f60\u4ecb\u7ecd\u4e86 WAL \u673a\u5236\u3002\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0cInnoDB \u5728\u5904\u7406\u66f4\u65b0\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u53ea\u505a\u4e86\u5199\u65e5\u5fd7\u8fd9\u4e00\u4e2a\u78c1\u76d8\u64cd\u4f5c\u3002\u8fd9\u4e2a\u65e5\u5fd7\u53eb\u4f5c redo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\uff0c\u4e5f\u5c31\u662f\u300a\u5b54\u4e59\u5df1\u300b\u91cc\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7528\u6765\u8bb0\u8d26\u7684\u7c89\u677f\uff0c\u5728\u66f4\u65b0\u5185\u5b58\u5199\u5b8c redo log \u540e\uff0c\u5c31\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u672c\u6b21\u66f4\u65b0\u6210\u529f\u3002</p> <p>\u505a\u4e0b\u7c7b\u6bd4\u7684\u8bdd\uff0c\u638c\u67dc\u8bb0\u8d26\u7684\u8d26\u672c\u662f\u6570\u636e\u6587\u4ef6\uff0c\u8bb0\u8d26\u7528\u7684\u7c89\u677f\u662f\u65e5\u5fd7\u6587\u4ef6\uff08redo log\uff09\uff0c\u638c\u67dc\u7684\u8bb0\u5fc6\u5c31\u662f\u5185\u5b58\u3002</p> <p>\u638c\u67dc\u603b\u8981\u627e\u65f6\u95f4\u628a\u8d26\u672c\u66f4\u65b0\u4e00\u4e0b\uff0c\u8fd9\u5bf9\u5e94\u7684\u5c31\u662f\u628a\u5185\u5b58\u91cc\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u672f\u8bed\u5c31\u662f flush\u3002\u5728\u8fd9\u4e2a flush \u64cd\u4f5c\u6267\u884c\u4e4b\u524d\uff0c\u5b54\u4e59\u5df1\u7684\u8d4a\u8d26\u603b\u989d\uff0c\u5176\u5b9e\u8ddf\u638c\u67dc\u624b\u4e2d\u8d26\u672c\u91cc\u9762\u7684\u8bb0\u5f55\u662f\u4e0d\u4e00\u81f4\u7684\u3002\u56e0\u4e3a\u5b54\u4e59\u5df1\u4eca\u5929\u7684\u8d4a\u8d26\u91d1\u989d\u8fd8\u53ea\u5728\u7c89\u677f\u4e0a\uff0c\u800c\u8d26\u672c\u91cc\u7684\u8bb0\u5f55\u662f\u8001\u7684\uff0c\u8fd8\u6ca1\u628a\u4eca\u5929\u7684\u8d4a\u8d26\u7b97\u8fdb\u53bb\u3002</p> <p>\u5f53\u5185\u5b58\u6570\u636e\u9875\u8ddf\u78c1\u76d8\u6570\u636e\u9875\u5185\u5bb9\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u79f0\u8fd9\u4e2a\u5185\u5b58\u9875\u4e3a\u201c\u810f\u9875\u201d\u3002\u5185\u5b58\u6570\u636e\u5199\u5165\u5230\u78c1\u76d8\u540e\uff0c\u5185\u5b58\u548c\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u9875\u7684\u5185\u5bb9\u5c31\u4e00\u81f4\u4e86\uff0c\u79f0\u4e3a\u201c\u5e72\u51c0\u9875\u201d\u3002</p> <p>\u4e0d\u8bba\u662f\u810f\u9875\u8fd8\u662f\u5e72\u51c0\u9875\uff0c\u90fd\u5728\u5185\u5b58\u4e2d\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5185\u5b58\u5bf9\u5e94\u7684\u5c31\u662f\u638c\u67dc\u7684\u8bb0\u5fc6\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u793a\u610f\u56fe\u6765\u5c55\u793a\u4e00\u4e0b\u201c\u5b54\u4e59\u5df1\u8d4a\u8d26\u201d\u7684\u6574\u4e2a\u64cd\u4f5c\u8fc7\u7a0b\u3002\u5047\u8bbe\u539f\u6765\u5b54\u4e59\u5df1\u6b20\u8d26 10 \u6587\uff0c\u8fd9\u6b21\u53c8\u8981\u8d4a 9 \u6587\u3002</p> <p></p> <p>\u56fe 1 \u201c\u5b54\u4e59\u5df1\u8d4a\u8d26\u201d\u66f4\u65b0\u548c flush \u8fc7\u7a0b</p> <p>\u56de\u5230\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u4f60\u4e0d\u96be\u60f3\u8c61\uff0c\u5e73\u65f6\u6267\u884c\u5f88\u5feb\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u5176\u5b9e\u5c31\u662f\u5728\u5199\u5185\u5b58\u548c\u65e5\u5fd7\uff0c\u800c MySQL \u5076\u5c14\u201c\u6296\u201d\u4e00\u4e0b\u7684\u90a3\u4e2a\u77ac\u95f4\uff0c\u53ef\u80fd\u5c31\u662f\u5728\u5237\u810f\u9875\uff08flush\uff09\u3002</p> <p>\u90a3\u4e48\uff0c\u4ec0\u4e48\u60c5\u51b5\u4f1a\u5f15\u53d1\u6570\u636e\u5e93\u7684 flush \u8fc7\u7a0b\u5462\uff1f</p> <p>\u6211\u4eec\u8fd8\u662f\u7ee7\u7eed\u7528\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u60f3\u4e00\u60f3\uff1a\u638c\u67dc\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u628a\u7c89\u677f\u4e0a\u7684\u8d4a\u8d26\u8bb0\u5f55\u6539\u5230\u8d26\u672c\u4e0a\uff1f</p> <ul> <li>\u7b2c\u4e00\u79cd\u573a\u666f\u662f\uff0c\u7c89\u677f\u6ee1\u4e86\uff0c\u8bb0\u4e0d\u4e0b\u4e86\u3002\u8fd9\u65f6\u5019\u5982\u679c\u518d\u6709\u4eba\u6765\u8d4a\u8d26\uff0c\u638c\u67dc\u5c31\u53ea\u5f97\u653e\u4e0b\u624b\u91cc\u7684\u6d3b\u513f\uff0c\u5c06\u7c89\u677f\u4e0a\u7684\u8bb0\u5f55\u64e6\u6389\u4e00\u4e9b\uff0c\u7559\u51fa\u7a7a\u4f4d\u4ee5\u4fbf\u7ee7\u7eed\u8bb0\u8d26\u3002\u5f53\u7136\u5728\u64e6\u6389\u4e4b\u524d\uff0c\u4ed6\u5fc5\u987b\u5148\u5c06\u6b63\u786e\u7684\u8d26\u76ee\u8bb0\u5f55\u5230\u8d26\u672c\u4e2d\u624d\u884c\u3002 \u8fd9\u4e2a\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f InnoDB \u7684 redo log \u5199\u6ee1\u4e86\u3002\u8fd9\u65f6\u5019\u7cfb\u7edf\u4f1a\u505c\u6b62\u6240\u6709\u66f4\u65b0\u64cd\u4f5c\uff0c\u628a checkpoint \u5f80\u524d\u63a8\u8fdb\uff0credo log \u7559\u51fa\u7a7a\u95f4\u53ef\u4ee5\u7ee7\u7eed\u5199\u3002\u6211\u5728\u7b2c\u4e8c\u8bb2\u753b\u4e86\u4e00\u4e2a redo log \u7684\u793a\u610f\u56fe\uff0c\u8fd9\u91cc\u6211\u6539\u6210\u73af\u5f62\uff0c\u4fbf\u4e8e\u5927\u5bb6\u7406\u89e3\u3002</li> </ul> <p></p> <p>\u56fe 2 redo log \u72b6\u6001\u56fe</p> <p>checkpoint \u53ef\u4e0d\u662f\u968f\u4fbf\u5f80\u524d\u4fee\u6539\u4e00\u4e0b\u4f4d\u7f6e\u5c31\u53ef\u4ee5\u7684\u3002\u6bd4\u5982\u56fe 2 \u4e2d\uff0c\u628a checkpoint \u4f4d\u7f6e\u4ece CP \u63a8\u8fdb\u5230 CP\u2019\uff0c\u5c31\u9700\u8981\u5c06\u4e24\u4e2a\u70b9\u4e4b\u95f4\u7684\u65e5\u5fd7\uff08\u6d45\u7eff\u8272\u90e8\u5206\uff09\uff0c\u5bf9\u5e94\u7684\u6240\u6709\u810f\u9875\u90fd flush \u5230\u78c1\u76d8\u4e0a\u3002\u4e4b\u540e\uff0c\u56fe\u4e2d\u4ece write pos \u5230 CP\u2019\u4e4b\u95f4\u5c31\u662f\u53ef\u4ee5\u518d\u5199\u5165\u7684 redo log \u7684\u533a\u57df\u3002</p> <ul> <li>\u7b2c\u4e8c\u79cd\u573a\u666f\u662f\uff0c\u8fd9\u4e00\u5929\u751f\u610f\u592a\u597d\uff0c\u8981\u8bb0\u4f4f\u7684\u4e8b\u60c5\u592a\u591a\uff0c\u638c\u67dc\u53d1\u73b0\u81ea\u5df1\u5feb\u8bb0\u4e0d\u4f4f\u4e86\uff0c\u8d76\u7d27\u627e\u51fa\u8d26\u672c\u628a\u5b54\u4e59\u5df1\u8fd9\u7b14\u8d26\u5148\u52a0\u8fdb\u53bb\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u7cfb\u7edf\u5185\u5b58\u4e0d\u8db3\u3002\u5f53\u9700\u8981\u65b0\u7684\u5185\u5b58\u9875\uff0c\u800c\u5185\u5b58\u4e0d\u591f\u7528\u7684\u65f6\u5019\uff0c\u5c31\u8981\u6dd8\u6c70\u4e00\u4e9b\u6570\u636e\u9875\uff0c\u7a7a\u51fa\u5185\u5b58\u7ed9\u522b\u7684\u6570\u636e\u9875\u4f7f\u7528\u3002\u5982\u679c\u6dd8\u6c70\u7684\u662f\u201c\u810f\u9875\u201d\uff0c\u5c31\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u3002 \u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u65f6\u5019\u96be\u9053\u4e0d\u80fd\u76f4\u63a5\u628a\u5185\u5b58\u6dd8\u6c70\u6389\uff0c\u4e0b\u6b21\u9700\u8981\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u9875\uff0c\u7136\u540e\u62ff redo log \u51fa\u6765\u5e94\u7528\u4e0d\u5c31\u884c\u4e86\uff1f\u8fd9\u91cc\u5176\u5b9e\u662f\u4ece\u6027\u80fd\u8003\u8651\u7684\u3002\u5982\u679c\u5237\u810f\u9875\u4e00\u5b9a\u4f1a\u5199\u76d8\uff0c\u5c31\u4fdd\u8bc1\u4e86\u6bcf\u4e2a\u6570\u636e\u9875\u6709\u4e24\u79cd\u72b6\u6001\uff1a </li> <li>\u4e00\u79cd\u662f\u5185\u5b58\u91cc\u5b58\u5728\uff0c\u5185\u5b58\u91cc\u5c31\u80af\u5b9a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b</li> <li>\u53e6\u4e00\u79cd\u662f\u5185\u5b58\u91cc\u6ca1\u6709\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u80af\u5b9a\u6570\u636e\u6587\u4ef6\u4e0a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u8bfb\u5165\u5185\u5b58\u540e\u8fd4\u56de\u3002 \u8fd9\u6837\u7684\u6548\u7387\u6700\u9ad8\u3002</li> <li>\u7b2c\u4e09\u79cd\u573a\u666f\u662f\uff0c\u751f\u610f\u4e0d\u5fd9\u7684\u65f6\u5019\uff0c\u6216\u8005\u6253\u70ca\u4e4b\u540e\u3002\u8fd9\u65f6\u5019\u67dc\u53f0\u6ca1\u4e8b\uff0c\u638c\u67dc\u95f2\u7740\u4e5f\u662f\u95f2\u7740\uff0c\u4e0d\u5982\u66f4\u65b0\u8d26\u672c\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f MySQL \u8ba4\u4e3a\u7cfb\u7edf\u201c\u7a7a\u95f2\u201d\u7684\u65f6\u5019\u3002\u5f53\u7136\uff0cMySQL\u201c\u8fd9\u5bb6\u9152\u5e97\u201d\u7684\u751f\u610f\u597d\u8d77\u6765\u53ef\u662f\u4f1a\u5f88\u5feb\u5c31\u80fd\u628a\u7c89\u677f\u8bb0\u6ee1\u7684\uff0c\u6240\u4ee5\u201c\u638c\u67dc\u201d\u8981\u5408\u7406\u5730\u5b89\u6392\u65f6\u95f4\uff0c\u5373\u4f7f\u662f\u201c\u751f\u610f\u597d\u201d\u7684\u65f6\u5019\uff0c\u4e5f\u8981\u89c1\u7f1d\u63d2\u9488\u5730\u627e\u65f6\u95f4\uff0c\u53ea\u8981\u6709\u673a\u4f1a\u5c31\u5237\u4e00\u70b9\u201c\u810f\u9875\u201d\u3002</li> <li>\u7b2c\u56db\u79cd\u573a\u666f\u662f\uff0c\u5e74\u5e95\u4e86\u54b8\u4ea8\u9152\u5e97\u8981\u5173\u95e8\u51e0\u5929\uff0c\u9700\u8981\u628a\u8d26\u7ed3\u6e05\u4e00\u4e0b\u3002\u8fd9\u65f6\u5019\u638c\u67dc\u8981\u628a\u6240\u6709\u8d26\u90fd\u8bb0\u5230\u8d26\u672c\u4e0a\uff0c\u8fd9\u6837\u8fc7\u5b8c\u5e74\u91cd\u65b0\u5f00\u5f20\u7684\u65f6\u5019\uff0c\u5c31\u80fd\u5c31\u7740\u8d26\u672c\u660e\u786e\u8d26\u76ee\u60c5\u51b5\u4e86\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f MySQL \u6b63\u5e38\u5173\u95ed\u7684\u60c5\u51b5\u3002\u8fd9\u65f6\u5019\uff0cMySQL \u4f1a\u628a\u5185\u5b58\u7684\u810f\u9875\u90fd flush \u5230\u78c1\u76d8\u4e0a\uff0c\u8fd9\u6837\u4e0b\u6b21 MySQL \u542f\u52a8\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u78c1\u76d8\u4e0a\u8bfb\u6570\u636e\uff0c\u542f\u52a8\u901f\u5ea6\u4f1a\u5f88\u5feb\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\uff0c\u4f60\u53ef\u4ee5\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u56db\u79cd\u573a\u666f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u3002</p> <p>\u5176\u4e2d\uff0c\u7b2c\u4e09\u79cd\u60c5\u51b5\u662f\u5c5e\u4e8e MySQL \u7a7a\u95f2\u65f6\u7684\u64cd\u4f5c\uff0c\u8fd9\u65f6\u7cfb\u7edf\u6ca1\u4ec0\u4e48\u538b\u529b\uff0c\u800c\u7b2c\u56db\u79cd\u573a\u666f\u662f\u6570\u636e\u5e93\u672c\u6765\u5c31\u8981\u5173\u95ed\u4e86\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e0d\u4f1a\u592a\u5173\u6ce8\u201c\u6027\u80fd\u201d\u95ee\u9898\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u6211\u4eec\u4e3b\u8981\u6765\u5206\u6790\u4e00\u4e0b\u524d\u4e24\u79cd\u573a\u666f\u4e0b\u7684\u6027\u80fd\u95ee\u9898\u3002</p> <p>\u7b2c\u4e00\u79cd\u662f\u201credo log \u5199\u6ee1\u4e86\uff0c\u8981 flush \u810f\u9875\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u662f InnoDB \u8981\u5c3d\u91cf\u907f\u514d\u7684\u3002\u56e0\u4e3a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u65f6\u5019\uff0c\u6574\u4e2a\u7cfb\u7edf\u5c31\u4e0d\u80fd\u518d\u63a5\u53d7\u66f4\u65b0\u4e86\uff0c\u6240\u6709\u7684\u66f4\u65b0\u90fd\u5fc5\u987b\u5835\u4f4f\u3002\u5982\u679c\u4f60\u4ece\u76d1\u63a7\u4e0a\u770b\uff0c\u8fd9\u65f6\u5019\u66f4\u65b0\u6570\u4f1a\u8dcc\u4e3a 0\u3002</p> <p>\u7b2c\u4e8c\u79cd\u662f\u201c\u5185\u5b58\u4e0d\u591f\u7528\u4e86\uff0c\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u5176\u5b9e\u662f\u5e38\u6001\u3002InnoDB \u7528\u7f13\u51b2\u6c60\uff08buffer pool\uff09\u7ba1\u7406\u5185\u5b58\uff0c\u7f13\u51b2\u6c60\u4e2d\u7684\u5185\u5b58\u9875\u6709\u4e09\u79cd\u72b6\u6001\uff1a</p> <ul> <li>\u7b2c\u4e00\u79cd\u662f\uff0c\u8fd8\u6ca1\u6709\u4f7f\u7528\u7684\uff1b</li> <li>\u7b2c\u4e8c\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u5e72\u51c0\u9875\uff1b</li> <li>\u7b2c\u4e09\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u810f\u9875\u3002</li> </ul> <p>InnoDB \u7684\u7b56\u7565\u662f\u5c3d\u91cf\u4f7f\u7528\u5185\u5b58\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4e00\u4e2a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u5e93\u6765\u8bf4\uff0c\u672a\u88ab\u4f7f\u7528\u7684\u9875\u9762\u5f88\u5c11\u3002</p> <p>\u800c\u5f53\u8981\u8bfb\u5165\u7684\u6570\u636e\u9875\u6ca1\u6709\u5728\u5185\u5b58\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u5230\u7f13\u51b2\u6c60\u4e2d\u7533\u8bf7\u4e00\u4e2a\u6570\u636e\u9875\u3002\u8fd9\u65f6\u5019\u53ea\u80fd\u628a\u6700\u4e45\u4e0d\u4f7f\u7528\u7684\u6570\u636e\u9875\u4ece\u5185\u5b58\u4e2d\u6dd8\u6c70\u6389\uff1a\u5982\u679c\u8981\u6dd8\u6c70\u7684\u662f\u4e00\u4e2a\u5e72\u51c0\u9875\uff0c\u5c31\u76f4\u63a5\u91ca\u653e\u51fa\u6765\u590d\u7528\uff1b\u4f46\u5982\u679c\u662f\u810f\u9875\u5462\uff0c\u5c31\u5fc5\u987b\u5c06\u810f\u9875\u5148\u5237\u5230\u78c1\u76d8\uff0c\u53d8\u6210\u5e72\u51c0\u9875\u540e\u624d\u80fd\u590d\u7528\u3002</p> <p>\u6240\u4ee5\uff0c\u5237\u810f\u9875\u867d\u7136\u662f\u5e38\u6001\uff0c\u4f46\u662f\u51fa\u73b0\u4ee5\u4e0b\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u90fd\u662f\u4f1a\u660e\u663e\u5f71\u54cd\u6027\u80fd\u7684\uff1a</p> <ol> <li>\u4e00\u4e2a\u67e5\u8be2\u8981\u6dd8\u6c70\u7684\u810f\u9875\u4e2a\u6570\u592a\u591a\uff0c\u4f1a\u5bfc\u81f4\u67e5\u8be2\u7684\u54cd\u5e94\u65f6\u95f4\u660e\u663e\u53d8\u957f\uff1b</li> <li>\u65e5\u5fd7\u5199\u6ee1\uff0c\u66f4\u65b0\u5168\u90e8\u5835\u4f4f\uff0c\u5199\u6027\u80fd\u8dcc\u4e3a 0\uff0c\u8fd9\u79cd\u60c5\u51b5\u5bf9\u654f\u611f\u4e1a\u52a1\u6765\u8bf4\uff0c\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002</li> </ol> <p>\u6240\u4ee5\uff0cInnoDB \u9700\u8981\u6709\u63a7\u5236\u810f\u9875\u6bd4\u4f8b\u7684\u673a\u5236\uff0c\u6765\u5c3d\u91cf\u907f\u514d\u4e0a\u9762\u7684\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#innodb","title":"InnoDB \u5237\u810f\u9875\u7684\u63a7\u5236\u7b56\u7565","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u6765\u548c\u4f60\u8bf4\u8bf4 InnoDB \u810f\u9875\u7684\u63a7\u5236\u7b56\u7565\uff0c\u4ee5\u53ca\u548c\u8fd9\u4e9b\u7b56\u7565\u76f8\u5173\u7684\u53c2\u6570\u3002</p> <p>\u9996\u5148\uff0c\u4f60\u8981\u6b63\u786e\u5730\u544a\u8bc9 InnoDB \u6240\u5728\u4e3b\u673a\u7684 IO \u80fd\u529b\uff0c\u8fd9\u6837 InnoDB \u624d\u80fd\u77e5\u9053\u9700\u8981\u5168\u529b\u5237\u810f\u9875\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5237\u591a\u5feb\u3002</p> <p>\u8fd9\u5c31\u8981\u7528\u5230 <code>innodb_io_capacity</code> \u8fd9\u4e2a\u53c2\u6570\u4e86\uff0c\u5b83\u4f1a\u544a\u8bc9 InnoDB \u4f60\u7684\u78c1\u76d8\u80fd\u529b\u3002\u8fd9\u4e2a\u503c\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210\u78c1\u76d8\u7684 IOPS\u3002\u78c1\u76d8\u7684 IOPS \u53ef\u4ee5\u901a\u8fc7 fio \u8fd9\u4e2a\u5de5\u5177\u6765\u6d4b\u8bd5\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u662f\u6211\u7528\u6765\u6d4b\u8bd5\u78c1\u76d8\u968f\u673a\u8bfb\u5199\u7684\u547d\u4ee4\uff1a</p> <pre><code>fio -filename=mytest.img -direct=1 -iodepth 1 \\\n  -thread -rw=randrw -ioengine=psync -bs=16k \\\n  -size=500M -numjobs=10 -runtime=10 \\\n  -group_reporting -name=mytest \n</code></pre> <p>\u5176\u5b9e\uff0c\u56e0\u4e3a\u6ca1\u80fd\u6b63\u786e\u5730\u8bbe\u7f6e <code>innodb_io_capacity</code> \u53c2\u6570\uff0c\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u4e5f\u6bd4\u6bd4\u7686\u662f\u3002\u4e4b\u524d\uff0c\u5c31\u66fe\u6709\u5176\u4ed6\u516c\u53f8\u7684\u5f00\u53d1\u8d1f\u8d23\u4eba\u627e\u6211\u770b\u4e00\u4e2a\u5e93\u7684\u6027\u80fd\u95ee\u9898\uff0c\u8bf4 MySQL \u7684\u5199\u5165\u901f\u5ea6\u5f88\u6162\uff0cTPS \u5f88\u4f4e\uff0c\u4f46\u662f\u6570\u636e\u5e93\u4e3b\u673a\u7684 IO \u538b\u529b\u5e76\u4e0d\u5927\u3002\u7ecf\u8fc7\u4e00\u756a\u6392\u67e5\uff0c\u53d1\u73b0\u7f6a\u9b41\u7978\u9996\u5c31\u662f\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u51fa\u4e86\u95ee\u9898\u3002</p> <p>\u4ed6\u7684\u4e3b\u673a\u78c1\u76d8\u7528\u7684\u662f SSD\uff0c\u4f46\u662f <code>innodb_io_capacity</code> \u7684\u503c\u8bbe\u7f6e\u7684\u662f 300\u3002\u4e8e\u662f\uff0cInnoDB \u8ba4\u4e3a\u8fd9\u4e2a\u7cfb\u7edf\u7684\u80fd\u529b\u5c31\u8fd9\u4e48\u5dee\uff0c\u6240\u4ee5\u5237\u810f\u9875\u5237\u5f97\u7279\u522b\u6162\uff0c\u751a\u81f3\u6bd4\u810f\u9875\u751f\u6210\u7684\u901f\u5ea6\u8fd8\u6162\uff0c\u8fd9\u6837\u5c31\u9020\u6210\u4e86\u810f\u9875\u7d2f\u79ef\uff0c\u5f71\u54cd\u4e86\u67e5\u8be2\u548c\u66f4\u65b0\u6027\u80fd\u3002</p> <p>\u867d\u7136\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u5b9a\u4e49\u4e86\u201c\u5168\u529b\u5237\u810f\u9875\u201d\u7684\u884c\u4e3a\uff0c\u4f46\u5e73\u65f6\u603b\u4e0d\u80fd\u4e00\u76f4\u662f\u5168\u529b\u5237\u5427\uff1f\u6bd5\u7adf\u78c1\u76d8\u80fd\u529b\u4e0d\u80fd\u53ea\u7528\u6765\u5237\u810f\u9875\uff0c\u8fd8\u9700\u8981\u670d\u52a1\u7528\u6237\u8bf7\u6c42\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u770b\u770b InnoDB \u600e\u4e48\u63a7\u5236\u5f15\u64ce\u6309\u7167\u201c\u5168\u529b\u201d\u7684\u767e\u5206\u6bd4\u6765\u5237\u810f\u9875\u3002</p> <p>\u6839\u636e\u6211\u524d\u9762\u63d0\u5230\u7684\u77e5\u8bc6\u70b9\uff0c\u8bd5\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u6765\u8bbe\u8ba1\u7b56\u7565\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\uff0c\u4f1a\u53c2\u8003\u54ea\u4e9b\u56e0\u7d20\u5462\uff1f</p> <p>\u8fd9\u4e2a\u95ee\u9898\u53ef\u4ee5\u8fd9\u4e48\u60f3\uff0c\u5982\u679c\u5237\u592a\u6162\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\uff1f\u9996\u5148\u662f\u5185\u5b58\u810f\u9875\u592a\u591a\uff0c\u5176\u6b21\u662f redo log \u5199\u6ee1\u3002</p> <p>\u6240\u4ee5\uff0cInnoDB \u7684\u5237\u76d8\u901f\u5ea6\u5c31\u662f\u8981\u53c2\u8003\u8fd9\u4e24\u4e2a\u56e0\u7d20\uff1a\u4e00\u4e2a\u662f\u810f\u9875\u6bd4\u4f8b\uff0c\u4e00\u4e2a\u662f redo log \u5199\u76d8\u901f\u5ea6\u3002</p> <p>InnoDB \u4f1a\u6839\u636e\u8fd9\u4e24\u4e2a\u56e0\u7d20\u5148\u5355\u72ec\u7b97\u51fa\u4e24\u4e2a\u6570\u5b57\u3002</p> <p>\u53c2\u6570 <code>innodb_max_dirty_pages_pct</code> \u662f\u810f\u9875\u6bd4\u4f8b\u4e0a\u9650\uff0cMySQL 5.7 \u9ed8\u8ba4\u503c\u662f 75%, 8.0 \u5219\u53d8\u6210\u4e86 90%\u3002InnoDB \u4f1a\u6839\u636e\u5f53\u524d\u7684\u810f\u9875\u6bd4\u4f8b\uff08\u5047\u8bbe\u4e3a M\uff09\uff0c\u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u5728 0 \u5230 100 \u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8ba1\u7b97\u8fd9\u4e2a\u6570\u5b57\u7684\u4f2a\u4ee3\u7801\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code>F1(M)\n{\n  if M&gt;=innodb_max_dirty_pages_pct then\n      return 100;\n  return 100*M/innodb_max_dirty_pages_pct;\n}\n</code></pre> <p>InnoDB \u6bcf\u6b21\u5199\u5165\u7684\u65e5\u5fd7\u90fd\u6709\u4e00\u4e2a\u5e8f\u53f7\uff0c\u5f53\u524d\u5199\u5165\u7684\u5e8f\u53f7\u8ddf checkpoint \u5bf9\u5e94\u7684\u5e8f\u53f7\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u6211\u4eec\u5047\u8bbe\u4e3a N\u3002InnoDB \u4f1a\u6839\u636e\u8fd9\u4e2a N \u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u5728 0 \u5230 100 \u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8fd9\u4e2a\u8ba1\u7b97\u516c\u5f0f\u53ef\u4ee5\u8bb0\u4e3a F2(N)\u3002F2(N) \u7b97\u6cd5\u6bd4\u8f83\u590d\u6742\uff0c\u4f60\u53ea\u8981\u77e5\u9053 N \u8d8a\u5927\uff0c\u7b97\u51fa\u6765\u7684\u503c\u8d8a\u5927\u5c31\u597d\u4e86\u3002</p> <p>\u7136\u540e\uff0c\u6839\u636e\u4e0a\u8ff0\u7b97\u5f97\u7684 F1(M) \u548c F2(N) \u4e24\u4e2a\u503c\uff0c\u53d6\u5176\u4e2d\u8f83\u5927\u7684\u503c\u8bb0\u4e3a R\uff0c\u4e4b\u540e\u5f15\u64ce\u5c31\u53ef\u4ee5\u6309\u7167 innodb_io_capacity \u5b9a\u4e49\u7684\u80fd\u529b\u4e58\u4ee5 R% \u6765\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\u3002</p> <p>\u4e0a\u8ff0\u7684\u8ba1\u7b97\u6d41\u7a0b\u6bd4\u8f83\u62bd\u8c61\uff0c\u4e0d\u5bb9\u6613\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u753b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u6d41\u7a0b\u56fe\u3002\u56fe\u4e2d\u7684 F1\u3001F2 \u5c31\u662f\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u810f\u9875\u6bd4\u4f8b\u548c redo log \u5199\u5165\u901f\u5ea6\u7b97\u51fa\u6765\u7684\u4e24\u4e2a\u503c\u3002</p> <pre><code>%%{ init: {\"flowchart\": {\"curve\": \"catmullRom\"}}}%%\ngraph TB\n    begin((\" \"))\n    begin --&gt; M(\"\u810f\u9875\u6bd4\u4f8bM&lt;br/&gt;max_dirty_pages_pct\")\n    begin --&gt; N(\"(\u5f53\u524d\u65e5\u5fd7\u5e8f\u5217 - checkponit) N\")\n    M --&gt; F1\n    N --&gt; F2\n    F1 --&gt; R[\"R = max{F1,F2}\"]\n    F2 --&gt; R\n    R --&gt; refresh(\"\u6309\u7167 R% \u901f\u5ea6\u5237\u65b0\u810f\u9875\")\n    refresh --&gt; over((\"   \"))\n\n    over .-&gt; begin</code></pre> <p>\u56fe 3 InnoDB \u5237\u810f\u9875\u901f\u5ea6\u7b56\u7565</p> <p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0cInnoDB \u4f1a\u5728\u540e\u53f0\u5237\u810f\u9875\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u662f\u8981\u5c06\u5185\u5b58\u9875\u5199\u5165\u78c1\u76d8\u3002\u6240\u4ee5\uff0c\u65e0\u8bba\u662f\u4f60\u7684\u67e5\u8be2\u8bed\u53e5\u5728\u9700\u8981\u5185\u5b58\u7684\u65f6\u5019\u53ef\u80fd\u8981\u6c42\u6dd8\u6c70\u4e00\u4e2a\u810f\u9875\uff0c\u8fd8\u662f\u7531\u4e8e\u5237\u810f\u9875\u7684\u903b\u8f91\u4f1a\u5360\u7528 IO \u8d44\u6e90\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u4e86\u4f60\u7684\u66f4\u65b0\u8bed\u53e5\uff0c\u90fd\u53ef\u80fd\u662f\u9020\u6210\u4f60\u4ece\u4e1a\u52a1\u7aef\u611f\u77e5\u5230 MySQL\u201c\u6296\u201d\u4e86\u4e00\u4e0b\u7684\u539f\u56e0\u3002</p> <p>\u8981\u5c3d\u91cf\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u5c31\u8981\u5408\u7406\u5730\u8bbe\u7f6e <code>innodb_io_capacity</code> \u7684\u503c\uff0c\u5e76\u4e14**\u5e73\u65f6\u8981\u591a\u5173\u6ce8\u810f\u9875\u6bd4\u4f8b\uff0c\u4e0d\u8981\u8ba9\u5b83\u7ecf\u5e38\u63a5\u8fd1 75%**\u3002</p> <p>\u5176\u4e2d\uff0c\u810f\u9875\u6bd4\u4f8b\u662f\u901a\u8fc7 <code>Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total</code> \u5f97\u5230\u7684\uff0c\u5177\u4f53\u7684\u547d\u4ee4\u53c2\u8003\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p> <pre><code>mysql&gt; set global show_compatibility_56=1; -- turn on if version &gt; 5.7.6\nmysql&gt; SELECT VARIABLE_VALUE / (\nSELECT VARIABLE_VALUE * 1.0\nFROM information_schema.GLOBAL_STATUS\nWHERE VARIABLE_NAME = 'Innodb_buffer_pool_pages_total'\n) AS ratio\nFROM information_schema.GLOBAL_STATUS\nWHERE VARIABLE_NAME = 'Innodb_buffer_pool_pages_dirty';\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u6709\u8da3\u7684\u7b56\u7565\u3002</p> <p>\u4e00\u65e6\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u9700\u8981\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5148 flush \u6389\u4e00\u4e2a\u810f\u9875\u65f6\uff0c\u8fd9\u4e2a\u67e5\u8be2\u5c31\u53ef\u80fd\u8981\u6bd4\u5e73\u65f6\u6162\u4e86\u3002\u800c MySQL \u4e2d\u7684\u4e00\u4e2a\u673a\u5236\uff0c\u53ef\u80fd\u8ba9\u4f60\u7684\u67e5\u8be2\u4f1a\u66f4\u6162\uff1a\u5728\u51c6\u5907\u5237\u4e00\u4e2a\u810f\u9875\u7684\u65f6\u5019\uff0c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u65c1\u8fb9\u7684\u6570\u636e\u9875\u521a\u597d\u662f\u810f\u9875\uff0c\u5c31\u4f1a\u628a\u8fd9\u4e2a\u201c\u90bb\u5c45\u201d\u4e5f\u5e26\u7740\u4e00\u8d77\u5237\u6389\uff1b\u800c\u4e14\u8fd9\u4e2a\u628a\u201c\u90bb\u5c45\u201d\u62d6\u4e0b\u6c34\u7684\u903b\u8f91\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u8513\u5ef6\uff0c\u4e5f\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u90bb\u5c45\u6570\u636e\u9875\uff0c\u5982\u679c\u8ddf\u5b83\u76f8\u90bb\u7684\u6570\u636e\u9875\u4e5f\u8fd8\u662f\u810f\u9875\u7684\u8bdd\uff0c\u4e5f\u4f1a\u88ab\u653e\u5230\u4e00\u8d77\u5237\u3002</p> <p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_flush_neighbors</code> \u53c2\u6570\u5c31\u662f\u7528\u6765\u63a7\u5236\u8fd9\u4e2a\u884c\u4e3a\u7684\uff0c\u503c\u4e3a 1 \u7684\u65f6\u5019\u4f1a\u6709\u4e0a\u8ff0\u7684\u201c\u8fde\u5750\u201d\u673a\u5236\uff0c\u503c\u4e3a 0 \u65f6\u8868\u793a\u4e0d\u627e\u90bb\u5c45\uff0c\u81ea\u5df1\u5237\u81ea\u5df1\u7684\u3002</p> <p>\u627e\u201c\u90bb\u5c45\u201d\u8fd9\u4e2a\u4f18\u5316\u5728\u673a\u68b0\u786c\u76d8\u65f6\u4ee3\u662f\u5f88\u6709\u610f\u4e49\u7684\uff0c\u53ef\u4ee5\u51cf\u5c11\u5f88\u591a\u968f\u673a IO\u3002\u673a\u68b0\u786c\u76d8\u7684\u968f\u673a IOPS \u4e00\u822c\u53ea\u6709\u51e0\u767e\uff0c\u76f8\u540c\u7684\u903b\u8f91\u64cd\u4f5c\u51cf\u5c11\u968f\u673a IO \u5c31\u610f\u5473\u7740\u7cfb\u7edf\u6027\u80fd\u7684\u5927\u5e45\u5ea6\u63d0\u5347\u3002</p> <p>\u800c\u5982\u679c\u4f7f\u7528\u7684\u662f SSD \u8fd9\u7c7b IOPS \u6bd4\u8f83\u9ad8\u7684\u8bbe\u5907\u7684\u8bdd\uff0c\u6211\u5c31\u5efa\u8bae\u4f60\u628a <code>innodb_flush_neighbors</code> \u7684\u503c\u8bbe\u7f6e\u6210 0\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019 IOPS \u5f80\u5f80\u4e0d\u662f\u74f6\u9888\uff0c\u800c\u201c\u53ea\u5237\u81ea\u5df1\u201d\uff0c\u5c31\u80fd\u66f4\u5feb\u5730\u6267\u884c\u5b8c\u5fc5\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\uff0c\u51cf\u5c11 SQL \u8bed\u53e5\u54cd\u5e94\u65f6\u95f4\u3002</p> <p>\u5728 MySQL 8.0 \u4e2d\uff0c<code>innodb_flush_neighbors</code> \u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u5df2\u7ecf\u662f 0 \u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_7","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5ef6\u7eed\u7b2c 2 \u7bc7\u4e2d\u4ecb\u7ecd\u7684 WAL \u7684\u6982\u5ff5\uff0c\u548c\u4f60\u89e3\u91ca\u4e86\u8fd9\u4e2a\u673a\u5236\u540e\u7eed\u9700\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\u548c\u6267\u884c\u65f6\u673a\u3002\u5229\u7528 WAL \u6280\u672f\uff0c\u6570\u636e\u5e93\u5c06\u968f\u673a\u5199\u8f6c\u6362\u6210\u4e86\u987a\u5e8f\u5199\uff0c\u5927\u5927\u63d0\u5347\u4e86\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p> <p>\u4f46\u662f\uff0c\u7531\u6b64\u4e5f\u5e26\u6765\u4e86\u5185\u5b58\u810f\u9875\u7684\u95ee\u9898\u3002\u810f\u9875\u4f1a\u88ab\u540e\u53f0\u7ebf\u7a0b\u81ea\u52a8 flush\uff0c\u4e5f\u4f1a\u7531\u4e8e\u6570\u636e\u9875\u6dd8\u6c70\u800c\u89e6\u53d1 flush\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u7531\u4e8e\u4f1a\u5360\u7528\u8d44\u6e90\uff0c\u53ef\u80fd\u4f1a\u8ba9\u4f60\u7684\u66f4\u65b0\u548c\u67e5\u8be2\u8bed\u53e5\u7684\u54cd\u5e94\u65f6\u95f4\u957f\u4e00\u4e9b\u3002\u5728\u6587\u7ae0\u91cc\uff0c\u6211\u4e5f\u7ed9\u4f60\u4ecb\u7ecd\u4e86\u63a7\u5236\u5237\u810f\u9875\u7684\u65b9\u6cd5\u548c\u5bf9\u5e94\u7684\u76d1\u63a7\u65b9\u5f0f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#13","title":"13 \u4e3a\u4ec0\u4e48\u8868\u6570\u636e\u5220\u6389\u4e00\u534a\uff0c\u8868\u6587\u4ef6\u5927\u5c0f\u4e0d\u53d8\uff1f","text":"<p>\u7ecf\u5e38\u4f1a\u6709\u540c\u5b66\u6765\u95ee\u6211\uff0c\u6211\u7684\u6570\u636e\u5e93\u5360\u7528\u7a7a\u95f4\u592a\u5927\uff0c\u6211\u628a\u4e00\u4e2a\u6700\u5927\u7684\u8868\u5220\u6389\u4e86\u4e00\u534a\u7684\u6570\u636e\uff0c\u600e\u4e48\u8868\u6587\u4ef6\u7684\u5927\u5c0f\u8fd8\u662f\u6ca1\u53d8\uff1f</p> <p>\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u5c31\u548c\u4f60\u804a\u804a\u6570\u636e\u5e93\u8868\u7684\u7a7a\u95f4\u56de\u6536\uff0c\u770b\u770b\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u8fd8\u662f\u9488\u5bf9 MySQL \u4e2d\u5e94\u7528\u6700\u5e7f\u6cdb\u7684 InnoDB \u5f15\u64ce\u5c55\u5f00\u8ba8\u8bba\u3002\u4e00\u4e2a InnoDB \u8868\u5305\u542b\u4e24\u90e8\u5206\uff0c\u5373\uff1a\u8868\u7ed3\u6784\u5b9a\u4e49\u548c\u6570\u636e\u3002\u5728 MySQL 8.0 \u7248\u672c\u4ee5\u524d\uff0c\u8868\u7ed3\u6784\u662f\u5b58\u5728\u4ee5 <code>.frm</code> \u4e3a\u540e\u7f00\u7684\u6587\u4ef6\u91cc\u3002</p> <p>\u800c MySQL 8.0 \u7248\u672c\uff0c\u5219\u5df2\u7ecf\u5141\u8bb8\u628a\u8868\u7ed3\u6784\u5b9a\u4e49\u653e\u5728\u7cfb\u7edf\u6570\u636e\u8868\u4e2d\u4e86\u3002\u56e0\u4e3a\u8868\u7ed3\u6784\u5b9a\u4e49\u5360\u7528\u7684\u7a7a\u95f4\u5f88\u5c0f\uff0c\u6240\u4ee5\u6211\u4eec\u4eca\u5929\u4e3b\u8981\u8ba8\u8bba\u7684\u662f\u8868\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4f1a\u5148\u548c\u4f60\u8bf4\u660e\u4e3a\u4ec0\u4e48\u7b80\u5355\u5730\u5220\u9664\u8868\u6570\u636e\u8fbe\u4e0d\u5230\u8868\u7a7a\u95f4\u56de\u6536\u7684\u6548\u679c\uff0c\u7136\u540e\u518d\u548c\u4f60\u4ecb\u7ecd\u6b63\u786e\u56de\u6536\u7a7a\u95f4\u7684\u65b9\u6cd5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#innodb_file_per_table","title":"\u53c2\u6570 <code>innodb_file_per_table</code>","text":"<p>\u8868\u6570\u636e\u65e2\u53ef\u4ee5\u5b58\u5728\u5171\u4eab\u8868\u7a7a\u95f4\u91cc\uff0c\u4e5f\u53ef\u4ee5\u662f\u5355\u72ec\u7684\u6587\u4ef6\u3002\u8fd9\u4e2a\u884c\u4e3a\u662f\u7531\u53c2\u6570 <code>innodb_file_per_table</code> \u63a7\u5236\u7684\uff1a</p> <ol> <li>\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a <code>OFF</code> \u8868\u793a\u7684\u662f\uff0c\u8868\u7684\u6570\u636e\u653e\u5728\u7cfb\u7edf\u5171\u4eab\u8868\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u8ddf\u6570\u636e\u5b57\u5178\u653e\u5728\u4e00\u8d77\uff1b</li> <li>\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a <code>ON</code> \u8868\u793a\u7684\u662f\uff0c\u6bcf\u4e2a InnoDB \u8868\u6570\u636e\u5b58\u50a8\u5728\u4e00\u4e2a\u4ee5 .ibd \u4e3a\u540e\u7f00\u7684\u6587\u4ef6\u4e2d\u3002</li> </ol> <p>\u4ece MySQL 5.6.6 \u7248\u672c\u5f00\u59cb\uff0c\u5b83\u7684\u9ed8\u8ba4\u503c\u5c31\u662f ON \u4e86\u3002</p> <p>\u6211\u5efa\u8bae\u4f60\u4e0d\u8bba\u4f7f\u7528 MySQL \u7684\u54ea\u4e2a\u7248\u672c\uff0c\u90fd\u5c06\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a ON\u3002</p> <p>\u56e0\u4e3a\uff0c\u4e00\u4e2a\u8868\u5355\u72ec\u5b58\u50a8\u4e3a\u4e00\u4e2a\u6587\u4ef6\u66f4\u5bb9\u6613\u7ba1\u7406\uff0c\u800c\u4e14\u5728\u4f60\u4e0d\u9700\u8981\u8fd9\u4e2a\u8868\u7684\u65f6\u5019\uff0c\u901a\u8fc7 <code>drop table</code> \u547d\u4ee4\uff0c\u7cfb\u7edf\u5c31\u4f1a\u76f4\u63a5\u5220\u9664\u8fd9\u4e2a\u6587\u4ef6\u3002\u800c\u5982\u679c\u662f\u653e\u5728\u5171\u4eab\u8868\u7a7a\u95f4\u4e2d\uff0c\u5373\u4f7f\u8868\u5220\u6389\u4e86\uff0c\u7a7a\u95f4\u4e5f\u662f\u4e0d\u4f1a\u56de\u6536\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u5c06 <code>innodb_file_per_table</code> \u8bbe\u7f6e\u4e3a ON\uff0c\u662f\u63a8\u8350\u505a\u6cd5\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u7684\u8ba8\u8bba\u90fd\u662f\u57fa\u4e8e\u8fd9\u4e2a\u8bbe\u7f6e\u5c55\u5f00\u7684\u3002</p> <p>\u6211\u4eec\u5728\u5220\u9664\u6574\u4e2a\u8868\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>drop table</code> \u547d\u4ee4\u56de\u6536\u8868\u7a7a\u95f4\u3002\u4f46\u662f\uff0c\u6211\u4eec\u9047\u5230\u7684\u66f4\u591a\u7684\u5220\u9664\u6570\u636e\u7684\u573a\u666f\u662f\u5220\u9664\u67d0\u4e9b\u884c\uff0c\u8fd9\u65f6\u5c31\u9047\u5230\u4e86\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff1a\u8868\u4e2d\u7684\u6570\u636e\u88ab\u5220\u9664\u4e86\uff0c\u4f46\u662f\u8868\u7a7a\u95f4\u5374\u6ca1\u6709\u88ab\u56de\u6536\u3002</p> <p>\u6211\u4eec\u8981\u5f7b\u5e95\u641e\u660e\u767d\u8fd9\u4e2a\u95ee\u9898\u7684\u8bdd\uff0c\u5c31\u8981\u4ece\u6570\u636e\u5220\u9664\u6d41\u7a0b\u8bf4\u8d77\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_8","title":"\u6570\u636e\u5220\u9664\u6d41\u7a0b","text":"<p>\u6211\u4eec\u5148\u518d\u6765\u770b\u4e00\u4e0b InnoDB \u4e2d\u4e00\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002\u5728\u524d\u9762\u7b2c4\u548c\u7b2c5\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u7d22\u5f15\u65f6\u66fe\u7ecf\u63d0\u5230\u8fc7\uff0cInnoDB \u91cc\u7684\u6570\u636e\u90fd\u662f\u7528 B+ \u6811\u7684\u7ed3\u6784\u7ec4\u7ec7\u7684\u3002</p> <p></p> <p>\u5047\u8bbe\uff0c\u6211\u4eec\u8981\u5220\u6389 R4 \u8fd9\u4e2a\u8bb0\u5f55\uff0cInnoDB \u5f15\u64ce\u53ea\u4f1a\u628a R4 \u8fd9\u4e2a\u8bb0\u5f55\u6807\u8bb0\u4e3a\u5220\u9664\u3002\u5982\u679c\u4e4b\u540e\u8981\u518d\u63d2\u5165\u4e00\u4e2a ID \u5728 300 \u548c 600 \u4e4b\u95f4\u7684\u8bb0\u5f55\u65f6\uff0c\u53ef\u80fd\u4f1a\u590d\u7528\u8fd9\u4e2a\u4f4d\u7f6e\u3002\u4f46\u662f\uff0c\u78c1\u76d8\u6587\u4ef6\u7684\u5927\u5c0f\u5e76\u4e0d\u4f1a\u7f29\u5c0f\u3002</p> <p>\u73b0\u5728\uff0c\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86 InnoDB \u7684\u6570\u636e\u662f\u6309\u9875\u5b58\u50a8\u7684\uff0c\u90a3\u4e48\u5982\u679c\u6211\u4eec\u5220\u6389\u4e86\u4e00\u4e2a\u6570\u636e\u9875\u4e0a\u7684\u6240\u6709\u8bb0\u5f55\uff0c\u4f1a\u600e\u4e48\u6837\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u6574\u4e2a\u6570\u636e\u9875\u5c31\u53ef\u4ee5\u88ab\u590d\u7528\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u6570\u636e\u9875\u7684\u590d\u7528\u8ddf\u8bb0\u5f55\u7684\u590d\u7528\u662f\u4e0d\u540c\u7684\u3002</p> <p>\u8bb0\u5f55\u7684\u590d\u7528\uff0c\u53ea\u9650\u4e8e\u7b26\u5408\u8303\u56f4\u6761\u4ef6\u7684\u6570\u636e\u3002\u6bd4\u5982\u4e0a\u9762\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0cR4 \u8fd9\u6761\u8bb0\u5f55\u88ab\u5220\u9664\u540e\uff0c\u5982\u679c\u63d2\u5165\u4e00\u4e2a ID \u662f 400 \u7684\u884c\uff0c\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u8fd9\u4e2a\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u63d2\u5165\u7684\u662f\u4e00\u4e2a ID \u662f 800 \u7684\u884c\uff0c\u5c31\u4e0d\u80fd\u590d\u7528\u8fd9\u4e2a\u4f4d\u7f6e\u4e86\u3002</p> <p>\u800c\u5f53\u6574\u4e2a\u9875\u4ece B+ \u6811\u91cc\u9762\u6458\u6389\u4ee5\u540e\uff0c\u53ef\u4ee5\u590d\u7528\u5230\u4efb\u4f55\u4f4d\u7f6e\u3002\u4ee5\u56fe 1 \u4e3a\u4f8b\uff0c\u5982\u679c\u5c06\u6570\u636e\u9875 page A \u4e0a\u7684\u6240\u6709\u8bb0\u5f55\u5220\u9664\u4ee5\u540e\uff0cpage A \u4f1a\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002\u8fd9\u65f6\u5019\u5982\u679c\u8981\u63d2\u5165\u4e00\u6761 ID=50 \u7684\u8bb0\u5f55\u9700\u8981\u4f7f\u7528\u65b0\u9875\u7684\u65f6\u5019\uff0cpage A \u662f\u53ef\u4ee5\u88ab\u590d\u7528\u7684\u3002</p> <p>\u5982\u679c\u76f8\u90bb\u7684\u4e24\u4e2a\u6570\u636e\u9875\u5229\u7528\u7387\u90fd\u5f88\u5c0f\uff0c\u7cfb\u7edf\u5c31\u4f1a\u628a\u8fd9\u4e24\u4e2a\u9875\u4e0a\u7684\u6570\u636e\u5408\u5230\u5176\u4e2d\u4e00\u4e2a\u9875\u4e0a\uff0c\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u9875\u5c31\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002</p> <p>\u8fdb\u4e00\u6b65\u5730\uff0c\u5982\u679c\u6211\u4eec\u7528 <code>delete</code> \u547d\u4ee4\u628a\u6574\u4e2a\u8868\u7684\u6570\u636e\u5220\u9664\u5462\uff1f\u7ed3\u679c\u5c31\u662f\uff0c\u6240\u6709\u7684\u6570\u636e\u9875\u90fd\u4f1a\u88ab\u6807\u8bb0\u4e3a\u53ef\u590d\u7528\u3002\u4f46\u662f\u78c1\u76d8\u4e0a\uff0c\u6587\u4ef6\u4e0d\u4f1a\u53d8\u5c0f\u3002</p> <p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c<code>delete</code> \u547d\u4ee4\u5176\u5b9e\u53ea\u662f\u628a\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u6216\u8005\u6570\u636e\u9875\u6807\u8bb0\u4e3a\u4e86\u201c\u53ef\u590d\u7528\u201d\uff0c\u4f46\u78c1\u76d8\u6587\u4ef6\u7684\u5927\u5c0f\u662f\u4e0d\u4f1a\u53d8\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u901a\u8fc7 <code>delete</code> \u547d\u4ee4\u662f\u4e0d\u80fd\u56de\u6536\u8868\u7a7a\u95f4\u7684\u3002\u8fd9\u4e9b\u53ef\u4ee5\u590d\u7528\uff0c\u800c\u6ca1\u6709\u88ab\u4f7f\u7528\u7684\u7a7a\u95f4\uff0c\u770b\u8d77\u6765\u5c31\u50cf\u662f\u201c\u7a7a\u6d1e\u201d\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u4e0d\u6b62\u662f\u5220\u9664\u6570\u636e\u4f1a\u9020\u6210\u7a7a\u6d1e\uff0c\u63d2\u5165\u6570\u636e\u4e5f\u4f1a\u3002</p> <p>\u5982\u679c\u6570\u636e\u662f\u6309\u7167\u7d22\u5f15\u9012\u589e\u987a\u5e8f\u63d2\u5165\u7684\uff0c\u90a3\u4e48\u7d22\u5f15\u662f\u7d27\u51d1\u7684\u3002\u4f46\u5982\u679c\u6570\u636e\u662f\u968f\u673a\u63d2\u5165\u7684\uff0c\u5c31\u53ef\u80fd\u9020\u6210\u7d22\u5f15\u7684\u6570\u636e\u9875\u5206\u88c2\u3002</p> <p>\u5047\u8bbe\u56fe 1 \u4e2d page A \u5df2\u7ecf\u6ee1\u4e86\uff0c\u8fd9\u65f6\u6211\u8981\u518d\u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u4f1a\u600e\u6837\u5462\uff1f</p> <p></p> <p>\u56fe 2 \u63d2\u5165\u6570\u636e\u5bfc\u81f4\u9875\u5206\u88c2</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e page A \u6ee1\u4e86\uff0c\u518d\u63d2\u5165\u4e00\u4e2a ID \u662f 550 \u7684\u6570\u636e\u65f6\uff0c\u5c31\u4e0d\u5f97\u4e0d\u518d\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u9875\u9762 page B \u6765\u4fdd\u5b58\u6570\u636e\u4e86\u3002\u9875\u5206\u88c2\u5b8c\u6210\u540e\uff0cpage A \u7684\u672b\u5c3e\u5c31\u7559\u4e0b\u4e86\u7a7a\u6d1e\uff08\u6ce8\u610f\uff1a\u5b9e\u9645\u4e0a\uff0c\u53ef\u80fd\u4e0d\u6b62 1 \u4e2a\u8bb0\u5f55\u7684\u4f4d\u7f6e\u662f\u7a7a\u6d1e\uff09\u3002</p> <p>\u53e6\u5916\uff0c\u66f4\u65b0\u7d22\u5f15\u4e0a\u7684\u503c\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5220\u9664\u4e00\u4e2a\u65e7\u7684\u503c\uff0c\u518d\u63d2\u5165\u4e00\u4e2a\u65b0\u503c\u3002\u4e0d\u96be\u7406\u89e3\uff0c\u8fd9\u4e5f\u662f\u4f1a\u9020\u6210\u7a7a\u6d1e\u7684\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u7ecf\u8fc7\u5927\u91cf\u589e\u5220\u6539\u7684\u8868\uff0c\u90fd\u662f\u53ef\u80fd\u662f\u5b58\u5728\u7a7a\u6d1e\u7684\u3002\u6240\u4ee5\uff0c\u5982\u679c\u80fd\u591f\u628a\u8fd9\u4e9b\u7a7a\u6d1e\u53bb\u6389\uff0c\u5c31\u80fd\u8fbe\u5230\u6536\u7f29\u8868\u7a7a\u95f4\u7684\u76ee\u7684\u3002</p> <p>\u800c\u91cd\u5efa\u8868\uff0c\u5c31\u53ef\u4ee5\u8fbe\u5230\u8fd9\u6837\u7684\u76ee\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_9","title":"\u91cd\u5efa\u8868","text":"<p>\u8bd5\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u73b0\u5728\u6709\u4e00\u4e2a\u8868 A\uff0c\u9700\u8981\u505a\u7a7a\u95f4\u6536\u7f29\uff0c\u4e3a\u4e86\u628a\u8868\u4e2d\u5b58\u5728\u7684\u7a7a\u6d1e\u53bb\u6389\uff0c\u4f60\u53ef\u4ee5\u600e\u4e48\u505a\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u4e0e\u8868 A \u7ed3\u6784\u76f8\u540c\u7684\u8868 B\uff0c\u7136\u540e\u6309\u7167\u4e3b\u952e ID \u9012\u589e\u7684\u987a\u5e8f\uff0c\u628a\u6570\u636e\u4e00\u884c\u4e00\u884c\u5730\u4ece\u8868 A \u91cc\u8bfb\u51fa\u6765\u518d\u63d2\u5165\u5230\u8868 B \u4e2d\u3002</p> <p>\u7531\u4e8e\u8868 B \u662f\u65b0\u5efa\u7684\u8868\uff0c\u6240\u4ee5\u8868 A \u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\u7a7a\u6d1e\uff0c\u5728\u8868 B \u4e2d\u5c31\u90fd\u4e0d\u5b58\u5728\u4e86\u3002\u663e\u7136\u5730\uff0c\u8868 B \u7684\u4e3b\u952e\u7d22\u5f15\u66f4\u7d27\u51d1\uff0c\u6570\u636e\u9875\u7684\u5229\u7528\u7387\u4e5f\u66f4\u9ad8\u3002\u5982\u679c\u6211\u4eec\u628a\u8868 B \u4f5c\u4e3a\u4e34\u65f6\u8868\uff0c\u6570\u636e\u4ece\u8868 A \u5bfc\u5165\u8868 B \u7684\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u7528\u8868 B \u66ff\u6362 A\uff0c\u4ece\u6548\u679c\u4e0a\u770b\uff0c\u5c31\u8d77\u5230\u4e86\u6536\u7f29\u8868 A \u7a7a\u95f4\u7684\u4f5c\u7528\u3002</p> <p>\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>alter table A engine=InnoDB</code> \u547d\u4ee4\u6765\u91cd\u5efa\u8868\u3002\u5728 MySQL 5.5 \u7248\u672c\u4e4b\u524d\uff0c\u8fd9\u4e2a\u547d\u4ee4\u7684\u6267\u884c\u6d41\u7a0b\u8ddf\u6211\u4eec\u524d\u9762\u63cf\u8ff0\u7684\u5dee\u4e0d\u591a\uff0c\u533a\u522b\u53ea\u662f\u8fd9\u4e2a\u4e34\u65f6\u8868 B \u4e0d\u9700\u8981\u4f60\u81ea\u5df1\u521b\u5efa\uff0cMySQL \u4f1a\u81ea\u52a8\u5b8c\u6210\u8f6c\u5b58\u6570\u636e\u3001\u4ea4\u6362\u8868\u540d\u3001\u5220\u9664\u65e7\u8868\u7684\u64cd\u4f5c\u3002</p> <p></p> <p>\u56fe 3 \u6539\u9501\u8868 DDL</p> <p>\u663e\u7136\uff0c\u82b1\u65f6\u95f4\u6700\u591a\u7684\u6b65\u9aa4\u662f\u5f80\u4e34\u65f6\u8868\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6709\u65b0\u7684\u6570\u636e\u8981\u5199\u5165\u5230\u8868 A \u7684\u8bdd\uff0c\u5c31\u4f1a\u9020\u6210\u6570\u636e\u4e22\u5931\u3002\u56e0\u6b64\uff0c\u5728\u6574\u4e2a DDL \u8fc7\u7a0b\u4e2d\uff0c\u8868 A \u4e2d\u4e0d\u80fd\u6709\u66f4\u65b0\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a DDL \u4e0d\u662f Online \u7684\u3002</p> <p>\u800c\u5728**MySQL 5.6 \u7248\u672c\u5f00\u59cb\u5f15\u5165\u7684 Online DDL\uff0c\u5bf9\u8fd9\u4e2a\u64cd\u4f5c\u6d41\u7a0b\u505a\u4e86\u4f18\u5316\u3002**</p> <p>\u6211\u7ed9\u4f60\u7b80\u5355\u63cf\u8ff0\u4e00\u4e0b\u5f15\u5165\u4e86 Online DDL \u4e4b\u540e\uff0c\u91cd\u5efa\u8868\u7684\u6d41\u7a0b\uff1a</p> <ol> <li>\u5efa\u7acb\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u626b\u63cf\u8868 A \u4e3b\u952e\u7684\u6240\u6709\u6570\u636e\u9875\uff1b</li> <li>\u7528\u6570\u636e\u9875\u4e2d\u8868 A \u7684\u8bb0\u5f55\u751f\u6210 B+ \u6811\uff0c\u5b58\u50a8\u5230\u4e34\u65f6\u6587\u4ef6\u4e2d\uff1b</li> <li>\u751f\u6210\u4e34\u65f6\u6587\u4ef6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5c06\u6240\u6709\u5bf9 A \u7684\u64cd\u4f5c\u8bb0\u5f55\u5728\u4e00\u4e2a\u65e5\u5fd7\u6587\u4ef6\uff08row log\uff09\u4e2d\uff0c\u5bf9\u5e94\u7684\u662f\u56fe\u4e2d state2 \u7684\u72b6\u6001\uff1b</li> <li>\u4e34\u65f6\u6587\u4ef6\u751f\u6210\u540e\uff0c\u5c06\u65e5\u5fd7\u6587\u4ef6\u4e2d\u7684\u64cd\u4f5c\u5e94\u7528\u5230\u4e34\u65f6\u6587\u4ef6\uff0c\u5f97\u5230\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u4e0a\u4e0e\u8868 A \u76f8\u540c\u7684\u6570\u636e\u6587\u4ef6\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u56fe\u4e2d state3 \u7684\u72b6\u6001\uff1b</li> <li>\u7528\u4e34\u65f6\u6587\u4ef6\u66ff\u6362\u8868 A \u7684\u6570\u636e\u6587\u4ef6\u3002</li> </ol> <p></p> <p>\u56fe 4 Online DDL</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0e\u56fe 3 \u8fc7\u7a0b\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c\u7531\u4e8e\u65e5\u5fd7\u6587\u4ef6\u8bb0\u5f55\u548c\u91cd\u653e\u64cd\u4f5c\u8fd9\u4e2a\u529f\u80fd\u7684\u5b58\u5728\uff0c\u8fd9\u4e2a\u65b9\u6848\u5728\u91cd\u5efa\u8868\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5141\u8bb8\u5bf9\u8868 A \u505a\u589e\u5220\u6539\u64cd\u4f5c\u3002\u8fd9\u4e5f\u5c31\u662f Online DDL \u540d\u5b57\u7684\u6765\u6e90\u3002</p> <p>\u6211\u8bb0\u5f97\u6709\u540c\u5b66\u5728\u7b2c 6 \u7bc7\u8bb2\u8868\u9501\u7684\u6587\u7ae0[\u300a\u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u7d22\u8fd9\u4e48\u591a\u963b\u788d\uff1f\u300b]\u7684\u8bc4\u8bba\u533a\u7559\u8a00\u8bf4\uff0cDDL \u4e4b\u524d\u662f\u8981\u62ff MDL \u5199\u9501\u7684\uff0c\u8fd9\u6837\u8fd8\u80fd\u53eb Online DDL \u5417\uff1f</p> <p>\u786e\u5b9e\uff0c\u56fe 4 \u7684\u6d41\u7a0b\u4e2d\uff0calter \u8bed\u53e5\u5728\u542f\u52a8\u7684\u65f6\u5019\u9700\u8981\u83b7\u53d6 MDL \u5199\u9501\uff0c\u4f46\u662f\u8fd9\u4e2a\u5199\u9501\u5728\u771f\u6b63\u62f7\u8d1d\u6570\u636e\u4e4b\u524d\u5c31\u9000\u5316\u6210\u8bfb\u9501\u4e86\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8981\u9000\u5316\u5462\uff1f\u4e3a\u4e86\u5b9e\u73b0 Online\uff0cMDL \u8bfb\u9501\u4e0d\u4f1a\u963b\u585e\u589e\u5220\u6539\u64cd\u4f5c\u3002</p> <p>\u90a3\u4e3a\u4ec0\u4e48\u4e0d\u5e72\u8106\u76f4\u63a5\u89e3\u9501\u5462\uff1f\u4e3a\u4e86\u4fdd\u62a4\u81ea\u5df1\uff0c\u7981\u6b62\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u540c\u65f6\u505a DDL\u3002</p> <p>\u800c\u5bf9\u4e8e\u4e00\u4e2a\u5927\u8868\u6765\u8bf4\uff0cOnline DDL \u6700\u8017\u65f6\u7684\u8fc7\u7a0b\u5c31\u662f\u62f7\u8d1d\u6570\u636e\u5230\u4e34\u65f6\u8868\u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u7684\u6267\u884c\u671f\u95f4\u53ef\u4ee5\u63a5\u53d7\u589e\u5220\u6539\u64cd\u4f5c\u3002\u6240\u4ee5\uff0c\u76f8\u5bf9\u4e8e\u6574\u4e2a DDL \u8fc7\u7a0b\u6765\u8bf4\uff0c\u9501\u7684\u65f6\u95f4\u975e\u5e38\u77ed\u3002\u5bf9\u4e1a\u52a1\u6765\u8bf4\uff0c\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u662f Online \u7684\u3002</p> <p>\u9700\u8981\u8865\u5145\u8bf4\u660e\u7684\u662f\uff0c\u4e0a\u8ff0\u7684\u8fd9\u4e9b\u91cd\u5efa\u65b9\u6cd5\u90fd\u4f1a\u626b\u63cf\u539f\u8868\u6570\u636e\u548c\u6784\u5efa\u4e34\u65f6\u6587\u4ef6\u3002\u5bf9\u4e8e\u5f88\u5927\u7684\u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u662f\u5f88\u6d88\u8017 IO \u548c CPU \u8d44\u6e90\u7684\u3002\u56e0\u6b64\uff0c\u5982\u679c\u662f\u7ebf\u4e0a\u670d\u52a1\uff0c\u4f60\u8981\u5f88\u5c0f\u5fc3\u5730\u63a7\u5236\u64cd\u4f5c\u65f6\u95f4\u3002\u5982\u679c\u60f3\u8981\u6bd4\u8f83\u5b89\u5168\u7684\u64cd\u4f5c\u7684\u8bdd\uff0c\u6211\u63a8\u8350\u4f60\u4f7f\u7528 GitHub \u5f00\u6e90\u7684 gh-ost \u6765\u505a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#online-inplace","title":"Online \u548c inplace","text":"<p>\u8bf4\u5230 Online\uff0c\u6211\u8fd8\u8981\u518d\u548c\u4f60\u6f84\u6e05\u4e00\u4e0b\u5b83\u548c\u53e6\u4e00\u4e2a\u8ddf DDL \u6709\u5173\u7684\u3001\u5bb9\u6613\u6df7\u6dc6\u7684\u6982\u5ff5 inplace \u7684\u533a\u522b\u3002</p> <p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u5728\u56fe 3 \u4e2d\uff0c\u6211\u4eec\u628a\u8868 A \u4e2d\u7684\u6570\u636e\u5bfc\u51fa\u6765\u7684\u5b58\u653e\u4f4d\u7f6e\u53eb\u4f5c <code>tmp_table</code>\u3002\u8fd9\u662f\u4e00\u4e2a\u4e34\u65f6\u8868\uff0c\u662f\u5728 server \u5c42\u521b\u5efa\u7684\u3002</p> <p>\u5728\u56fe 4 \u4e2d\uff0c\u6839\u636e\u8868 A \u91cd\u5efa\u51fa\u6765\u7684\u6570\u636e\u662f\u653e\u5728 <code>tmp_file</code> \u91cc\u7684\uff0c\u8fd9\u4e2a\u4e34\u65f6\u6587\u4ef6\u662f InnoDB \u5728\u5185\u90e8\u521b\u5efa\u51fa\u6765\u7684\u3002\u6574\u4e2a DDL \u8fc7\u7a0b\u90fd\u5728 InnoDB \u5185\u90e8\u5b8c\u6210\u3002\u5bf9\u4e8e server \u5c42\u6765\u8bf4\uff0c\u6ca1\u6709\u628a\u6570\u636e\u632a\u52a8\u5230\u4e34\u65f6\u8868\uff0c\u662f\u4e00\u4e2a\u201c\u539f\u5730\u201d\u64cd\u4f5c\uff0c\u8fd9\u5c31\u662f\u201cinplace\u201d\u540d\u79f0\u7684\u6765\u6e90\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u73b0\u5728\u95ee\u4f60\uff0c\u5982\u679c\u4f60\u6709\u4e00\u4e2a 1TB \u7684\u8868\uff0c\u73b0\u5728\u78c1\u76d8\u95f4\u662f 1.2TB\uff0c\u80fd\u4e0d\u80fd\u505a\u4e00\u4e2a inplace \u7684 DDL \u5462\uff1f</p> <p>\u7b54\u6848\u662f\u4e0d\u80fd\u3002\u56e0\u4e3a\uff0c<code>tmp_file</code> \u4e5f\u662f\u8981\u5360\u7528\u4e34\u65f6\u7a7a\u95f4\u7684\u3002</p> <p>\u6211\u4eec\u91cd\u5efa\u8868\u7684\u8fd9\u4e2a\u8bed\u53e5 <code>alter table t engine=InnoDB</code>\uff0c\u5176\u5b9e\u9690\u542b\u7684\u610f\u601d\u662f\uff1a</p> <pre><code>alter table t engine=innodb,ALGORITHM=inplace;\n</code></pre> <p>\u8ddf inplace \u5bf9\u5e94\u7684\u5c31\u662f\u62f7\u8d1d\u8868\u7684\u65b9\u5f0f\u4e86\uff0c\u7528\u6cd5\u662f\uff1a</p> <pre><code>alter table t engine=innodb,ALGORITHM=copy;\n</code></pre> <p>\u5f53\u4f60\u4f7f\u7528 <code>ALGORITHM=copy</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u7684\u662f\u5f3a\u5236\u62f7\u8d1d\u8868\uff0c\u5bf9\u5e94\u7684\u6d41\u7a0b\u5c31\u662f\u56fe 3 \u7684\u64cd\u4f5c\u8fc7\u7a0b\u3002</p> <p>\u4f46\u6211\u8fd9\u6837\u8bf4\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0cinplace \u8ddf Online \u662f\u4e0d\u662f\u5c31\u662f\u4e00\u4e2a\u610f\u601d\uff1f</p> <p>\u5176\u5b9e\u4e0d\u662f\u7684\uff0c\u53ea\u662f\u5728\u91cd\u5efa\u8868\u8fd9\u4e2a\u903b\u8f91\u4e2d\u521a\u597d\u662f\u8fd9\u6837\u800c\u5df2\u3002</p> <p>\u6bd4\u5982\uff0c\u5982\u679c\u6211\u8981\u7ed9 InnoDB \u8868\u7684\u4e00\u4e2a\u5b57\u6bb5\u52a0\u5168\u6587\u7d22\u5f15\uff0c\u5199\u6cd5\u662f\uff1a</p> <pre><code>alter table t add FULLTEXT(field_name);\n</code></pre> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u662f inplace \u7684\uff0c\u4f46\u4f1a\u963b\u585e\u589e\u5220\u6539\u64cd\u4f5c\uff0c\u662f\u975e Online \u7684\u3002</p> <p>\u5982\u679c\u8bf4\u8fd9\u4e24\u4e2a\u903b\u8f91\u4e4b\u95f4\u7684\u5173\u7cfb\u662f\u4ec0\u4e48\u7684\u8bdd\uff0c\u53ef\u4ee5\u6982\u62ec\u4e3a\uff1a</p> <ol> <li>DDL \u8fc7\u7a0b\u5982\u679c\u662f Online \u7684\uff0c\u5c31\u4e00\u5b9a\u662f inplace \u7684\uff1b</li> <li>\u53cd\u8fc7\u6765\u672a\u5fc5\uff0c\u4e5f\u5c31\u662f\u8bf4 inplace \u7684 DDL\uff0c\u6709\u53ef\u80fd\u4e0d\u662f Online \u7684\u3002\u622a\u6b62\u5230 MySQL 8.0\uff0c\u6dfb\u52a0\u5168\u6587\u7d22\u5f15\uff08FULLTEXT index\uff09\u548c\u7a7a\u95f4\u7d22\u5f15 (SPATIAL index) \u5c31\u5c5e\u4e8e\u8fd9\u79cd\u60c5\u51b5\u3002</li> </ol> <p>\u6700\u540e\uff0c\u6211\u4eec\u518d\u5ef6\u4f38\u4e00\u4e0b\u3002</p> <p>\u5728\u7b2c 10 \u7bc7\u6587\u7ae0[\u300aMySQL \u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u4f1a\u9009\u9519\u7d22\u5f15\u300b]\u7684\u8bc4\u8bba\u533a\u4e2d\uff0c\u6709\u540c\u5b66\u95ee\u5230\u4f7f\u7528 <code>optimize table</code>\u3001<code>analyze table</code> \u548c <code>alter table</code> \u8fd9\u4e09\u79cd\u65b9\u5f0f\u91cd\u5efa\u8868\u7684\u533a\u522b\u3002\u8fd9\u91cc\uff0c\u6211\u987a\u4fbf\u518d\u7b80\u5355\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u3002</p> <ul> <li>\u4ece MySQL 5.6 \u7248\u672c\u5f00\u59cb\uff0c<code>alter table t engine = InnoDB</code>\uff08\u4e5f\u5c31\u662f recreate\uff09\u9ed8\u8ba4\u7684\u5c31\u662f\u4e0a\u9762\u56fe 4 \u7684\u6d41\u7a0b\u4e86\uff1b</li> <li><code>analyze table t</code> \u5176\u5b9e\u4e0d\u662f\u91cd\u5efa\u8868\uff0c\u53ea\u662f\u5bf9\u8868\u7684\u7d22\u5f15\u4fe1\u606f\u505a\u91cd\u65b0\u7edf\u8ba1\uff0c\u6ca1\u6709\u4fee\u6539\u6570\u636e\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u52a0\u4e86 MDL \u8bfb\u9501\uff1b</li> <li><code>optimize table t</code> \u7b49\u4e8e <code>recreate+analyze</code>\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_10","title":"\u5c0f\u7ed3","text":"<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\uff0c\u5982\u679c\u8981\u6536\u7f29\u4e00\u4e2a\u8868\uff0c\u53ea\u662f delete \u6389\u8868\u91cc\u9762\u4e0d\u7528\u7684\u6570\u636e\u7684\u8bdd\uff0c\u8868\u6587\u4ef6\u7684\u5927\u5c0f\u662f\u4e0d\u4f1a\u53d8\u7684\uff0c\u4f60\u8fd8\u8981\u901a\u8fc7 <code>alter table</code> \u547d\u4ee4\u91cd\u5efa\u8868\uff0c\u624d\u80fd\u8fbe\u5230\u8868\u6587\u4ef6\u53d8\u5c0f\u7684\u76ee\u7684\u3002\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u91cd\u5efa\u8868\u7684\u4e24\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff0cOnline DDL \u7684\u65b9\u5f0f\u662f\u53ef\u4ee5\u8003\u8651\u5728\u4e1a\u52a1\u4f4e\u5cf0\u671f\u4f7f\u7528\u7684\uff0c\u800c MySQL 5.5 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u8fd9\u4e2a\u547d\u4ee4\u662f\u4f1a\u963b\u585e DML \u7684\uff0c\u8fd9\u4e2a\u4f60\u9700\u8981\u7279\u522b\u5c0f\u5fc3\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#14-count","title":"14 <code>count()</code>\u8fd9\u4e48\u6162\uff0c\u6211\u8be5\u600e\u4e48\u529e\uff1f","text":"<p>\u5728\u5f00\u53d1\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u7ecf\u5e38\u9700\u8981\u8ba1\u7b97\u4e00\u4e2a\u8868\u7684\u884c\u6570\uff0c\u6bd4\u5982\u4e00\u4e2a\u4ea4\u6613\u7cfb\u7edf\u7684\u6240\u6709\u53d8\u66f4\u8bb0\u5f55\u603b\u6570\u3002\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0c\u4e00\u6761 <code>select count(*) from t</code> \u8bed\u53e5\u4e0d\u5c31\u89e3\u51b3\u4e86\u5417\uff1f</p> <p>\u4f46\u662f\uff0c\u4f60\u4f1a\u53d1\u73b0\u968f\u7740\u7cfb\u7edf\u4e2d\u8bb0\u5f55\u6570\u8d8a\u6765\u8d8a\u591a\uff0c\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u5f97\u4e5f\u4f1a\u8d8a\u6765\u8d8a\u6162\u3002\u7136\u540e\u4f60\u53ef\u80fd\u5c31\u60f3\u4e86\uff0cMySQL \u600e\u4e48\u8fd9\u4e48\u7b28\u554a\uff0c\u8bb0\u4e2a\u603b\u6570\uff0c\u6bcf\u6b21\u8981\u67e5\u7684\u65f6\u5019\u76f4\u63a5\u8bfb\u51fa\u6765\uff0c\u4e0d\u5c31\u597d\u4e86\u5417\u3002</p> <p>\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u804a\u804a <code>count(*)</code> \u8bed\u53e5\u5230\u5e95\u662f\u600e\u6837\u5b9e\u73b0\u7684\uff0c\u4ee5\u53ca MySQL \u4e3a\u4ec0\u4e48\u4f1a\u8fd9\u4e48\u5b9e\u73b0\u3002\u7136\u540e\uff0c\u6211\u4f1a\u518d\u548c\u4f60\u8bf4\u8bf4\uff0c\u5982\u679c\u5e94\u7528\u4e2d\u6709\u8fd9\u79cd\u9891\u7e41\u53d8\u66f4\u5e76\u9700\u8981\u7edf\u8ba1\u8868\u884c\u6570\u7684\u9700\u6c42\uff0c\u4e1a\u52a1\u8bbe\u8ba1\u4e0a\u53ef\u4ee5\u600e\u4e48\u505a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#count","title":"<code>count(*)</code> \u7684\u5b9e\u73b0\u65b9\u5f0f","text":"<p>\u4f60\u9996\u5148\u8981\u660e\u786e\u7684\u662f\uff0c\u5728\u4e0d\u540c\u7684 MySQL \u5f15\u64ce\u4e2d\uff0c<code>count(*)</code> \u6709\u4e0d\u540c\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002</p> <ul> <li>MyISAM \u5f15\u64ce\u628a\u4e00\u4e2a\u8868\u7684\u603b\u884c\u6570\u5b58\u5728\u4e86\u78c1\u76d8\u4e0a\uff0c\u56e0\u6b64\u6267\u884c <code>count(*)</code> \u7684\u65f6\u5019\u4f1a\u76f4\u63a5\u8fd4\u56de\u8fd9\u4e2a\u6570\uff0c\u6548\u7387\u5f88\u9ad8\uff1b</li> <li>\u800c InnoDB \u5f15\u64ce\u5c31\u9ebb\u70e6\u4e86\uff0c\u5b83\u6267\u884c <code>count(*)</code> \u7684\u65f6\u5019\uff0c\u9700\u8981\u628a\u6570\u636e\u4e00\u884c\u4e00\u884c\u5730\u4ece\u5f15\u64ce\u91cc\u9762\u8bfb\u51fa\u6765\uff0c\u7136\u540e\u7d2f\u79ef\u8ba1\u6570\u3002</li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u5728\u8fd9\u7bc7\u6587\u7ae0\u91cc\u8ba8\u8bba\u7684\u662f\u6ca1\u6709\u8fc7\u6ee4\u6761\u4ef6\u7684 <code>count(*)</code>\uff0c\u5982\u679c\u52a0\u4e86 where \u6761\u4ef6\u7684\u8bdd\uff0cMyISAM \u8868\u4e5f\u662f\u4e0d\u80fd\u8fd4\u56de\u5f97\u8fd9\u4e48\u5feb\u7684\u3002</p> <p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4e00\u8d77\u5206\u6790\u4e86\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528 InnoDB\uff0c\u56e0\u4e3a\u4e0d\u8bba\u662f\u5728\u4e8b\u52a1\u652f\u6301\u3001\u5e76\u53d1\u80fd\u529b\u8fd8\u662f\u5728\u6570\u636e\u5b89\u5168\u65b9\u9762\uff0cInnoDB \u90fd\u4f18\u4e8e MyISAM\u3002\u6211\u731c\u4f60\u7684\u8868\u4e5f\u4e00\u5b9a\u662f\u7528\u4e86 InnoDB \u5f15\u64ce\u3002\u8fd9\u5c31\u662f\u5f53\u4f60\u7684\u8bb0\u5f55\u6570\u8d8a\u6765\u8d8a\u591a\u7684\u65f6\u5019\uff0c\u8ba1\u7b97\u4e00\u4e2a\u8868\u7684\u603b\u884c\u6570\u4f1a\u8d8a\u6765\u8d8a\u6162\u7684\u539f\u56e0\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#count_1","title":"\u4e0d\u540c\u7684 count \u7528\u6cd5","text":"<p>\u5728 <code>select count(?) from t</code> \u8fd9\u6837\u7684\u67e5\u8be2\u8bed\u53e5\u91cc\u9762\uff0c<code>count(*)</code>\u3001<code>count(\u4e3b\u952e id</code>)\u3001<code>count(\u5b57\u6bb5)</code> \u548c <code>count(1)</code> \u7b49\u4e0d\u540c\u7528\u6cd5\u7684\u6027\u80fd\uff0c\u6709\u54ea\u4e9b\u5dee\u522b\u3002\u4eca\u5929\u8c08\u5230\u4e86 <code>count(*)</code> \u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u5c31\u501f\u6b64\u673a\u4f1a\u548c\u4f60\u8be6\u7ec6\u8bf4\u660e\u4e00\u4e0b\u8fd9\u51e0\u79cd\u7528\u6cd5\u7684\u6027\u80fd\u5dee\u522b\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0b\u9762\u7684\u8ba8\u8bba\u8fd8\u662f\u57fa\u4e8e InnoDB \u5f15\u64ce\u7684\u3002</p> <p>\u8fd9\u91cc\uff0c\u9996\u5148\u4f60\u8981\u5f04\u6e05\u695a <code>count()</code> \u7684\u8bed\u4e49\u3002<code>count()</code> \u662f\u4e00\u4e2a\u805a\u5408\u51fd\u6570\uff0c\u5bf9\u4e8e\u8fd4\u56de\u7684\u7ed3\u679c\u96c6\uff0c\u4e00\u884c\u884c\u5730\u5224\u65ad\uff0c\u5982\u679c <code>count</code> \u51fd\u6570\u7684\u53c2\u6570\u4e0d\u662f NULL\uff0c\u7d2f\u8ba1\u503c\u5c31\u52a0 1\uff0c\u5426\u5219\u4e0d\u52a0\u3002\u6700\u540e\u8fd4\u56de\u7d2f\u8ba1\u503c\u3002</p> <p>\u6240\u4ee5\uff0c<code>count(*)</code>\u3001<code>count(\u4e3b\u952e id</code>)\u3001<code>count(\u5b57\u6bb5)</code>\u548c <code>count(1)</code> \u90fd\u8868\u793a\u8fd4\u56de\u6ee1\u8db3\u6761\u4ef6\u7684\u7ed3\u679c\u96c6\u7684\u603b\u884c\u6570\uff1b\u800c <code>count(\u5b57\u6bb5</code>\uff09\uff0c\u5219\u8868\u793a\u8fd4\u56de\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u884c\u91cc\u9762\uff0c\u53c2\u6570\u201c\u5b57\u6bb5\u201d\u4e0d\u4e3a NULL \u7684\u603b\u4e2a\u6570\u3002</p> <p>\u81f3\u4e8e\u5206\u6790\u6027\u80fd\u5dee\u522b\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u8bb0\u4f4f\u8fd9\u4e48\u51e0\u4e2a\u539f\u5219\uff1a</p> <ol> <li>server \u5c42\u8981\u4ec0\u4e48\u5c31\u7ed9\u4ec0\u4e48\uff1b</li> <li>InnoDB \u53ea\u7ed9\u5fc5\u8981\u7684\u503c\uff1b</li> <li>\u73b0\u5728\u7684\u4f18\u5316\u5668\u53ea\u4f18\u5316\u4e86 <code>count(*)</code> \u7684\u8bed\u4e49\u4e3a\u201c\u53d6\u884c\u6570\u201d\uff0c\u5176\u4ed6\u201c\u663e\u800c\u6613\u89c1\u201d\u7684\u4f18\u5316\u5e76\u6ca1\u6709\u505a\u3002</li> </ol> <p>\u8fd9\u662f\u4ec0\u4e48\u610f\u601d\u5462\uff1f\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u4e2a\u4e2a\u5730\u6765\u770b\u770b\u3002</p> <p>\u5bf9\u4e8e count(\u4e3b\u952e id) \u6765\u8bf4\uff0cInnoDB \u5f15\u64ce\u4f1a\u904d\u5386\u6574\u5f20\u8868\uff0c\u628a\u6bcf\u4e00\u884c\u7684 id \u503c\u90fd\u53d6\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 server \u5c42\u3002server \u5c42\u62ff\u5230 id \u540e\uff0c\u5224\u65ad\u662f\u4e0d\u53ef\u80fd\u4e3a\u7a7a\u7684\uff0c\u5c31\u6309\u884c\u7d2f\u52a0\u3002</p> <p>\u5bf9\u4e8e count(1) \u6765\u8bf4\uff0cInnoDB \u5f15\u64ce\u904d\u5386\u6574\u5f20\u8868\uff0c\u4f46\u4e0d\u53d6\u503c\u3002server \u5c42\u5bf9\u4e8e\u8fd4\u56de\u7684\u6bcf\u4e00\u884c\uff0c\u653e\u4e00\u4e2a\u6570\u5b57\u201c1\u201d\u8fdb\u53bb\uff0c\u5224\u65ad\u662f\u4e0d\u53ef\u80fd\u4e3a\u7a7a\u7684\uff0c\u6309\u884c\u7d2f\u52a0\u3002</p> <p>\u5355\u770b\u8fd9\u4e24\u4e2a\u7528\u6cd5\u7684\u5dee\u522b\u7684\u8bdd\uff0c\u4f60\u80fd\u5bf9\u6bd4\u51fa\u6765\uff0c<code>count(1)</code> \u6267\u884c\u5f97\u8981\u6bd4 <code>count(\u4e3b\u952e id)</code> \u5feb\u3002\u56e0\u4e3a\u4ece\u5f15\u64ce\u8fd4\u56de id \u4f1a\u6d89\u53ca\u5230\u89e3\u6790\u6570\u636e\u884c\uff0c\u4ee5\u53ca\u62f7\u8d1d\u5b57\u6bb5\u503c\u7684\u64cd\u4f5c\u3002</p> <p>\u5bf9\u4e8e count(\u5b57\u6bb5) \u6765\u8bf4\uff1a</p> <ol> <li>\u5982\u679c\u8fd9\u4e2a\u201c\u5b57\u6bb5\u201d\u662f\u5b9a\u4e49\u4e3a not null \u7684\u8bdd\uff0c\u4e00\u884c\u884c\u5730\u4ece\u8bb0\u5f55\u91cc\u9762\u8bfb\u51fa\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5224\u65ad\u4e0d\u80fd\u4e3a null\uff0c\u6309\u884c\u7d2f\u52a0\uff1b</li> <li>\u5982\u679c\u8fd9\u4e2a\u201c\u5b57\u6bb5\u201d\u5b9a\u4e49\u5141\u8bb8\u4e3a null\uff0c\u90a3\u4e48\u6267\u884c\u7684\u65f6\u5019\uff0c\u5224\u65ad\u5230\u6709\u53ef\u80fd\u662f null\uff0c\u8fd8\u8981\u628a\u503c\u53d6\u51fa\u6765\u518d\u5224\u65ad\u4e00\u4e0b\uff0c\u4e0d\u662f null \u624d\u7d2f\u52a0\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u524d\u9762\u7684\u7b2c\u4e00\u6761\u539f\u5219\uff0cserver \u5c42\u8981\u4ec0\u4e48\u5b57\u6bb5\uff0cInnoDB \u5c31\u8fd4\u56de\u4ec0\u4e48\u5b57\u6bb5\u3002</p> <p>\u4f46\u662f <code>count(*)</code> \u662f\u4f8b\u5916\uff0c\u5e76\u4e0d\u4f1a\u628a\u5168\u90e8\u5b57\u6bb5\u53d6\u51fa\u6765\uff0c\u800c\u662f\u4e13\u95e8\u505a\u4e86\u4f18\u5316\uff0c\u4e0d\u53d6\u503c\u3002<code>count(*)</code> \u80af\u5b9a\u4e0d\u662f null\uff0c\u6309\u884c\u7d2f\u52a0\u3002</p> <p>\u6240\u4ee5\u7ed3\u8bba\u662f\uff1a\u6309\u7167\u6548\u7387\u6392\u5e8f\u7684\u8bdd\uff0c<code>count(\u5b57\u6bb5)</code>\\&lt;<code>count(\u4e3b\u952e id)</code>\\&lt;<code>count(1)</code>\u2248<code>count(*)</code>\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\uff0c\u5c3d\u91cf\u4f7f\u7528 <code>count(*)</code>\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_11","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u804a\u4e86\u804a MySQL \u4e2d\u83b7\u5f97\u8868\u884c\u6570\u7684\u4e24\u79cd\u65b9\u6cd5\u3002\u6211\u4eec\u63d0\u5230\u4e86\u5728\u4e0d\u540c\u5f15\u64ce\u4e2d count(*) \u7684\u5b9e\u73b0\u65b9\u5f0f\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e5f\u5206\u6790\u4e86\u7528\u7f13\u5b58\u7cfb\u7edf\u6765\u5b58\u50a8\u8ba1\u6570\u503c\u5b58\u5728\u7684\u95ee\u9898\u3002</p> <p>\u5176\u5b9e\uff0c\u628a\u8ba1\u6570\u653e\u5728 Redis \u91cc\u9762\uff0c\u4e0d\u80fd\u591f\u4fdd\u8bc1\u8ba1\u6570\u548c MySQL \u8868\u91cc\u7684\u6570\u636e\u7cbe\u786e\u4e00\u81f4\u7684\u539f\u56e0\uff0c\u662f\u8fd9\u4e24\u4e2a\u4e0d\u540c\u7684\u5b58\u50a8\u6784\u6210\u7684\u7cfb\u7edf\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u65e0\u6cd5\u62ff\u5230\u7cbe\u786e\u4e00\u81f4\u7684\u89c6\u56fe\u3002\u800c\u628a\u8ba1\u6570\u503c\u4e5f\u653e\u5728 MySQL \u4e2d\uff0c\u5c31\u89e3\u51b3\u4e86\u4e00\u81f4\u6027\u89c6\u56fe\u7684\u95ee\u9898\u3002</p> <p>InnoDB \u5f15\u64ce\u652f\u6301\u4e8b\u52a1\uff0c\u6211\u4eec\u5229\u7528\u597d\u4e8b\u52a1\u7684\u539f\u5b50\u6027\u548c\u9694\u79bb\u6027\uff0c\u5c31\u53ef\u4ee5\u7b80\u5316\u5728\u4e1a\u52a1\u5f00\u53d1\u65f6\u7684\u903b\u8f91\u3002\u8fd9\u4e5f\u662f InnoDB \u5f15\u64ce\u5907\u53d7\u9752\u7750\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#15","title":"15 \u7b54\u7591\u6587\u7ae0\uff08\u4e00\uff09\uff1a\u65e5\u5fd7\u548c\u7d22\u5f15\u76f8\u5173\u95ee\u9898","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u66f4\u65b0\u524d\uff0cMySQL \u5b9e\u6218\u8fd9\u4e2a\u4e13\u680f\u5df2\u7ecf\u66f4\u65b0\u4e86 14 \u7bc7\u3002\u5728\u8fd9\u4e9b\u6587\u7ae0\u4e2d\uff0c\u5927\u5bb6\u5728\u8bc4\u8bba\u533a\u7559\u4e0b\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u7559\u8a00\u3002\u73b0\u5728\uff0c\u6bcf\u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u90fd\u6709\u70ed\u5fc3\u7684\u540c\u5b66\u5e2e\u5fd9\u603b\u7ed3\u6587\u7ae0\u77e5\u8bc6\u70b9\uff0c\u4e5f\u6709\u4e0d\u5c11\u540c\u5b66\u63d0\u51fa\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u95ee\u9898\uff0c\u66f4\u6709\u4e00\u4e9b\u540c\u5b66\u5e2e\u5fd9\u89e3\u7b54\u5176\u4ed6\u540c\u5b66\u63d0\u51fa\u7684\u95ee\u9898\u3002</p> <p>\u5728\u6d4f\u89c8\u8fd9\u4e9b\u7559\u8a00\u5e76\u56de\u590d\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6211\u500d\u53d7\u9f13\u821e\uff0c\u4e5f\u5c3d\u6211\u6240\u77e5\u5730\u5e2e\u52a9\u4f60\u89e3\u51b3\u95ee\u9898\u3001\u548c\u4f60\u8ba8\u8bba\u3002\u53ef\u4ee5\u8bf4\uff0c\u4f60\u4eec\u7684\u7559\u8a00\u6d3b\u8dc3\u4e86\u6574\u4e2a\u4e13\u680f\u7684\u6c1b\u56f4\u3001\u63d0\u5347\u4e86\u6574\u4e2a\u4e13\u680f\u7684\u8d28\u91cf\uff0c\u8c22\u8c22\u4f60\u4eec\u3002</p> <p>\u8bc4\u8bba\u533a\u7684\u5927\u591a\u6570\u7559\u8a00\u6211\u90fd\u76f4\u63a5\u56de\u590d\u4e86\uff0c\u5bf9\u4e8e\u9700\u8981\u5c55\u5f00\u8bf4\u660e\u7684\u95ee\u9898\uff0c\u6211\u90fd\u62ff\u51fa\u5c0f\u672c\u5b50\u8bb0\u4e86\u4e0b\u6765\u3002\u8fd9\u4e9b\u88ab\u8bb0\u4e0b\u6765\u7684\u95ee\u9898\uff0c\u5c31\u662f\u6211\u4eec\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u7684\u7d20\u6750\u4e86\u3002</p> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u5df2\u7ecf\u6536\u96c6\u4e86 47 \u4e2a\u95ee\u9898\uff0c\u5f88\u96be\u901a\u8fc7\u4eca\u5929\u8fd9\u4e00\u7bc7\u6587\u7ae0\u5168\u90e8\u5c55\u5f00\u3002\u6240\u4ee5\uff0c\u6211\u5c31\u5148\u4ece\u4e2d\u627e\u4e86\u51e0\u4e2a\u8054\u7cfb\u975e\u5e38\u7d27\u5bc6\u7684\u95ee\u9898\uff0c\u4e32\u4e86\u8d77\u6765\uff0c\u5e0c\u671b\u53ef\u4ee5\u5e2e\u4f60\u89e3\u51b3\u5173\u4e8e\u65e5\u5fd7\u548c\u7d22\u5f15\u7684\u4e00\u4e9b\u7591\u60d1\u3002\u800c\u5176\u4ed6\u95ee\u9898\uff0c\u6211\u4eec\u5c31\u7559\u7740\u540e\u9762\u6162\u6162\u5c55\u5f00\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_12","title":"\u65e5\u5fd7\u76f8\u5173\u95ee\u9898","text":"<p>\u6211\u5728\u7b2c 2 \u7bc7\u6587\u7ae0[\u300a\u65e5\u5fd7\u7cfb\u7edf\uff1a\u4e00\u6761 SQL \u66f4\u65b0\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\uff0c\u548c\u4f60\u8bb2\u5230 binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u548c redo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\u914d\u5408\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u53cd\u8bc1\u6cd5\uff0c\u8bf4\u660e\u4e86\u5982\u679c\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u4f1a\u5bfc\u81f4 MySQL \u51fa\u73b0\u4e3b\u5907\u6570\u636e\u4e0d\u4e00\u81f4\u7b49\u95ee\u9898\u3002</p> <p>\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e0b\u9762\uff0c\u5f88\u591a\u540c\u5b66\u5728\u95ee\uff0c\u5728\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u4e0d\u540c\u77ac\u95f4\uff0cMySQL \u5982\u679c\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u5b8c\u6574\u6027\u7684\uff1f</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u5f00\u59cb\u5427\u3002</p> <p>\u6211\u518d\u653e\u4e00\u6b21\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u56fe\uff0c\u65b9\u4fbf\u4f60\u5b66\u4e60\u4e0b\u9762\u7684\u5185\u5bb9\u3002</p> <p></p> <p>\u56fe 1 \u4e24\u9636\u6bb5\u63d0\u4ea4\u793a\u610f\u56fe</p> <p>\u8fd9\u91cc\uff0c\u6211\u8981\u5148\u548c\u4f60\u89e3\u91ca\u4e00\u4e2a\u8bef\u4f1a\u5f0f\u7684\u95ee\u9898\u3002\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u95ee\u5230\uff0c\u8fd9\u4e2a\u56fe\u4e0d\u662f\u4e00\u4e2a update \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5417\uff0c\u600e\u4e48\u8fd8\u4f1a\u8c03\u7528 commit \u8bed\u53e5\uff1f</p> <p>\u4ed6\u4ea7\u751f\u8fd9\u4e2a\u7591\u95ee\u7684\u539f\u56e0\uff0c\u662f\u628a**\u4e24\u4e2a\u201ccommit\u201d\u7684\u6982\u5ff5**\u6df7\u6dc6\u4e86\uff1a</p> <ul> <li>\u4ed6\u8bf4\u7684\u201ccommit \u8bed\u53e5\u201d\uff0c\u662f\u6307 MySQL \u8bed\u6cd5\u4e2d\uff0c\u7528\u4e8e\u63d0\u4ea4\u4e00\u4e2a\u4e8b\u52a1\u7684\u547d\u4ee4\u3002\u4e00\u822c\u8ddf begin/start transaction \u914d\u5bf9\u4f7f\u7528\u3002</li> <li>\u800c\u6211\u4eec\u56fe\u4e2d\u7528\u5230\u7684\u8fd9\u4e2a\u201ccommit \u6b65\u9aa4\u201d\uff0c\u6307\u7684\u662f\u4e8b\u52a1\u63d0\u4ea4\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e2a\u5c0f\u6b65\u9aa4\uff0c\u4e5f\u662f\u6700\u540e\u4e00\u6b65\u3002\u5f53\u8fd9\u4e2a\u6b65\u9aa4\u6267\u884c\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5c31\u63d0\u4ea4\u5b8c\u6210\u4e86\u3002</li> <li>\u201ccommit \u8bed\u53e5\u201d\u6267\u884c\u7684\u65f6\u5019\uff0c\u4f1a\u5305\u542b\u201ccommit \u6b65\u9aa4\u201d\u3002</li> </ul> <p>\u800c\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u9762\uff0c\u6ca1\u6709\u663e\u5f0f\u5730\u5f00\u542f\u4e8b\u52a1\uff0c\u56e0\u6b64\u8fd9\u4e2a update \u8bed\u53e5\u81ea\u5df1\u5c31\u662f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u6267\u884c\u5b8c\u6210\u540e\u63d0\u4ea4\u4e8b\u52a1\u65f6\uff0c\u5c31\u4f1a\u7528\u5230\u8fd9\u4e2a\u201ccommit \u6b65\u9aa4\u201c\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u5206\u6790\u4e00\u4e0b**\u5728\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u4e0d\u540c\u65f6\u523b\uff0cMySQL \u5f02\u5e38\u91cd\u542f\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u3002**</p> <p>\u5982\u679c\u5728\u56fe\u4e2d\u65f6\u523b A \u7684\u5730\u65b9\uff0c\u4e5f\u5c31\u662f\u5199\u5165 redo log \u5904\u4e8e prepare \u9636\u6bb5\u4e4b\u540e\u3001\u5199 binlog \u4e4b\u524d\uff0c\u53d1\u751f\u4e86\u5d29\u6e83\uff08crash\uff09\uff0c\u7531\u4e8e\u6b64\u65f6 binlog \u8fd8\u6ca1\u5199\uff0credo log \u4e5f\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u6240\u4ee5\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u56de\u6eda\u3002\u8fd9\u65f6\u5019\uff0cbinlog \u8fd8\u6ca1\u5199\uff0c\u6240\u4ee5\u4e5f\u4e0d\u4f1a\u4f20\u5230\u5907\u5e93\u3002\u5230\u8fd9\u91cc\uff0c\u5927\u5bb6\u90fd\u53ef\u4ee5\u7406\u89e3\u3002</p> <p>\u5927\u5bb6\u51fa\u73b0\u95ee\u9898\u7684\u5730\u65b9\uff0c\u4e3b\u8981\u96c6\u4e2d\u5728\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\uff0credo log \u8fd8\u6ca1 commit \u524d\u53d1\u751f crash\uff0c\u90a3\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019 MySQL \u4f1a\u600e\u4e48\u5904\u7406\uff1f</p> <p>\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u5d29\u6e83\u6062\u590d\u65f6\u7684\u5224\u65ad\u89c4\u5219\u3002</p> <ol> <li>\u5982\u679c redo log \u91cc\u9762\u7684\u4e8b\u52a1\u662f\u5b8c\u6574\u7684\uff0c\u4e5f\u5c31\u662f\u5df2\u7ecf\u6709\u4e86 commit \u6807\u8bc6\uff0c\u5219\u76f4\u63a5\u63d0\u4ea4\uff1b</li> <li>\u5982\u679c redo log \u91cc\u9762\u7684\u4e8b\u52a1\u53ea\u6709\u5b8c\u6574\u7684 prepare\uff0c\u5219\u5224\u65ad\u5bf9\u5e94\u7684\u4e8b\u52a1 binlog \u662f\u5426\u5b58\u5728\u5e76\u5b8c\u6574\uff1a a. \u5982\u679c\u662f\uff0c\u5219\u63d0\u4ea4\u4e8b\u52a1\uff1b b. \u5426\u5219\uff0c\u56de\u6eda\u4e8b\u52a1\u3002</li> </ol> <p>\u8fd9\u91cc\uff0c\u65f6\u523b B \u53d1\u751f crash \u5bf9\u5e94\u7684\u5c31\u662f 2(a) \u7684\u60c5\u51b5\uff0c\u5d29\u6e83\u6062\u590d\u8fc7\u7a0b\u4e2d\u4e8b\u52a1\u4f1a\u88ab\u63d0\u4ea4\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u7ee7\u7eed\u5ef6\u5c55\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#1mysql-binlog","title":"\u8ffd\u95ee 1\uff1aMySQL \u600e\u4e48\u77e5\u9053 binlog \u662f\u5b8c\u6574\u7684?","text":"<p>\u56de\u7b54\uff1a\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u6709\u5b8c\u6574\u683c\u5f0f\u7684\uff1a</p> <ul> <li>statement \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709 COMMIT\uff1b</li> <li>row \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709\u4e00\u4e2a XID event\u3002</li> </ul> <p>\u53e6\u5916\uff0c\u5728 MySQL 5.6.2 \u7248\u672c\u4ee5\u540e\uff0c\u8fd8\u5f15\u5165\u4e86 binlog-checksum \u53c2\u6570\uff0c\u7528\u6765\u9a8c\u8bc1 binlog \u5185\u5bb9\u7684\u6b63\u786e\u6027\u3002\u5bf9\u4e8e binlog \u65e5\u5fd7\u7531\u4e8e\u78c1\u76d8\u539f\u56e0\uff0c\u53ef\u80fd\u4f1a\u5728\u65e5\u5fd7\u4e2d\u95f4\u51fa\u9519\u7684\u60c5\u51b5\uff0cMySQL \u53ef\u4ee5\u901a\u8fc7\u6821\u9a8c checksum \u7684\u7ed3\u679c\u6765\u53d1\u73b0\u3002\u6240\u4ee5\uff0cMySQL \u8fd8\u662f\u6709\u529e\u6cd5\u9a8c\u8bc1\u4e8b\u52a1 binlog \u7684\u5b8c\u6574\u6027\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#2redo-log-binlog","title":"\u8ffd\u95ee 2\uff1aredo log \u548c binlog \u662f\u600e\u4e48\u5173\u8054\u8d77\u6765\u7684?","text":"<p>\u56de\u7b54\uff1a\u5b83\u4eec\u6709\u4e00\u4e2a\u5171\u540c\u7684\u6570\u636e\u5b57\u6bb5\uff0c\u53eb XID\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u4f1a\u6309\u987a\u5e8f\u626b\u63cf redo log\uff1a</p> <ul> <li>\u5982\u679c\u78b0\u5230\u65e2\u6709 prepare\u3001\u53c8\u6709 commit \u7684 redo log\uff0c\u5c31\u76f4\u63a5\u63d0\u4ea4\uff1b</li> <li>\u5982\u679c\u78b0\u5230\u53ea\u6709 parepare\u3001\u800c\u6ca1\u6709 commit \u7684 redo log\uff0c\u5c31\u62ff\u7740 XID \u53bb binlog \u627e\u5bf9\u5e94\u7684\u4e8b\u52a1\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#3-prepare-redo-log-binlogmysql","title":"\u8ffd\u95ee 3\uff1a\u5904\u4e8e prepare \u9636\u6bb5\u7684 redo log \u52a0\u4e0a\u5b8c\u6574 binlog\uff0c\u91cd\u542f\u5c31\u80fd\u6062\u590d\uff0cMySQL \u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u8bbe\u8ba1?","text":"<p>\u56de\u7b54\uff1a\u5176\u5b9e\uff0c\u8fd9\u4e2a\u95ee\u9898\u8fd8\u662f\u8ddf\u6211\u4eec\u5728\u53cd\u8bc1\u6cd5\u4e2d\u8bf4\u5230\u7684\u6570\u636e\u4e0e\u5907\u4efd\u7684\u4e00\u81f4\u6027\u6709\u5173\u3002\u5728\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\u4ee5\u540e MySQL \u53d1\u751f\u5d29\u6e83\uff0c\u8fd9\u65f6\u5019 binlog \u5df2\u7ecf\u5199\u5165\u4e86\uff0c\u4e4b\u540e\u5c31\u4f1a\u88ab\u4ece\u5e93\uff08\u6216\u8005\u7528\u8fd9\u4e2a binlog \u6062\u590d\u51fa\u6765\u7684\u5e93\uff09\u4f7f\u7528\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u4e3b\u5e93\u4e0a\u4e5f\u8981\u63d0\u4ea4\u8fd9\u4e2a\u4e8b\u52a1\u3002\u91c7\u7528\u8fd9\u4e2a\u7b56\u7565\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u7684\u6570\u636e\u5c31\u4fdd\u8bc1\u4e86\u4e00\u81f4\u6027\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#4-redo-log-binlog","title":"\u8ffd\u95ee 4\uff1a\u5982\u679c\u8fd9\u6837\u7684\u8bdd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u4e24\u9636\u6bb5\u63d0\u4ea4\u5462\uff1f\u5e72\u8106\u5148 redo log \u5199\u5b8c\uff0c\u518d\u5199 binlog\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u5fc5\u987b\u5f97\u4e24\u4e2a\u65e5\u5fd7\u90fd\u5b8c\u6574\u624d\u53ef\u4ee5\u3002\u662f\u4e0d\u662f\u4e00\u6837\u7684\u903b\u8f91\uff1f","text":"<p>\u56de\u7b54\uff1a\u5176\u5b9e\uff0c\u4e24\u9636\u6bb5\u63d0\u4ea4\u662f\u7ecf\u5178\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u95ee\u9898\uff0c\u5e76\u4e0d\u662f MySQL \u72ec\u6709\u7684\u3002</p> <p>\u5982\u679c\u5fc5\u987b\u8981\u4e3e\u4e00\u4e2a\u573a\u666f\uff0c\u6765\u8bf4\u660e\u8fd9\u4e48\u505a\u7684\u5fc5\u8981\u6027\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8e InnoDB \u5f15\u64ce\u6765\u8bf4\uff0c\u5982\u679c redo log \u63d0\u4ea4\u5b8c\u6210\u4e86\uff0c\u4e8b\u52a1\u5c31\u4e0d\u80fd\u56de\u6eda\uff08\u5982\u679c\u8fd9\u8fd8\u5141\u8bb8\u56de\u6eda\uff0c\u5c31\u53ef\u80fd\u8986\u76d6\u6389\u522b\u7684\u4e8b\u52a1\u7684\u66f4\u65b0\uff09\u3002\u800c\u5982\u679c redo log \u76f4\u63a5\u63d0\u4ea4\uff0c\u7136\u540e binlog \u5199\u5165\u7684\u65f6\u5019\u5931\u8d25\uff0cInnoDB \u53c8\u56de\u6eda\u4e0d\u4e86\uff0c\u6570\u636e\u548c binlog \u65e5\u5fd7\u53c8\u4e0d\u4e00\u81f4\u4e86\u3002</p> <p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u4e3a\u4e86\u7ed9\u6240\u6709\u4eba\u4e00\u4e2a\u673a\u4f1a\uff0c\u5f53\u6bcf\u4e2a\u4eba\u90fd\u8bf4\u201c\u6211 ok\u201d\u7684\u65f6\u5019\uff0c\u518d\u4e00\u8d77\u63d0\u4ea4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#5-binlog","title":"\u8ffd\u95ee 5\uff1a\u4e0d\u5f15\u5165\u4e24\u4e2a\u65e5\u5fd7\uff0c\u4e5f\u5c31\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u5fc5\u8981\u4e86\u3002\u53ea\u7528 binlog \u6765\u652f\u6301\u5d29\u6e83\u6062\u590d\uff0c\u53c8\u80fd\u652f\u6301\u5f52\u6863\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4e86\uff1f","text":"<p>\u56de\u7b54\uff1a\u8fd9\u4f4d\u540c\u5b66\u7684\u610f\u601d\u662f\uff0c\u53ea\u4fdd\u7559 binlog\uff0c\u7136\u540e\u53ef\u4ee5\u628a\u63d0\u4ea4\u6d41\u7a0b\u6539\u6210\u8fd9\u6837\uff1a\u2026 -&gt; \u201c\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u201d -&gt; \u201c\u5199 binlog\u201d -&gt; \u201c\u63d0\u4ea4\u4e8b\u52a1\u201d\uff0c\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u5d29\u6e83\u6062\u590d\u7684\u80fd\u529b\uff1f</p> <p>\u7b54\u6848\u662f\u4e0d\u53ef\u4ee5\u3002</p> <p>\u5982\u679c\u8bf4**\u5386\u53f2\u539f\u56e0**\u7684\u8bdd\uff0c\u90a3\u5c31\u662f InnoDB \u5e76\u4e0d\u662f MySQL \u7684\u539f\u751f\u5b58\u50a8\u5f15\u64ce\u3002MySQL \u7684\u539f\u751f\u5f15\u64ce\u662f MyISAM\uff0c\u8bbe\u8ba1\u4e4b\u521d\u5c31\u6709\u6ca1\u6709\u652f\u6301\u5d29\u6e83\u6062\u590d\u3002</p> <p>InnoDB \u5728\u4f5c\u4e3a MySQL \u7684\u63d2\u4ef6\u52a0\u5165 MySQL \u5f15\u64ce\u5bb6\u65cf\u4e4b\u524d\uff0c\u5c31\u5df2\u7ecf\u662f\u4e00\u4e2a\u63d0\u4f9b\u4e86\u5d29\u6e83\u6062\u590d\u548c\u4e8b\u52a1\u652f\u6301\u7684\u5f15\u64ce\u4e86\u3002</p> <p>InnoDB \u63a5\u5165\u4e86 MySQL \u540e\uff0c\u53d1\u73b0\u65e2\u7136 binlog \u6ca1\u6709\u5d29\u6e83\u6062\u590d\u7684\u80fd\u529b\uff0c\u90a3\u5c31\u7528 InnoDB \u539f\u6709\u7684 redo log \u597d\u4e86\u3002</p> <p>\u800c\u5982\u679c\u8bf4**\u5b9e\u73b0\u4e0a\u7684\u539f\u56e0**\u7684\u8bdd\uff0c\u5c31\u6709\u5f88\u591a\u4e86\u3002\u5c31\u6309\u7167\u95ee\u9898\u4e2d\u8bf4\u7684\uff0c\u53ea\u7528 binlog \u6765\u5b9e\u73b0\u5d29\u6e83\u6062\u590d\u7684\u6d41\u7a0b\uff0c\u6211\u753b\u4e86\u4e00\u5f20\u793a\u610f\u56fe\uff0c\u8fd9\u91cc\u5c31\u6ca1\u6709 redo log \u4e86\u3002</p> <p></p> <p>\u56fe 2 \u53ea\u7528 binlog \u652f\u6301\u5d29\u6e83\u6062\u590d</p> <p>\u8fd9\u6837\u7684\u6d41\u7a0b\u4e0b\uff0cbinlog \u8fd8\u662f\u4e0d\u80fd\u652f\u6301\u5d29\u6e83\u6062\u590d\u7684\u3002\u6211\u8bf4\u4e00\u4e2a\u4e0d\u652f\u6301\u7684\u70b9\u5427\uff1abinlog \u6ca1\u6709\u80fd\u529b\u6062\u590d\u201c\u6570\u636e\u9875\u201d\u3002</p> <p>\u5982\u679c\u5728\u56fe\u4e2d\u6807\u7684\u4f4d\u7f6e\uff0c\u4e5f\u5c31\u662f binlog2 \u5199\u5b8c\u4e86\uff0c\u4f46\u662f\u6574\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u6709 commit \u7684\u65f6\u5019\uff0cMySQL \u53d1\u751f\u4e86 crash\u3002</p> <p>\u91cd\u542f\u540e\uff0c\u5f15\u64ce\u5185\u90e8\u4e8b\u52a1 2 \u4f1a\u56de\u6eda\uff0c\u7136\u540e\u5e94\u7528 binlog2 \u53ef\u4ee5\u8865\u56de\u6765\uff1b\u4f46\u662f\u5bf9\u4e8e\u4e8b\u52a1 1 \u6765\u8bf4\uff0c\u7cfb\u7edf\u5df2\u7ecf\u8ba4\u4e3a\u63d0\u4ea4\u5b8c\u6210\u4e86\uff0c\u4e0d\u4f1a\u518d\u5e94\u7528\u4e00\u6b21 binlog1\u3002</p> <p>\u4f46\u662f\uff0cInnoDB \u5f15\u64ce\u4f7f\u7528\u7684\u662f WAL \u6280\u672f\uff0c\u6267\u884c\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u5199\u5b8c\u5185\u5b58\u548c\u65e5\u5fd7\uff0c\u4e8b\u52a1\u5c31\u7b97\u5b8c\u6210\u4e86\u3002\u5982\u679c\u4e4b\u540e\u5d29\u6e83\uff0c\u8981\u4f9d\u8d56\u4e8e\u65e5\u5fd7\u6765\u6062\u590d\u6570\u636e\u9875\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\u5728\u56fe\u4e2d\u8fd9\u4e2a\u4f4d\u7f6e\u53d1\u751f\u5d29\u6e83\u7684\u8bdd\uff0c\u4e8b\u52a1 1 \u4e5f\u662f\u53ef\u80fd\u4e22\u5931\u4e86\u7684\uff0c\u800c\u4e14\u662f\u6570\u636e\u9875\u7ea7\u7684\u4e22\u5931\u3002\u6b64\u65f6\uff0cbinlog \u91cc\u9762\u5e76\u6ca1\u6709\u8bb0\u5f55\u6570\u636e\u9875\u7684\u66f4\u65b0\u7ec6\u8282\uff0c\u662f\u8865\u4e0d\u56de\u6765\u7684\u3002</p> <p>\u4f60\u5982\u679c\u8981\u8bf4\uff0c\u90a3\u6211\u4f18\u5316\u4e00\u4e0b binlog \u7684\u5185\u5bb9\uff0c\u8ba9\u5b83\u6765\u8bb0\u5f55\u6570\u636e\u9875\u7684\u66f4\u6539\u53ef\u4ee5\u5417\uff1f\u4f46\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u53c8\u505a\u4e86\u4e00\u4e2a redo log \u51fa\u6765\u3002</p> <p>\u6240\u4ee5\uff0c\u81f3\u5c11\u73b0\u5728\u7684 binlog \u80fd\u529b\uff0c\u8fd8\u4e0d\u80fd\u652f\u6301\u5d29\u6e83\u6062\u590d\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#6-redo-log-binlog","title":"\u8ffd\u95ee 6\uff1a\u90a3\u80fd\u4e0d\u80fd\u53cd\u8fc7\u6765\uff0c\u53ea\u7528 redo log\uff0c\u4e0d\u8981 binlog\uff1f","text":"<p>\u56de\u7b54\uff1a\u5982\u679c\u53ea\u4ece\u5d29\u6e83\u6062\u590d\u7684\u89d2\u5ea6\u6765\u8bb2\u662f\u53ef\u4ee5\u7684\u3002\u4f60\u53ef\u4ee5\u628a binlog \u5173\u6389\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\u4e86\uff0c\u4f46\u7cfb\u7edf\u4f9d\u7136\u662f crash-safe \u7684\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u4e86\u89e3\u4e00\u4e0b\u4e1a\u754c\u5404\u4e2a\u516c\u53f8\u7684\u4f7f\u7528\u573a\u666f\u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\u5728\u6b63\u5f0f\u7684\u751f\u4ea7\u5e93\u4e0a\uff0cbinlog \u90fd\u662f\u5f00\u7740\u7684\u3002\u56e0\u4e3a binlog \u6709\u7740 redo log \u65e0\u6cd5\u66ff\u4ee3\u7684\u529f\u80fd\u3002</p> <p>\u4e00\u4e2a\u662f\u5f52\u6863\u3002redo log \u662f\u5faa\u73af\u5199\uff0c\u5199\u5230\u672b\u5c3e\u662f\u8981\u56de\u5230\u5f00\u5934\u7ee7\u7eed\u5199\u7684\u3002\u8fd9\u6837\u5386\u53f2\u65e5\u5fd7\u6ca1\u6cd5\u4fdd\u7559\uff0credo log \u4e5f\u5c31\u8d77\u4e0d\u5230\u5f52\u6863\u7684\u4f5c\u7528\u3002</p> <p>\u4e00\u4e2a\u5c31\u662f MySQL \u7cfb\u7edf\u4f9d\u8d56\u4e8e binlog\u3002binlog \u4f5c\u4e3a MySQL \u4e00\u5f00\u59cb\u5c31\u6709\u7684\u529f\u80fd\uff0c\u88ab\u7528\u5728\u4e86\u5f88\u591a\u5730\u65b9\u3002\u5176\u4e2d\uff0cMySQL \u7cfb\u7edf\u9ad8\u53ef\u7528\u7684\u57fa\u7840\uff0c\u5c31\u662f binlog \u590d\u5236\u3002</p> <p>\u8fd8\u6709\u5f88\u591a\u516c\u53f8\u6709\u5f02\u6784\u7cfb\u7edf\uff08\u6bd4\u5982\u4e00\u4e9b\u6570\u636e\u5206\u6790\u7cfb\u7edf\uff09\uff0c\u8fd9\u4e9b\u7cfb\u7edf\u5c31\u9760\u6d88\u8d39 MySQL \u7684 binlog \u6765\u66f4\u65b0\u81ea\u5df1\u7684\u6570\u636e\u3002\u5173\u6389 binlog \u7684\u8bdd\uff0c\u8fd9\u4e9b\u4e0b\u6e38\u7cfb\u7edf\u5c31\u6ca1\u6cd5\u8f93\u5165\u4e86\u3002</p> <p>\u603b\u4e4b\uff0c\u7531\u4e8e\u73b0\u5728\u5305\u62ec MySQL \u9ad8\u53ef\u7528\u5728\u5185\u7684\u5f88\u591a\u7cfb\u7edf\u673a\u5236\u90fd\u4f9d\u8d56\u4e8e binlog\uff0c\u6240\u4ee5\u201c\u9e20\u5360\u9e4a\u5de2\u201dredo log \u8fd8\u505a\u4e0d\u5230\u3002\u4f60\u770b\uff0c\u53d1\u5c55\u751f\u6001\u662f\u591a\u4e48\u91cd\u8981\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#7redo-log","title":"\u8ffd\u95ee 7\uff1aredo log \u4e00\u822c\u8bbe\u7f6e\u591a\u5927\uff1f","text":"<p>\u56de\u7b54\uff1aredo log \u592a\u5c0f\u7684\u8bdd\uff0c\u4f1a\u5bfc\u81f4\u5f88\u5feb\u5c31\u88ab\u5199\u6ee1\uff0c\u7136\u540e\u4e0d\u5f97\u4e0d\u5f3a\u884c\u5237 redo log\uff0c\u8fd9\u6837 WAL \u673a\u5236\u7684\u80fd\u529b\u5c31\u53d1\u6325\u4e0d\u51fa\u6765\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u662f\u73b0\u5728\u5e38\u89c1\u7684\u51e0\u4e2a TB \u7684\u78c1\u76d8\u7684\u8bdd\uff0c\u5c31\u4e0d\u8981\u592a\u5c0f\u6c14\u4e86\uff0c\u76f4\u63a5\u5c06 redo log \u8bbe\u7f6e\u4e3a 4 \u4e2a\u6587\u4ef6\u3001\u6bcf\u4e2a\u6587\u4ef6 1GB \u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#8-redo-log-buffer-pool","title":"\u8ffd\u95ee 8\uff1a\u6b63\u5e38\u8fd0\u884c\u4e2d\u7684\u5b9e\u4f8b\uff0c\u6570\u636e\u5199\u5165\u540e\u7684\u6700\u7ec8\u843d\u76d8\uff0c\u662f\u4ece redo log \u66f4\u65b0\u8fc7\u6765\u7684\u8fd8\u662f\u4ece buffer pool \u66f4\u65b0\u8fc7\u6765\u7684\u5462\uff1f","text":"<p>\u56de\u7b54\uff1a\u8fd9\u4e2a\u95ee\u9898\u5176\u5b9e\u95ee\u5f97\u975e\u5e38\u597d\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u4e86\uff0c\u201credo log \u91cc\u9762\u5230\u5e95\u662f\u4ec0\u4e48\u201d\u7684\u95ee\u9898\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0credo log \u5e76\u6ca1\u6709\u8bb0\u5f55\u6570\u636e\u9875\u7684\u5b8c\u6574\u6570\u636e\uff0c\u6240\u4ee5\u5b83\u5e76\u6ca1\u6709\u80fd\u529b\u81ea\u5df1\u53bb\u66f4\u65b0\u78c1\u76d8\u6570\u636e\u9875\uff0c\u4e5f\u5c31\u4e0d\u5b58\u5728\u201c\u6570\u636e\u6700\u7ec8\u843d\u76d8\uff0c\u662f\u7531 redo log \u66f4\u65b0\u8fc7\u53bb\u201d\u7684\u60c5\u51b5\u3002</p> <ol> <li>\u5982\u679c\u662f\u6b63\u5e38\u8fd0\u884c\u7684\u5b9e\u4f8b\u7684\u8bdd\uff0c\u6570\u636e\u9875\u88ab\u4fee\u6539\u4ee5\u540e\uff0c\u8ddf\u78c1\u76d8\u7684\u6570\u636e\u9875\u4e0d\u4e00\u81f4\uff0c\u79f0\u4e3a\u810f\u9875\u3002\u6700\u7ec8\u6570\u636e\u843d\u76d8\uff0c\u5c31\u662f\u628a\u5185\u5b58\u4e2d\u7684\u6570\u636e\u9875\u5199\u76d8\u3002\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u751a\u81f3\u4e0e redo log \u6beb\u65e0\u5173\u7cfb\u3002</li> <li>\u5728\u5d29\u6e83\u6062\u590d\u573a\u666f\u4e2d\uff0cInnoDB \u5982\u679c\u5224\u65ad\u5230\u4e00\u4e2a\u6570\u636e\u9875\u53ef\u80fd\u5728\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\u4e22\u5931\u4e86\u66f4\u65b0\uff0c\u5c31\u4f1a\u5c06\u5b83\u8bfb\u5230\u5185\u5b58\uff0c\u7136\u540e\u8ba9 redo log \u66f4\u65b0\u5185\u5b58\u5185\u5bb9\u3002\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u5185\u5b58\u9875\u53d8\u6210\u810f\u9875\uff0c\u5c31\u56de\u5230\u4e86\u7b2c\u4e00\u79cd\u60c5\u51b5\u7684\u72b6\u6001\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#9redo-log-buffer-redo-log","title":"\u8ffd\u95ee 9\uff1aredo log buffer \u662f\u4ec0\u4e48\uff1f\u662f\u5148\u4fee\u6539\u5185\u5b58\uff0c\u8fd8\u662f\u5148\u5199 redo log \u6587\u4ef6\uff1f","text":"<p>\u56de\u7b54\uff1a\u8fd9\u4e24\u4e2a\u95ee\u9898\u53ef\u4ee5\u4e00\u8d77\u56de\u7b54\u3002</p> <p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u7684\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u65e5\u5fd7\u662f\u8981\u5199\u591a\u6b21\u7684\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u4e8b\u52a1\uff1a</p> <pre><code>begin;\ninsert into t1 ...\ninsert into t2 ...\ncommit;\n</code></pre> <p>\u8fd9\u4e2a\u4e8b\u52a1\u8981\u5f80\u4e24\u4e2a\u8868\u4e2d\u63d2\u5165\u8bb0\u5f55\uff0c\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u7684\u65e5\u5fd7\u90fd\u5f97\u5148\u4fdd\u5b58\u8d77\u6765\uff0c\u4f46\u53c8\u4e0d\u80fd\u5728\u8fd8\u6ca1 commit \u7684\u65f6\u5019\u5c31\u76f4\u63a5\u5199\u5230 redo log \u6587\u4ef6\u91cc\u3002</p> <p>\u6240\u4ee5\uff0credo log buffer \u5c31\u662f\u4e00\u5757\u5185\u5b58\uff0c\u7528\u6765\u5148\u5b58 redo \u65e5\u5fd7\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6267\u884c\u7b2c\u4e00\u4e2a insert \u7684\u65f6\u5019\uff0c\u6570\u636e\u7684\u5185\u5b58\u88ab\u4fee\u6539\u4e86\uff0credo log buffer \u4e5f\u5199\u5165\u4e86\u65e5\u5fd7\u3002</p> <p>\u4f46\u662f\uff0c\u771f\u6b63\u628a\u65e5\u5fd7\u5199\u5230 redo log \u6587\u4ef6\uff08\u6587\u4ef6\u540d\u662f ib_logfile+ \u6570\u5b57\uff09\uff0c\u662f\u5728\u6267\u884c commit \u8bed\u53e5\u7684\u65f6\u5019\u505a\u7684\u3002</p> <p>\uff08\u8fd9\u91cc\u8bf4\u7684\u662f\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u201c\u4e3b\u52a8\u53bb\u5237\u76d8\u201d\uff0c\u4ee5\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684 IO \u6d88\u8017\u3002\u4f46\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u201c\u88ab\u52a8\u5199\u5165\u78c1\u76d8\u201d\uff0c\u6bd4\u5982\u5185\u5b58\u4e0d\u591f\u3001\u5176\u4ed6\u4e8b\u52a1\u63d0\u4ea4\u7b49\u60c5\u51b5\u3002\u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7b2c 22 \u7bc7\u6587\u7ae0\u300aMySQL \u6709\u54ea\u4e9b\u201c\u996e\u9e29\u6b62\u6e34\u201d\u7684\u63d0\u9ad8\u6027\u80fd\u7684\u65b9\u6cd5\uff1f\u300b\u4e2d\u518d\u8be6\u7ec6\u5c55\u5f00\uff09\u3002</p> <p>\u5355\u72ec\u6267\u884c\u4e00\u4e2a\u66f4\u65b0\u8bed\u53e5\u7684\u65f6\u5019\uff0cInnoDB \u4f1a\u81ea\u5df1\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u7684\u65f6\u5019\u63d0\u4ea4\u3002\u8fc7\u7a0b\u8ddf\u4e0a\u9762\u662f\u4e00\u6837\u7684\uff0c\u53ea\u4e0d\u8fc7\u662f\u201c\u538b\u7f29\u201d\u5230\u4e86\u4e00\u4e2a\u8bed\u53e5\u91cc\u9762\u5b8c\u6210\u3002</p> <p>\u4ee5\u4e0a\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c31\u662f\u628a\u5927\u5bb6\u63d0\u8fc7\u7684\u5173\u4e8e redo log \u548c binlog \u7684\u95ee\u9898\u4e32\u8d77\u6765\uff0c\u505a\u7684\u4e00\u6b21\u96c6\u4e2d\u56de\u7b54\u3002\u5982\u679c\u4f60\u8fd8\u6709\u95ee\u9898\uff0c\u53ef\u4ee5\u5728\u8bc4\u8bba\u533a\u7ee7\u7eed\u7559\u8a00\u8865\u5145\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_13","title":"\u4e1a\u52a1\u8bbe\u8ba1\u95ee\u9898","text":"<p>\u4e1a\u52a1\u4e0a\u6709\u8fd9\u6837\u7684\u9700\u6c42\uff0cA\u3001B \u4e24\u4e2a\u7528\u6237\uff0c\u5982\u679c\u4e92\u76f8\u5173\u6ce8\uff0c\u5219\u6210\u4e3a\u597d\u53cb\u3002\u8bbe\u8ba1\u4e0a\u662f\u6709\u4e24\u5f20\u8868\uff0c\u4e00\u4e2a\u662f like \u8868\uff0c\u4e00\u4e2a\u662f friend \u8868\uff0clike \u8868\u6709 <code>user_id</code>\u3001<code>liker_id</code> \u4e24\u4e2a\u5b57\u6bb5\uff0c\u6211\u8bbe\u7f6e\u4e3a\u590d\u5408\u552f\u4e00\u7d22\u5f15\u5373 <code>uk_user_id_liker_id</code>\u3002\u8bed\u53e5\u6267\u884c\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a</p> <p>\u4ee5 A \u5173\u6ce8 B \u4e3a\u4f8b\uff1a \u7b2c\u4e00\u6b65\uff0c\u5148\u67e5\u8be2\u5bf9\u65b9\u6709\u6ca1\u6709\u5173\u6ce8\u81ea\u5df1\uff08B \u6709\u6ca1\u6709\u5173\u6ce8 A\uff09</p> <pre><code> select * from like where user_id = B and liker_id = A;\n</code></pre> <p>\u5982\u679c\u6709\uff0c\u5219\u6210\u4e3a\u597d\u53cb <code>insert into friend;</code></p> <p>\u6ca1\u6709\uff0c\u5219\u53ea\u662f\u5355\u5411\u5173\u6ce8\u5173\u7cfb <code>insert into like;</code></p> <p>\u4f46\u662f\u5982\u679c A\u3001B \u540c\u65f6\u5173\u6ce8\u5bf9\u65b9\uff0c\u4f1a\u51fa\u73b0\u4e0d\u4f1a\u6210\u4e3a\u597d\u53cb\u7684\u60c5\u51b5\u3002\u56e0\u4e3a\u4e0a\u9762\u7b2c 1 \u6b65\uff0c\u53cc\u65b9\u90fd\u6ca1\u5173\u6ce8\u5bf9\u65b9\u3002\u7b2c 1 \u6b65\u5373\u4f7f\u4f7f\u7528\u4e86\u6392\u4ed6\u9501\u4e5f\u4e0d\u884c\uff0c\u56e0\u4e3a\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u884c\u9501\u65e0\u6cd5\u751f\u6548\u3002\u8bf7\u95ee\u8fd9\u79cd\u60c5\u51b5\uff0c\u5728 MySQL \u9501\u5c42\u9762\u6709\u6ca1\u6709\u529e\u6cd5\u5904\u7406\uff1f</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u628a\u8868\u6a21\u62df\u51fa\u6765\uff0c\u65b9\u4fbf\u6211\u4eec\u8ba8\u8bba\u3002</p> <pre><code>CREATE TABLE `like` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `user_id` int(11) NOT NULL,\n  `liker_id` int(11) NOT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_user_id_liker_id` (`user_id`,`liker_id`)\n) ENGINE=InnoDB; \n\nCREATE TABLE `friend` (\n  id` int(11) NOT NULL AUTO_INCREMENT,\n  `friend_1_id` int(11) NOT NULL,\n  `firned_2_id` int(11) NOT NULL,\n  UNIQUE KEY `uk_friend` (`friend_1_id`,`firned_2_id`)\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u867d\u7136\u8fd9\u4e2a\u9898\u5e72\u4e2d\uff0c\u5e76\u6ca1\u6709\u8bf4\u5230 friend \u8868\u7684\u7d22\u5f15\u7ed3\u6784\u3002\u4f46\u6211\u731c\u6d4b <code>friend_1_id</code> \u548c <code>friend_2_id</code> \u4e5f\u6709\u7d22\u5f15\uff0c\u4e3a\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u7ed9\u52a0\u4e0a\u552f\u4e00\u7d22\u5f15\u3002</p> <p>\u987a\u4fbf\u8bf4\u660e\u4e00\u4e0b\uff0c<code>like</code> \u662f\u5173\u952e\u5b57\uff0c\u6211\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u5173\u952e\u5b57\u4f5c\u4e3a\u5e93\u540d\u3001\u8868\u540d\u3001\u5b57\u6bb5\u540d\u6216\u7d22\u5f15\u540d\u3002</p> <p>\u5728\u5e76\u53d1\u573a\u666f\u4e0b\uff0c\u540c\u65f6\u6709\u4e24\u4e2a\u4eba\uff0c\u8bbe\u7f6e\u4e3a\u5173\u6ce8\u5bf9\u65b9\uff0c\u5c31\u53ef\u80fd\u5bfc\u81f4\u65e0\u6cd5\u6210\u529f\u52a0\u4e3a\u670b\u53cb\u5173\u7cfb\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u7528\u4f60\u5df2\u7ecf\u719f\u6089\u7684\u65f6\u523b\u987a\u5e8f\u8868\u7684\u5f62\u5f0f\uff0c\u628a\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u7684\u6267\u884c\u8bed\u53e5\u5217\u51fa\u6765\uff1a</p> session 1(\u903b\u8f91\u64cd\u4f5c\uff1a A \u559c\u6b22 B) session 2\uff08\u64cd\u4f5c\u903b\u8f91\uff1aB \u559c\u6b22 A\uff09 begin;select * from <code>like</code> where user_id= B and liker_id = A; // \u8fd4\u56de\u7a7a begin;select * from <code>like</code> where user_id= A and liker_id = B; // \u8fd4\u56de\u7a7a insert into <code>like</code> (user_id, liker_id) values(B, A); insert into <code>like</code> (user_id, liker_id) values(A, B); commit; commit; <p>\u7531\u4e8e\u4e00\u5f00\u59cb A \u548c B \u4e4b\u95f4\u6ca1\u6709\u5173\u6ce8\u5173\u7cfb\uff0c\u6240\u4ee5\u4e24\u4e2a\u4e8b\u52a1\u91cc\u9762\u7684 select \u8bed\u53e5\u67e5\u51fa\u6765\u7684\u7ed3\u679c\u90fd\u662f\u7a7a\u3002</p> <p>\u56e0\u6b64\uff0csession 1 \u7684\u903b\u8f91\u5c31\u662f\u201c\u65e2\u7136 B \u6ca1\u6709\u5173\u6ce8 A\uff0c\u90a3\u5c31\u53ea\u63d2\u5165\u4e00\u4e2a\u5355\u5411\u5173\u6ce8\u5173\u7cfb\u201d\u3002session 2 \u4e5f\u540c\u6837\u662f\u8fd9\u4e2a\u903b\u8f91\u3002</p> <p>\u8fd9\u4e2a\u7ed3\u679c\u5bf9\u4e1a\u52a1\u6765\u8bf4\u5c31\u662f bug \u4e86\u3002\u56e0\u4e3a\u5728\u4e1a\u52a1\u8bbe\u5b9a\u91cc\u9762\uff0c\u8fd9\u4e24\u4e2a\u903b\u8f91\u90fd\u6267\u884c\u5b8c\u6210\u4ee5\u540e\uff0c\u662f\u5e94\u8be5\u5728 friend \u8868\u91cc\u9762\u63d2\u5165\u4e00\u884c\u8bb0\u5f55\u7684\u3002</p> <p>\u5982\u63d0\u95ee\u91cc\u9762\u8bf4\u7684\uff0c\u201c\u7b2c 1 \u6b65\u5373\u4f7f\u4f7f\u7528\u4e86\u6392\u4ed6\u9501\u4e5f\u4e0d\u884c\uff0c\u56e0\u4e3a\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u884c\u9501\u65e0\u6cd5\u751f\u6548\u201d\u3002\u4e0d\u8fc7\uff0c\u6211\u60f3\u5230\u4e86\u53e6\u5916\u4e00\u4e2a\u65b9\u6cd5\uff0c\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u9996\u5148\uff0c\u8981\u7ed9 <code>like</code> \u8868\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\uff0c\u6bd4\u5982\u53eb\u4f5c <code>relation_ship</code>\uff0c\u5e76\u8bbe\u4e3a\u6574\u578b\uff0c\u53d6\u503c 1\u30012\u30013\u3002</p> <ul> <li>\u503c\u662f 1 \u7684\u65f6\u5019\uff0c\u8868\u793a user_id \u5173\u6ce8 liker_id; </li> <li>\u503c\u662f 2 \u7684\u65f6\u5019\uff0c\u8868\u793a liker_id \u5173\u6ce8 user_id; </li> <li>\u503c\u662f 3 \u7684\u65f6\u5019\uff0c\u8868\u793a\u4e92\u76f8\u5173\u6ce8\u3002</li> </ul> <p>\u7136\u540e\uff0c\u5f53 A \u5173\u6ce8 B \u7684\u65f6\u5019\uff0c\u903b\u8f91\u6539\u6210\u5982\u4e0b\u6240\u793a\u7684\u6837\u5b50\uff1a</p> <p>\u5e94\u7528\u4ee3\u7801\u91cc\u9762\uff0c\u6bd4\u8f83 A \u548c B \u7684\u5927\u5c0f\uff0c\u5982\u679c A\\&lt;B\uff0c\u5c31\u6267\u884c\u4e0b\u9762\u7684\u903b\u8f91</p> <pre><code>mysql&gt; begin; /* \u542f\u52a8\u4e8b\u52a1 */\ninsert into `like`(user_id, liker_id, relation_ship) values(A, B, 1) on duplicate key update relation_ship=relation_ship | 1;\nselect relation_ship from `like` where user_id=A and liker_id=B;\n/* \u4ee3\u7801\u4e2d\u5224\u65ad\u8fd4\u56de\u7684 relation_ship\uff0c\n  \u5982\u679c\u662f 1\uff0c\u4e8b\u52a1\u7ed3\u675f\uff0c\u6267\u884c commit\n  \u5982\u679c\u662f 3\uff0c\u5219\u6267\u884c\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\uff1a\n  */\ninsert ignore into friend(friend_1_id, friend_2_id) values(A,B);\ncommit;\n</code></pre> <p>\u5982\u679c A&gt;B\uff0c\u5219\u6267\u884c\u4e0b\u9762\u7684\u903b\u8f91</p> <pre><code>mysql&gt; begin; /* \u542f\u52a8\u4e8b\u52a1 */\ninsert into `like`(user_id, liker_id, relation_ship) values(B, A, 2) on duplicate key update relation_ship=relation_ship | 2;\nselect relation_ship from `like` where user_id=B and liker_id=A;\n/* \u4ee3\u7801\u4e2d\u5224\u65ad\u8fd4\u56de\u7684 relation_ship\uff0c\n  \u5982\u679c\u662f 2\uff0c\u4e8b\u52a1\u7ed3\u675f\uff0c\u6267\u884c commit\n  \u5982\u679c\u662f 3\uff0c\u5219\u6267\u884c\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\uff1a\n*/\ninsert ignore into friend(friend_1_id, friend_2_id) values(B,A);\ncommit;\n</code></pre> <p>\u8fd9\u4e2a\u8bbe\u8ba1\u91cc\uff0c\u8ba9 <code>like</code> \u8868\u91cc\u7684\u6570\u636e\u4fdd\u8bc1 <code>user_id &lt; liker_id</code>\uff0c\u8fd9\u6837\u4e0d\u8bba\u662f A \u5173\u6ce8 B\uff0c\u8fd8\u662f B \u5173\u6ce8 A\uff0c\u5728\u64cd\u4f5clike \u8868\u7684\u65f6\u5019\uff0c\u5982\u679c\u53cd\u5411\u7684\u5173\u7cfb\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4f1a\u51fa\u73b0\u884c\u9501\u51b2\u7a81\u3002</p> <p>\u7136\u540e\uff0c<code>insert \u2026 on duplicate</code> \u8bed\u53e5\uff0c\u786e\u4fdd\u4e86\u5728\u4e8b\u52a1\u5185\u90e8\uff0c\u6267\u884c\u4e86\u8fd9\u4e2a SQL \u8bed\u53e5\u540e\uff0c\u5c31\u5f3a\u884c\u5360\u4f4f\u4e86\u8fd9\u4e2a\u884c\u9501\uff0c\u4e4b\u540e\u7684 select \u5224\u65ad <code>relation_ship</code> \u8fd9\u4e2a\u903b\u8f91\u65f6\u5c31\u786e\u4fdd\u4e86\u662f\u5728\u884c\u9501\u4fdd\u62a4\u4e0b\u7684\u8bfb\u64cd\u4f5c\u3002</p> <p>\u64cd\u4f5c\u7b26 <code>|</code> \u662f\u6309\u4f4d\u6216\uff0c\u8fde\u540c\u6700\u540e\u4e00\u53e5 insert \u8bed\u53e5\u91cc\u7684 ignore\uff0c\u662f\u4e3a\u4e86\u4fdd\u8bc1\u91cd\u590d\u8c03\u7528\u65f6\u7684\u5e42\u7b49\u6027\u3002</p> <p>\u8fd9\u6837\uff0c\u5373\u4f7f\u5728\u53cc\u65b9\u201c\u540c\u65f6\u201d\u6267\u884c\u5173\u6ce8\u64cd\u4f5c\uff0c\u6700\u7ec8\u6570\u636e\u5e93\u91cc\u7684\u7ed3\u679c\uff0c\u4e5f\u662f like \u8868\u91cc\u9762\u6709\u4e00\u6761\u5173\u4e8e A \u548c B \u7684\u8bb0\u5f55\uff0c\u800c\u4e14 relation_ship \u7684\u503c\u662f 3\uff0c \u5e76\u4e14 friend \u8868\u91cc\u9762\u4e5f\u6709\u4e86 A \u548c B \u7684\u8fd9\u6761\u8bb0\u5f55\u3002</p> <p>\u4e0d\u77e5\u9053\u4f60\u4f1a\u4e0d\u4f1a\u5410\u69fd\uff1a\u4e4b\u524d\u660e\u660e\u8fd8\u8bf4\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\uff0c\u7ed3\u679c\u8fd9\u4e2a\u4f8b\u5b50\u4e00\u4e0a\u6765\u6211\u5c31\u521b\u5efa\u4e86\u4e24\u4e2a\u3002\u8fd9\u91cc\u6211\u8981\u518d\u548c\u4f60\u8bf4\u660e\u4e00\u4e0b\uff0c\u4e4b\u524d\u6587\u7ae0\u6211\u4eec\u8ba8\u8bba\u7684\uff0c\u662f\u5728\u201c\u4e1a\u52a1\u5f00\u53d1\u4fdd\u8bc1\u4e0d\u4f1a\u63d2\u5165\u91cd\u590d\u8bb0\u5f55\u201d\u7684\u60c5\u51b5\u4e0b\uff0c\u7740\u91cd\u8981\u89e3\u51b3\u6027\u80fd\u95ee\u9898\u7684\u65f6\u5019\uff0c\u624d\u5efa\u8bae\u5c3d\u91cf\u4f7f\u7528\u666e\u901a\u7d22\u5f15\u3002</p> <p>\u800c\u50cf\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6309\u7167\u8fd9\u4e2a\u8bbe\u8ba1\uff0c\u4e1a\u52a1\u6839\u672c\u5c31\u662f\u4fdd\u8bc1\u201c\u6211\u4e00\u5b9a\u4f1a\u63d2\u5165\u91cd\u590d\u6570\u636e\uff0c\u6570\u636e\u5e93\u4e00\u5b9a\u8981\u8981\u6709\u552f\u4e00\u6027\u7ea6\u675f\u201d\uff0c\u8fd9\u65f6\u5c31\u6ca1\u5565\u597d\u8bf4\u7684\u4e86\uff0c\u552f\u4e00\u7d22\u5f15\u5efa\u8d77\u6765\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_14","title":"\u5c0f\u7ed3","text":"<p>\u8fd9\u662f\u4e13\u680f\u7684\u7b2c\u4e00\u7bc7\u7b54\u7591\u6587\u7ae0\u3002</p> <p>\u6211\u9488\u5bf9\u524d 14 \u7bc7\u6587\u7ae0\uff0c\u5927\u5bb6\u5728\u8bc4\u8bba\u533a\u4e2d\u7684\u7559\u8a00\uff0c\u4ece\u4e2d\u6458\u53d6\u4e86\u5173\u4e8e\u65e5\u5fd7\u548c\u7d22\u5f15\u7684\u76f8\u5173\u95ee\u9898\uff0c\u4e32\u6210\u4e86\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u3002\u8fd9\u91cc\u6211\u4e5f\u8981\u518d\u548c\u4f60\u8bf4\u4e00\u58f0\uff0c\u6709\u4e9b\u6211\u7b54\u5e94\u5728\u7b54\u7591\u6587\u7ae0\u4e2d\u8fdb\u884c\u6269\u5c55\u7684\u8bdd\u9898\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u6ca1\u6765\u5f97\u53ca\u6269\u5c55\uff0c\u540e\u7eed\u6211\u4f1a\u518d\u627e\u673a\u4f1a\u4e3a\u4f60\u89e3\u7b54\u3002\u6240\u4ee5\uff0c\u7bc7\u5e45\u6240\u9650\uff0c\u8bc4\u8bba\u533a\u89c1\u5427\u3002</p> <p>\u6700\u540e\uff0c\u867d\u7136\u8fd9\u7bc7\u662f\u7b54\u7591\u6587\u7ae0\uff0c\u4f46\u8bfe\u540e\u95ee\u9898\u8fd8\u662f\u8981\u6709\u7684\u3002</p> <p>\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u8868 t\uff0c\u5e76\u63d2\u5165\u4e00\u884c\uff0c\u7136\u540e\u5bf9\u8fd9\u4e00\u884c\u505a\u4fee\u6539\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n`id` int(11) NOT NULL primary key auto_increment,\n`a` int(11) DEFAULT NULL\n) ENGINE=InnoDB;\nmysql&gt; insert into t values(1,2);\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u8868 t \u91cc\u6709\u552f\u4e00\u7684\u4e00\u884c\u6570\u636e (1,2)\u3002\u5047\u8bbe\uff0c\u6211\u73b0\u5728\u8981\u6267\u884c\uff1a</p> <pre><code>mysql&gt; update t set a=2 where id=1;\n</code></pre> <p>\u4f60\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u7ed3\u679c\uff1a</p> <pre><code>mysql&gt; update t set a=2 where id = 1;\nQuery OK, 0 rows affected (0.00 sec)\nRows matched: 1  Changed: 0  Warning: 0\n</code></pre> <p>\u7ed3\u679c\u663e\u793a\uff0c\u5339\u914d (rows matched) \u4e86\u4e00\u884c\uff0c\u4fee\u6539 (Changed) \u4e86 0 \u884c\u3002</p> <p>\u4ec5\u4ece\u73b0\u8c61\u4e0a\u770b\uff0cMySQL \u5185\u90e8\u5728\u5904\u7406\u8fd9\u4e2a\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6709\u4ee5\u4e0b\u4e09\u79cd\u9009\u62e9\uff1a</p> <ol> <li>\u66f4\u65b0\u90fd\u662f\u5148\u8bfb\u540e\u5199\u7684\uff0cMySQL \u8bfb\u51fa\u6570\u636e\uff0c\u53d1\u73b0 a \u7684\u503c\u672c\u6765\u5c31\u662f 2\uff0c\u4e0d\u66f4\u65b0\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\u6267\u884c\u7ed3\u675f\uff1b</li> <li>MySQL \u8c03\u7528\u4e86 InnoDB \u5f15\u64ce\u63d0\u4f9b\u7684\u201c\u4fee\u6539\u4e3a (1,2)\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4f46\u662f\u5f15\u64ce\u53d1\u73b0\u503c\u4e0e\u539f\u6765\u76f8\u540c\uff0c\u4e0d\u66f4\u65b0\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b</li> <li>InnoDB \u8ba4\u771f\u6267\u884c\u4e86\u201c\u628a\u8fd9\u4e2a\u503c\u4fee\u6539\u6210 (1,2)\"\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u8be5\u52a0\u9501\u7684\u52a0\u9501\uff0c\u8be5\u66f4\u65b0\u7684\u66f4\u65b0\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#16-order-by","title":"16 \u201corder by\u201d\u662f\u600e\u4e48\u5de5\u4f5c\u7684\uff1f","text":"<p>\u5728\u4f60\u5f00\u53d1\u5e94\u7528\u7684\u65f6\u5019\uff0c\u4e00\u5b9a\u4f1a\u7ecf\u5e38\u78b0\u5230\u9700\u8981\u6839\u636e\u6307\u5b9a\u7684\u5b57\u6bb5\u6392\u5e8f\u6765\u663e\u793a\u7ed3\u679c\u7684\u9700\u6c42\u3002\u8fd8\u662f\u4ee5\u6211\u4eec\u524d\u9762\u4e3e\u4f8b\u7528\u8fc7\u7684\u5e02\u6c11\u8868\u4e3a\u4f8b\uff0c\u5047\u8bbe\u4f60\u8981\u67e5\u8be2\u57ce\u5e02\u662f\u201c\u676d\u5dde\u201d\u7684\u6240\u6709\u4eba\u540d\u5b57\uff0c\u5e76\u4e14\u6309\u7167\u59d3\u540d\u6392\u5e8f\u8fd4\u56de\u524d 1000 \u4e2a\u4eba\u7684\u59d3\u540d\u3001\u5e74\u9f84\u3002</p> <p>\u5047\u8bbe\u8fd9\u4e2a\u8868\u7684\u90e8\u5206\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `city` varchar(16) NOT NULL,\n  `name` varchar(16) NOT NULL,\n  `age` int(11) NOT NULL,\n  `addr` varchar(128) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `city` (`city`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u8fd9\u65f6\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>select city,name,age from t where city='\u676d\u5dde' order by name limit 1000  ;\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u770b\u4e0a\u53bb\u903b\u8f91\u5f88\u6e05\u6670\uff0c\u4f46\u662f\u4f60\u4e86\u89e3\u5b83\u7684\u6267\u884c\u6d41\u7a0b\u5417\uff1f\u4eca\u5929\uff0c\u6211\u5c31\u548c\u4f60\u804a\u804a\u8fd9\u4e2a\u8bed\u53e5\u662f\u600e\u4e48\u6267\u884c\u7684\uff0c\u4ee5\u53ca\u6709\u4ec0\u4e48\u53c2\u6570\u4f1a\u5f71\u54cd\u6267\u884c\u7684\u884c\u4e3a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_15","title":"\u5168\u5b57\u6bb5\u6392\u5e8f","text":"<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7d22\u5f15\uff0c\u6240\u4ee5\u4f60\u73b0\u5728\u5c31\u5f88\u6e05\u695a\u4e86\uff0c\u4e3a\u907f\u514d\u5168\u8868\u626b\u63cf\uff0c\u6211\u4eec\u9700\u8981\u5728 city \u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\u3002</p> <p>\u5728 city \u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u4e4b\u540e\uff0c\u6211\u4eec\u7528 explain \u547d\u4ee4\u6765\u770b\u770b\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p> <pre><code>mysql&gt; explain select city,name,age from t where city='\u676d\u5dde' order by name limit 1000  ;\n+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref   | rows | filtered | Extra          |\n+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+\n|  1 | SIMPLE      | t     | NULL       | ref  | city          | city | 66      | const | 4000 |   100.00 | Using filesort |\n+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+----------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>Extra \u8fd9\u4e2a\u5b57\u6bb5\u4e2d\u7684\u201cUsing filesort\u201d\u8868\u793a\u7684\u5c31\u662f\u9700\u8981\u6392\u5e8f\uff0cMySQL \u4f1a\u7ed9\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u4e00\u5757\u5185\u5b58\u7528\u4e8e\u6392\u5e8f\uff0c\u79f0\u4e3a <code>sort_buffer</code>\u3002</p> <p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a SQL \u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b city \u8fd9\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p> <p></p> <p>\u56fe 2 city \u5b57\u6bb5\u7684\u7d22\u5f15\u793a\u610f\u56fe</p> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u884c\uff0c\u662f\u4ece <code>ID_X</code> \u5230 <code>ID_(X+N)</code> \u7684\u8fd9\u4e9b\u8bb0\u5f55\u3002</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a \uff1a</p> <ol> <li>\u521d\u59cb\u5316 <code>sort_buffer</code>\uff0c\u786e\u5b9a\u653e\u5165 name\u3001city\u3001age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\uff1b</li> <li>\u4ece\u7d22\u5f15 city \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 city='\u676d\u5dde\u2019\u6761\u4ef6\u7684\u4e3b\u952e id\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_X</code>\uff1b</li> <li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 name\u3001city\u3001age \u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u5b58\u5165 <code>sort_buffer</code> \u4e2d\uff1b</li> <li>\u4ece\u7d22\u5f15 city \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u7684\u4e3b\u952e id\uff1b</li> <li>\u91cd\u590d\u6b65\u9aa4 3\u30014 \u76f4\u5230 city \u7684\u503c\u4e0d\u6ee1\u8db3\u67e5\u8be2\u6761\u4ef6\u4e3a\u6b62\uff0c\u5bf9\u5e94\u7684\u4e3b\u952e id \u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_Y</code>\uff1b</li> <li>\u5bf9 <code>sort_buffer</code> \u4e2d\u7684\u6570\u636e\u6309\u7167\u5b57\u6bb5 name \u505a\u5feb\u901f\u6392\u5e8f\uff1b</li> <li>\u6309\u7167\u6392\u5e8f\u7ed3\u679c\u53d6\u524d 1000 \u884c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ol> <p>\u6211\u4eec\u6682\u4e14\u628a\u8fd9\u4e2a\u6392\u5e8f\u8fc7\u7a0b\uff0c\u79f0\u4e3a\u5168\u5b57\u6bb5\u6392\u5e8f\uff0c\u6267\u884c\u6d41\u7a0b\u7684\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff0c\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u8fd8\u4f1a\u7528\u5230\u8fd9\u4e2a\u6392\u5e8f\u3002</p> <p></p> <p>\u56fe 3 \u5168\u5b57\u6bb5\u6392\u5e8f</p> <p>\u56fe\u4e2d\u201c\u6309 name \u6392\u5e8f\u201d\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u53ef\u80fd\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\uff0c\u4e5f\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u5916\u90e8\u6392\u5e8f\uff0c\u8fd9\u53d6\u51b3\u4e8e\u6392\u5e8f\u6240\u9700\u7684\u5185\u5b58\u548c\u53c2\u6570 <code>sort_buffer_size</code>\u3002</p> <p><code>sort_buffer_size</code>\uff0c\u5c31\u662f MySQL \u4e3a\u6392\u5e8f\u5f00\u8f9f\u7684\u5185\u5b58\uff08<code>sort_buffer</code>\uff09\u7684\u5927\u5c0f\u3002\u5982\u679c\u8981\u6392\u5e8f\u7684\u6570\u636e\u91cf\u5c0f\u4e8e <code>sort_buffer_size</code>\uff0c\u6392\u5e8f\u5c31\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u3002\u4f46\u5982\u679c\u6392\u5e8f\u6570\u636e\u91cf\u592a\u5927\uff0c\u5185\u5b58\u653e\u4e0d\u4e0b\uff0c\u5219\u4e0d\u5f97\u4e0d\u5229\u7528\u78c1\u76d8\u4e34\u65f6\u6587\u4ef6\u8f85\u52a9\u6392\u5e8f\u3002</p> <p>\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u6765\u786e\u5b9a\u4e00\u4e2a\u6392\u5e8f\u8bed\u53e5\u662f\u5426\u4f7f\u7528\u4e86\u4e34\u65f6\u6587\u4ef6\u3002</p> <pre><code>/* \u6253\u5f00 optimizer_trace\uff0c\u53ea\u5bf9\u672c\u7ebf\u7a0b\u6709\u6548 */\nSET optimizer_trace='enabled=on';  \n/* @a \u4fdd\u5b58 Innodb_rows_read \u7684\u521d\u59cb\u503c */\nselect variable_value into @a from  performance_schema.session_status where variable_name = 'Innodb_rows_read'; \n/* \u6267\u884c\u8bed\u53e5 */\nselect city, name,age from t where city='\u676d\u5dde' order by name limit 1000;  \n/* \u67e5\u770b OPTIMIZER_TRACE \u8f93\u51fa */\nSELECT * FROM `information_schema`.`OPTIMIZER_TRACE`\\G; \n/* @b \u4fdd\u5b58 Innodb_rows_read \u7684\u5f53\u524d\u503c */\nselect variable_value into @b from performance_schema.session_status where variable_name = 'Innodb_rows_read'; \n/* \u8ba1\u7b97 Innodb_rows_read \u5dee\u503c */\nselect @b-@a;\n</code></pre> <p>\u8fd9\u4e2a\u65b9\u6cd5\u662f\u901a\u8fc7\u67e5\u770b OPTIMIZER_TRACE \u7684\u7ed3\u679c\u6765\u786e\u8ba4\u7684\uff0c\u4f60\u53ef\u4ee5\u4ece <code>number_of_tmp_files</code> \u4e2d\u770b\u5230\u662f\u5426\u4f7f\u7528\u4e86\u4e34\u65f6\u6587\u4ef6\u3002</p> <pre><code>{\n  \"filesort_summary\": {\n    \"rows\": 4000,\n    \"examined_rows\": 4000,\n    \"number_of_tmp_files\": 12,\n    \"sort_buffer_size\": 32768,\n    \"sort_mode\": \"&lt;sort_key, packed_additional_fields&gt;\"\n  }\n}\n</code></pre> <p><code>number_of_tmp_files</code> \u8868\u793a\u7684\u662f\uff0c\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u7684\u4e34\u65f6\u6587\u4ef6\u6570\u3002\u4f60\u4e00\u5b9a\u5947\u602a\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981 12 \u4e2a\u6587\u4ef6\uff1f\u5185\u5b58\u653e\u4e0d\u4e0b\u65f6\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u5916\u90e8\u6392\u5e8f\uff0c\u5916\u90e8\u6392\u5e8f\u4e00\u822c\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u3002\u53ef\u4ee5\u8fd9\u4e48\u7b80\u5355\u7406\u89e3\uff0cMySQL \u5c06\u9700\u8981\u6392\u5e8f\u7684\u6570\u636e\u5206\u6210 12 \u4efd\uff0c\u6bcf\u4e00\u4efd\u5355\u72ec\u6392\u5e8f\u540e\u5b58\u5728\u8fd9\u4e9b\u4e34\u65f6\u6587\u4ef6\u4e2d\u3002\u7136\u540e\u628a\u8fd9 12 \u4e2a\u6709\u5e8f\u6587\u4ef6\u518d\u5408\u5e76\u6210\u4e00\u4e2a\u6709\u5e8f\u7684\u5927\u6587\u4ef6\u3002</p> <p>\u5982\u679c <code>sort_buffer_size</code> \u8d85\u8fc7\u4e86\u9700\u8981\u6392\u5e8f\u7684\u6570\u636e\u91cf\u7684\u5927\u5c0f\uff0c<code>number_of_tmp_files</code> \u5c31\u662f 0\uff0c\u8868\u793a\u6392\u5e8f\u53ef\u4ee5\u76f4\u63a5\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u3002</p> <p>\u5426\u5219\u5c31\u9700\u8981\u653e\u5728\u4e34\u65f6\u6587\u4ef6\u4e2d\u6392\u5e8f\u3002<code>sort_buffer_size</code> \u8d8a\u5c0f\uff0c\u9700\u8981\u5206\u6210\u7684\u4efd\u6570\u8d8a\u591a\uff0c<code>number_of_tmp_files</code> \u7684\u503c\u5c31\u8d8a\u5927\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u518d\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u56fe 4 \u4e2d\u5176\u4ed6\u4e24\u4e2a\u503c\u7684\u610f\u601d\u3002</p> <p>\u6211\u4eec\u7684\u793a\u4f8b\u8868\u4e2d\u6709 4000 \u6761\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u770b\u5230 <code>examined_rows=4000</code>\uff0c\u8868\u793a\u53c2\u4e0e\u6392\u5e8f\u7684\u884c\u6570\u662f 4000 \u884c\u3002</p> <p><code>sort_mode</code> \u91cc\u9762\u7684 <code>packed_additional_fields</code> \u7684\u610f\u601d\u662f\uff0c\u6392\u5e8f\u8fc7\u7a0b\u5bf9\u5b57\u7b26\u4e32\u505a\u4e86\u201c\u7d27\u51d1\u201d\u5904\u7406\u3002\u5373\u4f7f name \u5b57\u6bb5\u7684\u5b9a\u4e49\u662f <code>varchar(16)</code>\uff0c\u5728\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u8fd8\u662f\u8981\u6309\u7167\u5b9e\u9645\u957f\u5ea6\u6765\u5206\u914d\u7a7a\u95f4\u7684\u3002</p> <p>\u540c\u65f6\uff0c\u6700\u540e\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5 <code>select @b-@a</code> \u7684\u8fd4\u56de\u7ed3\u679c\u662f 4000\uff0c\u8868\u793a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u53ea\u626b\u63cf\u4e86 4000 \u884c\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e3a\u4e86\u907f\u514d\u5bf9\u7ed3\u8bba\u9020\u6210\u5e72\u6270\uff0c\u6211\u628a <code>internal_tmp_disk_storage_engine</code> \u8bbe\u7f6e\u6210 MyISAM\u3002\u5426\u5219\uff0c<code>select @b-@a</code> \u7684\u7ed3\u679c\u4f1a\u663e\u793a\u4e3a 4001\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u67e5\u8be2 <code>OPTIMIZER_TRACE</code> \u8fd9\u4e2a\u8868\u65f6\uff0c\u9700\u8981\u7528\u5230\u4e34\u65f6\u8868\uff0c\u800c <code>internal_tmp_disk_storage_engine</code> \u7684\u9ed8\u8ba4\u503c\u662f InnoDB\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f InnoDB \u5f15\u64ce\u7684\u8bdd\uff0c\u628a\u6570\u636e\u4ece\u4e34\u65f6\u8868\u53d6\u51fa\u6765\u7684\u65f6\u5019\uff0c\u4f1a\u8ba9 <code>Innodb_rows_read</code> \u7684\u503c\u52a0 1\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#rowid","title":"rowid \u6392\u5e8f","text":"<p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u7b97\u6cd5\u8fc7\u7a0b\u91cc\u9762\uff0c\u53ea\u5bf9\u539f\u8868\u7684\u6570\u636e\u8bfb\u4e86\u4e00\u904d\uff0c\u5269\u4e0b\u7684\u64cd\u4f5c\u90fd\u662f\u5728 <code>sort_buffer</code> \u548c\u4e34\u65f6\u6587\u4ef6\u4e2d\u6267\u884c\u7684\u3002\u4f46\u8fd9\u4e2a\u7b97\u6cd5\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u5982\u679c\u67e5\u8be2\u8981\u8fd4\u56de\u7684\u5b57\u6bb5\u5f88\u591a\u7684\u8bdd\uff0c\u90a3\u4e48 <code>sort_buffer</code> \u91cc\u9762\u8981\u653e\u7684\u5b57\u6bb5\u6570\u592a\u591a\uff0c\u8fd9\u6837\u5185\u5b58\u91cc\u80fd\u591f\u540c\u65f6\u653e\u4e0b\u7684\u884c\u6570\u5f88\u5c11\uff0c\u8981\u5206\u6210\u5f88\u591a\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u6392\u5e8f\u7684\u6027\u80fd\u4f1a\u5f88\u5dee\u3002</p> <p>\u6240\u4ee5\u5982\u679c\u5355\u884c\u5f88\u5927\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6548\u7387\u4e0d\u591f\u597d\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c MySQL \u8ba4\u4e3a\u6392\u5e8f\u7684\u5355\u884c\u957f\u5ea6\u592a\u5927\u4f1a\u600e\u4e48\u505a\u5462\uff1f</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u6765\u4fee\u6539\u4e00\u4e2a\u53c2\u6570\uff0c\u8ba9 MySQL \u91c7\u7528\u53e6\u5916\u4e00\u79cd\u7b97\u6cd5\u3002</p> <pre><code>SET max_length_for_sort_data = 16;\n</code></pre> <p><code>max_length_for_sort_data</code>\uff0c\u662f MySQL \u4e2d\u4e13\u95e8\u63a7\u5236\u7528\u4e8e\u6392\u5e8f\u7684\u884c\u6570\u636e\u7684\u957f\u5ea6\u7684\u4e00\u4e2a\u53c2\u6570\u3002\u5b83\u7684\u610f\u601d\u662f\uff0c\u5982\u679c\u5355\u884c\u7684\u957f\u5ea6\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0cMySQL \u5c31\u8ba4\u4e3a\u5355\u884c\u592a\u5927\uff0c\u8981\u6362\u4e00\u4e2a\u7b97\u6cd5\u3002</p> <p><code>city\u3001name\u3001age</code> \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u5b9a\u4e49\u603b\u957f\u5ea6\u662f 36\uff0c\u6211\u628a <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u4e3a 16\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u8ba1\u7b97\u8fc7\u7a0b\u6709\u4ec0\u4e48\u6539\u53d8\u3002</p> <p>\u65b0\u7684\u7b97\u6cd5\u653e\u5165 <code>sort_buffer</code> \u7684\u5b57\u6bb5\uff0c\u53ea\u6709\u8981\u6392\u5e8f\u7684\u5217\uff08\u5373 name \u5b57\u6bb5\uff09\u548c\u4e3b\u952e id\u3002</p> <p>\u4f46\u8fd9\u65f6\uff0c\u6392\u5e8f\u7684\u7ed3\u679c\u5c31\u56e0\u4e3a\u5c11\u4e86 city \u548c age \u5b57\u6bb5\u7684\u503c\uff0c\u4e0d\u80fd\u76f4\u63a5\u8fd4\u56de\u4e86\uff0c\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u5982\u4e0b\u6240\u793a\u7684\u6837\u5b50\uff1a</p> <ol> <li>\u521d\u59cb\u5316 <code>sort_buffer</code>\uff0c\u786e\u5b9a\u653e\u5165\u4e24\u4e2a\u5b57\u6bb5\uff0c\u5373 name \u548c id\uff1b</li> <li>\u4ece\u7d22\u5f15 city \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u4e3b\u952e id\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_X</code>\uff1b</li> <li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 name\u3001id \u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u5b58\u5165 <code>sort_buffer</code> \u4e2d\uff1b</li> <li>\u4ece\u7d22\u5f15 city \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u7684\u4e3b\u952e id\uff1b</li> <li>\u91cd\u590d\u6b65\u9aa4 3\u30014 \u76f4\u5230\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u4e3a\u6b62\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684 <code>ID_Y</code>\uff1b</li> <li>\u5bf9 <code>sort_buffer</code> \u4e2d\u7684\u6570\u636e\u6309\u7167\u5b57\u6bb5 name \u8fdb\u884c\u6392\u5e8f\uff1b</li> <li>\u904d\u5386\u6392\u5e8f\u7ed3\u679c\uff0c\u53d6\u524d 1000 \u884c\uff0c\u5e76\u6309\u7167 id \u7684\u503c\u56de\u5230\u539f\u8868\u4e2d\u53d6\u51fa city\u3001name \u548c age \u4e09\u4e2a\u5b57\u6bb5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ol> <p>\u8fd9\u4e2a\u6267\u884c\u6d41\u7a0b\u7684\u793a\u610f\u56fe\u5982\u4e0b\uff0c\u6211\u628a\u5b83\u79f0\u4e3a rowid \u6392\u5e8f\u3002</p> <p></p> <p>\u56fe 5 rowid \u6392\u5e8f</p> <p>\u5bf9\u6bd4\u56fe 3 \u7684\u5168\u5b57\u6bb5\u6392\u5e8f\u6d41\u7a0b\u56fe\u4f60\u4f1a\u53d1\u73b0\uff0crowid \u6392\u5e8f\u591a\u8bbf\u95ee\u4e86\u4e00\u6b21\u8868 t \u7684\u4e3b\u952e\u7d22\u5f15\uff0c\u5c31\u662f\u6b65\u9aa4 7\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6700\u540e\u7684\u201c\u7ed3\u679c\u96c6\u201d\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u5b9e\u9645\u4e0a MySQL \u670d\u52a1\u7aef\u4ece\u6392\u5e8f\u540e\u7684 <code>sort_buffer</code> \u4e2d\u4f9d\u6b21\u53d6\u51fa id\uff0c\u7136\u540e\u5230\u539f\u8868\u67e5\u5230 city\u3001name \u548c age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u5728\u670d\u52a1\u7aef\u518d\u8017\u8d39\u5185\u5b58\u5b58\u50a8\u7ed3\u679c\uff0c\u662f\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u3002</p> <p>\u6839\u636e\u8fd9\u4e2a\u8bf4\u660e\u8fc7\u7a0b\u548c\u56fe\u793a\uff0c\u4f60\u53ef\u4ee5\u60f3\u4e00\u4e0b\uff0c\u8fd9\u4e2a\u65f6\u5019\u6267\u884c <code>select @b-@a</code>\uff0c\u7ed3\u679c\u4f1a\u662f\u591a\u5c11\u5462\uff1f</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u770b\u770b\u7ed3\u679c\u6709\u4ec0\u4e48\u4e0d\u540c\u3002</p> <p>\u9996\u5148\uff0c\u56fe\u4e2d\u7684 <code>examined_rows</code> \u7684\u503c\u8fd8\u662f 4000\uff0c\u8868\u793a\u7528\u4e8e\u6392\u5e8f\u7684\u6570\u636e\u662f 4000 \u884c\u3002\u4f46\u662f <code>select @b-@a</code> \u8fd9\u4e2a\u8bed\u53e5\u7684\u503c\u53d8\u6210 5000 \u4e86\u3002</p> <p>\u56e0\u4e3a\u8fd9\u65f6\u5019\u9664\u4e86\u6392\u5e8f\u8fc7\u7a0b\u5916\uff0c\u5728\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u8fd8\u8981\u6839\u636e id \u53bb\u539f\u8868\u53d6\u503c\u3002\u7531\u4e8e\u8bed\u53e5\u662f <code>limit 1000</code>\uff0c\u56e0\u6b64\u4f1a\u591a\u8bfb 1000 \u884c\u3002</p> <pre><code>{\n  \"filesort_summary\": {\n    \"rows\": 4000,\n    \"examined_rows\": 4000,\n    \"number_of_tmp_files\": 10,\n    \"sort_buffer_size\": 32768,\n    \"sort_mode\": \"&lt;sort_key, rowid&gt;\"\n  }\n}\n</code></pre> <p>\u4ece <code>OPTIMIZER_TRACE</code> \u7684\u7ed3\u679c\u4e2d\uff0c\u4f60\u8fd8\u80fd\u770b\u5230\u53e6\u5916\u4e24\u4e2a\u4fe1\u606f\u4e5f\u53d8\u4e86\u3002</p> <ul> <li><code>sort_mode</code> \u53d8\u6210\u4e86 <code>&lt;sort_key, rowid&gt;</code>\uff0c\u8868\u793a\u53c2\u4e0e\u6392\u5e8f\u7684\u53ea\u6709 name \u548c id \u8fd9\u4e24\u4e2a\u5b57\u6bb5\u3002</li> <li><code>number_of_tmp_files</code> \u53d8\u6210 10 \u4e86\uff0c\u662f\u56e0\u4e3a\u8fd9\u65f6\u5019\u53c2\u4e0e\u6392\u5e8f\u7684\u884c\u6570\u867d\u7136\u4ecd\u7136\u662f 4000 \u884c\uff0c\u4f46\u662f\u6bcf\u4e00\u884c\u90fd\u53d8\u5c0f\u4e86\uff0c\u56e0\u6b64\u9700\u8981\u6392\u5e8f\u7684\u603b\u6570\u636e\u91cf\u5c31\u53d8\u5c0f\u4e86\uff0c\u9700\u8981\u7684\u4e34\u65f6\u6587\u4ef6\u4e5f\u76f8\u5e94\u5730\u53d8\u5c11\u4e86\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#vs-rowid","title":"\u5168\u5b57\u6bb5\u6392\u5e8f VS rowid \u6392\u5e8f","text":"<p>\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\uff0c\u4ece\u8fd9\u4e24\u4e2a\u6267\u884c\u6d41\u7a0b\u91cc\uff0c\u8fd8\u80fd\u5f97\u51fa\u4ec0\u4e48\u7ed3\u8bba\u3002</p> <p>\u5982\u679c MySQL \u5b9e\u5728\u662f\u62c5\u5fc3\u6392\u5e8f\u5185\u5b58\u592a\u5c0f\uff0c\u4f1a\u5f71\u54cd\u6392\u5e8f\u6548\u7387\uff0c\u624d\u4f1a\u91c7\u7528 rowid \u6392\u5e8f\u7b97\u6cd5\uff0c\u8fd9\u6837\u6392\u5e8f\u8fc7\u7a0b\u4e2d\u4e00\u6b21\u53ef\u4ee5\u6392\u5e8f\u66f4\u591a\u884c\uff0c\u4f46\u662f\u9700\u8981\u518d\u56de\u5230\u539f\u8868\u53bb\u53d6\u6570\u636e\u3002</p> <p>\u5982\u679c MySQL \u8ba4\u4e3a\u5185\u5b58\u8db3\u591f\u5927\uff0c\u4f1a\u4f18\u5148\u9009\u62e9\u5168\u5b57\u6bb5\u6392\u5e8f\uff0c\u628a\u9700\u8981\u7684\u5b57\u6bb5\u90fd\u653e\u5230 sort_buffer \u4e2d\uff0c\u8fd9\u6837\u6392\u5e8f\u540e\u5c31\u4f1a\u76f4\u63a5\u4ece\u5185\u5b58\u91cc\u9762\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c\u4e86\uff0c\u4e0d\u7528\u518d\u56de\u5230\u539f\u8868\u53bb\u53d6\u6570\u636e\u3002</p> <p>\u8fd9\u4e5f\u5c31\u4f53\u73b0\u4e86 MySQL \u7684\u4e00\u4e2a\u8bbe\u8ba1\u601d\u60f3\uff1a\u5982\u679c\u5185\u5b58\u591f\uff0c\u5c31\u8981\u591a\u5229\u7528\u5185\u5b58\uff0c\u5c3d\u91cf\u51cf\u5c11\u78c1\u76d8\u8bbf\u95ee\u3002</p> <p>\u5bf9\u4e8e InnoDB \u8868\u6765\u8bf4\uff0crowid \u6392\u5e8f\u4f1a\u8981\u6c42\u56de\u8868\u591a\u9020\u6210\u78c1\u76d8\u8bfb\uff0c\u56e0\u6b64\u4e0d\u4f1a\u88ab\u4f18\u5148\u9009\u62e9\u3002</p> <p>\u8fd9\u4e2a\u7ed3\u8bba\u770b\u4e0a\u53bb\u6709\u70b9\u5e9f\u8bdd\u7684\u611f\u89c9\uff0c\u4f46\u662f\u4f60\u8981\u8bb0\u4f4f\u5b83\uff0c\u4e0b\u4e00\u7bc7\u6587\u7ae0\u6211\u4eec\u5c31\u4f1a\u7528\u5230\u3002</p> <p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u5c31\u4e86\u89e3\u4e86\uff0cMySQL \u505a\u6392\u5e8f\u662f\u4e00\u4e2a\u6210\u672c\u6bd4\u8f83\u9ad8\u7684\u64cd\u4f5c\u3002\u90a3\u4e48\u4f60\u4f1a\u95ee\uff0c\u662f\u4e0d\u662f\u6240\u6709\u7684 <code>order by</code> \u90fd\u9700\u8981\u6392\u5e8f\u64cd\u4f5c\u5462\uff1f\u5982\u679c\u4e0d\u6392\u5e8f\u5c31\u80fd\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u90a3\u5bf9\u7cfb\u7edf\u7684\u6d88\u8017\u4f1a\u5c0f\u5f88\u591a\uff0c\u8bed\u53e5\u7684\u6267\u884c\u65f6\u95f4\u4e5f\u4f1a\u53d8\u5f97\u66f4\u77ed\u3002</p> <p>\u5176\u5b9e\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684 <code>order by</code> \u8bed\u53e5\uff0c\u90fd\u9700\u8981\u6392\u5e8f\u64cd\u4f5c\u7684\u3002\u4ece\u4e0a\u9762\u5206\u6790\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u4e4b\u6240\u4ee5\u9700\u8981\u751f\u6210\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u5728\u4e34\u65f6\u8868\u4e0a\u505a\u6392\u5e8f\u64cd\u4f5c\uff0c\u5176\u539f\u56e0\u662f\u539f\u6765\u7684\u6570\u636e\u90fd\u662f\u65e0\u5e8f\u7684\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e0b\uff0c\u5982\u679c\u80fd\u591f\u4fdd\u8bc1\u4ece city \u8fd9\u4e2a\u7d22\u5f15\u4e0a\u53d6\u51fa\u6765\u7684\u884c\uff0c\u5929\u7136\u5c31\u662f\u6309\u7167 name \u9012\u589e\u6392\u5e8f\u7684\u8bdd\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u4e0d\u7528\u518d\u6392\u5e8f\u4e86\u5462\uff1f</p> <p>\u786e\u5b9e\u662f\u8fd9\u6837\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fd9\u4e2a\u5e02\u6c11\u8868\u4e0a\u521b\u5efa\u4e00\u4e2a city \u548c name \u7684\u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u662f\uff1a</p> <pre><code>alter table t add index city_user(city, name);\n</code></pre> <p>\u4f5c\u4e3a\u4e0e city \u7d22\u5f15\u7684\u5bf9\u6bd4\uff0c\u6211\u4eec\u6765\u770b\u770b\u8fd9\u4e2a\u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002</p> <p></p> <p>\u56fe 7 city \u548c name \u8054\u5408\u7d22\u5f15\u793a\u610f\u56fe</p> <p>\u5728\u8fd9\u4e2a\u7d22\u5f15\u91cc\u9762\uff0c\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u7528\u6811\u641c\u7d22\u7684\u65b9\u5f0f\u5b9a\u4f4d\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u7684\u8bb0\u5f55\uff0c\u5e76\u4e14\u989d\u5916\u786e\u4fdd\u4e86\uff0c\u63a5\u4e0b\u6765\u6309\u987a\u5e8f\u53d6\u201c\u4e0b\u4e00\u6761\u8bb0\u5f55\u201d\u7684\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u8981 city \u7684\u503c\u662f\u676d\u5dde\uff0cname \u7684\u503c\u5c31\u4e00\u5b9a\u662f\u6709\u5e8f\u7684\u3002</p> <p>\u8fd9\u6837\u6574\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u7684\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p> <ol> <li>\u4ece\u7d22\u5f15 <code>(city,name)</code> \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u4e3b\u952e id\uff1b</li> <li>\u5230\u4e3b\u952e id \u7d22\u5f15\u53d6\u51fa\u6574\u884c\uff0c\u53d6 <code>name\u3001city\u3001age</code> \u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li> <li>\u4ece\u7d22\u5f15 <code>(city,name)</code> \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u4e3b\u952e id\uff1b</li> <li>\u91cd\u590d\u6b65\u9aa4 2\u30013\uff0c\u76f4\u5230\u67e5\u5230\u7b2c 1000 \u6761\u8bb0\u5f55\uff0c\u6216\u8005\u662f\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u65f6\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p></p> <p>\u56fe 8 \u5f15\u5165 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\u540e\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8ba1\u5212</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u4e0d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u6392\u5e8f\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7528 explain \u7684\u7ed3\u679c\u6765\u5370\u8bc1\u4e00\u4e0b\u3002</p> <pre><code>mysql&gt; explain select city,name,age from t where city='\u676d\u5dde' order by name limit 1000  ;\n+----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+\n| id | select_type | table | partitions | type | possible_keys  | key       | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | t     | NULL       | ref  | city,city_user | city_user | 66      | const | 1000 |   100.00 | NULL  |\n+----+-------------+-------+------------+------+----------------+-----------+---------+-------+------+----------+-------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0cExtra \u5b57\u6bb5\u4e2d\u6ca1\u6709 <code>Using filesort</code> \u4e86\uff0c\u4e5f\u5c31\u662f\u4e0d\u9700\u8981\u6392\u5e8f\u4e86\u3002\u800c\u4e14\u7531\u4e8e <code>(city,name)</code> \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u672c\u8eab\u6709\u5e8f\uff0c\u6240\u4ee5\u8fd9\u4e2a\u67e5\u8be2\u4e5f\u4e0d\u7528\u628a 4000 \u884c\u5168\u90fd\u8bfb\u4e00\u904d\uff0c\u53ea\u8981\u627e\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u524d 1000 \u6761\u8bb0\u5f55\u5c31\u53ef\u4ee5\u9000\u51fa\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u53ea\u9700\u8981\u626b\u63cf 1000 \u6b21\u3002</p> <p>\u65e2\u7136\u8bf4\u5230\u8fd9\u91cc\u4e86\uff0c\u6211\u4eec\u518d\u5f80\u524d\u8ba8\u8bba\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u6709\u6ca1\u6709\u53ef\u80fd\u8fdb\u4e00\u6b65\u7b80\u5316\u5462\uff1f\u4e0d\u77e5\u9053\u4f60\u8fd8\u8bb0\u4e0d\u8bb0\u5f97\uff0c\u6211\u5728\u7b2c 5 \u7bc7\u6587\u7ae0[\u300a \u6df1\u5165\u6d45\u51fa\u7d22\u5f15\uff08\u4e0b\uff09\u300b]\u4e2d\uff0c\u548c\u4f60\u4ecb\u7ecd\u7684\u8986\u76d6\u7d22\u5f15\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u518d\u7a0d\u5fae\u590d\u4e60\u4e00\u4e0b\u3002\u8986\u76d6\u7d22\u5f15\u662f\u6307\uff0c\u7d22\u5f15\u4e0a\u7684\u4fe1\u606f\u8db3\u591f\u6ee1\u8db3\u67e5\u8be2\u8bf7\u6c42\uff0c\u4e0d\u9700\u8981\u518d\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u53d6\u6570\u636e\u3002</p> <p>\u6309\u7167\u8986\u76d6\u7d22\u5f15\u7684\u6982\u5ff5\uff0c\u6211\u4eec\u53ef\u4ee5\u518d\u4f18\u5316\u4e00\u4e0b\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002</p> <p>\u9488\u5bf9\u8fd9\u4e2a\u67e5\u8be2\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a city\u3001name \u548c age \u7684\u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u5c31\u662f\uff1a</p> <pre><code>alter table t add index city_user_age(city, name, age);\n</code></pre> <p>\u8fd9\u65f6\uff0c\u5bf9\u4e8e city \u5b57\u6bb5\u7684\u503c\u76f8\u540c\u7684\u884c\u6765\u8bf4\uff0c\u8fd8\u662f\u6309\u7167 name \u5b57\u6bb5\u7684\u503c\u9012\u589e\u6392\u5e8f\u7684\uff0c\u6b64\u65f6\u7684\u67e5\u8be2\u8bed\u53e5\u4e5f\u5c31\u4e0d\u518d\u9700\u8981\u6392\u5e8f\u4e86\u3002\u8fd9\u6837\u6574\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p> <ol> <li>\u4ece\u7d22\u5f15 <code>(city,name,age)</code> \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u53d6\u51fa\u5176\u4e2d\u7684 city\u3001name \u548c age \u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li> <li>\u4ece\u7d22\u5f15 <code>(city,name,age)</code> \u53d6\u4e0b\u4e00\u4e2a\u8bb0\u5f55\uff0c\u540c\u6837\u53d6\u51fa\u8fd9\u4e09\u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u76f4\u63a5\u8fd4\u56de\uff1b</li> <li>\u91cd\u590d\u6267\u884c\u6b65\u9aa4 2\uff0c\u76f4\u5230\u67e5\u5230\u7b2c 1000 \u6761\u8bb0\u5f55\uff0c\u6216\u8005\u662f\u4e0d\u6ee1\u8db3 <code>city='\u676d\u5dde'</code> \u6761\u4ef6\u65f6\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p></p> <p>\u56fe 10 \u5f15\u5165 (city,name,age) \u8054\u5408\u7d22\u5f15\u540e\uff0c\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b explain \u7684\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain select city,name,age from t where city='\u676d\u5dde' order by name limit 1000  ;\n+----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+\n| id | select_type | table | partitions | type | possible_keys      | key           | key_len | ref   | rows | filtered | Extra       |\n+----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+\n|  1 | SIMPLE      | t     | NULL       | ref  | city,city_user_age | city_user_age | 66      | const |    1 |   100.00 | Using index |\n+----+-------------+-------+------------+------+--------------------+---------------+---------+-------+------+----------+-------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cExtra \u5b57\u6bb5\u91cc\u9762\u591a\u4e86 <code>Using index</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u6027\u80fd\u4e0a\u4f1a\u5feb\u5f88\u591a\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u91cc\u5e76\u4e0d\u662f\u8bf4\u8981\u4e3a\u4e86\u6bcf\u4e2a\u67e5\u8be2\u80fd\u7528\u4e0a\u8986\u76d6\u7d22\u5f15\uff0c\u5c31\u8981\u628a\u8bed\u53e5\u4e2d\u6d89\u53ca\u7684\u5b57\u6bb5\u90fd\u5efa\u4e0a\u8054\u5408\u7d22\u5f15\uff0c\u6bd5\u7adf\u7d22\u5f15\u8fd8\u662f\u6709\u7ef4\u62a4\u4ee3\u4ef7\u7684\u3002\u8fd9\u662f\u4e00\u4e2a\u9700\u8981\u6743\u8861\u7684\u51b3\u5b9a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_16","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u91cc\u9762 <code>order by</code> \u8bed\u53e5\u7684\u51e0\u79cd\u7b97\u6cd5\u6d41\u7a0b\u3002</p> <p>\u5728\u5f00\u53d1\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u4f60\u603b\u662f\u4e0d\u53ef\u907f\u514d\u5730\u4f1a\u4f7f\u7528\u5230 <code>order by</code> \u8bed\u53e5\u3002\u4f60\u5fc3\u91cc\u8981\u6e05\u695a\u6bcf\u4e2a\u8bed\u53e5\u7684\u6392\u5e8f\u903b\u8f91\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff0c\u8fd8\u8981\u80fd\u591f\u5206\u6790\u51fa\u5728\u6700\u574f\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u5bf9\u7cfb\u7edf\u8d44\u6e90\u7684\u6d88\u8017\uff0c\u8fd9\u6837\u624d\u80fd\u505a\u5230\u4e0b\u7b14\u5982\u6709\u795e\uff0c\u4e0d\u72af\u4f4e\u7ea7\u9519\u8bef\u3002</p> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p> <p>\u5047\u8bbe\u4f60\u7684\u8868\u91cc\u9762\u5df2\u7ecf\u6709\u4e86 <code>city_name(city, name)</code> \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\uff0c\u7136\u540e\u4f60\u8981\u67e5\u676d\u5dde\u548c\u82cf\u5dde\u4e24\u4e2a\u57ce\u5e02\u4e2d\u6240\u6709\u7684\u5e02\u6c11\u7684\u59d3\u540d\uff0c\u5e76\u4e14\u6309\u540d\u5b57\u6392\u5e8f\uff0c\u663e\u793a\u524d 100 \u6761\u8bb0\u5f55\u3002\u5982\u679c SQL \u67e5\u8be2\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684 \uff1a</p> <pre><code>mysql&gt; select * from t where city in ('\u676d\u5dde',\"\u82cf\u5dde\") order by name limit 100;\n</code></pre> <p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u7684\u65f6\u5019\u4f1a\u6709\u6392\u5e8f\u8fc7\u7a0b\u5417\uff0c\u4e3a\u4ec0\u4e48\uff1f</p> <p>\u5982\u679c\u4e1a\u52a1\u7aef\u4ee3\u7801\u7531\u4f60\u6765\u5f00\u53d1\uff0c\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u5728\u6570\u636e\u5e93\u7aef\u4e0d\u9700\u8981\u6392\u5e8f\u7684\u65b9\u6848\uff0c\u4f60\u4f1a\u600e\u4e48\u5b9e\u73b0\u5462\uff1f</p> <p>\u8fdb\u4e00\u6b65\u5730\uff0c\u5982\u679c\u6709\u5206\u9875\u9700\u6c42\uff0c\u8981\u663e\u793a\u7b2c 101 \u9875\uff0c\u4e5f\u5c31\u662f\u8bf4\u8bed\u53e5\u6700\u540e\u8981\u6539\u6210  <code>limit 10000,100</code>\uff0c \u4f60\u7684\u5b9e\u73b0\u65b9\u6cd5\u53c8\u4f1a\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u56de\u7b54\uff1a</p> <p>\u867d\u7136\u6709 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\uff0c\u5bf9\u4e8e\u5355\u4e2a city \u5185\u90e8\uff0cname \u662f\u9012\u589e\u7684\u3002\u4f46\u662f\u7531\u4e8e\u8fd9\u6761 SQL \u8bed\u53e5\u4e0d\u662f\u8981\u5355\u72ec\u5730\u67e5\u4e00\u4e2a city \u7684\u503c\uff0c\u800c\u662f\u540c\u65f6\u67e5\u4e86\"\u676d\u5dde\"\u548c\" \u82cf\u5dde \"\u4e24\u4e2a\u57ce\u5e02\uff0c\u56e0\u6b64\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684 name \u5c31\u4e0d\u662f\u9012\u589e\u7684\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u9700\u8981\u6392\u5e8f\u3002</p> <p>\u90a3\u600e\u4e48\u907f\u514d\u6392\u5e8f\u5462\uff1f</p> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u8981\u7528\u5230 <code>(city,name)</code> \u8054\u5408\u7d22\u5f15\u7684\u7279\u6027\uff0c\u628a\u8fd9\u4e00\u6761\u8bed\u53e5\u62c6\u6210\u4e24\u6761\u8bed\u53e5\uff0c\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u6267\u884c <code>select * from t where city=\u201c\u676d\u5dde\u201d order by name limit 100;</code> \u8fd9\u4e2a\u8bed\u53e5\u662f\u4e0d\u9700\u8981\u6392\u5e8f\u7684\uff0c\u5ba2\u6237\u7aef\u7528\u4e00\u4e2a\u957f\u5ea6\u4e3a 100 \u7684\u5185\u5b58\u6570\u7ec4 A \u4fdd\u5b58\u7ed3\u679c\u3002</li> <li>\u6267\u884c <code>select * from t where city=\u201c\u82cf\u5dde\u201d order by name limit 100;</code> \u7528\u76f8\u540c\u7684\u65b9\u6cd5\uff0c\u5047\u8bbe\u7ed3\u679c\u88ab\u5b58\u8fdb\u4e86\u5185\u5b58\u6570\u7ec4 B\u3002</li> <li>\u73b0\u5728 A \u548c B \u662f\u4e24\u4e2a\u6709\u5e8f\u6570\u7ec4\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u7528\u5f52\u5e76\u6392\u5e8f\u7684\u601d\u60f3\uff0c\u5f97\u5230 name \u6700\u5c0f\u7684\u524d 100 \u503c\uff0c\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684\u7ed3\u679c\u4e86\u3002</li> </ol> <p>\u5982\u679c\u628a\u8fd9\u6761 SQL \u8bed\u53e5\u91cc <code>limit 100</code> \u6539\u6210 <code>limit 10000,100</code> \u7684\u8bdd\uff0c\u5904\u7406\u65b9\u5f0f\u5176\u5b9e\u4e5f\u5dee\u4e0d\u591a\uff0c\u5373\uff1a\u8981\u628a\u4e0a\u9762\u7684\u4e24\u6761\u8bed\u53e5\u6539\u6210\u5199\uff1a</p> <pre><code>select * from t where city='\u676d\u5dde' order by name limit 10100; \n</code></pre> <p>\u548c</p> <pre><code> select * from t where city='\u82cf\u5dde' order by name limit 10100\u3002\n</code></pre> <p>\u8fd9\u65f6\u5019\u6570\u636e\u91cf\u8f83\u5927\uff0c\u53ef\u4ee5\u540c\u65f6\u8d77\u4e24\u4e2a\u8fde\u63a5\u4e00\u884c\u884c\u8bfb\u7ed3\u679c\uff0c\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u62ff\u5230\u8fd9\u4e24\u4e2a\u7ed3\u679c\u96c6\u91cc\uff0c\u6309\u987a\u5e8f\u53d6\u7b2c <code>10001~10100</code> \u7684 name \u503c\uff0c\u5c31\u662f\u9700\u8981\u7684\u7ed3\u679c\u4e86\u3002</p> <p>\u5f53\u7136\u8fd9\u4e2a\u65b9\u6848\u6709\u4e00\u4e2a\u660e\u663e\u7684\u635f\u5931\uff0c\u5c31\u662f\u4ece\u6570\u636e\u5e93\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u6570\u636e\u91cf\u53d8\u5927\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u6570\u636e\u7684\u5355\u884c\u6bd4\u8f83\u5927\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u628a\u8fd9\u4e24\u6761 SQL \u8bed\u53e5\u6539\u6210\u4e0b\u9762\u8fd9\u79cd\u5199\u6cd5\uff1a</p> <pre><code>select id,name from t where city='\u676d\u5dde' order by name limit 10100; \n</code></pre> <p>\u548c</p> <pre><code>select id,name from t where city='\u82cf\u5dde' order by name limit 10100\u3002\n</code></pre> <p>\u7136\u540e\uff0c\u518d\u7528\u5f52\u5e76\u6392\u5e8f\u7684\u65b9\u6cd5\u53d6\u5f97\u6309 name \u987a\u5e8f\u7b2c <code>10001~10100</code> \u7684 name\u3001id \u7684\u503c\uff0c\u7136\u540e\u62ff\u7740\u8fd9 100 \u4e2a id \u5230\u6570\u636e\u5e93\u4e2d\u53bb\u67e5\u51fa\u6240\u6709\u8bb0\u5f55\u3002</p> <p>\u4e0a\u9762\u8fd9\u4e9b\u65b9\u6cd5\uff0c\u9700\u8981\u4f60\u6839\u636e\u6027\u80fd\u9700\u6c42\u548c\u5f00\u53d1\u7684\u590d\u6742\u5ea6\u505a\u51fa\u6743\u8861\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#17","title":"17 \u5982\u4f55\u6b63\u786e\u5730\u663e\u793a\u968f\u673a\u6d88\u606f\uff1f","text":"<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\uff0c\u4e3a\u4f60\u8bb2\u89e3\u5b8c order by \u8bed\u53e5\u7684\u51e0\u79cd\u6267\u884c\u6a21\u5f0f\u540e\uff0c\u5c31\u60f3\u5230\u4e86\u4e4b\u524d\u4e00\u4e2a\u505a\u82f1\u8bed\u5b66\u4e60 App \u7684\u670b\u53cb\u78b0\u5230\u8fc7\u7684\u4e00\u4e2a\u6027\u80fd\u95ee\u9898\u3002</p> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u4ece\u8fd9\u4e2a\u6027\u80fd\u95ee\u9898\u8bf4\u8d77\uff0c\u548c\u4f60\u8bf4\u8bf4 MySQL \u4e2d\u7684\u53e6\u5916\u4e00\u79cd\u6392\u5e8f\u9700\u6c42\uff0c\u5e0c\u671b\u80fd\u591f\u52a0\u6df1\u4f60\u5bf9 MySQL \u6392\u5e8f\u903b\u8f91\u7684\u7406\u89e3\u3002</p> <p>\u67d0\u82f1\u8bed\u5b66\u4e60 App \u9996\u9875\u6709\u4e00\u4e2a\u968f\u673a\u663e\u793a\u5355\u8bcd\u7684\u529f\u80fd\uff0c\u4e5f\u5c31\u662f\u6839\u636e\u6bcf\u4e2a\u7528\u6237\u7684\u7ea7\u522b\u6709\u4e00\u4e2a\u5355\u8bcd\u8868\uff0c\u7136\u540e\u8fd9\u4e2a\u7528\u6237\u6bcf\u6b21\u8bbf\u95ee\u9996\u9875\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u968f\u673a\u6eda\u52a8\u663e\u793a\u4e09\u4e2a\u5355\u8bcd\u3002\u4ed6\u4eec\u53d1\u73b0\u968f\u7740\u5355\u8bcd\u8868\u53d8\u5927\uff0c\u9009\u5355\u8bcd\u8fd9\u4e2a\u903b\u8f91\u53d8\u5f97\u8d8a\u6765\u8d8a\u6162\uff0c\u751a\u81f3\u5f71\u54cd\u5230\u4e86\u9996\u9875\u7684\u6253\u5f00\u901f\u5ea6\u3002</p> <p>\u73b0\u5728\uff0c\u5982\u679c\u8ba9\u4f60\u6765\u8bbe\u8ba1\u8fd9\u4e2a SQL \u8bed\u53e5\uff0c\u4f60\u4f1a\u600e\u4e48\u5199\u5462\uff1f</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u6211\u5bf9\u8fd9\u4e2a\u4f8b\u5b50\u8fdb\u884c\u4e86\u7b80\u5316\uff1a\u53bb\u6389\u6bcf\u4e2a\u7ea7\u522b\u7684\u7528\u6237\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684\u5355\u8bcd\u8868\u8fd9\u4e2a\u903b\u8f91\uff0c\u76f4\u63a5\u5c31\u662f\u4ece\u4e00\u4e2a\u5355\u8bcd\u8868\u4e2d\u968f\u673a\u9009\u51fa\u4e09\u4e2a\u5355\u8bcd\u3002\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u548c\u521d\u59cb\u6570\u636e\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>mysql&gt; CREATE TABLE `words` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `word` varchar(64) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=0;\n  while i&lt;10000 do\n    insert into words(word) values(concat(char(97+(i div 1000)), char(97+(i % 1000 div 100)), char(97+(i % 100 div 10)), char(97+(i % 10))));\n    set i=i+1;\n  end while;\nend;;\ndelimiter ; \ncall idata();\n</code></pre> <p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u8bf4\u660e\uff0c\u6211\u5728\u8fd9\u4e2a\u8868\u91cc\u9762\u63d2\u5165\u4e86 10000 \u884c\u8bb0\u5f55\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u770b\u770b\u8981\u968f\u673a\u9009\u62e9 3 \u4e2a\u5355\u8bcd\uff0c\u6709\u4ec0\u4e48\u65b9\u6cd5\u5b9e\u73b0\uff0c\u5b58\u5728\u4ec0\u4e48\u95ee\u9898\u4ee5\u53ca\u5982\u4f55\u6539\u8fdb\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_17","title":"\u5185\u5b58\u4e34\u65f6\u8868","text":"<p>\u9996\u5148\uff0c\u4f60\u4f1a\u60f3\u5230\u7528 order by rand() \u6765\u5b9e\u73b0\u8fd9\u4e2a\u903b\u8f91\u3002</p> <pre><code>mysql&gt; select word from words order by rand() limit 3;\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u610f\u601d\u5f88\u76f4\u767d\uff0c\u968f\u673a\u6392\u5e8f\u53d6\u524d 3 \u4e2a\u3002\u867d\u7136\u8fd9\u4e2a SQL \u8bed\u53e5\u5199\u6cd5\u5f88\u7b80\u5355\uff0c\u4f46\u6267\u884c\u6d41\u7a0b\u5374\u6709\u70b9\u590d\u6742\u7684\u3002</p> <p>\u6211\u4eec\u5148\u7528 explain \u547d\u4ee4\u6765\u770b\u770b\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u60c5\u51b5\u3002</p> <pre><code>mysql&gt; explain select word from words order by rand() limit 3;\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                           |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+\n|  1 | SIMPLE      | words | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 9980 |   100.00 | Using temporary; Using filesort |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+---------------------------------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre> <p>Extra \u5b57\u6bb5\u663e\u793a <code>Using temporary</code>\uff0c\u8868\u793a\u7684\u662f\u9700\u8981\u4f7f\u7528\u4e34\u65f6\u8868\uff1b<code>Using filesort</code>\uff0c\u8868\u793a\u7684\u662f\u9700\u8981\u6267\u884c\u6392\u5e8f\u64cd\u4f5c\u3002</p> <p>\u56e0\u6b64\u8fd9\u4e2a Extra \u7684\u610f\u601d\u5c31\u662f\uff0c\u9700\u8981\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u9700\u8981\u5728\u4e34\u65f6\u8868\u4e0a\u6392\u5e8f\u3002</p> <p>\u4f60\u89c9\u5f97\u5bf9\u4e8e\u4e34\u65f6\u5185\u5b58\u8868\u7684\u6392\u5e8f\u6765\u8bf4\uff0c\u5b83\u4f1a\u9009\u62e9\u54ea\u4e00\u79cd\u7b97\u6cd5\u5462\uff1f\u56de\u987e\u4e00\u4e0b\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684\u4e00\u4e2a\u7ed3\u8bba\uff1a\u5bf9\u4e8e InnoDB \u8868\u6765\u8bf4\uff0c\u6267\u884c\u5168\u5b57\u6bb5\u6392\u5e8f\u4f1a\u51cf\u5c11\u78c1\u76d8\u8bbf\u95ee\uff0c\u56e0\u6b64\u4f1a\u88ab\u4f18\u5148\u9009\u62e9\u3002</p> <p>\u6211\u5f3a\u8c03\u4e86\u201cInnoDB \u8868\u201d\uff0c\u4f60\u80af\u5b9a\u60f3\u5230\u4e86\uff0c\u5bf9\u4e8e\u5185\u5b58\u8868\uff0c\u56de\u8868\u8fc7\u7a0b\u53ea\u662f\u7b80\u5355\u5730\u6839\u636e\u6570\u636e\u884c\u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u8bbf\u95ee\u5185\u5b58\u5f97\u5230\u6570\u636e\uff0c\u6839\u672c\u4e0d\u4f1a\u5bfc\u81f4\u591a\u8bbf\u95ee\u78c1\u76d8\u3002\u4f18\u5316\u5668\u6ca1\u6709\u4e86\u8fd9\u4e00\u5c42\u987e\u8651\uff0c\u90a3\u4e48\u5b83\u4f1a\u4f18\u5148\u8003\u8651\u7684\uff0c\u5c31\u662f\u7528\u4e8e\u6392\u5e8f\u7684\u884c\u8d8a\u5c11\u8d8a\u597d\u4e86\uff0c\u6240\u4ee5\uff0cMySQL \u8fd9\u65f6\u5c31\u4f1a\u9009\u62e9 rowid \u6392\u5e8f\u3002</p> <p>\u7406\u89e3\u4e86\u8fd9\u4e2a\u7b97\u6cd5\u9009\u62e9\u7684\u903b\u8f91\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002\u540c\u65f6\uff0c\u901a\u8fc7\u4eca\u5929\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u6765\u5c1d\u8bd5\u5206\u6790\u4e00\u4e0b\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u3002</p> <p>\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u8868\u3002\u8fd9\u4e2a\u4e34\u65f6\u8868\u4f7f\u7528\u7684\u662f memory \u5f15\u64ce\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5\uff0c\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u662f double \u7c7b\u578b\uff0c\u4e3a\u4e86\u540e\u9762\u63cf\u8ff0\u65b9\u4fbf\uff0c\u8bb0\u4e3a\u5b57\u6bb5 R\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u662f <code>varchar(64)</code> \u7c7b\u578b\uff0c\u8bb0\u4e3a\u5b57\u6bb5 W\u3002\u5e76\u4e14\uff0c\u8fd9\u4e2a\u8868\u6ca1\u6709\u5efa\u7d22\u5f15\u3002</li> <li>\u4ece words \u8868\u4e2d\uff0c\u6309\u4e3b\u952e\u987a\u5e8f\u53d6\u51fa\u6240\u6709\u7684 word \u503c\u3002\u5bf9\u4e8e\u6bcf\u4e00\u4e2a word \u503c\uff0c\u8c03\u7528 <code>rand()</code> \u51fd\u6570\u751f\u6210\u4e00\u4e2a\u5927\u4e8e 0 \u5c0f\u4e8e 1 \u7684\u968f\u673a\u5c0f\u6570\uff0c\u5e76\u628a\u8fd9\u4e2a\u968f\u673a\u5c0f\u6570\u548c word \u5206\u522b\u5b58\u5165\u4e34\u65f6\u8868\u7684 R \u548c W \u5b57\u6bb5\u4e2d\uff0c\u5230\u6b64\uff0c\u626b\u63cf\u884c\u6570\u662f 10000\u3002</li> <li>\u73b0\u5728\u4e34\u65f6\u8868\u6709 10000 \u884c\u6570\u636e\u4e86\uff0c\u63a5\u4e0b\u6765\u4f60\u8981\u5728\u8fd9\u4e2a\u6ca1\u6709\u7d22\u5f15\u7684\u5185\u5b58\u4e34\u65f6\u8868\u4e0a\uff0c\u6309\u7167\u5b57\u6bb5 R \u6392\u5e8f\u3002</li> <li>\u521d\u59cb\u5316 <code>sort_buffer</code>\u3002<code>sort_buffer</code> \u4e2d\u6709\u4e24\u4e2a\u5b57\u6bb5\uff0c\u4e00\u4e2a\u662f double \u7c7b\u578b\uff0c\u53e6\u4e00\u4e2a\u662f\u6574\u578b\u3002</li> <li>\u4ece\u5185\u5b58\u4e34\u65f6\u8868\u4e2d\u4e00\u884c\u4e00\u884c\u5730\u53d6\u51fa R \u503c\u548c\u4f4d\u7f6e\u4fe1\u606f\uff0c\u5206\u522b\u5b58\u5165 <code>sort_buffer</code> \u4e2d\u7684\u4e24\u4e2a\u5b57\u6bb5\u91cc\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u8981\u5bf9\u5185\u5b58\u4e34\u65f6\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u6b64\u65f6\u626b\u63cf\u884c\u6570\u589e\u52a0 10000\uff0c\u53d8\u6210\u4e86 20000\u3002</li> <li>\u5728 <code>sort_buffer</code> \u4e2d\u6839\u636e R \u7684\u503c\u8fdb\u884c\u6392\u5e8f\u3002\u6ce8\u610f\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6ca1\u6709\u6d89\u53ca\u5230\u8868\u64cd\u4f5c\uff0c\u6240\u4ee5\u4e0d\u4f1a\u589e\u52a0\u626b\u63cf\u884c\u6570\u3002</li> <li>\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u53d6\u51fa\u524d\u4e09\u4e2a\u7ed3\u679c\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0c\u4f9d\u6b21\u5230\u5185\u5b58\u4e34\u65f6\u8868\u4e2d\u53d6\u51fa word \u503c\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u8bbf\u95ee\u4e86\u8868\u7684\u4e09\u884c\u6570\u636e\uff0c\u603b\u626b\u63cf\u884c\u6570\u53d8\u6210\u4e86 20003\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6765\u9a8c\u8bc1\u4e00\u4e0b\u6211\u4eec\u5206\u6790\u5f97\u5230\u7684\u626b\u63cf\u884c\u6570\u662f\u5426\u6b63\u786e\u3002</p> <pre><code>### Query_time: 0.900376  Lock_time: 0.000347 Rows_sent: 3 Rows_examined: 20003\nSET timestamp=1541402277;\nselect word from words order by rand() limit 3;\n</code></pre> <p>\u5176\u4e2d\uff0c<code>Rows_examined\uff1a20003</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86 20003 \u884c\uff0c\u4e5f\u5c31\u9a8c\u8bc1\u4e86\u6211\u4eec\u5206\u6790\u5f97\u51fa\u7684\u7ed3\u8bba\u3002</p> <p>\u8fd9\u91cc\u63d2\u4e00\u53e5\u9898\u5916\u8bdd\uff0c\u5728\u5e73\u65f6\u5b66\u4e60\u6982\u5ff5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u7ecf\u5e38\u8fd9\u6837\u505a\uff0c\u5148\u901a\u8fc7\u539f\u7406\u5206\u6790\u7b97\u51fa\u626b\u63cf\u884c\u6570\uff0c\u7136\u540e\u518d\u901a\u8fc7\u67e5\u770b\u6162\u67e5\u8be2\u65e5\u5fd7\uff0c\u6765\u9a8c\u8bc1\u81ea\u5df1\u7684\u7ed3\u8bba\u3002\u6211\u81ea\u5df1\u5c31\u662f\u7ecf\u5e38\u8fd9\u4e48\u505a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5f88\u6709\u8da3\uff0c\u5206\u6790\u5bf9\u4e86\u5f00\u5fc3\uff0c\u5206\u6790\u9519\u4e86\u4f46\u662f\u5f04\u6e05\u695a\u4e86\u4e5f\u5f88\u5f00\u5fc3\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u6765\u628a\u5b8c\u6574\u7684\u6392\u5e8f\u6267\u884c\u6d41\u7a0b\u56fe\u753b\u51fa\u6765\u3002</p> <p></p> <p>\u56fe 4 \u968f\u673a\u6392\u5e8f\u5b8c\u6574\u6d41\u7a0b\u56fe 1</p> <p>\u56fe\u4e2d\u7684 pos \u5c31\u662f\u4f4d\u7f6e\u4fe1\u606f\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u5947\u602a\uff0c\u8fd9\u91cc\u7684\u201c\u4f4d\u7f6e\u4fe1\u606f\u201d\u662f\u4e2a\u4ec0\u4e48\u6982\u5ff5\uff1f\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5bf9 InnoDB \u8868\u6392\u5e8f\u7684\u65f6\u5019\uff0c\u660e\u660e\u7528\u7684\u8fd8\u662f ID \u5b57\u6bb5\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u8981\u56de\u5230\u4e00\u4e2a\u57fa\u672c\u6982\u5ff5\uff1aMySQL \u7684\u8868\u662f\u7528\u4ec0\u4e48\u65b9\u6cd5\u6765\u5b9a\u4f4d\u201c\u4e00\u884c\u6570\u636e\u201d\u7684\u3002</p> <p>\u5728\u524d\u9762[\u7b2c 4]\u548c[\u7b2c 5]\u7bc7\u4ecb\u7ecd\u7d22\u5f15\u7684\u6587\u7ae0\u4e2d\uff0c\u6709\u51e0\u4f4d\u540c\u5b66\u95ee\u5230\uff0c\u5982\u679c\u628a\u4e00\u4e2a InnoDB \u8868\u7684\u4e3b\u952e\u5220\u6389\uff0c\u662f\u4e0d\u662f\u5c31\u6ca1\u6709\u4e3b\u952e\uff0c\u5c31\u6ca1\u529e\u6cd5\u56de\u8868\u4e86\uff1f</p> <p>\u5176\u5b9e\u4e0d\u662f\u7684\u3002\u5982\u679c\u4f60\u521b\u5efa\u7684\u8868\u6ca1\u6709\u4e3b\u952e\uff0c\u6216\u8005\u628a\u4e00\u4e2a\u8868\u7684\u4e3b\u952e\u5220\u6389\u4e86\uff0c\u90a3\u4e48 InnoDB \u4f1a\u81ea\u5df1\u751f\u6210\u4e00\u4e2a\u957f\u5ea6\u4e3a 6 \u5b57\u8282\u7684 rowid \u6765\u4f5c\u4e3a\u4e3b\u952e\u3002</p> <p>\u8fd9\u4e5f\u5c31\u662f\u6392\u5e8f\u6a21\u5f0f\u91cc\u9762\uff0crowid \u540d\u5b57\u7684\u6765\u5386\u3002\u5b9e\u9645\u4e0a\u5b83\u8868\u793a\u7684\u662f\uff1a\u6bcf\u4e2a\u5f15\u64ce\u7528\u6765\u552f\u4e00\u6807\u8bc6\u6570\u636e\u884c\u7684\u4fe1\u606f\u3002</p> <ul> <li>\u5bf9\u4e8e\u6709\u4e3b\u952e\u7684 InnoDB \u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a rowid \u5c31\u662f\u4e3b\u952e ID\uff1b</li> <li>\u5bf9\u4e8e\u6ca1\u6709\u4e3b\u952e\u7684 InnoDB \u8868\u6765\u8bf4\uff0c\u8fd9\u4e2a rowid \u5c31\u662f\u7531\u7cfb\u7edf\u751f\u6210\u7684\uff1b</li> <li>MEMORY \u5f15\u64ce\u4e0d\u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u9762\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u5c31\u662f\u4e00\u4e2a\u6570\u7ec4\u3002\u56e0\u6b64\uff0c\u8fd9\u4e2a rowid \u5176\u5b9e\u5c31\u662f\u6570\u7ec4\u7684\u4e0b\u6807\u3002</li> </ul> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u6765\u7a0d\u5fae\u5c0f\u7ed3\u4e00\u4e0b\uff1aorder by rand() \u4f7f\u7528\u4e86\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u5185\u5b58\u4e34\u65f6\u8868\u6392\u5e8f\u7684\u65f6\u5019\u4f7f\u7528\u4e86 rowid \u6392\u5e8f\u65b9\u6cd5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_18","title":"\u78c1\u76d8\u4e34\u65f6\u8868","text":"<p>\u90a3\u4e48\uff0c\u662f\u4e0d\u662f\u6240\u6709\u7684\u4e34\u65f6\u8868\u90fd\u662f\u5185\u5b58\u8868\u5462\uff1f</p> <p>\u5176\u5b9e\u4e0d\u662f\u7684\u3002<code>tmp_table_size</code> \u8fd9\u4e2a\u914d\u7f6e\u9650\u5236\u4e86\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\uff0c\u9ed8\u8ba4\u503c\u662f 16M\u3002\u5982\u679c\u4e34\u65f6\u8868\u5927\u5c0f\u8d85\u8fc7\u4e86 <code>tmp_table_size</code>\uff0c\u90a3\u4e48\u5185\u5b58\u4e34\u65f6\u8868\u5c31\u4f1a\u8f6c\u6210\u78c1\u76d8\u4e34\u65f6\u8868\u3002</p> <p>\u78c1\u76d8\u4e34\u65f6\u8868\u4f7f\u7528\u7684\u5f15\u64ce\u9ed8\u8ba4\u662f InnoDB\uff0c\u662f\u7531\u53c2\u6570 <code>internal_tmp_disk_storage_engine</code> (MySQL 8.0 \u5df2\u6ca1\u6709\u6b64\u53c2\u6570\uff0c\u5f15\u5165\u4e86\u65b0\u7684\u4e34\u65f6\u8868\u5f15\u64ce <code>Temporary MyISAM</code> )\u63a7\u5236\u7684\u3002</p> <p>\u5f53\u4f7f\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u7684\u65f6\u5019\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u4e00\u4e2a\u6ca1\u6709\u663e\u5f0f\u7d22\u5f15\u7684 InnoDB \u8868\u7684\u6392\u5e8f\u8fc7\u7a0b\u3002</p> <p>\u4e3a\u4e86\u590d\u73b0\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6211\u628a <code>tmp_table_size</code> \u8bbe\u7f6e\u6210 1024\uff0c\u628a <code>sort_buffer_size</code> \u8bbe\u7f6e\u6210 32768, \u628a <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u6210 16\u3002</p> <pre><code>set tmp_table_size=1024;\nset sort_buffer_size=32768;\nset max_length_for_sort_data=16;\n/* \u6253\u5f00 optimizer_trace\uff0c\u53ea\u5bf9\u672c\u7ebf\u7a0b\u6709\u6548 */\nSET optimizer_trace='enabled=on';  \n/* \u6267\u884c\u8bed\u53e5 */\nselect word from words order by rand() limit 3; \n/* \u67e5\u770b OPTIMIZER_TRACE \u8f93\u51fa */\nSELECT * FROM `information_schema`.`OPTIMIZER_TRACE`\\G\n</code></pre> <pre><code>{\n  \"filesort_priority_queue_optimization\": {\n      \"limit\": 3,\n      \"chosen\": true\n   },\n  \"filesort_execution\": [],\n    \"filesort_summary\": {\n      \"memory_available\": 32768,\n      \"key_size\": 16,\n      \"row_size\": 16,\n      \"max_rows_per_buffer\": 4,\n      \"num_rows_estimate\": 10010,\n      \"num_rows_found\": 10000,\n      \"num_initial_chunks_spilled_to_disk\": 0,\n      \"peak_memory_used\": 96,\n      \"sort_algorithm\": \"std::sort\",\n      \"unpacked_addon_fields\": \"using_priority_queue\",\n      \"sort_mode\": \"&lt;fixed_sort_key, rowid&gt;\"\n    }\n}\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6b21 <code>OPTIMIZER_TRACE</code> \u7684\u7ed3\u679c\u3002</p> <p>\u56e0\u4e3a\u5c06 <code>max_length_for_sort_data</code> \u8bbe\u7f6e\u6210 16\uff0c\u5c0f\u4e8e word \u5b57\u6bb5\u7684\u957f\u5ea6\u5b9a\u4e49\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u5230 <code>sort_mode</code> \u91cc\u9762\u663e\u793a\u7684\u662f rowid \u6392\u5e8f\uff0c\u8fd9\u4e2a\u662f\u7b26\u5408\u9884\u671f\u7684\uff0c\u53c2\u4e0e\u6392\u5e8f\u7684\u662f\u968f\u673a\u503c R \u5b57\u6bb5\u548c rowid \u5b57\u6bb5\u7ec4\u6210\u7684\u884c\u3002</p> <p>\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u5fc3\u7b97\u4e86\u4e00\u4e0b\uff0c\u53d1\u73b0\u4e0d\u5bf9\u3002R \u5b57\u6bb5\u5b58\u653e\u7684\u968f\u673a\u503c\u5c31 8 \u4e2a\u5b57\u8282\uff0crowid \u662f 6 \u4e2a\u5b57\u8282\uff0c\u6570\u636e\u603b\u884c\u6570\u662f 10000\uff0c\u8fd9\u6837\u7b97\u51fa\u6765\u5c31\u6709 140000 \u5b57\u8282\uff0c\u8d85\u8fc7\u4e86 <code>sort_buffer_size</code> \u5b9a\u4e49\u7684 32768 \u5b57\u8282\u4e86\u3002\u4f46\u662f\uff0c<code>number_of_tmp_files</code> \u7684\u503c\u5c45\u7136\u662f 0\uff0c\u96be\u9053\u4e0d\u9700\u8981\u7528\u4e34\u65f6\u6587\u4ef6\u5417\uff1f</p> <p>\u8fd9\u4e2a SQL \u8bed\u53e5\u7684\u6392\u5e8f\u786e\u5b9e\u6ca1\u6709\u7528\u5230\u4e34\u65f6\u6587\u4ef6\uff0c\u91c7\u7528\u662f MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684\u4e00\u4e2a\u65b0\u7684\u6392\u5e8f\u7b97\u6cd5\uff0c\u5373\uff1a\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u4e3a\u4ec0\u4e48\u6ca1\u6709\u4f7f\u7528\u4e34\u65f6\u6587\u4ef6\u7684\u7b97\u6cd5\uff0c\u4e5f\u5c31\u662f\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\uff0c\u800c\u662f\u91c7\u7528\u4e86\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u3002</p> <p>\u5176\u5b9e\uff0c\u6211\u4eec\u73b0\u5728\u7684 SQL \u8bed\u53e5\uff0c\u53ea\u9700\u8981\u53d6 R \u503c\u6700\u5c0f\u7684 3 \u4e2a rowid\u3002\u4f46\u662f\uff0c\u5982\u679c\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u7684\u8bdd\uff0c\u867d\u7136\u6700\u7ec8\u4e5f\u80fd\u5f97\u5230\u524d 3 \u4e2a\u503c\uff0c\u4f46\u662f\u8fd9\u4e2a\u7b97\u6cd5\u7ed3\u675f\u540e\uff0c\u5df2\u7ecf\u5c06 10000 \u884c\u6570\u636e\u90fd\u6392\u597d\u5e8f\u4e86\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u540e\u9762\u7684 9997 \u884c\u4e5f\u662f\u6709\u5e8f\u7684\u4e86\u3002\u4f46\uff0c\u6211\u4eec\u7684\u67e5\u8be2\u5e76\u4e0d\u9700\u8981\u8fd9\u4e9b\u6570\u636e\u662f\u6709\u5e8f\u7684\u3002\u6240\u4ee5\uff0c\u60f3\u4e00\u4e0b\u5c31\u660e\u767d\u4e86\uff0c\u8fd9\u6d6a\u8d39\u4e86\u975e\u5e38\u591a\u7684\u8ba1\u7b97\u91cf\u3002</p> <p>\u800c\u4f18\u5148\u961f\u5217\u7b97\u6cd5\uff0c\u5c31\u53ef\u4ee5\u7cbe\u786e\u5730\u53ea\u5f97\u5230\u4e09\u4e2a\u6700\u5c0f\u503c\uff0c\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u5bf9\u4e8e\u8fd9 10000 \u4e2a\u51c6\u5907\u6392\u5e8f\u7684 <code>(R,rowid)</code>\uff0c\u5148\u53d6\u524d\u4e09\u884c\uff0c\u6784\u9020\u6210\u4e00\u4e2a\u5806\uff1b\uff08\u5bf9\u6570\u636e\u7ed3\u6784\u5370\u8c61\u6a21\u7cca\u7684\u540c\u5b66\uff0c\u53ef\u4ee5\u5148\u8bbe\u60f3\u6210\u8fd9\u662f\u4e00\u4e2a\u7531\u4e09\u4e2a\u5143\u7d20\u7ec4\u6210\u7684\u6570\u7ec4\uff09</li> <li>\u53d6\u4e0b\u4e00\u4e2a\u884c <code>(R\u2019,rowid\u2019)</code>\uff0c\u8ddf\u5f53\u524d\u5806\u91cc\u9762\u6700\u5927\u7684 R \u6bd4\u8f83\uff0c\u5982\u679c R\u2019 \u5c0f\u4e8e R\uff0c\u628a\u8fd9\u4e2a <code>(R,rowid)</code> \u4ece\u5806\u4e2d\u53bb\u6389\uff0c\u6362\u6210 <code>(R\u2019,rowid\u2019)</code>\uff1b</li> <li>\u91cd\u590d\u7b2c 2 \u6b65\uff0c\u76f4\u5230\u7b2c 10000 \u4e2a <code>(R\u2019,rowid\u2019)</code> \u5b8c\u6210\u6bd4\u8f83\u3002</li> </ol> <p>\u8fd9\u91cc\u6211\u7b80\u5355\u753b\u4e86\u4e00\u4e2a\u4f18\u5148\u961f\u5217\u6392\u5e8f\u8fc7\u7a0b\u7684\u793a\u610f\u56fe\u3002</p> <p></p> <p>\u56fe 6 \u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u793a\u4f8b</p> <p>\u56fe 6 \u662f\u6a21\u62df 6 \u4e2a <code>(R,rowid)</code> \u884c\uff0c\u901a\u8fc7\u4f18\u5148\u961f\u5217\u6392\u5e8f\u627e\u5230\u6700\u5c0f\u7684\u4e09\u4e2a R \u503c\u7684\u884c\u7684\u8fc7\u7a0b\u3002\u6574\u4e2a\u6392\u5e8f\u8fc7\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u6700\u5feb\u5730\u62ff\u5230\u5f53\u524d\u5806\u7684\u6700\u5927\u503c\uff0c\u603b\u662f\u4fdd\u6301\u6700\u5927\u503c\u5728\u5806\u9876\uff0c\u56e0\u6b64\u8fd9\u662f\u4e00\u4e2a\u6700\u5927\u5806\u3002</p> <p>\u56fe 5 \u7684 <code>OPTIMIZER_TRACE</code> \u7ed3\u679c\u4e2d\uff0c<code>filesort_priority_queue_optimization</code> \u8fd9\u4e2a\u90e8\u5206\u7684 <code>chosen=true</code>\uff0c\u5c31\u8868\u793a\u4f7f\u7528\u4e86\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u4e34\u65f6\u6587\u4ef6\uff0c\u56e0\u6b64\u5bf9\u5e94\u7684 number_of_tmp_files \u662f 0\u3002</p> <p>\u8fd9\u4e2a\u6d41\u7a0b\u7ed3\u675f\u540e\uff0c\u6211\u4eec\u6784\u9020\u7684\u5806\u91cc\u9762\uff0c\u5c31\u662f\u8fd9\u4e2a 10000 \u884c\u91cc\u9762 R \u503c\u6700\u5c0f\u7684\u4e09\u884c\u3002\u7136\u540e\uff0c\u4f9d\u6b21\u628a\u5b83\u4eec\u7684 rowid \u53d6\u51fa\u6765\uff0c\u53bb\u4e34\u65f6\u8868\u91cc\u9762\u62ff\u5230 word \u5b57\u6bb5\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u8ddf\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684 rowid \u6392\u5e8f\u7684\u8fc7\u7a0b\u4e00\u6837\u4e86\u3002</p> <p>\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u4e0a\u9762\u4e00\u7bc7\u6587\u7ae0\u7684 SQL \u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>select city,name,age from t where city='\u676d\u5dde' order by name limit 1000  ;\n</code></pre> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u8fd9\u91cc\u4e5f\u7528\u5230\u4e86 limit\uff0c\u4e3a\u4ec0\u4e48\u6ca1\u7528\u4f18\u5148\u961f\u5217\u6392\u5e8f\u7b97\u6cd5\u5462\uff1f\u539f\u56e0\u662f\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u662f limit 1000\uff0c\u5982\u679c\u4f7f\u7528\u4f18\u5148\u961f\u5217\u7b97\u6cd5\u7684\u8bdd\uff0c\u9700\u8981\u7ef4\u62a4\u7684\u5806\u7684\u5927\u5c0f\u5c31\u662f 1000 \u884c\u7684 <code>(name,rowid)</code>\uff0c\u8d85\u8fc7\u4e86\u6211\u8bbe\u7f6e\u7684 <code>sort_buffer_size</code> \u5927\u5c0f\uff0c\u6240\u4ee5\u53ea\u80fd\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u7b97\u6cd5\u3002</p> <p>\u603b\u4e4b\uff0c\u4e0d\u8bba\u662f\u4f7f\u7528\u54ea\u79cd\u7c7b\u578b\u7684\u4e34\u65f6\u8868\uff0c<code>order by rand()</code> \u8fd9\u79cd\u5199\u6cd5\u90fd\u4f1a\u8ba9\u8ba1\u7b97\u8fc7\u7a0b\u975e\u5e38\u590d\u6742\uff0c\u9700\u8981\u5927\u91cf\u7684\u626b\u63cf\u884c\u6570\uff0c\u56e0\u6b64\u6392\u5e8f\u8fc7\u7a0b\u7684\u8d44\u6e90\u6d88\u8017\u4e5f\u4f1a\u5f88\u5927\u3002</p> <p>\u518d\u56de\u5230\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u600e\u4e48\u6b63\u786e\u5730\u968f\u673a\u6392\u5e8f\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_19","title":"\u968f\u673a\u6392\u5e8f\u65b9\u6cd5","text":"<p>\u6211\u4eec\u5148\u628a\u95ee\u9898\u7b80\u5316\u4e00\u4e0b\uff0c\u5982\u679c\u53ea\u968f\u673a\u9009\u62e9 1 \u4e2a word \u503c\uff0c\u53ef\u4ee5\u600e\u4e48\u505a\u5462\uff1f\u601d\u8def\u4e0a\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u53d6\u5f97\u8fd9\u4e2a\u8868\u7684\u4e3b\u952e id \u7684\u6700\u5927\u503c M \u548c\u6700\u5c0f\u503c N;</li> <li>\u7528\u968f\u673a\u51fd\u6570\u751f\u6210\u4e00\u4e2a\u6700\u5927\u503c\u5230\u6700\u5c0f\u503c\u4e4b\u95f4\u7684\u6570 \\(X = (M-N) * rand() + N\\)</li> <li>\u53d6\u4e0d\u5c0f\u4e8e X \u7684\u7b2c\u4e00\u4e2a ID \u7684\u884c\u3002</li> </ol> <p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u6682\u65f6\u79f0\u4f5c\u968f\u673a\u7b97\u6cd5 1\u3002\u8fd9\u91cc\uff0c\u6211\u76f4\u63a5\u7ed9\u4f60\u8d34\u4e00\u4e0b\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217:</p> <pre><code>select max(id),min(id) into @M,@N from t ;\nset @X= floor((@M-@N+1)*rand() + @N);\nselect * from t where id &gt;= @X limit 1;\n</code></pre> <p>\u8fd9\u4e2a\u65b9\u6cd5\u6548\u7387\u5f88\u9ad8\uff0c\u56e0\u4e3a\u53d6 <code>max(id)</code> \u548c <code>min(id)</code> \u90fd\u662f\u4e0d\u9700\u8981\u626b\u63cf\u7d22\u5f15\u7684\uff0c\u800c\u7b2c\u4e09\u6b65\u7684 select \u4e5f\u53ef\u4ee5\u7528\u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u5c31\u53ea\u626b\u63cf\u4e86 3 \u884c\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u672c\u8eab\u5e76\u4e0d\u4e25\u683c\u6ee1\u8db3\u9898\u76ee\u7684\u968f\u673a\u8981\u6c42\uff0c\u56e0\u4e3a ID \u4e2d\u95f4\u53ef\u80fd\u6709\u7a7a\u6d1e\uff0c\u56e0\u6b64\u9009\u62e9\u4e0d\u540c\u884c\u7684\u6982\u7387\u4e0d\u4e00\u6837\uff0c\u4e0d\u662f\u771f\u6b63\u7684\u968f\u673a\u3002</p> <p>\u6bd4\u5982\u4f60\u6709 4 \u4e2a id\uff0c\u5206\u522b\u662f 1\u30012\u30014\u30015\uff0c\u5982\u679c\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\uff0c\u90a3\u4e48\u53d6\u5230 id=4 \u7684\u8fd9\u4e00\u884c\u7684\u6982\u7387\u662f\u53d6\u5f97\u5176\u4ed6\u884c\u6982\u7387\u7684\u4e24\u500d\u3002</p> <p>\u5982\u679c\u8fd9\u56db\u884c\u7684 id \u5206\u522b\u662f 1\u30012\u300140000\u300140001 \u5462\uff1f\u8fd9\u4e2a\u7b97\u6cd5\u57fa\u672c\u5c31\u80fd\u5f53 bug \u6765\u770b\u5f85\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u4e3a\u4e86\u5f97\u5230\u4e25\u683c\u968f\u673a\u7684\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u8fd9\u4e2a\u6d41\u7a0b:</p> <ol> <li>\u53d6\u5f97\u6574\u4e2a\u8868\u7684\u884c\u6570\uff0c\u5e76\u8bb0\u4e3a C\u3002</li> <li>\u53d6\u5f97 \\(Y = floor(C * rand())\\)\u3002 floor \u51fd\u6570\u5728\u8fd9\u91cc\u7684\u4f5c\u7528\uff0c\u5c31\u662f\u53d6\u6574\u6570\u90e8\u5206\u3002</li> <li>\u518d\u7528 <code>limit Y,1</code> \u53d6\u5f97\u4e00\u884c\u3002</li> </ol> <p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u79f0\u4e3a\u968f\u673a\u7b97\u6cd5 2\u3002\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\uff0c\u5c31\u662f\u4e0a\u9762\u6d41\u7a0b\u7684\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217\u3002</p> <pre><code>select count(*) into @C from t;\nset @Y = floor(@C * rand());\nset @sql = concat(\"select * from t limit \", @Y, \",1\");\nprepare stmt from @sql;\nexecute stmt;\nDEALLOCATE prepare stmt;\n</code></pre> <p>\u7531\u4e8e limit \u540e\u9762\u7684\u53c2\u6570\u4e0d\u80fd\u76f4\u63a5\u8ddf\u53d8\u91cf\uff0c\u6240\u4ee5\u6211\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 prepare+execute \u7684\u65b9\u6cd5\u3002\u4f60\u4e5f\u53ef\u4ee5\u628a\u62fc\u63a5 SQL \u8bed\u53e5\u7684\u65b9\u6cd5\u5199\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u4f1a\u66f4\u7b80\u5355\u4e9b\u3002</p> <p>\u8fd9\u4e2a\u968f\u673a\u7b97\u6cd5 2\uff0c\u89e3\u51b3\u4e86\u7b97\u6cd5 1 \u91cc\u9762\u660e\u663e\u7684\u6982\u7387\u4e0d\u5747\u5300\u95ee\u9898\u3002</p> <p>MySQL \u5904\u7406 limit Y,1 \u7684\u505a\u6cd5\u5c31\u662f\u6309\u987a\u5e8f\u4e00\u4e2a\u4e00\u4e2a\u5730\u8bfb\u51fa\u6765\uff0c\u4e22\u6389\u524d Y \u4e2a\uff0c\u7136\u540e\u628a\u4e0b\u4e00\u4e2a\u8bb0\u5f55\u4f5c\u4e3a\u8fd4\u56de\u7ed3\u679c\uff0c\u56e0\u6b64\u8fd9\u4e00\u6b65\u9700\u8981\u626b\u63cf Y+1 \u884c\u3002\u518d\u52a0\u4e0a\uff0c\u7b2c\u4e00\u6b65\u626b\u63cf\u7684 C \u884c\uff0c\u603b\u5171\u9700\u8981\u626b\u63cf C+Y+1 \u884c\uff0c\u6267\u884c\u4ee3\u4ef7\u6bd4\u968f\u673a\u7b97\u6cd5 1 \u7684\u4ee3\u4ef7\u8981\u9ad8\u3002</p> <p>\u5f53\u7136\uff0c\u968f\u673a\u7b97\u6cd5 2 \u8ddf\u76f4\u63a5 <code>order by rand()</code> \u6bd4\u8d77\u6765\uff0c\u6267\u884c\u4ee3\u4ef7\u8fd8\u662f\u5c0f\u5f88\u591a\u7684\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u518d\u770b\u770b\uff0c\u5982\u679c\u6211\u4eec\u6309\u7167\u968f\u673a\u7b97\u6cd5 2 \u7684\u601d\u8def\uff0c\u8981\u968f\u673a\u53d6 3 \u4e2a word \u503c\u5462\uff1f\u4f60\u53ef\u4ee5\u8fd9\u4e48\u505a\uff1a</p> <ol> <li>\u53d6\u5f97\u6574\u4e2a\u8868\u7684\u884c\u6570\uff0c\u8bb0\u4e3a C\uff1b</li> <li>\u6839\u636e\u76f8\u540c\u7684\u968f\u673a\u65b9\u6cd5\u5f97\u5230 Y1\u3001Y2\u3001Y3\uff1b</li> <li>\u518d\u6267\u884c\u4e09\u4e2a limit Y, 1 \u8bed\u53e5\u5f97\u5230\u4e09\u884c\u6570\u636e\u3002</li> </ol> <p>\u6211\u4eec\u628a\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u79f0\u4f5c\u968f\u673a\u7b97\u6cd5 3\u3002\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\uff0c\u5c31\u662f\u4e0a\u9762\u6d41\u7a0b\u7684\u6267\u884c\u8bed\u53e5\u7684\u5e8f\u5217\u3002</p> <pre><code>select count(*) into @C from t;\nset @Y1 = floor(@C * rand());\nset @Y2 = floor(@C * rand());\nset @Y3 = floor(@C * rand());\n-- \u5728\u5e94\u7528\u4ee3\u7801\u91cc\u9762\u53d6 Y1\u3001Y2\u3001Y3 \u503c\uff0c\u62fc\u51fa SQL \u540e\u6267\u884c\nselect * from t limit @Y1\uff0c1;\nselect * from t limit @Y2\uff0c1;\nselect * from t limit @Y3\uff0c1;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_20","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u662f\u501f\u7740\u968f\u673a\u6392\u5e8f\u7684\u9700\u6c42\uff0c\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u5bf9\u4e34\u65f6\u8868\u6392\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p> <p>\u5982\u679c\u4f60\u76f4\u63a5\u4f7f\u7528 <code>order by rand()</code>\uff0c\u8fd9\u4e2a\u8bed\u53e5\u9700\u8981 Using temporary \u548c Using filesort\uff0c\u67e5\u8be2\u7684\u6267\u884c\u4ee3\u4ef7\u5f80\u5f80\u662f\u6bd4\u8f83\u5927\u7684\u3002\u6240\u4ee5\uff0c\u5728\u8bbe\u8ba1\u7684\u65f6\u5019\u4f60\u8981\u91cf\u907f\u5f00\u8fd9\u79cd\u5199\u6cd5\u3002</p> <p>\u4eca\u5929\u7684\u4f8b\u5b50\u91cc\u9762\uff0c\u6211\u4eec\u4e0d\u662f\u4ec5\u4ec5\u5728\u6570\u636e\u5e93\u5185\u90e8\u89e3\u51b3\u95ee\u9898\uff0c\u8fd8\u4f1a\u8ba9\u5e94\u7528\u4ee3\u7801\u914d\u5408\u62fc\u63a5 SQL \u8bed\u53e5\u3002\u5728\u5b9e\u9645\u5e94\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bd4\u8f83\u89c4\u8303\u7684\u7528\u6cd5\u5c31\u662f\uff1a\u5c3d\u91cf\u5c06\u4e1a\u52a1\u903b\u8f91\u5199\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\uff0c\u8ba9\u6570\u636e\u5e93\u53ea\u505a\u201c\u8bfb\u5199\u6570\u636e\u201d\u7684\u4e8b\u60c5\u3002\u56e0\u6b64\uff0c\u8fd9\u7c7b\u65b9\u6cd5\u7684\u5e94\u7528\u8fd8\u662f\u6bd4\u8f83\u5e7f\u6cdb\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#18-sql","title":"18 \u4e3a\u4ec0\u4e48\u8fd9\u4e9bSQL\u8bed\u53e5\u903b\u8f91\u76f8\u540c\uff0c\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\uff1f","text":"<p>\u5728 MySQL \u4e2d\uff0c\u6709\u5f88\u591a\u770b\u4e0a\u53bb\u903b\u8f91\u76f8\u540c\uff0c\u4f46\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\u7684 SQL \u8bed\u53e5\u3002\u5bf9\u8fd9\u4e9b\u8bed\u53e5\u4f7f\u7528\u4e0d\u5f53\u7684\u8bdd\uff0c\u5c31\u4f1a\u4e0d\u7ecf\u610f\u95f4\u5bfc\u81f4\u6574\u4e2a\u6570\u636e\u5e93\u7684\u538b\u529b\u53d8\u5927\u3002</p> <p>\u6211\u4eca\u5929\u6311\u9009\u4e86\u4e09\u4e2a\u8fd9\u6837\u7684\u6848\u4f8b\u548c\u4f60\u5206\u4eab\u3002\u5e0c\u671b\u518d\u9047\u5230\u76f8\u4f3c\u7684\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u4ee5\u505a\u5230\u4e3e\u4e00\u53cd\u4e09\u3001\u5feb\u901f\u89e3\u51b3\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_21","title":"\u6848\u4f8b\u4e00\uff1a\u6761\u4ef6\u5b57\u6bb5\u51fd\u6570\u64cd\u4f5c","text":"<p>\u5047\u8bbe\u4f60\u73b0\u5728\u7ef4\u62a4\u4e86\u4e00\u4e2a\u4ea4\u6613\u7cfb\u7edf\uff0c\u5176\u4e2d\u4ea4\u6613\u8bb0\u5f55\u8868 tradelog \u5305\u542b\u4ea4\u6613\u6d41\u6c34\u53f7\uff08tradeid\uff09\u3001\u4ea4\u6613\u5458 id\uff08operator\uff09\u3001\u4ea4\u6613\u65f6\u95f4\uff08<code>t_modified</code>\uff09\u7b49\u5b57\u6bb5\u3002\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u4eec\u5148\u5ffd\u7565\u5176\u4ed6\u5b57\u6bb5\u3002\u8fd9\u4e2a\u8868\u7684\u5efa\u8868\u8bed\u53e5\u5982\u4e0b\uff1a</p> <pre><code>CREATE TABLE `tradelog` (\n  `id` int(11) NOT NULL,\n  `tradeid` varchar(32) DEFAULT NULL,\n  `operator` int(11) DEFAULT NULL,\n  `t_modified` datetime DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `tradeid` (`tradeid`),\n  KEY `t_modified` (`t_modified`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- \u586b\u5145\u6570\u636e\nDELIMITER $$\n\nCREATE PROCEDURE `populate_tradelog`()\nBEGIN\n    DECLARE i INT DEFAULT 1;\n    DECLARE tradeid VARCHAR(32);\n    DECLARE operator INT;\n    DECLARE t_modified DATETIME;\n\n    WHILE i &lt;= 100000 DO\n        SET tradeid = CONCAT('TRADEID-', i);\n        SET operator = FLOOR(RAND() * 1000);\n        SET t_modified = DATE_ADD(NOW(), INTERVAL -FLOOR(RAND() * 365) DAY);\n\n        INSERT INTO tradelog (id, tradeid, operator, t_modified)\n        VALUES (i, tradeid, operator, t_modified);\n\n        SET i = i + 1;\n    END WHILE;\nEND$$\n\nDELIMITER ;\n\n-- populate\nCALL populate_tradelog();\n</code></pre> <p>\u5047\u8bbe\uff0c\u73b0\u5728\u5df2\u7ecf\u8bb0\u5f55\u4e86\u4ece 2016 \u5e74\u521d\u5230 2018 \u5e74\u5e95\u7684\u6240\u6709\u6570\u636e\uff0c\u8fd0\u8425\u90e8\u95e8\u6709\u4e00\u4e2a\u9700\u6c42\u662f\uff0c\u8981\u7edf\u8ba1\u53d1\u751f\u5728\u6240\u6709\u5e74\u4efd\u4e2d 7 \u6708\u4efd\u7684\u4ea4\u6613\u8bb0\u5f55\u603b\u6570\u3002\u8fd9\u4e2a\u903b\u8f91\u770b\u4e0a\u53bb\u5e76\u4e0d\u590d\u6742\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u53ef\u80fd\u4f1a\u8fd9\u4e48\u5199\uff1a</p> <pre><code>mysql&gt; select count(*) from tradelog where month(t_modified)=7;\n</code></pre> <p>\u7531\u4e8e <code>t_modified</code> \u5b57\u6bb5\u4e0a\u6709\u7d22\u5f15\uff0c\u4e8e\u662f\u4f60\u5c31\u5f88\u653e\u5fc3\u5730\u5728\u751f\u4ea7\u5e93\u4e2d\u6267\u884c\u4e86\u8fd9\u6761\u8bed\u53e5\uff0c\u4f46\u5374\u53d1\u73b0\u6267\u884c\u4e86\u7279\u522b\u4e45\uff0c\u624d\u8fd4\u56de\u4e86\u7ed3\u679c\u3002</p> <p>\u5982\u679c\u4f60\u95ee DBA \u540c\u4e8b\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u4ed6\u5927\u6982\u4f1a\u544a\u8bc9\u4f60\uff1a\u5982\u679c\u5bf9\u5b57\u6bb5\u505a\u4e86\u51fd\u6570\u8ba1\u7b97\uff0c\u5c31\u7528\u4e0d\u4e0a\u7d22\u5f15\u4e86\uff0c\u8fd9\u662f MySQL \u7684\u89c4\u5b9a\u3002</p> <p>\u73b0\u5728\u4f60\u5df2\u7ecf\u5b66\u8fc7\u4e86 InnoDB \u7684\u7d22\u5f15\u7ed3\u6784\u4e86\uff0c\u53ef\u4ee5\u518d\u8ffd\u95ee\u4e00\u53e5\u4e3a\u4ec0\u4e48\uff1f\u4e3a\u4ec0\u4e48\u6761\u4ef6\u662f <code>where t_modified='2018-7-1\u2019</code> \u7684\u65f6\u5019\u53ef\u4ee5\u7528\u4e0a\u7d22\u5f15\uff0c\u800c\u6539\u6210 <code>where month(t_modified)=7</code> \u7684\u65f6\u5019\u5c31\u4e0d\u884c\u4e86\uff1f</p> <p>\u4e0b\u9762\u662f\u8fd9\u4e2a <code>t_modified</code> \u7d22\u5f15\u7684\u793a\u610f\u56fe\u3002\u65b9\u6846\u4e0a\u9762\u7684\u6570\u5b57\u5c31\u662f <code>month()</code> \u51fd\u6570\u5bf9\u5e94\u7684\u503c\u3002</p> <p></p> <p>\u56fe 1 t_modified \u7d22\u5f15\u793a\u610f\u56fe</p> <p>\u5982\u679c\u4f60\u7684 SQL \u8bed\u53e5\u6761\u4ef6\u7528\u7684\u662f <code>where t_modified='2018-7-1'</code>\u7684\u8bdd\uff0c\u5f15\u64ce\u5c31\u4f1a\u6309\u7167\u4e0a\u9762\u7eff\u8272\u7bad\u5934\u7684\u8def\u7ebf\uff0c\u5feb\u901f\u5b9a\u4f4d\u5230 <code>t_modified='2018-7-1'</code>\u9700\u8981\u7684\u7ed3\u679c\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0cB+ \u6811\u63d0\u4f9b\u7684\u8fd9\u4e2a\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\uff0c\u6765\u6e90\u4e8e\u540c\u4e00\u5c42\u5144\u5f1f\u8282\u70b9\u7684\u6709\u5e8f\u6027\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u8ba1\u7b97 <code>month()</code> \u51fd\u6570\u7684\u8bdd\uff0c\u4f60\u4f1a\u770b\u5230\u4f20\u5165 7 \u7684\u65f6\u5019\uff0c\u5728\u6811\u7684\u7b2c\u4e00\u5c42\u5c31\u4e0d\u77e5\u9053\u8be5\u600e\u4e48\u529e\u4e86\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u7d22\u5f15\u503c\u7684\u6709\u5e8f\u6027\uff0c\u56e0\u6b64\u4f18\u5316\u5668\u5c31\u51b3\u5b9a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4f18\u5316\u5668\u5e76\u4e0d\u662f\u8981\u653e\u5f03\u4f7f\u7528\u8fd9\u4e2a\u7d22\u5f15\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u653e\u5f03\u4e86\u6811\u641c\u7d22\u529f\u80fd\uff0c\u4f18\u5316\u5668\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u4e3b\u952e\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u7d22\u5f15 <code>t_modified</code>\uff0c\u4f18\u5316\u5668\u5bf9\u6bd4\u7d22\u5f15\u5927\u5c0f\u540e\u53d1\u73b0\uff0c\u7d22\u5f15 <code>t_modified</code> \u66f4\u5c0f\uff0c\u904d\u5386\u8fd9\u4e2a\u7d22\u5f15\u6bd4\u904d\u5386\u4e3b\u952e\u7d22\u5f15\u6765\u5f97\u66f4\u5feb\u3002\u56e0\u6b64\u6700\u7ec8\u8fd8\u662f\u4f1a\u9009\u62e9\u7d22\u5f15 <code>t_modified</code>\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4f7f\u7528 explain \u547d\u4ee4\uff0c\u67e5\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain select count(*) from tradelog where month(t_modified)=7;\n+----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+\n| id | select_type | table    | partitions | type  | possible_keys | key        | key_len | ref  | rows | filtered | Extra                    |\n+----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+\n|  1 | SIMPLE      | tradelog | NULL       | index | NULL          | t_modified | 6       | NULL |100335|   100.00 | Using where; Using index |\n+----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+--------------------------+\n</code></pre> <p><code>key=\"t_modified\"</code> \u8868\u793a\u7684\u662f\uff0c\u4f7f\u7528\u4e86 <code>t_modified</code> \u8fd9\u4e2a\u7d22\u5f15\uff1b\u6211\u5728\u6d4b\u8bd5\u8868\u6570\u636e\u4e2d\u63d2\u5165\u4e86 10 \u4e07\u884c\u6570\u636e\uff0c<code>rows=100335</code>\uff0c\u8bf4\u660e\u8fd9\u6761\u8bed\u53e5\u626b\u63cf\u4e86\u6574\u4e2a\u7d22\u5f15\u7684\u6240\u6709\u503c\uff1bExtra \u5b57\u6bb5\u7684 Using index\uff0c\u8868\u793a\u7684\u662f\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u7531\u4e8e\u5728 <code>t_modified</code> \u5b57\u6bb5\u52a0\u4e86 <code>month()</code> \u51fd\u6570\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e86\u5168\u7d22\u5f15\u626b\u63cf\u3002\u4e3a\u4e86\u80fd\u591f\u7528\u4e0a\u7d22\u5f15\u7684\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\uff0c\u6211\u4eec\u5c31\u8981\u628a SQL \u8bed\u53e5\u6539\u6210\u57fa\u4e8e\u5b57\u6bb5\u672c\u8eab\u7684\u8303\u56f4\u67e5\u8be2\u3002\u6309\u7167\u4e0b\u9762\u8fd9\u4e2a\u5199\u6cd5\uff0c\u4f18\u5316\u5668\u5c31\u80fd\u6309\u7167\u6211\u4eec\u9884\u671f\u7684\uff0c\u7528\u4e0a <code>t_modified</code> \u7d22\u5f15\u7684\u5feb\u901f\u5b9a\u4f4d\u80fd\u529b\u4e86\u3002</p> <pre><code>mysql&gt; select count(*) from tradelog where\n    -&gt; (t_modified &gt;= '2016-7-1' and t_modified&lt;'2016-8-1') or\n    -&gt; (t_modified &gt;= '2017-7-1' and t_modified&lt;'2017-8-1') or \n    -&gt; (t_modified &gt;= '2018-7-1' and t_modified&lt;'2018-8-1');\n</code></pre> <p>\u5f53\u7136\uff0c\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u4e0a\u7ebf\u65f6\u95f4\u66f4\u65e9\uff0c\u6216\u8005\u540e\u9762\u53c8\u63d2\u5165\u4e86\u4e4b\u540e\u5e74\u4efd\u7684\u6570\u636e\u7684\u8bdd\uff0c\u4f60\u5c31\u9700\u8981\u518d\u628a\u5176\u4ed6\u5e74\u4efd\u8865\u9f50\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u7ed9\u4f60\u8bf4\u660e\u4e86\uff0c\u7531\u4e8e\u52a0\u4e86 <code>month()</code> \u51fd\u6570\u64cd\u4f5c\uff0cMySQL \u65e0\u6cd5\u518d\u4f7f\u7528\u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\u529f\u80fd\uff0c\u800c\u53ea\u80fd\u4f7f\u7528\u5168\u7d22\u5f15\u626b\u63cf\u3002</p> <p>\u4e0d\u8fc7\u4f18\u5316\u5668\u5728\u4e2a\u95ee\u9898\u4e0a\u786e\u5b9e\u6709\u201c\u5077\u61d2\u201d\u884c\u4e3a\uff0c\u5373\u4f7f\u662f\u5bf9\u4e8e\u4e0d\u6539\u53d8\u6709\u5e8f\u6027\u7684\u51fd\u6570\uff0c\u4e5f\u4e0d\u4f1a\u8003\u8651\u4f7f\u7528\u7d22\u5f15\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e <code>select * from tradelog where id + 1 = 10000</code> \u8fd9\u4e2a SQL \u8bed\u53e5\uff0c\u8fd9\u4e2a\u52a0 1 \u64cd\u4f5c\u5e76\u4e0d\u4f1a\u6539\u53d8\u6709\u5e8f\u6027\uff0c\u4f46\u662f MySQL \u4f18\u5316\u5668\u8fd8\u662f\u4e0d\u80fd\u7528 id \u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\u5230 9999 \u8fd9\u4e00\u884c\u3002\u6240\u4ee5\uff0c\u9700\u8981\u4f60\u5728\u5199 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u624b\u52a8\u6539\u5199\u6210 <code>where id = 10000 -1</code> \u624d\u53ef\u4ee5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_22","title":"\u6848\u4f8b\u4e8c\uff1a\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362","text":"<p>\u63a5\u4e0b\u6765\u6211\u518d\u8ddf\u4f60\u8bf4\u4e00\u8bf4\uff0c\u53e6\u4e00\u4e2a\u7ecf\u5e38\u8ba9\u7a0b\u5e8f\u5458\u6389\u5751\u91cc\u7684\u4f8b\u5b50\u3002</p> <p>\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select * from tradelog where tradeid=110717;\n</code></pre> <p>\u4ea4\u6613\u7f16\u53f7 tradeid \u8fd9\u4e2a\u5b57\u6bb5\u4e0a\uff0c\u672c\u6765\u5c31\u6709\u7d22\u5f15\uff0c\u4f46\u662f explain \u7684\u7ed3\u679c\u5374\u663e\u793a\uff0c\u8fd9\u6761\u8bed\u53e5\u9700\u8981\u8d70\u5168\u8868\u626b\u63cf\u3002\u4f60\u53ef\u80fd\u4e5f\u53d1\u73b0\u4e86\uff0ctradeid \u7684\u5b57\u6bb5\u7c7b\u578b\u662f <code>varchar(32)</code>\uff0c\u800c\u8f93\u5165\u7684\u53c2\u6570\u5374\u662f\u6574\u578b\uff0c\u6240\u4ee5\u9700\u8981\u505a\u7c7b\u578b\u8f6c\u6362\u3002</p> <p>\u90a3\u4e48\uff0c\u73b0\u5728\u8fd9\u91cc\u5c31\u6709\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u6570\u636e\u7c7b\u578b\u8f6c\u6362\u7684\u89c4\u5219\u662f\u4ec0\u4e48\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u6709\u6570\u636e\u7c7b\u578b\u8f6c\u6362\uff0c\u5c31\u9700\u8981\u8d70\u5168\u7d22\u5f15\u626b\u63cf\uff1f</li> </ol> <p>\u5148\u6765\u770b\u7b2c\u4e00\u4e2a\u95ee\u9898\uff0c\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u6570\u636e\u5e93\u91cc\u9762\u7c7b\u578b\u8fd9\u4e48\u591a\uff0c\u8fd9\u79cd\u6570\u636e\u7c7b\u578b\u8f6c\u6362\u89c4\u5219\u66f4\u591a\uff0c\u6211\u8bb0\u4e0d\u4f4f\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u770b <code>select '10' &gt; 9</code> \u7684\u7ed3\u679c\uff1a</p> <ol> <li>\u5982\u679c\u89c4\u5219\u662f\u201c\u5c06\u5b57\u7b26\u4e32\u8f6c\u6210\u6570\u5b57\u201d\uff0c\u90a3\u4e48\u5c31\u662f\u505a\u6570\u5b57\u6bd4\u8f83\uff0c\u7ed3\u679c\u5e94\u8be5\u662f 1\uff1b</li> <li>\u5982\u679c\u89c4\u5219\u662f\u201c\u5c06\u6570\u5b57\u8f6c\u6210\u5b57\u7b26\u4e32\u201d\uff0c\u90a3\u4e48\u5c31\u662f\u505a\u5b57\u7b26\u4e32\u6bd4\u8f83\uff0c\u7ed3\u679c\u5e94\u8be5\u662f 0\u3002</li> </ol> <p>\u9a8c\u8bc1\u7ed3\u679c\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>mysql&gt; select '10' &gt; 9;\n+----------+\n| '10' &gt; 9 |\n+----------+\n|        1 |\n+----------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u4ece\u56fe\u4e2d\u53ef\u77e5\uff0c<code>select '10' &gt; 9</code> \u8fd4\u56de\u7684\u662f 1\uff0c\u6240\u4ee5\u4f60\u5c31\u80fd\u786e\u8ba4 MySQL \u91cc\u7684\u8f6c\u6362\u89c4\u5219\u4e86\uff1a\u5728 MySQL \u4e2d\uff0c\u5b57\u7b26\u4e32\u548c\u6570\u5b57\u505a\u6bd4\u8f83\u7684\u8bdd\uff0c\u662f\u5c06\u5b57\u7b26\u4e32\u8f6c\u6362\u6210\u6570\u5b57\u3002</p> <p>\u8fd9\u65f6\uff0c\u4f60\u518d\u770b\u8fd9\u4e2a\u5168\u8868\u626b\u63cf\u7684\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select * from tradelog where tradeid=110717;\n</code></pre> <p>\u5c31\u77e5\u9053\u5bf9\u4e8e\u4f18\u5316\u5668\u6765\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u76f8\u5f53\u4e8e\uff1a</p> <pre><code>mysql&gt; select * from tradelog where  CAST(tradid AS signed int) = 110717;\n</code></pre> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8bed\u53e5\u89e6\u53d1\u4e86\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u89c4\u5219\uff1a\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u4f18\u5316\u5668\u4f1a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u7559\u7ed9\u4f60\u4e00\u4e2a\u5c0f\u95ee\u9898\uff0cid \u7684\u7c7b\u578b\u662f int\uff0c\u5982\u679c\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u662f\u5426\u4f1a\u5bfc\u81f4\u5168\u8868\u626b\u63cf\u5462\uff1f</p> <pre><code>select * from tradelog where id='83126';\n</code></pre> <p>\u4f60\u53ef\u4ee5\u5148\u81ea\u5df1\u5206\u6790\u4e00\u4e0b\uff0c\u518d\u5230\u6570\u636e\u5e93\u91cc\u9762\u53bb\u9a8c\u8bc1\u786e\u8ba4\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u7a0d\u5fae\u590d\u6742\u70b9\u7684\u4f8b\u5b50\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_23","title":"\u6848\u4f8b\u4e09\uff1a\u9690\u5f0f\u5b57\u7b26\u7f16\u7801\u8f6c\u6362","text":"<p>\u5047\u8bbe\u7cfb\u7edf\u91cc\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u8868 <code>trade_detail</code>\uff0c\u7528\u4e8e\u8bb0\u5f55\u4ea4\u6613\u7684\u64cd\u4f5c\u7ec6\u8282\u3002\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\u548c\u590d\u73b0\uff0c\u6211\u5f80\u4ea4\u6613\u65e5\u5fd7\u8868 tradelog \u548c\u4ea4\u6613\u8be6\u60c5\u8868 <code>trade_detail</code> \u8fd9\u4e24\u4e2a\u8868\u91cc\u63d2\u5165\u4e00\u4e9b\u6570\u636e\u3002</p> <pre><code>mysql&gt; CREATE TABLE `trade_detail` (\n  `id` int(11) NOT NULL,\n  `tradeid` varchar(32) DEFAULT NULL,\n  `trade_step` int(11) DEFAULT NULL, /* \u64cd\u4f5c\u6b65\u9aa4 */\n  `step_info` varchar(32) DEFAULT NULL, /* \u6b65\u9aa4\u4fe1\u606f */\n  PRIMARY KEY (`id`),\n  KEY `tradeid` (`tradeid`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8; \n\ninsert into trade_detail values(1, 'TRADEID-1', 1, 'add');\ninsert into trade_detail values(2, 'TRADEID-1', 2, 'update');\ninsert into trade_detail values(3, 'TRADEID-1', 3, 'commit');\ninsert into trade_detail values(4, 'TRADEID-2', 1, 'add');\ninsert into trade_detail values(5, 'TRADEID-2', 2, 'update');\ninsert into trade_detail values(6, 'TRADEID-2', 3, 'update again');\ninsert into trade_detail values(7, 'TRADEID-2', 4, 'commit');\ninsert into trade_detail values(8, 'TRADEID-3', 1, 'add');\ninsert into trade_detail values(9, 'TRADEID-3', 2, 'update');\ninsert into trade_detail values(10, 'TRADEID-3', 3, 'update again');\ninsert into trade_detail values(11, 'TRADEID-3', 4, 'commit');\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u8981\u67e5\u8be2 <code>id=2</code> \u7684\u4ea4\u6613\u7684\u6240\u6709\u64cd\u4f5c\u6b65\u9aa4\u4fe1\u606f\uff0cSQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>select d.* from tradelog t, trade_detail d where d.tradeid=t.tradeid and t.id=2; /* \u8bed\u53e5 Q1*/\n</code></pre> <p>explain \u7ed3\u679c</p> <pre><code>mysql&gt; explain select d.* from tradelog t, trade_detail d where d.tradeid=t.tradeid and t.id=2; /* \u8bed\u53e5 Q1*/;\n+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+\n| id | select_type | table | partitions | type  | possible_keys   | key     | key_len | ref   | rows | filtered | Extra       |\n+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+\n|  1 | SIMPLE      | t     | NULL       | const | PRIMARY,tradeid | PRIMARY | 4       | const |    1 |   100.00 | NULL        |\n|  1 | SIMPLE      | d     | NULL       | ALL   | NULL            | NULL    | NULL    | NULL  |   11 |   100.00 | Using where |\n+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-------------+\n</code></pre> <p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u7ed3\u679c\uff1a</p> <ol> <li>\u7b2c\u4e00\u884c\u663e\u793a\u4f18\u5316\u5668\u4f1a\u5148\u5728\u4ea4\u6613\u8bb0\u5f55\u8868 tradelog \u4e0a\u67e5\u5230 id=2 \u7684\u884c\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u7528\u4e0a\u4e86\u4e3b\u952e\u7d22\u5f15\uff0crows=1 \u8868\u793a\u53ea\u626b\u63cf\u4e00\u884c\uff1b</li> <li>\u7b2c\u4e8c\u884c <code>key=NULL</code>\uff0c\u8868\u793a\u6ca1\u6709\u7528\u4e0a\u4ea4\u6613\u8be6\u60c5\u8868 <code>trade_detail</code> \u4e0a\u7684 tradeid \u7d22\u5f15\uff0c\u8fdb\u884c\u4e86\u5168\u8868\u626b\u63cf\u3002</li> </ol> <p>\u5728\u8fd9\u4e2a\u6267\u884c\u8ba1\u5212\u91cc\uff0c\u662f\u4ece tradelog \u8868\u4e2d\u53d6 tradeid \u5b57\u6bb5\uff0c\u518d\u53bb <code>trade_detail</code> \u8868\u91cc\u67e5\u8be2\u5339\u914d\u5b57\u6bb5\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u628a tradelog \u79f0\u4e3a\u9a71\u52a8\u8868\uff0c\u628a <code>trade_detail</code> \u79f0\u4e3a\u88ab\u9a71\u52a8\u8868\uff0c\u628a tradeid \u79f0\u4e3a\u5173\u8054\u5b57\u6bb5\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u770b\u4e0b\u8fd9\u4e2a explain \u7ed3\u679c\u8868\u793a\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <p></p> <p>\u56fe 5 \u8bed\u53e5 Q1 \u7684\u6267\u884c\u8fc7\u7a0b</p> <p>\u56fe\u4e2d\uff1a</p> <ul> <li>\u7b2c 1 \u6b65\uff0c\u662f\u6839\u636e id \u5728 tradelog \u8868\u91cc\u627e\u5230 L2 \u8fd9\u4e00\u884c\uff1b</li> <li>\u7b2c 2 \u6b65\uff0c\u662f\u4ece L2 \u4e2d\u53d6\u51fa tradeid \u5b57\u6bb5\u7684\u503c\uff1b</li> <li>\u7b2c 3 \u6b65\uff0c\u662f\u6839\u636e tradeid \u503c\u5230 <code>trade_detail</code> \u8868\u4e2d\u67e5\u627e\u6761\u4ef6\u5339\u914d\u7684\u884c\u3002explain \u7684\u7ed3\u679c\u91cc\u9762\u7b2c\u4e8c\u884c\u7684 <code>key=NULL</code> \u8868\u793a\u7684\u5c31\u662f\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u901a\u8fc7\u904d\u5386\u4e3b\u952e\u7d22\u5f15\u7684\u65b9\u5f0f\uff0c\u4e00\u4e2a\u4e00\u4e2a\u5730\u5224\u65ad tradeid \u7684\u503c\u662f\u5426\u5339\u914d\u3002</li> </ul> <p>\u8fdb\u884c\u5230\u8fd9\u91cc\uff0c\u4f60\u4f1a\u53d1\u73b0\u7b2c 3 \u6b65\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u3002\u56e0\u4e3a\u8868 <code>trade_detail</code> \u91cc tradeid \u5b57\u6bb5\u4e0a\u662f\u6709\u7d22\u5f15\u7684\uff0c\u6211\u4eec\u672c\u6765\u662f\u5e0c\u671b\u901a\u8fc7\u4f7f\u7528 tradeid \u7d22\u5f15\u80fd\u591f\u5feb\u901f\u5b9a\u4f4d\u5230\u7b49\u503c\u7684\u884c\u3002\u4f46\u8fd9\u91cc\u5e76\u6ca1\u6709\u3002</p> <p>\u5982\u679c\u4f60\u53bb\u95ee DBA \u540c\u5b66\uff0c\u4ed6\u4eec\u53ef\u80fd\u4f1a\u544a\u8bc9\u4f60\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u8868\u7684\u5b57\u7b26\u96c6\u4e0d\u540c\uff0c\u4e00\u4e2a\u662f utf8\uff0c\u4e00\u4e2a\u662f utf8mb4\uff0c\u6240\u4ee5\u505a\u8868\u8fde\u63a5\u67e5\u8be2\u7684\u65f6\u5019\u7528\u4e0d\u4e0a\u5173\u8054\u5b57\u6bb5\u7684\u7d22\u5f15\u3002\u8fd9\u4e2a\u56de\u7b54\uff0c\u4e5f\u662f\u901a\u5e38\u4f60\u641c\u7d22\u8fd9\u4e2a\u95ee\u9898\u65f6\u4f1a\u5f97\u5230\u7684\u7b54\u6848\u3002</p> <p>\u4f46\u662f\u4f60\u5e94\u8be5\u518d\u8ffd\u95ee\u4e00\u4e0b\uff0c\u4e3a\u4ec0\u4e48\u5b57\u7b26\u96c6\u4e0d\u540c\u5c31\u7528\u4e0d\u4e0a\u7d22\u5f15\u5462\uff1f</p> <p>\u6211\u4eec\u8bf4\u95ee\u9898\u662f\u51fa\u5728\u6267\u884c\u6b65\u9aa4\u7684\u7b2c 3 \u6b65\uff0c\u5982\u679c\u5355\u72ec\u628a\u8fd9\u4e00\u6b65\u6539\u6210 SQL \u8bed\u53e5\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\uff1a</p> <pre><code>mysql&gt; select * from trade_detail where tradeid=$L2.tradeid.value; \n</code></pre> <p>\u5176\u4e2d\uff0c<code>$L2.tradeid.value</code> \u7684\u5b57\u7b26\u96c6\u662f <code>utf8mb4</code>\u3002</p> <p>\u53c2\u7167\u524d\u9762\u7684\u4e24\u4e2a\u4f8b\u5b50\uff0c\u4f60\u80af\u5b9a\u5c31\u60f3\u5230\u4e86\uff0c\u5b57\u7b26\u96c6 <code>utf8mb4</code> \u662f utf8 \u7684\u8d85\u96c6\uff0c\u6240\u4ee5\u5f53\u8fd9\u4e24\u4e2a\u7c7b\u578b\u7684\u5b57\u7b26\u4e32\u5728\u505a\u6bd4\u8f83\u7684\u65f6\u5019\uff0cMySQL \u5185\u90e8\u7684\u64cd\u4f5c\u662f\uff0c\u5148\u628a utf8 \u5b57\u7b26\u4e32\u8f6c\u6210 utf8mb4 \u5b57\u7b26\u96c6\uff0c\u518d\u505a\u6bd4\u8f83\u3002</p> <p>\u56e0\u6b64\uff0c \u5728\u6267\u884c\u4e0a\u9762\u8fd9\u4e2a\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u9700\u8981\u5c06\u88ab\u9a71\u52a8\u6570\u636e\u8868\u91cc\u7684\u5b57\u6bb5\u4e00\u4e2a\u4e2a\u5730\u8f6c\u6362\u6210 <code>utf8mb4</code>\uff0c\u518d\u8ddf L2 \u505a\u6bd4\u8f83\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u8bed\u53e5\u7b49\u540c\u4e8e\u4e0b\u9762\u8fd9\u4e2a\u5199\u6cd5\uff1a</p> <pre><code>select * from trade_detail  where CONVERT(traideid USING utf8mb4)=$L2.tradeid.value; \n</code></pre> <p>CONVERT() \u51fd\u6570\uff0c\u5728\u8fd9\u91cc\u7684\u610f\u601d\u662f\u628a\u8f93\u5165\u7684\u5b57\u7b26\u4e32\u8f6c\u6210 utf8mb4 \u5b57\u7b26\u96c6\u3002</p> <p>\u8fd9\u5c31\u518d\u6b21\u89e6\u53d1\u4e86\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u539f\u5219\uff1a\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u4f18\u5316\u5668\u4f1a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u4f60\u7ec8\u4e8e\u660e\u786e\u4e86\uff0c\u5b57\u7b26\u96c6\u4e0d\u540c\u53ea\u662f\u6761\u4ef6\u4e4b\u4e00\uff0c\u8fde\u63a5\u8fc7\u7a0b\u4e2d\u8981\u6c42\u5728\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u5b57\u6bb5\u4e0a\u52a0\u51fd\u6570\u64cd\u4f5c\uff0c\u662f\u76f4\u63a5\u5bfc\u81f4\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u5168\u8868\u626b\u63cf\u7684\u539f\u56e0\u3002</p> <p>\u4f5c\u4e3a\u5bf9\u6bd4\u9a8c\u8bc1\uff0c\u6211\u7ed9\u4f60\u63d0\u53e6\u5916\u4e00\u4e2a\u9700\u6c42\uff0c\u201c\u67e5\u627e trade_detail \u8868\u91cc id=4 \u7684\u64cd\u4f5c\uff0c\u5bf9\u5e94\u7684\u64cd\u4f5c\u8005\u662f\u8c01\u201d\uff0c\u518d\u6765\u770b\u4e0b\u8fd9\u4e2a\u8bed\u53e5\u548c\u5b83\u7684\u6267\u884c\u8ba1\u5212\u3002</p> <pre><code>mysql&gt;select l.operator from tradelog l , trade_detail d where d.tradeid=l.tradeid and d.id=4;\n</code></pre> <p>explain \u7ed3\u679c</p> <pre><code>mysql&gt; explain select l.operator from tradelog l , trade_detail d where d.tradeid=l.tradeid and d.id=4;\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | d     | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |\n|  1 | SIMPLE      | l     | NULL       | ref   | tradeid       | tradeid | 131     | const |    1 |   100.00 | NULL  |\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u91cc <code>trade_detail</code> \u8868\u6210\u4e86\u9a71\u52a8\u8868\uff0c\u4f46\u662f explain \u7ed3\u679c\u7684\u7b2c\u4e8c\u884c\u663e\u793a\uff0c\u8fd9\u6b21\u7684\u67e5\u8be2\u64cd\u4f5c\u7528\u4e0a\u4e86\u88ab\u9a71\u52a8\u8868 tradelog \u91cc\u7684\u7d22\u5f15 (tradeid)\uff0c\u626b\u63cf\u884c\u6570\u662f 1\u3002</p> <p>\u8fd9\u4e5f\u662f\u4e24\u4e2a tradeid \u5b57\u6bb5\u7684 join \u64cd\u4f5c\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u6b21\u80fd\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684 tradeid \u7d22\u5f15\u5462\uff1f\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u3002</p> <p>\u5047\u8bbe\u9a71\u52a8\u8868 trade_detail \u91cc id=4 \u7684\u884c\u8bb0\u4e3a R4\uff0c\u90a3\u4e48\u5728\u8fde\u63a5\u7684\u65f6\u5019\uff08\u56fe 5 \u7684\u7b2c 3 \u6b65\uff09\uff0c\u88ab\u9a71\u52a8\u8868 tradelog \u4e0a\u6267\u884c\u7684\u5c31\u662f\u7c7b\u4f3c\u8fd9\u6837\u7684 SQL \u8bed\u53e5\uff1a</p> <pre><code>select operator from tradelog  where traideid =$R4.tradeid.value; \n</code></pre> <p>\u8fd9\u65f6\u5019 $R4.tradeid.value \u7684\u5b57\u7b26\u96c6\u662f utf8, \u6309\u7167\u5b57\u7b26\u96c6\u8f6c\u6362\u89c4\u5219\uff0c\u8981\u8f6c\u6210 utf8mb4\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u88ab\u6539\u5199\u6210\uff1a</p> <pre><code>select operator from tradelog  where traideid =CONVERT($R4.tradeid.value USING utf8mb4); \n</code></pre> <p>\u4f60\u770b\uff0c\u8fd9\u91cc\u7684 CONVERT \u51fd\u6570\u662f\u52a0\u5728\u8f93\u5165\u53c2\u6570\u4e0a\u7684\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684 traideid \u7d22\u5f15\u3002</p> <p>\u7406\u89e3\u4e86\u539f\u7406\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u7528\u6765\u6307\u5bfc\u64cd\u4f5c\u4e86\u3002\u5982\u679c\u8981\u4f18\u5316\u8bed\u53e5</p> <pre><code>select d.* from tradelog l, trade_detail d where d.tradeid=l.tradeid and l.id=2;\n</code></pre> <p>\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p> <ul> <li> <p>\u6bd4\u8f83\u5e38\u89c1\u7684\u4f18\u5316\u65b9\u6cd5\u662f\uff0c\u628a <code>trade_detail</code> \u8868\u4e0a\u7684 tradeid \u5b57\u6bb5\u7684\u5b57\u7b26\u96c6\u4e5f\u6539\u6210 utf8mb4\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u5b57\u7b26\u96c6\u8f6c\u6362\u7684\u95ee\u9898\u4e86\u3002</p> <p><code>alter table trade_detail modify tradeid varchar(32) CHARACTER SET utf8mb4 default null;</code></p> </li> <li> <p>\u5982\u679c\u80fd\u591f\u4fee\u6539\u5b57\u6bb5\u7684\u5b57\u7b26\u96c6\u7684\u8bdd\uff0c\u662f\u6700\u597d\u4e0d\u8fc7\u4e86\u3002\u4f46\u5982\u679c\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c \u6216\u8005\u4e1a\u52a1\u4e0a\u6682\u65f6\u4e0d\u80fd\u505a\u8fd9\u4e2a DDL \u7684\u8bdd\uff0c\u90a3\u5c31\u53ea\u80fd\u91c7\u7528\u4fee\u6539 SQL \u8bed\u53e5\u7684\u65b9\u6cd5\u4e86\u3002</p> <p><code>mysql&gt; select d.* from tradelog l , trade_detail d where d.tradeid=CONVERT(l.tradeid USING utf8) and l.id=2;</code></p> </li> </ul> <p>SQL \u8bed\u53e5\u4f18\u5316\u540e\u7684 explain \u7ed3\u679c</p> <pre><code>mysql&gt; explain select d.* from tradelog l , trade_detail d where d.tradeid=CONVERT(l.tradeid USING utf8) and l.id=2;\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | l     | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |\n|  1 | SIMPLE      | d     | NULL       | ref   | tradeid       | tradeid | 99      | const |    4 |   100.00 | NULL  |\n+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u4e3b\u52a8\u628a l.tradeid \u8f6c\u6210 utf8\uff0c\u5c31\u907f\u514d\u4e86\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u5b57\u7b26\u7f16\u7801\u8f6c\u6362\uff0c\u4ece explain \u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6b21\u7d22\u5f15\u8d70\u5bf9\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_24","title":"\u6848\u4f8b\u56db\uff1a\u8d85\u8fc7\u5b57\u6bb5\u957f\u5ea6\u67e5\u8be2","text":"<p>\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>mysql&gt; CREATE TABLE `table_a` (\n  `id` int(11) NOT NULL,\n  `b` varchar(10) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `b` (`b`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u5047\u8bbe\u73b0\u5728\u8868\u91cc\u9762\uff0c\u6709 100 \u4e07\u884c\u6570\u636e\uff0c\u5176\u4e2d\u6709 10 \u4e07\u884c\u6570\u636e\u7684 b \u7684\u503c\u662f\u20191234567890\u2019\uff0c \u5047\u8bbe\u73b0\u5728\u6267\u884c\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684:</p> <pre><code>mysql&gt; select * from table_a where b='1234567890abcd';\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0cMySQL \u4f1a\u600e\u4e48\u6267\u884c\u5462\uff1f</p> <p>\u6700\u7406\u60f3\u7684\u60c5\u51b5\u662f\uff0cMySQL \u770b\u5230\u5b57\u6bb5 b \u5b9a\u4e49\u7684\u662f <code>varchar(10)</code>\uff0c\u90a3\u80af\u5b9a\u8fd4\u56de\u7a7a\u5440\u3002\u53ef\u60dc\uff0cMySQL \u5e76\u6ca1\u6709\u8fd9\u4e48\u505a\u3002</p> <p>\u90a3\u8981\u4e0d\uff0c\u5c31\u662f\u628a <code>'1234567890abcd'</code> \u62ff\u5230\u7d22\u5f15\u91cc\u9762\u53bb\u505a\u5339\u914d\uff0c\u80af\u5b9a\u4e5f\u6ca1\u80fd\u591f\u5feb\u901f\u5224\u65ad\u51fa\u7d22\u5f15\u6811 b \u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e2a\u503c\uff0c\u4e5f\u5f88\u5feb\u5c31\u80fd\u8fd4\u56de\u7a7a\u7ed3\u679c\u3002</p> <p>\u4f46\u5b9e\u9645\u4e0a\uff0cMySQL \u4e5f\u4e0d\u662f\u8fd9\u4e48\u505a\u7684\u3002</p> <p>\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u6267\u884c\u5f88\u6162\uff0c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5728\u4f20\u7ed9\u5f15\u64ce\u6267\u884c\u7684\u65f6\u5019\uff0c\u505a\u4e86\u5b57\u7b26\u622a\u65ad\u3002\u56e0\u4e3a\u5f15\u64ce\u91cc\u9762\u8fd9\u4e2a\u884c\u53ea\u5b9a\u4e49\u4e86\u957f\u5ea6\u662f 10\uff0c\u6240\u4ee5\u53ea\u622a\u4e86\u524d 10 \u4e2a\u5b57\u8282\uff0c\u5c31\u662f <code>'1234567890'</code> \u8fdb\u53bb\u505a\u5339\u914d\uff1b</li> <li>\u8fd9\u6837\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u6709 10 \u4e07\u884c\uff1b</li> <li>\u56e0\u4e3a\u662f <code>select *</code>\uff0c \u6240\u4ee5\u8981\u505a 10 \u4e07\u6b21\u56de\u8868\uff1b</li> <li>\u4f46\u662f\u6bcf\u6b21\u56de\u8868\u4ee5\u540e\u67e5\u51fa\u6574\u884c\uff0c\u5230 server \u5c42\u4e00\u5224\u65ad\uff0cb \u7684\u503c\u90fd\u4e0d\u662f <code>\u20191234567890abcd'</code></li> <li>\u8fd4\u56de\u7ed3\u679c\u662f\u7a7a\u3002</li> </ol> <p>\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u662f\u6211\u4eec\u6587\u7ae0\u5185\u5bb9\u7684\u4e00\u4e2a\u5f88\u597d\u7684\u8865\u5145\u3002\u867d\u7136\u6267\u884c\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u7ecf\u8fc7\u51fd\u6570\u64cd\u4f5c\uff0c\u4f46\u662f\u6700\u7ec8\u5728\u62ff\u5230\u7ed3\u679c\u540e\uff0cserver \u5c42\u8fd8\u662f\u8981\u505a\u4e00\u8f6e\u5224\u65ad\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_25","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u6211\u7ed9\u4f60\u4e3e\u4e86\u4e09\u4e2a\u4f8b\u5b50\uff0c\u5176\u5b9e\u662f\u5728\u8bf4\u540c\u4e00\u4ef6\u4e8b\u513f\uff0c\u5373\uff1a\u5bf9\u7d22\u5f15\u5b57\u6bb5\u505a\u51fd\u6570\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u7d22\u5f15\u503c\u7684\u6709\u5e8f\u6027\uff0c\u56e0\u6b64\u4f18\u5316\u5668\u5c31\u51b3\u5b9a\u653e\u5f03\u8d70\u6811\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u662f\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362\uff0c\u7b2c\u4e09\u4e2a\u4f8b\u5b50\u662f\u9690\u5f0f\u5b57\u7b26\u7f16\u7801\u8f6c\u6362\uff0c\u5b83\u4eec\u90fd\u8ddf\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u56e0\u4e3a\u8981\u6c42\u5728\u7d22\u5f15\u5b57\u6bb5\u4e0a\u505a\u51fd\u6570\u64cd\u4f5c\u800c\u5bfc\u81f4\u4e86\u5168\u7d22\u5f15\u626b\u63cf\u3002</p> <p>MySQL \u7684\u4f18\u5316\u5668\u786e\u5b9e\u6709\u201c\u5077\u61d2\u201d\u7684\u5acc\u7591\uff0c\u5373\u4f7f\u7b80\u5355\u5730\u628a where id+1=1000 \u6539\u5199\u6210 where id=1000-1 \u5c31\u80fd\u591f\u7528\u4e0a\u7d22\u5f15\u5feb\u901f\u67e5\u627e\uff0c\u4e5f\u4e0d\u4f1a\u4e3b\u52a8\u505a\u8fd9\u4e2a\u8bed\u53e5\u91cd\u5199\u3002</p> <p>\u56e0\u6b64\uff0c\u6bcf\u6b21\u4f60\u7684\u4e1a\u52a1\u4ee3\u7801\u5347\u7ea7\u65f6\uff0c\u628a\u53ef\u80fd\u51fa\u73b0\u7684\u3001\u65b0\u7684 SQL \u8bed\u53e5 explain \u4e00\u4e0b\uff0c\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4e60\u60ef\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#19","title":"19 \u4e3a\u4ec0\u4e48\u6211\u53ea\u67e5\u4e00\u884c\u7684\u8bed\u53e5\uff0c\u4e5f\u6267\u884c\u8fd9\u4e48\u6162\uff1f","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6211\u8ddf\u4f60\u8bf4\u67e5\u8be2\u6027\u80fd\u4f18\u5316\uff0c\u4f60\u9996\u5148\u4f1a\u60f3\u5230\u4e00\u4e9b\u590d\u6742\u7684\u8bed\u53e5\uff0c\u60f3\u5230\u67e5\u8be2\u9700\u8981\u8fd4\u56de\u5927\u91cf\u7684\u6570\u636e\u3002\u4f46\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u201c\u67e5\u4e00\u884c\u201d\uff0c\u4e5f\u4f1a\u6267\u884c\u5f97\u7279\u522b\u6162\u3002\u4eca\u5929\uff0c\u6211\u5c31\u8ddf\u4f60\u804a\u804a\u8fd9\u4e2a\u6709\u8da3\u7684\u8bdd\u9898\uff0c\u770b\u770b\u4ec0\u4e48\u60c5\u51b5\u4e0b\uff0c\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u73b0\u8c61\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5982\u679c MySQL \u6570\u636e\u5e93\u672c\u8eab\u5c31\u6709\u5f88\u5927\u7684\u538b\u529b\uff0c\u5bfc\u81f4\u6570\u636e\u5e93\u670d\u52a1\u5668 CPU \u5360\u7528\u7387\u5f88\u9ad8\u6216 ioutil\uff08IO \u5229\u7528\u7387\uff09\u5f88\u9ad8\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6240\u6709\u8bed\u53e5\u7684\u6267\u884c\u90fd\u6709\u53ef\u80fd\u53d8\u6162\uff0c\u4e0d\u5c5e\u4e8e\u6211\u4eec\u4eca\u5929\u7684\u8ba8\u8bba\u8303\u56f4\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0\uff0c\u6211\u8fd8\u662f\u6784\u9020\u4e00\u4e2a\u8868\uff0c\u57fa\u4e8e\u8fd9\u4e2a\u8868\u6765\u8bf4\u660e\u4eca\u5929\u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u8868\u6709\u4e24\u4e2a\u5b57\u6bb5 id \u548c c\uff0c\u5e76\u4e14\u6211\u5728\u91cc\u9762\u63d2\u5165\u4e86 10 \u4e07\u884c\u8bb0\u5f55\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=100000)do\n    insert into t values(i,i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ; \ncall idata();\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4f1a\u7528\u51e0\u4e2a\u4e0d\u540c\u7684\u573a\u666f\u6765\u4e3e\u4f8b\uff0c\u6709\u4e9b\u662f\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u6211\u4eec\u5df2\u7ecf\u4ecb\u7ecd\u8fc7\u7684\u77e5\u8bc6\u70b9\uff0c\u4f60\u770b\u770b\u80fd\u4e0d\u80fd\u4e00\u773c\u770b\u7a7f\uff0c\u6765\u68c0\u9a8c\u4e00\u4e0b\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#flush","title":"\u7b49 flush","text":"<p>\u6211\u5728\u8868 t \u4e0a\uff0c\u6267\u884c\u4e0b\u9762\u7684 SQL \u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select * from information_schema.processlist where id=1;\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u5148\u5356\u4e2a\u5173\u5b50\u3002</p> <p>\u6211\u67e5\u51fa\u6765\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u662f <code>Waiting for table flush</code>\uff0c\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p> <pre><code>mysql&gt; select * from information_schema.PROCESSLIST where id=6;\n+----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+\n| ID | USER            | HOST      | DB   | COMMAND | TIME  | STATE                  | INFO                       |\n+----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+\n| 6  | root            | localhost | test | Query   |   622 | Waiting for table flush| select * from t where id= 1|\n+----+-----------------+-----------+------+---------+-------+------------------------+----------------------------+\n</code></pre> <p>\u8fd9\u4e2a\u72b6\u6001\u8868\u793a\u7684\u662f\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6b63\u8981\u5bf9\u8868 t \u505a flush \u64cd\u4f5c\u3002MySQL \u91cc\u9762\u5bf9\u8868\u505a flush \u64cd\u4f5c\u7684\u7528\u6cd5\uff0c\u4e00\u822c\u6709\u4ee5\u4e0b\u4e24\u4e2a\uff1a</p> <pre><code>flush tables t with read lock; \nflush tables with read lock;\n</code></pre> <p>\u8fd9\u4e24\u4e2a flush \u8bed\u53e5\uff0c\u5982\u679c\u6307\u5b9a\u8868 t \u7684\u8bdd\uff0c\u4ee3\u8868\u7684\u662f\u53ea\u5173\u95ed\u8868 t\uff1b\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5177\u4f53\u7684\u8868\u540d\uff0c\u5219\u8868\u793a\u5173\u95ed MySQL \u91cc\u6240\u6709\u6253\u5f00\u7684\u8868\u3002</p> <p>\u4f46\u662f\u6b63\u5e38\u8fd9\u4e24\u4e2a\u8bed\u53e5\u6267\u884c\u8d77\u6765\u90fd\u5f88\u5feb\uff0c\u9664\u975e\u5b83\u4eec\u4e5f\u88ab\u522b\u7684\u7ebf\u7a0b\u5835\u4f4f\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u51fa\u73b0 Waiting for table flush \u72b6\u6001\u7684\u53ef\u80fd\u60c5\u51b5\u662f\uff1a\u6709\u4e00\u4e2a flush tables \u547d\u4ee4\u88ab\u522b\u7684\u8bed\u53e5\u5835\u4f4f\u4e86\uff0c\u7136\u540e\u5b83\u53c8\u5835\u4f4f\u4e86\u6211\u4eec\u7684 select \u8bed\u53e5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_26","title":"\u7b49\u884c\u9501","text":"<p>\u73b0\u5728\uff0c\u7ecf\u8fc7\u4e86\u8868\u7ea7\u9501\u7684\u8003\u9a8c\uff0c\u6211\u4eec\u7684 select \u8bed\u53e5\u7ec8\u4e8e\u6765\u5230\u5f15\u64ce\u91cc\u4e86\u3002</p> <pre><code>mysql&gt; select * from t where id=1 lock in share mode; \n</code></pre> <p>\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\u7684\u7528\u6cd5\u4f60\u4e5f\u5f88\u719f\u6089\u4e86\uff0c\u6211\u4eec\u5728\u7b2c 8 \u7bc7[\u300a\u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f\u300b]\u6587\u7ae0\u4ecb\u7ecd\u5f53\u524d\u8bfb\u65f6\u63d0\u5230\u8fc7\u3002</p> <p>\u7531\u4e8e\u8bbf\u95ee id=1 \u8fd9\u4e2a\u8bb0\u5f55\u65f6\u8981\u52a0\u8bfb\u9501\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u5df2\u7ecf\u6709\u4e00\u4e2a\u4e8b\u52a1\u5728\u8fd9\u884c\u8bb0\u5f55\u4e0a\u6301\u6709\u4e00\u4e2a\u5199\u9501\uff0c\u6211\u4eec\u7684 select \u8bed\u53e5\u5c31\u4f1a\u88ab\u5835\u4f4f\u3002</p> <p>\u590d\u73b0\u6b65\u9aa4\u548c\u73b0\u573a\u5982\u4e0b\uff1a</p> Session A Session B begin;update t set c  = c + 1 where id = 1; <code>select * from where id = 1 lock in share mode;</code> <p>\u884c\u9501\u590d\u73b0</p> <pre><code>mysql&gt; show processlist;\n+----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+\n| Id | User            | Host      | db   | Command | Time  | State                  | Info                                          |\n+----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+\n|  4 | event_scheduler | localhost | NULL | Daemon  | 75402 | Waiting on empty queue | NULL                                          |\n| 20 | root            | localhost | test | Query   |     0 | starting               | show processlist                              |\n| 21 | root            | localhost | test | Query   |     7 | statistics             | select * from t where id=1 lock in share mode |\n+----+-----------------+-----------+------+---------+-------+------------------------+-----------------------------------------------+\n3 rows in set (0.00 sec)\n</code></pre> <p>\u663e\u7136\uff0csession A \u542f\u52a8\u4e86\u4e8b\u52a1\uff0c\u5360\u6709\u5199\u9501\uff0c\u8fd8\u4e0d\u63d0\u4ea4\uff0c\u662f\u5bfc\u81f4 session B \u88ab\u5835\u4f4f\u7684\u539f\u56e0\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\u5e76\u4e0d\u96be\u5206\u6790\uff0c\u4f46\u95ee\u9898\u662f\u600e\u4e48\u67e5\u51fa\u662f\u8c01\u5360\u7740\u8fd9\u4e2a\u5199\u9501\u3002\u5982\u679c\u4f60\u7528\u7684\u662f MySQL 5.7 \u7248\u672c\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>sys.innodb_lock_waits</code> \u8868\u67e5\u5230\u3002</p> <p>\u67e5\u8be2\u65b9\u6cd5\u662f\uff1a</p> <pre><code>mysql&gt; select * from sys.innodb_lock_waits where locked_table='`test`.`t`' \\G;\n\n*************************** 1. row ***************************\n                wait_started: 2023-02-01 11:57:20\n                    wait_age: 00:00:01\n               wait_age_secs: 1\n                locked_table: `test`.`t`\n         locked_table_schema: test\n           locked_table_name: t\n      locked_table_partition: NULL\n   locked_table_subpartition: NULL\n                locked_index: PRIMARY\n                 locked_type: RECORD\n              waiting_trx_id: 421933896469888\n         waiting_trx_started: 2023-02-01 11:57:20\n             waiting_trx_age: 00:00:01\n     waiting_trx_rows_locked: 1\n   waiting_trx_rows_modified: 0\n                 waiting_pid: 21\n               waiting_query: select * from t where id=1 lock in share mode\n             waiting_lock_id: 140458919759232:488:4:3:140458768951320\n           waiting_lock_mode: S,REC_NOT_GAP\n             blocking_trx_id: 588483\n                blocking_pid: 20\n              blocking_query: select * from sys.innodb_lock_waits where locked_table='`test`.`t`'\n            blocking_lock_id: 140458919758376:488:4:3:140458768946712\n          blocking_lock_mode: X,REC_NOT_GAP\n        blocking_trx_started: 2023-02-01 11:56:23\n            blocking_trx_age: 00:00:58\n    blocking_trx_rows_locked: 1\n  blocking_trx_rows_modified: 0\n     sql_kill_blocking_query: KILL QUERY 20\nsql_kill_blocking_connection: KILL 20\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u4fe1\u606f\u5f88\u5168\uff0c20 \u53f7\u7ebf\u7a0b\u662f\u9020\u6210\u5835\u585e\u7684\u7f6a\u9b41\u7978\u9996\u3002\u800c\u5e72\u6389\u8fd9\u4e2a\u7f6a\u9b41\u7978\u9996\u7684\u65b9\u5f0f\uff0c\u5c31\u662f <code>KILL QUERY 20</code> \u6216 <code>KILL 20</code>\u3002</p> <p>\u4e0d\u8fc7\uff0c\u8fd9\u91cc\u4e0d\u5e94\u8be5\u663e\u793a <code>KILL QUERY 20</code>\u3002\u8fd9\u4e2a\u547d\u4ee4\u8868\u793a\u505c\u6b62 20 \u53f7\u7ebf\u7a0b\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\uff0c\u800c\u8fd9\u4e2a\u65b9\u6cd5\u5176\u5b9e\u662f\u6ca1\u6709\u7528\u7684\u3002\u56e0\u4e3a\u5360\u6709\u884c\u9501\u7684\u662f update \u8bed\u53e5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u5df2\u7ecf\u662f\u4e4b\u524d\u6267\u884c\u5b8c\u6210\u4e86\u7684\uff0c\u73b0\u5728\u6267\u884c KILL QUERY\uff0c\u65e0\u6cd5\u8ba9\u8fd9\u4e2a\u4e8b\u52a1\u53bb\u6389 id=1 \u4e0a\u7684\u884c\u9501\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0cKILL 20 \u624d\u6709\u6548\uff0c\u4e5f\u5c31\u662f\u8bf4\u76f4\u63a5\u65ad\u5f00\u8fd9\u4e2a\u8fde\u63a5\u3002\u8fd9\u91cc\u9690\u542b\u7684\u4e00\u4e2a\u903b\u8f91\u5c31\u662f\uff0c\u8fde\u63a5\u88ab\u65ad\u5f00\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u56de\u6eda\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u6b63\u5728\u6267\u884c\u7684\u7ebf\u7a0b\uff0c\u4e5f\u5c31\u91ca\u653e\u4e86 id=1 \u4e0a\u7684\u884c\u9501\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-2/#_27","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u6211\u7ed9\u4f60\u4e3e\u4e86\u5728\u4e00\u4e2a\u7b80\u5355\u7684\u8868\u4e0a\uff0c\u6267\u884c\u201c\u67e5\u4e00\u884c\u201d\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u7684\u88ab\u9501\u4f4f\u548c\u6267\u884c\u6162\u7684\u4f8b\u5b50\u3002\u8fd9\u5176\u4e2d\u6d89\u53ca\u5230\u4e86\u8868\u9501\u3001\u884c\u9501\u548c\u4e00\u81f4\u6027\u8bfb\u7684\u6982\u5ff5\u3002</p> <p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u78b0\u5230\u7684\u573a\u666f\u4f1a\u66f4\u590d\u6742\u3002\u4f46\u5927\u540c\u5c0f\u5f02\uff0c\u4f60\u53ef\u4ee5\u6309\u7167\u6211\u5728\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u7684\u5b9a\u4f4d\u65b9\u6cd5\uff0c\u6765\u5b9a\u4f4d\u5e76\u89e3\u51b3\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/","title":"\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e09\u90e8\u5206","text":"<p>Source</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e09\u90e8\u5206</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#20","title":"20 \u5e7b\u8bfb\u662f\u4ec0\u4e48\uff0c\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e86\u4e00\u4e2a\u5173\u4e8e\u52a0\u9501\u89c4\u5219\u7684\u95ee\u9898\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u8bf4\u8d77\u5427\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\u95ee\u9898\uff0c\u8fd9\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u5148\u4f7f\u7528\u4e00\u4e2a\u5c0f\u4e00\u70b9\u513f\u7684\u8868\u3002\u5efa\u8868\u548c\u521d\u59cb\u5316\u8bed\u53e5\u5982\u4e0b\uff08\u4e3a\u4e86\u4fbf\u4e8e\u672c\u671f\u7684\u4f8b\u5b50\u8bf4\u660e\uff0c\u6211\u628a\u4e0a\u7bc7\u6587\u7ae0\u4e2d\u7528\u5230\u7684\u8868\u7ed3\u6784\u505a\u4e86\u70b9\u513f\u4fee\u6539\uff09\uff1a</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `c` (`c`)\n) ENGINE=InnoDB; \ninsert into t values(0,0,0),(5,5,5),\n(10,10,10),(15,15,15),(20,20,20),(25,25,25);\n</code></pre> <p>\u8fd9\u4e2a\u8868\u9664\u4e86\u4e3b\u952e id \u5916\uff0c\u8fd8\u6709\u4e00\u4e2a\u7d22\u5f15 c\uff0c\u521d\u59cb\u5316\u8bed\u53e5\u5728\u8868\u4e2d\u63d2\u5165\u4e86 6 \u884c\u6570\u636e\u3002</p> <p>\u4e0a\u671f\u6211\u7559\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u5e8f\u5217\uff0c\u662f\u600e\u4e48\u52a0\u9501\u7684\uff0c\u52a0\u7684\u9501\u53c8\u662f\u4ec0\u4e48\u65f6\u5019\u91ca\u653e\u7684\u5462\uff1f</p> <pre><code>begin;\nselect * from t where d=5 for update;\ncommit;\n</code></pre> <p>\u6bd4\u8f83\u597d\u7406\u89e3\u7684\u662f\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u547d\u4e2d d=5 \u7684\u8fd9\u4e00\u884c\uff0c\u5bf9\u5e94\u7684\u4e3b\u952e id=5\uff0c\u56e0\u6b64\u5728 select \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0cid=5 \u8fd9\u4e00\u884c\u4f1a\u52a0\u4e00\u4e2a\u5199\u9501\uff0c\u800c\u4e14\u7531\u4e8e\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u8fd9\u4e2a\u5199\u9501\u4f1a\u5728\u6267\u884c commit \u8bed\u53e5\u7684\u65f6\u5019\u91ca\u653e\u3002</p> <p>\u7531\u4e8e\u5b57\u6bb5 d \u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u56e0\u6b64\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u4f1a\u505a\u5168\u8868\u626b\u63cf\u3002\u90a3\u4e48\uff0c\u5176\u4ed6\u88ab\u626b\u63cf\u5230\u7684\uff0c\u4f46\u662f\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684 5 \u884c\u8bb0\u5f55\u4e0a\uff0c\u4f1a\u4e0d\u4f1a\u88ab\u52a0\u9501\u5462\uff1f</p> <p>\u6211\u4eec\u77e5\u9053\uff0cInnoDB \u7684\u9ed8\u8ba4\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u662f\u53ef\u91cd\u590d\u8bfb\uff0c\u6240\u4ee5\u672c\u6587\u63a5\u4e0b\u6765\u6ca1\u6709\u7279\u6b8a\u8bf4\u660e\u7684\u90e8\u5206\uff0c\u90fd\u662f\u8bbe\u5b9a\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_1","title":"\u5e7b\u8bfb\u662f\u4ec0\u4e48\uff1f","text":"<p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u6765\u5206\u6790\u4e00\u4e0b\uff0c\u5982\u679c\u53ea\u5728 id=5 \u8fd9\u4e00\u884c\u52a0\u9501\uff0c\u800c\u5176\u4ed6\u884c\u7684\u4e0d\u52a0\u9501\u7684\u8bdd\uff0c\u4f1a\u600e\u4e48\u6837\u3002</p> <p>\u4e0b\u9762\u5148\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\uff08\u6ce8\u610f\uff1a\u8fd9\u662f\u6211\u5047\u8bbe\u7684\u4e00\u4e2a\u573a\u666f\uff09\uff1a</p> Session A Session B Session C T1 begin;select * from t where d=5 fro update; /Q1///result: (5,5,5) T2 update t set d=5 where id=0; T3 select * from t where d=5 fro update; /Q2///result: (0,0,5), (5,5,5) T4 insert into t values(1,1,5); T5 select * from t where d=5 fro update; /Q3///result: (0,0,5),(1,1,5),(5,5,5) T6 commit; <p>\u53ef\u4ee5\u770b\u5230\uff0csession A \u91cc\u6267\u884c\u4e86\u4e09\u6b21\u67e5\u8be2\uff0c\u5206\u522b\u662f Q1\u3001Q2 \u548c Q3\u3002\u5b83\u4eec\u7684 SQL \u8bed\u53e5\u76f8\u540c\uff0c\u90fd\u662f <code>select * from t where d=5 for update</code>\u3002\u8fd9\u4e2a\u8bed\u53e5\u7684\u610f\u601d\u4f60\u5e94\u8be5\u5f88\u6e05\u695a\u4e86\uff0c\u67e5\u6240\u6709 d=5 \u7684\u884c\uff0c\u800c\u4e14\u4f7f\u7528\u7684\u662f\u5f53\u524d\u8bfb\uff0c\u5e76\u4e14\u52a0\u4e0a\u5199\u9501\u3002\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\uff0c\u5206\u522b\u4f1a\u8fd4\u56de\u4ec0\u4e48\u7ed3\u679c\u3002</p> <ol> <li>Q1 \u53ea\u8fd4\u56de id=5 \u8fd9\u4e00\u884c\uff1b</li> <li>\u5728 T2 \u65f6\u523b\uff0csession B \u628a id=0 \u8fd9\u4e00\u884c\u7684 d \u503c\u6539\u6210\u4e86 5\uff0c\u56e0\u6b64 T3 \u65f6\u523b Q2 \u67e5\u51fa\u6765\u7684\u662f id=0 \u548c id=5 \u8fd9\u4e24\u884c\uff1b</li> <li>\u5728 T4 \u65f6\u523b\uff0csession C \u53c8\u63d2\u5165\u4e00\u884c<code>\uff081,1,5\uff09</code>\uff0c\u56e0\u6b64 T5 \u65f6\u523b Q3 \u67e5\u51fa\u6765\u7684\u662f id=0\u3001id=1 \u548c id=5 \u7684\u8fd9\u4e09\u884c\u3002</li> </ol> <p>\u5176\u4e2d\uff0cQ3 \u8bfb\u5230 id=1 \u8fd9\u4e00\u884c\u7684\u73b0\u8c61\uff0c\u88ab\u79f0\u4e3a\u201c\u5e7b\u8bfb\u201d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5e7b\u8bfb\u6307\u7684\u662f\u4e00\u4e2a\u4e8b\u52a1\u5728\u524d\u540e\u4e24\u6b21\u67e5\u8be2\u540c\u4e00\u4e2a\u8303\u56f4\u7684\u65f6\u5019\uff0c\u540e\u4e00\u6b21\u67e5\u8be2\u770b\u5230\u4e86\u524d\u4e00\u6b21\u67e5\u8be2\u6ca1\u6709\u770b\u5230\u7684\u884c\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5bf9\u201c\u5e7b\u8bfb\u201d\u505a\u4e00\u4e2a\u8bf4\u660e\uff1a</p> <ol> <li>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u666e\u901a\u7684\u67e5\u8be2\u662f\u5feb\u7167\u8bfb\uff0c\u662f\u4e0d\u4f1a\u770b\u5230\u522b\u7684\u4e8b\u52a1\u63d2\u5165\u7684\u6570\u636e\u7684\u3002\u56e0\u6b64\uff0c\u5e7b\u8bfb\u5728\u201c\u5f53\u524d\u8bfb\u201d\u4e0b\u624d\u4f1a\u51fa\u73b0\u3002</li> <li>\u4e0a\u9762 session B \u7684\u4fee\u6539\u7ed3\u679c\uff0c\u88ab session A \u4e4b\u540e\u7684 select \u8bed\u53e5\u7528\u201c\u5f53\u524d\u8bfb\u201d\u770b\u5230\uff0c\u4e0d\u80fd\u79f0\u4e3a\u5e7b\u8bfb\u3002\u5e7b\u8bfb\u4ec5\u4e13\u6307\u201c\u65b0\u63d2\u5165\u7684\u884c\u201d\u3002</li> </ol> <p>\u5982\u679c\u53ea\u4ece\u7b2c 8 \u7bc7\u6587\u7ae0[\u300a\u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684\uff1f\u300b]\u6211\u4eec\u5b66\u5230\u7684\u4e8b\u52a1\u53ef\u89c1\u6027\u89c4\u5219\u6765\u5206\u6790\u7684\u8bdd\uff0c\u4e0a\u9762\u8fd9\u4e09\u6761 SQL \u8bed\u53e5\u7684\u8fd4\u56de\u7ed3\u679c\u90fd\u6ca1\u6709\u95ee\u9898\u3002</p> <p>\u56e0\u4e3a\u8fd9\u4e09\u4e2a\u67e5\u8be2\u90fd\u662f\u52a0\u4e86 for update\uff0c\u90fd\u662f\u5f53\u524d\u8bfb\u3002\u800c\u5f53\u524d\u8bfb\u7684\u89c4\u5219\uff0c\u5c31\u662f\u8981\u80fd\u8bfb\u5230\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u8bb0\u5f55\u7684\u6700\u65b0\u503c\u3002\u5e76\u4e14\uff0csession B \u548c sessionC \u7684\u4e24\u6761\u8bed\u53e5\uff0c\u6267\u884c\u540e\u5c31\u4f1a\u63d0\u4ea4\uff0c\u6240\u4ee5 Q2 \u548c Q3 \u5c31\u662f\u5e94\u8be5\u770b\u5230\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u7684\u64cd\u4f5c\u6548\u679c\uff0c\u800c\u4e14\u4e5f\u770b\u5230\u4e86\uff0c\u8fd9\u8ddf\u4e8b\u52a1\u7684\u53ef\u89c1\u6027\u89c4\u5219\u5e76\u4e0d\u77db\u76fe\u3002</p> <p>\u4f46\u662f\uff0c\u8fd9\u662f\u4e0d\u662f\u771f\u7684\u6ca1\u95ee\u9898\u5462\uff1f</p> <p>\u4e0d\uff0c\u8fd9\u91cc\u8fd8\u771f\u5c31\u6709\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_2","title":"\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\uff1f","text":"<p>**\u9996\u5148\u662f\u8bed\u4e49\u4e0a\u7684\u3002**session A \u5728 T1 \u65f6\u523b\u5c31\u58f0\u660e\u4e86\uff0c\u201c\u6211\u8981\u628a\u6240\u6709 d=5 \u7684\u884c\u9501\u4f4f\uff0c\u4e0d\u51c6\u522b\u7684\u4e8b\u52a1\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u201d\u3002\u800c\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u8bed\u4e49\u88ab\u7834\u574f\u4e86\u3002</p> <p>\u5982\u679c\u73b0\u5728\u8fd9\u6837\u770b\u611f\u89c9\u8fd8\u4e0d\u660e\u663e\u7684\u8bdd\uff0c\u6211\u518d\u5f80 session B \u548c session C \u91cc\u9762\u5206\u522b\u52a0\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u4f60\u518d\u770b\u770b\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u3002</p> Session A Session B Session C T1 begin;select * from t where d=5 fro update; /Q1///result: (5,5,5) T2 update t set d=5 where id=0;update t set c=5 where id=0; T3 select * from t where d=5 fro update; /Q2///result: (0,0,5), (5,5,5) T4 insert into t values(1,1,5);update t set c=5 where id=1; T5 select * from t where d=5 fro update; /Q3///result: (0,0,5),(1,1,5),(5,5,5) T6 commit; <p>session B \u7684\u7b2c\u4e8c\u6761\u8bed\u53e5 <code>update t set c=5 where id=0</code>\uff0c\u8bed\u4e49\u662f\u201c\u6211\u628a id=0\u3001d=5 \u8fd9\u4e00\u884c\u7684 c \u503c\uff0c\u6539\u6210\u4e86 5\u201d\u3002</p> <p>\u7531\u4e8e\u5728 T1 \u65f6\u523b\uff0csession A \u8fd8\u53ea\u662f\u7ed9 id=5 \u8fd9\u4e00\u884c\u52a0\u4e86\u884c\u9501\uff0c \u5e76\u6ca1\u6709\u7ed9 id=0 \u8fd9\u884c\u52a0\u4e0a\u9501\u3002\u56e0\u6b64\uff0csession B \u5728 T2 \u65f6\u523b\uff0c\u662f\u53ef\u4ee5\u6267\u884c\u8fd9\u4e24\u6761 update \u8bed\u53e5\u7684\u3002\u8fd9\u6837\uff0c\u5c31\u7834\u574f\u4e86 session A \u91cc Q1 \u8bed\u53e5\u8981\u9501\u4f4f\u6240\u6709 d=5 \u7684\u884c\u7684\u52a0\u9501\u58f0\u660e\u3002</p> <p>session C \u4e5f\u662f\u4e00\u6837\u7684\u9053\u7406\uff0c\u5bf9 id=1 \u8fd9\u4e00\u884c\u7684\u4fee\u6539\uff0c\u4e5f\u662f\u7834\u574f\u4e86 Q1 \u7684\u52a0\u9501\u58f0\u660e\u3002</p> <p>\u5176\u6b21\uff0c\u662f\u6570\u636e\u4e00\u81f4\u6027\u7684\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u77e5\u9053\uff0c\u9501\u7684\u8bbe\u8ba1\u662f\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u800c\u8fd9\u4e2a\u4e00\u81f4\u6027\uff0c\u4e0d\u6b62\u662f\u6570\u636e\u5e93\u5185\u90e8\u6570\u636e\u72b6\u6001\u5728\u6b64\u523b\u7684\u4e00\u81f4\u6027\uff0c\u8fd8\u5305\u542b\u4e86\u6570\u636e\u548c\u65e5\u5fd7\u5728\u903b\u8f91\u4e0a\u7684\u4e00\u81f4\u6027\u3002</p> <p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u7ed9 session A \u5728 T1 \u65f6\u523b\u518d\u52a0\u4e00\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u5373\uff1a<code>update t set d=100 where d=5</code>\u3002</p> Session A Session B Session C T1 begin;select * from t where d=5 fro update; /Q1/update t set d=100 where d=5; T2 update t set d=5 where id=0;update t set c=5 where id=0; T3 select * from t where d=5 fro update; /Q2/ T4 insert into t values(1,1,5);update t set c=5 where id=1; T5 select * from t where d=5 fro update; /Q3/ T6 commit; <p>update \u7684\u52a0\u9501\u8bed\u4e49\u548c <code>select \u2026for update</code> \u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u8fd9\u65f6\u5019\u52a0\u4e0a\u8fd9\u6761 update \u8bed\u53e5\u4e5f\u5f88\u5408\u7406\u3002session A \u58f0\u660e\u8bf4\u201c\u8981\u7ed9 d=5 \u7684\u8bed\u53e5\u52a0\u4e0a\u9501\u201d\uff0c\u5c31\u662f\u4e3a\u4e86\u8981\u66f4\u65b0\u6570\u636e\uff0c\u65b0\u52a0\u7684\u8fd9\u6761 update \u8bed\u53e5\u5c31\u662f\u628a\u5b83\u8ba4\u4e3a\u52a0\u4e0a\u4e86\u9501\u7684\u8fd9\u4e00\u884c\u7684 d \u503c\u4fee\u6539\u6210\u4e86 100\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u56fe 3 \u6267\u884c\u5b8c\u6210\u540e\uff0c\u6570\u636e\u5e93\u91cc\u4f1a\u662f\u4ec0\u4e48\u7ed3\u679c\u3002</p> <ol> <li>\u7ecf\u8fc7 T1 \u65f6\u523b\uff0cid=5 \u8fd9\u4e00\u884c\u53d8\u6210 (5,5,100)\uff0c\u5f53\u7136\u8fd9\u4e2a\u7ed3\u679c\u6700\u7ec8\u662f\u5728 T6 \u65f6\u523b\u6b63\u5f0f\u63d0\u4ea4\u7684 ;</li> <li>\u7ecf\u8fc7 T2 \u65f6\u523b\uff0cid=0 \u8fd9\u4e00\u884c\u53d8\u6210 (0,5,5);</li> <li>\u7ecf\u8fc7 T4 \u65f6\u523b\uff0c\u8868\u91cc\u9762\u591a\u4e86\u4e00\u884c (1,5,5);</li> <li>\u5176\u4ed6\u884c\u8ddf\u8fd9\u4e2a\u6267\u884c\u5e8f\u5217\u65e0\u5173\uff0c\u4fdd\u6301\u4e0d\u53d8\u3002</li> </ol> <p>\u8fd9\u6837\u770b\uff0c\u8fd9\u4e9b\u6570\u636e\u4e5f\u6ca1\u5565\u95ee\u9898\uff0c\u4f46\u662f\u6211\u4eec\u518d\u6765\u770b\u770b\u8fd9\u65f6\u5019 binlog \u91cc\u9762\u7684\u5185\u5bb9\u3002</p> <ol> <li>T2 \u65f6\u523b\uff0csession B \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86\u4e24\u6761\u8bed\u53e5\uff1b</li> <li>T4 \u65f6\u523b\uff0csession C \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86\u4e24\u6761\u8bed\u53e5\uff1b</li> <li>T6 \u65f6\u523b\uff0csession A \u4e8b\u52a1\u63d0\u4ea4\uff0c\u5199\u5165\u4e86 update t set d=100 where d=5 \u8fd9\u6761\u8bed\u53e5\u3002</li> </ol> <p>\u6211\u7edf\u4e00\u653e\u5230\u4e00\u8d77\u7684\u8bdd\uff0c\u5c31\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>update t set d=5 where id=0; /*(0,0,5)*/\nupdate t set c=5 where id=0; /*(0,5,5)*/ \ninsert into t values(1,1,5); /*(1,1,5)*/\nupdate t set c=5 where id=1; /*(1,5,5)*/ \nupdate t set d=100 where d=5;/* \u6240\u6709 d=5 \u7684\u884c\uff0cd \u6539\u6210 100*/\n</code></pre> <p>\u597d\uff0c\u4f60\u5e94\u8be5\u770b\u51fa\u95ee\u9898\u4e86\u3002\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff0c\u4e0d\u8bba\u662f\u62ff\u5230\u5907\u5e93\u53bb\u6267\u884c\uff0c\u8fd8\u662f\u4ee5\u540e\u7528 binlog \u6765\u514b\u9686\u4e00\u4e2a\u5e93\uff0c\u8fd9\u4e09\u884c\u7684\u7ed3\u679c\uff0c\u90fd\u53d8\u6210\u4e86 (0,5,100)\u3001(1,5,100) \u548c (5,5,100)\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cid=0 \u548c id=1 \u8fd9\u4e24\u884c\uff0c\u53d1\u751f\u4e86\u6570\u636e\u4e0d\u4e00\u81f4\u3002\u8fd9\u4e2a\u95ee\u9898\u5f88\u4e25\u91cd\uff0c\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u518d\u56de\u987e\u4e00\u4e0b\uff0c\u8fd9\u4e2a\u6570\u636e\u4e0d\u4e00\u81f4\u5230\u5e95\u662f\u600e\u4e48\u5f15\u5165\u7684\uff1f</p> <p>\u6211\u4eec\u5206\u6790\u4e00\u4e0b\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u662f\u6211\u4eec\u5047\u8bbe <code>select * from t where d=5 for update</code> \u8fd9\u6761\u8bed\u53e5\u53ea\u7ed9 d=5 \u8fd9\u4e00\u884c\uff0c\u4e5f\u5c31\u662f id=5 \u7684\u8fd9\u4e00\u884c\u52a0\u9501\u201d\u5bfc\u81f4\u7684\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8ba4\u4e3a\uff0c\u4e0a\u9762\u7684\u8bbe\u5b9a\u4e0d\u5408\u7406\uff0c\u8981\u6539\u3002</p> <p>\u90a3\u600e\u4e48\u6539\u5462\uff1f\u6211\u4eec\u628a\u626b\u63cf\u8fc7\u7a0b\u4e2d\u78b0\u5230\u7684\u884c\uff0c\u4e5f\u90fd\u52a0\u4e0a\u5199\u9501\uff0c\u518d\u6765\u770b\u770b\u6267\u884c\u6548\u679c\u3002</p> Session A Session B Session C T1 begin;select * from t where d=5 fro update; /Q1/update t set d=100 where d=5; T2 update t set d=5 where id=0;(blocked)update t set c=5 where id=0; T3 select * from t where d=5 fro update; /Q2/ T4 insert into t values(1,1,5);update t set c=5 where id=1; T5 select * from t where d=5 fro update; /Q3/ T6 commit; <p>\u7531\u4e8e session A \u628a\u6240\u6709\u7684\u884c\u90fd\u52a0\u4e86\u5199\u9501\uff0c\u6240\u4ee5 session B \u5728\u6267\u884c\u7b2c\u4e00\u4e2a update \u8bed\u53e5\u7684\u65f6\u5019\u5c31\u88ab\u9501\u4f4f\u4e86\u3002\u9700\u8981\u7b49\u5230 T6 \u65f6\u523b session A \u63d0\u4ea4\u4ee5\u540e\uff0csession B \u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</p> <p>\u8fd9\u6837\u5bf9\u4e8e id=0 \u8fd9\u4e00\u884c\uff0c\u5728\u6570\u636e\u5e93\u91cc\u7684\u6700\u7ec8\u7ed3\u679c\u8fd8\u662f (0,5,5)\u3002\u5728 binlog \u91cc\u9762\uff0c\u6267\u884c\u5e8f\u5217\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>insert into t values(1,1,5); /*(1,1,5)*/\nupdate t set c=5 where id=1; /*(1,5,5)*/ \nupdate t set d=100 where d=5;/* \u6240\u6709 d=5 \u7684\u884c\uff0cd \u6539\u6210 100*/ \nupdate t set d=5 where id=0; /*(0,0,5)*/\nupdate t set c=5 where id=0; /*(0,5,5)*/\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6309\u7167\u65e5\u5fd7\u987a\u5e8f\u6267\u884c\uff0cid=0 \u8fd9\u4e00\u884c\u7684\u6700\u7ec8\u7ed3\u679c\u4e5f\u662f (0,5,5)\u3002\u6240\u4ee5\uff0cid=0 \u8fd9\u4e00\u884c\u7684\u95ee\u9898\u89e3\u51b3\u4e86\u3002</p> <p>\u4f46\u540c\u65f6\u4f60\u4e5f\u53ef\u4ee5\u770b\u5230\uff0cid=1 \u8fd9\u4e00\u884c\uff0c\u5728\u6570\u636e\u5e93\u91cc\u9762\u7684\u7ed3\u679c\u662f (1,5,5)\uff0c\u800c\u6839\u636e binlog \u7684\u6267\u884c\u7ed3\u679c\u662f (1,5,100)\uff0c\u4e5f\u5c31\u662f\u8bf4\u5e7b\u8bfb\u7684\u95ee\u9898\u8fd8\u662f\u6ca1\u6709\u89e3\u51b3\u3002\u4e3a\u4ec0\u4e48\u6211\u4eec\u5df2\u7ecf\u8fd9\u4e48\u201c\u51f6\u6b8b\u201d\u5730\uff0c\u628a\u6240\u6709\u7684\u8bb0\u5f55\u90fd\u4e0a\u4e86\u9501\uff0c\u8fd8\u662f\u963b\u6b62\u4e0d\u4e86 id=1 \u8fd9\u4e00\u884c\u7684\u63d2\u5165\u548c\u66f4\u65b0\u5462\uff1f</p> <p>\u539f\u56e0\u5f88\u7b80\u5355\u3002\u5728 T3 \u65f6\u523b\uff0c\u6211\u4eec\u7ed9\u6240\u6709\u884c\u52a0\u9501\u7684\u65f6\u5019\uff0cid=1 \u8fd9\u4e00\u884c\u8fd8\u4e0d\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u4e5f\u5c31\u52a0\u4e0d\u4e0a\u9501\u3002</p> <p>**\u4e5f\u5c31\u662f\u8bf4\uff0c\u5373\u4f7f\u628a\u6240\u6709\u7684\u8bb0\u5f55\u90fd\u52a0\u4e0a\u9501\uff0c\u8fd8\u662f\u963b\u6b62\u4e0d\u4e86\u65b0\u63d2\u5165\u7684\u8bb0\u5f55\uff0c**\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u201c\u5e7b\u8bfb\u201d\u4f1a\u88ab\u5355\u72ec\u62ff\u51fa\u6765\u89e3\u51b3\u7684\u539f\u56e0\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u5176\u5b9e\u6211\u4eec\u521a\u8bf4\u660e\u5b8c\u6587\u7ae0\u7684\u6807\u9898 \uff1a\u5e7b\u8bfb\u7684\u5b9a\u4e49\u548c\u5e7b\u8bfb\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b InnoDB \u600e\u4e48\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_3","title":"\u5982\u4f55\u89e3\u51b3\u5e7b\u8bfb\uff1f","text":"<p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u4ea7\u751f\u5e7b\u8bfb\u7684\u539f\u56e0\u662f\uff0c\u884c\u9501\u53ea\u80fd\u9501\u4f4f\u884c\uff0c\u4f46\u662f\u65b0\u63d2\u5165\u8bb0\u5f55\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u8981\u66f4\u65b0\u7684\u662f\u8bb0\u5f55\u4e4b\u95f4\u7684\u201c\u95f4\u9699\u201d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\uff0cInnoDB \u53ea\u597d\u5f15\u5165\u65b0\u7684\u9501\uff0c\u4e5f\u5c31\u662f\u95f4\u9699\u9501 (Gap Lock)\u3002</p> <p>\u987e\u540d\u601d\u4e49\uff0c\u95f4\u9699\u9501\uff0c\u9501\u7684\u5c31\u662f\u4e24\u4e2a\u503c\u4e4b\u95f4\u7684\u7a7a\u9699\u3002\u6bd4\u5982\u6587\u7ae0\u5f00\u5934\u7684\u8868 t\uff0c\u521d\u59cb\u5316\u63d2\u5165\u4e86 6 \u4e2a\u8bb0\u5f55\uff0c\u8fd9\u5c31\u4ea7\u751f\u4e86 7 \u4e2a\u95f4\u9699\u3002</p> <p></p> <p>\u56fe 5 \u8868 t \u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\u884c\u9501\u548c\u95f4\u9699\u9501</p> <p>\u8fd9\u6837\uff0c\u5f53\u4f60\u6267\u884c <code>select * from t where d=5 for update</code> \u7684\u65f6\u5019\uff0c\u5c31\u4e0d\u6b62\u662f\u7ed9\u6570\u636e\u5e93\u4e2d\u5df2\u6709\u7684 6 \u4e2a\u8bb0\u5f55\u52a0\u4e0a\u4e86\u884c\u9501\uff0c\u8fd8\u540c\u65f6\u52a0\u4e86 7 \u4e2a\u95f4\u9699\u9501\u3002\u8fd9\u6837\u5c31\u786e\u4fdd\u4e86\u65e0\u6cd5\u518d\u63d2\u5165\u65b0\u7684\u8bb0\u5f55\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\u8fd9\u65f6\u5019\uff0c\u5728\u4e00\u884c\u884c\u626b\u63cf\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u4ec5\u5c06\u7ed9\u884c\u52a0\u4e0a\u4e86\u884c\u9501\uff0c\u8fd8\u7ed9\u884c\u4e24\u8fb9\u7684\u7a7a\u9699\uff0c\u4e5f\u52a0\u4e0a\u4e86\u95f4\u9699\u9501\u3002</p> <p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u6570\u636e\u884c\u662f\u53ef\u4ee5\u52a0\u4e0a\u9501\u7684\u5b9e\u4f53\uff0c\u6570\u636e\u884c\u4e4b\u95f4\u7684\u95f4\u9699\uff0c\u4e5f\u662f\u53ef\u4ee5\u52a0\u4e0a\u9501\u7684\u5b9e\u4f53\u3002\u4f46\u662f\u95f4\u9699\u9501\u8ddf\u6211\u4eec\u4e4b\u524d\u78b0\u5230\u8fc7\u7684\u9501\u90fd\u4e0d\u592a\u4e00\u6837\u3002</p> <p>\u6bd4\u5982\u884c\u9501\uff0c\u5206\u6210\u8bfb\u9501\u548c\u5199\u9501\u3002\u4e0b\u56fe\u5c31\u662f\u8fd9\u4e24\u79cd\u7c7b\u578b\u884c\u9501\u7684\u51b2\u7a81\u5173\u7cfb\u3002</p> \u8bfb\u9501 \u5199\u9501 \u8bfb\u9501 \u517c\u5bb9 \u51b2\u7a81 \u5199\u9501 \u51b2\u7a81 \u51b2\u7a81 <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8ddf\u884c\u9501\u6709\u51b2\u7a81\u5173\u7cfb\u7684\u662f\u201c\u53e6\u5916\u4e00\u4e2a\u884c\u9501\u201d\u3002</p> <p>\u4f46\u662f\u95f4\u9699\u9501\u4e0d\u4e00\u6837\uff0c**\u8ddf\u95f4\u9699\u9501\u5b58\u5728\u51b2\u7a81\u5173\u7cfb\u7684\uff0c\u662f\u201c\u5f80\u8fd9\u4e2a\u95f4\u9699\u4e2d\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55\u201d\u8fd9\u4e2a\u64cd\u4f5c\u3002**\u95f4\u9699\u9501\u4e4b\u95f4\u90fd\u4e0d\u5b58\u5728\u51b2\u7a81\u5173\u7cfb\u3002</p> <p>\u8fd9\u53e5\u8bdd\u4e0d\u592a\u597d\u7406\u89e3\uff0c\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\uff1a</p> Session A Session B begin;select * from t where c=7 lock in share mode; begin;select * from t where c = 7 for update; <p>\u8fd9\u91cc session B \u5e76\u4e0d\u4f1a\u88ab\u5835\u4f4f\u3002\u56e0\u4e3a\u8868 t \u91cc\u5e76\u6ca1\u6709 c=7 \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u56e0\u6b64 session A \u52a0\u7684\u662f\u95f4\u9699\u9501 (5,10)\u3002\u800c session B \u4e5f\u662f\u5728\u8fd9\u4e2a\u95f4\u9699\u52a0\u7684\u95f4\u9699\u9501\u3002\u5b83\u4eec\u6709\u5171\u540c\u7684\u76ee\u6807\uff0c\u5373\uff1a\u4fdd\u62a4\u8fd9\u4e2a\u95f4\u9699\uff0c\u4e0d\u5141\u8bb8\u63d2\u5165\u503c\u3002\u4f46\uff0c\u5b83\u4eec\u4e4b\u95f4\u662f\u4e0d\u51b2\u7a81\u7684\u3002</p> <p>\u95f4\u9699\u9501\u548c\u884c\u9501\u5408\u79f0 next-key lock\uff0c\u6bcf\u4e2a next-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u7684\u8868 t \u521d\u59cb\u5316\u4ee5\u540e\uff0c\u5982\u679c\u7528 <code>select * from t for update</code> \u8981\u628a\u6574\u4e2a\u8868\u6240\u6709\u8bb0\u5f55\u9501\u8d77\u6765\uff0c\u5c31\u5f62\u6210\u4e86 7 \u4e2a next-key lock\uff0c\u5206\u522b\u662f <code>(-\u221e,0]\u3001(0,5]\u3001(5,10]\u3001(10,15]\u3001(15,20]\u3001(20, 25]\u3001(25, +supremum]</code>\u3002</p> <p>\u5907\u6ce8\uff1a\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u6211\u4eec\u628a\u95f4\u9699\u9501\u8bb0\u4e3a\u5f00\u533a\u95f4\uff0c\u628a next-key lock \u8bb0\u4e3a\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\u8bf4\uff0c\u8fd9\u4e2a supremum \u4ece\u54ea\u513f\u6765\u7684\u5462\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a <code>+\u221e</code> \u662f\u5f00\u533a\u95f4\u3002\u5b9e\u73b0\u4e0a\uff0cInnoDB \u7ed9\u6bcf\u4e2a\u7d22\u5f15\u52a0\u4e86\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u6700\u5927\u503c supremum\uff0c\u8fd9\u6837\u624d\u7b26\u5408\u6211\u4eec\u524d\u9762\u8bf4\u7684\u201c\u90fd\u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u201d\u3002</p> <p>\u95f4\u9699\u9501\u548c next-key lock \u7684\u5f15\u5165\uff0c\u5e2e\u6211\u4eec\u89e3\u51b3\u4e86\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u4f46\u540c\u65f6\u4e5f\u5e26\u6765\u4e86\u4e00\u4e9b\u201c\u56f0\u6270\u201d\u3002</p> <p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u5c31\u6709\u540c\u5b66\u63d0\u5230\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002\u6211\u628a\u4ed6\u7684\u95ee\u9898\u8f6c\u8ff0\u4e00\u4e0b\uff0c\u5bf9\u5e94\u5230\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u7684\u8868\u6765\u8bf4\uff0c\u4e1a\u52a1\u903b\u8f91\u8fd9\u6837\u7684\uff1a\u4efb\u610f\u9501\u4f4f\u4e00\u884c\uff0c\u5982\u679c\u8fd9\u4e00\u884c\u4e0d\u5b58\u5728\u7684\u8bdd\u5c31\u63d2\u5165\uff0c\u5982\u679c\u5b58\u5728\u8fd9\u4e00\u884c\u5c31\u66f4\u65b0\u5b83\u7684\u6570\u636e\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>begin;\nselect * from t where id=N for update; \n/* \u5982\u679c\u884c\u4e0d\u5b58\u5728 */\ninsert into t values(N,N,N);\n/* \u5982\u679c\u884c\u5b58\u5728 */\nupdate t set d=N set id=N; \ncommit;\n</code></pre> <p>\u53ef\u80fd\u4f60\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u4e0d\u662f <code>insert \u2026 on duplicate key update</code> \u5c31\u80fd\u89e3\u51b3\u5417\uff1f\u4f46\u5176\u5b9e\u5728\u6709\u591a\u4e2a\u552f\u4e00\u952e\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e0d\u80fd\u6ee1\u8db3\u8fd9\u4f4d\u63d0\u95ee\u540c\u5b66\u7684\u9700\u6c42\u7684\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u518d\u5c55\u5f00\u8bf4\u660e\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u53ea\u8ba8\u8bba\u8fd9\u4e2a\u903b\u8f91\u3002</p> <p>\u8fd9\u4e2a\u540c\u5b66\u78b0\u5230\u7684\u73b0\u8c61\u662f\uff0c\u8fd9\u4e2a\u903b\u8f91\u4e00\u65e6\u6709\u5e76\u53d1\uff0c\u5c31\u4f1a\u78b0\u5230\u6b7b\u9501\u3002\u4f60\u4e00\u5b9a\u4e5f\u89c9\u5f97\u5947\u602a\uff0c\u8fd9\u4e2a\u903b\u8f91\u6bcf\u6b21\u64cd\u4f5c\u524d\u7528 for update \u9501\u8d77\u6765\uff0c\u5df2\u7ecf\u662f\u6700\u4e25\u683c\u7684\u6a21\u5f0f\u4e86\uff0c\u600e\u4e48\u8fd8\u4f1a\u6709\u6b7b\u9501\u5462\uff1f</p> <p>\u8fd9\u91cc\uff0c\u6211\u7528\u4e24\u4e2a session \u6765\u6a21\u62df\u5e76\u53d1\uff0c\u5e76\u5047\u8bbe N=9\u3002</p> session A session B begin;select * from t where id=9 for update; begin;select * from t where id=9 for update; insert into t values(9,9,9);(blocked) insert into t values(9,9,9);(Error 1213(40001): Deadlock found) <p>\u4f60\u770b\u5230\u4e86\uff0c\u5176\u5b9e\u90fd\u4e0d\u9700\u8981\u7528\u5230\u540e\u9762\u7684 update \u8bed\u53e5\uff0c\u5c31\u5df2\u7ecf\u5f62\u6210\u6b7b\u9501\u4e86\u3002\u6211\u4eec\u6309\u8bed\u53e5\u6267\u884c\u987a\u5e8f\u6765\u5206\u6790\u4e00\u4e0b\uff1a</p> <ol> <li>session A \u6267\u884c <code>select \u2026 for update</code> \u8bed\u53e5\uff0c\u7531\u4e8e id=9 \u8fd9\u4e00\u884c\u5e76\u4e0d\u5b58\u5728\uff0c\u56e0\u6b64\u4f1a\u52a0\u4e0a\u95f4\u9699\u9501 (5,10);</li> <li>session B \u6267\u884c <code>select \u2026 for update</code> \u8bed\u53e5\uff0c\u540c\u6837\u4f1a\u52a0\u4e0a\u95f4\u9699\u9501 (5,10)\uff0c\u95f4\u9699\u9501\u4e4b\u95f4\u4e0d\u4f1a\u51b2\u7a81\uff0c\u56e0\u6b64\u8fd9\u4e2a\u8bed\u53e5\u53ef\u4ee5\u6267\u884c\u6210\u529f\uff1b</li> <li>session B \u8bd5\u56fe\u63d2\u5165\u4e00\u884c (9,9,9)\uff0c\u88ab session A \u7684\u95f4\u9699\u9501\u6321\u4f4f\u4e86\uff0c\u53ea\u597d\u8fdb\u5165\u7b49\u5f85\uff1b</li> <li>session A \u8bd5\u56fe\u63d2\u5165\u4e00\u884c (9,9,9)\uff0c\u88ab session B \u7684\u95f4\u9699\u9501\u6321\u4f4f\u4e86\u3002</li> </ol> <p>\u81f3\u6b64\uff0c\u4e24\u4e2a session \u8fdb\u5165\u4e92\u76f8\u7b49\u5f85\u72b6\u6001\uff0c\u5f62\u6210\u6b7b\u9501\u3002\u5f53\u7136\uff0cInnoDB \u7684\u6b7b\u9501\u68c0\u6d4b\u9a6c\u4e0a\u5c31\u53d1\u73b0\u4e86\u8fd9\u5bf9\u6b7b\u9501\u5173\u7cfb\uff0c\u8ba9 session A \u7684 insert \u8bed\u53e5\u62a5\u9519\u8fd4\u56de\u4e86\u3002</p> <p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c\u95f4\u9699\u9501\u7684\u5f15\u5165\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u540c\u6837\u7684\u8bed\u53e5\u9501\u4f4f\u66f4\u5927\u7684\u8303\u56f4\uff0c\u8fd9\u5176\u5b9e\u662f\u5f71\u54cd\u4e86\u5e76\u53d1\u5ea6\u7684\u3002\u5176\u5b9e\uff0c\u8fd9\u8fd8\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u8fd8\u4f1a\u78b0\u5230\u66f4\u591a\u3001\u66f4\u590d\u6742\u7684\u4f8b\u5b50\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u4e3a\u4e86\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u6211\u4eec\u5f15\u5165\u4e86\u8fd9\u4e48\u4e00\u5927\u4e32\u5185\u5bb9\uff0c\u6709\u6ca1\u6709\u66f4\u7b80\u5355\u4e00\u70b9\u7684\u5904\u7406\u65b9\u6cd5\u5462\u3002</p> <p>\u6211\u5728\u6587\u7ae0\u4e00\u5f00\u59cb\u5c31\u8bf4\u8fc7\uff0c\u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e\uff0c\u4eca\u5929\u548c\u4f60\u5206\u6790\u7684\u95ee\u9898\u90fd\u662f\u5728 \u53ef\u91cd\u590d\u8bfb \u9694\u79bb\u7ea7\u522b\u4e0b\u7684\uff0c\u95f4\u9699\u9501\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u624d\u4f1a\u751f\u6548\u7684\u3002\u6240\u4ee5\uff0c\u4f60\u5982\u679c\u628a\u9694\u79bb\u7ea7\u522b\u8bbe\u7f6e\u4e3a **\u8bfb\u5df2\u63d0\u4ea4**\u7684\u8bdd\uff0c\u5c31\u6ca1\u6709\u95f4\u9699\u9501\u4e86\u3002\u4f46\u540c\u65f6\uff0c\u4f60\u8981\u89e3\u51b3\u53ef\u80fd\u51fa\u73b0\u7684\u6570\u636e\u548c\u65e5\u5fd7\u4e0d\u4e00\u81f4\u95ee\u9898\uff0c\u9700\u8981\u628a binlog \u683c\u5f0f\u8bbe\u7f6e\u4e3a row\u3002\u8fd9\uff0c\u4e5f\u662f\u73b0\u5728\u4e0d\u5c11\u516c\u53f8\u4f7f\u7528\u7684\u914d\u7f6e\u7ec4\u5408\u3002</p> <p>\u524d\u9762\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u7559\u8a00\u8bf4\uff0c\u4ed6\u4eec\u516c\u53f8\u5c31\u4f7f\u7528\u7684\u662f\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u52a0 <code>binlog_format=row</code> \u7684\u7ec4\u5408\u3002\u4ed6\u66fe\u95ee\u4ed6\u4eec\u516c\u53f8\u7684 DBA \u8bf4\uff0c\u4f60\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u914d\u7f6e\u3002DBA \u76f4\u63a5\u7b54\u590d\u8bf4\uff0c\u56e0\u4e3a\u5927\u5bb6\u90fd\u8fd9\u4e48\u7528\u5440\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u5c31\u95ee\u8bf4\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5230\u5e95\u5408\u4e0d\u5408\u7406\u3002</p> <p>\u5173\u4e8e\u8fd9\u4e2a\u95ee\u9898\u672c\u8eab\u7684\u7b54\u6848\u662f\uff0c\u5982\u679c\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u591f\u7528\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e1a\u52a1\u4e0d\u9700\u8981\u53ef\u91cd\u590d\u8bfb\u7684\u4fdd\u8bc1\uff0c\u8fd9\u6837\u8003\u8651\u5230\u8bfb\u63d0\u4ea4\u4e0b\u64cd\u4f5c\u6570\u636e\u7684\u9501\u8303\u56f4\u66f4\u5c0f\uff08\u6ca1\u6709\u95f4\u9699\u9501\uff09\uff0c\u8fd9\u4e2a\u9009\u62e9\u662f\u5408\u7406\u7684\u3002</p> <p>\u4f46\u5176\u5b9e\u6211\u60f3\u8bf4\u7684\u662f\uff0c\u914d\u7f6e\u662f\u5426\u5408\u7406\uff0c\u8ddf\u4e1a\u52a1\u573a\u666f\u6709\u5173\uff0c\u9700\u8981\u5177\u4f53\u95ee\u9898\u5177\u4f53\u5206\u6790\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c DBA \u8ba4\u4e3a\u4e4b\u6240\u4ee5\u8fd9\u4e48\u7528\u7684\u539f\u56e0\u662f\u201c\u5927\u5bb6\u90fd\u8fd9\u4e48\u7528\u201d\uff0c\u90a3\u5c31\u6709\u95ee\u9898\u4e86\uff0c\u6216\u8005\u8bf4\uff0c\u8fdf\u65e9\u4f1a\u51fa\u95ee\u9898\u3002</p> <p>\u6bd4\u5982\u8bf4\uff0c\u5927\u5bb6\u90fd\u7528\u8bfb\u63d0\u4ea4\uff0c\u53ef\u662f\u903b\u8f91\u5907\u4efd\u7684\u65f6\u5019\uff0cmysqldump \u4e3a\u4ec0\u4e48\u8981\u628a\u5907\u4efd\u7ebf\u7a0b\u8bbe\u7f6e\u6210\u53ef\u91cd\u590d\u8bfb\u5462\uff1f\uff08\u8fd9\u4e2a\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u5df2\u7ecf\u89e3\u91ca\u8fc7\u4e86\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e0b\u7b2c 6 \u7bc7\u6587\u7ae0[\u300a\u5168\u5c40\u9501\u548c\u8868\u9501 \uff1a\u7ed9\u8868\u52a0\u4e2a\u5b57\u6bb5\u600e\u4e48\u6709\u8fd9\u4e48\u591a\u963b\u788d\uff1f\u300b]\u7684\u5185\u5bb9\uff09</p> <p>\u7136\u540e\uff0c\u5728\u5907\u4efd\u671f\u95f4\uff0c\u5907\u4efd\u7ebf\u7a0b\u7528\u7684\u662f\u53ef\u91cd\u590d\u8bfb\uff0c\u800c\u4e1a\u52a1\u7ebf\u7a0b\u7528\u7684\u662f\u8bfb\u63d0\u4ea4\u3002\u540c\u65f6\u5b58\u5728\u4e24\u79cd\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff0c\u4f1a\u4e0d\u4f1a\u6709\u95ee\u9898\uff1f</p> <p>\u8fdb\u4e00\u6b65\u5730\uff0c\u8fd9\u4e24\u4e2a\u4e0d\u540c\u7684\u9694\u79bb\u7ea7\u522b\u73b0\u8c61\u6709\u4ec0\u4e48\u4e0d\u4e00\u6837\u7684\uff0c\u5173\u4e8e\u6211\u4eec\u7684\u4e1a\u52a1\uff0c\u201c\u7528\u8bfb\u63d0\u4ea4\u5c31\u591f\u4e86\u201d\u8fd9\u4e2a\u7ed3\u8bba\u662f\u600e\u4e48\u5f97\u5230\u7684\uff1f</p> <p>\u5982\u679c\u4e1a\u52a1\u5f00\u53d1\u548c\u8fd0\u7ef4\u56e2\u961f\u8fd9\u4e9b\u95ee\u9898\u90fd\u6ca1\u6709\u5f04\u6e05\u695a\uff0c\u90a3\u4e48\u201c\u6ca1\u95ee\u9898\u201d\u8fd9\u4e2a\u7ed3\u8bba\uff0c\u672c\u8eab\u5c31\u662f\u6709\u95ee\u9898\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_4","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u6211\u4eec\u4ece\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7684\u8bfe\u540e\u95ee\u9898\u8bf4\u8d77\uff0c\u63d0\u5230\u4e86\u5168\u8868\u626b\u63cf\u7684\u52a0\u9501\u65b9\u5f0f\u3002\u6211\u4eec\u53d1\u73b0\u5373\u4f7f\u7ed9\u6240\u6709\u7684\u884c\u90fd\u52a0\u4e0a\u884c\u9501\uff0c\u4ecd\u7136\u65e0\u6cd5\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\uff0c\u56e0\u6b64\u5f15\u5165\u4e86\u95f4\u9699\u9501\u7684\u6982\u5ff5\u3002</p> <p>\u6211\u78b0\u5230\u8fc7\u5f88\u591a\u5bf9\u6570\u636e\u5e93\u6709\u4e00\u5b9a\u4e86\u89e3\u7684\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\uff0c\u4ed6\u4eec\u5728\u8bbe\u8ba1\u6570\u636e\u8868\u7ed3\u6784\u548c\u4e1a\u52a1 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5bf9\u884c\u9501\u6709\u5f88\u51c6\u786e\u7684\u8ba4\u8bc6\uff0c\u4f46\u5374\u5f88\u5c11\u8003\u8651\u5230\u95f4\u9699\u9501\u3002\u6700\u540e\u7684\u7ed3\u679c\uff0c\u5c31\u662f\u751f\u4ea7\u5e93\u4e0a\u4f1a\u7ecf\u5e38\u51fa\u73b0\u7531\u4e8e\u95f4\u9699\u9501\u5bfc\u81f4\u7684\u6b7b\u9501\u73b0\u8c61\u3002</p> <p>\u884c\u9501\u786e\u5b9e\u6bd4\u8f83\u76f4\u89c2\uff0c\u5224\u65ad\u89c4\u5219\u4e5f\u76f8\u5bf9\u7b80\u5355\uff0c\u95f4\u9699\u9501\u7684\u5f15\u5165\u4f1a\u5f71\u54cd\u7cfb\u7edf\u7684\u5e76\u53d1\u5ea6\uff0c\u4e5f\u589e\u52a0\u4e86\u9501\u5206\u6790\u7684\u590d\u6742\u5ea6\uff0c\u4f46\u4e5f\u6709\u7ae0\u53ef\u5faa\u3002\u4e0b\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u4f1a\u4e3a\u4f60\u8bb2\u89e3 InnoDB \u7684\u52a0\u9501\u89c4\u5219\uff0c\u5e2e\u4f60\u7406\u987a\u8fd9\u5176\u4e2d\u7684\u201c\u7ae0\u6cd5\u201d\u3002</p> <p>\u4f5c\u4e3a\u5bf9\u4e0b\u4e00\u7bc7\u6587\u7ae0\u7684\u9884\u4e60\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u3002</p> session A session B session C begin;select * from t where c&gt;=15 and c&lt;=20 order by c desc for update; insert into t values(11,11,11) insert into t values(6,6,6); <p>\u5982\u679c\u4f60\u4e4b\u524d\u6ca1\u6709\u4e86\u89e3\u8fc7\u672c\u7bc7\u6587\u7ae0\u7684\u76f8\u5173\u5185\u5bb9\uff0c\u4e00\u5b9a\u89c9\u5f97\u8fd9\u4e09\u4e2a\u8bed\u53e5\u7b80\u76f4\u662f\u98ce\u9a6c\u725b\u4e0d\u76f8\u53ca\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u91cc session B \u548c session C \u7684 insert \u8bed\u53e5\u90fd\u4f1a\u8fdb\u5165\u9501\u7b49\u5f85\u72b6\u6001\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bd5\u7740\u5206\u6790\u4e00\u4e0b\uff0c\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u539f\u56e0\u662f\u4ec0\u4e48\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#21","title":"21 \u4e3a\u4ec0\u4e48\u6211\u53ea\u6539\u4e00\u884c\u7684\u8bed\u53e5\uff0c\u9501\u8fd9\u4e48\u591a\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u95f4\u9699\u9501\u548c next-key lock \u7684\u6982\u5ff5\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u8bf4\u660e\u52a0\u9501\u89c4\u5219\u3002\u95f4\u9699\u9501\u7684\u6982\u5ff5\u7406\u89e3\u8d77\u6765\u786e\u5b9e\u6709\u70b9\u513f\u96be\uff0c\u5c24\u5176\u5728\u914d\u5408\u4e0a\u884c\u9501\u4ee5\u540e\uff0c\u5f88\u5bb9\u6613\u5728\u5224\u65ad\u662f\u5426\u4f1a\u51fa\u73b0\u9501\u7b49\u5f85\u7684\u95ee\u9898\u4e0a\u72af\u9519\u3002</p> <p>\u6240\u4ee5\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u5148\u4ece\u8fd9\u4e2a\u52a0\u9501\u89c4\u5219\u5f00\u59cb\u5427\u3002</p> <p>\u9996\u5148\u8bf4\u660e\u4e00\u4e0b\uff0c\u8fd9\u4e9b\u52a0\u9501\u89c4\u5219\u6211\u6ca1\u5728\u522b\u7684\u5730\u65b9\u770b\u5230\u8fc7\u6709\u7c7b\u4f3c\u7684\u603b\u7ed3\uff0c\u4ee5\u524d\u6211\u81ea\u5df1\u5224\u65ad\u7684\u65f6\u5019\u90fd\u662f\u60f3\u7740\u4ee3\u7801\u91cc\u9762\u7684\u5b9e\u73b0\u6765\u8111\u8865\u7684\u3002\u8fd9\u6b21\u4e3a\u4e86\u603b\u7ed3\u6210\u4e0d\u770b\u4ee3\u7801\u7684\u540c\u5b66\u4e5f\u80fd\u7406\u89e3\u7684\u89c4\u5219\uff0c\u662f\u6211\u53c8\u91cd\u65b0\u5237\u4e86\u4ee3\u7801\u4e34\u65f6\u603b\u7ed3\u51fa\u6765\u7684\u3002\u6240\u4ee5\uff0c\u8fd9\u4e2a\u89c4\u5219\u6709\u4ee5\u4e0b\u4e24\u6761\u524d\u63d0\u8bf4\u660e\uff1a</p> <ol> <li>MySQL \u540e\u9762\u7684\u7248\u672c\u53ef\u80fd\u4f1a\u6539\u53d8\u52a0\u9501\u7b56\u7565\uff0c\u6240\u4ee5\u8fd9\u4e2a\u89c4\u5219\u53ea\u9650\u4e8e\u622a\u6b62\u5230\u73b0\u5728\u7684\u6700\u65b0\u7248\u672c\uff0c\u5373 5.x \u7cfb\u5217 \\&lt;=5.7.24\uff0c8.0 \u7cfb\u5217 \\&lt;=8.0.13\u3002</li> <li>\u5982\u679c\u5927\u5bb6\u5728\u9a8c\u8bc1\u4e2d\u6709\u53d1\u73b0 bad case \u7684\u8bdd\uff0c\u8bf7\u63d0\u51fa\u6765\uff0c\u6211\u4f1a\u518d\u8865\u5145\u8fdb\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4f7f\u5f97\u4e00\u8d77\u5b66\u4e60\u672c\u4e13\u680f\u7684\u6240\u6709\u540c\u5b66\u90fd\u80fd\u53d7\u76ca\u3002</li> </ol> <p>\u56e0\u4e3a\u95f4\u9699\u9501\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u624d\u6709\u6548\uff0c\u6240\u4ee5\u672c\u7bc7\u6587\u7ae0\u63a5\u4e0b\u6765\u7684\u63cf\u8ff0\uff0c\u82e5\u6ca1\u6709\u7279\u6b8a\u8bf4\u660e\uff0c\u9ed8\u8ba4\u662f\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u3002</p> <p>\u6211\u603b\u7ed3\u7684\u52a0\u9501\u89c4\u5219\u91cc\u9762\uff0c\u5305\u542b\u4e86\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\u3002</p> <ol> <li>\u539f\u5219 1\uff1a\u52a0\u9501\u7684\u57fa\u672c\u5355\u4f4d\u662f next-key lock\u3002\u5e0c\u671b\u4f60\u8fd8\u8bb0\u5f97\uff0cnext-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</li> <li>\u539f\u5219 2\uff1a\u67e5\u627e\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501\u3002</li> <li>\u4f18\u5316 1\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u7ed9\u552f\u4e00\u7d22\u5f15\u52a0\u9501\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u884c\u9501\u3002</li> <li>\u4f18\u5316 2\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u65f6\u4e14\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3\u7b49\u503c\u6761\u4ef6\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u95f4\u9699\u9501\u3002</li> <li>\u4e00\u4e2a bug\uff1a\u552f\u4e00\u7d22\u5f15\u4e0a\u7684\u8303\u56f4\u67e5\u8be2\u4f1a\u8bbf\u95ee\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u503c\u4e3a\u6b62\u3002</li> </ol> <p>\u6211\u8fd8\u662f\u4ee5\u4e0a\u7bc7\u6587\u7ae0\u7684\u8868 t \u4e3a\u4f8b\uff0c\u548c\u4f60\u89e3\u91ca\u4e00\u4e0b\u8fd9\u4e9b\u89c4\u5219\u3002\u8868 t \u7684\u5efa\u8868\u8bed\u53e5\u548c\u521d\u59cb\u5316\u8bed\u53e5\u5982\u4e0b\u3002</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `c` (`c`)\n) ENGINE=InnoDB; \ninsert into t values(0,0,0),(5,5,5),\n(10,10,10),(15,15,15),(20,20,20),(25,25,25);\n</code></pre> <p>\u63a5\u4e0b\u6765\u7684\u4f8b\u5b50\u57fa\u672c\u90fd\u662f\u914d\u5408\u7740\u56fe\u7247\u8bf4\u660e\u7684\uff0c\u6240\u4ee5\u6211\u5efa\u8bae\u4f60\u53ef\u4ee5\u5bf9\u7167\u7740\u6587\u7a3f\u770b\uff0c\u6709\u4e9b\u4f8b\u5b50\u53ef\u80fd\u4f1a\u201c\u6bc1\u4e09\u89c2\u201d\uff0c\u4e5f\u5efa\u8bae\u4f60\u8bfb\u5b8c\u6587\u7ae0\u540e\u4eb2\u624b\u5b9e\u8df5\u4e00\u4e0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_5","title":"\u6848\u4f8b\u4e00\uff1a\u7b49\u503c\u67e5\u8be2\u95f4\u9699\u9501","text":"<p>\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u7b49\u503c\u6761\u4ef6\u64cd\u4f5c\u95f4\u9699\uff1a</p> session A session B session C begin;update t set d = d + 1 where id =7; insert into t values(8,8,8);(blocked) update t set d=d+1 where id=10;(Query OK) <p>\u7531\u4e8e\u8868 t \u4e2d\u6ca1\u6709 id=7 \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u7528\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u52a0\u9501\u89c4\u5219\u5224\u65ad\u4e00\u4e0b\u7684\u8bdd\uff1a</p> <ol> <li>\u6839\u636e\u539f\u5219 1\uff0c\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0csession A \u52a0\u9501\u8303\u56f4\u5c31\u662f (5,10]\uff1b</li> <li>\u540c\u65f6\u6839\u636e\u4f18\u5316 2\uff0c\u8fd9\u662f\u4e00\u4e2a\u7b49\u503c\u67e5\u8be2 (id=7)\uff0c\u800c id=10 \u4e0d\u6ee1\u8db3\u67e5\u8be2\u6761\u4ef6\uff0cnext-key lock \u9000\u5316\u6210\u95f4\u9699\u9501\uff0c\u56e0\u6b64\u6700\u7ec8\u52a0\u9501\u7684\u8303\u56f4\u662f (5,10)\u3002</li> </ol> <p>\u6240\u4ee5\uff0csession B \u8981\u5f80\u8fd9\u4e2a\u95f4\u9699\u91cc\u9762\u63d2\u5165 id=8 \u7684\u8bb0\u5f55\u4f1a\u88ab\u9501\u4f4f\uff0c\u4f46\u662f session C \u4fee\u6539 id=10 \u8fd9\u884c\u662f\u53ef\u4ee5\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_6","title":"\u6848\u4f8b\u4e8c\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u7b49\u503c\u9501","text":"<p>\u7b2c\u4e8c\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u8986\u76d6\u7d22\u5f15\u4e0a\u7684\u9501\uff1a</p> session A session B session C begin;select id from t where c=5 lock in share mode; update t set d=d+1 where id=5;(Query OK) insert into t values(7,7,7);(blocked) <p>\u770b\u5230\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u4f60\u662f\u4e0d\u662f\u6709\u4e00\u79cd\u201c\u8be5\u9501\u7684\u4e0d\u9501\uff0c\u4e0d\u8be5\u9501\u7684\u4e71\u9501\u201d\u7684\u611f\u89c9\uff1f\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u5427\u3002</p> <p>\u8fd9\u91cc session A \u8981\u7ed9\u7d22\u5f15 c \u4e0a c=5 \u7684\u8fd9\u4e00\u884c\u52a0\u4e0a\u8bfb\u9501\u3002</p> <ol> <li>\u6839\u636e\u539f\u5219 1\uff0c\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0c\u56e0\u6b64\u4f1a\u7ed9 (0,5] \u52a0\u4e0a next-key lock\u3002</li> <li>\u8981\u6ce8\u610f c \u662f\u666e\u901a\u7d22\u5f15\uff0c\u56e0\u6b64\u4ec5\u8bbf\u95ee c=5 \u8fd9\u4e00\u6761\u8bb0\u5f55\u662f\u4e0d\u80fd\u9a6c\u4e0a\u505c\u4e0b\u6765\u7684\uff0c\u9700\u8981\u5411\u53f3\u904d\u5386\uff0c\u67e5\u5230 c=10 \u624d\u653e\u5f03\u3002\u6839\u636e\u539f\u5219 2\uff0c\u8bbf\u95ee\u5230\u7684\u90fd\u8981\u52a0\u9501\uff0c\u56e0\u6b64\u8981\u7ed9 (5,10] \u52a0 next-key lock\u3002</li> <li>\u4f46\u662f\u540c\u65f6\u8fd9\u4e2a\u7b26\u5408\u4f18\u5316 2\uff1a\u7b49\u503c\u5224\u65ad\uff0c\u5411\u53f3\u904d\u5386\uff0c\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3 c=5 \u8fd9\u4e2a\u7b49\u503c\u6761\u4ef6\uff0c\u56e0\u6b64\u9000\u5316\u6210\u95f4\u9699\u9501 (5,10)\u3002</li> <li>\u6839\u636e\u539f\u5219 2 \uff0c\u53ea\u6709\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501\uff0c\u8fd9\u4e2a\u67e5\u8be2\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\uff0c\u5e76\u4e0d\u9700\u8981\u8bbf\u95ee\u4e3b\u952e\u7d22\u5f15\uff0c\u6240\u4ee5\u4e3b\u952e\u7d22\u5f15\u4e0a\u6ca1\u6709\u52a0\u4efb\u4f55\u9501\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 session B \u7684 update \u8bed\u53e5\u53ef\u4ee5\u6267\u884c\u5b8c\u6210\u3002</li> </ol> <p>\u4f46 session C \u8981\u63d2\u5165\u4e00\u4e2a (7,7,7) \u7684\u8bb0\u5f55\uff0c\u5c31\u4f1a\u88ab session A \u7684\u95f4\u9699\u9501 (5,10) \u9501\u4f4f\u3002</p> <p>\u9700\u8981\u6ce8\u610f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0clock in share mode \u53ea\u9501\u8986\u76d6\u7d22\u5f15\uff0c\u4f46\u662f\u5982\u679c\u662f for update \u5c31\u4e0d\u4e00\u6837\u4e86\u3002 \u6267\u884c for update \u65f6\uff0c\u7cfb\u7edf\u4f1a\u8ba4\u4e3a\u4f60\u63a5\u4e0b\u6765\u8981\u66f4\u65b0\u6570\u636e\uff0c\u56e0\u6b64\u4f1a\u987a\u4fbf\u7ed9\u4e3b\u952e\u7d22\u5f15\u4e0a\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u52a0\u4e0a\u884c\u9501\u3002</p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\uff0c\u9501\u662f\u52a0\u5728\u7d22\u5f15\u4e0a\u7684\uff1b\u540c\u65f6\uff0c\u5b83\u7ed9\u6211\u4eec\u7684\u6307\u5bfc\u662f\uff0c\u5982\u679c\u4f60\u8981\u7528 lock in share mode \u6765\u7ed9\u884c\u52a0\u8bfb\u9501\u907f\u514d\u6570\u636e\u88ab\u66f4\u65b0\u7684\u8bdd\uff0c\u5c31\u5fc5\u987b\u5f97\u7ed5\u8fc7\u8986\u76d6\u7d22\u5f15\u7684\u4f18\u5316\uff0c\u5728\u67e5\u8be2\u5b57\u6bb5\u4e2d\u52a0\u5165\u7d22\u5f15\u4e2d\u4e0d\u5b58\u5728\u7684\u5b57\u6bb5\u3002\u6bd4\u5982\uff0c\u5c06 session A \u7684\u67e5\u8be2\u8bed\u53e5\u6539\u6210 <code>select d from t where c=5 lock in share mode</code>\u3002\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u6548\u679c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_7","title":"\u6848\u4f8b\u4e09\uff1a\u4e3b\u952e\u7d22\u5f15\u8303\u56f4\u9501","text":"<p>\u7b2c\u4e09\u4e2a\u4f8b\u5b50\u662f\u5173\u4e8e\u8303\u56f4\u67e5\u8be2\u7684\u3002</p> <p>\u4e3e\u4f8b\u4e4b\u524d\uff0c\u4f60\u53ef\u4ee5\u5148\u601d\u8003\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a\u5bf9\u4e8e\u6211\u4eec\u8fd9\u4e2a\u8868 t\uff0c\u4e0b\u9762\u8fd9\u4e24\u6761\u67e5\u8be2\u8bed\u53e5\uff0c\u52a0\u9501\u8303\u56f4\u76f8\u540c\u5417\uff1f</p> <pre><code>mysql&gt; select * from t where id=10 for update;\nmysql&gt; select * from t where id&gt;=10 and id&lt;11 for update;\n</code></pre> <p>\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0cid \u5b9a\u4e49\u4e3a int \u7c7b\u578b\uff0c\u8fd9\u4e24\u4e2a\u8bed\u53e5\u5c31\u662f\u7b49\u4ef7\u7684\u5427\uff1f\u5176\u5b9e\uff0c\u5b83\u4eec\u5e76\u4e0d\u5b8c\u5168\u7b49\u4ef7\u3002</p> <p>\u5728\u903b\u8f91\u4e0a\uff0c\u8fd9\u4e24\u6761\u67e5\u8bed\u53e5\u80af\u5b9a\u662f\u7b49\u4ef7\u7684\uff0c\u4f46\u662f\u5b83\u4eec\u7684\u52a0\u9501\u89c4\u5219\u4e0d\u592a\u4e00\u6837\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u8ba9 session A \u6267\u884c\u7b2c\u4e8c\u4e2a\u67e5\u8be2\u8bed\u53e5\uff0c\u6765\u770b\u770b\u52a0\u9501\u6548\u679c\u3002</p> session A session B session C begin;select * from t where id&gt;=10 and id&lt;11 for update; insert into t values(8,8,8);(Query OK)insert into t values(13,13,13);(blocked) update t set d =d+1 where id=15;(blocked) <p>\u73b0\u5728\u6211\u4eec\u5c31\u7528\u524d\u9762\u63d0\u5230\u7684\u52a0\u9501\u89c4\u5219\uff0c\u6765\u5206\u6790\u4e00\u4e0b session A \u4f1a\u52a0\u4ec0\u4e48\u9501\u5462\uff1f</p> <ol> <li>\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u627e\u5230\u7b2c\u4e00\u4e2a id=10 \u7684\u884c\uff0c\u56e0\u6b64\u672c\u8be5\u662f next-key lock(5,10]\u3002 \u6839\u636e\u4f18\u5316 1\uff0c \u4e3b\u952e id \u4e0a\u7684\u7b49\u503c\u6761\u4ef6\uff0c\u9000\u5316\u6210\u884c\u9501\uff0c\u53ea\u52a0\u4e86 id=10 \u8fd9\u4e00\u884c\u7684\u884c\u9501\u3002</li> <li>\u8303\u56f4\u67e5\u627e\u5c31\u5f80\u540e\u7ee7\u7eed\u627e\uff0c\u627e\u5230 id=15 \u8fd9\u4e00\u884c\u505c\u4e0b\u6765\uff0c\u56e0\u6b64\u9700\u8981\u52a0 next-key lock(10,15]\u3002</li> </ol> <p>\u6240\u4ee5\uff0csession A \u8fd9\u65f6\u5019\u9501\u7684\u8303\u56f4\u5c31\u662f\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u884c\u9501 id=10 \u548c next-key lock(10,15]\u3002\u8fd9\u6837\uff0csession B \u548c session C \u7684\u7ed3\u679c\u4f60\u5c31\u80fd\u7406\u89e3\u4e86\u3002</p> <p>\u8fd9\u91cc\u4f60\u9700\u8981\u6ce8\u610f\u4e00\u70b9\uff0c\u9996\u6b21 session A \u5b9a\u4f4d\u67e5\u627e id=10 \u7684\u884c\u7684\u65f6\u5019\uff0c\u662f\u5f53\u505a\u7b49\u503c\u67e5\u8be2\u6765\u5224\u65ad\u7684\uff0c\u800c\u5411\u53f3\u626b\u63cf\u5230 id=15 \u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u8303\u56f4\u67e5\u8be2\u5224\u65ad\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_8","title":"\u6848\u4f8b\u56db\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u8303\u56f4\u9501","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e24\u4e2a\u8303\u56f4\u67e5\u8be2\u52a0\u9501\u7684\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u5bf9\u7167\u7740\u6848\u4f8b\u4e09\u6765\u770b\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0e\u6848\u4f8b\u4e09\u4e0d\u540c\u7684\u662f\uff0c\u6848\u4f8b\u56db\u4e2d\u67e5\u8be2\u8bed\u53e5\u7684 where \u90e8\u5206\u7528\u7684\u662f\u5b57\u6bb5 c\u3002</p> session A session B session C begin;select * from t where c&gt;=10 and c&lt;11 for update; insert into t values(8,8,8);(blocked) update t set d =d+1 where c=15;(blocked) <p>\u8fd9\u6b21 session A \u7528\u5b57\u6bb5 c \u6765\u5224\u65ad\uff0c\u52a0\u9501\u89c4\u5219\u8ddf\u6848\u4f8b\u4e09\u552f\u4e00\u7684\u4e0d\u540c\u662f\uff1a\u5728\u7b2c\u4e00\u6b21\u7528 c=10 \u5b9a\u4f4d\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u7d22\u5f15 c \u4e0a\u52a0\u4e86 (5,10] \u8fd9\u4e2a next-key lock \u540e\uff0c\u7531\u4e8e\u7d22\u5f15 c \u662f\u975e\u552f\u4e00\u7d22\u5f15\uff0c\u6ca1\u6709\u4f18\u5316\u89c4\u5219\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e0d\u4f1a\u8715\u53d8\u4e3a\u884c\u9501\uff0c\u56e0\u6b64\u6700\u7ec8 sesion A \u52a0\u7684\u9501\u662f\uff0c\u7d22\u5f15 c \u4e0a\u7684 (5,10] \u548c (10,15] \u8fd9\u4e24\u4e2a next-key lock\u3002</p> <p>\u6240\u4ee5\u4ece\u7ed3\u679c\u4e0a\u6765\u770b\uff0csesson B \u8981\u63d2\u5165\uff088,8,8) \u7684\u8fd9\u4e2a insert \u8bed\u53e5\u65f6\u5c31\u88ab\u5835\u4f4f\u4e86\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u626b\u63cf\u5230 c=15 \u624d\u505c\u6b62\u626b\u63cf\uff0c\u662f\u5408\u7406\u7684\uff0c\u56e0\u4e3a InnoDB \u8981\u626b\u5230 c=15\uff0c\u624d\u77e5\u9053\u4e0d\u9700\u8981\u7ee7\u7eed\u5f80\u540e\u627e\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#bug","title":"\u6848\u4f8b\u4e94\uff1a\u552f\u4e00\u7d22\u5f15\u8303\u56f4\u9501 bug","text":"<p>\u524d\u9762\u7684\u56db\u4e2a\u6848\u4f8b\uff0c\u6211\u4eec\u5df2\u7ecf\u7528\u5230\u4e86\u52a0\u9501\u89c4\u5219\u4e2d\u7684\u4e24\u4e2a\u539f\u5219\u548c\u4e24\u4e2a\u4f18\u5316\uff0c\u63a5\u4e0b\u6765\u518d\u770b\u4e00\u4e2a\u5173\u4e8e\u52a0\u9501\u89c4\u5219\u4e2d bug \u7684\u6848\u4f8b\u3002</p> session A session B session C begin;select * from t where id&gt;10 and id&lt;=11 for update; update t set d=d+1 where id=20;(blocked) insert into t values(16,16,16);(blocked) <p>session A \u662f\u4e00\u4e2a\u8303\u56f4\u67e5\u8be2\uff0c\u6309\u7167\u539f\u5219 1 \u7684\u8bdd\uff0c\u5e94\u8be5\u662f\u7d22\u5f15 id \u4e0a\u53ea\u52a0 (10,15] \u8fd9\u4e2a next-key lock\uff0c\u5e76\u4e14\u56e0\u4e3a id \u662f\u552f\u4e00\u952e\uff0c\u6240\u4ee5\u5faa\u73af\u5224\u65ad\u5230 id=15 \u8fd9\u4e00\u884c\u5c31\u5e94\u8be5\u505c\u6b62\u4e86\u3002</p> <p>\u4f46\u662f\u5b9e\u73b0\u4e0a\uff0cInnoDB \u4f1a\u5f80\u524d\u626b\u63cf\u5230\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u4e3a\u6b62\uff0c\u4e5f\u5c31\u662f id=20\u3002\u800c\u4e14\u7531\u4e8e\u8fd9\u662f\u4e2a\u8303\u56f4\u626b\u63cf\uff0c\u56e0\u6b64\u7d22\u5f15 id \u4e0a\u7684 (15,20] \u8fd9\u4e2a next-key lock \u4e5f\u4f1a\u88ab\u9501\u4e0a\u3002</p> <p>\u6240\u4ee5\u4f60\u770b\u5230\u4e86\uff0csession B \u8981\u66f4\u65b0 id=20 \u8fd9\u4e00\u884c\uff0c\u662f\u4f1a\u88ab\u9501\u4f4f\u7684\u3002\u540c\u6837\u5730\uff0csession C \u8981\u63d2\u5165 id=16 \u7684\u4e00\u884c\uff0c\u4e5f\u4f1a\u88ab\u9501\u4f4f\u3002</p> <p>\u7167\u7406\u8bf4\uff0c\u8fd9\u91cc\u9501\u4f4f id=20 \u8fd9\u4e00\u884c\u7684\u884c\u4e3a\uff0c\u5176\u5b9e\u662f\u6ca1\u6709\u5fc5\u8981\u7684\u3002\u56e0\u4e3a\u626b\u63cf\u5230 id=15\uff0c\u5c31\u53ef\u4ee5\u786e\u5b9a\u4e0d\u7528\u5f80\u540e\u518d\u627e\u4e86\u3002\u4f46\u5b9e\u73b0\u4e0a\u8fd8\u662f\u8fd9\u4e48\u505a\u4e86\uff0c\u56e0\u6b64\u6211\u8ba4\u4e3a\u8fd9\u662f\u4e2a bug\u3002</p> <p>\u6211\u4e5f\u66fe\u627e\u793e\u533a\u7684\u4e13\u5bb6\u8ba8\u8bba\u8fc7\uff0c\u5b98\u65b9 bug \u7cfb\u7edf\u4e0a\u4e5f\u6709\u63d0\u5230\uff0c\u4f46\u662f\u5e76\u672a\u88ab verified\u3002\u6240\u4ee5\uff0c\u8ba4\u4e3a\u8fd9\u662f bug \u8fd9\u4e2a\u4e8b\u513f\uff0c\u4e5f\u53ea\u80fd\u7b97\u6211\u7684\u4e00\u5bb6\u4e4b\u8a00\uff0c\u5982\u679c\u4f60\u6709\u5176\u4ed6\u89c1\u89e3\u7684\u8bdd\uff0c\u4e5f\u6b22\u8fce\u4f60\u63d0\u51fa\u6765\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_9","title":"\u6848\u4f8b\u516d\uff1a\u975e\u552f\u4e00\u7d22\u5f15\u4e0a\u5b58\u5728\"\u7b49\u503c\"\u7684\u4f8b\u5b50","text":"<p>\u63a5\u4e0b\u6765\u7684\u4f8b\u5b50\uff0c\u662f\u4e3a\u4e86\u66f4\u597d\u5730\u8bf4\u660e\u201c\u95f4\u9699\u201d\u8fd9\u4e2a\u6982\u5ff5\u3002\u8fd9\u91cc\uff0c\u6211\u7ed9\u8868 t \u63d2\u5165\u4e00\u6761\u65b0\u8bb0\u5f55\u3002</p> <pre><code>mysql&gt; insert into t values(30,10,30);\n</code></pre> <p>\u65b0\u63d2\u5165\u7684\u8fd9\u4e00\u884c c=10\uff0c\u4e5f\u5c31\u662f\u8bf4\u73b0\u5728\u8868\u91cc\u6709\u4e24\u4e2a c=10 \u7684\u884c\u3002\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7d22\u5f15 c \u4e0a\u7684\u95f4\u9699\u662f\u4ec0\u4e48\u72b6\u6001\u4e86\u5462\uff1f\u4f60\u8981\u77e5\u9053\uff0c\u7531\u4e8e\u975e\u552f\u4e00\u7d22\u5f15\u4e0a\u5305\u542b\u4e3b\u952e\u7684\u503c\uff0c\u6240\u4ee5\u662f\u4e0d\u53ef\u80fd\u5b58\u5728\u201c\u76f8\u540c\u201d\u7684\u4e24\u884c\u7684\u3002</p> <p></p> <p>\u56fe 6 \u975e\u552f\u4e00\u7d22\u5f15\u7b49\u503c\u7684\u4f8b\u5b50</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u867d\u7136\u6709\u4e24\u4e2a c=10\uff0c\u4f46\u662f\u5b83\u4eec\u7684\u4e3b\u952e\u503c id \u662f\u4e0d\u540c\u7684\uff08\u5206\u522b\u662f 10 \u548c 30\uff09\uff0c\u56e0\u6b64\u8fd9\u4e24\u4e2a c=10 \u7684\u8bb0\u5f55\u4e4b\u95f4\uff0c\u4e5f\u662f\u6709\u95f4\u9699\u7684\u3002</p> <p>\u56fe\u4e2d\u6211\u753b\u51fa\u4e86\u7d22\u5f15 c \u4e0a\u7684\u4e3b\u952e id\u3002\u4e3a\u4e86\u8ddf\u95f4\u9699\u9501\u7684\u5f00\u533a\u95f4\u5f62\u5f0f\u8fdb\u884c\u533a\u522b\uff0c\u6211\u7528 <code>(c=10,id=30)</code> \u8fd9\u6837\u7684\u5f62\u5f0f\uff0c\u6765\u8868\u793a\u7d22\u5f15\u4e0a\u7684\u4e00\u884c\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u6848\u4f8b\u516d\u3002</p> <p>\u8fd9\u6b21\u6211\u4eec\u7528 delete \u8bed\u53e5\u6765\u9a8c\u8bc1\u3002\u6ce8\u610f\uff0cdelete \u8bed\u53e5\u52a0\u9501\u7684\u903b\u8f91\uff0c\u5176\u5b9e\u8ddf <code>select ... for update</code> \u662f\u7c7b\u4f3c\u7684\uff0c\u4e5f\u5c31\u662f\u6211\u5728\u6587\u7ae0\u5f00\u59cb\u603b\u7ed3\u7684\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\u3002</p> session A session B session C begin;delete from t where c=10; insert into t values(12,12,12);(blocked) update t set d =d+1 where c=15;(Query OK) <p>\u8fd9\u65f6\uff0csession A \u5728\u904d\u5386\u7684\u65f6\u5019\uff0c\u5148\u8bbf\u95ee\u7b2c\u4e00\u4e2a c=10 \u7684\u8bb0\u5f55\u3002\u540c\u6837\u5730\uff0c\u6839\u636e\u539f\u5219 1\uff0c\u8fd9\u91cc\u52a0\u7684\u662f <code>(c=5,id=5)</code> \u5230 <code>(c=10,id=10)</code> \u8fd9\u4e2a next-key lock\u3002</p> <p>\u7136\u540e\uff0csession A \u5411\u53f3\u67e5\u627e\uff0c\u76f4\u5230\u78b0\u5230 <code>(c=15,id=15)</code> \u8fd9\u4e00\u884c\uff0c\u5faa\u73af\u624d\u7ed3\u675f\u3002\u6839\u636e\u4f18\u5316 2\uff0c\u8fd9\u662f\u4e00\u4e2a\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u67e5\u627e\u5230\u4e86\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u6240\u4ee5\u4f1a\u9000\u5316\u6210 <code>(c=10,id=10)</code> \u5230 <code>(c=15,id=15)</code> \u7684\u95f4\u9699\u9501\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a delete \u8bed\u53e5\u5728\u7d22\u5f15 c \u4e0a\u7684\u52a0\u9501\u8303\u56f4\uff0c\u5c31\u662f\u4e0b\u56fe\u4e2d\u84dd\u8272\u533a\u57df\u8986\u76d6\u7684\u90e8\u5206\u3002</p> <p>\u56fe 8 delete \u52a0\u9501\u6548\u679c\u793a\u4f8b</p> <p>\u8fd9\u4e2a\u84dd\u8272\u533a\u57df\u5de6\u53f3\u4e24\u8fb9\u90fd\u662f\u865a\u7ebf\uff0c\u8868\u793a\u5f00\u533a\u95f4\uff0c\u5373 (c=5,id=5) \u548c (c=15,id=15) \u8fd9\u4e24\u884c\u4e0a\u90fd\u6ca1\u6709\u9501\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#limit","title":"\u6848\u4f8b\u4e03\uff1alimit \u8bed\u53e5\u52a0\u9501","text":"<p>\u4f8b\u5b50 6 \u4e5f\u6709\u4e00\u4e2a\u5bf9\u7167\u6848\u4f8b\uff0c\u573a\u666f\u5982\u4e0b\u6240\u793a\uff1a</p> session A session B begin;delete from t where c=10 limit 2; insert into t values(12,12,12);(Query OK) <p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0csession A \u7684 delete \u8bed\u53e5\u52a0\u4e86 limit 2\u3002\u4f60\u77e5\u9053\u8868 t \u91cc c=10 \u7684\u8bb0\u5f55\u5176\u5b9e\u53ea\u6709\u4e24\u6761\uff0c\u56e0\u6b64\u52a0\u4e0d\u52a0 limit 2\uff0c\u5220\u9664\u7684\u6548\u679c\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u52a0\u9501\u7684\u6548\u679c\u5374\u4e0d\u540c\u3002\u53ef\u4ee5\u770b\u5230\uff0csession B \u7684 insert \u8bed\u53e5\u6267\u884c\u901a\u8fc7\u4e86\uff0c\u8ddf\u6848\u4f8b\u516d\u7684\u7ed3\u679c\u4e0d\u540c\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u6848\u4f8b\u4e03\u91cc\u7684 delete \u8bed\u53e5\u660e\u786e\u52a0\u4e86 limit 2 \u7684\u9650\u5236\uff0c\u56e0\u6b64\u5728\u904d\u5386\u5230 (c=10, id=30) \u8fd9\u4e00\u884c\u4e4b\u540e\uff0c\u6ee1\u8db3\u6761\u4ef6\u7684\u8bed\u53e5\u5df2\u7ecf\u6709\u4e24\u6761\uff0c\u5faa\u73af\u5c31\u7ed3\u675f\u4e86\u3002</p> <p>\u56e0\u6b64\uff0c\u7d22\u5f15 c \u4e0a\u7684\u52a0\u9501\u8303\u56f4\u5c31\u53d8\u6210\u4e86\u4ece\uff08c=5,id=5) \u5230\uff08c=10,id=30) \u8fd9\u4e2a\u524d\u5f00\u540e\u95ed\u533a\u95f4\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p>\u56fe 10 \u5e26 limit 2 \u7684\u52a0\u9501\u6548\u679c</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c(c=10,id=30\uff09\u4e4b\u540e\u7684\u8fd9\u4e2a\u95f4\u9699\u5e76\u6ca1\u6709\u5728\u52a0\u9501\u8303\u56f4\u91cc\uff0c\u56e0\u6b64 insert \u8bed\u53e5\u63d2\u5165 c=12 \u662f\u53ef\u4ee5\u6267\u884c\u6210\u529f\u7684\u3002</p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u6211\u4eec\u5b9e\u8df5\u7684\u6307\u5bfc\u610f\u4e49\u5c31\u662f\uff0c\u5728\u5220\u9664\u6570\u636e\u7684\u65f6\u5019\u5c3d\u91cf\u52a0 limit\u3002\u8fd9\u6837\u4e0d\u4ec5\u53ef\u4ee5\u63a7\u5236\u5220\u9664\u6570\u636e\u7684\u6761\u6570\uff0c\u8ba9\u64cd\u4f5c\u66f4\u5b89\u5168\uff0c\u8fd8\u53ef\u4ee5\u51cf\u5c0f\u52a0\u9501\u7684\u8303\u56f4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_10","title":"\u6848\u4f8b\u516b\uff1a\u4e00\u4e2a\u6b7b\u9501\u7684\u4f8b\u5b50","text":"<p>\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u5728\u5206\u6790\u7684\u65f6\u5019\uff0c\u662f\u6309\u7167 next-key lock \u7684\u903b\u8f91\u6765\u5206\u6790\u7684\uff0c\u56e0\u4e3a\u8fd9\u6837\u5206\u6790\u6bd4\u8f83\u65b9\u4fbf\u3002\u6700\u540e\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u6848\u4f8b\uff0c\u76ee\u7684\u662f\u8bf4\u660e\uff1anext-key lock \u5b9e\u9645\u4e0a\u662f\u95f4\u9699\u9501\u548c\u884c\u9501\u52a0\u8d77\u6765\u7684\u7ed3\u679c\u3002</p> <p>\u4f60\u4e00\u5b9a\u4f1a\u7591\u60d1\uff0c\u8fd9\u4e2a\u6982\u5ff5\u4e0d\u662f\u4e00\u5f00\u59cb\u5c31\u8bf4\u4e86\u5417\uff1f\u4e0d\u8981\u7740\u6025\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p> session A session B begin;select id from t where c=10 lock in share mode; update t set d=d+1 where c=10;(blocked) insert into t values(8,8,8); ERROR 1213 (40001):Deadlock found where trying to get lock;try restarting transaction <p>\u73b0\u5728\uff0c\u6211\u4eec\u6309\u65f6\u95f4\u987a\u5e8f\u6765\u5206\u6790\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u662f\u8fd9\u6837\u7684\u7ed3\u679c\u3002</p> <ol> <li>session A \u542f\u52a8\u4e8b\u52a1\u540e\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u52a0 <code>lock in share mode</code>\uff0c\u5728\u7d22\u5f15 c \u4e0a\u52a0\u4e86 next-key lock(5,10] \u548c\u95f4\u9699\u9501 (10,15)\uff1b</li> <li>session B \u7684 update \u8bed\u53e5\u4e5f\u8981\u5728\u7d22\u5f15 c \u4e0a\u52a0 next-key lock(5,10] \uff0c\u8fdb\u5165\u9501\u7b49\u5f85\uff1b</li> <li>\u7136\u540e session A \u8981\u518d\u63d2\u5165 <code>(8,8,8)</code> \u8fd9\u4e00\u884c\uff0c\u88ab session B \u7684\u95f4\u9699\u9501\u9501\u4f4f\u3002\u7531\u4e8e\u51fa\u73b0\u4e86\u6b7b\u9501\uff0cInnoDB \u8ba9 session B \u56de\u6eda\u3002</li> </ol> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0csession B \u7684 next-key lock \u4e0d\u662f\u8fd8\u6ca1\u7533\u8bf7\u6210\u529f\u5417\uff1f</p> <p>\u5176\u5b9e\u662f\u8fd9\u6837\u7684\uff0csession B \u7684\u201c\u52a0 next-key lock(5,10] \u201d\u64cd\u4f5c\uff0c\u5b9e\u9645\u4e0a\u5206\u6210\u4e86\u4e24\u6b65\uff0c\u5148\u662f\u52a0 (5,10) \u7684\u95f4\u9699\u9501\uff0c\u52a0\u9501\u6210\u529f\uff1b\u7136\u540e\u52a0 c=10 \u7684\u884c\u9501\uff0c\u8fd9\u65f6\u5019\u624d\u88ab\u9501\u4f4f\u7684\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u5728\u5206\u6790\u52a0\u9501\u89c4\u5219\u7684\u65f6\u5019\u53ef\u4ee5\u7528 next-key lock \u6765\u5206\u6790\u3002\u4f46\u662f\u8981\u77e5\u9053\uff0c\u5177\u4f53\u6267\u884c\u7684\u65f6\u5019\uff0c\u662f\u8981\u5206\u6210\u95f4\u9699\u9501\u548c\u884c\u9501\u4e24\u6bb5\u6765\u6267\u884c\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_11","title":"\u5c0f\u7ed3","text":"<p>\u8fd9\u91cc\u6211\u518d\u6b21\u8bf4\u660e\u4e00\u4e0b\uff0c\u6211\u4eec\u4e0a\u9762\u7684\u6240\u6709\u6848\u4f8b\u90fd\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b (repeatable-read) \u4e0b\u9a8c\u8bc1\u7684\u3002\u540c\u65f6\uff0c\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u9075\u5b88\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u6240\u6709\u52a0\u9501\u7684\u8d44\u6e90\uff0c\u90fd\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p> <p>\u5728\u6700\u540e\u7684\u6848\u4f8b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u6e05\u695a\u5730\u77e5\u9053 next-key lock \u5b9e\u9645\u4e0a\u662f\u7531\u95f4\u9699\u9501\u52a0\u884c\u9501\u5b9e\u73b0\u7684\u3002\u5982\u679c\u5207\u6362\u5230\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b (read-committed) \u7684\u8bdd\uff0c\u5c31\u597d\u7406\u89e3\u4e86\uff0c\u8fc7\u7a0b\u4e2d\u53bb\u6389\u95f4\u9699\u9501\u7684\u90e8\u5206\uff0c\u4e5f\u5c31\u662f\u53ea\u5269\u4e0b\u884c\u9501\u7684\u90e8\u5206\u3002</p> <p>\u5176\u5b9e\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u5728\u5916\u952e\u573a\u666f\u4e0b\u8fd8\u662f\u6709\u95f4\u9699\u9501\uff0c\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\uff0c\u6211\u4eec\u4eca\u5929\u5148\u4e0d\u5c55\u5f00\u3002</p> <p>\u53e6\u5916\uff0c\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\u8fd8\u6709\u4e00\u4e2a\u4f18\u5316\uff0c\u5373\uff1a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u52a0\u4e0a\u7684\u884c\u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c31\u8981\u628a\u201c\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u201d\u4e0a\u7684\u884c\u9501\u76f4\u63a5\u91ca\u653e\u4e86\uff0c\u4e0d\u9700\u8981\u7b49\u5230\u4e8b\u52a1\u63d0\u4ea4\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u9501\u7684\u8303\u56f4\u66f4\u5c0f\uff0c\u9501\u7684\u65f6\u95f4\u66f4\u77ed\uff0c\u8fd9\u4e5f\u662f\u4e0d\u5c11\u4e1a\u52a1\u90fd\u9ed8\u8ba4\u4f7f\u7528\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u7684\u539f\u56e0\u3002</p> <p>\u4e0d\u8fc7\uff0c\u6211\u5e0c\u671b\u4f60\u5b66\u8fc7\u4eca\u5929\u7684\u8bfe\u7a0b\u4ee5\u540e\uff0c\u53ef\u4ee5\u5bf9 next-key lock \u7684\u6982\u5ff5\u6709\u66f4\u6e05\u6670\u7684\u8ba4\u8bc6\uff0c\u5e76\u4e14\u4f1a\u7528\u52a0\u9501\u89c4\u5219\u53bb\u5224\u65ad\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u3002</p> <p>\u5728\u4e1a\u52a1\u9700\u8981\u4f7f\u7528\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u7684\u65f6\u5019\uff0c\u80fd\u591f\u66f4\u7ec6\u81f4\u5730\u8bbe\u8ba1\u64cd\u4f5c\u6570\u636e\u5e93\u7684\u8bed\u53e5\uff0c\u89e3\u51b3\u5e7b\u8bfb\u95ee\u9898\u7684\u540c\u65f6\uff0c\u6700\u5927\u9650\u5ea6\u5730\u63d0\u5347\u7cfb\u7edf\u5e76\u884c\u5904\u7406\u4e8b\u52a1\u7684\u80fd\u529b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#22-mysql","title":"22 MySQL\u6709\u54ea\u4e9b\u201c\u996e\u9e29\u6b62\u6e34\u201d\u63d0\u9ad8\u6027\u80fd\u7684\u65b9\u6cd5\uff1f","text":"<p>\u4e0d\u77e5\u9053\u4f60\u5728\u5b9e\u9645\u8fd0\u7ef4\u8fc7\u7a0b\u4e2d\u6709\u6ca1\u6709\u78b0\u5230\u8fd9\u6837\u7684\u60c5\u666f\uff1a\u4e1a\u52a1\u9ad8\u5cf0\u671f\uff0c\u751f\u4ea7\u73af\u5883\u7684 MySQL \u538b\u529b\u592a\u5927\uff0c\u6ca1\u6cd5\u6b63\u5e38\u54cd\u5e94\uff0c\u9700\u8981\u77ed\u671f\u5185\u3001\u4e34\u65f6\u6027\u5730\u63d0\u5347\u4e00\u4e9b\u6027\u80fd\u3002</p> <p>\u6211\u4ee5\u524d\u505a\u4e1a\u52a1\u62a4\u822a\u7684\u65f6\u5019\uff0c\u5c31\u5076\u5c14\u4f1a\u78b0\u4e0a\u8fd9\u79cd\u573a\u666f\u3002\u7528\u6237\u7684\u5f00\u53d1\u8d1f\u8d23\u4eba\u8bf4\uff0c\u4e0d\u7ba1\u4f60\u7528\u4ec0\u4e48\u65b9\u6848\uff0c\u8ba9\u4e1a\u52a1\u5148\u8dd1\u8d77\u6765\u518d\u8bf4\u3002</p> <p>\u4f46\uff0c\u5982\u679c\u662f\u65e0\u635f\u65b9\u6848\u7684\u8bdd\uff0c\u80af\u5b9a\u4e0d\u9700\u8981\u7b49\u5230\u8fd9\u4e2a\u65f6\u5019\u624d\u4e0a\u573a\u3002\u4eca\u5929\u6211\u4eec\u5c31\u6765\u804a\u804a\u8fd9\u4e9b\u4e34\u65f6\u65b9\u6848\uff0c\u5e76\u7740\u91cd\u8bf4\u4e00\u8bf4\u5b83\u4eec\u53ef\u80fd\u5b58\u5728\u7684\u98ce\u9669\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_12","title":"\u77ed\u8fde\u63a5\u98ce\u66b4","text":"<p>\u6b63\u5e38\u7684\u77ed\u8fde\u63a5\u6a21\u5f0f\u5c31\u662f\u8fde\u63a5\u5230\u6570\u636e\u5e93\u540e\uff0c\u6267\u884c\u5f88\u5c11\u7684 SQL \u8bed\u53e5\u5c31\u65ad\u5f00\uff0c\u4e0b\u6b21\u9700\u8981\u7684\u65f6\u5019\u518d\u91cd\u8fde\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f\u77ed\u8fde\u63a5\uff0c\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u8fde\u63a5\u6570\u7a81\u7136\u66b4\u6da8\u7684\u60c5\u51b5\u3002</p> <p>\u6211\u5728\u7b2c 1 \u7bc7\u6587\u7ae0[\u300a\u57fa\u7840\u67b6\u6784\uff1a\u4e00\u6761 SQL \u67e5\u8be2\u8bed\u53e5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1f\u300b]\u4e2d\u8bf4\u8fc7\uff0cMySQL \u5efa\u7acb\u8fde\u63a5\u7684\u8fc7\u7a0b\uff0c\u6210\u672c\u662f\u5f88\u9ad8\u7684\u3002\u9664\u4e86\u6b63\u5e38\u7684\u7f51\u7edc\u8fde\u63a5\u4e09\u6b21\u63e1\u624b\u5916\uff0c\u8fd8\u9700\u8981\u505a\u767b\u5f55\u6743\u9650\u5224\u65ad\u548c\u83b7\u5f97\u8fd9\u4e2a\u8fde\u63a5\u7684\u6570\u636e\u8bfb\u5199\u6743\u9650\u3002</p> <p>\u5728\u6570\u636e\u5e93\u538b\u529b\u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u989d\u5916\u7684\u6210\u672c\u5e76\u4e0d\u660e\u663e\u3002</p> <p>\u4f46\u662f\uff0c\u77ed\u8fde\u63a5\u6a21\u578b\u5b58\u5728\u4e00\u4e2a\u98ce\u9669\uff0c\u5c31\u662f\u4e00\u65e6\u6570\u636e\u5e93\u5904\u7406\u5f97\u6162\u4e00\u4e9b\uff0c\u8fde\u63a5\u6570\u5c31\u4f1a\u66b4\u6da8\u3002<code>max_connections</code> \u53c2\u6570\uff0c\u7528\u6765\u63a7\u5236\u4e00\u4e2a MySQL \u5b9e\u4f8b\u540c\u65f6\u5b58\u5728\u7684\u8fde\u63a5\u6570\u7684\u4e0a\u9650\uff0c\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u62d2\u7edd\u63a5\u4e0b\u6765\u7684\u8fde\u63a5\u8bf7\u6c42\uff0c\u5e76\u62a5\u9519\u63d0\u793a \u201cToo many connections\u201d\u3002\u5bf9\u4e8e\u88ab\u62d2\u7edd\u8fde\u63a5\u7684\u8bf7\u6c42\u6765\u8bf4\uff0c\u4ece\u4e1a\u52a1\u89d2\u5ea6\u770b\u5c31\u662f\u6570\u636e\u5e93\u4e0d\u53ef\u7528\u3002</p> <p>\u5728\u673a\u5668\u8d1f\u8f7d\u6bd4\u8f83\u9ad8\u7684\u65f6\u5019\uff0c\u5904\u7406\u73b0\u6709\u8bf7\u6c42\u7684\u65f6\u95f4\u53d8\u957f\uff0c\u6bcf\u4e2a\u8fde\u63a5\u4fdd\u6301\u7684\u65f6\u95f4\u4e5f\u66f4\u957f\u3002\u8fd9\u65f6\uff0c\u518d\u6709\u65b0\u5efa\u8fde\u63a5\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u4f1a\u8d85\u8fc7 <code>max_connections</code> \u7684\u9650\u5236\u3002</p> <p>\u78b0\u5230\u8fd9\u79cd\u60c5\u51b5\u65f6\uff0c\u4e00\u4e2a\u6bd4\u8f83\u81ea\u7136\u7684\u60f3\u6cd5\uff0c\u5c31\u662f\u8c03\u9ad8 <code>max_connections</code> \u7684\u503c\u3002\u4f46\u8fd9\u6837\u505a\u662f\u6709\u98ce\u9669\u7684\u3002\u56e0\u4e3a\u8bbe\u8ba1 <code>max_connections</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u76ee\u7684\u662f\u60f3\u4fdd\u62a4 MySQL\uff0c\u5982\u679c\u6211\u4eec\u628a\u5b83\u6539\u5f97\u592a\u5927\uff0c\u8ba9\u66f4\u591a\u7684\u8fde\u63a5\u90fd\u53ef\u4ee5\u8fdb\u6765\uff0c\u90a3\u4e48\u7cfb\u7edf\u7684\u8d1f\u8f7d\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u52a0\u5927\uff0c\u5927\u91cf\u7684\u8d44\u6e90\u8017\u8d39\u5728\u6743\u9650\u9a8c\u8bc1\u7b49\u903b\u8f91\u4e0a\uff0c\u7ed3\u679c\u53ef\u80fd\u662f\u9002\u5f97\u5176\u53cd\uff0c\u5df2\u7ecf\u8fde\u63a5\u7684\u7ebf\u7a0b\u62ff\u4e0d\u5230 CPU \u8d44\u6e90\u53bb\u6267\u884c\u4e1a\u52a1\u7684 SQL \u8bf7\u6c42\u3002</p> <p>\u90a3\u4e48\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u5efa\u8bae\u5462\uff1f\u6211\u8fd9\u91cc\u8fd8\u6709\u4e24\u79cd\u65b9\u6cd5\uff0c\u4f46\u8981\u6ce8\u610f\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u90fd\u662f\u6709\u635f\u7684\u3002</p> <p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff1a\u5148\u5904\u7406\u6389\u90a3\u4e9b\u5360\u7740\u8fde\u63a5\u4f46\u662f\u4e0d\u5de5\u4f5c\u7684\u7ebf\u7a0b\u3002</p> <p><code>max_connections</code> \u7684\u8ba1\u7b97\uff0c\u4e0d\u662f\u770b\u8c01\u5728 running\uff0c\u662f\u53ea\u8981\u8fde\u7740\u5c31\u5360\u7528\u4e00\u4e2a\u8ba1\u6570\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u90a3\u4e9b\u4e0d\u9700\u8981\u4fdd\u6301\u7684\u8fde\u63a5\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kill connection</code> \u4e3b\u52a8\u8e22\u6389\u3002\u8fd9\u4e2a\u884c\u4e3a\u8ddf\u4e8b\u5148\u8bbe\u7f6e <code>wait_timeout</code> \u7684\u6548\u679c\u662f\u4e00\u6837\u7684\u3002\u8bbe\u7f6e <code>wait_timeout</code> \u53c2\u6570\u8868\u793a\u7684\u662f\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u7a7a\u95f2 <code>wait_timeout</code> \u8fd9\u4e48\u591a\u79d2\u4e4b\u540e\uff0c\u5c31\u4f1a\u88ab MySQL \u76f4\u63a5\u65ad\u5f00\u8fde\u63a5\u3002</p> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\uff0c\u5728 show processlist \u7684\u7ed3\u679c\u91cc\uff0c\u8e22\u6389\u663e\u793a\u4e3a sleep \u7684\u7ebf\u7a0b\uff0c\u53ef\u80fd\u662f\u6709\u635f\u7684\u3002\u6211\u4eec\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u3002</p> session A session B session C T begin;insert into t values(1,1); select * from t where id=1; T+30s show processlist; <p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5982\u679c\u65ad\u5f00 session A \u7684\u8fde\u63a5\uff0c\u56e0\u4e3a\u8fd9\u65f6\u5019 session A \u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5 MySQL \u53ea\u80fd\u6309\u7167\u56de\u6eda\u4e8b\u52a1\u6765\u5904\u7406\uff1b\u800c\u65ad\u5f00 session B \u7684\u8fde\u63a5\uff0c\u5c31\u6ca1\u4ec0\u4e48\u5927\u5f71\u54cd\u3002\u6240\u4ee5\uff0c\u5982\u679c\u6309\u7167\u4f18\u5148\u7ea7\u6765\u8bf4\uff0c\u4f60\u5e94\u8be5\u4f18\u5148\u65ad\u5f00\u50cf session B \u8fd9\u6837\u7684\u4e8b\u52a1\u5916\u7a7a\u95f2\u7684\u8fde\u63a5\u3002</p> <p>\u4f46\u662f\uff0c\u600e\u4e48\u5224\u65ad\u54ea\u4e9b\u662f\u4e8b\u52a1\u5916\u7a7a\u95f2\u7684\u5462\uff1fsession C \u5728 T \u65f6\u523b\u4e4b\u540e\u7684 30 \u79d2\u6267\u884c show processlist\uff0c\u770b\u5230\u7684\u7ed3\u679c\u662f\u8fd9\u6837\u7684\u3002</p> <pre><code>mysql&gt; show processlist;\n+----+-----------------+-----------+------+---------+-------+------------------------+------------------+\n| Id | User            | Host      | db   | Command | Time  | State                  | Info             |\n+----+-----------------+-----------+------+---------+-------+------------------------+------------------+\n|  4 | event_scheduler | localhost | NULL | Daemon  | 86184 | Waiting on empty queue | NULL             |\n| 20 | root            | localhost | test | Sleep   |    13 |                        | NULL             |\n| 22 | root            | localhost | test | Sleep   |     4 |                        | NULL             |\n| 23 | root            | localhost | NULL | Query   |     0 | starting               | show processlist |\n+----+-----------------+-----------+------+---------+-------+------------------------+------------------+\n</code></pre> <p>\u56fe\u4e2d id=20 \u548c id=22 \u7684\u4e24\u4e2a\u4f1a\u8bdd\u90fd\u662f Sleep \u72b6\u6001\u3002\u800c\u8981\u770b\u4e8b\u52a1\u5177\u4f53\u72b6\u6001\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u67e5 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8868\u3002</p> <pre><code>mysql&gt; select * from information_schema.innodb_trx \\G;\n*************************** 1. row ***************************\n                    trx_id: 588510\n                 trx_state: RUNNING\n               trx_started: 2023-02-01 14:52:57\n     trx_requested_lock_id: NULL\n          trx_wait_started: NULL\n                trx_weight: 2\n       trx_mysql_thread_id: 20\n                 trx_query: NULL\n       trx_operation_state: NULL\n         trx_tables_in_use: 0\n         trx_tables_locked: 1\n          trx_lock_structs: 1\n     trx_lock_memory_bytes: 1136\n           trx_rows_locked: 0\n         trx_rows_modified: 1\n   trx_concurrency_tickets: 0\n       trx_isolation_level: REPEATABLE READ\n         trx_unique_checks: 1\n    trx_foreign_key_checks: 1\ntrx_last_foreign_key_error: NULL\n trx_adaptive_hash_latched: 0\n trx_adaptive_hash_timeout: 0\n          trx_is_read_only: 0\ntrx_autocommit_non_locking: 0\n1 row in set (0.00 sec)\n</code></pre> <p>\u8fd9\u4e2a\u7ed3\u679c\u91cc\uff0c<code>trx_mysql_thread_id=20</code>\uff0c\u8868\u793a id=20 \u7684\u7ebf\u7a0b\u8fd8\u5904\u5728\u4e8b\u52a1\u4e2d\u3002</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u662f\u8fde\u63a5\u6570\u8fc7\u591a\uff0c\u4f60\u53ef\u4ee5\u4f18\u5148\u65ad\u5f00\u4e8b\u52a1\u5916\u7a7a\u95f2\u592a\u4e45\u7684\u8fde\u63a5\uff1b\u5982\u679c\u8fd9\u6837\u8fd8\u4e0d\u591f\uff0c\u518d\u8003\u8651\u65ad\u5f00\u4e8b\u52a1\u5185\u7a7a\u95f2\u592a\u4e45\u7684\u8fde\u63a5\u3002</p> <p>\u4ece\u670d\u52a1\u7aef\u65ad\u5f00\u8fde\u63a5\u4f7f\u7528\u7684\u662f <code>kill connection + id</code> \u7684\u547d\u4ee4\uff0c \u4e00\u4e2a\u5ba2\u6237\u7aef\u5904\u4e8e sleep \u72b6\u6001\u65f6\uff0c\u5b83\u7684\u8fde\u63a5\u88ab\u670d\u52a1\u7aef\u4e3b\u52a8\u65ad\u5f00\u540e\uff0c\u8fd9\u4e2a\u5ba2\u6237\u7aef\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u77e5\u9053\u3002\u76f4\u5230\u5ba2\u6237\u7aef\u5728\u53d1\u8d77\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u624d\u4f1a\u6536\u5230\u8fd9\u6837\u7684\u62a5\u9519 <code>ERROR 2013 (HY000): Lost connection to MySQL server during query</code>\u3002</p> <p>\u4ece\u6570\u636e\u5e93\u7aef\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\u53ef\u80fd\u662f\u6709\u635f\u7684\uff0c\u5c24\u5176\u662f\u6709\u7684\u5e94\u7528\u7aef\u6536\u5230\u8fd9\u4e2a\u9519\u8bef\u540e\uff0c\u4e0d\u91cd\u65b0\u8fde\u63a5\uff0c\u800c\u662f\u76f4\u63a5\u7528\u8fd9\u4e2a\u5df2\u7ecf\u4e0d\u80fd\u7528\u7684\u53e5\u67c4\u91cd\u8bd5\u67e5\u8be2\u3002\u8fd9\u4f1a\u5bfc\u81f4\u4ece\u5e94\u7528\u7aef\u770b\u4e0a\u53bb\uff0c\u201cMySQL \u4e00\u76f4\u6ca1\u6062\u590d\u201d\u3002</p> <p>\u4f60\u53ef\u80fd\u89c9\u5f97\u8fd9\u662f\u4e00\u4e2a\u51b7\u7b11\u8bdd\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u78b0\u5230\u8fc7\u4e0d\u4e0b 10 \u6b21\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u662f\u4e00\u4e2a\u652f\u6301\u4e1a\u52a1\u7684 DBA\uff0c\u4e0d\u8981\u5047\u8bbe\u6240\u6709\u7684\u5e94\u7528\u4ee3\u7801\u90fd\u4f1a\u88ab\u6b63\u786e\u5730\u5904\u7406\u3002\u5373\u4f7f\u53ea\u662f\u4e00\u4e2a\u65ad\u5f00\u8fde\u63a5\u7684\u64cd\u4f5c\uff0c\u4e5f\u8981\u786e\u4fdd\u901a\u77e5\u5230\u4e1a\u52a1\u5f00\u53d1\u56e2\u961f\u3002</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff1a\u51cf\u5c11\u8fde\u63a5\u8fc7\u7a0b\u7684\u6d88\u8017\u3002</p> <p>\u6709\u7684\u4e1a\u52a1\u4ee3\u7801\u4f1a\u5728\u77ed\u65f6\u95f4\u5185\u5148\u5927\u91cf\u7533\u8bf7\u6570\u636e\u5e93\u8fde\u63a5\u505a\u5907\u7528\uff0c\u5982\u679c\u73b0\u5728\u6570\u636e\u5e93\u786e\u8ba4\u662f\u88ab\u8fde\u63a5\u884c\u4e3a\u6253\u6302\u4e86\uff0c\u90a3\u4e48\u4e00\u79cd\u53ef\u80fd\u7684\u505a\u6cd5\uff0c\u662f\u8ba9\u6570\u636e\u5e93\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u9636\u6bb5\u3002</p> <p>\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u7684\u65b9\u6cd5\u662f\uff1a\u91cd\u542f\u6570\u636e\u5e93\uff0c\u5e76\u4f7f\u7528 <code>\u2013-skip-grant-tables</code> \u53c2\u6570\u542f\u52a8\u3002\u8fd9\u6837\uff0c\u6574\u4e2a MySQL \u4f1a\u8df3\u8fc7\u6240\u6709\u7684\u6743\u9650\u9a8c\u8bc1\u9636\u6bb5\uff0c\u5305\u62ec\u8fde\u63a5\u8fc7\u7a0b\u548c\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u5728\u5185\u3002</p> <p>\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7279\u522b\u7b26\u5408\u6211\u4eec\u6807\u9898\u91cc\u8bf4\u7684\u201c\u996e\u9e29\u6b62\u6e34\u201d\uff0c\u98ce\u9669\u6781\u9ad8\uff0c\u662f\u6211\u7279\u522b\u4e0d\u5efa\u8bae\u4f7f\u7528\u7684\u65b9\u6848\u3002\u5c24\u5176\u4f60\u7684\u5e93\u5916\u7f51\u53ef\u8bbf\u95ee\u7684\u8bdd\uff0c\u5c31\u66f4\u4e0d\u80fd\u8fd9\u4e48\u505a\u4e86\u3002</p> <p>\u5728 MySQL 8.0 \u7248\u672c\u91cc\uff0c\u5982\u679c\u4f60\u542f\u7528 <code>-\u2013skip-grant-tables</code> \u53c2\u6570\uff0cMySQL \u4f1a\u9ed8\u8ba4\u628a <code>--skip-networking</code> \u53c2\u6570\u6253\u5f00\uff0c\u8868\u793a\u8fd9\u65f6\u5019\u6570\u636e\u5e93\u53ea\u80fd\u88ab\u672c\u5730\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u3002\u53ef\u89c1\uff0cMySQL \u5b98\u65b9\u5bf9 <code>--skip-grant-tables</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u5b89\u5168\u95ee\u9898\u4e5f\u5f88\u91cd\u89c6\u3002</p> <p>\u9664\u4e86\u77ed\u8fde\u63a5\u6570\u66b4\u589e\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u95ee\u9898\u5916\uff0c\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5728\u7ebf\u4e0a\u78b0\u5230\u66f4\u591a\u7684\u662f\u67e5\u8be2\u6216\u8005\u66f4\u65b0\u8bed\u53e5\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u3002\u5176\u4e2d\uff0c\u67e5\u8be2\u95ee\u9898\u6bd4\u8f83\u5178\u578b\u7684\u6709\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u7531\u65b0\u51fa\u73b0\u7684\u6162\u67e5\u8be2\u5bfc\u81f4\u7684\uff0c\u4e00\u7c7b\u662f\u7531 QPS\uff08\u6bcf\u79d2\u67e5\u8be2\u6570\uff09\u7a81\u589e\u5bfc\u81f4\u7684\u3002\u800c\u5173\u4e8e\u66f4\u65b0\u8bed\u53e5\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u548c\u4f60\u5c55\u5f00\u8bf4\u660e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_13","title":"\u6162\u67e5\u8be2\u6027\u80fd\u95ee\u9898","text":"<p>\u5728 MySQL \u4e2d\uff0c\u4f1a\u5f15\u53d1\u6027\u80fd\u95ee\u9898\u7684\u6162\u67e5\u8be2\uff0c\u5927\u4f53\u6709\u4ee5\u4e0b\u4e09\u79cd\u53ef\u80fd\uff1a</p> <ol> <li>\u7d22\u5f15\u6ca1\u6709\u8bbe\u8ba1\u597d\uff1b</li> <li>SQL \u8bed\u53e5\u6ca1\u5199\u597d\uff1b</li> <li>MySQL \u9009\u9519\u4e86\u7d22\u5f15\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5177\u4f53\u5206\u6790\u4e00\u4e0b\u8fd9\u4e09\u79cd\u53ef\u80fd\uff0c\u4ee5\u53ca\u5bf9\u5e94\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e00\u79cd\u53ef\u80fd\u662f\uff0c\u7d22\u5f15\u6ca1\u6709\u8bbe\u8ba1\u597d\u3002</p> <p>\u8fd9\u79cd\u573a\u666f\u4e00\u822c\u5c31\u662f\u901a\u8fc7\u7d27\u6025\u521b\u5efa\u7d22\u5f15\u6765\u89e3\u51b3\u3002MySQL 5.6 \u7248\u672c\u4ee5\u540e\uff0c\u521b\u5efa\u7d22\u5f15\u90fd\u652f\u6301 Online DDL \u4e86\uff0c\u5bf9\u4e8e\u90a3\u79cd\u9ad8\u5cf0\u671f\u6570\u636e\u5e93\u5df2\u7ecf\u88ab\u8fd9\u4e2a\u8bed\u53e5\u6253\u6302\u4e86\u7684\u60c5\u51b5\uff0c\u6700\u9ad8\u6548\u7684\u505a\u6cd5\u5c31\u662f\u76f4\u63a5\u6267\u884c alter table \u8bed\u53e5\u3002</p> <p>\u6bd4\u8f83\u7406\u60f3\u7684\u662f\u80fd\u591f\u5728\u5907\u5e93\u5148\u6267\u884c\u3002\u5047\u8bbe\u4f60\u73b0\u5728\u7684\u670d\u52a1\u662f\u4e00\u4e3b\u4e00\u5907\uff0c\u4e3b\u5e93 A\u3001\u5907\u5e93 B\uff0c\u8fd9\u4e2a\u65b9\u6848\u7684\u5927\u81f4\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5728\u5907\u5e93 B \u4e0a\u6267\u884c <code>set sql_log_bin=off</code>\uff0c\u4e5f\u5c31\u662f\u4e0d\u5199 binlog\uff0c\u7136\u540e\u6267\u884c alter table \u8bed\u53e5\u52a0\u4e0a\u7d22\u5f15\uff1b</li> <li>\u6267\u884c\u4e3b\u5907\u5207\u6362\uff1b</li> <li>\u8fd9\u65f6\u5019\u4e3b\u5e93\u662f B\uff0c\u5907\u5e93\u662f A\u3002\u5728 A \u4e0a\u6267\u884c <code>set sql_log_bin=off</code>\uff0c\u7136\u540e\u6267\u884c alter table \u8bed\u53e5\u52a0\u4e0a\u7d22\u5f15\u3002</li> </ol> <p>\u8fd9\u662f\u4e00\u4e2a\u201c\u53e4\u8001\u201d\u7684 DDL \u65b9\u6848\u3002\u5e73\u65f6\u5728\u505a\u53d8\u66f4\u7684\u65f6\u5019\uff0c\u4f60\u5e94\u8be5\u8003\u8651\u7c7b\u4f3c gh-ost \u8fd9\u6837\u7684\u65b9\u6848\uff0c\u66f4\u52a0\u7a33\u59a5\u3002\u4f46\u662f\u5728\u9700\u8981\u7d27\u6025\u5904\u7406\u65f6\uff0c\u4e0a\u9762\u8fd9\u4e2a\u65b9\u6848\u7684\u6548\u7387\u662f\u6700\u9ad8\u7684\u3002</p> <p>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e8c\u79cd\u53ef\u80fd\u662f\uff0c\u8bed\u53e5\u6ca1\u5199\u597d\u3002</p> <p>\u6bd4\u5982\uff0c\u6211\u4eec\u72af\u4e86\u5728\u7b2c 18 \u7bc7\u6587\u7ae0[\u300a\u4e3a\u4ec0\u4e48\u8fd9\u4e9b SQL \u8bed\u53e5\u903b\u8f91\u76f8\u540c\uff0c\u6027\u80fd\u5374\u5dee\u5f02\u5de8\u5927\uff1f\u300b]\u4e2d\u63d0\u5230\u7684\u90a3\u4e9b\u9519\u8bef\uff0c\u5bfc\u81f4\u8bed\u53e5\u6ca1\u6709\u4f7f\u7528\u4e0a\u7d22\u5f15\u3002</p> <p>\u8fd9\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6539\u5199 SQL \u8bed\u53e5\u6765\u5904\u7406\u3002MySQL 5.7 \u63d0\u4f9b\u4e86 <code>query_rewrite</code> \u529f\u80fd\uff0c\u53ef\u4ee5\u628a\u8f93\u5165\u7684\u4e00\u79cd\u8bed\u53e5\u6539\u5199\u6210\u53e6\u5916\u4e00\u79cd\u6a21\u5f0f\u3002</p> <p>\u6bd4\u5982\uff0c\u8bed\u53e5\u88ab\u9519\u8bef\u5730\u5199\u6210\u4e86 <code>select * from t where id + 1 = 10000</code>\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u65b9\u5f0f\uff0c\u589e\u52a0\u4e00\u4e2a\u8bed\u53e5\u6539\u5199\u89c4\u5219\u3002</p> <pre><code>mysql&gt; insert into query_rewrite.rewrite_rules(pattern, replacement, pattern_database) values (\"select * from t where id + 1 = ?\", \"select * from t where id = ? - 1\", \"test\"); \ncall query_rewrite.flush_rewrite_rules();\n</code></pre> <p>\u8fd9\u91cc\uff0c<code>call query_rewrite.flush_rewrite_rules()</code> \u8fd9\u4e2a\u5b58\u50a8\u8fc7\u7a0b\uff0c\u662f\u8ba9\u63d2\u5165\u7684\u65b0\u89c4\u5219\u751f\u6548\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684\u201c\u67e5\u8be2\u91cd\u5199\u201d\u3002\u4f60\u53ef\u4ee5\u7528\u56fe 4 \u4e2d\u7684\u65b9\u6cd5\u6765\u786e\u8ba4\u6539\u5199\u89c4\u5219\u662f\u5426\u751f\u6548\u3002</p> <pre><code>mysql&gt; select * from t where id + 1 = 1;\n+----+------+------+\n| id | c    | d    |\n+----+------+------+\n|  0 |    0 |    0 |\n+----+------+------+\n1 row in set, 1 warning (0.00 sec)\n\nmysql&gt; show warnings;\n+-------+------+--------------------------------------------------------------------------------------------------------------------+\n| Level | Code | Message                                                                                                            |\n+-------+------+--------------------------------------------------------------------------------------------------------------------+\n| Note  | 1105 | Query 'select * from t where id + 1 = 1' rewritten to 'select * from t where id = 1 - 1' by a query rewrite plugin |\n+-------+------+--------------------------------------------------------------------------------------------------------------------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u5982\u679c\u4f60\u5728\u6267\u884c\u4e0a\u8ff0\u63d2\u5165\u8bed\u53e5\u63d0\u793a <code>ERROR 1049 (42000): Unknown database 'query_rewrite'</code>\uff0c\u5219\u8bf4\u660e\u4f60\u7684\u6570\u636e\u5e93\u6ca1\u6709\u542f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u542f\u7528\u65b9\u5f0f\u5982\u4e0b\uff0c\u9996\u5148\u5bfc\u5165\u542f\u7528\u811a\u672c</p> <pre><code>$ mysql -uroot -h127.0.0.1 -p &lt; /usr/share/mysql/install_rewriter.sql\n</code></pre> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u67e5\u8be2\u6765\u786e\u8ba4\u5df2\u7ecf\u542f\u7528\u4e86\u8be5\u529f\u80fd</p> <pre><code>mysql&gt; SHOW GLOBAL VARIABLES LIKE 'rewriter_enabled';\n+------------------+-------+\n| Variable_name    | Value |\n+------------------+-------+\n| rewriter_enabled | ON    |\n+------------------+-------+\n</code></pre> <p>\u5982\u679c\u4f60\u4e0d\u9700\u8981\u8fd9\u4e2a\u529f\u80fd\u4e86\uff0c\u5219\u53ef\u4ee5\u6267\u884c <code>/usr/share/mysql/uninstall_rewriter.sql</code> \u8fd9\u4e2a\u811a\u672c\u6765\u5378\u8f7d</p> <p>\u5bfc\u81f4\u6162\u67e5\u8be2\u7684\u7b2c\u4e09\u79cd\u53ef\u80fd\u662fMySQL \u9009\u9519\u4e86\u7d22\u5f15\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u5e94\u6025\u65b9\u6848\u5c31\u662f\u7ed9\u8fd9\u4e2a\u8bed\u53e5\u52a0\u4e0a <code>force index</code>\u3002</p> <p>\u540c\u6837\u5730\uff0c\u4f7f\u7528\u67e5\u8be2\u91cd\u5199\u529f\u80fd\uff0c\u7ed9\u539f\u6765\u7684\u8bed\u53e5\u52a0\u4e0a <code>force index</code>\uff0c\u4e5f\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u4e0a\u9762\u6211\u548c\u4f60\u8ba8\u8bba\u7684\u7531\u6162\u67e5\u8be2\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u7684\u4e09\u79cd\u53ef\u80fd\u60c5\u51b5\uff0c\u5b9e\u9645\u4e0a\u51fa\u73b0\u6700\u591a\u7684\u662f\u524d\u4e24\u79cd\uff0c\u5373\uff1a\u7d22\u5f15\u6ca1\u8bbe\u8ba1\u597d\u548c\u8bed\u53e5\u6ca1\u5199\u597d\u3002\u800c\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u6070\u6070\u662f\u5b8c\u5168\u53ef\u4ee5\u907f\u514d\u7684\u3002\u6bd4\u5982\uff0c\u901a\u8fc7\u4e0b\u9762\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u5148\u53d1\u73b0\u95ee\u9898\u3002</p> <ol> <li>\u4e0a\u7ebf\u524d\uff0c\u5728\u6d4b\u8bd5\u73af\u5883\uff0c\u628a\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\u6253\u5f00\uff0c\u5e76\u4e14\u628a <code>long_query_time</code> \u8bbe\u7f6e\u6210 0\uff0c\u786e\u4fdd\u6bcf\u4e2a\u8bed\u53e5\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5165\u6162\u67e5\u8be2\u65e5\u5fd7\uff1b</li> <li>\u5728\u6d4b\u8bd5\u8868\u91cc\u63d2\u5165\u6a21\u62df\u7ebf\u4e0a\u7684\u6570\u636e\uff0c\u505a\u4e00\u904d\u56de\u5f52\u6d4b\u8bd5\uff1b</li> <li>\u89c2\u5bdf\u6162\u67e5\u8be2\u65e5\u5fd7\u91cc\u6bcf\u7c7b\u8bed\u53e5\u7684\u8f93\u51fa\uff0c\u7279\u522b\u7559\u610f <code>Rows_examined</code> \u5b57\u6bb5\u662f\u5426\u4e0e\u9884\u671f\u4e00\u81f4\u3002</li> </ol> <p>\u4e0d\u8981\u541d\u556c\u8fd9\u6bb5\u82b1\u5728\u4e0a\u7ebf\u524d\u7684\u201c\u989d\u5916\u201d\u65f6\u95f4\uff0c\u56e0\u4e3a\u8fd9\u4f1a\u5e2e\u4f60\u7701\u4e0b\u5f88\u591a\u6545\u969c\u590d\u76d8\u7684\u65f6\u95f4\u3002</p> <p>\u5982\u679c\u65b0\u589e\u7684 SQL \u8bed\u53e5\u4e0d\u591a\uff0c\u624b\u52a8\u8dd1\u4e00\u4e0b\u5c31\u53ef\u4ee5\u3002\u800c\u5982\u679c\u662f\u65b0\u9879\u76ee\u7684\u8bdd\uff0c\u6216\u8005\u662f\u4fee\u6539\u4e86\u539f\u6709\u9879\u76ee\u7684 \u8868\u7ed3\u6784\u8bbe\u8ba1\uff0c\u5168\u91cf\u56de\u5f52\u6d4b\u8bd5\u90fd\u662f\u5fc5\u8981\u7684\u3002\u8fd9\u65f6\u5019\uff0c\u4f60\u9700\u8981\u5de5\u5177\u5e2e\u4f60\u68c0\u67e5\u6240\u6709\u7684 SQL \u8bed\u53e5\u7684\u8fd4\u56de\u7ed3\u679c\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u5f00\u6e90\u5de5\u5177 pt-query-digest</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#qps","title":"QPS \u7a81\u589e\u95ee\u9898","text":"<p>\u6709\u65f6\u5019\u7531\u4e8e\u4e1a\u52a1\u7a81\u7136\u51fa\u73b0\u9ad8\u5cf0\uff0c\u6216\u8005\u5e94\u7528\u7a0b\u5e8f bug\uff0c\u5bfc\u81f4\u67d0\u4e2a\u8bed\u53e5\u7684 QPS \u7a81\u7136\u66b4\u6da8\uff0c\u4e5f\u53ef\u80fd\u5bfc\u81f4 MySQL \u538b\u529b\u8fc7\u5927\uff0c\u5f71\u54cd\u670d\u52a1\u3002</p> <p>\u6211\u4e4b\u524d\u78b0\u5230\u8fc7\u4e00\u7c7b\u60c5\u51b5\uff0c\u662f\u7531\u4e00\u4e2a\u65b0\u529f\u80fd\u7684 bug \u5bfc\u81f4\u7684\u3002\u5f53\u7136\uff0c\u6700\u7406\u60f3\u7684\u60c5\u51b5\u662f\u8ba9\u4e1a\u52a1\u628a\u8fd9\u4e2a\u529f\u80fd\u4e0b\u6389\uff0c\u670d\u52a1\u81ea\u7136\u5c31\u4f1a\u6062\u590d\u3002</p> <p>\u800c\u4e0b\u6389\u4e00\u4e2a\u529f\u80fd\uff0c\u5982\u679c\u4ece\u6570\u636e\u5e93\u7aef\u5904\u7406\u7684\u8bdd\uff0c\u5bf9\u5e94\u4e8e\u4e0d\u540c\u7684\u80cc\u666f\uff0c\u6709\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u7528\u3002</p> <ol> <li>\u4e00\u79cd\u662f\u7531\u5168\u65b0\u4e1a\u52a1\u7684 bug \u5bfc\u81f4\u7684\u3002\u5047\u8bbe\u4f60\u7684 DB \u8fd0\u7ef4\u662f\u6bd4\u8f83\u89c4\u8303\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u767d\u540d\u5355\u662f\u4e00\u4e2a\u4e2a\u52a0\u7684\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4f60\u80fd\u591f\u786e\u5b9a\u4e1a\u52a1\u65b9\u4f1a\u4e0b\u6389\u8fd9\u4e2a\u529f\u80fd\uff0c\u53ea\u662f\u65f6\u95f4\u4e0a\u6ca1\u90a3\u4e48\u5feb\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4ece\u6570\u636e\u5e93\u7aef\u76f4\u63a5\u628a\u767d\u540d\u5355\u53bb\u6389\u3002</li> <li>\u5982\u679c\u8fd9\u4e2a\u65b0\u529f\u80fd\u4f7f\u7528\u7684\u662f\u5355\u72ec\u7684\u6570\u636e\u5e93\u7528\u6237\uff0c\u53ef\u4ee5\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u628a\u8fd9\u4e2a\u7528\u6237\u5220\u6389\uff0c\u7136\u540e\u65ad\u5f00\u73b0\u6709\u8fde\u63a5\u3002\u8fd9\u6837\uff0c\u8fd9\u4e2a\u65b0\u529f\u80fd\u7684\u8fde\u63a5\u4e0d\u6210\u529f\uff0c\u7531\u5b83\u5f15\u53d1\u7684 QPS \u5c31\u4f1a\u53d8\u6210 0\u3002</li> <li>\u5982\u679c\u8fd9\u4e2a\u65b0\u589e\u7684\u529f\u80fd\u8ddf\u4e3b\u4f53\u529f\u80fd\u662f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u80fd\u901a\u8fc7\u5904\u7406\u8bed\u53e5\u6765\u9650\u5236\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u67e5\u8be2\u91cd\u5199\u529f\u80fd\uff0c\u628a\u538b\u529b\u6700\u5927\u7684 SQL \u8bed\u53e5\u76f4\u63a5\u91cd\u5199\u6210 <code>select 1</code> \u8fd4\u56de\u3002</li> </ol> <p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u7684\u98ce\u9669\u5f88\u9ad8\uff0c\u9700\u8981\u4f60\u7279\u522b\u7ec6\u81f4\u3002\u5b83\u53ef\u80fd\u5b58\u5728\u4e24\u4e2a\u526f\u4f5c\u7528\uff1a</p> <ol> <li>\u5982\u679c\u522b\u7684\u529f\u80fd\u91cc\u9762\u4e5f\u7528\u5230\u4e86\u8fd9\u4e2a SQL \u8bed\u53e5\u6a21\u677f\uff0c\u4f1a\u6709\u8bef\u4f24\uff1b</li> <li>\u5f88\u591a\u4e1a\u52a1\u5e76\u4e0d\u662f\u9760\u8fd9\u4e00\u4e2a\u8bed\u53e5\u5c31\u80fd\u5b8c\u6210\u903b\u8f91\u7684\uff0c\u6240\u4ee5\u5982\u679c\u5355\u72ec\u628a\u8fd9\u4e00\u4e2a\u8bed\u53e5\u4ee5 <code>select 1</code> \u7684\u7ed3\u679c\u8fd4\u56de\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u540e\u9762\u7684\u4e1a\u52a1\u903b\u8f91\u4e00\u8d77\u5931\u8d25\u3002</li> </ol> <p>\u6240\u4ee5\uff0c\u65b9\u6848 3 \u662f\u7528\u4e8e\u6b62\u8840\u7684\uff0c\u8ddf\u524d\u9762\u63d0\u5230\u7684\u53bb\u6389\u6743\u9650\u9a8c\u8bc1\u4e00\u6837\uff0c\u5e94\u8be5\u662f\u4f60\u6240\u6709\u9009\u9879\u91cc\u4f18\u5148\u7ea7\u6700\u4f4e\u7684\u4e00\u4e2a\u65b9\u6848\u3002</p> <p>\u540c\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u5176\u5b9e\u65b9\u6848 1 \u548c 2 \u90fd\u8981\u4f9d\u8d56\u4e8e\u89c4\u8303\u7684\u8fd0\u7ef4\u4f53\u7cfb\uff1a\u865a\u62df\u5316\u3001\u767d\u540d\u5355\u673a\u5236\u3001\u4e1a\u52a1\u8d26\u53f7\u5206\u79bb\u3002\u7531\u6b64\u53ef\u89c1\uff0c\u66f4\u591a\u7684\u51c6\u5907\uff0c\u5f80\u5f80\u610f\u5473\u7740\u66f4\u7a33\u5b9a\u7684\u7cfb\u7edf\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_14","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4ee5\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u6027\u80fd\u95ee\u9898\u4e3a\u80cc\u666f\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e9b\u7d27\u6025\u5904\u7406\u7684\u624b\u6bb5\u3002</p> <p>\u8fd9\u4e9b\u5904\u7406\u624b\u6bb5\u4e2d\uff0c\u65e2\u5305\u62ec\u4e86\u7c97\u66b4\u5730\u62d2\u7edd\u8fde\u63a5\u548c\u65ad\u5f00\u8fde\u63a5\uff0c\u4e5f\u6709\u901a\u8fc7\u91cd\u5199\u8bed\u53e5\u6765\u7ed5\u8fc7\u4e00\u4e9b\u5751\u7684\u65b9\u6cd5\uff1b\u65e2\u6709\u4e34\u65f6\u7684\u9ad8\u5371\u65b9\u6848\uff0c\u4e5f\u6709\u672a\u96e8\u7ef8\u7f2a\u7684\u3001\u76f8\u5bf9\u5b89\u5168\u7684\u9884\u6848\u3002</p> <p>\u5728\u5b9e\u9645\u5f00\u53d1\u4e2d\uff0c\u6211\u4eec\u4e5f\u8981\u5c3d\u91cf\u907f\u514d\u4e00\u4e9b\u4f4e\u6548\u7684\u65b9\u6cd5\uff0c\u6bd4\u5982\u907f\u514d\u5927\u91cf\u5730\u4f7f\u7528\u77ed\u8fde\u63a5\u3002\u540c\u65f6\uff0c\u5982\u679c\u4f60\u505a\u4e1a\u52a1\u5f00\u53d1\u7684\u8bdd\uff0c\u8981\u77e5\u9053\uff0c\u8fde\u63a5\u5f02\u5e38\u65ad\u5f00\u662f\u5e38\u6709\u7684\u4e8b\uff0c\u4f60\u7684\u4ee3\u7801\u91cc\u8981\u6709\u6b63\u786e\u5730\u91cd\u8fde\u5e76\u91cd\u8bd5\u7684\u673a\u5236\u3002</p> <p>DBA \u867d\u7136\u53ef\u4ee5\u901a\u8fc7\u8bed\u53e5\u91cd\u5199\u6765\u6682\u65f6\u5904\u7406\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u672c\u8eab\u662f\u4e00\u4e2a\u98ce\u9669\u9ad8\u7684\u64cd\u4f5c\uff0c\u505a\u597d SQL \u5ba1\u8ba1\u53ef\u4ee5\u51cf\u5c11\u9700\u8981\u8fd9\u7c7b\u64cd\u4f5c\u7684\u673a\u4f1a\u3002</p> <p>\u5176\u5b9e\uff0c\u4f60\u53ef\u4ee5\u770b\u5f97\u51fa\u6765\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u6211\u63d0\u5230\u7684\u89e3\u51b3\u65b9\u6cd5\u4e3b\u8981\u96c6\u4e2d\u5728 server \u5c42\u3002\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4f1a\u7ee7\u7eed\u548c\u4f60\u8ba8\u8bba\u4e00\u4e9b\u8ddf InnoDB \u6709\u5173\u7684\u5904\u7406\u65b9\u6cd5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#23-mysql","title":"23 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u7684\uff1f","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4f1a\u7ee7\u7eed\u548c\u4f60\u4ecb\u7ecd\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u4e34\u65f6\u63d0\u5347\u6027\u80fd\u7684\u65b9\u6cd5\u3002\u4ece\u6587\u7ae0\u6807\u9898\u201cMySQL \u662f\u600e\u4e48\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u7684\uff1f\u201d\uff0c\u4f60\u5c31\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u4eca\u5929\u6211\u548c\u4f60\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u8ddf\u6570\u636e\u7684\u53ef\u9760\u6027\u6709\u5173\u3002</p> <p>\u5728\u4e13\u680f\u524d\u9762\u6587\u7ae0\u548c\u7b54\u7591\u7bc7\u4e2d\uff0c\u6211\u90fd\u7740\u91cd\u4ecb\u7ecd\u4e86 WAL \u673a\u5236\uff0c\u5f97\u5230\u7684\u7ed3\u8bba\u662f\uff1a\u53ea\u8981 redo log \u548c binlog \u4fdd\u8bc1\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u5c31\u80fd\u786e\u4fdd MySQL \u5f02\u5e38\u91cd\u542f\u540e\uff0c\u6570\u636e\u53ef\u4ee5\u6062\u590d\u3002</p> <p>\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u53c8\u7ee7\u7eed\u8ffd\u95ee\uff0credo log \u7684\u5199\u5165\u6d41\u7a0b\u662f\u600e\u4e48\u6837\u7684\uff0c\u5982\u4f55\u4fdd\u8bc1 redo log \u771f\u5b9e\u5730\u5199\u5165\u4e86\u78c1\u76d8\u3002\u90a3\u4e48\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u518d\u4e00\u8d77\u770b\u770b MySQL \u5199\u5165 binlog \u548c redo log \u7684\u6d41\u7a0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#binlog","title":"binlog \u7684\u5199\u5165\u673a\u5236","text":"<p>\u5176\u5b9e\uff0cbinlog \u7684\u5199\u5165\u903b\u8f91\u6bd4\u8f83\u7b80\u5355\uff1a\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5148\u628a\u65e5\u5fd7\u5199\u5230 binlog cache\uff0c\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u518d\u628a binlog cache \u5199\u5230 binlog \u6587\u4ef6\u4e2d\u3002</p> <p>\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u4e0d\u80fd\u88ab\u62c6\u5f00\u7684\uff0c\u56e0\u6b64\u4e0d\u8bba\u8fd9\u4e2a\u4e8b\u52a1\u591a\u5927\uff0c\u4e5f\u8981\u786e\u4fdd\u4e00\u6b21\u6027\u5199\u5165\u3002\u8fd9\u5c31\u6d89\u53ca\u5230\u4e86 binlog cache \u7684\u4fdd\u5b58\u95ee\u9898\u3002</p> <p>\u7cfb\u7edf\u7ed9 binlog cache \u5206\u914d\u4e86\u4e00\u7247\u5185\u5b58\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u4e00\u4e2a\uff0c\u53c2\u6570 binlog_cache_size \u7528\u4e8e\u63a7\u5236\u5355\u4e2a\u7ebf\u7a0b\u5185 binlog cache \u6240\u5360\u5185\u5b58\u7684\u5927\u5c0f\u3002\u5982\u679c\u8d85\u8fc7\u4e86\u8fd9\u4e2a\u53c2\u6570\u89c4\u5b9a\u7684\u5927\u5c0f\uff0c\u5c31\u8981\u6682\u5b58\u5230\u78c1\u76d8\u3002</p> <p>\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6267\u884c\u5668\u628a binlog cache \u91cc\u7684\u5b8c\u6574\u4e8b\u52a1\u5199\u5165\u5230 binlog \u4e2d\uff0c\u5e76\u6e05\u7a7a binlog cache\u3002\u72b6\u6001\u5982\u56fe 1 \u6240\u793a\u3002</p> <p></p> <p>\u56fe 1 binlog \u5199\u76d8\u72b6\u6001</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u81ea\u5df1 binlog cache\uff0c\u4f46\u662f\u5171\u7528\u540c\u4e00\u4efd binlog \u6587\u4ef6\u3002</p> <ul> <li>\u56fe\u4e2d\u7684 write\uff0c\u6307\u7684\u5c31\u662f\u6307\u628a\u65e5\u5fd7\u5199\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\uff0c\u5e76\u6ca1\u6709\u628a\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u6240\u4ee5\u901f\u5ea6\u6bd4\u8f83\u5feb\u3002</li> <li>\u56fe\u4e2d\u7684 fsync\uff0c\u624d\u662f\u5c06\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u64cd\u4f5c\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u8ba4\u4e3a fsync \u624d\u5360\u78c1\u76d8\u7684 IOPS\u3002</li> </ul> <p>write \u548c fsync \u7684\u65f6\u673a\uff0c\u662f\u7531\u53c2\u6570 <code>sync_binlog</code> \u63a7\u5236\u7684\uff1a</p> <ol> <li><code>sync_binlog=0</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u53ea write\uff0c\u4e0d fsync\uff1b</li> <li><code>sync_binlog=1</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u4f1a\u6267\u884c fsync\uff1b</li> <li><code>sync_binlog=N</code>(N&gt;1) \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd write\uff0c\u4f46\u7d2f\u79ef N \u4e2a\u4e8b\u52a1\u540e\u624d fsync\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u5728\u51fa\u73b0 IO \u74f6\u9888\u7684\u573a\u666f\u91cc\uff0c\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u6210\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u503c\uff0c\u53ef\u4ee5\u63d0\u5347\u6027\u80fd\u3002\u5728\u5b9e\u9645\u7684\u4e1a\u52a1\u573a\u666f\u4e2d\uff0c\u8003\u8651\u5230\u4e22\u5931\u65e5\u5fd7\u91cf\u7684\u53ef\u63a7\u6027\uff0c\u4e00\u822c\u4e0d\u5efa\u8bae\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u6210 0\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u662f\u5c06\u5176\u8bbe\u7f6e\u4e3a 100~1000 \u4e2d\u7684\u67d0\u4e2a\u6570\u503c\u3002</p> <p>\u4f46\u662f\uff0c\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u4e3a N\uff0c\u5bf9\u5e94\u7684\u98ce\u9669\u662f\uff1a\u5982\u679c\u4e3b\u673a\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4f1a\u4e22\u5931\u6700\u8fd1 N \u4e2a\u4e8b\u52a1\u7684 binlog \u65e5\u5fd7\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#redo-log","title":"redo log \u7684\u5199\u5165\u673a\u5236","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u8bf4\u8bf4 redo log \u7684\u5199\u5165\u673a\u5236\u3002</p> <p>\u5728\u4e13\u680f\u7684[\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0]\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 redo log buffer\u3002\u4e8b\u52a1\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u7684 redo log \u662f\u8981\u5148\u5199\u5230 redo log buffer \u7684\u3002</p> <p>\u7136\u540e\u5c31\u6709\u540c\u5b66\u95ee\u4e86\uff0credo log buffer \u91cc\u9762\u7684\u5185\u5bb9\uff0c\u662f\u4e0d\u662f\u6bcf\u6b21\u751f\u6210\u540e\u90fd\u8981\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u4e0d\u9700\u8981\u3002</p> <p>\u5982\u679c\u4e8b\u52a1\u6267\u884c\u671f\u95f4 MySQL \u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u90a3\u8fd9\u90e8\u5206\u65e5\u5fd7\u5c31\u4e22\u4e86\u3002\u7531\u4e8e\u4e8b\u52a1\u5e76\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u8fd9\u65f6\u65e5\u5fd7\u4e22\u4e86\u4e5f\u4e0d\u4f1a\u6709\u635f\u5931\u3002</p> <p>\u90a3\u4e48\uff0c\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u662f\uff0c\u4e8b\u52a1\u8fd8\u6ca1\u63d0\u4ea4\u7684\u65f6\u5019\uff0credo log buffer \u4e2d\u7684\u90e8\u5206\u65e5\u5fd7\u6709\u6ca1\u6709\u53ef\u80fd\u88ab\u6301\u4e45\u5316\u5230\u78c1\u76d8\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u786e\u5b9e\u4f1a\u6709\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\uff0c\u8981\u4ece redo log \u53ef\u80fd\u5b58\u5728\u7684\u4e09\u79cd\u72b6\u6001\u8bf4\u8d77\u3002\u8fd9\u4e09\u79cd\u72b6\u6001\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u56fe 2 \u4e2d\u7684\u4e09\u4e2a\u989c\u8272\u5757\u3002</p> <p></p> <p>\u56fe 2 MySQL redo log \u5b58\u50a8\u72b6\u6001</p> <p>\u8fd9\u4e09\u79cd\u72b6\u6001\u5206\u522b\u662f\uff1a</p> <ol> <li>\u5b58\u5728 redo log buffer \u4e2d\uff0c\u7269\u7406\u4e0a\u662f\u5728 MySQL \u8fdb\u7a0b\u5185\u5b58\u4e2d\uff0c\u5c31\u662f\u56fe\u4e2d\u7684\u7ea2\u8272\u90e8\u5206\uff1b</li> <li>\u5199\u5230\u78c1\u76d8 (write)\uff0c\u4f46\u662f\u6ca1\u6709\u6301\u4e45\u5316\uff08fsync)\uff0c\u7269\u7406\u4e0a\u662f\u5728\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u91cc\u9762\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684\u9ec4\u8272\u90e8\u5206\uff1b</li> <li>\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u5bf9\u5e94\u7684\u662f hard disk\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7684\u7eff\u8272\u90e8\u5206\u3002</li> </ol> <p>\u65e5\u5fd7\u5199\u5230 redo log buffer \u662f\u5f88\u5feb\u7684\uff0cwirte \u5230 page cache \u4e5f\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u901f\u5ea6\u5c31\u6162\u591a\u4e86\u3002</p> <p>\u4e3a\u4e86\u63a7\u5236 redo log \u7684\u5199\u5165\u7b56\u7565\uff0cInnoDB \u63d0\u4f9b\u4e86 <code>innodb_flush_log_at_trx_commit</code> \u53c2\u6570\uff0c\u5b83\u6709\u4e09\u79cd\u53ef\u80fd\u53d6\u503c\uff1a</p> <ol> <li>\u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u53ea\u662f\u628a redo log \u7559\u5728 redo log buffer \u4e2d ;</li> <li>\u8bbe\u7f6e\u4e3a 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u5c06 redo log \u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff1b</li> <li>\u8bbe\u7f6e\u4e3a 2 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u53ea\u662f\u628a redo log \u5199\u5230 page cache\u3002</li> </ol> <p>InnoDB \u6709\u4e00\u4e2a\u540e\u53f0\u7ebf\u7a0b\uff0c\u6bcf\u9694 1 \u79d2\uff0c\u5c31\u4f1a\u628a redo log buffer \u4e2d\u7684\u65e5\u5fd7\uff0c\u8c03\u7528 write \u5199\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\uff0c\u7136\u540e\u8c03\u7528 fsync \u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002</p> <p>\u6ce8\u610f\uff0c\u4e8b\u52a1\u6267\u884c\u4e2d\u95f4\u8fc7\u7a0b\u7684 redo log \u4e5f\u662f\u76f4\u63a5\u5199\u5728 redo log buffer \u4e2d\u7684\uff0c\u8fd9\u4e9b redo log \u4e5f\u4f1a\u88ab\u540e\u53f0\u7ebf\u7a0b\u4e00\u8d77\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u6ca1\u6709\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684 redo log\uff0c\u4e5f\u662f\u53ef\u80fd\u5df2\u7ecf\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u9664\u4e86\u540e\u53f0\u7ebf\u7a0b\u6bcf\u79d2\u4e00\u6b21\u7684\u8f6e\u8be2\u64cd\u4f5c\u5916\uff0c\u8fd8\u6709\u4e24\u79cd\u573a\u666f\u4f1a\u8ba9\u4e00\u4e2a\u6ca1\u6709\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684 redo log \u5199\u5165\u5230\u78c1\u76d8\u4e2d\u3002</p> <ol> <li>**\u4e00\u79cd\u662f\uff0credo log buffer \u5360\u7528\u7684\u7a7a\u95f4\u5373\u5c06\u8fbe\u5230 innodb_log_buffer_size \u4e00\u534a\u7684\u65f6\u5019\uff0c\u540e\u53f0\u7ebf\u7a0b\u4f1a\u4e3b\u52a8\u5199\u76d8\u3002**\u6ce8\u610f\uff0c\u7531\u4e8e\u8fd9\u4e2a\u4e8b\u52a1\u5e76\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5199\u76d8\u52a8\u4f5c\u53ea\u662f write\uff0c\u800c\u6ca1\u6709\u8c03\u7528 fsync\uff0c\u4e5f\u5c31\u662f\u53ea\u7559\u5728\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684 page cache\u3002</li> <li>**\u53e6\u4e00\u79cd\u662f\uff0c\u5e76\u884c\u7684\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u987a\u5e26\u5c06\u8fd9\u4e2a\u4e8b\u52a1\u7684 redo log buffer \u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002**\u5047\u8bbe\u4e00\u4e2a\u4e8b\u52a1 A \u6267\u884c\u5230\u4e00\u534a\uff0c\u5df2\u7ecf\u5199\u4e86\u4e00\u4e9b redo log \u5230 buffer \u4e2d\uff0c\u8fd9\u65f6\u5019\u6709\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u7684\u4e8b\u52a1 B \u63d0\u4ea4\uff0c\u5982\u679c <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u7684\u662f 1\uff0c\u90a3\u4e48\u6309\u7167\u8fd9\u4e2a\u53c2\u6570\u7684\u903b\u8f91\uff0c\u4e8b\u52a1 B \u8981\u628a redo log buffer \u91cc\u7684\u65e5\u5fd7\u5168\u90e8\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u65f6\u5019\uff0c\u5c31\u4f1a\u5e26\u4e0a\u4e8b\u52a1 A \u5728 redo log buffer \u91cc\u7684\u65e5\u5fd7\u4e00\u8d77\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002</li> </ol> <p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u65f6\u5019\u8bf4\u8fc7\uff0c\u65f6\u5e8f\u4e0a redo log \u5148 prepare\uff0c \u518d\u5199 binlog\uff0c\u6700\u540e\u518d\u628a redo log commit\u3002</p> <p>\u5982\u679c\u628a <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u6210 1\uff0c\u90a3\u4e48 redo log \u5728 prepare \u9636\u6bb5\u5c31\u8981\u6301\u4e45\u5316\u4e00\u6b21\uff0c\u56e0\u4e3a\u6709\u4e00\u4e2a\u5d29\u6e83\u6062\u590d\u903b\u8f91\u662f\u8981\u4f9d\u8d56\u4e8e prepare \u7684 redo log\uff0c\u518d\u52a0\u4e0a binlog \u6765\u6062\u590d\u7684\u3002</p> <p>\u6bcf\u79d2\u4e00\u6b21\u540e\u53f0\u8f6e\u8be2\u5237\u76d8\uff0c\u518d\u52a0\u4e0a\u5d29\u6e83\u6062\u590d\u8fd9\u4e2a\u903b\u8f91\uff0cInnoDB \u5c31\u8ba4\u4e3a redo log \u5728 commit \u7684\u65f6\u5019\u5c31\u4e0d\u9700\u8981 fsync \u4e86\uff0c\u53ea\u4f1a write \u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u4e2d\u5c31\u591f\u4e86\u3002</p> <p>\u901a\u5e38\u6211\u4eec\u8bf4 MySQL \u7684\u201c\u53cc 1\u201d\u914d\u7f6e\uff0c\u6307\u7684\u5c31\u662f <code>sync_binlog</code> \u548c <code>innodb_flush_log_at_trx_commit</code> \u90fd\u8bbe\u7f6e\u6210 1\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u4e8b\u52a1\u5b8c\u6574\u63d0\u4ea4\u524d\uff0c\u9700\u8981\u7b49\u5f85\u4e24\u6b21\u5237\u76d8\uff0c\u4e00\u6b21\u662f redo log\uff08prepare \u9636\u6bb5\uff09\uff0c\u4e00\u6b21\u662f binlog\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4ece MySQL \u770b\u5230\u7684 TPS \u662f\u6bcf\u79d2\u4e24\u4e07\u7684\u8bdd\uff0c\u6bcf\u79d2\u5c31\u4f1a\u5199\u56db\u4e07\u6b21\u78c1\u76d8\u3002\u4f46\u662f\uff0c\u6211\u7528\u5de5\u5177\u6d4b\u8bd5\u51fa\u6765\uff0c\u78c1\u76d8\u80fd\u529b\u4e5f\u5c31\u4e24\u4e07\u5de6\u53f3\uff0c\u600e\u4e48\u80fd\u5b9e\u73b0\u4e24\u4e07\u7684 TPS\uff1f</p> <p>\u89e3\u91ca\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u8981\u7528\u5230\u7ec4\u63d0\u4ea4\uff08group commit\uff09\u673a\u5236\u4e86\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u65e5\u5fd7\u903b\u8f91\u5e8f\u5217\u53f7\uff08log sequence number\uff0cLSN\uff09\u7684\u6982\u5ff5\u3002LSN \u662f\u5355\u8c03\u9012\u589e\u7684\uff0c\u7528\u6765\u5bf9\u5e94 redo log \u7684\u4e00\u4e2a\u4e2a\u5199\u5165\u70b9\u3002\u6bcf\u6b21\u5199\u5165\u957f\u5ea6\u4e3a length \u7684 redo log\uff0c LSN \u7684\u503c\u5c31\u4f1a\u52a0\u4e0a length\u3002</p> <p>LSN \u4e5f\u4f1a\u5199\u5230 InnoDB \u7684\u6570\u636e\u9875\u4e2d\uff0c\u6765\u786e\u4fdd\u6570\u636e\u9875\u4e0d\u4f1a\u88ab\u591a\u6b21\u6267\u884c\u91cd\u590d\u7684 redo log\u3002\u5173\u4e8e LSN \u548c redo log\u3001checkpoint \u7684\u5173\u7cfb\uff0c\u6211\u4f1a\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u8be6\u7ec6\u5c55\u5f00\u3002</p> <p>\u5982\u56fe 3 \u6240\u793a\uff0c\u662f\u4e09\u4e2a\u5e76\u53d1\u4e8b\u52a1 (trx1, trx2, trx3) \u5728 prepare \u9636\u6bb5\uff0c\u90fd\u5199\u5b8c redo log buffer\uff0c\u6301\u4e45\u5316\u5230\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u5bf9\u5e94\u7684 LSN \u5206\u522b\u662f 50\u3001120 \u548c 160\u3002</p> <p></p> <p>\u56fe 3 redo log \u7ec4\u63d0\u4ea4</p> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c</p> <ol> <li>trx1 \u662f\u7b2c\u4e00\u4e2a\u5230\u8fbe\u7684\uff0c\u4f1a\u88ab\u9009\u4e3a\u8fd9\u7ec4\u7684 leader\uff1b</li> <li>\u7b49 trx1 \u8981\u5f00\u59cb\u5199\u76d8\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u7ec4\u91cc\u9762\u5df2\u7ecf\u6709\u4e86\u4e09\u4e2a\u4e8b\u52a1\uff0c\u8fd9\u65f6\u5019 LSN \u4e5f\u53d8\u6210\u4e86 160\uff1b</li> <li>trx1 \u53bb\u5199\u76d8\u7684\u65f6\u5019\uff0c\u5e26\u7684\u5c31\u662f LSN=160\uff0c\u56e0\u6b64\u7b49 trx1 \u8fd4\u56de\u65f6\uff0c\u6240\u6709 LSN \u5c0f\u4e8e\u7b49\u4e8e 160 \u7684 redo log\uff0c\u90fd\u5df2\u7ecf\u88ab\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff1b</li> <li>\u8fd9\u65f6\u5019 trx2 \u548c trx3 \u5c31\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u4e86\u3002</li> </ol> <p>\u6240\u4ee5\uff0c\u4e00\u6b21\u7ec4\u63d0\u4ea4\u91cc\u9762\uff0c\u7ec4\u5458\u8d8a\u591a\uff0c\u8282\u7ea6\u78c1\u76d8 IOPS \u7684\u6548\u679c\u8d8a\u597d\u3002\u4f46\u5982\u679c\u53ea\u6709\u5355\u7ebf\u7a0b\u538b\u6d4b\uff0c\u90a3\u5c31\u53ea\u80fd\u8001\u8001\u5b9e\u5b9e\u5730\u4e00\u4e2a\u4e8b\u52a1\u5bf9\u5e94\u4e00\u6b21\u6301\u4e45\u5316\u64cd\u4f5c\u4e86\u3002</p> <p>\u5728\u5e76\u53d1\u66f4\u65b0\u573a\u666f\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5199\u5b8c redo log buffer \u4ee5\u540e\uff0c\u63a5\u4e0b\u6765\u8fd9\u4e2a fsync \u8d8a\u665a\u8c03\u7528\uff0c\u7ec4\u5458\u53ef\u80fd\u8d8a\u591a\uff0c\u8282\u7ea6 IOPS \u7684\u6548\u679c\u5c31\u8d8a\u597d\u3002</p> <p>\u4e3a\u4e86\u8ba9\u4e00\u6b21 fsync \u5e26\u7684\u7ec4\u5458\u66f4\u591a\uff0cMySQL \u6709\u4e00\u4e2a\u5f88\u6709\u8da3\u7684\u4f18\u5316\uff1a\u62d6\u65f6\u95f4\u3002\u5728\u4ecb\u7ecd\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6211\u66fe\u7ecf\u7ed9\u4f60\u753b\u4e86\u4e00\u4e2a\u56fe\uff0c\u73b0\u5728\u6211\u628a\u5b83\u622a\u8fc7\u6765\u3002</p> <pre><code>graph TB\n    A[\"\u5199\u5165redolog&lt;br/&gt;\u5904\u4e8eprepare\u9636\u6bb5\"]\n    B[\"\u5199 binlog\"]\n    C[\"\u63d0\u4ea4\u4e8b\u52a1&lt;br/&gt;\u5904\u4e8e commit \u72b6\u6001\"]\n\n    A --&gt; B --&gt; C</code></pre> <p>\u56fe 4 \u4e24\u9636\u6bb5\u63d0\u4ea4</p> <p>\u56fe\u4e2d\uff0c\u6211\u628a\u201c\u5199 binlog\u201d\u5f53\u6210\u4e00\u4e2a\u52a8\u4f5c\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u5199 binlog \u662f\u5206\u6210\u4e24\u6b65\u7684\uff1a</p> <ol> <li>\u5148\u628a binlog \u4ece binlog cache \u4e2d\u5199\u5230\u78c1\u76d8\u4e0a\u7684 binlog \u6587\u4ef6\uff1b</li> <li>\u8c03\u7528 fsync \u6301\u4e45\u5316\u3002</li> </ol> <p>MySQL \u4e3a\u4e86\u8ba9\u7ec4\u63d0\u4ea4\u7684\u6548\u679c\u66f4\u597d\uff0c\u628a redo log \u505a fsync \u7684\u65f6\u95f4\u62d6\u5230\u4e86\u6b65\u9aa4 1 \u4e4b\u540e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e0a\u9762\u7684\u56fe\u53d8\u6210\u4e86\u8fd9\u6837\uff1a</p> <pre><code>graph TB\n    A[\"1. redo log prepare: write\"]\n    B[\"2. binlog: write\"]\n    C[\"3. redo log preapre: fsync\"]\n    D[\"4. binlog: fsync\"]\n    E[\"5. redo log commit: write\"]\n\n    A --&gt; B --&gt; C \n    A .-&gt; C\n    B .-&gt; D\n    C --&gt; D \n    D --&gt; E</code></pre> <p>\u56fe 5 \u4e24\u9636\u6bb5\u63d0\u4ea4\u7ec6\u5316</p> <p>\u8fd9\u4e48\u4e00\u6765\uff0cbinlog \u4e5f\u53ef\u4ee5\u7ec4\u63d0\u4ea4\u4e86\u3002\u5728\u6267\u884c\u56fe 5 \u4e2d\u7b2c 4 \u6b65\u628a binlog fsync \u5230\u78c1\u76d8\u65f6\uff0c\u5982\u679c\u6709\u591a\u4e2a\u4e8b\u52a1\u7684 binlog \u5df2\u7ecf\u5199\u5b8c\u4e86\uff0c\u4e5f\u662f\u4e00\u8d77\u6301\u4e45\u5316\u7684\uff0c\u8fd9\u6837\u4e5f\u53ef\u4ee5\u51cf\u5c11 IOPS \u7684\u6d88\u8017\u3002</p> <p>\u4e0d\u8fc7\u901a\u5e38\u60c5\u51b5\u4e0b\u7b2c 3 \u6b65\u6267\u884c\u5f97\u4f1a\u5f88\u5feb\uff0c\u6240\u4ee5 binlog \u7684 write \u548c fsync \u95f4\u7684\u95f4\u9694\u65f6\u95f4\u77ed\uff0c\u5bfc\u81f4\u80fd\u96c6\u5408\u5230\u4e00\u8d77\u6301\u4e45\u5316\u7684 binlog \u6bd4\u8f83\u5c11\uff0c\u56e0\u6b64 binlog \u7684\u7ec4\u63d0\u4ea4\u7684\u6548\u679c\u901a\u5e38\u4e0d\u5982 redo log \u7684\u6548\u679c\u90a3\u4e48\u597d\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u63d0\u5347 binlog \u7ec4\u63d0\u4ea4\u7684\u6548\u679c\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>binlog_group_commit_sync_delay</code> \u548c <code>binlog_group_commit_sync_no_delay_count</code> \u6765\u5b9e\u73b0\u3002</p> <ol> <li><code>binlog_group_commit_sync_delay</code> \u53c2\u6570\uff0c\u8868\u793a\u5ef6\u8fdf\u591a\u5c11\u5fae\u79d2\u540e\u624d\u8c03\u7528 fsync;</li> <li><code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u8868\u793a\u7d2f\u79ef\u591a\u5c11\u6b21\u4ee5\u540e\u624d\u8c03\u7528 fsync\u3002</li> </ol> <p>\u8fd9\u4e24\u4e2a\u6761\u4ef6\u662f\u6216\u7684\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u8981\u6709\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u5c31\u4f1a\u8c03\u7528 fsync\u3002</p> <p>\u6240\u4ee5\uff0c\u5f53 <code>binlog_group_commit_sync_delay</code> \u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c<code>binlog_group_commit_sync_no_delay_count</code> \u4e5f\u65e0\u6548\u4e86\u3002</p> <p>\u4e4b\u524d\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u95ee\u5230\uff0cWAL \u673a\u5236\u662f\u51cf\u5c11\u78c1\u76d8\u5199\uff0c\u53ef\u662f\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u8981\u5199 redo log \u548c binlog\uff0c\u8fd9\u78c1\u76d8\u8bfb\u5199\u6b21\u6570\u4e5f\u6ca1\u53d8\u5c11\u5440\uff1f</p> <p>\u73b0\u5728\u4f60\u5c31\u80fd\u7406\u89e3\u4e86\uff0cWAL \u673a\u5236\u4e3b\u8981\u5f97\u76ca\u4e8e\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>redo log \u548c binlog \u90fd\u662f\u987a\u5e8f\u5199\uff0c\u78c1\u76d8\u7684\u987a\u5e8f\u5199\u6bd4\u968f\u673a\u5199\u901f\u5ea6\u8981\u5feb\uff1b</li> <li>\u7ec4\u63d0\u4ea4\u673a\u5236\uff0c\u53ef\u4ee5\u5927\u5e45\u5ea6\u964d\u4f4e\u78c1\u76d8\u7684 IOPS \u6d88\u8017\u3002</li> </ol> <p>\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u518d\u6765\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff1a\u5982\u679c\u4f60\u7684 MySQL \u73b0\u5728\u51fa\u73b0\u4e86\u6027\u80fd\u74f6\u9888\uff0c\u800c\u4e14\u74f6\u9888\u5728 IO \u4e0a\uff0c\u53ef\u4ee5\u901a\u8fc7\u54ea\u4e9b\u65b9\u6cd5\u6765\u63d0\u5347\u6027\u80fd\u5462\uff1f</p> <p>\u9488\u5bf9\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u8003\u8651\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\uff1a</p> <ol> <li>\u8bbe\u7f6e <code>binlog_group_commit_sync_delay</code> \u548c <code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u51cf\u5c11 binlog \u7684\u5199\u76d8\u6b21\u6570\u3002\u8fd9\u4e2a\u65b9\u6cd5\u662f\u57fa\u4e8e\u201c\u989d\u5916\u7684\u6545\u610f\u7b49\u5f85\u201d\u6765\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u53ef\u80fd\u4f1a\u589e\u52a0\u8bed\u53e5\u7684\u54cd\u5e94\u65f6\u95f4\uff0c\u4f46\u6ca1\u6709\u4e22\u5931\u6570\u636e\u7684\u98ce\u9669\u3002</li> <li>\u5c06 <code>sync_binlog</code> \u8bbe\u7f6e\u4e3a\u5927\u4e8e 1 \u7684\u503c\uff08\u6bd4\u8f83\u5e38\u89c1\u662f 100~1000\uff09\u3002\u8fd9\u6837\u505a\u7684\u98ce\u9669\u662f\uff0c\u4e3b\u673a\u6389\u7535\u65f6\u4f1a\u4e22 binlog \u65e5\u5fd7\u3002</li> <li>\u5c06 <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u4e3a 2\u3002\u8fd9\u6837\u505a\u7684\u98ce\u9669\u662f\uff0c\u4e3b\u673a\u6389\u7535\u7684\u65f6\u5019\u4f1a\u4e22\u6570\u636e\u3002</li> </ol> <p>\u6211\u4e0d\u5efa\u8bae\u4f60\u628a <code>innodb_flush_log_at_trx_commit</code> \u8bbe\u7f6e\u6210 0\u3002\u56e0\u4e3a\u628a\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 0\uff0c\u8868\u793a redo log \u53ea\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u8fd9\u6837\u7684\u8bdd MySQL \u672c\u8eab\u5f02\u5e38\u91cd\u542f\u4e5f\u4f1a\u4e22\u6570\u636e\uff0c\u98ce\u9669\u592a\u5927\u3002\u800c redo log \u5199\u5230\u6587\u4ef6\u7cfb\u7edf\u7684 page cache \u7684\u901f\u5ea6\u4e5f\u662f\u5f88\u5feb\u7684\uff0c\u6240\u4ee5\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 2 \u8ddf\u8bbe\u7f6e\u6210 0 \u5176\u5b9e\u6027\u80fd\u5dee\u4e0d\u591a\uff0c\u4f46\u8fd9\u6837\u505a MySQL \u5f02\u5e38\u91cd\u542f\u65f6\u5c31\u4e0d\u4f1a\u4e22\u6570\u636e\u4e86\uff0c\u76f8\u6bd4\u4e4b\u4e0b\u98ce\u9669\u4f1a\u66f4\u5c0f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_15","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4e13\u680f\u7684[\u7b2c 2 \u7bc7]\u548c[\u7b2c 15 \u7bc7]\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u5206\u6790\u4e86\uff0c\u5982\u679c redo log \u548c binlog \u662f\u5b8c\u6574\u7684\uff0cMySQL \u662f\u5982\u4f55\u4fdd\u8bc1 crash-safe \u7684\u3002\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7740\u91cd\u548c\u4f60\u4ecb\u7ecd\u7684\u662f MySQL \u662f\u201c\u600e\u4e48\u4fdd\u8bc1 redo log \u548c binlog \u662f\u5b8c\u6574\u7684\u201d\u3002</p> <p>\u5e0c\u671b\u8fd9\u4e09\u7bc7\u6587\u7ae0\u4e32\u8d77\u6765\u7684\u5185\u5bb9\uff0c\u80fd\u591f\u8ba9\u4f60\u5bf9 crash-safe \u8fd9\u4e2a\u6982\u5ff5\u6709\u66f4\u6e05\u6670\u7684\u7406\u89e3\u3002</p> <p>\u4e4b\u524d\u7684\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0\u53d1\u5e03\u4e4b\u540e\uff0c\u6709\u540c\u5b66\u7ee7\u7eed\u7559\u8a00\u95ee\u5230\u4e86\u4e00\u4e9b\u8ddf\u65e5\u5fd7\u76f8\u5173\u7684\u95ee\u9898\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u4f60\u56de\u987e\u3001\u5b66\u4e60\uff0c\u6211\u518d\u96c6\u4e2d\u56de\u7b54\u4e00\u6b21\u8fd9\u4e9b\u95ee\u9898\u3002</p> <p>**\u95ee\u9898 1\uff1a**\u6267\u884c\u4e00\u4e2a update \u8bed\u53e5\u4ee5\u540e\uff0c\u6211\u518d\u53bb\u6267\u884c hexdump \u547d\u4ee4\u76f4\u63a5\u67e5\u770b ibd \u6587\u4ef6\u5185\u5bb9\uff0c\u4e3a\u4ec0\u4e48\u6ca1\u6709\u770b\u5230\u6570\u636e\u6709\u6539\u53d8\u5462\uff1f</p> <p>\u56de\u7b54\uff1a\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a WAL \u673a\u5236\u7684\u539f\u56e0\u3002update \u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0cInnoDB \u53ea\u4fdd\u8bc1\u5199\u5b8c\u4e86 redo log\u3001\u5185\u5b58\uff0c\u53ef\u80fd\u8fd8\u6ca1\u6765\u5f97\u53ca\u5c06\u6570\u636e\u5199\u5230\u78c1\u76d8\u3002</p> <p>**\u95ee\u9898 2\uff1a**\u4e3a\u4ec0\u4e48 binlog cache \u662f\u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u7ef4\u62a4\u7684\uff0c\u800c redo log buffer \u662f\u5168\u5c40\u5171\u7528\u7684\uff1f</p> <p>\u56de\u7b54\uff1aMySQL \u8fd9\u4e48\u8bbe\u8ba1\u7684\u4e3b\u8981\u539f\u56e0\u662f\uff0cbinlog \u662f\u4e0d\u80fd\u201c\u88ab\u6253\u65ad\u7684\u201d\u3002\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u5fc5\u987b\u8fde\u7eed\u5199\uff0c\u56e0\u6b64\u8981\u6574\u4e2a\u4e8b\u52a1\u5b8c\u6210\u540e\uff0c\u518d\u4e00\u8d77\u5199\u5230\u6587\u4ef6\u91cc\u3002</p> <p>\u800c redo log \u5e76\u6ca1\u6709\u8fd9\u4e2a\u8981\u6c42\uff0c\u4e2d\u95f4\u6709\u751f\u6210\u7684\u65e5\u5fd7\u53ef\u4ee5\u5199\u5230 redo log buffer \u4e2d\u3002redo log buffer \u4e2d\u7684\u5185\u5bb9\u8fd8\u80fd\u201c\u642d\u4fbf\u8f66\u201d\uff0c\u5176\u4ed6\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u53ef\u4ee5\u88ab\u4e00\u8d77\u5199\u5230\u78c1\u76d8\u4e2d\u3002</p> <p>**\u95ee\u9898 3\uff1a**\u4e8b\u52a1\u6267\u884c\u671f\u95f4\uff0c\u8fd8\u6ca1\u5230\u63d0\u4ea4\u9636\u6bb5\uff0c\u5982\u679c\u53d1\u751f crash \u7684\u8bdd\uff0credo log \u80af\u5b9a\u4e22\u4e86\uff0c\u8fd9\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\u5462\uff1f</p> <p>\u56de\u7b54\uff1a\u4e0d\u4f1a\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019 binlog \u4e5f\u8fd8\u5728 binlog cache \u91cc\uff0c\u6ca1\u53d1\u7ed9\u5907\u5e93\u3002crash \u4ee5\u540e redo log \u548c binlog \u90fd\u6ca1\u6709\u4e86\uff0c\u4ece\u4e1a\u52a1\u89d2\u5ea6\u770b\u8fd9\u4e2a\u4e8b\u52a1\u4e5f\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002</p> <p>**\u95ee\u9898 4\uff1a**\u5982\u679c binlog \u5199\u5b8c\u76d8\u4ee5\u540e\u53d1\u751f crash\uff0c\u8fd9\u65f6\u5019\u8fd8\u6ca1\u7ed9\u5ba2\u6237\u7aef\u7b54\u590d\u5c31\u91cd\u542f\u4e86\u3002\u7b49\u5ba2\u6237\u7aef\u518d\u91cd\u8fde\u8fdb\u6765\uff0c\u53d1\u73b0\u4e8b\u52a1\u5df2\u7ecf\u63d0\u4ea4\u6210\u529f\u4e86\uff0c\u8fd9\u662f\u4e0d\u662f bug\uff1f</p> <p>\u56de\u7b54\uff1a\u4e0d\u662f\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u66f4\u6781\u7aef\u7684\u60c5\u51b5\uff0c\u6574\u4e2a\u4e8b\u52a1\u90fd\u63d0\u4ea4\u6210\u529f\u4e86\uff0credo log commit \u5b8c\u6210\u4e86\uff0c\u5907\u5e93\u4e5f\u6536\u5230 binlog \u5e76\u6267\u884c\u4e86\u3002\u4f46\u662f\u4e3b\u5e93\u548c\u5ba2\u6237\u7aef\u7f51\u7edc\u65ad\u5f00\u4e86\uff0c\u5bfc\u81f4\u4e8b\u52a1\u6210\u529f\u7684\u5305\u8fd4\u56de\u4e0d\u56de\u53bb\uff0c\u8fd9\u65f6\u5019\u5ba2\u6237\u7aef\u4e5f\u4f1a\u6536\u5230\u201c\u7f51\u7edc\u65ad\u5f00\u201d\u7684\u5f02\u5e38\u3002\u8fd9\u79cd\u4e5f\u53ea\u80fd\u7b97\u662f\u4e8b\u52a1\u6210\u529f\u7684\uff0c\u4e0d\u80fd\u8ba4\u4e3a\u662f bug\u3002</p> <p>\u5b9e\u9645\u4e0a\u6570\u636e\u5e93\u7684 crash-safe \u4fdd\u8bc1\u7684\u662f\uff1a</p> <ol> <li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u4e8b\u52a1\u6210\u529f\u7684\u6d88\u606f\uff0c\u4e8b\u52a1\u5c31\u4e00\u5b9a\u6301\u4e45\u5316\u4e86\uff1b</li> <li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u4e8b\u52a1\u5931\u8d25\uff08\u6bd4\u5982\u4e3b\u952e\u51b2\u7a81\u3001\u56de\u6eda\u7b49\uff09\u7684\u6d88\u606f\uff0c\u4e8b\u52a1\u5c31\u4e00\u5b9a\u5931\u8d25\u4e86\uff1b</li> <li>\u5982\u679c\u5ba2\u6237\u7aef\u6536\u5230\u201c\u6267\u884c\u5f02\u5e38\u201d\u7684\u6d88\u606f\uff0c\u5e94\u7528\u9700\u8981\u91cd\u8fde\u540e\u901a\u8fc7\u67e5\u8be2\u5f53\u524d\u72b6\u6001\u6765\u7ee7\u7eed\u540e\u7eed\u7684\u903b\u8f91\u3002\u6b64\u65f6\u6570\u636e\u5e93\u53ea\u9700\u8981\u4fdd\u8bc1\u5185\u90e8\uff08\u6570\u636e\u548c\u65e5\u5fd7\u4e4b\u95f4\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u4e4b\u95f4\uff09\u4e00\u81f4\u5c31\u53ef\u4ee5\u4e86\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#24-mysql","title":"24 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u4e3b\u5907\u4e00\u81f4\u7684\uff1f","text":"<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4e0d\u6b62\u4e00\u6b21\u5730\u548c\u4f60\u63d0\u5230\u4e86 binlog\uff0c\u5927\u5bb6\u77e5\u9053 binlog \u53ef\u4ee5\u7528\u6765\u5f52\u6863\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u505a\u4e3b\u5907\u540c\u6b65\uff0c\u4f46\u5b83\u7684\u5185\u5bb9\u662f\u4ec0\u4e48\u6837\u7684\u5462\uff1f\u4e3a\u4ec0\u4e48\u5907\u5e93\u6267\u884c\u4e86 binlog \u5c31\u53ef\u4ee5\u8ddf\u4e3b\u5e93\u4fdd\u6301\u4e00\u81f4\u4e86\u5462\uff1f\u4eca\u5929\u6211\u5c31\u6b63\u5f0f\u5730\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e0b\u5b83\u3002</p> <p>\u6beb\u4e0d\u5938\u5f20\u5730\u8bf4\uff0cMySQL \u80fd\u591f\u6210\u4e3a\u73b0\u4e0b\u6700\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u5e93\uff0cbinlog \u529f\u4e0d\u53ef\u6ca1\u3002</p> <p>\u5728\u6700\u5f00\u59cb\uff0cMySQL \u662f\u4ee5\u5bb9\u6613\u5b66\u4e60\u548c\u65b9\u4fbf\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u88ab\u5f00\u53d1\u4eba\u5458\u9752\u7750\u7684\u3002\u800c\u5b83\u7684\u51e0\u4e4e\u6240\u6709\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u90fd\u76f4\u63a5\u4f9d\u8d56\u4e8e binlog\u3002\u867d\u7136\u8fd9\u4e9b\u9ad8\u53ef\u7528\u67b6\u6784\u5df2\u7ecf\u5448\u73b0\u51fa\u8d8a\u6765\u8d8a\u590d\u6742\u7684\u8d8b\u52bf\uff0c\u4f46\u90fd\u662f\u4ece\u6700\u57fa\u672c\u7684\u4e00\u4e3b\u4e00\u5907\u6f14\u5316\u8fc7\u6765\u7684\u3002</p> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u6211\u4e3b\u8981\u4e3a\u4f60\u4ecb\u7ecd\u4e3b\u5907\u7684\u57fa\u672c\u539f\u7406\u3002\u7406\u89e3\u4e86\u80cc\u540e\u7684\u8bbe\u8ba1\u539f\u7406\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4ece\u4e1a\u52a1\u5f00\u53d1\u7684\u89d2\u5ea6\uff0c\u6765\u501f\u9274\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u60f3\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mysql","title":"MySQL \u4e3b\u5907\u7684\u57fa\u672c\u539f\u7406","text":"<p>\u5982\u56fe 1 \u6240\u793a\u5c31\u662f\u57fa\u672c\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002</p> <p></p> <p>\u56fe 1 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b</p> <p>\u5728\u72b6\u6001 1 \u4e2d\uff0c\u5ba2\u6237\u7aef\u7684\u8bfb\u5199\u90fd\u76f4\u63a5\u8bbf\u95ee\u8282\u70b9 A\uff0c\u800c\u8282\u70b9 B \u662f A \u7684\u5907\u5e93\uff0c\u53ea\u662f\u5c06 A \u7684\u66f4\u65b0\u90fd\u540c\u6b65\u8fc7\u6765\uff0c\u5230\u672c\u5730\u6267\u884c\u3002\u8fd9\u6837\u53ef\u4ee5\u4fdd\u6301\u8282\u70b9 B \u548c A \u7684\u6570\u636e\u662f\u76f8\u540c\u7684\u3002</p> <p>\u5f53\u9700\u8981\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u5207\u6210\u72b6\u6001 2\u3002\u8fd9\u65f6\u5019\u5ba2\u6237\u7aef\u8bfb\u5199\u8bbf\u95ee\u7684\u90fd\u662f\u8282\u70b9 B\uff0c\u800c\u8282\u70b9 A \u662f B \u7684\u5907\u5e93\u3002</p> <p>\u5728\u72b6\u6001 1 \u4e2d\uff0c\u867d\u7136\u8282\u70b9 B \u6ca1\u6709\u88ab\u76f4\u63a5\u8bbf\u95ee\uff0c\u4f46\u662f\u6211\u4f9d\u7136\u5efa\u8bae\u4f60\u628a\u8282\u70b9 B\uff08\u4e5f\u5c31\u662f\u5907\u5e93\uff09\u8bbe\u7f6e\u6210\u53ea\u8bfb\uff08readonly\uff09\u6a21\u5f0f\u3002\u8fd9\u6837\u505a\uff0c\u6709\u4ee5\u4e0b\u51e0\u4e2a\u8003\u8651\uff1a</p> <ol> <li>\u6709\u65f6\u5019\u4e00\u4e9b\u8fd0\u8425\u7c7b\u7684\u67e5\u8be2\u8bed\u53e5\u4f1a\u88ab\u653e\u5230\u5907\u5e93\u4e0a\u53bb\u67e5\uff0c\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u53ef\u4ee5\u9632\u6b62\u8bef\u64cd\u4f5c\uff1b</li> <li>\u9632\u6b62\u5207\u6362\u903b\u8f91\u6709 bug\uff0c\u6bd4\u5982\u5207\u6362\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u53cc\u5199\uff0c\u9020\u6210\u4e3b\u5907\u4e0d\u4e00\u81f4\uff1b</li> <li>\u53ef\u4ee5\u7528 readonly \u72b6\u6001\uff0c\u6765\u5224\u65ad\u8282\u70b9\u7684\u89d2\u8272\u3002</li> </ol> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u6211\u628a\u5907\u5e93\u8bbe\u7f6e\u6210\u53ea\u8bfb\u4e86\uff0c\u8fd8\u600e\u4e48\u8ddf\u4e3b\u5e93\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\u5462\uff1f</p> <p>\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u4e0d\u7528\u62c5\u5fc3\u3002\u56e0\u4e3a readonly \u8bbe\u7f6e\u5bf9\u8d85\u7ea7 (super) \u6743\u9650\u7528\u6237\u662f\u65e0\u6548\u7684\uff0c\u800c\u7528\u4e8e\u540c\u6b65\u66f4\u65b0\u7684\u7ebf\u7a0b\uff0c\u5c31\u62e5\u6709\u8d85\u7ea7\u6743\u9650\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b**\u8282\u70b9 A \u5230 B \u8fd9\u6761\u7ebf\u7684\u5185\u90e8\u6d41\u7a0b\u662f\u4ec0\u4e48\u6837\u7684**\u3002\u56fe 2 \u4e2d\u753b\u51fa\u7684\u5c31\u662f\u4e00\u4e2a update \u8bed\u53e5\u5728\u8282\u70b9 A \u6267\u884c\uff0c\u7136\u540e\u540c\u6b65\u5230\u8282\u70b9 B \u7684\u5b8c\u6574\u6d41\u7a0b\u56fe\u3002</p> <pre><code>graph TB \n    subgraph A [\"master A\"]\n    direction LR\n    undo[\"undo log(mem)\"] --&gt; data[\"data(mem)\"] --&gt; redo[\"redo log(prepare)\"] --&gt; binlog\n    binlog --&gt; redo2[\"redo log (commit)\"]\n    binlog --&gt; dump[\"dump_thread\"]\n\n    bg_thread --&gt; undo2[\"undo log(disk)\"] --&gt; data2[\"data(disk)\"]\n    end\n\n    subgraph B [\"slave B\"]\n        direction RL\n        ioThread[\"io_thread\"] --&gt; relay[\"relay log\"] --&gt; sqlThread[\"sql_thread\"] --&gt; dataB[\"DATA\"] \n    end\n\n    dump --&gt; ioThread\n    start --&gt;undo\n    redo2 --&gt; ack</code></pre> <p>\u56fe 2 \u4e3b\u5907\u6d41\u7a0b\u56fe</p> <p>\u56fe 2 \u4e2d\uff0c\u5305\u542b\u4e86\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bb2\u5230\u7684 binlog \u548c redo log \u7684\u5199\u5165\u673a\u5236\u76f8\u5173\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u770b\u5230\uff1a\u4e3b\u5e93\u63a5\u6536\u5230\u5ba2\u6237\u7aef\u7684\u66f4\u65b0\u8bf7\u6c42\u540e\uff0c\u6267\u884c\u5185\u90e8\u4e8b\u52a1\u7684\u66f4\u65b0\u903b\u8f91\uff0c\u540c\u65f6\u5199 binlog\u3002</p> <p>\u5907\u5e93 B \u8ddf\u4e3b\u5e93 A \u4e4b\u95f4\u7ef4\u6301\u4e86\u4e00\u4e2a\u957f\u8fde\u63a5\u3002\u4e3b\u5e93 A \u5185\u90e8\u6709\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e13\u95e8\u7528\u4e8e\u670d\u52a1\u5907\u5e93 B \u7684\u8fd9\u4e2a\u957f\u8fde\u63a5\u3002\u4e00\u4e2a\u4e8b\u52a1\u65e5\u5fd7\u540c\u6b65\u7684\u5b8c\u6574\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5728\u5907\u5e93 B \u4e0a\u901a\u8fc7 change master \u547d\u4ee4\uff0c\u8bbe\u7f6e\u4e3b\u5e93 A \u7684 IP\u3001\u7aef\u53e3\u3001\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u4ee5\u53ca\u8981\u4ece\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u8bf7\u6c42 binlog\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5305\u542b\u6587\u4ef6\u540d\u548c\u65e5\u5fd7\u504f\u79fb\u91cf\u3002</li> <li>\u5728\u5907\u5e93 B \u4e0a\u6267\u884c start slave \u547d\u4ee4\uff0c\u8fd9\u65f6\u5019\u5907\u5e93\u4f1a\u542f\u52a8\u4e24\u4e2a\u7ebf\u7a0b\uff0c\u5c31\u662f\u56fe\u4e2d\u7684 <code>io_thread</code> \u548c <code>sql_thread</code>\u3002\u5176\u4e2d <code>io_thread</code> \u8d1f\u8d23\u4e0e\u4e3b\u5e93\u5efa\u7acb\u8fde\u63a5\u3002</li> <li>\u4e3b\u5e93 A \u6821\u9a8c\u5b8c\u7528\u6237\u540d\u3001\u5bc6\u7801\u540e\uff0c\u5f00\u59cb\u6309\u7167\u5907\u5e93 B \u4f20\u8fc7\u6765\u7684\u4f4d\u7f6e\uff0c\u4ece\u672c\u5730\u8bfb\u53d6 binlog\uff0c\u53d1\u7ed9 B\u3002</li> <li>\u5907\u5e93 B \u62ff\u5230 binlog \u540e\uff0c\u5199\u5230\u672c\u5730\u6587\u4ef6\uff0c\u79f0\u4e3a\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u3002</li> <li><code>sql_thread</code> \u8bfb\u53d6\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u89e3\u6790\u51fa\u65e5\u5fd7\u91cc\u7684\u547d\u4ee4\uff0c\u5e76\u6267\u884c\u3002</li> </ol> <p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\uff0c\u540e\u6765\u7531\u4e8e\u591a\u7ebf\u7a0b\u590d\u5236\u65b9\u6848\u7684\u5f15\u5165\uff0c<code>sql_thread</code> \u6f14\u5316\u6210\u4e3a\u4e86\u591a\u4e2a\u7ebf\u7a0b\uff0c\u8ddf\u6211\u4eec\u4eca\u5929\u8981\u4ecb\u7ecd\u7684\u539f\u7406\u6ca1\u6709\u76f4\u63a5\u5173\u7cfb\uff0c\u6682\u4e14\u4e0d\u5c55\u5f00\u3002</p> <p>\u5206\u6790\u5b8c\u4e86\u8fd9\u4e2a\u957f\u8fde\u63a5\u7684\u903b\u8f91\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u95ee\u9898\uff1abinlog \u91cc\u9762\u5230\u5e95\u662f\u4ec0\u4e48\u5185\u5bb9\uff0c\u4e3a\u4ec0\u4e48\u5907\u5e93\u62ff\u8fc7\u53bb\u53ef\u4ee5\u76f4\u63a5\u6267\u884c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#binlog_1","title":"binlog \u7684\u4e09\u79cd\u683c\u5f0f\u5bf9\u6bd4","text":"<p>\u6211\u5728[\u7b2c 15 \u7bc7\u7b54\u7591\u6587\u7ae0]\u4e2d\uff0c\u548c\u4f60\u63d0\u5230\u8fc7 binlog \u6709\u4e24\u79cd\u683c\u5f0f\uff0c\u4e00\u79cd\u662f statement\uff0c\u4e00\u79cd\u662f row\u3002\u53ef\u80fd\u4f60\u5728\u5176\u4ed6\u8d44\u6599\u4e0a\u8fd8\u4f1a\u770b\u5230\u6709\u7b2c\u4e09\u79cd\u683c\u5f0f\uff0c\u53eb\u4f5c mixed\uff0c\u5176\u5b9e\u5b83\u5c31\u662f\u524d\u4e24\u79cd\u683c\u5f0f\u7684\u6df7\u5408\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u63cf\u8ff0 binlog \u7684\u8fd9\u4e09\u79cd\u683c\u5f0f\u95f4\u7684\u533a\u522b\uff0c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a\u8868\uff0c\u5e76\u521d\u59cb\u5316\u51e0\u884c\u6570\u636e\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `t_modified`(`t_modified`)\n) ENGINE=InnoDB; \ninsert into t values(1,1,'2018-11-13');\ninsert into t values(2,2,'2018-11-12');\ninsert into t values(3,3,'2018-11-11');\ninsert into t values(4,4,'2018-11-10');\ninsert into t values(5,5,'2018-11-09');\n</code></pre> <p>\u5982\u679c\u8981\u5728\u8868\u4e2d\u5220\u9664\u4e00\u884c\u6570\u636e\u7684\u8bdd\uff0c\u6211\u4eec\u6765\u770b\u770b\u8fd9\u4e2a delete \u8bed\u53e5\u7684 binlog \u662f\u600e\u4e48\u8bb0\u5f55\u7684\u3002</p> <p>\u6ce8\u610f\uff0c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5305\u542b\u6ce8\u91ca\uff0c\u5982\u679c\u4f60\u7528 MySQL \u5ba2\u6237\u7aef\u6765\u505a\u8fd9\u4e2a\u5b9e\u9a8c\u7684\u8bdd\uff0c\u8981\u8bb0\u5f97\u52a0 -c \u53c2\u6570\uff0c\u5426\u5219\u5ba2\u6237\u7aef\u4f1a\u81ea\u52a8\u53bb\u6389\u6ce8\u91ca\u3002</p> <pre><code>mysql&gt; delete from t /*comment*/  where a&gt;=4 and t_modified&lt;='2018-11-10' limit 1;\n</code></pre> <p>\u5f53 binlog_format=statement \u65f6\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u7684\u5c31\u662f SQL \u8bed\u53e5\u7684\u539f\u6587\u3002\u4f60\u53ef\u4ee5\u7528</p> <pre><code>mysql&gt; show binlog events in 'binlog.000079' from 60602403;\n+---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+\n| Log_name      | Pos      | Event_type     | Server_id | End_log_pos | Info                                                                                   |\n+---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+\n| binlog.000079 | 60602403 | Anonymous_Gtid |         1 |    60602482 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                   |\n| binlog.000079 | 60602482 | Query          |         1 |    60602572 | BEGIN                                                                                  |\n| binlog.000079 | 60602572 | Query          |         1 |    60602731 | use `test`; delete from t /*comment*/  where a&gt;=4 and t_modified&lt;='2018-11-10' limit 1 |\n| binlog.000079 | 60602731 | Xid            |         1 |    60602762 | COMMIT /* xid=630521 */                                                                |\n+---------------+----------+----------------+-----------+-------------+----------------------------------------------------------------------------------------+\n</code></pre> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8f93\u51fa\u7ed3\u679c\u3002</p> <ul> <li>\u7b2c\u4e00\u884c <code>SET @@SESSION.GTID_NEXT='ANONYMOUS'</code>\u4f60\u53ef\u4ee5\u5148\u5ffd\u7565\uff0c\u540e\u9762\u6587\u7ae0\u6211\u4eec\u4f1a\u5728\u4ecb\u7ecd\u4e3b\u5907\u5207\u6362\u7684\u65f6\u5019\u518d\u63d0\u5230\uff1b</li> <li>\u7b2c\u4e8c\u884c\u662f\u4e00\u4e2a BEGIN\uff0c\u8ddf\u7b2c\u56db\u884c\u7684 commit \u5bf9\u5e94\uff0c\u8868\u793a\u4e2d\u95f4\u662f\u4e00\u4e2a\u4e8b\u52a1\uff1b</li> <li>\u7b2c\u4e09\u884c\u5c31\u662f\u771f\u5b9e\u6267\u884c\u7684\u8bed\u53e5\u4e86\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u771f\u5b9e\u6267\u884c\u7684 delete \u547d\u4ee4\u4e4b\u524d\uff0c\u8fd8\u6709\u4e00\u4e2a <code>use 'test'</code>\u547d\u4ee4\u3002\u8fd9\u6761\u547d\u4ee4\u4e0d\u662f\u6211\u4eec\u4e3b\u52a8\u6267\u884c\u7684\uff0c\u800c\u662f MySQL \u6839\u636e\u5f53\u524d\u8981\u64cd\u4f5c\u7684\u8868\u6240\u5728\u7684\u6570\u636e\u5e93\uff0c\u81ea\u884c\u6dfb\u52a0\u7684\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4fdd\u8bc1\u65e5\u5fd7\u4f20\u5230\u5907\u5e93\u53bb\u6267\u884c\u7684\u65f6\u5019\uff0c\u4e0d\u8bba\u5f53\u524d\u7684\u5de5\u4f5c\u7ebf\u7a0b\u5728\u54ea\u4e2a\u5e93\u91cc\uff0c\u90fd\u80fd\u591f\u6b63\u786e\u5730\u66f4\u65b0\u5230 test \u5e93\u7684\u8868 t\u3002 <code>use 'test'</code> \u547d\u4ee4\u4e4b\u540e\u7684 delete \u8bed\u53e5\uff0c\u5c31\u662f\u6211\u4eec\u8f93\u5165\u7684 SQL \u539f\u6587\u4e86\u3002\u53ef\u4ee5\u770b\u5230\uff0cbinlog\u201c\u5fe0\u5b9e\u201d\u5730\u8bb0\u5f55\u4e86 SQL \u547d\u4ee4\uff0c\u751a\u81f3\u8fde\u6ce8\u91ca\u4e5f\u4e00\u5e76\u8bb0\u5f55\u4e86\u3002</li> <li>\u6700\u540e\u4e00\u884c\u662f\u4e00\u4e2a COMMIT\u3002\u4f60\u53ef\u4ee5\u770b\u5230\u91cc\u9762\u5199\u7740 xid=630521\u3002</li> </ul> <p>\u4e3a\u4e86\u8bf4\u660e statement \u548c row \u683c\u5f0f\u7684\u533a\u522b\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6761 delete \u547d\u4ee4\u7684\u6267\u884c\u6548\u679c\u56fe\uff1a</p> <pre><code>mysql&gt; show warnings;\n+-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Level | Code | Message                                                                                                                                                                                                                         |\n+-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Note  | 1592 | Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT. The statement is unsafe because it uses a LIMIT clause. This is unsafe because the set of rows included cannot be predicted. |\n+-------+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd0\u884c\u8fd9\u6761 delete \u547d\u4ee4\u4ea7\u751f\u4e86\u4e00\u4e2a warning\uff0c\u539f\u56e0\u662f\u5f53\u524d binlog \u8bbe\u7f6e\u7684\u662f statement \u683c\u5f0f\uff0c\u5e76\u4e14\u8bed\u53e5\u4e2d\u6709 limit\uff0c\u6240\u4ee5\u8fd9\u4e2a\u547d\u4ee4\u53ef\u80fd\u662f unsafe \u7684\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a delete \u5e26 limit\uff0c\u5f88\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e3b\u5907\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p> <ol> <li>\u5982\u679c delete \u8bed\u53e5\u4f7f\u7528\u7684\u662f\u7d22\u5f15 a\uff0c\u90a3\u4e48\u4f1a\u6839\u636e\u7d22\u5f15 a \u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u5220\u9664\u7684\u662f a=4 \u8fd9\u4e00\u884c\uff1b</li> <li>\u4f46\u5982\u679c\u4f7f\u7528\u7684\u662f\u7d22\u5f15 <code>t_modified</code>\uff0c\u90a3\u4e48\u5220\u9664\u7684\u5c31\u662f <code>t_modified='2018-11-09'</code>\u4e5f\u5c31\u662f a=5 \u8fd9\u4e00\u884c\u3002</li> </ol> <p>\u7531\u4e8e statement \u683c\u5f0f\u4e0b\uff0c\u8bb0\u5f55\u5230 binlog \u91cc\u7684\u662f\u8bed\u53e5\u539f\u6587\uff0c\u56e0\u6b64\u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u5728\u4e3b\u5e93\u6267\u884c\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u7d22\u5f15 a\uff1b\u800c\u5728\u5907\u5e93\u6267\u884c\u8fd9\u6761 SQL \u8bed\u53e5\u7684\u65f6\u5019\uff0c\u5374\u4f7f\u7528\u4e86\u7d22\u5f15 <code>t_modified</code>\u3002\u56e0\u6b64\uff0cMySQL \u8ba4\u4e3a\u8fd9\u6837\u5199\u662f\u6709\u98ce\u9669\u7684\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u628a binlog \u7684\u683c\u5f0f\u6539\u4e3a <code>binlog_format=\u2018row\u2019</code>\uff0c \u662f\u4e0d\u662f\u5c31\u6ca1\u6709\u8fd9\u4e2a\u95ee\u9898\u4e86\u5462\uff1f\u6211\u4eec\u5148\u6765\u770b\u770b\u8fd9\u65f6\u5019 binog \u4e2d\u7684\u5185\u5bb9\u5427\u3002</p> <pre><code>mysql&gt; show binlog events in 'binlog.000079' from 60603121;\n+---------------+----------+----------------+-----------+-------------+--------------------------------------+\n| Log_name      | Pos      | Event_type     | Server_id | End_log_pos | Info                                 |\n+---------------+----------+----------------+-----------+-------------+--------------------------------------+\n| binlog.000079 | 60603121 | Anonymous_Gtid |         1 |    60603200 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS' |\n| binlog.000079 | 60603200 | Query          |         1 |    60603283 | BEGIN                                |\n| binlog.000079 | 60603283 | Table_map      |         1 |    60603333 | table_id: 154 (test.t)               |\n| binlog.000079 | 60603333 | Delete_rows    |         1 |    60603381 | table_id: 154 flags: STMT_END_F      |\n| binlog.000079 | 60603381 | Xid            |         1 |    60603412 | COMMIT /* xid=630541 */              |\n+---------------+----------+----------------+-----------+-------------+--------------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0e statement \u683c\u5f0f\u7684 binlog \u76f8\u6bd4\uff0c\u524d\u540e\u7684 BEGIN \u548c COMMIT \u662f\u4e00\u6837\u7684\u3002\u4f46\u662f\uff0crow \u683c\u5f0f\u7684 binlog \u91cc\u6ca1\u6709\u4e86 SQL \u8bed\u53e5\u7684\u539f\u6587\uff0c\u800c\u662f\u66ff\u6362\u6210\u4e86\u4e24\u4e2a event: <code>Table_map</code> \u548c <code>Delete_rows</code>\u3002</p> <ol> <li><code>Table_map</code> event\uff0c\u7528\u4e8e\u8bf4\u660e\u63a5\u4e0b\u6765\u8981\u64cd\u4f5c\u7684\u8868\u662f test \u5e93\u7684\u8868 t;</li> <li><code>Delete_rows</code> event\uff0c\u7528\u4e8e\u5b9a\u4e49\u5220\u9664\u7684\u884c\u4e3a\u3002</li> </ol> <p>\u5176\u5b9e\uff0c\u6211\u4eec\u901a\u8fc7\u56fe 5 \u662f\u770b\u4e0d\u5230\u8be6\u7ec6\u4fe1\u606f\u7684\uff0c\u8fd8\u9700\u8981\u501f\u52a9 mysqlbinlog \u5de5\u5177\uff0c\u7528\u4e0b\u9762\u8fd9\u4e2a\u547d\u4ee4\u89e3\u6790\u548c\u67e5\u770b binlog \u4e2d\u7684\u5185\u5bb9\u3002\u56e0\u4e3a\u56fe 5 \u4e2d\u7684\u4fe1\u606f\u663e\u793a\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u4ece 60603121\u8fd9\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528 <code>--start-position</code> \u53c2\u6570\u6765\u6307\u5b9a\u4ece\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u65e5\u5fd7\u5f00\u59cb\u89e3\u6790\u3002</p> <pre><code>$ mysqlbinlog  -vv binlog.000079 --start-position=60603121;\n</code></pre> <pre><code>#230201 15:51:54 server id 1  end_log_pos 60603283 CRC32 0x49b211b3     Query   thread_id=28    exec_time=0 error_code=0\nSET TIMESTAMP=1675237914/*!*/;\nSET @@session.pseudo_thread_id=28/*!*/;\nSET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;\nSET @@session.sql_mode=1168113696/*!*/;\nSET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;\n/*!\\C utf8mb4 *//*!*/;\nSET @@session.character_set_client=45,@@session.collation_connection=45,@@session.collation_server=45/*!*/;\nSET @@session.time_zone='SYSTEM'/*!*/;\nSET @@session.lc_time_names=0/*!*/;\nSET @@session.collation_database=DEFAULT/*!*/;\n/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;\nBEGIN\n/*!*/;\n# at 60603283\n#230201 15:51:54 server id 1  end_log_pos 60603333 CRC32 0x261dd71a     Table_map: `test`.`t` mapped to number 154\n# at 60603333\n#230201 15:51:54 server id 1  end_log_pos 60603381 CRC32 0xbef257a2     Delete_rows: table id 154 flags: STMT_END_F\n\nBINLOG '\nGhraYxMBAAAAMgAAAMW7nAMAAJoAAAAAAAEABHRlc3QAAXQAAwMDEQEAAgEBABrXHSY=\nGhraYyABAAAAMAAAAPW7nAMAAJoAAAAAAAEAAgAD/wADAAAAAwAAAFvnAICiV/K+\n'/*!*/;\n### DELETE FROM `test`.`t`\n### WHERE\n###   @1=3 /* INT meta=0 nullable=0 is_null=0 */\n###   @2=3 /* INT meta=0 nullable=1 is_null=0 */\n###   @3=1541865600 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n# at 60603381\n#230201 15:51:54 server id 1  end_log_pos 60603412 CRC32 0x1a408274     Xid = 630541\nCOMMIT/*!*/;\nSET @@SESSION.GTID_NEXT= 'AUTOMATIC' /* added by mysqlbinlog */ /*!*/;\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u56fe\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u51e0\u4e2a\u4fe1\u606f\uff1a</p> <ul> <li>server id 1\uff0c\u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u662f\u5728 <code>server_id=1</code> \u7684\u8fd9\u4e2a\u5e93\u4e0a\u6267\u884c\u7684\u3002</li> <li>\u6bcf\u4e2a event \u90fd\u6709 CRC32 \u7684\u503c\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u628a\u53c2\u6570 <code>binlog_checksum</code> \u8bbe\u7f6e\u6210\u4e86 CRC32\u3002</li> <li><code>Table_map</code> event \u8ddf\u4e4b\u524d\u770b\u5230\u7684\u76f8\u540c\uff0c\u663e\u793a\u4e86\u63a5\u4e0b\u6765\u8981\u6253\u5f00\u7684\u8868\uff0cmap \u5230\u6570\u5b57 154\u3002\u73b0\u5728\u6211\u4eec\u8fd9\u6761 SQL \u8bed\u53e5\u53ea\u64cd\u4f5c\u4e86\u4e00\u5f20\u8868\uff0c\u5982\u679c\u8981\u64cd\u4f5c\u591a\u5f20\u8868\u5462\uff1f\u6bcf\u4e2a\u8868\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>Table_map</code> event\u3001\u90fd\u4f1a map \u5230\u4e00\u4e2a\u5355\u72ec\u7684\u6570\u5b57\uff0c\u7528\u4e8e\u533a\u5206\u5bf9\u4e0d\u540c\u8868\u7684\u64cd\u4f5c\u3002</li> <li>\u5728 mysqlbinlog \u7684\u547d\u4ee4\u4e2d\uff0c\u4f7f\u7528\u4e86 <code>-vv</code> \u53c2\u6570\u662f\u4e3a\u4e86\u628a\u5185\u5bb9\u90fd\u89e3\u6790\u51fa\u6765\uff0c\u6240\u4ee5\u4ece\u7ed3\u679c\u91cc\u9762\u53ef\u4ee5\u770b\u5230\u5404\u4e2a\u5b57\u6bb5\u7684\u503c\uff08\u6bd4\u5982\uff0c<code>@1=4</code>\u3001 <code>@2=4</code> \u8fd9\u4e9b\u503c\uff09\u3002</li> <li><code>binlog_row_image</code> \u7684\u9ed8\u8ba4\u914d\u7f6e\u662f FULL\uff0c\u56e0\u6b64 <code>Delete_event</code> \u91cc\u9762\uff0c\u5305\u542b\u4e86\u5220\u6389\u7684\u884c\u7684\u6240\u6709\u5b57\u6bb5\u7684\u503c\u3002\u5982\u679c\u628a <code>binlog_row_image</code> \u8bbe\u7f6e\u4e3a MINIMAL\uff0c\u5219\u53ea\u4f1a\u8bb0\u5f55\u5fc5\u8981\u7684\u4fe1\u606f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u5c31\u662f\u53ea\u4f1a\u8bb0\u5f55 <code>id=4</code> \u8fd9\u4e2a\u4fe1\u606f\u3002</li> <li>\u6700\u540e\u7684 Xid event\uff0c\u7528\u4e8e\u8868\u793a\u4e8b\u52a1\u88ab\u6b63\u786e\u5730\u63d0\u4ea4\u4e86\u3002</li> </ul> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5f53 <code>binlog_format</code> \u4f7f\u7528 row \u683c\u5f0f\u7684\u65f6\u5019\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u4e86\u771f\u5b9e\u5220\u9664\u884c\u7684\u4e3b\u952e id\uff0c\u8fd9\u6837 binlog \u4f20\u5230\u5907\u5e93\u53bb\u7684\u65f6\u5019\uff0c\u5c31\u80af\u5b9a\u4f1a\u5220\u9664 id=4 \u7684\u884c\uff0c\u4e0d\u4f1a\u6709\u4e3b\u5907\u5220\u9664\u4e0d\u540c\u884c\u7684\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mixed-binlog","title":"\u4e3a\u4ec0\u4e48\u4f1a\u6709 mixed \u683c\u5f0f\u7684 binlog\uff1f","text":"<p>\u57fa\u4e8e\u4e0a\u9762\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff1a**\u4e3a\u4ec0\u4e48\u4f1a\u6709 mixed \u8fd9\u79cd binlog \u683c\u5f0f\u7684\u5b58\u5728\u573a\u666f\uff1f**\u63a8\u8bba\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ul> <li>\u56e0\u4e3a\u6709\u4e9b statement \u683c\u5f0f\u7684 binlog \u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0c\u6240\u4ee5\u8981\u4f7f\u7528 row \u683c\u5f0f\u3002</li> <li>\u4f46 row \u683c\u5f0f\u7684\u7f3a\u70b9\u662f\uff0c\u5f88\u5360\u7a7a\u95f4\u3002\u6bd4\u5982\u4f60\u7528\u4e00\u4e2a delete \u8bed\u53e5\u5220\u6389 10 \u4e07\u884c\u6570\u636e\uff0c\u7528 statement \u7684\u8bdd\u5c31\u662f\u4e00\u4e2a SQL \u8bed\u53e5\u88ab\u8bb0\u5f55\u5230 binlog \u4e2d\uff0c\u5360\u7528\u51e0\u5341\u4e2a\u5b57\u8282\u7684\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u7528 row \u683c\u5f0f\u7684 binlog\uff0c\u5c31\u8981\u628a\u8fd9 10 \u4e07\u6761\u8bb0\u5f55\u90fd\u5199\u5230 binlog \u4e2d\u3002\u8fd9\u6837\u505a\uff0c\u4e0d\u4ec5\u4f1a\u5360\u7528\u66f4\u5927\u7684\u7a7a\u95f4\uff0c\u540c\u65f6\u5199 binlog \u4e5f\u8981\u8017\u8d39 IO \u8d44\u6e90\uff0c\u5f71\u54cd\u6267\u884c\u901f\u5ea6\u3002</li> <li>\u6240\u4ee5\uff0cMySQL \u5c31\u53d6\u4e86\u4e2a\u6298\u4e2d\u65b9\u6848\uff0c\u4e5f\u5c31\u662f\u6709\u4e86 mixed \u683c\u5f0f\u7684 binlog\u3002mixed \u683c\u5f0f\u7684\u610f\u601d\u662f\uff0cMySQL \u81ea\u5df1\u4f1a\u5224\u65ad\u8fd9\u6761 SQL \u8bed\u53e5\u662f\u5426\u53ef\u80fd\u5f15\u8d77\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0c\u5982\u679c\u6709\u53ef\u80fd\uff0c\u5c31\u7528 row \u683c\u5f0f\uff0c\u5426\u5219\u5c31\u7528 statement \u683c\u5f0f\u3002</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cmixed \u683c\u5f0f\u53ef\u4ee5\u5229\u7528 statment \u683c\u5f0f\u7684\u4f18\u70b9\uff0c\u540c\u65f6\u53c8\u907f\u514d\u4e86\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u98ce\u9669\u3002</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u7684\u7ebf\u4e0a MySQL \u8bbe\u7f6e\u7684 binlog \u683c\u5f0f\u662f statement \u7684\u8bdd\uff0c\u90a3\u57fa\u672c\u4e0a\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u8fd9\u662f\u4e00\u4e2a\u4e0d\u5408\u7406\u7684\u8bbe\u7f6e\u3002\u4f60\u81f3\u5c11\u5e94\u8be5\u628a binlog \u7684\u683c\u5f0f\u8bbe\u7f6e\u4e3a mixed\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u8bbe\u7f6e\u4e3a mixed \u540e\uff0c\u5c31\u4f1a\u8bb0\u5f55\u4e3a row \u683c\u5f0f\uff1b\u800c\u5982\u679c\u6267\u884c\u7684\u8bed\u53e5\u53bb\u6389 limit 1\uff0c\u5c31\u4f1a\u8bb0\u5f55\u4e3a statement \u683c\u5f0f\u3002</p> <p>\u5f53\u7136\u6211\u8981\u8bf4\u7684\u662f\uff0c\u73b0\u5728\u8d8a\u6765\u8d8a\u591a\u7684\u573a\u666f\u8981\u6c42\u628a MySQL \u7684 binlog \u683c\u5f0f\u8bbe\u7f6e\u6210 row\u3002\u8fd9\u4e48\u505a\u7684\u7406\u7531\u6709\u5f88\u591a\uff0c\u6211\u6765\u7ed9\u4f60\u4e3e\u4e00\u4e2a\u53ef\u4ee5\u76f4\u63a5\u770b\u51fa\u6765\u7684\u597d\u5904\uff1a\u6062\u590d\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5206\u522b\u4ece delete\u3001insert \u548c update \u8fd9\u4e09\u79cd SQL \u8bed\u53e5\u7684\u89d2\u5ea6\uff0c\u6765\u770b\u770b\u6570\u636e\u6062\u590d\u7684\u95ee\u9898\u3002</p> <p>\u901a\u8fc7\u56fe 6 \u4f60\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5373\u4f7f\u6211\u6267\u884c\u7684\u662f delete \u8bed\u53e5\uff0crow \u683c\u5f0f\u7684 binlog \u4e5f\u4f1a\u628a\u88ab\u5220\u6389\u7684\u884c\u7684\u6574\u884c\u4fe1\u606f\u4fdd\u5b58\u8d77\u6765\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u5728\u6267\u884c\u5b8c\u4e00\u6761 delete \u8bed\u53e5\u4ee5\u540e\uff0c\u53d1\u73b0\u5220\u9519\u6570\u636e\u4e86\uff0c\u53ef\u4ee5\u76f4\u63a5\u628a binlog \u4e2d\u8bb0\u5f55\u7684 delete \u8bed\u53e5\u8f6c\u6210 insert\uff0c\u628a\u88ab\u9519\u5220\u7684\u6570\u636e\u63d2\u5165\u56de\u53bb\u5c31\u53ef\u4ee5\u6062\u590d\u4e86\u3002</p> <p>\u5982\u679c\u4f60\u662f\u6267\u884c\u9519\u4e86 insert \u8bed\u53e5\u5462\uff1f\u90a3\u5c31\u66f4\u76f4\u63a5\u4e86\u3002row \u683c\u5f0f\u4e0b\uff0cinsert \u8bed\u53e5\u7684 binlog \u91cc\u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u5b57\u6bb5\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u7528\u6765\u7cbe\u786e\u5b9a\u4f4d\u521a\u521a\u88ab\u63d2\u5165\u7684\u90a3\u4e00\u884c\u3002\u8fd9\u65f6\uff0c\u4f60\u76f4\u63a5\u628a insert \u8bed\u53e5\u8f6c\u6210 delete \u8bed\u53e5\uff0c\u5220\u9664\u6389\u8fd9\u88ab\u8bef\u63d2\u5165\u7684\u4e00\u884c\u6570\u636e\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u5982\u679c\u6267\u884c\u7684\u662f update \u8bed\u53e5\u7684\u8bdd\uff0cbinlog \u91cc\u9762\u4f1a\u8bb0\u5f55\u4fee\u6539\u524d\u6574\u884c\u7684\u6570\u636e\u548c\u4fee\u6539\u540e\u7684\u6574\u884c\u6570\u636e\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u8bef\u6267\u884c\u4e86 update \u8bed\u53e5\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u628a\u8fd9\u4e2a event \u524d\u540e\u7684\u4e24\u884c\u4fe1\u606f\u5bf9\u8c03\u4e00\u4e0b\uff0c\u518d\u53bb\u6570\u636e\u5e93\u91cc\u9762\u6267\u884c\uff0c\u5c31\u80fd\u6062\u590d\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u4e86\u3002</p> <p>\u5176\u5b9e\uff0c\u7531 delete\u3001insert \u6216\u8005 update \u8bed\u53e5\u5bfc\u81f4\u7684\u6570\u636e\u64cd\u4f5c\u9519\u8bef\uff0c\u9700\u8981\u6062\u590d\u5230\u64cd\u4f5c\u4e4b\u524d\u72b6\u6001\u7684\u60c5\u51b5\uff0c\u4e5f\u65f6\u6709\u53d1\u751f\u3002MariaDB \u7684Flashback\u5de5\u5177\u5c31\u662f\u57fa\u4e8e\u4e0a\u9762\u4ecb\u7ecd\u7684\u539f\u7406\u6765\u56de\u6eda\u6570\u636e\u7684\u3002</p> <p>\u867d\u7136 mixed \u683c\u5f0f\u7684 binlog \u73b0\u5728\u5df2\u7ecf\u7528\u5f97\u4e0d\u591a\u4e86\uff0c\u4f46\u8fd9\u91cc\u6211\u8fd8\u662f\u8981\u518d\u501f\u7528\u4e00\u4e0b mixed \u683c\u5f0f\u6765\u8bf4\u660e\u4e00\u4e2a\u95ee\u9898\uff0c\u6765\u770b\u4e00\u4e0b\u8fd9\u6761 SQL \u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; insert into t values(10,10, now());\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u628a binlog \u683c\u5f0f\u8bbe\u7f6e\u4e3a mixed\uff0c\u4f60\u89c9\u5f97 MySQL \u4f1a\u628a\u5b83\u8bb0\u5f55\u4e3a row \u683c\u5f0f\u8fd8\u662f statement \u683c\u5f0f\u5462\uff1f</p> <p>\u5148\u4e0d\u8981\u7740\u6025\u8bf4\u7ed3\u679c\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u7684\u6548\u679c\u3002</p> <pre><code>mysql&gt; show binlog events in 'binlog.000079' from 60603412;\n+---------------+----------+----------------+-----------+-------------+------------------------------------------------+\n| Log_name      | Pos      | Event_type     | Server_id | End_log_pos | Info                                           |\n+---------------+----------+----------------+-----------+-------------+------------------------------------------------+\n| binlog.000079 | 60603412 | Anonymous_Gtid |         1 |    60603491 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'           |\n| binlog.000079 | 60603491 | Query          |         1 |    60603581 | BEGIN                                          |\n| binlog.000079 | 60603581 | Query          |         1 |    60603700 | use `test`; insert into t values(10,10, now()) |\n| binlog.000079 | 60603700 | Xid            |         1 |    60603731 | COMMIT /* xid=630548 */                        |\n+---------------+----------+----------------+-----------+-------------+------------------------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u7528\u7684\u5c45\u7136\u662f statement \u683c\u5f0f\u3002\u4f60\u4e00\u5b9a\u4f1a\u5947\u602a\uff0c\u5982\u679c\u8fd9\u4e2a binlog \u8fc7\u4e86 1 \u5206\u949f\u624d\u4f20\u7ed9\u5907\u5e93\u7684\u8bdd\uff0c\u90a3\u4e3b\u5907\u7684\u6570\u636e\u4e0d\u5c31\u4e0d\u4e00\u81f4\u4e86\u5417\uff1f</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u7528 mysqlbinlog \u5de5\u5177\u6765\u770b\u770b\uff1a</p> <pre><code>/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;\nBEGIN\n/*!*/;\n# at 60603581\n#230201 16:41:36 server id 1  end_log_pos 60603700 CRC32 0xfc0bb7ba     Query   thread_id=28    exec_time=0 error_code=0\nuse `test`/*!*/;\nSET TIMESTAMP=1675240896/*!*/;\ninsert into t values(10,10, now())\n/*!*/;\n# at 60603700\n#230201 16:41:36 server id 1  end_log_pos 60603731 CRC32 0x554021b0     Xid = 630548\nCOMMIT/*!*/;\nSET @@SESSION.GTID_NEXT= 'AUTOMATIC' /* added by mysqlbinlog */ /*!*/;\nDELIMITER ;\n# End of log file\n/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;\n/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;\n</code></pre> <p>\u4ece\u56fe\u4e2d\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0c\u539f\u6765 binlog \u5728\u8bb0\u5f55 event \u7684\u65f6\u5019\uff0c\u591a\u8bb0\u4e86\u4e00\u6761\u547d\u4ee4\uff1a<code>SET TIMESTAMP=1675240896</code>\u3002\u5b83\u7528 SET TIMESTAMP \u547d\u4ee4\u7ea6\u5b9a\u4e86\u63a5\u4e0b\u6765\u7684 now() \u51fd\u6570\u7684\u8fd4\u56de\u65f6\u95f4\u3002</p> <p>\u56e0\u6b64\uff0c\u4e0d\u8bba\u8fd9\u4e2a binlog \u662f 1 \u5206\u949f\u4e4b\u540e\u88ab\u5907\u5e93\u6267\u884c\uff0c\u8fd8\u662f 3 \u5929\u540e\u7528\u6765\u6062\u590d\u8fd9\u4e2a\u5e93\u7684\u5907\u4efd\uff0c\u8fd9\u4e2a insert \u8bed\u53e5\u63d2\u5165\u7684\u884c\uff0c\u503c\u90fd\u662f\u56fa\u5b9a\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u901a\u8fc7\u8fd9\u6761 SET TIMESTAMP \u547d\u4ee4\uff0cMySQL \u5c31\u786e\u4fdd\u4e86\u4e3b\u5907\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002</p> <p>\u6211\u4e4b\u524d\u770b\u8fc7\u6709\u4eba\u5728\u91cd\u653e binlog \u6570\u636e\u7684\u65f6\u5019\uff0c\u662f\u8fd9\u4e48\u505a\u7684\uff1a\u7528 mysqlbinlog \u89e3\u6790\u51fa\u65e5\u5fd7\uff0c\u7136\u540e\u628a\u91cc\u9762\u7684 statement \u8bed\u53e5\u76f4\u63a5\u62f7\u8d1d\u51fa\u6765\u6267\u884c\u3002</p> <p>\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u6709\u98ce\u9669\u7684\u3002\u56e0\u4e3a\u6709\u4e9b\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\u662f\u4f9d\u8d56\u4e8e\u4e0a\u4e0b\u6587\u547d\u4ee4\u7684\uff0c\u76f4\u63a5\u6267\u884c\u7684\u7ed3\u679c\u5f88\u53ef\u80fd\u662f\u9519\u8bef\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u7528 binlog \u6765\u6062\u590d\u6570\u636e\u7684\u6807\u51c6\u505a\u6cd5\u662f\uff0c\u7528 mysqlbinlog \u5de5\u5177\u89e3\u6790\u51fa\u6765\uff0c\u7136\u540e\u628a\u89e3\u6790\u7ed3\u679c\u6574\u4e2a\u53d1\u7ed9 MySQL \u6267\u884c\u3002\u7c7b\u4f3c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ mysqlbinlog binlog.000079 --start-position=60603412 | mysql -h127.0.0.1 -P13000 -u$user -p$pwd;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_16","title":"\u5faa\u73af\u590d\u5236\u95ee\u9898","text":"<p>\u901a\u8fc7\u4e0a\u9762\u5bf9 MySQL \u4e2d binlog \u57fa\u672c\u5185\u5bb9\u7684\u7406\u89e3\uff0c\u4f60\u73b0\u5728\u53ef\u4ee5\u77e5\u9053\uff0cbinlog \u7684\u7279\u6027\u786e\u4fdd\u4e86\u5728\u5907\u5e93\u6267\u884c\u76f8\u540c\u7684 binlog\uff0c\u53ef\u4ee5\u5f97\u5230\u4e0e\u4e3b\u5e93\u76f8\u540c\u7684\u72b6\u6001\u3002</p> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e3b\u5907\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u56fe 1 \u4e2d A\u3001B \u4e24\u4e2a\u8282\u70b9\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\u3002\u5176\u5b9e\uff0c\u56fe 1 \u4e2d\u6211\u753b\u7684\u662f M-S \u7ed3\u6784\uff0c\u4f46\u5b9e\u9645\u751f\u4ea7\u4e0a\u4f7f\u7528\u6bd4\u8f83\u591a\u7684\u662f\u53cc M \u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u56fe 9 \u6240\u793a\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002</p> <p></p> <p>\u56fe 9 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b -- \u53cc M \u7ed3\u6784</p> <p>\u5bf9\u6bd4\u56fe 9 \u548c\u56fe 1\uff0c\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u53cc M \u7ed3\u6784\u548c M-S \u7ed3\u6784\uff0c\u5176\u5b9e\u533a\u522b\u53ea\u662f\u591a\u4e86\u4e00\u6761\u7ebf\uff0c\u5373\uff1a\u8282\u70b9 A \u548c B \u4e4b\u95f4\u603b\u662f\u4e92\u4e3a\u4e3b\u5907\u5173\u7cfb\u3002\u8fd9\u6837\u5728\u5207\u6362\u7684\u65f6\u5019\u5c31\u4e0d\u7528\u518d\u4fee\u6539\u4e3b\u5907\u5173\u7cfb\u3002</p> <p>\u4f46\u662f\uff0c\u53cc M \u7ed3\u6784\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\u3002</p> <p>\u4e1a\u52a1\u903b\u8f91\u5728\u8282\u70b9 A \u4e0a\u66f4\u65b0\u4e86\u4e00\u6761\u8bed\u53e5\uff0c\u7136\u540e\u518d\u628a\u751f\u6210\u7684 binlog \u53d1\u7ed9\u8282\u70b9 B\uff0c\u8282\u70b9 B \u6267\u884c\u5b8c\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u540e\u4e5f\u4f1a\u751f\u6210 binlog\u3002\uff08\u5efa\u8bae\u628a\u53c2\u6570 <code>log_slave_updates</code> \u8bbe\u7f6e\u4e3a on\uff0c\u8868\u793a\u5907\u5e93\u6267\u884c relay log \u540e\u751f\u6210 binlog\uff09\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u8282\u70b9 A \u540c\u65f6\u662f\u8282\u70b9 B \u7684\u5907\u5e93\uff0c\u76f8\u5f53\u4e8e\u53c8\u628a\u8282\u70b9 B \u65b0\u751f\u6210\u7684 binlog \u62ff\u8fc7\u6765\u6267\u884c\u4e86\u4e00\u6b21\uff0c\u7136\u540e\u8282\u70b9 A \u548c B \u95f4\uff0c\u4f1a\u4e0d\u65ad\u5730\u5faa\u73af\u6267\u884c\u8fd9\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u4e5f\u5c31\u662f\u5faa\u73af\u590d\u5236\u4e86\u3002\u8fd9\u4e2a\u8981\u600e\u4e48\u89e3\u51b3\u5462\uff1f</p> <p>\u4ece\u4e0a\u9762\u7684\u56fe 6 \u4e2d\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u5728 binlog \u4e2d\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u547d\u4ee4\u7b2c\u4e00\u6b21\u6267\u884c\u65f6\u6240\u5728\u5b9e\u4f8b\u7684 server id\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u903b\u8f91\uff0c\u6765\u89e3\u51b3\u4e24\u4e2a\u8282\u70b9\u95f4\u7684\u5faa\u73af\u590d\u5236\u7684\u95ee\u9898\uff1a</p> <ol> <li>\u89c4\u5b9a\u4e24\u4e2a\u5e93\u7684 server id \u5fc5\u987b\u4e0d\u540c\uff0c\u5982\u679c\u76f8\u540c\uff0c\u5219\u5b83\u4eec\u4e4b\u95f4\u4e0d\u80fd\u8bbe\u5b9a\u4e3a\u4e3b\u5907\u5173\u7cfb\uff1b</li> <li>\u4e00\u4e2a\u5907\u5e93\u63a5\u5230 binlog \u5e76\u5728\u91cd\u653e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u4e0e\u539f binlog \u7684 server id \u76f8\u540c\u7684\u65b0\u7684 binlog\uff1b</li> <li>\u6bcf\u4e2a\u5e93\u5728\u6536\u5230\u4ece\u81ea\u5df1\u7684\u4e3b\u5e93\u53d1\u8fc7\u6765\u7684\u65e5\u5fd7\u540e\uff0c\u5148\u5224\u65ad server id\uff0c\u5982\u679c\u8ddf\u81ea\u5df1\u7684\u76f8\u540c\uff0c\u8868\u793a\u8fd9\u4e2a\u65e5\u5fd7\u662f\u81ea\u5df1\u751f\u6210\u7684\uff0c\u5c31\u76f4\u63a5\u4e22\u5f03\u8fd9\u4e2a\u65e5\u5fd7\u3002</li> </ol> <p>\u6309\u7167\u8fd9\u4e2a\u903b\u8f91\uff0c\u5982\u679c\u6211\u4eec\u8bbe\u7f6e\u4e86\u53cc M \u7ed3\u6784\uff0c\u65e5\u5fd7\u7684\u6267\u884c\u6d41\u5c31\u4f1a\u53d8\u6210\u8fd9\u6837\uff1a</p> <ol> <li>\u4ece\u8282\u70b9 A \u66f4\u65b0\u7684\u4e8b\u52a1\uff0cbinlog \u91cc\u9762\u8bb0\u7684\u90fd\u662f A \u7684 server id\uff1b</li> <li>\u4f20\u5230\u8282\u70b9 B \u6267\u884c\u4e00\u6b21\u4ee5\u540e\uff0c\u8282\u70b9 B \u751f\u6210\u7684 binlog \u7684 server id \u4e5f\u662f A \u7684 server id\uff1b</li> <li>\u518d\u4f20\u56de\u7ed9\u8282\u70b9 A\uff0cA \u5224\u65ad\u5230\u8fd9\u4e2a server id \u4e0e\u81ea\u5df1\u7684\u76f8\u540c\uff0c\u5c31\u4e0d\u4f1a\u518d\u5904\u7406\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u6b7b\u5faa\u73af\u5728\u8fd9\u91cc\u5c31\u65ad\u6389\u4e86\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_17","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 MySQL binlog \u7684\u683c\u5f0f\u548c\u4e00\u4e9b\u57fa\u672c\u673a\u5236\uff0c\u662f\u540e\u9762\u6211\u8981\u4ecb\u7ecd\u7684\u8bfb\u5199\u5206\u79bb\u7b49\u7cfb\u5217\u6587\u7ae0\u7684\u80cc\u666f\u77e5\u8bc6\uff0c\u5e0c\u671b\u4f60\u53ef\u4ee5\u8ba4\u771f\u6d88\u5316\u7406\u89e3\u3002</p> <p>binlog \u5728 MySQL \u7684\u5404\u79cd\u9ad8\u53ef\u7528\u65b9\u6848\u4e0a\u626e\u6f14\u4e86\u91cd\u8981\u89d2\u8272\u3002\u4eca\u5929\u4ecb\u7ecd\u7684\u53ef\u4ee5\u8bf4\u662f\u6240\u6709 MySQL \u9ad8\u53ef\u7528\u65b9\u6848\u7684\u57fa\u7840\u3002\u5728\u8fd9\u4e4b\u4e0a\u6f14\u5316\u51fa\u4e86\u8bf8\u5982\u591a\u8282\u70b9\u3001\u534a\u540c\u6b65\u3001MySQL group replication \u7b49\u76f8\u5bf9\u590d\u6742\u7684\u65b9\u6848\u3002</p> <p>\u6211\u4e5f\u8ddf\u4f60\u4ecb\u7ecd\u4e86 MySQL \u4e0d\u540c\u683c\u5f0f binlog \u7684\u4f18\u7f3a\u70b9\uff0c\u548c\u8bbe\u8ba1\u8005\u7684\u601d\u8003\u3002\u5e0c\u671b\u4f60\u5728\u505a\u7cfb\u7edf\u5f00\u53d1\u65f6\u5019\uff0c\u4e5f\u80fd\u501f\u9274\u8fd9\u4e9b\u8bbe\u8ba1\u601d\u60f3\u3002</p> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p> <p>\u8bf4\u5230\u5faa\u73af\u590d\u5236\u95ee\u9898\u7684\u65f6\u5019\uff0c\u6211\u4eec\u8bf4 MySQL \u901a\u8fc7\u5224\u65ad server id \u7684\u65b9\u5f0f\uff0c\u65ad\u6389\u6b7b\u5faa\u73af\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u673a\u5236\u5176\u5b9e\u5e76\u4e0d\u5b8c\u5907\uff0c\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u8fd8\u662f\u6709\u53ef\u80fd\u51fa\u73b0\u6b7b\u5faa\u73af\u3002</p> <p>\u4f60\u80fd\u6784\u9020\u51fa\u4e00\u4e2a\u8fd9\u6837\u7684\u573a\u666f\u5417\uff1f\u53c8\u5e94\u8be5\u600e\u4e48\u89e3\u51b3\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u628a\u4f60\u7684\u8bbe\u8ba1\u548c\u5206\u6790\u5199\u5728\u8bc4\u8bba\u533a\uff0c\u6211\u4f1a\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u8ddf\u4f60\u8ba8\u8bba\u8fd9\u4e2a\u95ee\u9898\u3002\u611f\u8c22\u4f60\u7684\u6536\u542c\uff0c\u4e5f\u6b22\u8fce\u4f60\u628a\u8fd9\u7bc7\u6587\u7ae0\u5206\u4eab\u7ed9\u66f4\u591a\u7684\u670b\u53cb\u4e00\u8d77\u9605\u8bfb\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_18","title":"\u4e0a\u671f\u95ee\u9898\u65f6\u95f4","text":"<p>\u4e0a\u671f\u6211\u7559\u7ed9\u4f60\u7684\u95ee\u9898\u662f\uff0c\u4f60\u5728\u4ec0\u4e48\u65f6\u5019\u4f1a\u628a\u7ebf\u4e0a\u751f\u4ea7\u5e93\u8bbe\u7f6e\u6210\u201c\u975e\u53cc 1\u201d\u3002\u6211\u76ee\u524d\u77e5\u9053\u7684\u573a\u666f\uff0c\u6709\u4ee5\u4e0b\u8fd9\u4e9b\uff1a</p> <ol> <li>\u4e1a\u52a1\u9ad8\u5cf0\u671f\u3002\u4e00\u822c\u5982\u679c\u6709\u9884\u77e5\u7684\u9ad8\u5cf0\u671f\uff0cDBA \u4f1a\u6709\u9884\u6848\uff0c\u628a\u4e3b\u5e93\u8bbe\u7f6e\u6210\u201c\u975e\u53cc 1\u201d\u3002</li> <li>\u5907\u5e93\u5ef6\u8fdf\uff0c\u4e3a\u4e86\u8ba9\u5907\u5e93\u5c3d\u5feb\u8d76\u4e0a\u4e3b\u5e93\u3002@\u6c38\u6052\u8bb0\u5fc6\u548c @Second Sight \u63d0\u5230\u4e86\u8fd9\u4e2a\u573a\u666f\u3002</li> <li>\u7528\u5907\u4efd\u6062\u590d\u4e3b\u5e93\u7684\u526f\u672c\uff0c\u5e94\u7528 binlog \u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u8ddf\u4e0a\u4e00\u79cd\u573a\u666f\u7c7b\u4f3c\u3002</li> <li>\u6279\u91cf\u5bfc\u5165\u6570\u636e\u7684\u65f6\u5019\u3002</li> </ol> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u628a\u751f\u4ea7\u5e93\u6539\u6210\u201c\u975e\u53cc 1\u201d\u914d\u7f6e\uff0c\u662f\u8bbe\u7f6e <code>innodb_flush_logs_at_trx_commit=2</code>\u3001<code>sync_binlog=1000</code>\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#25-mysql","title":"25 MySQL\u662f\u600e\u4e48\u4fdd\u8bc1\u9ad8\u53ef\u7528\u7684\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 binlog \u7684\u57fa\u672c\u5185\u5bb9\uff0c\u5728\u4e00\u4e2a\u4e3b\u5907\u5173\u7cfb\u4e2d\uff0c\u6bcf\u4e2a\u5907\u5e93\u63a5\u6536\u4e3b\u5e93\u7684 binlog \u5e76\u6267\u884c\u3002</p> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u53ea\u8981\u4e3b\u5e93\u6267\u884c\u66f4\u65b0\u751f\u6210\u7684\u6240\u6709 binlog\uff0c\u90fd\u53ef\u4ee5\u4f20\u5230\u5907\u5e93\u5e76\u88ab\u6b63\u786e\u5730\u6267\u884c\uff0c\u5907\u5e93\u5c31\u80fd\u8fbe\u5230\u8ddf\u4e3b\u5e93\u4e00\u81f4\u7684\u72b6\u6001\uff0c\u8fd9\u5c31\u662f\u6700\u7ec8\u4e00\u81f4\u6027\u3002</p> <p>\u4f46\u662f\uff0cMySQL \u8981\u63d0\u4f9b\u9ad8\u53ef\u7528\u80fd\u529b\uff0c\u53ea\u6709\u6700\u7ec8\u4e00\u81f4\u6027\u662f\u4e0d\u591f\u7684\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u4eca\u5929\u6211\u5c31\u7740\u91cd\u548c\u4f60\u5206\u6790\u4e00\u4e0b\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u518d\u653e\u4e00\u6b21\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bb2\u5230\u7684\u53cc M \u7ed3\u6784\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u56fe\u3002</p> <p></p> <p>\u56fe 1 MySQL \u4e3b\u5907\u5207\u6362\u6d41\u7a0b -- \u53cc M \u7ed3\u6784</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_19","title":"\u4e3b\u5907\u5ef6\u8fdf","text":"<p>\u4e3b\u5907\u5207\u6362\u53ef\u80fd\u662f\u4e00\u4e2a\u4e3b\u52a8\u8fd0\u7ef4\u52a8\u4f5c\uff0c\u6bd4\u5982\u8f6f\u4ef6\u5347\u7ea7\u3001\u4e3b\u5e93\u6240\u5728\u673a\u5668\u6309\u8ba1\u5212\u4e0b\u7ebf\u7b49\uff0c\u4e5f\u53ef\u80fd\u662f\u88ab\u52a8\u64cd\u4f5c\uff0c\u6bd4\u5982\u4e3b\u5e93\u6240\u5728\u673a\u5668\u6389\u7535\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5148\u4e00\u8d77\u770b\u770b\u4e3b\u52a8\u5207\u6362\u7684\u573a\u666f\u3002</p> <p>\u5728\u4ecb\u7ecd\u4e3b\u52a8\u5207\u6362\u6d41\u7a0b\u7684\u8be6\u7ec6\u6b65\u9aa4\u4e4b\u524d\uff0c\u6211\u8981\u5148\u8ddf\u4f60\u8bf4\u660e\u4e00\u4e2a\u6982\u5ff5\uff0c\u5373\u201c\u540c\u6b65\u5ef6\u8fdf\u201d\u3002\u4e0e\u6570\u636e\u540c\u6b65\u6709\u5173\u7684\u65f6\u95f4\u70b9\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u4e09\u4e2a\uff1a</p> <ol> <li>\u4e3b\u5e93 A \u6267\u884c\u5b8c\u6210\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5199\u5165 binlog\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u65f6\u523b\u8bb0\u4e3a T1;</li> <li>\u4e4b\u540e\u4f20\u7ed9\u5907\u5e93 B\uff0c\u6211\u4eec\u628a\u5907\u5e93 B \u63a5\u6536\u5b8c\u8fd9\u4e2a binlog \u7684\u65f6\u523b\u8bb0\u4e3a T2;</li> <li>\u5907\u5e93 B \u6267\u884c\u5b8c\u6210\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u65f6\u523b\u8bb0\u4e3a T3\u3002</li> </ol> <p>\u6240\u8c13\u4e3b\u5907\u5ef6\u8fdf\uff0c\u5c31\u662f\u540c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u5b8c\u6210\u7684\u65f6\u95f4\u548c\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\u7684\u65f6\u95f4\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u4e5f\u5c31\u662f T3-T1\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728\u5907\u5e93\u4e0a\u6267\u884c <code>show slave status</code> \u547d\u4ee4\uff0c\u5b83\u7684\u8fd4\u56de\u7ed3\u679c\u91cc\u9762\u4f1a\u663e\u793a <code>seconds_behind_master</code>\uff0c\u7528\u4e8e\u8868\u793a\u5f53\u524d\u5907\u5e93\u5ef6\u8fdf\u4e86\u591a\u5c11\u79d2\u3002</p> <p><code>seconds_behind_master</code> \u7684\u8ba1\u7b97\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u6bcf\u4e2a\u4e8b\u52a1\u7684 binlog \u91cc\u9762\u90fd\u6709\u4e00\u4e2a\u65f6\u95f4\u5b57\u6bb5\uff0c\u7528\u4e8e\u8bb0\u5f55\u4e3b\u5e93\u4e0a\u5199\u5165\u7684\u65f6\u95f4\uff1b</li> <li>\u5907\u5e93\u53d6\u51fa\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u5b57\u6bb5\u7684\u503c\uff0c\u8ba1\u7b97\u5b83\u4e0e\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u7684\u5dee\u503c\uff0c\u5f97\u5230 <code>seconds_behind_master</code>\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5176\u5b9e <code>seconds_behind_master</code> \u8fd9\u4e2a\u53c2\u6570\u8ba1\u7b97\u7684\u5c31\u662f <code>T3-T1</code>\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 <code>seconds_behind_master</code> \u6765\u4f5c\u4e3a\u4e3b\u5907\u5ef6\u8fdf\u7684\u503c\uff0c\u8fd9\u4e2a\u503c\u7684\u65f6\u95f4\u7cbe\u5ea6\u662f\u79d2\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u5982\u679c\u4e3b\u5907\u5e93\u673a\u5668\u7684\u7cfb\u7edf\u65f6\u95f4\u8bbe\u7f6e\u4e0d\u4e00\u81f4\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u503c\u4e0d\u51c6\uff1f</p> <p>\u5176\u5b9e\u4e0d\u4f1a\u7684\u3002\u56e0\u4e3a\uff0c\u5907\u5e93\u8fde\u63a5\u5230\u4e3b\u5e93\u7684\u65f6\u5019\uff0c\u4f1a\u901a\u8fc7\u6267\u884c <code>SELECT UNIX_TIMESTAMP()</code> \u51fd\u6570\u6765\u83b7\u5f97\u5f53\u524d\u4e3b\u5e93\u7684\u7cfb\u7edf\u65f6\u95f4\u3002\u5982\u679c\u8fd9\u65f6\u5019\u53d1\u73b0\u4e3b\u5e93\u7684\u7cfb\u7edf\u65f6\u95f4\u4e0e\u81ea\u5df1\u4e0d\u4e00\u81f4\uff0c\u5907\u5e93\u5728\u6267\u884c <code>seconds_behind_master</code> \u8ba1\u7b97\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u6263\u6389\u8fd9\u4e2a\u5dee\u503c\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5728\u7f51\u7edc\u6b63\u5e38\u7684\u65f6\u5019\uff0c\u65e5\u5fd7\u4ece\u4e3b\u5e93\u4f20\u7ed9\u5907\u5e93\u6240\u9700\u7684\u65f6\u95f4\u662f\u5f88\u77ed\u7684\uff0c\u5373 T2-T1 \u7684\u503c\u662f\u975e\u5e38\u5c0f\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7f51\u7edc\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e3b\u5907\u5ef6\u8fdf\u7684\u4e3b\u8981\u6765\u6e90\u662f\u5907\u5e93\u63a5\u6536\u5b8c binlog \u548c\u6267\u884c\u5b8c\u8fd9\u4e2a\u4e8b\u52a1\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\u3002</p> <p>\u6240\u4ee5\u8bf4\uff0c\u4e3b\u5907\u5ef6\u8fdf\u6700\u76f4\u63a5\u7684\u8868\u73b0\u662f\uff0c\u5907\u5e93\u6d88\u8d39\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u7684\u901f\u5ea6\uff0c\u6bd4\u4e3b\u5e93\u751f\u4ea7 binlog \u7684\u901f\u5ea6\u8981\u6162\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u548c\u4f60\u4e00\u8d77\u5206\u6790\u4e0b\uff0c\u8fd9\u53ef\u80fd\u662f\u7531\u54ea\u4e9b\u539f\u56e0\u5bfc\u81f4\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_20","title":"\u4e3b\u5907\u5ef6\u8fdf\u7684\u6765\u6e90","text":"<p>\u9996\u5148\uff0c\u6709\u4e9b\u90e8\u7f72\u6761\u4ef6\u4e0b\uff0c\u5907\u5e93\u6240\u5728\u673a\u5668\u7684\u6027\u80fd\u8981\u6bd4\u4e3b\u5e93\u6240\u5728\u7684\u673a\u5668\u6027\u80fd\u5dee\u3002</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6709\u4eba\u8fd9\u4e48\u90e8\u7f72\u65f6\u7684\u60f3\u6cd5\u662f\uff0c\u53cd\u6b63\u5907\u5e93\u6ca1\u6709\u8bf7\u6c42\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528\u5dee\u4e00\u70b9\u513f\u7684\u673a\u5668\u3002\u6216\u8005\uff0c\u4ed6\u4eec\u4f1a\u628a 20 \u4e2a\u4e3b\u5e93\u653e\u5728 4 \u53f0\u673a\u5668\u4e0a\uff0c\u800c\u628a\u5907\u5e93\u96c6\u4e2d\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u3002</p> <p>\u5176\u5b9e\u6211\u4eec\u90fd\u77e5\u9053\uff0c\u66f4\u65b0\u8bf7\u6c42\u5bf9 IOPS \u7684\u538b\u529b\uff0c\u5728\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u662f\u65e0\u5dee\u522b\u7684\u3002\u6240\u4ee5\uff0c\u505a\u8fd9\u79cd\u90e8\u7f72\u65f6\uff0c\u4e00\u822c\u90fd\u4f1a\u5c06\u5907\u5e93\u8bbe\u7f6e\u4e3a\u201c\u975e\u53cc 1\u201d\u7684\u6a21\u5f0f\u3002</p> <p>\u4f46\u5b9e\u9645\u4e0a\uff0c\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u4e5f\u4f1a\u89e6\u53d1\u5927\u91cf\u7684\u8bfb\u64cd\u4f5c\u3002\u6240\u4ee5\uff0c\u5f53\u5907\u5e93\u4e3b\u673a\u4e0a\u7684\u591a\u4e2a\u5907\u5e93\u90fd\u5728\u4e89\u62a2\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u4e86\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u79cd\u90e8\u7f72\u73b0\u5728\u6bd4\u8f83\u5c11\u4e86\u3002\u56e0\u4e3a\u4e3b\u5907\u53ef\u80fd\u53d1\u751f\u5207\u6362\uff0c\u5907\u5e93\u968f\u65f6\u53ef\u80fd\u53d8\u6210\u4e3b\u5e93\uff0c\u6240\u4ee5\u4e3b\u5907\u5e93\u9009\u7528\u76f8\u540c\u89c4\u683c\u7684\u673a\u5668\uff0c\u5e76\u4e14\u505a\u5bf9\u79f0\u90e8\u7f72\uff0c\u662f\u73b0\u5728\u6bd4\u8f83\u5e38\u89c1\u7684\u60c5\u51b5\u3002</p> <p>\u8ffd\u95ee 1\uff1a\u4f46\u662f\uff0c\u505a\u4e86\u5bf9\u79f0\u90e8\u7f72\u4ee5\u540e\uff0c\u8fd8\u53ef\u80fd\u4f1a\u6709\u5ef6\u8fdf\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u8fd9\u5c31\u662f**\u7b2c\u4e8c\u79cd\u5e38\u89c1\u7684\u53ef\u80fd\u4e86\uff0c\u5373\u5907\u5e93\u7684\u538b\u529b\u5927**\u3002\u4e00\u822c\u7684\u60f3\u6cd5\u662f\uff0c\u4e3b\u5e93\u65e2\u7136\u63d0\u4f9b\u4e86\u5199\u80fd\u529b\uff0c\u90a3\u4e48\u5907\u5e93\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e9b\u8bfb\u80fd\u529b\u3002\u6216\u8005\u4e00\u4e9b\u8fd0\u8425\u540e\u53f0\u9700\u8981\u7684\u5206\u6790\u8bed\u53e5\uff0c\u4e0d\u80fd\u5f71\u54cd\u6b63\u5e38\u4e1a\u52a1\uff0c\u6240\u4ee5\u53ea\u80fd\u5728\u5907\u5e93\u4e0a\u8dd1\u3002</p> <p>\u6211\u771f\u5c31\u89c1\u8fc7\u4e0d\u5c11\u8fd9\u6837\u7684\u60c5\u51b5\u3002\u7531\u4e8e\u4e3b\u5e93\u76f4\u63a5\u5f71\u54cd\u4e1a\u52a1\uff0c\u5927\u5bb6\u4f7f\u7528\u8d77\u6765\u4f1a\u6bd4\u8f83\u514b\u5236\uff0c\u53cd\u800c\u5ffd\u89c6\u4e86\u5907\u5e93\u7684\u538b\u529b\u63a7\u5236\u3002\u7ed3\u679c\u5c31\u662f\uff0c\u5907\u5e93\u4e0a\u7684\u67e5\u8be2\u8017\u8d39\u4e86\u5927\u91cf\u7684 CPU \u8d44\u6e90\uff0c\u5f71\u54cd\u4e86\u540c\u6b65\u901f\u5ea6\uff0c\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u3002</p> <p>\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u4e00\u822c\u53ef\u4ee5\u8fd9\u4e48\u5904\u7406\uff1a</p> <ol> <li>\u4e00\u4e3b\u591a\u4ece\u3002\u9664\u4e86\u5907\u5e93\u5916\uff0c\u53ef\u4ee5\u591a\u63a5\u51e0\u4e2a\u4ece\u5e93\uff0c\u8ba9\u8fd9\u4e9b\u4ece\u5e93\u6765\u5206\u62c5\u8bfb\u7684\u538b\u529b\u3002</li> <li>\u901a\u8fc7 binlog \u8f93\u51fa\u5230\u5916\u90e8\u7cfb\u7edf\uff0c\u6bd4\u5982 Hadoop \u8fd9\u7c7b\u7cfb\u7edf\uff0c\u8ba9\u5916\u90e8\u7cfb\u7edf\u63d0\u4f9b\u7edf\u8ba1\u7c7b\u67e5\u8be2\u7684\u80fd\u529b\u3002</li> </ol> <p>\u5176\u4e2d\uff0c\u4e00\u4e3b\u591a\u4ece\u7684\u65b9\u5f0f\u5927\u90fd\u4f1a\u88ab\u91c7\u7528\u3002\u56e0\u4e3a\u4f5c\u4e3a\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u8fd8\u5fc5\u987b\u4fdd\u8bc1\u6709\u5b9a\u671f\u5168\u91cf\u5907\u4efd\u7684\u80fd\u529b\u3002\u800c\u4ece\u5e93\uff0c\u5c31\u5f88\u9002\u5408\u7528\u6765\u505a\u5907\u4efd\u3002</p> <p>\u5907\u6ce8\uff1a\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u4e00\u4e0b\uff0c\u4ece\u5e93\u548c\u5907\u5e93\u5728\u6982\u5ff5\u4e0a\u5176\u5b9e\u5dee\u4e0d\u591a\u3002\u5728\u6211\u4eec\u8fd9\u4e2a\u4e13\u680f\u91cc\uff0c\u4e3a\u4e86\u65b9\u4fbf\u63cf\u8ff0\uff0c\u6211\u628a\u4f1a\u5728 HA \u8fc7\u7a0b\u4e2d\u88ab\u9009\u6210\u65b0\u4e3b\u5e93\u7684\uff0c\u79f0\u4e3a\u5907\u5e93\uff0c\u5176\u4ed6\u7684\u79f0\u4e3a\u4ece\u5e93\u3002</p> <p>\u8ffd\u95ee 2\uff1a\u91c7\u7528\u4e86\u4e00\u4e3b\u591a\u4ece\uff0c\u4fdd\u8bc1\u5907\u5e93\u7684\u538b\u529b\u4e0d\u4f1a\u8d85\u8fc7\u4e3b\u5e93\uff0c\u8fd8\u6709\u4ec0\u4e48\u60c5\u51b5\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u5417\uff1f</p> <p>\u8fd9\u5c31\u662f\u7b2c\u4e09\u79cd\u53ef\u80fd\u4e86\uff0c\u5373\u5927\u4e8b\u52a1\u3002</p> <p>\u5927\u4e8b\u52a1\u8fd9\u79cd\u60c5\u51b5\u5f88\u597d\u7406\u89e3\u3002\u56e0\u4e3a\u4e3b\u5e93\u4e0a\u5fc5\u987b\u7b49\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\u624d\u4f1a\u5199\u5165 binlog\uff0c\u518d\u4f20\u7ed9\u5907\u5e93\u3002\u6240\u4ee5\uff0c\u5982\u679c\u4e00\u4e2a\u4e3b\u5e93\u4e0a\u7684\u8bed\u53e5\u6267\u884c 10 \u5206\u949f\uff0c\u90a3\u8fd9\u4e2a\u4e8b\u52a1\u5f88\u53ef\u80fd\u5c31\u4f1a\u5bfc\u81f4\u4ece\u5e93\u5ef6\u8fdf 10 \u5206\u949f\u3002</p> <p>\u4e0d\u77e5\u9053\u4f60\u6240\u5728\u516c\u53f8\u7684 DBA \u6709\u6ca1\u6709\u8ddf\u4f60\u8fd9\u4e48\u8bf4\u8fc7\uff1a\u4e0d\u8981**\u4e00\u6b21\u6027\u5730\u7528 delete \u8bed\u53e5\u5220\u9664\u592a\u591a\u6570\u636e**\u3002\u5176\u5b9e\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5927\u4e8b\u52a1\u573a\u666f\u3002</p> <p>\u6bd4\u5982\uff0c\u4e00\u4e9b\u5f52\u6863\u7c7b\u7684\u6570\u636e\uff0c\u5e73\u65f6\u6ca1\u6709\u6ce8\u610f\u5220\u9664\u5386\u53f2\u6570\u636e\uff0c\u7b49\u5230\u7a7a\u95f4\u5feb\u6ee1\u4e86\uff0c\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u8981\u4e00\u6b21\u6027\u5730\u5220\u6389\u5927\u91cf\u5386\u53f2\u6570\u636e\u3002\u540c\u65f6\uff0c\u53c8\u56e0\u4e3a\u8981\u907f\u514d\u5728\u9ad8\u5cf0\u671f\u64cd\u4f5c\u4f1a\u5f71\u54cd\u4e1a\u52a1\uff08\u81f3\u5c11\u6709\u8fd9\u4e2a\u610f\u8bc6\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\uff09\uff0c\u6240\u4ee5\u4f1a\u5728\u665a\u4e0a\u6267\u884c\u8fd9\u4e9b\u5927\u91cf\u6570\u636e\u7684\u5220\u9664\u64cd\u4f5c\u3002</p> <p>\u7ed3\u679c\uff0c\u8d1f\u8d23\u7684 DBA \u540c\u5b66\u534a\u591c\u5c31\u4f1a\u6536\u5230\u5ef6\u8fdf\u62a5\u8b66\u3002\u7136\u540e\uff0cDBA \u56e2\u961f\u5c31\u8981\u6c42\u4f60\u540e\u7eed\u518d\u5220\u9664\u6570\u636e\u7684\u65f6\u5019\uff0c\u8981\u63a7\u5236\u6bcf\u4e2a\u4e8b\u52a1\u5220\u9664\u7684\u6570\u636e\u91cf\uff0c\u5206\u6210\u591a\u6b21\u5220\u9664\u3002</p> <p>**\u53e6\u4e00\u79cd\u5178\u578b\u7684\u5927\u4e8b\u52a1\u573a\u666f\uff0c\u5c31\u662f\u5927\u8868 DDL\u3002**\u8fd9\u4e2a\u573a\u666f\uff0c\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u8fc7\u3002\u5904\u7406\u65b9\u6848\u5c31\u662f\uff0c\u8ba1\u5212\u5185\u7684 DDL\uff0c\u5efa\u8bae\u4f7f\u7528 gh-ost \u65b9\u6848.</p> <p>\u8ffd\u95ee 3\uff1a\u5982\u679c\u4e3b\u5e93\u4e0a\u4e5f\u4e0d\u505a\u5927\u4e8b\u52a1\u4e86\uff0c\u8fd8\u6709\u4ec0\u4e48\u539f\u56e0\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u5417\uff1f</p> <p>\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u8fd8\u6709\u4e00\u4e2a\u5927\u65b9\u5411\u7684\u539f\u56e0\uff0c\u5c31\u662f**\u5907\u5e93\u7684\u5e76\u884c\u590d\u5236\u80fd\u529b**\u3002\u8fd9\u4e2a\u8bdd\u9898\uff0c\u6211\u4f1a\u7559\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u518d\u548c\u4f60\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u5176\u5b9e\u8fd8\u662f\u6709\u4e0d\u5c11\u5176\u4ed6\u60c5\u51b5\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\uff0c\u5982\u679c\u4f60\u8fd8\u78b0\u5230\u8fc7\u5176\u4ed6\u573a\u666f\uff0c\u6b22\u8fce\u4f60\u5728\u8bc4\u8bba\u533a\u7ed9\u6211\u7559\u8a00\uff0c\u6211\u6765\u548c\u4f60\u4e00\u8d77\u5206\u6790\u3001\u8ba8\u8bba\u3002</p> <p>\u7531\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u5b58\u5728\uff0c\u6240\u4ee5\u5728\u4e3b\u5907\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u76f8\u5e94\u7684\u6709\u4e0d\u540c\u7684\u7b56\u7565\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_21","title":"\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565","text":"<p>\u5728\u56fe 1 \u7684\u53cc M \u7ed3\u6784\u4e0b\uff0c\u4ece\u72b6\u6001 1 \u5230\u72b6\u6001 2 \u5207\u6362\u7684\u8be6\u7ec6\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5224\u65ad\u5907\u5e93 B \u73b0\u5728\u7684 <code>seconds_behind_master</code>\uff0c\u5982\u679c\u5c0f\u4e8e\u67d0\u4e2a\u503c\uff08\u6bd4\u5982 5 \u79d2\uff09\u7ee7\u7eed\u4e0b\u4e00\u6b65\uff0c\u5426\u5219\u6301\u7eed\u91cd\u8bd5\u8fd9\u4e00\u6b65\uff1b</li> <li>\u628a\u4e3b\u5e93 A \u6539\u6210\u53ea\u8bfb\u72b6\u6001\uff0c\u5373\u628a readonly \u8bbe\u7f6e\u4e3a true\uff1b</li> <li>\u5224\u65ad\u5907\u5e93 B \u7684 <code>seconds_behind_master</code> \u7684\u503c\uff0c\u76f4\u5230\u8fd9\u4e2a\u503c\u53d8\u6210 0 \u4e3a\u6b62\uff1b</li> <li>\u628a\u5907\u5e93 B \u6539\u6210\u53ef\u8bfb\u5199\u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u628a readonly \u8bbe\u7f6e\u4e3a false\uff1b</li> <li>\u628a\u4e1a\u52a1\u8bf7\u6c42\u5207\u5230\u5907\u5e93 B\u3002</li> </ol> <p>\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff0c\u4e00\u822c\u662f\u7531\u4e13\u95e8\u7684 HA \u7cfb\u7edf\u6765\u5b8c\u6210\u7684\uff0c\u6211\u4eec\u6682\u65f6\u79f0\u4e4b\u4e3a\u53ef\u9760\u6027\u4f18\u5148\u6d41\u7a0b\u3002</p> <p></p> <p>\u56fe 2 MySQL \u53ef\u9760\u6027\u4f18\u5148\u4e3b\u5907\u5207\u6362\u6d41\u7a0b</p> <p>\u5907\u6ce8\uff1a\u56fe\u4e2d\u7684 SBM\uff0c\u662f <code>seconds_behind_master</code> \u53c2\u6570\u7684\u7b80\u5199\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\u4e2d\u662f\u6709\u4e0d\u53ef\u7528\u65f6\u95f4\u7684\u3002\u56e0\u4e3a\u5728\u6b65\u9aa4 2 \u4e4b\u540e\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u90fd\u5904\u4e8e readonly \u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u65f6\u7cfb\u7edf\u5904\u4e8e\u4e0d\u53ef\u5199\u72b6\u6001\uff0c\u76f4\u5230\u6b65\u9aa4 5 \u5b8c\u6210\u540e\u624d\u80fd\u6062\u590d\u3002</p> <p>\u5728\u8fd9\u4e2a\u4e0d\u53ef\u7528\u72b6\u6001\u4e2d\uff0c\u6bd4\u8f83\u8017\u8d39\u65f6\u95f4\u7684\u662f\u6b65\u9aa4 3\uff0c\u53ef\u80fd\u9700\u8981\u8017\u8d39\u597d\u51e0\u79d2\u7684\u65f6\u95f4\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u9700\u8981\u5728\u6b65\u9aa4 1 \u5148\u505a\u5224\u65ad\uff0c\u786e\u4fdd <code>seconds_behind_master</code> \u7684\u503c\u8db3\u591f\u5c0f\u3002</p> <p>\u8bd5\u60f3\u5982\u679c\u4e00\u5f00\u59cb\u4e3b\u5907\u5ef6\u8fdf\u5c31\u957f\u8fbe 30 \u5206\u949f\uff0c\u800c\u4e0d\u5148\u505a\u5224\u65ad\u76f4\u63a5\u5207\u6362\u7684\u8bdd\uff0c\u7cfb\u7edf\u7684\u4e0d\u53ef\u7528\u65f6\u95f4\u5c31\u4f1a\u957f\u8fbe 30 \u5206\u949f\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e00\u822c\u4e1a\u52a1\u90fd\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002</p> <p>\u5f53\u7136\uff0c\u7cfb\u7edf\u7684\u4e0d\u53ef\u7528\u65f6\u95f4\uff0c\u662f\u7531\u8fd9\u4e2a\u6570\u636e\u53ef\u9760\u6027\u4f18\u5148\u7684\u7b56\u7565\u51b3\u5b9a\u7684\u3002\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u53ef\u7528\u6027\u4f18\u5148\u7684\u7b56\u7565\uff0c\u6765\u628a\u8fd9\u4e2a\u4e0d\u53ef\u7528\u65f6\u95f4\u51e0\u4e4e\u964d\u4e3a 0\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_22","title":"\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565","text":"<p>\u5982\u679c\u6211\u5f3a\u884c\u628a\u6b65\u9aa4 4\u30015 \u8c03\u6574\u5230\u6700\u5f00\u59cb\u6267\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e0d\u7b49\u4e3b\u5907\u6570\u636e\u540c\u6b65\uff0c\u76f4\u63a5\u628a\u8fde\u63a5\u5207\u5230\u5907\u5e93 B\uff0c\u5e76\u4e14\u8ba9\u5907\u5e93 B \u53ef\u4ee5\u8bfb\u5199\uff0c\u90a3\u4e48\u7cfb\u7edf\u51e0\u4e4e\u5c31\u6ca1\u6709\u4e0d\u53ef\u7528\u65f6\u95f4\u4e86\u3002</p> <p>\u6211\u4eec\u628a\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff0c\u6682\u65f6\u79f0\u4f5c\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u3002\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\u7684\u4ee3\u4ef7\uff0c\u5c31\u662f\u53ef\u80fd\u51fa\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u548c\u4f60\u5206\u4eab\u4e00\u4e2a\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u4ea7\u751f\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u4f8b\u5b50\u3002\u5047\u8bbe\u6709\u4e00\u4e2a\u8868 t\uff1a</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,\n  `c` int(11) unsigned DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \ninsert into t(c) values(1),(2),(3);\n</code></pre> <p>\u8fd9\u4e2a\u8868\u5b9a\u4e49\u4e86\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e id\uff0c\u521d\u59cb\u5316\u6570\u636e\u540e\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u90fd\u662f 3 \u884c\u6570\u636e\u3002\u63a5\u4e0b\u6765\uff0c\u4e1a\u52a1\u4eba\u5458\u8981\u7ee7\u7eed\u5728\u8868 t \u4e0a\u6267\u884c\u4e24\u6761\u63d2\u5165\u8bed\u53e5\u7684\u547d\u4ee4\uff0c\u4f9d\u6b21\u662f\uff1a</p> <pre><code>insert into t(c) values(4);\ninsert into t(c) values(5);\n</code></pre> <p>\u5047\u8bbe\uff0c\u73b0\u5728\u4e3b\u5e93\u4e0a\u5176\u4ed6\u7684\u6570\u636e\u8868\u6709\u5927\u91cf\u7684\u66f4\u65b0\uff0c\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u8fbe\u5230 5 \u79d2\u3002\u5728\u63d2\u5165\u4e00\u6761 c=4 \u7684\u8bed\u53e5\u540e\uff0c\u53d1\u8d77\u4e86\u4e3b\u5907\u5207\u6362\u3002</p> <p>\u56fe 3 \u662f**\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 binlog_format=mixed**\u65f6\u7684\u5207\u6362\u6d41\u7a0b\u548c\u6570\u636e\u7ed3\u679c\u3002</p> <p></p> <p>\u56fe 3 \u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 <code>binlog_format=mixed</code></p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u5206\u6790\u4e0b\u8fd9\u4e2a\u5207\u6362\u6d41\u7a0b\uff1a</p> <ol> <li>\u6b65\u9aa4 2 \u4e2d\uff0c\u4e3b\u5e93 A \u6267\u884c\u5b8c insert \u8bed\u53e5\uff0c\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff084,4\uff09\uff0c\u4e4b\u540e\u5f00\u59cb\u8fdb\u884c\u4e3b\u5907\u5207\u6362\u3002</li> <li>\u6b65\u9aa4 3 \u4e2d\uff0c\u7531\u4e8e\u4e3b\u5907\u4e4b\u95f4\u6709 5 \u79d2\u7684\u5ef6\u8fdf\uff0c\u6240\u4ee5\u5907\u5e93 B \u8fd8\u6ca1\u6765\u5f97\u53ca\u5e94\u7528\u201c\u63d2\u5165 c=4\u201d\u8fd9\u4e2a\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u5c31\u5f00\u59cb\u63a5\u6536\u5ba2\u6237\u7aef\u201c\u63d2\u5165 c=5\u201d\u7684\u547d\u4ee4\u3002</li> <li>\u6b65\u9aa4 4 \u4e2d\uff0c\u5907\u5e93 B \u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff084,5\uff09\uff0c\u5e76\u4e14\u628a\u8fd9\u4e2a binlog \u53d1\u7ed9\u4e3b\u5e93 A\u3002</li> <li>\u6b65\u9aa4 5 \u4e2d\uff0c\u5907\u5e93 B \u6267\u884c\u201c\u63d2\u5165 c=4\u201d\u8fd9\u4e2a\u4e2d\u8f6c\u65e5\u5fd7\uff0c\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e\uff085,4\uff09\u3002\u800c\u76f4\u63a5\u5728\u5907\u5e93 B \u6267\u884c\u7684\u201c\u63d2\u5165 c=5\u201d\u8fd9\u4e2a\u8bed\u53e5\uff0c\u4f20\u5230\u4e3b\u5e93 A\uff0c\u5c31\u63d2\u5165\u4e86\u4e00\u884c\u65b0\u6570\u636e\uff085,5\uff09\u3002</li> </ol> <p>\u6700\u540e\u7684\u7ed3\u679c\u5c31\u662f\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u4e0a\u51fa\u73b0\u4e86\u4e24\u884c\u4e0d\u4e00\u81f4\u7684\u6570\u636e\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u662f\u7531\u53ef\u7528\u6027\u4f18\u5148\u6d41\u7a0b\u5bfc\u81f4\u7684\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u8fd8\u662f\u7528**\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4f46\u8bbe\u7f6e binlog_format=row**\uff0c\u60c5\u51b5\u53c8\u4f1a\u600e\u6837\u5462\uff1f</p> <p>\u56e0\u4e3a row \u683c\u5f0f\u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4f1a\u8bb0\u5f55\u65b0\u63d2\u5165\u7684\u884c\u7684\u6240\u6709\u5b57\u6bb5\u503c\uff0c\u6240\u4ee5\u6700\u540e\u53ea\u4f1a\u6709\u4e00\u884c\u4e0d\u4e00\u81f4\u3002\u800c\u4e14\uff0c\u4e24\u8fb9\u7684\u4e3b\u5907\u540c\u6b65\u7684\u5e94\u7528\u7ebf\u7a0b\u4f1a\u62a5\u9519 duplicate key error \u5e76\u505c\u6b62\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5907\u5e93 B \u7684 (5,4) \u548c\u4e3b\u5e93 A \u7684 (5,5) \u8fd9\u4e24\u884c\u6570\u636e\uff0c\u90fd\u4e0d\u4f1a\u88ab\u5bf9\u65b9\u6267\u884c\u3002</p> <p>\u56fe 4 \u4e2d\u6211\u753b\u51fa\u4e86\u8be6\u7ec6\u8fc7\u7a0b\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u518d\u5206\u6790\u4e00\u4e0b\u3002</p> <p></p> <p>\u56fe 4 \u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e14 <code>binlog_format=row</code></p> <p>\u4ece\u4e0a\u9762\u7684\u5206\u6790\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u7ed3\u8bba\uff1a</p> <ol> <li>\u4f7f\u7528 row \u683c\u5f0f\u7684 binlog \u65f6\uff0c\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u66f4\u5bb9\u6613\u88ab\u53d1\u73b0\u3002\u800c\u4f7f\u7528 mixed \u6216\u8005 statement \u683c\u5f0f\u7684 binlog \u65f6\uff0c\u6570\u636e\u5f88\u53ef\u80fd\u6084\u6084\u5730\u5c31\u4e0d\u4e00\u81f4\u4e86\u3002\u5982\u679c\u4f60\u8fc7\u4e86\u5f88\u4e45\u624d\u53d1\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u5f88\u53ef\u80fd\u8fd9\u65f6\u7684\u6570\u636e\u4e0d\u4e00\u81f4\u5df2\u7ecf\u4e0d\u53ef\u67e5\uff0c\u6216\u8005\u8fde\u5e26\u9020\u6210\u4e86\u66f4\u591a\u7684\u6570\u636e\u903b\u8f91\u4e0d\u4e00\u81f4\u3002</li> <li>\u4e3b\u5907\u5207\u6362\u7684\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\u4f1a\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\u3002\u56e0\u6b64\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u3002\u6bd5\u7adf\u5bf9\u6570\u636e\u670d\u52a1\u6765\u8bf4\u7684\u8bdd\uff0c\u6570\u636e\u7684\u53ef\u9760\u6027\u4e00\u822c\u8fd8\u662f\u8981\u4f18\u4e8e\u53ef\u7528\u6027\u7684\u3002</li> </ol> <p>\u4f46\u4e8b\u65e0\u7edd\u5bf9\uff0c\u6709\u6ca1\u6709\u54ea\u79cd\u60c5\u51b5\u6570\u636e\u7684\u53ef\u7528\u6027\u4f18\u5148\u7ea7\u66f4\u9ad8\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p> <p>\u6211\u66fe\u7ecf\u78b0\u5230\u8fc7\u8fd9\u6837\u7684\u4e00\u4e2a\u573a\u666f\uff1a</p> <ul> <li>\u6709\u4e00\u4e2a\u5e93\u7684\u4f5c\u7528\u662f\u8bb0\u5f55\u64cd\u4f5c\u65e5\u5fd7\u3002\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u6570\u636e\u4e0d\u4e00\u81f4\u53ef\u4ee5\u901a\u8fc7 binlog \u6765\u4fee\u8865\uff0c\u800c\u8fd9\u4e2a\u77ed\u6682\u7684\u4e0d\u4e00\u81f4\u4e5f\u4e0d\u4f1a\u5f15\u53d1\u4e1a\u52a1\u95ee\u9898\u3002</li> <li>\u540c\u65f6\uff0c\u4e1a\u52a1\u7cfb\u7edf\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u65e5\u5fd7\u5199\u5165\u903b\u8f91\uff0c\u5982\u679c\u8fd9\u4e2a\u5e93\u4e0d\u53ef\u5199\uff0c\u4f1a\u5bfc\u81f4\u7ebf\u4e0a\u7684\u4e1a\u52a1\u64cd\u4f5c\u65e0\u6cd5\u6267\u884c\u3002</li> </ul> <p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u5c31\u9700\u8981\u9009\u62e9\u5148\u5f3a\u884c\u5207\u6362\uff0c\u4e8b\u540e\u518d\u8865\u6570\u636e\u7684\u7b56\u7565\u3002</p> <p>\u5f53\u7136\uff0c\u4e8b\u540e\u590d\u76d8\u7684\u65f6\u5019\uff0c\u6211\u4eec\u60f3\u5230\u4e86\u4e00\u4e2a\u6539\u8fdb\u63aa\u65bd\u5c31\u662f\uff0c\u8ba9\u4e1a\u52a1\u903b\u8f91\u4e0d\u8981\u4f9d\u8d56\u4e8e\u8fd9\u7c7b\u65e5\u5fd7\u7684\u5199\u5165\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u65e5\u5fd7\u5199\u5165\u8fd9\u4e2a\u903b\u8f91\u6a21\u5757\u5e94\u8be5\u53ef\u4ee5\u964d\u7ea7\uff0c\u6bd4\u5982\u5199\u5230\u672c\u5730\u6587\u4ef6\uff0c\u6216\u8005\u5199\u5230\u53e6\u5916\u4e00\u4e2a\u4e34\u65f6\u5e93\u91cc\u9762\u3002</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u8fd9\u79cd\u573a\u666f\u5c31\u53c8\u53ef\u4ee5\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u770b\u770b\uff0c\u6309\u7167\u53ef\u9760\u6027\u4f18\u5148\u7684\u601d\u8def\uff0c\u5f02\u5e38\u5207\u6362\u4f1a\u662f\u4ec0\u4e48\u6548\u679c\uff1f</p> <p>\u5047\u8bbe\uff0c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u95f4\u7684\u4e3b\u5907\u5ef6\u8fdf\u662f 30 \u5206\u949f\uff0c\u8fd9\u65f6\u5019\u4e3b\u5e93 A \u6389\u7535\u4e86\uff0cHA \u7cfb\u7edf\u8981\u5207\u6362 B \u4f5c\u4e3a\u4e3b\u5e93\u3002\u6211\u4eec\u5728\u4e3b\u52a8\u5207\u6362\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u7b49\u5230\u4e3b\u5907\u5ef6\u8fdf\u5c0f\u4e8e 5 \u79d2\u7684\u65f6\u5019\u518d\u542f\u52a8\u5207\u6362\uff0c\u4f46\u8fd9\u65f6\u5019\u5df2\u7ecf\u522b\u65e0\u9009\u62e9\u4e86\u3002</p> <p></p> <p>\u56fe 5 \u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\uff0c\u4e3b\u5e93\u4e0d\u53ef\u7528</p> <p>\u91c7\u7528\u53ef\u9760\u6027\u4f18\u5148\u7b56\u7565\u7684\u8bdd\uff0c\u4f60\u5c31\u5fc5\u987b\u5f97\u7b49\u5230\u5907\u5e93 B \u7684 <code>seconds_behind_master</code>=0 \u4e4b\u540e\uff0c\u624d\u80fd\u5207\u6362\u3002\u4f46\u73b0\u5728\u7684\u60c5\u51b5\u6bd4\u521a\u521a\u66f4\u4e25\u91cd\uff0c\u5e76\u4e0d\u662f\u7cfb\u7edf\u53ea\u8bfb\u3001\u4e0d\u53ef\u5199\u7684\u95ee\u9898\u4e86\uff0c\u800c\u662f\u7cfb\u7edf\u5904\u4e8e\u5b8c\u5168\u4e0d\u53ef\u7528\u7684\u72b6\u6001\u3002\u56e0\u4e3a\uff0c\u4e3b\u5e93 A \u6389\u7535\u540e\uff0c\u6211\u4eec\u7684\u8fde\u63a5\u8fd8\u6ca1\u6709\u5207\u5230\u5907\u5e93 B\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u90a3\u80fd\u4e0d\u80fd\u76f4\u63a5\u5207\u6362\u5230\u5907\u5e93 B\uff0c\u4f46\u662f\u4fdd\u6301 B \u53ea\u8bfb\u5462\uff1f</p> <p>\u8fd9\u6837\u4e5f\u4e0d\u884c\u3002</p> <p>\u56e0\u4e3a\uff0c\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u4e2d\u8f6c\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5e94\u7528\u5b8c\u6210\uff0c\u5982\u679c\u76f4\u63a5\u53d1\u8d77\u4e3b\u5907\u5207\u6362\uff0c\u5ba2\u6237\u7aef\u67e5\u8be2\u770b\u4e0d\u5230\u4e4b\u524d\u6267\u884c\u5b8c\u6210\u7684\u4e8b\u52a1\uff0c\u4f1a\u8ba4\u4e3a\u6709\u201c\u6570\u636e\u4e22\u5931\u201d\u3002</p> <p>\u867d\u7136\u968f\u7740\u4e2d\u8f6c\u65e5\u5fd7\u7684\u7ee7\u7eed\u5e94\u7528\uff0c\u8fd9\u4e9b\u6570\u636e\u4f1a\u6062\u590d\u56de\u6765\uff0c\u4f46\u662f\u5bf9\u4e8e\u4e00\u4e9b\u4e1a\u52a1\u6765\u8bf4\uff0c\u67e5\u8be2\u5230\u201c\u6682\u65f6\u4e22\u5931\u6570\u636e\u7684\u72b6\u6001\u201d\u4e5f\u662f\u4e0d\u80fd\u88ab\u63a5\u53d7\u7684\u3002</p> <p>\u804a\u5230\u8fd9\u91cc\u4f60\u5c31\u77e5\u9053\u4e86\uff0c\u5728\u6ee1\u8db3\u6570\u636e\u53ef\u9760\u6027\u7684\u524d\u63d0\u4e0b\uff0cMySQL \u9ad8\u53ef\u7528\u7cfb\u7edf\u7684\u53ef\u7528\u6027\uff0c\u662f\u4f9d\u8d56\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u3002\u5ef6\u8fdf\u7684\u65f6\u95f4\u8d8a\u5c0f\uff0c\u5728\u4e3b\u5e93\u6545\u969c\u7684\u65f6\u5019\uff0c\u670d\u52a1\u6062\u590d\u9700\u8981\u7684\u65f6\u95f4\u5c31\u8d8a\u77ed\uff0c\u53ef\u7528\u6027\u5c31\u8d8a\u9ad8\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_23","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u9ad8\u53ef\u7528\u7cfb\u7edf\u7684\u57fa\u7840\uff0c\u5c31\u662f\u4e3b\u5907\u5207\u6362\u903b\u8f91\u3002\u7d27\u63a5\u7740\uff0c\u6211\u53c8\u548c\u4f60\u8ba8\u8bba\u4e86\u51e0\u79cd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u60c5\u51b5\uff0c\u4ee5\u53ca\u76f8\u5e94\u7684\u6539\u8fdb\u65b9\u5411\u3002</p> <p>\u7136\u540e\uff0c\u7531\u4e8e\u4e3b\u5907\u5ef6\u8fdf\u7684\u5b58\u5728\uff0c\u5207\u6362\u7b56\u7565\u5c31\u6709\u4e0d\u540c\u7684\u9009\u62e9\u3002\u6240\u4ee5\uff0c\u6211\u53c8\u548c\u4f60\u4e00\u8d77\u5206\u6790\u4e86\u53ef\u9760\u6027\u4f18\u5148\u548c\u53ef\u7528\u6027\u4f18\u5148\u7b56\u7565\u7684\u533a\u522b\u3002</p> <p>\u5728\u5b9e\u9645\u7684\u5e94\u7528\u4e2d\uff0c\u6211\u66f4\u5efa\u8bae\u4f7f\u7528\u53ef\u9760\u6027\u4f18\u5148\u7684\u7b56\u7565\u3002\u6bd5\u7adf\u4fdd\u8bc1\u6570\u636e\u51c6\u786e\uff0c\u5e94\u8be5\u662f\u6570\u636e\u5e93\u670d\u52a1\u7684\u5e95\u7ebf\u3002\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\uff0c\u901a\u8fc7\u51cf\u5c11\u4e3b\u5907\u5ef6\u8fdf\uff0c\u63d0\u5347\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#26","title":"26 \u5907\u5e93\u4e3a\u4ec0\u4e48\u4f1a\u5ef6\u8fdf\u597d\u51e0\u4e2a\u5c0f\u65f6\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u51e0\u79cd\u53ef\u80fd\u5bfc\u81f4\u5907\u5e93\u5ef6\u8fdf\u7684\u539f\u56e0\u3002\u4f60\u4f1a\u53d1\u73b0\uff0c\u8fd9\u4e9b\u573a\u666f\u91cc\uff0c\u4e0d\u8bba\u662f\u5076\u53d1\u6027\u7684\u67e5\u8be2\u538b\u529b\uff0c\u8fd8\u662f\u5907\u4efd\uff0c\u5bf9\u5907\u5e93\u5ef6\u8fdf\u7684\u5f71\u54cd\u4e00\u822c\u662f\u5206\u949f\u7ea7\u7684\uff0c\u800c\u4e14\u5728\u5907\u5e93\u6062\u590d\u6b63\u5e38\u4ee5\u540e\u90fd\u80fd\u591f\u8ffd\u4e0a\u6765\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u5907\u5e93\u6267\u884c\u65e5\u5fd7\u7684\u901f\u5ea6\u6301\u7eed\u4f4e\u4e8e\u4e3b\u5e93\u751f\u6210\u65e5\u5fd7\u7684\u901f\u5ea6\uff0c\u90a3\u8fd9\u4e2a\u5ef6\u8fdf\u5c31\u6709\u53ef\u80fd\u6210\u4e86\u5c0f\u65f6\u7ea7\u522b\u3002\u800c\u4e14\u5bf9\u4e8e\u4e00\u4e2a\u538b\u529b\u6301\u7eed\u6bd4\u8f83\u9ad8\u7684\u4e3b\u5e93\u6765\u8bf4\uff0c\u5907\u5e93\u5f88\u53ef\u80fd\u6c38\u8fdc\u90fd\u8ffd\u4e0d\u4e0a\u4e3b\u5e93\u7684\u8282\u594f\u3002</p> <p>\u8fd9\u5c31\u6d89\u53ca\u5230\u4eca\u5929\u6211\u8981\u7ed9\u4f60\u4ecb\u7ecd\u7684\u8bdd\u9898\uff1a\u5907\u5e93\u5e76\u884c\u590d\u5236\u80fd\u529b\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u4f60\u7406\u89e3\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u4e00\u4e0b\u7b2c 24 \u7bc7\u6587\u7ae0[\u300aMySQL \u662f\u600e\u4e48\u4fdd\u8bc1\u4e3b\u5907\u4e00\u81f4\u7684\uff1f\u300b]\u7684\u4e3b\u5907\u6d41\u7a0b\u56fe\u3002</p> <p></p> <p>\u56fe 1 \u4e3b\u5907\u6d41\u7a0b\u56fe</p> <p>\u8c08\u5230\u4e3b\u5907\u7684\u5e76\u884c\u590d\u5236\u80fd\u529b\uff0c\u6211\u4eec\u8981\u5173\u6ce8\u7684\u662f\u56fe\u4e2d\u9ed1\u8272\u7684\u4e24\u4e2a\u7bad\u5934\u3002\u4e00\u4e2a\u7bad\u5934\u4ee3\u8868\u4e86\u5ba2\u6237\u7aef\u5199\u5165\u4e3b\u5e93\uff0c\u53e6\u4e00\u7bad\u5934\u4ee3\u8868\u7684\u662f\u5907\u5e93\u4e0a <code>sql_thread</code> \u6267\u884c\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u3002\u5982\u679c\u7528\u7bad\u5934\u7684\u7c97\u7ec6\u6765\u4ee3\u8868\u5e76\u884c\u5ea6\u7684\u8bdd\uff0c\u90a3\u4e48\u771f\u5b9e\u60c5\u51b5\u5c31\u5982\u56fe 1 \u6240\u793a\uff0c\u7b2c\u4e00\u4e2a\u7bad\u5934\u8981\u660e\u663e\u7c97\u4e8e\u7b2c\u4e8c\u4e2a\u7bad\u5934\u3002</p> <p>\u5728\u4e3b\u5e93\u4e0a\uff0c\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u539f\u56e0\u5c31\u662f\u5404\u79cd\u9501\u4e86\u3002\u7531\u4e8e InnoDB \u5f15\u64ce\u652f\u6301\u884c\u9501\uff0c\u9664\u4e86\u6240\u6709\u5e76\u53d1\u4e8b\u52a1\u90fd\u5728\u66f4\u65b0\u540c\u4e00\u884c\uff08\u70ed\u70b9\u884c\uff09\u8fd9\u79cd\u6781\u7aef\u573a\u666f\u5916\uff0c\u5b83\u5bf9\u4e1a\u52a1\u5e76\u53d1\u5ea6\u7684\u652f\u6301\u8fd8\u662f\u5f88\u53cb\u597d\u7684\u3002\u6240\u4ee5\uff0c\u4f60\u5728\u6027\u80fd\u6d4b\u8bd5\u7684\u65f6\u5019\u4f1a\u53d1\u73b0\uff0c\u5e76\u53d1\u538b\u6d4b\u7ebf\u7a0b 32 \u5c31\u6bd4\u5355\u7ebf\u7a0b\u65f6\uff0c\u603b\u4f53\u541e\u5410\u91cf\u9ad8\u3002</p> <p>\u800c\u65e5\u5fd7\u5728\u5907\u5e93\u4e0a\u7684\u6267\u884c\uff0c\u5c31\u662f\u56fe\u4e2d\u5907\u5e93\u4e0a <code>sql_thread</code> \u66f4\u65b0\u6570\u636e (DATA) \u7684\u903b\u8f91\u3002\u5982\u679c\u662f\u7528\u5355\u7ebf\u7a0b\u7684\u8bdd\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5907\u5e93\u5e94\u7528\u65e5\u5fd7\u4e0d\u591f\u5feb\uff0c\u9020\u6210\u4e3b\u5907\u5ef6\u8fdf\u3002</p> <p>\u5728\u5b98\u65b9\u7684 5.6 \u7248\u672c\u4e4b\u524d\uff0cMySQL \u53ea\u652f\u6301\u5355\u7ebf\u7a0b\u590d\u5236\uff0c\u7531\u6b64\u5728\u4e3b\u5e93\u5e76\u53d1\u9ad8\u3001TPS \u9ad8\u65f6\u5c31\u4f1a\u51fa\u73b0\u4e25\u91cd\u7684\u4e3b\u5907\u5ef6\u8fdf\u95ee\u9898\u3002</p> <p>\u4ece\u5355\u7ebf\u7a0b\u590d\u5236\u5230\u6700\u65b0\u7248\u672c\u7684\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u4e2d\u95f4\u7684\u6f14\u5316\u7ecf\u5386\u4e86\u597d\u51e0\u4e2a\u7248\u672c\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u8ddf\u4f60\u8bf4\u8bf4 MySQL \u591a\u7ebf\u7a0b\u590d\u5236\u7684\u6f14\u8fdb\u8fc7\u7a0b\u3002</p> <p>\u5176\u5b9e\u8bf4\u5230\u5e95\uff0c\u6240\u6709\u7684\u591a\u7ebf\u7a0b\u590d\u5236\u673a\u5236\uff0c\u90fd\u662f\u8981\u628a\u56fe 1 \u4e2d\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u7684 <code>sql_thread</code>\uff0c\u62c6\u6210\u591a\u4e2a\u7ebf\u7a0b\uff0c\u4e5f\u5c31\u662f\u90fd\u7b26\u5408\u4e0b\u9762\u7684\u8fd9\u4e2a\u6a21\u578b\uff1a</p> <p></p> <p>\u56fe 2 \u591a\u7ebf\u7a0b\u6a21\u578b</p> <p>\u56fe 2 \u4e2d\uff0ccoordinator \u5c31\u662f\u539f\u6765\u7684 <code>sql_thread</code>, \u4e0d\u8fc7\u73b0\u5728\u5b83\u4e0d\u518d\u76f4\u63a5\u66f4\u65b0\u6570\u636e\u4e86\uff0c\u53ea\u8d1f\u8d23\u8bfb\u53d6\u4e2d\u8f6c\u65e5\u5fd7\u548c\u5206\u53d1\u4e8b\u52a1\u3002\u771f\u6b63\u66f4\u65b0\u65e5\u5fd7\u7684\uff0c\u53d8\u6210\u4e86 worker \u7ebf\u7a0b\u3002\u800c work \u7ebf\u7a0b\u7684\u4e2a\u6570\uff0c\u5c31\u662f\u7531\u53c2\u6570 <code>slave_parallel_workers</code> \u51b3\u5b9a\u7684\u3002\u6839\u636e\u6211\u7684\u7ecf\u9a8c\uff0c\u628a\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a 8~16 \u4e4b\u95f4\u6700\u597d\uff0832 \u6838\u7269\u7406\u673a\u7684\u60c5\u51b5\uff09\uff0c\u6bd5\u7adf\u5907\u5e93\u8fd8\u6709\u53ef\u80fd\u8981\u63d0\u4f9b\u8bfb\u67e5\u8be2\uff0c\u4e0d\u80fd\u628a CPU \u90fd\u5403\u5149\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u4f60\u9700\u8981\u5148\u601d\u8003\u4e00\u4e2a\u95ee\u9898\uff1a\u4e8b\u52a1\u80fd\u4e0d\u80fd\u6309\u7167\u8f6e\u8be2\u7684\u65b9\u5f0f\u5206\u53d1\u7ed9\u5404\u4e2a worker\uff0c\u4e5f\u5c31\u662f\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5206\u7ed9 <code>worker_1</code>\uff0c\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u53d1\u7ed9 <code>worker_2</code> \u5462\uff1f</p> <p>\u5176\u5b9e\u662f\u4e0d\u884c\u7684\u3002\u56e0\u4e3a\uff0c\u4e8b\u52a1\u88ab\u5206\u53d1\u7ed9 worker \u4ee5\u540e\uff0c\u4e0d\u540c\u7684 worker \u5c31\u72ec\u7acb\u6267\u884c\u4e86\u3002\u4f46\u662f\uff0c\u7531\u4e8e CPU \u7684\u8c03\u5ea6\u7b56\u7565\uff0c\u5f88\u53ef\u80fd\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u6700\u7ec8\u6bd4\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5148\u6267\u884c\u3002\u800c\u5982\u679c\u8fd9\u65f6\u5019\u521a\u597d\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u66f4\u65b0\u7684\u662f\u540c\u4e00\u884c\uff0c\u4e5f\u5c31\u610f\u5473\u7740\uff0c\u540c\u4e00\u884c\u4e0a\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5728\u4e3b\u5e93\u548c\u5907\u5e93\u4e0a\u7684\u6267\u884c\u987a\u5e8f\u76f8\u53cd\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u8bf7\u4f60\u518d\u8bbe\u60f3\u4e00\u4e0b\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff1a\u540c\u4e00\u4e2a\u4e8b\u52a1\u7684\u591a\u4e2a\u66f4\u65b0\u8bed\u53e5\uff0c\u80fd\u4e0d\u80fd\u5206\u7ed9\u4e0d\u540c\u7684 worker \u6765\u6267\u884c\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u4e5f\u4e0d\u884c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4e00\u4e2a\u4e8b\u52a1\u66f4\u65b0\u4e86\u8868 t1 \u548c\u8868 t2 \u4e2d\u7684\u5404\u4e00\u884c\uff0c\u5982\u679c\u8fd9\u4e24\u6761\u66f4\u65b0\u8bed\u53e5\u88ab\u5206\u5230\u4e0d\u540c worker \u7684\u8bdd\uff0c\u867d\u7136\u6700\u7ec8\u7684\u7ed3\u679c\u662f\u4e3b\u5907\u4e00\u81f4\u7684\uff0c\u4f46\u5982\u679c\u8868 t1 \u6267\u884c\u5b8c\u6210\u7684\u77ac\u95f4\uff0c\u5907\u5e93\u4e0a\u6709\u4e00\u4e2a\u67e5\u8be2\uff0c\u5c31\u4f1a\u770b\u5230\u8fd9\u4e2a\u4e8b\u52a1\u201c\u66f4\u65b0\u4e86\u4e00\u534a\u7684\u7ed3\u679c\u201d\uff0c\u7834\u574f\u4e86\u4e8b\u52a1\u903b\u8f91\u7684\u9694\u79bb\u6027\u3002</p> <p>\u6240\u4ee5\uff0ccoordinator \u5728\u5206\u53d1\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u8fd9\u4e24\u4e2a\u57fa\u672c\u8981\u6c42\uff1a</p> <ol> <li>\u4e0d\u80fd\u9020\u6210\u66f4\u65b0\u8986\u76d6\u3002\u8fd9\u5c31\u8981\u6c42\u66f4\u65b0\u540c\u4e00\u884c\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5fc5\u987b\u88ab\u5206\u53d1\u5230\u540c\u4e00\u4e2a worker \u4e2d\u3002</li> <li>\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e0d\u80fd\u88ab\u62c6\u5f00\uff0c\u5fc5\u987b\u653e\u5230\u540c\u4e00\u4e2a worker \u4e2d\u3002</li> </ol> <p>\u5404\u4e2a\u7248\u672c\u7684\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u90fd\u9075\u5faa\u4e86\u8fd9\u4e24\u6761\u57fa\u672c\u539f\u5219\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u5404\u4e2a\u7248\u672c\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mysql-56","title":"MySQL 5.6 \u7248\u672c\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565","text":"<p>\u5b98\u65b9 MySQL5.6 \u7248\u672c\uff0c\u652f\u6301\u4e86\u5e76\u884c\u590d\u5236\uff0c\u53ea\u662f\u652f\u6301\u7684\u7c92\u5ea6\u662f\u6309\u5e93\u5e76\u884c\u3002\u7406\u89e3\u4e86\u4e0a\u9762\u4ecb\u7ecd\u7684\u6309\u8868\u5206\u53d1\u7b56\u7565\u548c\u6309\u884c\u5206\u53d1\u7b56\u7565\uff0c\u4f60\u5c31\u7406\u89e3\u4e86\uff0c\u7528\u4e8e\u51b3\u5b9a\u5206\u53d1\u7b56\u7565\u7684 hash \u8868\u91cc\uff0ckey \u5c31\u662f\u6570\u636e\u5e93\u540d\u3002</p> <p>\u8fd9\u4e2a\u7b56\u7565\u7684\u5e76\u884c\u6548\u679c\uff0c\u53d6\u51b3\u4e8e\u538b\u529b\u6a21\u578b\u3002\u5982\u679c\u5728\u4e3b\u5e93\u4e0a\u6709\u591a\u4e2a DB\uff0c\u5e76\u4e14\u5404\u4e2a DB \u7684\u538b\u529b\u5747\u8861\uff0c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u7684\u6548\u679c\u4f1a\u5f88\u597d\u3002</p> <p>\u76f8\u6bd4\u4e8e\u6309\u8868\u548c\u6309\u884c\u5206\u53d1\uff0c\u8fd9\u4e2a\u7b56\u7565\u6709\u4e24\u4e2a\u4f18\u52bf\uff1a</p> <ol> <li>\u6784\u9020 hash \u503c\u7684\u65f6\u5019\u5f88\u5feb\uff0c\u53ea\u9700\u8981\u5e93\u540d\uff1b\u800c\u4e14\u4e00\u4e2a\u5b9e\u4f8b\u4e0a DB \u6570\u4e5f\u4e0d\u4f1a\u5f88\u591a\uff0c\u4e0d\u4f1a\u51fa\u73b0\u9700\u8981\u6784\u9020 100 \u4e07\u4e2a\u9879\u8fd9\u79cd\u60c5\u51b5\u3002</li> <li>\u4e0d\u8981\u6c42 binlog \u7684\u683c\u5f0f\u3002\u56e0\u4e3a statement \u683c\u5f0f\u7684 binlog \u4e5f\u53ef\u4ee5\u5f88\u5bb9\u6613\u62ff\u5230\u5e93\u540d\u3002</li> </ol> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u7684\u4e3b\u5e93\u4e0a\u7684\u8868\u90fd\u653e\u5728\u540c\u4e00\u4e2a DB \u91cc\u9762\uff0c\u8fd9\u4e2a\u7b56\u7565\u5c31\u6ca1\u6709\u6548\u679c\u4e86\uff1b\u6216\u8005\u5982\u679c\u4e0d\u540c DB \u7684\u70ed\u70b9\u4e0d\u540c\uff0c\u6bd4\u5982\u4e00\u4e2a\u662f\u4e1a\u52a1\u903b\u8f91\u5e93\uff0c\u4e00\u4e2a\u662f\u7cfb\u7edf\u914d\u7f6e\u5e93\uff0c\u90a3\u4e5f\u8d77\u4e0d\u5230\u5e76\u884c\u7684\u6548\u679c\u3002</p> <p>\u7406\u8bba\u4e0a\u4f60\u53ef\u4ee5\u521b\u5efa\u4e0d\u540c\u7684 DB\uff0c\u628a\u76f8\u540c\u70ed\u5ea6\u7684\u8868\u5747\u5300\u5206\u5230\u8fd9\u4e9b\u4e0d\u540c\u7684 DB \u4e2d\uff0c\u5f3a\u884c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u3002\u4e0d\u8fc7\u636e\u6211\u6240\u77e5\uff0c\u7531\u4e8e\u9700\u8981\u7279\u5730\u79fb\u52a8\u6570\u636e\uff0c\u8fd9\u4e2a\u7b56\u7565\u7528\u5f97\u5e76\u4e0d\u591a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mariadb","title":"MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565","text":"<p>\u5728\u7b2c 23 \u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u7ed9\u4f60\u4ecb\u7ecd\u4e86 redo log \u7ec4\u63d0\u4ea4 (group commit) \u4f18\u5316\uff0c \u800c MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u5229\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u7279\u6027\uff1a</p> <ol> <li>\u80fd\u591f\u5728\u540c\u4e00\u7ec4\u91cc\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u4e00\u5b9a\u4e0d\u4f1a\u4fee\u6539\u540c\u4e00\u884c\uff1b</li> <li>\u4e3b\u5e93\u4e0a\u53ef\u4ee5\u5e76\u884c\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u5907\u5e93\u4e0a\u4e5f\u4e00\u5b9a\u662f\u53ef\u4ee5\u5e76\u884c\u6267\u884c\u7684\u3002</li> </ol> <p>\u5728\u5b9e\u73b0\u4e0a\uff0cMariaDB \u662f\u8fd9\u4e48\u505a\u7684\uff1a</p> <ol> <li>\u5728\u4e00\u7ec4\u91cc\u9762\u4e00\u8d77\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u6709\u4e00\u4e2a\u76f8\u540c\u7684 <code>commit_id</code>\uff0c\u4e0b\u4e00\u7ec4\u5c31\u662f <code>commit_id+1</code>\uff1b</li> <li><code>commit_id</code> \u76f4\u63a5\u5199\u5230 binlog \u91cc\u9762\uff1b</li> <li>\u4f20\u5230\u5907\u5e93\u5e94\u7528\u7684\u65f6\u5019\uff0c\u76f8\u540c <code>commit_id</code> \u7684\u4e8b\u52a1\u5206\u53d1\u5230\u591a\u4e2a worker \u6267\u884c\uff1b</li> <li>\u8fd9\u4e00\u7ec4\u5168\u90e8\u6267\u884c\u5b8c\u6210\u540e\uff0ccoordinator \u518d\u53bb\u53d6\u4e0b\u4e00\u6279\u3002</li> </ol> <p>\u5f53\u65f6\uff0c\u8fd9\u4e2a\u7b56\u7565\u51fa\u6765\u7684\u65f6\u5019\u662f\u76f8\u5f53\u60ca\u8273\u7684\u3002\u56e0\u4e3a\uff0c\u4e4b\u524d\u4e1a\u754c\u7684\u601d\u8def\u90fd\u662f\u5728\u201c\u5206\u6790 binlog\uff0c\u5e76\u62c6\u5206\u5230 worker\u201d\u4e0a\u3002\u800c MariaDB \u7684\u8fd9\u4e2a\u7b56\u7565\uff0c\u76ee\u6807\u662f\u201c\u6a21\u62df\u4e3b\u5e93\u7684\u5e76\u884c\u6a21\u5f0f\u201d\u3002</p> <p>\u4f46\u662f\uff0c\u8fd9\u4e2a\u7b56\u7565\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5b83\u5e76\u6ca1\u6709\u5b9e\u73b0\u201c\u771f\u6b63\u7684\u6a21\u62df\u4e3b\u5e93\u5e76\u53d1\u5ea6\u201d\u8fd9\u4e2a\u76ee\u6807\u3002\u5728\u4e3b\u5e93\u4e0a\uff0c\u4e00\u7ec4\u4e8b\u52a1\u5728 commit \u7684\u65f6\u5019\uff0c\u4e0b\u4e00\u7ec4\u4e8b\u52a1\u662f\u540c\u65f6\u5904\u4e8e\u201c\u6267\u884c\u4e2d\u201d\u72b6\u6001\u7684\u3002</p> <p>\u5982\u56fe 5 \u6240\u793a\uff0c\u5047\u8bbe\u4e86\u4e09\u7ec4\u4e8b\u52a1\u5728\u4e3b\u5e93\u7684\u6267\u884c\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u5728 trx1\u3001trx2 \u548c trx3 \u63d0\u4ea4\u7684\u65f6\u5019\uff0ctrx4\u3001trx5 \u548c trx6 \u662f\u5728\u6267\u884c\u7684\u3002\u8fd9\u6837\uff0c\u5728\u7b2c\u4e00\u7ec4\u4e8b\u52a1\u63d0\u4ea4\u5b8c\u6210\u7684\u65f6\u5019\uff0c\u4e0b\u4e00\u7ec4\u4e8b\u52a1\u5f88\u5feb\u5c31\u4f1a\u8fdb\u5165 commit \u72b6\u6001\u3002</p> <p></p> <p>\u56fe 5 \u4e3b\u5e93\u5e76\u884c\u4e8b\u52a1</p> <p>\u800c\u6309\u7167 MariaDB \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\uff0c\u5907\u5e93\u4e0a\u7684\u6267\u884c\u6548\u679c\u5982\u56fe 6 \u6240\u793a\u3002</p> <p></p> <p>\u56fe 6 MariaDB \u5e76\u884c\u590d\u5236\uff0c\u5907\u5e93\u5e76\u884c\u6548\u679c</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u5907\u5e93\u4e0a\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u7b49\u7b2c\u4e00\u7ec4\u4e8b\u52a1\u5b8c\u5168\u6267\u884c\u5b8c\u6210\u540e\uff0c\u7b2c\u4e8c\u7ec4\u4e8b\u52a1\u624d\u80fd\u5f00\u59cb\u6267\u884c\uff0c\u8fd9\u6837\u7cfb\u7edf\u7684\u541e\u5410\u91cf\u5c31\u4e0d\u591f\u3002</p> <p>\u53e6\u5916\uff0c\u8fd9\u4e2a\u65b9\u6848\u5f88\u5bb9\u6613\u88ab\u5927\u4e8b\u52a1\u62d6\u540e\u817f\u3002\u5047\u8bbe trx2 \u662f\u4e00\u4e2a\u8d85\u5927\u4e8b\u52a1\uff0c\u90a3\u4e48\u5728\u5907\u5e93\u5e94\u7528\u7684\u65f6\u5019\uff0ctrx1 \u548c trx3 \u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c31\u53ea\u80fd\u7b49 trx2 \u5b8c\u5168\u6267\u884c\u5b8c\u6210\uff0c\u4e0b\u4e00\u7ec4\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002\u8fd9\u6bb5\u65f6\u95f4\uff0c\u53ea\u6709\u4e00\u4e2a worker \u7ebf\u7a0b\u5728\u5de5\u4f5c\uff0c\u662f\u5bf9\u8d44\u6e90\u7684\u6d6a\u8d39\u3002</p> <p>\u4e0d\u8fc7\u5373\u4f7f\u5982\u6b64\uff0c\u8fd9\u4e2a\u7b56\u7565\u4ecd\u7136\u662f\u4e00\u4e2a\u5f88\u6f02\u4eae\u7684\u521b\u65b0\u3002\u56e0\u4e3a\uff0c\u5b83\u5bf9\u539f\u7cfb\u7edf\u7684\u6539\u9020\u975e\u5e38\u5c11\uff0c\u5b9e\u73b0\u4e5f\u5f88\u4f18\u96c5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mysql-57","title":"MySQL 5.7 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565","text":"<p>\u5728 MariaDB \u5e76\u884c\u590d\u5236\u5b9e\u73b0\u4e4b\u540e\uff0c\u5b98\u65b9\u7684 MySQL5.7 \u7248\u672c\u4e5f\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u7531\u53c2\u6570 slave-parallel-type \u6765\u63a7\u5236\u5e76\u884c\u590d\u5236\u7b56\u7565\uff1a</p> <ol> <li>\u914d\u7f6e\u4e3a DATABASE\uff0c\u8868\u793a\u4f7f\u7528 MySQL 5.6 \u7248\u672c\u7684\u6309\u5e93\u5e76\u884c\u7b56\u7565\uff1b</li> <li>\u914d\u7f6e\u4e3a <code>LOGICAL_CLOCK</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u7c7b\u4f3c MariaDB \u7684\u7b56\u7565\u3002\u4e0d\u8fc7\uff0cMySQL 5.7 \u8fd9\u4e2a\u7b56\u7565\uff0c\u9488\u5bf9\u5e76\u884c\u5ea6\u505a\u4e86\u4f18\u5316\u3002\u8fd9\u4e2a\u4f18\u5316\u7684\u601d\u8def\u4e5f\u5f88\u6709\u8da3\u513f\u3002</li> </ol> <p>\u4f60\u53ef\u4ee5\u5148\u8003\u8651\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a\u540c\u65f6\u5904\u4e8e\u201c\u6267\u884c\u72b6\u6001\u201d\u7684\u6240\u6709\u4e8b\u52a1\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u5e76\u884c\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u4e0d\u80fd\u3002</p> <p>\u56e0\u4e3a\uff0c\u8fd9\u91cc\u9762\u53ef\u80fd\u6709\u7531\u4e8e\u9501\u51b2\u7a81\u800c\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\u7684\u4e8b\u52a1\u3002\u5982\u679c\u8fd9\u4e9b\u4e8b\u52a1\u5728\u5907\u5e93\u4e0a\u88ab\u5206\u914d\u5230\u4e0d\u540c\u7684 worker\uff0c\u5c31\u4f1a\u51fa\u73b0\u5907\u5e93\u8ddf\u4e3b\u5e93\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>\u800c\u4e0a\u9762\u63d0\u5230\u7684 MariaDB \u8fd9\u4e2a\u7b56\u7565\u7684\u6838\u5fc3\uff0c\u662f\u201c\u6240\u6709\u5904\u4e8e commit\u201d\u72b6\u6001\u7684\u4e8b\u52a1\u53ef\u4ee5\u5e76\u884c\u3002\u4e8b\u52a1\u5904\u4e8e commit \u72b6\u6001\uff0c\u8868\u793a\u5df2\u7ecf\u901a\u8fc7\u4e86\u9501\u51b2\u7a81\u7684\u68c0\u9a8c\u4e86\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u518d\u56de\u987e\u4e00\u4e0b\u4e24\u9636\u6bb5\u63d0\u4ea4\u3002</p> <p>\u5176\u5b9e\uff0c\u4e0d\u7528\u7b49\u5230 commit \u9636\u6bb5\uff0c\u53ea\u8981\u80fd\u591f\u5230\u8fbe redo log prepare \u9636\u6bb5\uff0c\u5c31\u8868\u793a\u4e8b\u52a1\u5df2\u7ecf\u901a\u8fc7\u9501\u51b2\u7a81\u7684\u68c0\u9a8c\u4e86\u3002</p> <p>\u56e0\u6b64\uff0cMySQL 5.7 \u5e76\u884c\u590d\u5236\u7b56\u7565\u7684\u601d\u60f3\u662f\uff1a</p> <ol> <li>\u540c\u65f6\u5904\u4e8e prepare \u72b6\u6001\u7684\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u65f6\u662f\u53ef\u4ee5\u5e76\u884c\u7684\uff1b</li> <li>\u5904\u4e8e prepare \u72b6\u6001\u7684\u4e8b\u52a1\uff0c\u4e0e\u5904\u4e8e commit \u72b6\u6001\u7684\u4e8b\u52a1\u4e4b\u95f4\uff0c\u5728\u5907\u5e93\u6267\u884c\u65f6\u4e5f\u662f\u53ef\u4ee5\u5e76\u884c\u7684\u3002</li> </ol> <p>\u6211\u5728\u7b2c 23 \u7bc7\u6587\u7ae0\uff0c\u8bb2 binlog \u7684\u7ec4\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u4ecb\u7ecd\u8fc7\u4e24\u4e2a\u53c2\u6570\uff1a</p> <ol> <li><code>binlog_group_commit_sync_delay</code> \u53c2\u6570\uff0c\u8868\u793a\u5ef6\u8fdf\u591a\u5c11\u5fae\u79d2\u540e\u624d\u8c03\u7528 fsync;</li> <li><code>binlog_group_commit_sync_no_delay_count</code> \u53c2\u6570\uff0c\u8868\u793a\u7d2f\u79ef\u591a\u5c11\u6b21\u4ee5\u540e\u624d\u8c03\u7528 fsync\u3002</li> </ol> <p>\u8fd9\u4e24\u4e2a\u53c2\u6570\u662f\u7528\u4e8e\u6545\u610f\u62c9\u957f binlog \u4ece write \u5230 fsync \u7684\u65f6\u95f4\uff0c\u4ee5\u6b64\u51cf\u5c11 binlog \u7684\u5199\u76d8\u6b21\u6570\u3002\u5728 MySQL 5.7 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u91cc\uff0c\u5b83\u4eec\u53ef\u4ee5\u7528\u6765\u5236\u9020\u66f4\u591a\u7684\u201c\u540c\u65f6\u5904\u4e8e prepare \u9636\u6bb5\u7684\u4e8b\u52a1\u201d\u3002\u8fd9\u6837\u5c31\u589e\u52a0\u4e86\u5907\u5e93\u590d\u5236\u7684\u5e76\u884c\u5ea6\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u65e2\u53ef\u4ee5\u201c\u6545\u610f\u201d\u8ba9\u4e3b\u5e93\u63d0\u4ea4\u5f97\u6162\u4e9b\uff0c\u53c8\u53ef\u4ee5\u8ba9\u5907\u5e93\u6267\u884c\u5f97\u5feb\u4e9b\u3002\u5728 MySQL 5.7 \u5904\u7406\u5907\u5e93\u5ef6\u8fdf\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u8003\u8651\u8c03\u6574\u8fd9\u4e24\u4e2a\u53c2\u6570\u503c\uff0c\u6765\u8fbe\u5230\u63d0\u5347\u5907\u5e93\u590d\u5236\u5e76\u53d1\u5ea6\u7684\u76ee\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#mysql-5722","title":"MySQL 5.7.22 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565","text":"<p>\u5728 2018 \u5e74 4 \u6708\u4efd\u53d1\u5e03\u7684 MySQL 5.7.22 \u7248\u672c\u91cc\uff0cMySQL \u589e\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\uff0c\u57fa\u4e8e WRITESET \u7684\u5e76\u884c\u590d\u5236\u3002</p> <p>\u76f8\u5e94\u5730\uff0c\u65b0\u589e\u4e86\u4e00\u4e2a\u53c2\u6570 <code>binlog-transaction-dependency-tracking</code>\uff0c\u7528\u6765\u63a7\u5236\u662f\u5426\u542f\u7528\u8fd9\u4e2a\u65b0\u7b56\u7565\u3002\u8fd9\u4e2a\u53c2\u6570\u7684\u53ef\u9009\u503c\u6709\u4ee5\u4e0b\u4e09\u79cd\u3002</p> <ol> <li><code>COMMIT_ORDER</code>\uff0c\u8868\u793a\u7684\u5c31\u662f\u524d\u9762\u4ecb\u7ecd\u7684\uff0c\u6839\u636e\u540c\u65f6\u8fdb\u5165 prepare \u548c commit \u6765\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u5e76\u884c\u7684\u7b56\u7565\u3002</li> <li><code>WRITESET</code>\uff0c\u8868\u793a\u7684\u662f\u5bf9\u4e8e\u4e8b\u52a1\u6d89\u53ca\u66f4\u65b0\u7684\u6bcf\u4e00\u884c\uff0c\u8ba1\u7b97\u51fa\u8fd9\u4e00\u884c\u7684 hash \u503c\uff0c\u7ec4\u6210\u96c6\u5408 writeset\u3002\u5982\u679c\u4e24\u4e2a\u4e8b\u52a1\u6ca1\u6709\u64cd\u4f5c\u76f8\u540c\u7684\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u4eec\u7684 writeset \u6ca1\u6709\u4ea4\u96c6\uff0c\u5c31\u53ef\u4ee5\u5e76\u884c\u3002</li> <li><code>WRITESET_SESSION</code>\uff0c\u662f\u5728 WRITESET \u7684\u57fa\u7840\u4e0a\u591a\u4e86\u4e00\u4e2a\u7ea6\u675f\uff0c\u5373\u5728\u4e3b\u5e93\u4e0a\u540c\u4e00\u4e2a\u7ebf\u7a0b\u5148\u540e\u6267\u884c\u7684\u4e24\u4e2a\u4e8b\u52a1\uff0c\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u4fdd\u8bc1\u76f8\u540c\u7684\u5148\u540e\u987a\u5e8f\u3002</li> </ol> <p>\u5f53\u7136\u4e3a\u4e86\u552f\u4e00\u6807\u8bc6\uff0c\u8fd9\u4e2a hash \u503c\u662f\u901a\u8fc7\u201c\u5e93\u540d + \u8868\u540d + \u7d22\u5f15\u540d + \u503c\u201d\u8ba1\u7b97\u51fa\u6765\u7684\u3002\u5982\u679c\u4e00\u4e2a\u8868\u4e0a\u9664\u4e86\u6709\u4e3b\u952e\u7d22\u5f15\u5916\uff0c\u8fd8\u6709\u5176\u4ed6\u552f\u4e00\u7d22\u5f15\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u4e2a\u552f\u4e00\u7d22\u5f15\uff0cinsert \u8bed\u53e5\u5bf9\u5e94\u7684 writeset \u5c31\u8981\u591a\u589e\u52a0\u4e00\u4e2a hash \u503c\u3002</p> <p>\u4f60\u53ef\u80fd\u770b\u51fa\u6765\u4e86\uff0c\u8fd9\u8ddf\u6211\u4eec\u524d\u9762\u4ecb\u7ecd\u7684\u57fa\u4e8e MySQL 5.5 \u7248\u672c\u7684\u6309\u884c\u5206\u53d1\u7684\u7b56\u7565\u662f\u5dee\u4e0d\u591a\u7684\u3002\u4e0d\u8fc7\uff0cMySQL \u5b98\u65b9\u7684\u8fd9\u4e2a\u5b9e\u73b0\u8fd8\u662f\u6709\u5f88\u5927\u7684\u4f18\u52bf\uff1a</p> <ol> <li>writeset \u662f\u5728\u4e3b\u5e93\u751f\u6210\u540e\u76f4\u63a5\u5199\u5165\u5230 binlog \u91cc\u9762\u7684\uff0c\u8fd9\u6837\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u4e0d\u9700\u8981\u89e3\u6790 binlog \u5185\u5bb9\uff08event \u91cc\u7684\u884c\u6570\u636e\uff09\uff0c\u8282\u7701\u4e86\u5f88\u591a\u8ba1\u7b97\u91cf\uff1b</li> <li>\u4e0d\u9700\u8981\u628a\u6574\u4e2a\u4e8b\u52a1\u7684 binlog \u90fd\u626b\u4e00\u904d\u624d\u80fd\u51b3\u5b9a\u5206\u53d1\u5230\u54ea\u4e2a worker\uff0c\u66f4\u7701\u5185\u5b58\uff1b</li> <li>\u7531\u4e8e\u5907\u5e93\u7684\u5206\u53d1\u7b56\u7565\u4e0d\u4f9d\u8d56\u4e8e binlog \u5185\u5bb9\uff0c\u6240\u4ee5 binlog \u662f statement \u683c\u5f0f\u4e5f\u662f\u53ef\u4ee5\u7684\u3002</li> </ol> <p>\u56e0\u6b64\uff0cMySQL 5.7.22 \u7684\u5e76\u884c\u590d\u5236\u7b56\u7565\u5728\u901a\u7528\u6027\u4e0a\u8fd8\u662f\u6709\u4fdd\u8bc1\u7684\u3002</p> <p>\u5f53\u7136\uff0c\u5bf9\u4e8e\u201c\u8868\u4e0a\u6ca1\u4e3b\u952e\u201d\u548c\u201c\u5916\u952e\u7ea6\u675f\u201d\u7684\u573a\u666f\uff0cWRITESET \u7b56\u7565\u4e5f\u662f\u6ca1\u6cd5\u5e76\u884c\u7684\uff0c\u4e5f\u4f1a\u6682\u65f6\u9000\u5316\u4e3a\u5355\u7ebf\u7a0b\u6a21\u578b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_24","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u5404\u79cd\u591a\u7ebf\u7a0b\u590d\u5236\u7b56\u7565\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8981\u6709\u591a\u7ebf\u7a0b\u590d\u5236\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5355\u7ebf\u7a0b\u590d\u5236\u7684\u80fd\u529b\u5168\u9762\u4f4e\u4e8e\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u8f83\u5927\u7684\u4e3b\u5e93\uff0c\u5907\u5e93\u662f\u53ef\u80fd\u4e00\u76f4\u8ffd\u4e0d\u4e0a\u4e3b\u5e93\u7684\u3002\u4ece\u73b0\u8c61\u4e0a\u770b\u5c31\u662f\uff0c\u5907\u5e93\u4e0a <code>seconds_behind_master</code> \u7684\u503c\u8d8a\u6765\u8d8a\u5927\u3002</p> <p>\u5728\u4ecb\u7ecd\u5b8c\u6bcf\u4e2a\u5e76\u884c\u590d\u5236\u7b56\u7565\u540e\uff0c\u6211\u8fd8\u548c\u4f60\u5206\u4eab\u4e86\u4e0d\u540c\u7b56\u7565\u7684\u4f18\u7f3a\u70b9\uff1a</p> <ul> <li>\u5982\u679c\u4f60\u662f DBA\uff0c\u5c31\u9700\u8981\u6839\u636e\u4e0d\u540c\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u9009\u62e9\u4e0d\u540c\u7684\u7b56\u7565\uff1b</li> <li>\u5982\u679c\u662f\u4f60\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\uff0c\u4e5f\u5e0c\u671b\u4f60\u80fd\u4ece\u4e2d\u83b7\u53d6\u7075\u611f\u7528\u5230\u5e73\u65f6\u7684\u5f00\u53d1\u5de5\u4f5c\u4e2d\u3002</li> </ul> <p>\u4ece\u8fd9\u4e9b\u5206\u6790\u4e2d\uff0c\u4f60\u4e5f\u4f1a\u53d1\u73b0\u5927\u4e8b\u52a1\u4e0d\u4ec5\u4f1a\u5f71\u54cd\u5230\u4e3b\u5e93\uff0c\u4e5f\u662f\u9020\u6210\u5907\u5e93\u590d\u5236\u5ef6\u8fdf\u7684\u4e3b\u8981\u539f\u56e0\u4e4b\u4e00\u3002\u56e0\u6b64\uff0c\u5728\u5e73\u65f6\u7684\u5f00\u53d1\u5de5\u4f5c\u4e2d\uff0c\u6211\u5efa\u8bae\u4f60\u5c3d\u91cf\u51cf\u5c11\u5927\u4e8b\u52a1\u64cd\u4f5c\uff0c\u628a\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</p> <p>\u5b98\u65b9 MySQL5.7 \u7248\u672c\u65b0\u589e\u7684\u5907\u5e93\u5e76\u884c\u7b56\u7565\uff0c\u4fee\u6539\u4e86 binlog \u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8bf4 binlog \u534f\u8bae\u5e76\u4e0d\u662f\u5411\u4e0a\u517c\u5bb9\u7684\uff0c\u5728\u4e3b\u5907\u5207\u6362\u3001\u7248\u672c\u5347\u7ea7\u7684\u65f6\u5019\u9700\u8981\u628a\u8fd9\u4e2a\u56e0\u7d20\u4e5f\u8003\u8651\u8fdb\u53bb\u3002</p> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u4e2a\u601d\u8003\u9898\u5427\u3002</p> <p>\u5047\u8bbe\u4e00\u4e2a MySQL 5.7.22 \u7248\u672c\u7684\u4e3b\u5e93\uff0c\u5355\u7ebf\u7a0b\u63d2\u5165\u4e86\u5f88\u591a\u6570\u636e\uff0c\u8fc7\u4e86 3 \u4e2a\u5c0f\u65f6\u540e\uff0c\u6211\u4eec\u8981\u7ed9\u8fd9\u4e2a\u4e3b\u5e93\u642d\u5efa\u4e00\u4e2a\u76f8\u540c\u7248\u672c\u7684\u5907\u5e93\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u4f60\u4e3a\u4e86\u66f4\u5feb\u5730\u8ba9\u5907\u5e93\u8ffd\u4e0a\u4e3b\u5e93\uff0c\u8981\u5f00\u5e76\u884c\u590d\u5236\u3002\u5728 binlog-transaction-dependency-tracking \u53c2\u6570\u7684 <code>COMMIT_ORDER</code>\u3001<code>WRITESET</code> \u548c <code>WRITE_SESSION</code> \u8fd9\u4e09\u4e2a\u53d6\u503c\u4e2d\uff0c\u4f60\u4f1a\u9009\u62e9\u54ea\u4e00\u4e2a\u5462\uff1f</p> <p>\u4f60\u9009\u62e9\u7684\u539f\u56e0\u662f\u4ec0\u4e48\uff1f\u5982\u679c\u8bbe\u7f6e\u53e6\u5916\u4e24\u4e2a\u53c2\u6570\uff0c\u4f60\u8ba4\u4e3a\u4f1a\u51fa\u73b0\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f</p> <p>\u56de\u7b54\uff1a</p> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u662f\uff0c\u5e94\u8be5\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a WRITESET\u3002</p> <p>\u7531\u4e8e\u4e3b\u5e93\u662f\u5355\u7ebf\u7a0b\u538b\u529b\u6a21\u5f0f\uff0c\u6240\u4ee5\u6bcf\u4e2a\u4e8b\u52a1\u7684 <code>commit_id</code> \u90fd\u4e0d\u540c\uff0c\u90a3\u4e48\u8bbe\u7f6e\u4e3a <code>COMMIT_ORDER</code> \u6a21\u5f0f\u7684\u8bdd\uff0c\u4ece\u5e93\u4e5f\u53ea\u80fd\u5355\u7ebf\u7a0b\u6267\u884c\u3002</p> <p>\u540c\u6837\u5730\uff0c\u7531\u4e8e <code>WRITESET_SESSION</code> \u6a21\u5f0f\u8981\u6c42\u5728\u5907\u5e93\u5e94\u7528\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u540c\u4e00\u4e2a\u7ebf\u7a0b\u7684\u65e5\u5fd7\u5fc5\u987b\u4e0e\u4e3b\u5e93\u4e0a\u6267\u884c\u7684\u5148\u540e\u987a\u5e8f\u76f8\u540c\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u4e3b\u5e93\u5355\u7ebf\u7a0b\u538b\u529b\u6a21\u5f0f\u4e0b\u9000\u5316\u6210\u5355\u7ebf\u7a0b\u590d\u5236\u3002</p> <p>\u6240\u4ee5\uff0c\u5e94\u8be5\u5c06 binlog-transaction-dependency-tracking \u8bbe\u7f6e\u4e3a WRITESET\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#27","title":"27 \u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff0c\u4ece\u5e93\u600e\u4e48\u529e\uff1f","text":"<p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u4ecb\u7ecd\u4e86 MySQL \u4e3b\u5907\u590d\u5236\u7684\u57fa\u7840\u7ed3\u6784\uff0c\u4f46\u8fd9\u4e9b\u90fd\u662f\u4e00\u4e3b\u4e00\u5907\u7684\u7ed3\u6784\u3002</p> <p>\u5927\u591a\u6570\u7684\u4e92\u8054\u7f51\u5e94\u7528\u573a\u666f\u90fd\u662f\u8bfb\u591a\u5199\u5c11\uff0c\u56e0\u6b64\u4f60\u8d1f\u8d23\u7684\u4e1a\u52a1\uff0c\u5728\u53d1\u5c55\u8fc7\u7a0b\u4e2d\u5f88\u53ef\u80fd\u5148\u4f1a\u9047\u5230\u8bfb\u6027\u80fd\u7684\u95ee\u9898\u3002\u800c\u5728\u6570\u636e\u5e93\u5c42\u89e3\u51b3\u8bfb\u6027\u80fd\u95ee\u9898\uff0c\u5c31\u8981\u6d89\u53ca\u5230\u63a5\u4e0b\u6765\u4e24\u7bc7\u6587\u7ae0\u8981\u8ba8\u8bba\u7684\u67b6\u6784\uff1a\u4e00\u4e3b\u591a\u4ece\u3002</p> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u5148\u804a\u804a\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u6b63\u786e\u6027\u3002\u7136\u540e\uff0c\u6211\u4eec\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u518d\u804a\u804a\u89e3\u51b3\u4e00\u4e3b\u591a\u4ece\u7684\u67e5\u8be2\u903b\u8f91\u6b63\u786e\u6027\u7684\u65b9\u6cd5\u3002</p> <p>\u5982\u56fe 1 \u6240\u793a\uff0c\u5c31\u662f\u4e00\u4e2a\u57fa\u672c\u7684\u4e00\u4e3b\u591a\u4ece\u7ed3\u6784\u3002</p> <p></p> <p>\u56fe 1 \u4e00\u4e3b\u591a\u4ece\u57fa\u672c\u7ed3\u6784</p> <p>\u56fe\u4e2d\uff0c\u865a\u7ebf\u7bad\u5934\u8868\u793a\u7684\u662f\u4e3b\u5907\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f A \u548c A\u2019\u4e92\u4e3a\u4e3b\u5907\uff0c \u4ece\u5e93 B\u3001C\u3001D \u6307\u5411\u7684\u662f\u4e3b\u5e93 A\u3002\u4e00\u4e3b\u591a\u4ece\u7684\u8bbe\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u8bfb\u5199\u5206\u79bb\uff0c\u4e3b\u5e93\u8d1f\u8d23\u6240\u6709\u7684\u5199\u5165\u548c\u4e00\u90e8\u5206\u8bfb\uff0c\u5176\u4ed6\u7684\u8bfb\u8bf7\u6c42\u5219\u7531\u4ece\u5e93\u5206\u62c5\u3002</p> <p>\u4eca\u5929\u6211\u4eec\u8981\u8ba8\u8bba\u7684\u5c31\u662f\uff0c\u5728\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u4e0b\uff0c\u4e3b\u5e93\u6545\u969c\u540e\u7684\u4e3b\u5907\u5207\u6362\u95ee\u9898\u3002</p> <p>\u5982\u56fe 2 \u6240\u793a\uff0c\u5c31\u662f\u4e3b\u5e93\u53d1\u751f\u6545\u969c\uff0c\u4e3b\u5907\u5207\u6362\u540e\u7684\u7ed3\u679c\u3002</p> <p></p> <p>\u56fe 2 \u4e00\u4e3b\u591a\u4ece\u57fa\u672c\u7ed3\u6784 -- \u4e3b\u5907\u5207\u6362</p> <p>\u76f8\u6bd4\u4e8e\u4e00\u4e3b\u4e00\u5907\u7684\u5207\u6362\u6d41\u7a0b\uff0c\u4e00\u4e3b\u591a\u4ece\u7ed3\u6784\u5728\u5207\u6362\u5b8c\u6210\u540e\uff0cA\u2019\u4f1a\u6210\u4e3a\u65b0\u7684\u4e3b\u5e93\uff0c\u4ece\u5e93 B\u3001C\u3001D \u4e5f\u8981\u6539\u63a5\u5230 A\u2019\u3002\u6b63\u662f\u7531\u4e8e\u591a\u4e86\u4ece\u5e93 B\u3001C\u3001D \u91cd\u65b0\u6307\u5411\u7684\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6240\u4ee5\u4e3b\u5907\u5207\u6362\u7684\u590d\u6742\u6027\u4e5f\u76f8\u5e94\u589e\u52a0\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u770b\u770b\u4e00\u4e2a\u5207\u6362\u7cfb\u7edf\u4f1a\u600e\u4e48\u5b8c\u6210\u4e00\u4e3b\u591a\u4ece\u7684\u4e3b\u5907\u5207\u6362\u8fc7\u7a0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_25","title":"\u57fa\u4e8e\u4f4d\u70b9\u7684\u4e3b\u5907\u5207\u6362","text":"<p>\u8fd9\u91cc\uff0c\u6211\u4eec\u9700\u8981\u5148\u6765\u56de\u987e\u4e00\u4e2a\u77e5\u8bc6\u70b9\u3002</p> <p>\u5f53\u6211\u4eec\u628a\u8282\u70b9 B \u8bbe\u7f6e\u6210\u8282\u70b9 A\u2019\u7684\u4ece\u5e93\u7684\u65f6\u5019\uff0c\u9700\u8981\u6267\u884c\u4e00\u6761 change master \u547d\u4ee4\uff1a</p> <pre><code>mysql &gt; CHANGE MASTER TO \n  MASTER_HOST=$host_name \n  MASTER_PORT=$port \n  MASTER_USER=$user_name \n  MASTER_PASSWORD=$password \n  MASTER_LOG_FILE=$master_log_name \n  MASTER_LOG_POS=$master_log_pos  \n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u6709\u8fd9\u4e48 6 \u4e2a\u53c2\u6570\uff1a</p> <ul> <li><code>MASTER_HOST</code>\u3001<code>MASTER_PORT</code>\u3001<code>MASTER_USER</code> \u548c <code>MASTER_PASSWORD</code> \u56db\u4e2a\u53c2\u6570\uff0c\u5206\u522b\u4ee3\u8868\u4e86\u4e3b\u5e93 A\u2019\u7684 IP\u3001\u7aef\u53e3\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</li> <li>\u6700\u540e\u4e24\u4e2a\u53c2\u6570 <code>MASTER_LOG_FILE</code> \u548c <code>MASTER_LOG_POS</code> \u8868\u793a\uff0c\u8981\u4ece\u4e3b\u5e93\u7684 <code>master_log_name</code> \u6587\u4ef6\u7684 <code>master_log_pos</code> \u8fd9\u4e2a\u4f4d\u7f6e\u7684\u65e5\u5fd7\u7ee7\u7eed\u540c\u6b65\u3002\u800c\u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u540c\u6b65\u4f4d\u70b9\uff0c\u4e5f\u5c31\u662f\u4e3b\u5e93\u5bf9\u5e94\u7684\u6587\u4ef6\u540d\u548c\u65e5\u5fd7\u504f\u79fb\u91cf\u3002</li> </ul> <p>\u90a3\u4e48\uff0c\u8fd9\u91cc\u5c31\u6709\u4e00\u4e2a\u95ee\u9898\u4e86\uff0c\u8282\u70b9 B \u8981\u8bbe\u7f6e\u6210 A\u2019\u7684\u4ece\u5e93\uff0c\u5c31\u8981\u6267\u884c change master \u547d\u4ee4\uff0c\u5c31\u4e0d\u53ef\u907f\u514d\u5730\u8981\u8bbe\u7f6e\u4f4d\u70b9\u7684\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u4f46\u662f\u8fd9\u4e24\u4e2a\u53c2\u6570\u5230\u5e95\u5e94\u8be5\u600e\u4e48\u8bbe\u7f6e\u5462\uff1f</p> <p>\u539f\u6765\u8282\u70b9 B \u662f A \u7684\u4ece\u5e93\uff0c\u672c\u5730\u8bb0\u5f55\u7684\u4e5f\u662f A \u7684\u4f4d\u70b9\u3002\u4f46\u662f\u76f8\u540c\u7684\u65e5\u5fd7\uff0cA \u7684\u4f4d\u70b9\u548c A\u2019\u7684\u4f4d\u70b9\u662f\u4e0d\u540c\u7684\u3002\u56e0\u6b64\uff0c\u4ece\u5e93 B \u8981\u5207\u6362\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u5148\u7ecf\u8fc7\u201c\u627e\u540c\u6b65\u4f4d\u70b9\u201d\u8fd9\u4e2a\u903b\u8f91\u3002</p> <p>\u8fd9\u4e2a\u4f4d\u70b9\u5f88\u96be\u7cbe\u786e\u53d6\u5230\uff0c\u53ea\u80fd\u53d6\u4e00\u4e2a\u5927\u6982\u4f4d\u7f6e\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p> <p>\u6211\u6765\u548c\u4f60\u5206\u6790\u4e00\u4e0b\u770b\u770b\u8fd9\u4e2a\u4f4d\u70b9\u4e00\u822c\u662f\u600e\u4e48\u83b7\u53d6\u5230\u7684\uff0c\u4f60\u5c31\u6e05\u695a\u5176\u4e2d\u4e0d\u7cbe\u786e\u7684\u539f\u56e0\u4e86\u3002</p> <p>\u8003\u8651\u5230\u5207\u6362\u8fc7\u7a0b\u4e2d\u4e0d\u80fd\u4e22\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u627e\u4f4d\u70b9\u7684\u65f6\u5019\uff0c\u603b\u662f\u8981\u627e\u4e00\u4e2a\u201c\u7a0d\u5fae\u5f80\u524d\u201d\u7684\uff0c\u7136\u540e\u518d\u901a\u8fc7\u5224\u65ad\u8df3\u8fc7\u90a3\u4e9b\u5728\u4ece\u5e93 B \u4e0a\u5df2\u7ecf\u6267\u884c\u8fc7\u7684\u4e8b\u52a1\u3002</p> <p>\u4e00\u79cd\u53d6\u540c\u6b65\u4f4d\u70b9\u7684\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li> <p>\u7b49\u5f85\u65b0\u4e3b\u5e93 A\u2019\u628a\u4e2d\u8f6c\u65e5\u5fd7\uff08relay log\uff09\u5168\u90e8\u540c\u6b65\u5b8c\u6210\uff1b</p> </li> <li> <p>\u5728 A\u2019\u4e0a\u6267\u884c <code>show master status</code> \u547d\u4ee4\uff0c\u5f97\u5230\u5f53\u524d A\u2019\u4e0a\u6700\u65b0\u7684 File \u548c Position\uff1b</p> </li> <li> <p>\u53d6\u539f\u4e3b\u5e93 A \u6545\u969c\u7684\u65f6\u523b T\uff1b</p> </li> <li> <p>\u7528 mysqlbinlog \u5de5\u5177\u89e3\u6790 A\u2019\u7684 File\uff0c\u5f97\u5230 T \u65f6\u523b\u7684\u4f4d\u70b9\u3002</p> <pre><code>$ mysqlbinlog  binlog.000079 --start-datetime='2023-02-01 16:41:36' --stop-datetime='2023-02-01 16:41:36'\n\n/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;\n/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;\nDELIMITER /*!*/;\n# at 4\n#230131 14:56:46 server id 1  end_log_pos 124 CRC32 0x76c363e1  Start: binlog v 4, server v 8.0.18 created 230131 14:56:46 at startup\n</code></pre> </li> </ol> <p>\u56fe\u4e2d\uff0c<code>end_log_pos</code> \u540e\u9762\u7684\u503c 124\uff0c\u8868\u793a\u7684\u5c31\u662f A\u2019 \u8fd9\u4e2a\u5b9e\u4f8b\uff0c\u5728 T \u65f6\u523b\u5199\u5165\u65b0\u7684 binlog \u7684\u4f4d\u7f6e\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u628a 123 \u8fd9\u4e2a\u503c\u4f5c\u4e3a <code>$master_log_pos</code> \uff0c\u7528\u5728\u8282\u70b9 B \u7684 change master \u547d\u4ee4\u91cc\u3002</p> <p>\u5f53\u7136\u8fd9\u4e2a\u503c\u5e76\u4e0d\u7cbe\u786e\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u6709\u8fd9\u4e48\u4e00\u79cd\u60c5\u51b5\uff0c\u5047\u8bbe\u5728 T \u8fd9\u4e2a\u65f6\u523b\uff0c\u4e3b\u5e93 A \u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u4e86\u4e00\u4e2a insert \u8bed\u53e5\u63d2\u5165\u4e86\u4e00\u884c\u6570\u636e R\uff0c\u5e76\u4e14\u5df2\u7ecf\u5c06 binlog \u4f20\u7ed9\u4e86 A\u2019\u548c B\uff0c\u7136\u540e\u5728\u4f20\u5b8c\u7684\u77ac\u95f4\u4e3b\u5e93 A \u7684\u4e3b\u673a\u5c31\u6389\u7535\u4e86\u3002</p> <p>\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7cfb\u7edf\u7684\u72b6\u6001\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5728\u4ece\u5e93 B \u4e0a\uff0c\u7531\u4e8e\u540c\u6b65\u4e86 binlog\uff0c R \u8fd9\u4e00\u884c\u5df2\u7ecf\u5b58\u5728\uff1b</li> <li>\u5728\u65b0\u4e3b\u5e93 A\u2019\u4e0a\uff0c R \u8fd9\u4e00\u884c\u4e5f\u5df2\u7ecf\u5b58\u5728\uff0c\u65e5\u5fd7\u662f\u5199\u5728 123 \u8fd9\u4e2a\u4f4d\u7f6e\u4e4b\u540e\u7684\uff1b</li> <li>\u6211\u4eec\u5728\u4ece\u5e93 B \u4e0a\u6267\u884c change master \u547d\u4ee4\uff0c\u6307\u5411 A\u2019\u7684 File \u6587\u4ef6\u7684 123 \u4f4d\u7f6e\uff0c\u5c31\u4f1a\u628a\u63d2\u5165 R \u8fd9\u4e00\u884c\u6570\u636e\u7684 binlog \u53c8\u540c\u6b65\u5230\u4ece\u5e93 B \u53bb\u6267\u884c\u3002</li> </ol> <p>\u8fd9\u65f6\u5019\uff0c\u4ece\u5e93 B \u7684\u540c\u6b65\u7ebf\u7a0b\u5c31\u4f1a\u62a5\u544a <code>Duplicate entry \u2018id_of_R\u2019 for key \u2018PRIMARY\u2019</code> \u9519\u8bef\uff0c\u63d0\u793a\u51fa\u73b0\u4e86\u4e3b\u952e\u51b2\u7a81\uff0c\u7136\u540e\u505c\u6b62\u540c\u6b65\u3002</p> <p>\u6240\u4ee5\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5728\u5207\u6362\u4efb\u52a1\u7684\u65f6\u5019\uff0c\u8981\u5148\u4e3b\u52a8\u8df3\u8fc7\u8fd9\u4e9b\u9519\u8bef\uff0c\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u6cd5\u3002</p> <p>\u4e00\u79cd\u505a\u6cd5\u662f\uff0c\u4e3b\u52a8\u8df3\u8fc7\u4e00\u4e2a\u4e8b\u52a1\u3002\u8df3\u8fc7\u547d\u4ee4\u7684\u5199\u6cd5\u662f\uff1a</p> <pre><code>mysql&gt; set global sql_slave_skip_counter=1;\nmysql&gt; start slave;\n</code></pre> <p>\u56e0\u4e3a\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u4f1a\u4e0d\u6b62\u91cd\u590d\u6267\u884c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728\u4ece\u5e93 B \u521a\u5f00\u59cb\u63a5\u5230\u65b0\u4e3b\u5e93 A\u2019\u65f6\uff0c\u6301\u7eed\u89c2\u5bdf\uff0c\u6bcf\u6b21\u78b0\u5230\u8fd9\u4e9b\u9519\u8bef\u5c31\u505c\u4e0b\u6765\uff0c\u6267\u884c\u4e00\u6b21\u8df3\u8fc7\u547d\u4ee4\uff0c\u76f4\u5230\u4e0d\u518d\u51fa\u73b0\u505c\u4e0b\u6765\u7684\u60c5\u51b5\uff0c\u4ee5\u6b64\u6765\u8df3\u8fc7\u53ef\u80fd\u6d89\u53ca\u7684\u6240\u6709\u4e8b\u52a1\u3002</p> <p>**\u53e6\u5916\u4e00\u79cd\u65b9\u5f0f\u662f\uff0c**\u901a\u8fc7\u8bbe\u7f6e <code>slave_skip_errors</code> \u53c2\u6570\uff0c\u76f4\u63a5\u8bbe\u7f6e\u8df3\u8fc7\u6307\u5b9a\u7684\u9519\u8bef\u3002</p> <p>\u5728\u6267\u884c\u4e3b\u5907\u5207\u6362\u65f6\uff0c\u6709\u8fd9\u4e48\u4e24\u7c7b\u9519\u8bef\uff0c\u662f\u7ecf\u5e38\u4f1a\u9047\u5230\u7684\uff1a</p> <ul> <li>1062 \u9519\u8bef\u662f\u63d2\u5165\u6570\u636e\u65f6\u552f\u4e00\u952e\u51b2\u7a81\uff1b</li> <li>1032 \u9519\u8bef\u662f\u5220\u9664\u6570\u636e\u65f6\u627e\u4e0d\u5230\u884c\u3002</li> </ul> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u628a <code>slave_skip_errors</code> \u8bbe\u7f6e\u4e3a <code>1032,1062</code>\uff0c\u8fd9\u6837\u4e2d\u95f4\u78b0\u5230\u8fd9\u4e24\u4e2a\u9519\u8bef\u65f6\u5c31\u76f4\u63a5\u8df3\u8fc7\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u79cd\u76f4\u63a5\u8df3\u8fc7\u6307\u5b9a\u9519\u8bef\u7684\u65b9\u6cd5\uff0c\u9488\u5bf9\u7684\u662f\u4e3b\u5907\u5207\u6362\u65f6\uff0c\u7531\u4e8e\u627e\u4e0d\u5230\u7cbe\u786e\u7684\u540c\u6b65\u4f4d\u70b9\uff0c\u6240\u4ee5\u53ea\u80fd\u91c7\u7528\u8fd9\u79cd\u65b9\u6cd5\u6765\u521b\u5efa\u4ece\u5e93\u548c\u65b0\u4e3b\u5e93\u7684\u4e3b\u5907\u5173\u7cfb\u3002</p> <p>\u8fd9\u4e2a\u80cc\u666f\u662f\uff0c\u6211\u4eec\u5f88\u6e05\u695a\u5728\u4e3b\u5907\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u76f4\u63a5\u8df3\u8fc7 1032 \u548c 1062 \u8fd9\u4e24\u7c7b\u9519\u8bef\u662f\u65e0\u635f\u7684\uff0c\u6240\u4ee5\u624d\u53ef\u4ee5\u8fd9\u4e48\u8bbe\u7f6e <code>slave_skip_errors</code> \u53c2\u6570\u3002\u7b49\u5230\u4e3b\u5907\u95f4\u7684\u540c\u6b65\u5173\u7cfb\u5efa\u7acb\u5b8c\u6210\uff0c\u5e76\u7a33\u5b9a\u6267\u884c\u4e00\u6bb5\u65f6\u95f4\u4e4b\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u628a\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a\u7a7a\uff0c\u4ee5\u514d\u4e4b\u540e\u771f\u7684\u51fa\u73b0\u4e86\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e5f\u8df3\u8fc7\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#gtid","title":"GTID","text":"<p>\u901a\u8fc7 <code>sql_slave_skip_counter</code> \u8df3\u8fc7\u4e8b\u52a1\u548c\u901a\u8fc7 <code>slave_skip_errors</code> \u5ffd\u7565\u9519\u8bef\u7684\u65b9\u6cd5\uff0c\u867d\u7136\u90fd\u6700\u7ec8\u53ef\u4ee5\u5efa\u7acb\u4ece\u5e93 B \u548c\u65b0\u4e3b\u5e93 A\u2019\u7684\u4e3b\u5907\u5173\u7cfb\uff0c\u4f46\u8fd9\u4e24\u79cd\u64cd\u4f5c\u90fd\u5f88\u590d\u6742\uff0c\u800c\u4e14\u5bb9\u6613\u51fa\u9519\u3002\u6240\u4ee5\uff0cMySQL 5.6 \u7248\u672c\u5f15\u5165\u4e86 GTID\uff0c\u5f7b\u5e95\u89e3\u51b3\u4e86\u8fd9\u4e2a\u56f0\u96be\u3002</p> <p>\u90a3\u4e48\uff0cGTID \u5230\u5e95\u662f\u4ec0\u4e48\u610f\u601d\uff0c\u53c8\u662f\u5982\u4f55\u89e3\u51b3\u627e\u540c\u6b65\u4f4d\u70b9\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f\u73b0\u5728\uff0c\u6211\u5c31\u548c\u4f60\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u3002</p> <p>GTID \u7684\u5168\u79f0\u662f Global Transaction Identifier\uff0c\u4e5f\u5c31\u662f\u5168\u5c40\u4e8b\u52a1 ID\uff0c\u662f\u4e00\u4e2a\u4e8b\u52a1\u5728\u63d0\u4ea4\u7684\u65f6\u5019\u751f\u6210\u7684\uff0c\u662f\u8fd9\u4e2a\u4e8b\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u3002\u5b83\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff0c\u683c\u5f0f\u662f\uff1a</p> <pre><code>GTID=server_uuid:gno\n</code></pre> <p>\u5176\u4e2d\uff1a</p> <ul> <li><code>server_uuid</code> \u662f\u4e00\u4e2a\u5b9e\u4f8b\u7b2c\u4e00\u6b21\u542f\u52a8\u65f6\u81ea\u52a8\u751f\u6210\u7684\uff0c\u662f\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684\u503c\uff1b</li> <li>gno \u662f\u4e00\u4e2a\u6574\u6570\uff0c\u521d\u59cb\u503c\u662f 1\uff0c\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u7684\u65f6\u5019\u5206\u914d\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u5e76\u52a0 1\u3002</li> </ul> <p>\u8fd9\u91cc\u6211\u9700\u8981\u548c\u4f60\u8bf4\u660e\u4e00\u4e0b\uff0c\u5728 MySQL \u7684\u5b98\u65b9\u6587\u6863\u91cc\uff0cGTID \u683c\u5f0f\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a</p> <pre><code>GTID=source_id:transaction_id\n</code></pre> <p>\u8fd9\u91cc\u7684 source_id \u5c31\u662f <code>server_uuid</code>\uff1b\u800c\u540e\u9762\u7684\u8fd9\u4e2a <code>transaction_id</code>\uff0c\u6211\u89c9\u5f97\u5bb9\u6613\u9020\u6210\u8bef\u5bfc\uff0c\u6240\u4ee5\u6211\u6539\u6210\u4e86 gno\u3002\u4e3a\u4ec0\u4e48\u8bf4\u4f7f\u7528 <code>transaction_id</code> \u5bb9\u6613\u9020\u6210\u8bef\u89e3\u5462\uff1f</p> <p>\u56e0\u4e3a\uff0c\u5728 MySQL \u91cc\u9762\u6211\u4eec\u8bf4 <code>transaction_id</code> \u5c31\u662f\u6307\u4e8b\u52a1 id\uff0c\u4e8b\u52a1 id \u662f\u5728\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u5206\u914d\u7684\uff0c\u5982\u679c\u8fd9\u4e2a\u4e8b\u52a1\u56de\u6eda\u4e86\uff0c\u4e8b\u52a1 id \u4e5f\u4f1a\u9012\u589e\uff0c\u800c gno \u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u624d\u4f1a\u5206\u914d\u3002</p> <p>\u4ece\u6548\u679c\u4e0a\u770b\uff0cGTID \u5f80\u5f80\u662f\u8fde\u7eed\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u7528 gno \u6765\u8868\u793a\u66f4\u5bb9\u6613\u7406\u89e3\u3002</p> <p>GTID \u6a21\u5f0f\u7684\u542f\u52a8\u4e5f\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u542f\u52a8\u4e00\u4e2a MySQL \u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u52a0\u4e0a\u53c2\u6570 <code>gtid_mode=on</code> \u548c <code>enforce_gtid_consistency=on</code> \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u90fd\u4f1a\u8ddf\u4e00\u4e2a GTID \u4e00\u4e00\u5bf9\u5e94\u3002\u8fd9\u4e2a GTID \u6709\u4e24\u79cd\u751f\u6210\u65b9\u5f0f\uff0c\u800c\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\u53d6\u51b3\u4e8e session \u53d8\u91cf <code>gtid_next</code> \u7684\u503c\u3002</p> <ol> <li>\u5982\u679c <code>gtid_next=automatic</code>\uff0c\u4ee3\u8868\u4f7f\u7528\u9ed8\u8ba4\u503c\u3002\u8fd9\u65f6\uff0cMySQL \u5c31\u4f1a\u628a <code>server_uuid:gno</code> \u5206\u914d\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\u3002</li> <li>\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u5148\u8bb0\u5f55\u4e00\u884c <code>SET @@SESSION.GTID_NEXT=\u2018server_uuid:gno\u2019;</code> </li> <li> <p>\u628a\u8fd9\u4e2a GTID \u52a0\u5165\u672c\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u3002</p> </li> <li> <p>\u5982\u679c <code>gtid_next</code> \u662f\u4e00\u4e2a\u6307\u5b9a\u7684 GTID \u7684\u503c\uff0c\u6bd4\u5982\u901a\u8fc7 <code>set gtid_next='current_gtid'</code>\u6307\u5b9a\u4e3a <code>current_gtid</code>\uff0c\u90a3\u4e48\u5c31\u6709\u4e24\u79cd\u53ef\u80fd\uff1a </p> </li> <li>\u5982\u679c <code>current_gtid</code> \u5df2\u7ecf\u5b58\u5728\u4e8e\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u4e2d\uff0c\u63a5\u4e0b\u6765\u6267\u884c\u7684\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u76f4\u63a5\u88ab\u7cfb\u7edf\u5ffd\u7565\uff1b </li> <li>\u5982\u679c <code>current_gtid</code> \u6ca1\u6709\u5b58\u5728\u4e8e\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\u4e2d\uff0c\u5c31\u5c06\u8fd9\u4e2a <code>current_gtid</code> \u5206\u914d\u7ed9\u63a5\u4e0b\u6765\u8981\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u4e5f\u5c31\u662f\u8bf4\u7cfb\u7edf\u4e0d\u9700\u8981\u7ed9\u8fd9\u4e2a\u4e8b\u52a1\u751f\u6210\u65b0\u7684 GTID\uff0c\u56e0\u6b64 gno \u4e5f\u4e0d\u7528\u52a0 1\u3002</li> </ol> <p>\u6ce8\u610f\uff0c\u4e00\u4e2a <code>current_gtid</code> \u53ea\u80fd\u7ed9\u4e00\u4e2a\u4e8b\u52a1\u4f7f\u7528\u3002\u8fd9\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u5982\u679c\u8981\u6267\u884c\u4e0b\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5c31\u8981\u6267\u884c set \u547d\u4ee4\uff0c\u628a <code>gtid_next</code> \u8bbe\u7f6e\u6210\u53e6\u5916\u4e00\u4e2a gtid \u6216\u8005 automatic\u3002</p> <p>\u8fd9\u6837\uff0c\u6bcf\u4e2a MySQL \u5b9e\u4f8b\u90fd\u7ef4\u62a4\u4e86\u4e00\u4e2a GTID \u96c6\u5408\uff0c\u7528\u6765\u5bf9\u5e94\u201c\u8fd9\u4e2a\u5b9e\u4f8b\u6267\u884c\u8fc7\u7684\u6240\u6709\u4e8b\u52a1\u201d\u3002</p> <p>\u8fd9\u6837\u770b\u4e0a\u53bb\u4e0d\u592a\u5bb9\u6613\u7406\u89e3\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6765\u548c\u4f60\u8bf4\u660e GTID \u7684\u57fa\u672c\u7528\u6cd5\u3002</p> <p>\u6211\u4eec\u5728\u5b9e\u4f8b X \u4e2d\u521b\u5efa\u4e00\u4e2a\u8868 t\u3002</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \ninsert into t values(1,1);\n</code></pre> <pre><code>mysql&gt; show binlog events in 'binlog.000082' from 155;\n+---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n| Log_name      | Pos | Event_type | Server_id | End_log_pos | Info                                                                                                                                      |\n+---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n| binlog.000082 | 155 | Gtid       |         1 |         232 | SET @@SESSION.GTID_NEXT= 'faddd5d4-9259-11e9-8971-868e345923a2:1'                                                                         |\n| binlog.000082 | 232 | Query      |         1 |         358 | use `test`; DROP TABLE `t` /* generated by server */ /* xid=630565 */                                                                     |\n| binlog.000082 | 358 | Gtid       |         1 |         437 | SET @@SESSION.GTID_NEXT= 'faddd5d4-9259-11e9-8971-868e345923a2:2'                                                                         |\n| binlog.000082 | 437 | Query      |         1 |         633 | use `test`; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB /* xid=630566 */ |\n| binlog.000082 | 633 | Gtid       |         1 |         712 | SET @@SESSION.GTID_NEXT= 'faddd5d4-9259-11e9-8971-868e345923a2:3'                                                                         |\n| binlog.000082 | 712 | Query      |         1 |         794 | BEGIN                                                                                                                                     |\n| binlog.000082 | 794 | Query      |         1 |         896 | use `test`; insert into t values(1,1)                                                                                                     |\n| binlog.000082 | 896 | Xid        |         1 |         927 | COMMIT /* xid=630567 */                                                                                                                   |\n+---------------+-----+------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n8 rows in set (0.00 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e8b\u52a1\u7684 BEGIN \u4e4b\u524d\u6709\u4e00\u6761 <code>SET @@SESSION.GTID_NEXT</code> \u547d\u4ee4\u3002\u8fd9\u65f6\uff0c\u5982\u679c\u5b9e\u4f8b  \u6709\u4ece\u5e93\uff0c\u90a3\u4e48\u5c06 CREATE TABLE \u548c insert \u8bed\u53e5\u7684 binlog \u540c\u6b65\u8fc7\u53bb\u6267\u884c\u7684\u8bdd\uff0c\u6267\u884c\u4e8b\u52a1\u4e4b\u524d\u5c31\u4f1a\u5148\u6267\u884c\u8fd9\u4e24\u4e2a SET \u547d\u4ee4\uff0c \u8fd9\u6837\u88ab\u52a0\u5165\u4ece\u5e93\u7684 GTID \u96c6\u5408\u7684\uff0c\u5c31\u662f\u56fe\u4e2d\u7684\u8fd9\u4e24\u4e2a GTID\u3002</p> <p>\u5047\u8bbe\uff0c\u73b0\u5728\u8fd9\u4e2a\u5b9e\u4f8b X \u662f\u53e6\u5916\u4e00\u4e2a\u5b9e\u4f8b Y \u7684\u4ece\u5e93\uff0c\u5e76\u4e14\u6b64\u65f6\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c\u4e86\u4e0b\u9762\u8fd9\u6761\u63d2\u5165\u8bed\u53e5\uff1a</p> <pre><code>insert into t values(1,1);\n</code></pre> <p>\u5e76\u4e14\uff0c\u8fd9\u6761\u8bed\u53e5\u5728\u5b9e\u4f8b Y \u4e0a\u7684 GTID \u662f <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code></p> <p>\u90a3\u4e48\uff0c\u5b9e\u4f8b X \u4f5c\u4e3a Y \u7684\u4ece\u5e93\uff0c\u5c31\u8981\u540c\u6b65\u8fd9\u4e2a\u4e8b\u52a1\u8fc7\u6765\u6267\u884c\uff0c\u663e\u7136\u4f1a\u51fa\u73b0\u4e3b\u952e\u51b2\u7a81\uff0c\u5bfc\u81f4\u5b9e\u4f8b X \u7684\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5e94\u8be5\u600e\u4e48\u5904\u7406\u5462\uff1f</p> <p>\u5904\u7406\u65b9\u6cd5\u5c31\u662f\uff0c\u4f60\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p> <pre><code>set gtid_next='aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10';\nbegin;\ncommit;\nset gtid_next=automatic;\nstart slave;\n</code></pre> <p>\u5176\u4e2d\uff0c\u524d\u4e09\u6761\u8bed\u53e5\u7684\u4f5c\u7528\uff0c\u662f\u901a\u8fc7\u63d0\u4ea4\u4e00\u4e2a\u7a7a\u4e8b\u52a1\uff0c\u628a\u8fd9\u4e2a GTID \u52a0\u5230\u5b9e\u4f8b X \u7684 GTID \u96c6\u5408\u4e2d\u3002\u5982\u56fe 5 \u6240\u793a\uff0c\u5c31\u662f\u6267\u884c\u5b8c\u8fd9\u4e2a\u7a7a\u4e8b\u52a1\u4e4b\u540e\u7684 <code>show master status</code> \u7684\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; show master status \\G;\n*************************** 1. row ***************************\n             File: binlog.000082\n         Position: 927\n     Binlog_Do_DB:\n Binlog_Ignore_DB:\nExecuted_Gtid_Set: faddd5d4-9259-11e9-8971-868e345923a2:1-3,aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10\n1 row in set (0.00 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5b9e\u4f8b X \u7684 <code>Executed_Gtid_set</code> \u91cc\u9762\uff0c\u5df2\u7ecf\u52a0\u5165\u4e86\u8fd9\u4e2a GTID\u3002</p> <p>\u8fd9\u6837\uff0c\u6211\u518d\u6267\u884c start slave \u547d\u4ee4\u8ba9\u540c\u6b65\u7ebf\u7a0b\u6267\u884c\u8d77\u6765\u7684\u65f6\u5019\uff0c\u867d\u7136\u5b9e\u4f8b X \u4e0a\u8fd8\u662f\u4f1a\u7ee7\u7eed\u6267\u884c\u5b9e\u4f8b Y \u4f20\u8fc7\u6765\u7684\u4e8b\u52a1\uff0c\u4f46\u662f\u7531\u4e8e <code>aaaaaaaa-cccc-dddd-eeee-ffffffffffff:10</code> \u5df2\u7ecf\u5b58\u5728\u4e8e\u5b9e\u4f8b X \u7684 GTID \u96c6\u5408\u4e2d\u4e86\uff0c\u6240\u4ee5\u5b9e\u4f8b X \u5c31\u4f1a\u76f4\u63a5\u8df3\u8fc7\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u518d\u51fa\u73b0\u4e3b\u952e\u51b2\u7a81\u7684\u9519\u8bef\u3002</p> <p>\u5728\u4e0a\u9762\u7684\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\u4e2d\uff0cstart slave \u547d\u4ee4\u4e4b\u524d\u8fd8\u6709\u4e00\u53e5 <code>set gtid_next=automatic</code>\u3002\u8fd9\u53e5\u8bdd\u7684\u4f5c\u7528\u662f\u201c\u6062\u590d GTID \u7684\u9ed8\u8ba4\u5206\u914d\u884c\u4e3a\u201d\uff0c\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u4e4b\u540e\u6709\u65b0\u7684\u4e8b\u52a1\u518d\u6267\u884c\uff0c\u5c31\u8fd8\u662f\u6309\u7167\u539f\u6765\u7684\u5206\u914d\u65b9\u5f0f\uff0c\u7ee7\u7eed\u5206\u914d gno=3\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#gtid_1","title":"\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u5207\u6362","text":"<p>\u73b0\u5728\uff0c\u6211\u4eec\u5df2\u7ecf\u7406\u89e3 GTID \u7684\u6982\u5ff5\uff0c\u518d\u4e00\u8d77\u6765\u770b\u770b\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u590d\u5236\u7684\u7528\u6cd5\u3002</p> <p>\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u5907\u5e93 B \u8981\u8bbe\u7f6e\u4e3a\u65b0\u4e3b\u5e93 A\u2019\u7684\u4ece\u5e93\u7684\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>CHANGE MASTER TO \nMASTER_HOST=$host_name \nMASTER_PORT=$port \nMASTER_USER=$user_name \nMASTER_PASSWORD=$password \nmaster_auto_position=1\n</code></pre> <p>\u5176\u4e2d\uff0c<code>master_auto_position=1</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u4e3b\u5907\u5173\u7cfb\u4f7f\u7528\u7684\u662f GTID \u534f\u8bae\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u524d\u9762\u8ba9\u6211\u4eec\u5934\u75bc\u4e0d\u5df2\u7684 <code>MASTER_LOG_FILE</code> \u548c <code>MASTER_LOG_POS</code> \u53c2\u6570\uff0c\u5df2\u7ecf\u4e0d\u9700\u8981\u6307\u5b9a\u4e86\u3002</p> <p>\u6211\u4eec\u628a\u73b0\u5728\u8fd9\u4e2a\u65f6\u523b\uff0c\u5b9e\u4f8b A\u2019\u7684 GTID \u96c6\u5408\u8bb0\u4e3a <code>set_a</code>\uff0c\u5b9e\u4f8b B \u7684 GTID \u96c6\u5408\u8bb0\u4e3a <code>set_b</code>\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u73b0\u5728\u7684\u4e3b\u5907\u5207\u6362\u903b\u8f91\u3002</p> <p>\u6211\u4eec\u5728\u5b9e\u4f8b B \u4e0a\u6267\u884c start slave \u547d\u4ee4\uff0c\u53d6 binlog \u7684\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5b9e\u4f8b B \u6307\u5b9a\u4e3b\u5e93 A\u2019\uff0c\u57fa\u4e8e\u4e3b\u5907\u534f\u8bae\u5efa\u7acb\u8fde\u63a5\u3002</li> <li>\u5b9e\u4f8b B \u628a <code>set_b</code> \u53d1\u7ed9\u4e3b\u5e93 A\u2019\u3002</li> <li>\u5b9e\u4f8b A\u2019\u7b97\u51fa <code>set_a</code> \u4e0e <code>set_b</code> \u7684\u5dee\u96c6\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u5b58\u5728\u4e8e <code>set_a</code>\uff0c\u4f46\u662f\u4e0d\u5b58\u5728\u4e8e <code>set_b</code> \u7684 GITD \u7684\u96c6\u5408\uff0c\u5224\u65ad A\u2019 \u672c\u5730\u662f\u5426\u5305\u542b\u4e86\u8fd9\u4e2a\u5dee\u96c6\u9700\u8981\u7684\u6240\u6709 binlog \u4e8b\u52a1\u3002 </li> <li>\u5982\u679c\u4e0d\u5305\u542b\uff0c\u8868\u793a A\u2019 \u5df2\u7ecf\u628a\u5b9e\u4f8b B \u9700\u8981\u7684 binlog \u7ed9\u5220\u6389\u4e86\uff0c\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\uff1b</li> <li> <p>\u5982\u679c\u786e\u8ba4\u5168\u90e8\u5305\u542b\uff0cA\u2019 \u4ece\u81ea\u5df1\u7684 binlog \u6587\u4ef6\u91cc\u9762\uff0c\u627e\u51fa\u7b2c\u4e00\u4e2a\u4e0d\u5728 <code>set_b</code> \u7684\u4e8b\u52a1\uff0c\u53d1\u7ed9 B\uff1b</p> </li> <li> <p>\u4e4b\u540e\u5c31\u4ece\u8fd9\u4e2a\u4e8b\u52a1\u5f00\u59cb\uff0c\u5f80\u540e\u8bfb\u6587\u4ef6\uff0c\u6309\u987a\u5e8f\u53d6 binlog \u53d1\u7ed9 B \u53bb\u6267\u884c\u3002</p> </li> </ol> <p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u903b\u8f91\u91cc\u9762\u5305\u542b\u4e86\u4e00\u4e2a\u8bbe\u8ba1\u601d\u60f3\uff1a\u5728\u57fa\u4e8e GTID \u7684\u4e3b\u5907\u5173\u7cfb\u91cc\uff0c\u7cfb\u7edf\u8ba4\u4e3a\u53ea\u8981\u5efa\u7acb\u4e3b\u5907\u5173\u7cfb\uff0c\u5c31\u5fc5\u987b\u4fdd\u8bc1\u4e3b\u5e93\u53d1\u7ed9\u5907\u5e93\u7684\u65e5\u5fd7\u662f\u5b8c\u6574\u7684\u3002\u56e0\u6b64\uff0c\u5982\u679c\u5b9e\u4f8b B \u9700\u8981\u7684\u65e5\u5fd7\u5df2\u7ecf\u4e0d\u5b58\u5728\uff0cA\u2019 \u5c31\u62d2\u7edd\u628a\u65e5\u5fd7\u53d1\u7ed9 B\u3002</p> <p>\u8fd9\u8ddf\u57fa\u4e8e\u4f4d\u70b9\u7684\u4e3b\u5907\u534f\u8bae\u4e0d\u540c\u3002\u57fa\u4e8e\u4f4d\u70b9\u7684\u534f\u8bae\uff0c\u662f\u7531\u5907\u5e93\u51b3\u5b9a\u7684\uff0c\u5907\u5e93\u6307\u5b9a\u54ea\u4e2a\u4f4d\u70b9\uff0c\u4e3b\u5e93\u5c31\u53d1\u54ea\u4e2a\u4f4d\u70b9\uff0c\u4e0d\u505a\u65e5\u5fd7\u7684\u5b8c\u6574\u6027\u5224\u65ad\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u5f15\u5165 GTID \u540e\uff0c\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u573a\u666f\u4e0b\uff0c\u4e3b\u5907\u5207\u6362\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002</p> <p>\u7531\u4e8e\u4e0d\u9700\u8981\u627e\u4f4d\u70b9\u4e86\uff0c\u6240\u4ee5\u4ece\u5e93 B\u3001C\u3001D \u53ea\u9700\u8981\u5206\u522b\u6267\u884c change master \u547d\u4ee4\u6307\u5411\u5b9e\u4f8b A\u2019 \u5373\u53ef\u3002</p> <p>\u5176\u5b9e\uff0c\u4e25\u8c28\u5730\u8bf4\uff0c\u4e3b\u5907\u5207\u6362\u4e0d\u662f\u4e0d\u9700\u8981\u627e\u4f4d\u70b9\u4e86\uff0c\u800c\u662f\u627e\u4f4d\u70b9\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u5728\u5b9e\u4f8b A\u2019 \u5185\u90e8\u5c31\u5df2\u7ecf\u81ea\u52a8\u5b8c\u6210\u4e86\u3002\u4f46\u7531\u4e8e\u8fd9\u4e2a\u5de5\u4f5c\u662f\u81ea\u52a8\u7684\uff0c\u6240\u4ee5\u5bf9 HA \u7cfb\u7edf\u7684\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\uff0c\u975e\u5e38\u53cb\u597d\u3002</p> <p>\u4e4b\u540e\u8fd9\u4e2a\u7cfb\u7edf\u5c31\u7531\u65b0\u4e3b\u5e93 A\u2019 \u5199\u5165\uff0c\u4e3b\u5e93 A\u2019 \u7684\u81ea\u5df1\u751f\u6210\u7684 binlog \u4e2d\u7684 GTID \u96c6\u5408\u683c\u5f0f\u662f\uff1a<code>server_uuid_of_A\u2019:1-M</code>\u3002</p> <p>\u5982\u679c\u4e4b\u524d\u4ece\u5e93 B \u7684 GTID \u96c6\u5408\u683c\u5f0f\u662f <code>server_uuid_of_A:1-N</code>\uff0c \u90a3\u4e48\u5207\u6362\u4e4b\u540e GTID \u96c6\u5408\u7684\u683c\u5f0f\u5c31\u53d8\u6210\u4e86 <code>server_uuid_of_A:1-N, server_uuid_of_A\u2019:1-M</code>\u3002</p> <p>\u5f53\u7136\uff0c\u4e3b\u5e93 A\u2019 \u4e4b\u524d\u4e5f\u662f A \u7684\u5907\u5e93\uff0c\u56e0\u6b64\u4e3b\u5e93 A\u2019 \u548c\u4ece\u5e93 B \u7684 GTID \u96c6\u5408\u662f\u4e00\u6837\u7684\u3002\u8fd9\u5c31\u8fbe\u5230\u4e86\u6211\u4eec\u9884\u671f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#gtid-ddl","title":"GTID \u548c\u5728\u7ebf DDL","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u518d\u4e3e\u4e2a\u4f8b\u5b50\u5e2e\u4f60\u7406\u89e3 GTID\u3002</p> <p>\u4e4b\u524d\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u63d0\u5230\u4e1a\u52a1\u9ad8\u5cf0\u671f\u7684\u6162\u67e5\u8be2\u6027\u80fd\u95ee\u9898\u65f6\uff0c\u5206\u6790\u5230\u5982\u679c\u662f\u7531\u4e8e\u7d22\u5f15\u7f3a\u5931\u5f15\u8d77\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u7ebf\u52a0\u7d22\u5f15\u6765\u89e3\u51b3\u3002\u4f46\u662f\uff0c\u8003\u8651\u5230\u8981\u907f\u514d\u65b0\u589e\u7d22\u5f15\u5bf9\u4e3b\u5e93\u6027\u80fd\u9020\u6210\u7684\u5f71\u54cd\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5728\u5907\u5e93\u52a0\u7d22\u5f15\uff0c\u7136\u540e\u518d\u5207\u6362\u3002</p> <p>\u5f53\u65f6\u6211\u8bf4\uff0c\u5728\u53cc M \u7ed3\u6784\u4e0b\uff0c\u5907\u5e93\u6267\u884c\u7684 DDL \u8bed\u53e5\u4e5f\u4f1a\u4f20\u7ed9\u4e3b\u5e93\uff0c\u4e3a\u4e86\u907f\u514d\u4f20\u56de\u540e\u5bf9\u4e3b\u5e93\u9020\u6210\u5f71\u54cd\uff0c\u8981\u901a\u8fc7 <code>set sql_log_bin=off</code> \u5173\u6389 binlog\u3002</p> <p>\u8bc4\u8bba\u533a\u6709\u4f4d\u540c\u5b66\u63d0\u51fa\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u8fd9\u6837\u64cd\u4f5c\u7684\u8bdd\uff0c\u6570\u636e\u5e93\u91cc\u9762\u662f\u52a0\u4e86\u7d22\u5f15\uff0c\u4f46\u662f binlog \u5e76\u6ca1\u6709\u8bb0\u5f55\u4e0b\u8fd9\u4e00\u4e2a\u66f4\u65b0\uff0c\u662f\u4e0d\u662f\u4f1a\u5bfc\u81f4\u6570\u636e\u548c\u65e5\u5fd7\u4e0d\u4e00\u81f4\uff1f</p> <p>\u8fd9\u4e2a\u95ee\u9898\u63d0\u5f97\u975e\u5e38\u597d\u3002\u5f53\u65f6\uff0c\u6211\u5728\u7559\u8a00\u7684\u56de\u590d\u4e2d\u5c31\u5f15\u7528\u4e86 GTID \u6765\u8bf4\u660e\u3002\u4eca\u5929\uff0c\u6211\u518d\u548c\u4f60\u5c55\u5f00\u8bf4\u660e\u4e00\u4e0b\u3002</p> <p>\u5047\u8bbe\uff0c\u8fd9\u4e24\u4e2a\u4e92\u4e3a\u4e3b\u5907\u5173\u7cfb\u7684\u5e93\u8fd8\u662f\u5b9e\u4f8b X \u548c\u5b9e\u4f8b Y\uff0c\u4e14\u5f53\u524d\u4e3b\u5e93\u662f X\uff0c\u5e76\u4e14\u90fd\u6253\u5f00\u4e86 GTID \u6a21\u5f0f\u3002\u8fd9\u65f6\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u53ef\u4ee5\u53d8\u6210\u4e0b\u9762\u8fd9\u6837\uff1a</p> <ul> <li> <p>\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c <code>stop slave</code>\u3002</p> </li> <li> <p>\u5728\u5b9e\u4f8b Y \u4e0a\u6267\u884c DDL \u8bed\u53e5\u3002\u6ce8\u610f\uff0c\u8fd9\u91cc\u5e76\u4e0d\u9700\u8981\u5173\u95ed binlog\u3002</p> </li> <li> <p>\u6267\u884c\u5b8c\u6210\u540e\uff0c\u67e5\u51fa\u8fd9\u4e2a DDL \u8bed\u53e5\u5bf9\u5e94\u7684 GTID\uff0c\u5e76\u8bb0\u4e3a <code>server_uuid_of_Y:gno</code>\u3002</p> </li> <li> <p>\u5230\u5b9e\u4f8b X \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bed\u53e5\u5e8f\u5217\uff1a</p> <pre><code>set GTID_NEXT=\"server_uuid_of_Y:gno\";\nbegin;\ncommit;\nset gtid_next=automatic;\nstart slave;\n</code></pre> </li> </ul> <p>\u200b       \u8fd9\u6837\u505a\u7684\u76ee\u7684\u5728\u4e8e\uff0c\u65e2\u53ef\u4ee5\u8ba9\u5b9e\u4f8b Y \u7684\u66f4\u65b0\u6709 binlog \u8bb0\u5f55\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u786e\u4fdd\u4e0d\u4f1a\u5728\u5b9e\u4f8b X \u4e0a\u6267\u884c\u8fd9\u6761\u66f4\u65b0\u3002</p> <ul> <li>\u63a5\u4e0b\u6765\uff0c\u6267\u884c\u5b8c\u4e3b\u5907\u5207\u6362\uff0c\u7136\u540e\u7167\u7740\u4e0a\u8ff0\u6d41\u7a0b\u518d\u6267\u884c\u4e00\u904d\u5373\u53ef\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_26","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u7684\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u4ece\u5e93\u627e\u65b0\u4e3b\u5e93\u7684\u4f4d\u70b9\u662f\u4e00\u4e2a\u75db\u70b9\u3002\u7531\u6b64\uff0c\u6211\u4eec\u5f15\u51fa\u4e86 MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684 GTID \u6a21\u5f0f\uff0c\u4ecb\u7ecd\u4e86 GTID \u7684\u57fa\u672c\u6982\u5ff5\u548c\u7528\u6cd5\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728 GTID \u6a21\u5f0f\u4e0b\uff0c\u4e00\u4e3b\u591a\u4ece\u5207\u6362\u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\u3002</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u7684 MySQL \u7248\u672c\u652f\u6301 GTID \u7684\u8bdd\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u5c3d\u91cf\u4f7f\u7528 GTID \u6a21\u5f0f\u6765\u505a\u4e00\u4e3b\u591a\u4ece\u7684\u5207\u6362\u3002</p> <p>\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u8fd8\u80fd\u770b\u5230 GTID \u6a21\u5f0f\u5728\u8bfb\u5199\u5206\u79bb\u573a\u666f\u7684\u5e94\u7528\u3002</p> <p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u6211\u4eec\u7684\u601d\u8003\u9898\u65f6\u95f4\u3002</p> <p>\u4f60\u5728 GTID \u6a21\u5f0f\u4e0b\u8bbe\u7f6e\u4e3b\u4ece\u5173\u7cfb\u7684\u65f6\u5019\uff0c\u4ece\u5e93\u6267\u884c start slave \u547d\u4ee4\u540e\uff0c\u4e3b\u5e93\u53d1\u73b0\u9700\u8981\u7684 binlog \u5df2\u7ecf\u88ab\u5220\u9664\u6389\u4e86\uff0c\u5bfc\u81f4\u4e3b\u5907\u521b\u5efa\u4e0d\u6210\u529f\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u89c9\u5f97\u53ef\u4ee5\u600e\u4e48\u5904\u7406\u5462\uff1f</p> <p>\u53c2\u8003\u5904\u7406\u65b9\u6848\uff1a</p> <ol> <li>\u5982\u679c\u4e1a\u52a1\u5141\u8bb8\u4e3b\u4ece\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728\u4e3b\u5e93\u4e0a\u5148\u6267\u884c <code>show global variables like 'gtid_purged'</code>\uff0c\u5f97\u5230\u4e3b\u5e93\u5df2\u7ecf\u5220\u9664\u7684 GTID \u96c6\u5408\uff0c\u5047\u8bbe\u662f <code>gtid_purged1</code>\uff1b\u7136\u540e\u5148\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>reset master</code>\uff0c\u518d\u6267\u884c <code>set global gtid_purged ='gtid_purged1'</code>\uff1b\u6700\u540e\u6267\u884c <code>start slave</code>\uff0c\u5c31\u4f1a\u4ece\u4e3b\u5e93\u73b0\u5b58\u7684 binlog \u5f00\u59cb\u540c\u6b65\u3002binlog \u7f3a\u5931\u7684\u90a3\u4e00\u90e8\u5206\uff0c\u6570\u636e\u5728\u4ece\u5e93\u4e0a\u5c31\u53ef\u80fd\u4f1a\u6709\u4e22\u5931\uff0c\u9020\u6210\u4e3b\u4ece\u4e0d\u4e00\u81f4\u3002</li> <li>\u5982\u679c\u9700\u8981\u4e3b\u4ece\u6570\u636e\u4e00\u81f4\u7684\u8bdd\uff0c\u6700\u597d\u8fd8\u662f\u901a\u8fc7\u91cd\u65b0\u642d\u5efa\u4ece\u5e93\u6765\u505a\u3002</li> <li>\u5982\u679c\u6709\u5176\u4ed6\u7684\u4ece\u5e93\u4fdd\u7559\u6709\u5168\u91cf\u7684 binlog \u7684\u8bdd\uff0c\u53ef\u4ee5\u628a\u65b0\u7684\u4ece\u5e93\u5148\u63a5\u5230\u8fd9\u4e2a\u4fdd\u7559\u4e86\u5168\u91cf binlog \u7684\u4ece\u5e93\uff0c\u8ffd\u4e0a\u65e5\u5fd7\u4ee5\u540e\uff0c\u5982\u679c\u6709\u9700\u8981\uff0c\u518d\u63a5\u56de\u4e3b\u5e93\u3002</li> <li>\u5982\u679c binlog \u6709\u5907\u4efd\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5148\u5728\u4ece\u5e93\u4e0a\u5e94\u7528\u7f3a\u5931\u7684 binlog\uff0c\u7136\u540e\u518d\u6267\u884c start slave\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#28","title":"28 \u8bfb\u5199\u5206\u79bb\u6709\u54ea\u4e9b\u5751\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u7684\u7ed3\u6784\u4ee5\u53ca\u5207\u6362\u6d41\u7a0b\u3002\u4eca\u5929\u6211\u4eec\u5c31\u7ee7\u7eed\u804a\u804a\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u7684\u5e94\u7528\u573a\u666f\uff1a\u8bfb\u5199\u5206\u79bb\uff0c\u4ee5\u53ca\u600e\u4e48\u5904\u7406\u4e3b\u5907\u5ef6\u8fdf\u5bfc\u81f4\u7684\u8bfb\u5199\u5206\u79bb\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u4e00\u4e3b\u591a\u4ece\u7684\u7ed3\u6784\uff0c\u5176\u5b9e\u5c31\u662f\u8bfb\u5199\u5206\u79bb\u7684\u57fa\u672c\u7ed3\u6784\u4e86\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u628a\u8fd9\u5f20\u56fe\u8d34\u8fc7\u6765\uff0c\u65b9\u4fbf\u4f60\u7406\u89e3\u3002</p> <p></p> <p>\u56fe 1 \u8bfb\u5199\u5206\u79bb\u57fa\u672c\u7ed3\u6784</p> <p>\u8bfb\u5199\u5206\u79bb\u7684\u4e3b\u8981\u76ee\u6807\u5c31\u662f\u5206\u644a\u4e3b\u5e93\u7684\u538b\u529b\u3002\u56fe 1 \u4e2d\u7684\u7ed3\u6784\u662f\u5ba2\u6237\u7aef\uff08client\uff09\u4e3b\u52a8\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u8fd9\u79cd\u6a21\u5f0f\u4e0b\u4e00\u822c\u4f1a\u628a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u4fe1\u606f\u653e\u5728\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u5c42\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7531\u5ba2\u6237\u7aef\u6765\u9009\u62e9\u540e\u7aef\u6570\u636e\u5e93\u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u8fd8\u6709\u4e00\u79cd\u67b6\u6784\u662f\uff0c\u5728 MySQL \u548c\u5ba2\u6237\u7aef\u4e4b\u95f4\u6709\u4e00\u4e2a\u4e2d\u95f4\u4ee3\u7406\u5c42 proxy\uff0c\u5ba2\u6237\u7aef\u53ea\u8fde\u63a5 proxy\uff0c \u7531 proxy \u6839\u636e\u8bf7\u6c42\u7c7b\u578b\u548c\u4e0a\u4e0b\u6587\u51b3\u5b9a\u8bf7\u6c42\u7684\u5206\u53d1\u8def\u7531\u3002</p> <p></p> <p>\u56fe 2 \u5e26 proxy \u7684\u8bfb\u5199\u5206\u79bb\u67b6\u6784</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u4e00\u4e0b\u5ba2\u6237\u7aef\u76f4\u8fde\u548c\u5e26 proxy \u7684\u8bfb\u5199\u5206\u79bb\u67b6\u6784\uff0c\u5404\u6709\u54ea\u4e9b\u7279\u70b9\u3002</p> <ol> <li>\u5ba2\u6237\u7aef\u76f4\u8fde\u65b9\u6848\uff0c\u56e0\u4e3a\u5c11\u4e86\u4e00\u5c42 proxy \u8f6c\u53d1\uff0c\u6240\u4ee5\u67e5\u8be2\u6027\u80fd\u7a0d\u5fae\u597d\u4e00\u70b9\u513f\uff0c\u5e76\u4e14\u6574\u4f53\u67b6\u6784\u7b80\u5355\uff0c\u6392\u67e5\u95ee\u9898\u66f4\u65b9\u4fbf\u3002\u4f46\u662f\u8fd9\u79cd\u65b9\u6848\uff0c\u7531\u4e8e\u8981\u4e86\u89e3\u540e\u7aef\u90e8\u7f72\u7ec6\u8282\uff0c\u6240\u4ee5\u5728\u51fa\u73b0\u4e3b\u5907\u5207\u6362\u3001\u5e93\u8fc1\u79fb\u7b49\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u5ba2\u6237\u7aef\u90fd\u4f1a\u611f\u77e5\u5230\uff0c\u5e76\u4e14\u9700\u8981\u8c03\u6574\u6570\u636e\u5e93\u8fde\u63a5\u4fe1\u606f\u3002 \u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u8fd9\u6837\u5ba2\u6237\u7aef\u4e5f\u592a\u9ebb\u70e6\u4e86\uff0c\u4fe1\u606f\u5927\u91cf\u5197\u4f59\uff0c\u67b6\u6784\u5f88\u4e11\u3002\u5176\u5b9e\u4e5f\u672a\u5fc5\uff0c\u4e00\u822c\u91c7\u7528\u8fd9\u6837\u7684\u67b6\u6784\uff0c\u4e00\u5b9a\u4f1a\u4f34\u968f\u4e00\u4e2a\u8d1f\u8d23\u7ba1\u7406\u540e\u7aef\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982 Zookeeper\uff0c\u5c3d\u91cf\u8ba9\u4e1a\u52a1\u7aef\u53ea\u4e13\u6ce8\u4e8e\u4e1a\u52a1\u903b\u8f91\u5f00\u53d1\u3002</li> <li>\u5e26 proxy \u7684\u67b6\u6784\uff0c\u5bf9\u5ba2\u6237\u7aef\u6bd4\u8f83\u53cb\u597d\u3002\u5ba2\u6237\u7aef\u4e0d\u9700\u8981\u5173\u6ce8\u540e\u7aef\u7ec6\u8282\uff0c\u8fde\u63a5\u7ef4\u62a4\u3001\u540e\u7aef\u4fe1\u606f\u7ef4\u62a4\u7b49\u5de5\u4f5c\uff0c\u90fd\u662f\u7531 proxy \u5b8c\u6210\u7684\u3002\u4f46\u8fd9\u6837\u7684\u8bdd\uff0c\u5bf9\u540e\u7aef\u7ef4\u62a4\u56e2\u961f\u7684\u8981\u6c42\u4f1a\u66f4\u9ad8\u3002\u800c\u4e14\uff0cproxy \u4e5f\u9700\u8981\u6709\u9ad8\u53ef\u7528\u67b6\u6784\u3002\u56e0\u6b64\uff0c\u5e26 proxy \u67b6\u6784\u7684\u6574\u4f53\u5c31\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\u3002</li> </ol> <p>\u7406\u89e3\u4e86\u8fd9\u4e24\u79cd\u65b9\u6848\u7684\u4f18\u52a3\uff0c\u5177\u4f53\u9009\u62e9\u54ea\u4e2a\u65b9\u6848\u5c31\u53d6\u51b3\u4e8e\u6570\u636e\u5e93\u56e2\u961f\u63d0\u4f9b\u7684\u80fd\u529b\u4e86\u3002\u4f46\u76ee\u524d\u770b\uff0c\u8d8b\u52bf\u662f\u5f80\u5e26 proxy \u7684\u67b6\u6784\u65b9\u5411\u53d1\u5c55\u7684\u3002</p> <p>\u4f46\u662f\uff0c\u4e0d\u8bba\u4f7f\u7528\u54ea\u79cd\u67b6\u6784\uff0c\u4f60\u90fd\u4f1a\u78b0\u5230\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\uff1a\u7531\u4e8e\u4e3b\u4ece\u53ef\u80fd\u5b58\u5728\u5ef6\u8fdf\uff0c\u5ba2\u6237\u7aef\u6267\u884c\u5b8c\u4e00\u4e2a\u66f4\u65b0\u4e8b\u52a1\u540e\u9a6c\u4e0a\u53d1\u8d77\u67e5\u8be2\uff0c\u5982\u679c\u67e5\u8be2\u9009\u62e9\u7684\u662f\u4ece\u5e93\u7684\u8bdd\uff0c\u5c31\u6709\u53ef\u80fd\u8bfb\u5230\u521a\u521a\u7684\u4e8b\u52a1\u66f4\u65b0\u4e4b\u524d\u7684\u72b6\u6001\u3002</p> <p>\u8fd9\u79cd\u201c\u5728\u4ece\u5e93\u4e0a\u4f1a\u8bfb\u5230\u7cfb\u7edf\u7684\u4e00\u4e2a\u8fc7\u671f\u72b6\u6001\u201d\u7684\u73b0\u8c61\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u91cc\uff0c\u6211\u4eec\u6682\u4e14\u79f0\u4e4b\u4e3a\u201c\u8fc7\u671f\u8bfb\u201d\u3002</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u4e86\u51e0\u79cd\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5907\u5ef6\u8fdf\u7684\u539f\u56e0\uff0c\u4ee5\u53ca\u5bf9\u5e94\u7684\u4f18\u5316\u7b56\u7565\uff0c\u4f46\u662f\u4e3b\u4ece\u5ef6\u8fdf\u8fd8\u662f\u4e0d\u80fd 100% \u907f\u514d\u7684\u3002</p> <p>\u4e0d\u8bba\u54ea\u79cd\u7ed3\u6784\uff0c\u5ba2\u6237\u7aef\u90fd\u5e0c\u671b\u67e5\u8be2\u4ece\u5e93\u7684\u6570\u636e\u7ed3\u679c\uff0c\u8ddf\u67e5\u4e3b\u5e93\u7684\u6570\u636e\u7ed3\u679c\u662f\u4e00\u6837\u7684\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u6765\u8ba8\u8bba\u600e\u4e48\u5904\u7406\u8fc7\u671f\u8bfb\u95ee\u9898\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u5148\u628a\u6587\u7ae0\u4e2d\u6d89\u53ca\u5230\u7684\u5904\u7406\u8fc7\u671f\u8bfb\u7684\u65b9\u6848\u6c47\u603b\u5728\u8fd9\u91cc\uff0c\u4ee5\u5e2e\u52a9\u4f60\u66f4\u597d\u5730\u7406\u89e3\u548c\u638c\u63e1\u5168\u6587\u7684\u77e5\u8bc6\u8109\u7edc\u3002\u8fd9\u4e9b\u65b9\u6848\u5305\u62ec\uff1a</p> <ul> <li>\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848\uff1b</li> <li>sleep \u65b9\u6848\uff1b</li> <li>\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u65b9\u6848\uff1b</li> <li>\u914d\u5408 semi-sync \u65b9\u6848\uff1b</li> <li>\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff1b</li> <li>\u7b49 GTID \u65b9\u6848\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_27","title":"\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848","text":"<p>\u5f3a\u5236\u8d70\u4e3b\u5e93\u65b9\u6848\u5176\u5b9e\u5c31\u662f\uff0c\u5c06\u67e5\u8be2\u8bf7\u6c42\u505a\u5206\u7c7b\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u67e5\u8be2\u8bf7\u6c42\u5206\u4e3a\u8fd9\u4e48\u4e24\u7c7b\uff1a</p> <ol> <li>\u5bf9\u4e8e\u5fc5\u987b\u8981\u62ff\u5230\u6700\u65b0\u7ed3\u679c\u7684\u8bf7\u6c42\uff0c\u5f3a\u5236\u5c06\u5176\u53d1\u5230\u4e3b\u5e93\u4e0a\u3002\u6bd4\u5982\uff0c\u5728\u4e00\u4e2a\u4ea4\u6613\u5e73\u53f0\u4e0a\uff0c\u5356\u5bb6\u53d1\u5e03\u5546\u54c1\u4ee5\u540e\uff0c\u9a6c\u4e0a\u8981\u8fd4\u56de\u4e3b\u9875\u9762\uff0c\u770b\u5546\u54c1\u662f\u5426\u53d1\u5e03\u6210\u529f\u3002\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bf7\u6c42\u9700\u8981\u62ff\u5230\u6700\u65b0\u7684\u7ed3\u679c\uff0c\u5c31\u5fc5\u987b\u8d70\u4e3b\u5e93\u3002</li> <li>\u5bf9\u4e8e\u53ef\u4ee5\u8bfb\u5230\u65e7\u6570\u636e\u7684\u8bf7\u6c42\uff0c\u624d\u5c06\u5176\u53d1\u5230\u4ece\u5e93\u4e0a\u3002\u5728\u8fd9\u4e2a\u4ea4\u6613\u5e73\u53f0\u4e0a\uff0c\u4e70\u5bb6\u6765\u901b\u5546\u94fa\u9875\u9762\uff0c\u5c31\u7b97\u665a\u51e0\u79d2\u770b\u5230\u6700\u65b0\u53d1\u5e03\u7684\u5546\u54c1\uff0c\u4e5f\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002\u90a3\u4e48\uff0c\u8fd9\u7c7b\u8bf7\u6c42\u5c31\u53ef\u4ee5\u8d70\u4ece\u5e93\u3002</li> </ol> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u65b9\u6848\u662f\u4e0d\u662f\u6709\u70b9\u754f\u96be\u548c\u53d6\u5de7\u7684\u610f\u601d\uff0c\u4f46\u5176\u5b9e\u8fd9\u4e2a\u65b9\u6848\u662f\u7528\u5f97\u6700\u591a\u7684\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u65b9\u6848\u6700\u5927\u7684\u95ee\u9898\u5728\u4e8e\uff0c\u6709\u65f6\u5019\u4f60\u4f1a\u78b0\u5230\u201c\u6240\u6709\u67e5\u8be2\u90fd\u4e0d\u80fd\u662f\u8fc7\u671f\u8bfb\u201d\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u4e00\u4e9b\u91d1\u878d\u7c7b\u7684\u4e1a\u52a1\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u4f60\u5c31\u8981\u653e\u5f03\u8bfb\u5199\u5206\u79bb\uff0c\u6240\u6709\u8bfb\u5199\u538b\u529b\u90fd\u5728\u4e3b\u5e93\uff0c\u7b49\u540c\u4e8e\u653e\u5f03\u4e86\u6269\u5c55\u6027\u3002</p> <p>\u56e0\u6b64\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u7684\u8bdd\u9898\u662f\uff1a\u53ef\u4ee5\u652f\u6301\u8bfb\u5199\u5206\u79bb\u7684\u573a\u666f\u4e0b\uff0c\u6709\u54ea\u4e9b\u89e3\u51b3\u8fc7\u671f\u8bfb\u7684\u65b9\u6848\uff0c\u5e76\u5206\u6790\u5404\u4e2a\u65b9\u6848\u7684\u4f18\u7f3a\u70b9\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#sleep","title":"Sleep \u65b9\u6848","text":"<p>\u4e3b\u5e93\u66f4\u65b0\u540e\uff0c\u8bfb\u4ece\u5e93\u4e4b\u524d\u5148 sleep \u4e00\u4e0b\u3002\u5177\u4f53\u7684\u65b9\u6848\u5c31\u662f\uff0c\u7c7b\u4f3c\u4e8e\u6267\u884c\u4e00\u6761 <code>select sleep(1)</code> \u547d\u4ee4\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6848\u7684\u5047\u8bbe\u662f\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u4e3b\u5907\u5ef6\u8fdf\u5728 1 \u79d2\u4e4b\u5185\uff0c\u505a\u4e00\u4e2a sleep \u53ef\u4ee5\u6709\u5f88\u5927\u6982\u7387\u62ff\u5230\u6700\u65b0\u7684\u6570\u636e\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6848\u7ed9\u4f60\u7684\u7b2c\u4e00\u611f\u89c9\uff0c\u5f88\u53ef\u80fd\u662f\u4e0d\u9760\u8c31\u513f\uff0c\u5e94\u8be5\u4e0d\u4f1a\u6709\u4eba\u7528\u5427\uff1f\u5e76\u4e14\uff0c\u4f60\u8fd8\u53ef\u80fd\u4f1a\u8bf4\uff0c\u76f4\u63a5\u5728\u53d1\u8d77\u67e5\u8be2\u65f6\u5148\u6267\u884c\u4e00\u6761 sleep \u8bed\u53e5\uff0c\u7528\u6237\u4f53\u9a8c\u5f88\u4e0d\u53cb\u597d\u554a\u3002</p> <p>\u4f46\uff0c\u8fd9\u4e2a\u601d\u8def\u786e\u5b9e\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u95ee\u9898\u3002\u4e3a\u4e86\u770b\u8d77\u6765\u66f4\u9760\u8c31\u513f\uff0c\u6211\u4eec\u53ef\u4ee5\u6362\u4e00\u79cd\u65b9\u5f0f\u3002</p> <p>\u4ee5\u5356\u5bb6\u53d1\u5e03\u5546\u54c1\u4e3a\u4f8b\uff0c\u5546\u54c1\u53d1\u5e03\u540e\uff0c\u7528 Ajax \u76f4\u63a5\u628a\u5ba2\u6237\u7aef\u8f93\u5165\u7684\u5185\u5bb9\u4f5c\u4e3a\u201c\u65b0\u7684\u5546\u54c1\u201d\u663e\u793a\u5728\u9875\u9762\u4e0a\uff0c\u800c\u4e0d\u662f\u771f\u6b63\u5730\u53bb\u6570\u636e\u5e93\u505a\u67e5\u8be2\u3002</p> <p>\u8fd9\u6837\uff0c\u5356\u5bb6\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u663e\u793a\uff0c\u6765\u786e\u8ba4\u4ea7\u54c1\u5df2\u7ecf\u53d1\u5e03\u6210\u529f\u4e86\u3002\u7b49\u5230\u5356\u5bb6\u518d\u5237\u65b0\u9875\u9762\uff0c\u53bb\u67e5\u770b\u5546\u54c1\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u5df2\u7ecf\u8fc7\u4e86\u4e00\u6bb5\u65f6\u95f4\uff0c\u4e5f\u5c31\u8fbe\u5230\u4e86 sleep \u7684\u76ee\u7684\uff0c\u8fdb\u800c\u4e5f\u5c31\u89e3\u51b3\u4e86\u8fc7\u671f\u8bfb\u7684\u95ee\u9898\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a sleep \u65b9\u6848\u786e\u5b9e\u89e3\u51b3\u4e86\u7c7b\u4f3c\u573a\u666f\u4e0b\u7684\u8fc7\u671f\u8bfb\u95ee\u9898\u3002\u4f46\uff0c\u4ece\u4e25\u683c\u610f\u4e49\u4e0a\u6765\u8bf4\uff0c\u8fd9\u4e2a\u65b9\u6848\u5b58\u5728\u7684\u95ee\u9898\u5c31\u662f\u4e0d\u7cbe\u786e\u3002\u8fd9\u4e2a\u4e0d\u7cbe\u786e\u5305\u542b\u4e86\u4e24\u5c42\u610f\u601d\uff1a</p> <ol> <li>\u5982\u679c\u8fd9\u4e2a\u67e5\u8be2\u8bf7\u6c42\u672c\u6765 0.5 \u79d2\u5c31\u53ef\u4ee5\u5728\u4ece\u5e93\u4e0a\u62ff\u5230\u6b63\u786e\u7ed3\u679c\uff0c\u4e5f\u4f1a\u7b49 1 \u79d2\uff1b</li> <li>\u5982\u679c\u5ef6\u8fdf\u8d85\u8fc7 1 \u79d2\uff0c\u8fd8\u662f\u4f1a\u51fa\u73b0\u8fc7\u671f\u8bfb\u3002</li> </ol> <p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u662f\u4e0d\u662f\u6709\u4e00\u79cd\u201c\u4f60\u662f\u4e0d\u662f\u5728\u9017\u6211\u201d\u7684\u611f\u89c9\uff0c\u8fd9\u4e2a\u6539\u8fdb\u65b9\u6848\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u7c7b\u4f3c Ajax \u573a\u666f\u4e0b\u7684\u8fc7\u671f\u8bfb\u95ee\u9898\uff0c\u4f46\u8fd8\u662f\u600e\u4e48\u770b\u90fd\u4e0d\u9760\u8c31\u513f\u3002\u522b\u7740\u6025\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e9b\u66f4\u51c6\u786e\u7684\u65b9\u6848\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_28","title":"\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u65b9\u6848","text":"<p>\u8981\u786e\u4fdd\u5907\u5e93\u65e0\u5ef6\u8fdf\uff0c\u901a\u5e38\u6709\u4e09\u79cd\u505a\u6cd5\u3002</p> <p>\u901a\u8fc7\u524d\u9762\u7684\u6587\u7ae0\uff0c\u6211\u4eec\u77e5\u9053 <code>show slave status</code> \u7ed3\u679c\u91cc\u7684 <code>seconds_behind_master</code> \u53c2\u6570\u7684\u503c\uff0c\u53ef\u4ee5\u7528\u6765\u8861\u91cf\u4e3b\u5907\u5ef6\u8fdf\u65f6\u95f4\u7684\u957f\u77ed\u3002</p> <p>\u6240\u4ee5**\u7b2c\u4e00\u79cd\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u65b9\u6cd5\u662f\uff0c**\u6bcf\u6b21\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u524d\uff0c\u5148\u5224\u65ad <code>seconds_behind_master</code> \u662f\u5426\u5df2\u7ecf\u7b49\u4e8e 0\u3002\u5982\u679c\u8fd8\u4e0d\u7b49\u4e8e 0 \uff0c\u90a3\u5c31\u5fc5\u987b\u7b49\u5230\u8fd9\u4e2a\u53c2\u6570\u53d8\u4e3a 0 \u624d\u80fd\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u3002</p> <p><code>seconds_behind_master</code> \u7684\u5355\u4f4d\u662f\u79d2\uff0c\u5982\u679c\u4f60\u89c9\u5f97\u7cbe\u5ea6\u4e0d\u591f\u7684\u8bdd\uff0c\u8fd8\u53ef\u4ee5\u91c7\u7528\u5bf9\u6bd4\u4f4d\u70b9\u548c GTID \u7684\u65b9\u6cd5\u6765\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u8bf4\u7684\u7b2c\u4e8c\u548c\u7b2c\u4e09\u79cd\u65b9\u6cd5\u3002</p> <p>\u5982\u4e0b\u662f\u4e00\u4e2a <code>show slave status</code> \u7ed3\u679c\u7684\u90e8\u5206\u5185\u5bb9\u3002</p> <pre><code>      Master_Log_File: master.000012\n  Read_Master_log_Pos: 1206067593\n.....\nRelay_Master_Log_File: master.000012\n....\n  Exec_Master_Log_Pos: 126067593\n....\n   Retrieved_Gtid_Set: 0000000-1111-000-1111-0000000000:1-10000\n    Executed_Gtid_Set: 0000000-1111-000-1111-0000000000:1-10000\n        Auto_Position: 1\n</code></pre> <p>**\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff0c**\u5bf9\u6bd4\u4f4d\u70b9\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff1a</p> <ul> <li><code>Master_Log_File</code> \u548c <code>Read_Master_Log_Pos</code>\uff0c\u8868\u793a\u7684\u662f\u8bfb\u5230\u7684\u4e3b\u5e93\u7684\u6700\u65b0\u4f4d\u70b9\uff1b</li> <li><code>Relay_Master_Log_File</code> \u548c <code>Exec_Master_Log_Pos</code>\uff0c\u8868\u793a\u7684\u662f\u5907\u5e93\u6267\u884c\u7684\u6700\u65b0\u4f4d\u70b9\u3002</li> </ul> <p>\u5982\u679c <code>Master_Log_File</code> \u548c <code>Relay_Master_Log_File</code>\u3001<code>Read_Master_Log_Pos</code> \u548c <code>Exec_Master_Log_Pos</code> \u8fd9\u4e24\u7ec4\u503c\u5b8c\u5168\u76f8\u540c\uff0c\u5c31\u8868\u793a\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u5df2\u7ecf\u540c\u6b65\u5b8c\u6210\u3002</p> <p>**\u7b2c\u4e09\u79cd\u65b9\u6cd5\uff0c**\u5bf9\u6bd4 GTID \u96c6\u5408\u786e\u4fdd\u4e3b\u5907\u65e0\u5ef6\u8fdf\uff1a</p> <ul> <li><code>Auto_Position=1</code> \uff0c\u8868\u793a\u8fd9\u5bf9\u4e3b\u5907\u5173\u7cfb\u4f7f\u7528\u4e86 GTID \u534f\u8bae\u3002</li> <li><code>Retrieved_Gtid_Set</code>\uff0c\u662f\u5907\u5e93\u6536\u5230\u7684\u6240\u6709\u65e5\u5fd7\u7684 GTID \u96c6\u5408\uff1b</li> <li><code>Executed_Gtid_Set</code>\uff0c\u662f\u5907\u5e93\u6240\u6709\u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u7684 GTID \u96c6\u5408\u3002</li> </ul> <p>\u5982\u679c\u8fd9\u4e24\u4e2a\u96c6\u5408\u76f8\u540c\uff0c\u4e5f\u8868\u793a\u5907\u5e93\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u90fd\u5df2\u7ecf\u540c\u6b65\u5b8c\u6210\u3002</p> <p>\u53ef\u89c1\uff0c\u5bf9\u6bd4\u4f4d\u70b9\u548c\u5bf9\u6bd4 GTID \u8fd9\u4e24\u79cd\u65b9\u6cd5\uff0c\u90fd\u8981\u6bd4\u5224\u65ad <code>seconds_behind_master</code> \u662f\u5426\u4e3a 0 \u66f4\u51c6\u786e\u3002</p> <p>\u5728\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u4e4b\u524d\uff0c\u5148\u5224\u65ad\u4ece\u5e93\u662f\u5426\u540c\u6b65\u5b8c\u6210\u7684\u65b9\u6cd5\uff0c\u76f8\u6bd4\u4e8e sleep \u65b9\u6848\uff0c\u51c6\u786e\u5ea6\u786e\u5b9e\u63d0\u5347\u4e86\u4e0d\u5c11\uff0c\u4f46\u8fd8\u662f\u6ca1\u6709\u8fbe\u5230\u201c\u7cbe\u786e\u201d\u7684\u7a0b\u5ea6\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p> <p>\u6211\u4eec\u73b0\u5728\u4e00\u8d77\u6765\u56de\u987e\u4e0b\uff0c\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u5728\u4e3b\u5907\u5e93\u4e4b\u95f4\u7684\u72b6\u6001\uff1a</p> <ol> <li>\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\uff0c\u5199\u5165 binlog\uff0c\u5e76\u53cd\u9988\u7ed9\u5ba2\u6237\u7aef\uff1b</li> <li>binlog \u88ab\u4ece\u4e3b\u5e93\u53d1\u9001\u7ed9\u5907\u5e93\uff0c\u5907\u5e93\u6536\u5230\uff1b</li> <li>\u5728\u5907\u5e93\u6267\u884c binlog \u5b8c\u6210\u3002</li> </ol> <p>\u6211\u4eec\u4e0a\u9762\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u903b\u8f91\uff0c\u662f\u201c\u5907\u5e93\u6536\u5230\u7684\u65e5\u5fd7\u90fd\u6267\u884c\u5b8c\u6210\u4e86\u201d\u3002\u4f46\u662f\uff0c\u4ece binlog \u5728\u4e3b\u5907\u4e4b\u95f4\u72b6\u6001\u7684\u5206\u6790\u4e2d\uff0c\u4e0d\u96be\u770b\u51fa\u8fd8\u6709\u4e00\u90e8\u5206\u65e5\u5fd7\uff0c\u5904\u4e8e\u5ba2\u6237\u7aef\u5df2\u7ecf\u6536\u5230\u63d0\u4ea4\u786e\u8ba4\uff0c\u800c\u5907\u5e93\u8fd8\u6ca1\u6536\u5230\u65e5\u5fd7\u7684\u72b6\u6001\u3002</p> <p>\u5982\u56fe 4 \u6240\u793a\u5c31\u662f\u8fd9\u6837\u7684\u4e00\u4e2a\u72b6\u6001\u3002</p> <p></p> <p>\u56fe 4 \u5907\u5e93\u8fd8\u6ca1\u6536\u5230 trx3</p> <p>\u8fd9\u65f6\uff0c\u4e3b\u5e93\u4e0a\u6267\u884c\u5b8c\u6210\u4e86\u4e09\u4e2a\u4e8b\u52a1 trx1\u3001trx2 \u548c trx3\uff0c\u5176\u4e2d\uff1a</p> <ol> <li>trx1 \u548c trx2 \u5df2\u7ecf\u4f20\u5230\u4ece\u5e93\uff0c\u5e76\u4e14\u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u4e86\uff1b</li> <li>trx3 \u5728\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\uff0c\u5e76\u4e14\u5df2\u7ecf\u56de\u590d\u7ed9\u5ba2\u6237\u7aef\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u4f20\u5230\u4ece\u5e93\u4e2d\u3002</li> </ol> <p>\u5982\u679c\u8fd9\u65f6\u5019\u4f60\u5728\u4ece\u5e93 B \u4e0a\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u6309\u7167\u6211\u4eec\u4e0a\u9762\u7684\u903b\u8f91\uff0c\u4ece\u5e93\u8ba4\u4e3a\u5df2\u7ecf\u6ca1\u6709\u540c\u6b65\u5ef6\u8fdf\uff0c\u4f46\u8fd8\u662f\u67e5\u4e0d\u5230 trx3 \u7684\u3002\u4e25\u683c\u5730\u8bf4\uff0c\u5c31\u662f\u51fa\u73b0\u4e86\u8fc7\u671f\u8bfb\u3002</p> <p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u95ee\u9898\u6709\u6ca1\u6709\u529e\u6cd5\u89e3\u51b3\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#semi-sync","title":"\u914d\u5408 semi-sync","text":"<p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u8981\u5f15\u5165\u534a\u540c\u6b65\u590d\u5236\uff0c\u4e5f\u5c31\u662f semi-sync replication\u3002</p> <p>semi-sync \u505a\u4e86\u8fd9\u6837\u7684\u8bbe\u8ba1\uff1a</p> <ol> <li>\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u4e3b\u5e93\u628a binlog \u53d1\u7ed9\u4ece\u5e93\uff1b</li> <li>\u4ece\u5e93\u6536\u5230 binlog \u4ee5\u540e\uff0c\u53d1\u56de\u7ed9\u4e3b\u5e93\u4e00\u4e2a ack\uff0c\u8868\u793a\u6536\u5230\u4e86\uff1b</li> <li>\u4e3b\u5e93\u6536\u5230\u8fd9\u4e2a ack \u4ee5\u540e\uff0c\u624d\u80fd\u7ed9\u5ba2\u6237\u7aef\u8fd4\u56de\u201c\u4e8b\u52a1\u5b8c\u6210\u201d\u7684\u786e\u8ba4\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u542f\u7528\u4e86 semi-sync\uff0c\u5c31\u8868\u793a\u6240\u6709\u7ed9\u5ba2\u6237\u7aef\u53d1\u9001\u8fc7\u786e\u8ba4\u7684\u4e8b\u52a1\uff0c\u90fd\u786e\u4fdd\u4e86\u5907\u5e93\u5df2\u7ecf\u6536\u5230\u4e86\u8fd9\u4e2a\u65e5\u5fd7\u3002</p> <p>\u5728[\u7b2c 25 \u7bc7\u6587\u7ae0]\u7684\u8bc4\u8bba\u533a\uff0c\u6709\u540c\u5b66\u95ee\u5230\uff1a\u5982\u679c\u4e3b\u5e93\u6389\u7535\u7684\u65f6\u5019\uff0c\u6709\u4e9b binlog \u8fd8\u6765\u4e0d\u53ca\u53d1\u7ed9\u4ece\u5e93\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u7cfb\u7edf\u6570\u636e\u4e22\u5931\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f\u666e\u901a\u7684\u5f02\u6b65\u590d\u5236\u6a21\u5f0f\uff0c\u5c31\u53ef\u80fd\u4f1a\u4e22\u5931\uff0c\u4f46 semi-sync \u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u8fd9\u6837\uff0csemi-sync \u914d\u5408\u524d\u9762\u5173\u4e8e\u4f4d\u70b9\u7684\u5224\u65ad\uff0c\u5c31\u80fd\u591f\u786e\u5b9a\u5728\u4ece\u5e93\u4e0a\u6267\u884c\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u53ef\u4ee5\u907f\u514d\u8fc7\u671f\u8bfb\u3002</p> <p>\u4f46\u662f\uff0csemi-sync+ \u4f4d\u70b9\u5224\u65ad\u7684\u65b9\u6848\uff0c\u53ea\u5bf9\u4e00\u4e3b\u4e00\u5907\u7684\u573a\u666f\u662f\u6210\u7acb\u7684\u3002\u5728\u4e00\u4e3b\u591a\u4ece\u573a\u666f\u4e2d\uff0c\u4e3b\u5e93\u53ea\u8981\u7b49\u5230\u4e00\u4e2a\u4ece\u5e93\u7684 ack\uff0c\u5c31\u5f00\u59cb\u7ed9\u5ba2\u6237\u7aef\u8fd4\u56de\u786e\u8ba4\u3002\u8fd9\u65f6\uff0c\u5728\u4ece\u5e93\u4e0a\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u5c31\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ol> <li>\u5982\u679c\u67e5\u8be2\u662f\u843d\u5728\u8fd9\u4e2a\u54cd\u5e94\u4e86 ack \u7684\u4ece\u5e93\u4e0a\uff0c\u662f\u80fd\u591f\u786e\u4fdd\u8bfb\u5230\u6700\u65b0\u6570\u636e\uff1b</li> <li>\u4f46\u5982\u679c\u662f\u67e5\u8be2\u843d\u5230\u5176\u4ed6\u4ece\u5e93\u4e0a\uff0c\u5b83\u4eec\u53ef\u80fd\u8fd8\u6ca1\u6709\u6536\u5230\u6700\u65b0\u7684\u65e5\u5fd7\uff0c\u5c31\u4f1a\u4ea7\u751f\u8fc7\u671f\u8bfb\u7684\u95ee\u9898\u3002</li> </ol> <p>\u5176\u5b9e\uff0c\u5224\u65ad\u540c\u6b65\u4f4d\u70b9\u7684\u65b9\u6848\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u6f5c\u5728\u7684\u95ee\u9898\uff0c\u5373\uff1a\u5982\u679c\u5728\u4e1a\u52a1\u66f4\u65b0\u7684\u9ad8\u5cf0\u671f\uff0c\u4e3b\u5e93\u7684\u4f4d\u70b9\u6216\u8005 GTID \u96c6\u5408\u66f4\u65b0\u5f88\u5feb\uff0c\u90a3\u4e48\u4e0a\u9762\u7684\u4e24\u4e2a\u4f4d\u70b9\u7b49\u503c\u5224\u65ad\u5c31\u4f1a\u4e00\u76f4\u4e0d\u6210\u7acb\uff0c\u5f88\u53ef\u80fd\u51fa\u73b0\u4ece\u5e93\u4e0a\u8fdf\u8fdf\u65e0\u6cd5\u54cd\u5e94\u67e5\u8be2\u8bf7\u6c42\u7684\u60c5\u51b5\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u56de\u5230\u6211\u4eec\u6700\u521d\u7684\u4e1a\u52a1\u903b\u8f91\u91cc\uff0c\u5f53\u53d1\u8d77\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u4ee5\u540e\uff0c\u6211\u4eec\u8981\u5f97\u5230\u51c6\u786e\u7684\u7ed3\u679c\uff0c\u5176\u5b9e\u5e76\u4e0d\u9700\u8981\u7b49\u5230\u201c\u4e3b\u5907\u5b8c\u5168\u540c\u6b65\u201d\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u65f6\u5e8f\u56fe\u3002</p> <p></p> <p>\u56fe 5 \u4e3b\u5907\u6301\u7eed\u5ef6\u8fdf\u4e00\u4e2a\u4e8b\u52a1</p> <p>\u56fe 5 \u6240\u793a\uff0c\u5c31\u662f\u7b49\u5f85\u4f4d\u70b9\u65b9\u6848\u7684\u4e00\u4e2a bad case\u3002\u56fe\u4e2d\u5907\u5e93 B \u4e0b\u7684\u865a\u7ebf\u6846\uff0c\u5206\u522b\u8868\u793a relaylog \u548c binlog \u4e2d\u7684\u4e8b\u52a1\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u56fe 5 \u4e2d\u4ece\u72b6\u6001 1 \u5230\u72b6\u6001 4\uff0c\u4e00\u76f4\u5904\u4e8e\u5ef6\u8fdf\u4e00\u4e2a\u4e8b\u52a1\u7684\u72b6\u6001\u3002</p> <p>\u5907\u5e93 B \u4e00\u76f4\u5230\u72b6\u6001 4 \u90fd\u548c\u4e3b\u5e93 A \u5b58\u5728\u5ef6\u8fdf\uff0c\u5982\u679c\u7528\u4e0a\u9762\u5fc5\u987b\u7b49\u5230\u65e0\u5ef6\u8fdf\u624d\u80fd\u67e5\u8be2\u7684\u65b9\u6848\uff0cselect \u8bed\u53e5\u76f4\u5230\u72b6\u6001 4 \u90fd\u4e0d\u80fd\u88ab\u6267\u884c\u3002</p> <p>\u4f46\u662f\uff0c\u5176\u5b9e\u5ba2\u6237\u7aef\u662f\u5728\u53d1\u5b8c trx1 \u66f4\u65b0\u540e\u53d1\u8d77\u7684 select \u8bed\u53e5\uff0c\u6211\u4eec\u53ea\u9700\u8981\u786e\u4fdd trx1 \u5df2\u7ecf\u6267\u884c\u5b8c\u6210\u5c31\u53ef\u4ee5\u6267\u884c select \u8bed\u53e5\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5728\u72b6\u6001 3 \u6267\u884c\u67e5\u8be2\u8bf7\u6c42\uff0c\u5f97\u5230\u7684\u5c31\u662f\u9884\u671f\u7ed3\u679c\u4e86\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c0f\u7ed3\u4e00\u4e0b\uff0csemi-sync \u914d\u5408\u5224\u65ad\u4e3b\u5907\u65e0\u5ef6\u8fdf\u7684\u65b9\u6848\uff0c\u5b58\u5728\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u4e00\u4e3b\u591a\u4ece\u7684\u65f6\u5019\uff0c\u5728\u67d0\u4e9b\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u4f1a\u5b58\u5728\u8fc7\u671f\u8bfb\u7684\u73b0\u8c61\uff1b</li> <li>\u5728\u6301\u7eed\u5ef6\u8fdf\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u51fa\u73b0\u8fc7\u5ea6\u7b49\u5f85\u7684\u95ee\u9898\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u8981\u548c\u4f60\u4ecb\u7ecd\u7684\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e24\u4e2a\u95ee\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_29","title":"\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848","text":"<p>\u8981\u7406\u89e3\u7b49\u4e3b\u5e93\u4f4d\u70b9\u65b9\u6848\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u6761\u547d\u4ee4\uff1a</p> <pre><code>select master_pos_wait(file, pos[, timeout]);\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u7684\u903b\u8f91\u5982\u4e0b\uff1a</p> <ol> <li>\u5b83\u662f\u5728\u4ece\u5e93\u6267\u884c\u7684\uff1b</li> <li>\u53c2\u6570 file \u548c pos \u6307\u7684\u662f\u4e3b\u5e93\u4e0a\u7684\u6587\u4ef6\u540d\u548c\u4f4d\u7f6e\uff1b</li> <li>timeout \u53ef\u9009\uff0c\u8bbe\u7f6e\u4e3a\u6b63\u6574\u6570 N \u8868\u793a\u8fd9\u4e2a\u51fd\u6570\u6700\u591a\u7b49\u5f85 N \u79d2\u3002</li> </ol> <p>\u8fd9\u4e2a\u547d\u4ee4\u6b63\u5e38\u8fd4\u56de\u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u6b63\u6574\u6570 M\uff0c\u8868\u793a\u4ece\u547d\u4ee4\u5f00\u59cb\u6267\u884c\uff0c\u5230\u5e94\u7528\u5b8c file \u548c pos \u8868\u793a\u7684 binlog \u4f4d\u7f6e\uff0c\u6267\u884c\u4e86\u591a\u5c11\u4e8b\u52a1\u3002</p> <p>\u5f53\u7136\uff0c\u9664\u4e86\u6b63\u5e38\u8fd4\u56de\u4e00\u4e2a\u6b63\u6574\u6570 M \u5916\uff0c\u8fd9\u6761\u547d\u4ee4\u8fd8\u4f1a\u8fd4\u56de\u4e00\u4e9b\u5176\u4ed6\u7ed3\u679c\uff0c\u5305\u62ec\uff1a</p> <ol> <li>\u5982\u679c\u6267\u884c\u671f\u95f4\uff0c\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u8fd4\u56de NULL\uff1b</li> <li>\u5982\u679c\u7b49\u5f85\u8d85\u8fc7 N \u79d2\uff0c\u5c31\u8fd4\u56de -1\uff1b</li> <li>\u5982\u679c\u521a\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53d1\u73b0\u5df2\u7ecf\u6267\u884c\u8fc7\u8fd9\u4e2a\u4f4d\u7f6e\u4e86\uff0c\u5219\u8fd4\u56de 0\u3002</li> </ol> <p>\u5bf9\u4e8e\u56fe 5 \u4e2d\u5148\u6267\u884c trx1\uff0c\u518d\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u7684\u903b\u8f91\uff0c\u8981\u4fdd\u8bc1\u80fd\u591f\u67e5\u5230\u6b63\u786e\u7684\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u903b\u8f91\uff1a</p> <ol> <li>trx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u9a6c\u4e0a\u6267\u884c show master status \u5f97\u5230\u5f53\u524d\u4e3b\u5e93\u6267\u884c\u5230\u7684 File \u548c Position\uff1b</li> <li>\u9009\u5b9a\u4e00\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li> <li>\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>select master_pos_wait(File, Position, 1)</code>\uff1b</li> <li>\u5982\u679c\u8fd4\u56de\u503c\u662f &gt;=0 \u7684\u6b63\u6574\u6570\uff0c\u5219\u5728\u8fd9\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li> <li>\u5426\u5219\uff0c\u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u3002</li> </ol> <p>\u6211\u628a\u4e0a\u9762\u8fd9\u4e2a\u6d41\u7a0b\u753b\u51fa\u6765\u3002</p> <p></p> <p>\u56fe 6 <code>master_pos_wait</code> \u65b9\u6848</p> <p>\u8fd9\u91cc\u6211\u4eec\u5047\u8bbe\uff0c\u8fd9\u6761 select \u67e5\u8be2\u6700\u591a\u5728\u4ece\u5e93\u4e0a\u7b49\u5f85 1 \u79d2\u3002\u90a3\u4e48\uff0c\u5982\u679c 1 \u79d2\u5185 <code>master_pos_wait</code> \u8fd4\u56de\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e 0 \u7684\u6574\u6570\uff0c\u5c31\u786e\u4fdd\u4e86\u4ece\u5e93\u4e0a\u6267\u884c\u7684\u8fd9\u4e2a\u67e5\u8be2\u7ed3\u679c\u4e00\u5b9a\u5305\u542b\u4e86 trx1 \u7684\u6570\u636e\u3002</p> <p>\u6b65\u9aa4 5 \u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff0c\u662f\u8fd9\u7c7b\u65b9\u6848\u5e38\u7528\u7684\u9000\u5316\u673a\u5236\u3002\u56e0\u4e3a\u4ece\u5e93\u7684\u5ef6\u8fdf\u65f6\u95f4\u4e0d\u53ef\u63a7\uff0c\u4e0d\u80fd\u65e0\u9650\u7b49\u5f85\uff0c\u6240\u4ee5\u5982\u679c\u7b49\u5f85\u8d85\u65f6\uff0c\u5c31\u5e94\u8be5\u653e\u5f03\uff0c\u7136\u540e\u5230\u4e3b\u5e93\u53bb\u67e5\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u6240\u6709\u7684\u4ece\u5e93\u90fd\u5ef6\u8fdf\u8d85\u8fc7 1 \u79d2\u4e86\uff0c\u90a3\u67e5\u8be2\u538b\u529b\u4e0d\u5c31\u90fd\u8dd1\u5230\u4e3b\u5e93\u4e0a\u4e86\u5417\uff1f\u786e\u5b9e\u662f\u8fd9\u6837\u3002</p> <p>\u4f46\u662f\uff0c\u6309\u7167\u6211\u4eec\u8bbe\u5b9a\u4e0d\u5141\u8bb8\u8fc7\u671f\u8bfb\u7684\u8981\u6c42\uff0c\u5c31\u53ea\u6709\u4e24\u79cd\u9009\u62e9\uff0c\u4e00\u79cd\u662f\u8d85\u65f6\u653e\u5f03\uff0c\u4e00\u79cd\u662f\u8f6c\u5230\u4e3b\u5e93\u67e5\u8be2\u3002\u5177\u4f53\u600e\u4e48\u9009\u62e9\uff0c\u5c31\u9700\u8981\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u505a\u597d\u9650\u6d41\u7b56\u7565\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#gtid_2","title":"GTID \u65b9\u6848","text":"<p>\u5982\u679c\u4f60\u7684\u6570\u636e\u5e93\u5f00\u542f\u4e86 GTID \u6a21\u5f0f\uff0c\u5bf9\u5e94\u7684\u4e5f\u6709\u7b49\u5f85 GTID \u7684\u65b9\u6848\u3002</p> <p>MySQL \u4e2d\u540c\u6837\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7c7b\u4f3c\u7684\u547d\u4ee4\uff1a</p> <pre><code> select wait_for_executed_gtid_set(gtid_set, 1);\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u7684\u903b\u8f91\u662f\uff1a</p> <ol> <li>\u7b49\u5f85\uff0c\u76f4\u5230\u8fd9\u4e2a\u5e93\u6267\u884c\u7684\u4e8b\u52a1\u4e2d\u5305\u542b\u4f20\u5165\u7684 gtid_set\uff0c\u8fd4\u56de 0\uff1b</li> <li>\u8d85\u65f6\u8fd4\u56de 1\u3002</li> </ol> <p>\u5728\u524d\u9762\u7b49\u4f4d\u70b9\u7684\u65b9\u6848\u4e2d\uff0c\u6211\u4eec\u6267\u884c\u5b8c\u4e8b\u52a1\u540e\uff0c\u8fd8\u8981\u4e3b\u52a8\u53bb\u4e3b\u5e93\u6267\u884c <code>show master status</code>\u3002</p> <p>\u800c MySQL 5.7.6 \u7248\u672c\u5f00\u59cb\uff0c\u5141\u8bb8\u5728\u6267\u884c\u5b8c\u66f4\u65b0\u7c7b\u4e8b\u52a1\u540e\uff0c\u628a\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u7b49 GTID \u7684\u65b9\u6848\u5c31\u53ef\u4ee5\u51cf\u5c11\u4e00\u6b21\u67e5\u8be2\u3002</p> <p>\u8fd9\u65f6\uff0c\u7b49 GTID \u7684\u6267\u884c\u6d41\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p> <ol> <li>trx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u4ece\u8fd4\u56de\u5305\u76f4\u63a5\u83b7\u53d6\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID\uff0c\u8bb0\u4e3a gtid1\uff1b</li> <li>\u9009\u5b9a\u4e00\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li> <li>\u5728\u4ece\u5e93\u4e0a\u6267\u884c <code>select wait_for_executed_gtid_set(gtid1, 1)</code>\uff1b</li> <li>\u5982\u679c\u8fd4\u56de\u503c\u662f 0\uff0c\u5219\u5728\u8fd9\u4e2a\u4ece\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\uff1b</li> <li>\u5426\u5219\uff0c\u5230\u4e3b\u5e93\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u3002</li> </ol> <p>\u8ddf\u7b49\u4e3b\u5e93\u4f4d\u70b9\u7684\u65b9\u6848\u4e00\u6837\uff0c\u7b49\u5f85\u8d85\u65f6\u540e\u662f\u5426\u76f4\u63a5\u5230\u4e3b\u5e93\u67e5\u8be2\uff0c\u9700\u8981\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u6765\u505a\u9650\u6d41\u8003\u8651\u3002</p> <p>\u6211\u628a\u8fd9\u4e2a\u6d41\u7a0b\u56fe\u753b\u51fa\u6765\u3002</p> <p></p> <p>\u56fe 7 <code>wait_for_executed_gtid_set</code> \u65b9\u6848</p> <p>\u5728\u4e0a\u9762\u7684\u7b2c\u4e00\u6b65\u4e2d\uff0ctrx1 \u4e8b\u52a1\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u4ece\u8fd4\u56de\u5305\u76f4\u63a5\u83b7\u53d6\u8fd9\u4e2a\u4e8b\u52a1\u7684 GTID\u3002</p> <p>\u95ee\u9898\u662f\uff0c\u600e\u4e48\u80fd\u591f\u8ba9 MySQL \u5728\u6267\u884c\u4e8b\u52a1\u540e\uff0c\u8fd4\u56de\u5305\u4e2d\u5e26\u4e0a GTID \u5462\uff1f</p> <p>\u4f60\u53ea\u9700\u8981\u5c06\u53c2\u6570 <code>session_track_gtids</code> \u8bbe\u7f6e\u4e3a <code>OWN_GTID</code>\uff0c\u7136\u540e\u901a\u8fc7 API \u63a5\u53e3 <code>mysql_session_track_get_first</code> \u4ece\u8fd4\u56de\u5305\u89e3\u6790\u51fa GTID \u7684\u503c\u5373\u53ef\u3002</p> <p>\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4ecb\u7ecd <code>mysql_reset_connection</code> \u7684\u65f6\u5019\uff0c\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u7559\u8a00\u95ee\u8fd9\u7c7b\u63a5\u53e3\u5e94\u8be5\u600e\u4e48\u4f7f\u7528\u3002</p> <p>\u8fd9\u91cc\u6211\u518d\u56de\u7b54\u4e00\u4e0b\u3002\u5176\u5b9e\uff0cMySQL \u5e76\u6ca1\u6709\u63d0\u4f9b\u8fd9\u7c7b\u63a5\u53e3\u7684 SQL \u7528\u6cd5\uff0c\u662f\u63d0\u4f9b\u7ed9\u7a0b\u5e8f\u7684 API\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_30","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u4e00\u4e3b\u591a\u4ece\u505a\u8bfb\u5199\u5206\u79bb\u65f6\uff0c\u53ef\u80fd\u78b0\u5230\u8fc7\u671f\u8bfb\u7684\u539f\u56e0\uff0c\u4ee5\u53ca\u51e0\u79cd\u5e94\u5bf9\u7684\u65b9\u6848\u3002</p> <p>\u8fd9\u51e0\u79cd\u65b9\u6848\u4e2d\uff0c\u6709\u7684\u65b9\u6848\u770b\u4e0a\u53bb\u662f\u505a\u4e86\u59a5\u534f\uff0c\u6709\u7684\u65b9\u6848\u770b\u4e0a\u53bb\u4e0d\u90a3\u4e48\u9760\u8c31\u513f\uff0c\u4f46\u90fd\u662f\u6709\u5b9e\u9645\u5e94\u7528\u573a\u666f\u7684\uff0c\u4f60\u9700\u8981\u6839\u636e\u4e1a\u52a1\u9700\u6c42\u9009\u62e9\u3002</p> <p>\u5373\u4f7f\u662f\u6700\u540e\u7b49\u5f85\u4f4d\u70b9\u548c\u7b49\u5f85 GTID \u8fd9\u4e24\u4e2a\u65b9\u6848\uff0c\u867d\u7136\u770b\u4e0a\u53bb\u6bd4\u8f83\u9760\u8c31\u513f\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u9700\u8981\u6743\u8861\u7684\u60c5\u51b5\u3002\u5982\u679c\u6240\u6709\u7684\u4ece\u5e93\u90fd\u5ef6\u8fdf\uff0c\u90a3\u4e48\u8bf7\u6c42\u5c31\u4f1a\u5168\u90e8\u843d\u5230\u4e3b\u5e93\u4e0a\uff0c\u8fd9\u65f6\u5019\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u538b\u529b\u7a81\u7136\u589e\u5927\uff0c\u628a\u4e3b\u5e93\u6253\u6302\u4e86\u5462\uff1f</p> <p>\u5176\u5b9e\uff0c\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u8fd9\u51e0\u4e2a\u65b9\u6848\u662f\u53ef\u4ee5\u6df7\u5408\u4f7f\u7528\u7684\u3002</p> <p>\u6bd4\u5982\uff0c\u5148\u5728\u5ba2\u6237\u7aef\u5bf9\u8bf7\u6c42\u505a\u5206\u7c7b\uff0c\u533a\u5206\u54ea\u4e9b\u8bf7\u6c42\u53ef\u4ee5\u63a5\u53d7\u8fc7\u671f\u8bfb\uff0c\u800c\u54ea\u4e9b\u8bf7\u6c42\u5b8c\u5168\u4e0d\u80fd\u63a5\u53d7\u8fc7\u671f\u8bfb\uff1b\u7136\u540e\uff0c\u5bf9\u4e8e\u4e0d\u80fd\u63a5\u53d7\u8fc7\u671f\u8bfb\u7684\u8bed\u53e5\uff0c\u518d\u4f7f\u7528\u7b49 GTID \u6216\u7b49\u4f4d\u70b9\u7684\u65b9\u6848\u3002</p> <p>\u4f46\u8bdd\u8bf4\u56de\u6765\uff0c\u8fc7\u671f\u8bfb\u5728\u672c\u8d28\u4e0a\u662f\u7531\u4e00\u5199\u591a\u8bfb\u5bfc\u81f4\u7684\u3002\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u53ef\u80fd\u4f1a\u6709\u522b\u7684\u4e0d\u9700\u8981\u7b49\u5f85\u5c31\u53ef\u4ee5\u6c34\u5e73\u6269\u5c55\u7684\u6570\u636e\u5e93\u65b9\u6848\uff0c\u4f46\u8fd9\u5f80\u5f80\u662f\u7528\u727a\u7272\u5199\u6027\u80fd\u6362\u6765\u7684\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u8bfb\u6027\u80fd\u548c\u5199\u6027\u80fd\u4e2d\u53d6\u6743\u8861\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#29","title":"29 \u5982\u4f55\u5224\u65ad\u4e00\u4e2a\u6570\u636e\u5e93\u662f\u4e0d\u662f\u51fa\u95ee\u9898\u4e86\uff1f","text":"<p>\u524d\u9762\u6587\u7ae0\u4e2d\uff0c\u4ecb\u7ecd\u4e86\u4e3b\u5907\u5207\u6362\u6d41\u7a0b\u3002\u901a\u8fc7\u8fd9\u4e9b\u5185\u5bb9\u7684\u8bb2\u89e3\uff0c\u4f60\u5e94\u8be5\u5df2\u7ecf\u5f88\u6e05\u695a\u4e86\uff1a\u5728\u4e00\u4e3b\u4e00\u5907\u7684\u53cc M \u67b6\u6784\u91cc\uff0c\u4e3b\u5907\u5207\u6362\u53ea\u9700\u8981\u628a\u5ba2\u6237\u7aef\u6d41\u91cf\u5207\u5230\u5907\u5e93\uff1b\u800c\u5728\u4e00\u4e3b\u591a\u4ece\u67b6\u6784\u91cc\uff0c\u4e3b\u5907\u5207\u6362\u9664\u4e86\u8981\u628a\u5ba2\u6237\u7aef\u6d41\u91cf\u5207\u5230\u5907\u5e93\u5916\uff0c\u8fd8\u9700\u8981\u628a\u4ece\u5e93\u63a5\u5230\u65b0\u4e3b\u5e93\u4e0a\u3002</p> <p>\u4e3b\u5907\u5207\u6362\u6709\u4e24\u79cd\u573a\u666f\uff0c\u4e00\u79cd\u662f\u4e3b\u52a8\u5207\u6362\uff0c\u4e00\u79cd\u662f\u88ab\u52a8\u5207\u6362\u3002\u800c\u5176\u4e2d\u88ab\u52a8\u5207\u6362\uff0c\u5f80\u5f80\u662f\u56e0\u4e3a\u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff0c\u7531 HA \u7cfb\u7edf\u53d1\u8d77\u7684\u3002</p> <p>\u8fd9\u4e5f\u5c31\u5f15\u51fa\u4e86\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u95ee\u9898\uff1a\u600e\u4e48\u5224\u65ad\u4e00\u4e2a\u4e3b\u5e93\u51fa\u95ee\u9898\u4e86\uff1f</p> <p>\u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u5f88\u7b80\u5355\u554a\uff0c\u8fde\u4e0a MySQL\uff0c\u6267\u884c\u4e2a select 1 \u5c31\u597d\u4e86\u3002\u4f46\u662f select 1 \u6210\u529f\u8fd4\u56de\u4e86\uff0c\u5c31\u8868\u793a\u4e3b\u5e93\u6ca1\u95ee\u9898\u5417\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#select-1","title":"select 1 \u5224\u65ad","text":"<p>\u5b9e\u9645\u4e0a\uff0cselect 1 \u6210\u529f\u8fd4\u56de\uff0c\u53ea\u80fd\u8bf4\u660e\u8fd9\u4e2a\u5e93\u7684\u8fdb\u7a0b\u8fd8\u5728\uff0c\u5e76\u4e0d\u80fd\u8bf4\u660e\u4e3b\u5e93\u6ca1\u95ee\u9898\u3002\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\u3002</p> <pre><code>set global innodb_thread_concurrency=3; \nCREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \n insert into t values(1,1)\n</code></pre> session A session B session C session D select sleep(100) from t; select sleep(100) from t; select sleep(100) from t; select 1;(Query OK)select * from t;(blocked) <p>\u6211\u4eec\u8bbe\u7f6e <code>innodb_thread_concurrency</code> \u53c2\u6570\u7684\u76ee\u7684\u662f\uff0c\u63a7\u5236 InnoDB \u7684\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u65e6\u5e76\u53d1\u7ebf\u7a0b\u6570\u8fbe\u5230\u8fd9\u4e2a\u503c\uff0cInnoDB \u5728\u63a5\u6536\u5230\u65b0\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\uff0c\u76f4\u5230\u6709\u7ebf\u7a0b\u9000\u51fa\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u628a <code>innodb_thread_concurrency</code> \u8bbe\u7f6e\u6210 3\uff0c\u8868\u793a InnoDB \u53ea\u5141\u8bb8 3 \u4e2a\u7ebf\u7a0b\u5e76\u884c\u6267\u884c\u3002\u800c\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u524d\u4e09\u4e2a session \u4e2d\u7684 sleep(100)\uff0c\u4f7f\u5f97\u8fd9\u4e09\u4e2a\u8bed\u53e5\u90fd\u5904\u4e8e\u201c\u6267\u884c\u201d\u72b6\u6001\uff0c\u4ee5\u6b64\u6765\u6a21\u62df\u5927\u67e5\u8be2\u3002</p> <p>\u4f60\u770b\u5230\u4e86\uff0c session D \u91cc\u9762\uff0cselect 1 \u662f\u80fd\u6267\u884c\u6210\u529f\u7684\uff0c\u4f46\u662f\u67e5\u8be2\u8868 t \u7684\u8bed\u53e5\u4f1a\u88ab\u5835\u4f4f\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u6211\u4eec\u7528 select 1 \u6765\u68c0\u6d4b\u5b9e\u4f8b\u662f\u5426\u6b63\u5e38\u7684\u8bdd\uff0c\u662f\u68c0\u6d4b\u4e0d\u51fa\u95ee\u9898\u7684\u3002</p> <p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_thread_concurrency</code> \u8fd9\u4e2a\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u662f 0\uff0c\u8868\u793a\u4e0d\u9650\u5236\u5e76\u53d1\u7ebf\u7a0b\u6570\u91cf\u3002\u4f46\u662f\uff0c\u4e0d\u9650\u5236\u5e76\u53d1\u7ebf\u7a0b\u6570\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002\u56e0\u4e3a\uff0c\u4e00\u4e2a\u673a\u5668\u7684 CPU \u6838\u6570\u6709\u9650\uff0c\u7ebf\u7a0b\u5168\u51b2\u8fdb\u6765\uff0c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u6210\u672c\u5c31\u4f1a\u592a\u9ad8\u3002</p> <p>\u6240\u4ee5\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5efa\u8bae\u628a <code>innodb_thread_concurrency</code> \u8bbe\u7f6e\u4e3a 64~128 \u4e4b\u95f4\u7684\u503c\u3002\u8fd9\u65f6\uff0c\u4f60\u4e00\u5b9a\u4f1a\u6709\u7591\u95ee\uff0c\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u6570\u8bbe\u7f6e\u4e3a 128 \u591f\u5e72\u5565\uff0c\u7ebf\u4e0a\u7684\u5e76\u53d1\u8fde\u63a5\u6570\u52a8\u4e0d\u52a8\u5c31\u4e0a\u5343\u4e86\u3002</p> <p>\u4ea7\u751f\u8fd9\u4e2a\u7591\u95ee\u7684\u539f\u56e0\uff0c\u662f\u641e\u6df7\u4e86**\u5e76\u53d1\u8fde\u63a5\u548c\u5e76\u53d1\u67e5\u8be2\u3002**</p> <p>\u5e76\u53d1\u8fde\u63a5\u548c\u5e76\u53d1\u67e5\u8be2\uff0c\u5e76\u4e0d\u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002\u4f60\u5728 <code>show processlist</code> \u7684\u7ed3\u679c\u91cc\uff0c\u770b\u5230\u7684\u51e0\u5343\u4e2a\u8fde\u63a5\uff0c\u6307\u7684\u5c31\u662f\u5e76\u53d1\u8fde\u63a5\u3002\u800c\u201c\u5f53\u524d\u6b63\u5728\u6267\u884c\u201d\u7684\u8bed\u53e5\uff0c\u624d\u662f\u6211\u4eec\u6240\u8bf4\u7684\u5e76\u53d1\u67e5\u8be2\u3002</p> <p>\u5e76\u53d1\u8fde\u63a5\u6570\u8fbe\u5230\u51e0\u5343\u4e2a\u5f71\u54cd\u5e76\u4e0d\u5927\uff0c\u5c31\u662f\u591a\u5360\u4e00\u4e9b\u5185\u5b58\u800c\u5df2\u3002\u6211\u4eec\u5e94\u8be5\u5173\u6ce8\u7684\u662f\u5e76\u53d1\u67e5\u8be2\uff0c\u56e0\u4e3a\u5e76\u53d1\u67e5\u8be2\u592a\u9ad8\u624d\u662f CPU \u6740\u624b\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981\u8bbe\u7f6e <code>innodb_thread_concurrency</code> \u53c2\u6570\u7684\u539f\u56e0\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u5728\u7ebf\u7a0b\u8fdb\u5165\u9501\u7b49\u5f85\u4ee5\u540e\uff0c\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u4f1a\u51cf\u4e00\uff0c\u4e5f\u5c31\u662f\u8bf4\u7b49\u884c\u9501\uff08\u4e5f\u5305\u62ec\u95f4\u9699\u9501\uff09\u7684\u7ebf\u7a0b\u662f\u4e0d\u7b97\u5728 128 \u91cc\u9762\u7684\u3002</p> <p>MySQL \u8fd9\u6837\u8bbe\u8ba1\u662f\u975e\u5e38\u6709\u610f\u4e49\u7684\u3002\u56e0\u4e3a\uff0c\u8fdb\u5165\u9501\u7b49\u5f85\u7684\u7ebf\u7a0b\u5df2\u7ecf\u4e0d\u5403 CPU \u4e86\uff1b\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5fc5\u987b\u8fd9\u4e48\u8bbe\u8ba1\uff0c\u624d\u80fd\u907f\u514d\u6574\u4e2a\u7cfb\u7edf\u9501\u6b7b\u3002</p> <p>\u4e3a\u4ec0\u4e48\u5462\uff1f\u5047\u8bbe\u5904\u4e8e\u9501\u7b49\u5f85\u7684\u7ebf\u7a0b\u4e5f\u5360\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\uff0c\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\uff1a</p> <ol> <li>\u7ebf\u7a0b 1 \u6267\u884c <code>begin; update t set c=c+1 where id=1</code>, \u542f\u52a8\u4e86\u4e8b\u52a1 trx1\uff0c \u7136\u540e\u4fdd\u6301\u8fd9\u4e2a\u72b6\u6001\u3002\u8fd9\u65f6\u5019\uff0c\u7ebf\u7a0b\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4e0d\u7b97\u5728\u5e76\u53d1\u7ebf\u7a0b\u91cc\u9762\u3002</li> <li>\u7ebf\u7a0b 2 \u5230\u7ebf\u7a0b 129 \u90fd\u6267\u884c <code>update t set c=c+1 where id=1</code>; \u7531\u4e8e\u7b49\u884c\u9501\uff0c\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002\u8fd9\u6837\u5c31\u6709 128 \u4e2a\u7ebf\u7a0b\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff1b</li> <li>\u5982\u679c\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\u7684\u7ebf\u7a0b\u8ba1\u6570\u4e0d\u51cf\u4e00\uff0cInnoDB \u5c31\u4f1a\u8ba4\u4e3a\u7ebf\u7a0b\u6570\u7528\u6ee1\u4e86\uff0c\u4f1a\u963b\u6b62\u5176\u4ed6\u8bed\u53e5\u8fdb\u5165\u5f15\u64ce\u6267\u884c\uff0c\u8fd9\u6837\u7ebf\u7a0b 1 \u4e0d\u80fd\u63d0\u4ea4\u4e8b\u52a1\u3002\u800c\u53e6\u5916\u7684 128 \u4e2a\u7ebf\u7a0b\u53c8\u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\uff0c\u6574\u4e2a\u7cfb\u7edf\u5c31\u5835\u4f4f\u4e86\u3002</li> </ol> <p>\u4e0b\u56fe 2 \u663e\u793a\u7684\u5c31\u662f\u8fd9\u4e2a\u72b6\u6001\u3002</p> <p></p> <p>\u56fe 2 \u7cfb\u7edf\u9501\u6b7b\u72b6\u6001\uff08\u5047\u8bbe\u7b49\u884c\u9501\u7684\u8bed\u53e5\u5360\u7528\u5e76\u53d1\u8ba1\u6570\uff09</p> <p>\u8fd9\u65f6\u5019 InnoDB \u4e0d\u80fd\u54cd\u5e94\u4efb\u4f55\u8bf7\u6c42\uff0c\u6574\u4e2a\u7cfb\u7edf\u88ab\u9501\u6b7b\u3002\u800c\u4e14\uff0c\u7531\u4e8e\u6240\u6709\u7ebf\u7a0b\u90fd\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u6b64\u65f6\u5360\u7528\u7684 CPU \u5374\u662f 0\uff0c\u800c\u8fd9\u660e\u663e\u4e0d\u5408\u7406\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u8bf4 InnoDB \u5728\u8bbe\u8ba1\u65f6\uff0c\u9047\u5230\u8fdb\u7a0b\u8fdb\u5165\u9501\u7b49\u5f85\u7684\u60c5\u51b5\u65f6\uff0c\u5c06\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u51cf 1 \u7684\u8bbe\u8ba1\uff0c\u662f\u5408\u7406\u800c\u4e14\u662f\u5fc5\u8981\u7684\u3002</p> <p>\u867d\u7136\u8bf4\u7b49\u9501\u7684\u7ebf\u7a0b\u4e0d\u7b97\u5728\u5e76\u53d1\u7ebf\u7a0b\u8ba1\u6570\u91cc\uff0c\u4f46\u5982\u679c\u5b83\u5728\u771f\u6b63\u5730\u6267\u884c\u67e5\u8be2\uff0c\u5c31\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u4f8b\u5b50\u4e2d\u524d\u4e09\u4e2a\u4e8b\u52a1\u4e2d\u7684 <code>select sleep(100) from t</code>\uff0c\u8fd8\u662f\u8981\u7b97\u8fdb\u5e76\u53d1\u7ebf\u7a0b\u7684\u8ba1\u6570\u7684\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u540c\u65f6\u5728\u6267\u884c\u7684\u8bed\u53e5\u8d85\u8fc7\u4e86\u8bbe\u7f6e\u7684 <code>innodb_thread_concurrency</code> \u7684\u503c\uff0c\u8fd9\u65f6\u5019\u7cfb\u7edf\u5176\u5b9e\u5df2\u7ecf\u4e0d\u884c\u4e86\uff0c\u4f46\u662f\u901a\u8fc7 select 1 \u6765\u68c0\u6d4b\u7cfb\u7edf\uff0c\u4f1a\u8ba4\u4e3a\u7cfb\u7edf\u8fd8\u662f\u6b63\u5e38\u7684\u3002</p> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u4f7f\u7528 select 1 \u7684\u5224\u65ad\u903b\u8f91\u8981\u4fee\u6539\u4e00\u4e0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_31","title":"\u67e5\u8868\u5224\u65ad","text":"<p>\u4e3a\u4e86\u80fd\u591f\u68c0\u6d4b InnoDB \u5e76\u53d1\u7ebf\u7a0b\u6570\u8fc7\u591a\u5bfc\u81f4\u7684\u7cfb\u7edf\u4e0d\u53ef\u7528\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u627e\u4e00\u4e2a\u8bbf\u95ee InnoDB \u7684\u573a\u666f\u3002\u4e00\u822c\u7684\u505a\u6cd5\u662f\uff0c\u5728\u7cfb\u7edf\u5e93\uff08mysql \u5e93\uff09\u91cc\u521b\u5efa\u4e00\u4e2a\u8868\uff0c\u6bd4\u5982\u547d\u540d\u4e3a health_check\uff0c\u91cc\u9762\u53ea\u653e\u4e00\u884c\u6570\u636e\uff0c\u7136\u540e\u5b9a\u671f\u6267\u884c\uff1a</p> <pre><code>mysql&gt; select * from mysql.health_check; \n</code></pre> <p>\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4b\u51fa\u7531\u4e8e\u5e76\u53d1\u7ebf\u7a0b\u8fc7\u591a\u5bfc\u81f4\u7684\u6570\u636e\u5e93\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u9a6c\u4e0a\u8fd8\u4f1a\u78b0\u5230\u4e0b\u4e00\u4e2a\u95ee\u9898\uff0c\u5373\uff1a\u7a7a\u95f4\u6ee1\u4e86\u4ee5\u540e\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53c8\u4f1a\u53d8\u5f97\u4e0d\u597d\u4f7f\u3002</p> <p>\u6211\u4eec\u77e5\u9053\uff0c\u66f4\u65b0\u4e8b\u52a1\u8981\u5199 binlog\uff0c\u800c\u4e00\u65e6 binlog \u6240\u5728\u78c1\u76d8\u7684\u7a7a\u95f4\u5360\u7528\u7387\u8fbe\u5230 100%\uff0c\u90a3\u4e48\u6240\u6709\u7684\u66f4\u65b0\u8bed\u53e5\u548c\u4e8b\u52a1\u63d0\u4ea4\u7684 commit \u8bed\u53e5\u5c31\u90fd\u4f1a\u88ab\u5835\u4f4f\u3002\u4f46\u662f\uff0c\u7cfb\u7edf\u8fd9\u65f6\u5019\u8fd8\u662f\u53ef\u4ee5\u6b63\u5e38\u8bfb\u6570\u636e\u7684\u3002</p> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u8fd8\u662f\u628a\u8fd9\u6761\u76d1\u63a7\u8bed\u53e5\u518d\u6539\u8fdb\u4e00\u4e0b\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u770b\u770b\u628a\u67e5\u8be2\u8bed\u53e5\u6539\u6210\u66f4\u65b0\u8bed\u53e5\u540e\u7684\u6548\u679c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_32","title":"\u66f4\u65b0\u5224\u65ad","text":"<p>\u65e2\u7136\u8981\u66f4\u65b0\uff0c\u5c31\u8981\u653e\u4e2a\u6709\u610f\u4e49\u7684\u5b57\u6bb5\uff0c\u5e38\u89c1\u505a\u6cd5\u662f\u653e\u4e00\u4e2a timestamp \u5b57\u6bb5\uff0c\u7528\u6765\u8868\u793a\u6700\u540e\u4e00\u6b21\u6267\u884c\u68c0\u6d4b\u7684\u65f6\u95f4\u3002\u8fd9\u6761\u66f4\u65b0\u8bed\u53e5\u7c7b\u4f3c\u4e8e\uff1a</p> <pre><code>mysql&gt; update mysql.health_check set t_modified=now();\n</code></pre> <p>\u8282\u70b9\u53ef\u7528\u6027\u7684\u68c0\u6d4b\u90fd\u5e94\u8be5\u5305\u542b\u4e3b\u5e93\u548c\u5907\u5e93\u3002\u5982\u679c\u7528\u66f4\u65b0\u6765\u68c0\u6d4b\u4e3b\u5e93\u7684\u8bdd\uff0c\u90a3\u4e48\u5907\u5e93\u4e5f\u8981\u8fdb\u884c\u66f4\u65b0\u68c0\u6d4b\u3002</p> <p>\u4f46\uff0c\u5907\u5e93\u7684\u68c0\u6d4b\u4e5f\u662f\u8981\u5199 binlog \u7684\u3002\u7531\u4e8e\u6211\u4eec\u4e00\u822c\u4f1a\u628a\u6570\u636e\u5e93 A \u548c B \u7684\u4e3b\u5907\u5173\u7cfb\u8bbe\u8ba1\u4e3a\u53cc M \u7ed3\u6784\uff0c\u6240\u4ee5\u5728\u5907\u5e93 B \u4e0a\u6267\u884c\u7684\u68c0\u6d4b\u547d\u4ee4\uff0c\u4e5f\u8981\u53d1\u56de\u7ed9\u4e3b\u5e93 A\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4e3b\u5e93 A \u548c\u5907\u5e93 B \u90fd\u7528\u76f8\u540c\u7684\u66f4\u65b0\u547d\u4ee4\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u884c\u51b2\u7a81\uff0c\u4e5f\u5c31\u662f\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002\u6240\u4ee5\uff0c\u73b0\u5728\u770b\u6765 <code>mysql.health_check</code> \u8fd9\u4e2a\u8868\u5c31\u4e0d\u80fd\u53ea\u6709\u4e00\u884c\u6570\u636e\u4e86\u3002</p> <p>\u4e3a\u4e86\u8ba9\u4e3b\u5907\u4e4b\u95f4\u7684\u66f4\u65b0\u4e0d\u4ea7\u751f\u51b2\u7a81\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 mysql.health_check \u8868\u4e0a\u5b58\u5165\u591a\u884c\u6570\u636e\uff0c\u5e76\u7528 A\u3001B \u7684 server_id \u505a\u4e3b\u952e\u3002</p> <pre><code>mysql&gt; CREATE TABLE `health_check` (\n  `id` int(11) NOT NULL,\n  `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \n/* \u68c0\u6d4b\u547d\u4ee4 */\ninsert into mysql.health_check(id, t_modified) values (@@server_id, now()) on duplicate key update t_modified=now();\n</code></pre> <p>\u7531\u4e8e MySQL \u89c4\u5b9a\u4e86\u4e3b\u5e93\u548c\u5907\u5e93\u7684 server_id \u5fc5\u987b\u4e0d\u540c\uff08\u5426\u5219\u521b\u5efa\u4e3b\u5907\u5173\u7cfb\u7684\u65f6\u5019\u5c31\u4f1a\u62a5\u9519\uff09\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u4e3b\u3001\u5907\u5e93\u5404\u81ea\u7684\u68c0\u6d4b\u547d\u4ee4\u4e0d\u4f1a\u53d1\u751f\u51b2\u7a81\u3002</p> <p>\u66f4\u65b0\u5224\u65ad\u662f\u4e00\u4e2a\u76f8\u5bf9\u6bd4\u8f83\u5e38\u7528\u7684\u65b9\u6848\u4e86\uff0c\u4e0d\u8fc7\u4f9d\u7136\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\u3002\u5176\u4e2d\uff0c\u201c\u5224\u5b9a\u6162\u201d\u4e00\u76f4\u662f\u8ba9 DBA \u5934\u75bc\u7684\u95ee\u9898\u3002</p> <p>\u4f60\u4e00\u5b9a\u4f1a\u7591\u60d1\uff0c\u66f4\u65b0\u8bed\u53e5\uff0c\u5982\u679c\u5931\u8d25\u6216\u8005\u8d85\u65f6\uff0c\u5c31\u53ef\u4ee5\u53d1\u8d77\u4e3b\u5907\u5207\u6362\u4e86\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u4f1a\u6709\u5224\u5b9a\u6162\u7684\u95ee\u9898\u5462\uff1f</p> <p>\u5176\u5b9e\uff0c\u8fd9\u91cc\u6d89\u53ca\u5230\u7684\u662f\u670d\u52a1\u5668 IO \u8d44\u6e90\u5206\u914d\u7684\u95ee\u9898\u3002</p> <p>\u9996\u5148\uff0c\u6240\u6709\u7684\u68c0\u6d4b\u903b\u8f91\u90fd\u9700\u8981\u4e00\u4e2a\u8d85\u65f6\u65f6\u95f4 N\u3002\u6267\u884c\u4e00\u6761 update \u8bed\u53e5\uff0c\u8d85\u8fc7 N \u79d2\u540e\u8fd8\u4e0d\u8fd4\u56de\uff0c\u5c31\u8ba4\u4e3a\u7cfb\u7edf\u4e0d\u53ef\u7528\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e2a\u65e5\u5fd7\u76d8\u7684 IO \u5229\u7528\u7387\u5df2\u7ecf\u662f 100% \u7684\u573a\u666f\u3002\u8fd9\u65f6\u5019\uff0c\u6574\u4e2a\u7cfb\u7edf\u54cd\u5e94\u975e\u5e38\u6162\uff0c\u5df2\u7ecf\u9700\u8981\u505a\u4e3b\u5907\u5207\u6362\u4e86\u3002</p> <p>\u4f46\u662f\u4f60\u8981\u77e5\u9053\uff0cIO \u5229\u7528\u7387 100% \u8868\u793a\u7cfb\u7edf\u7684 IO \u662f\u5728\u5de5\u4f5c\u7684\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u6709\u673a\u4f1a\u83b7\u5f97 IO \u8d44\u6e90\uff0c\u6267\u884c\u81ea\u5df1\u7684\u4efb\u52a1\u3002\u800c\u6211\u4eec\u7684\u68c0\u6d4b\u4f7f\u7528\u7684 update \u547d\u4ee4\uff0c\u9700\u8981\u7684\u8d44\u6e90\u5f88\u5c11\uff0c\u6240\u4ee5\u53ef\u80fd\u5728\u62ff\u5230 IO \u8d44\u6e90\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u63d0\u4ea4\u6210\u529f\uff0c\u5e76\u4e14\u5728\u8d85\u65f6\u65f6\u95f4 N \u79d2\u672a\u5230\u8fbe\u4e4b\u524d\u5c31\u8fd4\u56de\u7ed9\u4e86\u68c0\u6d4b\u7cfb\u7edf\u3002</p> <p>\u68c0\u6d4b\u7cfb\u7edf\u4e00\u770b\uff0cupdate \u547d\u4ee4\u6ca1\u6709\u8d85\u65f6\uff0c\u4e8e\u662f\u5c31\u5f97\u5230\u4e86\u201c\u7cfb\u7edf\u6b63\u5e38\u201d\u7684\u7ed3\u8bba\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u65f6\u5019\u5728\u4e1a\u52a1\u7cfb\u7edf\u4e0a\u6b63\u5e38\u7684 SQL \u8bed\u53e5\u5df2\u7ecf\u6267\u884c\u5f97\u5f88\u6162\u4e86\uff0c\u4f46\u662f DBA \u4e0a\u53bb\u4e00\u770b\uff0cHA \u7cfb\u7edf\u8fd8\u5728\u6b63\u5e38\u5de5\u4f5c\uff0c\u5e76\u4e14\u8ba4\u4e3a\u4e3b\u5e93\u73b0\u5728\u5904\u4e8e\u53ef\u7528\u72b6\u6001\u3002</p> <p>\u4e4b\u6240\u4ee5\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u73b0\u8c61\uff0c\u6839\u672c\u539f\u56e0\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u7684\u6240\u6709\u65b9\u6cd5\uff0c\u90fd\u662f\u57fa\u4e8e\u5916\u90e8\u68c0\u6d4b\u7684\u3002\u5916\u90e8\u68c0\u6d4b\u5929\u7136\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u968f\u673a\u6027\u3002</p> <p>\u56e0\u4e3a\uff0c\u5916\u90e8\u68c0\u6d4b\u90fd\u9700\u8981\u5b9a\u65f6\u8f6e\u8be2\uff0c\u6240\u4ee5\u7cfb\u7edf\u53ef\u80fd\u5df2\u7ecf\u51fa\u95ee\u9898\u4e86\uff0c\u4f46\u662f\u5374\u9700\u8981\u7b49\u5230\u4e0b\u4e00\u4e2a\u68c0\u6d4b\u53d1\u8d77\u6267\u884c\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u6211\u4eec\u624d\u6709\u53ef\u80fd\u53d1\u73b0\u95ee\u9898\u3002\u800c\u4e14\uff0c\u5982\u679c\u4f60\u7684\u8fd0\u6c14\u4e0d\u591f\u597d\u7684\u8bdd\uff0c\u53ef\u80fd\u7b2c\u4e00\u6b21\u8f6e\u8be2\u8fd8\u4e0d\u80fd\u53d1\u73b0\uff0c\u8fd9\u5c31\u4f1a\u5bfc\u81f4\u5207\u6362\u6162\u7684\u95ee\u9898\u3002</p> <p>\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\u6211\u8981\u518d\u548c\u4f60\u4ecb\u7ecd\u4e00\u79cd\u5728 MySQL \u5185\u90e8\u53d1\u73b0\u6570\u636e\u5e93\u95ee\u9898\u7684\u65b9\u6cd5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_33","title":"\u5185\u90e8\u7edf\u8ba1","text":"<p>\u9488\u5bf9\u78c1\u76d8\u5229\u7528\u7387\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c MySQL \u53ef\u4ee5\u544a\u8bc9\u6211\u4eec\uff0c\u5185\u90e8\u6bcf\u4e00\u6b21 IO \u8bf7\u6c42\u7684\u65f6\u95f4\uff0c\u90a3\u6211\u4eec\u5224\u65ad\u6570\u636e\u5e93\u662f\u5426\u51fa\u95ee\u9898\u7684\u65b9\u6cd5\u5c31\u53ef\u9760\u5f97\u591a\u4e86\u3002</p> <p>\u5176\u5b9e\uff0cMySQL 5.6 \u7248\u672c\u4ee5\u540e\u63d0\u4f9b\u7684 <code>performance_schema</code> \u5e93\uff0c\u5c31\u5728 <code>file_summary_by_event_name</code> \u8868\u91cc\u7edf\u8ba1\u4e86\u6bcf\u6b21 IO \u8bf7\u6c42\u7684\u65f6\u95f4\u3002</p> <p><code>file_summary_by_event_name</code> \u8868\u91cc\u6709\u5f88\u591a\u884c\u6570\u636e\uff0c\u6211\u4eec\u5148\u6765\u770b\u770b <code>event_name='wait/io/file/innodb/innodb_log_file\u2019</code>\u8fd9\u4e00\u884c\u3002</p> <pre><code>mysql&gt; select * from performance_schema.file_summary_by_event_name \n      where event_name = 'wait/io/file/innodb/innodb_log_file' \\G;\n*************************** 1. row ***************************\n               EVENT_NAME: wait/io/file/innodb/innodb_log_file\n               COUNT_STAR: 793403\n           SUM_TIMER_WAIT: 95887122719672\n           MIN_TIMER_WAIT: 871382\n           AVG_TIMER_WAIT: 120855468\n           MAX_TIMER_WAIT: 735743606690\n               COUNT_READ: 8\n           SUM_TIMER_READ: 33772444588\n           MIN_TIMER_READ: 1012608\n           AVG_TIMER_READ: 4221555427\n           MAX_TIMER_READ: 24994999638\n SUM_NUMBER_OF_BYTES_READ: 70656\n              COUNT_WRITE: 415313\n          SUM_TIMER_WRITE: 26836729823736\n          MIN_TIMER_WRITE: 2974536\n          AVG_TIMER_WRITE: 64617927\n          MAX_TIMER_WRITE: 228565239606\nSUM_NUMBER_OF_BYTES_WRITE: 345248256\n               COUNT_MISC: 378082\n           SUM_TIMER_MISC: 69016620451348\n           MIN_TIMER_MISC: 871382\n           AVG_TIMER_MISC: 182543981\n           MAX_TIMER_MISC: 735743606690\n1 row in set (0.01 sec)\n</code></pre> <p>\u56fe\u4e2d\u8fd9\u4e00\u884c\u8868\u793a\u7edf\u8ba1\u7684\u662f redo log \u7684\u5199\u5165\u65f6\u95f4\uff0c\u7b2c\u4e00\u5217 EVENT_NAME \u8868\u793a\u7edf\u8ba1\u7684\u7c7b\u578b\u3002</p> <p>\u63a5\u4e0b\u6765\u7684\u4e09\u7ec4\u6570\u636e\uff0c\u663e\u793a\u7684\u662f redo log \u64cd\u4f5c\u7684\u65f6\u95f4\u7edf\u8ba1\u3002</p> <p>\u7b2c\u4e00\u7ec4\u4e94\u5217\uff0c\u662f\u6240\u6709 IO \u7c7b\u578b\u7684\u7edf\u8ba1\u3002\u5176\u4e2d\uff0c<code>COUNT_STAR</code> \u662f\u6240\u6709 IO \u7684\u603b\u6b21\u6570\uff0c\u63a5\u4e0b\u6765\u56db\u5217\u662f\u5177\u4f53\u7684\u7edf\u8ba1\u9879\uff0c \u5355\u4f4d\u662f\u76ae\u79d2\uff1b\u524d\u7f00 SUM\u3001MIN\u3001AVG\u3001MAX\uff0c\u987e\u540d\u601d\u4e49\u6307\u7684\u5c31\u662f\u603b\u548c\u3001\u6700\u5c0f\u503c\u3001\u5e73\u5747\u503c\u548c\u6700\u5927\u503c\u3002</p> <p>\u7b2c\u4e8c\u7ec4\u516d\u5217\uff0c\u662f\u8bfb\u64cd\u4f5c\u7684\u7edf\u8ba1\u3002\u6700\u540e\u4e00\u5217 <code>SUM_NUMBER_OF_BYTES_READ</code> \u7edf\u8ba1\u7684\u662f\uff0c\u603b\u5171\u4ece redo log \u91cc\u8bfb\u4e86\u591a\u5c11\u4e2a\u5b57\u8282\u3002</p> <p>\u7b2c\u4e09\u7ec4\u516d\u5217\uff0c\u7edf\u8ba1\u7684\u662f\u5199\u64cd\u4f5c\u3002</p> <p>\u6700\u540e\u7684\u7b2c\u56db\u7ec4\u6570\u636e\uff0c\u662f\u5bf9\u5176\u4ed6\u7c7b\u578b\u6570\u636e\u7684\u7edf\u8ba1\u3002\u5728 redo log \u91cc\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u4eec\u5c31\u662f\u5bf9 fsync \u7684\u7edf\u8ba1\u3002</p> <p>\u5728 <code>performance_schema</code> \u5e93\u7684 <code>file_summary_by_event_name</code> \u8868\u91cc\uff0cbinlog \u5bf9\u5e94\u7684\u662f <code>event_name = 'wait/io/file/sql/binlog'</code>\u8fd9\u4e00\u884c\u3002\u5404\u4e2a\u5b57\u6bb5\u7684\u7edf\u8ba1\u903b\u8f91\uff0c\u4e0e redo log \u7684\u5404\u4e2a\u5b57\u6bb5\u5b8c\u5168\u76f8\u540c\u3002\u8fd9\u91cc\uff0c\u6211\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p> <p>\u56e0\u4e3a\u6211\u4eec\u6bcf\u4e00\u6b21\u64cd\u4f5c\u6570\u636e\u5e93\uff0c<code>performance_schema</code> \u90fd\u9700\u8981\u989d\u5916\u5730\u7edf\u8ba1\u8fd9\u4e9b\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u6253\u5f00\u8fd9\u4e2a\u7edf\u8ba1\u529f\u80fd\u662f\u6709\u6027\u80fd\u635f\u8017\u7684\u3002</p> <p>\u6211\u7684\u6d4b\u8bd5\u7ed3\u679c\u662f\uff0c\u5982\u679c\u6253\u5f00\u6240\u6709\u7684 <code>performance_schema</code> \u9879\uff0c\u6027\u80fd\u5927\u6982\u4f1a\u4e0b\u964d 10% \u5de6\u53f3\u3002\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u4f60\u53ea\u6253\u5f00\u81ea\u5df1\u9700\u8981\u7684\u9879\u8fdb\u884c\u7edf\u8ba1\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u65b9\u6cd5\u6253\u5f00\u6216\u8005\u5173\u95ed\u67d0\u4e2a\u5177\u4f53\u9879\u7684\u7edf\u8ba1\u3002</p> <p>\u5982\u679c\u8981\u6253\u5f00 redo log \u7684\u65f6\u95f4\u76d1\u63a7\uff0c\u4f60\u53ef\u4ee5\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; update setup_instruments set ENABLED='YES', Timed='YES' where name like '%wait/io/file/innodb/innodb_log_file%';\n</code></pre> <p>\u5047\u8bbe\uff0c\u73b0\u5728\u4f60\u5df2\u7ecf\u5f00\u542f\u4e86 redo log \u548c binlog \u8fd9\u4e24\u4e2a\u7edf\u8ba1\u4fe1\u606f\uff0c\u90a3\u8981\u600e\u4e48\u628a\u8fd9\u4e2a\u4fe1\u606f\u7528\u5728\u5b9e\u4f8b\u72b6\u6001\u8bca\u65ad\u4e0a\u5462\uff1f</p> <p>\u5f88\u7b80\u5355\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 MAX_TIMER \u7684\u503c\u6765\u5224\u65ad\u6570\u636e\u5e93\u662f\u5426\u51fa\u95ee\u9898\u4e86\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u8bbe\u5b9a\u9608\u503c\uff0c\u5355\u6b21 IO \u8bf7\u6c42\u65f6\u95f4\u8d85\u8fc7 200 \u6beb\u79d2\u5c5e\u4e8e\u5f02\u5e38\uff0c\u7136\u540e\u4f7f\u7528\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\u4f5c\u4e3a\u68c0\u6d4b\u903b\u8f91\u3002</p> <pre><code>mysql&gt; select event_name,MAX_TIMER_WAIT  FROM performance_schema.file_summary_by_event_name where event_name in ('wait/io/file/innodb/innodb_log_file','wait/io/file/sql/binlog') and MAX_TIMER_WAIT&gt;200*1000000000;\n</code></pre> <p>\u53d1\u73b0\u5f02\u5e38\u540e\uff0c\u53d6\u5230\u4f60\u9700\u8981\u7684\u4fe1\u606f\uff0c\u518d\u901a\u8fc7\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; truncate table performance_schema.file_summary_by_event_name;\n</code></pre> <p>\u628a\u4e4b\u524d\u7684\u7edf\u8ba1\u4fe1\u606f\u6e05\u7a7a\u3002\u8fd9\u6837\u5982\u679c\u540e\u9762\u7684\u76d1\u63a7\u4e2d\uff0c\u518d\u6b21\u51fa\u73b0\u8fd9\u4e2a\u5f02\u5e38\uff0c\u5c31\u53ef\u4ee5\u52a0\u5165\u76d1\u63a7\u7d2f\u79ef\u503c\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-3/#_34","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u68c0\u6d4b\u4e00\u4e2a MySQL \u5b9e\u4f8b\u5065\u5eb7\u72b6\u6001\u7684\u51e0\u79cd\u65b9\u6cd5\uff0c\u4ee5\u53ca\u5404\u79cd\u65b9\u6cd5\u5b58\u5728\u7684\u95ee\u9898\u548c\u6f14\u8fdb\u7684\u903b\u8f91\u3002</p> <p>\u4f60\u770b\u5b8c\u540e\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0cselect 1 \u8fd9\u6837\u7684\u65b9\u6cd5\u662f\u4e0d\u662f\u5df2\u7ecf\u88ab\u6dd8\u6c70\u4e86\u5462\uff0c\u4f46\u5b9e\u9645\u4e0a\u4f7f\u7528\u975e\u5e38\u5e7f\u6cdb\u7684 MHA\uff08Master High Availability\uff09\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u65b9\u6cd5\u3002</p> <p>MHA \u4e2d\u7684\u53e6\u4e00\u4e2a\u53ef\u9009\u65b9\u6cd5\u662f\u53ea\u505a\u8fde\u63a5\uff0c\u5c31\u662f \u201c\u5982\u679c\u8fde\u63a5\u6210\u529f\u5c31\u8ba4\u4e3a\u4e3b\u5e93\u6ca1\u95ee\u9898\u201d\u3002\u4e0d\u8fc7\u636e\u6211\u6240\u77e5\uff0c\u9009\u62e9\u8fd9\u4e2a\u65b9\u6cd5\u7684\u5f88\u5c11\u3002</p> <p>\u5176\u5b9e\uff0c\u6bcf\u4e2a\u6539\u8fdb\u7684\u65b9\u6848\uff0c\u90fd\u4f1a\u589e\u52a0\u989d\u5916\u635f\u8017\uff0c\u5e76\u4e0d\u80fd\u7528\u201c\u5bf9\u9519\u201d\u505a\u76f4\u63a5\u5224\u65ad\uff0c\u9700\u8981\u4f60\u6839\u636e\u4e1a\u52a1\u5b9e\u9645\u60c5\u51b5\u53bb\u505a\u6743\u8861\u3002</p> <p>\u6211\u4e2a\u4eba\u6bd4\u8f83\u503e\u5411\u7684\u65b9\u6848\uff0c\u662f\u4f18\u5148\u8003\u8651 update \u7cfb\u7edf\u8868\uff0c\u7136\u540e\u518d\u914d\u5408\u589e\u52a0\u68c0\u6d4b <code>performance_schema</code> \u7684\u4fe1\u606f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/","title":"\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u56db\u90e8\u5206","text":"<p>Source</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u56db\u90e8\u5206</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#30","title":"30 \u7b54\u7591\u6587\u7ae0\uff08\u4e8c\uff09\uff1a\u7528\u52a8\u6001\u7684\u89c2\u70b9\u770b\u52a0\u9501","text":"<p>\u524d\u9762\u7684\u6587\u7ae0\u4ecb\u7ecd\u4e86 InnoDB \u7684\u95f4\u9699\u9501\u3001next-key lock\uff0c\u4ee5\u53ca\u52a0\u9501\u89c4\u5219\u3002\u5728\u8fd9\u4e24\u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\uff0c\u51fa\u73b0\u4e86\u5f88\u591a\u9ad8\u8d28\u91cf\u7684\u7559\u8a00\u3002\u6211\u89c9\u5f97\u901a\u8fc7\u5206\u6790\u8fd9\u4e9b\u95ee\u9898\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u52a0\u6df1\u5bf9\u52a0\u9501\u89c4\u5219\u7684\u7406\u89e3\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u5c31\u4ece\u4e2d\u6311\u9009\u4e86\u51e0\u4e2a\u6709\u4ee3\u8868\u6027\u7684\u95ee\u9898\uff0c\u6784\u6210\u4e86\u4eca\u5929\u8fd9\u7bc7\u7b54\u7591\u6587\u7ae0\u7684\u4e3b\u9898\uff0c\u5373\uff1a\u7528\u52a8\u6001\u7684\u89c2\u70b9\u770b\u52a0\u9501\u3002</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u4f60\u7406\u89e3\uff0c\u6211\u4eec\u518d\u4e00\u8d77\u590d\u4e60\u4e00\u4e0b\u52a0\u9501\u89c4\u5219\u3002\u8fd9\u4e2a\u89c4\u5219\u4e2d\uff0c\u5305\u542b\u4e86\u4e24\u4e2a\u201c\u539f\u5219\u201d\u3001\u4e24\u4e2a\u201c\u4f18\u5316\u201d\u548c\u4e00\u4e2a\u201cbug\u201d\uff1a</p> <ul> <li>\u539f\u5219 1\uff1a\u52a0\u9501\u7684\u57fa\u672c\u5355\u4f4d\u662f next-key lock\u3002\u5e0c\u671b\u4f60\u8fd8\u8bb0\u5f97\uff0cnext-key lock \u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\u3002</li> <li>\u539f\u5219 2\uff1a\u67e5\u627e\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u5bf9\u8c61\u624d\u4f1a\u52a0\u9501\u3002</li> <li>\u4f18\u5316 1\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u7ed9\u552f\u4e00\u7d22\u5f15\u52a0\u9501\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u884c\u9501\u3002</li> <li>\u4f18\u5316 2\uff1a\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u65f6\u4e14\u6700\u540e\u4e00\u4e2a\u503c\u4e0d\u6ee1\u8db3\u7b49\u503c\u6761\u4ef6\u7684\u65f6\u5019\uff0cnext-key lock \u9000\u5316\u4e3a\u95f4\u9699\u9501\u3002</li> <li>\u4e00\u4e2a bug\uff1a\u552f\u4e00\u7d22\u5f15\u4e0a\u7684\u8303\u56f4\u67e5\u8be2\u4f1a\u8bbf\u95ee\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u4e2a\u503c\u4e3a\u6b62\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7684\u8ba8\u8bba\u8fd8\u662f\u57fa\u4e8e\u4e0b\u9762\u8fd9\u4e2a\u8868 t\uff1a</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `c` (`c`)\n) ENGINE=InnoDB; \ninsert into t values(0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25);\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_1","title":"\u4e0d\u7b49\u53f7\u6761\u4ef6\u91cc\u7684\u7b49\u503c\u67e5\u8be2","text":"<p>\u6709\u540c\u5b66\u5bf9\u201c\u7b49\u503c\u67e5\u8be2\u201d\u63d0\u51fa\u4e86\u7591\u95ee\uff1a\u7b49\u503c\u67e5\u8be2\u548c\u201c\u904d\u5386\u201d\u6709\u4ec0\u4e48\u533a\u522b\uff1f\u4e3a\u4ec0\u4e48\u6211\u4eec\u6587\u7ae0\u7684\u4f8b\u5b50\u91cc\u9762\uff0cwhere \u6761\u4ef6\u662f\u4e0d\u7b49\u53f7\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u91cc\u4e5f\u6709\u7b49\u503c\u67e5\u8be2\uff1f</p> <p>\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5206\u6790\u4e00\u4e0b\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\uff1a</p> <pre><code>begin;\nselect * from t where id&gt;9 and id&lt;12 order by id desc for update;\n</code></pre> <p>\u5229\u7528\u4e0a\u9762\u7684\u52a0\u9501\u89c4\u5219\uff0c\u6211\u4eec\u77e5\u9053\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u662f\u4e3b\u952e\u7d22\u5f15\u4e0a\u7684 (0,5]\u3001(5,10] \u548c (10, 15)\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cid=15 \u8fd9\u4e00\u884c\uff0c\u5e76\u6ca1\u6709\u88ab\u52a0\u4e0a\u884c\u9501\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u6211\u4eec\u8bf4\u52a0\u9501\u5355\u4f4d\u662f next-key lock\uff0c\u90fd\u662f\u524d\u5f00\u540e\u95ed\u533a\u95f4\uff0c\u4f46\u662f\u8fd9\u91cc\u7528\u5230\u4e86\u4f18\u5316 2\uff0c\u5373\u7d22\u5f15\u4e0a\u7684\u7b49\u503c\u67e5\u8be2\uff0c\u5411\u53f3\u904d\u5386\u7684\u65f6\u5019 id=15 \u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u6240\u4ee5 next-key lock \u9000\u5316\u4e3a\u4e86\u95f4\u9699\u9501 (10, 15)\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u7684\u67e5\u8be2\u8bed\u53e5\u4e2d where \u6761\u4ef6\u662f\u5927\u4e8e\u53f7\u548c\u5c0f\u4e8e\u53f7\uff0c\u8fd9\u91cc\u7684\u201c\u7b49\u503c\u67e5\u8be2\u201d\u53c8\u662f\u4ece\u54ea\u91cc\u6765\u7684\u5462\uff1f</p> <p>\u8981\u77e5\u9053\uff0c\u52a0\u9501\u52a8\u4f5c\u662f\u53d1\u751f\u5728\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\uff0c\u6240\u4ee5\u4f60\u5728\u5206\u6790\u52a0\u9501\u884c\u4e3a\u7684\u65f6\u5019\uff0c\u8981\u4ece\u7d22\u5f15\u4e0a\u7684\u6570\u636e\u7ed3\u6784\u5f00\u59cb\u3002\u8fd9\u91cc\uff0c\u6211\u518d\u628a\u8fd9\u4e2a\u8fc7\u7a0b\u62c6\u89e3\u4e00\u4e0b\u3002</p> <p>\u5982\u56fe 1 \u6240\u793a\uff0c\u662f\u8fd9\u4e2a\u8868\u7684\u7d22\u5f15 id \u7684\u793a\u610f\u56fe\u3002</p> (0,0,0) (5,5,5) (10,10,10) (15,15,15) (20,20,20) (25,25,25) <ol> <li>\u9996\u5148\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u8bed\u4e49\u662f order by id desc\uff0c\u8981\u62ff\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u6240\u6709\u884c\uff0c\u4f18\u5316\u5668\u5fc5\u987b\u5148\u627e\u5230\u201c\u7b2c\u4e00\u4e2a id\\&lt;12 \u7684\u503c\u201d\u3002</li> <li>\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u901a\u8fc7\u7d22\u5f15\u6811\u7684\u641c\u7d22\u8fc7\u7a0b\u5f97\u5230\u7684\uff0c\u5728\u5f15\u64ce\u5185\u90e8\uff0c\u5176\u5b9e\u662f\u8981\u627e\u5230 id=12 \u7684\u8fd9\u4e2a\u503c\uff0c\u53ea\u662f\u6700\u7ec8\u6ca1\u627e\u5230\uff0c\u4f46\u627e\u5230\u4e86 (10,15) \u8fd9\u4e2a\u95f4\u9699\u3002</li> <li>\u7136\u540e\u5411\u5de6\u904d\u5386\uff0c\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u4e0d\u662f\u7b49\u503c\u67e5\u8be2\u4e86\uff0c\u4f1a\u626b\u63cf\u5230 id=5 \u8fd9\u4e00\u884c\uff0c\u6240\u4ee5\u4f1a\u52a0\u4e00\u4e2a next-key lock (0,5]\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7\u6811\u641c\u7d22\u7684\u65b9\u5f0f\u5b9a\u4f4d\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u7528\u7684\u662f\u201c\u7b49\u503c\u67e5\u8be2\u201d\u7684\u65b9\u6cd5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_2","title":"\u7b49\u503c\u67e5\u8be2\u7684\u8fc7\u7a0b","text":"<p>\u4e0e\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5bf9\u5e94\u7684\uff0c\u662f @\u53d1\u6761\u6a59\u5b50\u540c\u5b66\u63d0\u51fa\u7684\u95ee\u9898\uff1a\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\u662f\u4ec0\u4e48\uff1f</p> <pre><code>begin;\nselect id from t where c in(5,20,10) lock in share mode;\n</code></pre> <p>\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u91cc\u7528\u7684\u662f in\uff0c\u6211\u4eec\u5148\u6765\u770b\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain select id from t where c in(5,20,10) lock in share mode;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+\n|  1 | SIMPLE      | t     | NULL       | range | c             | c    | 5       | NULL |    3 |   100.00 | Using where; Using index |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6761 in \u8bed\u53e5\u4f7f\u7528\u4e86\u7d22\u5f15 c \u5e76\u4e14 rows=3\uff0c\u8bf4\u660e\u8fd9\u4e09\u4e2a\u503c\u90fd\u662f\u901a\u8fc7 B+ \u6811\u641c\u7d22\u5b9a\u4f4d\u7684\u3002</p> <p>\u5728\u67e5\u627e c=5 \u7684\u65f6\u5019\uff0c\u5148\u9501\u4f4f\u4e86 (0,5]\u3002\u4f46\u662f\u56e0\u4e3a c \u4e0d\u662f\u552f\u4e00\u7d22\u5f15\uff0c\u4e3a\u4e86\u786e\u8ba4\u8fd8\u6709\u6ca1\u6709\u522b\u7684\u8bb0\u5f55 c=5\uff0c\u5c31\u8981\u5411\u53f3\u904d\u5386\uff0c\u627e\u5230 c=10 \u624d\u786e\u8ba4\u6ca1\u6709\u4e86\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6ee1\u8db3\u4f18\u5316 2\uff0c\u6240\u4ee5\u52a0\u4e86\u95f4\u9699\u9501 (5,10)\u3002</p> <p>\u540c\u6837\u7684\uff0c\u6267\u884c c=10 \u8fd9\u4e2a\u903b\u8f91\u7684\u65f6\u5019\uff0c\u52a0\u9501\u7684\u8303\u56f4\u662f (5,10] \u548c (10,15)\uff1b\u6267\u884c c=20 \u8fd9\u4e2a\u903b\u8f91\u7684\u65f6\u5019\uff0c\u52a0\u9501\u7684\u8303\u56f4\u662f (15,20] \u548c (20,25)\u3002</p> <p>\u901a\u8fc7\u8fd9\u4e2a\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u6761\u8bed\u53e5\u5728\u7d22\u5f15 c \u4e0a\u52a0\u7684\u4e09\u4e2a\u8bb0\u5f55\u9501\u7684\u987a\u5e8f\u662f\uff1a\u5148\u52a0 c=5 \u7684\u8bb0\u5f55\u9501\uff0c\u518d\u52a0 c=10 \u7684\u8bb0\u5f55\u9501\uff0c\u6700\u540e\u52a0 c=20 \u7684\u8bb0\u5f55\u9501\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u52a0\u9501\u8303\u56f4\uff0c\u4e0d\u5c31\u662f\u4ece (5,25) \u4e2d\u53bb\u6389 c=15 \u7684\u884c\u9501\u5417\uff1f\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u9ebb\u70e6\u5730\u5206\u6bb5\u8bf4\u5462\uff1f</p> <p>\u56e0\u4e3a\u6211\u8981\u8ddf\u4f60\u5f3a\u8c03\u8fd9\u4e2a\u8fc7\u7a0b\uff1a\u8fd9\u4e9b\u9501\u662f\u201c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e00\u4e2a\u4e00\u4e2a\u52a0\u7684\u201d\uff0c\u800c\u4e0d\u662f\u4e00\u6b21\u6027\u52a0\u4e0a\u53bb\u7684\u3002</p> <p>\u7406\u89e3\u4e86\u8fd9\u4e2a\u52a0\u9501\u8fc7\u7a0b\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u5206\u6790\u4e0b\u9762\u4f8b\u5b50\u4e2d\u7684\u6b7b\u9501\u95ee\u9898\u4e86\u3002</p> <p>\u5982\u679c\u540c\u65f6\u6709\u53e6\u5916\u4e00\u4e2a\u8bed\u53e5\uff0c\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p> <pre><code>select id from t where c in(5,20,10) order by c desc for update;\n</code></pre> <p>\u6b64\u65f6\u7684\u52a0\u9501\u8303\u56f4\uff0c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u6211\u4eec\u73b0\u5728\u90fd\u77e5\u9053\u95f4\u9699\u9501\u662f\u4e0d\u4e92\u9501\u7684\uff0c\u4f46\u662f\u8fd9\u4e24\u6761\u8bed\u53e5\u90fd\u4f1a\u5728\u7d22\u5f15 c \u4e0a\u7684 c=5\u300110\u300120 \u8fd9\u4e09\u884c\u8bb0\u5f55\u4e0a\u52a0\u8bb0\u5f55\u9501\u3002</p> <p>\u8fd9\u91cc\u4f60\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\uff0c\u7531\u4e8e\u8bed\u53e5\u91cc\u9762\u662f order by c desc\uff0c \u8fd9\u4e09\u4e2a\u8bb0\u5f55\u9501\u7684\u52a0\u9501\u987a\u5e8f\uff0c\u662f\u5148\u9501 c=20\uff0c\u7136\u540e c=10\uff0c\u6700\u540e\u662f c=5\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u6761\u8bed\u53e5\u8981\u52a0\u9501\u76f8\u540c\u7684\u8d44\u6e90\uff0c\u4f46\u662f\u52a0\u9501\u987a\u5e8f\u76f8\u53cd\u3002\u5f53\u8fd9\u4e24\u6761\u8bed\u53e5\u5e76\u53d1\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u6b7b\u9501\u3002</p> <p>\u5173\u4e8e\u6b7b\u9501\u7684\u4fe1\u606f\uff0cMySQL \u53ea\u4fdd\u7559\u4e86\u6700\u540e\u4e00\u4e2a\u6b7b\u9501\u7684\u73b0\u573a\uff0c\u4f46\u8fd9\u4e2a\u73b0\u573a\u8fd8\u662f\u4e0d\u5b8c\u5907\u7684\u3002</p> <p>\u6709\u540c\u5b66\u5728\u8bc4\u8bba\u533a\u7559\u8a00\u5230\uff0c\u5e0c\u671b\u6211\u80fd\u5c55\u5f00\u4e00\u4e0b\u600e\u4e48\u770b\u6b7b\u9501\u3002\u73b0\u5728\uff0c\u6211\u5c31\u6765\u7b80\u5355\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u7684\u6b7b\u9501\u73b0\u573a\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_3","title":"\u600e\u4e48\u770b\u6b7b\u9501\uff1f","text":"<p>\u4ee5\u4e0b \u662f\u5728\u51fa\u73b0\u6b7b\u9501\u540e\uff0c\u6267\u884c <code>show engine innodb status</code> \u547d\u4ee4\u5f97\u5230\u7684\u90e8\u5206\u8f93\u51fa\u3002\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u8f93\u51fa\u5f88\u591a\u4fe1\u606f\uff0c\u6709\u4e00\u8282 <code>LATESTDETECTED DEADLOCK</code>\uff0c\u5c31\u662f\u8bb0\u5f55\u7684\u6700\u540e\u4e00\u6b21\u6b7b\u9501\u4fe1\u606f\u3002</p> <pre><code>2019-01-09 19:21:11 0x7feb98d47700\n*** (1) TRANSACTION:\nTRANSACTION 422127109356256, ACTIVE 0 sec starting index read mysql tables in use 1, locked 1\nLOCK WAIT 4 lock struct (s), heap size 1136, 3 row lock(s)\nMySQL thread id 98, OS thread handle 140649857836800, query id 119190 localhost 127.0.0.1 root Sending data select id from t where c in(5,20,10) lock in share mode\n*** (1) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 24 page no 4 n bits 80 index c of table `test`.`t` trx id 422127109356256 lock mode S waiting\nRecord lock, heap no 4 PHYSICAL RECORD: _fields 2; compact format; info bits\n0: len 4; hex 0000000a; asc     ;;\n1: len 4; hex 0000000a; asc     ;;\n\n*** (2) TRANSACTION:\nTRANSACTION 1315, ACTIVE 0 sec starting index read mysql tables in use 1, locked 1\n5 lock struct (s), heap size 1136, 7 row lock (s)\nMySQL thread id 99, OS thread handle 140649858103040, query id 119189 localhost 127.0.0.1 root Sending data select id from t where c in(5,20,10) order by c desc for update\n*** (2) HOLDS THE LOCK(S) :\nRECORD LOCKS space id 24 page no 4 n bits 80 index c of table `test`.`t` trx id 1315 lock_mode X\nRecord lock, heap no 4 PHYSICAL RECORD: _fields 2; compact format; info bits 0\n0: len 4; hex 0000000a; asc    ;;\n1: len 4; hex 0000000a; asc    ;;\n\nRecord lock, heap no 6 PHYSICAL RECORD: _fields 2; compact format; info bits 0\n0: len 4; hex 00000014; asc   ;;\n1: len 4; hex 00000014; asc   ;;\n\n*** (2) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 24 page no 4 n bits 80 index c of table `test`.`t` trx id 1315 lock_mode X waiting\nRecord lock, heap no 3 PHYSICAL RECORD: _fields 2; compact format; info bits 0\n0: len 4; hex 00000005; asc   ;;\n1: len 4; hex 00000005; asc   ;;\n*** WE ROLL BACK TRANSACTION (1)\n</code></pre> <p>\u6211\u4eec\u6765\u770b\u770b\u8fd9\u56fe\u4e2d\u7684\u51e0\u4e2a\u5173\u952e\u4fe1\u606f\u3002</p> <ol> <li>\u8fd9\u4e2a\u7ed3\u679c\u5206\u6210\u4e09\u90e8\u5206\uff1a </li> <li><code>(1) TRANSACTION</code>\uff0c\u662f\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\uff1b</li> <li><code>(2) TRANSACTION</code>\uff0c\u662f\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\uff1b</li> <li><code>WE ROLL BACK TRANSACTION (1)</code>\uff0c\u662f\u6700\u7ec8\u7684\u5904\u7406\u7ed3\u679c\uff0c\u8868\u793a\u56de\u6eda\u4e86\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u3002</li> <li>\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\u4e2d\uff1a </li> <li>WAITING FOR THIS LOCK TO BE GRANTED\uff0c\u8868\u793a\u7684\u662f\u8fd9\u4e2a\u4e8b\u52a1\u5728\u7b49\u5f85\u7684\u9501\u4fe1\u606f\uff1b</li> <li>index c of table <code>test</code>.<code>t</code>\uff0c\u8bf4\u660e\u5728\u7b49\u7684\u662f\u8868 t \u4e0a\u7d22\u5f15c\u7684\u9501\uff1b</li> <li>lock mode S waiting \u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u8981\u81ea\u5df1\u52a0\u4e00\u4e2a\u8bfb\u9501\uff0c\u5f53\u524d\u7684\u72b6\u6001\u662f\u7b49\u5f85\u4e2d\uff1b</li> <li>Record lock \u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a\u8bb0\u5f55\u9501\uff1b</li> <li>n_fields 2 \u8868\u793a\u8fd9\u4e2a\u8bb0\u5f55\u662f2\u5217\uff0c\u4e5f\u5c31\u662f\u5b57\u6bb5 c \u548c\u4e3b\u952e\u5b57\u6bb5 id\uff1b</li> <li><code>0: len 4; hex 0000000a; asc ;;</code> \u662f\u7b2c\u4e00\u4e2a\u5b57\u6bb5\uff0c\u4e5f\u5c31\u662f c\u3002\u503c\u662f\u5341\u516d\u8fdb\u5236 a\uff0c\u4e5f\u5c31\u662f 10\uff1b</li> <li><code>1: len 4; hex 0000000a; asc ;;</code> \u662f\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\uff0c\u4e5f\u5c31\u662f\u4e3b\u952e id\uff0c\u503c\u4e5f\u662f 10\uff1b</li> <li>\u8fd9\u4e24\u884c\u91cc\u9762\u7684 asc \u8868\u793a\u7684\u662f\uff0c\u63a5\u4e0b\u6765\u8981\u6253\u5370\u51fa\u503c\u91cc\u9762\u7684\u201c\u53ef\u6253\u5370\u5b57\u7b26\u201d\uff0c\u4f46 10 \u4e0d\u662f\u53ef\u6253\u5370\u5b57\u7b26\uff0c\u56e0\u6b64\u5c31\u663e\u793a\u7a7a\u683c\u3002</li> <li>\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u4fe1\u606f\u5c31\u53ea\u663e\u793a\u51fa\u4e86\u7b49\u9501\u7684\u72b6\u6001\uff0c\u5728\u7b49\u5f85 <code>(c=10,id=10)</code> \u8fd9\u4e00\u884c\u7684\u9501\u3002</li> <li>\u5f53\u7136\u4f60\u662f\u77e5\u9053\u7684\uff0c\u65e2\u7136\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u4e5f\u5360\u6709\u522b\u7684\u9501\uff0c\u4f46\u662f\u6ca1\u6709\u663e\u793a\u51fa\u6765\u3002\u522b\u7740\u6025\uff0c\u6211\u4eec\u4ece\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u7684\u4fe1\u606f\u4e2d\u63a8\u5bfc\u51fa\u6765\u3002</li> <li>\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u663e\u793a\u7684\u4fe1\u606f\u8981\u591a\u4e00\u4e9b\uff1a </li> <li>HOLDS THE LOCK(S) \u7528\u6765\u663e\u793a\u8fd9\u4e2a\u4e8b\u52a1\u6301\u6709\u54ea\u4e9b\u9501\uff1b</li> <li>index c of table <code>test</code>.<code>t</code> \u8868\u793a\u9501\u662f\u5728\u8868 t \u7684\u7d22\u5f15 c \u4e0a\uff1b</li> <li>hex 0000000a \u548c hex 00000014 \u8868\u793a\u8fd9\u4e2a\u4e8b\u52a1\u6301\u6709 c=10 \u548c c=20 \u8fd9\u4e24\u4e2a\u8bb0\u5f55\u9501\uff1b</li> <li>WAITING FOR THIS LOCK TO BE GRANTED\uff0c\u8868\u793a\u5728\u7b49 <code>(c=5,id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u9501\u3002</li> </ol> <p>\u4ece\u4e0a\u9762\u8fd9\u4e9b\u4fe1\u606f\u4e2d\uff0c\u6211\u4eec\u5c31\u77e5\u9053\uff1a</p> <ol> <li><code>lock in share mode</code> \u7684\u8fd9\u6761\u8bed\u53e5\uff0c\u6301\u6709 c=5 \u7684\u8bb0\u5f55\u9501\uff0c\u5728\u7b49 c=10 \u7684\u9501\uff1b</li> <li><code>for update</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u6301\u6709 c=20 \u548c c=10 \u7684\u8bb0\u5f55\u9501\uff0c\u5728\u7b49 c=5 \u7684\u8bb0\u5f55\u9501\u3002</li> </ol> <p>\u56e0\u6b64\u5bfc\u81f4\u4e86\u6b7b\u9501\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a\u7ed3\u8bba\uff1a</p> <ol> <li>\u7531\u4e8e\u9501\u662f\u4e00\u4e2a\u4e2a\u52a0\u7684\uff0c\u8981\u907f\u514d\u6b7b\u9501\uff0c\u5bf9\u540c\u4e00\u7ec4\u8d44\u6e90\uff0c\u8981\u6309\u7167\u5c3d\u91cf\u76f8\u540c\u7684\u987a\u5e8f\u8bbf\u95ee\uff1b</li> <li>\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u523b\uff0cfor update \u8fd9\u6761\u8bed\u53e5\u5360\u6709\u7684\u8d44\u6e90\u66f4\u591a\uff0c\u56de\u6eda\u6210\u672c\u66f4\u5927\uff0c\u6240\u4ee5 InnoDB \u9009\u62e9\u4e86\u56de\u6eda\u6210\u672c\u66f4\u5c0f\u7684 lock in share mode \u8bed\u53e5\uff0c\u6765\u56de\u6eda\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_4","title":"\u600e\u4e48\u770b\u9501\u7b49\u5f85\uff1f","text":"<p>\u770b\u5b8c\u6b7b\u9501\uff0c\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u9501\u7b49\u5f85\u7684\u4f8b\u5b50\u3002</p> <pre><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\nSessionA -&gt;&gt; Table: begin\nSessionA -&gt;&gt; Table: select * from t where id&gt;10 and id&lt;=15 for update\nSessionB -&gt;&gt;+ Table: delete from t where id=10\nTable --&gt;&gt;-SessionB: Query OK\nSessionB -&gt;&gt;+ Table: insert into t values(10,10,10)\nTable --&gt;&gt;- SessionB: (blocked)</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e session A \u5e76\u6ca1\u6709\u9501\u4f4f c=10 \u8fd9\u4e2a\u8bb0\u5f55\uff0c\u6240\u4ee5 session B \u5220\u9664 id=10 \u8fd9\u4e00\u884c\u662f\u53ef\u4ee5\u7684\u3002\u4f46\u662f\u4e4b\u540e\uff0csession B \u518d\u60f3 insert id=10 \u8fd9\u4e00\u884c\u56de\u53bb\u5c31\u4e0d\u884c\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u6b64\u65f6 <code>show engine innodb status</code> \u7684\u7ed3\u679c\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u7ed9\u6211\u4eec\u4e00\u4e9b\u63d0\u793a\u3002\u9501\u4fe1\u606f\u662f\u5728\u8fd9\u4e2a\u547d\u4ee4\u8f93\u51fa\u7ed3\u679c\u7684 TRANSACTIONS \u8fd9\u4e00\u8282\u3002</p> <pre><code>---TRANSACTION 1311, ACTIVE 4 sec inserting\nmysql tables in use 1, locked 1\nLOCK WAIT 2 lock struct (s), heap size 1136, 1 row lock(s)\nMySQL thread id 11, OS thread handle 140504341464832, query id 20700 localhost 127.0.0.1 root update \ninsert into t values (10, 10, 10)\n------ TX HAS BEEN WAITING 4 SEC FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 24 page no 3 n bits 80 index PRIMARY of table 'test'. 't' trx id 1311 lock_mode X locks gap before rec insert intention waiting\nRecord lock, heap no 5 PHYSICAL RECORD: _fields 5; compact format; info bits o\n0: len 4; hex 0000000f; asc     ;;\n1: 1en 6: hex 000000000513; asc     ;;\n2: len 7; hey b0000001250134; asc    % 4;;\n3: len 4: hey 0000000f; asc     ;;\n4: len 4: hey 0000000f; asc     ;;\n</code></pre> <p>\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u5173\u952e\u4fe1\u606f\u3002</p> <ol> <li>index PRIMARY of table <code>test</code>.<code>t</code> \uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u88ab\u9501\u4f4f\u662f\u56e0\u4e3a\u8868 t \u4e3b\u952e\u4e0a\u7684\u67d0\u4e2a\u9501\u3002</li> <li><code>lock_mode X locks gap before rec insert intention waiting</code> \u8fd9\u91cc\u6709\u51e0\u4e2a\u4fe1\u606f\uff1a </li> <li><code>insert intention</code> \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u51c6\u5907\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55\uff0c\u8fd9\u662f\u4e00\u4e2a\u63d2\u5165\u610f\u5411\u9501\u3002\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u5c31\u662f\u8fd9\u4e2a\u63d2\u5165\u52a8\u4f5c\u672c\u8eab\u3002</li> <li><code>gap before rec</code> \u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u95f4\u9699\u9501\uff0c\u800c\u4e0d\u662f\u8bb0\u5f55\u9501\u3002</li> <li>\u90a3\u4e48\u8fd9\u4e2a gap \u662f\u5728\u54ea\u4e2a\u8bb0\u5f55\u4e4b\u524d\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u7684 0~4 \u8fd9 5 \u884c\u7684\u5185\u5bb9\u5c31\u662f\u8fd9\u4e2a\u8bb0\u5f55\u7684\u4fe1\u606f\u3002</li> <li><code>n_fields 5</code> \u4e5f\u8868\u793a\u4e86\uff0c\u8fd9\u4e00\u4e2a\u8bb0\u5f55\u6709 5 \u5217\uff1a </li> <li><code>0: len 4; hex 0000000f; asc ;;</code> \u7b2c\u4e00\u5217\u662f\u4e3b\u952e id \u5b57\u6bb5\uff0c\u5341\u516d\u8fdb\u5236 f \u5c31\u662f id=15\u3002\u6240\u4ee5\uff0c\u8fd9\u65f6\u6211\u4eec\u5c31\u77e5\u9053\u4e86\uff0c\u8fd9\u4e2a\u95f4\u9699\u5c31\u662f id=15 \u4e4b\u524d\u7684\uff0c\u56e0\u4e3a id=10 \u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86\uff0c\u5b83\u8868\u793a\u7684\u5c31\u662f <code>(5,15)</code>\u3002</li> <li><code>1: len 6; hex 0000008fb53; asc S;;</code> \u7b2c\u4e8c\u5217\u662f\u957f\u5ea6\u4e3a 6 \u5b57\u8282\u7684\u4e8b\u52a1 id\uff0c\u8868\u793a\u6700\u540e\u4fee\u6539\u8fd9\u4e00\u884c\u7684\u662f trx id \u4e3a 588627 \u7684\u4e8b\u52a1\u3002</li> <li><code>2: len 7; hex 82000002010137; asc  7;;</code> \u7b2c\u4e09\u5217\u957f\u5ea6\u4e3a 7 \u5b57\u8282\u7684\u56de\u6eda\u6bb5\u4fe1\u606f\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u7684 acs \u540e\u9762\u6709\u663e\u793a\u5185\u5bb9 (7)\uff0c\u8fd9\u662f\u56e0\u4e3a\u521a\u597d\u8fd9\u4e2a\u5b57\u8282\u662f\u53ef\u6253\u5370\u5b57\u7b26\u3002</li> <li>\u540e\u9762\u4e24\u5217\u662f c \u548c d \u7684\u503c\uff0c\u90fd\u662f 15\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u5c31\u77e5\u9053\u4e86\uff0c\u7531\u4e8e delete \u64cd\u4f5c\u628a id=10 \u8fd9\u4e00\u884c\u5220\u6389\u4e86\uff0c\u539f\u6765\u7684\u4e24\u4e2a\u95f4\u9699 (5,10)\u3001(10,15\uff09\u53d8\u6210\u4e86\u4e00\u4e2a (5,15)\u3002</p> <p>\u8bf4\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u4ee5\u8054\u5408\u8d77\u6765\u518d\u601d\u8003\u4e00\u4e0b\u8fd9\u4e24\u4e2a\u73b0\u8c61\u4e4b\u95f4\u7684\u5173\u8054\uff1a</p> <ol> <li>session A \u6267\u884c\u5b8c select \u8bed\u53e5\u540e\uff0c\u4ec0\u4e48\u90fd\u6ca1\u505a\uff0c\u4f46\u5b83\u52a0\u9501\u7684\u8303\u56f4\u7a81\u7136\u201c\u53d8\u5927\u201d\u4e86\uff1b</li> <li>\u5f53\u6211\u4eec\u6267\u884c <code>select * from t where c&gt;=15 and c&lt;=20 order by c desc lock in share mode;</code> \u5411\u5de6\u626b\u63cf\u5230 c=10 \u7684\u65f6\u5019\uff0c\u8981\u628a (5, 10] \u9501\u8d77\u6765\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6240\u8c13\u201c\u95f4\u9699\u201d\uff0c\u5176\u5b9e\u6839\u672c\u5c31\u662f\u7531\u201c\u8fd9\u4e2a\u95f4\u9699\u53f3\u8fb9\u7684\u90a3\u4e2a\u8bb0\u5f55\u201d\u5b9a\u4e49\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#update","title":"update \u7684\u4f8b\u5b50","text":"<p>\u518d\u6765\u770b\u4e00\u4e2a update \u8bed\u53e5\u7684\u6848\u4f8b\u3002</p> <pre><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\n\nSessionA -&gt;&gt; Table: begin\nSessionA -&gt;&gt; Table: select c from t where c &gt; 5 lock in share mode\nSessionB -&gt;&gt;+ Table: update t set c = 1 where c = 5\nTable --&gt;&gt;- SessionB: Query OK\nSessionB -&gt;&gt;+ Table: update t set c = 5 where c = 1\nTable --&gt;&gt;- SessionB: blocked</code></pre> <p>\u4f60\u53ef\u4ee5\u81ea\u5df1\u5206\u6790\u4e00\u4e0b\uff0csession A \u7684\u52a0\u9501\u8303\u56f4\u662f\u7d22\u5f15 c \u4e0a\u7684 <code>(5,10]\u3001(10,15]\u3001(15,20]\u3001(20,25]</code> \u548c <code>(25,supremum]</code>\u3002</p> <p>\u6ce8\u610f\uff1a\u6839\u636e c&gt;5 \u67e5\u5230\u7684\u7b2c\u4e00\u4e2a\u8bb0\u5f55\u662f c=10\uff0c\u56e0\u6b64\u4e0d\u4f1a\u52a0 (0,5] \u8fd9\u4e2a next-key lock\u3002</p> <p>\u4e4b\u540e session B \u7684\u7b2c\u4e00\u4e2a update \u8bed\u53e5\uff0c\u8981\u628a c=5 \u6539\u6210 c=1\uff0c\u4f60\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e24\u6b65\uff1a</p> <ol> <li>\u63d2\u5165 <code>(c=1, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\uff1b</li> <li>\u5220\u9664 <code>(c=5, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u3002</li> </ol> <p>\u6309\u7167\u6211\u4eec\u4e0a\u4e00\u8282\u8bf4\u7684\uff0c\u7d22\u5f15 c \u4e0a (5,10) \u95f4\u9699\u662f\u7531\u8fd9\u4e2a\u95f4\u9699\u53f3\u8fb9\u7684\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f c=10 \u5b9a\u4e49\u7684\u3002\u6240\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u64cd\u4f5c\uff0csession A \u7684\u52a0\u9501\u8303\u56f4\u53d8\u6210\u4e86\u56fe 7 \u6240\u793a\u7684\u6837\u5b50\uff1a</p> <p>\u56fe 7 session B \u4fee\u6539\u540e\uff0c session A \u7684\u52a0\u9501\u8303\u56f4</p> <p>\u597d\uff0c\u63a5\u4e0b\u6765 session B \u8981\u6267\u884c <code>update t set c = 5 where c = 1</code> \u8fd9\u4e2a\u8bed\u53e5\u4e86\uff0c\u4e00\u6837\u5730\u53ef\u4ee5\u62c6\u6210\u4e24\u6b65\uff1a</p> <ol> <li>\u63d2\u5165 <code>(c=5, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\uff1b</li> <li>\u5220\u9664 <code>(c=1, id=5)</code> \u8fd9\u4e2a\u8bb0\u5f55\u3002</li> </ol> <p>\u7b2c\u4e00\u6b65\u8bd5\u56fe\u5728\u5df2\u7ecf\u52a0\u4e86\u95f4\u9699\u9501\u7684 <code>(1,10)</code> \u4e2d\u63d2\u5165\u6570\u636e\uff0c\u6240\u4ee5\u5c31\u88ab\u5835\u4f4f\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_5","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u7528\u524d\u9762\u6587\u7ae0\u8bc4\u8bba\u533a\u7684\u51e0\u4e2a\u95ee\u9898\uff0c\u518d\u6b21\u590d\u4e60\u4e86\u52a0\u9501\u89c4\u5219\u3002\u5e76\u4e14\u91cd\u70b9\u8bf4\u660e\u4e86\u5206\u6790\u52a0\u9501\u8303\u56f4\u65f6\uff0c\u4e00\u5b9a\u8981\u914d\u5408\u8bed\u53e5\u6267\u884c\u903b\u8f91\u6765\u8fdb\u884c\u3002</p> <p>\u5728\u6211\u770b\u6765\uff0c\u6bcf\u4e2a\u60f3\u8ba4\u771f\u4e86\u89e3 MySQL \u539f\u7406\u7684\u540c\u5b66\uff0c\u5e94\u8be5\u90fd\u8981\u80fd\u591f\u505a\u5230\uff1a\u901a\u8fc7 explain \u7684\u7ed3\u679c\uff0c\u5c31\u80fd\u591f\u8111\u8865\u51fa\u4e00\u4e2a SQL \u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u3002\u8fbe\u5230\u8fd9\u6837\u7684\u7a0b\u5ea6\uff0c\u624d\u7b97\u662f\u5bf9\u7d22\u5f15\u7ec4\u7ec7\u8868\u3001\u7d22\u5f15\u3001\u9501\u7684\u6982\u5ff5\u6709\u4e86\u6bd4\u8f83\u6e05\u6670\u7684\u8ba4\u8bc6\u3002\u4f60\u540c\u6837\u4e5f\u53ef\u4ee5\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u6765\u9a8c\u8bc1\u81ea\u5df1\u5bf9\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u7684\u638c\u63e1\u7a0b\u5ea6\u3002</p> <p>\u5728\u5206\u6790\u8fd9\u4e9b\u52a0\u9501\u89c4\u5219\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u987a\u4fbf\u8ddf\u4f60\u4ecb\u7ecd\u4e86\u600e\u4e48\u770b <code>show engine innodb status</code> \u8f93\u51fa\u7ed3\u679c\u4e2d\u7684\u4e8b\u52a1\u4fe1\u606f\u548c\u6b7b\u9501\u4fe1\u606f\uff0c\u5e0c\u671b\u8fd9\u4e9b\u5185\u5bb9\u5bf9\u4f60\u4ee5\u540e\u5206\u6790\u73b0\u573a\u80fd\u6709\u6240\u5e2e\u52a9\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#31","title":"31 \u8bef\u5220\u6570\u636e\u540e\u9664\u4e86\u8dd1\u8def\uff0c\u8fd8\u80fd\u600e\u4e48\u529e\uff1f","text":"<p>\u4eca\u5929\u6211\u8981\u548c\u4f60\u8ba8\u8bba\u7684\u662f\u4e00\u4e2a\u6c89\u91cd\u7684\u8bdd\u9898\uff1a\u8bef\u5220\u6570\u636e\u3002</p> <p>\u5728\u524d\u9762\u51e0\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86 MySQL \u7684\u9ad8\u53ef\u7528\u67b6\u6784\u3002\u5f53\u7136\uff0c\u4f20\u7edf\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u662f\u4e0d\u80fd\u9884\u9632\u8bef\u5220\u6570\u636e\u7684\uff0c\u56e0\u4e3a\u4e3b\u5e93\u7684\u4e00\u4e2a <code>drop table</code> \u547d\u4ee4\uff0c\u4f1a\u901a\u8fc7 binlog \u4f20\u7ed9\u6240\u6709\u4ece\u5e93\u548c\u7ea7\u8054\u4ece\u5e93\uff0c\u8fdb\u800c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u5b9e\u4f8b\u90fd\u4f1a\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\u3002</p> <p>\u867d\u7136\u6211\u4eec\u4e4b\u524d\u9047\u5230\u7684\u5927\u591a\u6570\u7684\u6570\u636e\u88ab\u5220\uff0c\u90fd\u662f\u8fd0\u7ef4\u540c\u5b66\u6216\u8005 DBA \u80cc\u9505\u7684\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u53ea\u8981\u6709\u6570\u636e\u64cd\u4f5c\u6743\u9650\u7684\u540c\u5b66\uff0c\u90fd\u6709\u53ef\u80fd\u8e29\u5230\u8bef\u5220\u6570\u636e\u8fd9\u6761\u7ebf\u3002</p> <p>\u4eca\u5929\u6211\u4eec\u5c31\u6765\u804a\u804a\u8bef\u5220\u6570\u636e\u524d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u505a\u4e9b\u4ec0\u4e48\uff0c\u51cf\u5c11\u8bef\u5220\u6570\u636e\u7684\u98ce\u9669\uff0c\u548c\u7531\u8bef\u5220\u6570\u636e\u5e26\u6765\u7684\u635f\u5931\u3002</p> <p>\u4e3a\u4e86\u627e\u5230\u89e3\u51b3\u8bef\u5220\u6570\u636e\u7684\u66f4\u9ad8\u6548\u7684\u65b9\u6cd5\uff0c\u6211\u4eec\u9700\u8981\u5148\u5bf9\u548c MySQL \u76f8\u5173\u7684\u8bef\u5220\u6570\u636e\uff0c\u505a\u4e0b\u5206\u7c7b\uff1a</p> <ol> <li>\u4f7f\u7528 delete \u8bed\u53e5\u8bef\u5220\u6570\u636e\u884c\uff1b</li> <li>\u4f7f\u7528 drop table \u6216\u8005 truncate table \u8bed\u53e5\u8bef\u5220\u6570\u636e\u8868\uff1b</li> <li>\u4f7f\u7528 drop database \u8bed\u53e5\u8bef\u5220\u6570\u636e\u5e93\uff1b</li> <li>\u4f7f\u7528 rm \u547d\u4ee4\u8bef\u5220\u6574\u4e2a MySQL \u5b9e\u4f8b\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_6","title":"\u8bef\u5220\u884c","text":"<p>\u5982\u679c\u662f\u4f7f\u7528 delete \u8bed\u53e5\u8bef\u5220\u4e86\u6570\u636e\u884c\uff0c\u53ef\u4ee5\u7528 Flashback \u5de5\u5177\u901a\u8fc7\u95ea\u56de\u628a\u6570\u636e\u6062\u590d\u56de\u6765\u3002</p> <p>Flashback \u6062\u590d\u6570\u636e\u7684\u539f\u7406\uff0c\u662f\u4fee\u6539 binlog \u7684\u5185\u5bb9\uff0c\u62ff\u56de\u539f\u5e93\u91cd\u653e\u3002\u800c\u80fd\u591f\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6848\u7684\u524d\u63d0\u662f\uff0c\u9700\u8981\u786e\u4fdd <code>binlog_format=row</code> \u548c <code>binlog_row_image=FULL</code>\u3002</p> <p>\u5177\u4f53\u6062\u590d\u6570\u636e\u65f6\uff0c\u5bf9\u5355\u4e2a\u4e8b\u52a1\u505a\u5982\u4e0b\u5904\u7406\uff1a</p> <ol> <li>\u5bf9\u4e8e insert \u8bed\u53e5\uff0c\u5bf9\u5e94\u7684 binlog event \u7c7b\u578b\u662f Write_rows event\uff0c\u628a\u5b83\u6539\u6210 <code>Delete_rows</code> event \u5373\u53ef\uff1b</li> <li>\u540c\u7406\uff0c\u5bf9\u4e8e delete \u8bed\u53e5\uff0c\u4e5f\u662f\u5c06 Delete_rows event \u6539\u4e3a Write_rows event\uff1b</li> <li>\u800c\u5982\u679c\u662f Update_rows \u7684\u8bdd\uff0cbinlog \u91cc\u9762\u8bb0\u5f55\u4e86\u6570\u636e\u884c\u4fee\u6539\u524d\u548c\u4fee\u6539\u540e\u7684\u503c\uff0c\u5bf9\u8c03\u8fd9\u4e24\u884c\u7684\u4f4d\u7f6e\u5373\u53ef\u3002</li> </ol> <p>\u5982\u679c\u8bef\u64cd\u4f5c\u4e0d\u662f\u4e00\u4e2a\uff0c\u800c\u662f\u591a\u4e2a\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u6bd4\u5982\u4e0b\u9762\u4e09\u4e2a\u4e8b\u52a1\uff1a</p> <pre><code>(A)delete ...\n(B)insert ...\n(C)update ...\n</code></pre> <p>\u73b0\u5728\u8981\u628a\u6570\u636e\u5e93\u6062\u590d\u56de\u8fd9\u4e09\u4e2a\u4e8b\u52a1\u64cd\u4f5c\u4e4b\u524d\u7684\u72b6\u6001\uff0c\u7528 Flashback \u5de5\u5177\u89e3\u6790 binlog \u540e\uff0c\u5199\u56de\u4e3b\u5e93\u7684\u547d\u4ee4\u662f\uff1a</p> <pre><code>(reverse C)update ...\n(reverse B)delete ...\n(reverse A)insert ...\n</code></pre> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u8bef\u5220\u6570\u636e\u6d89\u53ca\u5230\u4e86\u591a\u4e2a\u4e8b\u52a1\u7684\u8bdd\uff0c\u9700\u8981\u5c06\u4e8b\u52a1\u7684\u987a\u5e8f\u8c03\u8fc7\u6765\u518d\u6267\u884c\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u76f4\u63a5\u5728\u4e3b\u5e93\u4e0a\u6267\u884c\u8fd9\u4e9b\u64cd\u4f5c\u3002</p> <p>\u6062\u590d\u6570\u636e\u6bd4\u8f83\u5b89\u5168\u7684\u505a\u6cd5\uff0c\u662f\u6062\u590d\u51fa\u4e00\u4e2a\u5907\u4efd\uff0c\u6216\u8005\u627e\u4e00\u4e2a\u4ece\u5e93\u4f5c\u4e3a\u4e34\u65f6\u5e93\uff0c\u5728\u8fd9\u4e2a\u4e34\u65f6\u5e93\u4e0a\u6267\u884c\u8fd9\u4e9b\u64cd\u4f5c\uff0c\u7136\u540e\u518d\u5c06\u786e\u8ba4\u8fc7\u7684\u4e34\u65f6\u5e93\u7684\u6570\u636e\uff0c\u6062\u590d\u56de\u4e3b\u5e93\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u505a\u5462\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u4e00\u4e2a\u5728\u6267\u884c\u7ebf\u4e0a\u903b\u8f91\u7684\u4e3b\u5e93\uff0c\u6570\u636e\u72b6\u6001\u7684\u53d8\u66f4\u5f80\u5f80\u662f\u6709\u5173\u8054\u7684\u3002\u53ef\u80fd\u7531\u4e8e\u53d1\u73b0\u6570\u636e\u95ee\u9898\u7684\u65f6\u95f4\u665a\u4e86\u4e00\u70b9\u513f\uff0c\u5c31\u5bfc\u81f4\u5df2\u7ecf\u5728\u4e4b\u524d\u8bef\u64cd\u4f5c\u7684\u57fa\u7840\u4e0a\uff0c\u4e1a\u52a1\u4ee3\u7801\u903b\u8f91\u53c8\u7ee7\u7eed\u4fee\u6539\u4e86\u5176\u4ed6\u6570\u636e\u3002\u6240\u4ee5\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u5355\u72ec\u6062\u590d\u8fd9\u51e0\u884c\u6570\u636e\uff0c\u800c\u53c8\u672a\u7ecf\u786e\u8ba4\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u4f1a\u51fa\u73b0\u5bf9\u6570\u636e\u7684\u4e8c\u6b21\u7834\u574f\u3002</p> <p>\u5f53\u7136\uff0c\u6211\u4eec\u4e0d\u6b62\u8981\u8bf4\u8bef\u5220\u6570\u636e\u7684\u4e8b\u540e\u5904\u7406\u529e\u6cd5\uff0c\u66f4\u91cd\u8981\u662f\u8981\u505a\u5230\u4e8b\u524d\u9884\u9632\u3002\u6211\u6709\u4ee5\u4e0b\u4e24\u4e2a\u5efa\u8bae\uff1a</p> <ol> <li>\u628a <code>sql_safe_updates</code> \u53c2\u6570\u8bbe\u7f6e\u4e3a on\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5982\u679c\u6211\u4eec\u5fd8\u8bb0\u5728 delete \u6216\u8005 update \u8bed\u53e5\u4e2d\u5199 where \u6761\u4ef6\uff0c\u6216\u8005 where \u6761\u4ef6\u91cc\u9762\u6ca1\u6709\u5305\u542b\u7d22\u5f15\u5b57\u6bb5\u7684\u8bdd\uff0c\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u5c31\u4f1a\u62a5\u9519\u3002</li> <li>\u4ee3\u7801\u4e0a\u7ebf\u524d\uff0c\u5fc5\u987b\u7ecf\u8fc7 SQL \u5ba1\u8ba1\u3002</li> </ol> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8bbe\u7f6e\u4e86 <code>sql_safe_updates=on</code>\uff0c\u5982\u679c\u6211\u771f\u7684\u8981\u628a\u4e00\u4e2a\u5c0f\u8868\u7684\u6570\u636e\u5168\u90e8\u5220\u6389\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f</p> <p>\u5982\u679c\u4f60\u786e\u5b9a\u8fd9\u4e2a\u5220\u9664\u64cd\u4f5c\u6ca1\u95ee\u9898\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728 delete \u8bed\u53e5\u4e2d\u52a0\u4e0a where \u6761\u4ef6\uff0c\u6bd4\u5982 <code>where id&gt;=0</code>\u3002</p> <p>\u4f46\u662f\uff0cdelete \u5168\u8868\u662f\u5f88\u6162\u7684\uff0c\u9700\u8981\u751f\u6210\u56de\u6eda\u65e5\u5fd7\u3001\u5199 redo\u3001\u5199 binlog\u3002\u6240\u4ee5\uff0c\u4ece\u6027\u80fd\u89d2\u5ea6\u8003\u8651\uff0c\u4f60\u5e94\u8be5\u4f18\u5148\u8003\u8651\u4f7f\u7528 truncate table \u6216\u8005 drop table \u547d\u4ee4\u3002</p> <p>\u4f7f\u7528 delete \u547d\u4ee4\u5220\u9664\u7684\u6570\u636e\uff0c\u4f60\u8fd8\u53ef\u4ee5\u7528 Flashback \u6765\u6062\u590d\u3002\u800c\u4f7f\u7528 truncate /drop table \u548c drop database \u547d\u4ee4\u5220\u9664\u7684\u6570\u636e\uff0c\u5c31\u6ca1\u529e\u6cd5\u901a\u8fc7 Flashback \u6765\u6062\u590d\u4e86\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a\uff0c\u5373\u4f7f\u6211\u4eec\u914d\u7f6e\u4e86 binlog_format=row\uff0c\u6267\u884c\u8fd9\u4e09\u4e2a\u547d\u4ee4\u65f6\uff0c\u8bb0\u5f55\u7684 binlog \u8fd8\u662f statement \u683c\u5f0f\u3002binlog \u91cc\u9762\u5c31\u53ea\u6709\u4e00\u4e2a truncate/drop \u8bed\u53e5\uff0c\u8fd9\u4e9b\u4fe1\u606f\u662f\u6062\u590d\u4e0d\u51fa\u6570\u636e\u7684\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u771f\u7684\u662f\u4f7f\u7528\u8fd9\u51e0\u6761\u547d\u4ee4\u8bef\u5220\u6570\u636e\u4e86\uff0c\u53c8\u8be5\u600e\u4e48\u529e\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_7","title":"\u8bef\u5220\u5e93 / \u8868","text":"<p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8981\u60f3\u6062\u590d\u6570\u636e\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u5168\u91cf\u5907\u4efd\uff0c\u52a0\u589e\u91cf\u65e5\u5fd7\u7684\u65b9\u5f0f\u4e86\u3002\u8fd9\u4e2a\u65b9\u6848\u8981\u6c42\u7ebf\u4e0a\u6709\u5b9a\u671f\u7684\u5168\u91cf\u5907\u4efd\uff0c\u5e76\u4e14\u5b9e\u65f6\u5907\u4efd binlog\u3002</p> <p>\u5728\u8fd9\u4e24\u4e2a\u6761\u4ef6\u90fd\u5177\u5907\u7684\u60c5\u51b5\u4e0b\uff0c\u5047\u5982\u6709\u4eba\u4e2d\u5348 12 \u70b9\u8bef\u5220\u4e86\u4e00\u4e2a\u5e93\uff0c\u6062\u590d\u6570\u636e\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u53d6\u6700\u8fd1\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5047\u8bbe\u8fd9\u4e2a\u5e93\u662f\u4e00\u5929\u4e00\u5907\uff0c\u4e0a\u6b21\u5907\u4efd\u662f\u5f53\u5929 0 \u70b9\uff1b</li> <li>\u7528\u5907\u4efd\u6062\u590d\u51fa\u4e00\u4e2a\u4e34\u65f6\u5e93\uff1b</li> <li>\u4ece\u65e5\u5fd7\u5907\u4efd\u91cc\u9762\uff0c\u53d6\u51fa\u51cc\u6668 0 \u70b9\u4e4b\u540e\u7684\u65e5\u5fd7\uff1b</li> <li>\u628a\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u9664\u4e86\u8bef\u5220\u9664\u6570\u636e\u7684\u8bed\u53e5\u5916\uff0c\u5168\u90e8\u5e94\u7528\u5230\u4e34\u65f6\u5e93\u3002</li> </ol> <p>\u5173\u4e8e\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u9700\u8981\u8bf4\u660e\u5982\u4e0b\u51e0\u70b9\uff1a</p> <ol> <li>\u4e3a\u4e86\u52a0\u901f\u6570\u636e\u6062\u590d\uff0c\u5982\u679c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u4e0a\u6709\u591a\u4e2a\u6570\u636e\u5e93\uff0c\u4f60\u53ef\u4ee5\u5728\u4f7f\u7528 mysqlbinlog \u547d\u4ee4\u65f6\uff0c\u52a0\u4e0a\u4e00\u4e2a <code>-\u2013database</code> \u53c2\u6570\uff0c\u7528\u6765\u6307\u5b9a\u8bef\u5220\u8868\u6240\u5728\u7684\u5e93\u3002\u8fd9\u6837\uff0c\u5c31\u907f\u514d\u4e86\u5728\u6062\u590d\u6570\u636e\u65f6\u8fd8\u8981\u5e94\u7528\u5176\u4ed6\u5e93\u65e5\u5fd7\u7684\u60c5\u51b5\u3002</li> <li>\u5728\u5e94\u7528\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u9700\u8981\u8df3\u8fc7 12 \u70b9\u8bef\u64cd\u4f5c\u7684\u90a3\u4e2a\u8bed\u53e5\u7684 binlog\uff1a </li> <li>\u5982\u679c\u539f\u5b9e\u4f8b\u6ca1\u6709\u4f7f\u7528 GTID \u6a21\u5f0f\uff0c\u53ea\u80fd\u5728\u5e94\u7528\u5230\u5305\u542b 12 \u70b9\u7684 binlog \u6587\u4ef6\u7684\u65f6\u5019\uff0c\u5148\u7528 <code>-\u2013stop-position</code> \u53c2\u6570\u6267\u884c\u5230\u8bef\u64cd\u4f5c\u4e4b\u524d\u7684\u65e5\u5fd7\uff0c\u7136\u540e\u518d\u7528 <code>-\u2013start-position</code> \u4ece\u8bef\u64cd\u4f5c\u4e4b\u540e\u7684\u65e5\u5fd7\u7ee7\u7eed\u6267\u884c\uff1b</li> <li>\u5982\u679c\u5b9e\u4f8b\u4f7f\u7528\u4e86 GTID \u6a21\u5f0f\uff0c\u5c31\u65b9\u4fbf\u591a\u4e86\u3002\u5047\u8bbe\u8bef\u64cd\u4f5c\u547d\u4ee4\u7684 GTID \u662f gtid1\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u6267\u884c <code>set gtid_next=gtid1;begin;commit;</code> \u5148\u628a\u8fd9\u4e2a GTID \u52a0\u5230\u4e34\u65f6\u5b9e\u4f8b\u7684 GTID \u96c6\u5408\uff0c\u4e4b\u540e\u6309\u987a\u5e8f\u6267\u884c binlog \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u81ea\u52a8\u8df3\u8fc7\u8bef\u64cd\u4f5c\u7684\u8bed\u53e5\u3002</li> </ol> <p>\u4e0d\u8fc7\uff0c\u5373\u4f7f\u8fd9\u6837\uff0c\u4f7f\u7528 mysqlbinlog \u65b9\u6cd5\u6062\u590d\u6570\u636e\u8fd8\u662f\u4e0d\u591f\u5feb\uff0c\u4e3b\u8981\u539f\u56e0\u6709\u4e24\u4e2a\uff1a</p> <ol> <li>\u5982\u679c\u662f\u8bef\u5220\u8868\uff0c\u6700\u597d\u5c31\u662f\u53ea\u6062\u590d\u51fa\u8fd9\u5f20\u8868\uff0c\u4e5f\u5c31\u662f\u53ea\u91cd\u653e\u8fd9\u5f20\u8868\u7684\u64cd\u4f5c\uff0c\u4f46\u662f mysqlbinlog \u5de5\u5177\u5e76\u4e0d\u80fd\u6307\u5b9a\u53ea\u89e3\u6790\u4e00\u4e2a\u8868\u7684\u65e5\u5fd7\uff1b</li> <li>\u7528 mysqlbinlog \u89e3\u6790\u51fa\u65e5\u5fd7\u5e94\u7528\uff0c\u5e94\u7528\u65e5\u5fd7\u7684\u8fc7\u7a0b\u5c31\u53ea\u80fd\u662f\u5355\u7ebf\u7a0b\u3002</li> </ol> <p>**\u4e00\u79cd\u52a0\u901f\u7684\u65b9\u6cd5\u662f\uff0c**\u5728\u7528\u5907\u4efd\u6062\u590d\u51fa\u4e34\u65f6\u5b9e\u4f8b\u4e4b\u540e\uff0c\u5c06\u8fd9\u4e2a\u4e34\u65f6\u5b9e\u4f8b\u8bbe\u7f6e\u6210\u7ebf\u4e0a\u5907\u5e93\u7684\u4ece\u5e93\uff0c\u8fd9\u6837\uff1a</p> <ol> <li>\u5728 start slave \u4e4b\u524d\uff0c\u5148\u901a\u8fc7\u6267\u884c <code>change replication filter replicate_do_table = (tbl_name)</code> \u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u8ba9\u4e34\u65f6\u5e93\u53ea\u540c\u6b65\u8bef\u64cd\u4f5c\u7684\u8868\uff1b</li> <li>\u8fd9\u6837\u505a\u4e5f\u53ef\u4ee5\u7528\u4e0a\u5e76\u884c\u590d\u5236\u6280\u672f\uff0c\u6765\u52a0\u901f\u6574\u4e2a\u6570\u636e\u6062\u590d\u8fc7\u7a0b\u3002</li> </ol> <p>\u5047\u8bbe\uff0c\u6211\u4eec\u53d1\u73b0\u5f53\u524d\u4e34\u65f6\u5b9e\u4f8b\u9700\u8981\u7684 binlog \u662f\u4ece <code>master.000005</code> \u5f00\u59cb\u7684\uff0c\u4f46\u662f\u5728\u5907\u5e93\u4e0a\u6267\u884c <code>show binlogs</code> \u663e\u793a\u7684\u6700\u5c0f\u7684 binlog \u6587\u4ef6\u662f <code>master.000007</code>\uff0c\u610f\u5473\u7740\u5c11\u4e86\u4e24\u4e2a binlog \u6587\u4ef6\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u9700\u8981\u53bb binlog \u5907\u4efd\u7cfb\u7edf\u4e2d\u627e\u5230\u8fd9\u4e24\u4e2a\u6587\u4ef6\u3002</p> <p>\u628a\u4e4b\u524d\u5220\u6389\u7684 binlog \u653e\u56de\u5907\u5e93\u7684\u64cd\u4f5c\u6b65\u9aa4\uff0c\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u4ece\u5907\u4efd\u7cfb\u7edf\u4e0b\u8f7d <code>master.000005</code> \u548c <code>master.000006</code> \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u653e\u5230\u5907\u5e93\u7684\u65e5\u5fd7\u76ee\u5f55\u4e0b\uff1b</li> <li>\u6253\u5f00\u65e5\u5fd7\u76ee\u5f55\u4e0b\u7684 <code>master.index</code> \u6587\u4ef6\uff0c\u5728\u6587\u4ef6\u5f00\u5934\u52a0\u5165\u4e24\u884c\uff0c\u5185\u5bb9\u5206\u522b\u662f <code>master.000005</code> \u548c <code>master.000006</code>;</li> <li>\u91cd\u542f\u5907\u5e93\uff0c\u76ee\u7684\u662f\u8981\u8ba9\u5907\u5e93\u91cd\u65b0\u8bc6\u522b\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u6587\u4ef6\uff1b</li> <li>\u73b0\u5728\u8fd9\u4e2a\u5907\u5e93\u4e0a\u5c31\u6709\u4e86\u4e34\u65f6\u5e93\u9700\u8981\u7684\u6240\u6709 binlog \u4e86\uff0c\u5efa\u7acb\u4e3b\u5907\u5173\u7cfb\uff0c\u5c31\u53ef\u4ee5\u6b63\u5e38\u540c\u6b65\u4e86\u3002</li> </ol> <p>\u4e0d\u8bba\u662f\u628a mysqlbinlog \u5de5\u5177\u89e3\u6790\u51fa\u7684 binlog \u6587\u4ef6\u5e94\u7528\u5230\u4e34\u65f6\u5e93\uff0c\u8fd8\u662f\u628a\u4e34\u65f6\u5e93\u63a5\u5230\u5907\u5e93\u4e0a\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6848\u7684\u5171\u540c\u70b9\u662f\uff1a\u8bef\u5220\u5e93\u6216\u8005\u8868\u540e\uff0c\u6062\u590d\u6570\u636e\u7684\u601d\u8def\u4e3b\u8981\u5c31\u662f\u901a\u8fc7\u5907\u4efd\uff0c\u518d\u52a0\u4e0a\u5e94\u7528 binlog \u7684\u65b9\u5f0f\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6848\u90fd\u8981\u6c42\u5907\u4efd\u7cfb\u7edf\u5b9a\u671f\u5907\u4efd\u5168\u91cf\u65e5\u5fd7\uff0c\u800c\u4e14\u9700\u8981\u786e\u4fdd binlog \u5728\u88ab\u4ece\u672c\u5730\u5220\u9664\u4e4b\u524d\u5df2\u7ecf\u505a\u4e86\u5907\u4efd\u3002</p> <p>\u4f46\u662f\uff0c\u4e00\u4e2a\u7cfb\u7edf\u4e0d\u53ef\u80fd\u5907\u4efd\u65e0\u9650\u7684\u65e5\u5fd7\uff0c\u4f60\u8fd8\u9700\u8981\u6839\u636e\u6210\u672c\u548c\u78c1\u76d8\u7a7a\u95f4\u8d44\u6e90\uff0c\u8bbe\u5b9a\u4e00\u4e2a\u65e5\u5fd7\u4fdd\u7559\u7684\u5929\u6570\u3002\u5982\u679c\u4f60\u7684 DBA \u56e2\u961f\u544a\u8bc9\u4f60\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u628a\u67d0\u4e2a\u5b9e\u4f8b\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u7684\u4efb\u610f\u65f6\u95f4\u70b9\uff0c\u8fd9\u5c31\u8868\u793a\u5907\u4efd\u7cfb\u7edf\u4fdd\u7559\u7684\u65e5\u5fd7\u65f6\u95f4\u5c31\u81f3\u5c11\u662f\u534a\u4e2a\u6708\u3002</p> <p>\u53e6\u5916\uff0c\u6211\u5efa\u8bae\u4f60\u4e0d\u8bba\u4f7f\u7528\u4e0a\u8ff0\u54ea\u79cd\u65b9\u5f0f\uff0c\u90fd\u8981\u628a\u8fd9\u4e2a\u6570\u636e\u6062\u590d\u529f\u80fd\u505a\u6210\u81ea\u52a8\u5316\u5de5\u5177\uff0c\u5e76\u4e14\u7ecf\u5e38\u62ff\u51fa\u6765\u6f14\u7ec3\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p> <p>\u8fd9\u91cc\u7684\u539f\u56e0\uff0c\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u867d\u7136\u201c\u53d1\u751f\u8fd9\u79cd\u4e8b\uff0c\u5927\u5bb6\u90fd\u4e0d\u60f3\u7684\u201d\uff0c\u4f46\u662f\u4e07\u4e00\u51fa\u73b0\u4e86\u8bef\u5220\u4e8b\u4ef6\uff0c\u80fd\u591f\u5feb\u901f\u6062\u590d\u6570\u636e\uff0c\u5c06\u635f\u5931\u964d\u5230\u6700\u5c0f\uff0c\u4e5f\u5e94\u8be5\u4e0d\u7528\u8dd1\u8def\u4e86\u3002</li> <li>\u800c\u5982\u679c\u4e34\u65f6\u518d\u624b\u5fd9\u811a\u4e71\u5730\u624b\u52a8\u64cd\u4f5c\uff0c\u6700\u540e\u53c8\u8bef\u64cd\u4f5c\u4e86\uff0c\u5bf9\u4e1a\u52a1\u9020\u6210\u4e86\u4e8c\u6b21\u4f24\u5bb3\uff0c\u90a3\u5c31\u8bf4\u4e0d\u8fc7\u53bb\u4e86\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_8","title":"\u5ef6\u8fdf\u590d\u5236\u5907\u5e93","text":"<p>\u867d\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5229\u7528\u5e76\u884c\u590d\u5236\u6765\u52a0\u901f\u6062\u590d\u6570\u636e\u7684\u8fc7\u7a0b\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6848\u4ecd\u7136\u5b58\u5728\u201c\u6062\u590d\u65f6\u95f4\u4e0d\u53ef\u63a7\u201d\u7684\u95ee\u9898\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u5e93\u7684\u5907\u4efd\u7279\u522b\u5927\uff0c\u6216\u8005\u8bef\u64cd\u4f5c\u7684\u65f6\u95f4\u8ddd\u79bb\u4e0a\u4e00\u4e2a\u5168\u91cf\u5907\u4efd\u7684\u65f6\u95f4\u8f83\u957f\uff0c\u6bd4\u5982\u4e00\u5468\u4e00\u5907\u7684\u5b9e\u4f8b\uff0c\u5728\u5907\u4efd\u4e4b\u540e\u7684\u7b2c 6 \u5929\u53d1\u751f\u8bef\u64cd\u4f5c\uff0c\u90a3\u5c31\u9700\u8981\u6062\u590d 6 \u5929\u7684\u65e5\u5fd7\uff0c\u8fd9\u4e2a\u6062\u590d\u65f6\u95f4\u53ef\u80fd\u662f\u8981\u6309\u5929\u6765\u8ba1\u7b97\u7684\u3002</p> <p>\u90a3\u4e48\uff0c\u6211\u4eec\u6709\u4ec0\u4e48\u65b9\u6cd5\u53ef\u4ee5\u7f29\u77ed\u6062\u590d\u6570\u636e\u9700\u8981\u7684\u65f6\u95f4\u5462\uff1f</p> <p>\u5982\u679c\u6709\u975e\u5e38\u6838\u5fc3\u7684\u4e1a\u52a1\uff0c\u4e0d\u5141\u8bb8\u592a\u957f\u7684\u6062\u590d\u65f6\u95f4\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651 **\u642d\u5efa\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u3002**\u8fd9\u4e2a\u529f\u80fd\u662f MySQL 5.6 \u7248\u672c\u5f15\u5165\u7684\u3002</p> <p>\u4e00\u822c\u7684\u4e3b\u5907\u590d\u5236\u7ed3\u6784\u5b58\u5728\u7684\u95ee\u9898\u662f\uff0c\u5982\u679c\u4e3b\u5e93\u4e0a\u6709\u4e2a\u8868\u88ab\u8bef\u5220\u4e86\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5f88\u5feb\u4e5f\u4f1a\u88ab\u53d1\u7ed9\u6240\u6709\u4ece\u5e93\uff0c\u8fdb\u800c\u5bfc\u81f4\u6240\u6709\u4ece\u5e93\u7684\u6570\u636e\u8868\u4e5f\u90fd\u4e00\u8d77\u88ab\u8bef\u5220\u4e86\u3002</p> <p>\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u5907\u5e93\uff0c\u901a\u8fc7 <code>CHANGE MASTER TO MASTER_DELAY = N</code> \u547d\u4ee4\uff0c\u53ef\u4ee5\u6307\u5b9a\u8fd9\u4e2a\u5907\u5e93\u6301\u7eed\u4fdd\u6301\u8ddf\u4e3b\u5e93\u6709 N \u79d2\u7684\u5ef6\u8fdf\u3002</p> <p>\u6bd4\u5982\u4f60\u628a N \u8bbe\u7f6e\u4e3a 3600\uff0c\u8fd9\u5c31\u4ee3\u8868\u4e86\u5982\u679c\u4e3b\u5e93\u4e0a\u6709\u6570\u636e\u88ab\u8bef\u5220\u4e86\uff0c\u5e76\u4e14\u5728 1 \u5c0f\u65f6\u5185\u53d1\u73b0\u4e86\u8fd9\u4e2a\u8bef\u64cd\u4f5c\u547d\u4ee4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u5c31\u8fd8\u6ca1\u6709\u5728\u8fd9\u4e2a\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u6267\u884c\u3002\u8fd9\u65f6\u5019\u5230\u8fd9\u4e2a\u5907\u5e93\u4e0a\u6267\u884c stop slave\uff0c\u518d\u901a\u8fc7\u4e4b\u524d\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u8df3\u8fc7\u8bef\u64cd\u4f5c\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u6062\u590d\u51fa\u9700\u8981\u7684\u6570\u636e\u3002</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u4f60\u5c31\u968f\u65f6\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\uff0c\u53ea\u9700\u8981\u6700\u591a\u518d\u8ffd 1 \u5c0f\u65f6\uff0c\u5c31\u53ef\u4ee5\u6062\u590d\u51fa\u6570\u636e\u7684\u4e34\u65f6\u5b9e\u4f8b\uff0c\u4e5f\u5c31\u7f29\u77ed\u4e86\u6574\u4e2a\u6570\u636e\u6062\u590d\u9700\u8981\u7684\u65f6\u95f4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_9","title":"\u9884\u9632\u8bef\u5220\u5e93 / \u8868\u7684\u65b9\u6cd5","text":"<p>\u867d\u7136\u5e38\u5728\u6cb3\u8fb9\u8d70\uff0c\u5f88\u96be\u4e0d\u6e7f\u978b\uff0c\u4f46\u7ec8\u7a76\u8fd8\u662f\u53ef\u4ee5\u627e\u5230\u4e00\u4e9b\u65b9\u6cd5\u6765\u907f\u514d\u7684\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u6211\u4e5f\u4f1a\u7ed9\u4f60\u4e00\u4e9b\u51cf\u5c11\u8bef\u5220\u64cd\u4f5c\u98ce\u9669\u7684\u5efa\u8bae\u3002</p> <p>\u7b2c\u4e00\u6761\u5efa\u8bae\u662f\uff0c\u8d26\u53f7\u5206\u79bb\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\uff0c\u907f\u514d\u5199\u9519\u547d\u4ee4\u3002\u6bd4\u5982\uff1a</p> <ul> <li>\u6211\u4eec\u53ea\u7ed9\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66 DML \u6743\u9650\uff0c\u800c\u4e0d\u7ed9 truncate/drop \u6743\u9650\u3002\u800c\u5982\u679c\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u6709 DDL \u9700\u6c42\u7684\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5f00\u53d1\u7ba1\u7406\u7cfb\u7edf\u5f97\u5230\u652f\u6301\u3002</li> <li>\u5373\u4f7f\u662f DBA \u56e2\u961f\u6210\u5458\uff0c\u65e5\u5e38\u4e5f\u90fd\u89c4\u5b9a\u53ea\u4f7f\u7528\u53ea\u8bfb\u8d26\u53f7\uff0c\u5fc5\u8981\u7684\u65f6\u5019\u624d\u4f7f\u7528\u6709\u66f4\u65b0\u6743\u9650\u7684\u8d26\u53f7\u3002</li> </ul> <p>\u7b2c\u4e8c\u6761\u5efa\u8bae\u662f\uff0c\u5236\u5b9a\u64cd\u4f5c\u89c4\u8303\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\uff0c\u662f\u907f\u514d\u5199\u9519\u8981\u5220\u9664\u7684\u8868\u540d\u3002\u6bd4\u5982\uff1a</p> <ul> <li>\u5728\u5220\u9664\u6570\u636e\u8868\u4e4b\u524d\uff0c\u5fc5\u987b\u5148\u5bf9\u8868\u505a\u6539\u540d\u64cd\u4f5c\u3002\u7136\u540e\uff0c\u89c2\u5bdf\u4e00\u6bb5\u65f6\u95f4\uff0c\u786e\u4fdd\u5bf9\u4e1a\u52a1\u65e0\u5f71\u54cd\u4ee5\u540e\u518d\u5220\u9664\u8fd9\u5f20\u8868\u3002</li> <li>\u6539\u8868\u540d\u7684\u65f6\u5019\uff0c\u8981\u6c42\u7ed9\u8868\u540d\u52a0\u56fa\u5b9a\u7684\u540e\u7f00\uff08\u6bd4\u5982\u52a0 <code>_to_be_deleted</code>)\uff0c\u7136\u540e\u5220\u9664\u8868\u7684\u52a8\u4f5c\u5fc5\u987b\u901a\u8fc7\u7ba1\u7406\u7cfb\u7edf\u6267\u884c\u3002\u5e76\u4e14\uff0c\u7ba1\u7406\u7cfb\u5220\u9664\u8868\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u5220\u9664\u56fa\u5b9a\u540e\u7f00\u7684\u8868\u3002</li> </ul>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#rm","title":"rm \u5220\u9664\u6570\u636e","text":"<p>\u5176\u5b9e\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u6709\u9ad8\u53ef\u7528\u673a\u5236\u7684 MySQL \u96c6\u7fa4\u6765\u8bf4\uff0c\u6700\u4e0d\u6015\u7684\u5c31\u662f rm \u5220\u9664\u6570\u636e\u4e86\u3002\u53ea\u8981\u4e0d\u662f\u6076\u610f\u5730\u628a\u6574\u4e2a\u96c6\u7fa4\u5220\u9664\uff0c\u800c\u53ea\u662f\u5220\u6389\u4e86\u5176\u4e2d\u67d0\u4e00\u4e2a\u8282\u70b9\u7684\u6570\u636e\u7684\u8bdd\uff0cHA \u7cfb\u7edf\u5c31\u4f1a\u5f00\u59cb\u5de5\u4f5c\uff0c\u9009\u51fa\u4e00\u4e2a\u65b0\u7684\u4e3b\u5e93\uff0c\u4ece\u800c\u4fdd\u8bc1\u6574\u4e2a\u96c6\u7fa4\u7684\u6b63\u5e38\u5de5\u4f5c\u3002</p> <p>\u8fd9\u65f6\uff0c\u4f60\u8981\u505a\u7684\u5c31\u662f\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u518d\u63a5\u5165\u6574\u4e2a\u96c6\u7fa4\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u73b0\u5728\u4e0d\u6b62\u662f DBA \u6709\u81ea\u52a8\u5316\u7cfb\u7edf\uff0cSA\uff08\u7cfb\u7edf\u7ba1\u7406\u5458\uff09\u4e5f\u6709\u81ea\u52a8\u5316\u7cfb\u7edf\uff0c\u6240\u4ee5\u4e5f\u8bb8\u4e00\u4e2a\u6279\u91cf\u4e0b\u7ebf\u673a\u5668\u7684\u64cd\u4f5c\uff0c\u4f1a\u8ba9\u4f60\u6574\u4e2a MySQL \u96c6\u7fa4\u7684\u6240\u6709\u8282\u70b9\u90fd\u5168\u519b\u8986\u6ca1\u3002</p> <p>\u5e94\u5bf9\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u7684\u5efa\u8bae\u53ea\u80fd\u662f\u8bf4\u5c3d\u91cf\u628a\u4f60\u7684\u5907\u4efd\u8de8\u673a\u623f\uff0c\u6216\u8005\u6700\u597d\u662f\u8de8\u57ce\u5e02\u4fdd\u5b58\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_10","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u8ba8\u8bba\u4e86\u8bef\u5220\u6570\u636e\u7684\u51e0\u79cd\u53ef\u80fd\uff0c\u4ee5\u53ca\u8bef\u5220\u540e\u7684\u5904\u7406\u65b9\u6cd5\u3002</p> <p>\u4f46\uff0c\u6211\u8981\u5f3a\u8c03\u7684\u662f\uff0c\u9884\u9632\u8fdc\u6bd4\u5904\u7406\u7684\u610f\u4e49\u6765\u5f97\u5927\u3002</p> <p>\u53e6\u5916\uff0c\u5728 MySQL \u7684\u96c6\u7fa4\u65b9\u6848\u4e2d\uff0c\u4f1a\u65f6\u4e0d\u65f6\u5730\u7528\u5230\u5907\u4efd\u6765\u6062\u590d\u5b9e\u4f8b\uff0c\u56e0\u6b64\u5b9a\u671f\u68c0\u67e5\u5907\u4efd\u7684\u6709\u6548\u6027\u4e5f\u5f88\u6709\u5fc5\u8981\u3002</p> <p>\u5982\u679c\u4f60\u662f\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\uff0c\u4f60\u53ef\u4ee5\u7528 show grants \u547d\u4ee4\u67e5\u770b\u8d26\u6237\u7684\u6743\u9650\uff0c\u5982\u679c\u6743\u9650\u8fc7\u5927\uff0c\u53ef\u4ee5\u5efa\u8bae DBA \u540c\u5b66\u7ed9\u4f60\u5206\u914d\u6743\u9650\u4f4e\u4e00\u4e9b\u7684\u8d26\u53f7\uff1b\u4f60\u4e5f\u53ef\u4ee5\u8bc4\u4f30\u4e1a\u52a1\u7684\u91cd\u8981\u6027\uff0c\u548c DBA \u5546\u91cf\u5907\u4efd\u7684\u5468\u671f\u3001\u662f\u5426\u6709\u5fc5\u8981\u521b\u5efa\u5ef6\u8fdf\u590d\u5236\u7684\u5907\u5e93\u7b49\u7b49\u3002</p> <p>\u6570\u636e\u548c\u670d\u52a1\u7684\u53ef\u9760\u6027\u4e0d\u6b62\u662f\u8fd0\u7ef4\u56e2\u961f\u7684\u5de5\u4f5c\uff0c\u6700\u7ec8\u662f\u5404\u4e2a\u73af\u8282\u4e00\u8d77\u4fdd\u969c\u7684\u7ed3\u679c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_11","title":"\u4e0a\u671f\u95ee\u9898\u65f6\u95f4","text":"<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u7ed9\u4f60\u7559\u7684\u95ee\u9898\uff0c\u662f\u5173\u4e8e\u7a7a\u8868\u7684\u95f4\u9699\u7684\u5b9a\u4e49\u3002</p> <p>\u4e00\u4e2a\u7a7a\u8868\u5c31\u53ea\u6709\u4e00\u4e2a\u95f4\u9699\u3002\u6bd4\u5982\uff0c\u5728\u7a7a\u8868\u4e0a\u6267\u884c\uff1a</p> <pre><code>begin;\nselect * from t where id&gt;1 for update;\n</code></pre> <p>\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u52a0\u9501\u7684\u8303\u56f4\u5c31\u662f next-key lock (-\u221e, supremum]\u3002</p> <p>\u9a8c\u8bc1\u65b9\u6cd5\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\u3002</p> session A session B create table t(id int primary key) engine=innodb;begin;select * from t where id &gt; 1 for update; insert into t values(2);(blocked) show engine innodb status \\G; <pre><code>mysql tables in use 1, locked 1\nLOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)\nMySQL thread id 30, OS thread handle 123145585483776, query id 630638 localhost root update\ninsert into tt values(2)\n------- TRX HAS BEEN WAITING 4 SEC FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 498 page no 4 n bits 72 index PRIMARY of table `test`.`tt` trx id 588668 lock_mode X insert intention waiting\nRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0\n 0: len 8; hex 73757072656d756d; asc supremum;;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#32-kill","title":"32 \u4e3a\u4ec0\u4e48\u8fd8\u6709kill\u4e0d\u6389\u7684\u8bed\u53e5\uff1f","text":"<p>\u5728 MySQL \u4e2d\u6709\u4e24\u4e2a kill \u547d\u4ee4\uff1a\u4e00\u4e2a\u662f <code>kill query + \u7ebf\u7a0b id</code>\uff0c\u8868\u793a\u7ec8\u6b62\u8fd9\u4e2a\u7ebf\u7a0b\u4e2d\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\uff1b\u4e00\u4e2a\u662f <code>kill connection + \u7ebf\u7a0b id</code>\uff0c\u8fd9\u91cc connection \u53ef\u7f3a\u7701\uff0c\u8868\u793a\u65ad\u5f00\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u8fde\u63a5\uff0c\u5f53\u7136\u5982\u679c\u8fd9\u4e2a\u7ebf\u7a0b\u6709\u8bed\u53e5\u6b63\u5728\u6267\u884c\uff0c\u4e5f\u662f\u8981\u5148\u505c\u6b62\u6b63\u5728\u6267\u884c\u7684\u8bed\u53e5\u7684\u3002</p> <p>\u4e0d\u77e5\u9053\u4f60\u5728\u4f7f\u7528 MySQL \u7684\u65f6\u5019\uff0c\u6709\u6ca1\u6709\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u73b0\u8c61\uff1a\u4f7f\u7528\u4e86 kill \u547d\u4ee4\uff0c\u5374\u6ca1\u80fd\u65ad\u5f00\u8fd9\u4e2a\u8fde\u63a5\u3002\u518d\u6267\u884c <code>show processlist</code> \u547d\u4ee4\uff0c\u770b\u5230\u8fd9\u6761\u8bed\u53e5\u7684 Command \u5217\u663e\u793a\u7684\u662f Killed\u3002</p> <p>\u4f60\u4e00\u5b9a\u4f1a\u5947\u602a\uff0c\u663e\u793a\u4e3a Killed \u662f\u4ec0\u4e48\u610f\u601d\uff0c\u4e0d\u662f\u5e94\u8be5\u76f4\u63a5\u5728 show processlist \u7684\u7ed3\u679c\u91cc\u770b\u4e0d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u4e86\u5417\uff1f</p> <p>\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u8ba8\u8bba\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u5176\u5b9e\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0ckill query/connection \u547d\u4ee4\u662f\u6709\u6548\u7684\u3002\u6bd4\u5982\uff0c\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u6267\u884c\u65f6\u95f4\u592a\u4e45\uff0c\u8981\u653e\u5f03\u7ee7\u7eed\u67e5\u8be2\uff0c\u8fd9\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u7528 kill query \u547d\u4ee4\uff0c\u7ec8\u6b62\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u3002</p> <p>\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8bed\u53e5\u5904\u4e8e\u9501\u7b49\u5f85\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u4f7f\u7528 kill \u547d\u4ee4\u4e5f\u662f\u6709\u6548\u7684\u3002\u6211\u4eec\u4e00\u8d77\u6765\u770b\u4e0b\u8fd9\u4e2a\u4f8b\u5b50\uff1a</p> session A session B session C begin;update t set c=c+1 where id=1; update t set c=c+1 where id=1;(blocked) ERROR 1317(70100): Query execution was interrupted kill query <code>thread_id_B</code> <p>\u53ef\u4ee5\u770b\u5230\uff0csession C \u6267\u884c kill query \u4ee5\u540e\uff0csession B \u51e0\u4e4e\u540c\u65f6\u5c31\u63d0\u793a\u4e86\u8bed\u53e5\u88ab\u4e2d\u65ad\u3002\u8fd9\uff0c\u5c31\u662f\u6211\u4eec\u9884\u671f\u7684\u7ed3\u679c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#kill","title":"\u6536\u5230 kill \u4ee5\u540e\uff0c\u7ebf\u7a0b\u505a\u4ec0\u4e48\uff1f","text":"<p>\u4f46\u662f\uff0c\u8fd9\u91cc\u4f60\u8981\u505c\u4e0b\u6765\u60f3\u4e00\u4e0b\uff1asession B \u662f\u76f4\u63a5\u7ec8\u6b62\u6389\u7ebf\u7a0b\uff0c\u4ec0\u4e48\u90fd\u4e0d\u7ba1\u5c31\u76f4\u63a5\u9000\u51fa\u5417\uff1f\u663e\u7136\uff0c\u8fd9\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u6211\u5728[\u7b2c 6 \u7bc7\u6587\u7ae0]\u4e2d\u8bb2\u8fc7\uff0c\u5f53\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u65f6\uff0c\u4f1a\u5728\u8868\u4e0a\u52a0 MDL \u8bfb\u9501\u3002\u6240\u4ee5\uff0csession B \u867d\u7136\u5904\u4e8e blocked \u72b6\u6001\uff0c\u4f46\u8fd8\u662f\u62ff\u7740\u4e00\u4e2a MDL \u8bfb\u9501\u7684\u3002\u5982\u679c\u7ebf\u7a0b\u88ab kill \u7684\u65f6\u5019\uff0c\u5c31\u76f4\u63a5\u7ec8\u6b62\uff0c\u90a3\u4e4b\u540e\u8fd9\u4e2a MDL \u8bfb\u9501\u5c31\u6ca1\u673a\u4f1a\u88ab\u91ca\u653e\u4e86\u3002</p> <p>\u8fd9\u6837\u770b\u6765\uff0ckill \u5e76\u4e0d\u662f\u9a6c\u4e0a\u505c\u6b62\u7684\u610f\u601d\uff0c\u800c\u662f\u544a\u8bc9\u6267\u884c\u7ebf\u7a0b\u8bf4\uff0c\u8fd9\u6761\u8bed\u53e5\u5df2\u7ecf\u4e0d\u9700\u8981\u7ee7\u7eed\u6267\u884c\u4e86\uff0c\u53ef\u4ee5\u5f00\u59cb\u201c\u6267\u884c\u505c\u6b62\u7684\u903b\u8f91\u4e86\u201d\u3002</p> <p>\u5176\u5b9e\uff0c\u8fd9\u8ddf Linux \u7684 kill \u547d\u4ee4\u7c7b\u4f3c\uff0ckill -N pid \u5e76\u4e0d\u662f\u8ba9\u8fdb\u7a0b\u76f4\u63a5\u505c\u6b62\uff0c\u800c\u662f\u7ed9\u8fdb\u7a0b\u53d1\u4e00\u4e2a\u4fe1\u53f7\uff0c\u7136\u540e\u8fdb\u7a0b\u5904\u7406\u8fd9\u4e2a\u4fe1\u53f7\uff0c\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u3002\u53ea\u662f\u5bf9\u4e8e MySQL \u7684 kill \u547d\u4ee4\u6765\u8bf4\uff0c\u4e0d\u9700\u8981\u4f20\u4fe1\u53f7\u91cf\u53c2\u6570\uff0c\u5c31\u53ea\u6709\u201c\u505c\u6b62\u201d\u8fd9\u4e2a\u547d\u4ee4\u3002</p> <p>\u5b9e\u73b0\u4e0a\uff0c\u5f53\u7528\u6237\u6267\u884c <code>kill query thread_id_B</code> \u65f6\uff0cMySQL \u91cc\u5904\u7406 kill \u547d\u4ee4\u7684\u7ebf\u7a0b\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a</p> <ol> <li>\u628a session B \u7684\u8fd0\u884c\u72b6\u6001\u6539\u6210 <code>THD::KILL_QUERY</code>(\u5c06\u53d8\u91cf killed \u8d4b\u503c\u4e3a <code>THD::KILL_QUERY</code>)\uff1b</li> <li>\u7ed9 session B \u7684\u6267\u884c\u7ebf\u7a0b\u53d1\u4e00\u4e2a\u4fe1\u53f7\u3002</li> </ol> <p>\u4e3a\u4ec0\u4e48\u8981\u53d1\u4fe1\u53f7\u5462\uff1f</p> <p>\u56e0\u4e3a\u50cf\u56fe 1 \u7684\u6211\u4eec\u4f8b\u5b50\u91cc\u9762\uff0csession B \u5904\u4e8e\u9501\u7b49\u5f85\u72b6\u6001\uff0c\u5982\u679c\u53ea\u662f\u628a session B \u7684\u7ebf\u7a0b\u72b6\u6001\u8bbe\u7f6e  <code>THD::KILL_QUERY</code>\uff0c\u7ebf\u7a0b B \u5e76\u4e0d\u77e5\u9053\u8fd9\u4e2a\u72b6\u6001\u53d8\u5316\uff0c\u8fd8\u662f\u4f1a\u7ee7\u7eed\u7b49\u5f85\u3002\u53d1\u4e00\u4e2a\u4fe1\u53f7\u7684\u76ee\u7684\uff0c\u5c31\u662f\u8ba9 session B \u9000\u51fa\u7b49\u5f85\uff0c\u6765\u5904\u7406\u8fd9\u4e2a  <code>THD::KILL_QUERY</code> \u72b6\u6001\u3002</p> <p>\u4e0a\u9762\u7684\u5206\u6790\u4e2d\uff0c\u9690\u542b\u4e86\u8fd9\u4e48\u4e09\u5c42\u610f\u601d\uff1a</p> <ol> <li>\u4e00\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u6709\u591a\u5904\u201c\u57cb\u70b9\u201d\uff0c\u5728\u8fd9\u4e9b\u201c\u57cb\u70b9\u201d\u7684\u5730\u65b9\u5224\u65ad\u7ebf\u7a0b\u72b6\u6001\uff0c\u5982\u679c\u53d1\u73b0\u7ebf\u7a0b\u72b6\u6001\u662f  <code>THD::KILL_QUERY</code>\uff0c\u624d\u5f00\u59cb\u8fdb\u5165\u8bed\u53e5\u7ec8\u6b62\u903b\u8f91\uff1b</li> <li>\u5982\u679c\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u5fc5\u987b\u662f\u4e00\u4e2a\u53ef\u4ee5\u88ab\u5524\u9192\u7684\u7b49\u5f85\uff0c\u5426\u5219\u6839\u672c\u4e0d\u4f1a\u6267\u884c\u5230\u201c\u57cb\u70b9\u201d\u5904\uff1b</li> <li>\u8bed\u53e5\u4ece\u5f00\u59cb\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\uff0c\u5230\u7ec8\u6b62\u903b\u8f91\u5b8c\u5168\u5b8c\u6210\uff0c\u662f\u6709\u4e00\u4e2a\u8fc7\u7a0b\u7684\u3002</li> </ol> <p>\u5230\u8fd9\u91cc\u4f60\u5c31\u77e5\u9053\u4e86\uff0c\u539f\u6765\u4e0d\u662f\u201c\u8bf4\u505c\u5c31\u505c\u7684\u201d\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec**\u518d\u770b\u4e00\u4e2a kill \u4e0d\u6389\u7684\u4f8b\u5b50**\uff0c\u4e5f\u5c31\u662f <code>innodb_thread_concurrency</code> \u4e0d\u591f\u7528\u7684\u4f8b\u5b50\u3002</p> <p>\u9996\u5148\uff0c\u6267\u884c set global innodb_thread_concurrency=2\uff0c\u5c06 InnoDB \u7684\u5e76\u53d1\u7ebf\u7a0b\u4e0a\u9650\u6570\u8bbe\u7f6e\u4e3a 2\uff1b\u7136\u540e\uff0c\u6267\u884c\u4e0b\u9762\u7684\u5e8f\u5217\uff1a</p> <pre><code>sequenceDiagram\nparticipant SessionA\nparticipant SessionB\nparticipant SessionC\nparticipant SessionD\nparticipant SessionE\nparticipant Table\npar \nSessionA -&gt;&gt;Table: select sleep(100) from t;\nand \nSessionB -&gt;&gt; Table: select sleep(100) from t;\nend\nSessionC -&gt;&gt;+ Table: select * from t\nTable --&gt;&gt;- SessionC: blocked\n\nSessionD -&gt;&gt; Table: kill query SessionC\npar\nSessionE -&gt;&gt; Table: kill SessionC\nand \nTable --&gt;&gt; SessionC: ERROR 2013(HY000): Lost connection to MySQL server during query\nend</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a</p> <ol> <li> <p>sesssion C \u6267\u884c\u7684\u65f6\u5019\u88ab\u5835\u4f4f\u4e86\uff1b</p> </li> <li> <p>\u4f46\u662f session D \u6267\u884c\u7684 kill query C \u547d\u4ee4\u5374\u6ca1\u4ec0\u4e48\u6548\u679c\uff0c</p> </li> <li> <p>\u76f4\u5230 session E \u6267\u884c\u4e86 kill connection \u547d\u4ee4\uff0c\u624d\u65ad\u5f00\u4e86 session C \u7684\u8fde\u63a5\uff0c\u63d0\u793a\u201cLost connection to MySQL server during query\u201d\uff0c</p> </li> <li> <p>\u4f46\u662f\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u5728 session E \u4e2d\u6267\u884c show processlist\uff0c\u4f60\u5c31\u80fd\u770b\u5230\u4e0b\u9762\u8fd9\u4e2a\u56fe\u3002</p> </li> </ol> <pre><code>mysql&gt; show processlist;\n+----+------+-----------------+------+---------+------+--------------+---------------------------+\n| Id | User | Host            | db   | Command | Time | State        | Info                      |\n+----+------+-----------------+------+---------+------+--------------+---------------------------+\n|  4 | root | localhost:50934 | test | Query  |    30 | User sleep   | select sleep(100) from t  |\n|  5 | root | localhost:50956 | test | Query  |    26 | User sleep   | select sleep(100) from t  |\n| 12 | root | localhost:53288 | test | Query  |    24 | Sending data | select * from t           |\n+----+------+-----------------+------+---------+------+--------------+---------------------------+\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0cid=12 \u8fd9\u4e2a\u7ebf\u7a0b\u7684 Commnad \u5217\u663e\u793a\u7684\u662f Killed\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5ba2\u6237\u7aef\u867d\u7136\u65ad\u5f00\u4e86\u8fde\u63a5\uff0c\u4f46\u5b9e\u9645\u4e0a\u670d\u52a1\u7aef\u4e0a\u8fd9\u6761\u8bed\u53e5\u8fd8\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u3002</p> <p>\u4e3a\u4ec0\u4e48\u5728\u6267\u884c kill query \u547d\u4ee4\u65f6\uff0c\u8fd9\u6761\u8bed\u53e5\u4e0d\u50cf\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u7684 update \u8bed\u53e5\u4e00\u6837\u9000\u51fa\u5462\uff1f</p> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c\u7b49\u884c\u9501\u65f6\uff0c\u4f7f\u7528\u7684\u662f pthread_cond_timedwait \u51fd\u6570\uff0c\u8fd9\u4e2a\u7b49\u5f85\u72b6\u6001\u53ef\u4ee5\u88ab\u5524\u9192\u3002\u4f46\u662f\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c12 \u53f7\u7ebf\u7a0b\u7684\u7b49\u5f85\u903b\u8f91\u662f\u8fd9\u6837\u7684\uff1a\u6bcf 10 \u6beb\u79d2\u5224\u65ad\u4e00\u4e0b\u662f\u5426\u53ef\u4ee5\u8fdb\u5165 InnoDB \u6267\u884c\uff0c\u5982\u679c\u4e0d\u884c\uff0c\u5c31\u8c03\u7528 nanosleep \u51fd\u6570\u8fdb\u5165 sleep \u72b6\u6001\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u867d\u7136 12 \u53f7\u7ebf\u7a0b\u7684\u72b6\u6001\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u6210\u4e86 KILL_QUERY\uff0c\u4f46\u662f\u5728\u8fd9\u4e2a\u7b49\u5f85\u8fdb\u5165 InnoDB \u7684\u5faa\u73af\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u6ca1\u6709\u53bb\u5224\u65ad\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u56e0\u6b64\u6839\u672c\u4e0d\u4f1a\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002</p> <p>\u800c\u5f53 session E \u6267\u884c kill connection \u547d\u4ee4\u65f6\uff0c\u662f\u8fd9\u4e48\u505a\u7684\uff0c</p> <ol> <li>\u628a 12 \u53f7\u7ebf\u7a0b\u72b6\u6001\u8bbe\u7f6e\u4e3a KILL_CONNECTION\uff1b</li> <li>\u5173\u6389 12 \u53f7\u7ebf\u7a0b\u7684\u7f51\u7edc\u8fde\u63a5\u3002\u56e0\u4e3a\u6709\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u6240\u4ee5\u4f60\u4f1a\u770b\u5230\uff0c\u8fd9\u65f6\u5019 session C \u6536\u5230\u4e86\u65ad\u5f00\u8fde\u63a5\u7684\u63d0\u793a\u3002</li> </ol> <p>\u90a3\u4e3a\u4ec0\u4e48\u6267\u884c show processlist \u7684\u65f6\u5019\uff0c\u4f1a\u770b\u5230 Command \u5217\u663e\u793a\u4e3a killed \u5462\uff1f\u5176\u5b9e\uff0c\u8fd9\u5c31\u662f\u56e0\u4e3a\u5728\u6267\u884c show processlist \u7684\u65f6\u5019\uff0c\u6709\u4e00\u4e2a\u7279\u522b\u7684\u903b\u8f91\uff1a</p> <pre><code>\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u662f KILL_CONNECTION\uff0c\u5c31\u628a Command \u5217\u663e\u793a\u6210 Killed\u3002\n</code></pre> <p>\u6240\u4ee5\u5176\u5b9e\uff0c\u5373\u4f7f\u662f\u5ba2\u6237\u7aef\u9000\u51fa\u4e86\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\u4ecd\u7136\u662f\u5728\u7b49\u5f85\u4e2d\u3002\u90a3\u8fd9\u4e2a\u7ebf\u7a0b\u4ec0\u4e48\u65f6\u5019\u4f1a\u9000\u51fa\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u53ea\u6709\u7b49\u5230\u6ee1\u8db3\u8fdb\u5165 InnoDB \u7684\u6761\u4ef6\u540e\uff0csession C \u7684\u67e5\u8be2\u8bed\u53e5\u7ee7\u7eed\u6267\u884c\uff0c\u7136\u540e\u624d\u6709\u53ef\u80fd\u5224\u65ad\u5230\u7ebf\u7a0b\u72b6\u6001\u5df2\u7ecf\u53d8\u6210\u4e86 KILL_QUERY \u6216\u8005 KILL_CONNECTION\uff0c\u518d\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u6765\u5c0f\u7ed3\u4e00\u4e0b\u3002</p> <p>**\u8fd9\u4e2a\u4f8b\u5b50\u662f kill \u65e0\u6548\u7684\u7b2c\u4e00\u7c7b\u60c5\u51b5\uff0c\u5373\uff1a\u7ebf\u7a0b\u6ca1\u6709\u6267\u884c\u5230\u5224\u65ad\u7ebf\u7a0b\u72b6\u6001\u7684\u903b\u8f91\u3002**\u8ddf\u8fd9\u79cd\u60c5\u51b5\u76f8\u540c\u7684\uff0c\u8fd8\u6709\u7531\u4e8e IO \u538b\u529b\u8fc7\u5927\uff0c\u8bfb\u5199 IO \u7684\u51fd\u6570\u4e00\u76f4\u65e0\u6cd5\u8fd4\u56de\uff0c\u5bfc\u81f4\u4e0d\u80fd\u53ca\u65f6\u5224\u65ad\u7ebf\u7a0b\u7684\u72b6\u6001\u3002</p> <p>**\u53e6\u4e00\u7c7b\u60c5\u51b5\u662f\uff0c\u7ec8\u6b62\u903b\u8f91\u8017\u65f6\u8f83\u957f\u3002**\u8fd9\u65f6\u5019\uff0c\u4ece show processlist \u7ed3\u679c\u4e0a\u770b\u4e5f\u662f Command=Killed\uff0c\u9700\u8981\u7b49\u5230\u7ec8\u6b62\u903b\u8f91\u5b8c\u6210\uff0c\u8bed\u53e5\u624d\u7b97\u771f\u6b63\u5b8c\u6210\u3002\u8fd9\u7c7b\u60c5\u51b5\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u573a\u666f\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ol> <li>\u8d85\u5927\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u88ab kill\u3002\u8fd9\u65f6\u5019\uff0c\u56de\u6eda\u64cd\u4f5c\u9700\u8981\u5bf9\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u65b0\u6570\u636e\u7248\u672c\u505a\u56de\u6536\u64cd\u4f5c\uff0c\u8017\u65f6\u5f88\u957f\u3002</li> <li>\u5927\u67e5\u8be2\u56de\u6eda\u3002\u5982\u679c\u67e5\u8be2\u8fc7\u7a0b\u4e2d\u751f\u6210\u4e86\u6bd4\u8f83\u5927\u7684\u4e34\u65f6\u6587\u4ef6\uff0c\u52a0\u4e0a\u6b64\u65f6\u6587\u4ef6\u7cfb\u7edf\u538b\u529b\u5927\uff0c\u5220\u9664\u4e34\u65f6\u6587\u4ef6\u53ef\u80fd\u9700\u8981\u7b49\u5f85 IO \u8d44\u6e90\uff0c\u5bfc\u81f4\u8017\u65f6\u8f83\u957f\u3002</li> <li>DDL \u547d\u4ee4\u6267\u884c\u5230\u6700\u540e\u9636\u6bb5\uff0c\u5982\u679c\u88ab kill\uff0c\u9700\u8981\u5220\u9664\u4e2d\u95f4\u8fc7\u7a0b\u7684\u4e34\u65f6\u6587\u4ef6\uff0c\u4e5f\u53ef\u80fd\u53d7 IO \u8d44\u6e90\u5f71\u54cd\u8017\u65f6\u8f83\u4e45\u3002</li> </ol> <p>\u4e4b\u524d\u6709\u4eba\u95ee\u8fc7\u6211\uff0c\u5982\u679c\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u901a\u8fc7 Ctrl+C \u547d\u4ee4\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u76f4\u63a5\u7ec8\u6b62\u7ebf\u7a0b\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u4e0d\u53ef\u4ee5\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u8bef\u89e3\uff0c\u5176\u5b9e\u5728\u5ba2\u6237\u7aef\u7684\u64cd\u4f5c\u53ea\u80fd\u64cd\u4f5c\u5230\u5ba2\u6237\u7aef\u7684\u7ebf\u7a0b\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u53ea\u80fd\u901a\u8fc7\u7f51\u7edc\u4ea4\u4e92\uff0c\u662f\u4e0d\u53ef\u80fd\u76f4\u63a5\u64cd\u4f5c\u670d\u52a1\u7aef\u7ebf\u7a0b\u7684\u3002</p> <p>\u800c\u7531\u4e8e MySQL \u662f\u505c\u7b49\u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u4e2a\u7ebf\u7a0b\u6267\u884c\u7684\u8bed\u53e5\u8fd8\u6ca1\u6709\u8fd4\u56de\u7684\u65f6\u5019\uff0c\u518d\u5f80\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7ee7\u7eed\u53d1\u547d\u4ee4\u4e5f\u662f\u6ca1\u6709\u7528\u7684\u3002\u5b9e\u9645\u4e0a\uff0c\u6267\u884c Ctrl+C \u7684\u65f6\u5019\uff0c\u662f MySQL \u5ba2\u6237\u7aef\u53e6\u5916\u542f\u52a8\u4e00\u4e2a\u8fde\u63a5\uff0c\u7136\u540e\u53d1\u9001\u4e00\u4e2a kill query \u547d\u4ee4\u3002</p> <p>\u6240\u4ee5\uff0c\u4f60\u53ef\u522b\u4ee5\u4e3a\u5728\u5ba2\u6237\u7aef\u6267\u884c\u5b8c Ctrl+C \u5c31\u4e07\u4e8b\u5927\u5409\u4e86\u3002\u56e0\u4e3a\uff0c\u8981 kill \u6389\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8fd8\u6d89\u53ca\u5230\u540e\u7aef\u7684\u5f88\u591a\u64cd\u4f5c\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_12","title":"\u5c0f\u7ed3","text":"<p>\u5728\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u9996\u5148\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u4e2d\uff0c\u6709\u4e9b\u8bed\u53e5\u548c\u8fde\u63a5\u201ckill \u4e0d\u6389\u201d\u7684\u60c5\u51b5\u3002</p> <p>\u8fd9\u4e9b\u201ckill \u4e0d\u6389\u201d\u7684\u60c5\u51b5\uff0c\u5176\u5b9e\u662f\u56e0\u4e3a\u53d1\u9001 kill \u547d\u4ee4\u7684\u5ba2\u6237\u7aef\uff0c\u5e76\u6ca1\u6709\u5f3a\u884c\u505c\u6b62\u76ee\u6807\u7ebf\u7a0b\u7684\u6267\u884c\uff0c\u800c\u53ea\u662f\u8bbe\u7f6e\u4e86\u4e2a\u72b6\u6001\uff0c\u5e76\u5524\u9192\u5bf9\u5e94\u7684\u7ebf\u7a0b\u3002\u800c\u88ab kill \u7684\u7ebf\u7a0b\uff0c\u9700\u8981\u6267\u884c\u5230\u5224\u65ad\u72b6\u6001\u7684\u201c\u57cb\u70b9\u201d\uff0c\u624d\u4f1a\u5f00\u59cb\u8fdb\u5165\u7ec8\u6b62\u903b\u8f91\u9636\u6bb5\u3002\u5e76\u4e14\uff0c\u7ec8\u6b62\u903b\u8f91\u672c\u8eab\u4e5f\u662f\u9700\u8981\u8017\u8d39\u65f6\u95f4\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u53d1\u73b0\u4e00\u4e2a\u7ebf\u7a0b\u5904\u4e8e Killed \u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff0c\u901a\u8fc7\u5f71\u54cd\u7cfb\u7edf\u73af\u5883\uff0c\u8ba9\u8fd9\u4e2a Killed \u72b6\u6001\u5c3d\u5feb\u7ed3\u675f\u3002</p> <p>\u6bd4\u5982\uff0c\u5982\u679c\u662f\u7b2c\u4e00\u4e2a\u4f8b\u5b50\u91cc InnoDB \u5e76\u53d1\u5ea6\u7684\u95ee\u9898\uff0c\u4f60\u5c31\u53ef\u4ee5\u4e34\u65f6\u8c03\u5927 <code>innodb_thread_concurrency</code> \u7684\u503c\uff0c\u6216\u8005\u505c\u6389\u522b\u7684\u7ebf\u7a0b\uff0c\u8ba9\u51fa\u4f4d\u5b50\u7ed9\u8fd9\u4e2a\u7ebf\u7a0b\u6267\u884c\u3002</p> <p>\u800c\u5982\u679c\u662f\u56de\u6eda\u903b\u8f91\u7531\u4e8e\u53d7\u5230 IO \u8d44\u6e90\u9650\u5236\u6267\u884c\u5f97\u6bd4\u8f83\u6162\uff0c\u5c31\u901a\u8fc7\u51cf\u5c11\u7cfb\u7edf\u538b\u529b\u8ba9\u5b83\u52a0\u901f\u3002</p> <p>\u505a\u5b8c\u8fd9\u4e9b\u64cd\u4f5c\u540e\uff0c\u5176\u5b9e\u4f60\u5df2\u7ecf\u6ca1\u6709\u529e\u6cd5\u518d\u5bf9\u5b83\u505a\u4ec0\u4e48\u4e86\uff0c\u53ea\u80fd\u7b49\u5f85\u6d41\u7a0b\u81ea\u5df1\u5b8c\u6210\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#33","title":"33 \u6211\u67e5\u8fd9\u4e48\u591a\u6570\u636e\uff0c\u4f1a\u4e0d\u4f1a\u628a\u6570\u636e\u5e93\u5185\u5b58\u6253\u7206\uff1f","text":"<p>\u6211\u7ecf\u5e38\u4f1a\u88ab\u95ee\u5230\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a\u6211\u7684\u4e3b\u673a\u5185\u5b58\u53ea\u6709 100G\uff0c\u73b0\u5728\u8981\u5bf9\u4e00\u4e2a 200G \u7684\u5927\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u4f1a\u4e0d\u4f1a\u628a\u6570\u636e\u5e93\u4e3b\u673a\u7684\u5185\u5b58\u7528\u5149\u4e86\uff1f</p> <p>\u8fd9\u4e2a\u95ee\u9898\u786e\u5b9e\u503c\u5f97\u62c5\u5fc3\uff0c\u88ab\u7cfb\u7edf OOM\uff08out of memory\uff09\u53ef\u4e0d\u662f\u95f9\u7740\u73a9\u7684\u3002\u4f46\u662f\uff0c\u53cd\u8fc7\u6765\u60f3\u60f3\uff0c\u903b\u8f91\u5907\u4efd\u7684\u65f6\u5019\uff0c\u53ef\u4e0d\u5c31\u662f\u505a\u6574\u5e93\u626b\u63cf\u5417\uff1f\u5982\u679c\u8fd9\u6837\u5c31\u4f1a\u628a\u5185\u5b58\u5403\u5149\uff0c\u903b\u8f91\u5907\u4efd\u4e0d\u662f\u65e9\u5c31\u6302\u4e86\uff1f</p> <p>\u6240\u4ee5\u8bf4\uff0c\u5bf9\u5927\u8868\u505a\u5168\u8868\u626b\u63cf\uff0c\u770b\u6765\u5e94\u8be5\u662f\u6ca1\u95ee\u9898\u7684\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u6d41\u7a0b\u5230\u5e95\u662f\u600e\u4e48\u6837\u7684\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#server","title":"\u5168\u8868\u626b\u63cf\u5bf9 server \u5c42\u7684\u5f71\u54cd","text":"<p>\u5047\u8bbe\uff0c\u6211\u4eec\u73b0\u5728\u8981\u5bf9\u4e00\u4e2a 200G \u7684 InnoDB \u8868 db1. t\uff0c\u6267\u884c\u4e00\u4e2a\u5168\u8868\u626b\u63cf\u3002\u5f53\u7136\uff0c\u4f60\u8981\u628a\u626b\u63cf\u7ed3\u679c\u4fdd\u5b58\u5728\u5ba2\u6237\u7aef\uff0c\u4f1a\u4f7f\u7528\u7c7b\u4f3c\u8fd9\u6837\u7684\u547d\u4ee4\uff1a</p> <pre><code>mysql -h$host -P$port -u$user -p$pwd -e \"select * from db1.t\" &gt; $target_file\n</code></pre> <p>\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\uff0cInnoDB \u7684\u6570\u636e\u662f\u4fdd\u5b58\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u7684\uff0c\u6240\u4ee5\u5168\u8868\u626b\u63cf\u5b9e\u9645\u4e0a\u662f\u76f4\u63a5\u626b\u63cf\u8868 t \u7684\u4e3b\u952e\u7d22\u5f15\u3002\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u7531\u4e8e\u6ca1\u6709\u5176\u4ed6\u7684\u5224\u65ad\u6761\u4ef6\uff0c\u6240\u4ee5\u67e5\u5230\u7684\u6bcf\u4e00\u884c\u90fd\u53ef\u4ee5\u76f4\u63a5\u653e\u5230\u7ed3\u679c\u96c6\u91cc\u9762\uff0c\u7136\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</p> <p>\u90a3\u4e48\uff0c\u8fd9\u4e2a\u201c\u7ed3\u679c\u96c6\u201d\u5b58\u5728\u54ea\u91cc\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a\uff0c\u670d\u52a1\u7aef\u5e76\u4e0d\u9700\u8981\u4fdd\u5b58\u4e00\u4e2a\u5b8c\u6574\u7684\u7ed3\u679c\u96c6\u3002\u53d6\u6570\u636e\u548c\u53d1\u6570\u636e\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u83b7\u53d6\u4e00\u884c\uff0c\u5199\u5230 <code>net_buffer</code> \u4e2d\u3002\u8fd9\u5757\u5185\u5b58\u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>net_buffer_length</code> \u5b9a\u4e49\u7684\uff0c\u9ed8\u8ba4\u662f 16k\u3002</li> <li>\u91cd\u590d\u83b7\u53d6\u884c\uff0c\u76f4\u5230 <code>net_buffer</code> \u5199\u6ee1\uff0c\u8c03\u7528\u7f51\u7edc\u63a5\u53e3\u53d1\u51fa\u53bb\u3002</li> <li>\u5982\u679c\u53d1\u9001\u6210\u529f\uff0c\u5c31\u6e05\u7a7a <code>net_buffer</code>\uff0c\u7136\u540e\u7ee7\u7eed\u53d6\u4e0b\u4e00\u884c\uff0c\u5e76\u5199\u5165 <code>net_buffer</code>\u3002</li> <li>\u5982\u679c\u53d1\u9001\u51fd\u6570\u8fd4\u56de EAGAIN \u6216 WSAEWOULDBLOCK\uff0c\u5c31\u8868\u793a\u672c\u5730\u7f51\u7edc\u6808\uff08socket send buffer\uff09\u5199\u6ee1\u4e86\uff0c\u8fdb\u5165\u7b49\u5f85\u3002\u76f4\u5230\u7f51\u7edc\u6808\u91cd\u65b0\u53ef\u5199\uff0c\u518d\u7ee7\u7eed\u53d1\u9001\u3002</li> </ol> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5bf9\u5e94\u7684\u6d41\u7a0b\u56fe\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>%%{init: {\"theme\": \"dark\"}}%%\ngraph LR\nsubgraph client\nnode1[\"socket receive buffer\"]\nend\nsubgraph server\n  subgraph MySQL\n    direction TB\n    data --&gt; net_buffer\n  end\n  net_buffer --&gt; node2[\"socket send buffer\"]\nend\nserver --&gt; client</code></pre> <p>\u4ece\u8fd9\u4e2a\u6d41\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff1a</p> <ol> <li>\u4e00\u4e2a\u67e5\u8be2\u5728\u53d1\u9001\u8fc7\u7a0b\u4e2d\uff0c\u5360\u7528\u7684 MySQL \u5185\u90e8\u7684\u5185\u5b58\u6700\u5927\u5c31\u662f <code>net_buffer_length</code> \u8fd9\u4e48\u5927\uff0c\u5e76\u4e0d\u4f1a\u8fbe\u5230 200G\uff1b</li> <li>socket send buffer \u4e5f\u4e0d\u53ef\u80fd\u8fbe\u5230 200G\uff08\u9ed8\u8ba4\u5b9a\u4e49 <code>/proc/sys/net/core/wmem_default</code>\uff09\uff0c\u5982\u679c socket send buffer \u88ab\u5199\u6ee1\uff0c\u5c31\u4f1a\u6682\u505c\u8bfb\u6570\u636e\u7684\u6d41\u7a0b\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cMySQL \u662f\u201c\u8fb9\u8bfb\u8fb9\u53d1\u7684\u201d\uff0c\u8fd9\u4e2a\u6982\u5ff5\u5f88\u91cd\u8981\u3002\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u63a5\u6536\u5f97\u6162\uff0c\u4f1a\u5bfc\u81f4 MySQL \u670d\u52a1\u7aef\u7531\u4e8e\u7ed3\u679c\u53d1\u4e0d\u51fa\u53bb\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u7684\u6267\u884c\u65f6\u95f4\u53d8\u957f\u3002</p> <p>\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u72b6\u6001\uff0c\u5c31\u662f\u6211\u6545\u610f\u8ba9\u5ba2\u6237\u7aef\u4e0d\u53bb\u8bfb socket receive buffer \u4e2d\u7684\u5185\u5bb9\uff0c\u7136\u540e\u5728\u670d\u52a1\u7aef show processlist \u770b\u5230\u7684\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; show processlist;\n+----+-----------------+-----------+------+---------+--------+------------------------+------------------+\n| Id | User            | Host      | db   | Command | Time   | State                  | Info             |\n+----+-----------------+-----------+------+---------+--------+------------------------+------------------+\n|  4 | event_scheduler | localhost | NULL | Daemon  | 151029 | Waiting on empty queue | NULL             |\n| 31 | root            | localhost | test | Query   |      0 | starting               | show processlist |\n| 32 | root            | localhost | test | Query   |      9 | Sending to client      | select * from t  |\n+----+-----------------+-----------+------+---------+--------+------------------------+------------------+\n</code></pre> <p>\u5982\u679c\u4f60\u770b\u5230 State \u7684\u503c\u4e00\u76f4\u5904\u4e8e**\u201cSending to client\u201d**\uff0c\u5c31\u8868\u793a\u670d\u52a1\u5668\u7aef\u7684\u7f51\u7edc\u6808\u5199\u6ee1\u4e86\u3002</p> <p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u66fe\u63d0\u5230\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u4f7f\u7528 <code>\u2013-quick</code> \u53c2\u6570\uff0c\u4f1a\u4f7f\u7528 <code>mysql_use_result</code> \u65b9\u6cd5\u3002\u8fd9\u4e2a\u65b9\u6cd5\u662f\u8bfb\u4e00\u884c\u5904\u7406\u4e00\u884c\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5047\u8bbe\u6709\u4e00\u4e2a\u4e1a\u52a1\u7684\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u6bcf\u8bfb\u4e00\u884c\u6570\u636e\u4ee5\u540e\u8981\u5904\u7406\u7684\u903b\u8f91\u5982\u679c\u5f88\u6162\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5ba2\u6237\u7aef\u8981\u8fc7\u5f88\u4e45\u624d\u4f1a\u53bb\u53d6\u4e0b\u4e00\u884c\u6570\u636e\uff0c\u53ef\u80fd\u5c31\u4f1a\u51fa\u73b0\u5982\u56fe \u6240\u793a\u7684\u8fd9\u79cd\u60c5\u51b5\u3002</p> <p>\u56e0\u6b64\uff0c\u5bf9\u4e8e\u6b63\u5e38\u7684\u7ebf\u4e0a\u4e1a\u52a1\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u7684\u8fd4\u56de\u7ed3\u679c\u4e0d\u4f1a\u5f88\u591a\u7684\u8bdd\uff0c\u6211\u90fd\u5efa\u8bae\u4f60\u4f7f\u7528 <code>mysql_store_result</code> \u8fd9\u4e2a\u63a5\u53e3\uff0c\u76f4\u63a5\u628a\u67e5\u8be2\u7ed3\u679c\u4fdd\u5b58\u5230\u672c\u5730\u5185\u5b58\u3002</p> <p>\u5f53\u7136\u524d\u63d0\u662f\u67e5\u8be2\u8fd4\u56de\u7ed3\u679c\u4e0d\u591a\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u5982\u679c\u4f60\u5728\u81ea\u5df1\u8d1f\u8d23\u7ef4\u62a4\u7684 MySQL \u91cc\u770b\u5230\u5f88\u591a\u4e2a\u7ebf\u7a0b\u90fd\u5904\u4e8e\u201cSending to client\u201d\u8fd9\u4e2a\u72b6\u6001\uff0c\u5c31\u610f\u5473\u7740\u4f60\u8981\u8ba9\u4e1a\u52a1\u5f00\u53d1\u540c\u5b66\u4f18\u5316\u67e5\u8be2\u7ed3\u679c\uff0c\u5e76\u8bc4\u4f30\u8fd9\u4e48\u591a\u7684\u8fd4\u56de\u7ed3\u679c\u662f\u5426\u5408\u7406\u3002</p> <p>\u800c\u5982\u679c\u8981\u5feb\u901f\u51cf\u5c11\u5904\u4e8e\u8fd9\u4e2a\u72b6\u6001\u7684\u7ebf\u7a0b\u7684\u8bdd\uff0c\u5c06 <code>net_buffer_length</code> \u53c2\u6570\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u66f4\u5927\u7684\u503c\u662f\u4e00\u4e2a\u53ef\u9009\u65b9\u6848\u3002</p> <p>\u4e0e \u201cSending to client\u201d \u957f\u76f8\u5f88\u7c7b\u4f3c\u7684\u4e00\u4e2a\u72b6\u6001\u662f \u201cSending data\u201d\uff0c\u8fd9\u662f\u4e00\u4e2a\u7ecf\u5e38\u88ab\u8bef\u4f1a\u7684\u95ee\u9898\u3002\u6709\u540c\u5b66\u95ee\u6211\u8bf4\uff0c\u5728\u81ea\u5df1\u7ef4\u62a4\u7684\u5b9e\u4f8b\u4e0a\u770b\u5230\u5f88\u591a\u67e5\u8be2\u8bed\u53e5\u7684\u72b6\u6001\u662f\u201cSending data\u201d\uff0c\u4f46\u67e5\u770b\u7f51\u7edc\u4e5f\u6ca1\u4ec0\u4e48\u95ee\u9898\u554a\uff0c\u4e3a\u4ec0\u4e48 Sending data \u8981\u8fd9\u4e48\u4e45\uff1f</p> <p>\u5b9e\u9645\u4e0a\uff0c\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u72b6\u6001\u53d8\u5316\u662f\u8fd9\u6837\u7684\uff08\u6ce8\u610f\uff1a\u8fd9\u91cc\uff0c\u6211\u7565\u53bb\u4e86\u5176\u4ed6\u65e0\u5173\u7684\u72b6\u6001\uff09\uff1a</p> <ul> <li>MySQL \u67e5\u8be2\u8bed\u53e5\u8fdb\u5165\u6267\u884c\u9636\u6bb5\u540e\uff0c\u9996\u5148\u628a\u72b6\u6001\u8bbe\u7f6e\u6210\u201cSending data\u201d\uff1b</li> <li>\u7136\u540e\uff0c\u53d1\u9001\u6267\u884c\u7ed3\u679c\u7684\u5217\u76f8\u5173\u7684\u4fe1\u606f\uff08meta data) \u7ed9\u5ba2\u6237\u7aef\uff1b</li> <li>\u518d\u7ee7\u7eed\u6267\u884c\u8bed\u53e5\u7684\u6d41\u7a0b\uff1b</li> <li>\u6267\u884c\u5b8c\u6210\u540e\uff0c\u628a\u72b6\u6001\u8bbe\u7f6e\u6210\u7a7a\u5b57\u7b26\u4e32\u3002</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u201cSending data\u201d\u5e76\u4e0d\u4e00\u5b9a\u662f\u6307\u201c\u6b63\u5728\u53d1\u9001\u6570\u636e\u201d\uff0c\u800c\u53ef\u80fd\u662f\u5904\u4e8e\u6267\u884c\u5668\u8fc7\u7a0b\u4e2d\u7684\u4efb\u610f\u9636\u6bb5\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4ec5\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u5904\u4e8e\u201c\u7b49\u5f85\u5ba2\u6237\u7aef\u63a5\u6536\u7ed3\u679c\u201d\u7684\u72b6\u6001\uff0c\u624d\u4f1a\u663e\u793a\"Sending to client\"\uff1b\u800c\u5982\u679c\u663e\u793a\u6210\u201cSending data\u201d\uff0c\u5b83\u7684\u610f\u601d\u53ea\u662f\u201c\u6b63\u5728\u6267\u884c\u201d\u3002</p> <p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0c\u67e5\u8be2\u7684\u7ed3\u679c\u662f\u5206\u6bb5\u53d1\u7ed9\u5ba2\u6237\u7aef\u7684\uff0c\u56e0\u6b64\u626b\u63cf\u5168\u8868\uff0c\u67e5\u8be2\u8fd4\u56de\u5927\u91cf\u7684\u6570\u636e\uff0c\u5e76\u4e0d\u4f1a\u628a\u5185\u5b58\u6253\u7206\u3002</p> <p>\u5728 server \u5c42\u7684\u5904\u7406\u903b\u8f91\u6211\u4eec\u90fd\u6e05\u695a\u4e86\uff0c\u5728 InnoDB \u5f15\u64ce\u91cc\u9762\u53c8\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f \u626b\u63cf\u5168\u8868\u4f1a\u4e0d\u4f1a\u5bf9\u5f15\u64ce\u7cfb\u7edf\u9020\u6210\u5f71\u54cd\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#innodb","title":"\u5168\u8868\u626b\u63cf\u5bf9 InnoDB \u7684\u5f71\u54cd","text":"<p>\u5185\u5b58\u7684\u6570\u636e\u9875\u662f\u5728 Buffer Pool (BP) \u4e2d\u7ba1\u7406\u7684\uff0c\u5728 WAL \u91cc Buffer Pool \u8d77\u5230\u4e86\u52a0\u901f\u66f4\u65b0\u7684\u4f5c\u7528\u3002\u800c\u5b9e\u9645\u4e0a\uff0cBuffer Pool \u8fd8\u6709\u4e00\u4e2a\u66f4\u91cd\u8981\u7684\u4f5c\u7528\uff0c\u5c31\u662f\u52a0\u901f\u67e5\u8be2\u3002</p> <p>\u5728\u7b2c 2 \u7bc7\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u6709\u540c\u5b66\u95ee\u9053\uff0c\u7531\u4e8e\u6709 WAL \u673a\u5236\uff0c\u5f53\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u9875\u662f\u65e7\u7684\uff0c\u90a3\u5982\u679c\u8fd9\u65f6\u5019\u9a6c\u4e0a\u6709\u4e00\u4e2a\u67e5\u8be2\u8981\u6765\u8bfb\u8fd9\u4e2a\u6570\u636e\u9875\uff0c\u662f\u4e0d\u662f\u8981\u9a6c\u4e0a\u628a redo log \u5e94\u7528\u5230\u6570\u636e\u9875\u5462\uff1f</p> <p>\u7b54\u6848\u662f\u4e0d\u9700\u8981\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019\u5185\u5b58\u6570\u636e\u9875\u7684\u7ed3\u679c\u662f\u6700\u65b0\u7684\uff0c\u76f4\u63a5\u8bfb\u5185\u5b58\u9875\u5c31\u53ef\u4ee5\u4e86\u3002\u4f60\u770b\uff0c\u8fd9\u65f6\u5019\u67e5\u8be2\u6839\u672c\u4e0d\u9700\u8981\u8bfb\u78c1\u76d8\uff0c\u76f4\u63a5\u4ece\u5185\u5b58\u62ff\u7ed3\u679c\uff0c\u901f\u5ea6\u662f\u5f88\u5feb\u7684\u3002\u6240\u4ee5\u8bf4\uff0cBuffer Pool \u8fd8\u6709\u52a0\u901f\u67e5\u8be2\u7684\u4f5c\u7528\u3002</p> <p>\u800c Buffer Pool \u5bf9\u67e5\u8be2\u7684\u52a0\u901f\u6548\u679c\uff0c\u4f9d\u8d56\u4e8e\u4e00\u4e2a\u91cd\u8981\u7684\u6307\u6807\uff0c\u5373\uff1a\u5185\u5b58\u547d\u4e2d\u7387\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728 <code>show engine innodb status</code> \u7ed3\u679c\u4e2d\uff0c\u67e5\u770b\u4e00\u4e2a\u7cfb\u7edf\u5f53\u524d\u7684 BP \u547d\u4e2d\u7387\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u7a33\u5b9a\u670d\u52a1\u7684\u7ebf\u4e0a\u7cfb\u7edf\uff0c\u8981\u4fdd\u8bc1\u54cd\u5e94\u65f6\u95f4\u7b26\u5408\u8981\u6c42\u7684\u8bdd\uff0c\u5185\u5b58\u547d\u4e2d\u7387\u8981\u5728 99% \u4ee5\u4e0a\u3002</p> <p>\u6267\u884c <code>show engine innodb status</code> \uff0c\u53ef\u4ee5\u770b\u5230\u201cBuffer pool hit rate\u201d\u5b57\u6837\uff0c\u663e\u793a\u7684\u5c31\u662f\u5f53\u524d\u7684\u547d\u4e2d\u7387\u3002</p> <pre><code>Buffer pool hit rate 1000 / 1000, young-making rate 19 / 1000 not 0 / 1000\n</code></pre> <p>\u5982\u679c\u6240\u6709\u67e5\u8be2\u9700\u8981\u7684\u6570\u636e\u9875\u90fd\u80fd\u591f\u76f4\u63a5\u4ece\u5185\u5b58\u5f97\u5230\uff0c\u90a3\u662f\u6700\u597d\u7684\uff0c\u5bf9\u5e94\u7684\u547d\u4e2d\u7387\u5c31\u662f 100%\u3002\u4f46\uff0c\u8fd9\u5728\u5b9e\u9645\u751f\u4ea7\u4e0a\u662f\u5f88\u96be\u505a\u5230\u7684\u3002</p> <p>InnoDB Buffer Pool \u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>innodb_buffer_pool_size</code> \u786e\u5b9a\u7684\uff0c\u4e00\u822c\u5efa\u8bae\u8bbe\u7f6e\u6210\u53ef\u7528\u7269\u7406\u5185\u5b58\u7684 60%~80%\u3002</p> <p>\u5728\u5927\u7ea6\u5341\u5e74\u524d\uff0c\u5355\u673a\u7684\u6570\u636e\u91cf\u662f\u4e0a\u767e\u4e2a G\uff0c\u800c\u7269\u7406\u5185\u5b58\u662f\u51e0\u4e2a G\uff1b\u73b0\u5728\u867d\u7136\u5f88\u591a\u670d\u52a1\u5668\u90fd\u80fd\u6709 128G \u751a\u81f3\u66f4\u9ad8\u7684\u5185\u5b58\uff0c\u4f46\u662f\u5355\u673a\u7684\u6570\u636e\u91cf\u5374\u8fbe\u5230\u4e86 T \u7ea7\u522b\u3002</p> <p>\u6240\u4ee5\uff0c<code>innodb_buffer_pool_size</code> \u5c0f\u4e8e\u78c1\u76d8\u7684\u6570\u636e\u91cf\u662f\u5f88\u5e38\u89c1\u7684\u3002\u5982\u679c\u4e00\u4e2a Buffer Pool \u6ee1\u4e86\uff0c\u800c\u53c8\u8981\u4ece\u78c1\u76d8\u8bfb\u5165\u4e00\u4e2a\u6570\u636e\u9875\uff0c\u90a3\u80af\u5b9a\u662f\u8981\u6dd8\u6c70\u4e00\u4e2a\u65e7\u6570\u636e\u9875\u7684\u3002</p> <p>InnoDB \u5185\u5b58\u7ba1\u7406\u7528\u7684\u662f\u6700\u8fd1\u6700\u5c11\u4f7f\u7528 (Least Recently Used, LRU) \u7b97\u6cd5\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u7684\u6838\u5fc3\u5c31\u662f\u6dd8\u6c70\u6700\u4e45\u672a\u4f7f\u7528\u7684\u6570\u636e\u3002</p> <p>\u4e0b\u56fe\u662f\u4e00\u4e2a LRU \u7b97\u6cd5\u7684\u57fa\u672c\u6a21\u578b\u3002</p> <p></p> <p>\u56fe 6 \u57fa\u672c LRU \u7b97\u6cd5</p> <p>InnoDB \u7ba1\u7406 Buffer Pool \u7684 LRU \u7b97\u6cd5\uff0c\u662f\u7528\u94fe\u8868\u6765\u5b9e\u73b0\u7684\u3002</p> <ol> <li>\u5728\u56fe 6 \u7684\u72b6\u6001 1 \u91cc\uff0c\u94fe\u8868\u5934\u90e8\u662f P1\uff0c\u8868\u793a P1 \u662f\u6700\u8fd1\u521a\u521a\u88ab\u8bbf\u95ee\u8fc7\u7684\u6570\u636e\u9875\uff1b\u5047\u8bbe\u5185\u5b58\u91cc\u53ea\u80fd\u653e\u4e0b\u8fd9\u4e48\u591a\u6570\u636e\u9875\uff1b</li> <li>\u8fd9\u65f6\u5019\u6709\u4e00\u4e2a\u8bfb\u8bf7\u6c42\u8bbf\u95ee P3\uff0c\u56e0\u6b64\u53d8\u6210\u72b6\u6001 2\uff0cP3 \u88ab\u79fb\u5230\u6700\u524d\u9762\uff1b</li> <li>\u72b6\u6001 3 \u8868\u793a\uff0c\u8fd9\u6b21\u8bbf\u95ee\u7684\u6570\u636e\u9875\u662f\u4e0d\u5b58\u5728\u4e8e\u94fe\u8868\u4e2d\u7684\uff0c\u6240\u4ee5\u9700\u8981\u5728 Buffer Pool \u4e2d\u65b0\u7533\u8bf7\u4e00\u4e2a\u6570\u636e\u9875 Px\uff0c\u52a0\u5230\u94fe\u8868\u5934\u90e8\u3002\u4f46\u662f\u7531\u4e8e\u5185\u5b58\u5df2\u7ecf\u6ee1\u4e86\uff0c\u4e0d\u80fd\u7533\u8bf7\u65b0\u7684\u5185\u5b58\u3002\u4e8e\u662f\uff0c\u4f1a\u6e05\u7a7a\u94fe\u8868\u672b\u5c3e Pm \u8fd9\u4e2a\u6570\u636e\u9875\u7684\u5185\u5b58\uff0c\u5b58\u5165 Px \u7684\u5185\u5bb9\uff0c\u7136\u540e\u653e\u5230\u94fe\u8868\u5934\u90e8\u3002</li> <li>\u4ece\u6548\u679c\u4e0a\u770b\uff0c\u5c31\u662f\u6700\u4e45\u6ca1\u6709\u88ab\u8bbf\u95ee\u7684\u6570\u636e\u9875 Pm\uff0c\u88ab\u6dd8\u6c70\u4e86\u3002</li> </ol> <p>\u8fd9\u4e2a\u7b97\u6cd5\u4e4d\u4e00\u770b\u4e0a\u53bb\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u662f\u5982\u679c\u8003\u8651\u5230\u8981\u505a\u4e00\u4e2a\u5168\u8868\u626b\u63cf\uff0c\u4f1a\u4e0d\u4f1a\u6709\u95ee\u9898\u5462\uff1f</p> <p>\u5047\u8bbe\u6309\u7167\u8fd9\u4e2a\u7b97\u6cd5\uff0c\u6211\u4eec\u8981\u626b\u63cf\u4e00\u4e2a 200G \u7684\u8868\uff0c\u800c\u8fd9\u4e2a\u8868\u662f\u4e00\u4e2a\u5386\u53f2\u6570\u636e\u8868\uff0c\u5e73\u65f6\u6ca1\u6709\u4e1a\u52a1\u8bbf\u95ee\u5b83\u3002</p> <p>\u90a3\u4e48\uff0c\u6309\u7167\u8fd9\u4e2a\u7b97\u6cd5\u626b\u63cf\u7684\u8bdd\uff0c\u5c31\u4f1a\u628a\u5f53\u524d\u7684 Buffer Pool \u91cc\u7684\u6570\u636e\u5168\u90e8\u6dd8\u6c70\u6389\uff0c\u5b58\u5165\u626b\u63cf\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5230\u7684\u6570\u636e\u9875\u7684\u5185\u5bb9\u3002\u4e5f\u5c31\u662f\u8bf4 Buffer Pool \u91cc\u9762\u4e3b\u8981\u653e\u7684\u662f\u8fd9\u4e2a\u5386\u53f2\u6570\u636e\u8868\u7684\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u6b63\u5728\u505a\u4e1a\u52a1\u670d\u52a1\u7684\u5e93\uff0c\u8fd9\u53ef\u4e0d\u5999\u3002\u4f60\u4f1a\u770b\u5230\uff0cBuffer Pool \u7684\u5185\u5b58\u547d\u4e2d\u7387\u6025\u5267\u4e0b\u964d\uff0c\u78c1\u76d8\u538b\u529b\u589e\u52a0\uff0cSQL \u8bed\u53e5\u54cd\u5e94\u53d8\u6162\u3002</p> <p>\u6240\u4ee5\uff0cInnoDB \u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a LRU \u7b97\u6cd5\u3002\u5b9e\u9645\u4e0a\uff0cInnoDB \u5bf9 LRU \u7b97\u6cd5\u505a\u4e86\u6539\u8fdb\u3002</p> <p></p> <p>\u56fe 7 \u6539\u8fdb\u7684 LRU \u7b97\u6cd5</p> <p>\u5728 InnoDB \u5b9e\u73b0\u4e0a\uff0c\u6309\u7167 5:3 \u7684\u6bd4\u4f8b\u628a\u6574\u4e2a LRU \u94fe\u8868\u5206\u6210\u4e86 young \u533a\u57df\u548c old \u533a\u57df\u3002\u56fe\u4e2d LRU_old \u6307\u5411\u7684\u5c31\u662f old \u533a\u57df\u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u662f\u6574\u4e2a\u94fe\u8868\u7684 \u215d \u5904\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u9760\u8fd1\u94fe\u8868\u5934\u90e8\u7684 \u215d \u662f young \u533a\u57df\uff0c\u9760\u8fd1\u94fe\u8868\u5c3e\u90e8\u7684 \u215c \u662f old \u533a\u57df\u3002</p> <p>\u6539\u8fdb\u540e\u7684 LRU \u7b97\u6cd5\u6267\u884c\u6d41\u7a0b\u53d8\u6210\u4e86\u4e0b\u9762\u8fd9\u6837\u3002</p> <ol> <li>\u56fe 7 \u4e2d\u72b6\u6001 1\uff0c\u8981\u8bbf\u95ee\u6570\u636e\u9875 P3\uff0c\u7531\u4e8e P3 \u5728 young \u533a\u57df\uff0c\u56e0\u6b64\u548c\u4f18\u5316\u524d\u7684 LRU \u7b97\u6cd5\u4e00\u6837\uff0c\u5c06\u5176\u79fb\u5230\u94fe\u8868\u5934\u90e8\uff0c\u53d8\u6210\u72b6\u6001 2\u3002</li> <li>\u4e4b\u540e\u8981\u8bbf\u95ee\u4e00\u4e2a\u65b0\u7684\u4e0d\u5b58\u5728\u4e8e\u5f53\u524d\u94fe\u8868\u7684\u6570\u636e\u9875\uff0c\u8fd9\u65f6\u5019\u4f9d\u7136\u662f\u6dd8\u6c70\u6389\u6570\u636e\u9875 Pm\uff0c\u4f46\u662f\u65b0\u63d2\u5165\u7684\u6570\u636e\u9875 Px\uff0c\u662f\u653e\u5728 LRU_old \u5904\u3002</li> <li>\u5904\u4e8e old \u533a\u57df\u7684\u6570\u636e\u9875\uff0c\u6bcf\u6b21\u88ab\u8bbf\u95ee\u7684\u65f6\u5019\u90fd\u8981\u505a\u4e0b\u9762\u8fd9\u4e2a\u5224\u65ad\uff1a </li> <li>\u82e5\u8fd9\u4e2a\u6570\u636e\u9875\u5728 LRU \u94fe\u8868\u4e2d\u5b58\u5728\u7684\u65f6\u95f4\u8d85\u8fc7\u4e86 1 \u79d2\uff0c\u5c31\u628a\u5b83\u79fb\u52a8\u5230\u94fe\u8868\u5934\u90e8\uff1b</li> <li>\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u5728 LRU \u94fe\u8868\u4e2d\u5b58\u5728\u7684\u65f6\u95f4\u77ed\u4e8e 1 \u79d2\uff0c\u4f4d\u7f6e\u4fdd\u6301\u4e0d\u53d8\u30021 \u79d2\u8fd9\u4e2a\u65f6\u95f4\uff0c\u662f\u7531\u53c2\u6570 innodb_old_blocks_time \u63a7\u5236\u7684\u3002\u5176\u9ed8\u8ba4\u503c\u662f 1000\uff0c\u5355\u4f4d\u6beb\u79d2\u3002</li> </ol> <p>\u8fd9\u4e2a\u7b56\u7565\uff0c\u5c31\u662f\u4e3a\u4e86\u5904\u7406\u7c7b\u4f3c\u5168\u8868\u626b\u63cf\u7684\u64cd\u4f5c\u91cf\u8eab\u5b9a\u5236\u7684\u3002\u8fd8\u662f\u4ee5\u521a\u521a\u7684\u626b\u63cf 200G \u7684\u5386\u53f2\u6570\u636e\u8868\u4e3a\u4f8b\uff0c\u6211\u4eec\u770b\u770b\u6539\u8fdb\u540e\u7684 LRU \u7b97\u6cd5\u7684\u64cd\u4f5c\u903b\u8f91\uff1a</p> <ol> <li>\u626b\u63cf\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u65b0\u63d2\u5165\u7684\u6570\u636e\u9875\uff0c\u90fd\u88ab\u653e\u5230 old \u533a\u57df ;</li> <li>\u4e00\u4e2a\u6570\u636e\u9875\u91cc\u9762\u6709\u591a\u6761\u8bb0\u5f55\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u4f1a\u88ab\u591a\u6b21\u8bbf\u95ee\u5230\uff0c\u4f46\u7531\u4e8e\u662f\u987a\u5e8f\u626b\u63cf\uff0c\u8fd9\u4e2a\u6570\u636e\u9875\u7b2c\u4e00\u6b21\u88ab\u8bbf\u95ee\u548c\u6700\u540e\u4e00\u6b21\u88ab\u8bbf\u95ee\u7684\u65f6\u95f4\u95f4\u9694\u4e0d\u4f1a\u8d85\u8fc7 1 \u79d2\uff0c\u56e0\u6b64\u8fd8\u662f\u4f1a\u88ab\u4fdd\u7559\u5728 old \u533a\u57df\uff1b</li> <li>\u518d\u7ee7\u7eed\u626b\u63cf\u540e\u7eed\u7684\u6570\u636e\uff0c\u4e4b\u524d\u7684\u8fd9\u4e2a\u6570\u636e\u9875\u4e4b\u540e\u4e5f\u4e0d\u4f1a\u518d\u88ab\u8bbf\u95ee\u5230\uff0c\u4e8e\u662f\u59cb\u7ec8\u6ca1\u6709\u673a\u4f1a\u79fb\u5230\u94fe\u8868\u5934\u90e8\uff08\u4e5f\u5c31\u662f young \u533a\u57df\uff09\uff0c\u5f88\u5feb\u5c31\u4f1a\u88ab\u6dd8\u6c70\u51fa\u53bb\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u7b56\u7565\u6700\u5927\u7684\u6536\u76ca\uff0c\u5c31\u662f\u5728\u626b\u63cf\u8fd9\u4e2a\u5927\u8868\u7684\u8fc7\u7a0b\u4e2d\uff0c\u867d\u7136\u4e5f\u7528\u5230\u4e86 Buffer Pool\uff0c\u4f46\u662f\u5bf9 young \u533a\u57df\u5b8c\u5168\u6ca1\u6709\u5f71\u54cd\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86 Buffer Pool \u54cd\u5e94\u6b63\u5e38\u4e1a\u52a1\u7684\u67e5\u8be2\u547d\u4e2d\u7387\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_13","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u7528\u201c\u5927\u67e5\u8be2\u4f1a\u4e0d\u4f1a\u628a\u5185\u5b58\u7528\u5149\u201d\u8fd9\u4e2a\u95ee\u9898\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7684\u67e5\u8be2\u7ed3\u679c\uff0c\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u8fc7\u7a0b\u3002</p> <p>\u7531\u4e8e MySQL \u91c7\u7528\u7684\u662f\u8fb9\u7b97\u8fb9\u53d1\u7684\u903b\u8f91\uff0c\u56e0\u6b64\u5bf9\u4e8e\u6570\u636e\u91cf\u5f88\u5927\u7684\u67e5\u8be2\u7ed3\u679c\u6765\u8bf4\uff0c\u4e0d\u4f1a\u5728 server \u7aef\u4fdd\u5b58\u5b8c\u6574\u7684\u7ed3\u679c\u96c6\u3002\u6240\u4ee5\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u8bfb\u7ed3\u679c\u4e0d\u53ca\u65f6\uff0c\u4f1a\u5835\u4f4f MySQL \u7684\u67e5\u8be2\u8fc7\u7a0b\uff0c\u4f46\u662f\u4e0d\u4f1a\u628a\u5185\u5b58\u6253\u7206\u3002</p> <p>\u800c\u5bf9\u4e8e InnoDB \u5f15\u64ce\u5185\u90e8\uff0c\u7531\u4e8e\u6709\u6dd8\u6c70\u7b56\u7565\uff0c\u5927\u67e5\u8be2\u4e5f\u4e0d\u4f1a\u5bfc\u81f4\u5185\u5b58\u66b4\u6da8\u3002\u5e76\u4e14\uff0c\u7531\u4e8e InnoDB \u5bf9 LRU \u7b97\u6cd5\u505a\u4e86\u6539\u8fdb\uff0c\u51b7\u6570\u636e\u7684\u5168\u8868\u626b\u63cf\uff0c\u5bf9 Buffer Pool \u7684\u5f71\u54cd\u4e5f\u80fd\u505a\u5230\u53ef\u63a7\u3002</p> <p>\u5f53\u7136\uff0c\u6211\u4eec\u524d\u9762\u6587\u7ae0\u6709\u8bf4\u8fc7\uff0c\u5168\u8868\u626b\u63cf\u8fd8\u662f\u6bd4\u8f83\u8017\u8d39 IO \u8d44\u6e90\u7684\uff0c\u6240\u4ee5\u4e1a\u52a1\u9ad8\u5cf0\u671f\u8fd8\u662f\u4e0d\u80fd\u76f4\u63a5\u5728\u7ebf\u4e0a\u4e3b\u5e93\u6267\u884c\u5168\u8868\u626b\u63cf\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#34-join","title":"34 \u5230\u5e95\u53ef\u4e0d\u53ef\u4ee5\u4f7f\u7528join\uff1f","text":"<p>\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u5173\u4e8e join \u8bed\u53e5\u4f7f\u7528\u7684\u95ee\u9898\uff0c\u4e00\u822c\u4f1a\u96c6\u4e2d\u5728\u4ee5\u4e0b\u4e24\u7c7b\uff1a</p> <ol> <li>\u6211\u4eec DBA \u4e0d\u8ba9\u4f7f\u7528 join\uff0c\u4f7f\u7528 join \u6709\u4ec0\u4e48\u95ee\u9898\u5462\uff1f</li> <li>\u5982\u679c\u6709\u4e24\u4e2a\u5927\u5c0f\u4e0d\u540c\u7684\u8868\u505a join\uff0c\u5e94\u8be5\u7528\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u5462\uff1f</li> </ol> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u5148\u8ddf\u4f60\u8bf4\u8bf4 join \u8bed\u53e5\u5230\u5e95\u662f\u600e\u4e48\u6267\u884c\u7684\uff0c\u7136\u540e\u518d\u6765\u56de\u7b54\u8fd9\u4e24\u4e2a\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\uff0c\u6211\u8fd8\u662f\u521b\u5efa\u4e24\u4e2a\u8868 t1 \u548c t2 \u6765\u548c\u4f60\u8bf4\u660e\u3002</p> <pre><code>CREATE TABLE `t2` (\n  `id` int(11) NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `b` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`)\n) ENGINE=InnoDB; \ndrop procedure idata;\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=1000)do\n    insert into t2 values(i, i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\ncall idata(); \ncreate table t1 like t2;\ninsert into t1 (select * from t2 where id&lt;=100);\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e24\u4e2a\u8868\u90fd\u6709\u4e00\u4e2a\u4e3b\u952e\u7d22\u5f15 id \u548c\u4e00\u4e2a\u7d22\u5f15 a\uff0c\u5b57\u6bb5 b \u4e0a\u65e0\u7d22\u5f15\u3002\u5b58\u50a8\u8fc7\u7a0b idata() \u5f80\u8868 t2 \u91cc\u63d2\u5165\u4e86 1000 \u884c\u6570\u636e\uff0c\u5728\u8868 t1 \u91cc\u63d2\u5165\u7684\u662f 100 \u884c\u6570\u636e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#index-nested-loop-join","title":"Index Nested-Loop Join","text":"<p>\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>select * from t1 straight_join t2 on (t1.a=t2.a);\n</code></pre> <p>\u5982\u679c\u76f4\u63a5\u4f7f\u7528 join \u8bed\u53e5\uff0cMySQL \u4f18\u5316\u5668\u53ef\u80fd\u4f1a\u9009\u62e9\u8868 t1 \u6216 t2 \u4f5c\u4e3a\u9a71\u52a8\u8868\uff0c\u8fd9\u6837\u4f1a\u5f71\u54cd\u6211\u4eec\u5206\u6790 SQL \u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u6240\u4ee5\uff0c\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6211\u6539\u7528 straight_join \u8ba9 MySQL \u4f7f\u7528\u56fa\u5b9a\u7684\u8fde\u63a5\u65b9\u5f0f\u6267\u884c\u67e5\u8be2\uff0c\u8fd9\u6837\u4f18\u5316\u5668\u53ea\u4f1a\u6309\u7167\u6211\u4eec\u6307\u5b9a\u7684\u65b9\u5f0f\u53bb join\u3002\u5728\u8fd9\u4e2a\u8bed\u53e5\u91cc\uff0ct1 \u662f\u9a71\u52a8\u8868\uff0ct2 \u662f\u88ab\u9a71\u52a8\u8868\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain select * from t1 straight_join t2 on (t1.a=t2.a);\n+----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref       | rows | filtered | Extra       |\n+----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+\n|  1 | SIMPLE      | t1    | NULL       | ALL  | a             | NULL | NULL    | NULL      |  100 |   100.00 | Using where |\n|  1 | SIMPLE      | t2    | NULL       | ref  | a             | a    | 5       | test.t1.a |    1 |   100.00 | NULL        |\n+----+-------------+-------+------------+------+---------------+------+---------+-----------+------+----------+-------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u6761\u8bed\u53e5\u91cc\uff0c\u88ab\u9a71\u52a8\u8868 t2 \u7684\u5b57\u6bb5 a \u4e0a\u6709\u7d22\u5f15\uff0cjoin \u8fc7\u7a0b\u7528\u4e0a\u4e86\u8fd9\u4e2a\u7d22\u5f15\uff0c\u56e0\u6b64\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u4ece\u8868 t1 \u4e2d\u8bfb\u5165\u4e00\u884c\u6570\u636e R\uff1b</li> <li>\u4ece\u6570\u636e\u884c R \u4e2d\uff0c\u53d6\u51fa a \u5b57\u6bb5\u5230\u8868 t2 \u91cc\u53bb\u67e5\u627e\uff1b</li> <li>\u53d6\u51fa\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\uff0c\u8ddf R \u7ec4\u6210\u4e00\u884c\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\uff1b</li> <li>\u91cd\u590d\u6267\u884c\u6b65\u9aa4 1 \u5230 3\uff0c\u76f4\u5230\u8868 t1 \u7684\u672b\u5c3e\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u5148\u904d\u5386\u8868 t1\uff0c\u7136\u540e\u6839\u636e\u4ece\u8868 t1 \u4e2d\u53d6\u51fa\u7684\u6bcf\u884c\u6570\u636e\u4e2d\u7684 a \u503c\uff0c\u53bb\u8868 t2 \u4e2d\u67e5\u627e\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\u3002\u5728\u5f62\u5f0f\u4e0a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u8ddf\u6211\u4eec\u5199\u7a0b\u5e8f\u65f6\u7684\u5d4c\u5957\u67e5\u8be2\u7c7b\u4f3c\uff0c\u5e76\u4e14\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u6240\u4ee5\u6211\u4eec\u79f0\u4e4b\u4e3a\u201cIndex Nested-Loop Join\u201d\uff0c\u7b80\u79f0 NLJ\u3002</p> <p>\u5728\u8fd9\u4e2a\u6d41\u7a0b\u91cc\uff1a</p> <ol> <li>\u5bf9\u9a71\u52a8\u8868 t1 \u505a\u4e86\u5168\u8868\u626b\u63cf\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u9700\u8981\u626b\u63cf 100 \u884c\uff1b</li> <li>\u800c\u5bf9\u4e8e\u6bcf\u4e00\u884c R\uff0c\u6839\u636e a \u5b57\u6bb5\u53bb\u8868 t2 \u67e5\u627e\uff0c\u8d70\u7684\u662f\u6811\u641c\u7d22\u8fc7\u7a0b\u3002\u7531\u4e8e\u6211\u4eec\u6784\u9020\u7684\u6570\u636e\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0c\u56e0\u6b64\u6bcf\u6b21\u7684\u641c\u7d22\u8fc7\u7a0b\u90fd\u53ea\u626b\u63cf\u4e00\u884c\uff0c\u4e5f\u662f\u603b\u5171\u626b\u63cf 100 \u884c\uff1b</li> <li>\u6240\u4ee5\uff0c\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\uff0c\u603b\u626b\u63cf\u884c\u6570\u662f 200\u3002</li> </ol> <p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u518d\u8bd5\u7740\u56de\u7b54\u4e00\u4e0b\u6587\u7ae0\u5f00\u5934\u7684\u4e24\u4e2a\u95ee\u9898\u3002</p> <p>\u5148\u770b\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u80fd\u4e0d\u80fd\u4f7f\u7528 join?</p> <p>\u5047\u8bbe\u4e0d\u4f7f\u7528 join\uff0c\u90a3\u6211\u4eec\u5c31\u53ea\u80fd\u7528\u5355\u8868\u67e5\u8be2\u3002\u6211\u4eec\u770b\u770b\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\u7684\u9700\u6c42\uff0c\u7528\u5355\u8868\u67e5\u8be2\u600e\u4e48\u5b9e\u73b0\u3002</p> <ol> <li>\u6267\u884c<code>select * from t1</code>\uff0c\u67e5\u51fa\u8868 t1 \u7684\u6240\u6709\u6570\u636e\uff0c\u8fd9\u91cc\u6709 100 \u884c\uff1b</li> <li>\u5faa\u73af\u904d\u5386\u8fd9 100 \u884c\u6570\u636e\uff1a </li> <li>\u4ece\u6bcf\u4e00\u884c R \u53d6\u51fa\u5b57\u6bb5 a \u7684\u503c $R.a\uff1b</li> <li>\u6267\u884c<code>select * from t2 where a=$R.a</code>\uff1b</li> <li>\u628a\u8fd4\u56de\u7684\u7ed3\u679c\u548c R \u6784\u6210\u7ed3\u679c\u96c6\u7684\u4e00\u884c\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\uff0c\u4e5f\u662f\u626b\u63cf\u4e86 200 \u884c\uff0c\u4f46\u662f\u603b\u5171\u6267\u884c\u4e86 101 \u6761\u8bed\u53e5\uff0c\u6bd4\u76f4\u63a5 join \u591a\u4e86 100 \u6b21\u4ea4\u4e92\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u5ba2\u6237\u7aef\u8fd8\u8981\u81ea\u5df1\u62fc\u63a5 SQL \u8bed\u53e5\u548c\u7ed3\u679c\u3002</p> <p>\u663e\u7136\uff0c\u8fd9\u4e48\u505a\u8fd8\u4e0d\u5982\u76f4\u63a5 join \u597d\u3002</p> <p>\u6211\u4eec\u518d\u6765\u770b\u770b\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a\u600e\u4e48\u9009\u62e9\u9a71\u52a8\u8868\uff1f</p> <p>\u5728\u8fd9\u4e2a join \u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u9a71\u52a8\u8868\u662f\u8d70\u5168\u8868\u626b\u63cf\uff0c\u800c\u88ab\u9a71\u52a8\u8868\u662f\u8d70\u6811\u641c\u7d22\u3002</p> <p>\u5047\u8bbe\u88ab\u9a71\u52a8\u8868\u7684\u884c\u6570\u662f M\u3002\u6bcf\u6b21\u5728\u88ab\u9a71\u52a8\u8868\u67e5\u4e00\u884c\u6570\u636e\uff0c\u8981\u5148\u641c\u7d22\u7d22\u5f15 a\uff0c\u518d\u641c\u7d22\u4e3b\u952e\u7d22\u5f15\u3002\u6bcf\u6b21\u641c\u7d22\u4e00\u68f5\u6811\u8fd1\u4f3c\u590d\u6742\u5ea6\u662f\u4ee5 2 \u4e3a\u5e95\u7684 M \u7684\u5bf9\u6570\uff0c\u8bb0\u4e3a \\(log_2M\\)\uff0c\u6240\u4ee5\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u67e5\u4e00\u884c\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f \\(2*log_2M\\)\u3002</p> <p>\u5047\u8bbe\u9a71\u52a8\u8868\u7684\u884c\u6570\u662f N\uff0c\u6267\u884c\u8fc7\u7a0b\u5c31\u8981\u626b\u63cf\u9a71\u52a8\u8868 N \u884c\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u4e00\u884c\uff0c\u5230\u88ab\u9a71\u52a8\u8868\u4e0a\u5339\u914d\u4e00\u6b21\u3002</p> <p>\u56e0\u6b64\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\uff0c\u8fd1\u4f3c\u590d\u6742\u5ea6\u662f \\(N + N*2*log_2M\\)\u3002</p> <p>\u663e\u7136\uff0cN \u5bf9\u626b\u63cf\u884c\u6570\u7684\u5f71\u54cd\u66f4\u5927\uff0c\u56e0\u6b64\u5e94\u8be5\u8ba9\u5c0f\u8868\u6765\u505a\u9a71\u52a8\u8868\u3002</p> <p>\u5982\u679c\u4f60\u6ca1\u89c9\u5f97\u8fd9\u4e2a\u5f71\u54cd\u6709\u90a3\u4e48\u201c\u663e\u7136\u201d\uff0c \u53ef\u4ee5\u8fd9\u4e48\u7406\u89e3\uff1aN \u6269\u5927 1000 \u500d\u7684\u8bdd\uff0c\u626b\u63cf\u884c\u6570\u5c31\u4f1a\u6269\u5927 1000 \u500d\uff1b\u800c M \u6269\u5927 1000 \u500d\uff0c\u626b\u63cf\u884c\u6570\u6269\u5927\u4e0d\u5230 10 \u500d\u3002</p> <p>\u5230\u8fd9\u91cc\u5c0f\u7ed3\u4e00\u4e0b\uff0c\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\u6211\u4eec\u5f97\u5230\u4e86\u4e24\u4e2a\u7ed3\u8bba\uff1a</p> <ol> <li>\u4f7f\u7528 join \u8bed\u53e5\uff0c\u6027\u80fd\u6bd4\u5f3a\u884c\u62c6\u6210\u591a\u4e2a\u5355\u8868\u6267\u884c SQL \u8bed\u53e5\u7684\u6027\u80fd\u8981\u597d\uff1b</li> <li>\u5982\u679c\u4f7f\u7528 join \u8bed\u53e5\u7684\u8bdd\uff0c\u9700\u8981\u8ba9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li> </ol> <p>\u4f46\u662f\uff0c\u4f60\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u4e2a\u7ed3\u8bba\u7684\u524d\u63d0\u662f\u201c\u53ef\u4ee5\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u201d\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u88ab\u9a71\u52a8\u8868\u7528\u4e0d\u4e0a\u7d22\u5f15\u7684\u60c5\u51b5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#simple-nested-loop-join","title":"Simple Nested-Loop Join","text":"<p>\u73b0\u5728\uff0c\u6211\u4eec\u628a SQL \u8bed\u53e5\u6539\u6210\u8fd9\u6837\uff1a</p> <pre><code>select * from t1 straight_join t2 on (t1.a=t2.b);\n</code></pre> <p>\u7531\u4e8e\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u6ca1\u6709\u7d22\u5f15\uff0c\u56e0\u6b64\u518d\u7528\u56fe 2 \u7684\u6267\u884c\u6d41\u7a0b\u65f6\uff0c\u6bcf\u6b21\u5230 t2 \u53bb\u5339\u914d\u7684\u65f6\u5019\uff0c\u5c31\u8981\u505a\u4e00\u6b21\u5168\u8868\u626b\u63cf\u3002</p> <p>\u4f60\u53ef\u4ee5\u5148\u8bbe\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff0c\u7ee7\u7eed\u4f7f\u7528\u56fe 2 \u7684\u7b97\u6cd5\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u5462\uff1f\u5982\u679c\u53ea\u770b\u7ed3\u679c\u7684\u8bdd\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u662f\u6b63\u786e\u7684\uff0c\u800c\u4e14\u8fd9\u4e2a\u7b97\u6cd5\u4e5f\u6709\u4e00\u4e2a\u540d\u5b57\uff0c\u53eb\u505a\u201cSimple Nested-Loop Join\u201d\u3002</p> <p>\u4f46\u662f\uff0c\u8fd9\u6837\u7b97\u6765\uff0c\u8fd9\u4e2a SQL \u8bf7\u6c42\u5c31\u8981\u626b\u63cf\u8868 t2 \u591a\u8fbe 100 \u6b21\uff0c\u603b\u5171\u626b\u63cf \\(100*1000=10\\) \u4e07\u884c\u3002</p> <p>\u8fd9\u8fd8\u53ea\u662f\u4e24\u4e2a\u5c0f\u8868\uff0c\u5982\u679c t1 \u548c t2 \u90fd\u662f 10 \u4e07\u884c\u7684\u8868\uff08\u5f53\u7136\u4e86\uff0c\u8fd9\u4e5f\u8fd8\u662f\u5c5e\u4e8e\u5c0f\u8868\u7684\u8303\u56f4\uff09\uff0c\u5c31\u8981\u626b\u63cf 100 \u4ebf\u884c\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u770b\u4e0a\u53bb\u592a\u201c\u7b28\u91cd\u201d\u4e86\u3002</p> <p>\u5f53\u7136\uff0cMySQL \u4e5f\u6ca1\u6709\u4f7f\u7528\u8fd9\u4e2a Simple Nested-Loop Join \u7b97\u6cd5\uff0c\u800c\u662f\u4f7f\u7528\u4e86\u53e6\u4e00\u4e2a\u53eb\u4f5c\u201cBlock Nested-Loop Join\u201d\u7684\u7b97\u6cd5\uff0c\u7b80\u79f0 BNL\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#block-nested-loop-join","title":"Block Nested-Loop Join","text":"<p>\u8fd9\u65f6\u5019\uff0c\u88ab\u9a71\u52a8\u8868\u4e0a\u6ca1\u6709\u53ef\u7528\u7684\u7d22\u5f15\uff0c\u7b97\u6cd5\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u628a\u8868 t1 \u7684\u6570\u636e\u8bfb\u5165\u7ebf\u7a0b\u5185\u5b58 <code>join_buffer</code> \u4e2d\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u4e2a\u8bed\u53e5\u4e2d\u5199\u7684\u662f <code>select *</code>\uff0c\u56e0\u6b64\u662f\u628a\u6574\u4e2a\u8868 t1 \u653e\u5165\u4e86\u5185\u5b58\uff1b</li> <li>\u626b\u63cf\u8868 t2\uff0c\u628a\u8868 t2 \u4e2d\u7684\u6bcf\u4e00\u884c\u53d6\u51fa\u6765\uff0c\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u505a\u5bf9\u6bd4\uff0c\u6ee1\u8db3 join \u6761\u4ef6\u7684\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\u3002</li> </ol> <p>\u5bf9\u5e94\u5730\uff0c\u8fd9\u6761 SQL \u8bed\u53e5\u7684 explain \u7ed3\u679c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>mysql&gt; explain select * from t1 straight_join t2 on (t1.a=t2.b);\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n|  1 | SIMPLE      | t1    | NULL       | ALL  | a             | NULL | NULL    | NULL |  100 |   100.00 | NULL                                               |\n|  1 | SIMPLE      | t2    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1000 |    10.00 | Using where; Using join buffer (Block Nested Loop) |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8868 t1 \u548c t2 \u90fd\u505a\u4e86\u4e00\u6b21\u5168\u8868\u626b\u63cf\uff0c\u56e0\u6b64\u603b\u7684\u626b\u63cf\u884c\u6570\u662f 1100\u3002\u7531\u4e8e <code>join_buffer</code> \u662f\u4ee5\u65e0\u5e8f\u6570\u7ec4\u7684\u65b9\u5f0f\u7ec4\u7ec7\u7684\uff0c\u56e0\u6b64\u5bf9\u8868 t2 \u4e2d\u7684\u6bcf\u4e00\u884c\uff0c\u90fd\u8981\u505a 100 \u6b21\u5224\u65ad\uff0c\u603b\u5171\u9700\u8981\u5728\u5185\u5b58\u4e2d\u505a\u7684\u5224\u65ad\u6b21\u6570\u662f\uff1a100 *1000=10 \u4e07\u6b21\u3002</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\uff0c\u5982\u679c\u4f7f\u7528 Simple Nested-Loop Join \u7b97\u6cd5\u8fdb\u884c\u67e5\u8be2\uff0c\u626b\u63cf\u884c\u6570\u4e5f\u662f 10 \u4e07\u884c\u3002\u56e0\u6b64\uff0c\u4ece\u65f6\u95f4\u590d\u6742\u5ea6\u4e0a\u6765\u8bf4\uff0c\u8fd9\u4e24\u4e2a\u7b97\u6cd5\u662f\u4e00\u6837\u7684\u3002\u4f46\u662f\uff0cBlock Nested-Loop Join \u7b97\u6cd5\u7684\u8fd9 10 \u4e07\u6b21\u5224\u65ad\u662f\u5185\u5b58\u64cd\u4f5c\uff0c\u901f\u5ea6\u4e0a\u4f1a\u5feb\u5f88\u591a\uff0c\u6027\u80fd\u4e5f\u66f4\u597d\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u9009\u62e9\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u3002</p> <p>\u5047\u8bbe\u5c0f\u8868\u7684\u884c\u6570\u662f N\uff0c\u5927\u8868\u7684\u884c\u6570\u662f M\uff0c\u90a3\u4e48\u5728\u8fd9\u4e2a\u7b97\u6cd5\u91cc\uff1a</p> <ol> <li>\u4e24\u4e2a\u8868\u90fd\u505a\u4e00\u6b21\u5168\u8868\u626b\u63cf\uff0c\u6240\u4ee5\u603b\u7684\u626b\u63cf\u884c\u6570\u662f M+N\uff1b</li> <li>\u5185\u5b58\u4e2d\u7684\u5224\u65ad\u6b21\u6570\u662f M*N\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8c03\u6362\u8fd9\u4e24\u4e2a\u7b97\u5f0f\u4e2d\u7684 M \u548c N \u6ca1\u5dee\u522b\uff0c\u56e0\u6b64\u8fd9\u65f6\u5019\u9009\u62e9\u5927\u8868\u8fd8\u662f\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff0c\u6267\u884c\u8017\u65f6\u662f\u4e00\u6837\u7684\u3002</p> <p>\u7136\u540e\uff0c\u4f60\u53ef\u80fd\u9a6c\u4e0a\u5c31\u4f1a\u95ee\u4e86\uff0c\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u8868 t1 \u624d 100 \u884c\uff0c\u8981\u662f\u8868 t1 \u662f\u4e00\u4e2a\u5927\u8868\uff0cjoin_buffer \u653e\u4e0d\u4e0b\u600e\u4e48\u529e\u5462\uff1f</p> <p>join_buffer \u7684\u5927\u5c0f\u662f\u7531\u53c2\u6570 <code>join_buffer_size</code> \u8bbe\u5b9a\u7684\uff0c\u9ed8\u8ba4\u503c\u662f 256k\u3002**\u5982\u679c\u653e\u4e0d\u4e0b\u8868 t1 \u7684\u6240\u6709\u6570\u636e\u8bdd\uff0c\u7b56\u7565\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5206\u6bb5\u653e\u3002**\u6211\u628a <code>join_buffer_size</code> \u6539\u6210 1200\uff0c\u518d\u6267\u884c\uff1a</p> <pre><code>select * from t1 straight_join t2 on (t1.a=t2.b);\n</code></pre> <p>\u6267\u884c\u8fc7\u7a0b\u5c31\u53d8\u6210\u4e86\uff1a</p> <ol> <li>\u626b\u63cf\u8868 t1\uff0c\u987a\u5e8f\u8bfb\u53d6\u6570\u636e\u884c\u653e\u5165 <code>join_buffer</code> \u4e2d\uff0c\u653e\u5b8c\u7b2c 88 \u884c <code>join_buffer</code> \u6ee1\u4e86\uff0c\u7ee7\u7eed\u7b2c 2 \u6b65\uff1b</li> <li>\u626b\u63cf\u8868 t2\uff0c\u628a t2 \u4e2d\u7684\u6bcf\u4e00\u884c\u53d6\u51fa\u6765\uff0c\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u505a\u5bf9\u6bd4\uff0c\u6ee1\u8db3 join \u6761\u4ef6\u7684\uff0c\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\uff1b</li> <li>\u6e05\u7a7a <code>join_buffer</code>\uff1b</li> <li>\u7ee7\u7eed\u626b\u63cf\u8868 t1\uff0c\u987a\u5e8f\u8bfb\u53d6\u6700\u540e\u7684 12 \u884c\u6570\u636e\u653e\u5165 <code>join_buffer</code> \u4e2d\uff0c\u7ee7\u7eed\u6267\u884c\u7b2c 2 \u6b65\u3002</li> </ol> <p>\u6267\u884c\u6d41\u7a0b\u56fe\u4e5f\u5c31\u53d8\u6210\u8fd9\u6837\uff1a</p> <p></p> <p>\u56fe 5 Block Nested-Loop Join -- \u4e24\u6bb5</p> <p>\u56fe\u4e2d\u7684\u6b65\u9aa4 4 \u548c 5\uff0c\u8868\u793a\u6e05\u7a7a <code>join_buffer</code> \u518d\u590d\u7528\u3002</p> <p>\u8fd9\u4e2a\u6d41\u7a0b\u624d\u4f53\u73b0\u51fa\u4e86\u8fd9\u4e2a\u7b97\u6cd5\u540d\u5b57\u4e2d\u201cBlock\u201d\u7684\u7531\u6765\uff0c\u8868\u793a\u201c\u5206\u5757\u53bb join\u201d\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u7531\u4e8e\u8868 t1 \u88ab\u5206\u6210\u4e86\u4e24\u6b21\u653e\u5165 join_buffer \u4e2d\uff0c\u5bfc\u81f4\u8868 t2 \u4f1a\u88ab\u626b\u63cf\u4e24\u6b21\u3002\u867d\u7136\u5206\u6210\u4e24\u6b21\u653e\u5165 <code>join_buffer</code>\uff0c\u4f46\u662f\u5224\u65ad\u7b49\u503c\u6761\u4ef6\u7684\u6b21\u6570\u8fd8\u662f\u4e0d\u53d8\u7684\uff0c\u4f9d\u7136\u662f (88+12)*1000=10 \u4e07\u6b21\u3002</p> <p>\u6211\u4eec\u518d\u6765\u770b\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9a71\u52a8\u8868\u7684\u9009\u62e9\u95ee\u9898\u3002</p> <p>\u5047\u8bbe\uff0c\u9a71\u52a8\u8868\u7684\u6570\u636e\u884c\u6570\u662f N\uff0c\u9700\u8981\u5206 K \u6bb5\u624d\u80fd\u5b8c\u6210\u7b97\u6cd5\u6d41\u7a0b\uff0c\u88ab\u9a71\u52a8\u8868\u7684\u6570\u636e\u884c\u6570\u662f M\u3002</p> <p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684 K \u4e0d\u662f\u5e38\u6570\uff0cN \u8d8a\u5927 K \u5c31\u4f1a\u8d8a\u5927\uff0c\u56e0\u6b64\u628a K \u8868\u793a\u4e3a $ \\lambda*N$\uff0c\u663e\u7136 \\(\\lambda\\) \u7684\u53d6\u503c\u8303\u56f4\u662f (0,1)\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u8fd9\u4e2a\u7b97\u6cd5\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff1a</p> <ol> <li>\u626b\u63cf\u884c\u6570\u662f \\(N+\\lambda*N*M\\)\uff1b</li> <li>\u5185\u5b58\u5224\u65ad \\(N*M\\) \u6b21\u3002</li> </ol> <p>\u663e\u7136\uff0c\u5185\u5b58\u5224\u65ad\u6b21\u6570\u662f\u4e0d\u53d7\u9009\u62e9\u54ea\u4e2a\u8868\u4f5c\u4e3a\u9a71\u52a8\u8868\u5f71\u54cd\u7684\u3002\u800c\u8003\u8651\u5230\u626b\u63cf\u884c\u6570\uff0c\u5728 M \u548c N \u5927\u5c0f\u786e\u5b9a\u7684\u60c5\u51b5\u4e0b\uff0cN \u5c0f\u4e00\u4e9b\uff0c\u6574\u4e2a\u7b97\u5f0f\u7684\u7ed3\u679c\u4f1a\u66f4\u5c0f\u3002</p> <p>\u6240\u4ee5\u7ed3\u8bba\u662f\uff0c\u5e94\u8be5\u8ba9\u5c0f\u8868\u5f53\u9a71\u52a8\u8868\u3002</p> <p>\u5f53\u7136\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u5728 \\(N+\\lambda*N*M\\)\u8fd9\u4e2a\u5f0f\u5b50\u91cc\uff0c\\(\\lambda\\)\u624d\u662f\u5f71\u54cd\u626b\u63cf\u884c\u6570\u7684\u5173\u952e\u56e0\u7d20\uff0c\u8fd9\u4e2a\u503c\u8d8a\u5c0f\u8d8a\u597d\u3002</p> <p>\u521a\u521a\u6211\u4eec\u8bf4\u4e86 N \u8d8a\u5927\uff0c\u5206\u6bb5\u6570 K \u8d8a\u5927\u3002\u90a3\u4e48\uff0cN \u56fa\u5b9a\u7684\u65f6\u5019\uff0c\u4ec0\u4e48\u53c2\u6570\u4f1a\u5f71\u54cd K \u7684\u5927\u5c0f\u5462\uff1f\u7b54\u6848\u662f <code>join_buffer_size</code>\u3002<code>join_buffer_size</code> \u8d8a\u5927\uff0c\u4e00\u6b21\u53ef\u4ee5\u653e\u5165\u7684\u884c\u8d8a\u591a\uff0c\u5206\u6210\u7684\u6bb5\u6570\u4e5f\u5c31\u8d8a\u5c11\uff0c\u5bf9\u88ab\u9a71\u52a8\u8868\u7684\u5168\u8868\u626b\u63cf\u6b21\u6570\u5c31\u8d8a\u5c11\u3002</p> <p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\uff0c\u4f60\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e9b\u5efa\u8bae\u544a\u8bc9\u4f60\uff0c\u5982\u679c\u4f60\u7684 join \u8bed\u53e5\u5f88\u6162\uff0c\u5c31\u628a <code>join_buffer_size</code> \u6539\u5927\u3002</p> <p>\u7406\u89e3\u4e86 MySQL \u6267\u884c join \u7684\u4e24\u79cd\u7b97\u6cd5\uff0c\u73b0\u5728\u6211\u4eec\u518d\u6765\u8bd5\u7740**\u56de\u7b54\u6587\u7ae0\u5f00\u5934\u7684\u4e24\u4e2a\u95ee\u9898**\u3002</p> <p>\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u80fd\u4e0d\u80fd\u4f7f\u7528 join \u8bed\u53e5\uff1f</p> <ol> <li>\u5982\u679c\u53ef\u4ee5\u4f7f\u7528 Index Nested-Loop Join \u7b97\u6cd5\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ef\u4ee5\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u7d22\u5f15\uff0c\u5176\u5b9e\u662f\u6ca1\u95ee\u9898\u7684\uff1b</li> <li>\u5982\u679c\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u626b\u63cf\u884c\u6570\u5c31\u4f1a\u8fc7\u591a\u3002\u5c24\u5176\u662f\u5728\u5927\u8868\u4e0a\u7684 join \u64cd\u4f5c\uff0c\u8fd9\u6837\u53ef\u80fd\u8981\u626b\u63cf\u88ab\u9a71\u52a8\u8868\u5f88\u591a\u6b21\uff0c\u4f1a\u5360\u7528\u5927\u91cf\u7684\u7cfb\u7edf\u8d44\u6e90\u3002\u6240\u4ee5\u8fd9\u79cd join \u5c3d\u91cf\u4e0d\u8981\u7528\u3002</li> </ol> <p>\u6240\u4ee5\u4f60\u5728\u5224\u65ad\u8981\u4e0d\u8981\u4f7f\u7528 join \u8bed\u53e5\u65f6\uff0c\u5c31\u662f\u770b explain \u7ed3\u679c\u91cc\u9762\uff0cExtra \u5b57\u6bb5\u91cc\u9762\u6709\u6ca1\u6709\u51fa\u73b0\u201cBlock Nested Loop\u201d\u5b57\u6837\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u95ee\u9898\u662f\uff1a\u5982\u679c\u8981\u4f7f\u7528 join\uff0c\u5e94\u8be5\u9009\u62e9\u5927\u8868\u505a\u9a71\u52a8\u8868\u8fd8\u662f\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff1f</p> <ol> <li>\u5982\u679c\u662f Index Nested-Loop Join \u7b97\u6cd5\uff0c\u5e94\u8be5\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\uff1b</li> <li>\u5982\u679c\u662f Block Nested-Loop Join \u7b97\u6cd5\uff1a </li> <li>\u5728 <code>join_buffer_size</code> \u8db3\u591f\u5927\u7684\u65f6\u5019\uff0c\u662f\u4e00\u6837\u7684\uff1b</li> <li>\u5728 <code>join_buffer_size</code> \u4e0d\u591f\u5927\u7684\u65f6\u5019\uff08\u8fd9\u79cd\u60c5\u51b5\u66f4\u5e38\u89c1\uff09\uff0c\u5e94\u8be5\u9009\u62e9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li> </ol> <p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u95ee\u9898\u7684\u7ed3\u8bba\u5c31\u662f\uff0c\u603b\u662f\u5e94\u8be5\u4f7f\u7528\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u6211\u9700\u8981\u8bf4\u660e\u4e0b\uff0c\u4ec0\u4e48\u53eb\u4f5c\u201c\u5c0f\u8868\u201d\u3002</p> <p>\u6211\u4eec\u524d\u9762\u7684\u4f8b\u5b50\u662f\u6ca1\u6709\u52a0\u6761\u4ef6\u7684\u3002\u5982\u679c\u6211\u5728\u8bed\u53e5\u7684 where \u6761\u4ef6\u52a0\u4e0a t2.id\\&lt;=50 \u8fd9\u4e2a\u9650\u5b9a\u6761\u4ef6\uff0c\u518d\u6765\u770b\u4e0b\u8fd9\u4e24\u6761\u8bed\u53e5\uff1a</p> <pre><code>select * from t1 straight_join t2 on (t1.b=t2.b) where t2.id&lt;=50;\nselect * from t2 straight_join t1 on (t1.b=t2.b) where t2.id&lt;=50;\n</code></pre> <p>\u6ce8\u610f\uff0c\u4e3a\u4e86\u8ba9\u4e24\u6761\u8bed\u53e5\u7684\u88ab\u9a71\u52a8\u8868\u90fd\u7528\u4e0d\u4e0a\u7d22\u5f15\uff0c\u6240\u4ee5 join \u5b57\u6bb5\u90fd\u4f7f\u7528\u4e86\u6ca1\u6709\u7d22\u5f15\u7684\u5b57\u6bb5 b\u3002</p> <p>\u4f46\u5982\u679c\u662f\u7528\u7b2c\u4e8c\u4e2a\u8bed\u53e5\u7684\u8bdd\uff0cjoin_buffer \u53ea\u9700\u8981\u653e\u5165 t2 \u7684\u524d 50 \u884c\uff0c\u663e\u7136\u662f\u66f4\u597d\u7684\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u201ct2 \u7684\u524d 50 \u884c\u201d\u662f\u90a3\u4e2a\u76f8\u5bf9\u5c0f\u7684\u8868\uff0c\u4e5f\u5c31\u662f\u201c\u5c0f\u8868\u201d\u3002</p> <p>\u6211\u4eec\u518d\u6765\u770b\u53e6\u5916\u4e00\u7ec4\u4f8b\u5b50\uff1a</p> <pre><code>select t1.b,t2.* from  t1  straight_join t2 on (t1.b=t2.b) where t2.id&lt;=100;\nselect t1.b,t2.* from  t2  straight_join t1 on (t1.b=t2.b) where t2.id&lt;=100;\n</code></pre> <p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u8868 t1 \u548c t2 \u90fd\u662f\u53ea\u6709 100 \u884c\u53c2\u52a0 join\u3002\u4f46\u662f\uff0c\u8fd9\u4e24\u6761\u8bed\u53e5\u6bcf\u6b21\u67e5\u8be2\u653e\u5165 <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u662f\u4e0d\u4e00\u6837\u7684\uff1a</p> <ul> <li>\u8868 t1 \u53ea\u67e5\u5b57\u6bb5 b\uff0c\u56e0\u6b64\u5982\u679c\u628a t1 \u653e\u5230 join_buffer \u4e2d\uff0c\u5219 join_buffer \u4e2d\u53ea\u9700\u8981\u653e\u5165 b \u7684\u503c\uff1b</li> <li>\u8868 t2 \u9700\u8981\u67e5\u6240\u6709\u7684\u5b57\u6bb5\uff0c\u56e0\u6b64\u5982\u679c\u628a\u8868 t2 \u653e\u5230 join_buffer \u4e2d\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u653e\u5165\u4e09\u4e2a\u5b57\u6bb5 id\u3001a \u548c b\u3002</li> </ul> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u5e94\u8be5\u9009\u62e9\u8868 t1 \u4f5c\u4e3a\u9a71\u52a8\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u201c\u53ea\u9700\u8981\u4e00\u5217\u53c2\u4e0e join \u7684\u8868 t1\u201d\u662f\u90a3\u4e2a\u76f8\u5bf9\u5c0f\u7684\u8868\u3002</p> <p>\u6240\u4ee5\uff0c\u66f4\u51c6\u786e\u5730\u8bf4\uff0c\u5728\u51b3\u5b9a\u54ea\u4e2a\u8868\u505a\u9a71\u52a8\u8868\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u662f\u4e24\u4e2a\u8868\u6309\u7167\u5404\u81ea\u7684\u6761\u4ef6\u8fc7\u6ee4\uff0c\u8fc7\u6ee4\u5b8c\u6210\u4e4b\u540e\uff0c\u8ba1\u7b97\u53c2\u4e0e join \u7684\u5404\u4e2a\u5b57\u6bb5\u7684\u603b\u6570\u636e\u91cf\uff0c\u6570\u636e\u91cf\u5c0f\u7684\u90a3\u4e2a\u8868\uff0c\u5c31\u662f\u201c\u5c0f\u8868\u201d\uff0c\u5e94\u8be5\u4f5c\u4e3a\u9a71\u52a8\u8868\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_14","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u6267\u884c join \u8bed\u53e5\u7684\u4e24\u79cd\u53ef\u80fd\u7b97\u6cd5\uff0c\u8fd9\u4e24\u79cd\u7b97\u6cd5\u662f\u7531\u80fd\u5426\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\u51b3\u5b9a\u7684\u3002\u800c\u80fd\u5426\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u5bf9 join \u8bed\u53e5\u7684\u6027\u80fd\u5f71\u54cd\u5f88\u5927\u3002</p> <p>\u901a\u8fc7\u5bf9 Index Nested-Loop Join \u548c Block Nested-Loop Join \u4e24\u4e2a\u7b97\u6cd5\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u6790\uff0c\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u6587\u7ae0\u5f00\u5934\u4e24\u4e2a\u95ee\u9898\u7684\u7b54\u6848\uff1a</p> <ol> <li>\u5982\u679c\u53ef\u4ee5\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0cjoin \u8bed\u53e5\u8fd8\u662f\u6709\u5176\u4f18\u52bf\u7684\uff1b</li> <li>\u4e0d\u80fd\u4f7f\u7528\u88ab\u9a71\u52a8\u8868\u7684\u7d22\u5f15\uff0c\u53ea\u80fd\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u8fd9\u6837\u7684\u8bed\u53e5\u5c31\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\uff1b</li> <li>\u5728\u4f7f\u7528 join \u7684\u65f6\u5019\uff0c\u5e94\u8be5\u8ba9\u5c0f\u8868\u505a\u9a71\u52a8\u8868\u3002</li> </ol> <p>\u6700\u540e\uff0c\u53c8\u5230\u4e86\u4eca\u5929\u7684\u95ee\u9898\u65f6\u95f4\u3002</p> <p>\u6211\u4eec\u5728\u4e0a\u6587\u8bf4\u5230\uff0c\u4f7f\u7528 Block Nested-Loop Join \u7b97\u6cd5\uff0c\u53ef\u80fd\u4f1a\u56e0\u4e3a <code>join_buffer</code> \u4e0d\u591f\u5927\uff0c\u9700\u8981\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u591a\u6b21\u5168\u8868\u626b\u63cf\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#35-join","title":"35 join\u8bed\u53e5\u600e\u4e48\u4f18\u5316\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 join \u8bed\u53e5\u7684\u4e24\u79cd\u7b97\u6cd5\uff0c\u5206\u522b\u662f Index Nested-Loop Join(NLJ) \u548c Block Nested-Loop Join(BNL)\u3002</p> <p>\u6211\u4eec\u53d1\u73b0\u5728\u4f7f\u7528 NLJ \u7b97\u6cd5\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u6548\u679c\u8fd8\u662f\u4e0d\u9519\u7684\uff0c\u6bd4\u901a\u8fc7\u5e94\u7528\u5c42\u62c6\u5206\u6210\u591a\u4e2a\u8bed\u53e5\u7136\u540e\u518d\u62fc\u63a5\u67e5\u8be2\u7ed3\u679c\u66f4\u65b9\u4fbf\uff0c\u800c\u4e14\u6027\u80fd\u4e5f\u4e0d\u4f1a\u5dee\u3002</p> <p>\u4f46\u662f\uff0cBNL \u7b97\u6cd5\u5728\u5927\u8868 join \u7684\u65f6\u5019\u6027\u80fd\u5c31\u5dee\u591a\u4e86\uff0c\u6bd4\u8f83\u6b21\u6570\u7b49\u4e8e\u4e24\u4e2a\u8868\u53c2\u4e0e join \u7684\u884c\u6570\u7684\u4e58\u79ef\uff0c\u5f88\u6d88\u8017 CPU \u8d44\u6e90\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u8fd9\u4e24\u4e2a\u7b97\u6cd5\u90fd\u8fd8\u6709\u7ee7\u7eed\u4f18\u5316\u7684\u7a7a\u95f4\uff0c\u6211\u4eec\u4eca\u5929\u5c31\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u8fd8\u662f\u521b\u5efa\u4e24\u4e2a\u8868 t1\u3001t2 \u6765\u548c\u4f60\u5c55\u5f00\u4eca\u5929\u7684\u95ee\u9898\u3002</p> <pre><code>create table t1(id int primary key, a int, b int, index(a));\ncreate table t2 like t1;\ndrop procedure idata;\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=1000)do\n    insert into t1 values(i, 1001-i, i);\n    set i=i+1;\n  end while;\n\n  set i=1;\n  while(i&lt;=1000000)do\n    insert into t2 values(i, i, i);\n    set i=i+1;\n  end while; \nend;;\ndelimiter ;\ncall idata();\n</code></pre> <p>\u4e3a\u4e86\u4fbf\u4e8e\u540e\u9762\u91cf\u5316\u8bf4\u660e\uff0c\u6211\u5728\u8868 t1 \u91cc\uff0c\u63d2\u5165\u4e86 1000 \u884c\u6570\u636e\uff0c\u6bcf\u4e00\u884c\u7684 a=1001-id \u7684\u503c\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8868 t1 \u4e2d\u5b57\u6bb5 a \u662f\u9006\u5e8f\u7684\u3002\u540c\u65f6\uff0c\u6211\u5728\u8868 t2 \u4e2d\u63d2\u5165\u4e86 100 \u4e07\u884c\u6570\u636e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#multi-range-read","title":"Multi-Range Read \u4f18\u5316","text":"<p>\u5728\u4ecb\u7ecd join \u8bed\u53e5\u7684\u4f18\u5316\u65b9\u6848\u4e4b\u524d\uff0c\u6211\u9700\u8981\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e2a\u77e5\u8bc6\u70b9\uff0c\u5373\uff1aMulti-Range Read \u4f18\u5316 (MRR)\u3002\u8fd9\u4e2a\u4f18\u5316\u7684\u4e3b\u8981\u76ee\u7684\u662f\u5c3d\u91cf\u4f7f\u7528\u987a\u5e8f\u8bfb\u76d8\u3002</p> <p>\u5728[\u7b2c 4 \u7bc7\u6587\u7ae0]\u4e2d\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd InnoDB \u7684\u7d22\u5f15\u7ed3\u6784\u65f6\uff0c\u63d0\u5230\u4e86\u201c\u56de\u8868\u201d\u7684\u6982\u5ff5\u3002\u6211\u4eec\u5148\u6765\u56de\u987e\u4e00\u4e0b\u8fd9\u4e2a\u6982\u5ff5\u3002\u56de\u8868\u662f\u6307\uff0cInnoDB \u5728\u666e\u901a\u7d22\u5f15 a \u4e0a\u67e5\u5230\u4e3b\u952e id \u7684\u503c\u540e\uff0c\u518d\u6839\u636e\u4e00\u4e2a\u4e2a\u4e3b\u952e id \u7684\u503c\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u53bb\u67e5\u6574\u884c\u6570\u636e\u7684\u8fc7\u7a0b\u3002</p> <p>\u7136\u540e\uff0c\u6709\u540c\u5b66\u5728\u7559\u8a00\u533a\u95ee\u5230\uff0c\u56de\u8868\u8fc7\u7a0b\u662f\u4e00\u884c\u884c\u5730\u67e5\u6570\u636e\uff0c\u8fd8\u662f\u6279\u91cf\u5730\u67e5\u6570\u636e\uff1f</p> <p>\u6211\u4eec\u5148\u6765\u770b\u770b\u8fd9\u4e2a\u95ee\u9898\u3002\u5047\u8bbe\uff0c\u6211\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>select * from t1 where a&gt;=1 and a&lt;=100;\n</code></pre> <p>\u4e3b\u952e\u7d22\u5f15\u662f\u4e00\u68f5 B+ \u6811\uff0c\u5728\u8fd9\u68f5\u6811\u4e0a\uff0c\u6bcf\u6b21\u53ea\u80fd\u6839\u636e\u4e00\u4e2a\u4e3b\u952e id \u67e5\u5230\u4e00\u884c\u6570\u636e\u3002\u56e0\u6b64\uff0c\u56de\u8868\u80af\u5b9a\u662f\u4e00\u884c\u884c\u641c\u7d22\u4e3b\u952e\u7d22\u5f15\u7684\uff0c\u57fa\u672c\u6d41\u7a0b\u5982\u56fe 1 \u6240\u793a\u3002</p> <p></p> <p>\u56fe 1 \u57fa\u672c\u56de\u8868\u6d41\u7a0b</p> <p>\u5982\u679c\u968f\u7740 a \u7684\u503c\u9012\u589e\u987a\u5e8f\u67e5\u8be2\u7684\u8bdd\uff0cid \u7684\u503c\u5c31\u53d8\u6210\u968f\u673a\u7684\uff0c\u90a3\u4e48\u5c31\u4f1a\u51fa\u73b0\u968f\u673a\u8bbf\u95ee\uff0c\u6027\u80fd\u76f8\u5bf9\u8f83\u5dee\u3002\u867d\u7136\u201c\u6309\u884c\u67e5\u201d\u8fd9\u4e2a\u673a\u5236\u4e0d\u80fd\u6539\uff0c\u4f46\u662f\u8c03\u6574\u67e5\u8be2\u7684\u987a\u5e8f\uff0c\u8fd8\u662f\u80fd\u591f\u52a0\u901f\u7684\u3002</p> <p>\u56e0\u4e3a\u5927\u591a\u6570\u7684\u6570\u636e\u90fd\u662f\u6309\u7167\u4e3b\u952e\u9012\u589e\u987a\u5e8f\u63d2\u5165\u5f97\u5230\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\uff0c\u5982\u679c\u6309\u7167\u4e3b\u952e\u7684\u9012\u589e\u987a\u5e8f\u67e5\u8be2\u7684\u8bdd\uff0c\u5bf9\u78c1\u76d8\u7684\u8bfb\u6bd4\u8f83\u63a5\u8fd1\u987a\u5e8f\u8bfb\uff0c\u80fd\u591f\u63d0\u5347\u8bfb\u6027\u80fd\u3002</p> <p>\u8fd9\uff0c\u5c31\u662f MRR \u4f18\u5316\u7684\u8bbe\u8ba1\u601d\u8def\u3002\u6b64\u65f6\uff0c\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u53d8\u6210\u4e86\u8fd9\u6837\uff1a</p> <ol> <li>\u6839\u636e\u7d22\u5f15 a\uff0c\u5b9a\u4f4d\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u5c06 id \u503c\u653e\u5165 <code>read_rnd_buffer</code> \u4e2d ;</li> <li>\u5c06 <code>read_rnd_buffer</code> \u4e2d\u7684 id \u8fdb\u884c\u9012\u589e\u6392\u5e8f\uff1b</li> <li>\u6392\u5e8f\u540e\u7684 id \u6570\u7ec4\uff0c\u4f9d\u6b21\u5230\u4e3b\u952e id \u7d22\u5f15\u4e2d\u67e5\u8bb0\u5f55\uff0c\u5e76\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u3002</li> </ol> <p>\u8fd9\u91cc\uff0c<code>read_rnd_buffer</code> \u7684\u5927\u5c0f\u662f\u7531 <code>read_rnd_buffer_size</code> \u53c2\u6570\u63a7\u5236\u7684\u3002\u5982\u679c\u6b65\u9aa4 1 \u4e2d\uff0c<code>read_rnd_buffer</code> \u653e\u6ee1\u4e86\uff0c\u5c31\u4f1a\u5148\u6267\u884c\u5b8c\u6b65\u9aa4 2 \u548c 3\uff0c\u7136\u540e\u6e05\u7a7a <code>read_rnd_buffer</code>\u3002\u4e4b\u540e\u7ee7\u7eed\u627e\u7d22\u5f15 a \u7684\u4e0b\u4e2a\u8bb0\u5f55\uff0c\u5e76\u7ee7\u7eed\u5faa\u73af\u3002</p> <p>\u53e6\u5916\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5982\u679c\u4f60\u60f3\u8981\u7a33\u5b9a\u5730\u4f7f\u7528 MRR \u4f18\u5316\u7684\u8bdd\uff0c\u9700\u8981\u8bbe\u7f6e<code>set optimizer_switch=\"mrr_cost_based=off\"</code>\u3002\uff08\u5b98\u65b9\u6587\u6863\u7684\u8bf4\u6cd5\uff0c\u662f\u73b0\u5728\u7684\u4f18\u5316\u5668\u7b56\u7565\uff0c\u5224\u65ad\u6d88\u8017\u7684\u65f6\u5019\uff0c\u4f1a\u66f4\u503e\u5411\u4e8e\u4e0d\u4f7f\u7528 MRR\uff0c\u628a <code>mrr_cost_based</code> \u8bbe\u7f6e\u4e3a off\uff0c\u5c31\u662f\u56fa\u5b9a\u4f7f\u7528 MRR \u4e86\u3002\uff09</p> <p>\u4e0b\u9762\u4e24\u5e45\u56fe\u5c31\u662f\u4f7f\u7528\u4e86 MRR \u4f18\u5316\u540e\u7684\u6267\u884c\u6d41\u7a0b\u548c explain \u7ed3\u679c\u3002</p> <p></p> <p>\u56fe 2 MRR \u6267\u884c\u6d41\u7a0b</p> <pre><code>mysql&gt; explain select * from t2 where a&gt;=1 and a&lt;=100;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                            |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+\n|  1 | SIMPLE      | t2    | NULL       | range | a             | a    | 5       | NULL |  100 |   100.00 | Using index condition; Using MRR |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------+\n</code></pre> <p>\u4ece explain \u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Extra \u5b57\u6bb5\u591a\u4e86 Using MRR\uff0c\u8868\u793a\u7684\u662f\u7528\u4e0a\u4e86 MRR \u4f18\u5316\u3002\u800c\u4e14\uff0c\u7531\u4e8e\u6211\u4eec\u5728 <code>read_rnd_buffer</code> \u4e2d\u6309\u7167 id \u505a\u4e86\u6392\u5e8f\uff0c\u6240\u4ee5\u6700\u540e\u5f97\u5230\u7684\u7ed3\u679c\u96c6\u4e5f\u662f\u6309\u7167\u4e3b\u952e id \u9012\u589e\u987a\u5e8f\u7684\uff0c\u4e5f\u5c31\u662f\u4e0e\u56fe 1 \u7ed3\u679c\u96c6\u4e2d\u884c\u7684\u987a\u5e8f\u76f8\u53cd\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c0f\u7ed3\u4e00\u4e0b\u3002</p> <p>**MRR \u80fd\u591f\u63d0\u5347\u6027\u80fd\u7684\u6838\u5fc3**\u5728\u4e8e\uff0c\u8fd9\u6761\u67e5\u8be2\u8bed\u53e5\u5728\u7d22\u5f15 a \u4e0a\u505a\u7684\u662f\u4e00\u4e2a\u8303\u56f4\u67e5\u8be2\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u591a\u503c\u67e5\u8be2\uff09\uff0c\u53ef\u4ee5\u5f97\u5230\u8db3\u591f\u591a\u7684\u4e3b\u952e id\u3002\u8fd9\u6837\u901a\u8fc7\u6392\u5e8f\u4ee5\u540e\uff0c\u518d\u53bb\u4e3b\u952e\u7d22\u5f15\u67e5\u6570\u636e\uff0c\u624d\u80fd\u4f53\u73b0\u51fa\u201c\u987a\u5e8f\u6027\u201d\u7684\u4f18\u52bf\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#batched-key-access","title":"Batched Key Access","text":"<p>\u7406\u89e3\u4e86 MRR \u6027\u80fd\u63d0\u5347\u7684\u539f\u7406\uff0c\u6211\u4eec\u5c31\u80fd\u7406\u89e3 MySQL \u5728 5.6 \u7248\u672c\u540e\u5f00\u59cb\u5f15\u5165\u7684 Batched Key Acess(BKA) \u7b97\u6cd5\u4e86\u3002\u8fd9\u4e2a BKA \u7b97\u6cd5\uff0c\u5176\u5b9e\u5c31\u662f\u5bf9 NLJ \u7b97\u6cd5\u7684\u4f18\u5316\u3002</p> <p>\u6211\u4eec\u518d\u6765\u770b\u770b\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u7528\u5230\u7684 NLJ \u7b97\u6cd5\u7684\u6d41\u7a0b\u56fe\uff1a</p> <p></p> <p>\u56fe 4 Index Nested-Loop Join \u6d41\u7a0b\u56fe</p> <p>NLJ \u7b97\u6cd5\u6267\u884c\u7684\u903b\u8f91\u662f\uff1a\u4ece\u9a71\u52a8\u8868 t1\uff0c\u4e00\u884c\u884c\u5730\u53d6\u51fa a \u7684\u503c\uff0c\u518d\u5230\u88ab\u9a71\u52a8\u8868 t2 \u53bb\u505a join\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u8868 t2 \u6765\u8bf4\uff0c\u6bcf\u6b21\u90fd\u662f\u5339\u914d\u4e00\u4e2a\u503c\u3002\u8fd9\u65f6\uff0cMRR \u7684\u4f18\u52bf\u5c31\u7528\u4e0d\u4e0a\u4e86\u3002</p> <p>\u90a3\u600e\u4e48\u624d\u80fd\u4e00\u6b21\u6027\u5730\u591a\u4f20\u4e9b\u503c\u7ed9\u8868 t2 \u5462\uff1f\u65b9\u6cd5\u5c31\u662f\uff0c\u4ece\u8868 t1 \u91cc\u4e00\u6b21\u6027\u5730\u591a\u62ff\u4e9b\u884c\u51fa\u6765\uff0c\u4e00\u8d77\u4f20\u7ed9\u8868 t2\u3002</p> <p>\u65e2\u7136\u5982\u6b64\uff0c\u6211\u4eec\u5c31\u628a\u8868 t1 \u7684\u6570\u636e\u53d6\u51fa\u6765\u4e00\u90e8\u5206\uff0c\u5148\u653e\u5230\u4e00\u4e2a\u4e34\u65f6\u5185\u5b58\u3002\u8fd9\u4e2a\u4e34\u65f6\u5185\u5b58\u4e0d\u662f\u522b\u4eba\uff0c\u5c31\u662f join_buffer\u3002</p> <p>\u901a\u8fc7\u4e0a\u4e00\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u77e5\u9053 <code>join_buffer</code> \u5728 BNL \u7b97\u6cd5\u91cc\u7684\u4f5c\u7528\uff0c\u662f\u6682\u5b58\u9a71\u52a8\u8868\u7684\u6570\u636e\u3002\u4f46\u662f\u5728 NLJ \u7b97\u6cd5\u91cc\u5e76\u6ca1\u6709\u7528\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u521a\u597d\u5c31\u53ef\u4ee5\u590d\u7528 <code>join_buffer</code> \u5230 BKA \u7b97\u6cd5\u4e2d\u3002</p> <p>\u5982\u56fe 5 \u6240\u793a\uff0c\u662f\u4e0a\u9762\u7684 NLJ \u7b97\u6cd5\u4f18\u5316\u540e\u7684 BKA \u7b97\u6cd5\u7684\u6d41\u7a0b\u3002</p> <p></p> <p>\u56fe 5 Batched Key Acess \u6d41\u7a0b</p> <p>\u56fe\u4e2d\uff0c\u6211\u5728 <code>join_buffer</code> \u4e2d\u653e\u5165\u7684\u6570\u636e\u662f P1~P100\uff0c\u8868\u793a\u7684\u662f\u53ea\u4f1a\u53d6\u67e5\u8be2\u9700\u8981\u7684\u5b57\u6bb5\u3002\u5f53\u7136\uff0c\u5982\u679c join buffer \u653e\u4e0d\u4e0b P1~P100 \u7684\u6240\u6709\u6570\u636e\uff0c\u5c31\u4f1a\u628a\u8fd9 100 \u884c\u6570\u636e\u5206\u6210\u591a\u6bb5\u6267\u884c\u4e0a\u56fe\u7684\u6d41\u7a0b\u3002</p> <p>\u90a3\u4e48\uff0c\u8fd9\u4e2a BKA \u7b97\u6cd5\u5230\u5e95\u8981\u600e\u4e48\u542f\u7528\u5462\uff1f</p> <p>\u5982\u679c\u8981\u4f7f\u7528 BKA \u4f18\u5316\u7b97\u6cd5\u7684\u8bdd\uff0c\u4f60\u9700\u8981\u5728\u6267\u884c SQL \u8bed\u53e5\u4e4b\u524d\uff0c\u5148\u8bbe\u7f6e</p> <pre><code>set optimizer_switch='mrr=on,mrr_cost_based=off,batched_key_access=on';\n</code></pre> <p>\u5176\u4e2d\uff0c\u524d\u4e24\u4e2a\u53c2\u6570\u7684\u4f5c\u7528\u662f\u8981\u542f\u7528 MRR\u3002\u8fd9\u4e48\u505a\u7684\u539f\u56e0\u662f\uff0cBKA \u7b97\u6cd5\u7684\u4f18\u5316\u8981\u4f9d\u8d56\u4e8e MRR\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#bnl","title":"BNL \u7b97\u6cd5\u7684\u6027\u80fd\u95ee\u9898","text":"<p>\u8bf4\u5b8c\u4e86 NLJ \u7b97\u6cd5\u7684\u4f18\u5316\uff0c\u6211\u4eec\u518d\u6765\u770b BNL \u7b97\u6cd5\u7684\u4f18\u5316\u3002</p> <p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u672b\u5c3e\uff0c\u7ed9\u4f60\u7559\u4e0b\u7684\u601d\u8003\u9898\u662f\uff0c\u4f7f\u7528 Block Nested-Loop Join(BNL) \u7b97\u6cd5\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bf9\u88ab\u9a71\u52a8\u8868\u505a\u591a\u6b21\u626b\u63cf\u3002\u5982\u679c\u8fd9\u4e2a\u88ab\u9a71\u52a8\u8868\u662f\u4e00\u4e2a\u5927\u7684\u51b7\u6570\u636e\u8868\uff0c\u9664\u4e86\u4f1a\u5bfc\u81f4 IO \u538b\u529b\u5927\u4ee5\u5916\uff0c\u8fd8\u4f1a\u5bf9\u7cfb\u7edf\u6709\u4ec0\u4e48\u5f71\u54cd\u5462\uff1f</p> <p>\u6211\u4eec\u8bf4\u5230 InnoDB \u7684 LRU \u7b97\u6cd5\u7684\u65f6\u5019\u63d0\u5230\uff0c\u7531\u4e8e InnoDB \u5bf9 Bufffer Pool \u7684 LRU \u7b97\u6cd5\u505a\u4e86\u4f18\u5316\uff0c\u5373\uff1a\u7b2c\u4e00\u6b21\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\u7684\u6570\u636e\u9875\uff0c\u4f1a\u5148\u653e\u5728 old \u533a\u57df\u3002\u5982\u679c 1 \u79d2\u4e4b\u540e\u8fd9\u4e2a\u6570\u636e\u9875\u4e0d\u518d\u88ab\u8bbf\u95ee\u4e86\uff0c\u5c31\u4e0d\u4f1a\u88ab\u79fb\u52a8\u5230 LRU \u94fe\u8868\u5934\u90e8\uff0c\u8fd9\u6837\u5bf9 Buffer Pool \u7684\u547d\u4e2d\u7387\u5f71\u54cd\u5c31\u4e0d\u5927\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4e00\u4e2a\u4f7f\u7528 BNL \u7b97\u6cd5\u7684 join \u8bed\u53e5\uff0c\u591a\u6b21\u626b\u63cf\u4e00\u4e2a\u51b7\u8868\uff0c\u800c\u4e14\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u65f6\u95f4\u8d85\u8fc7 1 \u79d2\uff0c\u5c31\u4f1a\u5728\u518d\u6b21\u626b\u63cf\u51b7\u8868\u7684\u65f6\u5019\uff0c\u628a\u51b7\u8868\u7684\u6570\u636e\u9875\u79fb\u5230 LRU \u94fe\u8868\u5934\u90e8\u3002</p> <p>\u8fd9\u79cd\u60c5\u51b5\u5bf9\u5e94\u7684\uff0c\u662f\u51b7\u8868\u7684\u6570\u636e\u91cf\u5c0f\u4e8e\u6574\u4e2a Buffer Pool \u7684 \u215c\uff0c\u80fd\u591f\u5b8c\u5168\u653e\u5165 old \u533a\u57df\u7684\u60c5\u51b5\u3002</p> <p>\u5982\u679c\u8fd9\u4e2a\u51b7\u8868\u5f88\u5927\uff0c\u5c31\u4f1a\u51fa\u73b0\u53e6\u5916\u4e00\u79cd\u60c5\u51b5\uff1a\u4e1a\u52a1\u6b63\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u9875\uff0c\u6ca1\u6709\u673a\u4f1a\u8fdb\u5165 young \u533a\u57df\u3002</p> <p>\u7531\u4e8e\u4f18\u5316\u673a\u5236\u7684\u5b58\u5728\uff0c\u4e00\u4e2a\u6b63\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u9875\uff0c\u8981\u8fdb\u5165 young \u533a\u57df\uff0c\u9700\u8981\u9694 1 \u79d2\u540e\u518d\u6b21\u88ab\u8bbf\u95ee\u5230\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u7684 join \u8bed\u53e5\u5728\u5faa\u73af\u8bfb\u78c1\u76d8\u548c\u6dd8\u6c70\u5185\u5b58\u9875\uff0c\u8fdb\u5165 old \u533a\u57df\u7684\u6570\u636e\u9875\uff0c\u5f88\u53ef\u80fd\u5728 1 \u79d2\u4e4b\u5185\u5c31\u88ab\u6dd8\u6c70\u4e86\u3002\u8fd9\u6837\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8fd9\u4e2a MySQL \u5b9e\u4f8b\u7684 Buffer Pool \u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0cyoung \u533a\u57df\u7684\u6570\u636e\u9875\u6ca1\u6709\u88ab\u5408\u7406\u5730\u6dd8\u6c70\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e24\u79cd\u60c5\u51b5\u90fd\u4f1a\u5f71\u54cd Buffer Pool \u7684\u6b63\u5e38\u8fd0\u4f5c\u3002</p> <p>\u5927\u8868 join \u64cd\u4f5c\u867d\u7136\u5bf9 IO \u6709\u5f71\u54cd\uff0c\u4f46\u662f\u5728\u8bed\u53e5\u6267\u884c\u7ed3\u675f\u540e\uff0c\u5bf9 IO \u7684\u5f71\u54cd\u4e5f\u5c31\u7ed3\u675f\u4e86\u3002\u4f46\u662f\uff0c\u5bf9 Buffer Pool \u7684\u5f71\u54cd\u5c31\u662f\u6301\u7eed\u6027\u7684\uff0c\u9700\u8981\u4f9d\u9760\u540e\u7eed\u7684\u67e5\u8be2\u8bf7\u6c42\u6162\u6162\u6062\u590d\u5185\u5b58\u547d\u4e2d\u7387\u3002</p> <p>\u4e3a\u4e86\u51cf\u5c11\u8fd9\u79cd\u5f71\u54cd\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u589e\u5927 join_buffer_size \u7684\u503c\uff0c\u51cf\u5c11\u5bf9\u88ab\u9a71\u52a8\u8868\u7684\u626b\u63cf\u6b21\u6570\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cBNL \u7b97\u6cd5\u5bf9\u7cfb\u7edf\u7684\u5f71\u54cd\u4e3b\u8981\u5305\u62ec\u4e09\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u53ef\u80fd\u4f1a\u591a\u6b21\u626b\u63cf\u88ab\u9a71\u52a8\u8868\uff0c\u5360\u7528\u78c1\u76d8 IO \u8d44\u6e90\uff1b</li> <li>\u5224\u65ad join \u6761\u4ef6\u9700\u8981\u6267\u884c M*N \u6b21\u5bf9\u6bd4\uff08M\u3001N \u5206\u522b\u662f\u4e24\u5f20\u8868\u7684\u884c\u6570\uff09\uff0c\u5982\u679c\u662f\u5927\u8868\u5c31\u4f1a\u5360\u7528\u975e\u5e38\u591a\u7684 CPU \u8d44\u6e90\uff1b</li> <li>\u53ef\u80fd\u4f1a\u5bfc\u81f4 Buffer Pool \u7684\u70ed\u6570\u636e\u88ab\u6dd8\u6c70\uff0c\u5f71\u54cd\u5185\u5b58\u547d\u4e2d\u7387\u3002</li> </ol> <p>\u6211\u4eec\u6267\u884c\u8bed\u53e5\u4e4b\u524d\uff0c\u9700\u8981\u901a\u8fc7\u7406\u8bba\u5206\u6790\u548c\u67e5\u770b explain \u7ed3\u679c\u7684\u65b9\u5f0f\uff0c\u786e\u8ba4\u662f\u5426\u8981\u4f7f\u7528 BNL \u7b97\u6cd5\u3002\u5982\u679c\u786e\u8ba4\u4f18\u5316\u5668\u4f1a\u4f7f\u7528 BNL \u7b97\u6cd5\uff0c\u5c31\u9700\u8981\u505a\u4f18\u5316\u3002\u4f18\u5316\u7684\u5e38\u89c1\u505a\u6cd5\u662f\uff0c\u7ed9\u88ab\u9a71\u52a8\u8868\u7684 join \u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\uff0c\u628a BNL \u7b97\u6cd5\u8f6c\u6210 BKA \u7b97\u6cd5\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u5177\u4f53\u770b\u770b\uff0c\u8fd9\u4e2a\u4f18\u5316\u600e\u4e48\u505a\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#bnl-bka","title":"BNL \u8f6c BKA","text":"<p>\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u5efa\u7d22\u5f15\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u76f4\u63a5\u8f6c\u6210 BKA \u7b97\u6cd5\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u6709\u65f6\u5019\u4f60\u786e\u5b9e\u4f1a\u78b0\u5230\u4e00\u4e9b\u4e0d\u9002\u5408\u5728\u88ab\u9a71\u52a8\u8868\u4e0a\u5efa\u7d22\u5f15\u7684\u60c5\u51b5\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>select * from t1 join t2 on (t1.b=t2.b) where t2.b&gt;=1 and t2.b&lt;=2000;\n</code></pre> <p>\u6211\u4eec\u5728\u6587\u7ae0\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u5728\u8868 t2 \u4e2d\u63d2\u5165\u4e86 100 \u4e07\u884c\u6570\u636e\uff0c\u4f46\u662f\u7ecf\u8fc7 where \u6761\u4ef6\u8fc7\u6ee4\u540e\uff0c\u9700\u8981\u53c2\u4e0e join \u7684\u53ea\u6709 2000 \u884c\u6570\u636e\u3002\u5982\u679c\u8fd9\u6761\u8bed\u53e5\u540c\u65f6\u662f\u4e00\u4e2a\u4f4e\u9891\u7684 SQL \u8bed\u53e5\uff0c\u90a3\u4e48\u518d\u4e3a\u8fd9\u4e2a\u8bed\u53e5\u5728\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u5c31\u5f88\u6d6a\u8d39\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f7f\u7528 BNL \u7b97\u6cd5\u6765 join \u7684\u8bdd\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u628a\u8868 t1 \u7684\u6240\u6709\u5b57\u6bb5\u53d6\u51fa\u6765\uff0c\u5b58\u5165 <code>join_buffer</code> \u4e2d\u3002\u8fd9\u4e2a\u8868\u53ea\u6709 1000 \u884c\uff0c<code>join_buffer_size</code> \u9ed8\u8ba4\u503c\u662f 256k\uff0c\u53ef\u4ee5\u5b8c\u5168\u5b58\u5165\u3002</li> <li>\u626b\u63cf\u8868 t2\uff0c\u53d6\u51fa\u6bcf\u4e00\u884c\u6570\u636e\u8ddf <code>join_buffer</code> \u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5bf9\u6bd4\uff0c </li> <li>\u5982\u679c\u4e0d\u6ee1\u8db3 t1.b=t2.b\uff0c\u5219\u8df3\u8fc7\uff1b</li> <li>\u5982\u679c\u6ee1\u8db3 t1.b=t2.b, \u518d\u5224\u65ad\u5176\u4ed6\u6761\u4ef6\uff0c\u4e5f\u5c31\u662f\u662f\u5426\u6ee1\u8db3 t2.b \u5904\u4e8e [1,2000] \u7684\u6761\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5c31\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\u8fd4\u56de\uff0c\u5426\u5219\u8df3\u8fc7\u3002</li> </ol> <p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u8bf4\u8fc7\uff0c\u5bf9\u4e8e\u8868 t2 \u7684\u6bcf\u4e00\u884c\uff0c\u5224\u65ad join \u662f\u5426\u6ee1\u8db3\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u904d\u5386 join_buffer \u4e2d\u7684\u6240\u6709\u884c\u3002\u56e0\u6b64\u5224\u65ad\u7b49\u503c\u6761\u4ef6\u7684\u6b21\u6570\u662f 1000*100 \u4e07 =10 \u4ebf\u6b21\uff0c\u8fd9\u4e2a\u5224\u65ad\u7684\u5de5\u4f5c\u91cf\u5f88\u5927\u3002</p> <pre><code>mysql&gt; explain select * from t1 join t2 on (t1.b = t2.b) where t2.b &gt;=1 and t2.b &lt;=2000;\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n|  1 | SIMPLE      | t1    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1000 |   100.00 | Using where                                        |\n|  1 | SIMPLE      | t2    | NULL       | ALL  | NULL          | NULL | NULL    | NULL |998222|     1.11 | Using where; Using join buffer (Block Nested Loop) |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cexplain \u7ed3\u679c\u91cc Extra \u5b57\u6bb5\u663e\u793a\u4f7f\u7528\u4e86 BNL \u7b97\u6cd5\u3002\u5728\u6211\u7684\u6d4b\u8bd5\u73af\u5883\u91cc\uff0c\u8fd9\u6761\u8bed\u53e5\u9700\u8981\u6267\u884c 1 \u5206 11 \u79d2\u3002</p> <p>\u5728\u8868 t2 \u7684\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u7d22\u5f15\u4f1a\u6d6a\u8d39\u8d44\u6e90\uff0c\u4f46\u662f\u4e0d\u521b\u5efa\u7d22\u5f15\u7684\u8bdd\u8fd9\u4e2a\u8bed\u53e5\u7684\u7b49\u503c\u6761\u4ef6\u8981\u5224\u65ad 10 \u4ebf\u6b21\uff0c\u60f3\u60f3\u4e5f\u662f\u6d6a\u8d39\u3002\u90a3\u4e48\uff0c\u6709\u6ca1\u6709\u4e24\u5168\u5176\u7f8e\u7684\u529e\u6cd5\u5462\uff1f</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u4e34\u65f6\u8868\u3002\u4f7f\u7528\u4e34\u65f6\u8868\u7684\u5927\u81f4\u601d\u8def\u662f\uff1a</p> <ol> <li>\u628a\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u653e\u5728\u4e34\u65f6\u8868 tmp_t \u4e2d\uff1b</li> <li>\u4e3a\u4e86\u8ba9 join \u4f7f\u7528 BKA \u7b97\u6cd5\uff0c\u7ed9\u4e34\u65f6\u8868 tmp_t \u7684\u5b57\u6bb5 b \u52a0\u4e0a\u7d22\u5f15\uff1b</li> <li>\u8ba9\u8868 t1 \u548c tmp_t \u505a join \u64cd\u4f5c\u3002</li> </ol> <p>\u6b64\u65f6\uff0c\u5bf9\u5e94\u7684 SQL \u8bed\u53e5\u7684\u5199\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>create temporary table temp_t(id int primary key, a int, b int, index(b))engine=innodb;\ninsert into temp_t select * from t2 where b&gt;=1 and b&lt;=2000;\nselect * from t1 join temp_t on (t1.b=temp_t.b);\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4e00\u8d77\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u6d88\u8017\uff1a</p> <ol> <li>\u6267\u884c insert \u8bed\u53e5\u6784\u9020 <code>temp_t</code> \u8868\u5e76\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8868 t2 \u505a\u4e86\u5168\u8868\u626b\u63cf\uff0c\u8fd9\u91cc\u626b\u63cf\u884c\u6570\u662f 100 \u4e07\u3002</li> <li>\u4e4b\u540e\u7684 join \u8bed\u53e5\uff0c\u626b\u63cf\u8868 t1\uff0c\u8fd9\u91cc\u7684\u626b\u63cf\u884c\u6570\u662f 1000\uff1bjoin \u6bd4\u8f83\u8fc7\u7a0b\u4e2d\uff0c\u505a\u4e86 1000 \u6b21\u5e26\u7d22\u5f15\u7684\u67e5\u8be2\u3002\u76f8\u6bd4\u4e8e\u4f18\u5316\u524d\u7684 join \u8bed\u53e5\u9700\u8981\u505a 10 \u4ebf\u6b21\u6761\u4ef6\u5224\u65ad\u6765\u8bf4\uff0c\u8fd9\u4e2a\u4f18\u5316\u6548\u679c\u8fd8\u662f\u5f88\u660e\u663e\u7684\u3002</li> </ol> <p>\u603b\u4f53\u6765\u770b\uff0c\u4e0d\u8bba\u662f\u5728\u539f\u8868\u4e0a\u52a0\u7d22\u5f15\uff0c\u8fd8\u662f\u7528\u6709\u7d22\u5f15\u7684\u4e34\u65f6\u8868\uff0c\u6211\u4eec\u7684\u601d\u8def\u90fd\u662f\u8ba9 join \u8bed\u53e5\u80fd\u591f\u7528\u4e0a\u88ab\u9a71\u52a8\u8868\u4e0a\u7684\u7d22\u5f15\uff0c\u6765\u89e6\u53d1 BKA \u7b97\u6cd5\uff0c\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#hash-join","title":"\u6269\u5c55 hash join","text":"<p>\u770b\u5230\u8fd9\u91cc\u4f60\u53ef\u80fd\u53d1\u73b0\u4e86\uff0c\u5176\u5b9e\u4e0a\u9762\u8ba1\u7b97 10 \u4ebf\u6b21\u90a3\u4e2a\u64cd\u4f5c\uff0c\u770b\u4e0a\u53bb\u6709\u70b9\u513f\u50bb\u3002\u5982\u679c <code>join_buffer</code> \u91cc\u9762\u7ef4\u62a4\u7684\u4e0d\u662f\u4e00\u4e2a\u65e0\u5e8f\u6570\u7ec4\uff0c\u800c\u662f\u4e00\u4e2a\u54c8\u5e0c\u8868\u7684\u8bdd\uff0c\u90a3\u4e48\u5c31\u4e0d\u662f 10 \u4ebf\u6b21\u5224\u65ad\uff0c\u800c\u662f 100 \u4e07\u6b21 hash \u67e5\u627e\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u6574\u6761\u8bed\u53e5\u7684\u6267\u884c\u901f\u5ea6\u5c31\u5feb\u591a\u4e86\u5427\uff1f</p> <p>\u786e\u5b9e\u5982\u6b64\u3002</p> <p>\u8fd9\uff0c\u4e5f\u6b63\u662f MySQL \u7684\u4f18\u5316\u5668\u548c\u6267\u884c\u5668\u4e00\u76f4\u88ab\u8bdf\u75c5\u7684\u4e00\u4e2a\u539f\u56e0\uff1a\u4e0d\u652f\u6301\u54c8\u5e0c join\u3002\u5e76\u4e14\uff0cMySQL \u5b98\u65b9\u7684 roadmap\uff0c\u4e5f\u662f\u8fdf\u8fdf\u6ca1\u6709\u628a\u8fd9\u4e2a\u4f18\u5316\u6392\u4e0a\u8bae\u7a0b\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u4f18\u5316\u601d\u8def\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0\u5728\u4e1a\u52a1\u7aef\u3002\u5b9e\u73b0\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p> <ol> <li><code>select * from t1;</code>\u53d6\u5f97\u8868 t1 \u7684\u5168\u90e8 1000 \u884c\u6570\u636e\uff0c\u5728\u4e1a\u52a1\u7aef\u5b58\u5165\u4e00\u4e2a hash \u7ed3\u6784\uff0c\u6bd4\u5982 C++ \u91cc\u7684 set\u3001PHP \u7684 dict \u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u3002</li> <li><code>select * from t2 where b&gt;=1 and b&lt;=2000;</code> \u83b7\u53d6\u8868 t2 \u4e2d\u6ee1\u8db3\u6761\u4ef6\u7684 2000 \u884c\u6570\u636e\u3002</li> <li>\u628a\u8fd9 2000 \u884c\u6570\u636e\uff0c\u4e00\u884c\u4e00\u884c\u5730\u53d6\u5230\u4e1a\u52a1\u7aef\uff0c\u5230 hash \u7ed3\u6784\u7684\u6570\u636e\u8868\u4e2d\u5bfb\u627e\u5339\u914d\u7684\u6570\u636e\u3002\u6ee1\u8db3\u5339\u914d\u7684\u6761\u4ef6\u7684\u8fd9\u884c\u6570\u636e\uff0c\u5c31\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u884c\u3002</li> </ol> <p>\u7406\u8bba\u4e0a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u6bd4\u4e34\u65f6\u8868\u65b9\u6848\u7684\u6267\u884c\u901f\u5ea6\u8fd8\u8981\u5feb\u4e00\u4e9b\u3002\u5982\u679c\u4f60\u611f\u5174\u8da3\u7684\u8bdd\uff0c\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_15","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u548c\u4f60\u5206\u4eab\u4e86 Index Nested-Loop Join\uff08NLJ\uff09\u548c Block Nested-Loop Join\uff08BNL\uff09\u7684\u4f18\u5316\u65b9\u6cd5\u3002</p> <p>\u5728\u8fd9\u4e9b\u4f18\u5316\u65b9\u6cd5\u4e2d\uff1a</p> <ol> <li>BKA \u4f18\u5316\u662f MySQL \u5df2\u7ecf\u5185\u7f6e\u652f\u6301\u7684\uff0c\u5efa\u8bae\u4f60\u9ed8\u8ba4\u4f7f\u7528\uff1b</li> <li>BNL \u7b97\u6cd5\u6548\u7387\u4f4e\uff0c\u5efa\u8bae\u4f60\u90fd\u5c3d\u91cf\u8f6c\u6210 BKA \u7b97\u6cd5\u3002\u4f18\u5316\u7684\u65b9\u5411\u5c31\u662f\u7ed9\u88ab\u9a71\u52a8\u8868\u7684\u5173\u8054\u5b57\u6bb5\u52a0\u4e0a\u7d22\u5f15\uff1b</li> <li>\u57fa\u4e8e\u4e34\u65f6\u8868\u7684\u6539\u8fdb\u65b9\u6848\uff0c\u5bf9\u4e8e\u80fd\u591f\u63d0\u524d\u8fc7\u6ee4\u51fa\u5c0f\u6570\u636e\u7684 join \u8bed\u53e5\u6765\u8bf4\uff0c\u6548\u679c\u8fd8\u662f\u5f88\u597d\u7684\uff1b</li> <li>MySQL \u76ee\u524d\u7684\u7248\u672c\u8fd8\u4e0d\u652f\u6301 hash join\uff0c\u4f46\u4f60\u53ef\u4ee5\u914d\u5408\u5e94\u7528\u7aef\u81ea\u5df1\u6a21\u62df\u51fa\u6765\uff0c\u7406\u8bba\u4e0a\u6548\u679c\u8981\u597d\u4e8e\u4e34\u65f6\u8868\u7684\u65b9\u6848\u3002</li> </ol> <p>\u6700\u540e\uff0c\u6211\u7ed9\u4f60\u7559\u4e0b\u4e00\u9053\u601d\u8003\u9898\u5427\u3002</p> <p>\u6211\u4eec\u5728\u8bb2 join \u8bed\u53e5\u7684\u8fd9\u4e24\u7bc7\u6587\u7ae0\u4e2d\uff0c\u90fd\u53ea\u6d89\u53ca\u5230\u4e86\u4e24\u4e2a\u8868\u7684 join\u3002\u90a3\u4e48\uff0c\u73b0\u5728\u6709\u4e00\u4e2a\u4e09\u4e2a\u8868 join \u7684\u9700\u6c42\uff0c\u5047\u8bbe\u8fd9\u4e09\u4e2a\u8868\u7684\u8868\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>CREATE TABLE `t1` (\n `id` int(11) NOT NULL,\n `a` int(11) DEFAULT NULL,\n `b` int(11) DEFAULT NULL,\n `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB; \ncreate table t2 like t1;\ncreate table t3 like t2;\ninsert into ... -- \u521d\u59cb\u5316\u4e09\u5f20\u8868\u7684\u6570\u636e\n</code></pre> <p>\u8bed\u53e5\u7684\u9700\u6c42\u5b9e\u73b0\u5982\u4e0b\u7684 join \u903b\u8f91\uff1a</p> <pre><code>select * from t1 join t2 on(t1.a=t2.a) join t3 on (t2.b=t3.b) where t1.c&gt;=X and t2.c&gt;=Y and t3.c&gt;=Z;\n</code></pre> <p>\u73b0\u5728\u4e3a\u4e86\u5f97\u5230\u6700\u5feb\u7684\u6267\u884c\u901f\u5ea6\uff0c\u5982\u679c\u8ba9\u4f60\u6765\u8bbe\u8ba1\u8868 t1\u3001t2\u3001t3 \u4e0a\u7684\u7d22\u5f15\uff0c\u6765\u652f\u6301\u8fd9\u4e2a join \u8bed\u53e5\uff0c\u4f60\u4f1a\u52a0\u54ea\u4e9b\u7d22\u5f15\u5462\uff1f</p> <p>\u540c\u65f6\uff0c\u5982\u679c\u6211\u5e0c\u671b\u4f60\u7528 <code>straight_join</code> \u6765\u91cd\u5199\u8fd9\u4e2a\u8bed\u53e5\uff0c\u914d\u5408\u4f60\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u4f60\u5c31\u9700\u8981\u5b89\u6392\u8fde\u63a5\u987a\u5e8f\uff0c\u4f60\u4e3b\u8981\u8003\u8651\u7684\u56e0\u7d20\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u56de\u7b54\uff1a</p> <p>\u5982\u679c\u6539\u5199\u6210 <code>straight_join</code>\uff0c\u8981\u600e\u4e48\u6307\u5b9a\u8fde\u63a5\u987a\u5e8f\uff0c\u4ee5\u53ca\u600e\u4e48\u7ed9\u4e09\u4e2a\u8868\u521b\u5efa\u7d22\u5f15\u3002</p> <p>\u7b2c\u4e00\u539f\u5219\u662f\u8981\u5c3d\u91cf\u4f7f\u7528 BKA \u7b97\u6cd5\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4f7f\u7528 BKA \u7b97\u6cd5\u7684\u65f6\u5019\uff0c\u5e76\u4e0d\u662f\u201c\u5148\u8ba1\u7b97\u4e24\u4e2a\u8868 join \u7684\u7ed3\u679c\uff0c\u518d\u8ddf\u7b2c\u4e09\u4e2a\u8868 join\u201d\uff0c\u800c\u662f\u76f4\u63a5\u5d4c\u5957\u67e5\u8be2\u7684\u3002</p> <p>\u5177\u4f53\u5b9e\u73b0\u662f\uff1a\u5728 t1.c&gt;=X\u3001t2.c&gt;=Y\u3001t3.c&gt;=Z \u8fd9\u4e09\u4e2a\u6761\u4ef6\u91cc\uff0c\u9009\u62e9\u4e00\u4e2a\u7ecf\u8fc7\u8fc7\u6ee4\u4ee5\u540e\uff0c\u6570\u636e\u6700\u5c11\u7684\u90a3\u4e2a\u8868\uff0c\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u3002\u6b64\u65f6\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u5982\u4e0b\u4e24\u79cd\u60c5\u51b5\u3002</p> <p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u9009\u51fa\u6765\u662f\u8868 t1 \u6216\u8005 t3\uff0c\u90a3\u5269\u4e0b\u7684\u90e8\u5206\u5c31\u56fa\u5b9a\u4e86\u3002</p> <ol> <li>\u5982\u679c\u9a71\u52a8\u8868\u662f t1\uff0c\u5219\u8fde\u63a5\u987a\u5e8f\u662f t1-&gt;t2-&gt;t3\uff0c\u8981\u5728\u88ab\u9a71\u52a8\u8868\u5b57\u6bb5\u521b\u5efa\u4e0a\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f t2.a \u548c t3.b \u4e0a\u521b\u5efa\u7d22\u5f15\uff1b</li> <li>\u5982\u679c\u9a71\u52a8\u8868\u662f t3\uff0c\u5219\u8fde\u63a5\u987a\u5e8f\u662f t3-&gt;t2-&gt;t1\uff0c\u9700\u8981\u5728 t2.b \u548c t1.a \u4e0a\u521b\u5efa\u7d22\u5f15\u3002</li> </ol> <p>\u540c\u65f6\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5728\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u7684\u5b57\u6bb5 c \u4e0a\u521b\u5efa\u7d22\u5f15\u3002</p> <p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u5982\u679c\u9009\u51fa\u6765\u7684\u7b2c\u4e00\u4e2a\u9a71\u52a8\u8868\u662f\u8868 t2 \u7684\u8bdd\uff0c\u5219\u9700\u8981\u8bc4\u4f30\u53e6\u5916\u4e24\u4e2a\u6761\u4ef6\u7684\u8fc7\u6ee4\u6548\u679c\u3002</p> <p>\u603b\u4e4b\uff0c\u6574\u4f53\u7684\u601d\u8def\u5c31\u662f\uff0c\u5c3d\u91cf\u8ba9\u6bcf\u4e00\u6b21\u53c2\u4e0e join \u7684\u9a71\u52a8\u8868\u7684\u6570\u636e\u96c6\uff0c\u8d8a\u5c0f\u8d8a\u597d\uff0c\u56e0\u4e3a\u8fd9\u6837\u6211\u4eec\u7684\u9a71\u52a8\u8868\u5c31\u4f1a\u8d8a\u5c0f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#36","title":"36 \u4e3a\u4ec0\u4e48\u4e34\u65f6\u8868\u53ef\u4ee5\u91cd\u540d\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5728\u4f18\u5316 join \u67e5\u8be2\u7684\u65f6\u5019\u4f7f\u7528\u5230\u4e86\u4e34\u65f6\u8868\u3002\u5f53\u65f6\uff0c\u6211\u4eec\u662f\u8fd9\u4e48\u7528\u7684\uff1a</p> <pre><code>create temporary table temp_t like t1;\nalter table temp_t add index(b);\ninsert into temp_t select * from t2 where b&gt;=1 and b&lt;=2000;\nselect * from t1 join temp_t on (t1.b=temp_t.b);\n</code></pre> <p>\u4f60\u53ef\u80fd\u4f1a\u6709\u7591\u95ee\uff0c\u4e3a\u4ec0\u4e48\u8981\u7528\u4e34\u65f6\u8868\u5462\uff1f\u76f4\u63a5\u7528\u666e\u901a\u8868\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u5462\uff1f</p> <p>\u4eca\u5929\u6211\u4eec\u5c31\u4ece\u8fd9\u4e2a\u95ee\u9898\u8bf4\u8d77\uff1a\u4e34\u65f6\u8868\u6709\u54ea\u4e9b\u7279\u5f81\uff0c\u4e3a\u4ec0\u4e48\u5b83\u9002\u5408\u8fd9\u4e2a\u573a\u666f\uff1f</p> <p>\u8fd9\u91cc\uff0c\u6211\u9700\u8981\u5148\u5e2e\u4f60\u5398\u6e05\u4e00\u4e2a\u5bb9\u6613\u8bef\u89e3\u7684\u95ee\u9898\uff1a\u6709\u7684\u4eba\u53ef\u80fd\u4f1a\u8ba4\u4e3a\uff0c\u4e34\u65f6\u8868\u5c31\u662f\u5185\u5b58\u8868\u3002\u4f46\u662f\uff0c\u8fd9\u4e24\u4e2a\u6982\u5ff5\u53ef\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u3002</p> <ul> <li>\u5185\u5b58\u8868\uff0c\u6307\u7684\u662f\u4f7f\u7528 Memory \u5f15\u64ce\u7684\u8868\uff0c\u5efa\u8868\u8bed\u6cd5\u662f <code>create table \u2026 engine=memory</code>\u3002\u8fd9\u79cd\u8868\u7684\u6570\u636e\u90fd\u4fdd\u5b58\u5728\u5185\u5b58\u91cc\uff0c\u7cfb\u7edf\u91cd\u542f\u7684\u65f6\u5019\u4f1a\u88ab\u6e05\u7a7a\uff0c\u4f46\u662f\u8868\u7ed3\u6784\u8fd8\u5728\u3002\u9664\u4e86\u8fd9\u4e24\u4e2a\u7279\u6027\u770b\u4e0a\u53bb\u6bd4\u8f83\u201c\u5947\u602a\u201d\u5916\uff0c\u4ece\u5176\u4ed6\u7684\u7279\u5f81\u4e0a\u770b\uff0c\u5b83\u5c31\u662f\u4e00\u4e2a\u6b63\u5e38\u7684\u8868\u3002</li> <li>\u800c\u4e34\u65f6\u8868\uff0c\u53ef\u4ee5\u4f7f\u7528\u5404\u79cd\u5f15\u64ce\u7c7b\u578b \u3002\u5982\u679c\u662f\u4f7f\u7528 InnoDB \u5f15\u64ce\u6216\u8005 MyISAM \u5f15\u64ce\u7684\u4e34\u65f6\u8868\uff0c\u5199\u6570\u636e\u7684\u65f6\u5019\u662f\u5199\u5230\u78c1\u76d8\u4e0a\u7684\u3002\u5f53\u7136\uff0c\u4e34\u65f6\u8868\u4e5f\u53ef\u4ee5\u4f7f\u7528 Memory \u5f15\u64ce\u3002</li> </ul> <p>\u5f04\u6e05\u695a\u4e86\u5185\u5b58\u8868\u548c\u4e34\u65f6\u8868\u7684\u533a\u522b\u4ee5\u540e\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u4e34\u65f6\u8868\u6709\u54ea\u4e9b\u7279\u5f81\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_16","title":"\u4e34\u65f6\u8868\u7684\u7279\u6027","text":"<p>\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u6211\u4eec\u6765\u770b\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u64cd\u4f5c\u5e8f\u5217\uff1a</p> <pre><code>sequenceDiagram\nparticipant SessionA\nparticipant Table\nparticipant SessionB\n\nSessionA -&gt;&gt; Table: create temporary table t(c int) engine=myisam;\n\nSessionB -&gt;&gt;+ Table: show create table t\nTable --&gt;&gt;- SessionB: Table 't' doesn't exists\n\nSessionA -&gt;&gt; Table: create table t (id int primary key) engine=innodb\nSessionA -&gt;&gt; Table: show create table t;\nTable --&gt;&gt; SessionA: return 't' defination\nSessionA -&gt;&gt; Table: show tables \nTable --&gt;&gt; SessionA: return all normal tables\n\nSessionB -&gt;&gt;+ Table: insert into t values(1)\nTable --&gt;&gt;- SessionB: return 1\n\nSessionA -&gt;&gt;+ Table: select * from t\nTable --&gt;&gt;- SessionA: return empty</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e34\u65f6\u8868\u5728\u4f7f\u7528\u4e0a\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ol> <li>\u5efa\u8868\u8bed\u6cd5\u662f <code>create temporary table \u2026</code>\u3002</li> <li>\u4e00\u4e2a\u4e34\u65f6\u8868\u53ea\u80fd\u88ab\u521b\u5efa\u5b83\u7684 session \u8bbf\u95ee\uff0c\u5bf9\u5176\u4ed6\u7ebf\u7a0b\u4e0d\u53ef\u89c1\u3002\u6240\u4ee5\uff0c\u56fe\u4e2d session A \u521b\u5efa\u7684\u4e34\u65f6\u8868 t\uff0c\u5bf9\u4e8e session B \u5c31\u662f\u4e0d\u53ef\u89c1\u7684\u3002</li> <li>\u4e34\u65f6\u8868\u53ef\u4ee5\u4e0e\u666e\u901a\u8868\u540c\u540d\u3002</li> <li>session A \u5185\u6709\u540c\u540d\u7684\u4e34\u65f6\u8868\u548c\u666e\u901a\u8868\u7684\u65f6\u5019\uff0cshow create \u8bed\u53e5\uff0c\u4ee5\u53ca\u589e\u5220\u6539\u67e5\u8bed\u53e5\u8bbf\u95ee\u7684\u662f\u4e34\u65f6\u8868\u3002</li> <li>show tables \u547d\u4ee4\u4e0d\u663e\u793a\u4e34\u65f6\u8868\u3002</li> </ol> <p>\u7531\u4e8e\u4e34\u65f6\u8868\u53ea\u80fd\u88ab\u521b\u5efa\u5b83\u7684 session \u8bbf\u95ee\uff0c\u6240\u4ee5\u5728\u8fd9\u4e2a session \u7ed3\u675f\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u5220\u9664\u4e34\u65f6\u8868\u3002\u4e5f\u6b63\u662f\u7531\u4e8e\u8fd9\u4e2a\u7279\u6027\uff0c\u4e34\u65f6\u8868\u5c31\u7279\u522b\u9002\u5408\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u7684 join \u4f18\u5316\u8fd9\u79cd\u573a\u666f\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u539f\u56e0\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u4e0d\u540c session \u7684\u4e34\u65f6\u8868\u662f\u53ef\u4ee5\u91cd\u540d\u7684\uff0c\u5982\u679c\u6709\u591a\u4e2a session \u540c\u65f6\u6267\u884c join \u4f18\u5316\uff0c\u4e0d\u9700\u8981\u62c5\u5fc3\u8868\u540d\u91cd\u590d\u5bfc\u81f4\u5efa\u8868\u5931\u8d25\u7684\u95ee\u9898\u3002</li> <li>\u4e0d\u9700\u8981\u62c5\u5fc3\u6570\u636e\u5220\u9664\u95ee\u9898\u3002\u5982\u679c\u4f7f\u7528\u666e\u901a\u8868\uff0c\u5728\u6d41\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u5ba2\u6237\u7aef\u53d1\u751f\u4e86\u5f02\u5e38\u65ad\u5f00\uff0c\u6216\u8005\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u8fd8\u9700\u8981\u4e13\u95e8\u6765\u6e05\u7406\u4e2d\u95f4\u8fc7\u7a0b\u4e2d\u751f\u6210\u7684\u6570\u636e\u8868\u3002\u800c\u4e34\u65f6\u8868\u7531\u4e8e\u4f1a\u81ea\u52a8\u56de\u6536\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u8fd9\u4e2a\u989d\u5916\u7684\u64cd\u4f5c\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_17","title":"\u4e34\u65f6\u8868\u7684\u5e94\u7528","text":"<p>\u7531\u4e8e\u4e0d\u7528\u62c5\u5fc3\u7ebf\u7a0b\u4e4b\u95f4\u7684\u91cd\u540d\u51b2\u7a81\uff0c\u4e34\u65f6\u8868\u7ecf\u5e38\u4f1a\u88ab\u7528\u5728\u590d\u6742\u67e5\u8be2\u7684\u4f18\u5316\u8fc7\u7a0b\u4e2d\u3002\u5176\u4e2d\uff0c\u5206\u5e93\u5206\u8868\u7cfb\u7edf\u7684\u8de8\u5e93\u67e5\u8be2\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u4f7f\u7528\u573a\u666f\u3002</p> <p>\u4e00\u822c\u5206\u5e93\u5206\u8868\u7684\u573a\u666f\uff0c\u5c31\u662f\u8981\u628a\u4e00\u4e2a\u903b\u8f91\u4e0a\u7684\u5927\u8868\u5206\u6563\u5230\u4e0d\u540c\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\u3002\u6bd4\u5982\u3002\u5c06\u4e00\u4e2a\u5927\u8868 ht\uff0c\u6309\u7167\u5b57\u6bb5 f\uff0c\u62c6\u5206\u6210 1024 \u4e2a\u5206\u8868\uff0c\u7136\u540e\u5206\u5e03\u5230 32 \u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\u3002</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u5206\u5e93\u5206\u8868\u7cfb\u7edf\u90fd\u6709\u4e00\u4e2a\u4e2d\u95f4\u5c42 proxy\u3002\u4e0d\u8fc7\uff0c\u4e5f\u6709\u4e00\u4e9b\u65b9\u6848\u4f1a\u8ba9\u5ba2\u6237\u7aef\u76f4\u63a5\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u4e5f\u5c31\u662f\u6ca1\u6709 proxy \u8fd9\u4e00\u5c42\u3002</p> <p>\u5728\u8fd9\u4e2a\u67b6\u6784\u4e2d\uff0c\u5206\u533a key \u7684\u9009\u62e9\u662f\u4ee5\u201c\u51cf\u5c11\u8de8\u5e93\u548c\u8de8\u8868\u67e5\u8be2\u201d\u4e3a\u4f9d\u636e\u7684\u3002\u5982\u679c\u5927\u90e8\u5206\u7684\u8bed\u53e5\u90fd\u4f1a\u5305\u542b f \u7684\u7b49\u503c\u6761\u4ef6\uff0c\u90a3\u4e48\u5c31\u8981\u7528 f \u505a\u5206\u533a\u952e\u3002\u8fd9\u6837\uff0c\u5728 proxy \u8fd9\u4e00\u5c42\u89e3\u6790\u5b8c SQL \u8bed\u53e5\u4ee5\u540e\uff0c\u5c31\u80fd\u786e\u5b9a\u5c06\u8fd9\u6761\u8bed\u53e5\u8def\u7531\u5230\u54ea\u4e2a\u5206\u8868\u505a\u67e5\u8be2\u3002</p> <p>\u6bd4\u5982\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p> <pre><code>select v from ht where f=N;\n</code></pre> <p>\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5206\u8868\u89c4\u5219\uff08\u6bd4\u5982\uff0cN%1024) \u6765\u786e\u8ba4\u9700\u8981\u7684\u6570\u636e\u88ab\u653e\u5728\u4e86\u54ea\u4e2a\u5206\u8868\u4e0a\u3002\u8fd9\u79cd\u8bed\u53e5\u53ea\u9700\u8981\u8bbf\u95ee\u4e00\u4e2a\u5206\u8868\uff0c\u662f\u5206\u5e93\u5206\u8868\u65b9\u6848\u6700\u6b22\u8fce\u7684\u8bed\u53e5\u5f62\u5f0f\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u8fd9\u4e2a\u8868\u4e0a\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u7d22\u5f15 k\uff0c\u5e76\u4e14\u67e5\u8be2\u8bed\u53e5\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>select v from ht where k &gt;= M order by t_modified desc limit 100;\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u7531\u4e8e\u67e5\u8be2\u6761\u4ef6\u91cc\u9762\u6ca1\u6709\u7528\u5230\u5206\u533a\u5b57\u6bb5 f\uff0c\u53ea\u80fd\u5230\u6240\u6709\u7684\u5206\u533a\u4e2d\u53bb\u67e5\u627e\u6ee1\u8db3\u6761\u4ef6\u7684\u6240\u6709\u884c\uff0c\u7136\u540e\u7edf\u4e00\u505a order by \u7684\u64cd\u4f5c\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6709\u4e24\u79cd\u6bd4\u8f83\u5e38\u7528\u7684\u601d\u8def\u3002</p> <p>**\u7b2c\u4e00\u79cd\u601d\u8def\u662f\uff0c**\u5728 proxy \u5c42\u7684\u8fdb\u7a0b\u4ee3\u7801\u4e2d\u5b9e\u73b0\u6392\u5e8f\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u7684\u4f18\u52bf\u662f\u5904\u7406\u901f\u5ea6\u5feb\uff0c\u62ff\u5230\u5206\u5e93\u7684\u6570\u636e\u4ee5\u540e\uff0c\u76f4\u63a5\u5728\u5185\u5b58\u4e2d\u53c2\u4e0e\u8ba1\u7b97\u3002\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u65b9\u6848\u7684\u7f3a\u70b9\u4e5f\u6bd4\u8f83\u660e\u663e\uff1a</p> <ol> <li>\u9700\u8981\u7684\u5f00\u53d1\u5de5\u4f5c\u91cf\u6bd4\u8f83\u5927\u3002\u6211\u4eec\u4e3e\u4f8b\u7684\u8fd9\u6761\u8bed\u53e5\u8fd8\u7b97\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u5982\u679c\u6d89\u53ca\u5230\u590d\u6742\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982 group by\uff0c\u751a\u81f3 join \u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u5bf9\u4e2d\u95f4\u5c42\u7684\u5f00\u53d1\u80fd\u529b\u8981\u6c42\u6bd4\u8f83\u9ad8\uff1b</li> <li>\u5bf9 proxy \u7aef\u7684\u538b\u529b\u6bd4\u8f83\u5927\uff0c\u5c24\u5176\u662f\u5f88\u5bb9\u6613\u51fa\u73b0\u5185\u5b58\u4e0d\u591f\u7528\u548c CPU \u74f6\u9888\u7684\u95ee\u9898\u3002</li> </ol> <p>**\u53e6\u4e00\u79cd\u601d\u8def\u5c31\u662f\uff0c**\u628a\u5404\u4e2a\u5206\u5e93\u62ff\u5230\u7684\u6570\u636e\uff0c\u6c47\u603b\u5230\u4e00\u4e2a MySQL \u5b9e\u4f8b\u7684\u4e00\u4e2a\u8868\u4e2d\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u6c47\u603b\u5b9e\u4f8b\u4e0a\u505a\u903b\u8f91\u64cd\u4f5c\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\uff0c\u6267\u884c\u6d41\u7a0b\u53ef\u4ee5\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <ul> <li>\u5728\u6c47\u603b\u5e93\u4e0a\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u8868 <code>temp_ht</code>\uff0c\u8868\u91cc\u5305\u542b\u4e09\u4e2a\u5b57\u6bb5 v\u3001k\u3001<code>t_modified</code>\uff1b</li> <li> <p>\u5728\u5404\u4e2a\u5206\u5e93\u4e0a\u6267\u884c</p> <p><code>select v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100;</code></p> </li> <li> <p>\u628a\u5206\u5e93\u6267\u884c\u7684\u7ed3\u679c\u63d2\u5165\u5230 temp_ht \u8868\u4e2d\uff1b</p> </li> <li> <p>\u6267\u884c</p> <p><code>select v from temp_ht order by t_modified desc limit 100;</code> </p> </li> </ul> <p>\u5f97\u5230\u7ed3\u679c\u3002</p> <p>**\u5728\u5b9e\u8df5\u4e2d\uff0c\u6211\u4eec\u5f80\u5f80\u4f1a\u53d1\u73b0\u6bcf\u4e2a\u5206\u5e93\u7684\u8ba1\u7b97\u91cf\u90fd\u4e0d\u9971\u548c\uff0c\u6240\u4ee5\u4f1a\u76f4\u63a5\u628a\u4e34\u65f6\u8868 <code>temp_ht</code> \u653e\u5230 32 \u4e2a\u5206\u5e93\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e0a\u3002**\u8fd9\u65f6\u7684\u67e5\u8be2\u903b\u8f91\u4e0e\u56fe 3 \u7c7b\u4f3c\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u518d\u601d\u8003\u4e00\u4e0b\u5177\u4f53\u7684\u6d41\u7a0b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_18","title":"\u4e34\u65f6\u8868\u548c\u4e3b\u5907\u590d\u5236","text":"<p>\u65e2\u7136\u5199 binlog\uff0c\u5c31\u610f\u5473\u7740\u5907\u5e93\u9700\u8981\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e00\u4e0b\uff0c\u5728\u4e3b\u5e93\u4e0a\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p> <pre><code>create table t_normal(id int primary key, c int)engine=innodb;/*Q1*/\ncreate temporary table temp_t like t_normal;/*Q2*/\ninsert into temp_t values(1,1);/*Q3*/\ninsert into t_normal select * from temp_t;/*Q4*/\n</code></pre> <p>\u5982\u679c\u5173\u4e8e\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u90fd\u4e0d\u8bb0\u5f55\uff0c\u90a3\u4e48\u5728\u5907\u5e93\u5c31\u53ea\u6709 <code>create table t_normal</code> \u8868\u548c <code>insert into t_normal select * from temp_t</code> \u8fd9\u4e24\u4e2a\u8bed\u53e5\u7684 binlog \u65e5\u5fd7\uff0c\u5907\u5e93\u5728\u6267\u884c\u5230 <code>insert into t_normal</code> \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u62a5\u9519 <code>\u8868 temp_t \u4e0d\u5b58\u5728</code></p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u628a binlog \u8bbe\u7f6e\u4e3a row \u683c\u5f0f\u5c31\u597d\u4e86\u5427\uff1f\u56e0\u4e3a binlog \u662f row \u683c\u5f0f\u65f6\uff0c\u5728\u8bb0\u5f55 <code>insert into t_normal</code> \u7684 binlog \u65f6\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u64cd\u4f5c\u7684\u6570\u636e\uff0c\u5373\uff1a<code>write_row</code> event \u91cc\u9762\u8bb0\u5f55\u7684\u903b\u8f91\u662f\u201c\u63d2\u5165\u4e00\u884c\u6570\u636e\uff081,1)\u201d\u3002</p> <p>\u786e\u5b9e\u662f\u8fd9\u6837\u3002\u5982\u679c\u5f53\u524d\u7684 <code>binlog_format=row</code>\uff0c\u90a3\u4e48\u8ddf\u4e34\u65f6\u8868\u6709\u5173\u7684\u8bed\u53e5\uff0c\u5c31\u4e0d\u4f1a\u8bb0\u5f55\u5230 binlog \u91cc\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ea\u5728 b<code>inlog_format=statment/mixed</code> \u7684\u65f6\u5019\uff0cbinlog \u4e2d\u624d\u4f1a\u8bb0\u5f55\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u3002</p> <p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u521b\u5efa\u4e34\u65f6\u8868\u7684\u8bed\u53e5\u4f1a\u4f20\u5230\u5907\u5e93\u6267\u884c\uff0c\u56e0\u6b64\u5907\u5e93\u7684\u540c\u6b65\u7ebf\u7a0b\u5c31\u4f1a\u521b\u5efa\u8fd9\u4e2a\u4e34\u65f6\u8868\u3002\u4e3b\u5e93\u5728\u7ebf\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u5220\u9664\u4e34\u65f6\u8868\uff0c\u4f46\u662f\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u662f\u6301\u7eed\u5728\u8fd0\u884c\u7684\u3002\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5728\u4e3b\u5e93\u4e0a\u518d\u5199\u4e00\u4e2a DROP TEMPORARY TABLE \u4f20\u7ed9\u5907\u5e93\u6267\u884c\u3002</p> <p>**\u4e4b\u524d\u6709\u4eba\u95ee\u8fc7\u6211\u4e00\u4e2a\u6709\u8da3\u7684\u95ee\u9898\uff1a**MySQL \u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4e0d\u8bba\u662f create table \u8fd8\u662f alter table \u8bed\u53e5\uff0c\u90fd\u662f\u539f\u6837\u8bb0\u5f55\uff0c\u751a\u81f3\u4e8e\u8fde\u7a7a\u683c\u90fd\u4e0d\u53d8\u3002\u4f46\u662f\u5982\u679c\u6267\u884c <code>drop table t_normal</code>\uff0c\u7cfb\u7edf\u8bb0\u5f55 binlog \u5c31\u4f1a\u5199\u6210\uff1a</p> <pre><code>DROP TABLE `t_normal` /* generated by server */\n</code></pre> <p>\u4e5f\u5c31\u662f\u6539\u6210\u4e86\u6807\u51c6\u7684\u683c\u5f0f\u3002\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u505a\u5462 \uff1f</p> <p>\u73b0\u5728\u4f60\u77e5\u9053\u539f\u56e0\u4e86\uff0c\u90a3\u5c31\u662f\uff1adrop table \u547d\u4ee4\u662f\u53ef\u4ee5\u4e00\u6b21\u5220\u9664\u591a\u4e2a\u8868\u7684\u3002\u6bd4\u5982\uff0c\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u8bbe\u7f6e <code>binlog_format=row</code>\uff0c\u5982\u679c\u4e3b\u5e93\u4e0a\u6267\u884c  <code>drop table t_normal, temp_t</code>\u8fd9\u4e2a\u547d\u4ee4\uff0c\u90a3\u4e48 binlog \u4e2d\u5c31\u53ea\u80fd\u8bb0\u5f55\uff1a</p> <pre><code>DROP TABLE `t_normal` /* generated by server */\n</code></pre> <p>\u56e0\u4e3a\u5907\u5e93\u4e0a\u5e76\u6ca1\u6709\u8868 temp_t\uff0c\u5c06\u8fd9\u4e2a\u547d\u4ee4\u91cd\u5199\u540e\u518d\u4f20\u5230\u5907\u5e93\u6267\u884c\uff0c\u624d\u4e0d\u4f1a\u5bfc\u81f4\u5907\u5e93\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\u3002</p> <p>\u6240\u4ee5\uff0cdrop table \u547d\u4ee4\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u5bf9\u8bed\u53e5\u505a\u6539\u5199\u3002 <code>/* generated by server */</code>\u660e\u4e86\u8fd9\u662f\u4e00\u4e2a\u88ab\u670d\u52a1\u7aef\u6539\u5199\u8fc7\u7684\u547d\u4ee4\u3002</p> <p>\u8bf4\u5230\u4e3b\u5907\u590d\u5236\uff0c\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a\u4e3b\u5e93\u4e0a\u4e0d\u540c\u7684\u7ebf\u7a0b\u521b\u5efa\u540c\u540d\u7684\u4e34\u65f6\u8868\u662f\u6ca1\u5173\u7cfb\u7684\uff0c\u4f46\u662f\u4f20\u5230\u5907\u5e93\u6267\u884c\u662f\u600e\u4e48\u5904\u7406\u7684\u5462\uff1f</p> <p>\u4e3b\u5e93 M \u4e0a\u7684\u4e24\u4e2a session \u521b\u5efa\u4e86\u540c\u540d\u7684\u4e34\u65f6\u8868 t1\uff0c\u8fd9\u4e24\u4e2a <code>create temporary table t1</code> \u8bed\u53e5\u90fd\u4f1a\u88ab\u4f20\u5230\u5907\u5e93 S \u4e0a\u3002</p> <p>\u4f46\u662f\uff0c\u5907\u5e93\u7684\u5e94\u7528\u65e5\u5fd7\u7ebf\u7a0b\u662f\u5171\u7528\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u8981\u5728\u5e94\u7528\u7ebf\u7a0b\u91cc\u9762\u5148\u540e\u6267\u884c\u8fd9\u4e2a create \u8bed\u53e5\u4e24\u6b21\u3002\uff08\u5373\u4f7f\u5f00\u4e86\u591a\u7ebf\u7a0b\u590d\u5236\uff0c\u4e5f\u53ef\u80fd\u88ab\u5206\u914d\u5230\u4ece\u5e93\u7684\u540c\u4e00\u4e2a worker \u4e2d\u6267\u884c\uff09\u3002\u90a3\u4e48\uff0c\u8fd9\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u540c\u6b65\u7ebf\u7a0b\u62a5\u9519 \uff1f</p> <p>\u663e\u7136\u662f\u4e0d\u4f1a\u7684\uff0c\u5426\u5219\u4e34\u65f6\u8868\u5c31\u662f\u4e00\u4e2a bug \u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5907\u5e93\u7ebf\u7a0b\u5728\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u628a\u8fd9\u4e24\u4e2a t1 \u8868\u5f53\u505a\u4e24\u4e2a\u4e0d\u540c\u7684\u4e34\u65f6\u8868\u6765\u5904\u7406\u3002\u8fd9\uff0c\u53c8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f</p> <p>MySQL \u5728\u8bb0\u5f55 binlog \u7684\u65f6\u5019\uff0c\u4f1a\u628a\u4e3b\u5e93\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u7684\u7ebf\u7a0b id \u5199\u5230 binlog \u4e2d\u3002\u8fd9\u6837\uff0c\u5728\u5907\u5e93\u7684\u5e94\u7528\u7ebf\u7a0b\u5c31\u80fd\u591f\u77e5\u9053\u6267\u884c\u6bcf\u4e2a\u8bed\u53e5\u7684\u4e3b\u5e93\u7ebf\u7a0b id\uff0c\u5e76\u5229\u7528\u8fd9\u4e2a\u7ebf\u7a0b id \u6765\u6784\u9020\u4e34\u65f6\u8868\u7684 table_def_key\uff1a</p> <ol> <li>session A \u7684\u4e34\u65f6\u8868 t1\uff0c\u5728\u5907\u5e93\u7684 <code>table_def_key</code> \u5c31\u662f\uff1a\u5e93\u540d +t1+\u201cM \u7684 serverid\u201d+\u201csession A \u7684 thread_id\u201d;</li> <li>session B \u7684\u4e34\u65f6\u8868 t1\uff0c\u5728\u5907\u5e93\u7684 <code>table_def_key</code> \u5c31\u662f \uff1a\u5e93\u540d +t1+\u201cM \u7684 serverid\u201d+\u201csession B \u7684 thread_id\u201d\u3002</li> </ol> <p>\u7531\u4e8e <code>table_def_key</code> \u4e0d\u540c\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a\u8868\u5728\u5907\u5e93\u7684\u5e94\u7528\u7ebf\u7a0b\u91cc\u9762\u662f\u4e0d\u4f1a\u51b2\u7a81\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_19","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e34\u65f6\u8868\u7684\u7528\u6cd5\u548c\u7279\u6027\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u4e34\u65f6\u8868\u4e00\u822c\u7528\u4e8e\u5904\u7406\u6bd4\u8f83\u590d\u6742\u7684\u8ba1\u7b97\u903b\u8f91\u3002\u7531\u4e8e\u4e34\u65f6\u8868\u662f\u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u53ef\u89c1\u7684\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u8003\u8651\u591a\u4e2a\u7ebf\u7a0b\u6267\u884c\u540c\u4e00\u4e2a\u5904\u7406\u903b\u8f91\u65f6\uff0c\u4e34\u65f6\u8868\u7684\u91cd\u540d\u95ee\u9898\u3002\u5728\u7ebf\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u8868\u4e5f\u80fd\u81ea\u52a8\u5220\u9664\uff0c\u7701\u53bb\u4e86\u6536\u5c3e\u548c\u5f02\u5e38\u5904\u7406\u7684\u5de5\u4f5c\u3002</p> <p>\u5728 <code>binlog_format='row'</code>\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u8868\u7684\u64cd\u4f5c\u4e0d\u8bb0\u5f55\u5230 binlog \u4e2d\uff0c\u4e5f\u7701\u53bb\u4e86\u4e0d\u5c11\u9ebb\u70e6\uff0c\u8fd9\u4e5f\u53ef\u4ee5\u6210\u4e3a\u4f60\u9009\u62e9 <code>binlog_format</code> \u65f6\u7684\u4e00\u4e2a\u8003\u8651\u56e0\u7d20\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u8fd9\u79cd\u4e34\u65f6\u8868\uff0c\u662f\u7528\u6237\u81ea\u5df1\u521b\u5efa\u7684 \uff0c\u4e5f\u53ef\u4ee5\u79f0\u4e3a\u7528\u6237\u4e34\u65f6\u8868\u3002\u4e0e\u5b83\u76f8\u5bf9\u5e94\u7684\uff0c\u5c31\u662f\u5185\u90e8\u4e34\u65f6\u8868\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#37","title":"37 \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\uff1f","text":"<p>\u4f60\u53ef\u80fd\u4f1a\u6709\u8fd9\u6837\u7684\u7591\u95ee\uff0cMySQL \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\u5462\uff1f</p> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u5c31\u5148\u7ed9\u4f60\u4e3e\u4e24\u4e2a\u9700\u8981\u7528\u5230\u5185\u90e8\u4e34\u65f6\u8868\u7684\u4f8b\u5b50\uff0c\u6765\u770b\u770b\u5185\u90e8\u4e34\u65f6\u8868\u662f\u600e\u4e48\u5de5\u4f5c\u7684\u3002\u7136\u540e\uff0c\u6211\u4eec\u518d\u6765\u5206\u6790\uff0c\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#union","title":"union \u6267\u884c\u6d41\u7a0b","text":"<p>\u4e3a\u4e86\u4fbf\u4e8e\u91cf\u5316\u5206\u6790\uff0c\u6211\u7528\u4e0b\u9762\u7684\u8868 t1 \u6765\u4e3e\u4f8b\u3002</p> <pre><code>create table t1(id int primary key, a int, b int, index(a));\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int; \n  set i=1;\n  while(i&lt;=1000)do\n    insert into t1 values(i, i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\ncall idata();\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u6267\u884c\u4e0b\u9762\u8fd9\u6761\u8bed\u53e5\uff1a</p> <pre><code>(select 1000 as f) union (select id from t1 order by id desc limit 2);\n</code></pre> <p>\u8fd9\u6761\u8bed\u53e5\u7528\u5230\u4e86 union\uff0c\u5b83\u7684\u8bed\u4e49\u662f\uff0c\u53d6\u8fd9\u4e24\u4e2a\u5b50\u67e5\u8be2\u7ed3\u679c\u7684\u5e76\u96c6\u3002\u5e76\u96c6\u7684\u610f\u601d\u5c31\u662f\u8fd9\u4e24\u4e2a\u96c6\u5408\u52a0\u8d77\u6765\uff0c\u91cd\u590d\u7684\u884c\u53ea\u4fdd\u7559\u4e00\u884c\u3002</p> <p>\u4e0b\u56fe\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain (select 1000 as f) union (select id from t1 order by id desc limit 2);\n+----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n| id | select_type  | table      | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                            |\n+----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n|  1 | PRIMARY      | NULL       | NULL       | NULL  | NULL          | NULL    | NULL    | NULL | NULL |     NULL | No tables used                   |\n|  2 | UNION        | t1         | NULL       | index | NULL          | PRIMARY | 4       | NULL |    2 |   100.00 | Backward index scan; Using index |\n| NULL | UNION RESULT | &lt;union1,2&gt; | NULL       | ALL   | NULL          | NULL    | NULL    | NULL | NULL |     NULL | Using temporary                  |\n+----+--------------+------------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a</p> <ul> <li>\u7b2c\u4e8c\u884c\u7684 key=PRIMARY\uff0c\u8bf4\u660e\u7b2c\u4e8c\u4e2a\u5b50\u53e5\u7528\u5230\u4e86\u7d22\u5f15 id\u3002</li> <li>\u7b2c\u4e09\u884c\u7684 Extra \u5b57\u6bb5\uff0c\u8868\u793a\u5728\u5bf9\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u96c6\u505a union \u7684\u65f6\u5019\uff0c\u4f7f\u7528\u4e86\u4e34\u65f6\u8868 (Using temporary)\u3002</li> </ul> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u521b\u5efa\u4e00\u4e2a\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u8fd9\u4e2a\u4e34\u65f6\u8868\u53ea\u6709\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5 f\uff0c\u5e76\u4e14 f \u662f\u4e3b\u952e\u5b57\u6bb5\u3002</li> <li>\u6267\u884c\u7b2c\u4e00\u4e2a\u5b50\u67e5\u8be2\uff0c\u5f97\u5230 1000 \u8fd9\u4e2a\u503c\uff0c\u5e76\u5b58\u5165\u4e34\u65f6\u8868\u4e2d\u3002</li> <li>\u6267\u884c\u7b2c\u4e8c\u4e2a\u5b50\u67e5\u8be2\uff1a </li> <li>\u62ff\u5230\u7b2c\u4e00\u884c id=1000\uff0c\u8bd5\u56fe\u63d2\u5165\u4e34\u65f6\u8868\u4e2d\u3002\u4f46\u7531\u4e8e 1000 \u8fd9\u4e2a\u503c\u5df2\u7ecf\u5b58\u5728\u4e8e\u4e34\u65f6\u8868\u4e86\uff0c\u8fdd\u53cd\u4e86\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u6240\u4ee5\u63d2\u5165\u5931\u8d25\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c\uff1b</li> <li>\u53d6\u5230\u7b2c\u4e8c\u884c id=999\uff0c\u63d2\u5165\u4e34\u65f6\u8868\u6210\u529f\u3002</li> <li>\u4ece\u4e34\u65f6\u8868\u4e2d\u6309\u884c\u53d6\u51fa\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\uff0c\u5e76\u5220\u9664\u4e34\u65f6\u8868\uff0c\u7ed3\u679c\u4e2d\u5305\u542b\u4e24\u884c\u6570\u636e\u5206\u522b\u662f 1000 \u548c 999\u3002</li> </ol> <p>\u8fd9\u91cc\u7684\u5185\u5b58\u4e34\u65f6\u8868\u8d77\u5230\u4e86\u6682\u5b58\u6570\u636e\u7684\u4f5c\u7528\uff0c\u800c\u4e14\u8ba1\u7b97\u8fc7\u7a0b\u8fd8\u7528\u4e0a\u4e86\u4e34\u65f6\u8868\u4e3b\u952e id \u7684\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u5b9e\u73b0\u4e86 union \u7684\u8bed\u4e49\u3002</p> <p>\u987a\u4fbf\u63d0\u4e00\u4e0b\uff0c\u5982\u679c\u628a\u4e0a\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e2d\u7684 union \u6539\u6210 union all \u7684\u8bdd\uff0c\u5c31\u6ca1\u6709\u4e86\u201c\u53bb\u91cd\u201d\u7684\u8bed\u4e49\u3002\u8fd9\u6837\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u4f9d\u6b21\u6267\u884c\u5b50\u67e5\u8be2\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u76f4\u63a5\u4f5c\u4e3a\u7ed3\u679c\u96c6\u7684\u4e00\u90e8\u5206\uff0c\u53d1\u7ed9\u5ba2\u6237\u7aef\u3002\u56e0\u6b64\u4e5f\u5c31\u4e0d\u9700\u8981\u4e34\u65f6\u8868\u4e86\u3002</p> <pre><code>mysql&gt; explain (select 1000 as f) union all (select id from t1 order by id desc limit 2);\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                            |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n|  1 | PRIMARY     | NULL  | NULL       | NULL  | NULL          | NULL    | NULL    | NULL | NULL |     NULL | No tables used                   |\n|  2 | UNION       | t1    | NULL       | index | NULL          | PRIMARY | 4       | NULL |    2 |   100.00 | Backward index scan; Using index |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7b2c\u4e8c\u884c\u7684 Extra \u5b57\u6bb5\u663e\u793a\u7684\u662f Using index\uff0c\u8868\u793a\u53ea\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u6ca1\u6709\u7528\u4e34\u65f6\u8868\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#group-by","title":"group by \u6267\u884c\u6d41\u7a0b","text":"<p>\u53e6\u5916\u4e00\u4e2a\u5e38\u89c1\u7684\u4f7f\u7528\u4e34\u65f6\u8868\u7684\u4f8b\u5b50\u662f group by\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>select id%10 as m, count(*) as c from t1 group by m;\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u903b\u8f91\u662f\u628a\u8868 t1 \u91cc\u7684\u6570\u636e\uff0c\u6309\u7167 id%10 \u8fdb\u884c\u5206\u7ec4\u7edf\u8ba1\uff0c\u5e76\u6309\u7167 m \u7684\u7ed3\u679c\u6392\u5e8f\u540e\u8f93\u51fa\u3002\u5b83\u7684 explain \u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>mysql&gt; explain select id%10 as m, count(*) as c from t1 group by m;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                        |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+\n|  1 | SIMPLE      | t1    | NULL       | index | PRIMARY,a     | a    | 5       | NULL | 1000 |   100.00 | Using index; Using temporary |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+------------------------------+\n</code></pre> <p>\u5728 Extra \u5b57\u6bb5\u91cc\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u4fe1\u606f\uff1a</p> <ul> <li>Using index\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u4f7f\u7528\u4e86\u8986\u76d6\u7d22\u5f15\uff0c\u9009\u62e9\u4e86\u7d22\u5f15 a\uff0c\u4e0d\u9700\u8981\u56de\u8868\uff1b</li> <li>Using temporary\uff0c\u8868\u793a\u4f7f\u7528\u4e86\u4e34\u65f6\u8868\uff1b</li> <li>Using filesort\uff0c\u8868\u793a\u9700\u8981\u6392\u5e8f\u3002</li> </ul> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u521b\u5efa\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5 m \u548c c\uff0c\u4e3b\u952e\u662f m\uff1b</li> <li>\u626b\u63cf\u8868 t1 \u7684\u7d22\u5f15 a\uff0c\u4f9d\u6b21\u53d6\u51fa\u53f6\u5b50\u8282\u70b9\u4e0a\u7684 id \u503c\uff0c\u8ba1\u7b97 id%10 \u7684\u7ed3\u679c\uff0c\u8bb0\u4e3a x\uff1b </li> <li>\u5982\u679c\u4e34\u65f6\u8868\u4e2d\u6ca1\u6709\u4e3b\u952e\u4e3a x \u7684\u884c\uff0c\u5c31\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55 (x,1);</li> <li>\u5982\u679c\u8868\u4e2d\u6709\u4e3b\u952e\u4e3a x \u7684\u884c\uff0c\u5c31\u5c06 x \u8fd9\u4e00\u884c\u7684 c \u503c\u52a0 1\uff1b</li> <li>\u904d\u5386\u5b8c\u6210\u540e\uff0c\u518d\u6839\u636e\u5b57\u6bb5 m \u505a\u6392\u5e8f\uff0c\u5f97\u5230\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e0b\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c\uff1a</p> <pre><code>mysql&gt;  select id%10 as m, count(*) as c from t1 group by m;\n+------+-----+\n| m    | c   |\n+------+-----+\n|    1 | 100 |\n|    2 | 100 |\n|    3 | 100 |\n|    4 | 100 |\n|    5 | 100 |\n|    6 | 100 |\n|    7 | 100 |\n|    8 | 100 |\n|    9 | 100 |\n|    0 | 100 |\n+------+-----+\n</code></pre> <p>\u5982\u679c\u4f60\u7684\u9700\u6c42\u5e76\u4e0d\u9700\u8981\u5bf9\u7ed3\u679c\u8fdb\u884c\u6392\u5e8f\uff0c\u90a3\u4f60\u53ef\u4ee5\u5728 SQL \u8bed\u53e5\u672b\u5c3e\u589e\u52a0 order by null\uff0c\u4e5f\u5c31\u662f\u6539\u6210\uff1a</p> <pre><code>select id%10 as m, count(*) as c from t1 group by m order by null;\n</code></pre> <p>\u8fd9\u6837\u5c31\u8df3\u8fc7\u4e86\u6700\u540e\u6392\u5e8f\u7684\u9636\u6bb5\uff0c\u76f4\u63a5\u4ece\u4e34\u65f6\u8868\u4e2d\u53d6\u6570\u636e\u8fd4\u56de\u3002</p> <p>\u7531\u4e8e\u8868 t1 \u4e2d\u7684 id \u503c\u662f\u4ece 1 \u5f00\u59cb\u7684\uff0c\u56e0\u6b64\u8fd4\u56de\u7684\u7ed3\u679c\u96c6\u4e2d\u7b2c\u4e00\u884c\u662f id=1\uff1b\u626b\u63cf\u5230 id=10 \u7684\u65f6\u5019\u624d\u63d2\u5165 m=0 \u8fd9\u4e00\u884c\uff0c\u56e0\u6b64\u7ed3\u679c\u96c6\u91cc\u6700\u540e\u4e00\u884c\u624d\u662f m=0\u3002</p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u7531\u4e8e\u4e34\u65f6\u8868\u53ea\u6709 10 \u884c\uff0c\u5185\u5b58\u53ef\u4ee5\u653e\u5f97\u4e0b\uff0c\u56e0\u6b64\u5168\u7a0b\u53ea\u4f7f\u7528\u4e86\u5185\u5b58\u4e34\u65f6\u8868\u3002\u4f46\u662f\uff0c\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\u662f\u6709\u9650\u5236\u7684\uff0c\u53c2\u6570 <code>tmp_table_size</code> \u5c31\u662f\u63a7\u5236\u8fd9\u4e2a\u5185\u5b58\u5927\u5c0f\u7684\uff0c\u9ed8\u8ba4\u662f 16M\u3002</p> <p>\u5982\u679c\u6211\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\uff1a</p> <pre><code>set tmp_table_size=1024;\nselect id%100 as m, count(*) as c from t1 group by m order by null limit 10;\n</code></pre> <p>\u628a\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\u9650\u5236\u4e3a\u6700\u5927 1024 \u5b57\u8282\uff0c\u5e76\u628a\u8bed\u53e5\u6539\u6210 id % 100\uff0c\u8fd9\u6837\u8fd4\u56de\u7ed3\u679c\u91cc\u6709 100 \u884c\u6570\u636e\u3002\u4f46\u662f\uff0c\u8fd9\u65f6\u7684\u5185\u5b58\u4e34\u65f6\u8868\u5927\u5c0f\u4e0d\u591f\u5b58\u4e0b\u8fd9 100 \u884c\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u53d1\u73b0\u5185\u5b58\u4e34\u65f6\u8868\u5927\u5c0f\u5230\u8fbe\u4e86\u4e0a\u9650\uff081024 \u5b57\u8282\uff09\u3002</p> <p>\u5982\u679c\u8fd9\u4e2a\u8868 t1 \u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u5f88\u53ef\u80fd\u8fd9\u4e2a\u67e5\u8be2\u9700\u8981\u7684\u78c1\u76d8\u4e34\u65f6\u8868\u5c31\u4f1a\u5360\u7528\u5927\u91cf\u7684\u78c1\u76d8\u7a7a\u95f4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#group-by-","title":"group by \u4f18\u5316\u65b9\u6cd5 -- \u7d22\u5f15","text":"<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u8bba\u662f\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u8fd8\u662f\u78c1\u76d8\u4e34\u65f6\u8868\uff0cgroup by \u903b\u8f91\u90fd\u9700\u8981\u6784\u9020\u4e00\u4e2a\u5e26\u552f\u4e00\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u4ee3\u4ef7\u90fd\u662f\u6bd4\u8f83\u9ad8\u7684\u3002\u5982\u679c\u8868\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u4e0a\u9762\u8fd9\u4e2a group by \u8bed\u53e5\u6267\u884c\u8d77\u6765\u5c31\u4f1a\u5f88\u6162\uff0c\u6211\u4eec\u6709\u4ec0\u4e48\u4f18\u5316\u7684\u65b9\u6cd5\u5462\uff1f</p> <p>\u8981\u89e3\u51b3 group by \u8bed\u53e5\u7684\u4f18\u5316\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u5148\u60f3\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff1a\u6267\u884c group by \u8bed\u53e5\u4e3a\u4ec0\u4e48\u9700\u8981\u4e34\u65f6\u8868\uff1f</p> <p>group by \u7684\u8bed\u4e49\u903b\u8f91\uff0c\u662f\u7edf\u8ba1\u4e0d\u540c\u7684\u503c\u51fa\u73b0\u7684\u4e2a\u6570\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6bcf\u4e00\u884c\u7684 id%100 \u7684\u7ed3\u679c\u662f\u65e0\u5e8f\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u4e34\u65f6\u8868\uff0c\u6765\u8bb0\u5f55\u5e76\u7edf\u8ba1\u7ed3\u679c\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u626b\u63cf\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u4fdd\u8bc1\u51fa\u73b0\u7684\u6570\u636e\u662f\u6709\u5e8f\u7684\uff0c\u662f\u4e0d\u662f\u5c31\u7b80\u5355\u4e86\u5462\uff1f</p> <p>\u5982\u679c\u53ef\u4ee5\u786e\u4fdd\u8f93\u5165\u7684\u6570\u636e\u662f\u6709\u5e8f\u7684\uff0c\u90a3\u4e48\u8ba1\u7b97 group by \u7684\u65f6\u5019\uff0c\u5c31\u53ea\u9700\u8981\u4ece\u5de6\u5230\u53f3\uff0c\u987a\u5e8f\u626b\u63cf\uff0c\u4f9d\u6b21\u7d2f\u52a0\u3002\u4e5f\u5c31\u662f\u4e0b\u9762\u8fd9\u4e2a\u8fc7\u7a0b\uff1a</p> <ul> <li>\u5f53\u78b0\u5230\u7b2c\u4e00\u4e2a 1 \u7684\u65f6\u5019\uff0c\u5df2\u7ecf\u77e5\u9053\u7d2f\u79ef\u4e86 X \u4e2a 0\uff0c\u7ed3\u679c\u96c6\u91cc\u7684\u7b2c\u4e00\u884c\u5c31\u662f (0,X);</li> <li>\u5f53\u78b0\u5230\u7b2c\u4e00\u4e2a 2 \u7684\u65f6\u5019\uff0c\u5df2\u7ecf\u77e5\u9053\u7d2f\u79ef\u4e86 Y \u4e2a 1\uff0c\u7ed3\u679c\u96c6\u91cc\u7684\u7b2c\u4e8c\u884c\u5c31\u662f (1,Y);</li> </ul> <p>\u6309\u7167\u8fd9\u4e2a\u903b\u8f91\u6267\u884c\u7684\u8bdd\uff0c\u626b\u63cf\u5230\u6574\u4e2a\u8f93\u5165\u7684\u6570\u636e\u7ed3\u675f\uff0c\u5c31\u53ef\u4ee5\u62ff\u5230 group by \u7684\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u518d\u989d\u5916\u6392\u5e8f\u3002</p> <p>\u4f60\u4e00\u5b9a\u60f3\u5230\u4e86\uff0cInnoDB \u7684\u7d22\u5f15\uff0c\u5c31\u53ef\u4ee5\u6ee1\u8db3\u8fd9\u4e2a\u8f93\u5165\u6709\u5e8f\u7684\u6761\u4ef6\u3002</p> <p>\u5728 MySQL 5.7 \u7248\u672c\u652f\u6301\u4e86 generated column \u673a\u5236\uff0c\u7528\u6765\u5b9e\u73b0\u5217\u6570\u636e\u7684\u5173\u8054\u66f4\u65b0\u3002\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2a\u5217 z\uff0c\u7136\u540e\u5728 z \u5217\u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff08\u5982\u679c\u662f MySQL 5.6 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u666e\u901a\u5217\u548c\u7d22\u5f15\uff0c\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\u3002</p> <pre><code>alter table t1 add column z int generated always as(id % 100), add index(z);\n</code></pre> <p>\u8fd9\u6837\uff0c\u7d22\u5f15 z \u4e0a\u7684\u6570\u636e\u5c31\u662f\u7c7b\u4f3c\u56fe 10 \u8fd9\u6837\u6709\u5e8f\u7684\u4e86\u3002\u4e0a\u9762\u7684 group by \u8bed\u53e5\u5c31\u53ef\u4ee5\u6539\u6210\uff1a</p> <pre><code>select z, count(*) as c from t1 group by z;\n</code></pre> <p>\u4f18\u5316\u540e\u7684 group by \u8bed\u53e5\u7684 explain \u7ed3\u679c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>mysql&gt; explain select z, count(*) as c from t1 group by z;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | t1    | NULL       | index | z             | z    | 5       | NULL | 1000 |   100.00 | Using index |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+\n</code></pre> <p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u4e0d\u518d\u9700\u8981\u4e34\u65f6\u8868\uff0c\u4e5f\u4e0d\u9700\u8981\u6392\u5e8f\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#group-by-_1","title":"group by \u4f18\u5316\u65b9\u6cd5 -- \u76f4\u63a5\u6392\u5e8f","text":"<p>\u6240\u4ee5\uff0c\u5982\u679c\u53ef\u4ee5\u901a\u8fc7\u52a0\u7d22\u5f15\u6765\u5b8c\u6210 group by \u903b\u8f91\u5c31\u518d\u597d\u4e0d\u8fc7\u4e86\u3002\u4f46\u662f\uff0c\u5982\u679c\u78b0\u4e0a\u4e0d\u9002\u5408\u521b\u5efa\u7d22\u5f15\u7684\u573a\u666f\uff0c\u6211\u4eec\u8fd8\u662f\u8981\u8001\u8001\u5b9e\u5b9e\u505a\u6392\u5e8f\u7684\u3002\u90a3\u4e48\uff0c\u8fd9\u65f6\u5019\u7684 group by \u8981\u600e\u4e48\u4f18\u5316\u5462\uff1f</p> <p>\u5982\u679c\u6211\u4eec\u660e\u660e\u77e5\u9053\uff0c\u4e00\u4e2a group by \u8bed\u53e5\u4e2d\u9700\u8981\u653e\u5230\u4e34\u65f6\u8868\u4e0a\u7684\u6570\u636e\u91cf\u7279\u522b\u5927\uff0c\u5374\u8fd8\u662f\u8981\u6309\u7167\u201c\u5148\u653e\u5230\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u63d2\u5165\u4e00\u90e8\u5206\u6570\u636e\u540e\uff0c\u53d1\u73b0\u5185\u5b58\u4e34\u65f6\u8868\u4e0d\u591f\u7528\u4e86\u518d\u8f6c\u6210\u78c1\u76d8\u4e34\u65f6\u8868\u201d\uff0c\u770b\u4e0a\u53bb\u5c31\u6709\u70b9\u513f\u50bb\u3002</p> <p>\u90a3\u4e48\uff0c\u6211\u4eec\u5c31\u4f1a\u60f3\u4e86\uff0cMySQL \u6709\u6ca1\u6709\u8ba9\u6211\u4eec\u76f4\u63a5\u8d70\u78c1\u76d8\u4e34\u65f6\u8868\u7684\u65b9\u6cd5\u5462\uff1f</p> <p>\u7b54\u6848\u662f\uff0c\u6709\u7684\u3002</p> <p>\u5728 group by \u8bed\u53e5\u4e2d\u52a0\u5165 <code>SQL_BIG_RESULT</code> \u8fd9\u4e2a\u63d0\u793a\uff08hint\uff09\uff0c\u5c31\u53ef\u4ee5\u544a\u8bc9\u4f18\u5316\u5668\uff1a\u8fd9\u4e2a\u8bed\u53e5\u6d89\u53ca\u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u8bf7\u76f4\u63a5\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u3002</p> <p>MySQL \u7684\u4f18\u5316\u5668\u4e00\u770b\uff0c\u78c1\u76d8\u4e34\u65f6\u8868\u662f B+ \u6811\u5b58\u50a8\uff0c\u5b58\u50a8\u6548\u7387\u4e0d\u5982\u6570\u7ec4\u6765\u5f97\u9ad8\u3002\u6240\u4ee5\uff0c\u65e2\u7136\u4f60\u544a\u8bc9\u6211\u6570\u636e\u91cf\u5f88\u5927\uff0c\u90a3\u4ece\u78c1\u76d8\u7a7a\u95f4\u8003\u8651\uff0c\u8fd8\u662f\u76f4\u63a5\u7528\u6570\u7ec4\u6765\u5b58\u5427\u3002</p> <p>\u56e0\u6b64\uff0c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5</p> <pre><code>select SQL_BIG_RESULT id%100 as m, count(*) as c from t1 group by m;\n</code></pre> <p>\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u521d\u59cb\u5316 sort_buffer\uff0c\u786e\u5b9a\u653e\u5165\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5\uff0c\u8bb0\u4e3a m\uff1b</li> <li>\u626b\u63cf\u8868 t1 \u7684\u7d22\u5f15 a\uff0c\u4f9d\u6b21\u53d6\u51fa\u91cc\u9762\u7684 id \u503c, \u5c06 id%100 \u7684\u503c\u5b58\u5165 sort_buffer \u4e2d\uff1b</li> <li>\u626b\u63cf\u5b8c\u6210\u540e\uff0c\u5bf9 sort_buffer \u7684\u5b57\u6bb5 m \u505a\u6392\u5e8f\uff08\u5982\u679c sort_buffer \u5185\u5b58\u4e0d\u591f\u7528\uff0c\u5c31\u4f1a\u5229\u7528\u78c1\u76d8\u4e34\u65f6\u6587\u4ef6\u8f85\u52a9\u6392\u5e8f\uff09\uff1b</li> <li>\u6392\u5e8f\u5b8c\u6210\u540e\uff0c\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a\u6709\u5e8f\u6570\u7ec4\u3002</li> </ol> <p>\u6839\u636e\u6709\u5e8f\u6570\u7ec4\uff0c\u5f97\u5230\u6570\u7ec4\u91cc\u9762\u7684\u4e0d\u540c\u503c\uff0c\u4ee5\u53ca\u6bcf\u4e2a\u503c\u7684\u51fa\u73b0\u6b21\u6570\u3002</p> <p>\u56fe\u4f7f\u7528 SQL_BIG_RESULT \u7684 explain \u7ed3\u679c</p> <pre><code>mysql&gt; explain select SQL_BIG_RESULT id%100 as m, count(*) as c from t1 group by m;\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+\n|  1 | SIMPLE      | t1    | NULL       | index | z             | z    | 5       | NULL | 1000 |   100.00 | Using index; Using filesort |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+\n</code></pre> <p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6ca1\u6709\u518d\u4f7f\u7528\u4e34\u65f6\u8868\uff0c\u800c\u662f\u76f4\u63a5\u7528\u4e86\u6392\u5e8f\u7b97\u6cd5\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684 union\u3001union all \u548c group by \u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u56de\u7b54\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff1aMySQL \u4ec0\u4e48\u65f6\u5019\u4f1a\u4f7f\u7528\u5185\u90e8\u4e34\u65f6\u8868\uff1f</p> <ol> <li>\u5982\u679c\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u53ef\u4ee5\u4e00\u8fb9\u8bfb\u6570\u636e\uff0c\u4e00\u8fb9\u76f4\u63a5\u5f97\u5230\u7ed3\u679c\uff0c\u662f\u4e0d\u9700\u8981\u989d\u5916\u5185\u5b58\u7684\uff0c\u5426\u5219\u5c31\u9700\u8981\u989d\u5916\u7684\u5185\u5b58\uff0c\u6765\u4fdd\u5b58\u4e2d\u95f4\u7ed3\u679c\uff1b</li> <li>join_buffer \u662f\u65e0\u5e8f\u6570\u7ec4\uff0csort_buffer \u662f\u6709\u5e8f\u6570\u7ec4\uff0c\u4e34\u65f6\u8868\u662f\u4e8c\u7ef4\u8868\u7ed3\u6784\uff1b</li> <li>\u5982\u679c\u6267\u884c\u903b\u8f91\u9700\u8981\u7528\u5230\u4e8c\u7ef4\u8868\u7279\u6027\uff0c\u5c31\u4f1a\u4f18\u5148\u8003\u8651\u4f7f\u7528\u4e34\u65f6\u8868\u3002\u6bd4\u5982\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0cunion \u9700\u8981\u7528\u5230\u552f\u4e00\u7d22\u5f15\u7ea6\u675f\uff0c group by \u8fd8\u9700\u8981\u7528\u5230\u53e6\u5916\u4e00\u4e2a\u5b57\u6bb5\u6765\u5b58\u7d2f\u79ef\u8ba1\u6570\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_20","title":"\u5c0f\u7ed3","text":"<p>\u901a\u8fc7\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u91cd\u70b9\u548c\u4f60\u8bb2\u4e86 group by \u7684\u51e0\u79cd\u5b9e\u73b0\u7b97\u6cd5\uff0c\u4ece\u4e2d\u53ef\u4ee5\u603b\u7ed3\u4e00\u4e9b\u4f7f\u7528\u7684\u6307\u5bfc\u539f\u5219\uff1a</p> <ol> <li>\u5982\u679c\u5bf9 group by \u8bed\u53e5\u7684\u7ed3\u679c\u6ca1\u6709\u6392\u5e8f\u8981\u6c42\uff0c\u8981\u5728\u8bed\u53e5\u540e\u9762\u52a0 order by null\uff1b</li> <li>\u5c3d\u91cf\u8ba9 group by \u8fc7\u7a0b\u7528\u4e0a\u8868\u7684\u7d22\u5f15\uff0c\u786e\u8ba4\u65b9\u6cd5\u662f explain \u7ed3\u679c\u91cc\u6ca1\u6709 Using temporary \u548c Using filesort\uff1b</li> <li>\u5982\u679c group by \u9700\u8981\u7edf\u8ba1\u7684\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u5c3d\u91cf\u53ea\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\uff1b\u4e5f\u53ef\u4ee5\u901a\u8fc7\u9002\u5f53\u8c03\u5927 <code>tmp_table_size</code> \u53c2\u6570\uff0c\u6765\u907f\u514d\u7528\u5230\u78c1\u76d8\u4e34\u65f6\u8868\uff1b</li> <li>\u5982\u679c\u6570\u636e\u91cf\u5b9e\u5728\u592a\u5927\uff0c\u4f7f\u7528 <code>SQL_BIG_RESULT</code> \u8fd9\u4e2a\u63d0\u793a\uff0c\u6765\u544a\u8bc9\u4f18\u5316\u5668\u76f4\u63a5\u4f7f\u7528\u6392\u5e8f\u7b97\u6cd5\u5f97\u5230 group by \u7684\u7ed3\u679c\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#38-innodbmemory","title":"38 \u90fd\u8bf4InnoDB\u597d\uff0c\u90a3\u8fd8\u8981\u4e0d\u8981\u4f7f\u7528Memory\u5f15\u64ce\uff1f","text":"<p>\u4e24\u4e2a group by \u8bed\u53e5\u90fd\u7528\u4e86 order by null\uff0c\u4e3a\u4ec0\u4e48\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u5f97\u5230\u7684\u8bed\u53e5\u7ed3\u679c\u91cc\uff0c0 \u8fd9\u4e2a\u503c\u5728\u6700\u540e\u4e00\u884c\uff1b\u800c\u4f7f\u7528\u78c1\u76d8\u4e34\u65f6\u8868\u5f97\u5230\u7684\u7ed3\u679c\u91cc\uff0c0 \u8fd9\u4e2a\u503c\u5728\u7b2c\u4e00\u884c\uff1f</p> <p>\u4eca\u5929\u6211\u4eec\u5c31\u6765\u770b\u770b\uff0c\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u7684\u539f\u56e0\u5427\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_21","title":"\u5185\u5b58\u8868\u7684\u6570\u636e\u7ec4\u7ec7\u7ed3\u6784","text":"<p>\u4e3a\u4e86\u4fbf\u4e8e\u5206\u6790\uff0c\u6211\u6765\u628a\u8fd9\u4e2a\u95ee\u9898\u7b80\u5316\u4e00\u4e0b\uff0c\u5047\u8bbe\u6709\u4ee5\u4e0b\u7684\u4e24\u5f20\u8868 t1 \u548c t2\uff0c\u5176\u4e2d\u8868 t1 \u4f7f\u7528 Memory \u5f15\u64ce\uff0c \u8868 t2 \u4f7f\u7528 InnoDB \u5f15\u64ce\u3002</p> <pre><code>create table t1(id int primary key, c int) engine=Memory;\ncreate table t2(id int primary key, c int) engine=innodb;\ninsert into t1 values(1,1),(2,2),(3,3),(4,4),(5,5),(6,6),(7,7),(8,8),(9,9),(0,0);\ninsert into t2 values(1,1),(2,2),(3,3),(4,4),(5,5),(6,6),(7,7),(8,8),(9,9),(0,0);\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u5206\u522b\u6267\u884c <code>select * from t1</code> \u548c <code>select * from t2\u3002</code></p> <pre><code>mysql&gt; select * from t1;\n+----+------+\n| id | c    |\n+----+------+\n|  1 |    1 |\n|  2 |    2 |\n|  3 |    3 |\n|  4 |    4 |\n|  5 |    5 |\n|  6 |    6 |\n|  7 |    7 |\n|  8 |    8 |\n|  9 |    9 |\n|  0 |    0 |\n+----+------+\n</code></pre> <pre><code>mysql&gt; select * from t2;\n+----+------+\n| id | c    |\n+----+------+\n|  0 |    0 |\n|  1 |    1 |\n|  2 |    2 |\n|  3 |    3 |\n|  4 |    4 |\n|  5 |    5 |\n|  6 |    6 |\n|  7 |    7 |\n|  8 |    8 |\n|  9 |    9 |\n+----+------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5185\u5b58\u8868 t1 \u7684\u8fd4\u56de\u7ed3\u679c\u91cc\u9762 0 \u5728\u6700\u540e\u4e00\u884c\uff0c\u800c InnoDB \u8868 t2 \u7684\u8fd4\u56de\u7ed3\u679c\u91cc 0 \u5728\u7b2c\u4e00\u884c\u3002</p> <p>\u51fa\u73b0\u8fd9\u4e2a\u533a\u522b\u7684\u539f\u56e0\uff0cInnoDB \u548c Memory \u5f15\u64ce\u7684\u6570\u636e\u7ec4\u7ec7\u65b9\u5f0f\u662f\u4e0d\u540c\u7684\uff1a</p> <ul> <li>InnoDB \u5f15\u64ce\u628a\u6570\u636e\u653e\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\uff0c\u5176\u4ed6\u7d22\u5f15\u4e0a\u4fdd\u5b58\u7684\u662f\u4e3b\u952e id\u3002\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a**\u7d22\u5f15\u7ec4\u7ec7\u8868**\uff08Index Organizied Table\uff09\u3002</li> <li>\u800c Memory \u5f15\u64ce\u91c7\u7528\u7684\u662f\u628a\u6570\u636e\u5355\u72ec\u5b58\u653e\uff0c\u7d22\u5f15\u4e0a\u4fdd\u5b58\u6570\u636e\u4f4d\u7f6e\u7684\u6570\u636e\u7ec4\u7ec7\u5f62\u5f0f\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a**\u5806\u7ec4\u7ec7\u8868**\uff08Heap Organizied Table\uff09\u3002</li> </ul> <p>\u4ece\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e24\u4e2a\u5f15\u64ce\u7684\u4e00\u4e9b\u5178\u578b\u4e0d\u540c\uff1a</p> <ol> <li>InnoDB \u8868\u7684\u6570\u636e\u603b\u662f\u6709\u5e8f\u5b58\u653e\u7684\uff0c\u800c\u5185\u5b58\u8868\u7684\u6570\u636e\u5c31\u662f\u6309\u7167\u5199\u5165\u987a\u5e8f\u5b58\u653e\u7684\uff1b</li> <li>\u5f53\u6570\u636e\u6587\u4ef6\u6709\u7a7a\u6d1e\u7684\u65f6\u5019\uff0cInnoDB \u8868\u5728\u63d2\u5165\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u6709\u5e8f\u6027\uff0c\u53ea\u80fd\u5728\u56fa\u5b9a\u7684\u4f4d\u7f6e\u5199\u5165\u65b0\u503c\uff0c\u800c\u5185\u5b58\u8868\u627e\u5230\u7a7a\u4f4d\u5c31\u53ef\u4ee5\u63d2\u5165\u65b0\u503c\uff1b</li> <li>\u6570\u636e\u4f4d\u7f6e\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0cInnoDB \u8868\u53ea\u9700\u8981\u4fee\u6539\u4e3b\u952e\u7d22\u5f15\uff0c\u800c\u5185\u5b58\u8868\u9700\u8981\u4fee\u6539\u6240\u6709\u7d22\u5f15\uff1b</li> <li>InnoDB \u8868\u7528\u4e3b\u952e\u7d22\u5f15\u67e5\u8be2\u65f6\u9700\u8981\u8d70\u4e00\u6b21\u7d22\u5f15\u67e5\u627e\uff0c\u7528\u666e\u901a\u7d22\u5f15\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u9700\u8981\u8d70\u4e24\u6b21\u7d22\u5f15\u67e5\u627e\u3002\u800c\u5185\u5b58\u8868\u6ca1\u6709\u8fd9\u4e2a\u533a\u522b\uff0c\u6240\u6709\u7d22\u5f15\u7684\u201c\u5730\u4f4d\u201d\u90fd\u662f\u76f8\u540c\u7684\u3002</li> <li>InnoDB \u652f\u6301\u53d8\u957f\u6570\u636e\u7c7b\u578b\uff0c\u4e0d\u540c\u8bb0\u5f55\u7684\u957f\u5ea6\u53ef\u80fd\u4e0d\u540c\uff1b\u5185\u5b58\u8868\u4e0d\u652f\u6301 Blob \u548c Text \u5b57\u6bb5\uff0c\u5e76\u4e14\u5373\u4f7f\u5b9a\u4e49\u4e86 varchar(N)\uff0c\u5b9e\u9645\u4e5f\u5f53\u4f5c char(N)\uff0c\u4e5f\u5c31\u662f\u56fa\u5b9a\u957f\u5ea6\u5b57\u7b26\u4e32\u6765\u5b58\u50a8\uff0c\u56e0\u6b64\u5185\u5b58\u8868\u7684\u6bcf\u884c\u6570\u636e\u957f\u5ea6\u76f8\u540c\u3002</li> </ol> <p>\u7531\u4e8e\u5185\u5b58\u8868\u7684\u8fd9\u4e9b\u7279\u6027\uff0c\u6bcf\u4e2a\u6570\u636e\u884c\u88ab\u5220\u9664\u4ee5\u540e\uff0c\u7a7a\u51fa\u7684\u8fd9\u4e2a\u4f4d\u7f6e\u90fd\u53ef\u4ee5\u88ab\u63a5\u4e0b\u6765\u8981\u63d2\u5165\u7684\u6570\u636e\u590d\u7528\u3002\u6bd4\u5982\uff0c\u5982\u679c\u8981\u5728\u8868 t1 \u4e2d\u6267\u884c\uff1a</p> <pre><code>delete from t1 where id=5;\ninsert into t1 values(10,10);\nselect * from t1;\n</code></pre> <p>\u5c31\u4f1a\u770b\u5230\u8fd4\u56de\u7ed3\u679c\u91cc\uff0cid=10 \u8fd9\u4e00\u884c\u51fa\u73b0\u5728 id=4 \u4e4b\u540e\uff0c\u4e5f\u5c31\u662f\u539f\u6765 id=5 \u8fd9\u884c\u6570\u636e\u7684\u4f4d\u7f6e\u3002</p> <p>\u9700\u8981\u6307\u51fa\u7684\u662f\uff0c\u8868 t1 \u7684\u8fd9\u4e2a\u4e3b\u952e\u7d22\u5f15\u662f\u54c8\u5e0c\u7d22\u5f15\uff0c\u56e0\u6b64\u5982\u679c\u6267\u884c\u8303\u56f4\u67e5\u8be2\uff0c\u6bd4\u5982</p> <pre><code>select * from t1 where id&lt;5;\n</code></pre> <p>\u662f\u7528\u4e0d\u4e0a\u4e3b\u952e\u7d22\u5f15\u7684\uff0c\u9700\u8981\u8d70\u5168\u8868\u626b\u63cf\u3002\u90a3\u5982\u679c\u8981\u8ba9\u5185\u5b58\u8868\u652f\u6301\u8303\u56f4\u626b\u63cf\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462 \uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#hash-b-tree","title":"hash \u7d22\u5f15\u548c B-Tree \u7d22\u5f15","text":"<p>\u5b9e\u9645\u4e0a\uff0c\u5185\u5b58\u8868\u4e5f\u662f\u652f B-Tree \u7d22\u5f15\u7684\u3002\u5728 id \u5217\u4e0a\u521b\u5efa\u4e00\u4e2a B-Tree \u7d22\u5f15\uff0cSQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>alter table t1 add index a_btree_index using btree (id);\n</code></pre> <p>\u4f5c\u4e3a\u5bf9\u6bd4\uff0c\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u8fd9\u4e0b\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\u4f7f\u7528 B-Tree \u548c hash \u7d22\u5f15\u67e5\u8be2\u8fd4\u56de\u7ed3\u679c\u5bf9\u6bd4\uff1a</p> <pre><code>mysql&gt; select * from t1 where id &lt; 5;\n+----+------+\n| id | c    |\n+----+------+\n|  0 |    0 |\n|  1 |    1 |\n|  2 |    2 |\n|  3 |    3 |\n|  4 |    4 |\n+----+------+\n</code></pre> <pre><code>mysql&gt; select * from t1 force index(primary) where id &lt; 5;\n+----+------+\n| id | c    |\n+----+------+\n|  1 |    1 |\n|  2 |    2 |\n|  3 |    3 |\n|  4 |    4 |\n|  0 |    0 |\n+----+------+\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6267\u884c <code>select * from t1 where id&lt;5</code> \u7684\u65f6\u5019\uff0c\u4f18\u5316\u5668\u4f1a\u9009\u62e9 B-Tree \u7d22\u5f15\uff0c\u6240\u4ee5\u8fd4\u56de\u7ed3\u679c\u662f 0 \u5230 4\u3002 \u4f7f\u7528 force index \u5f3a\u884c\u4f7f\u7528\u4e3b\u952e id \u8fd9\u4e2a\u7d22\u5f15\uff0cid=0 \u8fd9\u4e00\u884c\u5c31\u5728\u7ed3\u679c\u96c6\u7684\u6700\u672b\u5c3e\u4e86\u3002</p> <p>\u5176\u5b9e\uff0c\u4e00\u822c\u5728\u6211\u4eec\u7684\u5370\u8c61\u4e2d\uff0c\u5185\u5b58\u8868\u7684\u4f18\u52bf\u662f\u901f\u5ea6\u5feb\uff0c\u5176\u4e2d\u7684\u4e00\u4e2a\u539f\u56e0\u5c31\u662f Memory \u5f15\u64ce\u652f\u6301 hash \u7d22\u5f15\u3002\u5f53\u7136\uff0c\u66f4\u91cd\u8981\u7684\u539f\u56e0\u662f\uff0c\u5185\u5b58\u8868\u7684\u6240\u6709\u6570\u636e\u90fd\u4fdd\u5b58\u5728\u5185\u5b58\uff0c\u800c\u5185\u5b58\u7684\u8bfb\u5199\u901f\u5ea6\u603b\u662f\u6bd4\u78c1\u76d8\u5feb\u3002</p> <p>\u4f46\u662f\uff0c\u63a5\u4e0b\u6765\u6211\u8981\u8ddf\u4f60\u8bf4\u660e\uff0c\u4e3a\u4ec0\u4e48\u6211\u4e0d\u5efa\u8bae\u4f60\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u4f7f\u7528\u5185\u5b58\u8868\u3002\u8fd9\u91cc\u7684\u539f\u56e0\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u9501\u7c92\u5ea6\u95ee\u9898\uff1b</li> <li>\u6570\u636e\u6301\u4e45\u5316\u95ee\u9898\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_22","title":"\u5185\u5b58\u8868\u7684\u9501","text":"<p>\u6211\u4eec\u5148\u6765\u8bf4\u8bf4\u5185\u5b58\u8868\u7684\u9501\u7c92\u5ea6\u95ee\u9898\u3002</p> <p>\u5185\u5b58\u8868\u4e0d\u652f\u6301\u884c\u9501\uff0c\u53ea\u652f\u6301\u8868\u9501\u3002\u56e0\u6b64\uff0c\u4e00\u5f20\u8868\u53ea\u8981\u6709\u66f4\u65b0\uff0c\u5c31\u4f1a\u5835\u4f4f\u5176\u4ed6\u6240\u6709\u5728\u8fd9\u4e2a\u8868\u4e0a\u7684\u8bfb\u5199\u64cd\u4f5c\u3002</p> <p>\u8ddf\u884c\u9501\u6bd4\u8d77\u6765\uff0c\u8868\u9501\u5bf9\u5e76\u53d1\u8bbf\u95ee\u7684\u652f\u6301\u4e0d\u591f\u597d\u3002\u6240\u4ee5\uff0c\u5185\u5b58\u8868\u7684\u9501\u7c92\u5ea6\u95ee\u9898\uff0c\u51b3\u5b9a\u4e86\u5b83\u5728\u5904\u7406\u5e76\u53d1\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u6027\u80fd\u4e5f\u4e0d\u4f1a\u592a\u597d\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_23","title":"\u6570\u636e\u6301\u4e45\u6027\u95ee\u9898","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u770b\u6570\u636e\u6301\u4e45\u6027\u7684\u95ee\u9898\u3002</p> <p>\u6570\u636e\u653e\u5728\u5185\u5b58\u4e2d\uff0c\u662f\u5185\u5b58\u8868\u7684\u4f18\u52bf\uff0c\u4f46\u4e5f\u662f\u4e00\u4e2a\u52a3\u52bf\u3002\u56e0\u4e3a\uff0c\u6570\u636e\u5e93\u91cd\u542f\u7684\u65f6\u5019\uff0c\u6240\u6709\u7684\u5185\u5b58\u8868\u90fd\u4f1a\u88ab\u6e05\u7a7a\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u5982\u679c\u6570\u636e\u5e93\u5f02\u5e38\u91cd\u542f\uff0c\u5185\u5b58\u8868\u88ab\u6e05\u7a7a\u4e5f\u5c31\u6e05\u7a7a\u4e86\uff0c\u4e0d\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u554a\u3002\u4f46\u662f\uff0c\u5728\u9ad8\u53ef\u7528\u67b6\u6784\u4e0b\uff0c\u5185\u5b58\u8868\u7684\u8fd9\u4e2a\u7279\u70b9\u7b80\u76f4\u53ef\u4ee5\u5f53\u505a bug \u6765\u770b\u5f85\u4e86\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u8bf4\u5462\uff1f</p> <p>\u6211\u4eec\u5148\u770b\u770b M-S \u67b6\u6784\u4e0b\uff0c\u4f7f\u7528\u5185\u5b58\u8868\u5b58\u5728\u7684\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u65f6\u5e8f\uff1a</p> <ol> <li>\u4e1a\u52a1\u6b63\u5e38\u8bbf\u95ee\u4e3b\u5e93\uff1b</li> <li>\u5907\u5e93\u786c\u4ef6\u5347\u7ea7\uff0c\u5907\u5e93\u91cd\u542f\uff0c\u5185\u5b58\u8868 t1 \u5185\u5bb9\u88ab\u6e05\u7a7a\uff1b</li> <li>\u5907\u5e93\u91cd\u542f\u540e\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u4e00\u6761 update \u8bed\u53e5\uff0c\u4fee\u6539\u8868 t1 \u7684\u6570\u636e\u884c\uff0c\u8fd9\u65f6\u5907\u5e93\u5e94\u7528\u7ebf\u7a0b\u5c31\u4f1a\u62a5\u9519\u201c\u627e\u4e0d\u5230\u8981\u66f4\u65b0\u7684\u884c\u201d\u3002</li> </ol> <p>\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002\u5f53\u7136\uff0c\u5982\u679c\u8fd9\u65f6\u5019\u53d1\u751f\u4e3b\u5907\u5207\u6362\u7684\u8bdd\uff0c\u5ba2\u6237\u7aef\u4f1a\u770b\u5230\uff0c\u8868 t1 \u7684\u6570\u636e\u201c\u4e22\u5931\u201d\u4e86\u3002</p> <p>\u5728\u56fe 8 \u4e2d\u8fd9\u79cd\u6709 proxy \u7684\u67b6\u6784\u91cc\uff0c\u5927\u5bb6\u9ed8\u8ba4\u4e3b\u5907\u5207\u6362\u7684\u903b\u8f91\u662f\u7531\u6570\u636e\u5e93\u7cfb\u7edf\u81ea\u5df1\u7ef4\u62a4\u7684\u3002\u8fd9\u6837\u5bf9\u5ba2\u6237\u7aef\u6765\u8bf4\uff0c\u5c31\u662f\u201c\u7f51\u7edc\u65ad\u5f00\uff0c\u91cd\u8fde\u4e4b\u540e\uff0c\u53d1\u73b0\u5185\u5b58\u8868\u6570\u636e\u4e22\u5931\u4e86\u201d\u3002</p> <p>\u4f60\u53ef\u80fd\u8bf4\u8fd9\u8fd8\u597d\u554a\uff0c\u6bd5\u7adf\u4e3b\u5907\u53d1\u751f\u5207\u6362\uff0c\u8fde\u63a5\u4f1a\u65ad\u5f00\uff0c\u4e1a\u52a1\u7aef\u80fd\u591f\u611f\u77e5\u5230\u5f02\u5e38\u3002</p> <p>\u4f46\u662f\uff0c\u63a5\u4e0b\u6765\u5185\u5b58\u8868\u7684\u8fd9\u4e2a\u7279\u6027\u5c31\u4f1a\u8ba9\u4f7f\u7528\u73b0\u8c61\u663e\u5f97\u66f4\u201c\u8be1\u5f02\u201d\u4e86\u3002\u7531\u4e8e MySQL \u77e5\u9053\u91cd\u542f\u4e4b\u540e\uff0c\u5185\u5b58\u8868\u7684\u6570\u636e\u4f1a\u4e22\u5931\u3002\u6240\u4ee5\uff0c\u62c5\u5fc3\u4e3b\u5e93\u91cd\u542f\u4e4b\u540e\uff0c\u51fa\u73b0\u4e3b\u5907\u4e0d\u4e00\u81f4\uff0cMySQL \u5728\u5b9e\u73b0\u4e0a\u505a\u4e86\u8fd9\u6837\u4e00\u4ef6\u4e8b\u513f\uff1a\u5728\u6570\u636e\u5e93\u91cd\u542f\u4e4b\u540e\uff0c\u5f80 binlog \u91cc\u9762\u5199\u5165\u4e00\u884c DELETE FROM t1\u3002</p> <p>\u5982\u679c\u4f60\u4f7f\u7528\u662f\u53cc M \u7ed3\u6784\u7684\u8bdd\uff1a</p> <p>\u5728\u5907\u5e93\u91cd\u542f\u7684\u65f6\u5019\uff0c\u5907\u5e93 binlog \u91cc\u7684 delete \u8bed\u53e5\u5c31\u4f1a\u4f20\u5230\u4e3b\u5e93\uff0c\u7136\u540e\u628a\u4e3b\u5e93\u5185\u5b58\u8868\u7684\u5185\u5bb9\u5220\u9664\u3002\u8fd9\u6837\u4f60\u5728\u4f7f\u7528\u7684\u65f6\u5019\u5c31\u4f1a\u53d1\u73b0\uff0c\u4e3b\u5e93\u7684\u5185\u5b58\u8868\u6570\u636e\u7a81\u7136\u88ab\u6e05\u7a7a\u4e86\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u5185\u5b58\u8868\u5e76\u4e0d\u9002\u5408\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u4f5c\u4e3a\u666e\u901a\u6570\u636e\u8868\u4f7f\u7528\u3002</p> <p>\u6709\u540c\u5b66\u4f1a\u8bf4\uff0c\u4f46\u662f\u5185\u5b58\u8868\u6267\u884c\u901f\u5ea6\u5feb\u5440\u3002\u8fd9\u4e2a\u95ee\u9898\uff0c\u5176\u5b9e\u4f60\u53ef\u4ee5\u8fd9\u4e48\u5206\u6790\uff1a</p> <ol> <li>\u5982\u679c\u4f60\u7684\u8868\u66f4\u65b0\u91cf\u5927\uff0c\u90a3\u4e48\u5e76\u53d1\u5ea6\u662f\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u53c2\u8003\u6307\u6807\uff0cInnoDB \u652f\u6301\u884c\u9501\uff0c\u5e76\u53d1\u5ea6\u6bd4\u5185\u5b58\u8868\u597d\uff1b</li> <li>\u80fd\u653e\u5230\u5185\u5b58\u8868\u7684\u6570\u636e\u91cf\u90fd\u4e0d\u5927\u3002\u5982\u679c\u4f60\u8003\u8651\u7684\u662f\u8bfb\u7684\u6027\u80fd\uff0c\u4e00\u4e2a\u8bfb QPS \u5f88\u9ad8\u5e76\u4e14\u6570\u636e\u91cf\u4e0d\u5927\u7684\u8868\uff0c\u5373\u4f7f\u662f\u4f7f\u7528 InnoDB\uff0c\u6570\u636e\u4e5f\u662f\u90fd\u4f1a\u7f13\u5b58\u5728 InnoDB Buffer Pool \u91cc\u7684\u3002\u56e0\u6b64\uff0c\u4f7f\u7528 InnoDB \u8868\u7684\u8bfb\u6027\u80fd\u4e5f\u4e0d\u4f1a\u5dee\u3002</li> </ol> <p>\u6240\u4ee5\uff0c**\u6211\u5efa\u8bae\u4f60\u628a\u666e\u901a\u5185\u5b58\u8868\u90fd\u7528 InnoDB \u8868\u6765\u4ee3\u66ff\u3002**\u4f46\u662f\uff0c\u6709\u4e00\u4e2a\u573a\u666f\u5374\u662f\u4f8b\u5916\u7684\u3002</p> <p>\u8fd9\u4e2a\u573a\u666f\u5c31\u662f\uff0c\u6211\u4eec\u5728\u7b2c 35 \u548c 36 \u7bc7\u8bf4\u5230\u7684\u7528\u6237\u4e34\u65f6\u8868\u3002\u5728\u6570\u636e\u91cf\u53ef\u63a7\uff0c\u4e0d\u4f1a\u8017\u8d39\u8fc7\u591a\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u5185\u5b58\u8868\u3002</p> <p>\u5185\u5b58\u4e34\u65f6\u8868\u521a\u597d\u53ef\u4ee5\u65e0\u89c6\u5185\u5b58\u8868\u7684\u4e24\u4e2a\u4e0d\u8db3\uff0c\u4e3b\u8981\u662f\u4e0b\u9762\u7684\u4e09\u4e2a\u539f\u56e0\uff1a</p> <ol> <li>\u4e34\u65f6\u8868\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u8bbf\u95ee\uff0c\u6ca1\u6709\u5e76\u53d1\u6027\u7684\u95ee\u9898\uff1b</li> <li>\u4e34\u65f6\u8868\u91cd\u542f\u540e\u4e5f\u662f\u9700\u8981\u5220\u9664\u7684\uff0c\u6e05\u7a7a\u6570\u636e\u8fd9\u4e2a\u95ee\u9898\u4e0d\u5b58\u5728\uff1b</li> <li>\u5907\u5e93\u7684\u4e34\u65f6\u8868\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u4e3b\u5e93\u7684\u7528\u6237\u7ebf\u7a0b\u3002</li> </ol> <p>\u73b0\u5728\uff0c\u6211\u4eec\u56de\u8fc7\u5934\u518d\u770b\u4e00\u4e0b\u7b2c 35 \u7bc7 join \u8bed\u53e5\u4f18\u5316\u7684\u4f8b\u5b50\uff0c\u5f53\u65f6\u6211\u5efa\u8bae\u7684\u662f\u521b\u5efa\u4e00\u4e2a InnoDB \u4e34\u65f6\u8868\uff0c\u4f7f\u7528\u7684\u8bed\u53e5\u5e8f\u5217\u662f\uff1a</p> <pre><code>create temporary table temp_t(id int primary key, a int, b int, index(b))engine=innodb;\ninsert into temp_t select * from t2 where b&gt;=1 and b&lt;=2000;\nselect * from t1 join temp_t on (t1.b=temp_t.b);\n</code></pre> <p>\u4e86\u89e3\u4e86\u5185\u5b58\u8868\u7684\u7279\u6027\uff0c\u4f60\u5c31\u77e5\u9053\u4e86\uff0c \u5176\u5b9e\u8fd9\u91cc\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u7684\u6548\u679c\u66f4\u597d\uff0c\u539f\u56e0\u6709\u4e09\u4e2a\uff1a</p> <ol> <li>\u76f8\u6bd4\u4e8e InnoDB \u8868\uff0c\u4f7f\u7528\u5185\u5b58\u8868\u4e0d\u9700\u8981\u5199\u78c1\u76d8\uff0c\u5f80\u8868 <code>temp_t</code> \u7684\u5199\u6570\u636e\u7684\u901f\u5ea6\u66f4\u5feb\uff1b</li> <li>\u7d22\u5f15 b \u4f7f\u7528 hash \u7d22\u5f15\uff0c\u67e5\u627e\u7684\u901f\u5ea6\u6bd4 B-Tree \u7d22\u5f15\u5feb\uff1b</li> <li>\u4e34\u65f6\u8868\u6570\u636e\u53ea\u6709 2000 \u884c\uff0c\u5360\u7528\u7684\u5185\u5b58\u6709\u9650\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u5bf9[\u7b2c 35 \u7bc7\u6587\u7ae0]\u7684\u8bed\u53e5\u5e8f\u5217\u505a\u4e00\u4e2a\u6539\u5199\uff0c\u5c06\u4e34\u65f6\u8868 t1 \u6539\u6210\u5185\u5b58\u4e34\u65f6\u8868\uff0c\u5e76\u4e14\u5728\u5b57\u6bb5 b \u4e0a\u521b\u5efa\u4e00\u4e2a hash \u7d22\u5f15\u3002</p> <pre><code>create temporary table temp_t(id int primary key, a int, b int, index (b))engine=memory;\ninsert into temp_t select * from t2 where b&gt;=1 and b&lt;=2000;\nselect * from t1 join temp_t on (t1.b=temp_t.b);\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e0d\u8bba\u662f\u5bfc\u5165\u6570\u636e\u7684\u65f6\u95f4\uff0c\u8fd8\u662f\u6267\u884c join \u7684\u65f6\u95f4\uff0c\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u7684\u901f\u5ea6\u90fd\u6bd4\u4f7f\u7528 InnoDB \u4e34\u65f6\u8868\u8981\u66f4\u5feb\u4e00\u4e9b\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_24","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4ece\u201c\u8981\u4e0d\u8981\u4f7f\u7528\u5185\u5b58\u8868\u201d\u8fd9\u4e2a\u95ee\u9898\u5c55\u5f00\uff0c\u548c\u4f60\u4ecb\u7ecd\u4e86 Memory \u5f15\u64ce\u7684\u51e0\u4e2a\u7279\u6027\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e\u91cd\u542f\u4f1a\u4e22\u6570\u636e\uff0c\u5982\u679c\u4e00\u4e2a\u5907\u5e93\u91cd\u542f\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u7ebf\u7a0b\u505c\u6b62\uff1b\u5982\u679c\u4e3b\u5e93\u8ddf\u8fd9\u4e2a\u5907\u5e93\u662f\u53cc M \u67b6\u6784\uff0c\u8fd8\u53ef\u80fd\u5bfc\u81f4\u4e3b\u5e93\u7684\u5185\u5b58\u8868\u6570\u636e\u88ab\u5220\u6389\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u751f\u4ea7\u4e0a\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u4f7f\u7528\u666e\u901a\u5185\u5b58\u8868\u3002</p> <p>\u5982\u679c\u4f60\u662f DBA\uff0c\u53ef\u4ee5\u5728\u5efa\u8868\u7684\u5ba1\u6838\u7cfb\u7edf\u4e2d\u589e\u52a0\u8fd9\u7c7b\u89c4\u5219\uff0c\u8981\u6c42\u4e1a\u52a1\u6539\u7528 InnoDB \u8868\u3002\u6211\u4eec\u5728\u6587\u4e2d\u4e5f\u5206\u6790\u4e86\uff0c\u5176\u5b9e InnoDB \u8868\u6027\u80fd\u8fd8\u4e0d\u9519\uff0c\u800c\u4e14\u6570\u636e\u5b89\u5168\u4e5f\u6709\u4fdd\u969c\u3002\u800c\u5185\u5b58\u8868\u7531\u4e8e\u4e0d\u652f\u6301\u884c\u9501\uff0c\u66f4\u65b0\u8bed\u53e5\u4f1a\u963b\u585e\u67e5\u8be2\uff0c\u6027\u80fd\u4e5f\u672a\u5fc5\u5c31\u5982\u60f3\u8c61\u4e2d\u90a3\u4e48\u597d\u3002</p> <p>\u57fa\u4e8e\u5185\u5b58\u8868\u7684\u7279\u6027\uff0c\u6211\u4eec\u8fd8\u5206\u6790\u4e86\u5b83\u7684\u4e00\u4e2a\u9002\u7528\u573a\u666f\uff0c\u5c31\u662f\u5185\u5b58\u4e34\u65f6\u8868\u3002\u5185\u5b58\u8868\u652f\u6301 hash \u7d22\u5f15\uff0c\u8fd9\u4e2a\u7279\u6027\u5229\u7528\u8d77\u6765\uff0c\u5bf9\u590d\u6742\u67e5\u8be2\u7684\u52a0\u901f\u6548\u679c\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#39","title":"39 \u81ea\u589e\u4e3b\u952e\u4e3a\u4ec0\u4e48\u4e0d\u662f\u8fde\u7eed\u7684\uff1f","text":"<p>\u5728[\u7b2c 4 \u7bc7\u6587\u7ae0]\u4e2d\uff0c\u6211\u4eec\u63d0\u5230\u8fc7\u81ea\u589e\u4e3b\u952e\uff0c\u7531\u4e8e\u81ea\u589e\u4e3b\u952e\u53ef\u4ee5\u8ba9\u4e3b\u952e\u7d22\u5f15\u5c3d\u91cf\u5730\u4fdd\u6301\u9012\u589e\u987a\u5e8f\u63d2\u5165\uff0c\u907f\u514d\u4e86\u9875\u5206\u88c2\uff0c\u56e0\u6b64\u7d22\u5f15\u66f4\u7d27\u51d1\u3002</p> <p>\u4e4b\u524d\u6211\u89c1\u8fc7\u6709\u7684\u4e1a\u52a1\u8bbe\u8ba1\u4f9d\u8d56\u4e8e\u81ea\u589e\u4e3b\u952e\u7684\u8fde\u7eed\u6027\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u8bbe\u8ba1\u5047\u8bbe\u81ea\u589e\u4e3b\u952e\u662f\u8fde\u7eed\u7684\u3002\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u6837\u7684\u5047\u8bbe\u662f\u9519\u7684\uff0c\u56e0\u4e3a\u81ea\u589e\u4e3b\u952e\u4e0d\u80fd\u4fdd\u8bc1\u8fde\u7eed\u9012\u589e\u3002</p> <p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u6765\u8bf4\u8bf4\u8fd9\u4e2a\u95ee\u9898\uff0c\u770b\u770b\u4ec0\u4e48\u60c5\u51b5\u4e0b\u81ea\u589e\u4e3b\u952e\u4f1a\u51fa\u73b0 \u201c\u7a7a\u6d1e\u201d\uff1f</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u8868 t\uff0c\u5176\u4e2d id \u662f\u81ea\u589e\u4e3b\u952e\u5b57\u6bb5\u3001c \u662f\u552f\u4e00\u7d22\u5f15\u3002</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `c` (`c`)\n) ENGINE=InnoDB;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_25","title":"\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u54ea\u513f\uff1f","text":"<p>\u5728\u8fd9\u4e2a\u7a7a\u8868 t \u91cc\u9762\u6267\u884c <code>insert into t values(null, 1, 1);</code> \u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u518d\u6267\u884c show create table \u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u56fe\u6240\u793a\u7684\u7ed3\u679c\uff1a</p> <pre><code>mysql&gt; show create table t \\G;\n*************************** 1. row ***************************\n       Table: t\nCreate Table: CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `c` (`c`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8868\u5b9a\u4e49\u91cc\u9762\u51fa\u73b0\u4e86\u4e00\u4e2a <code>AUTO_INCREMENT=2</code>\uff0c\u8868\u793a\u4e0b\u4e00\u6b21\u63d2\u5165\u6570\u636e\u65f6\uff0c\u5982\u679c\u9700\u8981\u81ea\u52a8\u751f\u6210\u81ea\u589e\u503c\uff0c\u4f1a\u751f\u6210 id=2\u3002</p> <p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u8f93\u51fa\u7ed3\u679c\u5bb9\u6613\u5f15\u8d77\u8fd9\u6837\u7684\u8bef\u89e3\uff1a\u81ea\u589e\u503c\u662f\u4fdd\u5b58\u5728\u8868\u7ed3\u6784\u5b9a\u4e49\u91cc\u7684\u3002\u5b9e\u9645\u4e0a\uff0c\u8868\u7684\u7ed3\u6784\u5b9a\u4e49\u5b58\u653e\u5728\u540e\u7f00\u540d\u4e3a.frm \u7684\u6587\u4ef6\u4e2d\uff0c\u4f46\u662f\u5e76\u4e0d\u4f1a\u4fdd\u5b58\u81ea\u589e\u503c\u3002</p> <p>\u4e0d\u540c\u7684\u5f15\u64ce\u5bf9\u4e8e\u81ea\u589e\u503c\u7684\u4fdd\u5b58\u7b56\u7565\u4e0d\u540c\u3002</p> <ul> <li>MyISAM \u5f15\u64ce\u7684\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u6570\u636e\u6587\u4ef6\u4e2d\u3002</li> <li>InnoDB \u5f15\u64ce\u7684\u81ea\u589e\u503c\uff0c\u5176\u5b9e\u662f\u4fdd\u5b58\u5728\u4e86\u5185\u5b58\u91cc\uff0c\u5e76\u4e14\u5230\u4e86 MySQL 8.0 \u7248\u672c\u540e\uff0c\u624d\u6709\u4e86\u201c\u81ea\u589e\u503c\u6301\u4e45\u5316\u201d\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u662f\u624d\u5b9e\u73b0\u4e86\u201c\u5982\u679c\u53d1\u751f\u91cd\u542f\uff0c\u8868\u7684\u81ea\u589e\u503c\u53ef\u4ee5\u6062\u590d\u4e3a MySQL \u91cd\u542f\u524d\u7684\u503c\u201d\uff0c\u5177\u4f53\u60c5\u51b5\u662f\uff1a </li> <li>\u5728 MySQL 5.7 \u53ca\u4e4b\u524d\u7684\u7248\u672c\uff0c\u81ea\u589e\u503c\u4fdd\u5b58\u5728\u5185\u5b58\u91cc\uff0c\u5e76\u6ca1\u6709\u6301\u4e45\u5316\u3002\u6bcf\u6b21\u91cd\u542f\u540e\uff0c\u7b2c\u4e00\u6b21\u6253\u5f00\u8868\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u53bb\u627e\u81ea\u589e\u503c\u7684\u6700\u5927\u503c <code>max(id)</code>\uff0c\u7136\u540e\u5c06 <code>max(id)+1</code> \u4f5c\u4e3a\u8fd9\u4e2a\u8868\u5f53\u524d\u7684\u81ea\u589e\u503c\u3002 \u4e3e\u4f8b\u6765\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a\u8868\u5f53\u524d\u6570\u636e\u884c\u91cc\u6700\u5927\u7684 id \u662f 10\uff0c<code>AUTO_INCREMENT=11</code>\u3002\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5220\u9664 id=10 \u7684\u884c\uff0c<code>AUTO_INCREMENT</code> \u8fd8\u662f 11\u3002\u4f46\u5982\u679c\u9a6c\u4e0a\u91cd\u542f\u5b9e\u4f8b\uff0c\u91cd\u542f\u540e\u8fd9\u4e2a\u8868\u7684 AUTO_INCREMENT \u5c31\u4f1a\u53d8\u6210 10\u3002 \u4e5f\u5c31\u662f\u8bf4\uff0cMySQL \u91cd\u542f\u53ef\u80fd\u4f1a\u4fee\u6539\u4e00\u4e2a\u8868\u7684 <code>AUTO_INCREMENT</code> \u7684\u503c\u3002</li> <li>\u5728 MySQL 8.0 \u7248\u672c\uff0c\u5c06\u81ea\u589e\u503c\u7684\u53d8\u66f4\u8bb0\u5f55\u5728\u4e86 redo log \u4e2d\uff0c\u91cd\u542f\u7684\u65f6\u5019\u4f9d\u9760 redo log \u6062\u590d\u91cd\u542f\u4e4b\u524d\u7684\u503c\u3002</li> </ul> <p>\u7406\u89e3\u4e86 MySQL \u5bf9\u81ea\u589e\u503c\u7684\u4fdd\u5b58\u7b56\u7565\u4ee5\u540e\uff0c\u6211\u4eec\u518d\u770b\u770b\u81ea\u589e\u503c\u4fee\u6539\u673a\u5236\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_26","title":"\u81ea\u589e\u503c\u4fee\u6539\u673a\u5236","text":"<p>\u5728 MySQL \u91cc\u9762\uff0c\u5982\u679c\u5b57\u6bb5 id \u88ab\u5b9a\u4e49\u4e3a <code>AUTO_INCREMENT</code>\uff0c\u5728\u63d2\u5165\u4e00\u884c\u6570\u636e\u7684\u65f6\u5019\uff0c\u81ea\u589e\u503c\u7684\u884c\u4e3a\u5982\u4e0b\uff1a</p> <ol> <li>\u5982\u679c\u63d2\u5165\u6570\u636e\u65f6 id \u5b57\u6bb5\u6307\u5b9a\u4e3a 0\u3001null \u6216\u672a\u6307\u5b9a\u503c\uff0c\u90a3\u4e48\u5c31\u628a\u8fd9\u4e2a\u8868\u5f53\u524d\u7684 <code>AUTO_INCREMENT</code> \u503c\u586b\u5230\u81ea\u589e\u5b57\u6bb5\uff1b</li> <li>\u5982\u679c\u63d2\u5165\u6570\u636e\u65f6 id \u5b57\u6bb5\u6307\u5b9a\u4e86\u5177\u4f53\u7684\u503c\uff0c\u5c31\u76f4\u63a5\u4f7f\u7528\u8bed\u53e5\u91cc\u6307\u5b9a\u7684\u503c\u3002</li> </ol> <p>\u6839\u636e\u8981\u63d2\u5165\u7684\u503c\u548c\u5f53\u524d\u81ea\u589e\u503c\u7684\u5927\u5c0f\u5173\u7cfb\uff0c\u81ea\u589e\u503c\u7684\u53d8\u66f4\u7ed3\u679c\u4e5f\u4f1a\u6709\u6240\u4e0d\u540c\u3002\u5047\u8bbe\uff0c\u67d0\u6b21\u8981\u63d2\u5165\u7684\u503c\u662f X\uff0c\u5f53\u524d\u7684\u81ea\u589e\u503c\u662f Y\u3002</p> <ol> <li>\u5982\u679c X\\&lt;Y\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8868\u7684\u81ea\u589e\u503c\u4e0d\u53d8\uff1b</li> <li>\u5982\u679c X\u2265Y\uff0c\u5c31\u9700\u8981\u628a\u5f53\u524d\u81ea\u589e\u503c\u4fee\u6539\u4e3a\u65b0\u7684\u81ea\u589e\u503c\u3002</li> </ol> <p>\u65b0\u7684\u81ea\u589e\u503c\u751f\u6210\u7b97\u6cd5\u662f\uff1a\u4ece <code>auto_increment_offset</code> \u5f00\u59cb\uff0c\u4ee5 <code>auto_increment_increment</code> \u4e3a\u6b65\u957f\uff0c\u6301\u7eed\u53e0\u52a0\uff0c\u76f4\u5230\u627e\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e X \u7684\u503c\uff0c\u4f5c\u4e3a\u65b0\u7684\u81ea\u589e\u503c\u3002</p> <p>\u5176\u4e2d\uff0c<code>auto_increment_offset</code> \u548c <code>auto_increment_increment</code> \u662f\u4e24\u4e2a\u7cfb\u7edf\u53c2\u6570\uff0c\u5206\u522b\u7528\u6765\u8868\u793a\u81ea\u589e\u7684\u521d\u59cb\u503c\u548c\u6b65\u957f\uff0c\u9ed8\u8ba4\u503c\u90fd\u662f 1\u3002</p> <p>\u5907\u6ce8\uff1a\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u4f7f\u7528\u7684\u5c31\u4e0d\u5168\u662f\u9ed8\u8ba4\u503c\u3002\u6bd4\u5982\uff0c\u53cc M \u7684\u4e3b\u5907\u7ed3\u6784\u91cc\u8981\u6c42\u53cc\u5199\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u80fd\u4f1a\u8bbe\u7f6e\u6210 auto_increment_increment=2\uff0c\u8ba9\u4e00\u4e2a\u5e93\u7684\u81ea\u589e id \u90fd\u662f\u5947\u6570\uff0c\u53e6\u4e00\u4e2a\u5e93\u7684\u81ea\u589e id \u90fd\u662f\u5076\u6570\uff0c\u907f\u514d\u4e24\u4e2a\u5e93\u751f\u6210\u7684\u4e3b\u952e\u53d1\u751f\u51b2\u7a81\u3002</p> <p>\u5f53 <code>auto_increment_offset</code> \u548c <code>auto_increment_increment</code> \u90fd\u662f 1 \u7684\u65f6\u5019\uff0c\u65b0\u7684\u81ea\u589e\u503c\u751f\u6210\u903b\u8f91\u5f88\u7b80\u5355\uff0c\u5c31\u662f\uff1a</p> <ol> <li>\u5982\u679c\u51c6\u5907\u63d2\u5165\u7684\u503c &gt;= \u5f53\u524d\u81ea\u589e\u503c\uff0c\u65b0\u7684\u81ea\u589e\u503c\u5c31\u662f\u201c\u51c6\u5907\u63d2\u5165\u7684\u503c +1\u201d\uff1b</li> <li>\u5426\u5219\uff0c\u81ea\u589e\u503c\u4e0d\u53d8\u3002</li> </ol> <p>\u8fd9\u5c31\u5f15\u5165\u4e86\u6211\u4eec\u6587\u7ae0\u5f00\u5934\u63d0\u5230\u7684\u95ee\u9898\uff0c\u5728\u8fd9\u4e24\u4e2a\u53c2\u6570\u90fd\u8bbe\u7f6e\u4e3a 1 \u7684\u65f6\u5019\uff0c\u81ea\u589e\u4e3b\u952e id \u5374\u4e0d\u80fd\u4fdd\u8bc1\u662f\u8fde\u7eed\u7684\uff0c\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u5462\uff1f</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_27","title":"\u81ea\u589e\u503c\u7684\u4fee\u6539\u65f6\u673a","text":"<p>\u8981\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5c31\u8981\u770b\u4e00\u4e0b\u81ea\u589e\u503c\u7684\u4fee\u6539\u65f6\u673a\u3002</p> <p>\u5047\u8bbe\uff0c\u8868 t \u91cc\u9762\u5df2\u7ecf\u6709\u4e86 (1,1,1) \u8fd9\u6761\u8bb0\u5f55\uff0c\u8fd9\u65f6\u6211\u518d\u6267\u884c\u4e00\u6761\u63d2\u5165\u6570\u636e\u547d\u4ee4\uff1a</p> <pre><code>insert into t values(null, 1, 1); \n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5c31\u662f\uff1a</p> <ol> <li>\u6267\u884c\u5668\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\u5199\u5165\u4e00\u884c\uff0c\u4f20\u5165\u7684\u8fd9\u4e00\u884c\u7684\u503c\u662f (0,1,1);</li> <li>InnoDB \u53d1\u73b0\u7528\u6237\u6ca1\u6709\u6307\u5b9a\u81ea\u589e id \u7684\u503c\uff0c\u83b7\u53d6\u8868 t \u5f53\u524d\u7684\u81ea\u589e\u503c 2\uff1b</li> <li>\u5c06\u4f20\u5165\u7684\u884c\u7684\u503c\u6539\u6210 (2,1,1);</li> <li>\u5c06\u8868\u7684\u81ea\u589e\u503c\u6539\u6210 3\uff1b</li> <li>\u7ee7\u7eed\u6267\u884c\u63d2\u5165\u6570\u636e\u64cd\u4f5c\uff0c\u7531\u4e8e\u5df2\u7ecf\u5b58\u5728 c=1 \u7684\u8bb0\u5f55\uff0c\u6240\u4ee5\u62a5 Duplicate key error\uff0c\u8bed\u53e5\u8fd4\u56de\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8868\u7684\u81ea\u589e\u503c\u6539\u6210 3\uff0c\u662f\u5728\u771f\u6b63\u6267\u884c\u63d2\u5165\u6570\u636e\u7684\u64cd\u4f5c\u4e4b\u524d\u3002\u8fd9\u4e2a\u8bed\u53e5\u771f\u6b63\u6267\u884c\u7684\u65f6\u5019\uff0c\u56e0\u4e3a\u78b0\u5230\u552f\u4e00\u952e c \u51b2\u7a81\uff0c\u6240\u4ee5 id=2 \u8fd9\u4e00\u884c\u5e76\u6ca1\u6709\u63d2\u5165\u6210\u529f\uff0c\u4f46\u4e5f\u6ca1\u6709\u5c06\u81ea\u589e\u503c\u518d\u6539\u56de\u53bb\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u8fd9\u4e4b\u540e\uff0c\u518d\u63d2\u5165\u65b0\u7684\u6570\u636e\u884c\u65f6\uff0c\u62ff\u5230\u7684\u81ea\u589e id \u5c31\u662f 3\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u51fa\u73b0\u4e86\u81ea\u589e\u4e3b\u952e\u4e0d\u8fde\u7eed\u7684\u60c5\u51b5\u3002</p> <p>\u5982\u56fe 3 \u6240\u793a\u5c31\u662f\u5b8c\u6574\u7684\u6f14\u793a\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `c` (`c`)\n) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci\n\nmysql&gt; insert into t values(null,1,1);\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; insert into t values(null,1,1);\nERROR 1062 (23000): Duplicate entry '1' for key 'c'\nmysql&gt; insert into t values(null, 2,2);\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; select * from t;\n+----+------+------+\n| id | c    | d    |\n+----+------+------+\n|  1 |    1 |    1 |\n|  3 |    2 |    2 |\n+----+------+------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u5e8f\u5217\u590d\u73b0\u4e86\u4e00\u4e2a\u81ea\u589e\u4e3b\u952e id \u4e0d\u8fde\u7eed\u7684\u73b0\u573a (\u6ca1\u6709 id=2 \u7684\u884c\uff09\u3002\u53ef\u89c1\uff0c\u552f\u4e00\u952e\u51b2\u7a81\u662f\u5bfc\u81f4\u81ea\u589e\u4e3b\u952e id \u4e0d\u8fde\u7eed\u7684\u7b2c\u4e00\u79cd\u539f\u56e0\u3002</p> <p>\u540c\u6837\u5730\uff0c\u4e8b\u52a1**\u56de\u6eda\u4e5f\u4f1a\u4ea7\u751f\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u8fd9\u5c31\u662f\u7b2c\u4e8c\u79cd\u539f\u56e0\u3002**</p> <p>\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u5e8f\u5217\u5c31\u53ef\u4ee5\u6784\u9020\u4e0d\u8fde\u7eed\u7684\u81ea\u589e id\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u9a8c\u8bc1\u4e00\u4e0b\u3002</p> <pre><code>insert into t values(null,1,1);\nbegin;\ninsert into t values(null,2,2);\nrollback;\ninsert into t values(null,2,2);\n-- \u63d2\u5165\u7684\u884c\u662f (3,2,2)\n</code></pre> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u5728\u51fa\u73b0\u552f\u4e00\u952e\u51b2\u7a81\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\uff0cMySQL \u6ca1\u6709\u628a\u8868 t \u7684\u81ea\u589e\u503c\u6539\u56de\u53bb\u5462\uff1f\u5982\u679c\u628a\u8868 t \u7684\u5f53\u524d\u81ea\u589e\u503c\u4ece 3 \u6539\u56de 2\uff0c\u518d\u63d2\u5165\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u4e0d\u5c31\u53ef\u4ee5\u751f\u6210 id=2 \u7684\u4e00\u884c\u6570\u636e\u4e86\u5417\uff1f</p> <p>\u5176\u5b9e\uff0cMySQL \u8fd9\u4e48\u8bbe\u8ba1\u662f\u4e3a\u4e86\u63d0\u5347\u6027\u80fd\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u8ddf\u4f60\u5206\u6790\u4e00\u4e0b\u8fd9\u4e2a\u8bbe\u8ba1\u601d\u8def\uff0c\u770b\u770b**\u81ea\u589e\u503c\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u56de\u9000\u3002**</p> <p>\u5047\u8bbe\u6709\u4e24\u4e2a\u5e76\u884c\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u5728\u7533\u8bf7\u81ea\u589e\u503c\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u907f\u514d\u4e24\u4e2a\u4e8b\u52a1\u7533\u8bf7\u5230\u76f8\u540c\u7684\u81ea\u589e id\uff0c\u80af\u5b9a\u8981\u52a0\u9501\uff0c\u7136\u540e\u987a\u5e8f\u7533\u8bf7\u3002</p> <ol> <li>\u5047\u8bbe\u4e8b\u52a1 A \u7533\u8bf7\u5230\u4e86 id=2\uff0c \u4e8b\u52a1 B \u7533\u8bf7\u5230 id=3\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u8868 t \u7684\u81ea\u589e\u503c\u662f 4\uff0c\u4e4b\u540e\u7ee7\u7eed\u6267\u884c\u3002</li> <li>\u4e8b\u52a1 B \u6b63\u786e\u63d0\u4ea4\u4e86\uff0c\u4f46\u4e8b\u52a1 A \u51fa\u73b0\u4e86\u552f\u4e00\u952e\u51b2\u7a81\u3002</li> <li>\u5982\u679c\u5141\u8bb8\u4e8b\u52a1 A \u628a\u81ea\u589e id \u56de\u9000\uff0c\u4e5f\u5c31\u662f\u628a\u8868 t \u7684\u5f53\u524d\u81ea\u589e\u503c\u6539\u56de 2\uff0c\u90a3\u4e48\u5c31\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u8868\u91cc\u9762\u5df2\u7ecf\u6709 id=3 \u7684\u884c\uff0c\u800c\u5f53\u524d\u7684\u81ea\u589e id \u503c\u662f 2\u3002</li> <li>\u63a5\u4e0b\u6765\uff0c\u7ee7\u7eed\u6267\u884c\u7684\u5176\u4ed6\u4e8b\u52a1\u5c31\u4f1a\u7533\u8bf7\u5230 id=2\uff0c\u7136\u540e\u518d\u7533\u8bf7\u5230 id=3\u3002\u8fd9\u65f6\uff0c\u5c31\u4f1a\u51fa\u73b0\u63d2\u5165\u8bed\u53e5\u62a5\u9519\u201c\u4e3b\u952e\u51b2\u7a81\u201d\u3002</li> </ol> <p>\u800c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u4e3b\u952e\u51b2\u7a81\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <ol> <li>\u6bcf\u6b21\u7533\u8bf7 id \u4e4b\u524d\uff0c\u5148\u5224\u65ad\u8868\u91cc\u9762\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u8fd9\u4e2a id\u3002\u5982\u679c\u5b58\u5728\uff0c\u5c31\u8df3\u8fc7\u8fd9\u4e2a id\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6210\u672c\u5f88\u9ad8\u3002\u56e0\u4e3a\uff0c\u672c\u6765\u7533\u8bf7 id \u662f\u4e00\u4e2a\u5f88\u5feb\u7684\u64cd\u4f5c\uff0c\u73b0\u5728\u8fd8\u8981\u518d\u53bb\u4e3b\u952e\u7d22\u5f15\u6811\u4e0a\u5224\u65ad id \u662f\u5426\u5b58\u5728\u3002</li> <li>\u628a\u81ea\u589e id \u7684\u9501\u8303\u56f4\u6269\u5927\uff0c\u5fc5\u987b\u7b49\u5230\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\u5e76\u63d0\u4ea4\uff0c\u4e0b\u4e00\u4e2a\u4e8b\u52a1\u624d\u80fd\u518d\u7533\u8bf7\u81ea\u589e id\u3002\u8fd9\u4e2a\u65b9\u6cd5\u7684\u95ee\u9898\uff0c\u5c31\u662f\u9501\u7684\u7c92\u5ea6\u592a\u5927\uff0c\u7cfb\u7edf\u5e76\u53d1\u80fd\u529b\u5927\u5927\u4e0b\u964d\u3002</li> </ol> <p>\u53ef\u89c1\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u90fd\u4f1a\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u3002\u9020\u6210\u8fd9\u4e9b\u9ebb\u70e6\u7684\u7f6a\u9b41\u7978\u9996\uff0c\u5c31\u662f\u6211\u4eec\u5047\u8bbe\u7684\u8fd9\u4e2a\u201c\u5141\u8bb8\u81ea\u589e id \u56de\u9000\u201d\u7684\u524d\u63d0\u5bfc\u81f4\u7684\u3002</p> <p>\u56e0\u6b64\uff0cInnoDB \u653e\u5f03\u4e86\u8fd9\u4e2a\u8bbe\u8ba1\uff0c\u8bed\u53e5\u6267\u884c\u5931\u8d25\u4e5f\u4e0d\u56de\u9000\u81ea\u589e id\u3002\u4e5f\u6b63\u662f\u56e0\u4e3a\u8fd9\u6837\uff0c\u6240\u4ee5\u624d\u53ea\u4fdd\u8bc1\u4e86\u81ea\u589e id \u662f\u9012\u589e\u7684\uff0c\u4f46\u4e0d\u4fdd\u8bc1\u662f\u8fde\u7eed\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-4/#_28","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\uff0c\u6211\u4eec\u4ece\u201c\u81ea\u589e\u4e3b\u952e\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u4e0d\u8fde\u7eed\u7684\u503c\u201d\u8fd9\u4e2a\u95ee\u9898\u5f00\u59cb\uff0c\u9996\u5148\u8ba8\u8bba\u4e86\u81ea\u589e\u503c\u7684\u5b58\u50a8\u3002</p> <p>\u5728 MyISAM \u5f15\u64ce\u91cc\u9762\uff0c\u81ea\u589e\u503c\u662f\u88ab\u5199\u5728\u6570\u636e\u6587\u4ef6\u4e0a\u7684\u3002\u800c\u5728 InnoDB \u4e2d\uff0c\u81ea\u589e\u503c\u662f\u88ab\u8bb0\u5f55\u5728\u5185\u5b58\u7684\u3002MySQL \u76f4\u5230 8.0 \u7248\u672c\uff0c\u624d\u7ed9 InnoDB \u8868\u7684\u81ea\u589e\u503c\u52a0\u4e0a\u4e86\u6301\u4e45\u5316\u7684\u80fd\u529b\uff0c\u786e\u4fdd\u91cd\u542f\u524d\u540e\u4e00\u4e2a\u8868\u7684\u81ea\u589e\u503c\u4e0d\u53d8\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/","title":"\u300aMySQL \u5b9e\u621845\u8bb2\u300b\u8282\u9009\u7b2c\u4e94\u90e8\u5206","text":"<p>Source</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u8282\u9009\u81ea \u201c\u4e01\u5947\u201d \u5728\u6781\u5ba2\u65f6\u95f4\u7684 \u300aMySQL\u5b9e\u621845\u8bb2\u300b\u7684\u5185\u5bb9\uff0c\u8fd9\u662f\u7b2c\u4e94\u90e8\u5206</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#40-insert","title":"40 insert\u8bed\u53e5\u7684\u9501\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u591a\uff1f","text":"<p>\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u63d0\u5230 MySQL \u5bf9\u81ea\u589e\u4e3b\u952e\u9501\u505a\u4e86\u4f18\u5316\uff0c\u5c3d\u91cf\u5728\u7533\u8bf7\u5230\u81ea\u589e id \u4ee5\u540e\uff0c\u5c31\u91ca\u653e\u81ea\u589e\u9501\u3002</p> <p>\u56e0\u6b64\uff0cinsert \u8bed\u53e5\u662f\u4e00\u4e2a\u5f88\u8f7b\u91cf\u7684\u64cd\u4f5c\u3002\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u7ed3\u8bba\u5bf9\u4e8e\u201c\u666e\u901a\u7684 insert \u8bed\u53e5\u201d\u624d\u6709\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd8\u6709\u4e9b insert \u8bed\u53e5\u662f\u5c5e\u4e8e\u201c\u7279\u6b8a\u60c5\u51b5\u201d\u7684\uff0c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u9700\u8981\u7ed9\u5176\u4ed6\u8d44\u6e90\u52a0\u9501\uff0c\u6216\u8005\u65e0\u6cd5\u5728\u7533\u8bf7\u5230\u81ea\u589e id \u4ee5\u540e\u5c31\u7acb\u9a6c\u91ca\u653e\u81ea\u589e\u9501\u3002</p> <p>\u90a3\u4e48\uff0c\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u804a\u804a\u8fd9\u4e2a\u8bdd\u9898\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#insert-select","title":"insert \u2026 select \u8bed\u53e5","text":"<p>\u6211\u4eec\u5148\u4ece\u6628\u5929\u7684\u95ee\u9898\u8bf4\u8d77\u5427\u3002\u8868 t \u548c t2 \u7684\u8868\u7ed3\u6784\u3001\u521d\u59cb\u5316\u6570\u636e\u8bed\u53e5\u5982\u4e0b\uff0c\u4eca\u5929\u7684\u4f8b\u5b50\u6211\u4eec\u8fd8\u662f\u9488\u5bf9\u8fd9\u4e24\u4e2a\u8868\u5c55\u5f00\u3002</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `c` (`c`)\n) ENGINE=InnoDB; \ninsert into t values(null, 1,1);\ninsert into t values(null, 2,2);\ninsert into t values(null, 3,3);\ninsert into t values(null, 4,4); \ncreate table t2 like t;\n</code></pre> <p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u4e3a\u4ec0\u4e48\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c<code>binlog_format=statement</code> \u65f6\u6267\u884c\uff1a</p> <pre><code>insert into t2(c,d) select c,d from t;\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u65f6\uff0c\u9700\u8981\u5bf9\u8868 t \u7684\u6240\u6709\u884c\u548c\u95f4\u9699\u52a0\u9501\u5462\uff1f</p> <p>\u5176\u5b9e\uff0c\u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u9700\u8981\u8003\u8651\u7684\u8fd8\u662f\u65e5\u5fd7\u548c\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u6211\u4eec\u770b\u4e0b\u8fd9\u4e2a\u6267\u884c\u5e8f\u5217\uff1a</p> <ul> <li>session A: <code>insert into t values(-1, -1, -1)</code></li> <li>session B: <code>insert into t2(c, d) select c, d from t</code></li> </ul> <p>\u5b9e\u9645\u7684\u6267\u884c\u6548\u679c\u662f\uff0c\u5982\u679c session B \u5148\u6267\u884c\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u5bf9\u8868 t \u4e3b\u952e\u7d22\u5f15\u52a0\u4e86 (-\u221e,1] \u8fd9\u4e2a next-key lock\uff0c\u4f1a\u5728\u8bed\u53e5\u6267\u884c\u5b8c\u6210\u540e\uff0c\u624d\u5141\u8bb8 session A \u7684 insert \u8bed\u53e5\u6267\u884c\u3002</p> <p>\u4f46\u5982\u679c\u6ca1\u6709\u9501\u7684\u8bdd\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0 session B \u7684 insert \u8bed\u53e5\u5148\u6267\u884c\uff0c\u4f46\u662f\u540e\u5199\u5165 binlog \u7684\u60c5\u51b5\u3002\u4e8e\u662f\uff0c\u5728 <code>binlog_format=statement</code> \u7684\u60c5\u51b5\u4e0b\uff0cbinlog \u91cc\u9762\u5c31\u8bb0\u5f55\u4e86\u8fd9\u6837\u7684\u8bed\u53e5\u5e8f\u5217\uff1a</p> <pre><code>insert into t values(-1,-1,-1);\ninsert into t2(c,d) select c,d from t;\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u5230\u4e86\u5907\u5e93\u6267\u884c\uff0c\u5c31\u4f1a\u628a id=-1 \u8fd9\u4e00\u884c\u4e5f\u5199\u5230\u8868 t2 \u4e2d\uff0c\u51fa\u73b0\u4e3b\u5907\u4e0d\u4e00\u81f4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#insert","title":"insert \u5faa\u73af\u5199\u5165","text":"<p>\u5f53\u7136\u4e86\uff0c\u6267\u884c <code>insert \u2026 select</code> \u7684\u65f6\u5019\uff0c\u5bf9\u76ee\u6807\u8868\u4e5f\u4e0d\u662f\u9501\u5168\u8868\uff0c\u800c\u662f\u53ea\u9501\u4f4f\u9700\u8981\u8bbf\u95ee\u7684\u8d44\u6e90\u3002</p> <p>\u5982\u679c\u73b0\u5728\u6709\u8fd9\u4e48\u4e00\u4e2a\u9700\u6c42\uff1a\u8981\u5f80\u8868 t2 \u4e2d\u63d2\u5165\u4e00\u884c\u6570\u636e\uff0c\u8fd9\u4e00\u884c\u7684 c \u503c\u662f\u8868 t \u4e2d c \u503c\u7684\u6700\u5927\u503c\u52a0 1\u3002</p> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u4e48\u5199\u8fd9\u6761 SQL \u8bed\u53e5 \uff1a</p> <pre><code>insert into t2(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u52a0\u9501\u8303\u56f4\uff0c\u5c31\u662f\u8868 t \u7d22\u5f15 c \u4e0a\u7684 (3,4] \u548c (4,supremum] \u8fd9\u4e24\u4e2a next-key lock\uff0c\u4ee5\u53ca\u4e3b\u952e\u7d22\u5f15\u4e0a id=4 \u8fd9\u4e00\u884c\u3002</p> <p>\u5b83\u7684\u6267\u884c\u6d41\u7a0b\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u4ece\u8868 t \u4e2d\u6309\u7167\u7d22\u5f15 c \u5012\u5e8f\uff0c\u626b\u63cf\u7b2c\u4e00\u884c\uff0c\u62ff\u5230\u7ed3\u679c\u5199\u5165\u5230\u8868 t2 \u4e2d\u3002</p> <p>\u56e0\u6b64\u6574\u6761\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u662f 1\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u6211\u4eec\u662f\u8981\u628a\u8fd9\u6837\u7684\u4e00\u884c\u6570\u636e\u63d2\u5165\u5230\u8868 t \u4e2d\u7684\u8bdd\uff1a</p> <pre><code>insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n</code></pre> <p>\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u662f\u600e\u6837\u7684\uff1f\u626b\u63cf\u884c\u6570\u53c8\u662f\u591a\u5c11\u5462\uff1f</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u518d\u770b\u6162\u67e5\u8be2\u65e5\u5fd7\u5c31\u4f1a\u53d1\u73b0\u4e0d\u5bf9\u4e86\u3002</p> <pre><code># Query_time: 0.001429  Lock_time: 0.000213 Rows_sent: 0  Rows_examined: 5\nSET timestamp=1675306887;\ninsert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u7684 Rows_examined \u7684\u503c\u662f 5\u3002</p> <p>\u6211\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u63d0\u5230\u8fc7\uff0c\u5e0c\u671b\u4f60\u90fd\u80fd\u591f\u5b66\u4f1a\u7528 explain \u7684\u7ed3\u679c\u6765\u201c\u8111\u8865\u201d\u6574\u6761\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u4eca\u5929\uff0c\u6211\u4eec\u5c31\u6765\u4e00\u8d77\u8bd5\u8bd5\u3002</p> <p>\u5982\u56fe 4 \u6240\u793a\u5c31\u662f\u8fd9\u6761\u8bed\u53e5\u7684 explain \u7ed3\u679c\u3002</p> <pre><code>mysql&gt; explain insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+\n|  1 | INSERT      | t     | NULL       | ALL   | NULL          | NULL | NULL    | NULL | NULL |     NULL | NULL                                 |\n|  1 | SIMPLE      | t     | NULL       | index | NULL          | c    | 5       | NULL |    1 |   100.00 | Backward index scan; Using temporary |\n+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------+\n</code></pre> <p>\u4ece Extra \u5b57\u6bb5\u53ef\u4ee5\u770b\u5230\u201cUsing temporary\u201d\u5b57\u6837\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u7528\u5230\u4e86\u4e34\u65f6\u8868\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u628a\u8868 t \u7684\u5185\u5bb9\u8bfb\u51fa\u6765\uff0c\u5199\u5165\u4e34\u65f6\u8868\u3002</p> <p>\u56fe\u4e2d rows \u663e\u793a\u7684\u662f 1\uff0c\u6211\u4eec\u4e0d\u59a8\u5148\u5bf9\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u505a\u4e00\u4e2a\u731c\u6d4b\uff1a\u5982\u679c\u8bf4\u662f\u628a\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u8bfb\u51fa\u6765\uff08\u626b\u63cf 1 \u884c\uff09\uff0c\u5199\u5165\u4e34\u65f6\u8868\uff0c\u7136\u540e\u518d\u4ece\u4e34\u65f6\u8868\u8bfb\u51fa\u6765\uff08\u626b\u63cf 1 \u884c\uff09\uff0c\u5199\u56de\u8868 t \u4e2d\u3002\u90a3\u4e48\uff0c\u8fd9\u4e2a\u8bed\u53e5\u7684\u626b\u63cf\u884c\u6570\u5c31\u5e94\u8be5\u662f 2\uff0c\u800c\u4e0d\u662f 5\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u4e2a\u731c\u6d4b\u4e0d\u5bf9\u3002\u5b9e\u9645\u4e0a\uff0cExplain \u7ed3\u679c\u91cc\u7684 rows=1 \u662f\u56e0\u4e3a\u53d7\u5230\u4e86 limit 1 \u7684\u5f71\u54cd\u3002</p> <p>\u4ece\u53e6\u4e00\u4e2a\u89d2\u5ea6\u8003\u8651\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b InnoDB \u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002\u5982\u56fe 5 \u6240\u793a\uff0c\u662f\u5728\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u524d\u540e\u67e5\u770b <code>Innodb_rows_read</code> \u7684\u7ed3\u679c\u3002</p> <pre><code>mysql&gt; show status like 'Innodb_rows_read';\n+------------------+--------+\n| Variable_name    | Value  |\n+------------------+--------+\n| Innodb_rows_read | 221600 |\n+------------------+--------+\n1 row in set (0.01 sec)\n\nmysql&gt;  insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\nQuery OK, 1 row affected, 2 warnings (0.04 sec)\nRecords: 1  Duplicates: 0  Warnings: 2\n\nmysql&gt; show status like 'Innodb_rows_read';\n+------------------+--------+\n| Variable_name    | Value  |\n+------------------+--------+\n| Innodb_rows_read | 221601 |\n+------------------+--------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u628a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u7406\u6e05\u695a\u4e86\uff1a</p> <ol> <li>\u521b\u5efa\u4e34\u65f6\u8868\uff0c\u8868\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5 c \u548c d\u3002</li> <li>\u6309\u7167\u7d22\u5f15 c \u626b\u63cf\u8868 t\uff0c\u4f9d\u6b21\u53d6 c=4\u30013\u30012\u30011\uff0c\u7136\u540e\u56de\u8868\uff0c\u8bfb\u5230 c \u548c d \u7684\u503c\u5199\u5165\u4e34\u65f6\u8868\u3002\u8fd9\u65f6\uff0cRows_examined=4\u3002</li> <li>\u7531\u4e8e\u8bed\u4e49\u91cc\u9762\u6709 limit 1\uff0c\u6240\u4ee5\u53ea\u53d6\u4e86\u4e34\u65f6\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u518d\u63d2\u5165\u5230\u8868 t \u4e2d\u3002\u8fd9\u65f6\uff0cRows_examined \u7684\u503c\u52a0 1\uff0c\u53d8\u6210\u4e86 5\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u5bfc\u81f4\u5728\u8868 t \u4e0a\u505a\u5168\u8868\u626b\u63cf\uff0c\u5e76\u4e14\u4f1a\u7ed9\u7d22\u5f15 c \u4e0a\u7684\u6240\u6709\u95f4\u9699\u90fd\u52a0\u4e0a\u5171\u4eab\u7684 next-key lock\u3002\u6240\u4ee5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u671f\u95f4\uff0c\u5176\u4ed6\u4e8b\u52a1\u4e0d\u80fd\u5728\u8fd9\u4e2a\u8868\u4e0a\u63d2\u5165\u6570\u636e\u3002</p> <p>\u81f3\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u4e3a\u4ec0\u4e48\u9700\u8981\u4e34\u65f6\u8868\uff0c\u539f\u56e0\u662f\u8fd9\u7c7b\u4e00\u8fb9\u904d\u5386\u6570\u636e\uff0c\u4e00\u8fb9\u66f4\u65b0\u6570\u636e\u7684\u60c5\u51b5\uff0c\u5982\u679c\u8bfb\u51fa\u6765\u7684\u6570\u636e\u76f4\u63a5\u5199\u56de\u539f\u8868\uff0c\u5c31\u53ef\u80fd\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u8bfb\u5230\u521a\u521a\u63d2\u5165\u7684\u8bb0\u5f55\uff0c\u65b0\u63d2\u5165\u7684\u8bb0\u5f55\u5982\u679c\u53c2\u4e0e\u8ba1\u7b97\u903b\u8f91\uff0c\u5c31\u8ddf\u8bed\u4e49\u4e0d\u7b26\u3002</p> <p>\u7531\u4e8e\u5b9e\u73b0\u4e0a\u8fd9\u4e2a\u8bed\u53e5\u6ca1\u6709\u5728\u5b50\u67e5\u8be2\u4e2d\u5c31\u76f4\u63a5\u4f7f\u7528 limit 1\uff0c\u4ece\u800c\u5bfc\u81f4\u4e86\u8fd9\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u9700\u8981\u904d\u5386\u6574\u4e2a\u8868 t\u3002\u5b83\u7684\u4f18\u5316\u65b9\u6cd5\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u662f\u7528\u524d\u9762\u4ecb\u7ecd\u7684\u65b9\u6cd5\uff0c\u5148 insert into \u5230\u4e34\u65f6\u8868 temp_t\uff0c\u8fd9\u6837\u5c31\u53ea\u9700\u8981\u626b\u63cf\u4e00\u884c\uff1b\u7136\u540e\u518d\u4ece\u8868 temp_t \u91cc\u9762\u53d6\u51fa\u8fd9\u884c\u6570\u636e\u63d2\u5165\u8868 t1\u3002</p> <p>\u5f53\u7136\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u6d89\u53ca\u7684\u6570\u636e\u91cf\u5f88\u5c0f\uff0c\u4f60\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u6765\u505a\u8fd9\u4e2a\u4f18\u5316\u3002\u4f7f\u7528\u5185\u5b58\u4e34\u65f6\u8868\u4f18\u5316\u65f6\uff0c\u8bed\u53e5\u5e8f\u5217\u7684\u5199\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>create temporary table temp_t(c int,d int) engine=memory;\ninsert into temp_t  (select c+1, d from t force index(c) order by c desc limit 1);\ninsert into t select * from temp_t;\ndrop table temp_t;\n</code></pre>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_1","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u51e0\u79cd\u7279\u6b8a\u60c5\u51b5\u4e0b\u7684 insert \u8bed\u53e5\u3002</p> <p>insert \u2026 select \u662f\u5f88\u5e38\u89c1\u7684\u5728\u4e24\u4e2a\u8868\u4e4b\u95f4\u62f7\u8d1d\u6570\u636e\u7684\u65b9\u6cd5\u3002\u4f60\u9700\u8981\u6ce8\u610f\uff0c\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u8bed\u53e5\u4f1a\u7ed9 select \u7684\u8868\u91cc\u626b\u63cf\u5230\u7684\u8bb0\u5f55\u548c\u95f4\u9699\u52a0\u8bfb\u9501\u3002</p> <p>\u800c\u5982\u679c insert \u548c select \u7684\u5bf9\u8c61\u662f\u540c\u4e00\u4e2a\u8868\uff0c\u5219\u6709\u53ef\u80fd\u4f1a\u9020\u6210\u5faa\u73af\u5199\u5165\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u5f15\u5165\u7528\u6237\u4e34\u65f6\u8868\u6765\u505a\u4f18\u5316\u3002</p> <p>insert \u8bed\u53e5\u5982\u679c\u51fa\u73b0\u552f\u4e00\u952e\u51b2\u7a81\uff0c\u4f1a\u5728\u51b2\u7a81\u7684\u552f\u4e00\u503c\u4e0a\u52a0\u5171\u4eab\u7684 next-key lock(S \u9501)\u3002\u56e0\u6b64\uff0c\u78b0\u5230\u7531\u4e8e\u552f\u4e00\u952e\u7ea6\u675f\u5bfc\u81f4\u62a5\u9519\u540e\uff0c\u8981\u5c3d\u5feb\u63d0\u4ea4\u6216\u56de\u6eda\u4e8b\u52a1\uff0c\u907f\u514d\u52a0\u9501\u65f6\u95f4\u8fc7\u957f\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#41","title":"41 \u600e\u4e48\u6700\u5feb\u5730\u590d\u5236\u4e00\u5f20\u8868\uff1f","text":"<p>\u6211\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u6700\u540e\uff0c\u7ed9\u4f60\u7559\u4e0b\u7684\u95ee\u9898\u662f\u600e\u4e48\u5728\u4e24\u5f20\u8868\u4e2d\u62f7\u8d1d\u6570\u636e\u3002\u5982\u679c\u53ef\u4ee5\u63a7\u5236\u5bf9\u6e90\u8868\u7684\u626b\u63cf\u884c\u6570\u548c\u52a0\u9501\u8303\u56f4\u5f88\u5c0f\u7684\u8bdd\uff0c\u6211\u4eec\u7b80\u5355\u5730\u4f7f\u7528 <code>insert \u2026 select</code> \u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u3002</p> <p>\u5f53\u7136\uff0c\u4e3a\u4e86\u907f\u514d\u5bf9\u6e90\u8868\u52a0\u8bfb\u9501\uff0c\u66f4\u7a33\u59a5\u7684\u65b9\u6848\u662f\u5148\u5c06\u6570\u636e\u5199\u5230\u5916\u90e8\u6587\u672c\u6587\u4ef6\uff0c\u7136\u540e\u518d\u5199\u56de\u76ee\u6807\u8868\u3002\u8fd9\u65f6\uff0c\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u6cd5\u3002\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\uff0c\u6211\u4f1a\u548c\u4f60\u8be6\u7ec6\u5c55\u5f00\u4e00\u4e0b\u8fd9\u4e24\u79cd\u65b9\u6cd5\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u8fd8\u662f\u5148\u521b\u5efa\u4e00\u4e2a\u8868 db1.t\uff0c\u5e76\u63d2\u5165 1000 \u884c\u6570\u636e\uff0c\u540c\u65f6\u521b\u5efa\u4e00\u4e2a\u76f8\u540c\u7ed3\u6784\u7684\u8868 db2.t\u3002</p> <pre><code>create database db1;\nuse db1; \ncreate table t(id int primary key, a int, b int, index(a))engine=innodb;\ndelimiter ;;\n  create procedure idata()\n  begin\n    declare i int;\n    set i=1;\n    while(i&lt;=1000)do\n      insert into t values(i,i,i);\n      set i=i+1;\n    end while;\n  end;;\ndelimiter ;\ncall idata(); \ncreate database db2;\ncreate table db2.t like db1.t\n</code></pre> <p>\u5047\u8bbe\uff0c\u6211\u4eec\u8981\u628a db1.t \u91cc\u9762 a&gt;900 \u7684\u6570\u636e\u884c\u5bfc\u51fa\u6765\uff0c\u63d2\u5165\u5230 db2.t \u4e2d\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#mysqldump","title":"mysqldump \u65b9\u6cd5","text":"<p>\u4e00\u79cd\u65b9\u6cd5\u662f\uff0c\u4f7f\u7528 mysqldump \u547d\u4ee4\u5c06\u6570\u636e\u5bfc\u51fa\u6210\u4e00\u7ec4 INSERT \u8bed\u53e5\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ mysqldump -h$host -P$port -u$user --add-locks=0 --no-create-info --single-transaction  \\\n  --set-gtid-purged=OFF db1 t --where=\"a&gt;900\" --result-file=/tmp/t.sql\n</code></pre> <p>\u628a\u7ed3\u679c\u8f93\u51fa\u5230\u4e34\u65f6\u6587\u4ef6\u3002</p> <p>\u8fd9\u6761\u547d\u4ee4\u4e2d\uff0c\u4e3b\u8981\u53c2\u6570\u542b\u4e49\u5982\u4e0b\uff1a</p> <ol> <li><code>\u2013-single-transaction</code> \u7684\u4f5c\u7528\u662f\uff0c\u5728\u5bfc\u51fa\u6570\u636e\u7684\u65f6\u5019\u4e0d\u9700\u8981\u5bf9\u8868 db1.t \u52a0\u8868\u9501\uff0c\u800c\u662f\u4f7f\u7528 START TRANSACTION WITH CONSISTENT SNAPSHOT \u7684\u65b9\u6cd5\uff1b</li> <li><code>\u2013-add-locks</code> \u8bbe\u7f6e\u4e3a 0\uff0c\u8868\u793a\u5728\u8f93\u51fa\u7684\u6587\u4ef6\u7ed3\u679c\u91cc\uff0c\u4e0d\u589e\u52a0 <code>LOCK TABLES t WRITE;</code> \uff1b</li> <li><code>\u2013-no-create-info</code> \u7684\u610f\u601d\u662f\uff0c\u4e0d\u9700\u8981\u5bfc\u51fa\u8868\u7ed3\u6784\uff1b</li> <li><code>-\u2013set-gtid-purged=off</code> \u8868\u793a\u7684\u662f\uff0c\u4e0d\u8f93\u51fa\u8ddf GTID \u76f8\u5173\u7684\u4fe1\u606f\uff1b</li> <li><code>-\u2013result-file</code> \u6307\u5b9a\u4e86\u8f93\u51fa\u6587\u4ef6\u7684\u8def\u5f84\u3002</li> </ol> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u4e00\u6761 INSERT \u8bed\u53e5\u91cc\u9762\u4f1a\u5305\u542b\u591a\u4e2a value \u5bf9\uff0c\u8fd9\u662f\u4e3a\u4e86\u540e\u7eed\u7528\u8fd9\u4e2a\u6587\u4ef6\u6765\u5199\u5165\u6570\u636e\u7684\u65f6\u5019\uff0c\u6267\u884c\u901f\u5ea6\u53ef\u4ee5\u66f4\u5feb\u3002</p> <p>\u5982\u679c\u4f60\u5e0c\u671b\u751f\u6210\u7684\u6587\u4ef6\u4e2d\u4e00\u6761 INSERT \u8bed\u53e5\u53ea\u63d2\u5165\u4e00\u884c\u6570\u636e\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728\u6267\u884c mysqldump \u547d\u4ee4\u65f6\uff0c\u52a0\u4e0a\u53c2\u6570 <code>\u2013-skip-extended-insert</code>\u3002</p> <p>\u7136\u540e\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff0c\u5c06\u8fd9\u4e9b INSERT \u8bed\u53e5\u653e\u5230 db2 \u5e93\u91cc\u53bb\u6267\u884c\u3002</p> <pre><code>mysql -h127.0.0.1 -P13000  -uroot db2 -e \"source /client_tmp/t.sql\"\n</code></pre> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0csource \u5e76\u4e0d\u662f\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u800c\u662f\u4e00\u4e2a\u5ba2\u6237\u7aef\u547d\u4ee4\u3002mysql \u5ba2\u6237\u7aef\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u6253\u5f00\u6587\u4ef6\uff0c\u9ed8\u8ba4\u4ee5\u5206\u53f7\u4e3a\u7ed3\u5c3e\u8bfb\u53d6\u4e00\u6761\u6761\u7684 SQL \u8bed\u53e5\uff1b</li> <li>\u5c06 SQL \u8bed\u53e5\u53d1\u9001\u5230\u670d\u52a1\u7aef\u6267\u884c\u3002</li> </ol> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u670d\u52a1\u7aef\u6267\u884c\u7684\u5e76\u4e0d\u662f\u8fd9\u4e2a <code>source t.sql</code> \u8bed\u53e5\uff0c\u800c\u662f INSERT \u8bed\u53e5\u3002\u6240\u4ee5\uff0c\u4e0d\u8bba\u662f\u5728\u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow log\uff09\uff0c\u8fd8\u662f\u5728 binlog\uff0c\u8bb0\u5f55\u7684\u90fd\u662f\u8fd9\u4e9b\u8981\u88ab\u771f\u6b63\u6267\u884c\u7684 INSERT \u8bed\u53e5\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#csv","title":"\u5bfc\u51fa CSV \u6587\u4ef6","text":"<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u76f4\u63a5\u5c06\u7ed3\u679c\u5bfc\u51fa\u6210.csv \u6587\u4ef6\u3002MySQL \u63d0\u4f9b\u4e86\u4e0b\u9762\u7684\u8bed\u6cd5\uff0c\u7528\u6765\u5c06\u67e5\u8be2\u7ed3\u679c\u5bfc\u51fa\u5230\u670d\u52a1\u7aef\u672c\u5730\u76ee\u5f55\uff1a</p> <pre><code>mysql&gt; select * from db1.t where a&gt;900 into outfile '/server_tmp/t.csv';\n</code></pre> <p>\u6211\u4eec\u5728\u4f7f\u7528\u8fd9\u6761\u8bed\u53e5\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u5982\u4e0b\u51e0\u70b9\u3002</p> <ol> <li>\u8fd9\u6761\u8bed\u53e5\u4f1a\u5c06\u7ed3\u679c\u4fdd\u5b58\u5728\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6267\u884c\u547d\u4ee4\u7684\u5ba2\u6237\u7aef\u548c MySQL \u670d\u52a1\u7aef\u4e0d\u5728\u540c\u4e00\u4e2a\u673a\u5668\u4e0a\uff0c\u5ba2\u6237\u7aef\u673a\u5668\u7684\u4e34\u65f6\u76ee\u5f55\u4e0b\u662f\u4e0d\u4f1a\u751f\u6210 t.csv \u6587\u4ef6\u7684\u3002</li> <li>into outfile \u6307\u5b9a\u4e86\u6587\u4ef6\u7684\u751f\u6210\u4f4d\u7f6e\uff08<code>/server_tmp/</code>\uff09\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5fc5\u987b\u53d7\u53c2\u6570 <code>secure_file_priv</code> \u7684\u9650\u5236\u3002\u53c2\u6570 <code>secure_file_priv</code> \u7684\u53ef\u9009\u503c\u548c\u4f5c\u7528\u5206\u522b\u662f\uff1a </li> <li>\u5982\u679c\u8bbe\u7f6e\u4e3a empty\uff0c\u8868\u793a\u4e0d\u9650\u5236\u6587\u4ef6\u751f\u6210\u7684\u4f4d\u7f6e\uff0c\u8fd9\u662f\u4e0d\u5b89\u5168\u7684\u8bbe\u7f6e\uff1b</li> <li>\u5982\u679c\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8868\u793a\u8def\u5f84\u7684\u5b57\u7b26\u4e32\uff0c\u5c31\u8981\u6c42\u751f\u6210\u7684\u6587\u4ef6\u53ea\u80fd\u653e\u5728\u8fd9\u4e2a\u6307\u5b9a\u7684\u76ee\u5f55\uff0c\u6216\u8005\u5b83\u7684\u5b50\u76ee\u5f55\uff1b</li> <li>\u5982\u679c\u8bbe\u7f6e\u4e3a NULL\uff0c\u5c31\u8868\u793a\u7981\u6b62\u5728\u8fd9\u4e2a MySQL \u5b9e\u4f8b\u4e0a\u6267\u884c <code>select \u2026 into outfile</code> \u64cd\u4f5c\u3002</li> <li>\u8fd9\u6761\u547d\u4ee4\u4e0d\u4f1a\u5e2e\u4f60\u8986\u76d6\u6587\u4ef6\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u786e\u4fdd <code>/server_tmp/t.csv</code> \u8fd9\u4e2a\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5426\u5219\u6267\u884c\u8bed\u53e5\u65f6\u5c31\u4f1a\u56e0\u4e3a\u6709\u540c\u540d\u6587\u4ef6\u7684\u5b58\u5728\u800c\u62a5\u9519\u3002</li> <li>\u8fd9\u6761\u547d\u4ee4\u751f\u6210\u7684\u6587\u672c\u6587\u4ef6\u4e2d\uff0c\u539f\u5219\u4e0a\u4e00\u4e2a\u6570\u636e\u884c\u5bf9\u5e94\u6587\u672c\u6587\u4ef6\u7684\u4e00\u884c\u3002\u4f46\u662f\uff0c\u5982\u679c\u5b57\u6bb5\u4e2d\u5305\u542b\u6362\u884c\u7b26\uff0c\u5728\u751f\u6210\u7684\u6587\u672c\u4e2d\u4e5f\u4f1a\u6709\u6362\u884c\u7b26\u3002\u4e0d\u8fc7\u7c7b\u4f3c\u6362\u884c\u7b26\u3001\u5236\u8868\u7b26\u8fd9\u7c7b\u7b26\u53f7\uff0c\u524d\u9762\u90fd\u4f1a\u8ddf\u4e0a <code>\u201c\\\u201d</code>\u8fd9\u4e2a\u8f6c\u4e49\u7b26\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u8ddf\u5b57\u6bb5\u4e4b\u95f4\u3001\u6570\u636e\u884c\u4e4b\u95f4\u7684\u5206\u9694\u7b26\u533a\u5206\u5f00\u3002</li> </ol> <p>\u5f97\u5230.csv \u5bfc\u51fa\u6587\u4ef6\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u7528\u4e0b\u9762\u7684 load data \u547d\u4ee4\u5c06\u6570\u636e\u5bfc\u5165\u5230\u76ee\u6807\u8868 db2.t \u4e2d\u3002</p> <pre><code>mysql&gt; load data infile '/server_tmp/t.csv' into table db2.t;\n</code></pre> <p>\u8fd9\u6761\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\u3002</p> <ol> <li>\u6253\u5f00\u6587\u4ef6 <code>/server_tmp/t.csv</code>\uff0c\u4ee5\u5236\u8868\u7b26 ( <code>\\t</code>) \u4f5c\u4e3a\u5b57\u6bb5\u95f4\u7684\u5206\u9694\u7b26\uff0c\u4ee5\u6362\u884c\u7b26\uff08 <code>\\n</code>\uff09\u4f5c\u4e3a\u8bb0\u5f55\u4e4b\u95f4\u7684\u5206\u9694\u7b26\uff0c\u8fdb\u884c\u6570\u636e\u8bfb\u53d6\uff1b</li> <li>\u542f\u52a8\u4e8b\u52a1\u3002</li> <li>\u5224\u65ad\u6bcf\u4e00\u884c\u7684\u5b57\u6bb5\u6570\u4e0e\u8868 db2.t \u662f\u5426\u76f8\u540c\uff1a </li> <li>\u82e5\u4e0d\u76f8\u540c\uff0c\u5219\u76f4\u63a5\u62a5\u9519\uff0c\u4e8b\u52a1\u56de\u6eda\uff1b</li> <li>\u82e5\u76f8\u540c\uff0c\u5219\u6784\u9020\u6210\u4e00\u884c\uff0c\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\uff0c\u5199\u5165\u5230\u8868\u4e2d\u3002</li> <li>\u91cd\u590d\u6b65\u9aa4 3\uff0c\u76f4\u5230 <code>/server_tmp/t.csv</code> \u6574\u4e2a\u6587\u4ef6\u8bfb\u5165\u5b8c\u6210\uff0c\u63d0\u4ea4\u4e8b\u52a1\u3002</li> </ol> <p>\u4f60\u53ef\u80fd\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u5982\u679c binlog_format=statement\uff0c\u8fd9\u4e2a load \u8bed\u53e5\u8bb0\u5f55\u5230 binlog \u91cc\u4ee5\u540e\uff0c\u600e\u4e48\u5728\u5907\u5e93\u91cd\u653e\u5462\uff1f</p> <p>\u7531\u4e8e <code>/server_tmp/t.csv</code> \u6587\u4ef6\u53ea\u4fdd\u5b58\u5728\u4e3b\u5e93\u6240\u5728\u7684\u4e3b\u673a\u4e0a\uff0c\u5982\u679c\u53ea\u662f\u628a\u8fd9\u6761\u8bed\u53e5\u539f\u6587\u5199\u5230 binlog \u4e2d\uff0c\u5728\u5907\u5e93\u6267\u884c\u7684\u65f6\u5019\uff0c\u5907\u5e93\u7684\u672c\u5730\u673a\u5668\u4e0a\u6ca1\u6709\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c31\u4f1a\u5bfc\u81f4\u4e3b\u5907\u540c\u6b65\u505c\u6b62\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u6761\u8bed\u53e5\u6267\u884c\u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u5176\u5b9e\u662f\u4e0b\u9762\u8fd9\u6837\u7684\u3002</p> <ol> <li>\u4e3b\u5e93\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5c06 <code>/server_tmp/t.csv</code> \u6587\u4ef6\u7684\u5185\u5bb9\u76f4\u63a5\u5199\u5230 binlog \u6587\u4ef6\u4e2d\u3002</li> <li>\u5f80 binlog \u6587\u4ef6\u4e2d\u5199\u5165\u8bed\u53e5 <code>load data local infile '/tmp/SQL_LOAD_MB-1-0' INTO TABLE db2.t</code>\u3002</li> <li>\u628a\u8fd9\u4e2a binlog \u65e5\u5fd7\u4f20\u5230\u5907\u5e93\u3002</li> <li>\u5907\u5e93\u7684 apply \u7ebf\u7a0b\u5728\u6267\u884c\u8fd9\u4e2a\u4e8b\u52a1\u65e5\u5fd7\u65f6\uff1a </li> <li>\u5148\u5c06 binlog \u4e2d t.csv \u6587\u4ef6\u7684\u5185\u5bb9\u8bfb\u51fa\u6765\uff0c\u5199\u5165\u5230\u672c\u5730\u4e34\u65f6\u76ee\u5f55 <code>/tmp/SQL_LOAD_MB-1-0</code>\u4e2d\uff1b </li> <li>\u518d\u6267\u884c load data \u8bed\u53e5\uff0c\u5f80\u5907\u5e93\u7684 db2.t \u8868\u4e2d\u63d2\u5165\u8ddf\u4e3b\u5e93\u76f8\u540c\u7684\u6570\u636e\u3002</li> </ol> <p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u5907\u5e93\u6267\u884c\u7684 load data \u8bed\u53e5\u91cc\u9762\uff0c\u591a\u4e86\u4e00\u4e2a <code>local</code>\u3002\u5b83\u7684\u610f\u601d\u662f\u201c\u5c06\u6267\u884c\u8fd9\u6761\u547d\u4ee4\u7684\u5ba2\u6237\u7aef\u6240\u5728\u673a\u5668\u7684\u672c\u5730\u6587\u4ef6 <code>/tmp/SQL_LOAD_MB-1-0</code> \u7684\u5185\u5bb9\uff0c\u52a0\u8f7d\u5230\u76ee\u6807\u8868 db2.t \u4e2d\u201d\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cload data \u547d\u4ee4\u6709\u4e24\u79cd\u7528\u6cd5\uff1a</p> <ol> <li>\u4e0d\u52a0 <code>local</code>\uff0c\u662f\u8bfb\u53d6\u670d\u52a1\u7aef\u7684\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6587\u4ef6\u5fc5\u987b\u5728 <code>secure_file_priv</code> \u6307\u5b9a\u7684\u76ee\u5f55\u6216\u5b50\u76ee\u5f55\u4e0b\uff1b</li> <li>\u52a0\u4e0a <code>local</code>\uff0c\u8bfb\u53d6\u7684\u662f\u5ba2\u6237\u7aef\u7684\u6587\u4ef6\uff0c\u53ea\u8981 mysql \u5ba2\u6237\u7aef\u6709\u8bbf\u95ee\u8fd9\u4e2a\u6587\u4ef6\u7684\u6743\u9650\u5373\u53ef\u3002\u8fd9\u65f6\u5019\uff0cMySQL \u5ba2\u6237\u7aef\u4f1a\u5148\u628a\u672c\u5730\u6587\u4ef6\u4f20\u7ed9\u670d\u52a1\u7aef\uff0c\u7136\u540e\u6267\u884c\u4e0a\u8ff0\u7684 load data \u6d41\u7a0b\u3002</li> </ol> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cselect \u2026into outfile \u65b9\u6cd5\u4e0d\u4f1a\u751f\u6210\u8868\u7ed3\u6784\u6587\u4ef6, \u6240\u4ee5\u6211\u4eec\u5bfc\u6570\u636e\u65f6\u8fd8\u9700\u8981\u5355\u72ec\u7684\u547d\u4ee4\u5f97\u5230\u8868\u7ed3\u6784\u5b9a\u4e49\u3002mysqldump \u63d0\u4f9b\u4e86\u4e00\u4e2a<code>-\u2013tab</code> \u53c2\u6570\uff0c\u53ef\u4ee5\u540c\u65f6\u5bfc\u51fa\u8868\u7ed3\u6784\u5b9a\u4e49\u6587\u4ef6\u548c csv \u6570\u636e\u6587\u4ef6\u3002\u8fd9\u6761\u547d\u4ee4\u7684\u4f7f\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>mysqldump -h$host -P$port -u$user ---single-transaction  --set-gtid-purged=OFF db1 t --where=\"a&gt;900\" --tab=$secure_file_priv\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u4f1a\u5728 <code>$secure_file_priv</code> \u5b9a\u4e49\u7684\u76ee\u5f55\u4e0b\uff0c\u521b\u5efa\u4e00\u4e2a <code>t.sql</code> \u6587\u4ef6\u4fdd\u5b58\u5efa\u8868\u8bed\u53e5\uff0c\u540c\u65f6\u521b\u5efa\u4e00\u4e2a <code>t.txt</code> \u6587\u4ef6\u4fdd\u5b58 CSV \u6570\u636e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_2","title":"\u7269\u7406\u62f7\u8d1d\u65b9\u6cd5","text":"<p>\u524d\u9762\u6211\u4eec\u63d0\u5230\u7684 mysqldump \u65b9\u6cd5\u548c\u5bfc\u51fa CSV \u6587\u4ef6\u7684\u65b9\u6cd5\uff0c\u90fd\u662f\u903b\u8f91\u5bfc\u6570\u636e\u7684\u65b9\u6cd5\uff0c\u4e5f\u5c31\u662f\u5c06\u6570\u636e\u4ece\u8868 db1.t \u4e2d\u8bfb\u51fa\u6765\uff0c\u751f\u6210\u6587\u672c\uff0c\u7136\u540e\u518d\u5199\u5165\u76ee\u6807\u8868 db2.t \u4e2d\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u6709\u7269\u7406\u5bfc\u6570\u636e\u7684\u65b9\u6cd5\u5417\uff1f\u6bd4\u5982\uff0c\u76f4\u63a5\u628a db1.t \u8868\u7684 <code>.frm</code> \u6587\u4ef6\u548c <code>.ibd</code> \u6587\u4ef6\u62f7\u8d1d\u5230 db2 \u76ee\u5f55\u4e0b\uff0c\u662f\u5426\u53ef\u884c\u5462\uff1f</p> <p>\u7b54\u6848\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u56e0\u4e3a\uff0c\u4e00\u4e2a InnoDB \u8868\uff0c\u9664\u4e86\u5305\u542b\u8fd9\u4e24\u4e2a\u7269\u7406\u6587\u4ef6\u5916\uff0c\u8fd8\u9700\u8981\u5728\u6570\u636e\u5b57\u5178\u4e2d\u6ce8\u518c\u3002\u76f4\u63a5\u62f7\u8d1d\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684\u8bdd\uff0c\u56e0\u4e3a\u6570\u636e\u5b57\u5178\u4e2d\u6ca1\u6709 db2.t \u8fd9\u4e2a\u8868\uff0c\u7cfb\u7edf\u662f\u4e0d\u4f1a\u8bc6\u522b\u548c\u63a5\u53d7\u5b83\u4eec\u7684\u3002</p> <p>\u4e0d\u8fc7\uff0c\u5728 MySQL 5.6 \u7248\u672c\u5f15\u5165\u4e86**\u53ef\u4f20\u8f93\u8868\u7a7a\u95f4**(transportable tablespace) \u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u901a\u8fc7\u5bfc\u51fa + \u5bfc\u5165\u8868\u7a7a\u95f4\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u7269\u7406\u62f7\u8d1d\u8868\u7684\u529f\u80fd\u3002</p> <p>\u5047\u8bbe\u6211\u4eec\u73b0\u5728\u7684\u76ee\u6807\u662f\u5728 db1 \u5e93\u4e0b\uff0c\u590d\u5236\u4e00\u4e2a\u8ddf\u8868 t \u76f8\u540c\u7684\u8868 r\uff0c\u5177\u4f53\u7684\u6267\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u6267\u884c <code>create table r like t</code>\uff0c\u521b\u5efa\u4e00\u4e2a\u76f8\u540c\u8868\u7ed3\u6784\u7684\u7a7a\u8868\uff1b</li> <li>\u6267\u884c <code>alter table r discard tablespace</code>\uff0c\u8fd9\u65f6\u5019 r.ibd \u6587\u4ef6\u4f1a\u88ab\u5220\u9664\uff1b</li> <li>\u6267\u884c <code>flush table t for export</code>\uff0c\u8fd9\u65f6\u5019 db1 \u76ee\u5f55\u4e0b\u4f1a\u751f\u6210\u4e00\u4e2a t.cfg \u6587\u4ef6\uff1b</li> <li>\u5728 db1 \u76ee\u5f55\u4e0b\u6267\u884c <code>cp t.cfg r.cfg; cp t.ibd r.ibd\uff1b</code>\u8fd9\u4e24\u4e2a\u547d\u4ee4\uff08\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u62f7\u8d1d\u5f97\u5230\u7684\u4e24\u4e2a\u6587\u4ef6\uff0cMySQL \u8fdb\u7a0b\u8981\u6709\u8bfb\u5199\u6743\u9650\uff09\uff1b</li> <li>\u6267\u884c <code>unlock tables</code>\uff0c\u8fd9\u65f6\u5019 t.cfg \u6587\u4ef6\u4f1a\u88ab\u5220\u9664\uff1b</li> <li>\u6267\u884c <code>alter table r import tablespace</code>\uff0c\u5c06\u8fd9\u4e2a <code>r.ibd</code> \u6587\u4ef6\u4f5c\u4e3a\u8868 r \u7684\u65b0\u7684\u8868\u7a7a\u95f4\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6587\u4ef6\u7684\u6570\u636e\u5185\u5bb9\u548c t.ibd \u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u8868 r \u4e2d\u5c31\u6709\u4e86\u548c\u8868 t \u76f8\u540c\u7684\u6570\u636e\u3002</li> </ol> <p>\u81f3\u6b64\uff0c\u62f7\u8d1d\u8868\u6570\u636e\u7684\u64cd\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002\u8fd9\u4e2a\u6d41\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u56fe\u5982\u4e0b\uff1a</p> <p>\u5173\u4e8e\u62f7\u8d1d\u8868\u7684\u8fd9\u4e2a\u6d41\u7a0b\uff0c\u6709\u4ee5\u4e0b\u51e0\u4e2a\u6ce8\u610f\u70b9\uff1a</p> <ol> <li>\u5728\u7b2c 3 \u6b65\u6267\u884c\u5b8c <code>flsuh table</code> \u547d\u4ee4\u4e4b\u540e\uff0c<code>db1.t</code> \u6574\u4e2a\u8868\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\uff0c\u76f4\u5230\u6267\u884c <code>unlock tables</code> \u547d\u4ee4\u540e\u624d\u91ca\u653e\u8bfb\u9501\uff1b</li> <li>\u5728\u6267\u884c <code>import tablespace</code> \u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u8ba9\u6587\u4ef6\u91cc\u7684\u8868\u7a7a\u95f4 id \u548c\u6570\u636e\u5b57\u5178\u4e2d\u7684\u4e00\u81f4\uff0c\u4f1a\u4fee\u6539 r.ibd \u7684\u8868\u7a7a\u95f4 id\u3002\u800c\u8fd9\u4e2a\u8868\u7a7a\u95f4 id \u5b58\u5728\u4e8e\u6bcf\u4e00\u4e2a\u6570\u636e\u9875\u4e2d\u3002\u56e0\u6b64\uff0c\u5982\u679c\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u6587\u4ef6\uff08\u6bd4\u5982 TB \u7ea7\u522b\uff09\uff0c\u6bcf\u4e2a\u6570\u636e\u9875\u90fd\u9700\u8981\u4fee\u6539\uff0c\u6240\u4ee5\u4f60\u4f1a\u770b\u5230\u8fd9\u4e2a import \u8bed\u53e5\u7684\u6267\u884c\u662f\u9700\u8981\u4e00\u4e9b\u65f6\u95f4\u7684\u3002\u5f53\u7136\uff0c\u5982\u679c\u662f\u76f8\u6bd4\u4e8e\u903b\u8f91\u5bfc\u5165\u7684\u65b9\u6cd5\uff0cimport \u8bed\u53e5\u7684\u8017\u65f6\u662f\u975e\u5e38\u77ed\u7684\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_3","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86\u4e09\u79cd\u5c06\u4e00\u4e2a\u8868\u7684\u6570\u636e\u5bfc\u5165\u5230\u53e6\u5916\u4e00\u4e2a\u8868\u4e2d\u7684\u65b9\u6cd5\u3002</p> <p>\u6211\u4eec\u6765\u5bf9\u6bd4\u4e00\u4e0b\u8fd9\u4e09\u79cd\u65b9\u6cd5\u7684\u4f18\u7f3a\u70b9\u3002</p> <ol> <li>\u7269\u7406\u62f7\u8d1d\u7684\u65b9\u5f0f\u901f\u5ea6\u6700\u5feb\uff0c\u5c24\u5176\u5bf9\u4e8e\u5927\u8868\u62f7\u8d1d\u6765\u8bf4\u662f\u6700\u5feb\u7684\u65b9\u6cd5\u3002\u5982\u679c\u51fa\u73b0\u8bef\u5220\u8868\u7684\u60c5\u51b5\uff0c\u7528\u5907\u4efd\u6062\u590d\u51fa\u8bef\u5220\u4e4b\u524d\u7684\u4e34\u65f6\u5e93\uff0c\u7136\u540e\u518d\u628a\u4e34\u65f6\u5e93\u4e2d\u7684\u8868\u62f7\u8d1d\u5230\u751f\u4ea7\u5e93\u4e0a\uff0c\u662f\u6062\u590d\u6570\u636e\u6700\u5feb\u7684\u65b9\u6cd5\u3002\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7684\u4f7f\u7528\u4e5f\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\uff1a </li> <li>\u5fc5\u987b\u662f\u5168\u8868\u62f7\u8d1d\uff0c\u4e0d\u80fd\u53ea\u62f7\u8d1d\u90e8\u5206\u6570\u636e\uff1b</li> <li>\u9700\u8981\u5230\u670d\u52a1\u5668\u4e0a\u62f7\u8d1d\u6570\u636e\uff0c\u5728\u7528\u6237\u65e0\u6cd5\u767b\u5f55\u6570\u636e\u5e93\u4e3b\u673a\u7684\u573a\u666f\u4e0b\u65e0\u6cd5\u4f7f\u7528\uff1b</li> <li>\u7531\u4e8e\u662f\u901a\u8fc7\u62f7\u8d1d\u7269\u7406\u6587\u4ef6\u5b9e\u73b0\u7684\uff0c\u6e90\u8868\u548c\u76ee\u6807\u8868\u90fd\u662f\u4f7f\u7528 InnoDB \u5f15\u64ce\u65f6\u624d\u80fd\u4f7f\u7528\u3002</li> <li>\u7528 mysqldump \u751f\u6210\u5305\u542b INSERT \u8bed\u53e5\u6587\u4ef6\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728 where \u53c2\u6570\u589e\u52a0\u8fc7\u6ee4\u6761\u4ef6\uff0c\u6765\u5b9e\u73b0\u53ea\u5bfc\u51fa\u90e8\u5206\u6570\u636e\u3002\u8fd9\u4e2a\u65b9\u5f0f\u7684\u4e0d\u8db3\u4e4b\u4e00\u662f\uff0c\u4e0d\u80fd\u4f7f\u7528 join \u8fd9\u79cd\u6bd4\u8f83\u590d\u6742\u7684 where \u6761\u4ef6\u5199\u6cd5\u3002</li> <li>\u7528 <code>select \u2026 into outfile</code> \u7684\u65b9\u6cd5\u662f\u6700\u7075\u6d3b\u7684\uff0c\u652f\u6301\u6240\u6709\u7684 SQL \u5199\u6cd5\u3002\u4f46\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u7f3a\u70b9\u4e4b\u4e00\u5c31\u662f\uff0c\u6bcf\u6b21\u53ea\u80fd\u5bfc\u51fa\u4e00\u5f20\u8868\u7684\u6570\u636e\uff0c\u800c\u4e14\u8868\u7ed3\u6784\u4e5f\u9700\u8981\u53e6\u5916\u7684\u8bed\u53e5\u5355\u72ec\u5907\u4efd\u3002</li> </ol> <p>\u540e\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u903b\u8f91\u5907\u4efd\u65b9\u5f0f\uff0c\u662f\u53ef\u4ee5\u8de8\u5f15\u64ce\u4f7f\u7528\u7684\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#42-grantflush-privileges","title":"42 grant\u4e4b\u540e\u8981\u8ddf\u7740flush privileges\u5417\uff1f","text":"<p>\u5728 MySQL \u91cc\u9762\uff0cgrant \u8bed\u53e5\u662f\u7528\u6765\u7ed9\u7528\u6237\u8d4b\u6743\u7684\u3002\u4e0d\u77e5\u9053\u4f60\u6709\u6ca1\u6709\u89c1\u8fc7\u4e00\u4e9b\u64cd\u4f5c\u6587\u6863\u91cc\u9762\u63d0\u5230\uff0cgrant \u4e4b\u540e\u8981\u9a6c\u4e0a\u8ddf\u7740\u6267\u884c\u4e00\u4e2a flush privileges \u547d\u4ee4\uff0c\u624d\u80fd\u4f7f\u8d4b\u6743\u8bed\u53e5\u751f\u6548\u3002\u6211\u6700\u5f00\u59cb\u4f7f\u7528 MySQL \u7684\u65f6\u5019\uff0c\u5c31\u662f\u7167\u7740\u4e00\u4e2a\u64cd\u4f5c\u6587\u6863\u7684\u8bf4\u660e\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\u64cd\u4f5c\u7684\u3002</p> <p>\u90a3\u4e48\uff0cgrant \u4e4b\u540e\u771f\u7684\u9700\u8981\u6267\u884c flush privileges \u5417\uff1f\u5982\u679c\u6ca1\u6709\u6267\u884c\u8fd9\u4e2a flush \u547d\u4ee4\u7684\u8bdd\uff0c\u8d4b\u6743\u8bed\u53e5\u771f\u7684\u4e0d\u80fd\u751f\u6548\u5417\uff1f</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u5148\u548c\u4f60\u4ecb\u7ecd\u4e00\u4e0b grant \u8bed\u53e5\u548c flush privileges \u8bed\u53e5\u5206\u522b\u505a\u4e86\u4ec0\u4e48\u4e8b\u60c5\uff0c\u7136\u540e\u518d\u4e00\u8d77\u6765\u5206\u6790\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u8bf4\u660e\uff0c\u6211\u5148\u521b\u5efa\u4e00\u4e2a\u7528\u6237\uff1a</p> <pre><code>create user 'ua'@'%' identified by 'pa';\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u505a\u4e86\u4e24\u4e2a\u52a8\u4f5c\uff1a</p> <ol> <li>\u78c1\u76d8\u4e0a\uff0c\u5f80 <code>mysql.user</code> \u8868\u91cc\u63d2\u5165\u4e00\u884c\uff0c\u7531\u4e8e\u6ca1\u6709\u6307\u5b9a\u6743\u9650\uff0c\u6240\u4ee5\u8fd9\u884c\u6570\u636e\u4e0a\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u662f N\uff1b</li> <li>\u5185\u5b58\u91cc\uff0c\u5f80\u6570\u7ec4 <code>acl_users</code> \u91cc\u63d2\u5165\u4e00\u4e2a <code>acl_user</code> \u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7684 access \u5b57\u6bb5\u503c\u4e3a 0\u3002</li> </ol> <p>\u56fe 1 \u5c31\u662f\u8fd9\u4e2a\u65f6\u523b\u7528\u6237 ua \u5728 user \u8868\u4e2d\u7684\u72b6\u6001\u3002</p> <pre><code>mysql&gt; select * from mysql.user where user='ua'\\G;\n*************************** 1. row ***************************\n                    Host: %\n                    User: ua\n             Select_priv: N\n             Insert_priv: N\n             Update_priv: N\n             Delete_priv: N\n             Create_priv: N\n               Drop_priv: N\n             Reload_priv: N\n           Shutdown_priv: N\n            Process_priv: N\n               File_priv: N\n              Grant_priv: N\n         References_priv: N\n              Index_priv: N\n              Alter_priv: N\n            Show_db_priv: N\n              Super_priv: N\n   Create_tmp_table_priv: N\n        Lock_tables_priv: N\n            Execute_priv: N\n         Repl_slave_priv: N\n        Repl_client_priv: N\n        Create_view_priv: N\n          Show_view_priv: N\n     Create_routine_priv: N\n      Alter_routine_priv: N\n        Create_user_priv: N\n              Event_priv: N\n            Trigger_priv: N\n  Create_tablespace_priv: N\n                ssl_type:\n              ssl_cipher:\n             x509_issuer:\n            x509_subject:\n           max_questions: 0\n             max_updates: 0\n         max_connections: 0\n    max_user_connections: 0\n                  plugin: caching_sha2_password\n   authentication_string: $A$005$\n%P:eJ8= )7_{P=.1QQ3BFIVgLLcQ6MWmI61WcjMGnKMpgk9RGdANON2Pn6NB\n        password_expired: N\n   password_last_changed: 2023-02-02 11:33:19\n       password_lifetime: NULL\n          account_locked: N\n        Create_role_priv: N\n          Drop_role_priv: N\n  Password_reuse_history: NULL\n     Password_reuse_time: NULL\nPassword_require_current: NULL\n         User_attributes: NULL\n</code></pre> <p>\u5728 MySQL \u4e2d\uff0c\u7528\u6237\u6743\u9650\u662f\u6709\u4e0d\u540c\u7684\u8303\u56f4\u7684\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u6309\u7167\u7528\u6237\u6743\u9650\u8303\u56f4\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u4f9d\u6b21\u548c\u4f60\u8bf4\u660e\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_4","title":"\u5168\u5c40\u6743\u9650","text":"<p>\u5168\u5c40\u6743\u9650\uff0c\u4f5c\u7528\u4e8e\u6574\u4e2a MySQL \u5b9e\u4f8b\uff0c\u8fd9\u4e9b\u6743\u9650\u4fe1\u606f\u4fdd\u5b58\u5728 mysql \u5e93\u7684 user \u8868\u91cc\u3002\u5982\u679c\u6211\u8981\u7ed9\u7528\u6237 ua \u8d4b\u4e00\u4e2a\u6700\u9ad8\u6743\u9650\u7684\u8bdd\uff0c\u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p> <pre><code>grant all privileges on *.* to 'ua'@'%' with grant option;\n</code></pre> <p>\u8fd9\u4e2a grant \u547d\u4ee4\u505a\u4e86\u4e24\u4e2a\u52a8\u4f5c\uff1a</p> <ol> <li>\u78c1\u76d8\u4e0a\uff0c\u5c06 <code>mysql.user</code> \u8868\u91cc\uff0c\u7528\u6237 <code>'ua'@'%'</code>\u8fd9\u4e00\u884c\u7684\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u4fee\u6539\u4e3a <code>Y</code>\uff1b</li> <li>\u5185\u5b58\u91cc\uff0c\u4ece\u6570\u7ec4 <code>acl_users</code> \u4e2d\u627e\u5230\u8fd9\u4e2a\u7528\u6237\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5c06 access \u503c\uff08\u6743\u9650\u4f4d\uff09\u4fee\u6539\u4e3a\u4e8c\u8fdb\u5236\u7684\u201c\u5168 1\u201d\u3002</li> </ol> <p>\u5728\u8fd9\u4e2a grant \u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\uff0c\u5982\u679c\u6709\u65b0\u7684\u5ba2\u6237\u7aef\u4f7f\u7528\u7528\u6237\u540d ua \u767b\u5f55\u6210\u529f\uff0cMySQL \u4f1a\u4e3a\u65b0\u8fde\u63a5\u7ef4\u62a4\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u7136\u540e\u4ece <code>acl_users</code> \u6570\u7ec4\u91cc\u67e5\u5230\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\uff0c\u5e76\u5c06\u6743\u9650\u503c\u62f7\u8d1d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\u3002\u4e4b\u540e\u5728\u8fd9\u4e2a\u8fde\u63a5\u4e2d\u6267\u884c\u7684\u8bed\u53e5\uff0c\u6240\u6709\u5173\u4e8e\u5168\u5c40\u6743\u9650\u7684\u5224\u65ad\uff0c\u90fd\u76f4\u63a5\u4f7f\u7528\u7ebf\u7a0b\u5bf9\u8c61\u5185\u90e8\u4fdd\u5b58\u7684\u6743\u9650\u4f4d\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u5206\u6790\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff1a</p> <ol> <li>grant \u547d\u4ee4\u5bf9\u4e8e\u5168\u5c40\u6743\u9650\uff0c\u540c\u65f6\u66f4\u65b0\u4e86\u78c1\u76d8\u548c\u5185\u5b58\u3002\u547d\u4ee4\u5b8c\u6210\u540e\u5373\u65f6\u751f\u6548\uff0c\u63a5\u4e0b\u6765\u65b0\u521b\u5efa\u7684\u8fde\u63a5\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u3002</li> <li>\u5bf9\u4e8e\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\uff0c\u5b83\u7684\u5168\u5c40\u6743\u9650\u4e0d\u53d7 grant \u547d\u4ee4\u7684\u5f71\u54cd\u3002</li> </ol> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u4e00\u822c\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u8981\u5408\u7406\u63a7\u5236\u7528\u6237\u6743\u9650\u7684\u8303\u56f4\u3002\u6211\u4eec\u4e0a\u9762\u7528\u5230\u7684\u8fd9\u4e2a grant \u8bed\u53e5\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u9519\u8bef\u793a\u8303\u3002\u5982\u679c\u4e00\u4e2a\u7528\u6237\u6709\u6240\u6709\u6743\u9650\uff0c\u4e00\u822c\u5c31\u4e0d\u5e94\u8be5\u8bbe\u7f6e\u4e3a\u6240\u6709 IP \u5730\u5740\u90fd\u53ef\u4ee5\u8bbf\u95ee\u3002</p> <p>\u5982\u679c\u8981\u56de\u6536\u4e0a\u9762\u7684 grant \u8bed\u53e5\u8d4b\u4e88\u7684\u6743\u9650\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff1a</p> <pre><code>revoke all privileges on *.* from 'ua'@'%';\n</code></pre> <p>\u8fd9\u6761 revoke \u547d\u4ee4\u7684\u7528\u6cd5\u4e0e grant \u7c7b\u4f3c\uff0c\u505a\u4e86\u5982\u4e0b\u4e24\u4e2a\u52a8\u4f5c\uff1a</p> <ol> <li>\u78c1\u76d8\u4e0a\uff0c\u5c06 <code>mysql.user</code> \u8868\u91cc\uff0c\u7528\u6237 <code>'ua'@'%'</code> \u8fd9\u4e00\u884c\u7684\u6240\u6709\u8868\u793a\u6743\u9650\u7684\u5b57\u6bb5\u7684\u503c\u90fd\u4fee\u6539\u4e3a <code>N</code>\uff1b</li> <li>\u5185\u5b58\u91cc\uff0c\u4ece\u6570\u7ec4 acl_users \u4e2d\u627e\u5230\u8fd9\u4e2a\u7528\u6237\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5c06 access \u7684\u503c\u4fee\u6539\u4e3a 0\u3002</li> </ol>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#db","title":"db \u6743\u9650","text":"<p>\u9664\u4e86\u5168\u5c40\u6743\u9650\uff0cMySQL \u4e5f\u652f\u6301\u5e93\u7ea7\u522b\u7684\u6743\u9650\u5b9a\u4e49\u3002\u5982\u679c\u8981\u8ba9\u7528\u6237 ua \u62e5\u6709\u5e93 db1 \u7684\u6240\u6709\u6743\u9650\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff1a</p> <pre><code>grant all privileges on db1.* to 'ua'@'%' with grant option;\n</code></pre> <p>\u57fa\u4e8e\u5e93\u7684\u6743\u9650\u8bb0\u5f55\u4fdd\u5b58\u5728 mysql.db \u8868\u4e2d\uff0c\u5728\u5185\u5b58\u91cc\u5219\u4fdd\u5b58\u5728\u6570\u7ec4 acl_dbs \u4e2d\u3002\u8fd9\u6761 grant \u547d\u4ee4\u505a\u4e86\u5982\u4e0b\u4e24\u4e2a\u52a8\u4f5c\uff1a</p> <ol> <li>\u78c1\u76d8\u4e0a\uff0c\u5f80 <code>mysql.db</code> \u8868\u4e2d\u63d2\u5165\u4e86\u4e00\u884c\u8bb0\u5f55\uff0c\u6240\u6709\u6743\u9650\u4f4d\u5b57\u6bb5\u8bbe\u7f6e\u4e3a <code>Y</code>\uff1b</li> <li>\u5185\u5b58\u91cc\uff0c\u589e\u52a0\u4e00\u4e2a\u5bf9\u8c61\u5230\u6570\u7ec4 <code>acl_dbs</code> \u4e2d\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7684\u6743\u9650\u4f4d\u4e3a\u201c\u5168 1\u201d\u3002</li> </ol> <p>\u56fe 2 \u5c31\u662f\u8fd9\u4e2a\u65f6\u523b\u7528\u6237 ua \u5728 db \u8868\u4e2d\u7684\u72b6\u6001\u3002</p> <pre><code>mysql&gt; select * from mysql.db where user='ua'\\G;\n*************************** 1. row ***************************\n                 Host: %\n                   Db: db1\n                 User: ua\n          Select_priv: Y\n          Insert_priv: Y\n          Update_priv: Y\n          Delete_priv: Y\n          Create_priv: Y\n            Drop_priv: Y\n           Grant_priv: Y\n      References_priv: Y\n           Index_priv: Y\n           Alter_priv: Y\nCreate_tmp_table_priv: Y\n     Lock_tables_priv: Y\n     Create_view_priv: Y\n       Show_view_priv: Y\n  Create_routine_priv: Y\n   Alter_routine_priv: Y\n         Execute_priv: Y\n           Event_priv: Y\n         Trigger_priv: Y\n</code></pre> <p>\u6bcf\u6b21\u9700\u8981\u5224\u65ad\u4e00\u4e2a\u7528\u6237\u5bf9\u4e00\u4e2a\u6570\u636e\u5e93\u8bfb\u5199\u6743\u9650\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u904d\u5386\u4e00\u6b21 <code>acl_dbs</code> \u6570\u7ec4\uff0c\u6839\u636e user\u3001host \u548c db \u627e\u5230\u5339\u914d\u7684\u5bf9\u8c61\uff0c\u7136\u540e\u6839\u636e\u5bf9\u8c61\u7684\u6743\u9650\u4f4d\u6765\u5224\u65ad\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cgrant \u4fee\u6539 db \u6743\u9650\u7684\u65f6\u5019\uff0c\u662f\u540c\u65f6\u5bf9\u78c1\u76d8\u548c\u5185\u5b58\u751f\u6548\u7684\u3002</p> <p>grant \u64cd\u4f5c\u5bf9\u4e8e\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\u7684\u5f71\u54cd\uff0c\u5728\u5168\u5c40\u6743\u9650\u548c\u57fa\u4e8e db \u7684\u6743\u9650\u6548\u679c\u662f\u4e0d\u540c\u7684\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u505a\u4e00\u4e2a\u5bf9\u7167\u8bd5\u9a8c\u6765\u5206\u522b\u770b\u4e00\u4e0b\u3002</p> session A session B T1 connect(root, root);create databse db1;create user 'ua'@'%' identified by 'pa';grant super on *.* to 'ua'@'%';grant all privileges on db1.* to 'ua'@'%'; T2 connect(ua,pa);set global sync_binlog=1;(Query OK)create table db1.t(c int);(Query OK) T3 revoke super on . from 'ua'@'%'; T4 set global sync_binlog=1;(Query OK)alter table db1.t engine=innodb;(Query OK) T5 revoke all privileges on db1.* from 'ua'@'%'; T6 set global sync_binlog=1;(Query OK)alter table db1.t engine=innodb;(ALTER command denied) <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u56fe\u4e2d <code>set global sync_binlog</code> \u8fd9\u4e2a\u64cd\u4f5c\u662f\u9700\u8981 super \u6743\u9650\u7684\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u867d\u7136\u7528\u6237 ua \u7684 super \u6743\u9650\u5728 T3 \u65f6\u523b\u5df2\u7ecf\u901a\u8fc7 revoke \u8bed\u53e5\u56de\u6536\u4e86\uff0c\u4f46\u662f\u5728 T4 \u65f6\u523b\u6267\u884c set global \u7684\u65f6\u5019\uff0c\u6743\u9650\u9a8c\u8bc1\u8fd8\u662f\u901a\u8fc7\u4e86\u3002\u8fd9\u662f\u56e0\u4e3a super \u662f\u5168\u5c40\u6743\u9650\uff0c\u8fd9\u4e2a\u6743\u9650\u4fe1\u606f\u5728\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\uff0c\u800c revoke \u64cd\u4f5c\u5f71\u54cd\u4e0d\u5230\u8fd9\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\u3002</p> <p>\u800c\u5728 T5 \u65f6\u523b\u53bb\u6389 ua \u5bf9 db1 \u5e93\u7684\u6240\u6709\u6743\u9650\u540e\uff0c\u5728 T6 \u65f6\u523b session B \u518d\u64cd\u4f5c db1 \u5e93\u7684\u8868\uff0c\u5c31\u4f1a\u62a5\u9519\u201c\u6743\u9650\u4e0d\u8db3\u201d\u3002\u8fd9\u662f\u56e0\u4e3a <code>acl_dbs</code> \u662f\u4e00\u4e2a\u5168\u5c40\u6570\u7ec4\uff0c\u6240\u6709\u7ebf\u7a0b\u5224\u65ad db \u6743\u9650\u90fd\u7528\u8fd9\u4e2a\u6570\u7ec4\uff0c\u8fd9\u6837 revoke \u64cd\u4f5c\u9a6c\u4e0a\u5c31\u4f1a\u5f71\u54cd\u5230 session B\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_5","title":"\u8868\u6743\u9650\u548c\u5217\u6743\u9650","text":"<p>\u9664\u4e86 db \u7ea7\u522b\u7684\u6743\u9650\u5916\uff0cMySQL \u652f\u6301\u66f4\u7ec6\u7c92\u5ea6\u7684\u8868\u6743\u9650\u548c\u5217\u6743\u9650\u3002\u5176\u4e2d\uff0c\u8868\u6743\u9650\u5b9a\u4e49\u5b58\u653e\u5728\u8868 <code>mysql.tables_priv</code> \u4e2d\uff0c\u5217\u6743\u9650\u5b9a\u4e49\u5b58\u653e\u5728\u8868 <code>mysql.columns_priv</code> \u4e2d\u3002\u8fd9\u4e24\u7c7b\u6743\u9650\uff0c\u7ec4\u5408\u8d77\u6765\u5b58\u653e\u5728\u5185\u5b58\u7684 hash \u7ed3\u6784 <code>column_priv_hash</code> \u4e2d\u3002</p> <p>\u8fd9\u4e24\u7c7b\u6743\u9650\u7684\u8d4b\u6743\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>create table db1.t1(id int, a int); \ngrant all privileges on db1.t1 to 'ua'@'%' with grant option;\nGRANT SELECT(id), INSERT (id,a) ON mydb.mytbl TO 'ua'@'%' with grant option;\n</code></pre> <p>\u8ddf db \u6743\u9650\u7c7b\u4f3c\uff0c\u8fd9\u4e24\u4e2a\u6743\u9650\u6bcf\u6b21 grant \u7684\u65f6\u5019\u90fd\u4f1a\u4fee\u6539\u6570\u636e\u8868\uff0c\u4e5f\u4f1a\u540c\u6b65\u4fee\u6539\u5185\u5b58\u4e2d\u7684 hash \u7ed3\u6784\u3002\u56e0\u6b64\uff0c\u5bf9\u8fd9\u4e24\u7c7b\u6743\u9650\u7684\u64cd\u4f5c\uff0c\u4e5f\u4f1a\u9a6c\u4e0a\u5f71\u54cd\u5230\u5df2\u7ecf\u5b58\u5728\u7684\u8fde\u63a5\u3002</p> <p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u4e00\u5b9a\u4f1a\u95ee\uff0c\u770b\u6765 grant \u8bed\u53e5\u90fd\u662f\u5373\u65f6\u751f\u6548\u7684\uff0c\u90a3\u8fd9\u4e48\u770b\u5e94\u8be5\u5c31\u4e0d\u9700\u8981\u6267\u884c <code>flush privileges</code> \u8bed\u53e5\u4e86\u5440\u3002</p> <p>\u7b54\u6848\u4e5f\u786e\u5b9e\u662f\u8fd9\u6837\u7684\u3002</p> <p>flush privileges \u547d\u4ee4\u4f1a\u6e05\u7a7a <code>acl_users</code> \u6570\u7ec4\uff0c\u7136\u540e\u4ece <code>mysql.user</code> \u8868\u4e2d\u8bfb\u53d6\u6570\u636e\u91cd\u65b0\u52a0\u8f7d\uff0c\u91cd\u65b0\u6784\u9020\u4e00\u4e2a <code>acl_users</code> \u6570\u7ec4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4ee5\u6570\u636e\u8868\u4e2d\u7684\u6570\u636e\u4e3a\u51c6\uff0c\u4f1a\u5c06\u5168\u5c40\u6743\u9650\u5185\u5b58\u6570\u7ec4\u91cd\u65b0\u52a0\u8f7d\u4e00\u904d\u3002</p> <p>\u540c\u6837\u5730\uff0c\u5bf9\u4e8e db \u6743\u9650\u3001\u8868\u6743\u9650\u548c\u5217\u6743\u9650\uff0cMySQL \u4e5f\u505a\u4e86\u8fd9\u6837\u7684\u5904\u7406\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5185\u5b58\u7684\u6743\u9650\u6570\u636e\u548c\u78c1\u76d8\u6570\u636e\u8868\u76f8\u540c\u7684\u8bdd\uff0c\u4e0d\u9700\u8981\u6267\u884c flush privileges\u3002\u800c\u5982\u679c\u6211\u4eec\u90fd\u662f\u7528 grant/revoke \u8bed\u53e5\u6765\u6267\u884c\u7684\u8bdd\uff0c\u5185\u5b58\u548c\u6570\u636e\u8868\u672c\u6765\u5c31\u662f\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\u7684\u3002</p> <p>\u56e0\u6b64\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0cgrant \u547d\u4ee4\u4e4b\u540e\uff0c\u6ca1\u6709\u5fc5\u8981\u8ddf\u7740\u6267\u884c flush privileges \u547d\u4ee4\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#flush-privileges","title":"flush privileges \u4f7f\u7528\u573a\u666f","text":"<p>\u90a3\u4e48\uff0cflush privileges \u662f\u5728\u4ec0\u4e48\u65f6\u5019\u4f7f\u7528\u5462\uff1f\u663e\u7136\uff0c\u5f53\u6570\u636e\u8868\u4e2d\u7684\u6743\u9650\u6570\u636e\u8ddf\u5185\u5b58\u4e2d\u7684\u6743\u9650\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\uff0cflush privileges \u8bed\u53e5\u53ef\u4ee5\u7528\u6765\u91cd\u5efa\u5185\u5b58\u6570\u636e\uff0c\u8fbe\u5230\u4e00\u81f4\u72b6\u6001\u3002</p> <p>\u8fd9\u79cd\u4e0d\u4e00\u81f4\u5f80\u5f80\u662f\u7531\u4e0d\u89c4\u8303\u7684\u64cd\u4f5c\u5bfc\u81f4\u7684\uff0c\u6bd4\u5982\u76f4\u63a5\u7528 DML \u8bed\u53e5\u64cd\u4f5c\u7cfb\u7edf\u6743\u9650\u8868\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u8fd9\u4e2a\u573a\u666f\uff1a</p> client A client B T1 connect(root, root);create user 'ua'@'%' identified by 'pa'; T2 connect(ua,pa);(connect ok)disconnect T3 delete from mysql.user where user = 'ua'; T4 connect(ua, pa)(connect ok)disconnect T5 flush privileges; T6 connect(ua, pa)(Access Denied) <p>\u53ef\u4ee5\u770b\u5230\uff0cT3 \u65f6\u523b\u867d\u7136\u5df2\u7ecf\u7528 delete \u8bed\u53e5\u5220\u9664\u4e86\u7528\u6237 ua\uff0c\u4f46\u662f\u5728 T4 \u65f6\u523b\uff0c\u4ecd\u7136\u53ef\u4ee5\u7528 ua \u8fde\u63a5\u6210\u529f\u3002\u539f\u56e0\u5c31\u662f\uff0c\u8fd9\u65f6\u5019\u5185\u5b58\u4e2d <code>acl_users</code> \u6570\u7ec4\u4e2d\u8fd8\u6709\u8fd9\u4e2a\u7528\u6237\uff0c\u56e0\u6b64\u7cfb\u7edf\u5224\u65ad\u65f6\u8ba4\u4e3a\u7528\u6237\u8fd8\u6b63\u5e38\u5b58\u5728\u3002</p> <p>\u5728 T5 \u65f6\u523b\u6267\u884c\u8fc7 flush \u547d\u4ee4\u540e\uff0c\u5185\u5b58\u66f4\u65b0\uff0cT6 \u65f6\u523b\u518d\u8981\u7528 ua \u6765\u767b\u5f55\u7684\u8bdd\uff0c\u5c31\u4f1a\u62a5\u9519\u201c\u65e0\u6cd5\u8bbf\u95ee\u201d\u4e86\u3002</p> <p>\u76f4\u63a5\u64cd\u4f5c\u7cfb\u7edf\u8868\u662f\u4e0d\u89c4\u8303\u7684\u64cd\u4f5c\uff0c\u8fd9\u4e2a\u4e0d\u4e00\u81f4\u72b6\u6001\u4e5f\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u66f4\u201c\u8be1\u5f02\u201d\u7684\u73b0\u8c61\u53d1\u751f\u3002\u6bd4\u5982\uff0c\u524d\u9762\u8fd9\u4e2a\u901a\u8fc7 delete \u8bed\u53e5\u5220\u9664\u7528\u6237\u7684\u4f8b\u5b50\uff0c\u5c31\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684\u60c5\u51b5\uff1a</p>","tags":["mysql","tuning"]},{"location":"courses/mysql-lecture/mysql-practices-lecture-45-5/#_6","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u6211\u548c\u4f60\u4ecb\u7ecd\u4e86 MySQL \u7528\u6237\u6743\u9650\u5728\u6570\u636e\u8868\u548c\u5185\u5b58\u4e2d\u7684\u5b58\u5728\u5f62\u5f0f\uff0c\u4ee5\u53ca grant \u548c revoke \u547d\u4ee4\u7684\u6267\u884c\u903b\u8f91\u3002</p> <p>grant \u8bed\u53e5\u4f1a\u540c\u65f6\u4fee\u6539\u6570\u636e\u8868\u548c\u5185\u5b58\uff0c\u5224\u65ad\u6743\u9650\u7684\u65f6\u5019\u4f7f\u7528\u7684\u662f\u5185\u5b58\u6570\u636e\u3002\u56e0\u6b64\uff0c\u89c4\u8303\u5730\u4f7f\u7528 grant \u548c revoke \u8bed\u53e5\uff0c\u662f\u4e0d\u9700\u8981\u968f\u540e\u52a0\u4e0a flush privileges \u8bed\u53e5\u7684\u3002</p> <p>flush privileges \u8bed\u53e5\u672c\u8eab\u4f1a\u7528\u6570\u636e\u8868\u7684\u6570\u636e\u91cd\u5efa\u4e00\u4efd\u5185\u5b58\u6743\u9650\u6570\u636e\uff0c\u6240\u4ee5\u5728\u6743\u9650\u6570\u636e\u53ef\u80fd\u5b58\u5728\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u518d\u4f7f\u7528\u3002\u800c\u8fd9\u79cd\u4e0d\u4e00\u81f4\u5f80\u5f80\u662f\u7531\u4e8e\u76f4\u63a5\u7528 DML \u8bed\u53e5\u64cd\u4f5c\u7cfb\u7edf\u6743\u9650\u8868\u5bfc\u81f4\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u8fd9\u7c7b\u8bed\u53e5\u3002</p> <p>\u53e6\u5916\uff0c\u5728\u4f7f\u7528 grant \u8bed\u53e5\u8d4b\u6743\u65f6\uff0c\u4f60\u53ef\u80fd\u8fd8\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u5199\u6cd5\uff1a</p> <pre><code>grant super on *.* to 'ua'@'%' identified by 'pa';\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u52a0\u4e86 identified by \u2018\u5bc6\u7801\u2019\uff0c \u8bed\u53e5\u7684\u903b\u8f91\u91cc\u9762\u9664\u4e86\u8d4b\u6743\u5916\uff0c\u8fd8\u5305\u542b\u4e86\uff1a</p> <ol> <li>\u5982\u679c\u7528\u6237 <code>\u2019ua\u2019@\u2019%'</code>\u4e0d\u5b58\u5728\uff0c\u5c31\u521b\u5efa\u8fd9\u4e2a\u7528\u6237\uff0c\u5bc6\u7801\u662f pa\uff1b</li> <li>\u5982\u679c\u7528\u6237 ua \u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u5c06\u5bc6\u7801\u4fee\u6539\u6210 pa\u3002</li> </ol> <p>\u8fd9\u4e5f\u662f\u4e00\u79cd\u4e0d\u5efa\u8bae\u7684\u5199\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u79cd\u5199\u6cd5\u5f88\u5bb9\u6613\u5c31\u4f1a\u4e0d\u614e\u628a\u5bc6\u7801\u7ed9\u6539\u4e86\u3002</p> <p>\u201cgrant \u4e4b\u540e\u968f\u624b\u52a0 flush privileges\u201d\uff0c\u6211\u81ea\u5df1\u662f\u8fd9\u4e48\u4f7f\u7528\u4e86\u4e24\u4e09\u5e74\u4e4b\u540e\uff0c\u5728\u770b\u4ee3\u7801\u7684\u65f6\u5019\u624d\u53d1\u73b0\u5176\u5b9e\u5e76\u4e0d\u9700\u8981\u8fd9\u6837\u505a\uff0c\u90a3\u5df2\u7ecf\u662f 2011 \u5e74\u7684\u4e8b\u60c5\u4e86\u3002</p>","tags":["mysql","tuning"]},{"location":"courses/time-series-analysis/01-basic/","title":"\u57fa\u7840\u7bc7","text":"<p>Source</p>"},{"location":"courses/time-series-analysis/01-basic/#1","title":"1 \u524d\u8a00","text":"<p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\uff08time series analysis\uff09\u662f\u91cf\u5316\u6295\u8d44\u4e2d\u7684\u4e00\u95e8\u57fa\u672c\u6280\u672f\u3002\u65f6\u95f4\u5e8f\u5217\u662f\u6307\u5728\u4e00\u5b9a\u65f6\u95f4\u5185\u6309\u65f6\u95f4\u987a\u5e8f\u6d4b\u91cf\u7684\u67d0\u4e2a\u53d8\u91cf\u7684\u53d6\u503c\u5e8f\u5217\u3002\u6bd4\u5982\u53d8\u91cf\u662f\u80a1\u7968\u4ef7\u683c\uff0c\u90a3\u4e48\u5b83\u968f\u65f6\u95f4\u7684\u53d8\u5316\u5c31\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff1b\u540c\u6837\u7684\uff0c\u5982\u679c\u53d8\u91cf\u662f\u80a1\u7968\u7684\u6536\u76ca\u7387\uff0c\u5219\u5b83\u968f\u65f6\u95f4\u7684\u53d8\u5316\u4e5f\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u3002\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5c31\u662f\u4f7f\u7528\u7edf\u8ba1\u7684\u624b\u6bb5\u5bf9\u8fd9\u4e2a\u5e8f\u5217\u7684\u8fc7\u53bb\u8fdb\u884c\u5206\u6790\uff0c\u4ee5\u6b64\u5bf9\u8be5\u53d8\u91cf\u7684\u53d8\u5316\u7279\u6027\u5efa\u6a21\u3001\u5e76\u5bf9\u672a\u6765\u8fdb\u884c\u9884\u6d4b\u3002</p> <p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8bd5\u56fe\u901a\u8fc7\u7814\u7a76\u8fc7\u53bb\u6765\u9884\u6d4b\u672a\u6765\u3002</p> <p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u5de5\u7a0b\u5b66\u3001\u7ecf\u6d4e\u5b66\u3001\u6c14\u8c61\u5b66\u3001\u91d1\u878d\u5b66\u7b49\u4f17\u591a\u9886\u57df\u6709\u7740\u5e7f\u6cdb\u7684\u5e94\u7528\u3002\u5728\u91d1\u878d\u5b66\u9886\u57df\uff0c\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4f18\u79c0\u4e66\u7c4d\u5c42\u51fa\u4e0d\u7a77\u3002\u5176\u4e2d\u6700\u5bb6\u55bb\u6237\u6653\u4e4b\u4e00\u7684\u8981\u6570\u7f8e\u56fd\u829d\u52a0\u54e5\u5927\u5b66\u5546\u5b66\u9662 Ruey S. Tsay \u6559\u6388\u64b0\u5199\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790 \u2014\u2014 Analysis of Financial Time Series\uff08\u4e0b\u56fe\uff0c\u8be5\u4e66\u4e5f\u540c\u65f6\u6709\u4e2d\u6587\u7248\uff09\u3002</p> <p></p> <p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8981\u6c42\u4f7f\u7528\u8005\u5177\u5907\u4e00\u5b9a\u7684\u9ad8\u7b49\u6570\u5b66\u77e5\u8bc6\u3002\u7279\u522b\u662f\u5176\u4e2d\u4e00\u4e9b\u9ad8\u7ea7\u7684\u6a21\u578b\uff0c\u5982\u5206\u6790\u6ce2\u52a8\u7387\u7684 ARCH/GARCH \u6a21\u578b\u3001\u6781\u503c\u7406\u8bba\u3001\u8fde\u7eed\u968f\u673a\u8fc7\u7a0b\u3001\u72b6\u6001\u7a7a\u95f4\u6a21\u578b\u7b49\u90fd\u5bf9\u4f7f\u7528\u8005\u7684\u6570\u5b66\u6c34\u5e73\u6709\u7740\u6781\u9ad8\u7684\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u5728\u5f88\u591a\u4eba\u773c\u4e2d\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u65e0\u7591\u5e26\u7740\u539a\u539a\u7684\u9762\u7eb1\uff0c\u4ee4\u4eba\u671b\u800c\u5374\u6b65\u3002</p> <p>\u7136\u800c\uff0c\u5982\u679c\u5b66\u4e60\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u89e3\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u70b9\u3001\u719f\u6089\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\u3001\u5e76\u4f7f\u7528\u7ebf\u6027\u4f46\u975e\u5e38\u5b9e\u7528\u7684\u6a21\u578b\uff08\u6bd4\u5982 ARMA \u6a21\u578b\uff09\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u9884\u6d4b\u5e76\u4ee5\u6b64\u5236\u5b9a\u91cf\u5316\u7b56\u7565\uff0c\u90a3\u4e48\u53ea\u8981\u5177\u5907\u7b80\u5355\u7684\u7edf\u8ba1\u5b66\u57fa\u7840\uff0c\u5c31\u5b8c\u5168\u80fd\u591f\u5b9e\u73b0\u8fd9\u4e9b\u76ee\u6807\u3002</p> <p>\u51fa\u4e8e\u8fd9\u4e2a\u76ee\u7684\uff0c\u4ece\u672c\u5468\u5f00\u59cb\uff0c\u91cf\u5316\u6838\u6b66\u7814\u7a76\u8fd9\u4e2a\u4e13\u9898\u4e0b\u5c06\u63a8\u51fa\u56db\u7bc7\u6587\u7ae0\uff0c\u6df1\u5165\u6d45\u51fa\u7684\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76f8\u5173\u77e5\u8bc6\u3002\u8be5\u7cfb\u5217\u4e0d\u4f1a\u6d89\u53ca\u4e0a\u9762\u63d0\u5230\u7684\u90a3\u4e9b\u9ad8\u7ea7\u6a21\u578b\uff1b\u76f8\u53cd\u7684\uff0c\u672c\u7cfb\u5217\u4ee5\u5bf9\u80a1\u7968\u6536\u76ca\u7387\u5efa\u6a21\u5e76\u6784\u5efa\u6295\u8d44\u7b56\u7565\u4e3a\u76ee\u6807\uff0c\u6309\u90e8\u5c31\u73ed\u7684\u628a\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u6807\u6240\u9700\u8981\u7684\u6bcf\u4e00\u5757\u201c\u79ef\u6728\u201d\u6e05\u6670\u5730\u5448\u732e\u7ed9\u8bfb\u8005\u3002\u8fd9\u56db\u7bc7\u6587\u7ae0\u7684\u7ed3\u6784\u4e3a\uff1a</p> <ul> <li>\u57fa\u7840\u7bc7\uff08\u672c\u6587\uff09\uff1a\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u6027\u548c\u8fdb\u884c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u5e8f\u5217\u76f8\u5173\u6027\uff08\u53c8\u79f0\u81ea\u76f8\u5173\u6027\uff09\u3002</li> <li>\u521d\u7ea7\u7bc7\uff1a\u8bf4\u660e\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u8fc7\u7a0b\uff1b\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6700\u57fa\u672c\u6a21\u578b\uff1a\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u3002</li> <li>\u8fdb\u9636\u7bc7\uff1a\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u5e38\u7528\u7684\u7ebf\u6027\u6a21\u578b\uff1aAR\u3001MA\u3001ARMA \u7b49\u3002</li> <li>\u5e94\u7528\u7bc7\uff1a\u5229\u7528 ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u6295\u8d44\u7b56\u7565\uff0c\u4ee5\u6b64\u5c55\u793a\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\u7684\u5e94\u7528\u3002</li> </ul> <p>\u672c\u7cfb\u5217\u6587\u7ae0\u4f1a\u907f\u514d\u8fc7\u591a\u7f57\u5217\u6666\u6da9\u96be\u61c2\u7684\u5927\u6570\u5b66\uff08\u4f46\u4f1a\u6d89\u53ca\u5fc5\u8981\u7684\u6570\u5b66\u77e5\u8bc6\uff09\uff0c\u5e0c\u671b\u5e26\u4f60\u8d70\u5165\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u5927\u95e8\uff0c\u4e3a\u4f60\u4eca\u540e\u5b66\u4e60\u66f4\u9ad8\u7ea7\u7684\u6a21\u578b\u5960\u5b9a\u4e00\u4e9b\u57fa\u7840\u3002</p> <p>\u8fd9\u662f\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#2","title":"2 \u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790","text":"<p>\u4e3a\u4e86\u907f\u514d\u4e0b\u6587\u4e2d\u6d89\u53ca\u7684\u6982\u5ff5\u8fc7\u4e8e\u62bd\u8c61\uff0c\u6211\u4eec\u5047\u8bbe\u672c\u6587\u8ba8\u8bba\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e3a\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u5e8f\u5217\u3002</p> <p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u8003\u8651\u7684\u662f\u91d1\u878d\u53d8\u91cf\uff08\u6bd4\u5982\u6295\u8d44\u54c1\u6536\u76ca\u7387\uff09\u968f\u65f6\u95f4\u6f14\u53d8\u7684\u7406\u8bba\u548c\u5b9e\u8df5\u3002\u4efb\u4f55\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u90fd\u5305\u542b\u4e0d\u786e\u5b9a\u56e0\u7d20\uff0c\u56e0\u6b64\u7edf\u8ba1\u5b66\u7684\u7406\u8bba\u548c\u65b9\u6cd5\u5728\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u81f3\u5173\u91cd\u8981\u3002\u91d1\u878d\u8d44\u4ea7\u7684\u65f6\u95f4\u5e8f\u5217\u5e38\u88ab\u770b\u4f5c\u662f\u672a\u77e5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u968f\u65f6\u95f4\u53d8\u5316\u7684\u4e00\u4e2a\u5b9e\u73b0\u3002\u901a\u5e38\u5047\u8bbe\u8be5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u4ec5\u5728\u65f6\u95f4\u8f74\u4e0a\u7684\u79bb\u6563\u70b9\u6709\u5b9a\u4e49\uff0c\u5219\u8be5\u968f\u673a\u53d8\u91cf\u5e8f\u5217\u5c31\u662f\u4e00\u4e2a\u79bb\u6563\u968f\u673a\u8fc7\u7a0b\u3002\u6bd4\u5982\u80a1\u7968\u7684\u65e5\u6536\u76ca\u7387\u5c31\u662f\u79bb\u6563\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\uff0c\u6211\u4eec\u7684\u76ee\u6807\u662f\u901a\u8fc7\u7edf\u8ba1\u624b\u6bb5\u5bf9\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u8fd9\u4e2a\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\uff0c\u4ee5\u6b64\u63a8\u65ad\u5e8f\u5217\u4e2d\u4e0d\u540c\u4ea4\u6613\u65e5\u7684\u6536\u76ca\u7387\u4e4b\u95f4\u6709\u65e0\u4efb\u4f55\u7279\u5f81\uff0c\u4ee5\u6b64\u6765\u9884\u6d4b\u672a\u6765\u7684\u6536\u76ca\u7387\u5e76\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3002</p> <p>\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u53ef\u80fd\u5b58\u5728\u7684\u7279\u5f81\u5305\u62ec\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>\u8d8b\u52bf\uff1a\u8d8b\u52bf\u662f\u65f6\u95f4\u5e8f\u5217\u5728\u67d0\u4e00\u65b9\u5411\u4e0a\u6301\u7eed\u8fd0\u52a8\uff08\u6bd4\u5982\u725b\u5e02\u65f6\u80a1\u5e02\u6bcf\u5929\u90fd\u5728\u4e0a\u6da8\uff0c\u80a1\u7968\u6536\u76ca\u7387\u6301\u7eed\u4e3a\u6b63\uff1b\u718a\u5e02\u65f6\u80a1\u5e02\u6bcf\u5929\u90fd\u5728\u4e0b\u8dcc\uff0c\u80a1\u7968\u6536\u76ca\u7387\u6301\u7eed\u4e3a\u8d1f\uff09\u3002\u8d8b\u52bf\u7ecf\u5e38\u51fa\u73b0\u5728\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e2d\uff0c\u7279\u522b\u662f\u5927\u5b97\u5546\u54c1\u4ef7\u683c\uff1b\u8bb8\u591a\u5546\u54c1\u4ea4\u6613\u987e\u95ee\uff08CTA\uff09\u57fa\u91d1\u5728\u4ed6\u4eec\u7684\u4ea4\u6613\u7b97\u6cd5\u4e2d\u90fd\u4f7f\u7528\u4e86\u590d\u6742\u7684\u8d8b\u52bf\u8bc6\u522b\u6a21\u578b\u3002</li> <li>\u5b63\u8282\u53d8\u5316\uff1a\u8bb8\u591a\u65f6\u95f4\u5e8f\u5217\u4e2d\u5305\u542b\u5b63\u8282\u53d8\u5316\u3002\u5728\u91d1\u878d\u9886\u57df\uff0c\u6211\u4eec\u7ecf\u5e38\u770b\u5230\u5546\u54c1\u4ef7\u683c\u7684\u5b63\u8282\u6027\u53d8\u5316\uff0c\u7279\u522b\u662f\u90a3\u4e9b\u4e0e\u751f\u957f\u5b63\u8282\u6216\u6e29\u5ea6\u53d8\u5316\u6709\u5173\u7684\u5546\u54c1\uff0c\u6bd4\u5982\u5929\u7136\u6c14\u3002</li> <li> <p>\u5e8f\u5217\u76f8\u5173\u6027\uff1a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u4e00\u4e2a\u6700\u91cd\u8981\u7279\u5f81\u662f\u5e8f\u5217\u76f8\u5173\u6027\uff08serial correlation\uff09\uff0c\u53c8\u79f0\u4e3a\u81ea\u76f8\u5173\u6027\uff08autocorrelation\uff09\u3002\u4ee5\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u5e8f\u5217\u4e3a\u4f8b\uff0c\u6211\u4eec\u4f1a\u7ecf\u5e38\u89c2\u5bdf\u5230\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6536\u76ca\u7387\u4e4b\u95f4\u5b58\u5728\u6b63\u76f8\u5173\u6216\u8005\u8d1f\u76f8\u5173\u3002\u6b64\u5916\uff0c\u6ce2\u52a8\u805a\u7c7b\uff08volatility clustering\uff09\u4e5f\u662f\u4e00\u79cd\u5e8f\u5217\u76f8\u5173\u6027\uff0c\u5b83\u610f\u5473\u7740\u9ad8\u6ce2\u52a8\u7684\u9636\u6bb5\u5f80\u5f80\u4f34\u968f\u7740\u9ad8\u6ce2\u52a8\u7684\u9636\u6bb5\u51fa\u73b0\u3001\u4f4e\u6ce2\u52a8\u7684\u9636\u6bb5\u5f80\u5f80\u4f34\u968f\u7740\u4f4e\u6ce2\u52a8\u7684\u9636\u6bb5\u51fa\u73b0\uff0c\u8fd9\u5728\u91cf\u5316\u6295\u8d44\u4e2d\u5c24\u4e3a\u91cd\u8981\u3002\u6bd4\u5982\u4e0b\u56fe\u4e3a 2001 \u5e74\u5230 2017 \u5e74\u4e0a\u8bc1\u6307\u6570\u65e5\u6536\u76ca\u7387\u7684\u6807\u51c6\u5dee\uff0c\u4ece\u4e2d\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u6ce2\u52a8\u805a\u7c7b\u3002</p> <p></p> </li> <li> <p>\u968f\u673a\u566a\u58f0\uff1a\u5b83\u662f\u65f6\u95f4\u5e8f\u5217\u4e2d\u9664\u53bb\u8d8b\u52bf\u3001\u5b63\u8282\u53d8\u5316\u548c\u81ea\u76f8\u5173\u6027\u4e4b\u540e\u7684\u5269\u4f59\u968f\u673a\u6270\u52a8\u3002\u7531\u4e8e\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u4e0d\u786e\u5b9a\u6027\uff0c\u968f\u673a\u566a\u58f0\u603b\u662f\u5939\u6742\u5728\u65f6\u95f4\u5e8f\u5217\u4e2d\uff0c\u81f4\u4f7f\u65f6\u95f4\u5e8f\u5217\u8868\u73b0\u51fa\u67d0\u79cd\u9707\u8361\u5f0f\u7684\u65e0\u89c4\u5f8b\u8fd0\u52a8\u3002</p> </li> </ul> <p>\u91cf\u5316\u6295\u8d44\u7684\u4ea4\u6613\u8005\u7684\u76ee\u6807\u662f\u5229\u7528\u7edf\u8ba1\u5efa\u6a21\u6765\u8bc6\u522b\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u4e2d\u6f5c\u5728\u7684\u8d8b\u52bf\u3001\u5b63\u8282\u53d8\u5316\u548c\u5e8f\u5217\u76f8\u5173\u6027\u3002\u5229\u7528\u4e00\u4e2a\u597d\u7684\u6a21\u578b\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4e3b\u8981\u5e94\u7528\u5305\u62ec\uff1a</p> <ul> <li>\u9884\u6d4b\u672a\u6765\uff1a\u4e3a\u4e86\u6210\u529f\u4ea4\u6613\uff0c\u6211\u4eec\u9700\u8981\u5728 \u7edf\u8ba1\u4e0a \u201c\u51c6\u786e\u201d\u9884\u6d4b\u672a\u6765\u7684\u6295\u8d44\u54c1\u4ef7\u683c\u6216\u8005\u6536\u76ca\u7387\u3002</li> <li>\u5e8f\u5217\u6a21\u62df\uff1a\u4e00\u65e6\u53d1\u73b0\u4e86\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7edf\u8ba1\u7279\u5f81\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u6765\u6a21\u62df\u65f6\u95f4\u5e8f\u5217\u5e76\u8fdb\u884c\u573a\u666f\u5206\u6790\u3002\u8fd9\u5bf9\u4e8e\u4f30\u8ba1\u4ea4\u6613\u6b21\u6570\u3001\u671f\u671b\u4ea4\u6613\u6210\u672c\u3001\u671f\u671b\u6536\u76ca\u7387\u81f3\u5173\u91cd\u8981\uff0c\u4ece\u800c\u6700\u7ec8\u5b9a\u91cf\u7684\u8ba1\u7b97\u4e00\u4e2a\u7b56\u7565\u6216\u8005\u6295\u8d44\u7ec4\u5408\u7684\u98ce\u9669\u5206\u5e03\u548c\u76c8\u5229\u6c34\u5e73\u3002</li> </ul> <p>\u4e0a\u6587\u8bf4\u5230\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u5173\u7cfb\u4e2d\uff0c\u6700\u91cd\u8981\u7684\u5f53\u5c5e\u81ea\u76f8\u5173\u6027\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5f88\u5bb9\u6613\u4ece\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e2d\u8bc6\u522b\u51fa\u8d8b\u52bf\u4ee5\u53ca\u5b63\u8282\u53d8\u6362\u3002\u5f53\u9664\u53bb\u8fd9\u4e9b\u5173\u7cfb\u540e\uff0c\u5269\u4e0b\u7684\u65f6\u95f4\u5e8f\u5217\u5f80\u5f80\u770b\u6765\u5341\u5206\u968f\u673a\u3002\u7136\u800c\u5bf9\u4e8e\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\uff0c\u6bd4\u5982\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\uff0c\u770b\u4f3c\u968f\u673a\u7684\u65f6\u95f4\u5e8f\u5217\u4e2d\u5f80\u5f80\u5b58\u5728\u7740\u60ca\u4eba\u7684\u81ea\u76f8\u5173\u3002\u5bf9\u81ea\u76f8\u5173\u5efa\u6a21\u5e76\u52a0\u4ee5\u5229\u7528\u80fd\u591f\u5927\u5e45\u63d0\u9ad8\u4ea4\u6613\u4fe1\u53f7\u7684\u51c6\u786e\u6027 \u914d\u5bf9\u4ea4\u6613\u7684\u5747\u503c\u56de\u590d\u7b56\u7565\u5c31\u662f\u8fd9\u4e48\u4e00\u4e2a\u4f8b\u5b50\u3002\u5747\u503c\u56de\u590d\u7b56\u7565\u5229\u7528\u4e00\u5bf9\u6295\u8d44\u54c1\u4ef7\u5dee\u5e8f\u5217\u7684 \u8d1f\u76f8\u5173\u6027 \u8fdb\u884c\u6295\u8d44\uff0c\u4ea7\u751f\u505a\u591a\u6216\u8005\u505a\u7a7a\u7684\u4ea4\u6613\u4fe1\u53f7\uff0c\u5b9e\u73b0\u76c8\u5229\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#_2","title":"\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u6838\u5fc3\u5c31\u662f\u6316\u6398\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\u3002","text":"<p>\u672c\u6587\u7684\u4e0b\u9762\u51e0\u8282\u5c31\u6765\u4ecb\u7ecd\u5982\u4f55\u8ba1\u7b97\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002\u4e3a\u6b64\uff0c\u9996\u5148\u6765\u770b\u4e24\u4e2a\u57fa\u7840\u6982\u5ff5\uff1a\u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570\u3002\u4e4b\u540e\u4f1a\u8c08\u53ca\u65f6\u95f4\u5e8f\u5217\u7684\u7a33\u5b9a\u6027\uff0c\u5b83\u662f\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u4e00\u4e2a\u5fc5\u8981\u524d\u63d0\u3002\u6700\u540e\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#3","title":"3 \u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570","text":"<p>\u672c\u8282\u4ecb\u7ecd\u6982\u7387\u8bba\u4e2d\u7684\u57fa\u7840\u6982\u5ff5\uff1a\u534f\u65b9\u5dee\u548c\u76f8\u5173\u7cfb\u6570\u3002\u719f\u6089\u5b83\u4eec\u7684\u8bfb\u8005\u53ef\u8df3\u8fc7\u3002</p> <p>\u5047\u8bbe\u4e24\u4e2a\u968f\u673a\u53d8\u91cf \\(X\\) \u548c \\(Y\\) \u6ee1\u8db3\u672a\u77e5\u7684\u6982\u7387\u5206\u5e03\uff08\u53ef\u4ee5\u662f\u540c\u5206\u5e03\u4e5f\u53ef\u4ee5\u662f\u4e0d\u540c\u7684\u5206\u5e03\uff09\u3002 \\(E[\\cdot]\\) \u4e3a\u6c42\u89e3\u6570\u5b66\u671f\u671b\u7684\u8fd0\u7b97\u7b26\u3002\\(X\\) \u548c \\(Y\\) \u7684\u603b\u4f53\u534f\u65b9\u5dee\uff08population covariance\uff09\u4e3a\uff1a</p> \\[ Cov(X,Y) = E[(X-\\mu_X)(Y-\\mu_Y)] \\] <p>\u5176\u4e2d\uff0c \\(\\mu_X\\) \u548c \\(\\mu_Y\\) \u5206\u522b\u4e3a \\(X\\) \u548c \\(Y\\) \u7684 \u603b\u4f53\u5747\u503c\uff08population mean\uff09\u3002</p> <p>\u534f\u65b9\u5dee\u544a\u8bc9\u6211\u4eec\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u662f\u5982\u4f55\u4e00\u8d77\u79fb\u52a8\u7684\u3002</p> <p>\u5728\u5b9e\u9645\u4e2d\uff0c\u7531\u4e8e\u603b\u4f53\u7684\u6982\u7387\u5206\u5e03\u672a\u77e5\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7 \\(X\\) \u548c \\(Y\\) \u7684\u89c2\u6d4b\u503c\u6765\u8ba1\u7b97 \u6837\u672c\u5747\u503c\uff08sample mean\uff09\u3002\u5047\u8bbe\u6211\u4eec\u5404\u6709 \\(X\\) \u548c \\(Y\\) \u7684\u89c2\u6d4b\u503c \\(n\\) \u4e2a\uff0c\u5219\u5b83\u4eec\u7684**\u6837\u672c\u534f\u65b9\u5dee\uff08sample covariance\uff09** \u4e3a\uff1a</p> \\[\\frac{1}{n-1}\\sum_{i=1}^n{(X_i - \\bar{X})(Y_i - \\bar{Y})}\\] <p>\u5176\u4e2d\uff0c\\(\\bar{X}\\) \u548c\\(\\bar{Y}\\) \u4e3a \\(X\\) \u548c \\(Y\\) \u7684\u6837\u672c\u5747\u503c\u3002\u4e0a\u9762\u516c\u5f0f\u4e2d\u53f3\u4fa7\u4e4b\u6240\u4ee5\u9664\u4ee5 \\(n-1\\) \u800c\u975e \\(n\\) \u7684\u539f\u56e0\u662f\uff0c\u8fd9\u4e48\u505a\u53ef\u4ee5\u4fdd\u8bc1\u6837\u672c\u534f\u65b9\u5dee\u662f\uff08\u672a\u77e5\uff09\u603b\u4f53\u534f\u65b9\u5dee\u7684\u4e00\u4e2a**\u65e0\u504f\u4f30\u8ba1\uff08unbiased estimator\uff09**\u3002</p> <p>\u5047\u8bbe\u6211\u4eec\u968f\u673a\u751f\u6210\u4e24\u4e2a\u968f\u673a\u53d8\u91cf \\(X\\) \u548c \\(Y\\) \u7684\u5e8f\u5217\uff0c\u5b83\u4eec\u7684\u6563\u70b9\u56fe\u5982\u4e0b\u3002</p> <p></p> <p>\u6309\u7167\u4e0a\u9762\u7684\u516c\u5f0f\uff0c\\(X\\) \u548c \\(Y\\) \u7684\u6837\u672c\u534f\u65b9\u5dee\u4e3a 893.215203\u3002\u5b83\u6709\u4ec0\u4e48\u610f\u4e49\u5462\uff1f\u5728\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u518d\u6765\u770b\u53e6\u5916\u4e24\u4e2a\u53d8\u91cf\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\\(X100\\) \u548c\\(Y100\\) \u3002\u5b83\u4eec\u5206\u522b\u5b9a\u4e49\u4e3a$X100 = 100\\times X $ \u548c \\(Y100 = 100\\times Y\\) \u3002\u53ef\u89c1\uff0c\u5b83\u4eec\u4ec5\u4ec5\u662f \\(X\\) \u548c \\(Y\\) \u5404\u4e58\u4ee5 100 \u5f97\u5230\u7684\u3002 \\(X100\\) \u548c\\(Y100\\) \u7684\u6837\u672c\u534f\u65b9\u5dee\u4e3a 8932152.03\uff0c\u8fd9\u662f \\(X\\) \u548c \\(Y\\) \u7684\u534f\u65b9\u5dee\u7684 10000 \u500d\u3002\u7136\u800c\uff0c\u5982\u679c\u4ec5\u4ec5\u56e0\u6b64\u5c31\u5f97\u51fa \\(X100\\) \u548c \\(Y100\\) \u7684\u76f8\u5173\u6027\u9ad8\u4e8e \\(X\\) \u548c \\(Y\\) \u7684\u76f8\u5173\u6027\u5c31\u5927\u9519\u7279\u9519\u4e86\u3002 \u4e8b\u5b9e\u4e0a\uff0c\u7531\u4e8e \\(X100\\) \u548c \\(Y100\\) \u662f\u7531 \\(X\\) \u548c \\(Y\\) \u5206\u522b\u4e58\u4ee5 100 \u5f97\u5230\u7684\uff0c\u56e0\u6b64\u5b83\u4eec\u4e4b\u95f4\u7684\u76f8\u5173\u6027\u663e\u7136\u548c \\(X\\) \u4e0e \\(Y\\) \u7684\u76f8\u5173\u6027\u76f8\u540c\u3002</p> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\u4f7f\u7528\u534f\u65b9\u5dee\u8861\u91cf\u53d8\u91cf\u76f8\u5173\u6027\u7684**\u81f4\u547d\u7f3a\u70b9\uff1a\u534f\u65b9\u5dee\u662f\u6709\u91cf\u7eb2\u7684\uff0c\u56e0\u6b64\u5b83\u7684\u5927\u5c0f\u53d7\u968f\u673a\u53d8\u91cf\u672c\u8eab\u6ce2\u52a8\u8303\u56f4\u7684\u5f71\u54cd**\u3002\u5728\u4e0a\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5f53\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u7684\u6ce2\u52a8\u8303\u56f4\u6269\u5927 100 \u500d\u540e\uff0c\u5b83\u4eec\u7684\u534f\u65b9\u5dee\u6269\u5927\u4e86 10000 \u500d\u3002\u56e0\u6b64\uff0c\u4eba\u4eec\u5e0c\u671b\u4f7f\u7528\u67d0\u4e2a\u548c\u534f\u65b9\u5dee\u6709\u5173\uff0c\u4f46\u662f\u53c8\u662f**\u65e0\u91cf\u7eb2**\u7684\u6d4b\u91cf\u6765\u63cf\u8ff0\u4e24\u4e2a\u968f\u673a\u53d8\u91cf\u7684\u76f8\u5173\u6027\u3002\u6700\u7b80\u5355\u7684\u505a\u6cd5\u5c31\u662f\u7528\u53d8\u91cf\u81ea\u8eab\u7684\u6ce2\u52a8\u5bf9\u534f\u65b9\u5dee\u8fdb\u884c\u6807\u51c6\u5316\u3002\u76f8\u5173\u7cfb\u6570\uff08correlation \u6216\u8005 correlation coefficient\uff09\u4fbf\u7531\u6b64\u5f97\u6765\u3002</p> <p>\u4ee4 \\(\\rho\\) \u8868\u793a\\(X\\) \u548c \\(Y\\) \u7684**\u603b\u4f53\u76f8\u5173\u7cfb\u6570\uff08population correlation\uff09**\uff0c\u5b83\u7684\u5b9a\u4e49\u4e3a\uff1a</p> \\[\\rho(X,Y) = \\frac{E[(X-\\mu_x)(Y-\\mu_Y)]}{\\sigma_X\\sigma_Y} = \\frac{Cov(X,Y)}{\\sigma_X\\sigma_Y}\\] <p>\u5176\u4e2d \\(\\sigma_X\\) \u548c \\(\\sigma_Y\\) \u5206\u522b\u4e3a \\(X\\) \u548c \\(Y\\) \u7684**\u603b\u4f53\u6807\u51c6\u5dee\uff08population standard deviation\uff09**\u3002\u901a\u8fc7\u4f7f\u7528 \\(X\\) \u548c \\(Y\\) \u7684\u6807\u51c6\u5dee\u5bf9\u5b83\u4eec\u7684\u534f\u65b9\u5dee\u5f52\u4e00\u5316\uff0c\\(\\rho\\) \u7684\u53d6\u503c\u8303\u56f4\u5728 -1 \u5230 +1 \u4e4b\u95f4\uff0c\u5373 [-1, +1]\uff1a</p> <ul> <li>$\\rho(X,Y) = 1 $ \u8868\u793a\\(X\\) \u548c\\(Y\\) \u4e4b\u95f4\u5b58\u5728\u786e\u5207\u7684\u7ebf\u6027\u6b63\u76f8\u5173\uff1b</li> <li>$\\rho(X,Y) = 0 $ \u8868\u793a \\(X\\) \\(Y\\) \u4e4b\u95f4\u4e0d\u5b58\u5728\u4efb\u4f55\u7ebf\u6027\u76f8\u5173\u6027\uff1b</li> <li>$\\rho(X,Y) = -1 $ \u8868\u793a \\(X\\) \\(Y\\) \u4e4b\u95f4\u5b58\u5728\u786e\u5207\u7684\u7ebf\u6027\u8d1f\u76f8\u5173\u3002</li> </ul> <p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u76f8\u5173\u7cfb\u6570\u4ec5\u4ec5\u523b\u753b\\(X\\) \u548c \\(Y\\) \u4e4b\u95f4\u7684\u7ebf\u6027\u76f8\u5173\u6027\uff1b\u5b83\u4e0d\u63cf\u8ff0\u5b83\u4eec\u4e4b\u95f4\u7684\uff08\u4efb\u4f55\uff09\u975e\u7ebf\u6027\u5173\u7cfb\u3002\u5728\u5b9e\u9645\u4e2d\uff0c\u7531\u4e8e\u603b\u4f53\u7684\u6982\u7387\u5206\u5e03\u672a\u77e5\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7\\(X\\) \u548c\\(Y\\) \u7684\u89c2\u6d4b\u503c\u6765\u8ba1\u7b97 \\(X\\) \u548c \\(Y\\) \u7684**\u6837\u672c\u76f8\u5173\u7cfb\u6570\uff08sample correlation\uff09**\uff1a</p> \\[ \\hat\\rho(X,Y) = \\frac{\\sum_{i=1}^n{(X_i - \\bar{X})(Y_i - \\bar{Y})} }{\\sqrt{\\sum_{i=1}^n{(X_i - \\bar{X})^2}\\sum_{i=1}^n{(Y_i - \\bar{Y})^2}}} \\] <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u65e0\u8bba\u8003\u8651\\(X\\) \u548c\\(Y\\) \u8fd8\u662f\\(X100\\) \u548c\\(Y100\\) \uff08\u5373\u65e0\u8bba\u5982\u4f55\u7f29\u653e \\(X\\) \u548c\\(Y\\) \uff09\uff0c\u5b83\u4eec\u7684\u76f8\u5173\u7cfb\u6570\u90fd\u662f 0.894655\uff0c\u8fd9\u548c\u6211\u4eec\u7684\u9884\u671f\u76f8\u7b26\u3002\u7531\u4e8e\u8fd9\u4e2a\u6570\u503c\u975e\u5e38\u63a5\u8fd1 1\uff0c\u5b83\u610f\u5473\u7740 \\(X\\) \u548c \\(Y\\) \u4e4b\u95f4\u5b58\u5728\u5f88\u5f3a\u7684\u7ebf\u6027\u6b63\u76f8\u5173\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#4","title":"4 \u65f6\u95f4\u5e8f\u5217\u7684\u5e73\u7a33\u6027","text":"<p>\u5e73\u7a33\u6027\uff08stationarity\uff09\u662f\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u57fa\u7840\u3002</p> <p>\u4e3a\u4e86\u901a\u4fd7\u7684\u7406\u89e3\u5e73\u7a33\u6027\uff0c\u6765\u770b\u4e0b\u9762\u8fd9\u4e2a\u7c7b\u6bd4\uff08\u8fd9\u662f\u6211\u80fd\u60f3\u5230\u7684\u6700\u597d\u7684\u4f8b\u5b50\uff09\u3002\u5047\u5982\u67d0\u80a1\u7968\u7684\u65e5\u6536\u76ca\u7387\u7531\u8f6c\u8f6e\u76d8\u8d4c\u51b3\u5b9a\uff1a\u8f6c\u5230\u4e0d\u540c\u6570\u5b57\u5c31\u5bf9\u5e94\u4e0d\u540c\u7684\u6536\u76ca\u7387\u3002\u5728\u6bcf\u4e2a\u65f6\u523b \\(t\\) \uff0c\u6211\u4eec\u90fd\u8f6c\u540c\u4e00\u4e2a\u8f6e\u76d8\u8d4c\u5e76\u786e\u5b9a\u6536\u76ca\u7387 \\(r_t\\) \u3002\u53ea\u8981\u8fd9\u4e2a\u8f6e\u76d8\u4e0d\u53d8\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6240\u6709\u7684 \\(t\\) \uff0c\\(r_t\\) \u7684\u6982\u7387\u5206\u5e03\u90fd\u662f\u4e00\u6837\u7684\u3001\u4e0d\u968f\u65f6\u95f4\u53d8\u5316\u3002\u8fd9\u6837\u7684\u65f6\u95f4\u5e8f\u5217 \\(\\{r_t\\}\\) \u5c31\u662f\uff08\u4e25\u683c\uff09\u5e73\u7a33\u7684\u3002\u5982\u679c\u4ece\u67d0\u4e2a\u65f6\u523b \\(t'\\) \u5f00\u59cb\uff0c\u8f6e\u76d8\u53d1\u751f\u4e86\u53d8\u5316\uff08\u6bd4\u5982\u8f6e\u76d8\u4e0a\u9762\u7684\u6570\u5b57\u53d8\u591a\u4e86\uff09\uff0c\u90a3\u4e48\u663e\u7136\u4ece \\(t+ \\ge t'\\) \u5f00\u59cb\uff0c \\(r_t\\) \u7684\u5206\u5e03\u5c31\u4fbf\u968f\u4e4b\u53d1\u751f\u53d8\u5316\uff0c\u56e0\u6b64\u65f6\u95f4\u5e8f\u5217 \\(\\{r_t\\}\\) \u5c31\u4e0d\u662f\u5e73\u7a33\u7684\u3002</p> <p>\u5728\u6570\u5b66\u4e0a\uff0c\u65f6\u95f4\u5e8f\u5217\u7684**\u4e25\u5e73\u7a33\uff08strictly stationary\uff09\u6709\u7740\u66f4\u7cbe\u786e\u7684\u5b9a\u4e49\uff1a\u5b83\u8981\u6c42\u65f6\u95f4\u5e8f\u5217\u4e2d\u4efb\u610f\u7ed9\u5b9a\u957f\u5ea6\u7684\u4e24\u6bb5\u5b50\u5e8f\u5217\u90fd\u6ee1\u8db3\u76f8\u540c\u7684\u8054\u5408\u5206\u5e03\u3002**\u8fd9\u662f\u4e00\u4e2a\u5f88\u5f3a\u7684\u6761\u4ef6\uff0c\u5728\u5b9e\u9645\u4e2d\u51e0\u4e4e\u4e0d\u53ef\u80fd\u88ab\u6ee1\u8db3\u3002**\u56e0\u6b64\u6211\u4eec\u8fd8\u6709**\u5f31\u5e73\u7a33\uff08weakly stationary\uff09**\u7684\u5b9a\u4e49\uff0c\u5b83\u8981\u6c42\u65f6\u95f4\u5e8f\u5217\u6ee1\u8db3\u5747\u503c\u5e73\u7a33\u6027\uff08stationary in mean\uff09\u548c\u4e8c\u9636\u5e73\u7a33\u6027\uff08secondary order stationary\uff09**\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217 \\(\\{r_t\\}\\) \u6ee1\u8db3\u4ee5\u4e0b\u4e24\u4e2a\u6761\u4ef6\uff0c\u5219\u5b83\u662f\u5f31\u5e73\u7a33\u7684\uff1a</p> <ol> <li>\u5bf9\u4e8e\u6240\u6709\u7684\u65f6\u523b \\(t\\) \uff0c\u6709 \\(E[r_t] = \\mu\\) \uff0c\u5176\u4e2d \\(\\mu\\) \u662f\u4e00\u4e2a\u5e38\u6570\u3002</li> <li>\u5bf9\u4e8e\u6240\u6709\u7684\u65f6\u523b $$ \u548c\u4efb\u610f\u7684\u95f4\u9694 \\(k\\) \uff0c\\(r_t\\) \u548c \\(r_{t-k}\\) \u7684\u534f\u65b9\u5dee \\(\\sigma(r_t,r_{t-k})\\)\uff0c\u5176\u4e2d\\(\\gamma_k\\) \u4e0e\u65f6\u95f4\\(t\\) \u65e0\u5173\uff0c\u5b83\u4ec5\u4ec5\u4f9d\u8d56\u4e8e\u95f4\u9694 \\(k\\) \u3002\u7279\u522b\u7684\uff0c\u5f53 \\(k=0\\) \u65f6\uff0c\u8fd9\u4e2a\u7279\u6027\u610f\u5473\u7740 \\(\\sigma(r_t,r_t)\\) \u2014\u2014 \\(r_t\\) \u7684\u65b9\u5dee \u2014\u2014 \u4e0d\u968f\u65f6\u95f4\u53d8\u5316\uff0c\u7b49\u4e8e\u4e00\u4e2a\u4e0e\u65f6\u95f4 \\(t\\) \u65e0\u5173\u7684\u5e38\u6570\\(\\gamma_0\\)\uff0c\u8fd9\u79f0\u4e3a**\u65b9\u5dee\u5e73\u7a33\u6027\uff08stationary in variance\uff09**\u3002</li> </ol> <p>\u5f31\u5e73\u7a33\u5047\u8bbe\u5bf9\u4e8e\u5206\u6790\u6295\u8d44\u54c1\u6536\u76ca\u7387\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u4e3a\u4e86\u89e3\u91ca\u8fd9\u4e00\u70b9\uff0c\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\u3002\u5047\u8bbe\u6211\u4eec\u60f3\u77e5\u9053 2017 \u5e74 5 \u6708 16 \u65e5\u8fd9\u5929\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u7684\u5747\u503c\u662f\u591a\u5c11\uff0c\u800c\u6211\u4eec\u7684\u731c\u60f3\u662f\u5b83\u6765\u81ea\u4e00\u4e2a\u672a\u77e5\u7684\u5206\u5e03\u3002\u4e5f\u8bb8\u4f60\u4f1a\u9a6c\u4e0a\u8bf4\u201c\u67e5\u4e00\u4e0b Wind \u4e0d\u5c31\u77e5\u9053\u4e86\uff1f\u4e0a\u8bc1\u6307\u6570\u90a3\u5929\u7684\u6536\u76ca\u7387\u662f 0.74%\u201d\u3002\u6ce8\u610f\uff0c0.74% \u8fd9\u4e2a\u6570\u503c\u4ec5\u4ec5\u662f\u90a3\u5929\u4e0a\u8bc1\u6307\u6570\u672a\u77e5\u6536\u76ca\u7387\u5206\u5e03\u7684\u4e00\u4e2a\u5b9e\u73b0\uff08realization\uff09\uff01\u5b83\u4e0d\u662f\u5747\u503c\uff0c\u56e0\u6b64\u4ece\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u89d2\u5ea6\u6765\u8bf4\u4ec5\u4ec5\u77e5\u9053 0.74% \u8fdc\u8fdc\u4e0d\u591f\u3002</p> <p>\u5bf9\u4e8e\u4e00\u822c\u7684\u672a\u77e5\u6982\u7387\u5206\u5e03\uff0c\u53ea\u8981\u901a\u8fc7\u8fdb\u884c\u5927\u91cf\u91cd\u590d\u6027\u5b9e\u9a8c\uff0c\u5c31\u53ef\u4ee5\u6709\u8db3\u591f\u591a\u7684\u72ec\u7acb\u89c2\u6d4b\u70b9\u6765\u8fdb\u884c\u7edf\u8ba1\u63a8\u65ad\uff08\u8ba1\u7b97\u5747\u503c\u548c\u65b9\u5dee\u8fd9\u4e9b\u7edf\u8ba1\u91cf\uff09\u3002**\u6309\u7167\u8fd9\u4e2a\u601d\u8def\uff0c\u6211\u4eec\u5fc5\u987b\u628a 2017 \u5e74 5 \u6708 16 \u65e5\u8fd9\u4e00\u5929\u7ecf\u5386\u8bb8\u591a\u904d\uff0c\u5f97\u5230\u8bb8\u591a\u4e2a\u90a3\u5929\u7684\u6536\u76ca\u7387\u89c2\u6d4b\u503c\uff0c\u7136\u540e\u7528\u8fd9\u4e9b\u89c2\u6d4b\u503c\u8ba1\u7b97\u51fa\u6536\u76ca\u7387\u7684\u5747\u503c\u3002**\u4e0d\u5e78\u7684\u662f\uff0c\u5386\u53f2\u53ea\u53d1\u751f\u4e00\u6b21\uff0c\u65f6\u95f4\u4e5f\u4e00\u53bb\u4e0d\u590d\u8fd4\uff0c\u6211\u4eec\u53ea\u80fd\u5b9e\u5b9e\u5728\u5728\u7684\u7ecf\u5386\u4e00\u904d 2017 \u5e74 5 \u6708 16 \u65e5\uff0c\u53ea\u80fd\u5f97\u5230\u4e00\u4e2a\u6536\u76ca\u7387\u7684\u89c2\u6d4b\u70b9\uff0c\u5373 0.74%\u3002\u56e0\u6b64\u8fd9\u4e2a\u65b9\u6cd5\u5bf9\u4e8e\u91d1\u878d\u6570\u636e\u662f\u884c\u4e0d\u901a\u7684\u3002</p> <p>\u7136\u800c\uff0c\u5982\u679c\u6211\u4eec\u5047\u8bbe\u4e0a\u8bc1\u6307\u6570\u7684\u6536\u76ca\u7387\u5e8f\u5217\u6ee1\u8db3\u5f31\u5e73\u7a33\uff0c\u5c31\u67f3\u6697\u82b1\u660e\u4e86\u3002\u6839\u636e\u5f31\u5e73\u7a33\u5047\u8bbe\uff0c\u4e0a\u8bc1\u6307\u6570\u7684\u65e5\u6536\u76ca\u7387\u5e8f\u5217\\(\\{r_t\\}\\) \u7684\u5747\u503c\u662f\u4e00\u4e2a\u4e0e\u65f6\u95f4\u65e0\u5173\u7684\u5e38\u6570\uff0c\u5373 \\(E[r_t] = \\mu\\) \u3002\u8fd9\u6837\u4fbf\u53ef\u4ee5\u5229\u7528\u4e00\u6bb5\u65f6\u95f4\u7684\u5386\u53f2\u6570\u636e\u6765\u8ba1\u7b97\u51fa\u65e5\u6536\u76ca\u7387\u7684\u5747\u503c\u3002 \u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e0a\u8bc1\u6307\u6570\u5728 2017 \u5e74\u4ea4\u6613\u65e5\u7684\u65e5\u6536\u76ca\u7387\u5e8f\u5217\u53d6\u5e73\u5747\uff0c\u628a\u5b83\u4f5c\u4e3a\u5bf9\u603b\u4f53\u5747\u503c \\(\\mu\\) \u7684\u4e00\u4e2a\u4f30\u8ba1\u3002\u6839\u636e\u5f31\u5e73\u7a33\u6027\uff0c\u8be5\u5e73\u5747\u503c\u4e5f\u6b63\u662f 2017 \u5e74 5 \u6708 16 \u65e5\u7684\u6536\u76ca\u7387\u5747\u503c\u3002</p> <p>\u540c\u6837\u7684\u9053\u7406\uff0c\u5728\u5f31\u5e73\u7a33\u7684\u5047\u8bbe\u4e0b\uff0c\u53ef\u4ee5\u6839\u636e\u5386\u53f2\u6570\u636e\u65b9\u4fbf\u7684\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u8bf8\u591a\u7edf\u8ba1\u91cf\u8fdb\u884c\u63a8\u65ad\u3002\u5728\u91d1\u878d\u6587\u732e\u4e2d\uff0c\u4e5f\u901a\u5e38\u5047\u5b9a\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217\u662f\u5f31\u5e73\u7a33\u7684\u3002\u53ea\u8981\u6709\u8db3\u591f\u591a\u7684\u5386\u53f2\u6570\u636e\uff0c\u8fd9\u4e2a\u5047\u5b9a\u53ef\u4ee5\u7528\u5b9e\u8bc1\u65b9\u6cd5\u9a8c\u8bc1\u3002\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6570\u636e\u5206\u6210\u82e5\u5e72\u4e2a\u5b50\u96c6\uff0c\u5e76\u5206\u522b\u8ba1\u7b97\u6bcf\u4e2a\u5b50\u96c6\u7684\u7edf\u8ba1\u91cf\uff0c\u7136\u540e\u901a\u8fc7\u7edf\u8ba1\u7684\u624b\u6bb5\u68c0\u9a8c\u8fd9\u4e9b\u6765\u81ea\u4e0d\u540c\u5b50\u96c6\u7684\u7edf\u8ba1\u91cf\u7684\u4e00\u81f4\u6027\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5373\u4fbf\u662f\u5f31\u5e73\u7a33\u6027\uff0c\u6709\u65f6\u91d1\u878d\u6570\u636e\u4e5f\u65e0\u6cd5\u6ee1\u8db3\u3002\u56de\u60f3\u7b2c\u4e8c\u8282\u4e2d\u90a3\u4e2a\u4e0a\u8bc1\u6307\u6570\u65e5\u6536\u76ca\u7387\u6807\u51c6\u5dee\u7684\u56fe\uff0c\u5b83\u6e05\u6670\u7684\u8bf4\u660e\uff0c\u5728 2001 \u5230 2017 \u5e74\u4e4b\u95f4\uff0c\u6807\u51c6\u5dee\u662f\u968f\u65f6\u95f4\u53d8\u5316\u7684\u3002\u8fd9\u610f\u5473\u7740\u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u6536\u76ca\u7387\u5e8f\u5217\u4e0d\u6ee1\u8db3\u4e8c\u9636\u5e73\u7a33\u6027\u3002\u5bf9\u4e8e\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u66f4\u590d\u6742\u7684\u975e\u7ebf\u6027\u6a21\u578b\u5bf9\u6ce2\u52a8\u7387\u5efa\u6a21\uff08\u6bd4\u5982 GARCH\uff09\uff0c\u53c8\u6216\u8005\u53ef\u4ee5\u628a\u65f6\u95f4\u6bb5\u7ec6\u5206\u4e3a\u66f4\u77ed\u7684\u533a\u95f4\uff0c\u4f7f\u5f97\u5728\u6bcf\u4e2a\u5c0f\u533a\u95f4\u5185\u7684\u6536\u76ca\u7387\u5e8f\u5217\u5c3d\u91cf\u6ee1\u8db3\u5f31\u5e73\u7a33\u6027\u3002</p> <p>\u6709\u4e86\u4e0a\u4e00\u8282\u548c\u672c\u8282\u7684\u5185\u5bb9\u505a\u94fa\u57ab\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u53ef\u4ee5\u804a\u804a\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u4e86\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#5","title":"5 \u81ea\u76f8\u5173\u6027\u548c\u81ea\u76f8\u5173\u51fd\u6570","text":"<p>\u5047\u8bbe\u6211\u4eec\u6709\u5f31\u5e73\u7a33\u7684\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217 \\(\\{r_t\\}\\) \u3002\u81ea\u76f8\u5173\u6027\u8003\u5bdf\u7684\u662f \\(t\\) \u65f6\u523b\u7684\u6536\u76ca\u7387 \\(r_t\\) \u548c\u8ddd\u5f53\u524d\u4efb\u610f\u95f4\u9694 \\(k\\) \u65f6\u523b\u7684\u6536\u76ca\u7387\\(r_{t-k}\\) \u4e4b\u95f4\u7684\u7ebf\u6027\u76f8\u4f9d\u5173\u7cfb\uff08\\(k\\) \u7684\u53d6\u503c\u662f\u6240\u6709 \\(\\ge 0\\) \u7684\u6574\u6570\uff09\u3002\u7531\u4e8e \\(r_t\\) \u548c \\(r_{t-k}\\) \u6765\u81ea\u540c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u7b2c\u4e09\u8282\u4e2d\u7684\u76f8\u5173\u7cfb\u6570\u7684\u6982\u5ff5\u5e94\u7528\u5230 \\(r_t\\) \u548c \\(r_{t-k}\\) \u4e0a\uff0c\u4fbf\u63a8\u5e7f\u51fa\u81ea\u76f8\u5173\u7cfb\u6570\uff08autocorrelation\uff09\u3002</p> <p>\u5b9a\u4e49\uff1a\\(r_t\\) \u548c \\(r_{t-k}\\) \u7684\u76f8\u5173\u7cfb\u6570\u79f0\u4e3a \\(r_t\\) \u7684\u95f4\u9694\u4e3a \\(k\\)  \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u3002</p> <p>\u5728\u5f31\u5e73\u7a33\u5047\u8bbe\u4e0b\uff0c\u8fd9\u4e2a\u95f4\u9694\u4e3a \\(k\\) \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e0e\u65f6\u95f4 \\(t\\)  \u65e0\u5173\uff0c\u800c\u4ec5\u4ec5\u4e0e\u95f4\u9694 \\(k\\) \u6709\u5173\uff0c\u7531 \\(\\rho_k\\) \u8868\u793a\u3002\u7531\u7b2c\u4e09\u8282\u4e2d\u4ecb\u7ecd\u7684\u76f8\u5173\u7cfb\u6570\u7684\u5b9a\u4e49\u53ef\u77e5\uff1a</p> \\[ \\rho_k = \\frac{Cov(r_t,r_{t-k})}{\\sigma_{r_t}\\sigma_{r_{t-k}}} = \\frac{Cov(r_t,r_{t-k})}{\\sigma_{r_t}\\sigma_{r_t}} = \\frac{\\gamma_k}{\\gamma_0} \\] <p>\u4e0a\u9762\u7684\u63a8\u5bfc\u4e2d\u7528\u5230\u4e86\u5f31\u5e73\u7a33\u7684\u6027\u8d28\uff0c\u5373\u534f\u65b9\u5dee\u548c\u65b9\u5dee\u5e73\u7a33\u6027\uff08\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e8c\u9636\u5e73\u7a33\u6027\uff09\u3002\u4ece\u8fd9\u4e2a\u5b9a\u4e49\u4e0d\u96be\u770b\u51fa\uff0c\u5f53 \\(k=0\\) \u65f6\u6709\uff1a</p> \\[\\rho_0 = \\frac{\\gamma_0}{\\gamma_0} = 1\\] <p>\u8fd9\u8868\u793a \\(r_t\\) \u7684\u95f4\u9694\u4e3a 0 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u6052\u5b9a\u4e3a 1\u3002\u6b64\u5916\uff0c \\(\\rho_k\\) \u8fd8\u6709\u5982\u4e0b\u7684\u6027\u8d28\uff1a</p> \\[ \\rho_k = \\rho_{-k} \\\\ -1 \\le \\rho_k \\le 1  \\] <p>\u548c\u7b2c\u4e09\u8282\u4e00\u6837\uff0c\u4e0a\u9762\u5b9a\u4e49\u7684\\(\\rho_k\\) \u662f\u603b\u4f53\u7684\u7edf\u8ba1\u7279\u6027\u3002\u5b9e\u9645\u4e2d\uff0c\u6211\u4eec\u4ecd\u7136\u53ea\u80fd\u901a\u8fc7\u6709\u9650\u7684\u6837\u672c\u6570\u636e\u6765\u8ba1\u7b97\u6837\u672c\u7684\u7edf\u8ba1\u7279\u6027\u3002\u4ee4 \\(\\zeta_k\\) \u4e3a\u4e0e $rho_k$ \u5bf9\u5e94\u7684\u6837\u672c\u7edf\u8ba1\u91cf\uff0c\u5219\u6709\uff1a</p> \\[ \\zeta_k = \\frac{c_k}{c_0} \\\\ c_k = \\frac{1}{n}\\sum_{t=1}^{n-k}{(r_t - \\bar{r})(r_{t+k} - \\bar{r})} \\] <p>\u4e0a\u5f0f\u4e2d\uff0c \\(c_k\\) \u662f \\(r_t\\) \u7684\u95f4\u9694\u4e3a \\(k\\) \u7684\u6837\u672c\u81ea\u534f\u65b9\u5dee\uff08sample autocovariance of lag  \\(k\\))\uff1b \\(\\zeta_k\\) \u4e3a \\(r_t\\) \u7684**\u95f4\u9694\u4e3a \\(k\\) \u7684\u6837\u672c\u81ea\u76f8\u5173\u7cfb\u6570\uff08sample autocorrelation of lag \\(k\\)\uff09**\u3002</p> <p>\u5982\u679c\u628a \\(\\zeta_k\\) \u770b\u4f5c\u662f \\(k\\) \u7684\u65b9\u7a0b\uff0c\u5219\u5b83\u901a\u5e38\u88ab\u79f0\u4e3a\u6837\u672c\u81ea\u76f8\u5173\u65b9\u7a0b\uff08sample autocorrelation function\uff1b\u540c\u6837\u7684\uff0c\\(\\rho_k\\) \u4e3a\u603b\u4f53\u81ea\u76f8\u5173\u65b9\u7a0b\uff09\uff0c\u5b83\u523b\u753b\u4e86\u65f6\u95f4\u5e8f\u5217\u7684\u91cd\u8981\u7279\u6027\u3002\u5229\u7528\u76f8\u5173\u56fe\uff08correlogram\uff09\u53ef\u4ee5\u6e05\u6670\u5730\u770b\u5230 \\(\\zeta_k\\) \u662f\u5982\u4f55\u968f\u95f4\u9694 \\(k\\) \u53d8\u5316\u7684\u3002</p> <p>\u4e0b\u56fe\u4e3a\u4e24\u4e2a\u5047\u60f3\u65f6\u95f4\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u3002\u5b83\u4eec\u5448\u73b0\u51fa\u5b8c\u5168\u4e0d\u540c\u7ed3\u6784\u7684\u81ea\u76f8\u5173\u6027\u3002\u4e8b\u5b9e\u4e0a\uff0c\u7b2c\u4e00\u4e2a\u76f8\u5173\u56fe\u7684\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u660e\u663e\u7684\u8d8b\u52bf\uff1b\u800c\u7b2c\u4e8c\u4e2a\u76f8\u5173\u56fe\u7684\u65f6\u95f4\u5e8f\u5217\u5b58\u5728\u660e\u663e\u7684\u5468\u671f\u6027\u3002\u8fd9\u4e24\u4e2a\u4f8b\u5b50\u8bf4\u660e\u76f8\u5173\u56fe\u53ef\u4ee5\u544a\u8bc9\u6211\u4eec\u5f88\u591a\u65f6\u95f4\u5e8f\u5217\u7684\u5185\u5728\u7279\u6027\u3002</p> <p></p> <p>\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u867d\u7136\u8fdc\u6ca1\u6709\u8fd9\u4e24\u4e2a\u5047\u8c61\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u8fd9\u4e48\u6709\u7ed3\u6784\uff0c\u4f46\u76f8\u5173\u56fe\u5728\u6211\u4eec\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u65f6\u81f3\u5173\u91cd\u8981\u3002\u4e4b\u524d\u5df2\u7ecf\u8bf4\u8fc7\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\uff0c\u7279\u522b\u662f\u6536\u76ca\u7387\u5e8f\u5217\uff0c\u6700\u91cd\u8981\u7684\u7279\u6027\u662f\u4e00\u4e9b\u4e0d\u5bb9\u6613\u88ab\u53d1\u73b0\u7684\u81ea\u76f8\u5173\u6027\u3002\uff08\u901a\u5e38\u80a1\u7968\u7684\u6536\u76ca\u7387\u5e8f\u5217\u6ca1\u6709\u5b63\u8282\u6027\u6216\u8005\u660e\u663e\u7684\u8d8b\u52bf\u6027\uff1b\u5373\u4fbf\u662f\u5f31\u8d8b\u52bf\u4e5f\u53ef\u4ee5\u7531\u81ea\u76f8\u5173\u6027\u53cd\u5e94\u3002\uff09\u56e0\u6b64\uff0c\u62ff\u6765\u4e00\u4e2a\u6536\u76ca\u7387\u5e8f\u5217\uff0c\u53ea\u8981\u753b\u51fa\u76f8\u5173\u56fe\uff0c\u5c31\u53ef\u4ee5\u68c0\u6d4b\u8be5\u5e8f\u5217\u5728\u4efb\u4f55\u95f4\u9694\\(k\\) \u6709\u65e0\u7edf\u8ba1\u4e0a\u663e\u8457\u7684\u81ea\u76f8\u5173\u6027\u3002</p> <p>\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\uff0c\u6700\u91cd\u8981\u7684\u5c31\u662f\u6316\u6398\u51fa\u8be5\u5e8f\u5217\u4e2d\u7684\u4e0d\u540c\u95f4\u9694 \\(k\\) \u7684\u81ea\u76f8\u5173\u6027\u3002\u76f8\u5173\u56fe\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5224\u65ad\u6a21\u578b\u662f\u5426\u5408\u9002\u3002 \u8fd9\u662f\u56e0\u4e3a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u4e2d\u5f80\u5f80\u5305\u62ec\u76f8\u5173\u6027\u548c\u968f\u673a\u566a\u58f0\u3002\u5982\u679c\u6a21\u578b\u5f88\u597d\u7684\u6355\u6349\u4e86\u81ea\u76f8\u5173\u6027\uff0c\u90a3\u4e48\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e0e\u6a21\u578b\u62df\u5408\u7684\u65f6\u95f4\u5e8f\u5217\u4e4b\u95f4\u7684\u6b8b\u5dee\u5e94\u8be5\u8fd1\u4f3c\u7684\u7b49\u4e8e\u968f\u673a\u566a\u58f0\u3002 \u6b8b\u5dee\u5e8f\u5217\u81ea\u7136\u4e5f\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u56e0\u6b64\u53ef\u4ee5\u5bf9\u5b83\u753b\u51fa\u76f8\u5173\u56fe\u3002**\u4e00\u4e2a\u6807\u51c6\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u6ee1\u8db3 \\(\\rho_0 = 1\\) \u4ee5\u53ca \\(\\rho_k = 0, k=1,2,3,\\cdots\\) \u5373\u5bf9\u4e8e\u4efb\u610f\u4e0d\u4e3a 0 \u7684\u95f4\u9694\uff0c\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u5747\u4e3a 0\u3002**\u4e0b\u56fe\u4e3a\u4e00\u4e2a\u968f\u673a\u566a\u58f0\u7684\u76f8\u5173\u56fe\uff08\u6211\u4eec\u662f\u7528\u6807\u51c6\u6b63\u6001\u5206\u5e03\u6784\u9020\u4e86\u6709 500 \u4e2a\u70b9\u7684\u968f\u673a\u566a\u58f0\u5e8f\u5217\uff09\uff1a</p> <p></p> <p>\u5173\u4e8e\u8fd9\u4e2a\u56fe\uff1a</p> <ol> <li>\u663e\u7136\uff0c\u95f4\u9694\u4e3a 0 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 1\uff1b</li> <li>\u5bf9\u4e8e\u4efb\u610f\u7684 \\(k \\ge 1\\) \uff0c\u84dd\u8272\u7684\u9634\u5f71\u533a\u57df\u4e3a 95% \u7684\u7f6e\u4fe1\u533a\u95f4\u3002\u56e0\u6b64\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u53ea\u8981\u6ca1\u6709\u8d85\u8fc7\u84dd\u8272\u9634\u5f71\u533a\u57df\uff0c\u6211\u4eec\u5c31\u65e0\u6cd5\u5728 5% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\uff08\u539f\u5047\u8bbe\u4e3a\u95f4\u9694\u4e3a \\(k\\) \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 0\uff09\u3002\u4e0a\u56fe\u7684\u7ed3\u679c\u8bf4\u660e\u5f53 \\(k\\) \u4e0d\u4e3a 0 \u65f6\uff0c\u968f\u673a\u566a\u58f0\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u4e3a 0\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u5728\u8bc4\u4ef7\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u5efa\u6a21\u662f\u5426\u5408\u9002\u65f6\uff0c\u6211\u4eec\u9996\u5148\u627e\u5230\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u548c\u5b83\u7684\u62df\u5408\u5e8f\u5217\u4e4b\u95f4\u7684\u6b8b\u5dee\u5e8f\u5217\uff1b\u7136\u540e\u53ea\u8981\u753b\u51fa\u8fd9\u4e2a**\u6b8b\u5dee\u5e8f\u5217**\u7684\u76f8\u5173\u56fe\u5c31\u53ef\u4ee5\u770b\u5230\u5b83\u662f\u5426\u542b\u6709\u4efb\u4f55\u6a21\u578b\u672a\u8003\u8651\u7684\u989d\u5916\u81ea\u76f8\u5173\u6027\uff1a</p> <p>\u5982\u679c\u6b8b\u5dee\u7684\u76f8\u5173\u56fe\u548c\u4e0a\u9762\u8fd9\u4e2a\u56fe\u76f8\u4f3c\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u6b8b\u5dee\u662f\u4e00\u4e2a\u968f\u673a\u566a\u58f0\uff0c\u800c\u6a21\u578b\u5df2\u7ecf\u5f88\u597d\u7684\u6355\u6349\u4e86\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\uff1b</p> <p>\u5982\u679c\u6b8b\u5dee\u7684\u76f8\u5173\u56fe\u4f53\u73b0\u4e86\u989d\u5916\u7684\u81ea\u76f8\u5173\u6027\uff0c\u5b83\u4eec\u5c06\u4e3a\u6211\u4eec\u6539\u8fdb\u5df2\u6709\u7684\u6a21\u578b\u63d0\u4f9b\u4f9d\u636e\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u989d\u5916\u7684\u81ea\u76f8\u5173\u8bf4\u660e\u5df2\u6709\u6a21\u578b\u6ca1\u6709\u8003\u8651\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u5728\u67d0\u4e9b\u7279\u5b9a\u95f4\u9694\u4e0a\u7684\u81ea\u76f8\u5173\u3002</p>"},{"location":"courses/time-series-analysis/01-basic/#6","title":"6 \u4e0b\u6587\u9884\u544a","text":"<p>\u4f5c\u4e3a\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7cfb\u5217\u7684\u5f00\u7bc7\uff0c\u672c\u6587\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u6027\u548c\u8fdb\u884c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u5e76\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u81ea\u76f8\u5173\u6027\u3002\u5bf9\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u6838\u5fc3\u5c31\u662f\u6355\u6349\u8be5\u5e8f\u5217\u4e2d\u4e0d\u540c\u95f4\u9694\u4e0a\u7684\u81ea\u76f8\u5173\u6027\u3002\u76f8\u5173\u56fe\u53ef\u4ee5\u6e05\u6670\u5730\u523b\u753b\u4efb\u4f55\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5728\u4e0d\u540c\u95f4\u9694\u7684\u81ea\u76f8\u5173\u6027\u3002</p> <p>\u5728\u4e0b\u4e00\u7bc7\u4e2d\uff0c\u6211\u4eec\u5c06\u4f1a\u4ece\u6700\u7b80\u5355\u7684\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u51fa\u53d1\uff0c\u8bf4\u660e\u5b83\u4eec\u65e0\u6cd5\u6709\u6548\u523b\u753b\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u4f53\u73b0\u51fa\u6765\u7684\u81ea\u76f8\u5173\u6027\u3002\u8fd9\u4f1a\u4fc3\u4f7f\u6211\u4eec\u63d0\u51fa\u66f4\u9ad8\u7ea7\u7684\u6a21\u578b\uff0c\u5305\u62ec AR\uff0cMA\uff0c\u4ee5\u53ca ARMA\u3002\u8fd9\u4e9b\u6a21\u578b\u80cc\u540e\u7684\u7406\u8bba\u662f\u4ec0\u4e48\uff1f\u5982\u4f55\u6b63\u786e\u7684\u6311\u9009\u6a21\u578b\u7684\u53c2\u6570\u4ee5\u6784\u5efa\u6700\u9002\u5f53\u7684\u6a21\u578b\uff1f\u8fd9\u4e9b\u5c06\u4f1a\u5728\u672c\u7cfb\u5217\u540e\u9762\u51e0\u7bc7\u6587\u7ae0\u4e2d\u63a2\u8ba8\u3002</p> <p>\uff08\u5168\u6587\u5b8c\uff09</p> <p>\u514d\u8d23\u58f0\u660e\uff1a \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>"},{"location":"courses/time-series-analysis/02-primer/","title":"\u521d\u7ea7\u7bc7","text":"<p>Source</p>"},{"location":"courses/time-series-analysis/02-primer/#1","title":"1 \u524d\u6587\u56de\u987e","text":"<p>\u524d\u6587\u2014\u2014\u300a\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\uff1a\u57fa\u7840\u7bc7\u300b\u2014\u2014\u4ecb\u7ecd\u4e86\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u6838\u5fc3\u7279\u6027\uff1a\u81ea\u76f8\u5173\u6027\uff1b\u8bf4\u660e**\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u6838\u5fc3\u6b63\u662f\u6316\u6398\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027**\u3002\u4e00\u4e2a\u4f18\u79c0\u7684\u6a21\u578b\u5e94\u8be5\u80fd\u591f\u6709\u6548\u7684\u523b\u753b\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e2d\u4e0d\u540c\u95f4\u9694\u7684\u81ea\u76f8\u5173\u6027\uff1b\u800c\u8861\u91cf\u4e00\u4e2a\u6a21\u578b\u662f\u5426\u9002\u5408\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u51c6\u6b63\u662f\u8003\u5bdf\u539f\u59cb\u503c\u548c\u62df\u5408\u503c\u4e4b\u95f4\u7684\u6b8b\u5dee\u5e8f\u5217\u662f\u5426\u8fd1\u4f3c\u7684\u4e3a\u767d\u566a\u58f0\u3002</p> <p>\u672c\u7bc7\u662f\u7cfb\u5217\u7684\u7b2c\u4e8c\u7bc7\uff0c\u521d\u7ea7\u7bc7\u3002\u767d\u566a\u58f0\u6b63\u662f\u672c\u6587\u7684\u5185\u5bb9\u4e4b\u4e00\uff0c\u5b83\u662f\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u6700\u57fa\u672c\u7684\u6a21\u578b\u3002\u5728\u5b83\u7684\u57fa\u7840\u4e0a\u5ef6\u4f38\u51fa\u7684\u53e6\u4e00\u4e2a\u57fa\u672c\u6a21\u578b\u4fbf\u662f\u968f\u673a\u6e38\u8d70\u3002\u901a\u5e38\uff0c\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u88ab\u8ba4\u4e3a\u662f\u7528\u6765\u5206\u522b\u63cf\u8ff0\u6295\u8d44\u54c1\u6536\u76ca\u7387\u548c\u4ef7\u683c\u7684\u6700\u7b80\u5355\u6a21\u578b\u3002\u6211\u4eec\u7a0d\u540e\u4f1a\u770b\u5230\uff0c\u5bf9\u4e8e\u6536\u76ca\u7387\u6765\u8bf4\uff08\u7279\u522b\u662f\u80a1\u6307\u7684\u6536\u76ca\u7387\uff09\uff0c\u767d\u566a\u58f0\u6a21\u578b\u5e76\u4e0d\u6709\u6548\u3002</p>"},{"location":"courses/time-series-analysis/02-primer/#2","title":"2 \u65f6\u95f4\u5e8f\u5217\u5efa\u6a21","text":"<p>\u672c\u8d28\u4e0a\u8bf4\u8bb2\uff0c\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u662f\u4e00\u4e2a\u53ef\u4ee5\u201c\u89e3\u91ca\u201d\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\u7684\u6570\u5b66\u6a21\u578b\u3002</p> <p>\u80fd\u591f\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\u610f\u4e49\u91cd\u5927\uff1a</p> <p>\u6211\u4eec\u5047\u8bbe\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\uff08\u6bd4\u5982\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\uff09\u5b58\u5728\u672a\u77e5\u7684\u81ea\u76f8\u5173\u6027\uff08\u5f53\u7136\u4e5f\u4f34\u968f\u7740\u566a\u58f0\uff09\uff0c\u800c\u8fd9\u79cd\u81ea\u76f8\u5173\u6027\u4f53\u73b0\u4e86\u8be5\u65f6\u95f4\u5e8f\u5217\u67d0\u79cd\u5185\u5728\u7684\u7279\u6027\uff08\u6bd4\u5982\u8d8b\u52bf\u3001\u6216\u8005\u5747\u503c\u56de\u590d\uff09\uff0c\u800c\u8fd9\u79cd\u5185\u5728\u7279\u6027\u662f\u53ef\u4ee5\u5ef6\u7eed\u7684\uff08\u81f3\u5c11\u5728\u672a\u6765\u77ed\u65f6\u95f4\u5185\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5e0c\u671b\u901a\u8fc7\u5bf9\u5386\u53f2\u6570\u636e\u7684\u62df\u5408\u627e\u5230\u4e00\u4e2a\u5408\u9002\u7684\u6a21\u578b\uff0c\u4f7f\u5f97\u5b83\u80fd\u6700\u5927\u7a0b\u5ea6\u7684\u89e3\u91ca\u8be5\u65f6\u95f4\u5e8f\u5217\u8868\u73b0\u51fa\u6765\u7684\u81ea\u76f8\u5173\u6027\u3002\u57fa\u4e8e\u672a\u6765\u4f1a\u91cd\u590d\u5386\u53f2\u7684\u5047\u8bbe\uff0c\u6211\u4eec\u5728\u7edf\u8ba1\u4e0a\u9884\u671f\u8fd9\u79cd\u81ea\u76f8\u5173\u6027\u5b58\u5728\u4e8e\u672a\u6765\u7684\u5e8f\u5217\u4e2d\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6a21\u578b\u8003\u8651\u4e86\u8fd9\u79cd\u81ea\u76f8\u5173\u6027\uff0c\u56e0\u6b64\u5b83\u5c06\u4f1a\u5e2e\u52a9\u6211\u4eec\u6765\u9884\u6d4b\u672a\u6765\u3002</p> <p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e3a\u6211\u4eec\u7814\u7a76\u6295\u8d44\u54c1\u6536\u76ca\u7387\u7684\u884c\u4e3a\u63d0\u4f9b\u4e86\u6709\u529b\u7684\u7edf\u8ba1\u5b66\u6846\u67b6</p> <p>\u5728\u6295\u8d44\u4e2d\uff0c\u5bf9\u6536\u76ca\u7387\u7684\u9884\u6d4b\u663e\u7136\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u5982\u679c\u6211\u4eec\u80fd\u591f\u9884\u6d4b\u6295\u8d44\u54c1\u7684\u6da8\u8dcc\uff0c\u90a3\u4e48\u5c31\u80fd\u57fa\u4e8e\u6b64\u6784\u5efa\u4e00\u4e2a\u4ea4\u6613\u7b56\u7565\uff1b\u5982\u679c\u6211\u4eec\u80fd\u591f\u9884\u6d4b\u6536\u76ca\u7387\u7684\u6ce2\u52a8\u7387\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u8fdb\u884c\u98ce\u9669\u7ba1\u7406\uff08\u56e0\u6b64\u6211\u4eec\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u4e8c\u9636\u7edf\u8ba1\u91cf\u2014\u2014\u5982\u65b9\u5dee\u2014\u2014\u540c\u6837\u611f\u5174\u8da3\uff09\u3002</p> <p>\u5047\u8bbe\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u4e3a \\(\\{y_t\\}\\)\uff0c\u6a21\u578b\u62df\u5408\u51fa\u6765\u7684\u5e8f\u5217\u4e3a \\(\\{p_t\\}\\)\uff0c\u5219\u6b8b\u5dee\u5e8f\u5217 \\(\\{e_t\\}\\) \u5b9a\u4e49\u4e3a\u539f\u59cb\u5e8f\u5217\u548c\u62df\u5408\u5e8f\u5217\u7684\u5dee\u503c\uff1a</p> \\[e_t = y_t - p_t \\] <p>\u5982\u679c\u6a21\u578b\u5f88\u597d\u7684\u6355\u6349\u4e86\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\uff0c\u90a3\u4e48\u6b8b\u5dee\u5e8f\u5217 \\(\\{e_t\\}\\)\u5e94\u8be5\u8fd1\u4f3c\u7684\u4e3a\u767d\u566a\u58f0\uff0c\u5bf9\u4efb\u4f55\u975e\u96f6\u95f4\u9694 \\(k\\)\uff0c\u8be5\u6b8b\u5dee\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u7cfb\u6570 \\(\\rho_k\\) \u90fd\u5e94\u8be5\u5728\u7edf\u8ba1\u610f\u4e49\u4e0a\u4e0d\u663e\u8457\u7684\u504f\u79bb \\(0\\)\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u4ec5\u4ec5\u662f\u6211\u4eec\u8bf4\u8be5\u6a21\u578b\u662f\u4e2a\u4f18\u79c0\u6a21\u578b\u7684\u5145\u5206\u6761\u4ef6\uff0c\u56e0\u4e3a\u4e00\u4e2a\u597d\u6a21\u578b\u6700\u5173\u952e\u7684\u8fd8\u662f\u80fd\u4ea7\u751f\u8d5a\u94b1\u7684\u4ea4\u6613\u4fe1\u53f7\u3002\u56e0\u6b64\uff0c\u6a21\u578b\u7684\u68c0\u9a8c\u6700\u7ec8\u8fd8\u8981\u770b\u5b83\u5728\u6837\u672c\u5916\u9884\u6d4b\u7684\u51c6\u786e\u6027</p> <p>\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u8fc7\u7a0b\u53ef\u4ee5\u603b\u7ed3\u5982\u4e0b\uff1a</p> <p></p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u6211\u4eec\u603b\u662f\u5e0c\u671b\u9996\u5148\u753b\u51fa\u5b83\u7684\u76f8\u5173\u56fe\u6765\u770b\u770b\u5b83\u5b58\u5728\u4ec0\u4e48\u6837\u7684\u81ea\u76f8\u5173\u6027\u3002\u57fa\u4e8e\u5bf9\u5176\u81ea\u76f8\u5173\u6027\u7684\u8ba4\u77e5\uff0c\u7b2c\u4e8c\u6b65\u5219\u662f\u9009\u62e9\u5408\u9002\u7684\u6a21\u578b\uff0c\u6bd4\u5982 AR\u3001MA \u6216\u8005 ARMA \u6a21\u578b\uff0c\u751a\u81f3\u4e8e\u66f4\u9ad8\u7ea7\u5bf9\u6ce2\u52a8\u7387\u5efa\u6a21\u7684 GARCH \u6a21\u578b\u7b49\u3002\u9009\u5b9a\u6a21\u578b\u540e\uff0c\u63a5\u4e0b\u6765\u4fbf\u9700\u8981\u4f18\u5316\u6a21\u578b\u7684\u53c2\u6570\uff0c\u4ee5\u4f7f\u5176\u5c3d\u53ef\u80fd\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002\u5728\u8fd9\u4e00\u6b65\uff0c\u6211\u4eec\u901a\u8fc7\u5bf9\u6b8b\u5dee\u8fdb\u884c\u81ea\u76f8\u5173\u6027\u5206\u6790\u6765\u5224\u65ad\u6a21\u578b\u662f\u5426\u5408\u9002\u3002\u5728\u8fd9\u65b9\u9762\uff0cLjung\u2013Box \u68c0\u9a8c\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u65b9\u6cd5\uff0c\u5b83\u540c\u65f6\u68c0\u9a8c\u7ed9\u6b8b\u5dee\u5e8f\u5217\u5404\u95f4\u9694\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u662f\u5426\u663e\u8457\u7684\u4e0d\u4e3a 0\u3002\u5728\u9009\u5b9a\u6a21\u578b\u53c2\u6570\u4e4b\u540e\uff0c\u4ecd\u9700\u5b9a\u91cf\u8bc4\u4ef7\u8be5\u6a21\u578b\u5728\u6837\u672c\u5916\u9884\u6d4b\u7684\u51c6\u786e\u6027\u3002\u6bd5\u7adf\uff0c\u5bf9\u4e8e\u6837\u672c\u5185\u7684\u6570\u636e\uff0c\u9519\u8bef\u7684**\u8fc7\u62df\u5408**\u603b\u4f1a\u5f97\u5230\u201c\u4f18\u79c0\u201d\u7684\u6a21\u578b\uff0c\u4f46\u5b83\u4eec\u5f80\u5f80\u5bf9\u6837\u672c\u5916\u6570\u636e\u7684\u9884\u6d4b\u6548\u679c\u5f88\u5dee\u3002\u56e0\u6b64\uff0c\u53ea\u6709\u6837\u672c\u5916\u9884\u6d4b\u7684\u51c6\u786e\u6027\u624d\u80fd\u5ba2\u89c2\u7684\u8bc4\u4ef7\u6a21\u578b\u7684\u597d\u574f\u3002\u5982\u679c\u6a21\u578b\u7684\u51c6\u786e\u6027\u8f83\u5dee\uff0c\u8fd9\u8bf4\u660e\u8be5\u6a21\u578b\u5b58\u5728\u7f3a\u9677\uff0c\u65e0\u6cd5\u5145\u5206\u6355\u6349\u539f\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002\u8fd9\u65f6\u5fc5\u987b\u8003\u8651\u66f4\u6362\u6a21\u578b\u3002\u8fd9\u5c31\u6784\u6210\u4e86\u4e0a\u8ff0\u6b65\u9aa4\u7684\u53cd\u9988\u56de\u8def\uff0c\u76f4\u5230\u6700\u7ec8\u627e\u5230\u4e00\u4e2a\u65e2\u80fd\u89e3\u91ca\u539f\u65f6\u95f4\u5e8f\u5217\u81ea\u76f8\u5173\u6027\uff0c\u53c8\u80fd\u5728\u6837\u672c\u5916\u6709\u4e0d\u9519\u7684\u51c6\u786e\u6027\u7684\u6a21\u578b\u3002\u4e4b\u540e\uff0c\u8be5\u6a21\u578b\u5c06\u88ab\u7528\u6765\u4ea7\u751f\u4ea4\u6613\u578b\u53f7\u5e76\u6784\u5efa\u91cf\u5316\u6295\u8d44\u7b56\u7565\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4ecb\u7ecd\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\uff1a\u767d\u566a\u58f0\u3002</p>"},{"location":"courses/time-series-analysis/02-primer/#3","title":"3. \u767d\u566a\u58f0","text":"<p>\u672c\u6587\u7b2c\u4e00\u8282\u6307\u51fa\uff0c\u5bf9\u4e8e\u6536\u76ca\u7387\u6765\u8bf4\uff0c\u767d\u566a\u58f0\uff08white noise\uff09**\u5e76\u4e0d\u662f\u4e00\u4e2a\u5341\u5206\u6709\u6548\u7684\u6a21\u578b\u3002\u90a3\u4e48\u4e3a\u4ec0\u4e48\u6211\u4eec\u8fd8\u8981\u7814\u7a76\u5b83\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5b83\u6709\u4e00\u4e2a\u91cd\u8981\u7684\u7279\u6027\uff0c\u5373**\u5e8f\u5217\u4e0d\u76f8\u5173\uff1a\u4e00\u4e2a\u767d\u566a\u58f0\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u4e2a\u70b9\u90fd\u72ec\u7acb\u7684\u6765\u81ea\u67d0\u4e2a\u672a\u77e5\u7684\u5206\u5e03\uff0c\u5b83\u4eec\u6ee1\u8db3\u72ec\u7acb\u540c\u5206\u5e03\uff08independent and identically distributed\uff09\u3002</p> <p>\u4e00\u4e2a\uff08\u79bb\u6563\uff09\u767d\u566a\u58f0\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <p>\u8003\u8651\u65f6\u95f4\u5e8f\u5217 ({ w_t{}:{}t=1,\\cdots,n } (\u3002\u5982\u679c\u8be5\u5e8f\u5217\u7684\u6210\u5206 \\(w_t\\) \u6ee1\u8db3\u5747\u503c\u4e3a\\)0\\)\uff0c\u65b9\u5dee \\(\\sigma^2\\)\uff0c\u4e14\u5bf9\u4e8e\u4efb\u610f\u7684 (k \\ge 1 \\(\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\\)\\rho_k\\) \u5747\u4e3a \\(0\\) \uff0c\u5219\u79f0\u8be5\u65f6\u95f4\u5e8f\u5217\u4e3a\u4e00\u4e2a\u79bb\u6563\u7684\u767d\u566a\u58f0\u3002</p> <p>\u4e0a\u9762\u7684\u5b9a\u4e49\u5e76\u6ca1\u6709\u5047\u8bbe \\(w_t\\) \u6765\u81ea\u6b63\u6001\u5206\u5e03\u3002\u4e8b\u5b9e\u4e0a\uff0c\u767d\u566a\u58f0\u5bf9\u5206\u5e03\u6ca1\u6709\u8981\u6c42\u3002\u5f53 \\(w_t\\) \u6765\u81ea\u6b63\u6001\u5206\u5e03\u65f6\uff0c\u8be5\u5e8f\u5217\u53c8\u79f0\u4e3a\u9ad8\u65af\u767d\u566a\u58f0\uff08Gaussian white noise\uff09\u3002</p> <p>\u6839\u636e\u767d\u566a\u58f0\u7684\u5b9a\u4e49\uff0c\u4e00\u4e2a\u767d\u566a\u58f0\u5e8f\u5217\u663e\u7136\u6ee1\u8db3\u5e73\u7a33\u6027\u8981\u6c42\u3002\u5b83\u7684\u5747\u503c\u548c\u4e8c\u9636\u7edf\u8ba1\u91cf\u4e3a\uff1a </p> \\[ \\begin{align*} \\mu_w &amp; = &amp; 0  \\\\ \\rho_k &amp; = &amp;  \\begin{cases} 1 &amp; \\text{if } k = 0 \\\\ 0 &amp; \\text{if } k \\ne 0  \\end{cases} \\end{align*} \\] <p>\u6211\u4eec\u5df2\u7ecf\u591a\u6b21\u5f3a\u8c03\uff0c\u5f53\u4e00\u4e2a\u6a21\u578b\u5f88\u597d\u7684\u6355\u6349\u4e86\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\uff0c\u5b83\u7684\u6b8b\u5dee\u5e8f\u5217\u5c31\u5e94\u8be5\u6ca1\u6709\u4efb\u4f55\uff08\u7edf\u8ba1\u610f\u4e49\u4e0a\u663e\u8457\u7684\uff09\u81ea\u76f8\u5173\u6027\u4e86\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e00\u4e2a\u4f18\u79c0\u6a21\u578b\u7684\u6b8b\u5dee\u5e8f\u5217\u5e94\u8be5\uff08\u8fd1\u4f3c\uff09\u4e3a\u4e00\u4e2a\u767d\u566a\u58f0\u3002\u56e0\u6b64\uff0c\u4f7f\u7528\u767d\u566a\u58f0\u5e8f\u5217\u7684\u6027\u8d28\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u786e\u8ba4\u6211\u4eec\u7684\u6b8b\u5dee\u5e8f\u5217\u4e2d\u6ca1\u6709\u4efb\u4f55\u76f8\u5173\u6027\u4e86\uff0c\u4e00\u65e6\u6b8b\u5dee\u5e8f\u5217\u6ca1\u6709\u76f8\u5173\u6027\u4fbf\u610f\u5473\u7740\u6a21\u578b\u662f\u539f\u59cb\u65f6\u95f4\u5e8f\u5217\u7684\u4e00\u4e2a\u826f\u597d\u7684\u62df\u5408\u3002</p> <p>\u5728\u767d\u566a\u58f0\u6a21\u578b\u4e2d\uff0c\u552f\u4e00\u7684\u53c2\u6570\u5c31\u662f\u65b9\u5dee\\(\\sigma^2\\)\u3002\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7\u5386\u53f2\u6570\u636e\u4f30\u8ba1\u5f97\u5230\u3002\u5728\u672c\u7cfb\u5217\u7684\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u66fe\u7ed9\u51fa\u4e86\u4e00\u4e2a\u767d\u566a\u58f0\u5e8f\u5217\u7684\u76f8\u5173\u56fe\uff08\u5982\u4e0b\uff09\uff0c\u8be5\u5e8f\u5217\u7531\u6807\u51c6\u6b63\u6001\u5206\u5e03\u751f\u6210\uff08\u56e0\u6b64\u4e3a\u9ad8\u65af\u767d\u566a\u58f0\uff09\uff0c\u5171 500 \u4e2a\u89c2\u6d4b\u503c\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u5bf9\u56fe\u4e2d\u663e\u793a\u7684\u95f4\u9694 \\(k\\) \u7684\u53d6\u503c\uff0c\u5bf9\u6240\u6709 $k \\ge 1 $ \u5747\u6709\u81ea\u76f8\u5173\u7cfb\u6570\u5728\u7edf\u8ba1\u4e0a\u7b49\u4e8e \\(0\\) \u3002</p> <p></p>"},{"location":"courses/time-series-analysis/02-primer/#4","title":"4 \u968f\u673a\u6e38\u8d70","text":"<p>\u5c06\u767d\u566a\u58f0\u6a21\u578b\u8fdb\u884c\u4e00\u6b65\u5ef6\u4f38\uff0c\u4fbf\u5f97\u5230\u968f\u673a\u6e38\u8d70\uff08random walk\uff09\u6a21\u578b\uff0c\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <p>\u5bf9\u4e8e\u65f6\u95f4\u5e8f\u5217\\({x_t}\\)\uff0c\u5982\u679c\u5b83\u6ee1\u8db3 \\(x_t = x_{t-1} + w_t\\)\uff0c\u5176\u4e2d \\(w_t\\) \u662f\u4e00\u4e2a\u5747\u503c0\u3001\u65b9\u5dee\u4e3a \\(\\sigma^2\\) \u7684\u767d\u566a\u58f0\uff0c\u5219\u5e8f\u5217 \\(\\{x_t\\}\\) \u4e3a\u4e00\u4e2a\u968f\u673a\u6e38\u8d70\u3002</p> <p>\u7531\u5b9a\u4e49\u53ef\u77e5\uff0c\u5728\u4efb\u610f \\(t\\) \u65f6\u523b\u7684 \\(x_t\\) \u90fd\u662f\u4e0d\u8d85\u8fc7 \\(t\\) \u65f6\u523b\u7684\u6240\u6709\u5386\u53f2\u767d\u566a\u58f0\u5e8f\u5217\u7684\u603b\u548c\uff0c\u5373\uff1a</p> \\[ x_t = w_t + w_{t-1} + w_{t-2} + \\cdots + w_0 \\] <p>\u968f\u673a\u6e38\u8d70\u7684\u5e8f\u5217\u5747\u503c\u548c\u65b9\u5dee\u4e3a\uff1a</p> \\[ \\begin{align*} \\mu_{x_t} &amp; =  0 \\\\ Var(x_t)  &amp; =  Var(w_t) + Var(w_{t-1}) + \\cdots + Var(w_0) \\\\           &amp; =  t \\times Var(w_t) \\\\           &amp; =  t \\sigma^2 \\end{align*} \\] <p>\u867d\u7136\u5747\u503c\u4e0d\u968f\u65f6\u95f4 \\(t\\) \u6539\u53d8\uff0c\u4f46\u662f\u7531\u4e8e\u65b9\u5dee\u662f \\(t\\) \u7684\u51fd\u6570\uff0c\u56e0\u6b64\u968f\u673a\u6e38\u8d70\u4e0d\u6ee1\u8db3\u7a33\u5b9a\u6027\u3002\u968f\u7740 \\(t\\) \u7684\u589e\u52a0\uff0c\\(x_t\\) \u7684\u65b9\u5dee\u589e\u5927\uff0c\u8bf4\u660e\u5176\u6ce2\u52a8\u6027\u4e0d\u65ad\u589e\u52a0\u3002\u5bf9\u4e8e\u4efb\u610f\u7ed9\u5b9a\u7684 \\(k\\)  \uff0c\u901a\u8fc7\u4ee5\u4e0b\u63a8\u5bfc\u7ed9\u5f97\u51fa\u968f\u673a\u6e38\u8d70\u7684\u81ea\u534f\u65b9\u5dee\uff1a</p> \\[ \\begin{align*} Cov(x_t, x_{t+k}) &amp; =  Cov(x_t, x_t + w_{t+1} + \\cdots + w_k) \\\\                   &amp; =  Cov(x_t,x_t) + \\sum_{i=t+1}^{k}{Cov(x_t,w_i)} \\\\                   &amp; =  Cov(x_t,x_t) + 0 \\\\                   &amp; =  t\\sigma^2 \\end{align*} \\] <p>\u4e0a\u8ff0\u63a8\u5bfc\u4e2d\u4f7f\u7528\u4e86\u72ec\u7acb\u968f\u673a\u53d8\u91cf\u7684\u65b9\u5dee\u53ef\u52a0\u6027\u3002\u6709\u4e86\u81ea\u534f\u65b9\u5dee\u548c\u65b9\u5dee\uff0c\u4fbf\u53ef\u4ee5\u65b9\u4fbf\u7684\u6c42\u51fa\u968f\u673a\u6e38\u8d70\u7684\u81ea\u76f8\u5173\u51fd\u6570\uff1a</p> \\[ \\begin{align*} \\rho_k(t) &amp; = \\frac{Cov(x_t,x_{t+k})}{\\sqrt{(Var(x_t)}\\sqrt{Var(x_{t+k})} } \\\\           &amp; = \\frac{t\\sigma^2}{\\sqrt{t\\sigma^2}\\sqrt{(t+k)\\sigma^2}} \\\\           &amp; = \\frac{1}{\\sqrt{1 + k/t}} \\end{align*} \\] <p>\u663e\u7136\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u65e2\u662f\u65f6\u95f4 \\(t\\) \u53c8\u662f\u95f4\u9694 \\(k\\) \u7684\u51fd\u6570\u3002 \\(\\rho\\) \u7684\u8868\u8fbe\u5f0f\u8bf4\u660e\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u8db3\u591f\u957f\u7684\u968f\u673a\u6e38\u8d70\u65f6\u95f4\u5e8f\u5217(\\(t\\)  \u5f88\u5927\uff09\uff0c\u5f53\u8003\u5bdf\u7684\u81ea\u76f8\u5173\u95f4\u9694 \\(k\\) \u5f88\u5c0f\u65f6\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u8fd1\u4f3c\u4e3a1\u3002\u8fd9\u662f\u968f\u673a\u6e38\u8d70\u7684\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u4e0d\u719f\u6089\u5b83\u5f80\u5f80\u5bb9\u6613\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u9519\u8bef\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\u3002\u6211\u4eec\u901a\u5e38\u5047\u8bbe\u80a1\u4ef7\u7684\u5bf9\u6570\u6536\u76ca\u7387\u7b26\u5408\u6b63\u6001\u5206\u5e03\uff0c\u56e0\u6b64\u80a1\u4ef7\u5bf9\u6570\u662f\u4e00\u4e2a\u5e03\u6717\u8fd0\u52a8\uff08\u968f\u673a\u6e38\u8d70\u7684\u4e00\u79cd\u7279\u6b8a\u5f62\u5f0f\uff09\u3002\u5982\u679c\u5f53\u524d\u7684\uff08\u5bf9\u6570\uff09\u80a1\u4ef7\u662f \\(x_t\\)\uff0c\u7531\u968f\u673a\u6e38\u8d70\u7684\u7279\u6027\u53ef\u77e5\uff0c\\(t+1\\) \u65f6\u523b\u7684\u80a1\u4ef7\u7684\u6761\u4ef6\u671f\u671b\u4e3a $E[x_{t+1}|x_t] = x_t $\uff0c\u5373\u6211\u4eec\u5bf9\u4e0b\u4e00\u65f6\u70b9\u7684\u80a1\u4ef7\u7684\u6700\u597d\u7684\u731c\u6d4b\u5c31\u662f\u5f53\u524d\u7684\u4ef7\u683c\u3002\u968f\u673a\u6e38\u8d70\u662f\u4e00\u4e2a\u9785\uff08martingale\uff09\u3002</p> <p>\u5047\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u9884\u6d4b\u80a1\u4ef7\u7684\u6a21\u578b\uff0c\u800c\u8be5\u6a21\u578b\u5c31\u662f\u7528 \\(t\\) \u65f6\u523b\u7684\u80a1\u4ef7\u4f5c\u4e3a\u5bf9 \\(t+1\\) \u65f6\u523b\u7684\u80a1\u4ef7\u7684\u9884\u6d4b\uff0c\u5219\u8be5\u6a21\u578b\u7684\u9884\u6d4b\u503c\u548c\u5b9e\u9645\u503c\u4e4b\u95f4\u7684\u76f8\u5173\u7cfb\u6570\u5c31\u7b49\u4e8e\u80a1\u4ef7\u5e8f\u5217\u7684\u95f4\u9694\u4e3a 1 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u3002\u5982\u679c\u80a1\u4ef7\u8fd1\u4f3c\u7684\u4e3a\u968f\u673a\u6e38\u8d70\uff0c\u90a3\u4e48\u7531\u5b83\u7684\u6027\u8d28\u53ef\u77e5\uff0c\u95f4\u9694\u4e3a 1 \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u975e\u5e38\u63a5\u8fd1 1 \u3002\u56e0\u6b64\u6211\u4eec\u7684\u80a1\u4ef7\u9884\u6d4b\u6a21\u578b\u2014\u2014\u7528\u4eca\u5929\u7684\u4ef7\u683c\u4f5c\u4e3a\u660e\u5929\u7684\u4ef7\u683c\u7684\u9884\u6d4b\u2014\u2014\u7684\u9884\u6d4b\u503c\u548c\u5b9e\u9645\u503c\u4e4b\u95f4\u7684\u76f8\u5173\u7cfb\u6570\u4e5f\u975e\u5e38\u63a5\u8fd1 1 \u3002\u8fd9\u4f1a\u7ed9\u6211\u4eec\u9020\u6210\u9519\u89c9\uff1a\u8fd9\u4e2a\u6a21\u578b\u76f8\u5f53\u51c6\u786e\u3002</p> <p>\u4e0d\u5e78\u7684\u662f\uff0c\u8fd9\u4e2a\u6a21\u578b\u731c\u6d4b\u7684\u6536\u76ca\u7387\u5728\u4efb\u4f55\u65f6\u523b\u90fd\u4e3a \uff0c\u56e0\u6b64\u5b83\u5bf9\u4e8e\u6211\u4eec\u6784\u5efa\u4ea4\u6613\u4fe1\u53f7\u6beb\u65e0\u4f5c\u7528\u3002</p> <p>\u6211\u770b\u5230\u8fc7\u65e0\u6570\u7684\u5b66\u672f\u8bba\u6587\uff08\u5927\u591a\u662f\u7855\u58eb\u8bba\u6587\uff09\u4e2d\uff0c\u9488\u5bf9\u6295\u8d44\u54c1\u4ef7\u683c\u672c\u8eab\u6784\u5efa**\u81ea\u56de\u5f52**\u6a21\u578b\u3002\u72ec\u7acb\u53d8\u91cf\u5c31\u5305\u62ec\u5386\u53f2\u4ef7\u683c\uff0c\u7528\u5b83\u4eec\u548c\u5176\u4ed6\u4e00\u4e9b\u57fa\u672c\u9762\u6216\u5b8f\u89c2\u7ecf\u6d4e\u6570\u636e\u6765\u9884\u6d4b\u4e0b\u4e00\u4e2a\u4ea4\u6613\u65e5\u7684\u80a1\u4ef7\u3002\u4ece\u4e0a\u9762\u7684\u5206\u6790\u53ef\u77e5\uff0c\u8fd9\u6837\u7684\u6a21\u578b\u5c06\u4f1a\u201c\u7cbe\u51c6\u7684\u6beb\u65e0\u7528\u5904\u201d\uff0c\u56e0\u4e3a\u56de\u5f52\u6a21\u578b\u4e2d\u5386\u53f2\u4ef7\u683c\u7684\u7cfb\u6570\u4e4b\u548c\u5c06\u4f1a\u975e\u5e38\u63a5\u8fd11 \u3002</p> <p>\u4efb\u4f55\u4ef7\u683c\u5e8f\u5217\u7684\u81ea\u56de\u5f52\u6a21\u578b\u90fd\u662f\u800d\u6d41\u6c13\u3002</p> <p>\u5229\u7528\u672c\u6587\u7b2c\u4e09\u8282\u4f8b\u5b50\u4e2d\u7684\u767d\u566a\u58f0\u5e8f\u5217\uff0c\u4fbf\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u4eba\u5de5\u968f\u673a\u6e38\u8d70\u5e8f\u5217\u7684\u4f8b\u5b50\u3002\u5b83\u7684\u8f68\u8ff9\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u4e0d\u51fa\u610f\u5916\uff0c\u5f53\u95f4\u9694 \\(k\\) \u76f8\u5bf9\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u957f\u5ea6\u5f88\u5c0f\u65f6\uff0c\u5b83\u7684\u81ea\u76f8\u5173\u7cfb\u6570\uff08\u4e0b\u56fe\uff09\u975e\u5e38\u63a5\u8fd1 1 \uff0c\u8fd9\u6e90\u81ea\u968f\u673a\u6e38\u8d70\u7684\u6027\u8d28\u3002\u4e0d\u8981\u5fd8\u4e86\uff0c\u968f\u673a\u6e38\u8d70\u662f\u5bf9\u80a1\u4ef7\u7684\u5bf9\u6570\u5efa\u6a21\u3002\u56e0\u6b64\uff0c\u8fd9\u79cd\u81ea\u76f8\u5173\u6027\u5bf9\u4e8e\u57fa\u4e8e\u6536\u76ca\u7387\u9884\u6d4b\u7684\u6295\u8d44\u7b56\u7565\u5e76\u6ca1\u6709\u5e2e\u52a9\u3002</p> <p></p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u5982\u679c\uff08\u5bf9\u6570\uff09\u80a1\u4ef7\u4e25\u683c\u7684\u7b26\u5408\u968f\u673a\u6e38\u8d70\uff0c\u90a3\u4e48\u8be5\u65f6\u95f4\u5e8f\u5217\u7684\u65b9\u5dee\u5c06\u4f1a\u968f\u65f6\u95f4\u7ebf\u6027\u589e\u957f\u3002 \u8fd9\u8bf4\u660e\uff0c\u957f\u671f\u6765\u770b\u5b83\u5c06\u5448\u73b0\u51fa\u5de8\u5927\u7684\u6ce2\u52a8\u3002\u4e0b\u56fe\u4e3a\u6765\u81ea\u540c\u4e00\u4e2a\u5206\u5e03\u7684 15 \u6761\u968f\u673a\u6e38\u8d70\u7684\u8f68\u8ff9\u3002\u968f\u7740\u65f6\u95f4\u7684\u63a8\u8fdb\uff0c\u8fd9\u4e9b\u8f68\u8ff9\u4e0a\u5bf9\u5e94\u89c2\u6d4b\u503c\u7684\u6ce2\u52a8\u8d8a\u6765\u8d8a\u5927\uff0c\u5145\u5206\u7684\u5c55\u73b0\u51fa\u968f\u673a\u6027\u3002</p> <p></p>"},{"location":"courses/time-series-analysis/02-primer/#5","title":"5 \u7528\u767d\u566a\u58f0\u5bf9\u6536\u76ca\u7387\u5efa\u6a21","text":"<p>\u5982\u679c\u80a1\u7968\u7684\u5bf9\u6570\u6536\u76ca\u7387\u4e3a\u767d\u566a\u58f0\uff0c\u90a3\u4e48\u5b83\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u5e94\u8be5\u5728\u4efb\u4f55\u975e\u96f6\u7684\u95f4\u9694\u4e0a\u90fd\u5728\u7edf\u8ba1\u610f\u4e49\u4e0a\u7b49\u4e8e\u96f6\u3002\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u770b\u770b\u771f\u5b9e\u7684\u80a1\u7968\u6536\u76ca\u7387\u662f\u5426\u6ee1\u8db3\u8fd9\u4e00\u70b9\u3002\u4e3a\u6b64\uff0c\u8003\u8651\u4e00\u652f\u4e2a\u80a1\uff08\u4e07\u79d1\uff09\u548c\u4e00\u4e2a\u80a1\u6307\uff08\u4e0a\u8bc1\u6307\u6570\uff09\u3002</p> <p>\u4ee5\u65e5\u9891\u4e3a\u4f8b\uff0c\u901a\u8fc7\u4ea4\u6613\u65e5\u7684\u590d\u76d8\u540e\u6536\u76d8\u4ef7\u53ef\u4ee5\u7b97\u51fa\u5bf9\u6570\u6536\u76ca\u7387\uff1a</p> <p>\\(r_t = lnx_t - lnx_{t-1}\\)</p> <p>\u9996\u5148\u6765\u770b\u770b\u4e07\u79d1\uff0c\u5f53\u8003\u5bdf\u671f\u4e3a\u8fc7\u53bb  \u5e74\u65f6\uff0c\u4e07\u79d1\u7684\u5bf9\u6570\u6536\u76ca\u7387\u7684\u76f8\u5173\u56fe\u4e3a\uff1a</p> <p></p> <p>\u4e0a\u56fe\u6307\u51fa\uff0c\u5728\u95f4\u9694\u4e3a 2 \u548c 4 \u65f6\uff0c\u8be5\u6536\u76ca\u7387\u5e8f\u5217\u8868\u73b0\u51fa\u4e86\u7edf\u8ba1\u610f\u4e49\u4e0a\u663e\u8457\u7684\u76f8\u5173\u6027\u3002\u5f53\u7136\uff0c\u7531\u4e8e\u56fe\u4e2d\u7684\u84dd\u8272\u533a\u57df\u4ec5\u4ec5\u662f 95% \u7684\u7f6e\u4fe1\u533a\u95f4\uff0c\u56e0\u6b64\u4ec5\u4ec5\u6839\u636e\u968f\u673a\u6027\u4e5f\u5f88\u53ef\u80fd\u51fa\u73b0\u5728\u4e00\u4e2a\u6216\u8005\u4e24\u4e2a\u95f4\u9694\u4e0a\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u5904\u4e8e\u7f6e\u4fe1\u533a\u95f4\u4e4b\u5916\u7684\u60c5\u51b5\u3002\u56e0\u6b64\uff0c\u6839\u636e\u4e0a\u9762\u7684\u7ed3\u679c\uff0c\u6211\u4eec\u5e76\u4e0d\u80fd\u4e00\u5b9a\u5c31\u8bf4\u767d\u566a\u58f0\u4e0d\u662f\u4e07\u79d1\u6536\u76ca\u7387\u7684\u4e00\u4e2a\u9002\u5f53\u7684\u6a21\u578b\u3002</p> <p>\u5982\u679c\u6211\u4eec\u628a\u8003\u5bdf\u7684\u7a97\u53e3\u7f29\u77ed\u5230\u8fc7\u53bb 5 \u5e74\uff0c\u5219\u4e07\u79d1\u7684\u5bf9\u6570\u65e5\u6536\u76ca\u7387\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u53d8\u4e3a\uff1a</p> <p></p> <p>\u5f53 \\(k=1,2,3,4\\) \u4ee5\u53ca 14 \u7684\u65f6\u5019\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u90fd\u8d85\u8fc7\u4e86\u7f6e\u4fe1\u533a\u95f4\uff0c\u5373\u5728 5% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u4e0d\u4e3a\u96f6\u3002**\u6211\u4eec\u65e0\u6cd5\u518d\u65e0\u89c6\u8fd9\u6837\u7684\u7ed3\u679c\u800c\u628a\u5b83\u4eec\u90fd\u5f52\u7ed3\u4e8e\u968f\u673a\u6027\u3002**\u8be5\u76f8\u5173\u56fe\u6e05\u6670\u5730\u8bf4\u660e\u767d\u566a\u58f0\u4e0d\u80fd\u6709\u6548\u7684\u89e3\u91ca\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u8bc1\u6307\u6570\uff0c\u8fd9\u79cd\u7ed3\u8bba\u5219\u66f4\u52a0\u660e\u663e\u300210 \u5e74\u8fd8\u662f 5 \u5e74\u7684\u7a97\u53e3\uff0c\u4e0a\u8bc1\u6307\u6570\u7684\u5bf9\u6570\u6536\u76ca\u7387\u5747\u5728\u4e0d\u540c\u7684\u95f4\u9694\u4e0a\u8868\u73b0\u51fa\u4e86\u663e\u8457\u7684\u81ea\u76f8\u5173\uff08\u4e0b\u56fe\uff09\uff0c\u4e14\u5b83\u6bd4\u4e2a\u80a1\u7684\u81ea\u76f8\u5173\u6027\u66f4\u52a0\u663e\u8457\u3002</p> <p> </p> <p>\u8fd9\u4e2a\u7ed3\u679c\u8bf4\u660e\u4e0a\u8bc1\u6307\u6570\u7684\u5bf9\u6570\u6536\u76ca\u7387\u5e8f\u5217\u65e0\u6cd5\u7528\u767d\u566a\u58f0\u6765\u5efa\u6a21\u3002\u66f4\u6709\u610f\u601d\u7684\u662f\uff0c\u5f53 \\(k\\) \u8f83\u5c0f\u6216\u8005\u8f83\u5927\u65f6\uff0c\u4e0a\u8bc1\u6307\u6570\u7684\u6536\u76ca\u7387\u5747\u8868\u73b0\u51fa\u4e86\u81ea\u76f8\u5173\u6027\uff0c\u8fd9\u8bf4\u660e\u5b83\u65e2\u6709\u77ed\u8bb0\u5fc6\u53c8\u6709\u957f\u8bb0\u5fc6\u3002</p>"},{"location":"courses/time-series-analysis/02-primer/#6","title":"6 \u4e0b\u6587\u9884\u544a","text":"<p>\u672c\u6587\u7684\u5206\u6790\u5f15\u51fa\u5982\u4e0b\u7684\u7ed3\u8bba\uff1a</p> <p>\u65e0\u8bba\u5bf9\u4e8e\u4e2a\u80a1\u6216\u662f\u6307\u6570\uff0c\u5b83\u4eec\u7684\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u90fd\u5b58\u5728\u67d0\u79cd\u81ea\u76f8\u5173\u6027\uff0c\u4e0d\u6ee1\u8db3\u767d\u566a\u58f0\u6a21\u578b\u3002</p> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u5fc5\u987b\u8003\u8651\u66f4\u52a0\u9ad8\u7ea7\u7684\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u6765\u5bf9\u81ea\u76f8\u5173\u6027\u5efa\u6a21\u3002\u5728\u8fd9\u65b9\u9762\uff0c\u81ea\u56de\u5f52\u6a21\u578b\uff08AR\uff09\u548c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff08MA\uff09\uff0c\u4ee5\u53ca\u5b83\u4eec\u4e8c\u8005\u7684\u7ec4\u5408 \u2014\u2014 \u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff08ARMA\uff09 \u2014\u2014 \u90fd\u662f\u975e\u5e38\u6709\u529b\u7684\u5de5\u5177\u3002\u5b83\u4eec\u5c06\u662f\u672c\u7cfb\u5217\u4e0b\u4e00\u7bc7\u7684\u5185\u5bb9\u3002</p> <p>\uff08\u5168\u6587\u5b8c\uff09</p> <p>\u514d\u8d23\u58f0\u660e\uff1a \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>"},{"location":"courses/time-series-analysis/03-advance/","title":"\u8fdb\u9636\u7bc7","text":"<p>Source</p>"},{"location":"courses/time-series-analysis/03-advance/#1","title":"1 \u4e66\u63a5\u524d\u6587","text":"<p>\u672c\u7cfb\u5217\u7684\u524d\u4e24\u7bc7\u2014\u2014\u57fa\u7840\u7bc7\u548c\u521d\u7ea7\u7bc7\u2014\u2014\u5206\u522b\u4ecb\u7ecd\u4e86\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u6838\u5fc3\u4ee5\u53ca\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u4e2d\u6700\u7b80\u5355\u7684\u6a21\u578b\uff1a\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u3002\u5728\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7814\u7a76\u7684\u5bf9\u8c61\u4e2d\uff0c\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u65e0\u7591\u662f\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u3002\u6316\u6398\u6536\u76ca\u7387\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u662f\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u6838\u5fc3\u5185\u5bb9\u3002\u65e0\u8bba\u5bf9\u4e8e\u4e2a\u80a1\u8fd8\u662f\u6307\u6570\uff0c\u5b83\u4eec\u7684\u6536\u76ca\u7387\u5e8f\u5217\u90fd\u8868\u73b0\u7740\u4e00\u5b9a\u7684\u81ea\u76f8\u5173\u6027\u3002\u524d\u9762\u7684\u6587\u7ae0\u8bf4\u660e\uff0c\u767d\u566a\u58f0\u6a21\u578b\u5047\u8bbe\u4e86\u65f6\u95f4\u5e8f\u5217\u5404\u89c2\u6d4b\u70b9\u4e4b\u95f4\u7684\u72ec\u7acb\u6027\u3001\u65e0\u6cd5\u6355\u6349\u6536\u76ca\u7387\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\uff0c\u56e0\u6b64\u4f7f\u7528\u767d\u566a\u58f0\u6765\u5bf9\u6295\u8d44\u54c1\u6536\u76ca\u7387\u5efa\u6a21\u662f\u4e0d\u59a5\u7684\u3002</p> <p>\u5982\u679c\u6295\u8d44\u54c1\u6536\u76ca\u7387\u771f\u7684\u662f\u4e2a\u767d\u566a\u58f0\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9760\u6254\u786c\u5e01\u731c\u6da8\u8dcc\u5c31\u884c\u4e86\u3002</p> <p>\u672c\u6587\u4e3a\u7cfb\u5217\u7684\u7b2c\u4e09\u7bc7\u2014\u2014\u8fdb\u9636\u7bc7\u3002**\u6211\u4eec\u5c06\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u6700\u5e38\u7528\u7684\u7ebf\u6027\u6a21\u578b\uff1a\u81ea\u56de\u5f52\u6a21\u578b\u3001\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff0c\u4ee5\u53ca\u5b83\u4eec\u4e8c\u8005\u7ed3\u5408\u7684\u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u3002**\u5728\u4e0b\u6587\u4e2d\u6211\u4eec\u5c06\u770b\u5230\uff0c\u81ea\u56de\u5f52\u548c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u8fd9\u4e24\u4e2a\u6a21\u578b\u90fd\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u7b26\u5408\u4ea4\u6613\u8005\u5bf9\u6536\u76ca\u7387\u53d8\u5316\u7684\u7406\u89e3\uff0c\u56e0\u6b64\u5b83\u4eec\u90fd\u80fd\u523b\u753b\u51fa\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u7684\u67d0\u79cd\u81ea\u76f8\u5173\u6027\u3002</p> <p>\u9996\u5148\u6765\u770b\u81ea\u56de\u5f52\u6a21\u578b\u3002</p>"},{"location":"courses/time-series-analysis/03-advance/#2","title":"2 \u81ea\u56de\u5f52\u6a21\u578b","text":"<p>\u5bf9\u4e8e A \u80a1\u7684\u6536\u76ca\u7387\uff0c\u4eba\u4eec\u5f80\u5f80\u6709\u8fd9\u6837\u7684\u611f\u53d7\uff1a</p> <ul> <li>\u5728\u5927\u725b\u5e02\u7684\u65f6\u5019\uff0c\u80a1\u7968\u5929\u5929\u6da8\uff08\u6bcf\u4e2a\u4ea4\u6613\u65e5\u7684\u6536\u76ca\u7387\u90fd\u662f\u6b63\u7684\u3001\u9c9c\u6709\u56de\u8c03\uff09\uff0c\u4e07\u6c11\u6b22\u817e\uff1b</li> <li>\u5728\u5927\u718a\u5e02\u7684\u65f6\u5019\uff0c\u80a1\u7968\u65e5\u65e5\u8dcc\uff08\u6bcf\u4e2a\u4ea4\u6613\u65e5\u7684\u6536\u76ca\u7387\u90fd\u662f\u8d1f\u7684\u3001\u62d2\u7edd\u53cd\u5f39\uff09\uff0c\u623e\u6c14\u51b2\u5929\uff1b</li> <li>\u5728\u9707\u8361\u5e02\u7684\u65f6\u5019\uff0c\u80a1\u7968\u65f6\u6da8\u65f6\u8dcc\uff0c\u4e00\u4e70\u5c31\u8dcc\uff0c\u4e00\u5356\u5c31\u6da8\uff0c\u9887\u6709\u4ef7\u683c\u5728\u67d0\u4e2a\u533a\u95f4\u5185\u9707\u8361\u3001\u6536\u76ca\u7387\u5448\u73b0\u5747\u503c\u56de\u590d\u4e4b\u610f\u3002</li> </ul> <p>\u8fd9\u4e9b\u611f\u53d7\u7ed9\u6211\u4eec\u7684\u542f\u53d1\u662f\uff0c\u6536\u76ca\u7387\u5e8f\u5217\u7684\u524d\u540e\u89c2\u6d4b\u70b9\u4e4b\u95f4\u5f80\u5f80\u4e0d\u662f\u72ec\u7acb\u7684\uff0c\u800c\u662f\u4ee5\u67d0\u79cd\u81ea\u76f8\u5173\u6027\u8054\u7cfb\u5728\u4e00\u8d77\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u5f88\u81ea\u7136\u7684\u95ee\u9898\u5c31\u662f\uff1a\u80fd\u4e0d\u80fd\u7528\u8fc7\u53bb\u7684\u6536\u76ca\u7387\u5e8f\u5217\u5bf9\u672a\u6765\u7684\u6536\u76ca\u7387\u5efa\u6a21\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\u3002\u8fd9\u4fbf\u5f15\u51fa\u4e86\u81ea\u56de\u5f52\u6a21\u578b\uff08autoregressive model\uff09\u3002</p> <p>\u6570\u5b66\u4e0a\uff0c\u6ee1\u8db3\u5982\u4e0b\u5173\u7cfb\u7684\u65f6\u95f4\u5e8f\u5217 \\(\\{r_t\\}\\) \u88ab\u79f0\u4e3a\u4e00\u4e2a \\(p\\) \u9636\u7684\u81ea\u56de\u5f52\u6a21\u578b\uff0c\u8bb0\u4e3a \\(AR(p)\\) \u6a21\u578b\uff1a</p> \\[ r_t = \\alpha_1{r_t} + \\alpha_2{r_{t-2}} + \\cdots +\\alpha_p{r_{t-p}} + w_t = \\sum_{i=1}^{p}{\\alpha_i{r_{t-i}} + w_t} \\] <p>\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u7ebf\u6027\u56de\u5f52\u6a21\u578b\u3002\u5b83\u548c\u4f20\u7edf\u7ebf\u6027\u56de\u5f52\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u81ea\u53d8\u91cf\u662f\u5e8f\u5217\u81ea\u8eab\uff08\u5386\u53f2\u89c2\u6d4b\u503c\uff09\uff0c\u800c\u975e\u5176\u4ed6\u53d8\u91cf\uff0c\u8fd9\u5c31\u662f\u81ea\u56de\u5f52\u4e2d\u201c\u81ea\u201d\u7684\u7531\u6765\u3002</p> <p>\u53e6\u5916\uff0c \\(p\\) \u9636\u7684\u610f\u601d\u662f\u6a21\u578b\u4f7f\u7528\u5f53\u524d\u65f6\u523b \\(t\\) \u4e4b\u524d\u7684 \\(p\\) \u4e2a\u89c2\u6d4b\u503c\u4f5c\u4e3a\u81ea\u53d8\u91cf\u5bf9 \\(t\\) \u5efa\u6a21\u3002\u8fd9\u4e2a\u6a21\u578b\u7684\u542b\u4e49\u662f\uff0c $ r_t $ \u53ef\u4ee5\u8868\u8fbe\u4e3a \\(t\\) \u65f6\u523b\u4e4b\u524d\u7684 \\(p\\) \u4e2a\u6536\u76ca\u7387\u89c2\u6d4b\u503c\u7684\u7ebf\u6027\u7ec4\u5408\u4ee5\u53ca\u4e00\u4e2a \\(t\\) \u65f6\u523b\u7684\u968f\u673a\u8bef\u5dee \\(w_t\\) \u3002</p> <p>\\(p\\) \u7684\u53d6\u503c\u53ef\u4ee5\u662f\u4efb\u4f55\u4e00\u4e2a\u6b63\u6574\u6570\uff0c\u56e0\u6b64\u6700\u7b80\u5355\u7684\u81ea\u56de\u5f52\u6a21\u578b\u5c31\u662f \\(AR(1)\\) \u6a21\u578b\uff08\\(p=1\\)\uff09\u3002</p> <p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\uff0c\u6211\u4eec\u6ca1\u6709\u8003\u8651\u622a\u8ddd\u9879\u3002\u5982\u679c\u622a\u8ddd\u9879\u5bf9\u4e8e\u5f85\u7814\u7a76\u7684\u65f6\u95f4\u5e8f\u5217\u662f\u5fc5\u8981\u7684\uff0c\u5219\u53ef\u4ee5\u5728\u4e0a\u9762\u7684\u516c\u5f0f\u53f3\u4fa7\u52a0\u5165\u4e00\u4e2a\u5e38\u6570\u9879\\(c\\) \u3002</p> <p>\u53e6\u5916\u9700\u8981\u7279\u522b\u8bf4\u660e\u7684\u662f\uff0c\u81ea\u56de\u5f52\u6a21\u578b\u4e0d\u4e00\u5b9a\u90fd\u6ee1\u8db3\u5e73\u7a33\u6027\u3002 \u4e3e\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u672c\u7cfb\u5217\u521d\u7ea7\u7bc7\u4ecb\u7ecd\u7684\u968f\u673a\u6e38\u8d70\u6a21\u578b\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u4e00\u9636\u81ea\u56de\u5f52\u6a21\u578b\uff0c\u6ee1\u8db3\uff1a \\(x_t = x_{t-1} + w_t\\) \u3002\u7531\u4e8e \\(x_t\\) \u7684\u65b9\u5dee\u662f\u65f6\u95f4 \\(t\\) \u7684\u51fd\u6570\uff0c\u56e0\u6b64\u8be5\u5e8f\u5217\u4e0d\u6ee1\u8db3\u5e73\u7a33\u6027\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a \\(p\\) \u9636\u81ea\u56de\u5f52\u6a21\u578b\uff0c\u7531\u5b83\u7684\u56de\u5f52\u7cfb\u6570 \\(\\alpha_i\\) \u53ef\u4ee5\u5199\u51fa\u5b83\u7684**\u7279\u5f81\u65b9\u7a0b\uff08characteristic equation\uff09**\uff1a</p> \\[1-\\alpha_1{x} - \\alpha_2{x^2} - \\cdots - \\alpha_p{x^p} = 0\\] <p>\u5b83\u662f\u4e00\u4e2a \\(p\\) \u6b21\u591a\u9879\u5f0f\uff0c\u6709 \\(p\\) \u4e2a\u89e3\uff0c\u5176\u4e2d\u53ef\u80fd\u65e2\u5305\u62ec\u5b9e\u6570\u89e3\u53c8\u5305\u62ec\u590d\u6570\u89e3\uff1b\u8fd9 \\(p\\) \u4e2a\u89e3\u7684\u5012\u6570\u79f0\u4e3a\u8be5\u65b9\u7a0b\u7684 \u7279\u5f81\u6839\uff08characteristic roots\uff09\u3002 \u81ea\u56de\u5f52\u6a21\u578b\u5e73\u7a33\u6027\u8981\u6c42\u6a21\u578b\u7279\u5f81\u65b9\u7a0b\u7684\u6240\u6709\u7279\u5f81\u6839\u7684\u6a21\u90fd\u5c0f\u4e8e 1\u3002 \u5728\u4e0a\u9762\u7684\u968f\u673a\u6e38\u8d70\u4f8b\u5b50\u4e2d\uff0c\u8be5\u6a21\u578b\u7684\u7279\u5f81\u65b9\u7a0b\u4e3a \\(1-x=0\\) \uff0c\u5b83\u7684\u7279\u5f81\u6839\u4e3a 1\u3002\u7531\u4e8e\u5b83\u4e0d\u6ee1\u8db3\u6a21\u5c0f\u4e8e 1 \u8fd9\u4e2a\u6761\u4ef6\uff0c\u56e0\u6b64\u8be5\u6a21\u578b\u4e0d\u6ee1\u8db3\u5e73\u7a33\u6027\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u6ee1\u8db3\u5e73\u7a33\u6027\u3001\u4e14\u5047\u8bbe\u6ca1\u6709\u622a\u8ddd\u9879\u7684 \\(p\\) \u9636\u81ea\u56de\u5f52\u6a21\u578b\uff0c\u5b83\u7684\u5747\u503c\u663e\u7136\u4e3a 0\uff08\u5982\u679c\u6709\u622a\u8ddd\u9879\u7684\u8bdd\uff0c\u8be5\u65f6\u95f4\u5e8f\u5217\u7684\u5747\u503c\u5c31\u662f \\(c\\) \uff1b\u5b83\u7684\u4e0d\u540c\u95f4\u9694 \\(k\\) \u7684\u81ea\u534f\u65b9\u5dee \\(\\gamma_k\\) \u548c\u81ea\u76f8\u5173\u7cfb\u6570 \\(\\rho_k\\) \u53ef\u4ee5\u8868\u8fbe\u4e3a\u5982\u4e0b\u7684\u9012\u5f52\u65b9\u7a0b\uff0c\u53c8\u79f0\u4e3a Yule-Walker equations\uff1a</p> \\[  \\begin{cases} \\gamma_k = \\sum_{i=1}^p{\\alpha_i\\gamma_{k-1}}, \\quad k &gt; 0 \\\\ \\rho_k = \\sum_{i=1}^p{\\alpha_i\\rho_{k-i}}, \\quad k&gt;0 \\end{cases} \\] <p>\u5728\u5b9e\u9645\u4e2d\uff0c\u60f3\u8981\u4f7f\u7528\u81ea\u56de\u5f52\u6a21\u578b\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\uff0c\u5fc5\u987b\u786e\u5b9a\u6a21\u578b\u7684\u9636\u6570 \\(p\\) \u3002\u8fd9\u4e00\u70b9\u5c06\u5728\u672c\u6587\u7684\u7b2c 5 \u8282\u8ba8\u8bba\u3002</p>"},{"location":"courses/time-series-analysis/03-advance/#3","title":"3 \u6ed1\u52a8\u5e73\u5747\u6a21\u578b","text":"<p>\u6ed1\u52a8\u5e73\u5747\uff08moving average\uff09\u6a21\u578b\u662f\u53e6\u4e00\u4e2a\u5e38\u89c1\u7684\u7ebf\u6027\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u3002 \u5728\u81ea\u56de\u5f52\u6a21\u578b\u4e2d\uff0c\u6211\u4eec\u5c06\u6536\u76ca\u7387 \\(r_t\\) \u770b\u4f5c\u662f\u7ed9\u5b9a\u9636\u6570 \\(p\\) \u4e0b\u5386\u53f2\u6536\u76ca\u7387\u5e8f\u5217\u7684\u7ebf\u6027\u7ec4\u5408\u3002 \u4e0e\u81ea\u56de\u5f52\u6a21\u578b\u4e0d\u540c\uff0c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u5c06\u6536\u76ca\u7387 \\(r_t\\) \u770b\u4f5c\u662f\u5386\u53f2\u767d\u566a\u58f0\u7684\u7ebf\u6027\u7ec4\u5408\u3002</p> <p>\u8fd9\u542c\u8d77\u6765\u4e5f\u8bb8\u6709\u4e9b\u8d39\u89e3\u3002\u4f46\u5b83\u80cc\u540e\u7684\u903b\u8f91\u4e5f\u7b26\u5408\u4eba\u4eec\u7684\u8ba4\u77e5\u3002\u4ee5\u7f8e\u80a1\u6307\u6570\uff08\u6bd4\u5982\u6807\u51c6\u666e\u5c14 500 \u6307\u6570\uff09\u4e3a\u4f8b\uff0c\u5b83\u7ed9\u6211\u4eec\u7684\u5370\u8c61\u662f\u5b83\u7684\u6536\u76ca\u7387\u6709\u4e00\u4e2a\u5fae\u5f31\u7684\u4f46\u662f\u5927\u4e8e\u96f6\u7684\u6f02\u79fb\u7387\uff08drift\uff09\uff0c\u5f62\u6210\u4e00\u4e2a\u5e38\u5e74\u6162\u725b\u7684\u8d70\u52bf\u3002\u9664\u4e86\u8fd9\u4e2a drift \u9879\u4e4b\u5916\uff0c\u5b83\u7684\u6536\u76ca\u7387\u5448\u4e0d\u89c4\u5219\u7684\u6ce2\u52a8\u3002\u5728\u8fd9\u79cd\u80cc\u666f\u4e0b\uff0c\u81ea\u56de\u5f52\u6a21\u578b\u4eff\u4f5b\u4e0d\u662f\u90a3\u4e48\u597d\u7528\u3002\u800c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u5219\u662f\u5bf9\u6f02\u79fb\u7387\u4e4b\u5916\u201c\u968f\u673a\u566a\u58f0\u201d\u5efa\u6a21\uff0c\u5b83\u628a\u8fd9\u4e9b\u566a\u58f0\u7406\u89e3\u4e3a\u4e0d\u540c\u65f6\u523b\u51fa\u73b0\u7684\u5f71\u54cd\u6536\u76ca\u7387\u7684\u65b0\u606f\u6216\u8005\u51b2\u51fb\uff08shocks\uff09\u3002\u901a\u8fc7\u5bf9\u201c\u566a\u58f0\u201d\u5efa\u6a21\u6765\u9884\u6d4b\u5f53\u524d\u65f6\u523b \\(t\\) \u7684\u201c\u566a\u58f0\u201d\uff0c\u518d\u548c\u6f02\u79fb\u7387\u7ed3\u5408\uff0c\u4f5c\u4e3a \\(t\\) ** \u65f6\u523b\u7684\u6536\u76ca\u7387\u9884\u6d4b\u3002</p> <p>\u6570\u5b66\u4e0a\uff0c\u6ee1\u8db3\u5982\u4e0b\u5173\u7cfb\u7684\u65f6\u95f4\u5e8f\u5217\\(\\{r_t\\}\\) \u88ab\u79f0\u4e3a\u4e00\u4e2a \\(q\\) \u9636\u7684\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff08\u4e3a\u4e86\u7b80\u5316\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u5047\u8bbe\u6f02\u79fb\u7387\u9879\u4e3a 0\uff0c\u5373\u8be5\u6a21\u578b\u4e0d\u8003\u8651\u622a\u8ddd\u9879\uff09\uff0c\u8bb0\u4e3a \\(MA(q)\\) \u6a21\u578b\uff1a</p> \\[r_t = w_t + \\beta_1w_{t-1} + \\beta_2w_{t-2} + \\cdots + \\beta_qw_{t-q}\\] <p>\u4e0e\u81ea\u56de\u5f52\u6a21\u578b\u4e0d\u540c\uff0c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u4e00\u5b9a\u6ee1\u8db3\u5e73\u7a33\u6027\u3002 \u5b83\u7684\u5e8f\u5217\u5747\u503c\u4e3a 0\uff08\u5982\u679c\u8003\u8651\u622a\u8ddd\u9879\uff0c\u5219\u53ef\u4ee5\u5728\u4e0a\u5f0f\u53f3\u4fa7\u52a0\u5165\u4e00\u4e2a\u5e38\u6570 \\(c\\) \u4ee3\u8868\u6f02\u79fb\u7387\uff0c\u8fd9\u65f6\u5e8f\u5217\u5747\u503c\u53d8\u4e3a \\(c\\)\u3002\u5b83\u7684\u5404\u95f4\u9694 \\(k\\) \u7684\u81ea\u76f8\u5173\u7cfb\u6570\u6ee1\u8db3\uff1a</p> <p>$$ \\rho_k =  \\begin{cases} &amp; 1 &amp; \\text{if }  k = 0 \\ \\sum_{i=0}<sup>{q-k}{\\beta_i\\beta_{i+k}}/\\sum_{i=0}</sup>q{\\beta_i^2} &amp; &amp; \\text{if }  k=1,\\cdots,q \\ &amp; 0 &amp; \\text{if } k &gt; q \\ \\end{cases} $$ \u5176\u4e2d$\\beta_0 = 1 $ \u3002\u540c\u6837\uff0c\u6211\u4eec\u5c06\u5728\u7b2c 5 \u8282\u4e2d\u4ecb\u7ecd\u5982\u4f55\u9009\u62e9\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u7684\u9636\u6570 \\(q\\) \u3002</p>"},{"location":"courses/time-series-analysis/03-advance/#4","title":"4 \u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b","text":"<p>\u524d\u9762\u4e24\u8282\u5206\u522b\u8ba8\u8bba\u4e86\u81ea\u56de\u5f52\u548c\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u3002\u524d\u8005\u7528\u6536\u76ca\u7387\u7684\u5386\u53f2\u5bf9\u672a\u6765\u6536\u76ca\u7387\u505a\u9884\u6d4b\uff0c\u5b83\u80cc\u540e\u7684\u903b\u8f91\u662f\u6355\u6349\u5e02\u573a\u53c2\u4e0e\u8005\u7684\u6709\u6548\u6027\uff08\u6216\u8005\u975e\u6709\u6548\u6027\uff09\u9020\u6210\u7684\u5e02\u573a\u7684\u52a8\u91cf\u6216\u8005\u53cd\u8f6c\u6548\u5e94\uff1b\u800c\u540e\u8005\u5bf9\u566a\u58f0\u5efa\u6a21\uff0c\u5176\u903b\u8f91\u4e3a\u7a81\u53d1\u4fe1\u606f\u5bf9\u6536\u76ca\u7387\u5c06\u4f1a\u9020\u6210\u51b2\u51fb\uff08\u6bd4\u5982\u4e0a\u5e02\u516c\u53f8\u8d85\u51fa\u9884\u671f\u7684\u8d22\u62a5\u6216\u8005\u5185\u90e8\u4ea4\u6613\u4e11\u95fb\u7b49\uff09\u3002</p> <p>\u5c06\u4e00\u4e2a \\(p\\) \u9636\u7684\u81ea\u56de\u5f52\u6a21\u578b\u548c\u4e00\u4e2a \\(q\\)  \u9636\u7684\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u4fbf\u5f97\u5230\u4e86\u4e00\u4e2a\u9636\u6570\u4e3a \\((p,q)\\)  \u7684\u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff08autoregressive moving average model\uff09\uff0c\u5b83\u5c06 AR \u548c MA \u6a21\u578b\u7684\u4f18\u52bf\u4e92\u8865\u8d77\u6765\u3002 \u7531\u4e8e AR \u548c MA \u6a21\u578b\u90fd\u662f\u7ebf\u6027\u6a21\u578b\uff0c\u56e0\u6b64\u5b83\u4fe9\u7684\u7ebf\u6027\u7ec4\u5408\uff0c\u5373 ARMA \u6a21\u578b\uff0c\u4e5f\u662f\u7ebf\u6027\u6a21\u578b\u3002</p> <p>\u6570\u5b66\u4e0a\uff0c\u6ee1\u8db3\u5982\u4e0b\u5173\u7cfb\u7684\u65f6\u95f4\u5e8f\u5217\\(\\{r_t\\}\\) \u88ab\u79f0\u4e3a\u4e00\u4e2a\u9636\u6570\u4e3a \\((p,q)\\) \u7684\u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\uff08\u4e3a\u4e86\u7b80\u5316\u8868\u8fbe\u5f0f\uff0c\u5047\u8bbe\u6a21\u578b\u4e2d\u7684\u4e0d\u542b\u5e38\u6570\u9879\uff09\uff0c\u8bb0 \\(\\text{ARMA}(p,q)\\) \u6a21\u578b\uff1a</p> <p></p> <p>\u76f8\u6bd4\u8f83\u5355\u4e00\u7684 AR \u6216\u8005 MA \u6a21\u578b\uff0cARMA \u6a21\u578b\u62e5\u6709\u66f4\u591a\u7684\u53c2\u6570\u3002\u56e0\u6b64\u5b83\u51fa\u73b0\u8fc7\u62df\u5408\u7684\u5371\u9669\u5c31\u66f4\u9ad8\u3002 \u867d\u7136\u5b83\u80fd\u591f\u6355\u6349\u5230\u4e24\u4e2a\u5355\u4e00\u6a21\u578b\u5404\u81ea\u6240\u4ee3\u8868\u7684\u65f6\u95f4\u5e8f\u5217\u81ea\u56de\u5f52\u6027\uff0c\u4f46\u662f\u5728\u786e\u5b9a\u9636\u6570 \\(p\\) \u548c \\(q\\) \u7684\u65f6\u5019\uff0c\u6211\u4eec\u5e94\u65f6\u523b\u8c28\u8bb0\uff0c\u9632\u6b62\u8fc7\u62df\u5408\u3002</p> <p>\u4e0b\u9762\u5c31\u6765\u770b\u770b\u5982\u4f55\u5229\u7528**\u4fe1\u606f\u91cf\u51c6\u5219\uff08information criterion\uff09\u548c\u6b8b\u5dee\u81ea\u76f8\u5173\u68c0\u9a8c\u53ef\u4ee5\u88ab\u7528\u6765\u786e\u5b9a AR\u3001MA \u4ee5\u53ca ARMA \u6a21\u578b\u7684\u9636\u6570\u3002**</p>"},{"location":"courses/time-series-analysis/03-advance/#5","title":"5 \u786e\u5b9a\u6a21\u578b\u7684\u9636\u6570","text":"<p>\u5728\u5b9e\u9645\u4e2d\u4f7f\u7528 AR\u3001MA \u6216 ARMA \u6a21\u578b\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\uff0c\u5fc5\u987b\u786e\u5b9a\u6a21\u578b\u7684\u9636\u6570 \\(p\\) \u4ee5\u53ca \\(q\\) \u3002\u663e\u7136\uff0c\\(p\\) \u6216\u8005 \\(q\\) \u8d8a\u5927\uff0c\u5219\u6a21\u578b\u7684\u53c2\u6570\u8d8a\u591a\uff0c\u8d8a\u6709\u53ef\u80fd\u6355\u6349\u5230\u65f6\u95f4\u5e8f\u5217\u4e2d\u4e0d\u540c\u95f4\u9694 \\(k\\)  \u7684\u81ea\u76f8\u5173\u6027\u3002\u4f46\u662f\uff0c\u53c2\u6570\u592a\u591a\u7684\u8bdd\u5bb9\u6613\u9020\u6210\u8fc7\u62df\u5408\u3002\u56e0\u6b64\u5728\u9009\u62e9\u9636\u6570\u65f6\uff0c\u5fc5\u987b\u540c\u65f6\u8003\u8651\u62df\u5408\u7684\u51c6\u786e\u6027\u548c\u9632\u6b62\u8fc7\u62df\u5408\u3002</p> <p>\u5728\u786e\u5b9a\u6a21\u578b\u9636\u6570\u65f6\uff0c\u5e38\u7528\u7684\u5de5\u5177\u662f\u4f7f\u7528\u4fe1\u606f\u91cf\u51c6\u5219\uff0c\u5305\u62ec\u8d64\u6c60\u4fe1\u606f\u91cf\u51c6\u5219\uff08Akaike information criterion\uff0c\u7b80\u79f0 AIC\uff0c\u7531\u65e5\u672c\u7edf\u8ba1\u5b66\u5bb6\u8d64\u6c60\u5f18\u6b21\u521b\u7acb\uff09\u4ee5\u53ca\u8d1d\u53f6\u65af\u4fe1\u606f\u91cf\u51c6\u5219\uff08Bayesian information criterion\uff0c\u7b80\u79f0 BIC\uff09\u3002</p> <p>\u8fd9\u4e24\u4e2a\u4fe1\u606f\u91cf\u51c6\u5219\u7684\u76ee\u7684\u90fd\u662f\u5bfb\u627e\u53ef\u4ee5\u6700\u597d\u5730\u89e3\u91ca\u6570\u636e\u4f46\u5305\u542b\u6700\u5c11\u81ea\u7531\u53c2\u6570\u7684\u6a21\u578b\u3002\u5b83\u4eec\u5747\u4f7f\u7528\u6a21\u578b\u7684\u4f3c\u7136\u51fd\u6570\u3001\u53c2\u6570\u4e2a\u6570\u4ee5\u53ca\u89c2\u6d4b\u70b9\u4e2a\u6570\u6765\u6784\u5efa\u4e00\u4e2a\u6807\u91cf\u51fd\u6570\uff0c\u4ee5\u6b64\u4f5c\u4e3a\u8bc4\u4ef7\u6a21\u578b\u597d\u574f\u7684\u6807\u51c6\u3002\u5b83\u4eec\u7684\u533a\u522b\u662f\u6807\u91cf\u51fd\u6570\u7684\u8868\u8fbe\u5f0f\u6709\u6240\u4e0d\u540c\u3002</p> <p>\u4ee4 \\(L\\) \u3001 \\(k\\) \u3001\\(n\\) \u8868\u793a\u6a21\u578b\u7684\u4f3c\u7136\u51fd\u6570\uff0c\u5219 AIC \u548c BIC \u7684\u5b9a\u4e49\u5206\u522b\u4e3a\uff1a</p> \\[ \\begin{align} \\text{AIC } &amp; = -2\\ln(L) + 2k \\\\ \\text{BIC } &amp; = -2\\ln(L) + k\\ln(n) \\end{align} \\] <p>\u4ece\u5b9a\u4e49\u53ef\u77e5\uff0cAIC \u548c BIC \u90fd\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a\u7b2c\u4e00\u90e8\u5206\u8861\u91cf\u6a21\u578b\u7684\u62df\u5408\u5ea6\uff0c\u7b2c\u4e8c\u90e8\u5206\u662f\u5bf9\u53c2\u6570\u4e2a\u6570\u7684\u60e9\u7f5a\uff08\u9632\u6b62\u8fc7\u62df\u5408\uff09\u3002\u5f53\u4e00\u4e2a\u6a21\u578b\u80fd\u591f\u5f88\u597d\u7684\u89e3\u91ca\uff08\u6837\u672c\u5185\uff09\u6570\u636e\u65f6\uff0c\u5b83\u7684\u4f3c\u7136\u51fd\u6570\u5f88\u5927\uff0c\u56e0\u6b64\u7b2c\u4e00\u9879 $-2\\ln(L) ** \u5c31\u4f1a\u8d8a\u5c0f\uff1b\u5982\u679c\u6a21\u578b\u7684\u53c2\u6570\u8d8a\u5c11\uff0c\u5219\u7b2c\u4e8c\u9879\u4e5f\u8d8a\u5c11\u3002\u6240\u4ee5 AIC \u548c BIC \u603b\u662f\u8d8a\u5c0f\u8d8a\u597d\u3002</p> <p>\u968f\u7740\u6a21\u578b\u9636\u6570 \\(p\\) \u548c \\(q\\) \u7684\u589e\u591a\uff0c\u6a21\u578b\u5bf9\u6837\u672c\u5185\u7684\u6570\u636e\u7684\u89e3\u91ca\u7a0b\u5ea6\u8d8a\u6765\u8d8a\u9ad8\uff0c\u5373 \\(-2\\ln(L)\\) \u53d8\u5c0f\u3002\u4f46\u662f\u89e3\u91ca\u5ea6\u7684\u63d0\u9ad8\u662f\u4ee5\u53c2\u6570\u589e\u591a\uff08\u8fc7\u62df\u5408\u98ce\u9669\u589e\u5927\uff09\u4e3a\u4ee3\u4ef7\uff0c\u56e0\u6b64 \\(2k\\) \u6216\u8005 \\(k\\ln(n)\\) \u589e\u5927\u3002\u6240\u4ee5 AIC \u548c BIC \u662f\u5728\u8fd9\u4e24\u8005\u4e4b\u95f4\u505a\u6743\u8861\u3002\u6700\u7ec8\u9009\u51fa\u7684\u6700\u4f73\u53c2\u6570 \\(p^\\star\\) \u548c \\(q^\\star\\) \u53ef\u4ee5\u4f7f\u5b83\u4eec\u5bf9\u5e94\u7684 AIC \u6216\u8005 BIC \u6bd4\u5176\u4ed6\u4efb\u4f55\u53c2\u6570 \\(p\\) \u548c \\(q\\) \u5bf9\u5e94\u7684 AIC \u6216\u8005 BIC \u66f4\u5c0f\u3002</p> <p>\u503c\u5f97\u8bf4\u660e\u7684\u662f\uff0cAIC \u548c BIC \u7684\u8868\u8fbe\u5f0f\u867d\u7136\u957f\u5f97\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u7ec6\u5fae\u7684\u5dee\u522b\u3002\u56e0\u6b64\u5728\u5b9e\u9645\u4e2d\uff0c\u6709\u53ef\u80fd AIC \u5bf9\u5e94\u7684\u6700\u4f18\u9636\u6570\uff08\u5373\u4f7f\u5f97 AIC \u6700\u5c0f\uff09\u548c BIC \u5bf9\u5e94\u7684\u6700\u4f18\u9636\u6570\uff08\u5373\u4f7f\u5f97 BIC \u6700\u5c0f\uff09\u7565\u6709\u5dee\u522b\u3002\u5177\u4f53\u9009\u62e9\u54ea\u4e2a\u4fe1\u606f\u91cf\u51c6\u5219\u5219\u53d6\u51b3\u4e8e\u4f7f\u7528\u8005\u81ea\u8eab\u3002</p> <p>\u5f53\u6211\u4eec\u4f7f\u7528 AIC \u6216\u8005 BIC \u786e\u5b9a\u6a21\u578b\u7684\u6700\u4f18\u9636\u6570\u4e4b\u540e\uff0c\u4fbf\u53ef\u4ee5\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u3002\u4f46\u662f\uff0c\u6211\u4eec\u4ecd\u7136\u9700\u8981\u68c0\u9a8c\u8be5\u6a21\u578b\u662f\u5426\u5f88\u597d\u7684\u6355\u6349\u4e86\u65f6\u95f4\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\u3002\u5728\u672c\u7cfb\u5217\u53cd\u590d\u5f3a\u8c03\u8fc7\uff0c\u5982\u679c\u4e00\u4e2a\u6a21\u578b\u548c\u539f\u65f6\u95f4\u5e8f\u5217\u7684\u6b8b\u5dee\u6ee1\u8db3\u767d\u566a\u58f0\uff0c\u90a3\u4e48\u8be5\u6a21\u578b\u5c31\u662f\u5408\u9002\u7684\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ea\u9700\u8981\u68c0\u9a8c\u6b8b\u5dee\u5e8f\u5217\u662f\u5426\u5728\u4efb\u4f55\u95f4\u9694 k \u4e0a\u5448\u73b0\u51fa\u7edf\u8ba1\u610f\u4e49\u4e0a\u663e\u8457\u7684\u81ea\u76f8\u5173\u6027\u3002\u5728\u8fd9\u65b9\u9762\uff0cLjung\u2013Box \u68c0\u9a8c\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u65b9\u6cd5\uff0c\u5b83\u540c\u65f6\u68c0\u9a8c\u6b8b\u5dee\u5e8f\u5217\u5404\u95f4\u9694\u7684\u81ea\u76f8\u5173\u7cfb\u6570\u662f\u5426\u663e\u8457\u7684\u4e0d\u4e3a 0\u3002</p> <p>Ljung\u2013Box \u68c0\u9a8c\u6784\u5efa\u4e86\u4e00\u4e2a\u6ee1\u8db3\u5361\u65b9\u5206\u5e03\uff08chi-squared distribution\uff09\u7684\u7edf\u8ba1\u91cf\uff0c\u7136\u540e\u8ba1\u7b97\u5b83\u51fa\u73b0\u7684\u6982\u7387\uff0c\u4ee5\u6b64\u6765\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u5728\u7ed9\u5b9a\u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\u3002\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u53c2\u9605\u76f8\u5173\u8d44\u6599\u3002</p>"},{"location":"courses/time-series-analysis/03-advance/#6-arma-arma","title":"6 \u5229\u7528 AR\u3001MA \u4ee5\u53ca ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u5efa\u6a21","text":"<p>\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5229\u7528\u4e0a\u9762\u4ecb\u7ecd\u7684 AR\u3001MA \u4ee5\u53ca ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u7684\u5bf9\u6570\u6536\u76ca\u7387\u5efa\u6a21\u3002\u5b9e\u9a8c\u8003\u8651 2012 \u5e74 4 \u6708 24 \u65e5\u5230 2017 \u5e74 4 \u6708 24 \u65e5\u8fd9\u4e94\u5e74\u4e4b\u4e2d\u4e0a\u8bc1\u6307\u6570\u7684\u65e5\u6536\u76ca\u7387\u3002\u5728\u786e\u5b9a\u6a21\u578b\u9636\u6570\u65f6\uff0c\u5728\u7ed9\u5b9a\u7684 \\(p\\) \u3001 \\(q\\) \u53c2\u6570\u533a\u95f4\u5185\u4f7f\u7528\u4e0d\u540c\u7684\u53c2\u6570\u53d6\u503c\u5efa\u6a21\uff0c\u5e76\u91c7\u7528 AIC \u51c6\u5219\u8fdb\u884c\u53c2\u6570\u9009\u62e9\uff0c\u5728\u5efa\u6a21\u65f6\u8ba9\u4fdd\u7559\u5e38\u6570\u9879\u3002 \\(p\\) \u548c \\(q\\) \u7684\u533a\u95f4\u5206\u522b\u4e3a\uff1a</p> <ul> <li>AR \u6a21\u578b\uff1a \\(p\\) \u7684\u53d6\u503c\u8303\u56f4\u4e3a 1 \u5230 5\uff1b</li> <li>MA \u6a21\u578b\uff1a \\(q\\) \u7684\u53d6\u503c\u8303\u56f4\u4e3a 1 \u5230 5\uff1b</li> <li>ARMA \u6a21\u578b\uff1a\\(p\\) \u548c \\(q\\) \u7684\u53d6\u503c\u8303\u56f4\u4e3a 1 \u5230 5\u3002</li> </ul> <p>\u9996\u5148\u6765\u770b AR \u6a21\u578b\u3002\u6839\u636e AIC \u51c6\u5219\uff0c\u6700\u4f18\u7684\u9636\u6570 \\(p^\\star = 4\\) \uff0c\u6b64\u65f6 AIC = -7305.31\u3002\u4f7f\u7528 Ljung-Box \u68c0\u9a8c\u539f\u59cb\u5bf9\u6570\u6536\u76ca\u7387\u5e8f\u5217\u548c AR(4) \u6a21\u578b\u7684\u6b8b\u5dee\u662f\u5426\u5728 20 \u4ee5\u5185\u7684\u95f4\u9694\u4e0a\u6709\u4efb\u4f55\u81ea\u76f8\u5173\u6027\uff0c\u7edf\u8ba1\u91cf\u7684 p-value \u4e3a 0.005132\uff0c\u8bf4\u660e\u6211\u4eec\u53ef\u4ee5\u5728 1% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\u3002\u8fd9\u610f\u5473\u7740\u6b8b\u5dee\u4e2d\u5b58\u5728\u76f8\u5173\u6027\u3002\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u53ef\u4ee5\u4ece\u6b8b\u5dee\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u4e2d\u770b\u5230\uff0c\u5b83\u8bf4\u660e \u6b8b\u5dee\u5e8f\u5217\u5728\u95f4\u9694 \\(k\\) \u7b49\u4e8e 6\u30018\u300113 \u548c 19 \u65f6\u4ecd\u7136\u6709 AR(4) \u6a21\u578b\u672a\u6355\u6349\u5230\u7684\u81ea\u76f8\u5173\u6027\u3002</p> <p></p> <p>\u518d\u6765\u770b\u770b MA \u6a21\u578b\u3002\u6839\u636e AIC \u51c6\u5219\uff0c\u6700\u4f18\u7684\u9636\u6570\u540c\u6837\u4e3a $q^\\star = 4 $ \uff0c\u6b64\u65f6 AIC = -7302.70\u3002\u4f7f\u7528 Ljung-Box \u68c0\u9a8c\u539f\u59cb\u5bf9\u6570\u6536\u76ca\u7387\u5e8f\u5217\u548c MA(4) \u6a21\u578b\u7684\u6b8b\u5dee\u662f\u5426\u5728 20 \u4ee5\u5185\u7684\u95f4\u9694\u4e0a\u6709\u4efb\u4f55\u81ea\u76f8\u5173\u6027\uff0c\u7edf\u8ba1\u91cf\u7684 p-value \u4e3a 0.001371\u3002\u540c\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 1% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\u3002\u4ece\u4e0b\u9762\u7684\u6b8b\u5dee\u76f8\u5173\u56fe\u4e0d\u96be\u53d1\u73b0\uff0c\u4e0e AR(4) \u6a21\u578b\u7c7b\u4f3c\uff0cMA(4) \u6a21\u578b\u7684\u6b8b\u5dee\u5e8f\u5217\u5728\u95f4\u9694 \\(k\\) \u7b49\u4e8e 6\u30018\u300113 \u548c 19 \u65f6\u4ecd\u7136\u6709\u6a21\u578b\u672a\u6355\u6349\u5230\u7684\u81ea\u76f8\u5173\u6027\u3002</p> <p></p> <p>\u6700\u540e\u6765\u770b\u770b ARMA \u6a21\u578b\u3002\u6839\u636e AIC \u51c6\u5219\uff0c\u6700\u4f18\u7684\u9636\u6570\u4e3a \\(p^\\star = 5\\) \uff0c $q^\\star = 4 $ \uff0c\u6b64\u65f6 AIC = -7330.43\u3002\u4f7f\u7528 Ljung-Box \u68c0\u9a8c\u539f\u59cb\u5bf9\u6570\u6536\u76ca\u7387\u5e8f\u5217\u548c ARMA(5,4) \u6a21\u578b\u7684\u6b8b\u5dee\u662f\u5426\u5728 20 \u4ee5\u5185\u7684\u95f4\u9694\u4e0a\u6709\u4efb\u4f55\u81ea\u76f8\u5173\u6027\uff0c\u7edf\u8ba1\u91cf\u7684 p-value \u4e3a 0.103462\u3002\u8fd9\u8bf4\u660e\u6211\u4eec\u4e0d\u80fd\u5728 10% \u7684\u663e\u8457\u6027\u6c34\u5e73\u4e0b\u62d2\u7edd\u539f\u5047\u8bbe\u3002 \u5b83\u610f\u5473\u7740\u95f4\u9694 20 \u4ee5\u5185\uff0c\u8be5\u6a21\u578b\u7684\u6b8b\u5dee\u5e8f\u5217\u6ca1\u6709\u7edf\u8ba1\u4e0a\u663e\u8457\u7684\u81ea\u76f8\u5173\u3002\u4ece\u6b8b\u5dee\u5e8f\u5217\u7684\u76f8\u5173\u56fe\u4e2d\u770b\u5230\uff0c\u867d\u7136\u5f53 \\(k\\) \u7b49\u4e8e 12 \u548c 14 \u65f6\u81ea\u76f8\u5173\u7cfb\u6570\u8d85\u8fc7\u4e86 95% \u7f6e\u4fe1\u533a\u95f4\uff0c\u4f46\u6211\u4eec\u65e0\u6cd5\u4ece\u7edf\u8ba1\u4e0a\u5426\u5b9a\u5b83\u4eec\u53ef\u80fd\u662f\u6765\u81ea\u968f\u673a\u8bef\u5dee\u3002</p> <p></p> <p>\u4ece\u6b8b\u5dee\u7684\u81ea\u76f8\u5173\u6027\u5206\u6790\u6765\u770b\uff0cARMA \u6a21\u578b\u6bd4 AR \u548c MA \u6a21\u578b\u5355\u72ec\u4f7f\u7528\u66f4\u6709\u6548\u7684\u6355\u6349\u4e86\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u7684\u81ea\u76f8\u5173\u6027\u3002</p>"},{"location":"courses/time-series-analysis/03-advance/#7","title":"7 \u6700\u7ec8\u7ae0\u9884\u544a","text":"<p>\u4f17\u6240\u5468\u77e5\uff0c\u6295\u8d44\u54c1\u7684\u6536\u76ca\u7387\u5e8f\u5217\u5177\u6709\u4e00\u4e2a\u5c5e\u6027\u79f0\u4e3a\u6ce2\u52a8\u805a\u7c7b\uff08volatility clustering\uff09\u3002\u8fd9\u610f\u5473\u7740\u6536\u76ca\u7387\u7684\u6ce2\u52a8\u7387\u662f\u968f\u65f6\u95f4\u53d8\u5316\u7684\uff08\u5b83\u662f\u5bf9\u6536\u76ca\u7387\u5e8f\u5217\u7684\u4e8c\u9636\u5e73\u7a33\u6027\u5047\u8bbe\u7684\u76f4\u63a5\u6311\u6218\uff09\uff0c\u8fd9\u79cd\u6ce2\u52a8\u7387\u884c\u4e3a\u7684\u672f\u8bed\u79f0\u4e3a\u6761\u4ef6\u5f02\u65b9\u5dee\uff08conditional heteroskedasticity\uff09\u3002 \u672c\u6587\u4ecb\u7ecd\u7684 AR\uff0cMA \u548c ARMA \u6a21\u578b\u5747\u662f\u4e0d\u6761\u4ef6\u5f02\u65b9\u5dee\u6a21\u578b\uff1b\u5b83\u4eec\u4e0d\u8003\u8651\u6ce2\u52a8\u805a\u7c7b\uff08\u4e8b\u5b9e\u4e0a\uff0c\u4e0a\u4e00\u8282\u4e2d\u91c7\u7528\u8fd9\u4e9b\u6a21\u578b\u5bf9\u8fc7\u53bb 5 \u5e74\u4e0a\u8bc1\u6307\u6570\u5bf9\u6570\u6536\u76ca\u7387\u5efa\u6a21\u65f6\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e9b\u6a21\u578b\u65e0\u6cd5\u89e3\u91ca\u8f83\u5927\u65f6\u7684\u81ea\u76f8\u5173\u6027\uff0c\u8fd9\u8bf4\u660e\u6536\u76ca\u7387\u5b58\u5728\u957f\u8bb0\u5fc6\u6027\uff0c\u8fd9\u5c31\u548c\u6ce2\u52a8\u805a\u7c7b\u6709\u5173\uff09\u3002\u4e3a\u4e86\u5b9a\u91cf\u7684\u63cf\u8ff0\u8fd9\u79cd\u7279\u6027\uff0c\u6211\u4eec\u9700\u8981\u66f4\u52a0\u590d\u6742\u7684\u6a21\u578b\u3002</p> <p>\u9488\u5bf9\u6ce2\u52a8\u7387\u7684\u7279\u6027\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5bf9\u6536\u76ca\u7387\u7684\u5e73\u65b9\u76f4\u63a5\u5efa\u6a21\u3002\u8fd9\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u81ea\u56de\u5f52\u6761\u4ef6\u5f02\u65b9\u5dee\uff08Autoregressive Conditional Heteroskedastic\uff0c\u53c8\u79f0 ARCH\uff09\u6a21\u578b\u548c\u5e7f\u4e49\u81ea\u56de\u5f52\u6761\u4ef6\u5f02\u65b9\u5dee\uff08Generalized Autoregressive Conditional Heteroskedastic\uff0c\u53c8\u79f0 GARCH\uff09\u6a21\u578b\u3002(G)ARCH \u6a21\u578b\u662f\u5b9a\u91cf\u91d1\u878d\u4e2d\u5e94\u7528\u5e7f\u6cdb\uff0c\u4e3b\u8981\u7528\u4e8e\u9884\u6d4b\u98ce\u9669\u3002</p> <p>(G)ARCH \u6a21\u578b\u4e3b\u8981\u89e3\u51b3\u6536\u76ca\u7387\u7684\u6ce2\u52a8\u7387\u4e0d\u6052\u5b9a\u7684\u95ee\u9898\u3002\u6211\u4eec\u5728\u6b64\u6307\u51fa\u5b83\u662f\u4e3a\u4e86\u8ba9\u8bfb\u8005\u610f\u8bc6\u5230\u8fd9\u4e00\u70b9\u3002\u4f46\u662f\u4f5c\u4e3a\u672c\u7cfb\u5217\u6240\u8ffd\u6c42\u7684\u76ee\u6807\uff0c\u6211\u4eec\u5c06\u4e0d\u4f1a\u66f4\u8fdb\u4e00\u6b65\u7684\u6df1\u5165\u63a2\u8ba8 (G)ARCH \u6a21\u578b\u3002\u5f53\u7136\uff0c\u6ce2\u52a8\u805a\u7c7b\u4ecd\u7136\u662f\u4e00\u4e2a\u5fc5\u987b\u8981\u9762\u5bf9\u7684\u95ee\u9898\uff0c\u56e0\u6b64\u5728\u5b9e\u8bc1\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u6eda\u52a8\u7a97\u53e3\uff0c\u901a\u8fc7\u5bf9\u5728\u6bcf\u4e2a\u7a97\u53e3\u4e2d\u7684\u4e00\u6bb5\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\u6765\u89c4\u907f\u6389\u6ce2\u52a8\u805a\u7c7b\u8fd9\u4e2a\u95ee\u9898\uff0c\u5373\u5047\u8bbe\u5728\u6bcf\u4e00\u5c0f\u6bb5\u7a97\u53e3\u5185\u7684\u6536\u76ca\u7387\u5e8f\u5217\u662f\u5e73\u7a33\u7684\u3002</p> <p>\u4e0b\u4e00\u7bc7\u6587\u7ae0\u5c06\u662f\u672c\u7cfb\u5217\u7684\u6700\u7ec8\u7ae0\uff0c\u5b83\u5c06\u4ecb\u7ecd\u5982\u4f55\u5e94\u7528 ARMA \u6a21\u578b\u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u8fdb\u884c\u9884\u6d4b\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u4ea4\u6613\u7b56\u7565\u3002\u5bf9\u4e8e\u6536\u76ca\u7387\u7684\u9884\u6d4b\uff0c\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5230\u5e95\u662f\u7eb8\u4e0a\u8c08\u5175\u8fd8\u662f\u5b9e\u6218\u5229\u5668\uff1f\u6211\u4eec\u5c06\u5728\u4e0b\u7bc7\u89c1\u5206\u6653\u3002</p> <p>\uff08\u5168\u6587\u5b8c\uff09</p> <p>\u514d\u8d23\u58f0\u660e\uff1a \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>"},{"location":"courses/time-series-analysis/04-practices/","title":"\u5e94\u7528\u7bc7","text":"<p>Source</p>"},{"location":"courses/time-series-analysis/04-practices/#1","title":"1 \u4e66\u63a5\u524d\u6587","text":"<p>\u300a\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u300b\u7cfb\u5217\u60f3\u901a\u8fc7\u4e00\u7cfb\u5217\u6587\u7ae0\u4f7f\u8bfb\u8005**\u4e86\u89e3\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u70b9\u3001\u719f\u6089\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\u3001\u5e76\u4f7f\u7528\u7ebf\u6027\u4f46\u5b9e\u7528\u7684\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u6a21\u578b\u5bf9\u6295\u8d44\u54c1\u6536\u76ca\u7387\u8fdb\u884c\u9884\u6d4b\u5e76\u4ee5\u6b64\u5236\u5b9a\u91cf\u5316\u6295\u8d44\u7b56\u7565\u3002**</p> <p>\u5728\u672c\u7cfb\u5217\u4e4b\u524d\u7684\u4e09\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u4ee5\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\u4e3a\u76ee\u6807\uff0c\u6309\u90e8\u5c31\u73ed\u7684\u89e3\u91ca\u4e86\u4e3a\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u6807\u6240\u9700\u8981\u7684\u6bcf\u4e00\u5757\u201c\u79ef\u6728\u201d\u3002\u4f5c\u4e3a\u56de\u987e\uff0c\u8fd9\u4e09\u7bc7\u6587\u7ae0\u7684\u7ed3\u6784\u4e3a\uff1a</p> <ul> <li>**\u57fa\u7840\u7bc7\uff1a**\u4ecb\u7ecd\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u6027\u548c\u8fdb\u884c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u81ea\u76f8\u5173\u6027\u3002</li> <li>**\u521d\u7ea7\u7bc7\uff1a**\u8bf4\u660e\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u8fc7\u7a0b\uff1b\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6700\u57fa\u672c\u6a21\u578b\uff1a\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u3002</li> <li>**\u8fdb\u9636\u7bc7)\uff1a**\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u5e38\u7528\u7684\u7ebf\u6027\u6a21\u578b\uff1a\u81ea\u56de\u5f52\u6a21\u578b\u3001\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u3001\u4ee5\u53ca\u81ea\u56de\u5f52\u6ed1\u52a8\u5e73\u5747\u6a21\u578b\u3002</li> </ul> <p>\u672c\u6587\u662f\u7cfb\u5217\u7684\u6700\u540e\u4e00\u7bc7\uff1a\u5e94\u7528\u7bc7\u3002\u6211\u4eec\u5c06\u5229\u7528 ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u6295\u8d44\u7b56\u7565\uff0c\u4ee5\u6b64\u5c55\u793a\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\u7684\u5e94\u7528\u3002</p>"},{"location":"courses/time-series-analysis/04-practices/#2","title":"2 \u5bf9\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u9884\u6d4b\u7684\u6b63\u786e\u9884\u671f","text":"<p>\u901a\u8fc7\u672c\u7cfb\u5217\u4e4b\u524d\u7684\u6587\u7ae0\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff0c\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u76ee\u7684\u662f\u6316\u6398\u6536\u76ca\u7387\u5e8f\u5217\u7684\u5185\u5728\u201c\u7279\u6027\u201d\uff08\u81ea\u76f8\u5173\u6027\uff09\uff0c\u5e76\u5728\u201c\u8be5\u7279\u6027\u53ef\u4ee5\u5728\u672a\u6765\u91cd\u590d\u201d\u7684\u5047\u8bbe\u4e0b\uff0c\u5bf9\u672a\u6765\u7684\u6536\u76ca\u7387\u505a\u5224\u65ad\u3002\u5982\u679c\u6211\u4eec\u60f3\u8981\u6839\u636e\u8fd9\u4e2a\u6536\u76ca\u7387\u9884\u6d4b\u6765\u6784\u5efa\u4ea4\u6613\u4fe1\u53f7\u2014\u2014\u6bd4\u5982\u5982\u679c\u9884\u6d4b\u7684\u6536\u76ca\u7387\u4e3a\u6b63\u5219\u4e70\u5165\uff1b\u5982\u679c\u9884\u6d4b\u7684\u6536\u76ca\u7387\u4e3a\u8d1f\u5219\u7a7a\u4ed3\uff08\u56e0\u4e3a\u4e0d\u5bb9\u6613\u505a\u7a7a\uff09\u2014\u2014\u90a3\u4e48\u5c31\u5fc5\u987b\u8981\u5bf9\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u7684\u9884\u6d4b\u6548\u679c\u6709\u6b63\u786e\u7684\u8ba4\u8bc6\u3002</p> <p>\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\u3002\u4e0b\u56fe\u662f\u4e0a\u8bc1\u6307\u6570\u5728 2017 \u5e74 4 \u6708 24 \u65e5\uff08\u542b\uff09\u4e4b\u524d 20 \u4e2a\u4ea4\u6613\u65e5\u7684\u6536\u76ca\u7387\uff08\u6ce8\uff1a\u4e3a\u4e86\u5efa\u6a21\uff0c\u6211\u4eec\u5f53\u7136\u53ef\u4ee5\u4e5f\u5e94\u8be5\u4f7f\u7528\u66f4\u957f\u7684\u5386\u53f2\u6570\u636e\uff1b\u8fd9\u91cc\u4e3a\u4e86\u7ed8\u56fe\u6e05\u6670\u4ec5\u663e\u793a 20 \u4e2a\u5386\u53f2\u4ea4\u6613\u65e5\u7684\u6570\u636e\uff09\u3002\u90a3\u4e48\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u5bf9\u4e0b\u4e00\u4e2a\u4ea4\u6613\u65e5\uff0c\u5373 2017 \u5e74 4 \u6708 25 \u65e5\uff0c\u7684\u6536\u76ca\u7387\u9884\u6d4b\u4f1a\u662f\u591a\u5c11\u5462\uff1f\u8be5\u9884\u6d4b\u503c\u4f1a\u63a5\u8fd1\u56fe\u4e2d\u7684\u70b9 1\u30012\u30013 \u6216\u8005 4 \u5417\uff1f</p> <p></p> <p>\u4e5f\u8bb8\u4f60\u5df2\u7ecf\u6ce8\u610f\u5230\u4e86\uff0c\u6211\u6545\u610f\u6311\u9009\u7684\u8fd9 4 \u4e2a\u70b9\u90fd\u6ee1\u8db3\u4e00\u4e2a\u6761\u4ef6\uff0c\u5c31\u662f\u5979\u4eec\u7684\u7edd\u5bf9\u503c\u90fd\u5927\u4e8e 0.5%\uff08\u5176\u4e2d 1 \u548c 4 \u4e24\u4e2a\u70b9\u7684\u7edd\u5bf9\u503c\u90fd\u9ad8\u4e8e 1%\uff09\u3002\u00b10.5% \u6216\u8005 \u00b11% \u7684\u65e5\u6536\u76ca\u7387\u5bf9\u4e8e\u4e0a\u8bc1\u6307\u6570\u53ef\u4ee5\u7b97\u662f\u6b63\u5e38\u7684\u53d6\u503c\uff0c\u56e0\u6b64\u6211\u4eec\u662f\u5426\u5e94\u8be5\u9884\u671f\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u7684\u9884\u6d4b\u503c\u4e5f\u6709\u7c7b\u4f3c\u7684\u91cf\u7ea7\u5462\uff1f</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u5982\u679c\u6211\u4eec\u7528 1 \u5e74\u7684\u5386\u53f2\u6570\u636e\u6765\u6784\u5efa ARMA \u6a21\u578b\uff0c\u5e76\u5bf9 2017 \u5e74 4 \u6708 25 \u65e5\u7684\u6536\u76ca\u7387\u9884\u6d4b\u65f6\uff0c\u5f97\u5230\u7684\u9884\u6d4b\u503c\u548c\u5b83\u7684 95% \u7684\u7f6e\u4fe1\u533a\u95f4\u5982\u4e0b\u56fe\u6240\u793a\uff08\u4e0b\u56fe\u4e2d\uff0c\u6a21\u578b\u540c\u65f6\u5bf9 2017 \u5e74 4 \u6708 25 \u65e5\u4e4b\u540e\u7684 5 \u4e2a\u4ea4\u6613\u65e5\u8fdb\u884c\u9884\u6d4b\uff09\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6536\u76ca\u7387\u7684\u9884\u6d4b\u503c\u5b9e\u9645\u4e0a\u975e\u5e38\u63a5\u8fd1 0%\uff0c\u8fdc\u6ca1\u6709\u5230\u8fbe \u00b10.5% \u6216\u8005 \u00b11% \u7684\u91cf\u7ea7\u3002\u4e14\u5b83\u7684 95% \u7684\u7f6e\u4fe1\u533a\u95f4\u975e\u5e38\u5bbd\u3002\u8fd9\u6837\u7684\u7ed3\u679c\u8bf4\u660e\uff1a</p> <p>\u5f53\u6211\u4eec\u7528\u8f83\u957f\u7684\u4e00\u6bb5\u5386\u53f2\u6570\u636e\u6765\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u65f6\uff0c\u5e8f\u5217\u7684\u5185\u5728\u81ea\u76f8\u5173\u6027\u76f8\u5bf9\u4e8e\u968f\u673a\u566a\u58f0\u6765\u8bf4\u975e\u5e38\u5fae\u5f31\u3002\u6a21\u578b\u80fd\u591f\u89e3\u91ca\u7684\u6536\u76ca\u7387\u7684\u6ce2\u52a8\u8f83\u968f\u673a\u566a\u58f0\u7684\u6ce2\u52a8\u6765\u8bf4\u5fae\u4e4e\u5176\u5fae\uff08\u4e0a\u56fe\u4e2d\u7eff\u8272\u7684\u6837\u672c\u5185\u62df\u5408\u6536\u76ca\u7387\u548c\u84dd\u8272\u7684\u5b9e\u9645\u6536\u76ca\u7387\u4e4b\u95f4\u7684\u6b8b\u5dee\u5f88\u5927\u5f88\u597d\u7684\u8bf4\u660e\u4e86\u8fd9\u4e00\u70b9\uff09\u3002\u8fd9\u6837\u7684\u7ed3\u679c\u5c31\u662f\uff0c\u6a21\u578b\u5bf9\u4e8e\u6536\u76ca\u7387\u7684\u9884\u6d4b\u7684\u7edd\u5bf9\u503c\u5c06\u4f1a\u975e\u5e38\u63a5\u8fd1 0\uff0c\u4e14\u8be5\u9884\u6d4b\u503c\u7684\u6807\u51c6\u5dee\u4f1a\u5f88\u5927\uff0c\u9020\u6210\u5f88\u5bbd\u7684\u7f6e\u4fe1\u533a\u95f4\u3002</p> <p>\u5982\u679c\u7528\u767d\u8bdd\u6765\u89e3\u91ca\u4e0a\u9762\u8fd9\u4e00\u5927\u6bb5\u8bdd\u90a3\u5c31\u662f\uff1a\u5982\u679c\u4f7f\u7528\u592a\u957f\u7684\u5386\u53f2\u6570\u636e\u5efa\u6a21\uff0c\u5219\u5e8f\u5217\u4e2d\u8868\u73b0\u51fa\u6765\u7684\u81ea\u76f8\u5173\u6027\u975e\u5e38\u5fae\u5f31\uff0c\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u201c\u7136\u5e76\u5375\u201d\u3002</p> <p>\u65e2\u7136\u592a\u957f\u4e0d\u884c\uff0c\u90a3\u6211\u4eec\u6765\u770b\u770b\u5c11\u7528\u70b9\u6570\u636e\u5efa\u6a21\u53c8\u5982\u4f55\u3002\u5047\u5982\u6211\u4eec\u4ec5\u4ec5\u4f7f\u7528 10 \u4e2a\u5386\u53f2\u6536\u76ca\u7387\u6570\u636e\u5efa\u6a21\uff0c\u5219\u9884\u6d4b\u7ed3\u679c\u5982\u4e0b\uff1a</p> <p></p> <p>\u8fd9\u4f1a\u6211\u4eec\u770b\u5230\uff0c\u6570\u636e\u5c11\u4e86\u4ee5\u540e\uff0c\u62df\u5408\u6536\u76ca\u7387\u548c\u5b9e\u9645\u6536\u76ca\u7387\u66f4\u52a0\u63a5\u8fd1\uff1b\u800c\u9884\u6d4b\u51fa\u6765\u7684\u6536\u76ca\u7387\u4f3c\u4e4e\u5728\u91cf\u7ea7\u4e0a\u4e5f\u66f4\u52a0\u7b26\u5408\u6211\u4eec \u00b10.5% \u6216\u8005 \u00b11% \u7684\u9884\u671f\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u9884\u6d4b\u7ed3\u679c\u6211\u4eec\u6562\u76f8\u4fe1\u5417\uff1f</p> <p>\u5f53\u6211\u4eec\u7528\u5f88\u77ed\u7684\u4e00\u6bb5\u5386\u53f2\u6570\u636e\u6765\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u65f6\uff0c\u51e0\u4e4e\u201c\u786e\u5b9a\u3001\u4e00\u5b9a\u4ee5\u53ca\u80af\u5b9a\u201d\u7684\u4f1a\u53d1\u751f\u8fc7\u62df\u5408\u3002\u4e8b\u5b9e\u4e0a\uff0c\u4e0a\u9762\u7684\u6a21\u578b\u662f\u4e00\u4e2a\u5e26\u6709\u5e38\u6570\u9879\u7684 AR(4) \u6a21\u578b\uff0c\u76f8\u5f53\u4e8e\u7528 10 \u4e2a\u5386\u53f2\u6570\u636e\u6765\u786e\u5b9a 5 \u4e2a\u6a21\u578b\u7684\u53c2\u6570\u3002\u8fc7\u62df\u5408\u7684\u7ed3\u679c\u662f\uff0c\u6a21\u578b\u8fc7\u5206\u89e3\u8bfb\u4e86\u6837\u672c\u5185\u7684\u968f\u673a\u6270\u52a8\uff0c\u4ee5\u81f3\u4e8e\u5b83\u5bf9\u6837\u672c\u5916\u6570\u636e\u7684\u9884\u6d4b\u51c6\u786e\u6027\u4f1a\u975e\u5e38\u5dee\uff08\u8be5\u6a21\u578b\u5728\u6837\u672c\u5916\u6709\u5f88\u5927\u7684\u65b9\u5dee\uff09\u3002\u6211\u4eec\u65e0\u6cd5\u80af\u5b9a\u8be5\u6a21\u578b\u6355\u6349\u5230\u4e86\u591a\u5c11\u6536\u76ca\u7387\u5185\u5728\u7684\u7279\u5f81\uff0c\u4f46\u53ef\u4ee5\u80af\u5b9a\u7684\u662f\u5b83\u523b\u753b\u4e86\u6837\u672c\u5185\u7684\u5f88\u591a\u65e0\u6548\u566a\u58f0\u3002</p> <p>\u5982\u679c\u7528\u767d\u8bdd\u6765\u89e3\u91ca\u4e0a\u9762\u8fd9\u4e00\u5927\u6bb5\u8bdd\u90a3\u5c31\u662f\uff1a\u5982\u679c\u4f7f\u7528\u592a\u77ed\u7684\u5386\u53f2\u6570\u636e\u5efa\u6a21\uff0c\u5219\u6a21\u578b\u4f1a\u8fc7\u5ea6\u5173\u6ce8\u6837\u672c\u5185\u7684\u968f\u673a\u6270\u52a8\uff0c\u56e0\u6b64\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u4f9d\u7136\u201c\u7136\u5e76\u5375\u201d\u3002</p> <p>\u5f52\u6839\u7ed3\u5e95\uff0cARMA \u6a21\u578b\u662f\u4e00\u4e2a\u7edf\u8ba1\u5efa\u6a21\u7684\u65b9\u6cd5\u3002\u56e0\u6b64\u548c\u6240\u6709\u7edf\u8ba1\u6a21\u578b\u4e00\u6837\uff0c\u5b83\u5728\u9884\u6d4b\u7684\u65f6\u5019\u65e2\u6709\u504f\u5dee\u53c8\u6709\u65b9\u5dee\u3002\u6b64\u5916\uff0c\u6536\u76ca\u7387\u5e8f\u5217\u4e2d\u542b\u6709\u5927\u91cf\u7684\u968f\u673a\u6270\u52a8\uff0c\u4e14\u9891\u7387\u8d8a\u9ad8\u6270\u52a8\u8d8a\u5f3a\uff08\u6bd4\u5982\u65e5\u5185\u9ad8\u9891\u6570\u636e\u6bd4\u65e5\u6570\u636e\u7684\u566a\u58f0\u66f4\u5927\uff1b\u65e5\u6570\u636e\u6bd4\u5468\u6570\u636e\u7684\u566a\u58f0\u66f4\u5927\uff09\u3002\u8fd9\u4e5f\u4e3a\u9884\u6d4b\u672c\u8eab\u5e26\u6765\u4e86\u5de8\u5927\u7684\u56f0\u96be\u3002\u56e0\u6b64\uff0c\u5728\u4f7f\u7528\u65f6\u6709\u6b63\u786e\u7684\u9884\u671f\u5c31\u975e\u5e38\u91cd\u8981\u3002</p> <p>\u4e0a\u9762\u7684\u5206\u6790\u8bf4\u660e\uff0c\u7531\u4e8e\u6536\u76ca\u7387\u7684\u7279\u6b8a\u6027\uff08\u7279\u522b\u662f\u6211\u4eec\u7814\u7a76\u7684 A \u80a1\u6536\u76ca\u7387\u7684\u7279\u6b8a\u6027\uff09\uff0c\u4f7f\u7528\u592a\u957f\u6216\u8005\u592a\u77ed\u7684\u6570\u636e\u5efa\u6a21\u90fd\u6ca1\u4ec0\u4e48\u592a\u5927\u7684\u4f5c\u7528\u3002\u4f46\u662f\uff0c\u53ea\u8981\u9884\u671f\u6b63\u786e\uff0c\u8fd9\u4e9b\u56f0\u96be\u4ecd\u7136\u4e0d\u59a8\u788d\u6211\u4eec\u6765\u5c1d\u8bd5\u4e00\u4e0b\u3002\u4e0b\u9762\u6211\u4eec\u5c31\u7528 ARMA \u6a21\u578b\u6765\u4e3a\u4e0a\u8bc1\u6307\u6570\u6784\u5efa\u4e00\u4e2a\u6295\u8d44\u7b56\u7565\u3002</p>"},{"location":"courses/time-series-analysis/04-practices/#3-arma","title":"3 \u57fa\u4e8e ARMA \u6a21\u578b\u7684\u6295\u8d44\u7b56\u7565","text":"<p>\u6211\u4eec\u7684\u6295\u8d44\u6807\u7684\u4e3a\u4e0a\u8bc1\u6307\u6570\u3002\u56de\u6d4b\u671f\u4e3a 2013 \u5e74 7 \u6708 19 \u65e5\u5230 2017 \u5e74 4 \u6708 24 \u65e5\u3002\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u4ea4\u6613\u7b56\u7565\u5982\u4e0b\uff1a</p> <p>\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u4ea4\u6613\u65e5\uff0c\u4f7f\u7528\u4e4b\u524d\u7684 60 \u4e2a\u5386\u53f2\u65e5\u6536\u76ca\u7387\uff08\u76f8\u5f53\u4e8e 3 \u4e2a\u6708\uff09\u6eda\u52a8\u6784\u5efa ARMA \u6a21\u578b\uff0c\u5e76\u5bf9\u8be5\u65e5\u7684\u6536\u76ca\u7387\u9884\u6d4b\u3002\u5728\u9009\u62e9\u6a21\u578b\u53c2\u6570\u65f6\uff0cARMA \u7684\u9636\u6570 p \u548c q \u7684\u53d6\u503c\u8303\u56f4\u5747\u4e3a 1 \u5230 4\uff0c\u5e76\u6839\u636e AIC \u51c6\u5219\u786e\u5b9a\u6700\u4f18\u53c2\u6570\u3002\u5982\u679c\u6536\u76ca\u7387\u9884\u6d4b\u4e3a\u6b63\u5219\u5728\u4e0b\u4e00\u4e2a\u4ea4\u6613\u65e5\u6301\u4ed3\uff1b\u53cd\u4e4b\u5219\u7a7a\u4ed3\u3002\u4e0d\u8003\u8651\u4ea4\u6613\u6210\u672c\u3002</p> <p>\u4e0a\u8ff0\u7b56\u7565\u5728\u56de\u6d4b\u671f\u7684\u51c0\u503c\u548c\u4e0a\u8bc1\u6307\u6570\u81ea\u8eab\u7684\u51c0\u503c\u6bd4\u8f83\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u51c0\u503c\u66f2\u7ebf\u7684\u5177\u4f53\u53c2\u6570\u5982\u4e0b\uff1a</p> <p></p> <p>\u4ece\u7ed3\u679c\u4e0a\u770b\uff0c\u57fa\u4e8e ARMA \u5efa\u6a21\u7684\u7b56\u7565\u4f3c\u4e4e\u8fd8\u4e0d\u9519\uff1a\u5b83\u8f83\u4e0a\u8bc1\u6307\u6570\u672c\u8eab\u53d6\u5f97\u4e86\u66f4\u9ad8\u7684\u6536\u76ca\u548c\u66f4\u4f4e\u7684\u56de\u64a4\uff0c\u56e0\u6b64\u6709\u66f4\u9ad8\u7684\u590f\u666e\u7387\uff08\u5f53\u7136\uff0c\u8fd9\u90e8\u5206\u201c\u5f97\u76ca\u4e8e\u201d\u6211\u4eec\u6ca1\u6709\u8003\u8651\u4ea4\u6613\u6210\u672c\uff09\u3002\u4ece\u51c0\u503c\u66f2\u7ebf\u56fe\u4e0a\u4e0d\u96be\u53d1\u73b0 ARMA \u6a21\u578b\u5bf9\u6536\u76ca\u7387\u7684\u9884\u6d4b\u6ee1\u8db3\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ol> <li>\u9884\u6d4b\u8f83\u597d\u7684\u6355\u6349\u5230\u4e86 2014 \u5e74\u5e95\u5230 2015 \u5e74\u4e2d\u65ec\u7684\u5927\u725b\u5e02\uff1b</li> <li>\u9884\u6d4b\u4e00\u5b9a\u7a0b\u5ea6\u7684\u8eb2\u8fc7\u4e86 2015 \u5e74\u4e0b\u534a\u5e74\u5f00\u59cb\u5230 2016 \u5e74\u521d\u7684\u51e0\u6ce2\u4e0b\u8dcc\uff1b</li> <li>\u4ece 2016 \u5e74 3 \u6708\u4efd\u5f00\u59cb\uff0cARMA \u6a21\u578b\u7684\u8d70\u52bf\u548c\u57fa\u51c6\u6307\u6570\u63a5\u8fd1\u3002</li> </ol> <p>\u4ece ARMA \u7684\u53c2\u6570\u4e0a\u4e0d\u96be\u89e3\u91ca\u51fa\u73b0\u4e0a\u9762\u7ed3\u679c\u7684\u539f\u56e0\u3002\u4e0b\u56fe\u662f ARMA \u6a21\u578b\u4e2d\u7684\u5e38\u6570\u9879\u968f\u65f6\u95f4\u7684\u53d8\u5316\u3002\u8f83 AR \u6216\u8005 MA \u90e8\u5206\u7684\u8d21\u732e\uff0c\u5e38\u6570\u9879\uff08\u6536\u76ca\u7387\u7684\u6f02\u79fb\u7387\uff09\u7684\u91cf\u7ea7\u5bf9\u6536\u76ca\u7387\u7684\u9884\u6d4b\u8d21\u732e\u66f4\u5927\u3002\u663e\u7136\uff0cARMA \u6a21\u578b\u5728\u725b\u5e02\u65f6\u6709\u663e\u8457\u4e3a\u6b63\u7684\u5e38\u6570\u9879\uff0c\u800c\u5728\u718a\u5e02\u7684\u65f6\u5019\u6709\u663e\u8457\u4e3a\u8d1f\u7684\u5e38\u6570\u9879\u3002\u800c\u81ea 2016 \u5e74 3 \u6708\u5f00\u59cb\uff0c\u5e38\u6570\u9879\u63a5\u8fd1 0 \u4f46\u662f\u5927\u90e8\u5206\u65f6\u95f4\u4ecd\u7136\u4e3a\u8bc1\uff0c\u8fd9\u6837\u7684\u7ed3\u679c\u5c31\u662f\u7b56\u7565\u5728\u5927\u6bd4\u4f8b\u7684\u65f6\u95f4\u4e2d\u4f1a\u6301\u6709\u4e0a\u8bc1\u6307\u6570\uff0c\u56e0\u6b64\u7b56\u7565\u5728\u8fd9\u4e2a\u65f6\u671f\u7684\u8d70\u52bf\u548c\u6307\u6570\u63a5\u8fd1\u3002</p> <p></p> <p>\u80a1\u707e n.0 \u4e4b\u540e\uff0c\u968f\u7740\u76d1\u7ba1\u7684\u52a0\u5f3a\uff0c\u9664\u53bb\u968f\u673a\u6270\u52a8\u4e4b\u540e\u7684\u6536\u76ca\u7387\u518d\u96be\u5448\u73b0\u5927\u725b\u5927\u718a\u5e02\u65f6\u7684\u90a3\u79cd\u5927\u5e45\u6ce2\u52a8\u3002\u5177\u6709\u4e2d\u56fd\u7279\u8272\u7684 A \u80a1\u751f\u751f\u53d8\u6210\u4e86\u5177\u6709\u7f8e\u56fd\u7279\u8272\u7684\u7f8e\u80a1\uff08\u957f\u671f\u6709\u4e00\u4e2a\u6b63\u7684\u5c0f\u5e45\u6f02\u79fb\u7387\uff0c\u6b64\u5916\u5c31\u662f\u968f\u673a\u6270\u52a8\uff09\u3002\u7531\u4e8e\u76d1\u7ba1\u7684\u53d8\u5316\uff0c\u6211\u56fd\u7684\u80a1\u5e02\u5df2\u7ecf\u6084\u7136\u53d1\u751f\u4e86\u7ed3\u6784\u6027\u53d8\u5316\uff08regime change\uff09\u3002\u5982\u679c A \u80a1\u4ee5\u540e\u7ef4\u6301\u8fd9\u79cd\u8d70\u52bf\uff0c\u90a3\u4e48\u6700\u597d\u7684\u7b56\u7565\u4e5f\u8bb8\u5c31\u662f\uff08\u91cf\u5316\uff09\u9009\u80a1\uff0c\u5373\u4fbf\u662f\u6ca1\u6709\u5bf9\u51b2\u7684\u7eaf\u591a\u5934\u9009\u80a1\u4e5f\u5927\u6709\u53ef\u4e3a\u3002</p>"},{"location":"courses/time-series-analysis/04-practices/#4-arma","title":"4 \u5145\u6ee1\u5e0c\u671b\uff1f\u957f\u56de\u6d4b\u671f\u5185\u518d\u770b ARMA \u6a21\u578b","text":"<p>\u4e0a\u9762\u7684\u7ed3\u679c\u4e5f\u8bb8\u8ba9\u4eba\u611f\u5230\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u91cf\u5316\u6295\u8d44\u4e2d\u662f\u5145\u6ee1\u5e0c\u671b\u7684\u3002\u4f46\u6b63\u5982\u672c\u6587\u7b2c\u4e8c\u8282\u8bf4\u660e\u7684\u90a3\u6837\uff0c\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u6709\u5176\u81ea\u8eab\u5b58\u5728\u7684\u95ee\u9898\uff0c\u4e14\u80a1\u7968\u7684\u6536\u76ca\u7387\uff08\u5c24\u5176\u662f\u9ad8\u9891\u7684\u6536\u76ca\u7387\uff09\u9884\u6d4b\u8fd9\u4ef6\u4e8b\u672c\u8eab\u51e0\u4e4e\u6ca1\u6709\u4ec0\u4e48\u89c4\u5f8b\u53ef\u5faa\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5c06\u56de\u6d4b\u671f\u4ece\u8fc7\u53bb 4 \u5e74\u62c9\u957f\u5230\u8fc7\u53bb 11 \u5e74\uff08\u5373\u8003\u8651\u8fc7\u53bb\u7684\u4e24\u4e2a\u725b\u718a\u5468\u671f\uff09\uff0c\u7ed3\u679c\u4f1a\u600e\u6837\u7684\uff1f\u4e0b\u56fe\u662f\u7b56\u7565\u548c\u57fa\u51c6\u6307\u6570\u7684\u51c0\u503c\u66f2\u7ebf\u3002\u7b56\u7565\u53ef\u8c13\u4ee4\u4eba\u5927\u8dcc\u773c\u955c\u3002</p> <p></p> <p>\u5728\u56de\u6d4b\u671f\u5185\uff0c\u5728\u5c1a\u672a\u8003\u8651\u4ea4\u6613\u6210\u672c\u7684\u524d\u63d0\u4e0b\uff0c\u7b56\u7565\u5c31\u8fdc\u8fdc\u5730\u8dd1\u8f93\u4e86\u6307\u6570\u3002\u6211\u4eec\u5f53\u7136\u4e0d\u80fd\u8349\u8349\u7684\u4e0b\u7ed3\u8bba\u8bf4 ARMA \u6a21\u578b\u6ca1\u6709\u7528\u3002\u4f46\u662f\u8fd9\u4e2a\u7ed3\u679c\u4e5f\u6e05\u695a\u7684\u544a\u8bc9\u6211\u4eec\uff0c\u5982\u679c\u60f3\u4f7f\u7528\u6a21\u578b\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\uff0c\u6211\u4eec\u5fc5\u987b\u5bf9\u6295\u8d44\u54c1\u548c\u6a21\u578b\u672c\u8eab\u90fd\u975e\u5e38\u4e86\u89e3\uff0c\u8fd9\u6837\u624d\u80fd\u5c06\u4e8c\u8005\u8f83\u597d\u7684\u7ed3\u5408\u5728\u4e00\u8d77\u3001\u4f7f\u6a21\u578b\u5c3d\u53ef\u80fd\u7684\u53cd\u5e94\u6295\u8d44\u54c1\u7684\u7279\u70b9\u3002\u5982\u679c\u4ec5\u4ec5\u662f\u80e1\u4e71\u7684\u5c1d\u8bd5\u53c2\u6570\uff0c\u7ed3\u679c\u5f80\u5f80\u662f\u5f92\u52b3\u7684\u3002</p>"},{"location":"courses/time-series-analysis/04-practices/#5","title":"5 \u7ed3\u8bed","text":"<p>\u4f5c\u4e3a\u7cfb\u5217\u7684\u6700\u7ec8\u7ae0\uff0c\u672c\u6587\u4ecb\u7ecd\u4e86\u5982\u4f55\u5e94\u7528 ARMA \u6a21\u578b\u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u8fdb\u884c\u9884\u6d4b\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u4ea4\u6613\u7b56\u7565\u3002\u5728\u4e0a\u4e00\u7bc7\u6700\u540e\uff0c\u6211\u4eec\u63d0\u51fa\u4e86\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a</p> <p>\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5230\u5e95\u662f\u7eb8\u4e0a\u8c08\u5175\u8fd8\u662f\u5b9e\u6218\u5229\u5668\uff1f</p> <p>\u4e5f\u8bb8\u901a\u8fc7\u672c\u6587\u4e2d\u7b80\u5355\u7684\u5b9e\u8bc1\u6211\u4eec\u4ecd\u7136\u65e0\u6cd5\u786e\u5207\u7684\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\u3002\u4f46\u662f\uff0c\u76f8\u4fe1\u901a\u8fc7\u4eca\u5929\u7684\u6587\u7ae0\uff0c\u4f60\u80fd\u5bf9\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u9884\u6d4b\u6548\u679c\u6709\u4e00\u4e2a\u6b63\u786e\u7684\u9884\u671f\uff0c\u8fd9\u5bf9\u4e8e\u8fdb\u4e00\u6b65\u4f7f\u7528\u9884\u6d4b\u7ed3\u679c\u81f3\u5173\u91cd\u8981\u3002\u6211\u4eec\u770b\u5230\uff0c\u5728\u8fc7\u53bb 4 \u5e74\u7684\u56de\u6d4b\u671f\u5185\uff0cARMA \u6a21\u578b\u8fd8\u662f\u53d6\u5f97\u4e86\u4e0d\u9519\u7684\u7ed3\u679c\u3002\u66f4\u8fdb\u4e00\u6b65\u7684\uff0c\u5373\u4fbf\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u7684\u9884\u6d4b\u7684\u51c6\u786e\u6027\u4e0d\u8db3\u4ee5\u4f7f\u5b83\u88ab\u72ec\u7acb\u7684\u7528\u4e8e\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\uff0c\u5b83\u6240\u4f20\u8fbe\u7684\u4fe1\u606f\u4e5f\u80fd\u591f\u4e3a\u6211\u4eec\u7406\u89e3\u6295\u8d44\u54c1\u672c\u8eab\u63d0\u4f9b\u4e00\u4e9b\u542f\u53d1\u3002</p> <p>\u6b64\u5916\uff0c\u6211\u4eec\u5f53\u7136\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528\u66f4\u9ad8\u7ea7\u7684\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u6a21\u578b\uff0c\u6bd4\u5982\u7528 ARMA \u6a21\u578b\u9884\u6d4b\u6536\u76ca\u7387\u5e76\u7ed3\u5408 GARCH \u6a21\u578b\u9884\u6d4b\u6536\u76ca\u7387\u6ce2\u52a8\u7387\u3002\u8fd9\u4f1a\u53d6\u5f97\u6bd4\u5355\u7eaf\u7684\u4f7f\u7528 ARMA \u6a21\u578b\u66f4\u52a0\u4f18\u5f02\u7684\u6548\u679c\u3002\u5728\u6d77\u5916\uff0c\u6709\u4eba\u4f7f\u7528 ARMA + GARCH \u6a21\u578b\u5bf9\u6807\u666e 500 \u5efa\u6a21\u5e76\u53d6\u5f97\u4e86\u4e0d\u9519\u7684\u6548\u679c\uff08\u5f53\u7136\u90a3\u548c\u7f8e\u80a1\u81ea\u8eab\u7684\u957f\u671f\u6162\u725b\u4e14\u5728\u80a1\u707e\u65f6\u53c8\u53ef\u4ee5\u505a\u7a7a\u6709\u4e00\u5b9a\u5173\u7cfb\uff09\u3002\u867d\u7136\u56f0\u96be\u91cd\u91cd\uff0c\u4f46\u662f\u65b0\u6a21\u578b\u7684\u63d0\u51fa\u4e3a\u6211\u4eec\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\u63d0\u4f9b\u4e86\u66f4\u5e7f\u9614\u7684\u7a7a\u95f4\u548c\u524d\u6240\u672a\u6709\u7684\u53ef\u80fd\u3002</p> <p>\u6b63\u5982\u8fd9\u4e16\u4e0a\u6ca1\u6709\u5b8c\u7f8e\u7684\u6a21\u578b\u4e00\u6837\uff0c\u4ea4\u6613\u4e2d\u4e5f\u6ca1\u6709\u5e38\u80dc\u7684\u7b56\u7565\u3002\u6211\u4eec\u8981\u505a\u7684\u662f\u627e\u5230\u9002\u5408\u81ea\u5df1\u6295\u8d44\u6807\u7684\u4ee5\u53ca\u7b26\u5408\u81ea\u5df1\u4ea4\u6613\u98ce\u683c\u7684\u7b56\u7565\u3002\u52aa\u529b\u63d0\u5347\u4ea4\u6613\u6c34\u5e73\u7684\u8fc7\u7a0b\uff0c\u4e5f\u6b63\u662f\u6211\u4eec\u62d3\u5bbd\u77e5\u8bc6\u9762\u3001\u5386\u7ec3\u5fc3\u6027\u3001\u63d0\u9ad8\u4eba\u751f\u4fee\u4e3a\u7684\u8fc7\u7a0b\u3002</p> <p>\uff08\u5168\u7cfb\u5217\u5b8c\uff09</p> <p>\u514d\u8d23\u58f0\u660e\uff1a \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/","title":"\u8865\u5b8c\u7bc7","text":"<p>Source</p> <p>\u6458\u8981</p> <p>\u672c\u6587\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684 GARCH \u6a21\u578b\uff0c\u9610\u8ff0\u4f7f\u7528 mean model \u548c volatility model \u5bf9\u6536\u76ca\u7387\u5e8f\u5217\u8054\u5408\u5efa\u6a21\u7684\u65b9\u6cd5\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#1","title":"1 \u5f15\u8a00","text":"<p>\u4e24\u5e74\u524d\uff0c\u6211\u4eec\u63a8\u51fa\u4e86\u300a\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u300b\u7cfb\u5217\uff0c\u901a\u8fc7\u56db\u7bc7\u6587\u7ae0\u4ecb\u7ecd\u4e86\u91d1\u878d\u6570\u636e\u65f6\u5e8f\u5206\u6790\u5efa\u6a21\u7684\u57fa\u7840\u77e5\u8bc6\u3002\u8fd9\u56db\u7bc7\u6587\u7ae0\u7684\u5185\u5bb9\u5206\u522b\u4e3a\uff1a</p> <ul> <li>\u57fa\u7840\u7bc7 \u4ecb\u7ecd\u91d1\u878d\u65f6\u5e8f\u7279\u6027\u548c\u8fdb\u884c\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u76ee\u7684\uff1b\u89e3\u91ca\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\uff1a\u81ea\u76f8\u5173\u6027\u3002</li> <li>\u521d\u7ea7\u7bc7 \u8bf4\u660e\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\u7684\u8fc7\u7a0b\uff1b\u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u7684\u6700\u57fa\u672c\u6a21\u578b\uff1a\u767d\u566a\u58f0\u548c\u968f\u673a\u6e38\u8d70\u3002</li> <li>\u8fdb\u9636\u7bc7 \u4ecb\u7ecd\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u4e2d\u5e38\u7528\u7684\u7ebf\u6027\u6a21\u578b\uff1aAR\u3001MA \u4ee5\u53ca ARMA\u3002</li> <li>\u5e94\u7528\u7bc7 \u5229\u7528 ARMA \u5bf9\u4e0a\u8bc1\u6307\u6570\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\uff0c\u5e76\u4ee5\u6b64\u4ea7\u751f\u4ea4\u6613\u4fe1\u53f7\u3001\u6784\u5efa\u6295\u8d44\u7b56\u7565\uff0c\u4ee5\u6b64\u8bf4\u660e\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5728\u91cf\u5316\u6295\u8d44\u9886\u57df\u7684\u5e94\u7528\u3002</li> </ul> <p>\u901a\u8fc7\u524d\u8ff0\u56db\u7bc7\u6587\u7ae0\u7684\u4ecb\u7ecd\u53ef\u77e5\uff0c\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u6838\u5fc3\u662f\u627e\u5230\u8d44\u4ea7\u6536\u76ca\u7387\u5e8f\u5217\u7684\u81ea\u76f8\u5173\u6027\uff0c\u5e76\u5229\u7528\u5b83\u3002\u4ee5 2012 \u5e74 1 \u6708 1 \u65e5\u5230 2019 \u5e74 7 \u6708 31 \u65e5\u4e0a\u8bc1\u6307\u6570\u65e5\u9891\u5bf9\u6570\u6536\u76ca\u7387\u4e3a\u4f8b\uff0c\u5047\u8bbe\u4f7f\u7528 ARMA(3, 2) \u5bf9\u5176\u5efa\u6a21\uff0c\u5e76\u8003\u5bdf\u5176\u6b8b\u5dee\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u6b8b\u5dee\u65f6\u5e8f\u4ee5\u53ca\u5b83\u7684 ACF \u548c Partial ACF\uff08PACF\uff09\u3002</p> <p></p> <p>\u4ece ACF \u548c PACF \u4e0a\u4e0d\u96be\u770b\u51fa\uff0c\u5728\u5f88\u591a lags \u4e0a\uff0c\u81ea\u76f8\u5173\u7cfb\u6570\u662f\u8d85\u8fc7 95% \u7684\u7f6e\u4fe1\u533a\u95f4\u7684\uff1b\u800c\u4ece\u6700\u4e0a\u9762\u4e00\u526f\u56fe\u4e2d\u4e5f\u80fd\u660e\u663e\u770b\u51fa\u6536\u76ca\u7387\u5e8f\u5217\u7684\u4e00\u5927\u7279\u5f81 \u2014\u2014 \u6ce2\u52a8\u7387\u805a\u7c7b\u3002\u5982\u679c\u628a\u6b8b\u5dee\u53d6\u5e73\u65b9\uff0c\u5e76\u518d\u6b21\u4f5c\u56fe\uff0c\u4e0a\u8ff0\u6ce2\u52a8\u7387\u805a\u7c7b\u5219\u4f1a\u53d8\u5f97\u66f4\u52a0\u76f4\u89c2\u3002\u5b83\u5728\u6570\u5b66\u4e0a\u88ab\u79f0\u4e3a\u6761\u4ef6\u5f02\u65b9\u5dee\uff08conditional heteroskedasticity\uff09\u3002</p> <p></p> <p>\u4e0a\u8ff0\u7ed3\u679c\u610f\u5473\u7740\uff0c\u4ec5\u4f7f\u7528 ARMA \u5bf9\u6536\u76ca\u7387\u5e8f\u5217\u5efa\u6a21\u662f\u4e0d\u591f\u7684\uff0c\u5b83\u5bf9\u6761\u4ef6\u5f02\u65b9\u5dee\u65e0\u80fd\u4e3a\u529b\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u9700\u8981\u5bf9\u6ce2\u52a8\u7387\u5efa\u6a21\uff0c\u5373\u4f7f\u7528 Generalized Autoregressive Conditional Heteroskedasticity\uff08GARCH\uff09\u6a21\u578b\u3002</p> <p>\u4e0d\u4ecb\u7ecd GARCH \u7684\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7cfb\u5217\u5927\u62b5\u662f\u4e0d\u5b8c\u6574\u7684\uff1b\u6b64\u5916\u4e5f\u6709\u5c0f\u4f19\u4f34\u7559\u8a00\u8bf4\u80fd\u4e0d\u80fd\u5199\u5199 GARCH\u3002\u6240\u4ee5\u4eca\u5929\u5c31\u6765\u8865\u4f5c\u4e1a\u4e86\uff0c\u4e5f\u56e0\u6b64\u7ed9\u8fd9\u7bc7\u6587\u7ae0\u8d77\u4e86\u4e2a\u201c\u8865\u5b8c\u7bc7\u201d\u7684\u540d\u5b57\u3002</p> <p>\u8003\u8651\u5230\u672c\u7cfb\u5217\u524d\u56db\u7bc7\u201c\u72e0\u72e0\u201d\u7684\u53c2\u8003\u4e86 https://quantstart.com \u4e0a\u76f8\u5173\u6587\u7ae0\u7684\u201c\u4f18\u826f\u4f20\u7edf\u201d\uff0c\u6211\u5728\u672c\u6587\u7b2c 3 \u5c0f\u8282\u4ecb\u7ecd GARCH \u7684\u6570\u5b66\u6a21\u578b\u65f6\u4e5f\u4f1a\u518d\u6b21\u501f\u9274\uff08\u53c2\u8003\u6587\u732e\u4e2d\u6709\u94fe\u63a5\uff09\u3002\u6700\u540e\uff0c\u518d\u7ed9 https://quantstart.com \u6253\u4e2a call\uff08\u5fc5\u987b\u7ed9\u8db3\u5b83 credits\uff09\uff0c\u5b83\u4e0a\u9762\u7684\u6240\u6709\u6587\u7ae0\u90fd\u975e\u5e38\u503c\u5f97\u4e00\u8bfb\u3002</p> <p>\u4e0b\u6587\u4ee5\u8d44\u4ea7\u6536\u76ca\u7387\u5e8f\u5217\u4f5c\u4e3a\u7814\u7a76\u5bf9\u8c61\uff0c\u4ecb\u7ecd\u76f8\u5173\u6982\u5ff5\uff1a\u7b2c 2 \u8282\u89e3\u91ca\u6a21\u578b\u7684\u7ed3\u6784\uff1b\u7b2c 3 \u8282\u4ecb\u7ecd ARCH \u548c GARCH \u7684\u6570\u5b66\u80cc\u666f\u77e5\u8bc6\uff1b\u7b2c 4 \u8282\u8bf4\u660e\u5982\u4f55\u4f7f\u7528 ARMA \u548c GARCH \u5bf9\u6536\u76ca\u7387\u7684\u6761\u4ef6\u5747\u503c\u548c\u6761\u4ef6\u65b9\u5dee\u8fdb\u884c\u8054\u5408\u5efa\u6a21\uff1b\u7b2c 5 \u8282\u9488\u5bf9\u4e0a\u8bc1\u6307\u6570\u505a\u7b80\u5355\u5b9e\u8bc1\uff1b\u7b2c 6 \u8282\u603b\u7ed3\u5168\u6587\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#2","title":"2 \u6a21\u578b\u7684\u7ed3\u6784","text":"<p>\u9996\u5148\u6765\u770b\u770b\u201c\u6761\u4ef6\u5f02\u65b9\u5dee\u201d\u4e00\u8bcd\u3002</p> <p>\u6ce2\u52a8\u7387\u805a\u7c7b\u8bf4\u660e\u4e0d\u540c\u9636\u6bb5\u6536\u76ca\u7387\u7684\u65b9\u5dee\u662f\u4e0d\u540c\u7684\uff0c\u8fd9\u5c31\u662f\u5f02\u65b9\u5dee\u6027\uff08heteroskedastic\uff09\u3002\u800c\u5f88\u591a\u65f6\u5019\uff0c\u8d44\u4ea7\u6536\u76ca\u7387\u8868\u73b0\u51fa\u9ad8\u6ce2\u52a8\u4f34\u968f\u7740\u9ad8\u6ce2\u52a8\u65f6\u671f\uff08\u5927\u725b\u5e02\u6216\u8005\u80a1\u707e\u7684\u65f6\u5019\uff09\uff0c\u800c\u4f4e\u6ce2\u52a8\u53c8\u5f80\u5f80\u4f34\u968f\u7740\u4f4e\u6ce2\u52a8\uff0c\u56e0\u6b64**\u6ce2\u52a8\u7387\u4e4b\u95f4\u662f\u5b58\u5728\u5e8f\u5217\u76f8\u5173\u6027\u7684**\uff0c\u8fd9\u5c31\u662f\u201c\u6761\u4ef6\u201d\u4e00\u8bcd\u7684\u6765\u6e90\u3002\u5c06\u4e8c\u8005\u7ed3\u5408\u5c31\u6709\u4e86\u6761\u4ef6\u5f02\u65b9\u5dee\u3002</p> <p>\u4f7f\u7528 GARCH \u5efa\u6a21\uff0c\u662f\u4e3a\u4e86\u5728 \\(r_t\\) \u7684\u7ebf\u6027\u81ea\u76f8\u5173\u6027\u4e4b\u4e0a\u8003\u8651\u5176\u65b9\u5dee\u4e4b\u95f4\u7684\u76f8\u5173\u6027\uff0c\u5373\u628a\u5747\u503c\u6a21\u578b\u548c\u6ce2\u52a8\u7387\u6a21\u578b\u653e\u5728\u4e00\u4e2a\u6574\u4f53\u6846\u67b6\u4e2d\u8003\u8651\uff08Tsay 2010\uff09\u3002 \u5047\u8bbe \\(t \u2013 1\\) \u65f6\u523b\u6240\u6709\u5df2\u77e5\u7684\u4fe1\u606f\u4e3a\\(F_{t-1}\\) \uff0c\u5219\u5f53\u7ed9\u5b9a \\(F_{t-1}\\) \u65f6\uff0ct \u65f6\u523b\u6536\u76ca\u7387\u7684\u6761\u4ef6\u5747\u503c\u548c\u6761\u4ef6\u65b9\u5dee\u53ef\u5199\u4e3a\uff1a</p> \\[ \\begin{align} \\mu_t &amp; = E[r_t|F_{t-1}] \\\\ \\sigma_t^2 &amp; = var(r_t|F_{t-1}) = E[(r_t -\\mu_t)^2|F_{t-1}] \\end{align} \\] <p>\u5bf9\u4e8e\u6761\u4ef6\u5747\u503c \\(\\mu_t\\) \uff0c\u5b83\u53ef\u4ee5\u662f\u4e00\u4e2a\u5e38\u6570\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u5df2\u7ecf\u638c\u63e1\u7684 ARMA \u6a21\u578b\u5bf9\u5176\u5efa\u6a21\u3002\u4e00\u65e6\u6709\u4e86\\(\\mu_t\\) \u7684\u6a21\u578b\uff0c\\(r_t\\) \u53ef\u4ee5\u5199\u4f5c\uff1a</p> \\[ r_t = \\mu_t + \\epsilon_t \\] <p>\u4e0a\u5f0f\u4e2d \\(\\epsilon_t\\) \u662f \\(t\\) \u65f6\u523b\u7684\u6270\u52a8\u6216\u8005\u65b0\u606f\u3002\u7ed3\u5408\u4e0a\u5f0f\u548c\u6761\u4ef6\u65b9\u5dee\u7684\u5b9a\u4e49\u53ef\u77e5\uff0c\\(t\\) \u65f6\u523b\u6536\u76ca\u7387 \\(r\\_t\\) \u7684\u6761\u4ef6\u65b9\u5dee\u7531 \\(\\epsilon_t\\) \u7684\u65b9\u5dee\u51b3\u5b9a\uff1a</p> \\[ \\sigma_t^2 = var(r_t|F_{t-1}) = var(\\epsilon_t|F_{t-1})\\] <p>\u4ece\u6a21\u578b\u7ed3\u6784\u4e0d\u96be\u770b\u51fa\uff0c\u4e3a\u4e86\u8003\u8651\u6761\u4ef6\u5f02\u65b9\u5dee\u5219\u9700\u8981\u5bf9\\(\\epsilon_t\\)\u5efa\u6a21\uff0c\u800c\u8fd9\u6b63\u662f GARCH \u7684\u76ee\u6807\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#3-arch-garch","title":"3 ARCH \u548c GARCH","text":"<p>\u5728\u4ecb\u7ecd GARCH \u4e4b\u524d\u4e0d\u59a8\u5148\u6765\u770b\u770b ARCH\uff0c\u6bd5\u7adf GARCH \u53ea\u662f\u5728\u5b83\u524d\u9762\u52a0\u4e86\u4e00\u4e2a G\uff08generalized\uff09\u4ece\u800c\u5c06\u5176\u63a8\u5e7f\u4e86\u3002ARCH \u7531 Engle (1982) \u63d0\u51fa\uff0c\u5b83\u662f\u7b2c\u4e00\u4e2a\u5bf9\u6ce2\u52a8\u7387\u5efa\u6a21\u7684\u7cfb\u7edf\u6027\u6846\u67b6\u3002</p> <p>\u5bf9\u4e8e \\(\\epsilon_t\\)\uff0c\u8003\u8651\u5982\u4e0b\u6a21\u578b\uff08\u5176\u4e2d \\(w_t\\) \u8868\u793a\u5747\u503c\u4e3a 0\u3001\u65b9\u5dee\u4e3a 1 \u7684\u767d\u566a\u58f0\uff09\uff1a</p> \\[ \\begin{align} \\epsilon_t &amp; =  \\sigma_tw_t \\\\ \\sigma_t^2 &amp; =  \\alpha_0 + \\alpha_1\\epsilon_{t-1}^2 \\end{align} \\] <p>\u628a \\(\\sigma_t\\) \u7684\u8868\u8fbe\u5f0f\u5e26\u56de\u5230 \\(\\epsilon_t\\) \u4e2d\u53ef\u5f97\uff1a</p> \\[ \\epsilon_t = w_t \\sqrt{\\alpha_0 + \\alpha_1\\epsilon_{t-1}^2}\\] <p>\u8fd9\u4e2a\u5173\u4e8e\u5e8f\u5217 \\(\\{\\epsilon_t\\}\\)\u7684\u6a21\u578b\u79f0\u4f5c\u4e00\u9636\u81ea\u56de\u5f52\u6761\u4ef6\u5f02\u65b9\u5dee\u6a21\u578b\uff0c\u4e5f\u5c31\u662f\u6700\u7b80\u5355\u7684 ARCH(1) \u8fc7\u7a0b \u2014\u2014 \u62ec\u53f7\u91cc\u7684\u7cfb\u6570 1 \u8868\u660e\u81ea\u56de\u5f52\u6a21\u578b\u4e2d\u53ea\u8003\u8651\u4e86 lag = 1 \u9636\u3002\u4e3a\u4e86\u76f4\u89c2\u770b\u51fa\u65b9\u5dee\u5e8f\u5217\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u5c06\u4e0a\u5f0f\u4e24\u8fb9\u5e73\u65b9\uff1a</p> \\[ \\begin{array}{rll} \\mbox{var}(\\epsilon_t) &amp; = &amp; \\mbox{E}[\\epsilon_t^2]-(\\mbox{E}[\\epsilon_t])^2 \\\\                        &amp; = &amp; \\mbox{E}[\\epsilon_t^2]\\\\                        &amp; = &amp; \\mbox{E}[\\omega_t^2]\\mbox{E}[\\alpha_0 + \\alpha_1\\epsilon_{t-1}^2]\\\\                        &amp; = &amp; \\mbox{E}[\\alpha_0+\\alpha_1\\epsilon_{t-1}^2]\\\\                        &amp; = &amp; \\alpha_0 + \\alpha_1\\mbox{var}(\\epsilon_{t-1}) \\end{array}) \\] <p>\u4e0a\u5f0f\u6e05\u6670\u7684\u663e\u793a\u4e86\\(var(\\epsilon_t)\\) \u548c \\(var(\\epsilon_{t-1})\\) \u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u524d\u9762\u6211\u4eec\u63d0\u5230\uff0c \\(\\{\\epsilon_t)\\}\\) \u7684\u6a21\u578b\u662f\u4e00\u4e2a ARCH(1) \u8fc7\u7a0b\u3002\u4ece \\(var(\\epsilon_t)\\) \u548c\\(var(\\epsilon_{t-1})\\) \u7684\u5173\u7cfb\u53ef\u77e5\uff0c\u4e00\u4e2a ARCH(1) \u8fc7\u7a0b\u7684\u65b9\u5dee \u2014\u2014 \u5373 \\(var(\\epsilon_t)\\) \u2014\u2014 \u6b63\u662f\u4e00\u4e2a AR(1)\uff0c\u5373\u4e00\u9636\u81ea\u56de\u5f52\u8fc7\u7a0b\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u7167\u732b\u753b\u864e\uff0c\u5c06 ARCH(1) \u7b80\u5355\u63a8\u5e7f\u5230\u591a\u9636 lags\uff0c\u5c31\u5f97\u5230 ARCH(p) \u8fc7\u7a0b\uff1a</p> \\[ \\displaystyle\\epsilon_t=\\omega_t\\sqrt{\\alpha_0+\\sum_{i=1}^p\\alpha_i\\epsilon_{t-i}^2} \\] <p>\u7c7b\u4f3c\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\u4e00\u4e2a ARCH(p) \u8fc7\u7a0b\u7684\u65b9\u5dee\u662f\u4e00\u4e2a AR(p)\uff0c\u5373 p \u9636\u81ea\u56de\u5f52\u8fc7\u7a0b\uff1b\u8fd9\u76f8\u5f53\u4e8e\u5bf9\u65b9\u5dee\u4f7f\u7528 AR(p) \u6765\u5efa\u6a21\u3002\u65e2\u7136\u80fd\u5bf9\u65b9\u5dee\u7528 AR(p) \u6765\u5efa\u6a21\uff0c\u90a3\u4e48\u5f88\u81ea\u7136\u7684\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u628a MA(q) \u4e5f\u52a0\u4e0a\u5f97\u5230\u65b9\u5dee\u7684 ARMA(p, q) \u6a21\u578b\u5462\uff1f\u5982\u6b64\u4fbf\u5f15\u51fa\u4e86 GARCH(p, q)\u3002</p> <p>\u5bf9\u4e8e \\(\\epsilon_t\\) \uff0c\u8003\u8651\u5982\u4e0b\u6a21\u578b\uff1a</p> \\[ \\begin{array}{rll} \\epsilon_t&amp;=&amp;\\sigma_t\\omega_t\\\\ \\sigma_t^2&amp;=&amp;\\displaystyle\\alpha_0+\\sum_{i=1}^{p}\\alpha_i\\epsilon_{t-i}^2+\\sum_{j=1}^{q}\\beta_j\\sigma_{t-j}^2+\\end{array} \\] <p>\u8fd9\u5c31\u662f\u5927\u540d\u9f0e\u9f0e\u7684 **GARCH(p, q) \u6a21\u578b \u2014\u2014 (p, q) \u9636\u7684\u5e7f\u4e49\u81ea\u56de\u5f52\u6761\u4ef6\u5f02\u65b9\u5dee\u6a21\u578b\u3002**\u6709\u4e86 GARCH \u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u5b83\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\u4e86\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#4-arma-garch","title":"4 \u4f7f\u7528 ARMA + GARCH \u5bf9\u6536\u76ca\u7387\u5efa\u6a21","text":"<p>\u672c\u5c0f\u8282\u6765\u770b\u770b\u5982\u4f55\u5728\u7b2c\u4e8c\u8282\u4ecb\u7ecd\u7684\u4f53\u7cfb\u4e0b\u4f7f\u7528 \\(\\text{ARMA}(p, q)\\) \u548c \\(\\text{GARCH}(p', q')\\) \u6765\u5bf9 \\(r_t\\) \u8fdb\u884c\u8054\u5408\u5efa\u6a21\u3002\u4e3a\u4e86\u533a\u5206\u6761\u4ef6\u5747\u503c\u6a21\u578b\u548c\u6761\u4ef6\u65b9\u5dee\u6a21\u578b\u4e2d\u7684\u81ea\u56de\u5f52\u9636\u6570\uff0c\u6211\u7279\u610f\u7528\u4e86 \\((p, q)\\) \u548c \\((p', q')\\) \u8868\u793a\u3002</p> <p>\u5c06\u524d\u9762\u7684\u5185\u5bb9\u6574\u5408\u5230\u4e00\u8d77\u5f97\u5230\u5173\u4e8e\\(r_t\\) \u7684\u6a21\u578b\u5982\u4e0b\uff1a</p> \\[ \\begin{array}{rll} r_t &amp; = &amp; \\mu_t\\epsilon_t\\\\ \\mu_t &amp; = &amp; \\displaystyle\\theta_0\\sum_{i=1}^p\\theta_ir_{t-i}\\sum_{j=1}^q\\eta_j\\epsilon_{t-j}\\\\ \\epsilon_t  &amp; = &amp; \\sigma_t\\omega_t\\\\ \\sigma_t^2  &amp; = &amp; \\displaystyle\\alpha_0\\sum_{i=1}^{p^\\prime}\\alpha_i\\epsilon_{t-i}^2 \\sum_{j=1}^{q^\\prime}\\beta_j\\sigma_{t-j}^2 \\end{array} \\] <p>\u5f53\u6211\u4eec\u5bf9 ** \u5efa\u6a21\u65f6\uff0c\u9700\u8981\u540c\u65f6\u6307\u5b9a** mean model\uff08\u5bf9 ** \u5efa\u6a21\uff09\u4ee5\u53ca volatility model\uff08\u5bf9  \u5efa\u6a21\uff09\u3002**\u4e0a\u5f0f\u4f7f\u7528\u4e86 ARMA(p, q) \u4f5c\u4e3a mean model\uff0c\u4f46\u6839\u636e\u5b9e\u9645\u95ee\u9898\u4e5f\u53ef\u4ee5\u4f7f\u7528\u66f4\u7b80\u5355\u7684\u6a21\u578b\uff0c\u6bd4\u5982  = \u5e38\u6570\uff1b\u4f7f\u7528\u4e86 GARCH(p', q') \u4f5c\u4e3a volatility model\u3002\u6700\u540e\u4f7f\u7528\u5df2\u6709\u7684\u6570\u636e\u5bf9\u8fd9\u4e24\u4e2a\u6a21\u578b\u7684\u53c2\u6570\u8fdb\u884c\u8054\u5408\u4f30\u8ba1\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u65e0\u8bba\u4f7f\u7528 python \u8fd8\u662f R \u7684\u76f8\u5173 package\uff0c\u5728\u8c03\u7528\u65f6\u90fd\u8981\u6307\u5b9a mean model \u548c volatility model\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5728 https://quantstart.com \u4e0a\u4e00\u7bc7\u4f7f\u7528 ARMA \u5bf9 mean \u5efa\u6a21\u3001\u7528 GARCH \u5bf9 volatility \u5efa\u6a21\u6765\u4ea4\u6613 S&amp;P500 \u6307\u6570\u7684\u4f8b\u5b50\u4e2d\uff0c\u4f5c\u8005\u5bf9\u4e24\u4e2a\u6a21\u578b\u540c\u65f6\u8fdb\u884c\u4e86\u8bbe\u5b9a\u3002</p> <p>Once we have chosen the specification we carry out the actual fitting of ARMA+GARCH using the ugarchfit command, which takes the specification object, the k  returns of the S&amp;P500 and a numerical optimisation solver. We have chosen to use hybrid, which tries different solvers in order to increase the likelihood of convergence:</p> <pre><code>spec = ugarchspec(\n            variance.model=list(garchOrder=c(1,1)),\n            mean.model=list(armaOrder=c(final.order[1], final.order[3]), include.mean=T),\n            distribution.model=\"sged\")\n\nfit = tryCatch(\n  ugarchfit(\n    spec, spReturnsOffset, solver = 'hybrid'\n  ), error=function(e) e, warning=function(w) w\n)\n</code></pre> <p>\u5728\u5177\u4f53 GARCH \u5efa\u6a21\u65f6\u53ef\u4ee5\u9075\u5982\u4e0b\u6b65\u9aa4\uff08Tsay 2010\uff09\uff1a</p> <ol> <li>\u4f7f\u7528 ARMA \u5bf9 \\(r_t\\) \u5efa\u6a21\u4ee5\u6d88\u9664\u4efb\u4f55\u7ebf\u6027\u4f9d\u8d56\uff0c\u786e\u5b9a\u6700\u4f18\u53c2\u6570 \\(p\\) \u548c \\(q\\)\uff08\u53ef\u4ee5\u5229\u7528 AIC/BIC \u6765\u786e\u5b9a\uff09\uff1b</li> <li>\u5bf9\u4e0a\u8ff0\u6a21\u578b\u7684\u6b8b\u5dee\u8fdb\u884c GARCH \u5206\u6790\uff1b</li> <li>\u5982\u679c\u6b8b\u5dee\u4e2d\u8868\u73b0\u51fa\u663e\u8457\u7684\u6761\u4ef6\u5f02\u65b9\u5dee\uff0c\u5219\u7ed9\u5b9a\u4e00\u4e2a\u6ce2\u52a8\u6a21\u578b $ \\text{GARCH}(p', q') $\uff1b</li> <li>\u4f7f\u7528\u5386\u53f2\u6570\u636e\u5bf9\u7b2c\u4e00\u6b65\u4e2d\u7684 \\(\\text{ARMA}(p, q)\\) \u548c\u7b2c\u4e09\u6b65\u4e2d\u7684 $ \\text{GARCH}(p', q') $ \u8fdb\u884c\u8054\u5408\u53c2\u6570\u4f30\u8ba1\uff1b</li> <li>\u4ed4\u7ec6\u68c0\u9a8c\u7b2c\u56db\u6b65\u4e2d\u62df\u5408\u51fa\u7684\u6a21\u578b\uff0c\u5982\u6709\u5fc5\u8981\u5219\u5bf9\u5176\u8fdb\u884c\u4fee\u6539\u3002</li> </ol> <p>\u4ee5\u4e0a\u4e94\u6b65\u6784\u6210\u4e86\u5bf9\u6761\u4ef6\u5747\u503c\u548c\u6761\u4ef6\u65b9\u5dee\u7684\u8054\u5408\u5efa\u6a21\uff0c\u4f7f\u7528\u5f97\u5230\u7684\u6a21\u578b\u5c31\u53ef\u4ee5\u5bf9\u672a\u6765\u7684 \\(r_t\\) \u4ee5\u53ca \\(\\mbox{var(r_t)}\\) \u8fdb\u884c\u9884\u6d4b\u3002</p> <p>\u5728\u79bb\u5f00\u672c\u8282\u4e4b\u524d\uff0c\u6211\u4eec\u518d\u6765\u4ecb\u7ecd\u4e24\u4e2a\u4f7f\u7528 GARCH \u5efa\u6a21\u65f6**\u4e0d\u5341\u5206\u6b63\u786e**\u7684\u505a\u6cd5\uff08\u5e0c\u671b\u80fd\u5e2e\u4f60\u6392\u96f7\uff09\u3002</p> <p>\u9519\u8bef\u505a\u6cd5\u4e00\uff1a\u7528 \\(ARMA(p, q)\\) \u7684\u9636\u6570\u4f5c\u4e3a \\(GARCH(p', q')\\) \u7684\u9636\u6570</p> <p>\u7f51\u4e0a\u4e00\u4e9b\u8d44\u6599\u4e2d\u63d0\u8fc7\u8fd9\u6837\u7684\u505a\u6cd5\uff1a\u9996\u5148\u662f\u7528 ARMA \u5bf9 \\(r\\_t\\) \u5efa\u6a21\u3001\u786e\u5b9a\u6700\u4f18\u7684\u53c2\u6570 p \u548c q\uff1b\u7136\u540e\u5c06\u5b83\u4eec\u4f5c\u4e3a\u6ce2\u52a8\u7387\u6a21\u578b\u7684\u9636\u6570\uff0c\u5373 \\(GARCH(p, q)\\)\uff0c\u540c\u65f6\u5728\u8054\u5408\u5efa\u6a21\u65f6\u4ec5\u5047\u8bbe mean model $\\mu_t = \\text{constant} $\u3002\u8fd9\u79cd\u505a\u6cd5\u4f7f\u7528\u4ece \\(r_t\\) \u7ebf\u6027\u5173\u7cfb\u627e\u5230\u7684 p \u548c q \u53bb\u5bf9 \\(r_t\\) \u7684\u6ce2\u52a8\u7387\u7684\u5173\u7cfb\u5efa\u6a21\uff0c\u7136\u540e\u53c8\u5047\u8bbe mean model \u662f\u5e38\u6570\uff0c\u7740\u5b9e\u4ee4\u4eba\u8d39\u89e3\u3002</p> <p>\u9519\u8bef\u505a\u6cd5\u4e8c\uff1a\u5c06 mean model \u548c volatility model \u62c6\u5f00\u4f30\u8ba1</p> <p>\u8fd9\u79cd\u505a\u6cd5\u542c\u4e0a\u53bb\u66f4\u201c\u9760\u8c31\u201d\u4e00\u4e9b\u3002\u9996\u5148\u662f\u7528 ARMA \u5bf9 \\(r_t\\) \u5efa\u6a21\uff0c\u786e\u5b9a\u6700\u4f18\u53c2\u6570 p \u548c q\uff1b\u7136\u540e\u4f7f\u7528 ARMA \u6a21\u578b\u7684\u6b8b\u5dee\u4e3a\u88ab\u89e3\u91ca\u53d8\u91cf\uff0c\u5bf9\u5176\u8fdb\u884c GARCH(p', q') \u5efa\u6a21\uff1b\u7b2c\u4e8c\u6b65\u4e2d\u56e0\u4e3a\u88ab\u89e3\u91ca\u53d8\u91cf\u662f\u6b8b\u5dee\uff0c\u56e0\u6b64 GARCH \u6a21\u578b\u7684 mean model $\\mu_t = 0 $\uff0c\u5373\u5047\u8bbe\u6b8b\u5dee\u5747\u503c\u4e3a\u96f6\u3002</p> <p>\u8fd9\u79cd\u505a\u6cd5\u770b\u4f3c\u5408\u7406\uff0c\u4f46\u662f\u4ece\u6761\u4ef6\u5747\u503c\u89d2\u5ea6\u6765\u8bf4\uff0c\u5b83\u4e5f\u4ec5\u4ec5\u662f\u5229\u7528\u4e86 ARMA \u8fd9\u4e00\u6b65\uff08\u7b2c\u4e8c\u6b65\u7684 GARCH \u5efa\u6a21\u7531\u4e8e\u5047\u8bbe mean model\\(\\mu_t = 0\\) \u56e0\u6b64\u5bf9\u6761\u4ef6\u5747\u503c\u4e0d\u518d\u6709\u5f71\u54cd\uff09\uff0c\u800c\u6ca1\u6709\u5229\u7528 ARMA + GARCH \u7684\u8054\u5408\u4f30\u8ba1\u8003\u5bdf\u5f02\u65b9\u5dee\u5bf9\u6536\u76ca\u7387\u5e8f\u5217\u7684\u5f71\u54cd\u3002\u901a\u5e38\u6765\u8bf4\uff0c\u5c31 ARMA \u7684\u53c2\u6570\u800c\u8a00\uff0c\u4ec5\u4f7f\u7528 ARMA \u548c\u8054\u5408\u4f7f\u7528 ARMA + GARCH \u7684\u7ed3\u679c\u662f\u6709\u5dee\u5f02\u7684\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u4f7f\u7528 AR(2) \u548c AR(2) + GARCH(1, 1) \u4e24\u79cd\u65b9\u6cd5\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\u3002</p> <p>\u63d2\u64ad\u4e00\u53e5\uff1a\u6709\u5c0f\u4f19\u4f34\u53ef\u80fd\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u7528 AR \u4e0d\u7528 ARMA\u3002\u8fd9\u662f\u56e0\u4e3a python \u4e2d\u7684 arch package \u76ee\u524d\u6240\u652f\u6301\u7684 mean model \u4e2d\u4e0d\u5305\u62ec ARMA \u6a21\u578b\uff0c\u4f46\u5305\u62ec AR \u6a21\u578b\u3002R \u5728\u8fd9\u65b9\u9762\u652f\u6301\u7684\u66f4\u5f3a\u5927\u4e00\u4e9b\u3002</p> <p>OK\uff0c\u56de\u5230\u4f8b\u5b50\u3002\u4e0b\u8868\u5c55\u793a\u4e86\u4e24\u79cd\u65b9\u6cd5\u5efa\u6a21\u65f6\uff0cAR(2) \u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u770b\u51fa\u5b83\u4eec\u4e4b\u95f4\u7684\u5dee\u5f02\u3002</p> <p></p> <p>\u6240\u4ee5\uff0cGARCH \u6a21\u578b\u867d\u597d\uff0c\u4f46\u662f use with care\u3002\u6211\u4eec\u5e94\u65f6\u523b\u641e\u6e05\u695a\u662f\u5728\u5bf9\u4ec0\u4e48\u5efa\u6a21\u3001\u600e\u4e48\u5efa\u6a21\uff0cmean model \u662f\u4ec0\u4e48\u3001volatility model \u53c8\u662f\u4ec0\u4e48\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#5","title":"5 \u7b80\u5355\u5b9e\u8bc1","text":"<p>\u6700\u540e\u901a\u8fc7\u4e00\u4e2a toy example \u6765\u4ecb\u7ecd ARMA + GARCH \u7684\u5e94\u7528\u3002</p> <p>\u4ee5\u4e0b\u5bf9\u4e0a\u8bc1\u6307\u6570\u81ea 2012 \u5e74 1 \u6708\u5230 2019 \u5e74 7 \u6708\u7684\u65e5\u9891\u5bf9\u6570\u6536\u76ca\u7387\u8fdb\u884c\u65f6\u95f4\u5e8f\u5217\u5efa\u6a21\uff0c\u5e76\u4f7f\u7528\u8be5\u6a21\u578b\u9884\u6d4b\u4e0b\u4e00\u4e2a\u4ea4\u6613\u7684\u6536\u76ca\u7387\u3002\u5982\u679c\u9884\u6d4b\u4e3a\u6b63\u5219\u9009\u62e9\u6301\u6709\u4e0a\u8bc1\u6307\u6570\uff0c\u53cd\u4e4b\u5219\u7a7a\u4ed3\uff1b\u5047\u8bbe\u4ee5\u6536\u76d8\u4ef7\u6210\u4ea4\u4e14\u4e0d\u8003\u8651\u4efb\u4f55\u4ea4\u6613\u6210\u672c\u3002</p> <p>\u5728\u6784\u5efa\u7b56\u7565\u65f6\uff0c\u91c7\u7528\u957f\u5ea6\u4e3a T \u7684\u6eda\u52a8\u7a97\u53e3\u5386\u53f2\u6570\u636e\u3002\u9996\u5148\u662f\u7528 AR \u5bf9\u6536\u76ca\u7387\u5efa\u6a21\uff08\u56e0\u4e3a python arch package \u4e0d\u652f\u6301 ARMA \u4f5c\u4e3a mean model\uff0c\u6240\u4ee5\u4ec5\u4f7f\u7528 AR(p) \u6a21\u578b\uff09\uff0c\u5e76\u6839\u636e AIC \u9009\u62e9\u6700\u4f18 p \u503c\uff08p \u53d6\u503c\u8303\u56f4\u4e3a 0 \u5230 5\uff09\uff1b\u7136\u540e\u4ee5\u8be5 AR(p) \u4f5c\u4e3a mean model\uff0c\u5e76\u4f7f\u7528 GARCH(1, 1) \u6a21\u578b\u4e3a volatility model\uff0c\u8fdb\u884c\u8054\u5408\u53c2\u6570\u4f30\u8ba1\u3002\u4f7f\u7528\u6700\u7ec8\u7684\u6a21\u578b\u9884\u6d4b\u4e0b\u4e00\u4e2a\u4ea4\u6613\u65e5\u6536\u76ca\u7387\u3002\u6b64\u5916\u4f5c\u4e3a\u6bd4\u8f83\uff0c\u6211\u4eec\u4e5f\u8003\u8651\u4ec5\u91c7\u7528 AR(p) \u6765\u5bf9\u6536\u76ca\u7387\u5efa\u6a21\uff0c\u800c\u4e0d\u8003\u8651\u6761\u4ef6\u5f02\u65b9\u5dee\u7684\u5f71\u54cd\u3002</p> <p>\u9996\u5148\u6765\u770b T = 60 \u4e2a\u4ea4\u6613\u65e5\u7684\u60c5\u51b5\u3002\u4e0b\u56fe\u5c55\u793a\u4e86 AR \u548c AR + GARCH \u4e24\u79cd\u7b56\u7565\u7684\u51c0\u503c\u548c\u56de\u64a4\u66f2\u7ebf\u3002\u5c31\u8868\u73b0\u800c\u8a00\uff0c\u5b83\u4eec\u5747\u6218\u80dc\u4e86\u4e0a\u8bc1\u6307\u6570\u672c\u8eab\uff08benchmark\uff09\u3002\u4f46\u662f\u5728\u80a1\u707e\u4e4b\u540e\uff08\u6ce2\u52a8\u7387\u53d8\u5927\u4e86\uff09\uff0c\u8fd9\u4e24\u79cd\u6a21\u578b\u7684\u8868\u73b0\u53d1\u751f\u4e86\u5206\u5316\uff0c\u5c31\u8fd9\u4e2a\u7b80\u5355\u5b9e\u8bc1\u800c\u8a00\uff0cAR \u7684\u6548\u679c\u6bd4 AR + GARCH \u66f4\u597d\u3002</p> <p></p> <p>\u518d\u6765\u770b\u770b\u628a\u6eda\u52a8\u7a97\u53e3\u957f\u5ea6\u6362\u5230 T = 252 \u7684\u60c5\u51b5\u3002\u7ed3\u679c\u548c\u4e0a\u9762\u63a5\u8fd1\uff0c\u4f9d\u7136\u662f AR \u6218\u80dc\u4e86 AR + GARCH \u7684\u7ec4\u5408\u3002</p> <p></p> <p>\u4ece\u672c\u5c0f\u8282\u7684\u4f8b\u5b50\u6765\u770b\uff0c\u52a0\u5165\u4e86 GARCH \u7684\u7b56\u7565\u4f3c\u4e4e\u5e76\u6ca1\u6709\u4ec5\u4f7f\u7528 AR \u7684\u7b56\u7565\u4f18\u5f02\u3002\u6211\u5728\u6700\u540e\u7684\u7ed3\u8bed\u90e8\u5206\u5bf9\u6b64\u505a\u7b80\u5355\u8bc4\u4ef7\u3002</p>"},{"location":"courses/time-series-analysis/05-complete/#6","title":"6 \u7ed3\u8bed","text":"<p>\u4f5c\u4e3a\u201c\u8865\u5b8c\u7bc7\u201d\uff0c\u672c\u6587\u586b\u4e86\u300a\u5199\u7ed9\u4f60\u7684\u91d1\u878d\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u300b\u6700\u540e\u4e00\u4e2a\u5927\u5751 \u2014\u2014 GARCH\uff1b\u5199\u4f5c\u7684\u91cd\u70b9\u5728\u4e8e\u9610\u8ff0\u4f7f\u7528 mean model \u548c volatility model \u5bf9\u6536\u76ca\u7387\u5e8f\u5217\u8054\u5408\u5efa\u6a21\uff0c\u4ee5\u53ca\u5728\u4e00\u4e2a\u6574\u5408\u7684\u6846\u67b6\u4e0b\u5bf9\u4e24\u79cd\u6a21\u578b\u7684\u53c2\u6570\u8fdb\u884c\u8054\u5408\u4f30\u8ba1\u3002</p> <p>\u672c\u6587\u7684\u7b2c 5 \u8282\u7ed9\u51fa\u4e86\u4e00\u4e2a\u7b80\u5355\u5b9e\u8bc1\u3002\u56e0 python arch package \u7684\u529f\u80fd\u6240\u9650\uff0c\u5b9e\u8bc1\u4e2d\u7684 mean model \u4ec5\u91c7\u7528\u4e86 AR \u6a21\u578b\u3002\u611f\u5174\u8da3\u7684\u5c0f\u4f19\u4f34\u4e0d\u59a8\u5c1d\u8bd5 R \u7684\u76f8\u5173 packages\u3002</p> <p>\u4ece\u5b9e\u8bc1\u7ed3\u679c\u6765\u770b\uff0c\u52a0\u5165 GARCH \u4f3c\u4e4e\u6ca1\u4ec0\u4e48\u6548\u679c\u3002\u4f46\u4e0d\u8981\u5fd8\u4e86\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u5bf9 GARCH \u7684\u53c2\u6570\u8fdb\u884c\u4efb\u4f55\u4f18\u5316\uff0c\u4e5f\u6ca1\u6709\u989d\u5916\u5229\u7528\u5176\u5bf9\u6ce2\u52a8\u7387\u7684\u5efa\u6a21\u6765\u6dfb\u52a0\u66f4\u52a0\u590d\u6742\u7684\u89c4\u5219 \u2014\u2014 \u6bd4\u5982 volatility scaling\u3002\u56e0\u6b64\uff0c\u4ec5\u4ec5\u57fa\u4e8e\u8fd9\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u96be\u4ee5\u5bf9 GARCH \u7684\u8d21\u732e\u505a\u51fa\u4efb\u4f55\u6b63\u786e\u7684\u8bc4\u5224\u3002</p> <p>\u5bf9\u4e8e\u91cf\u5316\u6295\u8d44\u7684\u7814\u7a76\u6765\u8bf4\uff0c\u6784\u5efa\u51fa\u7b56\u7565\u5e76\u770b\u5230\u56de\u6d4b\u51fa\u6765\u7684\u51c0\u503c\u66f2\u7ebf\u65e0\u7591\u662f\u6700\u4ee4\u4eba\u6fc0\u52a8\u7684\u3002\u7136\u800c\uff0c\u771f\u6b63\u7814\u7a76\u5de5\u4f5c\u7684\u6838\u5fc3\u5374\u5728\u4e8e\u641e\u61c2\u6bcf\u4e2a\u6a21\u578b\u7684\u539f\u7406\u4ee5\u53ca\u5b83\u7684\u4f5c\u7528\uff0c\u800c\u8fd9\u4e2a\u8fc7\u7a0b\u6ce8\u5b9a\u662f\u67af\u71e5\u7684\u3002Quantstart Team \u5728\u5176\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7cfb\u5217\u6587\u7ae0\uff08\u4ee5\u53ca\u5176\u4ed6\u7cfb\u5217\uff09\u4e2d\u4e0d\u538c\u5176\u70e6\u7684\u4ecb\u7ecd\u6bcf\u4e2a\u57fa\u7840\u6a21\u578b\uff0c\u4ece\u7b80\u5355\u5230\u590d\u6742\uff0c\u50cf\u642d\u79ef\u6728\u4e00\u6837\u4e3a\u8bfb\u8005\u6784\u5efa\u77e5\u8bc6\u4f53\u7cfb\uff0c\u4ee4\u4eba\u656c\u4f69\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6709\u4e86\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u7684\u5404\u4e2a building blocks\u3002\u4f46\u662f\uff0c\u80fd\u591f\u7528\u5b83\u4eec\u505a\u4ec0\u4e48\u3001\u5982\u4f55\u53bb\u66f4\u79d1\u5b66\u7684\u5bf9\u6536\u76ca\u7387\u5206\u6790\u3001\u9884\u6d4b\uff0c\u8fd8\u9700\u6709\u7ecf\u9a8c\u7684\u79ef\u7d2f\u3002\u6700\u540e\uff0c\u6211\u60f3\u4ee5\u4e0b\u9762\u8fd9\u6bb5\u51fa\u81ea Quantstart \u7684\u8bdd\u4f5c\u4e3a\u672c\u7cfb\u5217\u7684\u7ed3\u675f\uff0c\u4e5f\u5e0c\u671b\u4e0e\u5404\u4f4d\u5171\u52c9\u3002</p> <p>True quantitative trading research is careful, measured and takes significant time to get right. There is no quick fix or \"get rich scheme\" in quant trading.</p>"},{"location":"courses/time-series-analysis/05-complete/#_2","title":"\u53c2\u8003\u6587\u732e","text":"<ul> <li>Engle, R. F. (1982). Autoregressive conditional heteroscedasticity with estimates of the variance of United Kingdom inflation. Econometrica, Vol. 50(4), 987 \u2013 1008.</li> <li>Tsay, R. S. (2010). Analysis of Financial Time Series (3<sup>rd</sup> ed). Wiley.</li> <li>Generalised Autoregressive Conditional Heteroskedasticity GARCH-p-q Models for Time-Series analysis</li> </ul> <p>\u514d\u8d23\u58f0\u660e\uff1a \u6587\u7ae0\u5185\u5bb9\u4e0d\u53ef\u89c6\u4e3a\u6295\u8d44\u610f\u89c1\u3002\u5e02\u573a\u6709\u98ce\u9669\uff0c\u5165\u5e02\u9700\u8c28\u614e\u3002</p>"},{"location":"database/maridb-ax-setup/","title":"MariaDB AX \u5b89\u88c5\u6d4b\u8bd5\u7b80\u8bb0","text":""},{"location":"database/maridb-ax-setup/#mariadb-ax_1","title":"MariaDB AX \u67b6\u6784","text":"<p>\u5728\u5b98\u65b9\u7ed9\u51fa\u7684\u67b6\u6784\u56fe\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5206\u4e3a\u4e09\u4e2a\u7ec4\u4ef6\u6784\u6210\uff1aUM\u3001PM\u3001\u6570\u636e\u5b58\u50a8\u5c42\u3002</p> <p>\u7528\u6237\u6a21\u5757\uff08UM\uff09\uff1a \u7528\u6237\u6a21\u5757\u7ba1\u7406\u548c\u63a7\u5236\u7ec8\u7aef\u7528\u6237\u67e5\u8be2\u7684\u64cd\u4f5c\uff0c\u5b83\u7ef4\u62a4\u6bcf\u4e2a\u67e5\u8be2\u7684\u72b6\u6001\uff0c\u5411\u4e00\u4e2a\u6216\u591a\u4e2a\u6027\u80fd\u6a21\u5757\u53d1\u51fa\u8bf7\u6c42\u4ee5\u4ee3\u4e3a\u6267\u884cSQL\u67e5\u8be2\u5de5\u4f5c\uff0c\u6700\u540e\uff0c\u7528\u6237\u6a21\u5757\u6c47\u96c6\u6765\u81ea\u5404\u4e2a\u53c2\u4e0e\u7684\u6027\u80fd\u6a21\u5757\u7684\u6240\u6709\u67e5\u8be2\u7ed3\u679c\uff0c\u4ee5\u5f62\u6210\u8fd4\u56de\u7ed9\u7528\u6237\u7684\u5b8c\u6574\u7684\u67e5\u8be2\u7ed3\u679c\u96c6\u3002</p> <p>\u6027\u80fd\u6a21\u5757\uff08PM\uff09\uff1a \u6027\u80fd\u6a21\u5757\u8d1f\u8d23\u5b58\u50a8\uff0c\u68c0\u7d22\u548c\u7ba1\u7406\u6570\u636e\uff0c\u5904\u7406\u5bf9\u67e5\u8be2\u64cd\u4f5c\u7684\u5757\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u4f20\u9012\u56de\u7528\u6237\u6a21\u5757\u4ee5\u5b8c\u6210\u67e5\u8be2\u8bf7\u6c42\u3002\u6027\u80fd\u6a21\u5757\u5c06\u83b7\u53d6\u7684\u6570\u636e\u7f13\u5b58\u5728\u5176\u5185\u5b58\u4e2d\u8ba1\u7b97\u3002MPP\u662f\u901a\u8fc7\u5141\u8bb8\u7528\u6237\u914d\u7f6e\u5c3d\u53ef\u80fd\u591a\u7684\u6027\u80fd\u6a21\u5757\uff0c\u4ee5\u5b9e\u73b0\u66f4\u9ad8\u7684\u5904\u7406\u80fd\u529b\u3002</p> <p>\u5b58\u50a8\uff1a MariaDB ColumnStore\u5bf9\u4e8e\u5b58\u50a8\u7cfb\u7edf\u6781\u4e3a\u7075\u6d3b\u3002\u5f53\u5728\u5185\u90e8\u8fd0\u884c\u65f6\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528\u672c\u5730\u5b58\u50a8\u6216\u5171\u4eab\u5b58\u50a8\uff08\u4f8b\u5982SAN\uff09\u6765\u5b58\u50a8\u6570\u636e\u3002\u5728Amazon EC2\u73af\u5883\u4e2d\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528\u4e34\u65f6\u6216\u5f39\u6027\u5757\u5b58\u50a8\uff08EBS\uff09\u5377\u3002\u5f53\u65e0\u5171\u4eab\u90e8\u7f72\u9700\u8981\u6570\u636e\u5197\u4f59\u65f6\uff0c\u5b83\u88ab\u6784\u5efa\u4e3a\u4e0eGlusterFS\u548cApache Hadoop\u5206\u5e03\u5f0f\u6587\u4ef6\u7cfb\u7edf\uff08HDFS\uff09\u96c6\u6210\u3002</p> <p>\u4e00\u53e5\u8bdd\u603b\u7ed3\uff1a\u7528\u6237\u6a21\u5757\uff08UM\uff09\u5c06\u5ba2\u6237\u7aef\u53d1\u51fa\u7684SQL\u8bf7\u6c42\u8fdb\u884c\u5206\u914d\uff0c\u5206\u914d\u5230\u540e\u7aef\u6027\u80fd\u6a21\u5757\uff08PM\uff09\uff0cPM\u8fdb\u884c\u6570\u636e\u67e5\u8be2\u5206\u6790\uff0c\u5c06\u5904\u7406\u7684\u7ed3\u679c\u8fd4\u56de\u7ed9UM\uff0cUM\u518d\u628aPM\u5206\u6790\u7684\u7ed3\u679c\u8fdb\u884c\u805a\u5408\uff0c\u6700\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u6700\u7ec8\u7684\u67e5\u8be2\u7ed3\u679c\u3002</p>"},{"location":"database/maridb-ax-setup/#mariadb","title":"MariaDB \u7ec4\u4ef6\u67b6\u6784","text":"<p>\u5176\u6838\u5fc3\u662f ColumnStore \u8fd9\u4e2a\u7ec4\u4ef6\uff0c\u5b83\u5c31\u662f\u6700\u65e9\u7684InfroBright\uff0c\u540c\u65f6\u628a\u539f\u6765\u652f\u6301HDFS\u7684InfiniBand\u4e5f\u79fb\u690d\u8fc7\u6765\u4e86\uff0c\u56e0\u6b64\u5e95\u5c42\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u662f\u652f\u6301HDFS\u7684\uff08\u540e\u9762\u7ee7\u7eed\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff09</p>"},{"location":"database/maridb-ax-setup/#_1","title":"\u5b89\u88c5","text":""},{"location":"database/maridb-ax-setup/#_2","title":"\u524d\u63d0\u6761\u4ef6","text":"<ol> <li>\u89c4\u5212\u597d\u54ea\u4e9b\u8282\u70b9\u505aUM\uff0c\u54ea\u4e9b\u8282\u70b9\u505aPM\uff0c\u5b58\u50a8\u662f\u7528\u5185\u7f6e\u7684\u8fd8\u662f\u5916\u90e8\u5b58\u50a8</li> <li>\u6240\u6709\u8282\u70b9\u4e4b\u95f4\u9700\u8981\u9884\u5148\u505a\u597d\u5171\u4eab\u5bc6\u94a5SSH\u767b\u9646</li> <li>\u6240\u6709\u8282\u70b9\u5fc5\u987b\u5148\u5b89\u88c5\u4f9d\u8d56\u7684\u5305\uff0c<code>yum install -y  expect perl perl-DBI openssl zlib   perl-DBD-MySQL boost</code></li> <li>\u6240\u6709\u8282\u70b9\u5fc5\u987b\u5378\u8f7dmariadb\u76f8\u5173\u7684\u5305 <code>yum remove -y mariadb mariadb-server</code></li> </ol>"},{"location":"database/maridb-ax-setup/#_3","title":"\u5b89\u88c5","text":"<p>\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\uff08\u4e00\u822c\u662fPM1\uff09\u4e0b\u8f7dAX\u7684\u538b\u7f29\u5305\uff0c\u5efa\u8bae\u4e0b\u8f7dRPM\u7684\u538b\u7f29\u5305(<code>wget https://downloads.mariadb.com/ColumnStore/1.1.6/centos/x86_64/7/mariadb-columnstore-1.1.6-1-centos7.x86_64.rpm.tar.gz</code>) \uff0c\u7136\u540e\u89e3\u538b\u5230<code>/root</code>\u76ee\u5f55\u4e0b \u9996\u5148\u5728\u8be5\u8282\u70b9\u4e0a\u628a\u6240\u6709\u7684rpm\u5305\u90fd\u5b89\u88c5\u4e0a\uff0c\u7136\u540e\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <pre><code>/usr/local/mariadb/columnstore/bin/postConfigure\n</code></pre> <p>\u6309\u7167\u63d0\u793a\uff0c\u5e76\u6839\u636e\u81ea\u5df1\u7684\u89c4\u5212\u8fdb\u884c\u914d\u7f6e\uff08\u8fd9\u91cc\u6682\u65f6\u501f\u7528\u522b\u7684\u56fe\uff09</p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p>"},{"location":"database/maridb-ax-setup/#_4","title":"\u6d4b\u8bd5","text":"<p>\u8fd9\u91cc\u4f7f\u7528Cloudera Tutorial\u4e2d\u7684retail_db\u5e93\u6765\u505a\u6d4b\u8bd5\uff0c\u4e0d\u8fc7\u4e3a\u4e86\u4f7f\u7528<code>ColumnStore</code>\u5f15\u64ce\uff0c\u5efa\u8868\u8bed\u53e5\u9700\u8981\u8fdb\u884c\u4e00\u5b9a\u7684\u8c03\u6574\uff0c\u76ee\u524d\u8be5\u5f15\u64ce\u4e0d\u652f\u6301\u4e3b\u952e\uff0c\u7d22\u5f15\u7b49\u3002\u56e0\u6b64\u7b80\u8868\u8bed\u53e5\u5982\u4e0b\uff1a</p> <pre><code>create table products (\n    product_id int(11) not null,\n    `product_category_id` int(11) ,\n    `product_name` varchar(45),\n    `product_description` varchar(255) ,\n    `product_price` float ,\n    `product_image` varchar(255) \n) engine=ColumnStore;\n\n\nCREATE TABLE `categories` (\n  `category_id` int(11) ,\n  `category_department_id` int(11) ,\n  `category_name` varchar(45) \n)engine=ColumnStore;\n\nCREATE TABLE `customers` (\n  `customer_id` int(11) ,\n  `customer_fname` varchar(45) ,\n  `customer_lname` varchar(45) ,\n  `customer_email` varchar(45) ,\n  `customer_password` varchar(45) ,\n  `customer_street` varchar(255) ,\n  `customer_city` varchar(45) ,\n  `customer_state` varchar(45) ,\n  `customer_zipcode` varchar(45) \n) engine=ColumnStore;\n\n\nCREATE TABLE `departments` (\n`department_id` int(11) ,\n`department_name` varchar(45) \n)engine=ColumnStore;\n\n\nCREATE TABLE `order_items` (\n`order_item_id` int(11) ,\n`order_item_order_id` int(11) ,\n`order_item_product_id` int(11) ,\n`order_item_quantity` tinyint(4) ,\n`order_item_subtotal` float ,\n`order_item_product_price` float \n)engine=ColumnStore;\n\nCREATE TABLE `orders` (\n`order_id` int(11) ,\n`order_date` datetime ,\n`order_customer_id` int(11) ,\n`order_status` varchar(45) \n)engine=ColumnStore;\n</code></pre> <p>\u5176\u6570\u636e\u5229\u7528\u539f\u59cb\u6570\u636e\u7136\u540e\u8fdb\u884c\u4e0d\u65ad<code>insert into select</code>\u65b9\u5f0f\u8fdb\u884c\u8ffd\u52a0\u3002\u8fd9\u91cc\u6211\u5bf9\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u5b89\u88c5\u7684MariaDB\u4ee5\u53ca\u4e00\u4e2a\u9ed8\u8ba4\u914d\u7f6e\u7684MariaDB AX(1 um + 3 pm)\uff0c\u6d4b\u8bd5\u8bed\u53e5\u5982\u4e0b\uff1a</p> <pre><code>select p.product_id, p.product_name, r.revenue\nfrom products p inner join\n(select oi.order_item_product_id, sum(oi.order_item_subtotal) as revenue\nfrom order_items oi inner join orders o\non oi.order_item_order_id = o.order_id\nwhere o.order_status &lt;&gt; 'CANCELED'\nand o.order_status &lt;&gt; 'SUSPECTED_FRAUD'\ngroup by order_item_product_id) r\non p.product_id = r.order_item_product_id\norder by r.revenue desc\nlimit 10;\n</code></pre> <p>\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p> <p></p> <p>\u4e0b\u9762\u662f\u53e6\u5916\u4e00\u4e2a\u6d4b\u8bd5\u8bed\u53e5\uff1a</p> <pre><code>select c.category_name, count(order_item_quantity) as count\nfrom order_items oi\ninner join products p on oi.order_item_product_id = p.product_id\ninner join categories c on c.category_id = p.product_category_id\ngroup by c.category_name\norder by count desc\nlimit 10;\n</code></pre> <p>\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p> <p></p> <p>\u5de6\u8fb9\u662fAX\u7684\u67e5\u8be2\u65f6\u95f4\uff0c\u53f3\u8fb9\u662fmariadb\u7684\u67e5\u8be2\u65f6\u95f4\u3002</p> <p>\u76f8\u5173\u7684\u8bb0\u5f55\u6761\u6570\u5982\u4e0b\uff1a</p> <pre><code>+-------------+---------+\n| table_name  | num     |\n+-------------+---------+\n| orders      | 2204256 |\n| order_items | 5510336 |\n| products    |    1345 |\n+-------------+---------+\n3 rows in set (0.14 sec)\n</code></pre>"},{"location":"database/mysql-cluster-setup/","title":"MySQL Cluster \u914d\u7f6e","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_1","title":"\u51c6\u5907\u670d\u52a1\u5668","text":"<p>\u8ba1\u5212\u5efa\u7acb\u67095\u4e2a\u8282\u70b9\u7684MySQL CLuster\u4f53\u7cfb\uff0c\u9700\u8981\u7528\u52305\u53f0\u670d\u52a1\u5668\uff0c\u4f46\u662f\u6211\u4eec\u505a\u5b9e\u9a8c\u65f6\u6ca1\u6709\u8fd9\u4e48\u591a\u673a\u5668\uff0c\u53ef\u4ee5\u53ea\u75283\u53f0\uff0c\u63d0\u4f9b5\u4e2a\u8282\u70b9\u7684MySQL CLuster\u4f53\u7cfb\uff0c\u5c06SQL\u8282\u70b9\u548c\u6570\u636e\u8282\u70b9\u5171\u7528\u4e00\u53f0\u673a\u5668\uff0c\u5177\u4f53\u5982\u4e0b\u3002</p> \u4e3b\u673a\u540d \u8282\u70b9 \u5bf9\u5e94\u7684IP\u548c\u7aef\u53e3 DB-mgm \u7ba1\u7406\u8282\u70b9 10.10.6.201:1186 DB-node1 \u6570\u636e\u8282\u70b9 10.10.6.211:2202 DB-node1 SQL\u8282\u70b9 10.10.6.211:3306 DB-node2 \u6570\u636e\u8282\u70b9 10.10.6.212:2202 DB-node2 SQL\u8282\u70b9 10.10.6.212:3306","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_2","title":"\u51c6\u5907\u8f6f\u4ef6\u5305","text":"<p>\u73b0\u5728\u7684mysql\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e13\u95e8\u4f5c\u96c6\u7fa4\u7684\u5b89\u88c5\u5305\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u4e00\u4e2a\u4e2a\u7684\u4e0b\u8f7d\u6240\u9700\u8981\u7684\u5de5\u5177\u4e86\u3002\u4ece\u5b98\u7f51\u4e0b\u8f7d\u3002 http://cdn.mysql.com/Downloads/MySQL-Cluster-7.4/mysql-cluster-gpl-7.4.5-linux-glibc2.5-x86_64.tar.gz</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_3","title":"\u5b89\u88c5","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#sql","title":"\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\uff08\u5404\u4e24\u53f0\uff09","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#mysql","title":"\u6dfb\u52a0mysql\u7528\u6237\u548c\u7ec4\uff0c\u8fd9\u662f\u5fc5\u9700\u7684\u3002","text":"<pre><code>[root@DB-node1 ~]# groupadd mysql\n[root@DB-node1 ~]# useradd -g mysql mysql\n[root@DB-node1 ~]#\u00a0\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_4","title":"\u5f00\u59cb\u5b89\u88c5\uff0c\u4e0b\u8f7d\u7684\u7248\u672c\u662f\u514d\u7f16\u8bd1\u7684\uff0c\u590d\u5236\u8fc7\u6765\u5c31\u53ef\u4ee5\u7528\u4e86\u3002","text":"<pre><code>[root@DB-node1 ~]# http://cdn.mysql.com/Downloads/MySQL-Cluster-7.4/mysql-cluster-gpl-7.4.5-linux-glibc2.5-x86_64.tar.gz \n[root@DB-node1 ~]# tar -zxvf mysql-cluster-gpl-7.4.5-linux-glibc2.5-x86_64.tar.gz -C /usr/local/\n[root@DB-node1 ~]# ln -sv /usr/local/mysql-cluster-gpl-7.4.5-linux-glibc2.5-x86_64/ /usr/local/mysql\n[root@DB-node1 ~]#\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_5","title":"\u4fee\u6539\u76ee\u5f55\u6743\u9650\uff0c\u8fd9\u4e5f\u662f\u5fc5\u9700\u7684\uff0c\u4e0d\u7136\u7b2c\u56db\u6b65\u4f1a\u62a5\u9519\u7684\u3002","text":"<pre><code>[root@DB-node1 ~]# chown -R mysql.root /usr/local/mysql\n[root@DB-node1 ~]# chown -R mysql.root /usr/local/mysql/\n[root@DB-node1 ~]#\u00a0\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_6","title":"\u5b89\u88c5\u521d\u59cb\u7684\u6570\u636e\u5e93\u8868","text":"<pre><code>[root@DB-node1 ~]# /usr/local/mysql/scripts/mysql_install_db --user=mysql\nFATAL ERROR: Could not find ./bin/my_print_defaults\nIf you compiled from source, you need to run 'make install' to\ncopy the software into the correct location ready for operation.\nIf you are using a binary release, you must either be at the top\nlevel of the extracted archive, or pass the --basedir option\npointing to that location.\n</code></pre> <p>\u5982\u679c\u51fa\u73b0\u4e0a\u9762\u9519\u8bef\uff0c\u8bf4\u660e\u6ca1\u6709\u6307\u5b9amysql\u76ee\u5f55\uff0c\u9700\u624b\u5de5\u6307\u5b9a\u3002 \u89e3\u51b3\u65b9\u6cd5</p> <pre><code>[root@DB-node1 ~]# /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data/\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#mysql_1","title":"\u8bbe\u7f6emysql\u670d\u52a1\u4e3a\u5f00\u673a\u81ea\u542f\u52a8\u5e76\u542f\u52a8","text":"<pre><code>[root@DB-node1 ~]# cp /usr/local/mysql/support-files/mysql.server /etc/rc.d/init.d/mysqld\n[root@DB-node1 ~]# chmod +x /etc/rc.d/init.d/mysqld\u00a0\n[root@DB-node1 ~]# chkconfig --add mysqld\u00a0\n[root@DB-node1 ~]# chkconfig --list mysqld\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\nmysqld\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0:off\u00a0\u00a0 1:off\u00a0\u00a0 2:on\u00a0\u00a0\u00a0 3:on\u00a0\u00a0\u00a0 4:on\u00a0\u00a0\u00a0 5:on\u00a0\u00a0\u00a0 6:off\n[root@DB-node1 ~]#\n[root@DB-node1 ~]# service mysqld start\n</code></pre> <p>\u5230\u8fd9\u4e00\u6b65\uff0c\u5728\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\u4e0a\u5c31\u7b97\u5b89\u88c5\u597d\u4e86\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_7","title":"\u7ba1\u7406\u8282\u70b9","text":"<p>\u7ba1\u7406\u8282\u70b9\u7684\u5b89\u88c5\u66f4\u7b80\u5355\uff0c\u53ea\u8981\u5728\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\u670d\u52a1\u5668\u4e0a\u590d\u5236\u4e9b\u6587\u4ef6\u51fa\u6765\u5c31\u884c\u4e86\uff0c\u867d\u7136\u53ea\u6709\u4e00\u6b65\uff0c</p> <pre><code>[root@DB-mgm ~]# scp 10.10.6.211:/usr/local/mysql/bin/ndb_mgm* /usr/local/bin/\n[root@DB-mgm ~]# ll /usr/local/bin/ndb*\n-rwxr-xr-x 1 root root\u00a0 7137184 Apr 13 09:45 /usr/local/bin/ndb_mgm\n-rwxr-xr-x 1 root root 16336025 Apr 13 09:45 /usr/local/bin/ndb_mgmd\n[root@DB-mgm ~]#\u00a0\n</code></pre> <p>\u7ba1\u7406\u8282\u70b9\u53ea\u8981ndb_mgm\u548cndb_mgmd\u4e24\u4e2a\u6587\u4ef6\u548c\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\uff0c\u56e0\u6b64\u628a\u8fd9\u4e09\u4e2a\u6587\u4ef6\u590d\u5236\u5230\u90a3\u91cc\uff0c\u90a3\u91cc\u5c31\u662f\u7ba1\u7406\u8282\u70b9\u4e86\u3002ndb_mgmd\u662fmysql cluster\u7ba1\u7406\u670d\u52a1\u5668\uff0cndb_mgm\u662f\u5ba2\u6237\u7aef\u7ba1\u7406\u5de5\u5177\uff0c\u7b49\u4e00\u4e0b\u4f1a\u7528\u5230\u5b83\u4eec\u7684\u3002\u5230\u76ee\u524d\u4e3a\u6b62\u4e24\u4e2aSQL\u8282\u70b9\u4e24\u4e2a\u6570\u636e\u8282\u70b9\u548c\u4e00\u4e2a\u7ba1\u7406\u8282\u70b9\u90fd\u5b89\u88c5\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u8fd8\u4e0d\u80fd\u5de5\u4f5c\uff0c\u5f97\u8fdb\u884c\u914d\u7f6e\uff0c\u628a\u8fd9\u51e0\u4e2a\u8282\u70b9\u8054\u7cfb\u5728\u4e00\u8d77\u534f\u540c\u5de5\u4f5c\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_8","title":"\u914d\u7f6e","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#sql_1","title":"\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\uff08\u5404\u4e24\u53f0\uff09","text":"<p>mysql\u670d\u52a1\u542f\u52a8\u65f6\u4f1a\u9ed8\u8ba4\u52a0\u8f7d/etc/my.cnf\u4f5c\u4e3a\u5176\u914d\u7f6e\u6587\u4ef6\uff0c\u8981\u5c06\u4e00\u4e2amysql\u670d\u52a1\u5668\u914d\u7f6e\u6210\u4e00\u4e2a\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\u4e5f\u975e\u5e38\u7684\u7b80\u5355\uff1a \u53ea\u8981\u5728\u5185\u5bb9\u7ed3\u5c3e\u52a0\u4e0a\u4e0b\u97624\u884c\u5c31\u5c06\u8fd9\u4e2amysql\u670d\u52a1\u5668\u53d8\u6210\u4e86\u4e00\u4e2a\u6570\u636e\u8282\u70b9\u548cSQL\u8282\u70b9\u3002</p> <pre><code>ndbcluster\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u8fd0\u884cNDB\u5b58\u50a8\u5f15\u64ce\nndb-connectstring=10.10.6.201\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6307\u5b9a\u7ba1\u7406\u8282\u70b9\u00a0 \u8fd9\u4e24\u884c\u58f0\u660e\u5176\u4e3aSQL\u8282\u70b9\n[mysql_cluster]\nndb-connectstring=10.10.6.201\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6307\u5b9a\u7ba1\u7406\u8282\u70b9\u00a0 \u8fd9\u4e24\u884c\u58f0\u660e\u5176\u4e3a\u6570\u636e\u8282\u70b9\n</code></pre> <p>\u65b0\u5efamysql\u7684\u914d\u7f6e\u6587\u4ef6</p> <pre><code>[root@DB-node1 ~]# vi /etc/my.cnf\n[root@DB-node1 ~]# more /etc/my.cnf\u00a0\n[client]\nport=3306\nsocket=/usr/local/mysql/mysql.sock\n[mysqld]\nbasedir=/usr/local/mysql/\ndatadir=/usr/local/mysql/data\nuser= mysql\npid-file=/usr/local/mysql/mysqld.pid\nlog-error=/usr/local/mysql/mysqld.err\n</code></pre> <p>\u4ee5\u4e0b\u56db\u884c\u4e3a\u65b0\u589e\u52a0\u5185\u5bb9</p> <pre><code>ndbcluster\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u8fd0\u884cNDB\u5b58\u50a8\u5f15\u64ce\nndb-connectstring=10.10.6.201\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6307\u5b9a\u7ba1\u7406\u8282\u70b9\u00a0 \u8fd9\u4e24\u884c\u58f0\u660e\u5176\u4e3aSQL\u8282\u70b9\n[mysql_cluster]\nndb-connectstring=10.10.6.201\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6307\u5b9a\u7ba1\u7406\u8282\u70b9\u00a0 \u8fd9\u4e24\u884c\u58f0\u660e\u5176\u6570\u636e\u8282\u70b9\n</code></pre> <p>\u6ce8\u610f\u4e24\u53f0\u670d\u52a1\u5668\u90fd\u5f97\u8fd9\u6837\u914d\u7f6e\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_9","title":"\u7ba1\u7406\u8282\u70b9","text":"<p>\u7ba1\u7406\u8282\u70b9\u7684\u914d\u7f6e\u590d\u6742\u4e00\u70b9\uff0c\u5728\u7ba1\u7406\u670d\u52a1\u5668<code>/usr/local/mysql/</code>\u76ee\u5f55\u4e2d\u521b\u5efa<code>config.ini</code>\u6587\u4ef6\u3002 \u7f51\u4e0a\u8bf4 \u4f7f\u7528<code>mysql-cluster</code>\uff0c\u4f46\u662f\u542f\u52a8\u65f6 \u603b\u65f6\u6709\u5982\u4e0b\u63d0\u793a\uff1a</p> <pre><code>[root@DB-mgm ~]# ndb_mgmd -f /usr/local/mysql-cluster/config.ini\u00a0\nMySQL Cluster Management Server mysql-5.6.23 ndb-7.4.5\n2015-04-13 14:13:28 [MgmtSrvr] INFO\u00a0\u00a0\u00a0\u00a0 -- The default config directory '/usr/local/mysql/mysql-cluster' does not exist. Trying to create it...\nFailed to create directory '/usr/local/mysql/mysql-cluster', error: 2\n2015-04-13 14:13:28 [MgmtSrvr] ERROR\u00a0\u00a0\u00a0 -- Could not create directory '/usr/local/mysql/mysql-cluster'. Either create it manually or specify a different directory with --configdir=&lt;path&gt;\n</code></pre> <p>\u6700\u540e\u6539\u6210\u4e86<code>/usr/local/mysql</code> \u5c31\u53ef\u4ee5\u4e86</p> <pre><code>[root@DB-mgm ~]# mkdir /usr/local/mysql\n[root@DB-mgm ~]# vi /usr/local/mysql/config.ini\n[root@DB-mgm ~]# more /usr/local/mysql/config.ini\u00a0\n[NDBD DEFAULT]\nNoOfReplicas=1\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u7684\u955c\u50cf\u6570\u91cf\nDataMemory=500M\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u4e2d\u7ed9\u6570\u636e\u5206\u914d\u7684\u5185\u5b58\nIndexMemory=300M\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u4e2d\u7ed9\u7d22\u5f15\u5206\u914d\u7684\u5185\u5b58\n[TCP DEFAULT]\nportnumber=2202\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6570\u636e\u8282\u70b9\u7684\u9ed8\u8ba4\u8fde\u63a5\u7aef\u53e3\n[NDB_MGMD]\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u914d\u7f6e\u7ba1\u7406\u8282\u70b9\nhostname=10.10.6.201\ndatadir=/usr/local/mysql/\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u7ba1\u7406\u8282\u70b9\u6570\u636e(\u65e5\u5fd7)\u76ee\u5f55\n[NDBD]\nhostname=10.10.6.211\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6570\u636e\u8282\u70b9\u914d\u7f6e\ndatadir=/usr/local/mysql/data/\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\\u6570\u636e\u8282\u70b9\u76ee\u5f55\n[NDBD]\nhostname=10.10.6.212\ndatadir=/usr/local/mysql/data/\n[MYSQLD]\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \\\\SQL\u8282\u70b9\u76ee\u5f55\nhostname=10.10.6.211\n[MYSQLD]\nhostname=10.10.6.212\n</code></pre> <ul> <li><code>[NDBD DEFAULT]</code>\uff1a\u8868\u793a\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u7684\u9ed8\u8ba4\u914d\u7f6e\u5728\u6bcf\u4e2a\u8282\u70b9\u7684<code>[NDBD]</code>\u4e2d\u4e0d\u7528\u518d\u5199\u8fd9\u4e9b\u9009\u9879\uff0c\u53ea\u80fd\u6709\u4e00\u4e2a\u3002 </li> <li><code>[NDB_MGMD]</code>\uff1a\u8868\u793a\u7ba1\u7406\u8282\u70b9\u7684\u914d\u7f6e\uff0c\u53ea\u6709\u4e00\u4e2a\u3002 </li> <li><code>[NDBD]</code>\uff1a\u8868\u793a\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u6709\u591a\u4e2a\u3002 </li> <li><code>[MYSQLD]</code>\uff1a\u8868\u793aSQL\u8282\u70b9\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u6709\u591a\u4e2a\uff0c\u5206\u522b\u5199\u4e0a\u4e0d\u540cSQL\u8282\u70b9\u7684IP\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u4ec0\u4e48\u90fd\u4e0d\u5199\uff0c\u53ea\u4fdd\u7559\u4e00\u4e2a\u7a7a\u8282\u70b9\uff0c\u8868\u793a\u4efb\u610f\u4e00\u4e2aIP\u5730\u5740\u90fd\u53ef\u4ee5\u8fdb\u884c\u8bbf\u95ee\uff0c\u6b64\u8282\u70b9\u7684\u4e2a\u6570\u8868\u660e\u4e86\u53ef\u4ee5\u7528\u6765\u8fde\u63a5\u6570\u636e\u8282\u70b9\u7684SQL\u8282\u70b9\u603b\u6570\u3002</li> </ul>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_10","title":"\u542f\u52a8","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_11","title":"\u7ba1\u7406\u8282\u70b9","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_12","title":"\u542f\u52a8\u7ba1\u7406\u8282\u70b9","text":"<p>mysql cluster \u9700\u8981\u5404\u4e2a\u8282\u70b9\u90fd \u8fdb\u884c\u542f\u52a8\u540e\u624d\u53ef\u4ee5\u5de5\u4f5c\uff0c\u8282\u70b9\u7684\u542f\u52a8\u987a\u5e8f\u4e3a\u7ba1\u7406\u8282\u70b9-&gt;\u6570\u636e\u8282\u70b9-&gt;SQL\u8282\u70b9\u3002\u9996\u5148\u542f\u52a8\u7ba1\u7406\u8282\u70b9</p> <pre><code>[root@DB-mgm ~]# ndb_mgmd -f /usr/local/mysql/config.ini\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\nMySQL Cluster Management Server mysql-5.6.23 ndb-7.4.5\n2015-04-13 14:14:14 [MgmtSrvr] INFO\u00a0\u00a0\u00a0\u00a0 -- The default config directory '/usr/local/mysql/mysql-cluster' does not exist. Trying to create it...\n2015-04-13 14:14:14 [MgmtSrvr] INFO\u00a0\u00a0\u00a0\u00a0 -- Sucessfully created config directory\n2015-04-13 14:14:14 [MgmtSrvr] WARNING\u00a0 -- at line 7: [TCP] portnumber is deprecated\n[root@DB-mgm ~]#\n[root@DB-mgm ~]# echo \"/usr/local/bin/ndb_mgmd -f /usr/local/mysql/config.ini \"\u00a0 &gt;&gt;/etc/rc.local\n[root@DB-mgm ~]#\n</code></pre> <p>\u547d\u4ee4\u884c\u4e2d\u7684ndb_mgmd\u662fmysql cluster\u7684\u7ba1\u7406\u670d\u52a1\u5668\uff0c\u540e\u9762\u7684-f\u8868\u793a\u540e\u9762\u7684\u53c2\u6570\u662f\u542f\u52a8\u7684\u53c2\u6570\u914d\u7f6e\u6587\u4ef6\u3002\u5982\u679c\u5728\u542f\u52a8\u540e\u8fc7\u4e86\u51e0\u5929\u53c8\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6570\u636e\u8282\u70b9\uff0c\u8fd9\u65f6\u4fee\u6539\u4e86\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u65f6\u5c31\u5fc5\u987b\u52a0\u4e0a--initial\u53c2\u6570\uff0c\u4e0d\u7136\u6dfb\u52a0\u7684\u8282\u70b9\u4e0d\u4f1a\u4f5c\u7528\u5728mysql cluster\u4e2d\u3002</p> <p><code>./ndb_mgmd -f /var/lib/mysql-cluster/config.ini --initial</code></p> <p>\u542f\u52a8\u65f6\u53ef\u80fd\u4f1a\u62a5\u4e2a<code>WARNING,\u5982WARNING\u00a0 -- at line 7: [TCP] portnumber is deprecated</code>\uff0c\u8fd9\u4e2a\u4e0d\u7528\u7ba1\u3002\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u7684\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_13","title":"\u67e5\u770b\u6709\u65e0\u542f\u52a8\u6210\u529f","text":"<pre><code>[root@DB-mgm ~]# ls /usr/local/mysql/\nconfig.ini\u00a0 mysql-cluster\u00a0 ndb_1_cluster.log\u00a0 ndb_1_out.log\u00a0 ndb_1.pid\n[root@DB-mgm ~]#\u00a0\n[root@DB-mgm ~]# netstat -tlnp | grep 1186\ntcp\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0\u00a0\u00a0\u00a0\u00a0\u00a0 0 0.0.0.0:1186\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0.0.0.0:*\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 LISTEN\u00a0\u00a0\u00a0\u00a0\u00a0 3075/ndb_mgmd\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n[root@DB-mgm ~]# ndb_mgm\n-- NDB Cluster -- Management Client --\nndb_mgm&gt; show\nConnected to Management Server at: localhost:1186\nCluster Configuration\n---------------------\n[ndbd(NDB)]\u00a0\u00a0\u00a0\u00a0 2 node(s)\nid=2 (not connected, accepting connect from 10.10.6.211)\nid=3 (not connected, accepting connect from 10.10.6.212)\n[ndb_mgmd(MGM)] 1 node(s)\nid=1\u00a0\u00a0\u00a0 @10.10.6.201\u00a0 (mysql-5.6.23 ndb-7.4.5)\n[mysqld(API)]\u00a0\u00a0 2 node(s)\nid=4 (not connected, accepting connect from 10.10.6.211)\nid=5 (not connected, accepting connect from 10.10.6.212)\nndb_mgm&gt; exit\n[root@DB-mgm ~]#\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_14","title":"\u6570\u636e\u8282\u70b9\uff08\u4e24\u53f0\uff09","text":"<p>\u5b89\u88c5\u540e\u7b2c\u4e00\u6b21\u542f\u52a8\u6570\u636e\u8282\u70b9\u65f6\u8981\u52a0\u4e0a--initial\u53c2\u6570\uff0c\u5176\u5b83\u65f6\u5019\u4e0d\u8981\u52a0\uff0c\u9664\u975e\u662f\u5728\u5907\u4efd\u3001\u6062\u590d\u6216\u914d\u7f6e\u53d8\u5316\u540e\u91cd\u542f\u65f6\u3002</p> <pre><code>[root@DB-node1 ~]# /usr/local/mysql/bin/ndbd --initial\n2015-04-13 14:49:59 [ndbd] INFO\u00a0\u00a0\u00a0\u00a0 -- Angel connected to '10.10.6.201:1186'\n2015-04-13 14:49:59 [ndbd] INFO\u00a0\u00a0\u00a0\u00a0 -- Angel allocated nodeid: 2\n[root@DB-node1 ~]# netstat -tlnp |grep 2202\ntcp\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0\u00a0\u00a0\u00a0\u00a0\u00a0 0 10.10.6.211:2202\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0.0.0.0:*\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 LISTEN\u00a0\u00a0\u00a0\u00a0\u00a0 14780/ndbd\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n[root@DB-node1 ~]#\u00a0\u00a0\u00a0\u00a0\n[root@DB-node1 ~]# echo /usr/local/mysql/bin/ndbd &gt;&gt;/etc/rc.local\n[root@DB-node1 ~]#\u00a0\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#sql_2","title":"SQL\u8282\u70b9\uff08\u4e24\u53f0\uff09","text":"<pre><code>[root@DB-node1 ~]# service\u00a0 mysqld start\nStarting MySQL SUCCESS!\u00a0\n[root@DB-node1 ~]#\u00a0\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_15","title":"\u5ba2\u6237\u7aef\u7ba1\u7406","text":"<p>\u8fd9\u65f6\u5c31\u8fdb\u5165\u5230\u5ba2\u6237\u7aef\u6216\u7ba1\u7406\u8282\u70b9\uff0c\u53ef\u4ee5\u5bf9mysql cluster\u8fdb\u884c\u5404\u9879\u64cd\u4f5c\uff0c\u8fdb\u5165\u540e\u4f1a\u6709ndb_mgm &gt; \u63d0\u793a\u7b26\u51fa\u73b0\uff0c\u9996\u5148\u6765\u67e5\u770b\u5404\u8282\u70b9\u7684\u8fde\u63a5\u60c5\u51b5\uff0c\u5728<code>ndb_mgm&gt;</code> \u63d0\u793a\u7b26\u4e0b\u8f93\u5165<code>show</code>\uff1a</p> <pre><code>[root@DB-mgm ~]# ndb_mgm\n-- NDB Cluster -- Management Client --\nndb_mgm&gt; show\nConnected to Management Server at: localhost:1186\nCluster Configuration\n---------------------\n[ndbd(NDB)]\u00a0\u00a0\u00a0\u00a0 2 node(s)\nid=2\u00a0\u00a0\u00a0 @10.10.6.211\u00a0 (mysql-5.6.23 ndb-7.4.5, Nodegroup: 0, *)\nid=3\u00a0\u00a0\u00a0 @10.10.6.212\u00a0 (mysql-5.6.23 ndb-7.4.5, Nodegroup: 1)\n[ndb_mgmd(MGM)] 1 node(s)\nid=1\u00a0\u00a0\u00a0 @10.10.6.201\u00a0 (mysql-5.6.23 ndb-7.4.5)\n[mysqld(API)]\u00a0\u00a0 2 node(s)\nid=4\u00a0\u00a0\u00a0 @10.10.6.211\u00a0 (mysql-5.6.23 ndb-7.4.5)\nid=5\u00a0\u00a0\u00a0 @10.10.6.212\u00a0 (mysql-5.6.23 ndb-7.4.5)\nndb_mgm&gt; exit\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5404\u4e2a\u8282\u70b9\u5df2\u7ecf\u8fde\u63a5\u4e0a\u4e86\uff0c\u81f3\u6b64\uff0cmysql cluster\u914d\u7f6e\u5b8c\u6210\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_16","title":"\u5173\u95ed","text":"<p>mysql cluster\u7684\u5173\u95ed\u4e5f\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u5728<code>ndb_mgm&gt;</code> \u63d0\u793a\u7b26\u4e0b\u8f93\u5165 <code>shutdown</code>\u5373\u53ef\uff0c\u8fd9\u65f6\u4f1a\u663e\u793a\u5404\u8282\u70b9\u7684\u5173\u95ed\u4fe1\u606f\uff0c\u518d\u8f93\u5165exit\u5373\u53ef\u9000\u51fandb_mgm\u7ba1\u7406\uff0c\u56de\u5230shell\u4e2d\u3002\u867d\u7136mysql cluster \u5173\u95ed\u4e86\uff0c\u4f46\u662fSQL\u8282\u70b9\u7684mysql\u670d\u52a1\u5e76\u4e0d\u4f1a\u505c\u6b62\u7684\u3002\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u505a\u5404\u79cd\u8bd5\u9a8c\u4e86\u3002</p>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#_17","title":"\u6d4b\u8bd5","text":"","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#sqljedy_db","title":"\u5728\u4e00\u4e2aSQL\u8282\u70b9\u65b0\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u6570\u636e\u5e93\uff0cjedy_db","text":"<pre><code>mysql&gt; create database jedy_db;\nQuery OK, 1 row affected (0.10 sec)\n[DB-node1] mysql&gt; show databases;\n+--------------------+\n| Database\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n+--------------------+\n| information_schema |\n| jedy_db\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| mysql\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| ndb_2_fs\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| ndbinfo\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| performance_schema |\n| test\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n+--------------------+\n7 rows in set (0.05 sec)\n</code></pre>","tags":["mysql","ndb","cluster"]},{"location":"database/mysql-cluster-setup/#sql_3","title":"\u5728\u53e6\u4e00\u4e2aSQL\u8282\u70b9\u67e5\u770b","text":"<pre><code>[DB-node2] mysql&gt; show databases;\n+--------------------+\n| Database\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n+--------------------+\n| information_schema |\n| jedy_db\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| mysql\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| ndb_3_fs\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| ndbinfo\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n| performance_schema |\n| test\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 |\n+--------------------+\n7 rows in set (0.06 sec)\n</code></pre> <p>\u6240\u6709\u914d\u7f6e\u5b8c\u6210</p>","tags":["mysql","ndb","cluster"]},{"location":"database/oracle-11g-imp-and-exp/","title":"Oracle 11g \u5bfc\u5165\u5bfc\u51fa\u57fa\u672c\u64cd\u4f5c","text":"<p>Source</p>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#1-oracle-11g","title":"1. oracle 11g \u6570\u636e\u5e93\u7684\u5bfc\u5165\u5bfc\u51fa","text":"<ul> <li> <p>*</p> </li> <li> <p>oracle11g \u6570\u636e\u5e93\u7684\u5bfc\u5165/\u5bfc\u51fa\uff0c\u5c31\u662f\u6211\u4eec\u901a\u5e38\u6240\u8bf4\u7684oracle\u6570\u636e\u7684\u8fd8\u539f/\u5907\u4efd\u3002</p> </li> <li>\u6570\u636e\u5e93\u5bfc\u5165:\u628a.dmp \u683c\u5f0f\u6587\u4ef6\u4ece\u672c\u5730\u5bfc\u5165\u5230\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e2d\u3002</li> <li>\u6570\u636e\u5e93\u5bfc\u51fa:\u628a\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e2d\u7684\u6570\u636e\u5bfc\u51fa\u5230\u672c\u5730\u751f\u6210.dmp\u683c\u5f0f\u6587\u4ef6\u3002</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#2-oracle-11g-3","title":"2. oracle 11g \u6570\u636e\u5e93\u5bfc\u5165\u5bfc\u51fa\u76843\u79cd\u65b9\u5f0f","text":"<ul> <li> <p>*</p> </li> <li> <p>\u4f20\u7edf\u65b9\u5f0f\uff1aexp(\u5bfc\u51fa)\u548cimp\uff08\u5bfc\u5165\uff09;</p> </li> <li>\u6570\u636e\u6cf5\u65b9\u5f0f\uff1aexpdp\u5bfc\u51fa\u548cimpdp\uff08\u5bfc\u5165\uff09;</li> <li>\u7b2c\u4e09\u65b9\u5de5\u5177\uff1aPL/sql Develpoer\uff0cNavicat\u7b49;</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#3-3","title":"3. 3\u79cd\u65b9\u6cd5\u7684\u4f18\u7f3a\u70b9","text":"<ul> <li>*</li> </ul> <p>3.1 exp/imp:</p> <ul> <li>\u4f18\u70b9:\u4ee3\u7801\u4e66\u5199\u7b80\u5355\u6613\u61c2,\u4ece\u672c\u5730\u5373\u53ef\u76f4\u63a5\u5bfc\u5165\uff0c\u4e0d\u7528\u5728\u670d\u52a1\u5668\u4e2d\u64cd\u4f5c\uff0c\u964d\u4f4e\u96be\u5ea6\uff0c\u51cf\u5c11\u670d\u52a1\u5668\u4e0a\u7684\u64cd\u4f5c\u4e5f\u5c31 \u4fdd\u8bc1\u4e86\u670d\u52a1\u5668\u4e0a\u6570\u636e\u6587\u4ef6\u7684\u5b89\u5168\u6027\u3002</li> <li>\u7f3a\u70b9\uff1a\u8fd9\u79cd\u5bfc\u5165\u5bfc\u51fa\u7684\u901f\u5ea6\u76f8\u5bf9\u8f83\u6162\uff0c\u5408\u9002\u6570\u636e\u5e93\u6570\u636e\u8f83\u5c11\u7684\u65f6\u5019\u3002\u5982\u679c\u6587\u4ef6\u8d85\u8fc7\u51e0\u4e2aG\uff0c\u5927\u4f17\u6027\u80fd\u7684\u7535 \u8111\uff0c\u81f3\u5c11\u9700\u89814~5\u4e2a\u5c0f\u65f6\u5de6\u53f3\u3002</li> </ul> <p>3.2 expdp/impdp</p> <ul> <li>\u4f18\u70b9:\u5bfc\u5165\u5bfc\u51fa\u901f\u5ea6\u76f8\u5bf9\u8f83\u5feb,\u51e0\u4e2aG\u7684\u6570\u636e\u6587\u4ef6\u4e00\u822c\u57281~2\u5c0f\u65f6\u5de6\u53f3\u3002</li> <li>\u7f3a\u70b9:\u4ee3\u7801\u76f8\u5bf9\u4e0d\u6613\u7406\u89e3,\u8981\u60f3\u5b9e\u73b0\u5bfc\u5165\u5bfc\u51fa\u7684\u64cd\u4f5c\uff0c\u5fc5\u987b\u5728\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u903b\u8f91\u76ee\u5f55(\u4e0d\u662f\u771f\u6b63\u7684\u76ee\u5f55)\u3002\u6211\u4eec \u90fd\u77e5\u9053\u6570\u636e\u5e93\u670d\u52a1\u5668\u7684\u91cd\u8981\u6027\uff0c\u6240\u4ee5\u5728\u4e0a\u9762\u7684\u64cd\u4f5c\u5fc5\u987b\u614e\u91cd\u3002\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u4e00\u822c\u7531\u4e13\u4e1a\u7684\u7a0b\u5e8f\u4eba\u5458\u6765\u5b8c \u6210(\u4e0d\u4e00\u5b9a\u662fDBA(\u6570\u636e\u5e93\u7ba1\u7406\u5458)\u6765\u5e72,\u4e2d\u5c0f\u516c\u53f8\u53ef\u80fd\u6ca1\u6709DBA)\u3002</li> </ul> <p>3.3 PL/sql Develpoer:</p> <ul> <li>\u4f18\u70b9\uff1a\u5c01\u88c5\u4e86\u5bfc\u5165\u5bfc\u51fa\u547d\u4ee4\uff0c\u65e0\u9700\u6bcf\u6b21\u90fd\u624b\u52a8\u8f93\u5165\u547d\u4ee4\u3002\u65b9\u4fbf\u5feb\u6377\uff0c\u63d0\u9ad8\u6548\u7387\u3002</li> <li>\u7f3a\u70b9\uff1a\u957f\u65f6\u95f4\u5e94\u7528\u4f1a\u5bf9\u5176\u4ea7\u751f\u4f9d\u8d56\uff0c\u964d\u4f4e\u5bf9\u4ee3\u7801\u6267\u884c\u539f\u7406\u7684\u7406\u89e3\u3002</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#4","title":"4.\u5bfc\u5165\u5bfc\u51fa\u65b9\u6cd5\u4e0e\u5b9e\u4f8b","text":"<ul> <li>*</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#41-expimp","title":"4.1 \u4f20\u7edf\u65b9\u5f0f(exp/imp)","text":"<p>4.1.1 \u901a\u7528\u547d\u4ee4</p> <ul> <li>exp(imp) username/password@servicename:1521 file=\u201dd:\\temp.dmp\u201d full = y;</li> </ul> <p>4.1.2 \u53c2\u6570\u89e3\u91ca</p> <ul> <li>exp:\u5bfc\u51fa\u547d\u4ee4\uff0c\u5bfc\u51fa\u65f6\u5fc5\u5199\u3002</li> <li>imp:\u5bfc\u5165\u547d\u4ee4\uff0c\u5bfc\u5165\u65f6\u5fc5\u5199,\u6bcf\u6b21\u64cd\u4f5c\uff0c\u4e8c\u8005\u53ea\u80fd\u9009\u62e9\u4e00\u4e2a\u6267\u884c\u3002</li> <li>username:\u5bfc\u51fa\u6570\u636e\u7684\u7528\u6237\u540d\uff0c\u5fc5\u5199;</li> <li>password:\u5bfc\u51fa\u6570\u636e\u7684\u5bc6\u7801\uff0c\u5fc5\u5199;</li> <li>@:\u5730\u5740\u7b26\u53f7\uff0c\u5fc5\u5199;</li> <li>servicename:Oracle\u7684\u670d\u52a1\u540d\uff0c\u5fc5\u5199;</li> <li>1521:\u7aef\u53e3\u53f7\uff0c1521\u662f\u9ed8\u8ba4\u7684\u53ef\u4ee5\u4e0d\u5199,\u975e\u9ed8\u8ba4\u8981\u5199;</li> <li>file=\u201de:\\temp.dmp\u201d : \u6587\u4ef6\u5b58\u653e\u8def\u5f84\u5730\u5740\uff0c\u5fc5\u5199;</li> <li>full=y :\u8868\u793a\u5168\u5e93\u5bfc\u51fa\u3002\u53ef\u4ee5\u4e0d\u5199\uff0c\u5219\u9ed8\u8ba4\u4e3ano,\u5219\u53ea\u5bfc\u51fa\u7528\u6237\u4e0b\u7684\u5bf9\u8c61</li> </ul> <p>4.1.3 \u5bfc\u51fa\u5bfc\u5165\u5b9e\u4f8b</p> <ul> <li>\u6309\u5168\u5e93\u5bfc exp(imp) system/wisense@orcl file=\u201de:\\temp.dmp\u201d full = y;</li> <li>\u6309\u7528\u6237\u5bfc exp(imp) system/wisense@orcl file=\u201de:\\temp.dmp\u201d owner(username1,username2,username3,\u2026);</li> <li>\u6309\u8868\u540d\u5bfc exp(imp) system/wisense@orcl file=\u201de:\\temp.dmp\u201d tabels= (table1,table2,table3,\u2026);</li> <li>\u6309\u8868\u7a7a\u95f4\u5bfc exp(imp) system/wisense@orcl file=\u201de:\\temp.dmp\u201d tablespaces= (tablespace1,tablespace2,tablespace3,\u2026);</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-11g-imp-and-exp/#42-expdpimpdp","title":"4.2 \u6570\u636e\u6cf5\u65b9\u5f0f\uff08expdp/impdp\uff09","text":"<p>4.2.1 \u901a\u7528\u547d\u4ee4 expdp(impdp) username/password@servicename:1521 schemas=username directory=dumpdir dumpfile=temp.dmp [remap_schema=origin_username:target_username] [remap_tablespace=origin_tablespace:target_tablespace] [logfile=file1.log];</p> <p>4.2.2 \u53c2\u6570\u89e3\u91ca</p> <ul> <li>exp:\u5bfc\u51fa\u547d\u4ee4\uff0c\u5bfc\u51fa\u65f6\u5fc5\u5199;</li> <li>imp:\u5bfc\u5165\u547d\u4ee4\uff0c\u5bfc\u5165\u65f6\u5fc5\u5199,\u6bcf\u6b21\u64cd\u4f5c\uff0c\u4e8c\u8005\u53ea\u80fd\u9009\u62e9\u4e00\u4e2a\u6267\u884c;</li> <li>username:\u5bfc\u51fa\u6570\u636e\u7684\u7528\u6237\u540d\uff0c\u5fc5\u5199;</li> <li>password:\u5bfc\u51fa\u6570\u636e\u7684\u5bc6\u7801\uff0c\u5fc5\u5199;</li> <li>@:\u5730\u5740\u7b26\u53f7\uff0c\u5fc5\u5199;</li> <li>servicename:Oracle\u7684\u670d\u52a1\u540d\uff0c\u5fc5\u5199;</li> <li>1521:\u7aef\u53e3\u53f7\uff0c1521\u662f\u9ed8\u8ba4\u7684\u53ef\u4ee5\u4e0d\u5199,\u975e\u9ed8\u8ba4\u8981\u5199;</li> <li>schemas\uff1a\u5bfc\u51fa\u64cd\u4f5c\u7684\u7528\u6237\u540d;</li> <li>remap_schema=\u6e90\u6570\u636e\u5e93\u7528\u6237\u540d:\u76ee\u6807\u6570\u636e\u5e93\u7528\u6237\u540d,\u4e8c\u8005\u4e0d\u540c\u65f6\u5fc5\u5199\uff0c\u76f8\u540c\u53ef\u4ee5\u7701\u7565;</li> <li>remap_tablespace=\u6e90\u6570\u636e\u5e93\u8868\u7a7a\u95f4:\u76ee\u6807\u6570\u636e\u5e93\u8868\u7a7a\u95f4,\u4e8c\u8005\u4e0d\u540c\u65f6\u5fc5\u5199\uff0c\u76f8\u540c\u53ef\u4ee5\u7701\u7565;</li> <li>directory:\u521b\u5efa\u7684\u6587\u4ef6\u5939\u540d\u79f0;</li> <li>dumpfile\uff1a\u5bfc\u51fa\u7684\u6587\u4ef6;</li> <li>logfile:\u5bfc\u51fa\u7684\u65e5\u5fd7\u6587\u4ef6,\u53ef\u4ee5\u4e0d\u5199\uff1b</li> </ul> <p>4.2.3 \u5bfc\u51fa\u5bfc\u5165\u5b9e\u4f8b</p> <ul> <li>\u6309\u5168\u5e93\u5bfc expdp(impdp) system/wisense@orcl directory=data_pump_dir dumpfile=temp.dmp FULL=y;</li> <li>\u6309\u7528\u6237\u5bfc expdp(impdp) system/wisense@orcl schemas=username directory=data_pump_dir dumpfile=temp.dmp;</li> <li>\u6309\u8868\u540d\u5bfc expdp(impdp) system/wisense@orcl tables=emp,dept directory=data_pump_dir dumpfile=temp.dmp;</li> <li>\u6309\u8868\u7a7a\u95f4\u5bfc expdp(impdp) system/wisense@orcl tablespaces=temp,example directory=data_pump_dir dumpfile=temp.dmp;</li> <li>\u6309\u67e5\u8be2\u6761\u4ef6\u5bfc expdp(impdp) system/wisense@orcl tables=emp query=\u2019sqlwhere\u2019 directory=data_pump_dir dumpfile=temp.dmp;</li> <li>\u6539\u53d8\u7528\u6237\u548c\u8868\u7a7a\u95f4\u5bfc\u5165 impdp system/wisense@orcl schemas=username directory=data_pump_dir dumpfile=temp.dmp remap_schema=origin_username:target_username remap_tablespace=origin_tablespace:target_tablespace</li> <li>\u8ffd\u52a0\u6570\u636e impdp system/wisense@orcl schemas=system table_exists_action directory=data_pump_dir dumpfile=temp.dmp ;</li> </ul> <p>4.2.4 \u5176\u4ed6\u547d\u4ee4</p> <ul> <li>\u8fde\u63a5\u767b\u5f55 sqlplus /nolog conn system/wisense</li> <li>\u67e5\u770b\u8868\u7a7a\u95f4 select * form dba_tablespaces;</li> <li>\u521b\u5efa\u8868\u7a7a\u95f4 create tablespace \u2018wisense\u2019 datafile \u2018d:\\app\\Administrator\\oradata\\orcl\\wisense.dbf\u2019 size 100M autoextend on next 1M maxsize 20480M\uff08unlimited\uff09 extent management local;</li> <li>\u521b\u5efa\u903b\u8f91\u76ee\u5f55 create directory dumpdir as \u2018d:\\oracle_dump_dir';</li> <li>\u521b\u5efa\u7528\u6237 create user username identified by username default tablespace ts_username;</li> <li>\u7ed9\u7528\u6237\u8d4b\u4e88\u5728\u6307\u5b9a\u76ee\u5f55\u7684\u64cd\u4f5c\u6743\u9650 grant read,write on directory dumpdir to username;</li> </ul>","tags":["oracle","exp","imp","expdp","impdp"]},{"location":"database/oracle-silent-installation/","title":"Oracle \u9759\u9ed8\u5b89\u88c5","text":"<p>Oracle \u6570\u636e\u5e93\u9ed8\u8ba4\u91c7\u53d6\u56fe\u5f62\u754c\u9762\u5b89\u88c5\uff0c\u4f46\u662f\u5bf9\u4e8e\u6ca1\u6709\u56fe\u5f62\u754c\u9762\u6216\u8005\u5f88\u96be\u542f\u7528\u56fe\u5f62\u754c\u9762\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u91c7\u53d6\u6307\u5b9a\u5e94\u7b54\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u3002</p> <p>\u5e94\u7b54\u6587\u4ef6\u6709\u4e24\u79cd\u83b7\u53d6\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f\u5728\u67d0\u4e00\u53f0\u5b89\u88c5\u8fc7\u7684\u673a\u5668\u4e0a\uff0c\u5f53\u65f6\u4fdd\u5b58\u8fc7\u5e94\u7b54\u6587\u4ef6\uff0c\u7136\u540e\u62ff\u8fc7\u6765\u4fee\u6539\u5c31\u53ef\u4ee5\u4e86\u3002 \u53e6\u5916\u4e00\u79cd\u5c31\u662f\u7528\u5b89\u88c5\u4ecb\u8d28\u4e2d\u63d0\u4f9b\u7684\u5e94\u7b54\u6587\u4ef6\u6a21\u677f\u8fdb\u884c\u4fee\u6539\u3002\u6a21\u677f\u5728\u5b89\u88c5\u4ecb\u8d28\u7684_respone_\u76ee\u5f55\u4e0b\u3002 \u8be5\u76ee\u5f55\u4e0b\u6709\u4e09\u4e2a\u6587\u4ef6\uff0c\u4ece\u540d\u5b57\u53ef\u4ee5\u770b\u51fa\u5bf9\u5e94\u7684\u529f\u80fd\uff0c\u8fd9\u91cc\u6211\u4eec\u9488\u5bf9 <code>db_install.rsp</code> \u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v11_2_0\n\n#------------------------------------------------------------------------------\n# Specify the installation option.\n# It can be one of the following:\n#   - INSTALL_DB_SWONLY\n#   - INSTALL_DB_AND_CONFIG\n#   - UPGRADE_DB\n#-------------------------------------------------------------------------------\noracle.install.option=INSTALL_DB_AND_CONFIG\n# use my hostname\nORACLE_HOSTNAME=localhost\n\nUNIX_GROUP_NAME=oinstall\n\nINVENTORY_LOCATION=/opt/oracle/app/oraInventory\n\n#-------------------------------------------------------------------------------\n# Specify the languages in which the components will be installed.             \n# \n# en   : English                  ja   : Japanese                  \n# fr   : French                   ko   : Korean                    \n# ar   : Arabic                   es   : Latin American Spanish    \n# bn   : Bengali                  lv   : Latvian                   \n# pt_BR: Brazilian Portuguese     lt   : Lithuanian                \n# bg   : Bulgarian                ms   : Malay                     \n# fr_CA: Canadian French          es_MX: Mexican Spanish           \n# ca   : Catalan                  no   : Norwegian                 \n# hr   : Croatian                 pl   : Polish                    \n# cs   : Czech                    pt   : Portuguese                \n# da   : Danish                   ro   : Romanian                  \n# nl   : Dutch                    ru   : Russian                   \n# ar_EG: Egyptian                 zh_CN: Simplified Chinese        \n# en_GB: English (Great Britain)  sk   : Slovak                    \n# et   : Estonian                 sl   : Slovenian                 \n# fi   : Finnish                  es_ES: Spanish                   \n# de   : German                   sv   : Swedish                   \n# el   : Greek                    th   : Thai                      \n# iw   : Hebrew                   zh_TW: Traditional Chinese       \n# hu   : Hungarian                tr   : Turkish                   \n# is   : Icelandic                uk   : Ukrainian                 \n# in   : Indonesian               vi   : Vietnamese                \n# it   : Italian                                                   \n#\n# all_langs   : All languages\n#\n# Specify value as the following to select any of the languages.\n# Example : SELECTED_LANGUAGES=en,fr,ja\n#\n# Specify value as the following to select all the languages.\n# Example : SELECTED_LANGUAGES=all_langs  \nSELECTED_LANGUAGES=en,zh_CN\n\nORACLE_HOME=/opt/oracle/app/oracle/product/11.2.0/dbhome_1\n\nORACLE_BASE=/opt/oracle/app/oracle\n\n#------------------------------------------------------------------------------\n# Specify the installation edition of the component.                        \n#                                                             \n# The value should contain only one of these choices.        \n#   - EE     : Enterprise Edition                                \n#   - SE     : Standard Edition                                  \n#   - SEONE  : Standard Edition One\n#   - PE     : Personal Edition (WINDOWS ONLY)\n#------------------------------------------------------------------------------\noracle.install.db.InstallEdition=EE\n\noracle.install.db.EEOptionsSelection=false\n\noracle.install.db.optionalComponents=oracle.rdbms.partitioning:11.2.0.4.0,oracle.oraolap:11.2.0.4.0,oracle.rdbms.dm:11.2.0.4.0,oracle.rdbms.dv:11.2.0.4.0,oracle.rdbms.lbac:11.2.0.4.0,oracle.rdbms.rat:11.2.0.4.0\n\n\noracle.install.db.DBA_GROUP=oinstall\n\noracle.install.db.OPER_GROUP=oinstall\n\noracle.install.db.CLUSTER_NODES=\n\noracle.install.db.isRACOneInstall=false\n\noracle.install.db.racOneServiceName=\n\n#------------------------------------------------------------------------------\n# Specify the type of database to create.\n# It can be one of the following:\n#   - GENERAL_PURPOSE/TRANSACTION_PROCESSING             \n#   - DATA_WAREHOUSE                                \n#------------------------------------------------------------------------------\noracle.install.db.config.starterdb.type=GENERAL_PURPOSE\n\n# ORACLE SID\noracle.install.db.config.starterdb.globalDBName=ini\noracle.install.db.config.starterdb.SID=ini\n\n#------------------------------------------------------------------------------\n# Specify the Starter Database character set.\n#                                              \n# It can be one of the following:\n# AL32UTF8, WE8ISO8859P15, WE8MSWIN1252, EE8ISO8859P2,\n# EE8MSWIN1250, NE8ISO8859P10, NEE8ISO8859P4, BLT8MSWIN1257,\n# BLT8ISO8859P13, CL8ISO8859P5, CL8MSWIN1251, AR8ISO8859P6,\n# AR8MSWIN1256, EL8ISO8859P7, EL8MSWIN1253, IW8ISO8859P8,\n# IW8MSWIN1255, JA16EUC, JA16EUCTILDE, JA16SJIS, JA16SJISTILDE,\n# KO16MSWIN949, ZHS16GBK, TH8TISASCII, ZHT32EUC, ZHT16MSWIN950,\n# ZHT16HKSCS, WE8ISO8859P9, TR8MSWIN1254, VN8MSWIN1258\n#------------------------------------------------------------------------------\noracle.install.db.config.starterdb.characterSet=ZHS16GBK\n\noracle.install.db.config.starterdb.memoryOption=true\n\n# Memory, by MB\noracle.install.db.config.starterdb.memoryLimit=20480\n\noracle.install.db.config.starterdb.installExampleSchemas=false\n\noracle.install.db.config.starterdb.enableSecuritySettings=true\n\n\noracle.install.db.config.starterdb.password.ALL=Lczq2021\n\noracle.install.db.config.starterdb.password.SYS=\n\noracle.install.db.config.starterdb.password.SYSTEM=\n\noracle.install.db.config.starterdb.password.SYSMAN=\n\noracle.install.db.config.starterdb.password.DBSNMP=\n\noracle.install.db.config.starterdb.control=DB_CONTROL\n\noracle.install.db.config.starterdb.gridcontrol.gridControlServiceURL=\n\n\noracle.install.db.config.starterdb.automatedBackup.enable=false\n\noracle.install.db.config.starterdb.automatedBackup.osuid=\n\noracle.install.db.config.starterdb.automatedBackup.ospwd=\n\noracle.install.db.config.starterdb.storageType=FILE_SYSTEM_STORAGE\n\noracle.install.db.config.starterdb.fileSystemStorage.dataLocation=/opt/oracle/app/oracle/oradata\n\noracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=\n\noracle.install.db.config.asm.diskGroup=\n\noracle.install.db.config.asm.ASMSNMPPassword=\n\nMYORACLESUPPORT_USERNAME=\n\nMYORACLESUPPORT_PASSWORD=\n\nSECURITY_UPDATES_VIA_MYORACLESUPPORT=\n\nDECLINE_SECURITY_UPDATES=true\n\nPROXY_HOST=\n\nPROXY_PORT=\n\nPROXY_USER=\n\nPROXY_PWD=\n\nPROXY_REALM=\n\nCOLLECTOR_SUPPORTHUB_URL=\n\noracle.installer.autoupdates.option=SKIP_UPDATES\noracle.installer.autoupdates.downloadUpdatesLoc=\nAUTOUPDATES_MYORACLESUPPORT_USERNAME=\n\nAUTOUPDATES_MYORACLESUPPORT_PASSWORD=\n</code></pre> <p>\u4fdd\u5b58\u8be5\u6587\u4ef6\uff0c\u6bd4\u5982 /tmp/db-install.rsp </p> <p>\u63a5\u4e0b\u91cc\u9700\u8981\u505a\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u5b89\u88c5 Oracle JDK <code>rpm -ivh jdk1.8.0u91*.rpm</code></li> <li>\u521b\u5efa\u5bf9\u5e94\u7684\u8d26\u53f7\u548c\u7528\u6237\u7ec4: <code>groupadd oinstall &amp;&amp; useradd -g oinstall oracle</code></li> <li>\u5b89\u88c5\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305 <code>yum install gcc gcc-c++ gcc-c++-devel glibc-devel libgcc libgcc-devel libaio libaio-devel compat-libstdc++-33 libstdc++ libstdc++-devel elfutils-libelf-devel ksh libaio</code></li> <li>\u5f00\u59cb\u8fdb\u884c\u9759\u9ed8\u5b89\u88c5 <code>./runInstaller -silent -responseFile /tmp/db-install.rsp -jreLoc /usr/java/jdk1.8.0_91/jre -ignoreSysPrereqs -ignorePrereq</code></li> </ol> <p>\u5b89\u88c5\u5b8c\u6bd5\u540e\uff0c\u914d\u7f6e oracle \u8d26\u53f7\u7684\u987a\u5883\u53d8\u91cf\u3002\u4ee5\u53ca\u589e\u52a0 Oracle \u8d26\u53f7\u7684\u6253\u5f00\u6587\u4ef6\u6570\u7b49</p> <pre><code>cat -&gt;/etc/security/limits.d/oracle.conf\noracle   soft   nofile    8192\noracle   hard   nofile    65536\noracle   soft   nproc    16384\noracle   hard   nproc    16384\noracle   soft   stack    10240\noracle   hard   stack    32768\noracle   hard   memlock    134217728\noracle   soft   memlock    134217728\n^D\n</code></pre>","tags":["oracle","respone"]},{"location":"database/percona-cluster-with-haproxy/","title":"HAProxy + Percona XtraDB Cluster \u90e8\u7f72","text":"","tags":["percona","xtradb","mysql","cluster","haproxy"]},{"location":"database/percona-cluster-with-haproxy/#_1","title":"\u73af\u5883\u8bf4\u660e","text":"<p>\u5047\u5b9aPercona XtraDB Cluster(\u4ee5\u4e0b\u7b80\u79f0PXC)\u67094\u4e2a\u8282\u70b9\uff0c\u5206\u522b\u4e3a\uff1a  </p> <ul> <li>192.168.1.75</li> <li>192.168.1.77</li> <li>192.168.1.78</li> <li>192.168.1.81</li> </ul> <p>HAProxy \u90e8\u7f72\u5728<code>192.168.1.97</code>\u8282\u70b9\u4e0a\u3002</p>","tags":["percona","xtradb","mysql","cluster","haproxy"]},{"location":"database/percona-cluster-with-haproxy/#haproxycfg","title":"\u914d\u7f6ehaproxy.cfg","text":"<p>\u5728<code>192.168.1.97</code>\u4e0a\u5b89\u88c5HAProxy\u540e\uff0c\u9700\u8981\u914d\u7f6e<code>/etc/haproxy/haproxy.cfg</code>\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>global\nlog 127.0.0.1    local0\nlog 127.0.0.1    local1 notice\nmaxconn     4096\nuser        haproxy\ngroup        haproxy\ndaemon\n#debug\n\ndefaults\nlog            global\nmode        http\noption        tcplog\noption        dontlognull\noption        redispatch\nretries        3\nmaxconn        2000\ncontimeout    5000\nclitimeout    50000\nsrvtimeout    50000\n\nfrontend    pxc-front\nbind        *:33060       # \u5bf9\u5916\u5f00\u653e\u7684MySQL\u8fde\u63a5\u7aef\u53e3\nmode        tcp\ndefault_backend    pxc-back\n\nfrontend    stats-front\nbind        *:8080       # \u67e5\u770bHAProxy\u7684\u72b6\u6001\u7aef\u53e3\nmode        http\ndefault_backend    stats-back\n\nbackend        pxc-back\nmode        tcp\nbalance        roundrobin\noption         httpchk\n\nserver    db01    192.168.1.75:3306    check     port 9200 inter 5000  rise 2 fall 2\nserver    db02    192.168.1.77:3306    check     port 9200 inter 5000  rise 2 fall 2\nserver    db03    192.168.1.78:3306    check     port 9200 inter 5000  rise 2 fall 2\nserver    db04    192.168.1.81:3306    check     port 9200 inter 5000  rise 2 fall 2 backup\n\nbackend        stats-back\nmode        http\nbalance        roundrobin\nstats        uri /haproxy/stats\nstats        auth pxcstats:secret    # \u67e5\u770b\u72b6\u6001\u7684\u8ba4\u8bc1\u8d26\u6237\u53f7\u548c\u5bc6\u7801\n</code></pre>","tags":["percona","xtradb","mysql","cluster","haproxy"]},{"location":"database/percona-cluster-with-haproxy/#_2","title":"\u914d\u7f6e\u6570\u636e\u5e93\u68c0\u6d4b\u811a\u672c","text":"<p>\u9700\u8981\u5728\u6bcf\u4e2aPXC\u8282\u70b9\u4e0a\u914d\u7f6e\u6570\u636e\u5e93\u68c0\u6d4b\u811a\u672c\uff0c\u8be5\u811a\u672c\u7684\u72b6\u6001\u4ee5HTTP\u7684\u65b9\u5f0f\u53d1\u5e03\u51fa\u53bb\u3002 \u5728\u4e0a\u8ff0\u56db\u4e2aPXC\u8282\u70b9\u4e0a\uff0c\u9700\u8981\u5b89\u88c5\u4e0b\u9762\u7684\u4e24\u4e2a\u811a\u672c\uff1a</p> <ul> <li>mysqlchk</li> <li>clustercheck</li> </ul> <p><code>mysqlchk</code>\u662f\u4e00\u4e2a<code>xinetd</code>\u5b88\u62a4\u8fdb\u7a0b\u914d\u7f6e\u6587\u4ef6\uff0c\u9ed8\u8ba4\u4f4d\u7f6e\u4e3a<code>/etc/xinetd.d</code>\u76ee\u5f55\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code> # default: on\ndescription: mysqlchk\nservice mysqlchk\n{\n    this is a config for xinetd, place it in /etc/xinetd.d/\n    disable = no\n    flags           = REUSE\n    socket_type     = stream\n    port            = 9200\n    wait            = no\n    user            = nobody\n    server_args     = clustercheck clustercheckpassword 1 /var/log/clustercheck.log 0 /etc/my.cnf\n    server          = /usr/local/sbin/clustercheck\n    log_on_failure  += USERID\n    only_from       = 192.168.1.0/24\n    #\n    # Passing arguments to clustercheck\n    # &lt;user&gt; &lt;pass&gt; &lt;available_when_donor=0|1&gt; &lt;log_file&gt; &lt;available_when_readonly=0|1&gt; &lt;defaults_extra_file&gt;\"\n    # Recommended: server_args   = user pass 1 /var/log/log-file 0 /etc/my.cnf.local\"\n    # Compatibility: server_args = user pass 1 /var/log/log-file 1 /etc/my.cnf.local\"\n    # 55-to-56 upgrade: server_args = user pass 1 /var/log/log-file 0 /etc/my.cnf.extra\"\n    #\n    # recommended to put the IPs that need\n    # to connect exclusively (security purposes)\n    per_source      = UNLIMITED\n}\n</code></pre> <p>\u521b\u5efa<code>/var/log/clustercheck.log</code>\u6587\u4ef6\uff0c\u5e76\u8bbe\u7f6e\u5c5e\u4e3b\u4e3a\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684<code>nobody</code>\u3002</p> <p>\u5728<code>/etc/services</code>\u6587\u4ef6\u589e\u52a0\u5bf9<code>9200</code>\u7aef\u53e3\u7684\u670d\u52a1\u63cf\u8ff0\uff0c\u7c7b\u4f3c\u4e0b\u9762\u4e00\u884c: mysqlcheck  9200/tcp     #MySQL Status Check</p> <p>\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u4e2d\u63d0\u5230\u7684<code>/usr/local/sbin/clustercheck</code>\u6587\u4ef6\uff0c\u6765\u6e90\u4e8e\ufffc\ufffc</p> <p>\u5728\u4efb\u610f\u4e00\u4e2aPXC\u8282\u70b9\u4e0a\uff08\u6bd4\u5982\u662f<code>192.168.1.75</code>\uff09\u521b\u5efa\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u63d0\u4f9b\u7684\u6570\u636e\u5e93\u72b6\u6001\u68c0\u6d4b\u8d26\u53f7</p> <pre><code>mysql&gt; grant process on *.* to 'clustercheck'@'localhost' identified by 'clustercheckpassword!';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; flush privileges;\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre> <p>\u5728PXC\u56db\u4e2a\u8282\u70b9\u4e0a\uff0c\u542f\u52a8<code>xinetd</code>\u670d\u52a1\uff1a  </p> <p><code>service xinetd start</code></p> <p>\u67e5\u770b9200\u7aef\u53e3\u662f\u5426\u5df2\u7ecf\u6253\u5f00\u3002</p>","tags":["percona","xtradb","mysql","cluster","haproxy"]},{"location":"database/percona-cluster-with-haproxy/#haproxy","title":"\u542f\u52a8HAProxy","text":"<p>\u4e0a\u8ff0\u8fc7\u7a0b\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u542f\u52a8<code>HAProxy</code>\u4e86\uff1a  <code>service haproxy start</code></p> <p>\u5982\u679c\u6ca1\u6709\u62a5\u9519\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95ee <code>http://192.168.1.97:8080/haproxy/stats</code>\uff0c\u8f93\u5165\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u8d26\u53f7\u5bc6\u7801\uff0c\u5c31\u53ef\u4ee5\u770b\u5230HAProxy\u7684\u72b6\u6001\u4e86\u3002</p>","tags":["percona","xtradb","mysql","cluster","haproxy"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/","title":"\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72 ClickHouse \u96c6\u7fa4","text":"<p>\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u901a\u8fc7\u4e0d\u540c\u7aef\u53e3\u90e8\u7f72 3 \u8282\u70b9\u7684 ClickHouse \u96c6\u7fa4\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e3a\u6bcf\u4e2a\u5b9e\u4f8b\u5206\u914d\u4e0d\u540c\u7684\u7aef\u53e3\u548c\u6570\u636e\u76ee\u5f55\u6765\u5b9e\u73b0\u3002\u4ee5\u4e0b\u662f\u8be6\u7ec6\u6b65\u9aa4\uff1a</p>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_1","title":"\u73af\u5883\u51c6\u5907","text":"<p>\u786e\u4fdd\u4f60\u7684\u670d\u52a1\u5668\u6709\u8db3\u591f\u7684\u8d44\u6e90\uff08CPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\uff09\u6765\u8fd0\u884c\u591a\u4e2a ClickHouse \u5b9e\u4f8b\u3002\u4e0b\u8f7d ClickHouse \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u8fdb\u884c\u5b89\u88c5\u3002</p> <pre><code>LATEST_VERSION=$(curl -s https://raw.githubusercontent.com/ClickHouse/ClickHouse/master/utils/list-versions/version_date.tsv | \\\n    grep -Eo '[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+' | sort -V -r | head -n 1)\nexport LATEST_VERSION\n\ncase $(uname -m) in\n  x86_64) ARCH=amd64 ;;\n  aarch64) ARCH=arm64 ;;\n  *) echo \"Unknown architecture $(uname -m)\"; exit 1 ;;\nesac\n\ncurl -fO \"https://packages.clickhouse.com/tgz/stable/$PKG-$LATEST_VERSION-${ARCH}.tgz\" \\\n  || curl -fO \"https://packages.clickhouse.com/tgz/stable/$PKG-$LATEST_VERSION.tgz\"\ntar -xzvf \"clickhouse-common-static-$LATEST_VERSION.tgz\"\nclickhouse-server-$LATEST_VERSION/install/doinst.sh\n(cd /usr/bin &amp;&amp; ln -s clickhouse clickhouse-server &amp;&amp; ln -sf clickhouse clickhouse-client)\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#clickhouse_1","title":"\u521b\u5efa\u591a\u4e2a ClickHouse \u5b9e\u4f8b","text":"<p>\u6211\u4eec\u5c06\u4e3a\u6bcf\u4e2a\u5b9e\u4f8b\u521b\u5efa\u72ec\u7acb\u7684\u914d\u7f6e\u76ee\u5f55\u548c\u6570\u636e\u76ee\u5f55\u3002</p>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_2","title":"\u521b\u5efa\u76ee\u5f55\u7ed3\u6784","text":"<p>\u5047\u8bbe\u57fa\u7840\u76ee\u5f55\u4e3a <code>/clickhouse</code>\uff0c\u521b\u5efa\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\uff1a</p> <pre><code>mkdir -p /clickhouse/{instance1,instance2,instance3}/{config,data,logs}\n</code></pre> <ul> <li><code>instance1</code>\u3001<code>instance2</code>\u3001<code>instance3</code> \u5206\u522b\u5bf9\u5e94 3 \u4e2a ClickHouse \u5b9e\u4f8b\u3002</li> <li>\u6bcf\u4e2a\u5b9e\u4f8b\u7684 <code>config</code> \u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u914d\u7f6e\u6587\u4ef6\uff0c<code>data</code> \u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u6570\u636e\uff0c<code>logs</code> \u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u65e5\u5fd7\u3002</li> </ul>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_3","title":"\u914d\u7f6e\u6bcf\u4e2a\u5b9e\u4f8b","text":"","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#1","title":"\u5b9e\u4f8b 1 \u914d\u7f6e","text":"<p>\u62f7\u8d1d <code>clickhouse-server-$LATEST_VERSION</code>\u4e0b\u7684 <code>config/config.xml</code> \u6587\u4ef6\u548c <code>config/users.xml</code> \u5230 <code>/clickhouse/instance1/config/</code>\u3002</p> <p>\u521b\u5efa <code>/clickhouse/instance1/config/config.d</code> \u76ee\u5f55,\u5728\u8be5\u76ee\u5f55\u4e0b\u5206\u522b\u521b\u5efa\u4ee5\u4e0b\u6587\u4ef6:</p> <p>config.xml</p> <pre><code>&lt;clickhouse replace=\"true\"&gt;\n    &lt;path&gt;/clickhouse/instance1/data/&lt;/path&gt;\n    &lt;tmp_path&gt;/clickhouse/instance1/tmp/&lt;/tmp_path&gt;\n    &lt;user_files_path&gt;/clickhouse/instance1/user_files/&lt;/user_files_path&gt;\n    &lt;format_schema_path&gt;/clickhouse/instance1/format_schemas/&lt;/format_schema_path&gt;\n    &lt;logger&gt;\n        &lt;log&gt;/clickhouse/instance1/logs/clickhouse-server.log&lt;/log&gt;\n        &lt;errorlog&gt;/clickhouse/instance1/logs/clickhouse-server.err.log&lt;/errorlog&gt;\n    &lt;/logger&gt;\n    &lt;storage_configuration&gt;\n        &lt;disks&gt;\n            &lt;default&gt;\n                &lt;keep_free_space_bytes&gt;0&lt;/keep_free_space_bytes&gt;\n            &lt;/default&gt;\n            &lt;data&gt;\n                &lt;path&gt;/clickhouse/instance1/disk_data/&lt;/path&gt;\n                &lt;keep_free_space_bytes&gt;0&lt;/keep_free_space_bytes&gt;\n            &lt;/data&gt;\n        &lt;/disks&gt;\n    &lt;/storage_configuration&gt;\n&lt;/clickhouse&gt;\n</code></pre> <p>port.xml</p> <pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;yandex&gt;\n    &lt;interserver_http_host&gt;localhost&lt;/interserver_http_host&gt;\n    &lt;http_port&gt;8123&lt;/http_port&gt;\n    &lt;tcp_port&gt;9001&lt;/tcp_port&gt;\n    &lt;mysql_port&gt;9004&lt;/mysql_port&gt;\n    &lt;postgresql_port&gt;9005&lt;/postgresql_port&gt;\n&lt;/yandex&gt;\n</code></pre> <p>macros.xml</p> <pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;yandex&gt;\n    &lt;macros&gt;\n        &lt;shard&gt;1&lt;/shard&gt;\n        &lt;replica&gt;1&lt;/replica&gt;\n    &lt;/macros&gt;\n&lt;/yandex&gt;\n</code></pre> <p>remote_servers.xml</p> <pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;yandex&gt;\n    &lt;remote_servers&gt;\n        &lt;testcluster&gt;\n            &lt;shard&gt;\n                &lt;weight&gt;1&lt;/weight&gt;\n                &lt;internal_replication&gt;true&lt;/internal_replication&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;127.0.0.1&lt;/host&gt;\n                    &lt;port&gt;9001&lt;/port&gt;\n                &lt;/replica&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;127.0.0.1&lt;/host&gt;\n                    &lt;port&gt;9002&lt;/port&gt;\n                &lt;/replica&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;127.0.0.1&lt;/host&gt;\n                    &lt;port&gt;9003&lt;/port&gt;\n                &lt;/replica&gt;\n            &lt;/shard&gt;\n        &lt;/testcluster&gt;\n    &lt;/remote_servers&gt;\n&lt;/yandex&gt;\n</code></pre> <p>zookeeper</p> <pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;yandex&gt;\n    &lt;zookeeper&gt;\n        &lt;node index=\"1\"&gt;\n            &lt;host&gt;node1&lt;/host&gt;\n            &lt;port&gt;2181&lt;/port&gt;\n        &lt;/node&gt;\n        &lt;node index=\"2\"&gt;\n            &lt;host&gt;node2&lt;/host&gt;\n            &lt;port&gt;2181&lt;/port&gt;\n        &lt;/node&gt;\n        &lt;node index=\"3\"&gt;\n            &lt;host&gt;node3&lt;/host&gt;\n            &lt;port&gt;2181&lt;/port&gt;\n        &lt;/node&gt;\n    &lt;/zookeeper&gt;\n&lt;/yandex&gt;\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#2","title":"\u5b9e\u4f8b 2 \u914d\u7f6e","text":"<pre><code>cp -a /clickhouse/instance1/config/* /clickhouse/instance2/config\nsed -i 's/instance1/instance2/g' /clickhouse/instance2/config/config.xml\nsed -i 's#&lt;replica&gt;1&lt;/replica&gt;#&lt;replica&gt;2&lt;/replica&gt;#' /clickhouse/instance2/config/macros.xml\nsed -i 's/8123/8124/;s/9001/9002/;s/9004/19004/;s/9005/19005/' /clickhouse/instance2/config/port.xml\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#2_1","title":"\u5b9e\u4f8b 2 \u914d\u7f6e","text":"<pre><code>cp -a /clickhouse/instance1/config/* /clickhouse/instance3/config\nsed -i 's/instance1/instance3/g' /clickhouse/instance3/config/config.xml\nsed -i 's#&lt;replica&gt;1&lt;/replica&gt;#&lt;replica&gt;3&lt;/replica&gt;#' /clickhouse/instance2/config/macros.xml\nsed -i 's/8123/8125/;s/9001/9003/;s/9004/29004/;s/9005/29005/' /clickhouse/instance2/config/port.xml\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#clickhouse_2","title":"\u542f\u52a8 ClickHouse \u5b9e\u4f8b","text":"<pre><code>/usr/bin/clickhouse-server --daemon --config-file=/clickhouse/instance1/config/config.xml\n/usr/bin/clickhouse-server --daemon --config-file=/clickhouse/instance2/config/config.xml\n/usr/bin/clickhouse-server --daemon --config-file=/clickhouse/instance3/config/config.xml\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_4","title":"\u521b\u5efa\u590d\u5236\u8868\u4ee5\u53ca\u5206\u5e03\u5f0f\u8868\u8fdb\u884c\u9a8c\u8bc1","text":"","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_5","title":"\u521b\u5efa\u590d\u5236\u8868","text":"<pre><code>CREATE DATABASE IF NOT EXISTS dev ON CLUSTER testcluster;\nCREATE TABLE dev.test_replicated on cluster testcluster\n(\n    id UInt32,\n    value String,\n    timestamp DateTime\n)\nENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/{shard}/test_replicated', '{replica}', timestamp)\nORDER BY id;\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_6","title":"\u521b\u5efa\u5206\u5e03\u5f0f\u8868","text":"<pre><code>CREATE TABLE dev.test_ds_table\n(\n    id UInt32,\n    value String,\n    timestamp DateTime\n)\nENGINE = Distributed('testcluster', 'dev', 'test_replicated');\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_7","title":"\u63d2\u5165\u6570\u636e","text":"<pre><code>insert into dev.test_replicated values (1, 'test', now());\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_8","title":"\u9a8c\u8bc1","text":"<pre><code>```sql\nSELECT *\nFROM dev.test_replicated\n\nQuery id: 68f9117c-105b-49a2-831e-864ec5954f70\n\n\u250c\u2500id\u2500\u252c\u2500value\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500timestamp\u2500\u2510\n\u2502  1 \u2502 test  \u2502 2025-02-01 20:03:19 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n1 row in set. Elapsed: 0.003 sec.\n\n\nselect * from dev.test_ds_table;\n\nSELECT *\nFROM dev.test_ds_table\n\nQuery id: 7733ea97-d70c-4122-9416-2fb34f7c1f7a\n\n\u250c\u2500id\u2500\u252c\u2500value\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500timestamp\u2500\u2510\n\u2502  1 \u2502 test  \u2502 2025-02-01 20:03:19 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n1 row in set. Elapsed: 0.004 sec.\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/setup-a-clickhouse-cluster-on-one-node/#_9","title":"\u96c6\u7fa4\u4fe1\u606f","text":"<pre><code>SELECT *\nFROM system.clusters\nWHERE cluster = 'testcluster'\n\nQuery id: 5cd714df-3a5f-4eeb-975e-572c00d43c29\n\n\nRow 1:\n\u2500\u2500\u2500\u2500\u2500\u2500\ncluster:                 testcluster\nshard_num:               1\nshard_weight:            1\nreplica_num:             1\nhost_name:               127.0.0.1\nhost_address:            127.0.0.1\nport:                    9001\nis_local:                1\nuser:                    default\ndefault_database:\nerrors_count:            0\nslowdowns_count:         0\nestimated_recovery_time: 0\ndatabase_shard_name:\ndatabase_replica_name:\nis_active:               \u1d3a\u1d41\u1d38\u1d38\n\nRow 2:\n\u2500\u2500\u2500\u2500\u2500\u2500\ncluster:                 testcluster\nshard_num:               1\nshard_weight:            1\nreplica_num:             2\nhost_name:               127.0.0.1\nhost_address:            127.0.0.1\nport:                    9002\nis_local:                0\nuser:                    default\ndefault_database:\nerrors_count:            0\nslowdowns_count:         0\nestimated_recovery_time: 0\ndatabase_shard_name:\ndatabase_replica_name:\nis_active:               \u1d3a\u1d41\u1d38\u1d38\n\nRow 3:\n\u2500\u2500\u2500\u2500\u2500\u2500\ncluster:                 testcluster\nshard_num:               1\nshard_weight:            1\nreplica_num:             3\nhost_name:               127.0.0.1\nhost_address:            127.0.0.1\nport:                    9003\nis_local:                0\nuser:                    default\ndefault_database:\nerrors_count:            0\nslowdowns_count:         0\nestimated_recovery_time: 0\ndatabase_shard_name:\ndatabase_replica_name:\nis_active:               \u1d3a\u1d41\u1d38\u1d38\n\n3 rows in set. Elapsed: 0.003 sec.\n</code></pre>","tags":["clickhouse","cluster"]},{"location":"database/why-mysql8-slower-than-mysql57/","title":"\u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u4e3a\u4ec0\u4e48 MySQL 8.0 \u6bd4 MySQL 5.7 \u6162","text":"<p>\u8fd9\u4e24\u5929\u5728\u6574\u7406 MySQL \u7684\u8d44\u6599\uff0c\u7136\u540e\u5206\u522b\u5728 MySQL 5.7 \u548c MySQL 8.0 \u4e0a\u505a\u6d4b\u8bd5\uff0c\u770b\u770b\u8fd9\u4e9b\u8d44\u6599\u5185\u5bb9\u5728\u4e24\u4e2a\u7248\u672c\u4e0a\u662f\u5426\u6709\u5dee\u5f02\u3002</p> <p>\u7ed3\u679c\u5728\u6d89\u53ca\u5230\u4e00\u4e2a\u63d2\u5165\u6570\u636e\u7684\u573a\u666f\u4e2d\uff0c\u53d1\u73b0\u4e24\u4e2a\u7248\u672c\u7684\u6027\u80fd\u76f8\u5dee\u5f88\u5927\uff0c\u90fd\u662f\u5728\u4e00\u4e2a\u7b80\u5355\u8868\u4e0a\u901a\u8fc7\u5b58\u50a8\u8fc7\u7a0b\u6765\u63d2\u5165100\u4e07\u6761\u8bb0\u5f55\u3002\u4e24\u8005\u7684\u6027\u80fd\u76f8\u5dee3\u500d\u591a\u3002</p> <p>\u4e8e\u662f\u5c31\u60f3\u770b\u770b\u662f\u4ec0\u4e48\u539f\u56e0\u5bfc\u81f4\u4e24\u8005\u8fd9\u4e48\u5927\u7684\u5dee\u5f02\uff0c\u4ee5\u53ca\u5e94\u8be5\u505a\u54ea\u4e9b\u8c03\u6574\u624d\u80fd\u6709\u6027\u80fd\u63d0\u5347\u3002</p> <p>\u9996\u5148\u8bf4\u660e\uff0c\u4e24\u4e2a\u6570\u636e\u5e93\u5b89\u88c5\u5728\u76f8\u540c\u578b\u53f7\uff0c\u76f8\u540c\u914d\u7f6e\u7684\u4e24\u53f0\u673a\u5668\u4e0a\uff0c\u90fd\u91c7\u53d6\u9ed8\u8ba4\u914d\u7f6e\uff0c\u6240\u914d\u7f6e\u7684\u5185\u5b58\u4e5f\u4e00\u81f4\u3002</p>","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_1","title":"\u7f18\u8d77","text":"<p>\u6211\u5c31\u662f\u5728\u4e0b\u9762\u8fd9\u5f20\u8868\u4ee5\u53ca\u5b58\u50a8\u8fc7\u7a0b\u4e2d\u53d1\u73b0\u4e86\u4e24\u8005\u7684\u6027\u80fd\u5dee\u5f02</p> <pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `b` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `b` (`b`)\n) ENGINE=InnoDB;\n\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=100000)do\n    insert into t values(i, i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\n</code></pre> <p>\u4e0b\u9762\u662f\u6267\u884c\u7684\u7ed3\u679c(\u542b\u6709 <code>mysql-5.7</code> \u63d0\u793a\u7b26\u7684\u8868\u793a\u662f 5.7 \u7248\u672c)</p> <pre><code>mysql-5.7&gt;call idata();\nQuery OK, 1 row affected (6.07 sec)\n\nmysql-8.0&gt;call idata();\nQuery OK, 1 row affected (20.06 sec)\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e2a\u6027\u80fd\u76f8\u5dee\u8fd8\u662f\u5f88\u5927\u7684\u3002\u6211\u60f3\u5e94\u8be5\u662f MySQL 8.0 \u67d0\u4e9b\u9ed8\u8ba4\u53c2\u6570\u53ef\u80fd\u8bbe\u7f6e\u5f97\u4e0d\u592a\u597d\uff0c\u6240\u4ee5\u5bfc\u81f4\u6bd4\u8f83\u6162\u3002 \u4e8e\u662f\u6211\u628a\u628a\u4e24\u8005\u7684\u9ed8\u8ba4\u914d\u7f6e\u4e2d\uff0c\u6211\u89c9\u5f97\u7684\u548c\u672c\u6b21\u6027\u80fd\u76f8\u5173\u7684\u5dee\u5f02\u5217\u51fa\u6765\u4e86\uff0c\u5f53\u7136\u6211\u8fd9\u91cc\u662f\u5217\u51fa\u4e24\u8005\u90fd\u6709\u7684\u53c2\u6570\uff0c \u81f3\u4e8e\u90a3\u4e9b\u53ea\u5b58\u5728 MySQL 8.0 \u7684\u53c2\u6570\u5c31\u6ca1\u6709\u5217\u51fa\u4e86</p> \u914d\u7f6e\u53c2\u6570 mysql 5.7 \u503c mysql 8.0  \u503c back_log 80 151 event_scheduler OFF ON innodb_autoinc_lock_mode 1 2 innodb_flush_method - fsync innodb_undo_log_truncate OFF ON innodb_undo_tablespaces 0 2 innodb_flush_neighbors 1 0 innodb_max_dirty_pages_pct 75 90 innodb_max_dirty_pages_pct_lwm 0 10 local_infile ON OFF log_error_verbosity 3 2 master_info_repository FILE TABLE max_allowd_packet 4194304 67108864 max_error_count 64 1024 max_length_for_sort_data 1024 4096 open_files_limit 5000 10000 optimizer_trace_max_mem_size 16384 1048576 performance_schema_max_cond_classes 80 150 performance_schema_max_memory_classes 320 450 performance_schema_max_mutex_classes 210 350 performance_schema_max_rwlock_classes 50 60 performance_schema_max_stage_classes 150 175 performance_schema_max_statement_classes 193 219 performance_schema_max_thread_classes 50 100 pseudo_thread_id 19 18 slave_parallel_type DATABASE LOGICAL_CLOCK slave_parallel_workers 0 4 slave_pending_jobs_size_max 16777216 134217728 slave_preserve_commit_order OFF ON table_definition_cache 1400 2000 table_open_cache 2000 4000 thread_stack 262144 1048576 transaction_write_set_extraction OFF XXHASH64","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_2","title":"\u6392\u67e5","text":"<p>\u65e2\u7136\u4e0a\u9762\u8fd9\u4e9b\u53c2\u6570\u4e0d\u540c\uff0c\u90a3\u6211\u6328\u4e2a\u628a\u53c2\u6570\u7684\u503c\u6539\u6210\u4e00\u6837\uff0c\u770b\u770b\u6027\u80fd\u6709\u4ec0\u4e48\u53d8\u5316\uff0c\u4e8e\u662f\u6211\u628a\u4e0a\u9762\u6d89\u53ca\u5230 InnoDB \u7684\u53c2\u6570\u9010\u4e2a\u8fdb\u884c\u8c03\u6574\uff0c\u5f97\u5230\u4e86\u4e0b\u9762\u7684\u8fd9\u4e2a\u6027\u80fd\u8868</p> \u53c2\u6570 \u503c 5.7 \u6027\u80fd(\u79d2) 8.0 \u6027\u80fd(\u79d2) <code>innodb_autoinc_lock_mode</code> 1 6.11 20.32 <code>innodb_undo_log_truncate</code> OFF 6.10 20.18 <code>innodb_max_dirty_pages_pct</code> 75 6.14 19.89 <code>innodb_max_dirty_pages_pct_lwm</code> 0 6.13 19.87 <code>back_log</code> 80 6.07 20.23 <p>\u4e00\u987f\u64cd\u4f5c\u4e0b\u6765\uff0c\u53d1\u73b0\u53c2\u6570\u5bf9\u6027\u80fd\u5dee\u5f02\u6ca1\u6709\u592a\u591a\u5f71\u54cd\uff0c\u6211\u7a81\u7136\uff0c\u96be\u9053\u662f\u56e0\u4e3a\u867d\u7136\u4e24\u53f0\u673a\u5668\u7684\u914d\u7f6e\u76f8\u540c\uff0c\u4f46\u53ef\u80fd\u78c1\u76d8\u7684\u6027\u80fd\u4e0d\u7528\u76f8\u540c\u4e86\uff1f</p> <p>\u4e8e\u662f\u5bf9\u4e24\u53f0\u673a\u5668\u7684\u78c1\u76d8\u8fdb\u884c\u4e86\u4e00\u8f6e\u6027\u80fd\u6d4b\u8bd5\uff0c\u4f7f\u7528\u7684\u5de5\u5177\u4e3a  fio \uff0c\u6d4b\u8bd5\u7684\u53c2\u6570\u5982\u4e0b</p> <pre><code>$ /usr/bin/fio --randrepeat=1 --ioengine=libaio \\\n  --direct=1 --gtod_reduce=1 --name=test \\\n  --filename=test --bs=4k --iodepth=64 \\\n  --size=4G --readwrite=randrw --rwmixread=75\n</code></pre> <p>10 \u5206\u949f\u540e\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u662f\u4e24\u53f0\u673a\u5668\u7684\u786c\u76d8\u6027\u80fd\u57fa\u672c\u65e0\u5dee\u5f02\u3002</p> <p>\u4e0b\u9762\u662f MySQL 5.7 \u90a3\u53f0\u673a\u5668\u7684\u7ed3\u679c</p> <pre><code>Starting 1 process\ntest: Laying out IO file (1 file / 4096MiB)\nJobs: 1 (f=1): [m(1)][100.0%][r=10.1MiB/s,w=3440KiB/s][r=2586,w=860 IOPS][eta 00m:00s]\ntest: (groupid=0, jobs=1): err= 0: pid=21548: Sat Mar 25 22:42:23 2023\n   read: IOPS=1684, BW=6739KiB/s (6901kB/s)(3070MiB/466501msec)\n   bw (  KiB/s): min= 3904, max=10776, per=100.00%, avg=6737.87, stdev=631.32, samples=933\n   iops        : min=  976, max= 2694, avg=1684.45, stdev=157.83, samples=933\n  write: IOPS=563, BW=2252KiB/s (2306kB/s)(1026MiB/466501msec)\n   bw (  KiB/s): min= 1368, max= 3584, per=100.00%, avg=2251.96, stdev=230.00, samples=933\n   iops        : min=  342, max=  896, avg=562.96, stdev=57.50, samples=933\n  cpu          : usr=1.07%, sys=3.71%, ctx=999168, majf=0, minf=8\n  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.1%, &gt;=64=0.0%\n     issued rwts: total=785920,262656,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=64\n\nRun status group 0 (all jobs):\n   READ: bw=6739KiB/s (6901kB/s), 6739KiB/s-6739KiB/s (6901kB/s-6901kB/s), io=3070MiB (3219MB), run=466501-466501msec\n  WRITE: bw=2252KiB/s (2306kB/s), 2252KiB/s-2252KiB/s (2306kB/s-2306kB/s), io=1026MiB (1076MB), run=466501-466501msec\n\nDisk stats (read/write):\n  sda: ios=785514/263262, merge=0/17, ticks=29813462/19803, in_queue=29833266, util=99.98%\n</code></pre> <p>\u8fd9\u4e2a\u4e0b\u9762\u662f MySQL 8.0 \u90a3\u53f0\u673a\u5668\u7684\u7ed3\u679c</p> <pre><code>Starting 1 process\ntest: Laying out IO file (1 file / 4096MiB)\nJobs: 1 (f=1): [m(1)][100.0%][r=9488KiB/s,w=3232KiB/s][r=2372,w=808 IOPS][eta 00m:00s]\ntest: (groupid=0, jobs=1): err= 0: pid=22261: Sat Mar 25 22:42:21 2023\n   read: IOPS=1692, BW=6768KiB/s (6931kB/s)(3070MiB/464483msec)\n   bw (  KiB/s): min= 3216, max=10040, per=99.91%, avg=6762.12, stdev=581.69, samples=928\n   iops        : min=  804, max= 2510, avg=1690.51, stdev=145.43, samples=928\n  write: IOPS=565, BW=2262KiB/s (2316kB/s)(1026MiB/464483msec)\n   bw (  KiB/s): min= 1024, max= 3456, per=99.96%, avg=2260.11, stdev=214.79, samples=928\n   iops        : min=  256, max=  864, avg=565.00, stdev=53.70, samples=928\n  cpu          : usr=1.10%, sys=3.74%, ctx=999072, majf=0, minf=8\n  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.1%, &gt;=64=0.0%\n     issued rwts: total=785920,262656,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=64\n\nRun status group 0 (all jobs):\n   READ: bw=6768KiB/s (6931kB/s), 6768KiB/s-6768KiB/s (6931kB/s-6931kB/s), io=3070MiB (3219MB), run=464483-464483msec\n  WRITE: bw=2262KiB/s (2316kB/s), 2262KiB/s-2262KiB/s (2316kB/s-2316kB/s), io=1026MiB (1076MB), run=464483-464483msec\n\nDisk stats (read/write):\n  sda: ios=785411/262588, merge=0/8, ticks=29677795/20550, in_queue=29698344, util=100.00%\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e24\u53f0\u786c\u76d8\u7684\u8bfb\u7684 IOPS \u5206\u522b\u662f <code>1684.45</code>\u548c <code>1690.51</code>\u5dee\u5f02\u4e0d\u5230 3%\u3002</p> <p>\u800c\u5199\u7684 IOPS \u5206\u522b\u4e3a <code>562.96</code> \u548c <code>565.00</code> \uff0c\u5dee\u5f02\u7387\u5728\u5343\u5206\u4e4b4\u4ee5\u5185\u3002</p>","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_3","title":"\u66d9\u5149","text":"<p>\u4e8e\u662f\u5f00\u59cb\u75af\u72c2\u7684\u627e\u8d44\u6599\uff0c \u7136\u540e\u627e\u5230\u4e00\u4e2a \u53c2\u6570  <code>transaction_write_set_extraction</code>\uff0c\u8be5\u53c2\u6570\u7528\u6765\u6307\u5b9a\u7528\u4e8e\u5bf9\u4e8b\u52a1\u4e2d\u63d0\u53d6\u7684\u5199\u5165\u8fdb\u884c\u54c8\u5e0c\u7684\u7b97\u6cd5\uff0c\u5728 MySQL 5.7 \u9ed8\u8ba4\u4e0d\u542f\u7528\uff0c\u800c 8.0 \u5219\u9ed8\u8ba4\u914d\u7f6e\u4e3a <code>XXHASH64</code>\uff0c\u5c1d\u8bd5\u90fd\u6539\u6210 <code>OFF</code></p> <p>\u5f97\u5230\u5982\u4e0b\u7684\u7ed3\u679c\uff1a</p> <pre><code>mysql-5.7&gt;call idata();\nQuery OK, 1 row affected (6.15 sec)\n\nmysql-8.0&gt;call idata();\nQuery OK, 1 row affected (14.75 sec)\n</code></pre> <p>\u8fd9\u4e24\u8005\u7684\u5dee\u5f02\u4e00\u4e0b\u5c0f\u4e86\u4e0d\u5c11\uff0c\u4f46\u4ecd\u7136\u67092\u500d\u7684\u5dee\u8ddd\uff0c\u4e0d\u5e94\u8be5\u554a\u3002</p>","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_4","title":"\u758f\u5ffd","text":"<p>\u7ee7\u7eed\u6298\u817e\uff0c\u663e\u8457\u6027\u80fd\u5dee\u5f02\u8fd8\u662f\u5728\u90a3\u91cc\uff0c\u6211\u60f3\u4e0d\u5e94\u8be5\u554a\uff0c\u5982\u679c\u771f\u7684\u6027\u80fd\u5dee\u5f02\u8fd9\u4e48\u5927\uff0c\u793e\u533a\u8fd8\u4e0d\u95f9\u7ffb\u5929\u4e86\u3002\u6211\u60f3\u4e0d\u4f1a\u662f\u5b58\u50a8\u7684\u6587\u4ef6\u683c\u5f0f\u6709\u4e9b\u533a\u522b\uff0c\u4e8e\u662f\u53bb\u770b\u6570\u636e\u76ee\u5f55\uff0c\u770b\u6709\u4ec0\u4e48\u53d1\u73b0\u6ca1\u6709\uff0c\u8fdb\u5165 MySQL 8.0 \u65f6\uff0c\u54a6\uff0c\u600e\u4e48\u770b\u5230\u6709 binlog \u65e5\u5fd7\u6587\u4ef6\uff1f\u4e0d\u662f\u9ed8\u8ba4\u5173\u95ed\u4e86\u5417\uff1f</p> <p>\u518d\u770b MySQL 5.7 \uff0c\u6ca1\u6709 binlog \u65e5\u5fd7\uff0c\u597d\u5bb6\u4f19\uff0c\u641e\u5f97\u534a\u5929\u8fd8\u662f\u81ea\u5df1\u7684\u539f\u56e0\u554a\u3002</p> <p>\u539f\u6765 MysQL 5.7 \u91cc\u5982\u679c\u4e0d\u5e0c\u671b\u5199 binlog \uff0c\u90a3\u8bbe\u7f6e <code>log_bin=0</code> \u6216\u8005 <code>log_bin=off</code>\u90fd\u53ef\u4ee5\uff0c\u800c MySQL 8.0 ,\u5219\u9700\u8981\u914d\u7f6e\u4e3a <code>skip-log-bin</code></p> <p>\u8d76\u7d27\u8bbe\u7f6e\u540e\uff0c\u518d\u7ee7\u7eed\u6d4b\u8bd5</p> <pre><code>mysql-5.7&gt;call idata();\nQuery OK, 1 row affected (6.11 sec)\n\nmysql-8.0&gt;call idata();\nQuery OK, 1 row affected (7.03 sec)\n</code></pre> <p>\u8fd9\u4e0b\u6027\u80fd\u5dee\u5f02\u5728 15% \u4ee5\u5185\u4e86\u3002\u8003\u8651\u5230\u56e0\u4e3a MySQL 8.0 \u591a\u4e86\u5f88\u591a\u65b0\u7279\u6027\uff0c\u4f30\u8ba1\u5728\u5f00\u7bb1\u5373\u7528\u7684\u60c5\u51b5\u4e0b\uff0c MySQL 8.0 \u6027\u80fd\u6253\u4e0d\u8fc7 MySQL 5.7</p> <p>\u90a3\u5c31\u5c1d\u8bd5\u4f18\u5316\u770b\u770b</p>","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_5","title":"\u4f18\u5316","text":"<p>\u6211\u7ee7\u7eed\u8c03\u6574\u6709 MySQL 8.0 \u6709\u5173\u7684\u53c2\u6570\uff0c\u770b\u770b\u5728\u8fd9\u4e2a\u7eaf\u63d2\u5165\u7684\u573a\u666f\u4e0b\uff0cMySQL 8.0 \u662f\u5426\u80fd\u548c MySQL 5.7 \u6301\u5e73\u751a\u81f3\u8d85\u8fc7\uff0c\u4f46\u7ecf\u8fc7\u591a\u6b21\u53c2\u6570\u8c03\u6574\u540e\uff0c\u76ee\u524d\u4f9d\u7136\u662f MySQL 5.7 \u83b7\u80dc\u3002\u4e5f\u8bb8\u5728\u7efc\u5408\u8d1f\u8f7d\u4e0a\uff0cMySQL 8.0 \u53ef\u80fd\u80dc\u4e8e MySQL 5.7\uff0c\u6bd4\u5982\u6211\u770b\u5230\u6709\u4eba\u505a\u7684\u6d4b\u8bd5\u4e2d \u4e2d\uff0c\u5f53\u5e76\u53d1\u7684\u7ebf\u7a0b\u8d85\u8fc7 1024 \u540e\uff0cMySQL 8.0 \u7684\u6027\u80fd\u5c31\u76f8\u6bd4 5.7 \u6709\u4e86\u663e\u8457\u7684\u63d0\u5347\u3002</p> <p>\u540e\u7eed\u6709\u65f6\u95f4\u53ef\u4ee5\u4f7f\u7528sysbench \u4e4b\u7c7b\u7684\u5de5\u5177\u641e\u4e00\u4e2a\u7efc\u5408\u8d1f\u8f7d\u6bd4\u8f83\u3002</p>","tags":["mysql","performance","benchmark"]},{"location":"database/why-mysql8-slower-than-mysql57/#_6","title":"\u53c2\u8003","text":"<p>\u4ee5\u4e0b\u662f\u672c\u5e16\u7684\u90e8\u5206\u53c2\u8003\u8d44\u6599</p> <ul> <li>https://stackoverflow.com/questions/67685738/mysql-performance-5-7-vs-8-0</li> <li>https://severalnines.com/blog/mysql-performance-benchmarking-mysql-57-vs-mysql-80/</li> <li>https://dba.stackexchange.com/questions/216352/inserts-in-mysql-8-are-slower-than-inserts-in-mysql-5-7</li> <li>https://bugs.mysql.com/bug.php?id=93734</li> <li>http://dimitrik.free.fr/Presentations/MySQL_Tuning-Feb2019-dim.pdf</li> <li>https://www.devart.com/dbforge/mysql/studio/mysql-performance-tips.html</li> </ul>","tags":["mysql","performance","benchmark"]},{"location":"kubernetes/access-k8s-pod-from-outersider/","title":"\u5916\u90e8\u673a\u5668\u5982\u4f55\u76f4\u63a5\u76f4\u63a5\u8bbf\u95ee kubernetes \u96c6\u7fa4\u5185\u670d\u52a1","text":"<p>\u9700\u6c42\u5927\u81f4\u662f\u8fd9\u6837\u7684\uff0c\u6709\u4e00\u4e2a kubernetes \u96c6\u7fa4\uff08\u4ee5\u4e0b\u7b80\u79f0 k8s \u96c6\u7fa4\uff09\uff0c\u8fd0\u884c\u7684\u7a0b\u5e8f\uff08pod\uff09\u5728\u96c6\u7fa4\u5185\u6216\u8005\u96c6\u7fa4\u8282\u70b9\u4e4b\u95f4\u662f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u7684\uff0c\u4f46\u662f\u96c6\u7fa4\u5916\u7684\u673a\u5668\u4e0d\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u3002</p> <p>\u4e00\u79cd\u7b80\u5355\u7684\u89e3\u51b3\u529e\u6cd5\u662f\u628a\u7a0b\u5e8f\u7684\u7aef\u53e3\u901a\u8fc7 nodePort \u7684\u65b9\u5f0f\u628a\u670d\u52a1\u76d1\u542c\u7aef\u53e3\u66b4\u9732\u5728\u4e3b\u673a\u4e0a\uff0c\u8fd9\u6837\u5916\u90e8\u673a\u5668\u5c31\u53ef\u4ee5\u901a\u8fc7\u96c6\u7fa4\u4e3b\u673a\u4e0a\u5bf9\u5e94\u7684\u7aef\u53e3\u6765\u8bbf\u95ee\u7a0b\u5e8f(pod) \u4e86\u3002</p> <p>\u4f46\u8fd9\u79cd\u65b9\u5f0f\u7684\u4e00\u4e2a\u9ebb\u70e6\u5728\u4e8e\u7aef\u53e3\u9700\u8981\u7ba1\u7406\uff0c\u800c\u4e14\u57fa\u672c\u4e0a\u5f88\u96be\u505a\u5230\u96c6\u7fa4\u5185\u5916\u7aef\u53e3\u4e00\u81f4\uff08\u6bd4\u5982\u591a\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u7684\u7aef\u53e3\u90fd\u662f8080\uff0c\u4f46\u66b4\u9732\u7684\u7aef\u53e3\u53c8\u4e0d\u80fd\u91cd\u590d\uff09\u3002</p> <p>\u6240\u4ee5\u60f3\u627e\u4e00\u4e2a\u5408\u9002\u7684\u65b9\u5f0f\uff0c\u4f7f\u5f97\u96c6\u7fa4\u5916\u90e8\u7a0b\u5e8f\u80fd\u50cf\u5728\u96c6\u7fa4\u8282\u70b9\u751a\u81f3\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\u7a0b\u5e8f\u90a3\u6837\u65e0\u950b\uff0c\u8fd9\u5bf9\u5f00\u53d1\u8005\u800c\u8a00\u65e0\u7591\u6781\u5927\u7684\u51cf\u5c11\u4e86\u73af\u5883\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u80fd\u5feb\u901fdebug\u3002</p> <p>Telpresence \u662f\u4e00\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u4f46\u8981\u5bf9\u5916\u90e8\u673a\u5668\u548c\u96c6\u7fa4\u673a\u5668\u7684\u4fb5\u5165\u6027\u592a\u9ad8\uff0c\u5176\u5b9e\u5f88\u96be\u7ba1\u7406\u7684\u3002</p> <p>\u6700\u540e\u53d7\u8fd9\u7bc7\u6587\u7ae0 \u7684\u542f\u53d1\uff0c\u5728\u6d4b\u8bd5\u73af\u5883\u8fdb\u884c\u4e86\u9a8c\u8bc1\u53ef\u884c\u6027\uff0c\u8fd9\u5e94\u8be5\u662f\u6210\u672c\u6700\u4f4e\u7684\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\u4e86\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u65b9\u6848\u6709\u4e00\u4e2a\u524d\u63d0\uff0c\u90a3\u5c31\u662f **\u5916\u90e8\u673a\u5668**\u8981\u80fd\u76f4\u63a5\u8bbf\u95ee\u96c6\u7fa4\u7684\u8282\u70b9\uff0c\u53ef\u4ee5\u4e0d\u5728\u4e00\u4e2a\u7f51\u6bb5\uff0c\u4f46\u5fc5\u987b\u80fd\u4e92\u901a\u3002\u5426\u5219\u8fd9\u4e2a\u65b9\u6848\u6ca1\u620f\u3002</p> <p>\u6574\u4e2a\u65b9\u6848\u5206\u6210\u4e24\u4e2a\u90e8\u5206\uff0c\u4e00\u4e2a\u662f\u89e3\u51b3\u7f51\u7edc\u4e92\u901a\u95ee\u9898\uff0c\u4e00\u4e2a\u662f\u89e3\u51b3\u540d\u79f0\u89e3\u6790\u95ee\u9898</p>","tags":["dns","k8s","service"]},{"location":"kubernetes/access-k8s-pod-from-outersider/#_1","title":"\u89e3\u51b3\u7f51\u7edc\u4e92\u901a\u95ee\u9898","text":"<p>\u6bd4\u5982\u8fd9\u6837\u7684\u7f51\u7edc\u62d3\u6251\u7ed3\u6784\uff1a</p> <pre><code>graph TB\n    subgraph outersider\n    direction TB\n    node1[\"10.90.1.100\"]\n    node2[\"10.90.1.101\"]\n    node3[\"...\"]\n    node4[\"10.90.1.x\"]\n    end\n\n    subgraph k8s\n    direction TB\n    n1[\"IP: 10.90.2.100&lt;br&gt;svc: 10.1.0.0/16\"]\n    n2[\"IP: 10.90.2.101&lt;br&gt;svc: 10.1.0.0/16\"]\n    n3[\"...\"]\n    n4[\"IP: 10.90.2.x&lt;br&gt;svc: 10.1.0.0/16\"]\n    end\n\n    outersider &lt;--\u4e92\u901a---&gt; k8s\n</code></pre> <p>\u96c6\u7fa4\u5916\u90e8\u673a\u5668\u7684\u7f51\u6bb5\u662f <code>10.90.1.0/24</code>\uff0c k8s \u96c6\u7fa4\u8282\u70b9\u7684\u7f51\u6bb5\u662f  <code>10.90.2.0/24</code> \uff0c\u96c6\u7fa4\u5185 Service \u914d\u7f6e\u7684\u7f51\u6bb5\u662f <code>10.1.0.0/16</code>\uff0c\u5176\u4e2d <code>10.90.1.0</code> \u548c <code>10.90.2.0</code> \u662f\u4e92\u901a\u7684\u3002</p> <p>\u4f46\u662f\u6211\u4eec\u77e5\u9053\u4ece <code>10.90.1.0/24</code> \u80af\u5b9a\u76f4\u63a5\u8bbf\u95ee <code>10.1.0.0/16</code> \u8fd9\u4e2a\u7f51\u6bb5\u7684\u3002</p> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u5728 <code>10.90.1.0/24</code> \u673a\u5668\u4e0a\u589e\u52a0\u4e00\u6761\u9759\u6001\u8def\u7531\uff0c\u4f7f\u5f97\u8bbf\u95ee <code>10.1.0.0/16</code> \u7f51\u6bb5\u7684\u8bf7\u6c42\u90fd\u8f6c\u5230 <code>10.90.2.0/24</code> \u4e2d\u7684\u4efb\u4f55\u4e00\u53f0\u3002\u5f53\u7136\u4e00\u822c\u6211\u90fd\u6307\u5b9a\u4e00\u53f0\uff0c\u6bd4\u5982\u8fd9\u91cc\u5c31\u6307\u5b9a <code>10.90.2.100</code></p> <p>Linux \u7cfb\u7edf\u901a\u8fc7\u5982\u4e0b\u6307\u4ee4\u589e\u52a0\u8def\u7531</p> <pre><code># route add -net 10.1.0.0/16 gw 10.90.2.100\n</code></pre> <p>Windows \u7cfb\u7edf\u901a\u8fc7\u4e0b\u9762\u7684\u6307\u4ee4\u589e\u52a0\u8def\u7531</p> <pre><code>c:\\&gt; ROUTE -p ADD 10.1.0.0 MASK 255.255.0.0 10.90.2.100\n</code></pre> <p>\u589e\u52a0\u8def\u7531\u540e\uff0c\u518d\u5c1d\u8bd5\u5728 <code>10.90.1.0/24</code> \u673a\u5668\u4e0a\u8bbf\u95ee <code>10.1.0.0/16</code> \u7684\u670d\u52a1\u8bd5\u4e0b\uff08\u6709\u53ef\u80fd <code>ping</code> \u547d\u4ee4\u5e76\u4e0d\u751f\u6548\uff0c\u81f3\u5c11\u6211\u7684\u73af\u5883\u662f\u5982\u6b64\uff09</p>","tags":["dns","k8s","service"]},{"location":"kubernetes/access-k8s-pod-from-outersider/#_2","title":"\u89e3\u51b3\u540d\u79f0\u89e3\u6790\u95ee\u9898","text":"<p>\u7f51\u7edc\u901a\u4e86\u540e\uff0c\u6211\u4eec\u8fd8\u5e0c\u671b\u80fd\u76f4\u63a5\u8bbf Service \u7684\u540d\u5b57\u6765\u8bbf\u95ee\u5bf9\u5e94\u7684\u670d\u52a1\uff0c\u90a3\u8fd9\u6837\u5c31\u771f\u7684\u548c\u96c6\u7fa4\u5185\u8bbf\u95ee\u6beb\u65e0\u4e8c\u81f4\u4e86\uff0c\u8fd9\u4e2a\u5230\u6bd4\u8f83\u5bb9\u6613\u89e3\u51b3\uff0c\u53ea\u9700\u8981\u5728 k8s \u96c6\u7fa4 <code>10.90.2.0/24</code> \u4efb\u610f\u8282\u70b9\u4e0a\u90e8\u7f72\u4e00\u4e2a DNS \u670d\u52a1\uff0c\u4ec5\u4f5c\u8f6c\u53d1\uff0c\u8f6c\u53d1\u5230 k8s \u96c6\u7fa4\u5185\u90e8\u7684 DNS \u91cc\uff08\u6bd4\u5982 <code>kube-dns</code> \u6216 <code>coredns</code> \u4e4b\u7c7b\u7684\uff09</p> <p>\u5047\u5b9a\u4f60 k8s \u96c6\u7fa4\u5185\u7684 DNS \u5730\u5740\u4e3a <code>10.1.0.10</code> \u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6b65\u9aa4\u6765\u5b8c\u6210</p>","tags":["dns","k8s","service"]},{"location":"kubernetes/access-k8s-pod-from-outersider/#dns","title":"\u90e8\u7f72\u8f6c\u53d1 DNS","text":"<p>\u5728 <code>10.90.2.100</code> \u4e0a\u5b89\u88c5 bind \u5957\u4ef6</p> <pre><code># yum install -y bind bind-utils\n</code></pre> <p>\u4fee\u6539 <code>/etc/named.conf</code> \u6587\u4ef6\uff0c\u5728 <code>options</code> \u6bb5\u589e\u52a0\u4e0b\u9762\u7684\u914d\u7f6e\uff1a</p> <pre><code>forwarders {\n    10.1.0.10;\n};\nforward only;\n</code></pre> <p>\u7136\u540e\u542f\u52a8\u670d\u52a1</p> <pre><code># systemctl start named\n</code></pre> <p>\u6d4b\u8bd5\u4e0b\u662f\u5426\u6b63\u5e38</p> <pre><code>$ dig @10.90.2.100 redis.default.svc.cluster.local\n\n; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; @10.90.2.100 redis.default.svc.cluster.local\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 62948\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 4096\n;; QUESTION SECTION:\n;minio.default.svc.cluster.local. IN    A\n\n;; ANSWER SECTION:\nredis.default.svc.cluster.local. 30 IN  A       10.1.130.208\n\n;; Query time: 2 msec\n;; SERVER: 10.90.2.100#53(10.90.2.100)\n;; WHEN: \u4e94 2\u6708 17 23:28:26 CST 2023\n;; MSG SIZE  rcvd: 76\n</code></pre> <p>\u770b\u6765\u5df2\u7ecf\u6210\u529f\u89e3\u6790\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u5728\u5916\u90e8\u673a\u5668 (<code>10.90.1.0/16</code> )\u7684\u673a\u5668\u4e0a\u914d\u7f6e\u4e0a\u8fd9\u4e2a DNS</p> <p>Linux \u7cfb\u7edf\uff0c\u4fee\u6539 <code>/etc/resolv.conf</code> \u6587\u4ef6\uff0c\u589e\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>nameserver 10.90.2.100\nsearch default.svc.cluster.local svc.cluster.local\n</code></pre> <p>Windows \u7cfb\u7edf\u53c2\u8003\u5b98\u65b9\u6587\u6863\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u57fa\u672c\u4e0a\u96c6\u7fa4\u5916\u673a\u5668\u8bbf\u95ee k8s \u96c6\u7fa4\u5185\u7684\u670d\u52a1\u5c31\u548c\u5728\u96c6\u7fa4\u5185\u8bbf\u95ee\u65e0\u7591\u4e86\u3002Happy :-)</p>","tags":["dns","k8s","service"]},{"location":"kubernetes/calico-node-troubleshooting/","title":"Calico Node \u65e0\u6cd5\u542f\u52a8\u7684\u6392\u67e5","text":"<p>\u6211\u4eec\u90e8\u7f72\u4e86\u4e00\u4e2a 3 \u8282\u70b9\u7684 Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u7528\u7684\u662f Calico \u7f51\u7edc\u63d2\u4ef6\uff0c\u7248\u672c\u4fe1\u606f\u5982\u4e0b:</p> <ul> <li>Kubernetes: v1.27.4</li> <li>Calico: v3.15.1</li> <li>CNI: v0.8.6</li> <li>OS: Ubuntu 22.04 LTS</li> <li>Kernel: 6.5.0-21-generic</li> <li>containerd: 1.7.12-0ubuntu2~22.04.1</li> </ul> <p>\u5f53\u524d\u96c6\u7fa4\u5de5\u4f5c\u6b63\u5e38\uff0c\u6211\u4eec\u5c1d\u8bd5\u65b0\u589e\u4e00\u4e2a\u76f8\u540c\u7248\u672c\u4fe1\u606f\u7684\u8282\u70b9\uff0c\u4f46\u662f\u53d1\u73b0\u65b0\u8282\u70b9\u7684 Calico Node \u65e0\u6cd5\u542f\u52a8\uff0c \u4f7f\u7528 <code>kubectl describe pod calico-node-xxxxx -n kube-system</code> \u67e5\u770b Pod \u7684\u72b6\u6001\uff0c\u53d1\u73b0\u5b58\u6d3b\u63a2\u9488\u5931\u8d25\uff0c\u5bfc\u81f4 Pod \u4e0d\u65ad\u91cd\u542f\uff0c\u6700\u540e\u8fdb\u5165 CrashLoopBackOff \u72b6\u6001\u3002</p> <p>\u67e5\u770b Pod \u7684\u65e5\u5fd7\uff0c\u4e5f\u6ca1\u6709\u660e\u663e\u7684\u62a5\u9519\uff0c\u4e00\u822c\u662f\u5728\u4e0b\u9762\u7684\u65e5\u5fd7\u540e\uff0c Pod \u5c31\u91cd\u542f\u4e86</p> <pre><code>2024-11-11 03:12:57.671 [INFO][105] felix/health.go 336: Overall health status changed: live=true ready=true\n+---------------------------+---------+----------------+-----------------+--------+\n|         COMPONENT         | TIMEOUT |    LIVENESS    |    READINESS    | DETAIL |\n+---------------------------+---------+----------------+-----------------+--------+\n| CalculationGraph          | 30s     | reporting live | reporting ready |        |\n| FelixStartup              | -       | reporting live | reporting ready |        |\n| InternalDataplaneMainLoop | 1m30s   | reporting live | reporting ready |        |\n+---------------------------+---------+----------------+-----------------+--------+\n</code></pre> <p><code>kubelet</code> \u670d\u52a1\u4e5f\u6ca1\u6709\u660e\u663e\u7684\u62a5\u9519\u4fe1\u606f\uff0c\u6392\u67e5\u9677\u5165\u4e86\u50f5\u5c40\uff0c\u4e0d\u77e5\u9053\u8be5\u5982\u4f55\u89e3\u51b3\u3002\u671f\u95f4\u5c1d\u8bd5\u4e86\u91cd\u7f6e\u8282\u70b9\uff0c\u91cd\u65b0\u90e8\u7f72 Calico Node\uff0c\u4f46\u662f\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002</p> <p>\u8fd9\u6837\u65ad\u65ad\u7eed\u7eed\u6392\u67e5\u4e86\u4e00\u5468\uff0c\u95ee\u9898\u8fd8\u662f\u6ca1\u6709\u89e3\u51b3\u3002</p> <p>\u4eca\u5929\u53c8\u7ee7\u7eed\u6392\u67e5\uff0c\u7136\u540e\u518d <code>/var/log/calico/cni/cni.log</code> \u65e5\u5fd7\u91cc\u627e\u5230\u4e86\u4e0b\u9762\u7684\u4fe1\u606f\uff1a</p> <pre><code>2024-11-11 02:54:08.675 [INFO][119] felix/daemon.go 398: Successfully loaded configuration. GOMAXPROCS=64 builddate=\"2023-08-17T14:17:29+0000\" config=&amp;config.Config{UseInternalDataplaneDriver:true, DataplaneDriver:\"calico-iptables-plugin\", DataplaneWatchdogTimeout:90000000000, WireguardEnabled:false, WireguardEnabledV6:false, WireguardListeningPort:51820, WireguardListeningPortV6:51821, WireguardRoutingRulePriority:99, WireguardInterfaceName:\"wireguard.cali\", WireguardInterfaceNameV6:\"wg-v6.cali\", WireguardMTU:0, WireguardMTUV6:0, WireguardHostEncryptionEnabled:false, WireguardPersistentKeepAlive:0, BPFEnabled:false, BPFDisableUnprivileged:true, BPFLogLevel:\"off\", BPFLogFilters:map[string]string(nil), BPFCTLBLogFilter:\"\", BPFDataIfacePattern:(*regexp.Regexp)(0xc000479ae0), BPFL3IfacePattern:(*regexp.Regexp)(nil), BPFConnectTimeLoadBalancingEnabled:true, BPFExternalServiceMode:\"tunnel\", BPFDSROptoutCIDRs:[]string(nil), BPFKubeProxyIptablesCleanupEnabled:true, BPFKubeProxyMinSyncPeriod:1000000000, BPFKubeProxyEndpointSlicesEnabled:true, BPFExtToServiceConnmark:0, BPFPSNATPorts:numorstring.Port{MinPort:0x4e20, MaxPort:0x752f, PortName:\"\"}, BPFMapSizeNATFrontend:65536, BPFMapSizeNATBackend:262144, BPFMapSizeNATAffinity:65536, BPFMapSizeRoute:262144, BPFMapSizeConntrack:512000, BPFMapSizeIPSets:1048576, BPFMapSizeIfState:1000, BPFHostConntrackBypass:true, BPFEnforceRPF:\"Loose\", BPFPolicyDebugEnabled:true, BPFForceTrackPacketsFromIfaces:[]string{\"docker+\"}, BPFDisableGROForIfaces:(*regexp.Regexp)(nil), DebugBPFCgroupV2:\"\", DebugBPFMapRepinEnabled:false, DatastoreType:\"kubernetes\", FelixHostname:\"node13.k8s.gp51.com\", EtcdAddr:\"127.0.0.1:2379\", EtcdScheme:\"http\", EtcdKeyFile:\"\", EtcdCertFile:\"\", EtcdCaFile:\"\", EtcdEndpoints:[]string(nil), TyphaAddr:\"\", TyphaK8sServiceName:\"\", TyphaK8sNamespace:\"kube-system\", TyphaReadTimeout:30000000000, TyphaWriteTimeout:10000000000, TyphaKeyFile:\"\", TyphaCertFile:\"\", TyphaCAFile:\"\", TyphaCN:\"\", TyphaURISAN:\"\", Ipv6Support:false, BpfIpv6Support:false, IptablesBackend:\"auto\", RouteRefreshInterval:90000000000, InterfaceRefreshInterval:90000000000, DeviceRouteSourceAddress:net.IP(nil), DeviceRouteSourceAddressIPv6:net.IP(nil), DeviceRouteProtocol:3, RemoveExternalRoutes:true, IptablesRefreshInterval:90000000000, IptablesPostWriteCheckIntervalSecs:1000000000, IptablesLockFilePath:\"/run/xtables.lock\", IptablesLockTimeoutSecs:0, IptablesLockProbeIntervalMillis:50000000, FeatureDetectOverride:map[string]string(nil), FeatureGates:map[string]string(nil), IpsetsRefreshInterval:10000000000, MaxIpsetSize:1048576, XDPRefreshInterval:90000000000, PolicySyncPathPrefix:\"\", NetlinkTimeoutSecs:10000000000, MetadataAddr:\"\", MetadataPort:8775, OpenstackRegion:\"\", InterfacePrefix:\"cali\", InterfaceExclude:[]*regexp.Regexp{(*regexp.Regexp)(0xc000479c20)}, ChainInsertMode:\"insert\", DefaultEndpointToHostAction:\"ACCEPT\", IptablesFilterAllowAction:\"ACCEPT\", IptablesMangleAllowAction:\"ACCEPT\", IptablesFilterDenyAction:\"DROP\", LogPrefix:\"calico-packet\", LogFilePath:\"\", LogSeverityFile:\"\", LogSeverityScreen:\"INFO\", LogSeveritySys:\"\", LogDebugFilenameRegex:(*regexp.Regexp)(nil), VXLANEnabled:(*bool)(nil), VXLANPort:4789, VXLANVNI:4096, VXLANMTU:0, VXLANMTUV6:0, IPv4VXLANTunnelAddr:net.IP(nil), IPv6VXLANTunnelAddr:net.IP(nil), VXLANTunnelMACAddr:\"\", VXLANTunnelMACAddrV6:\"\", IpInIpEnabled:(*bool)(nil), IpInIpMtu:0, IpInIpTunnelAddr:net.IP{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0xa, 0xf4, 0xe2, 0x40}, FloatingIPs:\"Disabled\", AllowVXLANPacketsFromWorkloads:false, AllowIPIPPacketsFromWorkloads:false, AWSSrcDstCheck:\"DoNothing\", ServiceLoopPrevention:\"Drop\", WorkloadSourceSpoofing:\"Disabled\", ReportingIntervalSecs:0, ReportingTTLSecs:90000000000, EndpointReportingEnabled:false, EndpointReportingDelaySecs:1000000000, IptablesMarkMask:0xffff0000, DisableConntrackInvalidCheck:false, HealthEnabled:true, HealthPort:9099, HealthHost:\"localhost\", HealthTimeoutOverrides:map[string]time.Duration(nil), PrometheusMetricsEnabled:false, PrometheusMetricsHost:\"\", PrometheusMetricsPort:9091, PrometheusGoMetricsEnabled:true, PrometheusProcessMetricsEnabled:true, PrometheusWireGuardMetricsEnabled:true, FailsafeInboundHostPorts:[]config.ProtoPort{config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x16}, config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x44}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0xb3}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94c}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1561}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x192b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0a}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0b}}, FailsafeOutboundHostPorts:[]config.ProtoPort{config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x35}, config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x43}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0xb3}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94c}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1561}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x192b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0a}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0b}}, KubeNodePortRanges:[]numorstring.Port{numorstring.Port{MinPort:0x7530, MaxPort:0x7fff, PortName:\"\"}}, NATPortRange:numorstring.Port{MinPort:0x0, MaxPort:0x0, PortName:\"\"}, NATOutgoingAddress:net.IP(nil), UsageReportingEnabled:true, UsageReportingInitialDelaySecs:300000000000, UsageReportingIntervalSecs:86400000000000, ClusterGUID:\"a97da56e5db6460facdb88bcaeac2b27\", ClusterType:\"k8s,bgp,kubeadm,kdd\", CalicoVersion:\"v3.27.0-0.dev-263-g253d5925780a\", ExternalNodesCIDRList:[]string(nil), DebugMemoryProfilePath:\"\", DebugCPUProfilePath:\"/tmp/felix-cpu-&lt;timestamp&gt;.pprof\", DebugDisableLogDropping:false, DebugSimulateCalcGraphHangAfter:0, DebugSimulateDataplaneHangAfter:0, DebugPanicAfter:0, DebugSimulateDataRace:false, RouteSource:\"CalicoIPAM\", RouteTableRange:idalloc.IndexRange{Min:0, Max:0}, RouteTableRanges:[]idalloc.IndexRange(nil), RouteSyncDisabled:false, IptablesNATOutgoingInterfaceFilter:\"\", SidecarAccelerationEnabled:false, XDPEnabled:true, GenericXDPEnabled:false, Variant:\"Calico\", MTUIfacePattern:(*regexp.Regexp)(0xc000479ea0), Encapsulation:config.Encapsulation{IPIPEnabled:true, VXLANEnabled:false, VXLANEnabledV6:false}, internalOverrides:map[string]string{}, sourceToRawConfig:map[config.Source]map[string]string{0x1:map[string]string{\"CalicoVersion\":\"v3.27.0-0.dev-263-g253d5925780a\", \"ClusterGUID\":\"a97da56e5db6460facdb88bcaeac2b27\", \"ClusterType\":\"k8s,bgp,kubeadm,kdd\", \"FloatingIPs\":\"Disabled\", \"LogSeverityScreen\":\"Info\", \"ReportingIntervalSecs\":\"0\"}, 0x2:map[string]string{\"IpInIpTunnelAddr\":\"10.244.226.64\"}, 0x3:map[string]string{\"LogFilePath\":\"None\", \"LogSeverityFile\":\"None\", \"LogSeveritySys\":\"None\", \"MetadataAddr\":\"None\"}, 0x4:map[string]string{\"datastoretype\":\"kubernetes\", \"defaultendpointtohostaction\":\"ACCEPT\", \"felixhostname\":\"node13.k8s.gp51.com\", \"healthenabled\":\"true\", \"ipinipmtu\":\"0\", \"ipv6support\":\"false\", \"vxlanmtu\":\"0\", \"wireguardmtu\":\"0\"}}, rawValues:map[string]string{\"CalicoVersion\":\"v3.27.0-0.dev-263-g253d5925780a\", \"ClusterGUID\":\"a97da56e5db6460facdb88bcaeac2b27\", \"ClusterType\":\"k8s,bgp,kubeadm,kdd\", \"DatastoreType\":\"kubernetes\", \"DefaultEndpointToHostAction\":\"ACCEPT\", \"FelixHostname\":\"node13.k8s.gp51.com\", \"FloatingIPs\":\"Disabled\", \"HealthEnabled\":\"true\", \"IpInIpMtu\":\"0\", \"IpInIpTunnelAddr\":\"10.244.226.64\", \"Ipv6Support\":\"false\", \"LogFilePath\":\"None\", \"LogSeverityFile\":\"None\", \"LogSeverityScreen\":\"Info\", \"LogSeveritySys\":\"None\", \"MetadataAddr\":\"None\", \"ReportingIntervalSecs\":\"0\", \"VXLANMTU\":\"0\", \"WireguardMTU\":\"0\"}, Err:error(nil), loadClientConfigFromEnvironment:(func() (*apiconfig.CalicoAPIConfig, error))(0x162cca0), useNodeResourceUpdates:false} gitcommit=\"253d5925780a3207cd262279e32cf54f11db18a0\" version=\"v3.27.0-0.dev-263-g253d5925780a\"\n2024-11-11 02:54:08.679 [INFO][119] felix/int_dataplane.go 356: Creating internal dataplane driver. config=intdataplane.Config{Hostname:\"node13.k8s.gp51.com\", NodeZone:\"\", IPv6Enabled:false, RuleRendererOverride:rules.RuleRenderer(nil), IPIPMTU:0, VXLANMTU:0, VXLANMTUV6:0, VXLANPort:4789, MaxIPSetSize:1048576, RouteSyncDisabled:false, IptablesBackend:\"auto\", IPSetsRefreshInterval:10000000000, RouteRefreshInterval:90000000000, DeviceRouteSourceAddress:net.IP(nil), DeviceRouteSourceAddressIPv6:net.IP(nil), DeviceRouteProtocol:3, RemoveExternalRoutes:true, IptablesRefreshInterval:90000000000, IptablesPostWriteCheckInterval:1000000000, IptablesInsertMode:\"insert\", IptablesLockFilePath:\"/run/xtables.lock\", IptablesLockTimeout:0, IptablesLockProbeInterval:50000000, XDPRefreshInterval:90000000000, FloatingIPsEnabled:false, Wireguard:wireguard.Config{Enabled:false, EnabledV6:false, ListeningPort:51820, ListeningPortV6:51821, FirewallMark:0, RoutingRulePriority:99, RoutingTableIndex:1, RoutingTableIndexV6:2, InterfaceName:\"wireguard.cali\", InterfaceNameV6:\"wg-v6.cali\", MTU:0, MTUV6:0, RouteSource:\"CalicoIPAM\", EncryptHostTraffic:false, PersistentKeepAlive:0, RouteSyncDisabled:false}, NetlinkTimeout:10000000000, RulesConfig:rules.Config{IPSetConfigV4:(*ipsets.IPVersionConfig)(0xc0006a45f0), IPSetConfigV6:(*ipsets.IPVersionConfig)(0xc0006a4690), WorkloadIfacePrefixes:[]string{\"cali\"}, IptablesMarkAccept:0x10000, IptablesMarkPass:0x20000, IptablesMarkScratch0:0x40000, IptablesMarkScratch1:0x80000, IptablesMarkEndpoint:0xfff00000, IptablesMarkNonCaliEndpoint:0x100000, KubeNodePortRanges:[]numorstring.Port{numorstring.Port{MinPort:0x7530, MaxPort:0x7fff, PortName:\"\"}}, KubeIPVSSupportEnabled:true, OpenStackMetadataIP:net.IP(nil), OpenStackMetadataPort:0x2247, OpenStackSpecialCasesEnabled:false, VXLANEnabled:false, VXLANEnabledV6:false, VXLANPort:4789, VXLANVNI:4096, IPIPEnabled:true, FelixConfigIPIPEnabled:(*bool)(nil), IPIPTunnelAddress:net.IP{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0xa, 0xf4, 0xe2, 0x40}, VXLANTunnelAddress:net.IP(nil), VXLANTunnelAddressV6:net.IP(nil), AllowVXLANPacketsFromWorkloads:false, AllowIPIPPacketsFromWorkloads:false, WireguardEnabled:false, WireguardEnabledV6:false, WireguardInterfaceName:\"wireguard.cali\", WireguardInterfaceNameV6:\"wg-v6.cali\", WireguardIptablesMark:0x0, WireguardListeningPort:51820, WireguardListeningPortV6:51821, WireguardEncryptHostTraffic:false, RouteSource:\"CalicoIPAM\", IptablesLogPrefix:\"calico-packet\", EndpointToHostAction:\"ACCEPT\", IptablesFilterAllowAction:\"ACCEPT\", IptablesMangleAllowAction:\"ACCEPT\", IptablesFilterDenyAction:\"DROP\", FailsafeInboundHostPorts:[]config.ProtoPort{config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x16}, config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x44}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0xb3}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94c}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1561}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x192b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0a}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0b}}, FailsafeOutboundHostPorts:[]config.ProtoPort{config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x35}, config.ProtoPort{Net:\"\", Protocol:\"udp\", Port:0x43}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0xb3}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x94c}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1561}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x192b}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0a}, config.ProtoPort{Net:\"\", Protocol:\"tcp\", Port:0x1a0b}}, DisableConntrackInvalid:false, NATPortRange:numorstring.Port{MinPort:0x0, MaxPort:0x0, PortName:\"\"}, IptablesNATOutgoingInterfaceFilter:\"\", NATOutgoingAddress:net.IP(nil), BPFEnabled:false, BPFForceTrackPacketsFromIfaces:[]string{\"docker+\"}, ServiceLoopPrevention:\"Drop\"}, IfaceMonitorConfig:ifacemonitor.Config{InterfaceExcludes:[]*regexp.Regexp{(*regexp.Regexp)(0xc000479c20)}, ResyncInterval:90000000000, NetlinkTimeout:10000000000}, StatusReportingInterval:0, ConfigChangedRestartCallback:(func())(0x27fadc0), FatalErrorRestartCallback:(func(error))(0x27faca0), PostInSyncCallback:(func())(0x27e9220), HealthAggregator:(*health.HealthAggregator)(0xc0006a35f0), WatchdogTimeout:90000000000, RouteTableManager:(*idalloc.IndexAllocator)(0xc000616740), DebugSimulateDataplaneHangAfter:0, ExternalNodesCidrs:[]string(nil), BPFEnabled:false, BPFPolicyDebugEnabled:true, BPFDisableUnprivileged:true, BPFKubeProxyIptablesCleanupEnabled:true, BPFLogLevel:\"off\", BPFLogFilters:map[string]string(nil), BPFCTLBLogFilter:\"\", BPFExtToServiceConnmark:0, BPFDataIfacePattern:(*regexp.Regexp)(0xc000479ae0), BPFL3IfacePattern:(*regexp.Regexp)(nil), XDPEnabled:true, XDPAllowGeneric:false, BPFConntrackTimeouts:conntrack.Timeouts{CreationGracePeriod:10000000000, TCPPreEstablished:20000000000, TCPEstablished:3600000000000, TCPFinsSeen:30000000000, TCPResetSeen:40000000000, UDPLastSeen:60000000000, GenericIPLastSeen:600000000000, ICMPLastSeen:5000000000}, BPFCgroupV2:\"\", BPFConnTimeLBEnabled:true, BPFMapRepin:false, BPFNodePortDSREnabled:false, BPFDSROptoutCIDRs:[]string(nil), BPFPSNATPorts:numorstring.Port{MinPort:0x4e20, MaxPort:0x752f, PortName:\"\"}, BPFMapSizeRoute:262144, BPFMapSizeConntrack:512000, BPFMapSizeNATFrontend:65536, BPFMapSizeNATBackend:262144, BPFMapSizeNATAffinity:65536, BPFMapSizeIPSets:1048576, BPFMapSizeIfState:1000, BPFIpv6Enabled:false, BPFHostConntrackBypass:true, BPFEnforceRPF:\"Loose\", BPFDisableGROForIfaces:(*regexp.Regexp)(nil), KubeProxyMinSyncPeriod:1000000000, SidecarAccelerationEnabled:false, LookPathOverride:(func(string) (string, error))(nil), KubeClientSet:(*kubernetes.Clientset)(0xc0007829c0), FeatureDetectOverrides:map[string]string(nil), FeatureGates:map[string]string(nil), hostMTU:0, MTUIfacePattern:(*regexp.Regexp)(0xc000479ea0), RouteSource:\"CalicoIPAM\", KubernetesProvider:0x0}\n2024-11-11 02:54:08.708 [INFO][119] felix/int_dataplane.go 1965: attempted to modprobe nf_conntrack_proto_sctp error=exit status 1 output=\"\"\n</code></pre> <p>\u770b\u8fd9\u65e5\u5fd7\u57fa\u672c\u5e76\u4e0d\u662f <code>ERROR</code> \uff0c\u6700\u540e\u63d0\u793a <code>nf_conntrack_proto_sctp</code> \u5185\u6838\u6a21\u5757\u52a0\u8f7d\u5931\u8d25\uff0c\u6211\u4ee5\u4e3a\u8fd9\u4e2a\u5c31\u662f\u62a5\u9519\u7684\u6839\u672c\u539f\u56e0\u4e86\uff0c\u7136\u540e\u5f00\u59cb\u67e5\u627e\u8fd9\u4e2a\u6a21\u5757\uff0c\u5f53\u524d\u5185\u6838\u679c\u7136\u6ca1\u6709\u5e26\u8fd9\u4e2a\u6a21\u5757\uff0c \u5c1d\u8bd5\u5b89\u88c5\u4e86 <code>linux-modules-extra</code> \u5305\uff0c\u4e5f\u6ca1\u6709\u8fd9\u4e2a\u6a21\u5757\uff0c\u7136\u540e\u53bb\u53e6\u5916\u51e0\u4e2a\u6b63\u5e38\u8fd0\u884c\u7684\u8282\u70b9\u4e0a\uff0c\u53d1\u73b0\u90fd\u6ca1\u6709\u8fd9\u4e2a\u5185\u6838\u6a21\u5757\u3002\u770b\u6765\u8fd9\u4e2a\u6a21\u5757\u5e76\u4e0d\u662f\u5fc5\u987b\u7684\uff0c\u90a3\u8fd9\u4e2a\u4fe1\u606f\u4e5f\u4e0d\u662f\u5bfc\u81f4 Calico Node \u65e0\u6cd5\u542f\u52a8\u7684\u539f\u56e0\u4e86\u3002</p> <p>\u6ca1\u76ee\u7684\u7684\u662f\u5728 Google \u4e0a\u641c\u7d22 <code>nf_conntrack_proto_sctp ubuntu 22.04</code> \uff0c\u7b2c\u4e00\u6761\u641c\u7d22\u7ed3\u679c\u6807\u9898\u5c31\u662f Calico Node keeps restarting with CrashLoopBackOff #7951 \uff0c\u9a6c\u4e0a\u70b9\u51fb\u8fdb\u53bb\u770b\u770b\u3002 \u8fd9\u662f2023\u5e748\u6708\u4efd\u7684\u4e00\u4e2a issue \uff0c\u5df2\u7ecf\u5173\u95ed\uff0c\u8ba8\u8bba\u5f97\u7684\u6bd4\u8f83\u591a, \u8ba8\u8bba\u7684\u6700\u540e\uff0c\u63d0\u51fa issue \u5f97\u4f5c\u8005\u6700\u540e\u81ea\u5df1\u89e3\u51b3\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u662f\u56e0\u4e3a SystemdCgroup \u8bbe\u7f6e\u7684\u95ee\u9898\u3002 \u7acb\u523b\u67e5\u770b\u6211\u8fd9\u8fb9\u7684 <code>/etc/containerd/config.toml</code> \u6587\u4ef6\uff0c\u679c\u7136\u8bbe\u7f6e <code>SystemdCgroup</code> \u4e3a <code>false</code>\uff0c\u7acb\u523b\u6539\u6210 <code>true</code> \u540e\uff0c\u91cd\u542f containerd \u548c kubelet \u670d\u52a1\uff0c\u7136\u540e\u5220\u9664 Calico Node \u7684 pod\uff0c\u518d\u6b21\u521b\u5efa\uff0c\u679c\u7136\u6b63\u5e38\u542f\u52a8\u4e86\u3002</p>","tags":["calico","kubernetes","network"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/","title":"\u57fa\u4e8e ELK \u7684 \u65e5\u5fd7\u6536\u96c6\u4e0e\u81ea\u52a8\u7d22\u5f15\u521b\u5efa","text":"<p>\u6587\u7ae0\u6765\u6e90\uff1a Source</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#_1","title":"\u9700\u6c42","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5c06SpringBoot\u9879\u76ee\u90e8\u7f72\u5728K8S\u4e2d\uff0c\u6b64\u65f6\u9700\u8981filebeat\u6536\u96c6\u65e5\u5fd7\u5e76\u901a\u8fc7ELK\u8fdb\u884c\u5c55\u793a\uff0c\u4ee5\u7528\u4e8e\u540e\u7eed\u7684\u95ee\u9898\u6392\u67e5\u53ca\u76d1\u63a7\u3002</p> <p>\u4e0e\u4f20\u7edf\u7684\u65e5\u5fd7\u6536\u96c6\u4e0d\u540c\uff1a</p> <ul> <li>pod\u6240\u5728\u8282\u70b9\u4e0d\u56fa\u5b9a\uff0c\u6bcf\u4e2apod\u4e2d\u8fd0\u884cfilebeat\uff0c\u914d\u7f6e\u7e41\u7410\u4e14\u6d6a\u8d39\u8d44\u6e90\uff1b</li> <li>pod\u7684\u65e5\u5fd7\u76ee\u5f55\u4e00\u822c\u4ee5emptydir\u65b9\u5f0f\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\uff0c\u76ee\u5f55\u4e0d\u56fa\u5b9a\uff0cfilebeat\u65e0\u6cd5\u81ea\u52a8\u5339\u914d\uff1b</li> <li>pod\u6301\u7eed\u589e\u591a\uff0cfilebeat\u9700\u8981\u505a\u5230\u81ea\u52a8\u68c0\u6d4b\u5e76\u6536\u96c6\uff1b</li> </ul> <p>\u56e0\u6b64\u6700\u597d\u7684\u6536\u96c6\u65b9\u5f0f\u4e3anode\u8282\u70b9\u4e0a\u7684\u4e00\u4e2afilebeat\u80fd\u591f\u6536\u96c6\u6240\u6709\u7684pod\u65e5\u5fd7\uff0c\u4f46\u662f\u8fd9\u5c31\u8981\u6c42<code>\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u89c4\u5219\u3001\u76ee\u5f55\u4ee5\u53ca\u8f93\u51fa\u65b9\u5f0f</code>\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5c31\u6309\u8fd9\u4e2a\u601d\u8def\u8fdb\u884c\u601d\u8003\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#_2","title":"\u65e5\u5fd7\u76ee\u5f55","text":"<p>K8S\u4e2d\u7684\u65e5\u5fd7\u76ee\u5f55\u6709\u4ee5\u4e0b\u4e09\u79cd\uff1a</p> <ul> <li>/var/lib/docker/containers/</li> <li>/var/log/containers/</li> <li>/var/log/pods/</li> </ul> <p>\u4e3a\u4ec0\u4e48\u4f1a\u6709\u8fd9\u4e09\u79cd\u76ee\u5f55\u5462\uff1f\u8fd9\u5c31\u8981\u4ece\u5bb9\u5668\u8fd0\u884c\u65f6\uff08Container Runtime\uff09\u7ec4\u4ef6\u8bf4\u8d77\u4e86\uff1a</p> <ul> <li>\u5f53Docker \u4f5c\u4e3a k8s \u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u5bb9\u5668\u65e5\u5fd7\u7684\u843d\u76d8\u5c06\u7531 docker \u6765\u5b8c\u6210\uff0c\u4fdd\u5b58\u5728/var/lib/docker/containers/$CONTAINERID \u76ee\u5f55\u4e0b\u3002Kubelet \u4f1a\u5728 /var/log/pods \u548c /var/log/containers \u4e0b\u5efa\u7acb\u8f6f\u94fe\u63a5\uff0c\u6307\u5411 /var/lib/docker/containers/CONTAINERID \u8be5\u76ee\u5f55\u4e0b\u7684\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3002</li> <li>\u5f53Containerd \u4f5c\u4e3a k8s \u5bb9\u5668\u8fd0\u884c\u65f6\uff0c \u5bb9\u5668\u65e5\u5fd7\u7684\u843d\u76d8\u7531 Kubelet \u6765\u5b8c\u6210\uff0c\u4fdd\u5b58\u81f3 /var/log/pods/$CONTAINER_NAME \u76ee\u5f55\u4e0b\uff0c\u540c\u65f6\u5728 /var/log/containers \u76ee\u5f55\u4e0b\u521b\u5efa\u8f6f\u94fe\u63a5\uff0c\u6307\u5411\u65e5\u5fd7\u6587\u4ef6\u3002</li> </ul> <pre><code>    # 1.\u67e5\u770b/var/log/containers\u76ee\u5f55\u4e0b\u6587\u4ef6\uff0c\u5df2\u88ab\u8f6f\u94fe\u5230/var/log/pods\u4e2d\u7684xx.log\u6587\u4ef6\u6309\n    # cd /var/log/containers &amp;&amp; ll\n    lrwxrwxrwx 1 root root 107 Jun 15 15:39 kube-apiserver-uvmsvr-3-217_kube-system_kube-apiserver-7fbb97008724e35427262c1ac294c24d7771365b9facf5f5a49c6b15f032e441.log -&gt; /var/log/pods/kube-system_kube-apiserver-uvmsvr-3-217_837ea80229ea9cd5bbf448f4f0386cbc/kube-apiserver/1.log\n    lrwxrwxrwx 1 root root 107 Aug 21 11:39 kube-apiserver-uvmsvr-3-217_kube-system_kube-apiserver-fd8b454b07b8701045f007bd55551aae60f376d1aee07729779ec516ea505239.log -&gt; /var/log/pods/kube-system_kube-apiserver-uvmsvr-3-217_837ea80229ea9cd5bbf448f4f0386cbc/kube-apiserver/2.log\n\n    ...\u53ea\u5217\u4e3e\u90e8\u5206...\n\n    # 2.\u67e5\u770b/var/log/pods\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6,xx.log \u6700\u7ec8\u53c8\u8f6f\u94fe\u5230/var/lib/docker/containers/ \u4e0b\u7684xxx-json.log\n    # cd /var/log/pods\n    ll /var/log/pods/kube-system_kube-apiserver-uvmsvr-3-217_837ea80229ea9cd5bbf448f4f0386cbc/kube-apiserver/1.log\n    lrwxrwxrwx 1 root root 165 Jun 15 15:39 /var/log/pods/kube-system_kube-apiserver-uvmsvr-3-217_837ea80229ea9cd5bbf448f4f0386cbc/kube-apiserver/1.log -&gt; /var/lib/docker/containers/7fbb97008724e35427262c1ac294c24d7771365b9facf5f5a49c6b15f032e441/7fbb97008724e35427262c1ac294c24d7771365b9facf5f5a49c6b15f032e441-json.log\n</code></pre> <p>\u65e0\u8bbak8s\u4f7f\u7528\u54ea\u79cd\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u6700\u7ec8\u7684\u65e5\u5fd7\u90fd\u662f\u8bfb\u53d6\u7684<code>xxx-json.log</code>\uff0c\u662f\u7531\u5bb9\u5668\u4ee5json\u683c\u5f0f<code>stdout</code>\u8f93\u51fa\u7684\uff0c\u4e86\u89e3\u8fd9\u4e9b\u540e\u6211\u4eec\u5f97\u5230\u4e86<code>\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u89c4\u5219</code>\uff1a</p> <ul> <li>\u7edf\u4e00\u76ee\u5f55 \uff1a/var/log/containers</li> <li>\u7edf\u4e00\u7684\u8f93\u51fa\u65b9\u5f0f\uff1astdout</li> <li>\u7edf\u4e00\u7684\u65e5\u5fd7\u683c\u5f0f\uff1ajson</li> </ul>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#filebeat","title":"filebeat","text":"<p>\u5728\u660e\u786e\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u89c4\u5219\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528DaemonSet\u8fd0\u884cfilebeat\uff0c\u6536\u96c6k8s\u7684\u6240\u6709pod\u65e5\u5fd7\u3002</p> <p>ELK\u5b98\u65b9\u63d0\u4f9bfilebeat\u5728k8s\u4e2d\u7684\u8fd0\u884c\u914d\u7f6e\u6587\u4ef6\u3002</p> <pre><code>    # \u4e0b\u8f7d\u6587\u4ef6\n    curl -L -O https://raw.githubusercontent.com/elastic/beats/7.9/deploy/kubernetes/filebeat-kubernetes.yaml\n</code></pre> <p>\u5176\u4e2dfilebeat\u7684\u914d\u7f6e\u6587\u4ef6\u4ee5<code>configmap</code>\u7684\u65b9\u5f0f\u6302\u8f7d\u81f3\u5bb9\u5668\u7684<code>/etc/filebeat.yml</code>,\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u4fee\u6539configmap\u5c31\u53ef\u4ee5\u5b9e\u73b0\u914d\u7f6e\u6587\u4ef6\u7684\u4fee\u6539\u3002</p> <p>\u9ed8\u8ba4\u7684filebeat-kubernetes.yaml\u867d\u7136\u80fd\u591f\u5b9e\u73b0pod\u65e5\u5fd7\u7684\u6536\u96c6\uff0c\u4f46\u662f\u6700\u7ec8\u5728ELK\u5c55\u793a\u65f6\u4f1a\u6709\u591a\u4f59\u5b57\u6bb5\u6216\u5b57\u6bb5\u4e0d\u5168\u7684\u73b0\u8c61\uff0c\u5982\uff1a    \u5176\u4e2dhost\u5b57\u6bb5\u3001agent\u5b57\u6bb5\u6211\u4eec\u4e0d\u9700\u8981\uff0c\u4fdd\u7559\u5c06\u4f1a\u589e\u52a0\u5b58\u50a8\u5f00\u9500\uff0c\u800c\u4e14\u6ca1\u6709\u5173\u4e8eK8S\u7684\u63cf\u8ff0\u4fe1\u606f\uff0c\u5982namespace\u3001node\u8282\u70b9\u4fe1\u606f\u3001image\u4fe1\u606f\u7b49\u662f\u4e0d\u663e\u793a\u7684\u3002\u56e0\u6b64\u6211\u4eec\u8fd8\u9700\u8981\u57fa\u4e8e\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u5fae\u8c03\uff0c\u6765\u83b7\u5f97\u6211\u4eec\u9700\u8981\u7684\u65e5\u5fd7\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#1k8s","title":"1.\u6dfb\u52a0k8s\u63cf\u8ff0\u4fe1\u606f","text":"<p>k8s\u63cf\u8ff0\u4fe1\u606f\u9ed8\u8ba4\u4e0d\u6dfb\u52a0\uff0c\u53ef\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5f00\u542f\uff1a</p> <pre><code>    processors:\n      - add_kubernetes_metadata:\n          default_indexers.enabled: true\n          default_matchers.enabled: true\n</code></pre> <p>\u6548\u679c\u5982\u4e0b\uff1a    \u6b64\u65f6pod\u7684\u57fa\u672c\u4fe1\u606f\u90fd\u5c06\u4f1a\u5728ELK\u4e2d\u5c55\u793a\uff0c\u5bf9\u6211\u4eec\u6392\u67e5\u95ee\u9898\u975e\u5e38\u4fbf\u5229\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#2","title":"2.\u5220\u9664\u591a\u4f59\u5b57\u6bb5","text":"<p>\u9ed8\u8ba4\u6536\u96c6\u7684\u5b57\u6bb5\u5305\u62echost\uff0cagent\u7b49\u65e0\u7528\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\u8fdb\u884c\u5220\u9664\u3002</p> <pre><code>    processors:\n      - drop_fields:\n        #\u5220\u9664\u7684\u591a\u4f59\u5b57\u6bb5\n        fields: [\"host\", \"tags\", \"ecs\", \"log\", \"prospector\", \"agent\", \"input\", \"beat\", \"offset\"]\n        ignore_missing: true\n</code></pre> <p>\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7drop_fields\u5220\u9664\u591a\u4f59\u7684\u5b57\u6bb5\uff0c\u4f46\u662f<code>@timestamp</code>\u548c<code>type</code>\u4e0d\u80fd\u88ab\u5220\u9664\u7684\u3002\u7ecf\u8fc7\u6d4b\u8bd5<code>ecs</code>\u3001<code>agent</code>\u3001<code>tags</code>\u4e5f\u672a\u80fd\u901a\u8fc7filbebeat\u5220\u9664\u3002</p> <p>\u6ce8\u610f\uff1a\u4e00\u4e2afilebeat.yml\u53ef\u80fd\u7531\u591a\u4e2aprocessors\uff0c\u5982\u679c\u4f60\u5728\u5176\u4e2d\u4e00\u4e2aprocessors\u4e2d\u8bbe\u7f6e\u4e86drop_fields\uff0c\u800c\u5728\u5176\u4ed6processors\u6ca1\u6709\u8bbe\u7f6e\uff0c\u5219\u6700\u7ec8\u53ef\u80fd\u5bfc\u81f4\u9700\u8981\u5220\u9664\u7684\u5b57\u6bb5\u88ab\u5220\u9664\u540e\u53c8\u81ea\u52a8\u6dfb\u52a0\u3002</p> <p>\u5bf9\u4e8e\u672a\u5220\u9664\u7684\u5b57\u6bb5\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7logstash\u8fdb\u884c\u5220\u9664\uff0c\u4f8b\u5982\uff1a</p> <pre><code>    remove_field =&gt; [ \"agent\" ]\n    remove_field =&gt; [ \"ecs\" ]\n    remove_field =&gt; [ \"tags\" ]\n</code></pre>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#3","title":"3.\u591a\u884c\u5408\u5e76","text":"<p>\u5bf9\u4e8espringboot\u65e5\u5fd7\uff0c\u6211\u4eec\u4e00\u822c\u9700\u8981\u5c06\u65e5\u5fd7\u62c6\u5206\u6210\u65f6\u95f4\u6233\u3001\u65e5\u5fd7\u7ea7\u522b\u3001\u4fe1\u606f\u5185\u5bb9\uff1b\u5bf9\u4e8eERROR\u7ea7\u522b\u65e5\u5fd7\u8fd8\u8981\u591a\u884c\u5408\u5e76\uff0c\u4ee5\u4fbf\u53cb\u597d\u7684\u5c55\u793a\u9519\u8bef\u4fe1\u606f\u3002  \u5728filebeat\u4e2d\u8bbe\u7f6e\u5c06\u6bcf\u884c\u5f00\u5934\u65f6\u95f4\u683c\u5f0f\u4e3a<code>2020-09-06</code>\u4e0e\u4e4b\u540e\u4e0d\u5339\u914d\u6b64\u89c4\u5219\u7684\u884c\u8fdb\u884c\u5408\u5e76\u3002</p> <pre><code>    multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'\n    multiline.negate: true\n    multiline.match: after\n    multiline.timeout: 30\n</code></pre>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#4message","title":"4.message\u5b57\u6bb5\u62c6\u5206","text":"<p>\u9ed8\u8ba4filebeat\u6536\u96c6\u7684\u65e5\u5fd7\u4ee5json\u683c\u5f0f\u5b58\u50a8\uff0c\u65e5\u5fd7\u5185\u5bb9\u5b58\u50a8\u4e3amessage\uff0c\u56e0\u6b64\u9700\u8981\u5728logstash\u4e2d\u8fc7\u6ee4message\u5e76\u5c06\u5176\u62c6\u5206\u540e\u518d\u5199\u5165elasticsearch\u3002</p> <pre><code>  grok {\n    match =&gt; { \"message\" =&gt; \"(%{TIMESTAMP_ISO8601:logdatetime}  %{LOGLEVEL:level} %{GREEDYDATA:logmessage})|%{GREEDYDATA:logmessage}\" }\n  }\n</code></pre> <p>\u5c06message\u4e2d\u7684\u65e5\u5fd7\u5185\u5bb9\u518d\u62c6\u5206\u4e3a\u65f6\u95f4\u3001\u65e5\u5fd7\u7ea7\u522b\u3001\u4fe1\u606f\u5185\u5bb9\u7b49\u5b57\u6bb5\uff0c\u4ee5\u4fbf\u5728ELK\u4e2d\u8fdb\u884c\u641c\u7d22\u3002  \u6548\u679c\u4e3a\uff1a    \u6ce8\u610f\uff1a<code>stream\uff1astdout</code>\u8868\u793a\u65e5\u5fd7\u4ee5stdout\u8f93\u51fa\u5230json\u683c\u5f0f\u7684\u65e5\u5fd7\u4e2d\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#logstash","title":"logstash\u81ea\u52a8\u521b\u5efa\u7d22\u5f15","text":"<p>logstash\u5c06filebeat\u6536\u96c6\u7684\u65e5\u5fd7\u8f93\u51fa\u5230elasticsearch\u5e76\u521b\u5efa\u7d22\u5f15\u3002\u5bf9\u4e8e\u4e0d\u65ad\u589e\u591a\u7684pod\uff0c\u6211\u4eec\u4e0d\u53ef\u80fd\u6328\u4e2a\u53bb\u624b\u52a8\u81ea\u5b9a\u4e49\u7d22\u5f15\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u5c31\u662f<code>logstash\u6839\u636efilebeat\u7684\u5b57\u6bb5\u81ea\u52a8\u521b\u5efa\u7d22\u5f15</code>\u3002</p> <p>\u9ed8\u8ba4logstash\u901a\u8fc7metadata\u4e2d\u7684\u5b57\u6bb5\u81ea\u52a8\u521b\u5efa\u7d22\u5f15\uff0c\u5982\uff1a</p> <pre><code>    output {\n      if [fields][service] == \"k8s-log\" {\n        elasticsearch {\n          hosts =&gt; [\"192.168.3.101:9200\"]\n          index =&gt; \"%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}\"\n        }\n        # \u53ef\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\uff0c\u67e5\u770bmetadata\u4fe1\u606f\n        # stdout { codec =&gt; rubydebug { metadata =&gt; true}}\n      }\n    }\n</code></pre> <p>\u6b64\u65f6\u5728elasticsearch\u4e2d\u81ea\u52a8\u521b\u5efa\u7684\u7d22\u5f15\u4e3a<code>filebeat-7.9-2020.09.06</code>\uff0c\u56e0\u4e3a\u901a\u8fc7stdout\u6253\u5370\u7684metadata\u5185\u5bb9\u4e3a\uff1a</p> <pre><code>    {\n        ....,\n        \"@metadata\" =&gt; {\n            \"beat\" =&gt; \"filebeat\",\n            \"version\" =&gt; \"7.9\"\n        }\n    }\n</code></pre> <p>\u6ce8\u610f\uff1a  metadata\u4fe1\u606f\u4e0d\u4f5c\u4e3a\u6700\u7ec8\u7684\u4fe1\u606f\u5728ELK\u4e2d\u5c55\u793a,\u65e2\u53ef\u4ee5\u51cf\u5c11logstash\u914d\u7f6e\u6587\u4ef6\u7684\u590d\u6742\u6027\uff08\u907f\u514d\u8c03\u7528remove_field\uff09\uff0c\u4e5f\u53ef\u4ee5\u51cf\u5c11\u8f93\u51fa\u4e2d\u7684\u4e00\u4e9b\u4e0d\u5fc5\u8981\u7684\u6570\u636e\u3002</p> <p>\u7531\u4e8elogtash\u901a\u8fc7metadata\u521b\u5efa\u7684<code>filebeat-7.9-2020-8</code>\u7d22\u5f15\u662f\u56fa\u5b9a\u7684\uff0c\u56e0\u6b64\u6536\u96c6\u7684k8s\u4e2d\u6240\u6709\u7684pod\u65e5\u5fd7\u90fd\u5c06\u5199\u5165\u8fd9\u4e2a\u7d22\u5f15\u3002</p> <p>\u601d\u8003\uff1alogstash\u662f\u5426\u53ef\u4ee5\u6839\u636efilebeat\u7684\u5b57\u6bb5\u81ea\u52a8\u521b\u5efa\u7d22\u5f15\uff0c\u8fd9\u6837\u5c06\u65e5\u5fd7\u5199\u5165\u4e0d\u540c\u7684\u7d22\u5f15\u4e86\u3002</p> <p>\u56e0\u6b64\u6211\u5c1d\u8bd5\u6839\u636epod\u7684\u547d\u540d\u7a7a\u95f4\u548cpod\u6807\u7b7e\u81ea\u52a8\u521b\u5efa\u7d22\u5f15\u3002</p> <pre><code>    output {\n      if [fields][service] == \"k8s-log\" {\n        elasticsearch {\n          hosts =&gt; [\"192.168.3.101:9200\"]\n          index =&gt; \"k8s-%{[kubernetes][namespace]}-%{[kubernetes][labels][app]}-%{+YYYY.MM.dd}\"\n          #user =&gt; \"elastic\"\n          #password =&gt; \"changeme\"\n        }\n        #stdout { codec =&gt; rubydebug { metadata =&gt; true}}\n      }\n    }\n</code></pre> <p>\u6700\u7ec8\u521b\u5efa\u7684\u7d22\u5f15\u4e3a<code>k8s-test-helloworld-2020.09.06</code>\uff0c\u5b9e\u73b0\u81ea\u52a8\u521b\u5efa\u7d22\u5f15\u7684\u9700\u6c42\u4e86\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#_3","title":"\u6700\u7ec8\u6574\u5408","text":"","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#1filebeat","title":"1.filebeat","text":"<pre><code>    # 1.\u4e0b\u8f7d\u521d\u59cb\u914d\u7f6e\u6587\u4ef6\n    curl -L -O https://raw.githubusercontent.com/elastic/beats/7.9/deploy/kubernetes/filebeat-kubernetes.yaml\n\n    # 2.\u4fee\u6539configmap\n    apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: filebeat-config\n      namespace: kube-system\n      labels:\n        k8s-app: filebeat\n    data:\n      filebeat.yml: |-\n        filebeat.inputs:\n        - type: container\n          paths:\n            - /var/log/containers/api-*.log\n\n          #\u591a\u884c\u5408\u5e76\n          multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'\n          multiline.negate: true\n          multiline.match: after\n          multiline.timeout: 30\n          fields:\n            #\u81ea\u5b9a\u4e49\u5b57\u6bb5\u7528\u4e8elogstash\u8bc6\u522bk8s\u8f93\u5165\u7684\u65e5\u5fd7\n            service: k8s-log\n\n          #\u7981\u6b62\u6536\u96c6host.xxxx\u5b57\u6bb5 \n          #publisher_pipeline.disable_host: true\n          processors:\n            - add_kubernetes_metadata:\n                #\u6dfb\u52a0k8s\u63cf\u8ff0\u5b57\u6bb5\n                default_indexers.enabled: true\n                default_matchers.enabled: true\n                host: ${NODE_NAME}\n                matchers:\n                - logs_path:\n                    logs_path: \"/var/log/containers/\"\n            - drop_fields:\n                #\u5220\u9664\u7684\u591a\u4f59\u5b57\u6bb5\n                fields: [\"host\", \"tags\", \"ecs\", \"log\", \"prospector\", \"agent\", \"input\", \"beat\", \"offset\"]\n                ignore_missing: true\n        output.redis:\n          hosts: [\"192.168.3.44\"]\n          #password: \"\"\n          key: \"k8s-java-log_test\"\n          db: 1\n          timeout: 5\n        #output.logstash:\n        #  hosts: [\"192.168.3.101:5044\"]\n</code></pre>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#2-logstash","title":"2. logstash","text":"<pre><code>    input {\n      beats {\n        port =&gt; 5044\n      }\n      redis {\n        host =&gt; \"192.168.3.44\"\n        port =&gt; \"6379\"\n        db =&gt; 1\n        data_type =&gt; \"list\"\n        key =&gt; \"k8s-java-log_test\"\n        type =&gt; \"k8s-log\"\n      }\n    }\n\n    filter {\n      if [type] == \"k8s-log\" {\n        grok {\n          match =&gt; { \"message\" =&gt; \"(%{TIMESTAMP_ISO8601:logdatetime}  %{LOGLEVEL:level} %{GREEDYDATA:logmessage})|%{GREEDYDATA:logmessage}\" }\n          remove_field =&gt; [ \"message\" ]\n          remove_field =&gt; [ \"agent\" ]\n          remove_field =&gt; [ \"ecs\" ]\n          remove_field =&gt; [ \"tags\" ]\n        }\n      }\n    }\n\n    output {\n      if [fields][service] == \"k8s-log\" {\n        elasticsearch {\n          hosts =&gt; [\"192.168.3.101:9200\"]\n          index =&gt; \"k8s-%{[kubernetes][namespace]}-%{[kubernetes][labels][app]}-%{+YYYY.MM.dd}\"\n        }\n        #stdout { codec =&gt; rubydebug { metadata =&gt; true}}\n      }\n    }\n</code></pre> <p>\u6700\u7ec8\u6548\u679c\u5982\u4e0b\uff1a  </p>","tags":["elk","kubernetes"]},{"location":"kubernetes/collect-k8s-log-with-filebeat/#_4","title":"\u603b\u7ed3","text":"<p>\u521a\u5f00\u59cb\u60f3\u5230pod\u7684\u7279\u6027\u65f6\uff0c\u6700\u521d\u60f3\u5230\u4f7f\u7528sidecar\u6a21\u5f0f\uff0c\u5373\u6bcf\u4e2apod\u4e2d\u90fd\u8fd0\u884c\u4e00\u4e2afilebeat\u8fdb\u884c\u65e5\u5fd7\u6536\u96c6\uff0c\u7684\u786e\u6bd4\u8f83\u8017\u8d39\u8d44\u6e90\u3002\u7ecf\u8fc7\u9605\u8bfb\u4e86\u5b98\u65b9\u7684k8s\u90e8\u7f72\u4ee5\u53cak8s\u7684\u51e0\u4e2a\u65e5\u5fd7\u76ee\u5f55\uff0c\u624d\u786e\u5b9aDaemonSet\u90e8\u7f72filebeat\u624d\u662f\u6700\u4f18\u65b9\u6848\u3002</p> <p>\u53e6\u5916\uff0c\u8fd8\u5c1d\u8bd5\u4f7f\u7528\u963f\u91cc\u5f00\u6e90\u7684log-pilot\uff0c\u4f46\u6700\u7ec8\u8fd8\u662f\u9009\u62e9\u4e86ELK\u5b98\u65b9\u7684\u90e8\u7f72\u3002</p>","tags":["elk","kubernetes"]},{"location":"kubernetes/coredns-support-hosts-file/","title":"CoreDNS \u652f\u6301\u89e3\u6790\u5bbf\u4e3b\u673a\u7684 hosts \u6587\u4ef6","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c CoreDNS \u4e0d\u652f\u6301\u8282\u70b9\u7684 <code>/etc/hosts</code> \u6587\u4ef6\u91cc\u7684\u9759\u6001\u57df\u540d\u89e3\u6790\u3002\u9700\u8981\u4fee\u6539 <code>coredns</code> \u7684 <code>configmap</code> \u914d\u7f6e\uff0c\u75c5\u5728 <code>coredns</code> \u589e\u52a0\u8282\u70b9 <code>/etc/hosts</code> \u7684\u6302\u8f7d\u3002</p> <p>\u767b\u5f55\u4efb\u610f\u4e00\u53f0\u63a7\u5236\u5e73\u9762\u4e3b\u673a\uff0c\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c</p>","tags":["kubernetes","coredns"]},{"location":"kubernetes/coredns-support-hosts-file/#corednsconfigmap","title":"\u4fee\u6539coredns\u7684configMap","text":"<p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <pre><code>kubectl -n kube-system edit configmap coredns\n</code></pre> <p>\u5728 <code>health</code> \u5185\u5bb9\u7684\u540e\u9762\u589e\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>hosts /etc/add_hosts {\n    fallthrough\n}\n</code></pre> <p>\u5b8c\u6574\u7684\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        hosts /etc/add_hosts {\n           fallthrough\n        }\n        ready\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2022-01-26T03:29:22Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"227\"\n  uid: 5a1bacdf-0f57-4306-95a0-9f3fe967a921\n</code></pre>","tags":["kubernetes","coredns"]},{"location":"kubernetes/coredns-support-hosts-file/#corednsdeployment","title":"\u4fee\u6539coredns\u7684deployment","text":"<p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>kubectl edit deployment -n kube-system coredns\n</code></pre> <p>\u5728 <code>volumeMounts:</code> \u8fd9\u4e00\u884c\u4e0b\u589e\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>        - mountPath: /etc/add_hosts\n          name: add-hosts\n</code></pre> <p>\u5728 <code>volumes:</code> \u8fd9\u4e00\u884c\u4e0b\u589e\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>      - hostPath:\n          path: /etc/hosts\n          type: \"\"\n        name: add-hosts\n</code></pre> <p>\u5b8c\u6574\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  annotations:\n    deployment.kubernetes.io/revision: \"1\"\n  creationTimestamp: \"2022-01-26T03:29:22Z\"\n  generation: 1\n  labels:\n    k8s-app: kube-dns\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"640\"\n  uid: b1cf8b75-e995-43fe-8117-858e8e086e3d\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 2\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      k8s-app: kube-dns\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        k8s-app: kube-dns\n    spec:\n      containers:\n      - args:\n        - -conf\n        - /etc/coredns/Corefile\n        image: k8s.gcr.io/coredns/coredns:v1.8.6\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          failureThreshold: 5\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 5\n        name: coredns\n        ports:\n        - containerPort: 53\n          name: dns\n          protocol: UDP\n        - containerPort: 53\n         name: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\n          name: metrics\n          protocol: TCP\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /ready\n            port: 8181\n            scheme: HTTP\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        resources:\n          limits:\n            memory: 170Mi\n          requests:\n            cpu: 100m\n            memory: 70Mi\n        securityContext:\n          allowPrivilegeEscalation: false\n          capabilities:\n            add:\n            - NET_BIND_SERVICE\n            drop:\n            - all\n          readOnlyRootFilesystem: true\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /etc/coredns\n          name: config-volume\n          readOnly: true\n        - mountPath: /etc/add_hosts\n          name: add-hosts\n      dnsPolicy: Default\n      nodeSelector:\n        kubernetes.io/os: linux\n      priorityClassName: system-cluster-critical\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext: {}\n      serviceAccount: coredns\n      serviceAccountName: coredns\n      terminationGracePeriodSeconds: 30\n      tolerations:\n      - key: CriticalAddonsOnly\n        operator: Exists\n      - effect: NoSchedule\n        key: node-role.kubernetes.io/master\n      - effect: NoSchedule\n        key: node-role.kubernetes.io/control-plane\n      volumes:\n      - configMap:\n          defaultMode: 420\n          items:\n          - key: Corefile\n            path: Corefile\n          name: coredns\n        name: config-volume\n      - hostPath:\n          path: /etc/hosts\n          type: \"\"\n        name: add-hosts\nstatus:\n  availableReplicas: 2\n  conditions:\n  - lastTransitionTime: \"2022-01-26T03:29:55Z\"\n    lastUpdateTime: \"2022-01-26T03:29:55Z\"\n    message: Deployment has minimum availability.\n    reason: MinimumReplicasAvailable\n    status: \"True\"\n    type: Available\n  - lastTransitionTime: \"2022-01-26T03:29:37Z\"\n    lastUpdateTime: \"2022-01-26T03:29:55Z\"\n    message: ReplicaSet \"coredns-64897985d\" has successfully progressed.\n    reason: NewReplicaSetAvailable\n    status: \"True\"\n    type: Progressing\n  observedGeneration: 1\n  readyReplicas: 2\n  replicas: 2\n  updatedReplicas: 2\n</code></pre>","tags":["kubernetes","coredns"]},{"location":"kubernetes/coredns-support-hosts-file/#_1","title":"\u9a8c\u8bc1","text":"<p>\u5728\u6240\u6709 k8s \u8282\u70b9\u7684 <code>/etc/hosts</code> \u6587\u4ef6\u91cc\u589e\u52a0\u4e00\u6761 IP \u5730\u5740\u6620\u5c04\uff0c\u7136\u540e\u767b\u5f55\u4efb\u610f\u4e00\u4e2a pod\uff0c \u7136\u540e ping \u6dfb\u52a0\u5230 <code>/etc/hosts</code> \u7684\u6620\u5c04\u4e3b\u673a\uff0c\u770b\u662f\u5426\u89e3\u6790\u6210\u521a\u624d\u589e\u52a0\u7684 IP \u5730\u5740\u3002</p>","tags":["kubernetes","coredns"]},{"location":"kubernetes/deep-dive-into-k8s-internals/","title":"\u7528\u5947\u602a\u7684\u65b9\u5f0f\u6784\u5efa\u7b80\u5355 k8s \u96c6\u7fa4","text":"","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_1","title":"\u524d\u8a00","text":"<p>\u8fd9\u4e2a\u5e16\u5b50\u7684\u521b\u5efa\u6765\u6e90\u4e8e youtube \u7684\u4e00\u4e2a\u89c6\u9891 \uff0c\u8fd9\u4e2a\u89c6\u9891\u4ecb\u7ecd\u5982\u4f55\u5feb\u901f\u90e8\u7f72\u4e00\u4e2ak8s\u96c6\u7fa4\u5f88\u6709\u65b0\u610f\uff0c\u4ed6\u6ca1\u6709\u4f7f\u7528\u5e38\u89c1\u7684minkube\u6216\u8005kubeadm\u8fd9\u79cd\u65b9\u5f0f\u6765\u521b\u5efa\u5b8c\u6574\u7684\u96c6\u7fa4\uff0c\u4e5f\u4e0d\u662f\u4ece\u6e90\u4ee3\u7801\u5f00\u59cb\u4ece\u5934\u64b8\u8d77\uff0c\u540c\u65f6\u4e5f\u6ca1\u6709\u8bf4\u8981\u5148\u642d\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u96c6\u7fa4\uff0c\u7136\u540e\u6f14\u793a\u57fa\u672c\u64cd\u4f5c\u3002 \u4ed6\u5148\u5957\u8def\u5f0f\u7684\u752819\u5f20\u56fe\u8bf4\u4e86\u521b\u5efa\u4e00\u4e2adeployment \u65f6k8s\u96c6\u7fa4\u7684\u5185\u90e8\u673a\u5236\uff0c\u4e00\u822c\u5230\u8fd9\u91cc\u5df2\u7ecf\u5f88\u6e05\u695a\u4e86\u89e3\u5185\u90e8\u7ec4\u4ef6\u7684\u4e92\u64cd\u4f5c\u8fc7\u7a0b\u4e86\u3002\u7136\u540e\u4f5c\u8005\u73b0\u573a\u767b\u5f55\u4e00\u53f0\u670d\u52a1\u5668\uff0c\u5f00\u59cb\u4efb\u610f\u7684\u4ece\u4e00\u4e2a\u670d\u52a1\u8fd0\u884c\u5f00\u59cb\uff0c\u6bd4\u5982\u4ed6\u5148\u8fd0\u884c kube-apiserver\uff0c\u90a3\u80af\u5b9a\u4f1a\u62a5\u9519\uff0c\u4e8e\u662f\u6839\u636e\u62a5\u9519\u6765\u89e3\u51b3\u95ee\u9898\uff0c\u6bcf\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\uff0c\u4ed6\u5c31\u5c1d\u8bd5\u521b\u5efa deployment \uff0c\u7136\u540e\u7ee7\u7eed\u6839\u636e\u62a5\u9519\u6765\u89e3\u51b3\u95ee\u9898\u3002\u76f4\u5230\u6700\u540e\u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u5355\u8282\u70b9\u96c6\u7fa4\uff0c\u8fd9\u4e2a\u6f14\u793a\u5de5\u7a0b\u8ba9\u4f60\u5bf9k8s \u4e2a\u7ec4\u4ef6\u8282\u70b9\u7684\u5173\u7cfb\uff0c\u6709\u4e86\u66f4\u6df1\u523b\u7684\u7406\u89e3\u3002</p> <p>\u56e0\u4e3a\u4ed6\u662f\u73b0\u573a\u5f88\u5feb\u6f14\u793a\uff0c\u4e8e\u662f\u6211\u6253\u7b97\u8fd9\u590d\u523b\u8fd9\u4e2a\u8fc7\u7a0b\u3002\u4f5c\u8005\u7528 19 \u5f20\u5e7b\u706f\u7247\u6f14\u793a\u4e86\u4e00\u4e2a deployment \u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u6211\u628a\u8fd9\u4e2a\u6f14\u793a\u8fc7\u7a0b\u6574\u7406\u6210\u4e86\u4e00\u4e2a\u65f6\u5e8f\u56fe\u3002</p> <pre><code>sequenceDiagram\n    participant User\n    participant API Server\n    participant Etcd\n    participant Scheduler\n    participant Kubelet\n    participant Docker\n\n    User-&gt;&gt;API Server: create deployment\n    activate API Server\n    API Server-&gt;&gt;Etcd: write\n    activate Etcd\n    Etcd --&gt;&gt; API Server: OK\n    deactivate Etcd\n    API Server --&gt;&gt;User: OK\n    deactivate API Server\n\n    API Server -&gt;&gt; Scheduler: watcher - API Server(new pod)\n    activate Scheduler\n    Scheduler -&gt;&gt; API Server: bind pod\n    activate API Server\n    API Server -&gt;&gt; Etcd: write\n    activate Etcd\n    Etcd --&gt;&gt; API Server: OK\n    deactivate Etcd\n    API Server --&gt;&gt; Scheduler: OK\n    deactivate API Server\n    deactivate Scheduler\n\n    API Server -&gt;&gt; Kubelet: watcher - API Server(bound pod)\n    activate Kubelet\n    Kubelet -&gt;&gt; Docker: docker run\n    activate Docker\n    Docker --&gt;&gt; Kubelet: OK\n    deactivate Docker\n    Kubelet -&gt;&gt; API Server: update pod status\n    activate API Server\n    API Server -&gt; Etcd: write\n    activate Etcd\n    Etcd --&gt; API Server: OK\n    deactivate Etcd\n    API Server --&gt; Kubelet: OK\n    deactivate API Server\n    deactivate Kubelet</code></pre> <p>\u4f5c\u8005\u5728\u6784\u5efa\u8be5\u96c6\u7fa4\u7684\u76ee\u6807\u662f\u521b\u5efa\u4e00\u4e2a\u6700\u5c0f\u5316\u7684k8s\u7684\u96c6\u7fa4\uff0c\u8fd9\u4e2a\u96c6\u7fa4\u53ef\u4ee5\u5b9e\u73b0\uff1a</p> <ul> <li>\u521b\u5efa Deployment \uff08<code>kubectl run</code>\uff0c<code>kubectl create deployment</code>)</li> <li>\u7528 Service \u65b9\u5f0f\u66b4\u9732\u51fa\u53bb</li> <li>\u53ef\u4ee5\u8fde\u63a5\u8fd9\u4e2a\u670d\u52a1</li> </ul> <p>\u8fd9\u91cc\u7684 \u201c\u6700\u5c0f\u5316\u201d \u610f\u5473\u7740\uff1a</p> <ul> <li>\u6700\u5c11\u7684\u7ec4\u4ef6</li> <li>\u6700\u5c11\u7684\u547d\u4ee4\u884c\u53c2\u6570</li> <li>\u6700\u5c11\u7684\u914d\u7f6e\u6587\u4ef6</li> </ul> <p>\u540c\u65f6\uff0c\u8fd9\u4e2a\u6700\u5c0f\u5316\u96c6\u7fa4\u4e0d\u8003\u8651\u4ee5\u4e0b\u56e0\u7d20\uff1a</p> <ul> <li>\u96c6\u7fa4\u5b89\u5168\u6027</li> <li>\u96c6\u7fa4\u53ef\u6269\u5c55\u6027</li> <li>\u96c6\u7fa4\u9ad8\u53ef\u7528\u6027</li> </ul> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u5c31\u662f\u8981\u6700\u7b80\u5316</p> <p>\u7136\u540e\u5b9e\u9645\u4e0a\u5e76\u4e0d\u662f\u8fd9\u6837\uff0c\u56e0\u4e3a\u65b0\u7684\u7248\u672c\u5df2\u7ecf\u76f4\u63a5\u5e9f\u5f03\u4e86\u975e TLS \u901a\u4fe1\u6a21\u5f0f\uff0c\u8fd9\u5c31\u4f7f\u5f97\u4f5c\u8005\u5728\u6f14\u8bb2\u4e2d\u63d0\u5230\u7684\u4e0d\u8003\u8651\u5b89\u5168\u901a\u4fe1\u6ca1\u6cd5\u901a\u8fc7\u4e86\uff0c\u8fd9\u90e8\u5206\u662f\u96c6\u7fa4\u642d\u5efa\u4e2d\u6700\u4e3a\u590d\u6742\u7684\u4e00\u90e8\u5206\uff0c\u6709\u4e86\u8fd9\u90e8\u5206\u7684\u914d\u7f6e\u540e\uff0c\u5176\u5b9e\u6574\u4e2a\u90e8\u7f72\u7684\u5177\u4f53\u64cd\u4f5c\u5c31\u548c\u4f5c\u8005\u6f14\u793a\u7684\u6709\u76f8\u5f53\u5927\u7684\u4e0d\u540c\u4e86\u3002</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_2","title":"\u73af\u5883\u51c6\u5907","text":"<p>\u4f5c\u8005\u5728\u6f14\u793a\u7684\u8fc7\u7a0b\u4e2d\u51c6\u5907\u4e86\u4e24\u53f0\u666e\u901a\u914d\u7f6e\u7684\u865a\u62df\u673a\uff0c\u6211\u8fd9\u91cc\u627e\u4e86\u4e24\u53f0\u9650\u5236\u7684\u673a\u5668\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <ul> <li>\u673a\u5668\u578b\u53f7\uff1a Dell R640</li> <li>CPU: Intel(R) Xeon(R) Silver 4216 CPU @ 2.10GHz</li> <li>\u5185\u5b58\uff1a64G</li> <li>OS: CentOS 7.6</li> <li>kernel: 5.19.11</li> </ul> <p>\u4e24\u53f0\u673a\u5668\u7684 IP \u5730\u5740\u5206\u522b\u4e3a <code>10.90.23.41</code>,<code>10.90.23.42</code></p> <p>\u7136\u540e\u51c6\u5907\u9700\u8981\u7684\u8f6f\u4ef6\uff0c\u5168\u90e8\u653e\u5728 <code>/opt/k8s</code> \u76ee\u5f55\u4e0b\uff0c\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>docker ce 20.10.14</li> <li>etcd 3.5.7</li> <li>kubectl v1.23.17</li> <li>kubelet v1.23.17</li> <li>kube-controller-manager v1.23.17</li> <li>kube-proxy v1.23.17</li> <li>kube-apiserver v1.23.17</li> <li>kube-scheduler v1.23.17</li> <li>cfssl v1.6.3</li> <li>cfssljson v1.6.3</li> </ul> <p>\u5176\u4e2d <code>docker-ce</code> \u662f\u901a\u8fc7 yum \u4ed3\u5e93\u5b89\u88c5\u7684\uff0c\u5176\u4ed6\u662f\u4ece\u7ed9\u51fa\u7684\u8fde\u63a5\u4e0b\u8f7d\u7684\u3002</p> <pre><code># export ver=\"v1.23.17\"\n# for i in kubectl kubelet kube-proxy kube-apiserver kube-scheduler \n&gt; do\n&gt; wget https://dl.k8s.io/${ver}/bin/linux/amd64/${i}\n&gt; done\n# wget -O- https://storage.googleapis.com/etcd/v3.5.7/etcd-v3.5.7-linux-amd64.tar.gz |tar -xz\n# chmod +x kube* etcd*\n# tree /opt/k8s/\n/opt/k8s/\n\u251c\u2500\u2500 etcd\n\u251c\u2500\u2500 etcdctl\n\u251c\u2500\u2500 etcdutl\n\u251c\u2500\u2500 kube-apiserver\n\u251c\u2500\u2500 kubectl\n\u251c\u2500\u2500 kubelet\n\u251c\u2500\u2500 kube-proxy\n\u2514\u2500\u2500 kube-scheduler\n\n0 directories, 5 files\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_3","title":"\u521b\u5efa\u8bc1\u4e66","text":"<p>\u4ece <code>1.21</code> \u5f00\u59cb\uff0ckubernetes \u5df2\u7ecf\u7981\u7528\u4e86<code>insecure-port</code> \u53c2\u6570\uff0c\u56e0\u6b64\u96c6\u7fa4\u5fc5\u987b\u4f7f\u7528 TLS \u8bc1\u4e66\u6765\u8fdb\u884c\u901a\u8baf\uff0c\u56e0\u6b64\u5fc5\u987b\u5148\u521b\u5efa\u5404\u7ec4\u4ef6\u9700\u8981\u7684\u8bc1\u4e66\uff0c\u4e3a\u4e86\u7b80\u5316\u521b\u5efa\u8fc7\u7a0b\uff0c\u6211\u4eec\u4f7f\u7528 cloudflare \u63d0\u4f9b\u7684 cfssl \u5de5\u5177\u6765\u521b\u5efa\u3002</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#ca","title":"\u521b\u5efa CA \u8bc1\u4e66","text":"<pre><code>mkdir -p pki/{admin,api,ca,clients,controller,front-proxy,proxy,scheduler,service-account,users}\n\nexport TLS_C=\"CN\"\nexport TLS_L=\"TOWN\"\nexport TLS_OU=\"localhost\"\nexport TLS_ST=\"CITY\"\n\ncat &gt; pki/ca/ca-config.json &lt;&lt;EOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"8760h\"\n    },\n    \"profiles\": {\n      \"kubernetes\": {\n        \"usages\": [\"signing\", \"key encipherment\", \"server auth\", \"client auth\"],\n        \"expiry\": \"8760h\"\n      }\n    }\n  }\n}\nEOF\n\ncat &gt; pki/ca/ca-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"Kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"Kubernetes\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\n\ncfssl gencert -initca pki/ca/ca-csr.json | cfssljson -bare pki/ca/ca\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#tls","title":"\u521b\u5efa TLS \u8bc1\u4e66","text":"","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_4","title":"\u521b\u5efa\u7ba1\u7406\u5458\u914d\u7f6e\u6587\u4ef6\u548c\u8bc1\u4e66","text":"<pre><code>cat &gt; pki/admin/admin-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"admin\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"system:masters\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/admin/admin-csr.json | cfssljson -bare pki/admin/admin\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_5","title":"\u521b\u5efa \u8282\u70b9\u8bc1\u4e66","text":"<pre><code>cat &gt; pki/clients/node41-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:node:node41\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"system:nodes\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\nINTERNAL_IP=$(ip addr show bond0 | grep -Po 'inet \\K[\\d.]+')\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -hostname=node41,${INTERNAL_IP} \\\n  -profile=kubernetes \\\n  pki/clients/node41-csr.json | cfssljson -bare pki/clients/node41\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-controller-manager","title":"\u5e8a\u67b6 kube-controller-manager \u7ec4\u4ef6\u8bc1\u4e66","text":"<pre><code>cat &gt; pki/controller/kube-controller-manager-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/controller/kube-controller-manager-csr.json | cfssljson -bare pki/controller/kube-controller-manager\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-proxy","title":"\u521b\u5efa kube-proxy \u8bc1\u4e66","text":"<pre><code>cat &gt; pki/proxy/kube-proxy-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-proxy\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"system:node-proxier\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/proxy/kube-proxy-csr.json | cfssljson -bare pki/proxy/kube-proxy\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-scheduler","title":"\u521b\u5efa kube-scheduler \u8bc1\u4e66","text":"<pre><code>cat &gt; pki/scheduler/kube-scheduler-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/scheduler/kube-scheduler-csr.json | cfssljson -bare pki/scheduler/kube-scheduler\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#front-proxy","title":"\u521b\u5efa front-proxy \u8bc1\u4e66","text":"<pre><code>cat &gt; pki/front-proxy/front-proxy-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"front-proxy\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"front-proxy\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/front-proxy/front-proxy-csr.json | cfssljson -bare pki/front-proxy/front-proxy\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-apiserver","title":"\u521b\u5efa kube-apiserver \u8bc1\u4e66","text":"<pre><code>cat &gt; pki/api/kubernetes-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"Kubernetes\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -hostname=10.90.23.41,10.90.23.42,127.0.0.1,kubernetes.default \\\n  -profile=kubernetes \\\n  pki/api/kubernetes-csr.json | cfssljson -bare pki/api/kubernetes\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#service-account","title":"\u521b\u5efa service-account \u8bc1\u4e66","text":"<pre><code>cat &gt; pki/service-account/service-account-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"service-accounts\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"${TLS_C}\",\n      \"L\": \"${TLS_L}\",\n      \"O\": \"Kubernetes\",\n      \"OU\": \"${TLS_OU}\",\n      \"ST\": \"${TLS_ST}\"\n    }\n  ]\n}\nEOF\ncfssl gencert \\\n  -ca=pki/ca/ca.pem \\\n  -ca-key=pki/ca/ca-key.pem \\\n  -config=pki/ca/ca-config.json \\\n  -profile=kubernetes \\\n  pki/service-account/service-account-csr.json | cfssljson -bare pki/service-account/service-account\n</code></pre> <p>\u6700\u540e\u521b\u5efa\u7684\u7684\u6240\u6709\u8bc1\u4e66\u5982\u4e0b\uff1a</p> <pre><code># tree /opt/k8s/pki\n/opt/k8s/pki\n\u251c\u2500\u2500 admin\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 admin.pem\n\u251c\u2500\u2500 api\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kubernetes.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kubernetes-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kubernetes-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 kubernetes.pem\n\u251c\u2500\u2500 ca\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ca-config.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ca.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ca-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ca-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 ca.pem\n\u251c\u2500\u2500 clients\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 node41.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 node41-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 node41-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 node41.pem\n\u251c\u2500\u2500 controller\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-controller-manager.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-controller-manager-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-controller-manager-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 kube-controller-manager.pem\n\u251c\u2500\u2500 front-proxy\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 front-proxy.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 front-proxy-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 front-proxy-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 front-proxy.pem\n\u251c\u2500\u2500 proxy\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-proxy.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-proxy-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-proxy-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 kube-proxy.pem\n\u251c\u2500\u2500 scheduler\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-scheduler.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-scheduler-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kube-scheduler-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 kube-scheduler.pem\n\u251c\u2500\u2500 service-account\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 service-account.csr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 service-account-csr.json\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 service-account-key.pem\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 service-account.pem\n\u2514\u2500\u2500 users\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_6","title":"\u5f00\u59cb\u642d\u5efa","text":"<p>\u90e8\u7f72\u7684\u601d\u8def\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u5c1d\u8bd5\u542f\u52a8 <code>API Server</code></li> <li>\u5c1d\u8bd5\u521b\u5efa Deployment</li> <li>\u770b\u662f\u5426\u62a5\u9519</li> <li>\u5982\u679c\u6709\u62a5\u9519\uff0c\u5c1d\u8bd5\u4fee\u590d\uff0c\u8df3\u5230\u6b65\u9aa4 2\uff0c \u76f4\u5230\u521b\u5efa\u6210\u529f</li> </ol>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-apiserver_1","title":"\u542f\u52a8 kube-apiserver","text":"<pre><code># ./kube-apiserver\nW0320 20:30:47.651537    3927 services.go:37] No CIDR for service cluster IPs specified. Default value which was 10.0.0.0/24 is deprecated and will be removed in future releases. Please specify it using --service-cluster-ip-range on kube-apiserver.\nI0320 20:30:48.018907    3927 serving.go:342] Generated self-signed cert (/var/run/kubernetes/apiserver.crt, /var/run/kubernetes/apiserver.key)\nI0320 20:30:48.018924    3927 server.go:555] external host was not specified, using 10.90.23.41\nW0320 20:30:48.018931    3927 authentication.go:520] AnonymousAuth is not allowed with the AlwaysAllow authorizer. Resetting AnonymousAuth to false. You should use a different authorizer\nE0320 20:30:48.019080    3927 run.go:74] \"command failed\" err=\"[--etcd-servers must be specified, service-account-issuer is a required flag, --service-account-signing-key-file and --service-account-issuer are required flags]\"\n</code></pre> <p>\u62a5\u9519\u4e86\uff0c\u770b\u6700\u884c\u7684\u62a5\u9519\u4fe1\u606f\uff0c<code>--etcd-servers must be specified</code>\uff0c\u90a3\u5c31\u8981\u5148\u542f\u52a8 <code>etcd</code>\u4e86</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#etcd","title":"\u542f\u52a8 etcd","text":"<pre><code># ./etcd\n{\"level\":\"info\",\"ts\":\"2023-03-20T21:38:43.155+0800\",\"caller\":\"etcdmain/etcd.go:73\",\"msg\":\"Running: \",\"args\":[\"./etcd\"]}\n...\n{\"level\":\"info\",\"ts\":\"2023-03-20T21:38:43.960+0800\",\"caller\":\"embed/serve.go:146\",\"msg\":\"serving client traffic insecurely; this is strongly discouraged!\",\"address\":\"127.0.0.1:2379\"}\n</code></pre> <p>\u770b\u6765\u662f\u6210\u529f\u4e86\uff0c\u6ce8\u610f\u6700\u540e\u4e00\u884c\u7684\u8f93\u51fa\uff0c\u6211\u4eec\u77e5\u9053 etcd \u7684\u5730\u5740\u4e3a <code>127.0.0.1:2379</code></p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#api-server","title":"\u518d\u6b21\u542f\u52a8 API Server","text":"<pre><code># ./kube-apiserver --etcd-servers http://127.0.0.1:2379\nW0320 21:42:49.655612    9431 services.go:37] No CIDR for service cluster IPs specified. Default value which was 10.0.0.0/24 is deprecated and will be removed in future releases. Please specify it using --service-cluster-ip-range on kube-apiserver.\nI0320 21:42:49.655666    9431 server.go:555] external host was not specified, using 10.90.23.41\nW0320 21:42:49.655676    9431 authentication.go:520] AnonymousAuth is not allowed with the AlwaysAllow authorizer. Resetting AnonymousAuth to false. You should use a different authorizer\nE0320 21:42:49.655860    9431 run.go:74] \"command failed\" err=\"[service-account-issuer is a required flag, --service-account-signing-key-file and --service-account-issuer are required flags]\"\n</code></pre> <p>\u770b\u6765\u65b0\u7248\u672c\u65b0\u589e\u4e86\u5fc5\u987b\u7684\u53c2\u6570 \uff0c\u6309\u7167\u6700\u540e\u4e00\u884c\u7684\u9519\u8bef\uff0c\u6211\u4eec\u8981\u89e3\u51b3 <code>--service-account-signing-key-file</code>, <code>--service-account-issuer</code> \u4e24\u4e2a\u53c2\u6570\u95ee\u9898</p> <p>\u540c\u65f6\u6211\u4eec\u542f\u7528 <code>AnonymousAuth</code> (<code>--anonymous-auth</code>)</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_7","title":"\u7ee7\u7eed\u542f\u52a8","text":"<pre><code># ./kube-apiserver --etcd-servers http://127.0.0.1:2379 \\\n  --authorization-mode=Node,RBAC \\\n  --anonymous-auth=false \\\n  --service-account-issuer=api \\\n  --client-ca-file=/opt/k8s/pki/ca/ca.pem \\\n  --service-account-key-file=/opt/k8s/pki/service-account/service-account.pem \\\n  --service-account-signing-key-file=/opt/k8s/pki/service-account/service-account-key.pem \\\n  --tls-cert-file=/opt/k8s/pki/api/kubernetes.pem \\\n  --tls-private-key-file=/opt/k8s/pki/api/kubernetes-key.pem \\\n  --v=2\n\nW0320 22:38:19.001075   13586 services.go:37] No CIDR for service cluster IPs specified. Default value which was 10.0.0.0/24 is deprecated and will be removed in future releases. Please specify it using --service-cluster-ip-range on kube-apiserver.\nI0320 22:38:19.001131   13586 server.go:555] external host was not specified, using 10.90.23.41\nI0320 22:38:19.001706   13586 server.go:163] Version: v1.26.3\n...\nI0320 22:38:20.759381   13586 secure_serving.go:210] Serving securely on [::]:6443\nI0320 22:38:21.491867   13586 controller.go:132] OpenAPI AggregationController: action for item k8s_internal_local_delegation_chain_0000000000: Nothing (removed from the queue).\nI0320 22:38:21.763534   13586 storage_scheduling.go:111] all system priority classes are created successfully or already exist.\n</code></pre> <p>\u76ee\u524d\u6765\u770b\uff0c\u542f\u52a8\u6210\u529f\uff0c\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 TLS\uff0c\u6240\u4ee5\u7aef\u53e3\u4e0d\u662f\u9ed8\u8ba4 <code>8080</code>\uff0c\u800c\u662f\u53d8\u6210\u4e86 <code>6443</code></p> <p>\u56e0\u4e3a\u542f\u7528\u4e86 TLS\uff0c\u6240\u4ee5\u8fd8\u5f97\u521b\u5efa\u53ef\u4ee5\u53ef\u7528\u7684\u5e10\u53f7</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_8","title":"\u521b\u5efa\u5e10\u53f7","text":"<pre><code>$ mkdir /opt/k8s/client\n$ openssl genrsa -out client-key.pem 4096\n$ openssl req -new -x509 -days 365 -key client-key.pem -sha256 -batch -out client.pem\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#api-server_1","title":"\u548c API Server \u4ea4\u4e92","text":"<p>\u9996\u5148\u914d\u7f6e\u9700\u8981\u5fc5\u8981\u7684\u73af\u5883</p> <pre><code>kubectl config set-cluster localhost \\\n  --certificate-authority=pki/ca/ca.pem \\\n  --server=https://127.0.0.1:6443 \n\nkubectl config set-credentials admin \\\n  --client-certificate=pki/admin/admin.pem \\\n  --client-key=pki/admin/admin-key.pem \n\n\nkubectl config set-context default \\\n  --cluster=localhost \\\n  --user=admin \n\nkubectl config use-context default\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c1d\u8bd5\u6267\u884c\u4e00\u4e9b\u6700\u5e38\u7528\u7684\u547d\u4ee4 </p> <pre><code># kubectl get nodes\nNo resources found\n# kubectl get services\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   38m\n</code></pre> <p>\u4ece\u8f93\u51fa\u6765\u770b\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u8282\u70b9\uff0c\u4f46 <code>services</code> \u8d44\u6e90\u5230\u662f\u521b\u5efa\u4e86\u4e00\u4e2a</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#deployment","title":"\u521b\u5efa Deployment","text":"<p>\u6211\u4eec\u5c1d\u8bd5\u521b\u5efa Deployment</p> <pre><code># kubectl create deployment web --image=nginx\ndeployment.apps/web created\n\n# kubectl get all\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   43m\n\nNAME                  READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/web   0/1     0            0           27s\n</code></pre> <p>\u4ece\u8f93\u51fa\u6765\u770b\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u6210\u529f\uff0c\u8fd9\u662f\u56e0\u4e3a\u76ee\u524d\u96c6\u7fa4\u8fd8\u6ca1\u6709 <code>ReplicaSet</code> \u670d\u52a1\uff0c\u56e0\u4e3a\u4e0d\u4f1a\u521b\u5efa Pod</p> <p>\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u8fd0\u884c controller manager</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#controller-manager","title":"\u8fd0\u884c controller manager","text":"<pre><code># ./kube-controller-manager\nI0321 13:35:56.653517   17112 serving.go:348] Generated self-signed cert in-memory\nW0321 13:35:56.653551   17112 client_config.go:617] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.\nW0321 13:35:56.653557   17112 client_config.go:622] error creating inClusterConfig, falling back to default config: unable to load in-cluster configuration, KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT must be defined\ninvalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable\n</code></pre> <p>\u6839\u636e\u62a5\u9519\u4fe1\u606f\uff0c\u6211\u4eec\u589e\u52a0\u76f8\u5e94\u7684\u53c2\u6570\uff0c\u8fd9\u91cc\u9700\u8981\u63d0\u4f9b <code>--kubeconfig</code>\u914d\u7f6e\u6587\u4ef6\u6216\u8005 <code>--master</code> \u670d\u52a1</p> <pre><code>mkdir configs\n{\n  kubectl config set-cluster localhost \\\n    --certificate-authority=/opt/k8s/pki/ca/ca.pem \\\n    --server=https://127.0.0.1:6443 \\\n    --kubeconfig=configs/kube-controller-manager.kubeconfig\n\n  kubectl config set-credentials system:kube-controller-manager \\\n    --client-certificate=/opt/k8s/pki/controller/kube-controller-manager.pem \\\n    --client-key=/opt/k8s/pki/controller/kube-controller-manager-key.pem \\\n    --kubeconfig=configs/kube-controller-manager.kubeconfig\n\n  kubectl config set-context default \\\n    --cluster=localhost \\\n    --user=system:kube-controller-manager \\\n    --kubeconfig=configs/kube-controller-manager.kubeconfig\n\n  kubectl config use-context default --kubeconfig=configs/kube-controller-manager.kubeconfig\n}\n</code></pre> <p>\u7ecf\u8fc72\u4e2a\u5c0f\u65f6\u7684\u8c03\u8bd5\u4ee5\u53ca\u75af\u72c2\u5bfb\u627e\u5404\u7c7b\u8d44\u6e90\u540e\uff0c\u5f97\u5230\u5982\u4e0b\u7684\u53c2\u6570</p> <pre><code># ./kube-controller-manager \\\n  --master https://127.0.0.1:6443 \\\n  --root-ca-file=/opt/k8s/pki/ca/ca.pem \\\n  --client-ca-file=/opt/k8s/pki/ca/ca.pem \\\n  --cluster-name=localhost \\\n  --requestheader-client-ca-file=/opt/k8s/pki/front-proxy/front-proxy.pem \\\n  --cluster-signing-cert-file=/opt/k8s/pki/ca/ca.pem \\\n  --cluster-signing-key-file=/opt/k8s/pki/ca/ca-key.pem  \\\n  --service-account-private-key-file=/opt/k8s/pki/service-account/service-account-key.pem \\\n  --use-service-account-credentials=true  \\\n  --authentication-kubeconfig=/opt/k8s/configs/kube-controller-manager.kubeconfig \\\n  --authorization-kubeconfig=/opt/k8s/configs/kube-controller-manager.kubeconfig \\\n  --kubeconfig=/opt/k8s/configs/kube-controller-manager.kubeconfig \\\n  --v=2\n</code></pre> <p>\u6211\u4eec\u7ee7\u7eed\u89c2\u5bdf <code>Deployment</code> \u90e8\u7f72\u5f97\u5982\u4f55\u4e86</p> <pre><code># kubectl get all\nNAME                       READY   STATUS    RESTARTS   AGE\npod/web-76b56fd968-9hvvj   0/1     Pending   0          64s\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   94m\n\nNAME                  READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/web   0/1     1            0           51m\n\nNAME                             DESIRED   CURRENT   READY   AGE\nreplicaset.apps/web-76b56fd968   1         1         0       65s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cReplicaSet \u8d44\u6e90\u6709\u4e86\uff0c\u4f46\u662f Pod \u8fd8\u662f\u6ca1\u6709\u8fd0\u884c\uff0c\u4f46\u5904\u4e8e <code>Pending</code> \u72b6\u6001\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u8fd8\u6ca1\u6709 work node\uff0c\u4e0b\u9762\u7684\u547d\u4ee4\u4e5f\u8868\u660e\u4e86\u8fd9\u4e00\u70b9</p> <pre><code># kubectl get nodes\nNo resources found\n</code></pre> <p>\u6240\u4ee5\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u542f\u52a8\u5bb9\u5668\u5f15\u64ce(Dockerd) \u4ee5\u53ca kubelet</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_9","title":"\u542f\u52a8\u5bb9\u5668\u5f15\u64ce","text":"<p>\u6211\u4eec\u8fd9\u91cc\u7ee7\u7eed\u4f7f\u7528 Docker \u4f5c\u4e3a\u8fd0\u884c\u65f6\u5bb9\u5668</p> <pre><code># systemctl start docker\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kubelet","title":"\u542f\u52a8 kubelet","text":"<p>\u6ce8\u610f\uff0c\u5982\u679c <code>kubelet</code> \u8fd0\u884c\u4e0d\u5e26\u53c2\u6570\uff0c\u4ed6\u4e5f\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u4f46\u4ed6\u4e0d\u4f1a\u52a0\u5165\u5230\u73b0\u6709\u7684\u96c6\u7fa4\u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u6307\u5b9a\u53c2\u6570\uff0c\u540c\u65f6\u7406\u4e0a\u524d\u9762\u6b65\u9aa4\u521b\u5efa\u7684 <code>$HOME/.kube/config</code> \u6587\u4ef6</p> <pre><code>./kubelet --kubeconfig ~/.kube/config\n\nI0321 15:20:10.623951   26194 server.go:446] \"Kubelet version\" kubeletVersion=\"v1.23.17\"\nI0321 15:20:10.626190   26194 container_manager_linux.go:975] \"CPUAccounting not enabled for process\" pid=26194\nI0321 15:20:10.626211   26194 container_manager_linux.go:978] \"MemoryAccounting not enabled for process\" pid=26194\nI0321 15:20:10.684392   26194 server.go:693] \"--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /\"\nE0321 15:20:10.684528   26194 server.go:302] \"Failed to run kubelet\" err=\"failed to run Kubelet: running with swap on is not supported, please disable swap! or set --fail-swap-on flag to false. /proc/swaps contained: [Filename\\t\\t\\t\\tType\\t\\tSize\\t\\tUsed\\t\\tPriority /dev/sda4                               partition\\t32769020\\t0\\t\\t-2]\"\n</code></pre> <p><code>kubelet</code> \u68c0\u6d4b\u5230\u7cfb\u7edf\u542f\u7528\u4e86 <code>swap</code> \uff0c\u5f97\u5148\u8981\u7981\u7528</p> <pre><code>swapoff -a\n</code></pre> <p>\u7136\u540e\u518d\u6b21\u542f\u7528</p> <pre><code>./kubelet --kubeconfig ~/.kube/config\n\nE0321 15:20:24.011779   26301 server.go:302] \"Failed to run kubelet\" err=\"failed to run Kubelet: misconfiguration: kubelet cgroup driver: \\\"cgroupfs\\\" is different from docker cgroup driver: \\\"systemd\\\"\"\n</code></pre> <p>kubelet \u9ed8\u8ba4\u7684 <code>cgroup</code> \u9a71\u52a8\u548c <code>docker</code> \u7684\u9a71\u52a8\u4e0d\u4e00\u81f4\uff0c\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u53c2\u6570\u4fdd\u6301\u4e00\u81f4</p> <pre><code>./kubelet --kubeconfig ~/.kube/config \\\n  --cgroup-driver=systemd\n\n .....\n E0321 15:25:18.969438   26778 summary_sys_containers.go:48] \"Failed to get system container stats\" err=\"failed to get cgroup stats for \\\"/user.slice/user-0.slice/session-30391.scope\\\": failed to get container info for \\\"/user.slice/user-0.slice/session-30391.scope\\\": unknown container \\\"/user.slice/user-0.slice/session-30391.scope\\\"\" containerName=\"/user.slice/user-0.slice/session-30391.scope\"\nE0321 15:25:28.983576   26778 summary_sys_containers.go:48] \"Failed to get system container stats\" err=\"failed to get cgroup stats for \\\"/user.slice/user-0.slice/session-30391.scope\\\": failed to get container info for \\\"/user.slice/user-0.slice/session-30391.scope\\\": unknown container \\\"/user.slice/user-0.slice/session-30391.scope\\\"\" containerName=\"/user.slice/user-0.slice/session-30391.scope\"\n</code></pre> <p>\u770b\u4e0a\u53bb\u542f\u52a8\u6210\u529f\u4e86\uff0c\u6211\u4eec\u68c0\u67e5\u4e0b</p> <pre><code># kubectl get nodes\nNAME     STATUS   ROLES    AGE   VERSION\nnode41   Ready    &lt;none&gt;   38s   v1.23.17\n</code></pre> <p>\u7ee7\u7eed\u68c0\u6d4b pod \u7684\u72b6\u6001</p> <pre><code>kubectl get all\nNAME                       READY   STATUS    RESTARTS   AGE\npod/web-76b56fd968-9hvvj   0/1     Pending   0          63m\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   157m\n\nNAME                  READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/web   0/1     1            0           114m\n\nNAME                             DESIRED   CURRENT   READY   AGE\nreplicaset.apps/web-76b56fd968   1         1         0       63m\n</code></pre> <p>\u6211\u4eec\u770b\u5230 Pod \u4f9d\u7136\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u76ee\u524d\u8fd8\u6709\u8c03\u5ea6\u7ec4\u4ef6\uff0c\u6240\u4ee5\u4e0d\u77e5\u9053\u5e94\u8be5\u628a\u8fd9\u4e2a\u521b\u5efa\u4efb\u52a1\u53d1\u9001\u7ed9\u90a3\u53f0 work node</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_10","title":"\u542f\u7528\u8c03\u5ea6\u670d\u52a1","text":"<pre><code>./kube-scheduler --kubeconfig ~/.kube/config\n\nI0321 15:44:55.022774   31170 serving.go:348] Generated self-signed cert in-memory\nW0321 15:44:55.393173   31170 authentication.go:316] No authentication-kubeconfig provided in order to lookup client-ca-file in configmap/extension-apiserver-authentication in kube-system, so client certificate authentication won't work.\nW0321 15:44:55.393192   31170 authentication.go:340] No authentication-kubeconfig provided in order to lookup requestheader-client-ca-file in configmap/extension-apiserver-authentication in kube-system, so request-header client certificate authentication won't work.\nW0321 15:44:55.393203   31170 authorization.go:194] No authorization-kubeconfig provided, so SubjectAccessReview of authorization tokens won't work.\nI0321 15:44:55.408176   31170 server.go:139] \"Starting Kubernetes Scheduler\" version=\"v1.23.17\"\nI0321 15:44:55.409896   31170 secure_serving.go:200] Serving securely on [::]:10259\nI0321 15:44:55.409967   31170 tlsconfig.go:240] \"Starting DynamicServingCertificateController\"\nI0321 15:44:55.510724   31170 leaderelection.go:248] attempting to acquire leader lease kube-system/kube-scheduler...\nI0321 15:44:55.519355   31170 leaderelection.go:258] successfully acquired lease kube-system/kube-scheduler\n</code></pre> <p>\u6211\u4eec\u518d\u770b Pod \u7684\u72b6\u6001</p> <pre><code># kubectl get pods\n\nNAME                   READY   STATUS    RESTARTS   AGE\nweb-58bd5fd67c-rrhg7   1/1     Running   0          5m15s\n</code></pre> <p>\u6210\u529f\u4e86\uff01</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#pod","title":"\u4eba\u5de5\u8c03\u5ea6 Pod","text":"<p>\u5982\u679c\u4e0d\u542f\u7528 <code>kube-scheduler</code> \u670d\u52a1\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a <code>Bind</code> \u8d44\u6e90\u6765\u4eba\u5de5\u8fdb\u884c\u8c03\u5ea6</p> <pre><code>kubectl create -f- &lt;&lt;EOF\napiVersion: v1\nkind: Binding\nmetadata:\n  name: web-58bd5fd67c-rrhg7\ntarget:\n  apiVersion: v1\n  kind: Node\n  name: node41\nEOF\n</code></pre> <p>\u8fd9\u5176\u5b9e\u5c31\u662f <code>kube-scheduler</code> \u7684\u5de5\u4f5c\u673a\u5236</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#pod_1","title":"\u8fde\u63a5\u5230 Pod","text":"<p>\u68c0\u67e5 Pod \u6216\u83b7\u5f97\u7684 IP \u5730\u5740</p> <pre><code># kubectl get pods -o wide\nNAME                  READY   STATUS    RESTARTS   AGE     IP           NODE      \nweb-58bd5fd67c-rrhg7   1/1     Running   0        8m22s   172.17.0.2   node41  \n</code></pre> <p>\u5c1d\u8bd5\u8bbf\u95ee\u8fd9\u4e2a pod</p> <pre><code># curl http://172.17.0.2\n\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u80fd\u770b\u5230 Nginx \u7684\u6b22\u8fce\u9875\u9762</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#deployment_1","title":"\u66b4\u9732 Deployment","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa Service \u8d44\u6e90\u6765\u5173\u8054\u8be5 Deployment</p> <pre><code># kubectl expose deployment web --port=80\nservice/web exposed\n\n# kubectl get svc\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   3h16m\nweb          ClusterIP   10.0.0.65    &lt;none&gt;        80/TCP    15s\n\n# curl --connect-timeout  3  http://10.0.0.65\ncurl: (28) Connection timed out after 3001 milliseconds\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u8bbf\u95ee\u521b\u5efa\u7684 Service \u662f\u8d85\u65f6\u7684\uff0c\u8bf4\u660e\u6b64\u65f6\u7f51\u7edc\u8fd8\u4e0d\u901a\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u76ee\u524d\u8fd8\u6709\u8f6c\u53d1\u670d\u52a1\u6765\u627f\u62c5</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-proxy_1","title":"\u542f\u52a8 kube-proxy","text":"<pre><code># ./kube-proxy --kubeconfig=$HOME/.kube/config\n\nI0321 16:31:52.049688   10836 server.go:224] \"Warning, all flags other than --config, --write-config-to, and --cleanup are deprecated, please begin using a config file ASAP\"\nI0321 16:31:52.067506   10836 node.go:163] Successfully retrieved node IP: 10.90.23.41\nI0321 16:31:52.067529   10836 server_others.go:138] \"Detected node IP\" address=\"10.90.23.41\"\nI0321 16:31:52.067549   10836 server_others.go:572] \"Unknown proxy mode, assuming iptables proxy\" proxyMode=\"\"\nI0321 16:31:52.071891   10836 server_others.go:206] \"Using iptables Proxier\"\nI0321 16:31:52.071913   10836 server_others.go:213] \"kube-proxy running in dual-stack mode\" ipFamily=IPv4\nI0321 16:31:52.071925   10836 server_others.go:214] \"Creating dualStackProxier for iptables\"\nI0321 16:31:52.071932   10836 server_others.go:486] \"Detect-local-mode set to ClusterCIDR, but no cluster CIDR defined\"\nI0321 16:31:52.071940   10836 server_others.go:535] \"Defaulting to no-op detect-local\" detect-local-mode=\"ClusterCIDR\"\nI0321 16:31:52.072144   10836 server.go:656] \"Version info\" version=\"v1.23.17\"\nI0321 16:31:52.078767   10836 conntrack.go:100] \"Set sysctl\" entry=\"net/netfilter/nf_conntrack_max\" value=1048576\nI0321 16:31:52.078795   10836 conntrack.go:52] \"Setting nf_conntrack_max\" nf_conntrack_max=1048576\nI0321 16:31:52.078834   10836 conntrack.go:100] \"Set sysctl\" entry=\"net/netfilter/nf_conntrack_tcp_timeout_close_wait\" value=3600\nI0321 16:31:52.078943   10836 config.go:317] \"Starting service config controller\"\nI0321 16:31:52.078956   10836 shared_informer.go:240] Waiting for caches to sync for service config\nI0321 16:31:52.078976   10836 config.go:444] \"Starting node config controller\"\nI0321 16:31:52.078980   10836 shared_informer.go:240] Waiting for caches to sync for node config\nI0321 16:31:52.078987   10836 config.go:226] \"Starting endpoint slice config controller\"\nI0321 16:31:52.079003   10836 shared_informer.go:240] Waiting for caches to sync for endpoint slice config\nI0321 16:31:52.179072   10836 shared_informer.go:247] Caches are synced for service config\nI0321 16:31:52.179086   10836 shared_informer.go:247] Caches are synced for endpoint slice config\nI0321 16:31:52.179081   10836 shared_informer.go:247] Caches are synced for node config\n</code></pre> <p>\u518d\u5c1d\u8bd5\u8bbf\u95ee Service</p> <pre><code># curl --connect-timeout  3  http://10.0.0.65\n\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5df2\u7ecf\u6210\u529f\u4e86</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kube-proxy_2","title":"kube-proxy \u5de5\u4f5c\u539f\u7406","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ckube-proxy \u662f\u901a\u8fc7\u521b\u5efa iptables \u89c4\u5219\u6765\u8fdb\u884c\u8f6c\u53d1\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4b\u8282\u70b9\u7684 OUTPUT \u89c4\u5219\u94fe\u770b\u4e0b\u60c5\u51b5</p> <pre><code># iptables -t nat -L OUTPUT\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */\nDOCKER     all  --  anywhere            !loopback/8           ADDRTYPE match dst-type LOCAL\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u6709 <code>KUBE-SERVICES</code> \u94fe\u8def</p> <p>\u6240\u6709\u7684\u6d41\u91cf\u90fd\u662f\u8d70\u8fd9\u4e2a\u94fe\u8def\uff0c\u6211\u4eec\u7ee7\u7eed\u89c2\u5bdf</p> <pre><code># iptables -t nat -L KUBE-SERVICES\nChain KUBE-SERVICES (2 references)\ntarget     prot opt source               destination\nKUBE-SVC-LOLE4ISW44XBNF3G  tcp  --  anywhere             10.0.0.65            /* default/web cluster IP */ tcp dpt:http\nKUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  anywhere             10.0.0.1             /* default/kubernetes:https cluster IP */ tcp dpt:https\nKUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL\n</code></pre> <p>\u9488\u5bf9\u6bcf\u4e2a Service \uff0c\u90fd\u4f1a\u521b\u5efa\u4e00\u6761\u89c4\u5219\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6253\u7b97\u518d\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\u5230\u96c6\u7fa4\u4e2d</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_11","title":"\u65b0\u589e\u8282\u70b9","text":"<p>\u9996\u5148\u628a\u524d\u9762\u8282 \u7684 <code>/opt/k8s</code> \u76ee\u5f55\u62f7\u8d1d\u5230\u65b0\u8282\u70b9</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_12","title":"\u8fd0\u884c\u5bb9\u5668\u5f15\u64ce","text":"<pre><code># systemctl start docker\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#kubelet_1","title":"\u8fd0\u884c kubelet","text":"<p>\u5148\u62f7\u8d1d\u524d\u9762\u8282\u70b9\u7684 <code>$HOME/.kube/config</code> \u6587\u4ef6\u5230\u5230\u8282\u70b9</p> <pre><code># scp node41:/root/.kube/config node42:/tmp/\n</code></pre> <p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u628a <code>server: https://127.0.0.1:6443</code> \u6362\u6210 <code>server: https://10.90.23.41:6443</code></p> <p>\u7136\u540e\u8fd0\u884c</p> <pre><code># ./kubelet --cgroup-driver=systemd  --kubeconfig /tmp/config\nFlag --cgroup-driver has been deprecated, This parameter should be set via the config file specified by the Kubelet's --config flag. See https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for more information.\nI0321 20:12:36.308745   32224 server.go:446] \"Kubelet version\" kubeletVersion=\"v1.23.17\"\nI0321 20:12:36.310418   32224 container_manager_linux.go:975] \"CPUAccounting not enabled for process\" pid=32224\nI0321 20:12:36.310432   32224 container_manager_linux.go:978] \"MemoryAccounting not enabled for process\" pid=32224\n....\nE0321 20:12:36.460003   32224 eviction_manager.go:254] \"Eviction manager: failed to get summary stats\" err=\"failed to get node info: node \\\"node42\\\" not found\"\n</code></pre> <p>\u4f3c\u4e4e\u6210\u529f\u4e86</p> <pre><code>#  kubectl get nodes\nNAME    STATUS   ROLES    AGE     VERSION\nnode41   Ready    &lt;none&gt;   4h48m   v1.23.17\nnode42   Ready    &lt;none&gt;   65s     v1.23.17\n</code></pre>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_13","title":"\u90e8\u7f72\u65b0\u7684\u670d\u52a1","text":"<pre><code># kubectl create deployment httpenv --image=jpetazzo/httpenv\ndeployment.apps/httpenv created\n# kubectl scale deployment httpenv --replicas=5\ndeployment.apps/httpenv scaled\n</code></pre> <p>\u770b\u4e0b Pod \u72b6\u6001</p> <pre><code># kubectl get pods\nNAME                      READY   STATUS    RESTARTS   AGE\nhttpenv-858f759c7-jr77f   1/1     Running   0          2m22s\nhttpenv-858f759c7-krtvs   1/1     Running   0          2m36s\nhttpenv-858f759c7-q6v6b   1/1     Running   0          2m22s\nhttpenv-858f759c7-scbm7   1/1     Running   0          2m22s\nhttpenv-858f759c7-vkpgn   1/1     Running   0          2m22s\nweb-58bd5fd67c-rrhg7      1/1     Running   0          4h30m\n</code></pre> <p>\u4f3c\u4e4e\u4e00\u5207\u90fd\u6b63\u5e38\uff0c\u4f46\u4f7f\u7528 <code>-owide</code> \u518d\u770b\u4e0b</p> <pre><code># kubectl get pods  -o wide\nNAME                      READY   STATUS    RESTARTS   AGE     IP           NODE             \nhttpenv-858f759c7-jr77f   1/1     Running   0          2m38s   172.17.0.2   node42   \nhttpenv-858f759c7-krtvs   1/1     Running   0          2m52s   172.17.0.3   node42   \nhttpenv-858f759c7-q6v6b   1/1     Running   0          2m38s   172.17.0.4   node42\nhttpenv-858f759c7-scbm7   1/1     Running   0          2m38s   172.17.0.3   node41  \nhttpenv-858f759c7-vkpgn   1/1     Running   0          2m38s   172.17.0.4   node41   \nweb-58bd5fd67c-rrhg7      1/1     Running   0          4h30m   172.17.0.2   node41   \n</code></pre> <p>\u600e\u4e48 pod \u7684 IP \u5730\u5740\u6709\u91cd\u590d\u7684?</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u542f\u7528\u7f51\u7edc\u63d2\u4ef6\uff0c\u6240\u4ee5\u96c6\u7fa4\u81ea\u8eab\u4e0d\u89e3\u51b3\u7f51\u7edc\u5206\u914d\u95ee\u9898\uff0c\u8fd9\u4e9b IP \u5730\u5740\u90fd\u662f\u6765\u81ea Docker \u81ea\u8eab\u7684\u5206\u914d</p> <p>\u800c Docker \u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u5206\u914d\u7684 IP \u4f1a\u76f8\u540c\uff0c\u6240\u4ee5\u4e24\u4e2a\u8282\u70b9\u7684 IP \u5730\u5740\u5c31\u91cd\u590d\u4e86</p> <p>\u56e0\u6b64\u6211\u4eec\u9700\u8981\u542f\u7528\u7f51\u7edc\u63d2\u4ef6</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_14","title":"\u542f\u7528\u7f51\u7edc\u63d2\u4ef6","text":"<p>\u6211\u4eec\u4f7f\u7528 <code>cni</code> \u7f51\u7edc\u63d2\u4ef6\uff0c\u4f7f\u7528\u7f51\u7edc\u63d2\u4ef6\u9700\u8981\u89c4\u5212\u5b50\u7f51\uff0c\u4e00\u822c\u6211\u4eec\u4f7f\u7528 <code>10.C.N.0/24</code> \u5b50\u7f51\u6a21\u5f0f\uff0c\u8fd9\u91cc</p> <ul> <li>C \u8868\u793a\u96c6\u7fa4\u6570\uff0c\u53ef\u4ee5\u4ece0\u5f00\u59cb\uff0c\u4e5f\u53ef\u4ee5\u4ece1\u5f00\u59cb</li> <li>N \u8868\u793a\u96c6\u7fa4\u4e2d\u8282\u70b9\u5e8f\u6570,\u53ef\u4ee5\u4ece0\u5f00\u59cb\uff0c\u4e5f\u53ef\u4ee5\u4ece1\u5f00\u59cb</li> </ul> <p>\u9996\u5148\uff0c\u6211\u4eec\u505c\u6b62\u4e24\u53f0\u673a\u5668\u7684 kubelet \u670d\u52a1\uff0c\u7136\u540e\u589e\u52a0\u7b2c\u4e00\u4e2a\u8282\u70b9\u589e\u52a0</p> <pre><code>--network-plugin=kubenet --pod-cidr 10.1.1.0/24\n</code></pre> <p>\u7b2c\u4e8c\u4e2a\u8282\u70b9\u589e\u52a0</p> <pre><code>--network-plugin=kubenet --pod-cidr 10.1.2.0/24\n</code></pre> <p>\u53c2\u6570\u6765\u542f\u52a8\u3002</p> <p>\u542f\u52a8\u4e4b\u524d\u4f60\u9700\u8981\u5148\u5b89\u88c5 <code>kubernetes-cni</code> \u5305\uff0c\u6211\u8fd9\u91cc\u76f4\u63a5\u4ece\u5176\u4ed6\u670d\u52a1\u5668\u4e0a\u62f7\u8d1d\u8fc7\u6765\u7684</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_15","title":"\u91cd\u65b0\u90e8\u7f72","text":"<p>\u91cd\u542f\u542f\u7528\u7f51\u7edc\u4e4b\u540e\uff0c\u9700\u8981\u91cd\u542f\u521b\u5efa Deployment</p> <pre><code># kubectl delete pods --all\n\npod \"httpenv-858f759c7-jr77f\" deleted\npod \"httpenv-858f759c7-krtvs\" deleted\npod \"httpenv-858f759c7-q6v6b\" deleted\npod \"httpenv-858f759c7-scbm7\" deleted\npod \"httpenv-858f759c7-vkpgn\" deleted\npod \"web-58bd5fd67c-rrhg7\" deleted\n</code></pre> <p>\u7b49\u4e0a\u4e00\u4f1a\uff0c\u6211\u4eec\u518d\u770b</p> <pre><code># kubectl get pods -o wide\n\nNAME                      READY   STATUS    RESTARTS   AGE   IP         NODE\nhttpenv-858f759c7-89qlj   1/1     Running   0          44s   10.1.2.3   node42\nhttpenv-858f759c7-dl5hj   1/1     Running   0          44s   10.1.1.3   node41\nhttpenv-858f759c7-f9qpq   1/1     Running   0          44s   10.1.1.4   node41\nhttpenv-858f759c7-nhkdk   1/1     Running   0          44s   10.1.2.2   node42\nhttpenv-858f759c7-sswpt   1/1     Running   0          44s   10.1.2.4   node42\nweb-58bd5fd67c-nlsjp      1/1     Running   0          44s   10.1.1.2   node41\n</code></pre> <p>\u8fd9\u770b\u4e0a\u53bb\u4e00\u5207\u6b63\u5e38</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_16","title":"\u66b4\u9732\u670d\u52a1","text":"<pre><code># kubectl expose deployment httpenv --port=8888\nservice/httpenv exposed\n# kubectl get svc httpenv\nNAME      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\nhttpenv   ClusterIP   10.0.0.250   &lt;none&gt;        8888/TCP   22s\n</code></pre> <p>\u5c1d\u8bd5\u8bbf\u95ee\u8fd9\u4e2a\u670d\u52a1</p> <pre><code># for i in {1..10}; do  curl -sS  --connect-timeout 1 http://10.250:8888 |jq '.HOSTNAME'; sleep 0.3;done\n\n\"httpenv-858f759c7-f9qpq\"\n\"httpenv-858f759c7-f9qpq\"\ncurl: (28) Connection timed out after 1001 milliseconds\ncurl: (28) Connection timed out after 1001 milliseconds\ncurl: (28) Connection timed out after 1001 milliseconds\n\"httpenv-858f759c7-f9qpq\"\n\"httpenv-858f759c7-dl5hj\"\n\"httpenv-858f759c7-dl5hj\"\ncurl: (28) Connection timed out after 1001 milliseconds\ncurl: (28) Connection timed out after 1001 milliseconds\n</code></pre> <p>\u6211\u4eec\u53d1\u73b0\u53ea\u6709\u8bbf\u95ee\u8fd0\u884c\u5728 <code>node41</code> \u8282\u70b9\u7684 Pod \u53ef\u4ee5\u6709\u8fd4\u56de\uff0c\u8fd0\u884c\u5728 <code>node42</code> \u8282\u70b9\u4e0a\u7684\u5219\u76f4\u63a5\u8d85\u65f6\u4e86</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6bcf\u4e2a\u8282\u70b9\u5206\u914d\u7684\u5b50\u7f51\uff0c\u5176\u4ed6\u8282\u70b9\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684\u8def\u7531\u89c4\u5219</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_17","title":"\u589e\u52a0\u9759\u6001\u8def\u7531","text":"<p>\u6211\u4eec\u9700\u8981\u544a\u8bc9\u6bcf\u4e00\u4e2a\u8282\u70b9 <code>10.C.N.0/24</code> \u662f\u4f4d\u4e8e\u8282\u70b9 N \u4e0a\uff0c\u6211\u4eec\u9700\u8981\u589e\u52a0\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\u7684\u8def\u7531\u89c4\u5219</p> <pre><code>ip route add 10.C.N.0/24 via W.X.Y.Z\n</code></pre> <p>\u8fd9\u91cc\u7684 <code>W.X.Y.Z</code> \u5c31\u662f\u8282\u70b9 <code>N</code> \u7684\u5185\u7f51 IP \u5730\u5740\u3002\u5177\u4f53\u5230\u6211\u4eec\u7684\u73af\u5883\uff0c\u9700\u8981\u5206\u522b\u5728 <code>node41</code> \u4e0a\u589e\u52a0\u5982\u4e0b\u8def\u7531\u89c4\u5219\uff1a</p> <pre><code>ip route add 10.1.2.0/24 via 10.90.23.42\n</code></pre> <p>\u5728\u8282\u70b9 <code>node42</code> \u4e0a\u589e\u52a0\u4e0b\u9762\u7684\u89c4\u5219</p> <pre><code>ip route add 10.1.1.0/24 via 10.90.23.41\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u518d\u6d4b\u8bd5\u8bbf\u95ee\u60c5\u51b5</p> <pre><code># for i in {1..10}; do  curl -sS  --connect-timeout 1   http://10.250:8888 |jq '.HOSTNAME'; sleep 0.3;done\n\n\"httpenv-858f759c7-89qlj\"\n\"httpenv-858f759c7-nhkdk\"\n\"httpenv-858f759c7-89qlj\"\n\"httpenv-858f759c7-nhkdk\"\n\"httpenv-858f759c7-dl5hj\"\n\"httpenv-858f759c7-89qlj\"\n\"httpenv-858f759c7-f9qpq\"\n\"httpenv-858f759c7-sswpt\"\n\"httpenv-858f759c7-nhkdk\"\n\"httpenv-858f759c7-nhkdk\"\n</code></pre> <p>\u8fd9\u770b\u4e0a\u53bb\u5c31\u6b63\u5e38\u4e86</p>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/deep-dive-into-k8s-internals/#_18","title":"\u603b\u7ed3","text":"<p>\u6574\u4e2a\u7eaf\u624b\u5de5\u642d\u5efa k8s \u96c6\u7fa4\u7684\u6b65\u9aa4\u5c31\u5230\u6b64\u7ed3\u675f\uff0c\u5176\u4ed6\u7684\u6269\u5c55\u5c31\u662f\u56f4\u7ed5\u6211\u4eec\u4e0a\u9762\u4e00\u4e9b\u9700\u6c42\u6269\u5c55\u4e8c\u6765\uff0c\u6bd4\u5982\u5f53\u8282\u70b9\u8fc7\u591a\u662f\uff0c\u4e0d\u53ef\u80fd\u4eba\u5de5\u7ed9\u6bcf\u4e00\u4e2a\u8282\u70b9\u53bb\u589e\u52a0\u9759\u6001\u8def\u7531\uff0c\u56e0\u6b64\u9700\u8981\u6709\u4e13\u95e8\u7684\u8def\u7531\u7ec4\u4ef6\u6765\u5904\u7406\u3002</p> <p>\u5f53\u5f15\u5165 TLS \u540e\uff0c\u6574\u4e2a\u90e8\u7f72\u8fc7\u7a0b\u5176\u5b9e\u590d\u6742\u4e86\u4e0d\u5c11\uff0c\u8fd9\u8fd8\u662f\u501f\u52a9\u4e86\u4e00\u4e9b\u80fd\u7b80\u5316\u5de5\u4f5c\u91cf\u7684\u5de5\u5177\u3002</p> <p>\u56e0\u6b64\u603b\u6765\u7684\u6765\u8bf4\uff0c\u65b0\u7248\u672c\u7684\u90e8\u7f72\uff0c\u4f7f\u7528\u5b98\u65b9\u63a8\u8350\u7684 kubeadm \u4e5f\u597d\uff0cKOps \u4e5f\u597d\uff0cKubespray \u751a\u81f3minikube \u90fd\u6bd4\u8fd9\u79cd\u65b9\u5f0f\u8981\u6765\u7684\u5feb\u5f97\u591a\u3002</p> <p>\u663e\u7136\u8fd9\u79cd\u6a21\u5f0f\u9002\u5408\u624b\u5934\u5df2\u7ecf\u6709\u5443\u96c6\u7fa4\uff0c\u800c\u4e14\u5bf9\u96c6\u7fa4\u6709\u4e86\u4e00\u5b9a\u7684\u4e86\u89e3\uff0c\u60f3\u8fdb\u4e00\u641e\u6e05\u695a\u5404\u7ec4\u5efa\u7684\u5173\u7cfb\uff0c\u7ec4\u4ef6\u51fa\u73b0\u6545\u969c\u540e\uff0c\u5982\u4f55\u7ef4\u62a4\u3002\u90a3\u4e48\u901a\u8fc7\u8fd9\u4e48\u4e00\u5957\u65b9\u5f0f\u4e0b\u6765\uff0c\u76f8\u4fe1\u8fd8\u662f\u6709\u4e0d\u5c11\u6536\u83b7\u7684\u3002</p> <p>\u53c2\u8003\u8d44\u6599</p> <ol> <li>https://lisa-2019-10.container.training/tutorial.yml.html</li> <li>https://kubernetes.io/docs/reference/kubectl/cheatsheet/</li> <li>https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</li> <li>https://stackoverflow.com/questions/42170380/how-to-add-users-to-kubernetes-kubectl</li> <li>https://medium.com/@DrewViles/install-cloudflares-pki-toolkit-and-generate-tls-certs-2e3fcedea8a0</li> <li>https://github.com/kelseyhightower/kubernetes-the-hard-way/</li> <li>https://s.itho.me/day/2017/k8s/1020-1100%20All%20The%20Troubles%20You%20Get%20Into%20When%20Setting%20Up%20a%20Production-ready%20Kubernetes%20Cluster.pdf</li> </ol>","tags":["k8s","etcd","kubectl","docker"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/","title":"\u5728 Kubernetes Dashboard \u521b\u5efa\u57fa\u4e8e RBAC \u7684\u6388\u6743\u7528\u6237","text":"<p>Kuberenetes Dashboard \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u521b\u5efa\u4e86\u4e00\u4e2a Admin \u89d2\u8272\u7684\u7528\u6237\uff0c\u5c5e\u4e8e\u8d85\u7ea7\u7ba1\u7406\u5458\u3002</p> <p>\u6211\u4eec\u5e0c\u671b\u5728\u521b\u5efa\u4e00\u4e9b\u666e\u901a\u7528\u6237\uff0c\u57fa\u4e8e namespace \u8fdb\u884c\u5212\u5206\uff0c\u6bcf\u4e2a\u521b\u5efa\u7684\u7528\u6237\u53ea\u80fd\u5728\u6307\u5b9a\u7684 namespace \u4e0b\u8fdb\u884c\u4e00\u4e9b\u6267\u884c\u7684\u64cd\u4f5c\uff0c\u4e0b\u9762\u662f\u6b65\u9aa4</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#namespace","title":"\u57fa\u4e8e namespace \u5185\u7684\u7528\u6237\u521b\u5efa","text":"<p>\u4ee5\u4e0b\u7684\u64cd\u4f5c\u662f\u5c06\u521b\u5efa\u7684\u7528\u6237\u9650\u5b9a\u5728\u6307\u5b9a\u7684 namespace \u4e0b\uff0c\u96c6\u7fa4\u8d44\u6e90\u4ee5\u53ca\u5176\u4ed6 namespace \u8d44\u6e90\u4e0d\u53ef\u89c1</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#namespace-serviceaccount","title":"\u5728 namespace \u4e0a\u521b\u5efa ServiceAccount \u8d44\u6e90","text":"<pre><code>kubectl create sa staff-user -n staff-center\n</code></pre>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_1","title":"\u521b\u5efa\u7528\u6237\u89d2\u8272","text":"<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  namespace: staff-center\n  name: role-staff\nrules:\n- apiGroups: [\"\"]\n  resources: [\"pods\",\"services\",\"deployments\", \"pods/log\",\"ingresses\", \"endpoints\", \"statefulsets\", \"jobs\",\"cronjobs\",\"daemonsets\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n- apiGroups: [\"\"]\n  resources: [\"pods/exec\"]\n  verbs: [\"get\", \"watch\", \"list\",\"create\"]\n</code></pre> <p>\u4fdd\u5b58\u4e3a <code>role-staff-user.yaml</code></p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_2","title":"\u521b\u5efa\u89d2\u8272\u7ed1\u5b9a","text":"<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: role-bind-staff\n  namespace: staff-center\nsubjects:\n- kind: ServiceAccount\n  name: staff-user\n  namespace: staff-center\nroleRef:\n  kind: Role\n  name: role-staff\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u4fdd\u5b58\u4e3a <code>role-binding-staff-user.yaml</code></p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_3","title":"\u6267\u884c\u4e0a\u9762\u4e2a\u914d\u7f6e\u6587\u4ef6","text":"<pre><code>kubectl apply -f role-staff-user.yaml\nkubectl apply -f role-binding-staff-user.yaml\n</code></pre>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#token","title":"\u83b7\u5f97\u8be5\u7528\u6237\u7684 token","text":"<pre><code>## 1. get secret \nsecpod=$(kubectl get sa -n staff-center staff-user -o jsonpath='{.secrets[0].name}')\n## 2. get token\ntoken=$(kubectl get secret -n staff-center ${secpod} -o jsonpath='{.data.token}' |base64 -d)\necho \"your login token: ${token}\"\n</code></pre> <p>\u5c06\u811a\u672c\u4fdd\u5b58\u4e3a <code>get-token.sh</code>\uff0c \u7136\u540e\u6267\u884c\uff0c\u53ef\u4ee5\u83b7\u5f97\u5f53\u524d\u7528\u6237\u7684 <code>token</code>\uff0c\u7528\u8fd9\u4e2a token \u5c31\u53ef\u4ee5\u767b\u5f55\u5230 Dashboard\u3002</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_4","title":"\u83b7\u53d6\u53ef\u4ee5\u914d\u7f6e\u7684\u8d44\u6e90\u5217\u8868","text":"<p>\u5728\u521b\u5efa\u89d2\u8272\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5982\u4f55\u77e5\u9053\u5f53\u524d\u6709\u54ea\u4e9b\u8d44\u6e90\u53ef\u4ee5\u7528\u4e8e <code>resources</code> \u7684\u914d\u7f6e\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2 <code>api-resources</code> \u5373\u53ef\u83b7\u5f97\uff0c\u5982\u4e0b\uff1a</p> <p><pre><code>[root@master dashboard]# kubectl api-resources --sort-by=name\nNAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND\napiservices                                    apiregistration.k8s.io/v1              false        APIService\napiservices                                    management.cattle.io/v3                false        APIService\napps                                           catalog.cattle.io/v1                   true         App\nauthconfigs                                    management.cattle.io/v3                false        AuthConfig\nbgpconfigurations                              crd.projectcalico.org/v1               false        BGPConfiguration\nbgppeers                                       crd.projectcalico.org/v1               false        BGPPeer\nbindings                                       v1                                     true         Binding\nblockaffinities                                crd.projectcalico.org/v1               false        BlockAffinity\ncaliconodestatuses                             crd.projectcalico.org/v1               false        CalicoNodeStatus\ncertificatesigningrequests        csr          certificates.k8s.io/v1                 false        CertificateSigningRequest\nclusterflows                                   logging.banzaicloud.io/v1beta1         true         ClusterFlow\nclusterinformations                            crd.projectcalico.org/v1               false        ClusterInformation\nclusteroutputs                                 logging.banzaicloud.io/v1beta1         true         ClusterOutput\nclusterregistrationtokens                      management.cattle.io/v3                true         ClusterRegistrationToken\nclusterrepos                                   catalog.cattle.io/v1                   false        ClusterRepo\nclusterrolebindings                            rbac.authorization.k8s.io/v1           false        ClusterRoleBinding\nclusterroles                                   rbac.authorization.k8s.io/v1           false        ClusterRole\nclusters                                       management.cattle.io/v3                false        Cluster\ncomponentstatuses                 cs           v1                                     false        ComponentStatus\n.....\n</code></pre> \u4e0a\u9762\u7684\u8f93\u51fa\uff0c\u4f60\u53ea\u8981\u5173\u5fc3 <code>NAME</code> \u8fd9\u4e00\u5217\u5c31\u53ef\u4ee5\u4e86</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_5","title":"\u8bbe\u5b9a\u96c6\u7fa4\u8d44\u6e90\u8bbf\u95ee\u6743\u9650","text":"<p>\u5047\u5b9a\u4f60\u8fd8\u5e0c\u671b\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e9b\u6307\u5b9a\u7684\u96c6\u7fa4\u8d44\u6e90\uff0c\u6bd4\u5982\u4e0a\u9762\u521b\u5efa\u7684\u7528\u6237\uff0c\u767b\u5f55\u540e\uff0c\u5e76\u4e0d\u80fd\u76f4\u63a5\u8df3\u8f6c\u4ed6\u5bf9\u5e94\u7684 namespace \u4e0a\uff0c\u800c\u4e14\u5728 namespace \u5904\u8fdb\u884c\u641c\u7d22\uff0c\u4e5f\u4e0d\u4f1a\u7ed9\u7ed3\u679c namespace \u672c\u8eab\u5c5e\u4e8e\u96c6\u7fa4\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u96c6\u7fa4\u89d2\u8272\u4ee5\u53ca\u7ed1\u5b9a\u96c6\u7fa4\u89d2\u8272\u6765\u8ba9\u7528\u6237\u53ef\u4ee5\u5217\u51fa\u5f53\u524d\u5df2\u6709\u7684 namespace \uff0c\u65b9\u4fbf\u7528\u6237\u9009\u62e9</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_6","title":"\u521b\u5efa\u96c6\u7fa4\u89d2\u8272","text":"<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  # \"namespace\" \u88ab\u5ffd\u7565\uff0c\u56e0\u4e3a ClusterRoles \u4e0d\u53d7\u540d\u5b57\u7a7a\u95f4\u9650\u5236\n  name: cluster-role-staff-user\nrules:\n- apiGroups: [\"\"]\n  resources: [\"namespaces\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n</code></pre> <p>\u4fdd\u5b58\u4e3a <code>cluster-role-staff-user.yaml</code></p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_7","title":"\u521b\u5efa\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a","text":"<pre><code>apiVersion: rbac.authorization.k8s.io/v1\n# \u6b64\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\u5141\u8bb8 \u201cmanager\u201d \u7ec4\u4e2d\u7684\u4efb\u4f55\u4eba\u8bbf\u95ee\u4efb\u4f55\u540d\u5b57\u7a7a\u95f4\u4e2d\u7684 secrets\nkind: ClusterRoleBinding\nmetadata:\n  name: staff-user-read-namespaces\nsubjects:\n- kind: ServiceAccount\n  name: staff-user\n  namespace: staff-center\nroleRef:\n  kind: ClusterRole\n  name: cluster-role-staff-user\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u4fdd\u5b58\u4e3a <code>cluster-role-binding-staff-user.yaml</code></p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_8","title":"\u6267\u884c\u8fd9\u4e24\u4e2a\u914d\u7f6e\u6587\u4ef6","text":"<pre><code>kubectl apply -f cluster-role-staff-user.yaml\nkubectl apply -f cluster-role-binding-staff-user.yaml\n</code></pre> <p>\u91cd\u65b0\u767b\u5f55\u6216\u5237\u65b0\u9875\u9762\uff0c\u5c31\u53ef\u4ee5\u5728 namespace \u5904\u770b\u5230\u5f53\u524d\u5df2\u6709\u7684 namespace \u4e86\u3002</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#token_1","title":"\u4fee\u6539 token \u7684\u6709\u6548\u65f6\u5e38","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b, dashboard \u7684 token \u6709\u6548\u671f\u662f 5 \u5206\u949f\uff0c\u8fd9\u4e2a\u65f6\u95f4\u6709\u70b9\u77ed\uff0c\u6211\u4eec\u53ef\u4ee5\u589e\u52a0\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u589e\u52a0\u5230 8 \u5c0f\u65f6</p> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <p><pre><code>kubectl edit deployment  -n kubernetes-dashboard  kubernetes-dashboard\n</code></pre> \u7136\u540e\u627e\u5230 </p> <p><pre><code>spec:\n  containers:\n  - args:\n    - --auto-generate-certificates\n    - --enable-insecure-login\n</code></pre> \u8fd9\u4e2a\u4f4d\u7f6e\uff0c\u589e\u52a0\u4e00\u4e2a <code>token-ttl</code> \u53c2\u6570\uff0c\u7f16\u8f91\u540e\uff0c\u5982\u4e0b\uff1a</p> <pre><code>yaml\nspec:\n  containers:\n  - args:\n    - --auto-generate-certificates\n    - --enable-insecure-login\n    - --token-ttl=28800\n</code></pre> <p>\u4fdd\u5b58\u9000\u51fa\uff0c\u7b49\u5f85\u4e00\u4f1a\uff0c\u7136\u540e\u91cd\u65b0\u767b\u5f55</p>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/how-to-create-user-for-k8s-dashboard/#_9","title":"\u53c2\u8003\u6587\u6863","text":"<ul> <li>https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</li> <li>https://github.com/kubernetes/dashboard/issues/2882</li> </ul>","tags":["kubernetes","dashboard","rbac"]},{"location":"kubernetes/kubernetes-setup/","title":"\u4f7f\u7528 kubeadm \u5b89\u88c5 kubernetes","text":"<p>\u8fd9\u91cc\u63cf\u8ff0\u5982\u4f55\u4f7f\u7528 kubeadm \u5de5\u5177\u6765\u5b89\u88c5 kubernetes v1.23, \u5b98\u65b9\u4e5f\u6709\u7c7b\u4f3c\u6587\u6863 \uff0c\u4f46\u89c9\u5f97\u4e0d\u591f\u8be6\u7ec6</p>"},{"location":"kubernetes/kubernetes-setup/#_1","title":"\u4e3b\u673a\u5217\u8868","text":"<p>\u672c\u6b21\u5b89\u88c5\u6709\u5982\u4e0b\u670d\u52a1\u5668\uff0c\u4fe1\u606f\u5982\u4e0b\uff1a</p> \u4e3b\u673a\u540d\u79f0 IP \u5730\u5740 \u64cd\u4f5c\u7cfb\u7edf node27.k8s.wgzhao.com 192.168.23.27 CentOS 7.9 node28.k8s.wgzhao.com 192.168.23.28 CentOS 7.9 node29.k8s.wgzhao.com 192.168.23.29 CentOS 7.9 node30.k8s.wgzhao.com 192.168.23.30 CentOS 7.9 node31.k8s.wgzhao.com 192.168.23.31 CentOS 7.9"},{"location":"kubernetes/kubernetes-setup/#_2","title":"\u64cd\u4f5c\u7cfb\u7edf\u53ca\u78c1\u76d8\u8bf4\u660e","text":"<ol> <li>\u7cfb\u7edf\u4e3a\u6700\u5c0f\u5b89\u88c5\u6a21\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u7136\u540e\u989d\u5916\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305</li> <li>\u7981\u7528\u4e86 <code>swap</code>\uff0c \u8fd9\u662f docker \u8981\u6c42\u7684</li> <li>\u914d\u7f6e\u597d epel, docker-ce, kubernetes \u4ed3\u5e93\uff0c\u8fd9\u90e8\u5206\u53ef\u4ee5\u81ea\u884c Google</li> <li>\u5f00\u542f <code>node27</code> \u5230\u6240\u6709\u8282\u70b9\uff08\u5305\u62ec\u81ea\u8eab) \u7684 ssh \u5bc6\u94a5\u767b\u5f55\uff0c\u4f7f\u7528root\u3002</li> </ol>"},{"location":"kubernetes/kubernetes-setup/#keepalived-haproxy","title":"keepalived + haproxy \u5b89\u88c5","text":"<p>\u4e3a\u4e86\u4fdd\u8bc1\u6838\u5fc3\u7ec4\u4ef6\u7684\u9ad8\u53ef\u7528\u4ee5\u53ca\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\uff0c\u5728<code>node27</code> - <code>node29</code> \u4e09\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72\u4e86 <code>keepalived</code> + <code>haproxy</code> \u4f5c\u4e3a\u9ad8\u53ef\u7528\u65b9\u6848\u3002</p> <p>\u5176\u4e2d\u6d6e\u52a8IP\u5730\u5740(VIP) \u4e3a <code>192.168.23.32</code>, \u914d\u7f6e\u8bf4\u660e\u5982\u4e0b\uff1a</p>"},{"location":"kubernetes/kubernetes-setup/#keepalived","title":"keepalived","text":"<p><code>node27</code> \u8282\u70b9\u4f5c\u4e3a <code>keepalived</code> \u7684 master\uff0c\u914d\u7f6e\u6587\u4ef6\u5728 <code>/etc/keepalived/keepalived.conf</code> \uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>! /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id k8s\n}\nvrrp_script check_haproxy {\n  script \"killall -0 haproxy\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface bond0\n    virtual_router_id 51\n    priority 250\n    authentication {\n        auth_type PASS\n        auth_pass ZAXRUlay\n    }\n    virtual_ipaddress {\n        192.168.23.32\n    }\n    track_script {\n        check_haproxy\n    }\n}\n</code></pre> <p><code>node28</code>, <code>node29</code> \u4e24\u4e2a\u8282\u70b9\u4f5c\u4e3a keepalived \u7684 BACKUP\uff0c \u5176\u914d\u7f6e\u6587\u4ef6\u5185\u5982\u4e0b\uff1a</p> <pre><code>! /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id k8s\n}\nvrrp_script check_haproxy {\n  script \"killall -0 haproxy\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface bond0\n    virtual_router_id 51\n    priority 200\n    authentication {\n        auth_type PASS\n        auth_pass ZAXRUlay\n    }\n    virtual_ipaddress {\n        192.168.23.32\n    }\n    track_script {\n        check_haproxy\n    }\n}\n</code></pre> <p>\u6ce8\uff1a \u4e24\u4e2a\u8282\u70b9\u7684\u914d\u7f6e\u4ec5\u6709 <code>priority 200</code> \u5904\u4e0d\u540c\uff0c<code>node29</code> \u7684\u914d\u7f6e\u4e3a <code>priority 150</code>.</p>"},{"location":"kubernetes/kubernetes-setup/#haproxy","title":"haproxy","text":"<p><code>haproxy</code> \u5728\u4e09\u4e2a\u8282\u70b9\u4e0a\u7684\u914d\u7f6e\u90fd\u76f8\u540c\uff0c\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/haproxy/haproxy.cfg</code> </p> <pre><code>global\n  log 127.0.0.1    local2\n  chroot /var/lib/haproxy\n  pidfile /var/run/haproxy.pid\n  maxconn 4000\n  user haproxy\n  group haproxy\n  daemon\n\ndefaults\n  log global\n  mode http\n  option dontlognull\n  timeout connect 5000ms\n  timeout client 600000ms\n  timeout server 600000ms\n\nlisten stats\n    bind :19090\n    mode http\n    balance\n    stats uri /haproxy_stats\n    stats auth admin:admin@123!\n    stats admin if TRUE\n\nfrontend kube-apiserver\n   mode tcp\n   option tcplog\n   bind *:8443\n   default_backend kube-apiserver-backend\n\nbackend kube-apiserver-backend\n    mode tcp\n    balance roundrobin\n    server node27.k8s.wgzhao.com node27:6443 check\n    server node28.k8s.wgzhao.com node28:6443 check\n    server node29.k8s.wgzhao.com node29:6443 check\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#kubernetes","title":"kubernetes \u5b89\u88c5","text":""},{"location":"kubernetes/kubernetes-setup/#_3","title":"\u90e8\u7f72\u73af\u5883\u8bf4\u660e","text":"<p>\u6211\u4eec\u4f7f\u7528 <code>kubeadm</code> \u642d\u5efa\u4e00\u4e2a\u9ad8\u53ef\u7528\u7684k8s\u96c6\u7fa4\uff0c\u9ad8\u53ef\u7528\u4e3b\u8981\u4f53\u73b0\u5728\u5bf9 <code>master</code>\u8282\u70b9\u7ec4\u4ef6\u53ca <code>etcd</code> \u5b58\u50a8\u7684\u9ad8\u53ef\u7528\uff0c\u672c\u6b21\u90e8\u7f72\u4f7f\u7528\u5230\u7684\u670d\u52a1\u5668 IP \u53ca\u89d2\u8272\u5bf9\u5e94\u5982\u4e0b\uff1a</p> \u4e3b\u673a\u540d\u79f0 IP \u5730\u5740 \u89d2\u8272 node.k8s.wgzhao.com 192.168.23.32 VIP node27.k8s.wgzhao.com 192.168.23.27 master/node node28.k8s.wgzhao.com 192.168.23.28 master/node node29.k8s.wgzhao.com 192.168.23.29 master/node node30.k8s.wgzhao.com 192.168.23.30 node node31.k8s.wgzhao.com 192.168.23.31 node"},{"location":"kubernetes/kubernetes-setup/#_4","title":"\u96c6\u7fa4\u67b6\u6784\u53ca\u90e8\u7f72\u51c6\u5907","text":"<p>\u642d\u5efa\u4e09\u4e2a master \u901a\u8fc7 <code>keepalived</code> \u63d0\u4f9b\u4e00\u4e2a <code>vip</code> \u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u5e76\u4e14\u6dfb\u52a0 <code>haproxy</code>\u6765\u4e3a <code>apiserver</code> \u63d0\u4f9b\u53cd\u5411\u4ee3\u7406\u7684\u4f5c\u7528\u3002 \u8fd9\u6837\u6765\u81ea <code>haproxy</code> \u7684\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u8f6e\u8be2\u8f6c\u53d1\u5230\u540e\u7aef\u7684 <code>master</code> \u8282\u70b9\u4e0a\u3002\u5e94\u67b6\u6784\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5728\u5b89\u88c5\u4e4b\u524d\u8981\u63d0\u524d\u505a\u597d\u4ee5\u4e0b\u4e8b\u60c5\uff1a</p> <ol> <li>\u4fee\u6539hosts\u6587\u4ef6\uff0c\u4fdd\u8bc1\u6bcf\u4e2a\u8282\u70b9\u90fd\u80fd ping \u901a\u8bbe\u5b9a\u7684\u4e3b\u673a\u540d</li> <li>\u6240\u6709\u4e3b\u673a\u7684\u65f6\u95f4\u5fc5\u987b\u540c\u6b65\uff0c\u914d\u7f6e\u5e76\u5f00\u542f <code>ntpd</code> \u670d\u52a1</li> <li>\u5173\u95ed\u9632\u706b\u5899</li> <li>\u5173\u95ed selinux</li> <li>\u7981\u7528 swap\uff0c\u5e76\u5728 <code>/etc/fstab</code> \u4e2d\u6ce8\u91ca\u76f8\u5e94\u7684\u914d\u7f6e</li> <li>\u914d\u7f6e\u5fc5\u8981\u7684\u7cfb\u7edf\u53c2\u6570</li> <li>\u5f00\u542f\u8def\u7531         <pre><code>cat /etc/sysctl.d/k8s.conf\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\n</code></pre><ol> <li>\u914d\u7f6e\u8d44\u6e90\u6587\u4ef6     <pre><code>$ echo \"* soft nofile 65536\" &gt;&gt; /etc/security/limits.conf\n$ echo \"* hard nofile 65536\" &gt;&gt; /etc/security/limits.conf\n$ echo \"* soft nproc 65536\"  &gt;&gt; /etc/security/limits.conf\n$ echo \"* hard nproc 65536\"  &gt;&gt; /etc/security/limits.conf\n$ echo \"* soft  memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\n$ echo \"* hard memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\n</code></pre></li> </ol> </li> </ol>"},{"location":"kubernetes/kubernetes-setup/#docker","title":"\u5b89\u88c5\u548c\u914d\u7f6e Docker","text":"<p>\u4ee5\u4e0b\u64cd\u4f5c\u5728\u6240\u6709\u8282\u70b9\u4e0a\u6267\u884c</p> <pre><code>yum install -y docker-ce \n\ncat -&gt; /etc/docker/daemon.json &lt;&lt;EOF\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"100m\"\n  },\n  \"storage-driver\": \"overlay2\",\n  \"storage-opts\": [\n    \"overlay2.override_kernel_check=true\"\n  ]\n}\nEOF\n\n# systemctl daemon-realod\n# systemctl enable --now docker\n# systemctl start docker\n</code></pre> <p>\u68c0\u67e5 docker \u4fe1\u606f</p> <pre><code># docker info\n\nClient:\n Context:    default\n Debug Mode: false\n Plugins:\n  app: Docker App (Docker Inc., v0.9.1-beta3)\n  buildx: Docker Buildx (Docker Inc., v0.7.1-docker)\n  scan: Docker Scan (Docker Inc., v0.12.0)\n\nServer:\n Containers: 14\n  Running: 12\n  Paused: 0\n  Stopped: 2\n Images: 23\n Server Version: 20.10.12\n Storage Driver: overlay2\n  Backing Filesystem: xfs\n  Supports d_type: true\n  Native Overlay Diff: true\n  userxattr: false\n Logging Driver: json-file\n Cgroup Driver: systemd\n Cgroup Version: 1\n Plugins:\n  Volume: local\n  Network: bridge host ipvlan macvlan null overlay\n  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\n  docker info\nClient:\n Context:    default\n Debug Mode: false\n Plugins:\n  app: Docker App (Docker Inc., v0.9.1-beta3)\n  buildx: Docker Buildx (Docker Inc., v0.7.1-docker)\n  scan: Docker Scan (Docker Inc., v0.12.0)\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#kubernetes_1","title":"\u51c6\u5907 kubernetes \u6240\u9700\u7684\u955c\u50cf","text":"<p>\u56e0\u4e3a\u670d\u52a1\u5668\u65e0\u6cd5\u76f4\u63a5\u8054\u7f51\uff0c\u8fd9\u90e8\u5206\u9700\u8981\u5148\u81ea\u884c\u4ece\u7f51\u7edc\u4e0a\u4e0b\u8f7d\u6240\u9700\u8981\u7684\u955c\u50cf\uff0c\u7136\u540e\u6253\u5305\u4e0a\u4f20\u5230\u6bcf\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u52a0\u8f7d\u955c\u50cf\uff0c\u9700\u8981\u7684\u955c\u50cf\u5927\u81f4\u5982\u4e0b\uff1a</p> <p>\u4e0a\u8ff0\u53ea\u6709\u4e00\u884c\u8bdd\uff0c\u4f46\u5e94\u8be5\u662f\u6574\u4e2a\u90e8\u7f72\u91cc\u8017\u65f6\u6700\u957f\u7684\u64cd\u4f5c</p> <pre><code># docker images |grep 'k8s.gcr.io'\nk8s.gcr.io/kube-apiserver                        v1.23.1    b6d7abedde39   3 weeks ago    135MB\nk8s.gcr.io/kube-proxy                            v1.23.1    b46c42588d51   3 weeks ago    112MB\nk8s.gcr.io/kube-controller-manager               v1.23.1    f51846a4fd28   3 weeks ago    125MB\nk8s.gcr.io/kube-scheduler                        v1.23.1    71d575efe628   3 weeks ago    53.5MB\nk8s.gcr.io/controller                            v1.1.0     ae1a7201ec95   7 weeks ago    285MB\nk8s.gcr.io/metrics-server                        v0.5.2     f73640fb5061   8 weeks ago    64.3MB\nk8s.gcr.io/flannel                               v0.15.1    e6ea68648f0c   2 months ago   69.5MB\nk8s.gcr.io/etcd                                  3.5.1-0    25f8c7f3da61   2 months ago   293MB\nk8s.gcr.io/kube-webhook-certgen                  v1.1.1     c41e9fcadf5a   3 months ago   47.7MB\nk8s.gcr.io/coredns/coredns                       v1.8.6     a4ca41631cc7   3 months ago   46.8MB\nk8s.gcr.io/coredns                               v1.8.6     a4ca41631cc7   3 months ago   46.8MB\nk8s.gcr.io/pause                                 3.6        6270bb605e12   4 months ago   683kB\nk8s.gcr.io/defaultbackend-amd64                  1.5        b5af743e5984   3 years ago    5.13MB\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#kubadm-kubelet-kubectl","title":"\u5b89\u88c5 kubadm, kubelet, kubectl","text":"<pre><code># yum install -y kubeadm kubelet kubectl\n# echo \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#master","title":"\u5b89\u88c5 master","text":"<p>\u5728\u5177\u6709 VIP \u5730\u5740\u7684\u670d\u52a1\u5668\u4e0a\u8fdb\u884c\u64cd\u4f5c\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u662f\u5728 <code>node27</code>  \u8282\u70b9\u4e0a</p>"},{"location":"kubernetes/kubernetes-setup/#kubeadm","title":"\u521b\u5efakubeadm\u914d\u7f6e\u6587\u4ef6","text":"<p><pre><code># mkdir -p /etc/kubernetes/manifests`\n</code></pre> \u521b\u5efa  <code>/etc/kubernetes/manifests/kubeadm-config.yaml</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiServer:\n  certSANs:\n    - node27.k8s.wgzhao.com\n    - node28.k8s.wgzhao.com\n    - node29.k8s.wgzhao.com\n    - node.k8s.wgzhao.com\n    - 192.168.23.27\n    - 192.168.23.28\n    - 192.168.23.29\n    - 192.168.23.32\n    - 127.0.0.1\n  extraArgs:\n    authorization-mode: Node,RBAC\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrolPlaneEndpoint: \"node.k8s.wgzhao.com:8443\"\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nkind: ClusterConfiguration\nkubernetesVersion: v1.23.1\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 10.244.0.0/16\n  serviceSubnet: 10.1.0.0/16\nscheduler: {}\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#master_1","title":"\u521d\u59cb\u5316 master \u8282\u70b9","text":"<pre><code># kubeadm init --config /etc/kubernetes/manifests/kubeadm-config.yaml --upload-certs\n</code></pre> <p>\u4e0a\u8ff0\u64cd\u4f5c\u5982\u679c\u6210\u529f\u7684\u8bdd\uff0c\u5219\u5e94\u8be5\u770b\u7c7b\u4f3c\u4e0b\u9762\u7684\u8f93\u51fa</p> <pre><code>Your Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of the control-plane node running the following command on each as root:\n\n  kubeadm join node.k8s.wgzhao.com:8443 --token ko0dqo.ia527mk472eibub9 \\\n        --discovery-token-ca-cert-hash sha256:050903b27c13a642064ea6298458be9d203bcf5def4c5d5af55597a506fd4949 \\\n        --control-plane --certificate-key 34c6b1b15c57c2acff76a99752ba65a11c7cb1593f67fa4f0383b126b5509658\n\nPlease note that the certificate-key gives access to cluster sensitive data, keep it secret!\nAs a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use\n\"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward.\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join node.k8s.wgzhao.com:8443 --token ko0dqo.ia527mk472eibub9 \\\n        --discovery-token-ca-cert-hash sha256:050903b27c13a642064ea6298458be9d203bcf5def4c5d5af55597a506fd4949\n</code></pre> <p>\u4fdd\u5b58\u4e0a\u8ff0\u8f93\u51fa\u5185\u5bb9\u5230\u6587\u672c\u6587\u4ef6\uff0c\u540e\u7eed\u8981\u7528\u5230\u3002</p> <p>\u6309\u7167\u4e0a\u8ff0\u63d0\u793a\uff0c\u8fdb\u884c\u64cd\u4f5c</p> <pre><code># mkdir -p $HOME/.kube\n# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n# sudo chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre> <p>\u67e5\u770b\u96c6\u7fa4\u72b6\u6001</p> <pre><code># kubectl get cs\nNAME                 STATUS    MESSAGE                         ERROR\nscheduler            Healthy   ok\ncontroller-manager   Healthy   ok\netcd-0               Healthy   {\"health\":\"true\",\"reason\":\"\"}\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_5","title":"\u5b89\u88c5\u96c6\u7fa4\u7f51\u7edc","text":"<p>\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6ca1\u6709\u4f7f\u7528 <code>calico</code> \u7f51\u7edc\u7ec4\u4ef6\uff0c\u800c\u662f\u4f7f\u7528\u4e86\u8f83\u8001\u7684<code>flannel</code>\u7f51\u7edc\u7ec4\u4ef6\uff0c\u540e\u7eed\u53ef\u4ee5\u8f6c\u6362\u3002</p> <p>\u4ee5\u4e0b\u64cd\u4f5c\u7ee7\u7eed\u5728 master \u8282\u70b9\u4e0a\u6267\u884c\u3002</p>"},{"location":"kubernetes/kubernetes-setup/#flannel","title":"\u83b7\u53d6 <code>flannel</code> \u7684\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># wget -c -O kube-flannel.yaml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n</code></pre> <p>\u8fd9\u91cc\u6ce8\u610f\u8282\u70b9\uff1a</p> <ol> <li>\u65e0\u6cd5\u8bbf\u95ee\u5916\u7f51\u7684\u60c5\u51b5\u4e0b\uff0c\u5148\u5c06\u6587\u4ef6\u590d\u5236\u5230\u672c\u5730\uff0c\u7136\u540e\u7c98\u8d34\u6216\u8005\u4e0a\u4f20\u5230\u670d\u52a1\u5668</li> <li>\u67e5\u770b\u8be5\u6587\u4ef6\u4e2d\u6d89\u53ca\u5230\u54ea\u4e9b\u955c\u50cf\uff0c\u5982\u679c\u672c\u5730\u4e0d\u5b58\u5728\uff0c\u5219\u9700\u8981\u5148\u4e0b\u8f7d\u7136\u540e\u4e0a\u4f20\u5230\u6240\u6709\u670d\u52a1\u5668</li> <li>\u540e\u7eed\u64cd\u4f5c\u5747\u9700\u8981\u8003\u8651\u4ee5\u4e0a\u6b65\u9aa4</li> </ol>"},{"location":"kubernetes/kubernetes-setup/#_6","title":"\u5b89\u88c5","text":"<pre><code># kubectl apply -f kube-flannel.yml \npodsecuritypolicy.policy/psp.flannel.unprivileged created\nclusterrole.rbac.authorization.k8s.io/flannel created\nclusterrolebinding.rbac.authorization.k8s.io/flannel created\nserviceaccount/flannel created\nconfigmap/kube-flannel-cfg created\ndaemonset.apps/kube-flannel-ds-amd64 created\ndaemonset.apps/kube-flannel-ds-arm64 created\ndaemonset.apps/kube-flannel-ds-arm created\ndaemonset.apps/kube-flannel-ds-ppc64le created\ndaemonset.apps/kube-flannel-ds-s390x created\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_7","title":"\u68c0\u6d4b\u5b89\u88c5\u662f\u5426\u6210\u529f","text":"<pre><code># kubectl get pods -n kube-system\nNAME                                          READY   STATUS    RESTARTS      AGE\ncoredns-64897985d-6rnps                       1/1     Running   0             27h\ncoredns-64897985d-slpf2                       1/1     Running   0             27h\netcd-node27.k8s.wgzhao.com                      1/1     Running   6             29h\netcd-node28.k8s.wgzhao.com                      1/1     Running   0             27h\netcd-node29.k8s.wgzhao.com                      1/1     Running   0             27h\nkube-apiserver-node27.k8s.wgzhao.com            1/1     Running   0             29h\nkube-apiserver-node28.k8s.wgzhao.com            1/1     Running   0             27h\nkube-apiserver-node29.k8s.wgzhao.com            1/1     Running   0             27h\nkube-controller-manager-node27.k8s.wgzhao.com   1/1     Running   1 (27h ago)   29h\nkube-controller-manager-node28.k8s.wgzhao.com   1/1     Running   0             27h\nkube-controller-manager-node29.k8s.wgzhao.com   1/1     Running   0             27h\nkube-flannel-ds-49j7s                         1/1     Running   0             27h\nkube-flannel-ds-7vzqd                         1/1     Running   0             27h\nkube-flannel-ds-bzkhs                         1/1     Running   0             27h\nkube-flannel-ds-kc67m                         1/1     Running   0             27h\nkube-flannel-ds-qn2v6                         1/1     Running   0             27h\nkube-proxy-6whsp                              1/1     Running   0             29h\nkube-proxy-cndmh                              1/1     Running   0             27h\nkube-proxy-dgv4c                              1/1     Running   0             27h\nkube-proxy-h55bd                              1/1     Running   0             27h\nkube-proxy-jwc9l                              1/1     Running   0             27h\nkube-scheduler-node27.k8s.wgzhao.com            1/1     Running   5 (27h ago)   29h\nkube-scheduler-node28.k8s.wgzhao.com            1/1     Running   0             27h\nkube-scheduler-node29.k8s.wgzhao.com            1/1     Running   0             27h\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_8","title":"\u5176\u4ed6\u8282\u70b9\u52a0\u5165\u96c6\u7fa4","text":"<p>\u9996\u5148\u5c06 master \u8282\u70b9\u4e0a\u7684\u5bc6\u94a5\u53ca\u76f8\u5173\u6587\u4ef6\u62f7\u8d1d\u5230 <code>node28</code>, <code>node29</code> \u4e24\u4e2a\u8282\u70b9\u4e0a</p> <pre><code>[root@node27]# ssh root@node28 mkdir -p /etc/kubernetes/pki/etcd\n[root@node27]# ssh root@node29 mkdir -p /etc/kubernetes/pki/etcd\n[root@node27]# cd /etc/kubernetes\n[root@node27]# scp admin.conf root@node28:/etc/kubernetes/admin.conf     \n[root@node27]# scp admin.conf root@node29:/etc/kubernetes/admin.conf     \n[root@node27]# scp pki/{ca.*,sa.*,front-proxy-ca.*} root@node28:/etc/kubernetes/pki\n[root@node27]# scp pki/{ca.*,sa.*,front-proxy-ca.*} root@node29:/etc/kubernetes/pki\n[root@node27]# scp pki/etcd/ca.* root@node28:/etc/kubernetes/pki/etcd\n[root@node27]# scp pki/etcd/ca.* root@node29:/etc/kubernetes/pki/etcd\n</code></pre> <p>\u5206\u522b\u5728 <code>node28</code>, <code>node29</code> \u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <pre><code>[root@node28]# kubeadm join node.k8s.wgzhao.com:8443 --token ko0dqo.ia527mk472eibub9 \\\n        --discovery-token-ca-cert-hash sha256:050903b27c13a642064ea6298458be9d203bcf5def4c5d5af55597a506fd4949 \\\n        --control-plane --certificate-key 34c6b1b15c57c2acff76a99752ba65a11c7cb1593f67fa4f0383b126b5509658\n</code></pre> <pre><code>[root@node29]# kubeadm join node.k8s.wgzhao.com:8443 --token ko0dqo.ia527mk472eibub9 \\\n        --discovery-token-ca-cert-hash sha256:050903b27c13a642064ea6298458be9d203bcf5def4c5d5af55597a506fd4949 \\\n        --control-plane --certificate-key 34c6b1b15c57c2acff76a99752ba65a11c7cb1593f67fa4f0383b126b5509658\n</code></pre> <p>\u540c\u6837\u6839\u636e\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u793a\u8fdb\u884c\u540e\u7eed\u64cd\u4f5c\uff0c\u4e3b\u8981\u662f\u4e0b\u9762\u7684\u64cd\u4f5c</p> <pre><code>[root@node28]# mkdir -p $HOME/.kube\n[root@node28]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n[root@node28]# chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_9","title":"\u68c0\u67e5\u7ed3\u679c","text":"<pre><code>[root@node27]# kubectl get node\nNAME                  STATUS   ROLES                  AGE   VERSION\nnode27.k8s.wgzhao.com   Ready    control-plane,master   29h   v1.23.1\nnode28.k8s.wgzhao.com   Ready    control-plane,master   27h   v1.23.1\nnode29.k8s.wgzhao.com   Ready    control-plane,master   27h   v1.23.1\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#node","title":"node \u52a0\u5165\u96c6\u7fa4","text":"<p>\u5728\u5269\u4e0b\u7684 <code>node30</code>, <code>node31</code> \u8282\u70b9\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>[root@node30]# kubeadm join node.k8s.wgzhao.com:8443 --token ko0dqo.ia527mk472eibub9 \\\n        --discovery-token-ca-cert-hash sha256:050903b27c13a642064ea6298458be9d203bcf5def4c5d5af55597a506fd4949\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_10","title":"\u68c0\u67e5\u7ed3\u679c","text":"<pre><code>[root@node27]# kubectl get node\nNAME                  STATUS   ROLES                  AGE   VERSION\nnode27.k8s.wgzhao.com   Ready    control-plane,master   29h   v1.23.1\nnode28.k8s.wgzhao.com   Ready    control-plane,master   27h   v1.23.1\nnode29.k8s.wgzhao.com   Ready    control-plane,master   27h   v1.23.1\nnode30.k8s.wgzhao.com   Ready    &lt;none&gt;                 27h   v1.23.1\nnode31.k8s.wgzhao.com   Ready    &lt;none&gt;                 27h   v1.23.1\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#master-node","title":"master \u8282\u70b9\u4e5f\u505a\u4e3anode \u8282\u70b9\u52a0\u5165","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cmaster\u8282\u70b9\u5c06\u6765\u5e76\u4e0d\u4f1a\u5206\u914d pod\uff0c\u8fd9\u91cc\u6211\u4eec\u5e0c\u671b\u6240\u6709\u7684 master \u4e5f\u540c\u65f6\u5145\u5f53 node \u89d2\u8272\u3002\u9700\u8981\u5728\u4efb\u610f master \u8282\u70b9\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>[root@node27]# kubectl taint nodes --all node-role.kubernetes.io/master-\nnode \"node27\" untainted\nnode \"node28\" untainted\nnode \"node29\" untainted\ntaint \"node-role.kubernetes.io/master:\" not found\ntaint \"node-role.kubernetes.io/master:\" not found\n</code></pre>"},{"location":"kubernetes/kubernetes-setup/#_11","title":"\u540e\u7eed\u6269\u5bb9","text":""},{"location":"kubernetes/kubernetes-setup/#worker","title":"\u589e\u52a0 worker  \u8282\u70b9","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0a\u8ff0\u547d\u4ee4\u8f93\u51fa\u7684 <code>token</code> \u6709\u6548\u671f\u662f 24 \u5c0f\u65f6\uff0c\u5982\u679c\u4e4b\u540e\u8981\u52a0\u5165\u96c6\u7fa4\uff0c\u9700\u8981\u91cd\u65b0\u751f\u6210 token\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code># \u663e\u793a\u83b7\u53d6token\u5217\u8868\n$ kubeadm token list\n# \u751f\u6210\u65b0\u7684token\n$ kubeadm token create\n</code></pre> <p>\u9664<code>token</code>\u5916\uff0c<code>join</code>\u547d\u4ee4\u8fd8\u9700\u8981\u4e00\u4e2a<code>sha256</code>\u7684\u503c\uff0c\u901a\u8fc7\u4ee5\u4e0b\u65b9\u6cd5\u8ba1\u7b97</p> <pre><code>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'\n</code></pre> <p>\u7528\u4e0a\u9762\u8f93\u51fa\u7684<code>token</code>\u548c<code>sha256</code>\u7684\u503c\u6216\u8005\u662f\u5229\u7528<code>kubeadm token create --print-join-command</code>\u62fc\u63a5<code>join</code>\u547d\u4ee4\u5373\u53ef</p>"},{"location":"kubernetes/kubernetes-setup/#master_2","title":"\u589e\u52a0 master \u8282\u70b9","text":"<p>\u5982\u679c\u60f3\u8981\u589e\u52a0 master \u8282\u70b9\uff0c\u5927\u81f4\u8fc7\u7a0b\u548c\u589e\u52a0 worker \u8282\u70b9\u5dee\u4e0d\u591a\uff0c\u4f46\u6709\u4e9b\u7ec6\u5fae\u533a\u522b\uff0c\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>"},{"location":"kubernetes/kubernetes-setup/#certificate-key","title":"\u521b\u5efa certificate key","text":"<p>\u8981\u60f3\u4f5c\u4e3a master \u8282\u70b9\u52a0\u5165\uff0c\u9996\u5148\u5f97\u6709 <code>certificate key</code>, \u5728\u96c6\u7fa4\u4e2d\u76ee\u524d\u662f master \u8282\u70b9\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <pre><code>kubeadm init phase upload-certs --upload-certs\n</code></pre> <p>\u4f1a\u5f97\u5230\u7c7b\u4f3c\u4e0b\u9762\u7684\u8f93\u51fa</p> <pre><code>W0401 20:29:27.970092    4138 version.go:103] could not fetch a Kubernetes version from the internet: unable to get URL \"https://dl.k8s.io/release/stable-1.txt\": Get \"https://dl.k8s.io/release/stable-1.txt\": dial tcp: lookup dl.k8s.io on [::1]:53: read udp [::1]:49473-&gt;[::1]:53: read: connection refused\nW0401 20:29:27.970196    4138 version.go:104] falling back to the local client version: v1.23.1\n[upload-certs] Storing the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace\n[upload-certs] Using certificate key:\na551f2def4e697f7a11672bae42cc3cd9f0bf7a274455fe7dd0493c9f95a5da1\n</code></pre> <p>\u4e0a\u8ff0\u8f93\u51fa\u7684\u6700\u540e\u4e00\u884c hash <code>a551f2def4e697f7a11672bae42cc3cd9f0bf7a274455fe7dd0493c9f95a5da1</code> \u503c\u5c31\u662f <code>certificate key</code></p> <p>\u63a5\u7740\u521b\u5efa\u7528\u4e8e join \u7684\u6307\u4ee4</p> <pre><code>kubeadm token create --certificate-key a551f2def4e697f7a11672bae42cc3cd9f0bf7a274455fe7dd0493c9f95a5da1 \\\n  --print-join-command\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u4f1a\u83b7\u5f97\u4e0b\u9762\u7684\u8f93\u51fa</p> <pre><code>kubeadm join 192.168.23.32:6443 --token guh5md.wgnvivkar5e07oty \\\n  --discovery-token-ca-cert-hash sha256:1b9e1ba8899715e67410236b6e478438da4403163afb3bd2439498622df4ceb6 \\\n  --control-plane --certificate-key a551f2def4e697f7a11672bae42cc3cd9f0bf7a274455fe7dd0493c9f95a5da1\n</code></pre> <p>\u7136\u540e\u5728\u9700\u8981\u4f5c\u4e3a master \u8282\u70b9\u7684\u673a\u5668\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4</p> <pre><code>kubeadm join 192.168.23.32:6443 --token guh5md.wgnvivkar5e07oty \\\n  --discovery-token-ca-cert-hash sha256:1b9e1ba8899715e67410236b6e478438da4403163afb3bd2439498622df4ceb6 \\\n  --control-plane --certificate-key a551f2def4e697f7a11672bae42cc3cd9f0bf7a274455fe7dd0493c9f95a5da1 \\\n  --apiserver-advertise-address 192.168.23.100\n</code></pre> <p>\u6ce8\u610f\u4e0a\u8ff0\u547d\u4ee4\u589e\u52a0\u4e86 <code>--apiserver-advertise-address 192.168.23.100</code>\uff0c\u8fd9\u7b49\u4e8e\u544a\u8bc9\u5176\u4ed6\u8282\u70b9\uff0c\u589e\u52a0\u4e86\u4e00\u4e2a <code>api-server</code></p> <p>\u4e0a\u8ff0\u547d\u4ee4\u4f1a\u5f97\u5230\u5982\u4e0b\u7684\u8f93\u51fa\uff1a</p> <pre><code>[preflight] Running pre-flight checks\n[preflight] Reading configuration from the cluster...\n[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'\n[preflight] Running pre-flight checks before initializing the new control plane instance\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'\n[download-certs] Downloading the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"apiserver\" certificate and key\n....\n\n[kubeconfig] Generating kubeconfig files\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/admin.conf\"\n...\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/scheduler.conf\"\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[check-etcd] Checking that the etcd cluster is healthy\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...\n[etcd] Announced new etcd member joining to the existing etcd cluster\n[etcd] Creating static Pod manifest for \"etcd\"\n[etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s\nThe 'update-status' phase is deprecated and will be removed in a future release. Currently it performs no operation\n[mark-control-plane] Marking the node node100 as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node node100 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]\n</code></pre> <p>\u7b49\u5f85\u4e00\u5206\u949f\uff0c\u7136\u540e\u5728\u8be5\u8282\u70b9\u4e0a\u6267\u884c <code>kubectl get nodes</code> \u5e94\u8be5\u5c31\u53ef\u4ee5\u770b\u5230\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u5e76\u663e\u793a\u4e3a <code>control-plane, master</code> \u89d2\u8272\u4e86\u3002</p>"},{"location":"kubernetes/take-flannel-to-calico/","title":"Migrate kubernetes cluster from Flannel to Calico","text":"<p>Source</p> <p>4 MINUTE READ </p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#big-picture","title":"Big picture","text":"<p>Migrate an existing Kubernetes cluster with flannel/Canal to Calico networking.</p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#value","title":"Value","text":"<p>If you are already using flannel for networking, it is easy to migrate to Calico\u2019s native VXLAN networking. Calico VXLAN is fully equivalent to flannel vxlan, but you get the benefits of the broader range of features offered by Calico with an active maintainer community.</p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#concepts","title":"Concepts","text":"","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#limitations-of-host-local-ipam-in-flannel","title":"Limitations of host-local IPAM in flannel","text":"<p>Flannel networking uses the host-local IPAM (IP address management) CNI plugin, which provides simple IP address management for your cluster. Although simple, it has limitations:</p> <ul> <li>When you create a node, it is pre-allocated a CIDR. If the number of pods per-node exceeds the number of IP addresses available per node, you must recreate the cluster. Conversely, if the number of pods is much smaller than the number of addresses available per node, IP address space is not efficiently used; as you scale out and IP addresses are depleted, inefficiencies become a pain point.</li> <li>Because each node has a pre-allocated CIDR, pods must always have an IP address assigned based on the node it is running on. Being able to allocate IP addresses based on other attributes (for example, the pod\u2019s namespace), provides flexiblity to meet use cases that arise.</li> </ul> <p>Migrating to Calico IPAM solves these use cases and more. For advantages of Calico IPAM, see Blog: Live Migration from Flannel to Calico.</p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#methods-for-migrating-to-calico-networking","title":"Methods for migrating to Calico networking","text":"<p>There are two ways to switch your cluster to use Calico networking. Both methods give you a fully-functional Calico cluster using VXLAN networking between pods.</p> <ul> <li>Create a new cluster using Calico and migrate existing workloads</li> </ul> <p>If you have the ability to migrate worloads from one cluster to the next without caring about downtime, this is the easiest method: create a new cluster using Calico. * Live migration on an existing cluster</p> <p>If your workloads are already in production, or downtime is not an option, use the live migration tool that performs a rolling update of each node in the cluster.</p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#before-you-begin","title":"Before you begin\u2026","text":"<p>Required</p> <ul> <li>A cluster with flannel for networking using the VXLAN backend.</li> <li>Flannel version v0.9.1 or higher (Canal version v3.7.0 or greater).</li> <li>Flannel must have been installed using a Kubernetes daemon set and configured: </li> <li>To use the Kubernetes API for storing its configuration (as opposed to etcd)</li> <li>With <code>DirectRouting</code> disabled (default)</li> <li>Cluster must allow for: </li> <li>Adding/deleting/modifying node labels</li> <li>Modifying and deleting of the flannel daemon set. For example, it must not be installed using the Kubernetes Addon-manager.</li> </ul>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#how-to","title":"How to","text":"<ul> <li>Migrate from flannel networking to Calico networking, live migration</li> <li>Modify flannel configuration</li> <li>View migration status</li> <li>View migration logs</li> <li>Revert migration</li> </ul>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#migrate-from-flannel-networking-to-calico-networking-live-migration","title":"Migrate from flannel networking to Calico networking, live migration","text":"<ol> <li> <p>Install Calico.</p> <p>kubectl apply -f https://docs.projectcalico.org/manifests/flannel-migration/calico.yaml 2. Start the migration controller.</p> <p>kubectl apply -f https://docs.projectcalico.org/manifests/flannel-migration/migration-job.yaml</p> </li> </ol> <p>You will see nodes begin to update one at a time. 3. Monitor the migration.</p> <pre><code>  kubectl get jobs -n kube-system flannel-migration\n</code></pre> <p>When the host node is upgraded, the migration controller may be rescheduled several times. The installation is complete when the output of the above command shows 1/1 completions. For example:</p> <pre><code>  NAME                COMPLETIONS   DURATION   AGE\nflannel-migration   1/1           2m59s      5m9s\n</code></pre> <ol> <li> <p>Delete the migration controller.</p> <p>kubectl delete -f https://docs.projectcalico.org/manifests/flannel-migration/migration-job.yaml</p> </li> </ol>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#modify-flannel-configuration","title":"Modify flannel configuration","text":"<p>The migration controller autodetects your flannel configuration, and in most cases, does not require additional configuration. If you require special configuration, the migration tool provides the following options, which can be set as environment variables within the pod.</p> <p>Configuration optionsDescriptionDefaultFLANNEL_NETWORKIPv4 network CIDR used by flannel for the cluster.Automatically detectedFLANNEL_DAEMONSET_NAMEName of the flannel daemon set in the kube-system namespace.kube-flannel-ds-amd64FLANNEL_MTUMTU for the flannel VXLAN device.Automatically detectedFLANNEL_IP_MASQWhether masquerading is enabled for outbound traffic.Automatically detectedFLANNEL_SUBNET_LENPer-node subnet length used by flannel.24FLANNEL_ANNOTATION_PREFIXValue provided via the kube-annotation-prefix option to flannel.flannel.alpha.coreos.comFLANNEL_VNIThe VNI used for the flannel network.1FLANNEL_PORTUDP port used for VXLAN.8472CALICO_DAEMONSET_NAMEName of the calico daemon set in the kube-system namespace.calico-nodeCNI_CONFIG_DIRFull path on the host in which to search for CNI config files./etc/cni/net.d</p>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#view-migration-status","title":"View migration status","text":"<p>View the controller\u2019s current status.</p> <pre><code>kubectl get pods -n kube-system -l k8s-app=flannel-migration-controller\n</code></pre>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#view-migration-logs","title":"View migration logs","text":"<p>View migration logs to see if any actions are required.</p> <pre><code>kubectl logs -n kube-system -l k8s-app=flannel-migration-controller\n</code></pre>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#revert-migration","title":"Revert migration","text":"<p>If you need to revert a cluster from Calico back to flannel, follow these steps.</p> <ol> <li> <p>Remove the migration controller and Calico.</p> <p>kubectl delete -f https://docs.projectcalico.org/manifests/flannel-migration/migration-job.yaml kubectl delete -f https://docs.projectcalico.org/manifests/flannel-migration/calico.yaml 2. Determine the nodes that were migrated to Calico.</p> <p>kubectl get nodes -l projectcalico.org/node-network-during-migration=calico</p> </li> </ol> <p>Then, for each node found above, run the following commands to delete Calico.</p> <ol> <li> <p>Cordon and drain the node.</p> <p>kubectl drain  2. Log in to the node and remove the CNI configuration. <p>rm /etc/cni/net.d/10-calico.conflist 3. Reboot the node. 4. Enable flannel on the node.</p> <p>kubectl label node  projectcalico.org/node-network-during-migration=flannel --overwrite 5. Uncordon the node. <p>kubectl uncordon  <p>After the above steps have been completed on each node, perform the following steps.</p> <ol> <li> <p>Remove the <code>nodeSelector</code> from the flannel daemonset.</p> <p>kubectl patch ds/kube-flannel-ds-amd64 -n kube-system -p '{\"spec\": {\"template\": {\"spec\": {\"nodeSelector\": null}}}}' 2. Remove the migration label from all nodes.</p> <p>kubectl label node --all projectcalico.org/node-network-during-migration-</p> </li> </ol>","tags":["kubernetes","flannel","calico"]},{"location":"kubernetes/take-flannel-to-calico/#next-steps","title":"Next steps","text":"<p>Learn about Calico IP address management</p> <p>SlackDiscourseGitHubTwitterYouTubeFree Online Training</p>","tags":["kubernetes","flannel","calico"]},{"location":"misc/Latex%20Math%20Symbols/","title":"\u7528\u4e8e LateX \u7684\u6570\u5b66\u7b26\u53f7","text":"<p>http://web.ift.uib.no/Teori/KURS/WRK/TeX/symALL.html \u6709\u5e38\u7528\u7684\u6570\u5b66\u7b26\u53f7\u7684LaTex \u5199\u6cd5\uff0c\u4e0b\u9762\u7684 PDF \u6587\u4ef6\u6765\u81ea\u8be5\u7f51\u7ad9</p> <p>Latex Math Symbols.pdf</p> <p>\u540c\u65f6\u6211\u628a\u7f51\u7ad9\u5185\u5bb9\u590d\u5236\u5230\u8fd9\u91cc\uff0c\u65b9\u4fbf\u67e5\u8be2</p>","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#greek-symbols","title":"\u5e0c\u814a\u5b57\u6bcd(Greek symbols)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#binary-operation-symbols","title":"\u4e8c\u8fdb\u5236\u64cd\u4f5c\u7b26(binary operation symbols)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#relation-symbols","title":"\u5173\u7cfb\u7b26\u53f7\uff08Relation Symbols)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#punctuation-symbols","title":"\u6807\u8bb0\u7b26\u53f7(Punctuation Symbols\uff09","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#arrow-symbols","title":"\u7bad\u5934\u7b26\u53f7\uff08Arrow Symbols\uff09","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#miscellaneous-symbols","title":"\u5176\u4ed6\u7b26\u53f7\uff08Miscellaneous Symbols\uff09","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#variable-sized-symbols","title":"\u53ef\u53d8\u5927\u5c0f\u7b26\u53f7(Variable-sized  Symbols)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#log-like-symbols","title":"\u5bf9\u6570\u76f8\u4f3c\u7b26\u53f7(Log-like Symbols)","text":"<p>LaTex \u6307\u4ee4</p> <pre><code> \\arccos     \\cos       \\csc      \\exp      \\ker         \\limsup      \\min      \\sinh  \n \\arcsin     \\cosh      \\deg      \\gcd      \\lg          \\ln          \\Pr       \\sup \n \\arctan     \\cot       \\det      \\hom      \\lim         \\log         \\sec      \\tan\n \\arg        \\coth      \\dim      \\inf      \\liminf      \\max         \\sin      \\tanh\n</code></pre> <p>\u5bf9\u5e94\u7684\u7b26\u53f7</p>","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#delimiters","title":"\u754c\u5b9a\u7b26(Delimiters)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#large-delimiters","title":"\u5927\u754c\u5b9a\u7b26(Large Delimiters)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#math-mode-accents","title":"\u6570\u5b66\u6a21\u5f0f\u53d8\u97f3\u7b26(Math mode accents)","text":"","tags":["latex","math","symbol"]},{"location":"misc/Latex%20Math%20Symbols/#some-other-constructions","title":"\u5176\u4ed6\u7ed3\u6784(Some other constructions)","text":"<p>\u540c\u6837\u7684\u4e0a\u8ff0\u6587\u6863\u662f\u4ece\u4ee5\u4e0b\u7684 LaTex \u4ee3\u7801\u751f\u6210</p> <pre><code>%%% ====================================================================\n%%%  @LaTeX-file{\n%%%     filename        = \"symbols.tex\",\n%%%     version         = \"2.00\",\n%%%     date            = \"12 June 1992\",\n%%%     time            = \"17:19:25 BST\",\n%%%     author          = \"David Carlisle\",\n%%%     address         = \"Computer Science Department\n%%%                        Manchester University\n%%%                        Oxford Road\n%%%                        Manchester\n%%%                        England\n%%%                        M13 9PL\",\n%%%     telephone       = \"+44 61 275 6139\",\n%%%     FAX             = \"+44 61 275 6236\",\n%%%     checksum        = \"15177 476 1350 17118\",\n%%%     email           = \"carlisle@cs.man.ac.uk (Internet)\",\n%%%     codetable       = \"ISO/ASCII\",\n%%%     keywords        = \"LaTeX, NFSS, AMSFonts, symbols\",\n%%%     supported       = \"yes\",\n%%%     docstring       = \"\n%%%\n%%%     symbols.tex\n%%%\n%%%     A listing of all the standard LaTeX, and AMS symbols.\n%%%     and Math Alphabets.\n%%%\n%%%     If used with NFSS, It requires amssymb.sty and AMSFonts.\n%%%     If used without NFSS, It does not show the AMS Fonts.\n%%%\n%%%     The checksum field above was produced by\n%%%     Robert Solovay's checksum utility.\",\n%%%  }\n%%% ====================================================================\n\n\\ifx\\selectfont\\undefined\n% Old Style LaTeX\n    \\documentstyle{article}\n\\else\n% NFSS-specific code\n\n               % You never noticed did you!\n    \\count18=3 % Well I am not supposed to know what \\count18 is\n               % used for, but if this wasn't here, you would have\n           % to use a format based on basefont.tex\n\n    \\documentstyle[amssymb]{article}\n\n%   Cyrillic and Script are done like this to save on the bold math\n%   groups. Otherwise this document can only be processed by a format\n%   based on basefont.tex\n%   If you do not want these *and* all the AMS stuff, you can use\n%   euscript and dpccyr style options to get these fonts, but then you\n%   run out of math groups (you can only have 16) unless your latex is\n%   based on basefont.tex.\n\n%    If your format is  based on fontdef.max, you do not need\n%    these \\new@fontshape commands, but they will not do any harm.\n    \\makeatletter\n    \\new@fontshape{UWCyr}{m}{n}{%\n       &lt;5&gt;wncyr5%\n       &lt;6&gt;wncyr6%\n       &lt;7&gt;wncyr7%\n       &lt;8&gt;wncyr8%\n       &lt;9&gt;wncyr9%\n       &lt;10&gt;wncyr10%\n       &lt;11&gt;wncyr10 at10.95pt%\n       &lt;12&gt;wncyr10 at12pt%\n       &lt;14&gt;wncyr10 at14.4pt%\n       &lt;17&gt;wncyr10 at17.28pt%\n       &lt;20&gt;wncyr10 at20.74pt%\n       &lt;25&gt;wncyr10 at24.88pt}{}\n\n    \\new@fontshape{eus}{m}{n}{%\n       &lt;5&gt;eusm5%\n       &lt;6&gt;eusm6%\n       &lt;7&gt;eusm7%\n       &lt;8&gt;eusm8%\n       &lt;9&gt;eusm9%\n       &lt;10&gt;eusm10%\n       &lt;11&gt;eusm10 at10.95pt%\n       &lt;12&gt;eusm10 at12pt%\n       &lt;14&gt;eusm10 at14.4pt%\n       &lt;17&gt;eusm10 at17.28pt%\n       &lt;20&gt;eusm10 at20.74pt%\n       &lt;25&gt;eusm10 at24.88pt}{}\n    \\makeatother\n\n    \\newmathalphabet{\\mathcyr}\n    \\addtoversion{normal}{\\mathcyr}{UWCyr}{m}{n}\n    \\newmathalphabet{\\EuScript}\n    \\addtoversion{normal}{\\EuScript}{eus}{m}{n}\n\n%   A few symbols omitted from amssymb.sty\n    \\newsymbol\\Finv 2060\n    \\newsymbol\\Game 2061\n    \\newsymbol\\Bbbk 207C\n    \\newsymbol\\diagup 231E\n    \\newsymbol\\diagdown 231F\n    \\newsymbol\\nsucceqq 230F\n%\n\\fi\n% end of NFSS-specific code\n\n% Math-mode symbol &amp; verbatim\n\\def\\W#1#2{$#1{#2}$ &amp;\\tt\\string#1\\string{#2\\string}}\n\\def\\X#1{$#1$ &amp;\\tt\\string#1}\n\\def\\Y#1{$\\big#1$ &amp;\\tt\\string#1}\n\\def\\Z#1{\\tt\\string#1}\n\n% A non-floating table environment.\n\\makeatletter\n\\renewenvironment{table}%\n   {\\vskip\\intextsep\\parskip\\z@\n    \\vbox\\bgroup\\centering\\def\\@captype{table}}%\n   {\\egroup\\vskip\\intextsep}\n\\makeatother\n\n% All the tables are \\label'ed in case this document ever gets some\n% explanatory text written, however there are no \\refs as yet. To save\n% LaTeX-ing the file twice we go:\n\\renewcommand{\\label}[1]{}\n\n% A4 page setup\n\\topmargin -45pt\n\\textwidth=532pt\n\\oddsidemargin=-40pt \\evensidemargin\\oddsidemargin\n\\textheight 682pt\n\n\\begin{document}\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\alpha        &amp;\\X\\theta       &amp;\\X o           &amp;\\X\\tau         \\\\\n\\X\\beta         &amp;\\X\\vartheta    &amp;\\X\\pi          &amp;\\X\\upsilon     \\\\\n\\X\\gamma        &amp;\\X\\gamma       &amp;\\X\\varpi       &amp;\\X\\phi         \\\\\n\\X\\delta        &amp;\\X\\kappa       &amp;\\X\\rho         &amp;\\X\\varphi      \\\\\n\\X\\epsilon      &amp;\\X\\lambda      &amp;\\X\\varrho      &amp;\\X\\chi         \\\\\n\\X\\varepsilon   &amp;\\X\\mu          &amp;\\X\\sigma       &amp;\\X\\psi         \\\\\n\\X\\zeta         &amp;\\X\\nu          &amp;\\X\\varsigma    &amp;\\X\\omega       \\\\\n\\X\\eta          &amp;\\X\\xi                                          \\\\\n                                                                \\\\\n\\X\\Gamma        &amp;\\X\\Lambda      &amp;\\X\\Sigma       &amp;\\X\\Psi         \\\\\n\\X\\Delta        &amp;\\X\\Xi          &amp;\\X\\Upsilon     &amp;\\X\\Omega       \\\\\n\\X\\Theta        &amp;\\X\\Pi          &amp;\\X\\Phi\n\\end{tabular}\n\\caption{Greek Letters}\\label{greek}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\pm           &amp;\\X\\cap         &amp;\\X\\diamond             &amp;\\X\\oplus     \\\\\n\\X\\mp           &amp;\\X\\cup         &amp;\\X\\bigtriangleup       &amp;\\X\\ominus    \\\\\n\\X\\times        &amp;\\X\\uplus       &amp;\\X\\bigtriangledown     &amp;\\X\\otimes    \\\\\n\\X\\div          &amp;\\X\\sqcap       &amp;\\X\\triangleleft        &amp;\\X\\oslash    \\\\\n\\X\\ast          &amp;\\X\\sqcup       &amp;\\X\\triangleright       &amp;\\X\\odot      \\\\\n\\X\\star         &amp;\\X\\vee         &amp;\\X\\lhd$^b$             &amp;\\X\\bigcirc   \\\\\n\\X\\circ         &amp;\\X\\wedge       &amp;\\X\\rhd$^b$             &amp;\\X\\dagger    \\\\\n\\X\\bullet       &amp;\\X\\setminus    &amp;\\X\\unlhd$^b$           &amp;\\X\\ddagger   \\\\\n\\X\\cdot         &amp;\\X\\wr          &amp;\\X\\unrhd$^b$           &amp;\\X\\amalg     \\\\\n\\X+             &amp;\\X-\n\\end{tabular}\n\n$^b$ Not predefined in a format based on {\\tt basefont.tex}.\n     Use one of the style options\\\\\n     {\\tt oldlfont}, {\\tt newlfont}, {\\tt amsfonts} or {\\tt amssymb}.\n\n\\caption{Binary Operation Symbols}\\label{bin}\n\\end{table}\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\leq          &amp;\\X\\geq         &amp;\\X\\equiv       &amp;\\X\\models      \\\\\n\\X\\prec         &amp;\\X\\succ        &amp;\\X\\sim         &amp;\\X\\perp        \\\\\n\\X\\preceq       &amp;\\X\\succeq      &amp;\\X\\simeq       &amp;\\X\\mid         \\\\\n\\X\\ll           &amp;\\X\\gg          &amp;\\X\\asymp       &amp;\\X\\parallel    \\\\\n\\X\\subset       &amp;\\X\\supset      &amp;\\X\\approx      &amp;\\X\\bowtie      \\\\\n\\X\\subseteq     &amp;\\X\\supseteq    &amp;\\X\\cong        &amp;\\X\\Join$^b$    \\\\\n\\X\\sqsubset$^b$ &amp;\\X\\sqsupset$^b$&amp;\\X\\neq         &amp;\\X\\smile       \\\\\n\\X\\sqsubseteq   &amp;\\X\\sqsupseteq  &amp;\\X\\doteq       &amp;\\X\\frown       \\\\\n\\X\\in           &amp;\\X\\ni          &amp;\\X\\propto      &amp;\\X=            \\\\\n\\X\\vdash        &amp;\\X\\dashv       &amp;\\X&lt;            &amp;\\X&gt;            \\\\\n\\X:\n\\end{tabular}\n\n$^b$ Not predefined in a format based on {\\tt basefont.tex}.\n     Use one of the style options\\\\\n     {\\tt oldlfont}, {\\tt newlfont}, {\\tt amsfonts} or {\\tt amssymb}.\n\n\\caption{Relation Symbols}\\label{rel}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*{5}{lp{3.2em}}}\n\\X,     &amp;\\X;    &amp;\\X\\colon       &amp;\\X\\ldotp       &amp;\\X\\cdotp\n\\end{tabular}\n\\caption{Punctuation Symbols}\\label{punct}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*6l}\n\\X\\leftarrow            &amp;\\X\\longleftarrow       &amp;\\X\\uparrow     \\\\\n\\X\\Leftarrow            &amp;\\X\\Longleftarrow       &amp;\\X\\Uparrow     \\\\\n\\X\\rightarrow           &amp;\\X\\longrightarrow      &amp;\\X\\downarrow   \\\\\n\\X\\Rightarrow           &amp;\\X\\Longrightarrow      &amp;\\X\\Downarrow   \\\\\n\\X\\leftrightarrow       &amp;\\X\\longleftrightarrow  &amp;\\X\\updownarrow \\\\\n\\X\\Leftrightarrow       &amp;\\X\\Longleftrightarrow  &amp;\\X\\Updownarrow \\\\\n\\X\\mapsto               &amp;\\X\\longmapsto          &amp;\\X\\nearrow     \\\\\n\\X\\hookleftarrow        &amp;\\X\\hookrightarrow      &amp;\\X\\searrow     \\\\\n\\X\\leftharpoonup        &amp;\\X\\rightharpoonup      &amp;\\X\\swarrow     \\\\\n\\X\\leftharpoondown      &amp;\\X\\rightharpoondown    &amp;\\X\\nwarrow     \\\\\n\\X\\rightleftharpoons    &amp;\\X\\leadsto$^b$\n\\end{tabular}\n\n$^b$ Not predefined in a format based on {\\tt basefont.tex}.\n     Use one of the style options\\\\\n     {\\tt oldlfont}, {\\tt newlfont}, {\\tt amsfonts} or {\\tt amssymb}.\n\n\\caption{Arrow Symbols}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\ldots        &amp;\\X\\cdots       &amp;\\X\\vdots       &amp;\\X\\ddots       \\\\\n\\X\\aleph        &amp;\\X\\prime       &amp;\\X\\forall      &amp;\\X\\infty       \\\\\n\\X\\hbar         &amp;\\X\\emptyset    &amp;\\X\\exists      &amp;\\X\\Box$^b$     \\\\\n\\X\\imath        &amp;\\X\\nabla       &amp;\\X\\neg         &amp;\\X\\Diamond$^b$ \\\\\n\\X\\jmath        &amp;\\X\\surd        &amp;\\X\\flat        &amp;\\X\\triangle    \\\\\n\\X\\ell          &amp;\\X\\top         &amp;\\X\\natural     &amp;\\X\\clubsuit    \\\\\n\\X\\wp           &amp;\\X\\bot         &amp;\\X\\sharp       &amp;\\X\\diamondsuit \\\\\n\\X\\Re           &amp;\\X\\|           &amp;\\X\\backslash   &amp;\\X\\heartsuit   \\\\\n\\X\\Im           &amp;\\X\\angle       &amp;\\X\\partial     &amp;\\X\\spadesuit   \\\\\n\\X\\mho$^b$      &amp;\\X.            &amp;\\X|\n\\end{tabular}\n\n$^b$ Not predefined in a format based on {\\tt basefont.tex}.\n     Use one of the style options\\\\\n     {\\tt oldlfont}, {\\tt newlfont}, {\\tt amsfonts} or {\\tt amssymb}.\n\n\\caption{Miscellaneous Symbols}\\label{ord}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*6l}\n\\X\\sum          &amp;\\X\\bigcap      &amp;\\X\\bigodot     \\\\\n\\X\\prod         &amp;\\X\\bigcup      &amp;\\X\\bigotimes   \\\\\n\\X\\coprod       &amp;\\X\\bigsqcup    &amp;\\X\\bigoplus    \\\\\n\\X\\int          &amp;\\X\\bigvee      &amp;\\X\\biguplus    \\\\\n\\X\\oint         &amp;\\X\\bigwedge\n\\end{tabular}\n\\caption{Variable-sized  Symbols}\\label{op}\n\\end{table}\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\Z\\arccos &amp;\\Z\\cos  &amp;\\Z\\csc &amp;\\Z\\exp &amp;\n           \\Z\\ker    &amp;\\Z\\limsup &amp;\\Z\\min &amp;\\Z\\sinh \\\\\n\\Z\\arcsin &amp;\\Z\\cosh &amp;\\Z\\deg &amp;\\Z\\gcd &amp;\n           \\Z\\lg     &amp;\\Z\\ln     &amp;\\Z\\Pr  &amp;\\Z\\sup  \\\\\n\\Z\\arctan &amp;\\Z\\cot  &amp;\\Z\\det &amp;\\Z\\hom &amp;\n           \\Z\\lim    &amp;\\Z\\log    &amp;\\Z\\sec &amp;\\Z\\tan  \\\\\n\\Z\\arg    &amp;\\Z\\coth &amp;\\Z\\dim &amp;\\Z\\inf &amp;\n           \\Z\\liminf &amp;\\Z\\max    &amp;\\Z\\sin &amp;\\Z\\tanh\n\\end{tabular}\n\\caption{Log-like Symbols}\\label{log}\n\\end{table}\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X(             &amp;\\X)            &amp;\\X\\uparrow     &amp;\\X\\Uparrow     \\\\\n\\X[             &amp;\\X]            &amp;\\X\\downarrow   &amp;\\X\\Downarrow   \\\\\n\\X\\{            &amp;\\X\\}           &amp;\\X\\updownarrow &amp;\\X\\Updownarrow \\\\\n\\X\\lfloor       &amp;\\X\\rfloor      &amp;\\X\\lceil       &amp;\\X\\rceil       \\\\\n\\X\\langle       &amp;\\X\\rangle      &amp;\\X/            &amp;\\X\\backslash   \\\\\n\\X|             &amp;\\X\\|\n\\end{tabular}\n\\caption{Delimiters\\label{dels}}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\Y\\rmoustache&amp;  \\Y\\lmoustache&amp;  \\Y\\rgroup&amp;      \\Y\\lgroup\\\\[5pt]\n\\Y\\arrowvert&amp;   \\Y\\Arrowvert&amp;   \\Y\\bracevert\n\\end{tabular}\n\\caption{Large Delimiters\\label{ldels}}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*{10}l}\n\\W\\hat{a}     &amp;\\W\\acute{a}  &amp;\\W\\bar{a}    &amp;\\W\\dot{a}    &amp;\\W\\breve{a}\\\\\n\\W\\check{a}   &amp;\\W\\grave{a}  &amp;\\W\\vec{a}    &amp;\\W\\ddot{a}   &amp;\\W\\tilde{a}\\\\\n\\end{tabular}\n\\caption{Math mode accents}\\label{accent}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*4l}\n\\W\\widetilde{abc}       &amp;\\W\\widehat{abc}                        \\\\\n\\W\\overleftarrow{abc}   &amp;\\W\\overrightarrow{abc}                 \\\\\n\\W\\overline{abc}        &amp;\\W\\underline{abc}                      \\\\\n\\W\\overbrace{abc}       &amp;\\W\\underbrace{abc}                     \\\\[5pt]\n\\W\\sqrt{abc}            &amp;$\\sqrt[n]{abc}$&amp;\\verb|\\sqrt[n]{abc}|   \\\\\n$f'$&amp;\\verb|f'|          &amp;$\\frac{abc}{xyz}$&amp;\\verb|\\frac{abc}{xyz}|\n\\end{tabular}\n\\caption{Some other constructions}\\label{other}\n\\end{table}\n\n\\ifx\\selectfont\\undefined\\expandafter\\stop\\fi\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\ulcorner&amp;\\X\\urcorner&amp;\\X\\llcorner&amp;\\X\\lrcorner\n\\end{tabular}\n\\caption{AMS Delimiters\\label{ams-del}}\n\\end{table}\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\dashrightarrow       &amp;\\X\\dashleftarrow\n        &amp;\\X\\leftleftarrows      &amp;\\X\\leftrightarrows     \\\\\n\\X\\Lleftarrow           &amp;\\X\\twoheadleftarrow\n        &amp;\\X\\leftarrowtail       &amp;\\X\\looparrowleft       \\\\\n\\X\\leftrightharpoons    &amp;\\X\\curvearrowleft\n        &amp;\\X\\circlearrowleft     &amp;\\X\\Lsh                 \\\\\n\\X\\upuparrows           &amp;\\X\\upharpoonleft\n        &amp;\\X\\downharpoonleft     &amp;\\X\\multimap            \\\\\n\\X\\leftrightsquigarrow  &amp;\\X\\rightrightarrows\n        &amp;\\X\\rightleftarrows     &amp;\\X\\rightrightarrows    \\\\\n\\X\\rightleftarrows      &amp;\\X\\twoheadrightarrow\n        &amp;\\X\\rightarrowtail      &amp;\\X\\looparrowright      \\\\\n\\X\\rightleftharpoons    &amp;\\X\\curvearrowright\n        &amp;\\X\\circlearrowright    &amp;\\X\\Rsh                 \\\\\n\\X\\downdownarrows       &amp;\\X\\upharpoonright\n        &amp;\\X\\downharpoonright    &amp;\\X\\rightsquigarrow\n\\end{tabular}\n\n\\caption{AMS Arrows\\label{ams-arrows}}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\nleftarrow   &amp;\\X\\nrightarrow &amp;\\X\\nLeftarrow  &amp;\\X\\nRightarrow \\\\\n\\X\\nleftrightarrow&amp;\\X\\nLeftrightarrow\n\\end{tabular}\n\\caption{AMS Negated Arrows\\label{ams-narrows}}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*4l}\n\\X\\digamma      &amp;\\X\\varkappa\n\\end{tabular}\n\\caption{AMS Greek\\label{ams-greek}}\n\\end{table}\n\n\\begin{table}\n\\begin{tabular}{*6l}\n\\X\\beth &amp;\\X\\daleth      &amp;\\X\\gimel\n\\end{tabular}\n\\caption{AMS Hebrew\\label{ams-hebrew}}\n\\end{table}\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\hbar         &amp;\\X\\hslash      &amp;\\X\\vartriangle &amp;\\X\\triangledown      \\\\\n\\X\\square       &amp;\\X\\lozenge     &amp;\\X\\circledS    &amp;\\X\\angle             \\\\\n\\X\\measuredangle&amp;\\X\\nexists     &amp;\\X\\mho         &amp;\\X\\Finv$^u$          \\\\\n\\X\\Game$^u$     &amp;\\X\\Bbbk$^u$    &amp;\\X\\backprime   &amp;\\X\\varnothing        \\\\\n\\X\\blacktriangle&amp;\\X\\blacktriangledown&amp;\\X\\blacksquare&amp;\\X\\blacklozenge  \\\\\n\\X\\bigstar      &amp;\\X\\sphericalangle      &amp;\\X\\complement  &amp;\\X\\eth       \\\\\n\\X\\diagup$^u$   &amp;\\X\\diagdown$^u$\n\\end{tabular}\n\n$^u$ Not defined in {\\tt amssymb.sty}, define using the\n\\verb|\\newsymbol|  command.\n\n\\caption{AMS Miscellaneous\\label{ams-misc}}\n\\end{table}\n%\n\n\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\dotplus      &amp;\\X\\smallsetminus&amp;\\X\\Cap        &amp;\\X\\Cup               \\\\\n\\X\\barwedge     &amp;\\X\\veebar      &amp;\\X\\doublebarwedge&amp;\\X\\boxminus        \\\\\n\\X\\boxtimes     &amp;\\X\\boxdot      &amp;\\X\\boxplus     &amp;\\X\\divideontimes     \\\\\n\\X\\ltimes       &amp;\\X\\rtimes      &amp;\\X\\leftthreetimes&amp;\\X\\rightthreetimes \\\\\n\\X\\curlywedge   &amp;\\X\\curlyvee    &amp;\\X\\circleddash &amp;\\X\\circledast        \\\\\n\\X\\circledcirc  &amp;\\X\\centerdot   &amp;\\X\\intercal\n\\end{tabular}\n\n\\caption{AMS Binary Operators\\label{ams-bin}}\n\\end{table}\n\n\n\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\leqq         &amp;\\X\\leqslant    &amp;\\X\\eqslantless        &amp;\\X\\lesssim    \\\\\n\\X\\lessapprox   &amp;\\X\\approxeq    &amp;\\X\\lessdot            &amp;\\X\\lll        \\\\\n\\X\\lessgtr      &amp;\\X\\lesseqgtr   &amp;\\X\\lesseqqgtr         &amp;\\X\\doteqdot   \\\\\n\\X\\risingdotseq &amp;\\X\\fallingdotseq&amp;\\X\\backsim           &amp;\\X\\backsimeq  \\\\\n\\X\\subseteqq    &amp;\\X\\Subset      &amp;\\X\\sqsubset           &amp;\\X\\preccurlyeq\\\\\n\\X\\curlyeqprec  &amp;\\X\\precsim     &amp;\\X\\precapprox     &amp;\\X\\vartriangleleft\\\\\n\\X\\trianglelefteq&amp;\\X\\vDash      &amp;\\X\\Vvdash             &amp;\\X\\smallsmile \\\\\n\\X\\smallfrown   &amp;\\X\\bumpeq      &amp;\\X\\Bumpeq             &amp;\\X\\geqq       \\\\\n\\X\\geqslant     &amp;\\X\\eqslantgtr  &amp;\\X\\gtrsim             &amp;\\X\\gtrapprox  \\\\\n\\X\\gtrdot       &amp;\\X\\ggg         &amp;\\X\\gtrless            &amp;\\X\\gtreqless  \\\\\n\\X\\gtreqqless   &amp;\\X\\eqcirc      &amp;\\X\\circeq             &amp;\\X\\triangleq  \\\\\n\\X\\thicksim     &amp;\\X\\thickapprox &amp;\\X\\supseteqq          &amp;\\X\\Supset     \\\\\n\\X\\sqsupset     &amp;\\X\\succcurlyeq &amp;\\X\\curlyeqsucc        &amp;\\X\\succsim    \\\\\n\\X\\succapprox   &amp;\\X\\vartriangleright&amp;\\X\\trianglerighteq&amp;\\X\\Vdash      \\\\\n\\X\\shortmid     &amp;\\X\\shortparallel&amp;\\X\\between           &amp;\\X\\pitchfork  \\\\\n\\X\\varpropto    &amp;\\X\\blacktriangleleft&amp;\\X\\therefore     &amp;\\X\\backepsilon\\\\\n\\X\\blacktriangleright&amp;\\X\\because\n\\end{tabular}\n\n\\caption{AMS Binary Relations\\label{ams-rel}}\n\\end{table}\n%\n\\begin{table}\n\\begin{tabular}{*8l}\n\\X\\nless        &amp;\\X\\nleq        &amp;\\X\\nleqslant   &amp;\\X\\nleqq       \\\\\n\\X\\lneq         &amp;\\X\\lneqq       &amp;\\X\\lvertneqq   &amp;\\X\\lnsim       \\\\\n\\X\\lnapprox     &amp;\\X\\nprec       &amp;\\X\\npreceq     &amp;\\X\\precnsim    \\\\\n\\X\\precnapprox  &amp;\\X\\nsim        &amp;\\X\\nshortmid   &amp;\\X\\nmid        \\\\\n\\X\\nvdash       &amp;\\X\\nvDash      &amp;\\X\\ntriangleleft&amp;\\X\\ntrianglelefteq\\\\\n\\X\\nsubseteq    &amp;\\X\\subsetneq   &amp;\\X\\varsubsetneq&amp;\\X\\subsetneqq  \\\\\n\\X\\varsubsetneqq&amp;\\X\\ngtr        &amp;\\X\\ngeq        &amp;\\X\\ngeqslant   \\\\\n\\X\\ngeqq        &amp;\\X\\gneq        &amp;\\X\\gneqq       &amp;\\X\\gvertneqq   \\\\\n\\X\\gnsim        &amp;\\X\\gnapprox    &amp;\\X\\nsucc       &amp;\\X\\nsucceq     \\\\\n\\X\\nsucceqq$^u$ &amp;\\X\\succnsim    &amp;\\X\\succnapprox &amp;\\X\\ncong       \\\\\n\\X\\nshortparallel&amp;\\X\\nparallel  &amp;\\X\\nvDash      &amp;\\X\\nVDash      \\\\\n\\X\\ntriangleright&amp;\\X\\ntrianglerighteq&amp;\\X\\nsupseteq&amp;\\X\\nsupseteqq\\\\\n\\X\\supsetneq    &amp;\\X\\varsupsetneq&amp;\\X\\supsetneqq  &amp;\\X\\varsupsetneqq\n\\end{tabular}\n\n$^u$ Not defined in {\\tt amssymb.sty}, define using the\n\\verb|\\newsymbol| command.\n\n\\caption{AMS Negated Binary Relations\\label{ams-nrel}}\n\\end{table}\n%\n\n\\begin{table}\n\\begin{tabular}{*4l}\n &amp;\\tt newlfont/margid&amp;\\tt oldlfont/nomargid&amp;Requried style option\\\\\n\\hline\n$\\mathrm{ABCdef}$\n        &amp;\\verb|\\mathrm{ABCdef}| &amp;\\verb|{\\mathrm ABCdef}|\n        &amp;       \\\\\n$\\cal{ABC}$\n        &amp;\\verb|\\cal{ABC}| &amp;\\verb|{\\cal ABC}|\n        &amp;       \\\\\n$\\EuScript{ABC}$\n        &amp;\\verb|\\EuScript{ABC}| &amp;\\verb|{\\EuScript ABCdef}|\n        &amp;{\\tt euscript}                         \\\\\n$\\frak{ABCdef}$\n        &amp;\\verb|\\frak{ABCdef}| &amp;\\verb|{\\frak ABCdef}|\n        &amp;{\\tt amsfonts} or {\\tt amssymb}        \\\\\n$\\Bbb{ABC}$\n        &amp;\\verb|\\Bbb{ABC}| &amp;\\verb|{\\Bbb ABC}|\n        &amp;{\\tt amsfonts} or {\\tt amssymb}        \\\\\n$\\mathcyr{ABCdef}$\n        &amp;\\verb|\\mathcyr{ABCdef}| &amp;\\verb|{\\mathcyr ABCdef}|\n        &amp;{\\tt cyrillic}\n\\end{tabular}\n\\caption{Math Alphabets\\label{alphabets}}\n\\end{table}\n\n\\end{document}\n</code></pre>","tags":["latex","math","symbol"]},{"location":"misc/git-from-zero-to-hero/","title":"Git\u4ece\u5165\u95e8\u5230\u5e94\u4ed8\u65e5\u5e38\u5de5\u4f5c","text":"","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git_1","title":"Git\u6982\u8ff0","text":"","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git_2","title":"Git \u662f\u4e00\u4e2a\u5f00\u6e90\u7684 \u5206\u5e03\u5f0f\u7248\u672c\u63a7\u5236\u7cfb\u7edf \u3002","text":"","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git_3","title":"Git\u4ece\u5165\u95e8\u5230\u5e94\u4ed8\u65e5\u5e38\u5de5\u4f5c","text":"","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git_4","title":"Git\u6982\u8ff0","text":"<p>Git \u662f\u4e00\u4e2a\u5f00\u6e90\u7684 \u5206\u5e03\u5f0f\u7248\u672c\u63a7\u5236\u7cfb\u7edf \u3002</p> <p>\u5728Git\u770b\u6765\uff0c\u6587\u4ef6\u6709\u56db\u79cd\u72b6\u6001: \u672a\u8ddf\u8e2a (untracked)\u3001 \u672a\u4fee\u6539 (unmodified)\u3001\u5df2\u4fee\u6539 (modified) \u3001\u5df2\u6682\u5b58 (staged) \u3002</p> \u72b6\u6001 \u63cf\u8ff0 untracked \u672a\u8ffd\u8e2a\u3002\u6587\u4ef6\u672a\u88ab git \u7ba1\u7406\uff0c\u6267\u884c <code>git add</code> \u53ef\u5c06\u5176\u8f6c\u6362\u4e3a\u300c\u5df2\u8ffd\u8e2a\u300d\u7684\u300c\u672a\u4fee\u6539\u72b6\u6001\u300d\u3002 unmodified \u672a\u4fee\u6539\u3002\u5df2\u8ffd\u8e2a\uff0c\u4ece\u300c\u5df2\u6682\u5b58\u300d\u72b6\u6001\u6267\u884c <code>git commit</code> \u63d0\u4ea4\u540e\u7684\u72b6\u6001\u3002\u56e0\u6b64\u4e5f\u88ab\u79f0\u4f5c\u300c\u5df2\u63d0\u4ea4\u300d\u72b6\u6001 (commited) \u3002 modified \u5df2\u4fee\u6539\u3002\u5df2\u8ffd\u8e2a\uff0c\u5e76\u4e14\u53d1\u751f\u4e86\u4fee\u6539\uff0c\u4f46\u8fd8\u672a\u6682\u5b58\u3002 staged \u5df2\u6682\u5b58\u3002\u5df2\u8ffd\u8e2a\uff0c\u5bf9\u4e00\u4e2a\u4fee\u6539\u8fc7\u7684\u6587\u4ef6\u6267\u884c <code>git add</code> \u540e\u7684\u72b6\u6001\u3002 <p></p> <p>git \u4e2d\u7684\u4e09\u4e2a\u533a\u57df: \u4ed3\u5e93\u3001\u5de5\u4f5c\u76ee\u5f55\u3001\u6682\u5b58\u533a\u57df\u3002</p> \u533a\u57df \u63cf\u8ff0 \u5de5\u4f5c\u76ee\u5f55 \u4ed3\u5e93\u7684\u67d0\u4e2a\u7248\u672c\u72ec\u7acb\u63d0\u53d6\u51fa\u6765\u7684\u5185\u5bb9\u3002\u4ece Git \u4ed3\u5e93\u7684\u538b\u7f29\u6570\u636e\u5e93\u4e2d\u63d0\u53d6\u51fa\u6765\uff0c\u653e\u5728\u78c1\u76d8\u4e0a\u4f9b\u7528\u6237\u4f7f\u7528\u548c\u4fee\u6539\u3002 \u6682\u5b58\u533a / \u7d22\u5f15 \u672c\u8d28\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u4fdd\u5b58\u4e86\u4e0b\u6b21\u5c06\u63d0\u4ea4\u7684\u6587\u4ef6\u5217\u8868\u4fe1\u606f\uff0c\u4e00\u822c\u5728 Git \u4ed3\u5e93\u76ee\u5f55\u4e2d\uff0c\u6709\u65f6\u4e5f\u88ab\u79f0\u4f5c\u300c\u7d22\u5f15\u300d\u3002 Git\u4ed3\u5e93 / \u7248\u672c\u5e93 Git \u7528\u6765\u4fdd\u5b58\u9879\u76ee\u7684\u5143\u6570\u636e\u548c\u5bf9\u8c61\u6570\u636e\u5e93\u7684\u5730\u65b9\u3002 <p></p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_1","title":"\u5e38\u7528\u547d\u4ee4\u4e00\u89c8","text":"<p>git \u5e38\u7528\u547d\u4ee4\u3002\u4f7f\u7528 <code>git help &lt;verb&gt;</code>, <code>git &lt;verb&gt; --help</code>, <code>man git-&lt;verb&gt;</code> \u53ef\u67e5\u770b\u76f8\u5173\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u3002</p> \u547d\u4ee4 \u63cf\u8ff0 \u25a0 \u57fa\u672c\u64cd\u4f5c git config --[system/global/local] user.name &lt;\u7528\u6237\u540d&gt; \u8bbe\u7f6e\u4e0d\u540c\u5c42\u7ea7 git \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 git \u7528\u6237\u540d git config --[system/global/local] user.email &lt;\u90ae\u7bb1&gt; \u8bbe\u7f6e\u4e0d\u540c\u5c42\u7ea7 git \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 git \u90ae\u7bb1 git config --[system/global/local] --list \u67e5\u770b\u4e0d\u540c\u5c42\u7ea7 git \u914d\u7f6e\u5185\u5bb9 git config --[system/global/local] --edit \u7f16\u8f91\u4e0d\u540c\u5c42\u7ea7 git \u914d\u7f6e\u5185\u5bb9 git config --[system/global/local] &lt;\u53d8\u91cf\u7ec4\u540d.\u53d8\u91cf&gt; \u67e5\u770b\u4e0d\u540c\u5c42\u7ea7\u4e0b\u7684git\u914d\u7f6e\u4e2d\u7684\u53d8\u91cf\u503c git init \u5c06\u5f53\u524d\u6587\u4ef6\u5939\u521d\u59cb\u5316\u4e3a\u672c\u5730\u5e93 git add &lt;\u6587\u4ef6\u540d&gt; \u6dfb\u52a0\u5230\u6682\u5b58\u533a git add &lt;\u76ee\u5f55&gt; \u6dfb\u52a0\u6307\u5b9a\u76ee\u5f55\u53ca\u5176\u5b50\u76ee\u5f55\u5230\u6682\u5b58\u533a git add . \u6dfb\u52a0\u5f53\u524d\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u548c\u6240\u6709\u5b50\u76ee\u5f55\u5230\u6682\u5b58\u533a\u203b \u8fc7\u6ee4 <code>.gitignore</code> git add * \u6dfb\u52a0\u5f53\u524d\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u548c\u6240\u6709\u5b50\u76ee\u5f55\u5230\u6682\u5b58\u533a\u203b \u4e0d\u8fc7\u6ee4 <code>.gitignore</code> \uff0c\u4e00\u822c\u4e0d\u4f7f\u7528\u8be5\u547d\u4ee4\u3002 git ls-files \u67e5\u770b\u6682\u5b58\u533a\u548c\u5de5\u4f5c\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 git commit -m \"&lt;\u672c\u6b21\u63d0\u4ea4\u7684\u9644\u5e26\u4fe1\u606f&gt;\" \u63d0\u4ea4\u5230\u672c\u5730\u5e93 git status \u672c\u5730\u5e93\u72b6\u6001 git status -s \u672c\u5730\u5e93\u72b6\u6001\u7f29\u7565\u4fe1\u606f git diff &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u5de5\u4f5c\u76ee\u5f55\u4e2d\u4fee\u6539\u524d\u540e\u7684\u5dee\u5f02\u3002 git diff --staged &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u6682\u5b58\u533a\u4e0e\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u95f4\u7684\u5dee\u5f02\u3002 git diff &lt;\u7248\u672c\u53f7&gt; &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u5de5\u4f5c\u76ee\u5f55\u53ca\u6307\u5b9a\u4ed3\u5e93\u7248\u672c\u95f4\u7684\u5dee\u5f02\u3002 git reflog \u67e5\u770b\u5386\u53f2\u8bb0\u5f55\u7f29\u7565\u4fe1\u606f git rm &lt;\u6587\u4ef6\u540d&gt; \u4ece\u5df2\u7ecf\u8ddf\u8e2a\u7684\u6587\u4ef6\u6e05\u5355\u4e2d (\u6682\u5b58\u533a\u57df) \u79fb\u9664\u6307\u5b9a\u6587\u4ef6\uff0c\u540c\u65f6\u5220\u9664\u8be5\u6587\u4ef6 git mv &lt;\u6587\u4ef6\u540d1&gt; &lt;\u6587\u4ef6\u540d2&gt; \u5c06\u6587\u4ef6\u540d1\u6539\u6210\u6587\u4ef6\u540d2 git log \u67e5\u770b\u5386\u53f2\u8bb0\u5f55\u5b8c\u6574\u4fe1\u606f git log -p \u67e5\u770b\u5386\u53f2\u8bb0\u5f55\u5b8c\u6574\u4fe1\u606f\u5e76\u5c55\u793a\u6bcf\u6b21\u63d0\u4ea4\u7684\u5dee\u5f02 git log -2 \u67e5\u770b2\u6761\u5386\u53f2\u8bb0\u5f55\u5b8c\u6574\u4fe1\u606f git log --oneline --graph --all \u4ee5\u56fe\u5f62\u5f62\u5f0f (\u5206\u652f\u6d41) \u67e5\u770b\u63d0\u4ea4\u5386\u53f2 git reflog \u67e5\u770b\u5386\u53f2\u8bb0\u5f55\u7f29\u7565\u4fe1\u606f git reflog -p \u67e5\u770b\u5386\u53f2\u8bb0\u5f55\u7f29\u7565\u4fe1\u606f\u5e76\u5c55\u793a\u6bcf\u6b21\u63d0\u4ea4\u7684\u5dee\u5f02 git reflog -2 \u67e5\u770b2\u6761\u5386\u53f2\u8bb0\u5f55\u7f29\u7565\u4fe1\u606f \u25a0 \u64a4\u9500\u64cd\u4f5c git commit --amend \u4fee\u6539 message \u540e\u63d0\u4ea4\u6682\u5b58\u533a\uff0c\u66ff\u6362\u6389\u6700\u540e\u4e00\u6b21\u63d0\u4ea4\uff0c\u5373\u63d0\u4ea4\u6570\u4e0d\u53d8 (commit id\u4e0d\u540c)\u3002 git commit --amend -m \"&lt;\u63d0\u4ea4\u4fe1\u606f&gt;\" \u540c\u4e0a\uff0c\u4f46\u4e0d\u4f1a\u6253\u5f00\u7f16\u8f91\u5668\u7f16\u8f91\u63d0\u4ea4\u4fe1\u606f\uff0c\u800c\u662f\u76f4\u63a5\u5199\u4e0a\u63d0\u4ea4\u4fe1\u606f\u3002 git restore --staged &lt;\u6587\u4ef6\u540d&gt; \u5c06\u6682\u5b58\u533a\u7684\u6307\u5b9a\u6587\u4ef6\u79fb\u51fa\u6682\u5b58\u533a git restore &lt;\u6587\u4ef6\u540d&gt; \u5728\u5de5\u4f5c\u76ee\u5f55\u4e0b\uff0c\u5c06\u5df2\u4fee\u6539\u72b6\u6001\u7684\u6307\u5b9a\u6587\u4ef6\u56de\u9000\u5230\u672a\u4fee\u6539\u7684\u72b6\u6001\u3002 git reset HEAD &lt;\u6587\u4ef6\u540d&gt; \u540c <code>git restore --staged &lt;\u6587\u4ef6\u540d&gt;</code> git checkout -- &lt;\u6587\u4ef6\u540d&gt; \u540c <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code> \u25a0 \u5207\u6362\u64cd\u4f5c git reset --soft &lt;\u7248\u672c\u53f7&gt; \u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c (commit) \uff0c\u4e0d\u6539\u52a8 index \u548c working tree\u3002\u203b \u4e0d\u53ef\u6307\u5b9a\u6587\u4ef6\u540d (\u6307\u5b9a\u5219\u62a5\u9519)\u3002 git reset --mixed  &lt;\u7248\u672c\u53f7&gt; \u4e0d\u6307\u5b9a\u6587\u4ef6\u3002\u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c (commit) \uff0c\u5e76\u4f7f\u5f97\u6682\u5b58\u533a\u4e0e\u6307\u5b9a\u7248\u672c\u4e00\u81f4\uff0c\u5373\u5728\u6307\u5b9a\u7248\u672c\u4e4b\u540e\u52a0\u5165\u6682\u5b58\u533a\u7684\u6240\u6709\u6587\u4ef6\u90fd\u79fb\u51fa\u6682\u5b58\u533a\u3002\u203b <code>--mixed</code> \u53c2\u6570\u662f\u9ed8\u8ba4\u7684\uff0c\u4e5f\u53ef\u4e0d\u5199\u3002 git reset --mixed  &lt;\u7248\u672c\u53f7&gt; &lt;\u6587\u4ef6\u540d&gt; \u6307\u5b9a\u6587\u4ef6\u3002<code>HEAD</code> \u6307\u9488\u4e0d\u53d8\uff0c\u4f46\u6307\u5b9a\u7684\u6587\u4ef6\u5bf9\u5e94\u7684\u6682\u5b58\u533a\u5185\u5bb9\u5c06\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u7684\u72b6\u6001\uff0c\u5176\u4ed6\u6587\u4ef6\u5728\u6682\u5b58\u533a\u7684\u5185\u5bb9\u4e0d\u53d8\u3002 git reset --hard &lt;\u7248\u672c\u53f7&gt; \u5c06 HEAD, index \u548c working tree \u90fd\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u53f7\u7684\u72b6\u6001\u3002\u203b \u4e0d\u53ef\u6307\u5b9a\u6587\u4ef6\u540d (\u6307\u5b9a\u5219\u62a5\u9519)\u3002 \u25a0 \u5206\u652f\u64cd\u4f5c git branch \u5217\u51fa\u672c\u5730\u6240\u6709\u5206\u652f\u540d git branch -r \u5217\u51fa\u8fdc\u7a0b\u6240\u6709\u5206\u652f\u540d git branch -a \u5217\u51fa\u672c\u5730\u53ca\u8fdc\u7a0b\u7684\u6240\u6709\u5206\u652f\u540d git branch &lt;\u5206\u652f\u540d&gt; \u4ee5\u6307\u5b9a\u5206\u652f\u540d\u521b\u5efa\u65b0\u5206\u652f git branch -d &lt;\u5206\u652f\u540d&gt; \u5220\u9664\u6307\u5b9a\u5206\u652f git switch &lt;\u5206\u652f\u540d&gt; \u5207\u6362\u5230\u6307\u5b9a\u5206\u652f git switch -c &lt;\u5206\u652f\u540d&gt; \u521b\u5efa\u5e76\u5207\u6362\u5206\u652f git switch - \u5207\u6362\u56de\u4e0a\u4e00\u6b21\u6240\u5728\u5206\u652f git checkout &lt;\u5206\u652f\u540d&gt; \u5207\u6362\u5230\u6307\u5b9a\u5206\u652f git checkout -b &lt;\u5206\u652f\u540d&gt; \u521b\u5efa\u5e76\u5207\u6362\u5206\u652f git merge &lt;\u5206\u652f\u540d&gt; \u5c06\u6307\u5b9a\u5206\u652f\u5408\u5e76\u5165\u5f53\u524d\u5206\u652f git rebase &lt;\u5206\u652f\u540d&gt; \u4ee5\u5f53\u524d\u5206\u652f\u4e3a\u57fa\u5e95\uff0c\u5c06\u6307\u5b9a\u5206\u652f\u5728\u5206\u6b67\u540e\u7684\u4fee\u6539\u5408\u5165\u5f53\u524d\u5206\u652f (\u5728\u5f53\u524d\u5206\u652f\u4e0b\u91cd\u653e\u6307\u5b9a\u5206\u652f\u5728\u5206\u6b67\u70b9\u540e\u7684\u63d0\u4ea4) \u25a0 \u8fdc\u7a0b\u64cd\u4f5c git remote add &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d&gt; &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt; \u5173\u8054\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93 git remote \u5217\u51fa\u8fdc\u7a0b\u4ed3\u5e93 (\u522b\u540d) git remove -v \u5217\u51fa\u8fdc\u7a0b\u4ed3\u5e93\u8be6\u7ec6\u4fe1\u606f (\u8fdc\u7a0b\u5730\u5740\u522b\u540d\u548cfetch&amp;push\u7684\u5730\u5740) git remote show &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d&gt; \u67e5\u770b\u8fdc\u7a0b\u4ed3\u5e93\u8be6\u7ec6\u4fe1\u606f git remote rename &lt;\u5f53\u524d\u522b\u540d&gt; &lt;\u65b0\u522b\u540d&gt; \u4fee\u6539\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d git clone &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt; \u5c06\u8fdc\u7a0b\u4ed3\u5e93\u514b\u9686\u5230\u5f53\u524d\u76ee\u5f55\u4e0b git push &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt; &lt;\u672c\u5730\u5206\u652f\u540d&gt;:&lt;\u8fdc\u7a0b\u5206\u652f\u540d&gt; \u63a8\u9001\u672c\u5730\u5f53\u524d\u5206\u652f\u7248\u672c\u5230\u8fdc\u7a0b\u4ed3\u5e93\u6307\u5b9a\u5206\u652f git push -u &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5206\u652f\u540d&gt; \u5c06\u672c\u5730\u4ed3\u5e93\u5f53\u524d\u5206\u652f\u5185\u5bb9\u63a8\u9001\u5230\u6307\u5b9a\u8fdc\u7a0b\u4ed3\u5e93\u7684\u6307\u5b9a\u5206\u652f\u203b <code>-u</code> \u662f <code>--set-upstream</code> \u7684\u7f29\u7565\uff0c\u5173\u8054\u5f53\u524d\u5206\u652f\u4e0e\u6307\u5b9a\u7684\u8fdc\u7a0b\u4ed3\u5e93\u5206\u652f\uff0c\u65b9\u4fbf\u4e4b\u540e\u4ec5\u4f7f\u7528 <code>git push</code> \u5b8c\u6210\u63a8\u9001\u3002 git push &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt; &lt;\u5206\u652f\u540d&gt; \u5f53\u672c\u5730\u5206\u652f\u540d\u4e0e\u8fdc\u7a0b\u5206\u652f\u540d\u76f8\u540c\u65f6\u7684\u7565\u5199 git push \u82e5\u5f53\u524d\u672c\u5730\u5206\u652f\u5df2\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u67d0\u5206\u652f\u901a\u8fc7 <code>--set-upstream</code> \u53c2\u6570\u7ed1\u5b9a\u8fc7\uff0c\u5219\u53ef\u76f4\u63a5\u5c06\u672c\u5730\u5206\u652f\u5f53\u524d\u7248\u672c\u63a8\u9001\u5230\u8be5\u8fdc\u7a0b\u5206\u652f git fetch &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5206\u652f\u540d&gt; \u4ece\u6307\u5b9a\u8fdc\u7a0b\u4ed3\u5e93\u83b7\u53d6\u6307\u5b9a\u5206\u652f\u7684\u6700\u65b0\u7248\u672c\u5230\u5f53\u524d\u4ed3\u5e93\u4e2d\uff0c\u4f46\u4e0d merge git fetch &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; \u4ece\u6307\u5b9a\u8fdc\u7a0b\u4ed3\u5e93\u7684\u83b7\u53d6\u6240\u6709\u5206\u652f\u4e2d\u7684\u6700\u65b0\u7248\u672c\u5230\u5f53\u524d\u4ed3\u5e93\u4e2d\uff0c\u4f46\u4e0d merge git fetch \u7c7b\u4f3c push \uff0c\u82e5\u5df2\u7ecf\u8bbe\u7f6e\u4e86 <code>--set-upstream</code> \uff0c\u5219\u53ef\u7701\u7565\u540e\u7eed\u53c2\u6570 git pull &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u8fdc\u7a0b\u5206\u652f\u540d&gt;:&lt;\u672c\u5730\u5206\u652f\u540d&gt; \u4ece\u6307\u5b9a\u8fdc\u7a0b\u4ed3\u5e93\u83b7\u53d6\u6307\u5b9a\u5206\u652f\u7684\u6700\u65b0\u7248\u672c\u5230\u6307\u5b9a\u672c\u5730\u5206\u652f\u4e2d\uff0c\u5e76 merge git pull &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u5206\u652f\u540d&gt; \u8fdc\u7a0b\u5206\u652f\u540d\u4e0e\u672c\u5730\u5206\u652f\u540d\u76f8\u540c\u65f6\u7684\u7b80\u5199 git pull \u7c7b\u4f3c push \uff0c\u82e5\u5df2\u7ecf\u8bbe\u7f6e\u4e86 <code>--set-upstream</code> \uff0c\u5219\u53ef\u7701\u7565\u540e\u7eed\u53c2\u6570 <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_2","title":"\u57fa\u672c\u64cd\u4f5c","text":"","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-config","title":"git config","text":"<p>git \u6709\u4e09\u4e2a\u5c42\u7ea7\u7684\u914d\u7f6e\u6587\u4ef6\u3002</p> \u914d\u7f6e\u6587\u4ef6 \u63cf\u8ff0 \u7cfb\u7edf\u7ea7 (system) \u914d\u7f6e\u5bf9OS\u7cfb\u7edf\u4e0b\u6240\u6709\u7528\u6237\u6709\u6548\u3002 \u7cfb\u7edf\u7528\u6237\u7ea7 (global) \u914d\u7f6e\u5bf9OS\u7cfb\u7edf\u4e0b\u5f53\u524d\u7528\u6237\u6709\u6548\u3002 \u5f53\u524d\u4ed3\u5e93\u7ea7\u522b (local) \u914d\u7f6e\u5bf9\u5f53\u524d\u4ed3\u5e93\u6709\u6548\u3002 <p>\u4e0d\u540c\u7cfb\u7edf\u4e0b\u4e0d\u540c\u7ea7\u522b\u7684\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\u3002</p> \u7cfb\u7edf \u914d\u7f6e\u6587\u4ef6 \u63cf\u8ff0 MacOS system \u4f7f\u7528 brew \u5b89\u88c5\u65f6\uff0c\u4e3a\u8be5\u6587\u4ef6: <code>/usr/local/etc/config</code> global \u4e3a\u8be5\u6587\u4ef6 <code>/Users/&lt;your user name&gt;/.gitconfig</code> local \u5f53\u524d\u4ed3\u5e93 <code>.git</code> \u6587\u4ef6\u5939\u4e0b\u7684 <code>.gitconfig</code> Windows system <code>C:\\Program Files\\Git\\etc\\gitconfig</code> global <code>C:\\Users\\&lt;your user name&gt;\\.gitconfig</code> local \u5f53\u524d\u4ed3\u5e93 <code>.git</code> \u6587\u4ef6\u5939\u4e0b\u7684 <code>.gitconfig</code> Linux <p>\u5982\u4e0b\uff0c\u53ef\u901a\u8fc7 <code>cat</code> \u547d\u4ee4\u67e5\u770b\u4e09\u4e2a\u5c42\u7ea7\u4e0b\u7684 git \u914d\u7f6e\u5185\u5bb9\u3002</p> <pre><code>koshiba@koshiba ~ % cat /usr/local/etc/gitconfig\n[credential]\n    helper = osxkeychain\nkoshiba@koshiba ~ % cat ~/.gitconfig\n[filter \"lfs\"]\n    clean = git-lfs clean -- %f\n    smudge = git-lfs smudge -- %f\n    process = git-lfs filter-process\n    required = true\n[user]\n    name = koshiba\n    email = koshiba@yuki.com\n[init]\n    defaultBranch = master\nkoshiba@koshiba ~ % cat iCloud/study/tech/git/git-demo/.git/config\n[core]\n    repositoryformatversion = 0\n    filemode = true\n    bare = false\n    logallrefupdates = true\n    ignorecase = true\n    precomposeunicode = true\n[user]\n    name = ikoshiba\n    email = koshiba@yama.com\nkoshiba@koshiba ~ %\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>git config --[system/global/local] --list</code> \u67e5\u770b\u3002</p> <pre><code>koshiba@koshiba ~ % git config --system --list\ncredential.helper=osxkeychain\nkoshiba@koshiba ~ % git config --global --list\nfilter.lfs.clean=git-lfs clean -- %f\nfilter.lfs.smudge=git-lfs smudge -- %f\nfilter.lfs.process=git-lfs filter-process\nfilter.lfs.required=true\nuser.name=koshiba\nuser.email=koshiba@yuki.com\ninit.defaultbranch=master\nkoshiba@koshiba ~ % cd iCloud/study/tech/git/git-demo/\nkoshiba@koshiba git-demo % git config --local --list\ncore.repositoryformatversion=0\ncore.filemode=true\ncore.bare=false\ncore.logallrefupdates=true\ncore.ignorecase=true\ncore.precomposeunicode=true\nuser.name=ikoshiba\nuser.email=koshiba@yama.com\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u5e26\u6709 <code>--local</code> \u53c2\u6570\u7684 <code>git config</code> \u547d\u4ee4\u8981\u5728\u4ed3\u5e93\u5185\u6267\u884c\uff0c\u5426\u5219\u8fd4\u56de\u5982\u4e0b\u9519\u8bef\u63d0\u793a\u3002</p> <pre><code>koshiba@koshiba ~ % git config --local user.name\nfatal: --local can only be used inside a git repository\nkoshiba@koshiba ~ %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_3","title":"\u914d\u7f6e\u7528\u6237\u7b7e\u540d","text":"<p>\u53ef\u4ee5\u901a\u8fc7 <code>vim</code> \u547d\u4ee4\u6216\u8005\u5e26 <code>--edit</code> \u53c2\u6570\u7684 <code>git config</code> \u547d\u4ee4\u6253\u5f00\u914d\u7f6e\u6587\u4ef6\u5b8c\u6210\u7f16\u8f91\uff0c\u66f4\u597d\u7684\u65b9\u5f0f\u662f\u76f4\u63a5\u4f7f\u7528 <code>git config</code> \u547d\u4ee4\u6307\u5b9a\u5177\u4f53\u7684\u53d8\u91cf\u3002\u901a\u5e38\u5728\u4f7f\u7528 git \u8fdb\u884c\u7248\u672c\u63a7\u5236\u7ba1\u7406\u524d\uff0c\u9700\u8981\u8bbe\u7f6e\u7528\u6237\u540d\u53ca\u90ae\u7bb1\uff0c\u5373\u300c\u7528\u6237\u7b7e\u540d\u300d\uff0c\u7528\u4e8e\u6807\u8bc6\u64cd\u4f5c\u8005\u4fe1\u606f\uff0c\u65e0\u8be5\u4fe1\u606f\u5219\u65e0\u6cd5\u63d0\u4ea4\u3002</p> <p>\u5982\u4e0b\u8bbe\u7f6e global \u5c42\u7ea7\u7684 user.name \u53ca user.email\u3002</p> <pre><code>koshiba@koshiba git-demo % git config --global user.name koshiba\nkoshiba@koshiba git-demo % git config --global user.name\nkoshiba\nkoshiba@koshiba git-demo % git config --global user.email koshiba@gmail.com\nkoshiba@koshiba git-demo % git config --global user.email\nkoshiba@gmail.com\n</code></pre> <p>\u5f53\u6211\u4eec\u5e0c\u671b\u5bf9\u67d0\u4e2a\u5177\u4f53\u7684 git \u9879\u76ee (\u5373 <code>.git</code> \u6240\u5728\u76ee\u5f55) \u4f7f\u7528\u4e0d\u540c\u4e8e global \u7684\u7528\u6237\u7b7e\u540d\u65f6\uff0c\u4f7f\u7528 <code>--local</code> \u53c2\u6570\u5355\u72ec\u8bbe\u7f6e\uff0c\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba git-demo % git config --local user.name koshiba123\nkoshiba@koshiba git-demo % git config --local user.name\nkoshiba123\nkoshiba@koshiba git-demo % git config --local user.email koshiba@outlook.com\nkoshiba@koshiba git-demo % git config --local user.email\nkoshiba@outlook.com\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u300c\u7528\u6237\u7b7e\u540d\u300d\u4e0e\u5728\u300c\u8fdc\u7a0b\u64cd\u4f5c\u300d\u4e2d\u4f7f\u7528\u8fdc\u7a0b\u5e93\u5e73\u53f0 (\u5982 github) \u7684\u8d26\u6237\u4fe1\u606f\u65e0\u5173\uff0c\u53ea\u4e0d\u8fc7\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06\u7528\u6237\u7b7e\u540d\u8bbe\u7f6e\u4e3a\u8fdc\u7a0b\u5e93\u5e73\u53f0\u7684\u8d26\u53f7\u540d\u53ca\u90ae\u7bb1\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_4","title":"\u914d\u7f6e\u5168\u5c40\u5ffd\u7565","text":"<p>\u4f7f\u7528 MacOS \u65f6\uff0c\u672c\u5730 git \u4ed3\u5e93\u4e2d\u53ef\u80fd\u4f1a\u51fa\u73b0 MacOS \u4e2d\u7279\u6709\u7684 <code>.DS_Store</code> \u6587\u4ef6\u3002\u7c7b\u4f3c\u8fd9\u6837\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\uff0c\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u6bcf\u4e00\u4e2a\u672c\u5730 git \u4ed3\u5e93\uff0c\u5728 <code>.git</code> \u6240\u5728\u76ee\u5f55\u4e0b\u8bbe\u7f6e\u65b0\u5efa <code>.gitignore</code> \u6587\u4ef6\uff0c\u5728\u5176\u4e2d\u8bbe\u7f6e\u9700\u8981\u5ffd\u7565\u7684\u672c\u4ed3\u5e93\u5185\u7684\u6587\u4ef6\u548c\u6587\u4ef6\u5939\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a\u5168\u5c40\u5ffd\u7565\u914d\u7f6e\u6587\u4ef6 <code>.gitignore_global</code> (\u901a\u5e38\u4e0e\u5168\u5c40\u914d\u7f6e\u6587\u4ef6 <code>.gitconfig</code> \u653e\u7f6e\u5728\u540c\u4e00\u76ee\u5f55\u4e0b\uff0c\u5373 <code>~/</code> \u4e0b) \u3002\u4f8b\u5982\u65b0\u5efa\u4e00\u4e2a <code>~/.gitignore_global</code> \u6587\u4ef6\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba ~ % cat ~/.gitignore_global\n# MacOS .DS_Store\n**/.DS_Store\nkoshiba@koshiba ~ %\n</code></pre> <p><code>**</code> \u8868\u793a\u6240\u6709\u5c42\u7ea7\u76ee\u5f55</p> <p>\u7136\u540e\u4f7f\u7528 <code>git config --global core.excludesfile ~/.gitignore_global</code> \u547d\u4ee4\u914d\u7f6e\u5230\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\u4e2d\u3002</p> <pre><code>koshiba@koshiba git-demo % git config --global core.excludesfile ~/.gitignore_global\nkoshiba@koshiba git-demo % git config --global --list\nfilter.lfs.clean=git-lfs clean -- %f\nfilter.lfs.smudge=git-lfs smudge -- %f\nfilter.lfs.process=git-lfs filter-process\ntarget/\nfilter.lfs.required=true\nuser.name=koshiba\nuser.email=koshiba@163.com\ninit.defaultbranch=master\ncore.excludesfile=/Users/koshiba/.gitignore_global\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u5bf9\u4e8e\u5df2\u7ecf\u5728 <code>.gitignore_global</code> \u4e2d\u7684\u5ffd\u7565\u89c4\u5219\uff0c\u4e4b\u540e\u5c31\u4e0d\u9700\u8981\u518d\u9488\u5bf9\u6bcf\u4e00\u4e2a git \u4ed3\u5e93\u8bbe\u7f6e\u5355\u72ec\u8bbe\u7f6e\u4e86\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_5","title":"\u914d\u7f6e\u5ffd\u7565\u8f6c\u4e49","text":"<p>\u4f7f\u7528 git \u547d\u4ee4\u65f6\uff0c\u547d\u4ee4\u884c\u56de\u663e\u4fe1\u606f\u7684\u4e2d\u6587 (\u6216\u65e5\u6587\u7b49) \u5b57\u7b26\u4f1a\u88ab\u8f6c\u4e49\u3002\u5982\u4e0b\uff0c<code>\u4e2d\u6587.md</code> \u88ab\u663e\u793a\u4e3a <code>\\344\\270\\255\\346\\226\\207.md</code> \u3002</p> <pre><code>koshiba@koshiba pics % vim \u4e2d\u6587.md\nkoshiba@koshiba pics % git status\nOn branch master\nYour branch is up to date with 'origin/master'.\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    \"\\344\\270\\255\\346\\226\\207.md\"\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba pics %\n</code></pre> <p>\u53ef\u4ee5\u5c06 <code>core.quotepath</code> \u8bbe\u7f6e\u4e3a <code>false</code> \u7981\u6b62\u8f6c\u4e49\uff0c\u4ee5\u4fbf\u663e\u793a\u4e2d\u6587\u3002</p> <pre><code>koshiba@koshiba pics % git config --global core.quotepath false\nkoshiba@koshiba pics % git status\nOn branch master\nYour branch is up to date with 'origin/master'.\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    \u4e2d\u6587.md\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba pics %\n</code></pre> <p><code>core.quotePath</code> \u53c2\u6570\u7684\u4f5c\u7528\u5982\u4e0b (\u6765\u81ea \u5b98\u65b9\u6587\u6863 )\u3002</p> <p>Commands that output paths (e.g. ls-files, diff), will quote \"unusual\" characters in the pathname by enclosing the pathname in double-quotes and escaping those characters with backslashes in the same way C escapes control characters (e.g. <code>\\t</code> for TAB, <code>\\n</code> for LF, <code>\\\\</code> for backslash) or bytes with values larger than 0x80 (e.g. octal <code>\\302\\265</code> for \"micro\" in UTF-8). If this variable is set to false, bytes higher than 0x80 are not considered \"unusual\" any more. Double-quotes, backslash and control characters are always escaped regardless of the setting of this variable. A simple space character is not considered \"unusual\". Many commands can output pathnames completely verbatim using the <code>-z</code> option. The default value is true.</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-init","title":"git init","text":"<p>\u5728\u6587\u4ef6\u5939\u8def\u5f84\u4e0b\u6267\u884c <code>git init</code> \uff0c\u6b64\u6587\u4ef6\u5939\u5373\u79f0\u4e3a git \u672c\u5730\u4ed3\u5e93\uff0c\u6587\u4ef6\u5939\u4e0b\u51fa\u73b0 <code>.git</code> \u9690\u85cf\u6587\u4ef6\u5939\uff0c\u5176\u5185\u4fdd\u5b58\u4e86 git \u7528\u4e8e\u7248\u672c\u7ba1\u7406\u7684\u5404\u79cd\u4fe1\u606f\u6587\u4ef6\u3002</p> <pre><code>koshiba@koshiba git-demo % git init\nInitialized empty Git repository in /Users/koshiba/Library/Mobile Documents/com~apple~CloudDocs/study/tech/git/git-demo/.git/\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u6b64\u65f6\u5373\u53ef\u4f7f\u7528 git \u547d\u4ee4 <code>git status</code> \u67e5\u770b\u4ed3\u5e93\u6587\u4ef6\u72b6\u6001\u3002</p> <pre><code>koshiba@koshiba git-demo1 % git status\nOn branch master\n\nNo commits yet\n\nnothing to commit (create/copy files and use \"git add\" to track)\nkoshiba@koshiba git-demo1 %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-add","title":"git add","text":"<p>\u6587\u4ef6\u5939\u521d\u59cb\u5316\u4e3a git \u4ed3\u5e93\u540e\uff0c\u5c1a\u672a\u6709\u6587\u4ef6\u88ab git \u8ffd\u8e2a\u7ba1\u7406\uff0c\u6b64\u65f6\u4f7f\u7528 <code>git add &lt;\u6587\u4ef6\u540d&gt;</code> \u547d\u4ee4\u5c06\u6307\u5b9a\u6587\u4ef6\u653e\u5165\u300c\u6682\u5b58\u533a\u300d\u3002\u6682\u5b58\u533a\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5b83\u4fdd\u5b58\u4e86\u4e0b\u6b21\u5c06\u63d0\u4ea4\u7684\u6587\u4ef6\u5217\u8868\u4fe1\u606f\u3002\u5982\u4e0b\uff0c\u65b0\u589e\u4e00\u4e2a <code>hello.txt</code> \u6587\u4ef6\u540e\uff0c\u4f7f\u7528 <code>git status</code> \u67e5\u770b\u4ed3\u5e93\u5185\u6587\u4ef6\u6240\u5c5e\u72b6\u6001\uff0c\u53ef\u4ee5\u770b\u5230 <code>Untracked files</code> \u4fe1\u606f\u3002</p> <pre><code>koshiba@koshiba git-demo % git status\nOn branch master\n\nNo commits yet\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    .DS_Store\n    hello.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u6b64\u65f6\u4f7f\u7528 <code>git add helle.txt</code> \u5373\u53ef\u5c06\u6587\u4ef6\u653e\u5165\u300c\u6682\u5b58\u533a\u300d(\u6807\u8bb0\u4e3a\u8ffd\u8e2a\u6587\u4ef6)\u3002</p> <pre><code>koshiba@koshiba git-demo % git add hello.txt\nkoshiba@koshiba git-demo % git status\nOn branch master\n\nNo commits yet\n\nChanges to be committed:\n  (use \"git rm --cached &lt;file&gt;...\" to unstage)\n    new file:   hello.txt\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    .DS_Store\n\nkoshiba@koshiba git-demo %\n</code></pre> <ul> <li><code>git add .</code> \u4f1a\u628a\u672c\u5730\u6240 \u6709 untrack \u7684 (\u5305\u62ec\u8ffd\u8e2a\u8fc7\u4f46\u53c8\u4fee\u6539\u4e86\u7684) \u6587\u4ef6\u90fd\u52a0\u5165\u6682\u5b58\u533a\u3002</li> <li><code>git add *</code> \u4f1a\u5ffd\u7565 <code>.gitignore</code> \u628a\u4efb\u4f55\u6587\u4ef6\u90fd\u52a0\u5165\u3002\u6267\u884c\u65f6\u4f1a\u51fa\u73b0\u5982\u4e0b\u63d0\u793a\uff0c\u52a0\u4e0a <code>-f</code> \u53c2\u6570\u540e\u53ef\u5f3a\u5236\u52a0\u5165\uff0c\u4f46\u663e\u7136\u901a\u5e38\u6211\u4eec\u4e0d\u4f1a\u8fd9\u4e48\u505a\u3002</li> </ul> <pre><code>koshiba@koshiba hello-git % git add *\nThe following paths are ignored by one of your .gitignore files:\ntest\ntest.txt\nhint: Use -f if you really want to add them.\nhint: Turn this message off by running\nhint: \"git config advice.addIgnoredFile false\"\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-commit","title":"git commit","text":"<p>\u4f7f\u7528 <code>git commit -m \"&lt;message&gt;\" &lt;filename&gt;</code>\u63d0\u4ea4\u6307\u5b9a\u6587\u4ef6\u3002</p> <pre><code>koshiba@koshiba git-demo % git commit -m \"first commit\" hello.txt\n[master (root-commit) 3d542ed] first commit\n 1 file changed, 3 insertions(+)\n create mode 100644 hello.txt\nkoshiba@koshiba git-demo % git status\nOn branch master\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    .DS_Store\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u4fee\u6539\u6587\u4ef6</p> <p>\u4fee\u6539\u6587\u4ef6\u540e git \u4f1a\u68c0\u6d4b\u5230\u88ab\u4fee\u6539\u7684\u6587\u4ef6\u3002</p> <pre><code>koshiba@koshiba git-demo % git status\nOn branch master\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   hello.txt\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    .DS_Store\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u518d\u6b21\u6dfb\u52a0\u5e76\u63d0\u4ea4</p> <pre><code>koshiba@koshiba git-demo % git add hello.txt\nkoshiba@koshiba git-demo % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    modified:   hello.txt\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    .DS_Store\n\nkoshiba@koshiba git-demo % git commit -m \"first changed\"\n[master c246db6] first changed\n 1 file changed, 1 insertion(+), 1 deletion(-)\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>git commit -am \"&lt;message&gt;\"</code> \u5c06\u6240\u6709\u5df2\u8ddf\u8e2a\u7684\u6587\u4ef6 \u6682\u5b58\u5e76\u63d0\u4ea4 (\u5373 add \u4e0e commit \u4e00\u8d77\u5b8c\u6210)\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-status","title":"git status","text":"<p><code>git status</code> \u547d\u4ee4\u53ef\u4ee5\u6dfb\u52a0 <code>-s</code> (<code>--short</code>) \u53c2\u6570\u4ee5\u7d27\u51d1\u5f62\u5f0f\u8fd4\u56de\u72b6\u6001\u4fe1\u606f\u3002\u5982\u4e0b\uff0c\u6dfb\u52a0 <code>untracked.txt</code>, <code>added.txt</code> \u548c <code>modified.txt</code> \u6587\u4ef6\u6f14\u793a\u5904\u4e8e <code>untracked(??)</code>, <code>added(A)</code> , <code>modified(_M)</code> (M\u5728\u53f3\u4fa7) \u4ee5\u53ca <code>modifiedAdded(M_)</code> (M\u5728\u5de6\u4fa7) \u72b6\u6001\u7684\u60c5\u51b5\u3002</p> <ul> <li><code>untracked.txt</code> \u65b0\u5efa\u540e\u5c1a\u672a\u901a\u8fc7 <code>git add</code> \u6dfb\u52a0\u5230\u6682\u5b58\u533a\u3002</li> <li><code>added.txt</code> \u65b0\u5efa\u540e\u901a\u8fc7 <code>git add</code> \u6dfb\u52a0\u5230\u4e86\u6682\u5b58\u533a\uff0c\u4f46\u672a <code>git commit</code> \u63d0\u4ea4\u3002</li> <li><code>modified.txt</code> \u65b0\u5efa\u540e\u6dfb\u52a0\u5230\u4e86\u6682\u5b58\u533a\uff0c\u4e14\u5df2\u63d0\u4ea4\uff0c\u5e76\u5728\u63d0\u4ea4\u540e\u505a\u4e86\u4fee\u6539\u3002</li> <li><code>modifiedAdded.txt</code> \u65b0\u5efa\u540e\u6dfb\u52a0\u5230\u4e86\u6682\u5b58\u533a\uff0c\u4e14\u5df2\u63d0\u4ea4\uff0c\u5e76\u5728\u63d0\u4ea4\u540e\u505a\u4e86\u4fee\u6539\uff0c\u4e4b\u540e\u53c8\u63d0\u4ea4\u5230\u4e86\u6682\u5b58\u533a\u3002</li> </ul> <pre><code>koshiba@koshiba git-demo % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    new file:   added.txt\n    modified:   modifiedAdded.txt\n\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   .DS_Store\n    modified:   modified.txt\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    untracked.txt\n\nkoshiba@koshiba git-demo % git status -s\n M .DS_Store\nA  added.txt\n M modified.txt\nM  modifiedAdded.txt\n?? untracked.txt\nkoshiba@koshiba git-demo %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-diff","title":"git diff","text":"\u547d\u4ee4 \u63cf\u8ff0 git diff &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u5de5\u4f5c\u76ee\u5f55\u4e2d\u4fee\u6539\u524d\u540e\u7684\u5dee\u5f02\u3002 git diff --staged &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u6682\u5b58\u533a\u4e0e\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u95f4\u7684\u5dee\u5f02\u3002 git diff &lt;\u7248\u672c\u53f7&gt; &lt;\u6587\u4ef6\u540d&gt; \u5217\u51fa\u6307\u5b9a\u6587\u4ef6\u5728\u5de5\u4f5c\u76ee\u5f55\u53ca\u6307\u5b9a\u4ed3\u5e93\u7248\u672c\u95f4\u7684\u5dee\u5f02\u3002 <p>\u203b <code>--staged</code> \u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>--cached</code> \u4ee3\u66ff\u3002</p> <p>\u203b \u4e0a\u8ff0\u547d\u4ee4\u5747\u9488\u5bf9\u88ab git \u7ba1\u7406\u7684\u6587\u4ef6\uff0c\u5373\u88ab <code>git add</code> \u8fc7\u7684\u6587\u4ef6\u3002\u5f53\u4e0d\u6307\u5b9a\u5177\u4f53\u6587\u4ef6\u65f6\uff0c\u5217\u51fa\u6240\u6709\u6587\u4ef6\u7684\u5dee\u5f02\u3002</p> <p>\u203b \u300c\u7248\u672c\u53f7\u300d\u53ef\u4ee5\u7528 <code>HEAD</code>\u3001<code>HEAD^</code>\u3001<code>HEAD^^</code>\u3001<code>HEAD~~1</code>\u3001<code>HEAD~~2</code> \u7b49\u5f62\u5f0f\u8868\u793a\u3002<code>HEAD</code> \u8868\u793a\u5f53\u524d\u7248\u672c\uff0c<code>HEAD^</code> \u8868\u793a\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6709\u591a\u5c11\u4e2a <code>^</code> \u5c31\u5f80\u524d\u591a\u5c11\u4e2a\u7248\u672c\uff0c<code>~1</code> \u8868\u793a\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6570\u5b57\u662f\u591a\u5c11\uff0c\u5c31\u8868\u793a\u5f80\u524d\u591a\u5c11\u4e2a\u7248\u672c\u3002</p> <p>\u65b0\u5efa diff.txt \u4e14\u8be5\u6587\u4ef6\u53ea\u6709\u4e00\u884c\u300conly first line when created\u300d\u3002\u53ef\u4ee5\u770b\u5230\u7531\u4e8e\u5c1a\u672a\u5bf9 compare.txt \u6267\u884c <code>git add</code> \uff0c\u5373\u6b64\u6587\u4ef6\u8fd8\u672a\u88ab git \u7ba1\u7406\uff0c\u56e0\u6b64 \u4e09\u6761 <code>git diff</code> \u547d\u4ee4\u5747\u65e0\u56de\u663e\u3002</p> <pre><code>koshiba@koshiba hello-git % vim compare.txt\nkoshiba@koshiba hello-git % git diff\nkoshiba@koshiba hello-git % git diff --staged compare.txt\nkoshiba@koshiba hello-git % git diff HEAD compare.txt\n</code></pre> <p>\u6267\u884c <code>git add compare.txt</code> \u4e4b\u540e\u3002\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u3002</p> <ul> <li><code>git diff</code> \u547d\u4ee4\u65e0\u56de\u663e\uff0c\u56e0\u4e3a\u662f\u521d\u6b21\u88ab git \u7ba1\u7406\uff0c\u5373\u7b2c\u4e00\u6b21\u51fa\u73b0\u5728 git \u7684\u5de5\u4f5c\u76ee\u5f55\uff0c\u6b64\u6587\u4ef6\u5728\u5de5\u4f5c\u76ee\u5f55\u4e2d\u65e0\u5386\u53f2\u53ef\u6bd4\u8f83\u7248\u672c\u3002</li> <li><code>git diff --staged</code> \u5217\u51fa\u9996\u884c\u5dee\u5f02\uff0c\u56e0\u4e3a\u6b64\u65f6\u6682\u5b58\u533a\u6bd4\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u591a\u4e00\u884c (\u591a\u4e86\u6b64\u6587\u4ef6\uff0c\u5e76\u4e14\u6709\u4e00\u884c\u5dee\u5f02) \u3002</li> <li><code>git diff HEAD</code> \u5217\u51fa\u9996\u884c\u5dee\u5f02\uff0c\u56e0\u4e3a\u6b64\u65f6\u5de5\u4f5c\u76ee\u5f55\u6bd4\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u591a\u4e00\u884c (\u591a\u4e86\u6b64\u6587\u4ef6\uff0c\u5e76\u4e14\u6709\u4e00\u884c\u5dee\u5f02) \u3002</li> </ul> <pre><code>koshiba@koshiba hello-git % git add compare.txt\nkoshiba@koshiba hello-git % git diff\nkoshiba@koshiba hello-git % git diff --staged compare.txt\ndiff --git a/compare.txt b/compare.txt\nnew file mode 100644\nindex 0000000..80dd23d\n--- /dev/null\n+++ b/compare.txt\n@@ -0,0 +1 @@\n+only first line when created\nkoshiba@koshiba hello-git % git diff HEAD compare.txt\ndiff --git a/compare.txt b/compare.txt\nnew file mode 100644\nindex 0000000..80dd23d\n--- /dev/null\n+++ b/compare.txt\n@@ -0,0 +1 @@\n+only first line when created\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u6267\u884c <code>git commit -m \"add compare.txt\"</code> \u63d0\u4ea4 compare.txt \u4e4b\u540e\u3002\u53ef\u770b\u5230\u5982\u4e0b\u3002\u6b64\u65f6\u5de5\u4f5c\u76ee\u5f55\u3001\u6682\u5b58\u533a\u548c\u5f53\u524d\u7248\u672c\u5747\u65e0\u5dee\u5f02\u3002</p> <pre><code>koshiba@koshiba hello-git % git commit -m \"add compare.txt\"\n[master 1e05a4f] add compare.txt\n 2 files changed, 1 insertion(+), 1 deletion(-)\n create mode 100644 compare.txt\n delete mode 100644 diff.txt\nkoshiba@koshiba hello-git % git diff\nkoshiba@koshiba hello-git % git diff --staged compare.txt\nkoshiba@koshiba hello-git % git diff HEAD compare.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u589e\u52a0\u7b2c\u4e8c\u884c \u300csecond line added\u300d\u4e4b\u540e\u3002\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u3002</p> <ul> <li><code>git diff</code> \u5217\u51fa\u7b2c\u4e8c\u884c\u5dee\u5f02\uff0c\u56e0\u4e3a\u6b64\u65f6\u5de5\u4f5c\u76ee\u5f55\u4e0b\u8be5\u6587\u4ef6\u591a\u4e86\u4e00\u884c \u3002</li> <li><code>git diff --staged</code> \u7531\u4e8e\u6682\u5b58\u533a\u4e0e\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u65e0\u5dee\u5f02\uff0c\u56e0\u6b64\u65e0\u56de\u663e\u3002</li> <li><code>git diff HEAD</code> \u5217\u51fa\u7b2c\u4e8c\u884c\u5dee\u5f02\uff0c\u56e0\u4e3a\u6b64\u65f6\u5de5\u4f5c\u76ee\u5f55\u4e0b\u8be5\u6587\u4ef6\u76f8\u6bd4\u6307\u5b9a\u7684\u4ed3\u5e93\u7248\u672c\u591a\u4e86\u4e00\u884c \u3002</li> </ul> <pre><code>koshiba@koshiba hello-git % git diff compare.txt\ndiff --git a/compare.txt b/compare.txt\nindex 80dd23d..3d555a6 100644\n--- a/compare.txt\n+++ b/compare.txt\n@@ -1 +1,2 @@\n only first line when created\n+second line added\nkoshiba@koshiba hello-git % git diff --staged compare.txt\nkoshiba@koshiba hello-git % git diff HEAD compare.txt\ndiff --git a/compare.txt b/compare.txt\nindex 80dd23d..3d555a6 100644\n--- a/compare.txt\n+++ b/compare.txt\n@@ -1 +1,2 @@\n only first line when created\n+second line added\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u300c\u7248\u672c\u53f7\u300d\u7684\u4e0d\u540c\u5199\u6cd5\u3002</p> <pre><code>koshiba@koshiba hello-git % git diff HEAD~1 compare.txt\ndiff --git a/compare.txt b/compare.txt\nnew file mode 100644\nindex 0000000..3d555a6\n--- /dev/null\n+++ b/compare.txt\n@@ -0,0 +1,2 @@\n+only first line when created\n+second line added\nkoshiba@koshiba hello-git % git diff HEAD^ compare.txt\ndiff --git a/compare.txt b/compare.txt\nnew file mode 100644\nindex 0000000..3d555a6\n--- /dev/null\n+++ b/compare.txt\n@@ -0,0 +1,2 @@\n+only first line when created\n+second line added\nkoshiba@koshiba hello-git % git reflog -2\n1e05a4f (HEAD -&gt; master) HEAD@{0}: commit: add compare.txt\nf08b6a1 HEAD@{1}: commit: add diff.txt\nkoshiba@koshiba hello-git % git diff f08b6a1 compare.txt\ndiff --git a/compare.txt b/compare.txt\nnew file mode 100644\nindex 0000000..3d555a6\n--- /dev/null\n+++ b/compare.txt\n@@ -0,0 +1,2 @@\n+only first line when created\n+second line added\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-rm","title":"git rm","text":"<p>\u4f7f\u7528 <code>git rm &lt;filename&gt;</code> \u4ece\u5df2\u8ddf\u8e2a\u7684\u6587\u4ef6\u6e05\u5355\u4e2d\u79fb\u9664\u6307\u5b9a\u6587\u4ef6 (\u5373\u4ece\u6682\u5b58\u533a\u57df\u79fb\u9664) \u5e76\u63d0\u4ea4\uff0c\u540c\u65f6\u5220\u9664\u8be5\u6587\u4ef6\u3002\u5982\u679c\u53ea\u662f \u4f7f\u7528 <code>rm</code> \uff0c\u867d\u7136\u6587\u4ef6\u88ab\u5220\u9664\uff0c\u4f46 <code>git status</code> \u540e\u8fd8\u662f\u80fd\u770b\u5230\u5df2\u88ab\u5220\u9664\u7684\u6587\u4ef6\u3002</p> <pre><code>koshiba@koshiba git-demo % git rm hello.txt\nerror: the following file has staged content different from both the\nfile and the HEAD:\n    hello.txt\n(use -f to force removal)\nkoshiba@koshiba git-demo % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    modified:   hello.txt\n\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   .DS_Store\n    modified:   hello.txt\n\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u5982\u4e0a\uff0c\u5728 <code>git rm</code> \u5220\u9664\u6307\u5b9a\u6587\u4ef6\u524d\uff0c\u82e5\u8be5\u6587\u4ef6\u6709\u8fc7\u4fee\u6539\uff0c\u5219\u62d2\u7edd\u5220\u9664\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u9632\u6b62\u5220\u9664\u672a\u6dfb\u52a0\u5230\u4ed3\u5e93\u4e2d\u7684\u6570\u636e\uff0c\u8fd9\u6837\u7684\u6570\u636e\u65e0\u6cd5\u88ab git \u6062\u590d\u3002\u786e\u5b9a\u8981\u5220\u9664\u65f6\u53ef\u4ee5\u4f7f\u7528 <code>-f</code> \u53c2\u6570\u5f3a\u5236\u5220\u9664 (force) \u3002</p> <pre><code>koshiba@koshiba git-demo % git rm -f hello.txt\nrm 'hello.txt'\nkoshiba@koshiba git-demo % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    deleted:    hello.txt\n\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   .DS_Store\n\nkoshiba@koshiba git-demo %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-mv","title":"git mv","text":"<p>\u4f7f\u7528 <code>git mv</code> \u547d\u4ee4\u4fee\u6539\u6587\u4ef6\u540d\uff0c\u4f8b\u5982 <code>git mv a.txt b.txt</code> \u76f8\u5f53\u4e8e\u5982\u4e0b\u4e09\u884c\u547d\u4ee4\u3002</p> <pre><code>mv a.txt b.txt\ngit rm a.txt\ngit add b.txt\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-log","title":"git log","text":"<p>\u4f7f\u7528 <code>git log</code> \u67e5\u770b\u63d0\u4ea4\u5386\u53f2\u3002</p> <pre><code>koshiba@koshiba git-demo % git log\ncommit b8d829123843fe1d760983ed5bfc9f2cbcc22d13 (HEAD -&gt; master)\nAuthor: ikoshiba &lt;youremail@yama.com&gt;\nDate:   Mon Sep 26 19:54:50 2022 +0800\n\n    modified one line\n\ncommit 5f3d03819d450b534153b90531393efd38e6a0a1\nAuthor: ikoshiba &lt;youremail@yama.com&gt;\nDate:   Mon Sep 26 19:53:32 2022 +0800\n\n    first commit\n</code></pre> <p>\u4f7f\u7528 <code>git log -p</code> \u67e5\u770b\u6bcf\u6b21\u63d0\u4ea4\u7684\u5dee\u5f02\uff0c\u4f7f\u7528 <code>git log -p -2</code> \u67e5\u770b\u6700\u8fd1 2 \u6b21\u63d0\u4ea4\u7684\u5dee\u5f02\u3002</p> <pre><code>koshiba@koshiba git-demo % git log -p\ncommit b8d829123843fe1d760983ed5bfc9f2cbcc22d13 (HEAD -&gt; master)\nAuthor: ikoshiba &lt;youremail@yama.com&gt;\nDate:   Mon Sep 26 19:54:50 2022 +0800\n\n    modified one line\n\ndiff --git a/hello.txt b/hello.txt\nindex 40f4dc0..06227ce 100644\n--- a/hello.txt\n+++ b/hello.txt\n@@ -1,3 +1,3 @@\n-hello 1\n+hello 1 modified\n hello 2\n hello 3\n\ncommit 5f3d03819d450b534153b90531393efd38e6a0a1\nAuthor: ikoshiba &lt;youremail@yama.com&gt;\nDate:   Mon Sep 26 19:53:32 2022 +0800\n\n    first commit\n\ndiff --git a/hello.txt b/hello.txt\nnew file mode 100644\nindex 0000000..40f4dc0\n--- /dev/null\n+++ b/hello.txt\n@@ -0,0 +1,3 @@\n+hello 1\n+hello 2\n+hello 3\n</code></pre> <p><code>git log</code> \u547d\u4ee4\u6709\u8bb8\u591a\u53c2\u6570\u53ef\u7528\u4e8e\u8c03\u6574\u8f93\u51fa\u5386\u53f2\u8bb0\u5f55\u7684\u4fe1\u606f\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-reflog","title":"git reflog","text":"<p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>git reflog</code> \u67e5\u770b\u7f29\u7565\u7684\u63d0\u4ea4\u5386\u53f2\u4fe1\u606f\u3002<code>git reflog -p</code>, <code>git reflog -2</code> \u7684\u4f5c\u7528\u4e0e <code>git log -p</code> \u548c <code>git log -2</code> \u7c7b\u4f3c\u3002</p> <pre><code>koshiba@koshiba git-demo % git reflog\nb8d8291 (HEAD -&gt; master) HEAD@{0}: commit: modified one line\n5f3d038 HEAD@{1}: commit: first commit\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_6","title":"\u64a4\u9500\u64cd\u4f5c","text":"\u64a4\u9500\u64cd\u4f5c \u6267\u884c\u524d\u72b6\u6001 \u533a\u57df\u53d8\u5316 \u63cf\u8ff0 git commit --amend \u672a\u4fee\u6539 \u6682\u5b58\u533a &gt; \u4ed3\u5e93 \u4fee\u6539 message \u540e\u63d0\u4ea4\u6682\u5b58\u533a\uff0c\u66ff\u6362\u6389\u6700\u540e\u4e00\u6b21\u63d0\u4ea4\uff0c\u5373\u63d0\u4ea4\u6570\u4e0d\u53d8 (commit id\u4e0d\u540c)\u3002 git commit --amend -m \"&lt;\u63d0\u4ea4\u4fe1\u606f&gt;\" \u672a\u4fee\u6539 \u6682\u5b58\u533a &gt; \u4ed3\u5e93 \u540c\u4e0a\uff0c\u4f46\u4e0d\u4f1a\u6253\u5f00\u7f16\u8f91\u5668\u7f16\u8f91\u63d0\u4ea4\u4fe1\u606f\uff0c\u800c\u662f\u76f4\u63a5\u5199\u4e0a\u63d0\u4ea4\u4fe1\u606f\u3002 git restore --staged &lt;\u6587\u4ef6\u540d&gt; \u5df2\u6682\u5b58 \u6682\u5b58\u533a &gt; \u5de5\u4f5c\u533a \u5c06\u6307\u5b9a\u6587\u4ef6\u79fb\u51fa\u6682\u5b58\u533a\u203b \u5fc5\u987b\u6307\u5b9a\u6587\u4ef6\u540d git restore &lt;\u6587\u4ef6\u540d&gt; \u5df2\u4fee\u6539 \u5747\u5728\u5de5\u4f5c\u533a \u90fd\u5728\u5de5\u4f5c\u76ee\u5f55\u4e0b\uff0c\u5c06\u5df2\u4fee\u6539\u72b6\u6001\u7684\u6307\u5b9a\u6587\u4ef6\u56de\u9000\u5230\u672a\u4fee\u6539\u7684\u72b6\u6001\uff0c\u5373\u4e22\u5f03\u6307\u5b9a\u6587\u4ef6\u7684\u6240\u6709\u4fee\u6539\u3002 git reset HEAD &lt;\u6587\u4ef6\u540d&gt; \u5df2\u6682\u5b58 \u6682\u5b58\u533a &gt; \u5de5\u4f5c\u533a \u540c <code>git restore --staged &lt;\u6587\u4ef6\u540d&gt;</code>\u203b \u82e5\u4e0d\u6307\u5b9a\u6587\u4ef6\u540d\uff0c\u5219\u6e05\u7a7a\u6682\u5b58\u533a git checkout -- &lt;\u6587\u4ef6\u540d&gt; \u5df2\u4fee\u6539 \u5747\u5728\u5de5\u4f5c\u533a \u540c <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code>\u203b \u5fc5\u987b\u6307\u5b9a\u6587\u4ef6\u540d","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-commit-amend","title":"git commit --amend","text":"<p>\u5728\u67d0\u6b21\u63d0\u4ea4\u540e\u53d1\u73b0\u8be5\u63d0\u4ea4\u7684 message \u63cf\u8ff0\u6709\u8bef\uff0c\u60f3\u8981\u4fee\u6539\u8be5 message \uff0c\u6216\u8005\u60f3\u8981\u518d add \u4e00\u4e9b\u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>git commit --amend</code> \u3002</p> <p>\u5982\u4e0b\u5148\u5b8c\u6210\u4e24\u6b21\u63d0\u4ea4\u3002</p> <pre><code>commit 6d70b38bd6becddcd2b70fb1a5bc3ee929070497 (HEAD -&gt; master)\nAuthor: koshiba &lt;koshiba@163.com&gt;\niiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiijjjiiiiiiiiiiiixx\nDate:   Wed Sep 28 20:11:01 2022 +0800\n\n    first commit\nkoshiba@koshiba hello-git % vim hello.txt\nkoshiba@koshiba hello-git % git add .\nkoshiba@koshiba hello-git % git commit -m \"second commit\"\n[master 6eefb40] second commit\n 1 file changed, 1 insertion(+), 1 deletion(-)\nkoshiba@koshiba hello-git % git log\ncommit 6eefb4065d6b3f02cedf9edce05d3de2afaace87 (HEAD -&gt; master)\nAuthor: koshiba &lt;koshiba@163.com&gt;\nDate:   Wed Sep 28 20:11:37 2022 +0800\n\n    second commit\n\ncommit 6d70b38bd6becddcd2b70fb1a5bc3ee929070497\nAuthor: koshiba &lt;koshiba@163.com&gt;\nDate:   Wed Sep 28 20:11:01 2022 +0800\n\n    first commit\nkoshiba@koshiba hello-git % git status\nOn branch master\nnothing to commit, working tree clean\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u4fee\u6539\u6587\u4ef6\u5e76\u6267\u884c <code>git add</code> \u540e\uff0c\u5c06 message \u4fee\u6539\u4e3a \"second commit (amend)\" \u6765\u53d6\u4ee3\u4e0a\u4e00\u6b21\u63d0\u4ea4\u3002\u518d\u6b21\u6267\u884c <code>git log</code> \u53ef\u4ee5\u770b\u5230\u524d\u6b21\u63d0\u4ea4 (6eefb) \u5df2\u4e0d\u663e\u793a\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u65b0\u63d0\u4ea4 (b299e) \uff0cmessage \u53d1\u751f\u53d8\u5316\u4f46\u63d0\u4ea4\u65f6\u95f4\u548c\u4f5c\u8005\u4fe1\u606f\u4e0e\u4e4b\u524d\u662f\u4e00\u81f4\u7684\u3002</p> <pre><code>koshiba@koshiba hello-git % vim hello.txt\nkoshiba@koshiba hello-git % git add hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    modified:   hello.txt\n\nkoshiba@koshiba hello-git % git commit --amend -m \"second commit (amend)\"\n[master b299e54] second commit (amend)\n Date: Wed Sep 28 20:11:37 2022 +0800\n 1 file changed, 1 insertion(+), 1 deletion(-)\nkoshiba@koshiba hello-git % git log\ncommit b299e542f8677f2c1e55b17cd9aa24bb2241ebad (HEAD -&gt; master)\nAuthor: koshiba &lt;koshiba@163.com&gt;\nDate:   Wed Sep 28 20:11:37 2022 +0800\n\n    second commit (amend)\n\ncommit 6d70b38bd6becddcd2b70fb1a5bc3ee929070497\nAuthor: koshiba &lt;koshiba@163.com&gt;\nDate:   Wed Sep 28 20:11:01 2022 +0800\n\n    first commit\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u6bcf\u6b21\u63d0\u4ea4\u65f6\u90fd\u53ef\u4ee5\u4f7f\u7528 <code>git commit --amend -m \"&lt;message&gt;\"</code> \u6765\u53d6\u4ee3\u4e0a\u4e00\u6b21\u63d0\u4ea4\uff0c\u8fd9\u6837\u65e0\u8bba\u6709\u591a\u5c11\u6b21\u63d0\u4ea4\uff0c <code>git log</code> \u90fd\u53ea\u663e\u793a\u6700\u540e\u4e00\u6b21\u63d0\u4ea4\u3002(\u4f46\u662f <code>git reflog</code> \u4ecd\u4f1a\u663e\u793a\u6bcf\u4e00\u6b21\u63d0\u4ea4) \u3002</p> <pre><code>koshiba@koshiba hello-git % git reflog\nb299e54 (HEAD -&gt; master) HEAD@{0}: commit (amend): second commit (amend)\n6eefb40 HEAD@{1}: commit: second commit\n6d70b38 HEAD@{2}: commit (initial): first commit\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-restore","title":"git restore","text":"<p>\u4e3b\u8981\u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u4e24\u79cd\u7528\u6cd5\u90fd\u5fc5\u987b\u6307\u5b9a\u6587\u4ef6\u540d\uff0c\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\u6587\u4ef6 (\u6587\u4ef6\u540d\u7528\u7a7a\u683c\u5206\u5f00) \u3002</p> <ul> <li>\u4f7f\u7528 <code>git restore --staged &lt;\u6587\u4ef6\u540d&gt;</code> \u5c06\u6307\u5b9a\u7684\u6682\u5b58\u533a\u4e2d\u7684\u6587\u4ef6\u79fb\u51fa\u6682\u5b58\u533a\u3002</li> <li>\u4f7f\u7528 <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code> \u5c06\u5de5\u4f5c\u76ee\u5f55\u4e0b\u7684\u300c\u5df2\u4fee\u6539\u300d\u6587\u4ef6\u6062\u590d\u4e3a\u672a\u4fee\u6539\u72b6\u6001\u3002</li> </ul> <pre><code>koshiba@koshiba hello-git % git add hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    modified:   hello.txt\n\nkoshiba@koshiba hello-git % git restore --staged hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   hello.txt\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\nkoshiba@koshiba hello-git % git restore hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nnothing to commit, working tree clean\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-reset","title":"git reset","text":"<p>\u4f7f\u7528 <code>git reset HEAD &lt;filename&gt;</code> \u5c06\u6307\u5b9a\u7684\u5df2\u6682\u5b58\u7684\u6587\u4ef6\u79fb\u51fa\u6682\u5b58\u533a (\u540c <code>git restore --staged &lt;filename&gt;</code> )\uff0c \u82e5\u4e0d\u6307\u5b9a\u6587\u4ef6\uff0c\u5219\u53d6\u6d88\u6240\u6709\u6587\u4ef6\u7684\u6682\u5b58\u5185\u5bb9 (\u6e05\u7a7a\u6682\u5b58\u533a)\u3002\u5176\u4e2d\uff0c<code>HEAD</code> \u8868\u793a\u5f53\u524d\u7248\u672c\uff0c\u9000\u56de\u5230\u4e0a\u4e00\u4e2a\u7248\u672c\u53ef\u7528 <code>HEAD^</code>\u3002</p> <p><code>git reset HEAD &lt;filename&gt;</code> \u4e0e <code>git restore --staged &lt;filename&gt;</code> \u6548\u679c\u76f8\u540c\uff0c\u4f46 git \u7684\u63d0\u793a\u63a8\u8350\u4f7f\u7528 <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code> \u7528\u6cd5\u3002</p> <p>\u5982\u4e0b\u5c55\u793a <code>hello.txt</code> \u52a0\u5165\u6682\u5b58\u533a\u540e\uff0c\u6267\u884c <code>git reset HEAD</code> \u53d6\u6d88\u6682\u5b58\u7684\u8fc7\u7a0b\u3002</p> <pre><code>koshiba@koshiba hello-git % git add hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    modified:   hello.txt\n\nkoshiba@koshiba hello-git % git reset HEAD hello.txt\nUnstaged changes after reset:\nM   hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges not staged for commit:\n  (use \"git add &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    modified:   hello.txt\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-checkout-","title":"git checkout --","text":"<p>\u4f7f\u7528 <code>git checkout -- &lt;filename&gt;</code> \u5c06\u5de5\u4f5c\u76ee\u5f55\u4e0b\u7684\u300c\u5df2\u4fee\u6539\u300d\u6587\u4ef6\u6062\u590d\u4e3a\u672a\u4fee\u6539\u72b6\u6001\uff0c\u540c <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code> \uff0cgit \u7684\u63d0\u793a\u63a8\u8350\u4f7f\u7528 <code>git restore &lt;\u6587\u4ef6\u540d&gt;</code> \u7528\u6cd5\u3002</p> <p>\u5982\u4e0b\uff0c\u63a5\u4e0a\u4e00\u8282\u7684\u64cd\u4f5c\u3002</p> <pre><code>koshiba@koshiba hello-git % git checkout -- hello.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nnothing to commit, working tree clean\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_7","title":"\u5207\u6362\u64cd\u4f5c","text":"<p>\u5207\u6362\u64cd\u4f5c\u4e5f\u5c5e\u4e8e\u5e7f\u4e49\u4e0a\u7684\u64a4\u9500\uff0c\u4f46\u66f4\u5f3a\u8c03\u5728\u7248\u672c\u95f4\u7a7f\u68ad\u7684\u7279\u70b9\u3002<code>git reset</code> \u7684\u4e3b\u8981\u80fd\u529b\u7279\u70b9\u5c31\u662f\u80fd\u591f\u5b9e\u73b0\u7248\u672c\u4e4b\u95f4\u7a7f\u68ad\u7684\u64cd\u4f5c\uff0c\u5373\u300c\u5207\u6362\u64cd\u4f5c\u300d\u3002</p> <p>\u5728\u4ecb\u7ecd\u547d\u4ee4\u4e4b\u524d\u6709\u5fc5\u8981\u5148\u8bf4\u660e\u5982\u4e0b\u4e09\u4e2a\u300c\u5207\u6362\u76ee\u6807\u300d\u7684\u6982\u5ff5\u3002</p> \u5207\u6362\u76ee\u6807 \u63cf\u8ff0 HEAD \u6307\u5411\u5f53\u524d\u5206\u652f\u7684\u5f53\u524d\u7248\u672c (commit) \u7684\u6307\u9488\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5c31\u662f\u5f53\u524d\u7248\u672c\u3002 index \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6682\u5b58\u533a working tree \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 <p><code>git reset</code> \u547d\u4ee4\u6709\u4e09\u79cd\u5e38\u7528\u6a21\u5f0f\uff0c <code>--mixed</code> (\u9ed8\u8ba4\uff0c\u4e0d\u663e\u5f0f\u5199\u51fa\u65f6\u5373\u4e3a\u6b64\u6a21\u5f0f)\u3001<code>--soft</code> \u4ee5\u53ca <code>--hard</code> \uff0c\u5206\u522b\u5b9e\u73b0\u5bf9\u4e0d\u540c\u300c\u5207\u6362\u76ee\u6807\u300d\u7684\u64cd\u4f5c\u3002</p> \u547d\u4ee4 \u63cf\u8ff0 git reset --soft &lt;\u7248\u672c\u53f7&gt; \u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c (commit) \uff0c\u4e0d\u6539\u52a8 index \u548c working tree\u3002\u203b \u4e0d\u53ef\u6307\u5b9a\u6587\u4ef6\u540d (\u6307\u5b9a\u5219\u62a5\u9519)\u3002 git reset --mixed  &lt;\u7248\u672c\u53f7&gt; \u4e0d\u6307\u5b9a\u6587\u4ef6\u3002\u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c (commit) \uff0c\u5e76\u4f7f\u5f97\u6682\u5b58\u533a\u4e0e\u6307\u5b9a\u7248\u672c\u4e00\u81f4\uff0c\u5373\u5728\u6307\u5b9a\u7248\u672c\u4e4b\u540e\u52a0\u5165\u6682\u5b58\u533a\u7684\u6240\u6709\u6587\u4ef6\u90fd\u79fb\u51fa\u6682\u5b58\u533a\u3002\u203b <code>--mixed</code> \u53c2\u6570\u662f\u9ed8\u8ba4\u7684\uff0c\u4e5f\u53ef\u4e0d\u5199\u3002 git reset --mixed  &lt;\u7248\u672c\u53f7&gt; &lt;\u6587\u4ef6\u540d&gt; \u6307\u5b9a\u6587\u4ef6\u3002HEAD \u6307\u9488\u4e0d\u53d8\uff0c\u4f46\u6307\u5b9a\u7684\u6587\u4ef6\u5bf9\u5e94\u7684\u6682\u5b58\u533a\u5185\u5bb9\u5c06\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u7684\u72b6\u6001\uff0c\u5176\u4ed6\u6587\u4ef6\u5728\u6682\u5b58\u533a\u7684\u5185\u5bb9\u4e0d\u53d8\u3002 git reset --hard &lt;\u7248\u672c\u53f7&gt; \u5c06 HEAD, index \u548c working tree \u90fd\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u53f7\u7684\u72b6\u6001\u3002\u203b \u4e0d\u53ef\u6307\u5b9a\u6587\u4ef6\u540d (\u6307\u5b9a\u5219\u62a5\u9519)\u3002 <p>\u203b \u300c\u7248\u672c\u53f7\u300d\u53ef\u4ee5\u7528 <code>HEAD</code>, <code>HEAD^</code>, <code>HEAD^^</code>, <code>HEAD~1</code>, <code>HEAD~2</code> \u7b49\u5f62\u5f0f\u8868\u793a\u3002HEAD \u8868\u793a\u5f53\u524d\u7248\u672c\uff0cHEAD^ \u8868\u793a\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6709\u591a\u5c11\u4e2a <code>^</code> \u5c31\u5f80\u524d\u591a\u5c11\u4e2a\u7248\u672c\uff0c<code>~1</code> \u8868\u793a\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6570\u5b57\u662f\u591a\u5c11\uff0c\u5c31\u8868\u793a\u5f80\u524d\u591a\u5c11\u4e2a\u7248\u672c\u3002</p> <p>\u203b \u5728\u300c\u64a4\u9500\u64cd\u4f5c\u300d\u4e2d\uff0c\u6211\u4eec\u8bf4\u8fc7 git 2.23 \u7248\u672c\u52a0\u5165 <code>git restore</code> \u547d\u4ee4\u540e\uff0c\u63a8\u8350\u4f7f\u7528 <code>git restore --staged &lt;\u6587\u4ef6\u540d&gt;</code> \u6765\u4ee3\u66ff <code>git reset HEAD &lt;filename&gt;</code> \uff0c\u539f\u56e0\u4e4b\u4e00\u5c31\u662f <code>git reset</code> \u627f\u62c5\u7684\u529f\u80fd\u592a\u591a\uff0c\u6709\u5fc5\u8981\u5f15\u5165\u65b0\u7684\u66f4\u76f4\u89c2\u7684\u547d\u4ee4\u6765\u53d6\u4ee3\u4e00\u90e8\u5206\u529f\u80fd\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-reset-soft","title":"git reset --soft","text":"<p><code>git reset --soft &lt;commit id&gt;</code> \u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c (commit) \uff0c\u4e0d\u6539\u52a8 index \u548c working tree\u3002\u7b80\u5355\u76f4\u89c2\u7684\u7406\u89e3\u5373\u6267\u884c\u540e\uff0c\u5728\u7248\u672c\u5386\u53f2\u4e2d\u7684\u7b2c\u4e00\u6761 (\u5f53\u524d\u7248\u672c) \u5373\u4e3a\u6307\u5b9a\u7684\u90a3\u4e2a\u7248\u672c\uff0c\u9664\u6b64\u4e4b\u5916\u65e0\u5176\u4ed6\u53d8\u5316\u3002</p> <p>\u5982\u4e0b\u6f14\u793a <code>--soft</code> \u6a21\u5f0f\u7684\u6548\u679c\u3002</p> <p>\u9996\u5148\uff0c\u4f9d\u6b21\u63d0\u4ea4 1.txt , 2.txt \u548c 3.txt \u4e4b\u540e<code>git add</code> 4.txt \u4f46\u4e0d\u63d0\u4ea4\uff0c\u5219\u5f53\u524d\u6709 3 \u4e2a\u7248\u672c\uff0c\u6682\u5b58\u533a\u4e2d\u6709\u56db\u4e2a\u6587\u4ef6 (\u901a\u8fc7 <code>git ls-files</code> \u67e5\u770b)\u3002</p> <pre><code>koshiba@koshiba hello-git % git reflog\n5bff39f (HEAD -&gt; master) HEAD@{0}: commit: add 3\nd287e4b HEAD@{1}: commit: add 2\nc97c40e HEAD@{2}: commit (initial): add 1\nkoshiba@koshiba hello-git %\nkoshiba@koshiba hello-git %\nkoshiba@koshiba hello-git %\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2.txt\n3.txt\nkoshiba@koshiba hello-git % vim 4.txt\nkoshiba@koshiba hello-git % git add 4.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    new file:   4.txt\n\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2.txt\n3.txt\n4.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u7136\u540e\u8f6f\u5207\u6362\u56de  (<code>--soft</code>) \u7b2c\u4e00\u4e2a\u7248\u672c (c97c40e)\uff0c\u6b64\u65f6\u5f53\u524d\u5206\u652f (master) \u7684 HEAD \u786e\u5b9e\u6307\u5411\u4e86\u6307\u5b9a\u7684\u7248\u672c\u3002\u901a\u8fc7 <code>git status</code> \u548c <code>git ls-files</code> \u53ef\u4ee5\u770b\u5230\uff0c\u5728\u6682\u5b58\u533a\u7684\u5185\u5bb9\u65e0\u53d8\u5316\uff0c\u53ea\u4e0d\u8fc7\u56e0\u4e3a\u5207\u56de\u4e86\u82e5\u5e72\u4e2a\u7248\u672c\uff0c\u6682\u5b58\u533a\u300c\u9886\u5148\u300d\u4e86\u5f53\u524d\u7248\u672c (c97c40e) \uff0c\u56e0\u6b64 2.txt, 3.txt, 4.txt \u90fd\u662f\u300cChanges to be committed\u300d\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset --soft c97c40e\nkoshiba@koshiba hello-git % git reflog\nc97c40e (HEAD -&gt; master) HEAD@{0}: reset: moving to c97c40e\n5bff39f HEAD@{1}: commit: add 3\nd287e4b HEAD@{2}: commit: add 2\nc97c40e (HEAD -&gt; master) HEAD@{3}: commit (initial): add 1\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    new file:   2.txt\n    new file:   3.txt\n    new file:   4.txt\n\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2.txt\n3.txt\n4.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u7531\u6b64\u6211\u4eec\u9a8c\u8bc1\u4e86 <code>--soft</code> \u6a21\u5f0f\u786e\u5b9e\u53ea\u662f\u5c06 HEAD \u6307\u5411\u6307\u5b9a\u7684\u7248\u672c\uff0c\u6682\u5b58\u533a\u4e0e\u5de5\u4f5c\u76ee\u5f55\u65e0\u53d8\u5316\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-reset-mixed","title":"git reset --mixed","text":"<p><code>git reset --mixed &lt;commit id&gt;</code> \u547d\u4ee4\uff0c\u53ef\u4ee5\u6307\u5b9a\u6587\u4ef6\u6216\u4e0d\u6307\u5b9a\u6587\u4ef6\uff0c\u6548\u679c\u4e0d\u540c\u3002</p> <ul> <li>\u4e0d\u6307\u5b9a\u6587\u4ef6\u65f6\u3002\u5373\u5305\u542b\u4e86 <code>--soft</code> \u5b9e\u73b0\u7684\u529f\u80fd\uff0c\u5373 <code>HEAD</code> \u6307\u9488\u6307\u5411\u6307\u5b9a\u7684\u7248\u672c\uff0c\u53c8\u5b9e\u73b0\u4e86\u300c\u6682\u5b58\u533a\u300d\u7684\u5207\u6362\uff0c\u5373\u4f7f\u5f97\u6682\u5b58\u533a\u4e0e\u6307\u5b9a\u7248\u672c\u4e00\u81f4\u3002</li> <li>\u6307\u5b9a\u6587\u4ef6\u65f6\u3002<code>HEAD</code> \u6307\u9488\u4e0d\u53d8\uff0c\u4f46\u6307\u5b9a\u7684\u6587\u4ef6\u5bf9\u5e94\u7684\u6682\u5b58\u533a\u5185\u5bb9\u5c06\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u7684\u72b6\u6001\u3002</li> </ul> <p>\u9996\u5148\uff0c\u63d0\u4ea4 1.txt \u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u7248\u672c (fc746eb) \uff0c\u63d0\u4ea4 2-1.txt \u548c 2-2.txt \u4f5c\u4e3a\u7b2c\u4e8c\u4e2a\u7248\u672c (d3f6a97) \uff0c\u63d0\u4ea4 3.txt \u4f5c\u4e3a\u7b2c\u4e09\u4e2a\u7248\u672c (23a6441) \uff0c\u5c06 4.txt \u653e\u5165\u6682\u5b58\u533a\u4f46\u4e0d\u63d0\u4ea4\u3002</p> <pre><code>koshiba@koshiba hello-git % vim 1.txt\nkoshiba@koshiba hello-git % git add 1.txt\nkoshiba@koshiba hello-git % git commit -m \"add 1.txt\"\n[master (root-commit) fc746eb] add 1.txt\n 1 file changed, 1 insertion(+)\n create mode 100644 1.txt\nkoshiba@koshiba hello-git % vim 2-1.txt\nkoshiba@koshiba hello-git % vim 2-2.txt\nkoshiba@koshiba hello-git % git add 2-1.txt 2-2.txt\nkoshiba@koshiba hello-git % git commit -m \"add 2-1.txt 2-2.txt\"\n[master d3f6a97] add 2-1.txt 2-2.txt\n 2 files changed, 2 insertions(+)\n create mode 100644 2-1.txt\n create mode 100644 2-2.txt\nkoshiba@koshiba hello-git % vim 3.txt\nkoshiba@koshiba hello-git % git add 3.txt\nkoshiba@koshiba hello-git % git commit -m \"add 3.txt\"\n[master 23a6441] add 3.txt\n 1 file changed, 1 insertion(+)\n create mode 100644 3.txt\nkoshiba@koshiba hello-git % vim 4.txt\nkoshiba@koshiba hello-git % git add 4.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    new file:   4.txt\n\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6682\u5b58\u533a\u4e2d\u6709\u4e94\u4e2a\u6587\u4ef6\uff0c\u63d0\u4ea4\u5386\u53f2\u6709\u4e09\u6b21\uff0c\u5f53\u524d HEAD \u6307\u5411\u7684\u662f\u63d0\u4ea4\u4e86 3.txt \u7684\u7248\u672c\u3002</p> <pre><code>koshiba@koshiba hello-git % git ls-files\n1.txt\n2-1.txt\n2-2.txt\n3.txt\n4.txt\nkoshiba@koshiba hello-git % git reflog\n23a6441 (HEAD -&gt; master) HEAD@{0}: commit: add 3.txt\nd3f6a97 HEAD@{1}: commit: add 2-1.txt 2-2.txt\nfc746eb HEAD@{2}: commit (initial): add 1.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u63a5\u7740\u6267\u884c\u6df7\u5408\u5207\u6362 (<code>--mixed</code>) \u5230\u7b2c\u4e8c\u4e2a\u7248\u672c\uff0c\u5373\u63d0\u4ea4\u4e86 2-1.txt \u548c 2-2.txt \u7684\u7248\u672c (d3f6a97) \uff0c\u7531\u4e8e\u672a\u6307\u5b9a\u6587\u4ef6\uff0c\u56e0\u6b64\u5b9e\u73b0\u7684\u6548\u679c\u662f HEAD \u6307\u5411 d3f6a97 \uff0c\u4e14\u6682\u5b58\u533a\u4e5f\u6062\u590d\u5230 d3f6a97 \u7684\u72b6\u6001\u3002\u67e5\u770b\u63d0\u4ea4\u5386\u53f2\uff0cHEAD \u786e\u5b9e\u4e3a d3f6a97\uff0c\u4e14 message \u63d0\u793a\u4e86\u662f\u901a\u8fc7 reset \u5207\u6362\u800c\u6765\u7684\u3002\u901a\u8fc7 <code>git ls-files</code> \u770b\u5230\u6b64\u65f6\u6682\u5b58\u533a\u91cc\u7684\u6587\u4ef6\u4e5f\u786e\u5b9e\u662f\u7b2c\u4e8c\u4e2a\u7248\u672c\u5bf9\u5e94\u7684\u4e09\u4e2a\u6587\u4ef6 1.txt, 2-1.txt, 2-2.txt \uff0c\u5373\u76f8\u5f53\u4e8e\u628a\u6307\u5b9a\u7248\u672c\u4e4b\u540e\u624d\u653e\u5230\u6682\u5b58\u533a\u7684\u6587\u4ef6\u90fd\u79fb\u51fa\u4e86\u6682\u5b58\u533a\uff0c\u5bfc\u81f4\u8fd9\u4e9b\u6587\u4ef6\u51fa\u73b0\u5728 <code>git status</code> \u7684\u63d0\u793a\u4e2d\uff0c\u5373\u4ed6\u4eec\u6b64\u65f6\u662f \u300cUntracked files\u300d(\u5728\u6307\u5b9a\u7248\u672c\u4e4b\u540e\u624d\u521b\u5efa\u7684)\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset --mixed d3f6a97\nkoshiba@koshiba hello-git % git reflog\nd3f6a97 (HEAD -&gt; master) HEAD@{0}: reset: moving to d3f6a97\n23a6441 HEAD@{1}: commit: add 3.txt\nd3f6a97 (HEAD -&gt; master) HEAD@{2}: commit: add 2-1.txt 2-2.txt\nfc746eb HEAD@{3}: commit (initial): add 1.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    3.txt\n    4.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2-1.txt\n2-2.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u63a5\u7740\u518d\u6d4b\u8bd5\u6307\u5b9a\u6587\u4ef6\u7684\u6548\u679c\uff0c\u5982\u4e0b\uff0c\u7531\u4e8e <code>--mixed</code> \u662f\u9ed8\u8ba4\u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u7701\u7565\u3002\u6267\u884c <code>git reset fc746eb 2-1.txt</code> \u5c06\u6307\u5b9a\u6587\u4ef6 2-1.txt \u5bf9\u5e94\u7684\u6682\u5b58\u533a\u5185\u5bb9\u5207\u6362\u56de <code>fc746eb</code> \u7248\u672c (\u63d0\u4ea4\u4e86 1.txt \u7684\u7b2c\u4e00\u4e2a\u7248\u672c) \uff0c\u5373\u53ea\u5c06\u6b64\u6587\u4ef6\u5bf9\u5e94\u6682\u5b58\u533a\u7684\u5185\u5bb9\u79fb\u9664\u5bf9\u5e94\u5230\u6307\u5b9a\u7684\u7248\u672c\u72b6\u6001 (\u5bf9\u8fd9\u4e2a\u4f8b\u5b50\u6765\u8bf4\uff0c\u5373\u79fb\u9664\uff0c\u56e0\u4e3a 1.txt \u63d0\u4ea4\u7684\u65f6\u5019\u5c1a\u672a\u521b\u5efa 2-1.txt)\uff0c\u5176\u4ed6\u6587\u4ef6\u5728\u6682\u5b58\u533a\u7684\u5185\u5bb9\u4fdd\u7559\u3002</p> <p>\u9996\u5148\u901a\u8fc7 <code>git reflog</code> \u53ef\u4ee5\u770b\u5230 HEAD \u4e0d\u53d8\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset fc746eb 2-1.txt\nkoshiba@koshiba hello-git % git reflog\nd3f6a97 (HEAD -&gt; master) HEAD@{0}: reset: moving to d3f6a97\n23a6441 HEAD@{1}: commit: add 3.txt\nd3f6a97 (HEAD -&gt; master) HEAD@{2}: commit: add 2-1.txt 2-2.txt\nfc746eb HEAD@{3}: commit (initial): add 1.txt\nkoshiba@koshiba hello-git % \n</code></pre> <p>\u63a5\u7740\uff0c\u901a\u8fc7 <code>git ls-files</code> \u770b\u5230\u5f53\u524d\u6682\u5b58\u533a\u5df2\u65e0 2-1.txt \uff0c\u4f46\u5374\u6709 2-2.txt \uff0c\u8bf4\u660e\u53ea\u662f\u79fb\u9664\u4e86\u6307\u5b9a\u7684\u6587\u4ef6\u5bf9\u5e94\u7684\u6682\u5b58\u533a\u5185\u5bb9\u3002\u53e6\u5916\u6267\u884c <code>git status</code> \u53ef\u4ee5\u770b\u5230\u79fb\u51fa\u7684 2-1.txt \u4ee5\u53ca\u5728\u524d\u4e00\u6b21\u4e0d\u5e26\u6587\u4ef6\u540d\u7684\u6df7\u5408\u5207\u6362\u540e\u79fb\u51fa\u7684 3.txt \u548c 4.txt \u90fd\u53d8\u4e3a\u4e86 \u300cUntracked files\u300d\u3002</p> <pre><code>koshiba@koshiba hello-git % git status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged &lt;file&gt;...\" to unstage)\n    deleted:    2-1.txt\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    2-1.txt\n    3.txt\n    4.txt\n\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2-2.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-reset-hard","title":"git reset --hard","text":"<p><code>git reset --hard &lt;commit id&gt;</code> \u547d\u4ee4\u5c06 HEAD, index \u548c working tree \u90fd\u5207\u6362\u5230\u6307\u5b9a\u7248\u672c\u53f7\u7684\u72b6\u6001</p> <p>\u63a5\u7740\u4e4b\u524d <code>git reset --mixed</code> \u7684\u64cd\u4f5c\u540e\u7ee7\u7eed\u6f14\u793a\uff0c\u9996\u5148\u6267\u884c <code>git reset 23a6441</code> \u6062\u590d\u5230\u63d0\u4ea4\u4e86 3.txt \u4e4b\u540e\u7684\u7248\u672c\u72b6\u6001\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset 23a6441\nkoshiba@koshiba hello-git % git status\nOn branch master\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    4.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2-1.txt\n2-2.txt\n3.txt\nkoshiba@koshiba hello-git % git log --oneline\n23a6441 (HEAD -&gt; master) add 3.txt\nd3f6a97 add 2-1.txt 2-2.txt\nfc746eb add 1.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u7136\u540e\u6267\u884c <code>git reset --hard fc746eb</code> \u786c\u5207\u6362\u56de\u63d0\u4ea4\u4e86 1.txt \u4e4b\u540e\u7684\u7248\u672c\u3002\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u6548\u679c\uff0c\u5373 HEAD, index (\u6682\u5b58\u533a) \u548c\u5de5\u4f5c\u76ee\u5f55\u786e\u5b9e\u90fd\u5207\u6362\u5230\u4e86 fc746eb \u7684\u72b6\u6001\u3002\u7565\u6709\u4e0d\u540c\u7684\u662f\u6b64\u65f6\u8fd8\u5b58\u5728\u65b0\u5efa\u72b6\u6001\u4f46\u672a <code>git add</code> \u7684 4.txt\uff0c\u8fd9\u662f\u56e0\u4e3a\u6267\u884c\u6b64\u6b21\u786c\u5207\u6362\u65f6 4.txt \u662f\u672a <code>git add</code> \u7684\u72b6\u6001\uff0c\u4e0d\u88ab git \u6240\u7ba1\u63a7\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset --hard fc746eb\nHEAD is now at fc746eb add 1.txt\nkoshiba@koshiba hello-git % git log --oneline\nfc746eb (HEAD -&gt; master) add 1.txt\nkoshiba@koshiba hello-git % git reflog\nfc746eb (HEAD -&gt; master) HEAD@{0}: reset: moving to fc746eb\n23a6441 HEAD@{1}: reset: moving to 23a6441\nd3f6a97 HEAD@{2}: reset: moving to d3f6a97\n23a6441 HEAD@{3}: commit: add 3.txt\nd3f6a97 HEAD@{4}: commit: add 2-1.txt 2-2.txt\nfc746eb (HEAD -&gt; master) HEAD@{5}: commit (initial): add 1.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    4.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba hello-git % git ls-files\n1.txt\nkoshiba@koshiba hello-git % ls -al\ntotal 16\ndrwxr-xr-x@  5 koshiba  staff  160 Sep 29 16:21 .\ndrwxr-xr-x@ 10 koshiba  staff  320 Sep 29 16:21 ..\ndrwxr-xr-x@ 13 koshiba  staff  416 Sep 29 16:20 .git\n-rw-r--r--   1 koshiba  staff    3 Sep 29 15:34 1.txt\n-rw-r--r--   1 koshiba  staff    4 Sep 29 15:35 4.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u5982\u679c\u8fd9\u65f6\u5019\u6211\u4eec\u518d\u6b21\u786c\u5207\u6362\u56de\u63d0\u4ea4\u4e86 3.txt \u7684\u7248\u672c (23a6441)\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u6548\u679c\uff0c\u5373\u6062\u590d\u5230\u4e86\u8be5\u7248\u672c\u72b6\u6001\uff0c\u4e0d\u540c\u7684\u4e5f\u662f 4.txt \u4ecd\u7136\u5b58\u5728\uff0c\u539f\u56e0\u540c\u524d\u8ff0\u3002</p> <pre><code>koshiba@koshiba hello-git % git reset --hard 23a6441\nHEAD is now at 23a6441 add 3.txt\nkoshiba@koshiba hello-git % ls -al\ntotal 40\ndrwxr-xr-x@  8 koshiba  staff  256 Sep 29 16:21 .\ndrwxr-xr-x@ 10 koshiba  staff  320 Sep 29 16:21 ..\ndrwxr-xr-x@ 13 koshiba  staff  416 Sep 29 16:21 .git\n-rw-r--r--   1 koshiba  staff    3 Sep 29 15:34 1.txt\n-rw-r--r--   1 koshiba  staff    2 Sep 29 16:21 2-1.txt\n-rw-r--r--   1 koshiba  staff    4 Sep 29 16:21 2-2.txt\n-rw-r--r--   1 koshiba  staff    4 Sep 29 16:21 3.txt\n-rw-r--r--   1 koshiba  staff    4 Sep 29 15:35 4.txt\nkoshiba@koshiba hello-git % git status\nOn branch master\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    4.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\nkoshiba@koshiba hello-git % git ls-files\n1.txt\n2-1.txt\n2-2.txt\n3.txt\nkoshiba@koshiba hello-git % git log --oneline\n23a6441 (HEAD -&gt; master) add 3.txt\nd3f6a97 add 2-1.txt 2-2.txt\nfc746eb add 1.txt\nkoshiba@koshiba hello-git % git reflog\n23a6441 (HEAD -&gt; master) HEAD@{0}: reset: moving to 23a6441\nfc746eb HEAD@{1}: reset: moving to fc746eb\n23a6441 (HEAD -&gt; master) HEAD@{2}: reset: moving to 23a6441\nd3f6a97 HEAD@{3}: reset: moving to d3f6a97\n23a6441 (HEAD -&gt; master) HEAD@{4}: commit: add 3.txt\nd3f6a97 HEAD@{5}: commit: add 2-1.txt 2-2.txt\nfc746eb HEAD@{6}: commit (initial): add 1.txt\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_8","title":"\u5206\u652f\u64cd\u4f5c","text":"<p>\u5206\u652f\u672c\u8d28\u4e0a\u662f\u6307\u5411\u63d0\u4ea4\u5bf9\u8c61\u7684\u53ef\u53d8\u6307\u9488\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-branch","title":"git branch","text":"<p>\u65b0\u5efa\u5206\u652f\u672c\u8d28\u4e0a\u662f git \u521b\u5efa\u4e86\u4e00\u4e2a\u53ef\u4ee5\u79fb\u52a8\u7684\u6307\u5411\u5f53\u524d\u63d0\u4ea4\u5bf9\u8c61\u7684\u65b0\u6307\u9488\u3002</p> <p>\u4f7f\u7528 <code>git branch &lt;\u5206\u652f\u540d&gt;</code> \u521b\u5efa\u5206\u652f\u3002</p> <pre><code>koshiba@koshiba hello-git % git branch testing\nkoshiba@koshiba hello-git % git branch -a\n* master\n  remote\n  testing\n  remotes/origin/master\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u4f7f\u7528  <code>git branch -d &lt;\u5206\u652f\u540d&gt;</code> \u5220\u9664\u5206\u652f\uff0c\u6267\u884c <code>git branch</code> \u67e5\u770b\u672c\u5730\u4ed3\u5e93\u5206\u652f\u5217\u8868\uff0c <code>*</code> \u8868\u793a\u5f53\u524d\u5206\u652f\u3002</p> <pre><code>koshiba@koshiba hello-git % git branch -d testing\nDeleted branch testing (was 070472d).\nkoshiba@koshiba hello-git % git branch\n* master\n  remote\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-switch","title":"git switch","text":"<p>\u4f7f\u7528 <code>git switch &lt;\u5206\u652f\u540d&gt;</code> \u5207\u6362\u5206\u652f\u3002</p> <pre><code>koshiba@koshiba hello-git % git branch testing\nkoshiba@koshiba hello-git % git branch\n* master\n  testing\nkoshiba@koshiba hello-git % git switch testing\nSwitched to branch 'testing'\nkoshiba@koshiba hello-git % git status\nOn branch testing\nnothing to commit, working tree clean\nkoshiba@koshiba hello-git % git switch -c fix\nSwitched to a new branch 'fix'\nkoshiba@koshiba hello-git % git branch\n* fix\n  master\n  testing\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u4f7f\u7528 <code>git switch -c &lt;\u5206\u652f\u540d&gt;</code> \u521b\u5efa\u5e76\u5207\u6362\u5206\u652f\u3002</p> <p>\u4f7f\u7528 <code>git switch -</code> \u5207\u6362\u5230\u4e0a\u4e00\u6b21\u6240\u5728\u5206\u652f\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-checkout","title":"git checkout","text":"<p>\u4f7f\u7528 <code>git checkout &lt;\u5206\u652f\u540d&gt;</code> \u5207\u6362\u5206\u652f\u3002</p> <pre><code>koshiba@koshiba hello-git % git checkout testing\nSwitched to branch 'testing'\nkoshiba@koshiba hello-git % git status\nOn branch testing\nnothing to commit, working tree clean\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u4f7f\u7528 <code>git checkout -b &lt;\u5206\u652f\u540d&gt;</code> \u521b\u5efa\u5e76\u5207\u6362\u5206\u652f\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-merge","title":"git merge","text":"<p><code>git merge &lt;\u5206\u652f\u540d&gt;</code> \u5c06\u6307\u5b9a\u5206\u652f\u5408\u5e76\u5230\u5f53\u524d\u5206\u652f\u4e2d\u3002\u5408\u5e76\u901a\u5e38\u6709\u300c\u5feb\u8fdb\u300d\u548c \u300c\u4e09\u65b9\u5408\u5e76\u300d\u3002</p> <p>\u65b0\u5efa\u5e76\u5207\u6362\u5230 testing \u5206\u652f\u540e\uff0c\u5728 testing \u5206\u652f\u4e0a\u5b8c\u6210\u82e5\u5e72\u6b21 commit\uff0c\u4e14 master \u65e0\u65b0\u7684 commit\uff0c\u6b64\u65f6\u5207\u56de master \u5206\u652f\uff0c\u5e76\u6267\u884c <code>git merge</code> \u5c06 testing \u5408\u5e76\u5230\u5f53\u524d\u5206\u652f\u4e2d\u3002</p> <pre><code>koshiba@koshiba hello-git % git checkout master\nSwitched to branch 'master'\nYour branch is ahead of 'origin/master' by 3 commits.\n  (use \"git push\" to publish your local commits)\nkoshiba@koshiba hello-git % git merge testing\nUpdating 44f99a2..b4552ad\nFast-forward\n hello.txt | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u7531\u4e8e master \u662f testing \u7684\u76f4\u63a5\u7956\u5148\uff0cmaster \u53ef\u987a\u7740 testing \u5206\u652f\u7684\u5386\u6b21 commit \u76f4\u63a5\u5230\u8fbe\u5f53\u524d testing\uff0c\u6b64\u60c5\u51b5\u4e0b\u7684\u5408\u5e76\u65e0\u9700\u89e3\u51b3\u5206\u6b67\uff0c\u56e0\u6b64 master \u53ef\u4ee5\u300c\u5feb\u8fdb\u300d\u76f4\u8fbe testing\uff0c\u800c\u4e0d\u4f1a\u4ea7\u751f\u65b0\u7684\u7248\u672c (\u5feb\u7167)\uff0c\u56de\u663e\u4e2d\u7684 <code>Fast-forwad</code> \u53cd\u6620\u4e86\u8fd9\u4e00\u7279\u70b9\u3002</p> <p>\u5982\u4e0b\u53ef\u4ee5\u770b\u5230\u5728 master \u5206\u652f\u4e0b\u5408\u5e76 testing \u5206\u652f\u540e\uff0c\u5f53\u524d HEAD (55d1aca) \u4e0e testing \u6700\u540e\u4e00\u6b21\u63d0\u4ea4\u662f\u540c\u4e00\u4e2a\u3002</p> <pre><code>55d1aca (HEAD -&gt; master, testing) HEAD@{0}: merge testing: Fast-forward\n6255ab9 HEAD@{1}: checkout: moving from testing to master\n55d1aca (HEAD -&gt; master, testing) HEAD@{2}: commit: testing commit\n6255ab9 HEAD@{3}: checkout: moving from master to testing\n6255ab9 HEAD@{4}: commit (initial): master commit\n</code></pre> <p>\u82e5\u4ece\u5206\u6b67\u70b9\u5f00\u59cb master \u548c testing \u90fd\u5404\u81ea\u524d\u8fdb\u4e86\u82e5\u5e72\u4e2a commit\uff0c\u5219\u6b64\u65f6\u5408\u5e76\u4e3a\u300c\u4e09\u65b9\u5408\u5e76\u300d\u3002\u82e5\u4ea7\u751f\u51b2\u7a81\uff0c\u5219\u6709\u5982\u4e0b\u63d0\u793a\u3002</p> <pre><code>koshiba@koshiba hello-git % git log --oneline --graph --all\n* 4a3e876 (HEAD -&gt; testing) testing 1\n| * b6c50b9 (master) master 1\n|/\n* b4552ad modified hello.txt 3\n...(\u7565)...\nkoshiba@koshiba hello-git % git merge testing\nAuto-merging hello.txt\nCONFLICT (content): Merge conflict in hello.txt\nAutomatic merge failed; fix conflicts and then commit the result.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u89e3\u51b3\u51b2\u7a81\u540e\uff0c\u6267\u884c <code>git status</code> \u53ef\u4ee5\u770b\u5230 <code>All conflicts fixed but you are still merging.</code> \uff0c\u5373\u8bf4\u660e\u51b2\u7a81\u5df2\u89e3\u51b3\uff0c\u6839\u636e\u63d0\u793a\u518d\u6b21\u63d0\u4ea4\u5373\u5b8c\u6210\u5408\u5e76\u3002\u4e0e\u300c\u5feb\u8fdb\u300d\u5408\u5e76\u4e0d\u540c\u7684\u662f\uff0c\u300c\u4e09\u65b9\u5408\u5e76\u300d\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u5feb\u7167\u3002</p> <pre><code>koshiba@koshiba hello-git % git status\nOn branch master\nYour branch is ahead of 'origin/master' by 7 commits.\n  (use \"git push\" to publish your local commits)\n\nAll conflicts fixed but you are still merging.\n  (use \"git commit\" to conclude merge)\n\nkoshiba@koshiba hello-git %\nkoshiba@koshiba hello-git % git commit\n[master b8da922] Merge branch 'testing'\nkoshiba@koshiba hello-git % git log --oneline --graph --all\n*   b8da922 (HEAD -&gt; master) Merge branch 'testing'\n|\\\n| * 4a3e876 (testing) testing 1\n* | b6c50b9 master 1\n|/\n* b4552ad modified hello.txt 3\n...(\u7565)...\n</code></pre> <p>\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u968f\u65f6\u4ee5\u56fe\u5f62\u5f62\u5f0f\u67e5\u770b\u4e0d\u540c\u5206\u652f\u7684\u524d\u8fdb\u548c\u5408\u5e76\u8fc7\u7a0b\u3002</p> <pre><code>git log --oneline --decorate --graph --all\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-rebase","title":"git rebase","text":"<p>\u4e24\u5206\u652f\u4ece\u5206\u53c9\u5904\u5f00\u59cb\u5404\u81ea\u6709\u82e5\u5e72\u63d0\u4ea4\uff0c\u5408\u5e76\u8fd9\u4e24\u4e2a\u5206\u652f\u7684\u53e6\u4e00\u79cd\u65b9\u5f0f\u662f <code>git rebase</code> (\u53d8\u57fa)\uff0c\u4e0e <code>git merge</code> \u6267\u884c\u300c\u4e09\u65b9\u5408\u5e76\u300d\u4e0d\u540c\u7684\u662f\uff0c<code>git rebase</code> \u4f1a\u5728\u5f53\u524d\u5206\u652f\u4e0b\u91cd\u653e\u53e6\u4e00\u4e2a\u5206\u652f\u5728\u5206\u53c9\u5904\u540e\u7684\u5386\u6b21\u63d0\u4ea4\uff0c\u6700\u7ec8\u5f97\u5230\u4e00\u4e2a\u65b0\u63d0\u4ea4\uff0c\u7ed3\u679c\u4e0e <code>git merge</code> \u76f8\u540c\uff0c\u4f46\u63d0\u4ea4\u5386\u53f2\u66f4\u6574\u6d01\uff0c\u5206\u652f\u867d\u5e76\u884c\uff0c\u4f46\u53d8\u57fa\u4e4b\u540e\u7684\u63d0\u4ea4\u5386\u53f2\u662f\u4e00\u6761\u4e32\u884c\u7684\u76f4\u7ebf\u3002</p> <p>\u5f53\u524d\u5206\u53c9\u540e master \u5206\u652f\u548c testing \u5206\u652f\u5404\u6709\u4e00\u4e2a\u63d0\u4ea4\u7248\u672c\u3002</p> <pre><code>koshiba@koshiba hello-git % git log --oneline --decorate --graph --all\n* e2f517c (HEAD -&gt; testing) testing modified 1\n| * ae47d2e (master) master modified 1\n| *   b8da922 Merge branch 'testing'\n| |\\\n| |/\n|/|\n* | 4a3e876 testing 1\n...(\u7565)...\n</code></pre> <p>\u5207\u56de master \uff0c\u6267\u884c\u53d8\u57fa\uff0c\u5982\u4e0b\uff0c\u6709\u51b2\u7a81\uff0c\u6839\u636e\u63d0\u793a\u5148\u89e3\u51b3\u51b2\u7a81\u3002</p> <pre><code>koshiba@koshiba hello-git % git checkout master\nSwitched to branch 'master'\nkoshiba@koshiba hello-git % git rebase testing\nAuto-merging hello.txt\nCONFLICT (content): Merge conflict in hello.txt\nerror: could not apply b6c50b9... master 1\nhint: Resolve all conflicts manually, mark them as resolved with\nhint: \"git add/rm &lt;conflicted_files&gt;\", then run \"git rebase --continue\".\nhint: You can instead skip this commit: run \"git rebase --skip\".\nhint: To abort and get back to the state before \"git rebase\", run \"git rebase --abort\".\nCould not apply b6c50b9... master 1\n</code></pre> <p>\u89e3\u51b3\u51b2\u7a81\u540e\uff0c\u5bf9\u51b2\u7a81\u6587\u4ef6\u6267\u884c <code>git add</code> \u540e\uff0c\u518d\u6b21\u6267\u884c\u53d8\u57fa <code>git rebase --continue</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git rebase --continue\nSuccessfully rebased and updated refs/heads/master.\nkoshiba@koshiba hello-git % git log --oneline --decorate --graph --all\n* e2f517c (HEAD -&gt; master, testing) testing modified 1\n* 4a3e876 testing 1\n...(\u7565)...\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u76f4\u63a5\u6267\u884c <code>git rebase &lt;basebranch&gt; &lt;topicbranch&gt;</code> \u5c06 topicbranch \u5206\u53c9\u540e\u7684\u4fee\u6539\u5728 basebranch \u4e0a\u91cd\u653e\uff0c\u7701\u53bb\u4e86 <code>git checkout</code> \u5207\u6362\u5230 basebranch \u7684\u64cd\u4f5c\u3002</p> <p>\u53d8\u57fa\u7684\u539f\u5219\uff1a\u53ea\u5bf9\u5c1a\u672a\u63a8\u9001\u7684\u672c\u5730\u4fee\u6539\u6267\u884c\u53d8\u57fa\uff0c\u800c\u4e0d\u5bf9\u672c\u5730\u4ed3\u5e93\u5916\u6709\u526f\u672c\u7684\u5206\u652f\u6267\u884c\u53d8\u57fa\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#_9","title":"\u8fdc\u7a0b\u64cd\u4f5c","text":"<p>\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u4e4b\u95f4\u5efa\u7acb\u5173\u8054\u7684\u65b9\u5f0f\u5982\u4e0b\u3002</p> <ul> <li>\u65b9\u5f0f\u4e00(\u672c\u5730\u5230\u8fdc\u7a0b)\uff1a\u5148\u5efa\u7acb\u672c\u5730\u4ed3\u5e93\uff0c\u7136\u540e\u5c06\u672c\u5730\u4ed3\u5e93\u63a8\u9001\u5230\u8fdc\u7a0b\u3002</li> <li>\u65b9\u5f0f\u4e8c(\u8fdc\u7a0b\u5230\u672c\u5730)\uff1a\u5148\u5efa\u7acb\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u7136\u540e\u5728\u672c\u5730\u514b\u9686\u8fdc\u7a0b\u4ed3\u5e93\u3002</li> </ul> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-remote","title":"git remote","text":"<p>\u5b9e\u73b0\u4ece\u672c\u5730\u5230\u8fdc\u7a0b\u7684\u65b9\u5f0f\u4e00\uff0c\u9996\u5148\u8981\u4f7f\u7528 <code>git remote add &lt;\u4ed3\u5e93\u522b\u540d&gt; &lt;url/ssh&gt;</code> \u5173\u8054\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b github \u4ed3\u5e93\u3002\u6839\u636e\u901a\u4fe1\u534f\u8bae\u7684\u4e0d\u540c\uff0c\u5206\u4e3a https \u65b9\u5f0f\u548c ssh \u65b9\u5f0f\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#https","title":"https\u65b9\u5f0f","text":"<p>\u30101. \u5173\u8054\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u3011</p> <p>\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u5b8c\u6210\u5173\u8054\uff0c\u5e76\u68c0\u67e5\u5173\u8054\u7ed3\u679c\u3002</p> <pre><code>koshiba@koshiba git-demo % git remote add origin https://github.com/ikoshiba/git-demo.git\nkoshiba@koshiba git-demo % git remote\norigin\nkoshiba@koshiba git-demo % git remote -v\norigin  https://github.com/ikoshiba/git-demo.git (fetch)\norigin  https://github.com/ikoshiba/git-demo.git (push)\nkoshiba@koshiba git-demo %\n</code></pre> <p></p> <p>\u30102. \u5728 github \u4e0a\u521b\u5efa\u8fdc\u7a0b\u4ed3\u5e93\u3011</p> <p>\u4ed3\u5e93\u540d\u901a\u5e38\u4e0e\u672c\u5730\u4ed3\u5e93\u76f8\u540c\uff0c\u4f46\u4e5f\u53ef\u4ee5\u4e0d\u540c\u3002</p> <p></p> <p>\u30103. \u63a8\u9001\u3011</p> <p>\u5173\u8054\u540e\u6267\u884c <code>git push -u origin master</code> \u63a8\u9001\u672c\u5730\u4ed3\u5e93\u5230\u8fdc\u7a0b\u4ed3\u5e93\u4e2d\u3002\u5176\u4e2d <code>-u</code> \u53c2\u6570\u662f <code>--set-upstream</code> \u7684\u7f29\u7565\uff0c\u4f7f\u5f97\u5f53\u524d\u672c\u5730\u5206\u652f <code>master</code>  \u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u5206\u652f <code>master</code> \u5173\u8054\u8d77\u6765\uff0c\u540e\u7eed\u518d\u63a8\u9001\u65f6\uff0c\u5c31\u53ea\u9700\u8981\u6267\u884c <code>git push</code> \u5373\u53ef\u3002</p> <pre><code>koshiba@koshiba git-demo % git push -u origin master\nUsername for 'https://github.com': ikoshiba\nPassword for 'https://ikoshiba@github.com':\nremote: Support for password authentication was removed on August 13, 2021.\nremote: Please see https://docs.github.com/en/get-started/getting-started-with-git/about-remote-repositories#cloning-with-https-urls for information on currently recommended modes of authentication.\nfatal: Authentication failed for 'https://github.com/ikoshiba/git-demo.git/'\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u6ce8\u610f\uff0c\u6839\u636e\u5982\u4e0a\u63d0\u793a\uff0cgithub \u4ece 2021\u5e748\u670813\u65e5\u8d77\uff0chttps \u65b9\u5f0f\u7684\u63a5\u5165\u6821\u9a8c\u4e0d\u518d\u652f\u6301\u4f7f\u7528 \u666e\u901a\u5bc6\u7801 \u7684\u65b9\u5f0f\uff0c\u76ee\u524d\u652f\u6301\u4f7f\u7528 Personal Access Token \u6765\u5b8c\u6210\u8ba4\u8bc1\uff0c\u5373 <code>Password for 'https://...'</code> \u5904\u5e94\u5f53\u586b\u5199\u76ee\u6807 github \u8d26\u53f7\u7684 Personal Access Token (PAT) \uff0c\u8bbe\u7f6e\u65b9\u5f0f\u5728 \u8fd9\u91cc \u67e5\u770b\u3002</p> <p>\u586b\u5165\u6b63\u786e\u7684 PAT \u540e\u5373\u53ef\u6210\u529f\u63a8\u9001\uff0c\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba git-demo % git push -u origin master\nUsername for 'https://github.com': ikoshiba\nPassword for 'https://ikoshiba@github.com':\nEnumerating objects: 57, done.\nCounting objects: 100% (57/57), done.\nDelta compression using up to 8 threads\nCompressing objects: 100% (37/37), done.\nWriting objects: 100% (57/57), 5.02 KiB | 642.00 KiB/s, done.\nTotal 57 (delta 5), reused 0 (delta 0), pack-reused 0\nremote: Resolving deltas: 100% (5/5), done.\nTo https://github.com/ikoshiba/git-demo.git\n * [new branch]      master -&gt; master\nbranch 'master' set up to track 'origin/master'.\nkoshiba@koshiba git-demo %\n</code></pre> <p>\u6ce8\u610f\uff0c\u5982\u679c\u6ca1\u6709\u4e8b\u5148\u5728 github \u4e0a\u521b\u5efa\u76ee\u6807\u5173\u8054\u8fdc\u7a0b\u4ed3\u5e93\u7684\u8bdd\uff0c\u63a8\u9001\u5c06\u4f1a\u5931\u8d25\uff0c\u5e76\u663e\u793a\u5931\u8d25\u539f\u56e0\u662f\u627e\u4e0d\u5230\u6307\u5b9a\u7684\u8fdc\u7a0b\u4ed3\u5e93\u3002</p> <pre><code>koshiba@koshiba git-demo % git push -u origin master\nremote: Repository not found.\nfatal: repository 'https://github.com/ikoshiba/git-demo.git/' not found\nkoshiba@koshiba git-demo\n</code></pre> <p></p> <p>\u30104. \u67e5\u770b\u8fdc\u7a0b\u5e93\u4fe1\u606f\u3011</p> <p>\u6267\u884c <code>git remote show origin</code> \u67e5\u770b\u8fdc\u7a0b\u5e93\u4fe1\u606f\u3002</p> <pre><code>koshiba@koshiba hello-git % git remote show origin\n* remote origin\n  Fetch URL: https://github.com/ikoshiba/hello-git.git\n  Push  URL: https://github.com/ikoshiba/hello-git.git\n  HEAD branch: master\n  Remote branch:\n    master tracked\n  Local branch configured for 'git pull':\n    master merges with remote master\n  Local ref configured for 'git push':\n    master pushes to master (up to date)\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#ssh","title":"ssh\u65b9\u5f0f","text":"<p>https \u65b9\u5f0f\u6bcf\u6b21\u63a8\u9001\u90fd\u9700\u8981\u8ba4\u8bc1\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u7528 ssh \u65b9\u5f0f\u7ea6\u5b9a\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u7684\u516c\u79c1\u94a5\uff0c\u5373\u53ef\u81ea\u52a8\u8ba4\u8bc1\u3002</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\u5ba2\u6237\u7aef\u73af\u5883\u53ea\u9700\u8981\u4e00\u5bf9\u516c\u79c1\u94a5\u5efa\u7acb\u5230 github \u8fdc\u7a0b\u5e93\u7684 ssh \u901a\u4fe1\u3002\u82e5\u5e0c\u671b\u5728\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\u4e0b\u4e0e\u591a\u4e2a github \u8d26\u53f7\u4e0b\u7684\u4ed3\u5e93\u5efa\u7acb ssh \u901a\u4fe1\uff0c\u5219\u7531\u4e8e github \u4e0d\u540c\u8d26\u53f7\u4e0b\u7684\u516c\u94a5\u5fc5\u987b\u4e0d\u540c\uff0c\u76f8\u5e94\u5730\uff0c\u5728\u672c\u5730\u521b\u5efa\u516c\u79c1\u94a5\u5bf9\u65f6\uff0c\u4e5f\u9700\u8981\u521b\u5efa\u591a\u5bf9\u3002</p> <p>\u5982\u4e0b\u6f14\u793a\u5982\u4f55\u521b\u5efa\u4e24\u5bf9\u4e0d\u540c\u7684\u516c\u79c1\u94a5\uff0c\u5e76\u5e94\u7528\u5230\u5bf9\u4e0d\u540c\u7684 github \u8d26\u53f7\u7684 ssh \u8fde\u63a5\u4e2d\u3002</p> <p>\u30101. ssh-keygen \u547d\u4ee4\u751f\u6210\u516c\u79c1\u94a5\u5bf9\u3011</p> <p>\u6267\u884c <code>ssh-keygen -t rsa -C \"yuki.com\"</code> \u547d\u4ee4\u751f\u6210\u516c\u79c1\u94a5\u5bf9\u3002<code>-t</code> \u9009\u62e9\u52a0\u5bc6\u7b97\u6cd5\uff0c <code>-C</code> \u6dfb\u52a0\u5907\u6ce8\uff0c\u4e60\u60ef\u4e0a\u4f1a\u586b\u5199\u4e00\u4e2a\u90ae\u7bb1\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u586b\u5199\u5176\u4ed6\u5b57\u7b26\u4e32\u3002</p> \u8bbe\u7f6e \u63cf\u8ff0 Enter file in which to save the key () \u62ec\u53f7\u540e\u662f\u9ed8\u8ba4\u516c\u79c1\u94a5\u8def\u5f84\u548c\u540d\u79f0\u79c1\u94a5\u9ed8\u8ba4\u540d: id_rsa\u516c\u94a5\u9ed8\u8ba4\u540d: id_rsa.pub Enter passphrase \u52a0\u5bc6\u4e32\uff0c\u5373 ssh \u901a\u4fe1\u65f6\u7684\u53e3\u4ee4\uff0c\u901a\u5e38\u4e0d\u4f7f\u7528\uff0c\u56de\u8f66\u5373\u53ef <pre><code>koshiba@koshiba ~ % ssh-keygen -t rsa -C \"yuki.com\"\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/Users/koshiba/.ssh/id_rsa): /Users/koshiba/.ssh/id_rsa_163\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /Users/koshiba/.ssh/id_rsa_163\nYour public key has been saved in /Users/koshiba/.ssh/id_rsa_163.pub\nThe key fingerprint is:\nSHA256:rS6a3ou3HauNl0w+1Y5v6oTzbVo7xu/PKaOVIQbMCoI yuki.com\nThe key's randomart image is:\n+---[RSA 3072]----+\n|                 |\n|  .     o        |\n| E . .   +       |\n|    . . ...      |\n|       .S .+ .   |\n|        .oo o o  |\n|       +=o.+.o   |\n|     +o=**.oO+ ..|\n|   .=o**=o=O=+=oo|\n+----[SHA256]-----+\nkoshiba@koshiba ~ % \n</code></pre> <p>\u63a5\u7740\u6267\u884c <code>ssh-keygen -t rsa -C \"yama.com\"</code> \u751f\u6210\u53e6\u4e00\u5bf9\u516c\u79c1\u94a5\u5bf9\uff0c\u5728 <code>~/.ssh</code> \u4e0b\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u4e24\u5bf9\u516c\u79c1\u94a5\u5bf9\u3002</p> <pre><code>id_rsa_163\nid_rsa_163.pub\nid_rsa_outlook\nid_rsa_outlook.pub\n</code></pre> <p>\u30102. \u5728 <code>.ssh</code> \u4e0b\u521b\u5efa <code>config</code> \u6587\u4ef6\u3011</p> <p>\u521b\u5efa\u5982\u4e0b <code>config</code> \u6587\u4ef6\u3002</p> <pre><code># github-163\nHost github.com.163\nHostName github.com\nPreferredAuthentications publickey\nIdentityFile ~/.ssh/id_rsa_163\n\n# github-outlook\nHost github.com.outlook\nHostName github.com\nPreferredAuthentications publickey\nIdentityFile ~/.ssh/id_rsa_outlook\n</code></pre> <p>\u540e\u9762\u6211\u4eec\u4f1a\u770b\u5230\uff0c\u5c06\u6307\u5b9a\u7684\u516c\u79c1\u94a5\u5bf9\u4e0e\u6307\u5b9a\u7684 github \u8d26\u6237\u76f8\u5173\u8054\u7684\u5173\u952e\u662f <code>Host</code> \uff0c\u5b83\u662f\u8fdc\u7a0b\u6258\u7ba1\u670d\u52a1\u7aef\u7684\u522b\u540d\uff0c\u5728\u4f7f\u7528 <code>git@&lt;host&gt;</code> \u65b9\u5f0f\u6267\u884c ssh \u8fde\u63a5\u65f6\uff0c<code>&lt;host&gt;</code> \u586b\u5165\u7684\u5373 <code>Host</code> \u3002</p> <p><code>Host</code> \u4e0e <code>IdentityFile</code> \u51b3\u5b9a\u4e86\u516c\u79c1\u94a5\u5bf9\u4e0e\u5177\u4f53\u8d26\u6237\u7684\u5bf9\u5e94\u5173\u7cfb (\u8be5\u8d26\u6237\u4e0b\u7528\u516c\u94a5\u4e0e <code>IdentifyFile</code> \u4e2d\u6307\u5b9a\u7684\u4e00\u6837) \uff0c\u800c\u5b9e\u9645\u4e0a\u4f1a\u8fde\u63a5 <code>Hostname</code> \u3002</p> <p>\u30103. \u5c06\u516c\u94a5\u6dfb\u52a0\u5bf9\u5e94\u7684 github \u8d26\u6237\u4e2d\u3011</p> <p>\u5728 github \u7684 <code>setting &gt; SSH and GPG keys &gt; SSH keys</code> \u4e2d\u70b9\u51fb <code>New SSH key</code> \u6dfb\u52a0\u516c\u94a5\u7684\u5185\u5bb9\u3002</p> <p>\u4f7f\u7528 <code>ssh -T git@github.com.outlook</code> \u547d\u4ee4\u6d4b\u8bd5 ssh \u8fde\u63a5\uff0c\u51fa\u73b0\u5982\u4e0b\u63d0\u793a\u5373\u8bf4\u660e\u53ef\u901a\u8fc7 ssh \u65b9\u5f0f\u901a\u4fe1\u3002</p> <pre><code>koshiba@koshiba hello-git % ssh -T git@github.com.outlook\nHi ikoshiba! You've successfully authenticated, but GitHub does not provide shell access.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u30104. \u5173\u8054\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u3011</p> <p>\u4f7f\u7528 <code>git remote add</code> \u547d\u4ee4\u5173\u8054\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u3002\u82e5\u5f53\u524d\u5b58\u5728 https \u65b9\u5f0f\u7684\u5173\u8054\uff0c\u5148\u6267\u884c <code>git remote rm origin</code> \u5220\u9664\u3002</p> <pre><code>koshiba@koshiba hello-git % git remote add origin git@github.com.outlook:ikoshiba/hello-git.git\nkoshiba@koshiba hello-git % git remote -v\norigin  git@github.com.outlook:ikoshiba/hello-git.git (fetch)\norigin  git@github.com.outlook:ikoshiba/hello-git.git (push)\n</code></pre> <p>\u30105. \u63a8\u9001\u3011</p> <p>\u4e0e https \u65b9\u5f0f\u4e00\u6837\uff0c\u63a8\u9001\u524d\u4e5f\u8981\u63d0\u524d\u5728 github \u4e2d\u521b\u5efa\u597d\u76ee\u6807\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u5426\u5219\u4f1a\u62a5\u5982\u4e0b\u9519 <code>ERROR: Repository not found.</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git push -u origin master\nERROR: Repository not found.\nfatal: Could not read from remote repository.\n</code></pre> <p>\u521b\u5efa\u540e\u518d\u6b21\u63a8\u9001\u6210\u529f\uff0c\u8fdc\u7a0b\u5e93\u4e2d\u4e5f\u51fa\u73b0\u4e86\u672c\u5730\u5e93\u63a8\u9001\u7684\u6587\u4ef6\u3002</p> <pre><code>koshiba@koshiba hello-git % git push -u origin master\nEnumerating objects: 57, done.\nCounting objects: 100% (57/57), done.\nDelta compression using up to 8 threads\nCompressing objects: 100% (32/32), done.\nWriting objects: 100% (57/57), 5.02 KiB | 5.02 MiB/s, done.\nTotal 57 (delta 5), reused 57 (delta 5), pack-reused 0\nremote: Resolving deltas: 100% (5/5), done.\nTo github.com.outlook:ikoshiba/hello-git.git\n * [new branch]      master -&gt; master\nbranch 'master' set up to track 'origin/master'.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u30106. \u67e5\u770b\u8fdc\u7a0b\u5e93\u4fe1\u606f\u3011</p> <p>\u6267\u884c <code>git remote show origin</code> \u67e5\u770b\u8fdc\u7a0b\u5e93\u4fe1\u606f\u3002</p> <pre><code>koshiba@koshiba hello-git % git remote show origin\n* remote origin\n  Fetch URL: git@github.com.outlook:ikoshiba/hello-git.git\n  Push  URL: git@github.com.outlook:ikoshiba/hello-git.git\n  HEAD branch: master\n  Remote branch:\n    master tracked\n  Local branch configured for 'git pull':\n    master merges with remote master\n  Local ref configured for 'git push':\n    master pushes to master (up to date)\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#rename","title":"rename","text":"<p>\u53ef\u4ee5\u901a\u8fc7 <code>git remote rename &lt;\u5f53\u524d\u522b\u540d&gt; &lt;\u65b0\u522b\u540d&gt;</code> \u6765\u4fee\u6539\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u4fee\u6539\u540e\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u770b\u5230\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d\u5df2\u7ecf\u53d8\u4e3a <code>main</code> \uff0c\u539f\u5148\u7684 <code>origin</code> \u5df2\u4e0d\u53ef\u7528\uff0c\u4e14\u8fdc\u7a0b\u4ed3\u5e93\u5206\u652f\u4e5f\u76f8\u5e94\u53d8\u4e3a <code>main/master</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git remote rename origin main\nRenaming remote references: 100% (1/1), done.\nkoshiba@koshiba hello-git % git remote\nmain\nkoshiba@koshiba hello-git % git remote -v\nmain    git@github.com.outlook:ikoshiba/hello-git.git (fetch)\nmain    git@github.com.outlook:ikoshiba/hello-git.git (push)\nkoshiba@koshiba hello-git % git branch -r\n  main/master\nkoshiba@koshiba hello-git % git branch -a\n* master\n  remote\n  remotes/main/master\nkoshiba@koshiba hello-git % git push\nEverything up-to-date\nkoshiba@koshiba hello-git % git push main master\nEverything up-to-date\nkoshiba@koshiba hello-git % git remote show origin\nfatal: 'origin' does not appear to be a git repository\nfatal: Could not read from remote repository.\n\nPlease make sure you have the correct access rights\nand the repository exists.\nkoshiba@koshiba hello-git % git remote show main\n* remote main\n  Fetch URL: git@github.com.outlook:ikoshiba/hello-git.git\n  Push  URL: git@github.com.outlook:ikoshiba/hello-git.git\n  HEAD branch: master\n  Remote branch:\n    master tracked\n  Local branch configured for 'git pull':\n    master merges with remote master\n  Local ref configured for 'git push':\n    master pushes to master (up to date)\nkoshiba@koshiba hello-git % git reflog main/master\nbe33e38 (HEAD -&gt; master, main/master) refs/remotes/main/master@{0}: remote: renamed refs/remotes/origin/master to refs/remotes/main/master\nbe33e38 (HEAD -&gt; master, main/master) refs/remotes/main/master@{1}: update by push\nad50bf4 refs/remotes/main/master@{2}: fetch: fast-forward\nedf13a1 refs/remotes/main/master@{3}: fetch: fast-forward\nb0c4efa (remote) refs/remotes/main/master@{4}: update by push\nde2bb32 refs/remotes/main/master@{5}: fetch: fast-forward\na343286 refs/remotes/main/master@{6}: update by push\neeeea6f refs/remotes/main/master@{7}: pull: fast-forward\n2464feb refs/remotes/main/master@{8}: update by push\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#remove","title":"remove","text":"<p>\u4f7f\u7528 <code>git remote remove &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u522b\u540d&gt;</code> \u6765\u89e3\u9664\u672c\u5730\u4ed3\u5e93\u4e0e\u8fdc\u7a0b\u4ed3\u5e93\u7684\u5173\u8054\u3002<code>remove</code> \u4e5f\u53ef\u4ee5\u7b80\u5199\u4e3a <code>rm</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git remote remove main\nkoshiba@koshiba hello-git % git remote\nkoshiba@koshiba hello-git % git branch -r\nkoshiba@koshiba hello-git % git reflog main/master\nfatal: ambiguous argument 'main/master': unknown revision or path not in the working tree.\nUse '--' to separate paths from revisions, like this:\n'git &lt;command&gt; [&lt;revision&gt;...] -- [&lt;file&gt;...]'\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-clone","title":"git clone","text":"<p>\u4f7f\u7528 <code>git clone</code> \u547d\u4ee4\u5c06\u8fdc\u7a0b\u4ed3\u5e93\u514b\u9686\u5230\u5f53\u524d\u672c\u5730\u76ee\u5f55\u4e0b\u3002\u53ef\u4ee5\u770b\u5230\u8be5\u547d\u4ee4\u5c06\u8fdc\u7a0b\u4ed3\u5e93\u62c9\u53d6\u5230\u5f53\u524d\u8def\u5f84\u4e0b (\u5373\u76f8\u5f53\u4e8e\u4e0b\u8f7d\u4e86 hello-git) \uff0c\u5e76\u4e14\u5b8c\u6210\u4e86 <code>git init</code> \u7ba1\u7406\u5df2\u7ecf\u4e0b\u8f7d\u5230\u672c\u5730\u7684 <code>hello-git</code> (\u6709 <code>.git</code> \u9690\u85cf\u6587\u4ef6\u5939)\uff0c\u4e5f\u5b8c\u6210\u4e86 <code>git remote add</code> \u5173\u8054\uff0c\u5e76\u4e14\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u7684\u522b\u540d\u4e5f\u5df2\u81ea\u52a8\u8bbe\u7f6e\u4e3a <code>origin</code> \u3002</p> <pre><code>koshiba@koshiba git % git clone https://github.com/ikoshiba/hello-git.git\nCloning into 'hello-git'...\nremote: Enumerating objects: 57, done.\nremote: Counting objects: 100% (57/57), done.\nremote: Compressing objects: 100% (32/32), done.\nremote: Total 57 (delta 5), reused 57 (delta 5), pack-reused 0\nReceiving objects: 100% (57/57), 5.02 KiB | 733.00 KiB/s, done.\nResolving deltas: 100% (5/5), done.\nkoshiba@koshiba git % cd hello-git\nkoshiba@koshiba hello-git % ls -la\ntotal 24\ndrwxr-xr-x@  5 koshiba  staff   160 Sep 27 05:53 .\ndrwxr-xr-x@ 10 koshiba  staff   320 Sep 27 05:53 ..\n-rw-r--r--   1 koshiba  staff  6148 Sep 27 05:53 .DS_Store\ndrwxr-xr-x@ 12 koshiba  staff   384 Sep 27 05:53 .git\n-rw-r--r--   1 koshiba  staff    31 Sep 27 05:53 hello.txt\nkoshiba@koshiba hello-git % git remote -v\norigin  https://github.com/ikoshiba/hello-git.git (fetch)\norigin  https://github.com/ikoshiba/hello-git.git (push)\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-push","title":"git push","text":"<p>\u6267\u884c <code>git push &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt; &lt;\u672c\u5730\u5206\u652f\u540d&gt;:&lt;\u8fdc\u7a0b\u5206\u652f\u540d&gt;</code> \u63a8\u9001\u5f53\u524d\u4ed3\u5e93\u5230\u8fdc\u7a0b\u5e93\u3002</p> <ul> <li>\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u5728 <code>git remote add</code> \u547d\u4ee4\u4e2d\u5df2\u7ecf\u8bbe\u7f6e\u4e86 <code>origin</code> \u522b\u540d\uff0c\u56e0\u6b64\u53ef\u4ee5\u586b\u5165 <code>origin</code> \u3002</li> <li>\u5f53\u300c\u672c\u5730\u5206\u652f\u540d\u300d\u4e0e\u300c\u8fdc\u7a0b\u5206\u652f\u540d\u300d\u76f8\u540c\u65f6\uff0c\u672c\u4f8b\u4e2d\u4e3a <code>master</code> \uff0c\u53ef\u4ee5\u5199\u4e3a <code>git push origin master</code> \u3002</li> <li>\u5728\u7b2c\u4e00\u6b21\u63a8\u9001\u65f6\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 <code>-u</code> \u53c2\u6570\u6307\u5b9a\u4e86\u672c\u5730\u5206\u652f\u5230\u6307\u5b9a\u8fdc\u7a0b\u5206\u652f\u7684\u901a\u9053 (master -&gt; master) \u3002\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u6267\u884c <code>git push</code> \uff0c\u6548\u679c\u7b49\u540c\u5982\u4e0b\u3002</li> </ul> <pre><code>git push git@github.com.outlook:ikoshiba/hello-git.git master:master\n</code></pre> <p>\u5982\u679c\u672c\u5730\u4ed3\u5e93\u5f53\u524d\u5206\u652f\u6bd4\u8fdc\u7a0b\u5206\u652f\u8981\u843d\u540e\uff0c\u4f8b\u5982\u8fdc\u7a0b\u5206\u652f\u4e0a\u7684\u6587\u4ef6\u6709\u66f4\u65b0\uff0c\u672c\u5730\u5728\u5c1a\u672a\u62c9\u53d6\u5408\u5e76\u8be5\u66f4\u65b0\u7684\u60c5\u51b5\u4e0b\u5c1d\u8bd5\u63a8\u9001\u672c\u5730\u7684\u65b0\u63d0\u4ea4\uff0c\u5219\u4f1a\u51fa\u73b0\u5931\u8d25\uff0c\u5982\u4e0b\u3002\u53ef\u4ee5\u4f7f\u7528 <code>git pull</code> \u5148\u884c\u62c9\u53d6\u5408\u5e76\uff0c\u6216\u8005\u6267\u884c <code>git merger &lt;\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740&gt;/&lt;\u8fdc\u7a0b\u5206\u652f&gt;</code> \u6765\u5c06\u300c\u672c\u5730\u7684\u8fdc\u7a0b\u5206\u652f\u300d\u5408\u5e76\u5230\u672c\u5730\u5f53\u524d\u5206\u652f\u3002</p> <pre><code>To github.com.outlook:ikoshiba/hello-git.git\n ! [rejected]        master -&gt; master (non-fast-forward)\nerror: failed to push some refs to 'github.com.outlook:ikoshiba/hello-git.git'\nhint: Updates were rejected because the tip of your current branch is behind\nhint: its remote counterpart. Integrate the remote changes (e.g.\nhint: 'git pull ...') before pushing again.\nhint: See the 'Note about fast-forwards' in 'git push --help' for details.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u5982\u679c\u672c\u5730\u548c\u8fdc\u7a0b\u5206\u652f\u662f\u540c\u4e00\u4e2a\u7248\u672c\uff0c\u5373\u65e0\u66f4\u65b0\uff0c\u5219\u63a8\u9001\u540e\u663e\u793a <code>Everything up-to-date</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git push\nEverything up-to-date\n</code></pre> <p>\u82e5\u6709\u66f4\u65b0\uff0c\u4e14\u6b63\u5e38\u63a8\u9001\uff0c\u5219\u663e\u793a\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba hello-git % git push\nEnumerating objects: 5, done.\nCounting objects: 100% (5/5), done.\nDelta compression using up to 8 threads\nCompressing objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 312 bytes | 312.00 KiB/s, done.\nTotal 3 (delta 0), reused 0 (delta 0), pack-reused 0\nTo github.com.outlook:ikoshiba/hello-git.git\n   eeeea6f..a343286  master -&gt; master\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-fetch","title":"git fetch","text":"<p>\u5c06\u8fdc\u7a0b\u5e93\u5f53\u524d\u7248\u672c\u62c9\u53d6\u5230\u672c\u5730\uff0c\u4f46\u4e0d\u5408\u5e76 (<code>git merge</code>) \u3002\u82e5\u672c\u5730\u5206\u652f\u4e0e\u8fdc\u7a0b\u5206\u652f\u7248\u672c\u76f8\u540c\uff0c\u5219\u65e0\u56de\u663e\uff0c\u82e5\u4e0d\u540c\uff0c\u5219\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba hello-git % git fetch\nremote: Enumerating objects: 5, done.\nremote: Counting objects: 100% (5/5), done.\nremote: Compressing objects: 100% (3/3), done.\nremote: Total 3 (delta 1), reused 0 (delta 0), pack-reused 0\nUnpacking objects: 100% (3/3), 683 bytes | 170.00 KiB/s, done.\nFrom github.com.outlook:ikoshiba/hello-git\n   edf13a1..ad50bf4  master     -&gt; origin/master\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u53ef\u901a\u8fc7 <code>git log origin/master</code> \u6216 <code>git reflog origin/master</code> \u67e5\u770b\u672c\u5730\u7684\u8fdc\u7a0b\u5206\u652f\u63d0\u4ea4\u5386\u53f2\u6765\u786e\u8ba4\u786e\u5b9e\u62c9\u53d6\u4e86\u8fdc\u7a0b\u5206\u652f\u5f53\u524d\u7248\u672c\u3002</p> <pre><code>koshiba@koshiba hello-git % git reflog origin/master\nad50bf4 (origin/master) refs/remotes/origin/master@{0}: fetch: fast-forward\nedf13a1 (HEAD -&gt; master) refs/remotes/origin/master@{1}: fetch: fast-forward\nb0c4efa (remote) refs/remotes/origin/master@{2}: update by push\nde2bb32 refs/remotes/origin/master@{3}: fetch: fast-forward\na343286 refs/remotes/origin/master@{4}: update by push\neeeea6f refs/remotes/origin/master@{5}: pull: fast-forward\n2464feb refs/remotes/origin/master@{6}: update by push\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u53ef\u901a\u8fc7 <code>git branch -a</code> \u67e5\u770b\u672c\u5730\u548c\u8fdc\u7a0b\u5206\u652f\uff0c\u6216\u8005\u901a\u8fc7 <code>git branch -r</code> \u67e5\u770b\u8fdc\u7a0b\u5206\u652f\u3002</p> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-merge_1","title":"git merge","text":"<p><code>git fetch</code> \u4e4b\u540e\u8981\u901a\u8fc7 <code>git merge</code> \u5c06\u8fdc\u7a0b\u5206\u652f\u5408\u5e76\u5230\u672c\u5730\u5206\u652f\uff0c\u76f8\u5f53\u4e8e <code>git merge origin/master</code> \u3002\u4ece\u56de\u663e\u4e2d\u8fd8\u80fd\u770b\u5230\u8fd9\u662f\u4e00\u6b21\u300c\u5feb\u8fdb\u300d (Fast-forward) \u5408\u5e76\u3002</p> <pre><code>koshiba@koshiba hello-git % git merge\nUpdating b0c4efa..edf13a1\nFast-forward\n hello.txt | 1 +\n 1 file changed, 1 insertion(+)\nkoshiba@koshiba hello-git %\n</code></pre> <p></p>","tags":["git","version control","distributed version control"]},{"location":"misc/git-from-zero-to-hero/#git-pull","title":"git pull","text":"<p>\u5c06\u8fdc\u7a0b\u5e93\u5f53\u524d\u7248\u672c\u62c9\u53d6\u5230\u672c\u5730\u5e76\u5408\u5e76 (<code>git merge</code>) \u3002\u683c\u5f0f\u5982\u4e0b\u3002</p> <pre><code>git pull &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u8fdc\u7a0b\u5206\u652f\u540d&gt;:&lt;\u672c\u5730\u5206\u652f\u540d&gt;\n</code></pre> <p>\u82e5\u8fdc\u7a0b\u5206\u652f\u540d\u4e0e\u672c\u5730\u5206\u652f\u540d\u76f8\u540c\uff0c\u53ef\u7b80\u5199\u5982\u4e0b\u3002</p> <pre><code>git pull &lt;\u8fdc\u7a0b\u4ed3\u5e93\u522b\u540d&gt; &lt;\u5206\u652f\u540d&gt;\n</code></pre> <p>\u82e5\u5df2\u7ecf\u914d\u7f6e\u8fc7 upstream \uff0c\u53ef\u7b80\u5199\u5982\u4e0b\u3002</p> <pre><code>git pull\n</code></pre> <p>\u82e5\u7248\u672c\u76f8\u540c\uff0c\u5219\u663e\u793a <code>Already up to date.</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git pull\nAlready up to date.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u82e5\u6709\u51b2\u7a81\uff0c\u5219\u663e\u793a\u5982\u4e0b\u3002\u6b64\u65f6\u9700\u8981\u5148\u89e3\u51b3\u51b2\u7a81\uff0c\u63a5\u7740 <code>git add</code>, <code>git commit</code> \uff0c\u7136\u540e\u518d <code>git pull</code> \u3002</p> <pre><code>koshiba@koshiba hello-git % git pull\nerror: Pulling is not possible because you have unmerged files.\nhint: Fix them up in the work tree, and then use 'git add/rm &lt;file&gt;'\nhint: as appropriate to mark resolution and make a commit.\nfatal: Exiting because of an unresolved conflict.\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u82e5\u62c9\u53d6\u540e\u53ef\u6b63\u5e38\u5408\u5e76\uff0c\u5219\u663e\u793a\u5982\u4e0b\u3002</p> <pre><code>koshiba@koshiba hello-git % git pull\nremote: Enumerating objects: 5, done.\nremote: Counting objects: 100% (5/5), done.\nremote: Compressing objects: 100% (2/2), done.\nremote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0\nUnpacking objects: 100% (3/3), 686 bytes | 171.00 KiB/s, done.\nFrom github.com.outlook:ikoshiba/hello-git\n   2464feb..eeeea6f  master     -&gt; origin/master\nUpdating 2464feb..eeeea6f\nFast-forward\n hello.txt | 1 +\n 1 file changed, 1 insertion(+)\nkoshiba@koshiba hello-git %\n</code></pre> <p>\u4f7f\u7528 <code>git fetch</code> \u662f\u66f4\u597d\u7684\u5b9e\u8df5 (\u53c2\u8003) \u3002</p>","tags":["git","version control","distributed version control"]},{"location":"misc/gitlab-ci-configuration/","title":"gitlab-ci.yml \u8be6\u89e3","text":"<p>\u672c\u6587\u5bf9 GitLab CI \u6d41\u6c34\u7ebf\u914d\u7f6e\u6587\u4ef6 <code>.gitlab-ci.yml</code> \u8fdb\u884c\u8be6\u7ec6\u7684\u4ecb\u7ecd\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#gitlab-ci","title":"GitLab CI\u4ecb\u7ecd","text":"<ul> <li>GitLab\u63d0\u4ea4\u6301\u7eed\u96c6\u6210\u670d\u52a1\uff0c\u5f53\u4f60\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e2d\u6dfb\u52a0 <code>.gitlab-ci.yml</code> \u6587\u4ef6\uff0c\u5e76\u914d\u7f6e\u9879\u76ee\u7684\u8fd0\u884c\u5668( <code>GitLab Runner</code> )\uff0c\u90a3\u4e48\u540e\u7eed\u7684\u6bcf\u6b21\u63d0\u4ea4\u90fd\u4f1a\u89e6\u53d1CI\u6d41\u6c34\u7ebf( <code>pipeline</code> )\u7684\u6267\u884c\u3002</li> <li><code>.gitlab-ci.yml</code> \u6587\u4ef6\u544a\u8bc9\u8fd0\u884c\u5668\u9700\u8981\u505a\u54ea\u4e9b\u4e8b\u60c5\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6d41\u6c34\u7ebf\u6709 <code>build</code> \u3001<code>test</code> \u3001<code>deploy</code> \u4e09\u4e2a\u9636\u6bb5\uff0c\u5373 <code>\u6784\u5efa</code> \u3001<code>\u6d4b\u8bd5</code> \u3001<code>\u90e8\u7f72</code> \uff0c\u672a\u88ab\u4f7f\u7528\u7684\u9636\u6bb5\u5c06\u4f1a\u88ab\u81ea\u52a8\u5ffd\u7565\u3002</li> <li>\u5982\u679c\u4e00\u5207\u8fd0\u884c\u6b63\u5e38\uff08\u6ca1\u6709\u975e\u96f6\u8fd4\u56de\u503c\uff09\uff0c\u60a8\u5c06\u83b7\u5f97\u4e0e\u63d0\u4ea4\u76f8\u5173\u8054\u7684\u6f02\u4eae\u7eff\u8272\u590d\u9009\u6807\u8bb0(\u5982\u4e0b\u56fe\u6240\u793a)\u3002\u8fd9\u6837\u53ef\u4ee5\u5728\u67e5\u770b\u4ee3\u7801\u4e4b\u524d\u8f7b\u677e\u67e5\u770b\u63d0\u4ea4\u662f\u5426\u5bfc\u81f4\u4efb\u4f55\u6d4b\u8bd5\u5931\u8d25\u3002</li> </ul> <ul> <li>\u5927\u591a\u6570\u9879\u76ee\u4f7f\u7528GitLab\u7684CI\u670d\u52a1\u6765\u8fd0\u884c\u6d4b\u8bd5\u5957\u4ef6\uff0c\u4ee5\u4fbf\u5f00\u53d1\u4eba\u5458\u5728\u7834\u574f\u67d0\u4e9b\u5185\u5bb9\u65f6\u53ef\u4ee5\u7acb\u5373\u83b7\u5f97\u53cd\u9988\u3002\u4f7f\u7528\u6301\u7eed\u4ea4\u4ed8\u548c\u6301\u7eed\u90e8\u7f72\u5c06\u6d4b\u8bd5\u4ee3\u7801\u81ea\u52a8\u90e8\u7f72\u5230\u6a21\u62df\u73af\u5883\u548c\u751f\u4ea7\u73af\u5883\u7684\u8d8b\u52bf\u8d8a\u6765\u8d8a\u660e\u663e\u3002</li> <li>\u7531\u4e8e\u5c06 <code>.gitlab-ci.yml</code> \u6587\u4ef6\u5b58\u653e\u5728\u4ed3\u5e93\u4e2d\u8fdb\u884c\u7248\u672c\u63a7\u5236\uff0c\u4f7f\u7528\u5355\u4e00\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u63a7\u5236\u6d41\u6c34\u7ebf\uff0c\u5177\u6709\u8bfb\u8bbf\u95ee\u6743\u9650\u7684\u6bcf\u4e2a\u4eba\u90fd\u53ef\u4ee5\u67e5\u770b\u5185\u5bb9\uff0c\u4ece\u800c\u4f7f\u5176\u66f4\u6709\u5438\u5f15\u529b\u5730\u6539\u8fdb\u548c\u67e5\u770b\u6784\u5efa\u811a\u672c\u3002\u65e7\u7684\u7248\u672c\u4e5f\u80fd\u6784\u5efa\u6210\u529f\uff0cforks\u9879\u76ee\u4e5f\u5bb9\u6613\u4f7f\u7528CI\uff0c\u5206\u652f\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u6d41\u6c34\u7ebf\u548c\u4f5c\u4e1a\u3002</li> <li><code>.gitlab-ci.yml</code> \u5b9a\u4e49\u6bcf\u4e2a\u9879\u76ee\u7684\u6d41\u6c34\u7ebf\u7684\u7ed3\u6784\u548c\u987a\u5e8f\uff0c\u7531\u4ee5\u4e0b\u4e24\u4e2a\u56e0\u7d20\u51b3\u5b9a\uff1a</li> </ul> <ul> <li>Gitlab Runner \u8fd0\u884c\u5668\u4f7f\u7528\u7684\u6267\u884c\u5668( <code>executor</code> )\uff0c\u6267\u884c\u5668\u5e38\u7528\u7684 <code>Shell</code> \u3001 <code>Docker</code> \u3001<code>Kubernets</code> \uff0c \u6211\u4eec\u5f53\u524d\u4ec5\u4f7f\u7528 <code>Shell</code> \u6267\u884c\u5668\uff0c\u540e\u7eed\u518d\u4f7f\u7528\u5176\u4ed6\u6267\u884c\u5668\u3002</li> <li>\u9047\u5230\u8fdb\u7a0b\u6210\u529f\u6216\u5931\u8d25\u65f6\u7b49\u6761\u4ef6\u65f6\u505a\u51fa\u7684\u51b3\u5b9a\u3002</li> </ul> <ul> <li>\u53ef\u4ee5\u5728 Getting started with GitLab CI/CD \u67e5\u770b\u5230\u6d41\u6c34\u7ebf\u7684\u7b80\u5355\u793a\u4f8b\u3002</li> <li>\u53ef\u4ee5\u5728 GitLab CI/CD Examples \u67e5\u770b\u66f4\u591a\u7684\u6d41\u6c34\u7ebf\u793a\u4f8b\u3002</li> <li>\u5728\u6d41\u6c34\u7ebf\u811a\u672c\u4e2d\u53ef\u4ee5\u4f7f\u7528\u9884\u5b9a\u4e49\u7684\u5168\u5c40\u53d8\u91cf\uff0c\u8be6\u7ec6\u53ef\u67e5\u770b GitLab CI/CD Variables \u3002</li> <li>\u4f01\u4e1a\u7ea7\u7684 <code>.gitlab-ci.yml</code> \u793a\u4f8b\u53ef\u67e5\u770b https://gitlab.com/gitlab-org/gitlab-ce/blob/master/.gitlab-ci.yml \u3002</li> <li>Job\u4f5c\u4e1a\u662f <code>.gitlab-ci.yml</code> \u6587\u4ef6\u7684\u57fa\u672c\u5143\u7d20\uff0c\u6bcf\u4e2a\u4f5c\u4e1a\u81f3\u5c11\u6709 <code>script</code> \u5b50\u53e5\uff0c\u5728\u6d41\u6c34\u7ebf\u4e2d\u53ef\u4ee5\u5b9a\u4e49\u4efb\u610f\u591a\u4e2a\u4f5c\u4e1a\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u5fc5\u987b\u5177\u6709\u552f\u4e00\u7684\u540d\u79f0\uff0c\u4f46\u6709\u4e00\u4e9b\u4fdd\u7559\u7684\u5173\u952e\u5b57\u4e0d\u80fd\u7528\u4f5c\u4f5c\u4e1a\u540d\u79f0\uff0c\u4fdd\u7559\u5173\u952e\u5b57( <code>reserved keywords</code> )\u6709 <code>image</code> \u3001 <code>services</code> \u3001 <code>stages</code> \u3001 <code>types</code> \u3001 <code>before_script</code> \u3001 <code>after_script</code> \u3001 <code>variables</code> \u3001 <code>cache</code> \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#gitlab-ciyml_1","title":"<code>.gitlab-ci.yml</code> \u914d\u7f6e\u53c2\u6570","text":"\u5173\u952e\u5b57 \u63cf\u8ff0 script \u5fc5\u987b\u53c2\u6570\uff0c\u8fd0\u884c\u5668\u9700\u8981\u6267\u884c\u7684\u811a\u672c image \u4f7f\u7528Docker image\u955c\u50cf services \u4f7f\u7528Docker services\u955c\u50cf before_script \u4f5c\u4e1a\u6267\u884c\u524d\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4 after_script \u4f5c\u4e1a\u6267\u884c\u540e\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4 stages \u5b9a\u4e49\u6d41\u6c34\u7ebf\u6240\u6709\u7684\u9636\u6bb5 stage \u5b9a\u4e49\u4f5c\u4e1a\u6240\u5904\u6d41\u6c34\u7ebf\u7684\u9636\u6bb5(\u9ed8\u8ba4test\u9636\u6bb5) only \u9650\u5236\u4f5c\u4e1a\u5728\u4ec0\u4e48\u65f6\u5019\u521b\u5efa except \u9650\u5236\u4f5c\u4e1a\u5728\u4ec0\u4e48\u65f6\u5019\u4e0d\u521b\u5efa tags \u4f5c\u7528\u4f7f\u7528\u7684Runner\u8fd0\u884c\u5668\u7684\u6807\u7b7e\u5217\u8868 allow_failure \u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\uff0c\u5931\u8d25\u7684\u4f5c\u4e1a\u4e0d\u5f71\u54cd\u63d0\u4ea4\u7684\u72b6\u6001 when \u4ec0\u4e48\u65f6\u5019\u8fd0\u884c\u4f5c\u4e1a environment \u4f5c\u7528\u90e8\u7f72\u7684\u73af\u5883\u540d\u79f0 cache \u6307\u5b9a\u9700\u8981\u5728job\u4e4b\u95f4\u7f13\u5b58\u7684\u6587\u4ef6\u6216\u76ee\u5f55 artifacts \u5f52\u6863\u6587\u4ef6\u5217\u8868\uff0c\u6307\u5b9a\u6210\u529f\u540e\u5e94\u9644\u52a0\u5230job\u7684\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u5217\u8868 dependencies \u5f53\u524d\u4f5c\u4e1a\u4f9d\u8d56\u7684\u5176\u4ed6\u4f5c\u4e1a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4f9d\u8d56\u4f5c\u4e1a\u7684\u5f52\u6863\u6587\u4ef6 coverage \u4f5c\u4e1a\u7684\u4ee3\u7801\u8986\u76d6\u7387 retry \u4f5c\u4e1a\u5931\u8d25\u65f6\uff0c\u53ef\u4ee5\u81ea\u52a8\u6267\u884c\u591a\u5c11\u6b21 parallel \u6307\u5b9a\u5e76\u884c\u8fd0\u884c\u7684\u4f5c\u4e1a\u5b9e\u4f8b trigger \u5b9a\u4e49\u4e0b\u6e38\u6d41\u6c34\u7ebf\u7684\u89e6\u53d1\u5668 include \u4f5c\u4e1a\u52a0\u8f7d\u5176\u4ed6YAML\u6587\u4ef6 extends \u63a7\u5236\u5b9e\u4f53\u4ece\u54ea\u91cc\u7ee7\u627f pages \u4e0a\u4f20GitLab Pages\u7684\u7ed3\u679c retry \u4f5c\u4e1a\u5931\u8d25\u65f6\uff0c\u53ef\u4ee5\u81ea\u52a8\u6267\u884c\u591a\u5c11\u6b21 variables \u5b9a\u4e49\u73af\u5883\u53d8\u91cf","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_1","title":"\u53c2\u6570\u8be6\u89e3","text":"","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#script","title":"<code>script</code>","text":"<p><code>script</code> \u662f\u4f5c\u4e1a\u4e2d\u552f\u4e00\u5fc5\u987b\u7684\u5173\u952e\u5b57\u53c2\u6570\uff0c\u662f\u8fd0\u884c\u5668\u9700\u8981\u6267\u884c\u7684\u811a\u672c\uff0c\u5982:</p> <pre><code>build1:\n  script:\n    - echo \"Do your build here\"\n    - uname -a\n</code></pre> <p>\u8868\u793a <code>build1</code> \u4f5c\u4e1a\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4\u662f\u8f93\u51fa <code>Do your build here</code>\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#image","title":"<code>image</code>","text":"<p><code>image</code> \u6307\u5b9a\u4f7f\u7528Docker\u955c\u50cf\u3002\u5982 <code>image:name</code> \uff0c\u6682\u65f6\u5ffd\u7565\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#services","title":"<code>services</code>","text":"<p><code>services</code> \u6307\u5b9a\u4f7f\u7528Docker\u955c\u50cf\u670d\u52a1\u3002\u5982 <code>services:name</code> \uff0c\u6682\u65f6\u5ffd\u7565\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#before_script","title":"<code>before_script</code>","text":"<p><code>before_script</code> \u7528\u4e8e\u5b9a\u4e49\u5728\u6240\u6709\u4f5c\u4e1a\u4e4b\u524d\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4\uff0c\u6bd4\u5982\u66f4\u65b0\u4ee3\u7801\u3001\u5b89\u88c5\u4f9d\u8d56\u3001\u6253\u5370\u8c03\u8bd5\u4fe1\u606f\u4e4b\u7c7b\u7684\u4e8b\u60c5\u3002</p> <p>\u793a\u4f8b:</p> <pre><code>before_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#after_script","title":"<code>after_script</code>","text":"<p><code>after_script</code> \u7528\u4e8e\u5b9a\u4e49\u5728\u6240\u6709\u4f5c\u4e1a(\u5373\u4f7f\u5931\u8d25)\u4e4b\u540e\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4\uff0c\u6bd4\u5982\u6e05\u7a7a\u5de5\u4f5c\u7a7a\u95f4\u3002</p> <p>\u793a\u4f8b:</p> <pre><code>after_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n</code></pre> <p>\u91cd\u8981\u8bf4\u660e\uff1a</p> <ul> <li><code>before_script</code> \u548c <code>script</code> \u5728\u4e00\u4e2a\u4e0a\u4e0b\u6587\u4e2d\u662f\u4e32\u884c\u6267\u884c\u7684\uff0c<code>after_script</code> \u662f\u72ec\u7acb\u6267\u884c\u7684\uff0c\u5373 <code>after_script</code> \u4e0e <code>before_script/script</code> \u7684\u4e0a\u4e0b\u6587\u73af\u5883\u4e0d\u540c\u3002</li> <li><code>after_script</code> \u4f1a\u5c06\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u503c\u3002</li> <li>\u7531\u4e8e <code>after_script</code> \u662f\u5206\u79bb\u7684\u4e0a\u4e0b\u6587\uff0c\u5728 <code>after_script</code> \u4e2d\u65e0\u6cd5\u770b\u5230\u5728 <code>before_script</code>\u548c <code>script</code> \u4e2d\u6240\u505a\u7684\u4fee\u6539:</li> <li>\u5728 <code>before_script</code> \u548c <code>script</code> \u4e2d\u7684\u547d\u540d\u522b\u540d\u3001\u5bfc\u51fa\u53d8\u91cf\uff0c\u5bf9 <code>after_script</code> \u4e0d\u53ef\u89c1\uff1b</li> <li><code>before_script</code>\u548c <code>script</code> \u5728\u5de5\u4f5c\u6811\u4e4b\u5916\u5b89\u88c5\u7684\u8f6f\u4ef6\uff0c\u5bf9 <code>after_script</code> \u4e0d\u53ef\u89c1\u3002</li> <li>\u4f60\u53ef\u4ee5\u5728\u4f5c\u4e1a\u4e2d\u5b9a\u4e49 <code>before_script</code>\uff0c <code>after_script</code> \uff0c\u4e5f\u53ef\u4ee5\u5c06\u5176\u5b9a\u4e49\u4e3a\u9876\u7ea7\u5143\u7d20\uff0c\u5b9a\u4e49\u4e3a\u9876\u7ea7\u5143\u7d20\u5c06\u4e3a\u6bcf\u4e00\u4e2a\u4efb\u52a1\u90fd\u6267\u884c\u76f8\u5e94\u9636\u6bb5\u7684\u811a\u672c\u6216\u547d\u4ee4\u3002\u4f5c\u4e1a\u7ea7\u4f1a\u8986\u76d6\u5168\u5c40\u7ea7\u7684\u5b9a\u4e49\u3002</li> </ul> <p>\u793a\u4f8b:</p> <pre><code>before_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    - cloc .\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    - cloc .\n  tags:\n    - bluelog\n</code></pre> <p>\u5c06\u4fee\u6539\u4e0a\u4f20\u63d0\u4ea4\uff0c\u67e5\u770b\u4f5c\u4e1abuild1\u7684\u63a7\u5236\u53f0\u8f93\u51fa\uff1a</p> <p></p> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0 <code>build1</code> \u4f5c\u4e1a\u7684 <code>before_script</code> \u548c <code>after_script</code> \u5c06\u5168\u5c40\u7684 <code>before_script</code> \u548c <code>after_script</code> \u8986\u76d6\u4e86\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#stages","title":"<code>stages</code>","text":"<p><code>stages</code> \u5b9a\u4e49\u6d41\u6c34\u7ebf\u5168\u5c40\u53ef\u4f7f\u7528\u7684\u9636\u6bb5\uff0c\u9636\u6bb5\u5141\u8bb8\u6709\u7075\u6d3b\u7684\u591a\u7ea7\u7ba1\u9053\uff0c\u9636\u6bb5\u5143\u7d20\u7684\u6392\u5e8f\u5b9a\u4e49\u4e86\u4f5c\u4e1a\u6267\u884c\u7684\u987a\u5e8f\u3002</p> <ul> <li>\u76f8\u540c <code>stage</code> \u9636\u6bb5\u7684\u4f5c\u4e1a\u5e76\u884c\u8fd0\u884c\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0a\u4e00\u9636\u6bb5\u7684\u4f5c\u4e1a\u5168\u90e8\u8fd0\u884c\u6210\u529f\u540e\u624d\u6267\u884c\u4e0b\u4e00\u9636\u6bb5\u7684\u4f5c\u4e1a\u3002</li> <li>\u9ed8\u8ba4\u6709\u4e09\u4e2a\u9636\u6bb5\uff0c <code>build</code> \u3001<code>test</code> \u3001<code>deploy</code> \u4e09\u4e2a\u9636\u6bb5\uff0c\u5373 <code>\u6784\u5efa</code> \u3001<code>\u6d4b\u8bd5</code> \u3001<code>\u90e8\u7f72</code> \u3002</li> <li>\u5982\u679c\u4e00\u4e2a\u4f5c\u4e1a\u672a\u5b9a\u4e49 <code>stage</code> \u9636\u6bb5\uff0c\u5219\u4f5c\u4e1a\u4f7f\u7528 <code>test</code> \u6d4b\u8bd5\u9636\u6bb5\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4efb\u4f55\u4e00\u4e2a\u524d\u7f6e\u7684\u4f5c\u4e1a\u5931\u8d25\u4e86\uff0ccommit\u63d0\u4ea4\u4f1a\u6807\u8bb0\u4e3afailed\u5e76\u4e14\u4e0b\u4e00\u4e2astages\u7684\u4f5c\u4e1a\u90fd\u4e0d\u4f1a\u6267\u884c\u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#stage","title":"<code>stage</code>","text":"<p><code>stage</code> \u5b9a\u4e49\u6d41\u6c34\u7ebf\u4e2d\u6bcf\u4e2a\u4f5c\u4e1a\u6240\u5904\u7684\u9636\u6bb5\uff0c\u5904\u4e8e\u76f8\u540c\u9636\u6bb5\u7684\u4f5c\u4e1a\u5e76\u884c\u6267\u884c\u3002</p> <p>\u793a\u4f8b:</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    - cloc .\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    - cloc .\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    - flake8 .\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  script:\n    - echo \"Do a test here\"\n    - echo \"For example run a test suite\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n</code></pre> <p>\u6211\u4eec\u589e\u52a0\u4e00\u4e2a <code>code_check</code> \u9636\u6bb5\uff0c\u8be5\u9636\u6bb5\u6709\u4e00\u4e2a\u4f5c\u4e1a <code>find Bugs</code> \uff0c\u8be5\u4f5c\u4e1a\u4e3b\u8981\u662f\u5148\u5b89\u88c5Flake8\uff0c\u7136\u540e\u4f7f\u7528Flake8\u5bf9Python\u4ee3\u7801\u8fdb\u884c\u89c4\u8303\u68c0\u67e5\u3002</p> <p></p> <p>\u7531\u4e8eFlake8\u68c0\u67e5\u5230\u4e86Python\u4ee3\u7801\u4e2d\u7684\u7f3a\u9677\uff0c\u5bfc\u81f4find Bugs\u4f5c\u4e1a\u5931\u8d25\uff01\u8fd9\u6837\u53ef\u4ee5\u63a7\u5236\u5f00\u53d1\u4eba\u5458\u63d0\u4ea4\u6709\u574f\u5473\u9053\u7684\u4ee3\u7801\u5230\u4ed3\u5e93\u4e2d\u3002</p> <p>\u53e6\u5916\uff0c\u5728\u4e0a\u4e00\u4e2a\u6d41\u6c34\u7ebf\u4e2d\uff0cTest\u9636\u6bb5\u7684\u4f5c\u4e1atest1\u548ctest2\u662f\u5e76\u884c\u6267\u884c\u7684\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u672c\u6b21(pipeline #7)\u6d41\u6c34\u7ebf\u7531\u4e8e\u5728\u4f5c\u4e1a <code>find Bugs</code> \u68c0\u67e5\u4e0d\u901a\u8fc7\uff0c\u5bfc\u81f4\u6574\u4e2a\u6d41\u6c34\u7ebf\u8fd0\u884c\u5931\u8d25\uff0c\u540e\u7eed\u7684\u4f5c\u4e1a\u4e0d\u4f1a\u6267\u884c\uff1a</p> <p></p> <p>Attention</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGitLab Runner\u8fd0\u884c\u5668\u6bcf\u6b21\u53ea\u6267\u884c\u4e00\u4e2a\u4f5c\u4e1a\uff0c\u53ea\u6709\u5f53\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\u4e4b\u4e00\u65f6\uff0c\u624d\u4f1a\u771f\u6b63\u7684\u5e76\u884c\u6267\u884c:</p> <ul> <li>\u4f5c\u4e1a\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u8fd0\u884c\u5668\u4e0a\uff1b</li> <li>\u4f60\u4fee\u6539\u4e86\u8fd0\u884c\u5668\u7684 <code>concurrent</code> \u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>concurrent = 1</code> \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#only-except","title":"<code>only</code> \u548c <code>except</code>","text":"<p><code>only</code> \u548c <code>except</code> \u7528\u4e8e\u5728\u521b\u5efa\u4f5c\u4e1a\u65f6\u5bf9\u4f5c\u4e1a\u7684\u9650\u5236\u7b56\u7565\u3002</p> <ul> <li><code>only</code> \u5b9a\u4e49\u4e86\u54ea\u4e9b\u5206\u652f\u6216\u6807\u7b7e(branches and tags)\u7684\u4f5c\u4e1a\u4f1a\u8fd0\u884c</li> <li><code>except</code> \u5b9a\u4e49\u4e86\u54ea\u4e9b\u5206\u652f\u6216\u6807\u7b7e(branches and tags)\u7684\u4f5c\u4e1a\u4e0d\u4f1a\u8fd0\u884c</li> </ul> <p>\u4e0b\u9762\u662f\u7b56\u7565\u89c4\u5219\uff1a</p> <ul> <li><code>only</code> \u548c <code>except</code> \u53ef\u540c\u65f6\u4f7f\u7528\uff0c\u5982\u679c\u5728\u4e00\u4e2a\u4f5c\u4e1a\u4e2d\u540c\u65f6\u5b9a\u4e49\u4e86 <code>only</code> \u548c <code>except</code> \uff0c\u5219\u540c\u65f6 <code>only</code> <code>except</code> \u8fdb\u884c\u8fc7\u6ee4(\u6ce8\u610f\uff0c\u4e0d\u662f\u5ffd\u7565 <code>except</code> \u6761\u4ef6) \u3002</li> <li><code>only</code> \u548c <code>except</code> \u53ef\u4ee5\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u3002</li> <li><code>only</code> \u548c <code>except</code> \u5141\u8bb8\u6307\u5b9a\u7528\u4e8e\u8fc7\u6ee4forks\u4f5c\u4e1a\u7684\u5b58\u50a8\u5e93\u8def\u5f84\u3002</li> <li><code>only</code> \u548c <code>except</code> \u4e2d\u53ef\u4ee5\u4f7f\u7528\u7279\u6b8a\u7684\u5173\u952e\u5b57\uff0c\u5982 <code>branches</code> \u3001 <code>tags</code> \u3001 <code>api</code> \u3001 <code>external</code> \u3001 <code>pipelines</code> \u3001 <code>pushes</code> \u3001 <code>schedules</code> \u3001 <code>triggers</code> \u3001 <code>web</code> \u3001 <code>merge_requests</code> \u3001 <code>chats</code> \u7b49\u3002</li> </ul> <p><code>only</code> \u548c <code>except</code> \u4e2d\u53ef\u4ee5\u4f7f\u7528\u7279\u6b8a\u7684\u5173\u952e\u5b57\uff1a</p> <p>\u5173\u952e\u5b57\u63cf\u8ff0\u91ca\u4e49branches\u5f53\u4e00\u4e2a\u5206\u652f\u88abpush\u4e0a\u6765tags\u5f53\u4e00\u4e2a\u6253\u4e86tag\u6807\u8bb0\u7684Release\u88ab\u63d0\u4ea4\u65f6api\u5f53\u4e00\u4e2apipline\u88ab\u7b2c\u4e8c\u4e2apiplines api\u6240\u89e6\u53d1\u8c03\u8d77(\u4e0d\u662f\u89e6\u53d1\u5668API)external\u5f53\u4f7f\u7528\u4e86GitLab\u4ee5\u5916\u7684\u5916\u90e8CI\u670d\u52a1\uff0c\u5982Jenkinspipelines\u9488\u5bf9\u591a\u9879\u76ee\u89e6\u53d1\u5668\u800c\u8a00\uff0c\u5f53\u4f7f\u7528CI_JOB_TOKEN\uff0c \u5e76\u4f7f\u7528gitlab\u6240\u63d0\u4f9b\u7684api\u521b\u5efa\u591a\u4e2apipelines\u7684\u65f6\u5019pushes\u5f53pipeline\u88ab\u7528\u6237\u7684git push\u64cd\u4f5c\u6240\u89e6\u53d1\u7684\u65f6\u5019schedules\u9488\u5bf9\u9884\u5b9a\u597d\u7684pipline\u8ba1\u5212\u800c\u8a00\uff08\u6bcf\u65e5\u6784\u5efa\u4e00\u7c7b\uff09triggers\u7528\u89e6\u53d1\u5668token\u521b\u5efapiplines\u7684\u65f6\u5019web\u5728GitLab WEB\u9875\u9762\u4e0aPipelines\u6807\u7b7e\u9875\u4e0b\uff0c\u6309\u4e0brun pipline\u7684\u65f6\u5019merge_requests\u5f53\u5408\u5e76\u8bf7\u6c42\u521b\u5efa\u6216\u66f4\u65b0\u7684\u65f6\u5019chats\u5f53\u4f7f\u7528GitLab ChatOps \u521b\u5efa\u4f5c\u4e1a\u7684\u65f6\u5019</p> <p>\u5728\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cjob\u5c06\u53ea\u4f1a\u8fd0\u884c\u4ee5 <code>issue-</code> \u5f00\u59cb\u7684refs(\u5206\u652f)\uff0c\u7136\u800cexcept\u4e2d\u6307\u5b9a\u5206\u652f\u4e0d\u80fd\u6267\u884c\uff0c\u6240\u4ee5\u8fd9\u4e2ajob\u5c06\u4e0d\u4f1a\u6267\u884c:</p> <pre><code>job:\n  # use regexp\n  only:\n    - /^issue-.*$/\n  # use special keyword\n  except:\n    - branches\n</code></pre> <p>\u5339\u914d\u6a21\u5f0f\u9ed8\u8ba4\u662f\u5927\u5c0f\u5199\u654f\u611f\u7684(case-sensitive)\uff0c\u4f7f\u7528 <code>i</code> \u6807\u5fd7\uff0c\u5982 <code>/pattern/i</code> \u53ef\u4ee5\u4f7f\u5339\u914d\u6a21\u5f0f\u5927\u5c0f\u5199\u4e0d\u654f\u611f:</p> <pre><code>job:\n  # use regexp\n  only:\n    - /^issue-.*$/i\n  # use special keyword\n  except:\n    - branches\n</code></pre> <p>\u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\uff0c\u4ec5\u5f53\u6307\u5b9a\u6807\u8bb0\u7684tags\u7684refs\u5f15\u7528\uff0c\u6216\u8005\u901a\u8fc7API\u89e6\u53d1\u5668\u7684\u6784\u5efa\u3001\u6216\u8005\u6d41\u6c34\u7ebf\u8ba1\u5212\u8c03\u5ea6\u7684\u6784\u5efa\u624d\u4f1a\u8fd0\u884c:</p> <pre><code>job:\n  # use special keywords\n  only:\n    - tags\n    - triggers\n    - schedules\n</code></pre> <p>\u4ed3\u5e93\u7684\u8def\u5f84(repository path)\u53ea\u80fd\u7528\u4e8e\u7236\u7ea7\u4ed3\u5e93\u6267\u884c\u4f5c\u4e1a\uff0c\u4e0d\u80fd\u7528\u4e8eforks:</p> <pre><code>job:\n  only:\n    - branches@gitlab-org/gitlab-ce\n  except:\n    - master@gitlab-org/gitlab-ce\n    - /^release/.*$/@gitlab-org/gitlab-ce\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5c06\u4f1a\u5728\u6240\u6709\u5206\u652f\u6267\u884c\uff0c\u4f46 \u4e0d\u4f1a\u5728 master\u4e3b\u5e72\u4ee5\u53ca\u4ee5release/\u5f00\u5934\u7684\u5206\u652f\u4e0a\u6267\u884c\u3002</p> <ul> <li>\u5f53\u4e00\u4e2a\u4f5c\u4e1a\u6ca1\u6709\u5b9a\u4e49 <code>only</code> \u89c4\u5219\u65f6\uff0c\u5176\u9ed8\u8ba4\u4e3a <code>only: ['branches', 'tags']</code> \u3002</li> <li>\u5982\u679c\u4e00\u4e2a\u4f5c\u4e1a\u6ca1\u6709\u5b9a\u4e49 <code>except</code> \u89c4\u5219\u65f6\uff0c\u5219\u9ed8\u8ba4 <code>except</code> \u89c4\u5219\u4e3a\u7a7a\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4e24\u4e2a\u4f8b\u5b50\u662f\u7b49\u4ef7\u7684:</p> <pre><code>job:\n  script: echo 'test'\n</code></pre> <p>\u8f6c\u6362\u540e:</p> <pre><code>job:\n  script: echo 'test'\n  only: ['branches', 'tags']\n</code></pre> <p>Attention</p> <p>\u5173\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u4f7f\u7528\u7684\u8bf4\u660e\uff1a</p> <ul> <li>\u56e0\u4e3a <code>@</code> \u7528\u4e8e\u8868\u793aref\u7684\u5b58\u50a8\u5e93\u8def\u5f84\u7684\u5f00\u5934\uff0c\u6240\u4ee5\u5728\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u5339\u914d\u5305\u542b <code>@</code> \u5b57\u7b26\u7684ref\u540d\u79f0\u9700\u8981\u4f7f\u7528\u5341\u516d\u8fdb\u5236\u5b57\u7b26\u4ee3\u7801 <code>\\x40</code> \u3002</li> <li>\u4ec5\u6807\u7b7e\u548c\u5206\u652f\u540d\u79f0\u624d\u80fd\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\uff0c\u4ed3\u5e93\u8def\u5f84\u6309\u5b57\u9762\u610f\u4e49\u5339\u914d\u3002</li> <li>\u5982\u679c\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u6807\u7b7e\u6216\u5206\u652f\u540d\u79f0\uff0c\u5219\u5339\u914d\u6a21\u5f0f\u7684\u6574\u4e2a\u5f15\u7528\u90e8\u5206\u90fd\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u3002</li> <li>\u6b63\u5219\u8868\u8fbe\u5f0f\u5fc5\u987b\u4ee5 <code>/</code> \u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u5373 <code>/regular expressions/</code> \uff0c\u56e0\u6b64\uff0c <code>issue-/.*/</code> \u4e0d\u4f1a\u5339\u914d\u4ee5 <code>issue-</code> \u5f00\u5934\u7684\u6807\u7b7e\u6216\u5206\u652f\u3002</li> <li>\u53ef\u4ee5\u5728\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u4f7f\u7528\u951a\u70b9 <code>^$</code> \uff0c\u7528\u6765\u5339\u914d\u5f00\u5934\u6216\u7ed3\u5c3e\uff0c\u5982 <code>/^issue-.*$/</code> \u4e0e <code>/^issue-/</code> \u7b49\u4ef7\uff0c \u4f46 <code>/issue/</code> \u5374\u53ef\u4ee5\u5339\u914d\u540d\u79f0\u4e3a <code>severe-issues</code> \u7684\u5206\u652f\uff0c\u6240\u4ee5\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u4f7f\u7528\u8981\u8c28\u614e\uff01</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#only-except_1","title":"<code>only</code> \u548c <code>except</code> \u9ad8\u7ea7\u7528\u6cd5","text":"<ul> <li><code>only</code> \u548c <code>except</code> \u652f\u6301\u9ad8\u7ea7\u7b56\u7565\uff0c<code>refs</code> \u3001 <code>variables</code> \u3001 <code>changes</code> \u3001 <code>kubernetes</code> \u56db\u4e2a\u5173\u952e\u5b57\u53ef\u4ee5\u4f7f\u7528\u3002</li> <li>\u5982\u679c\u540c\u65f6\u4f7f\u7528\u591a\u4e2a\u5173\u952e\u5b57\uff0c\u4e2d\u95f4\u7684\u903b\u8f91\u662f\u903b\u8f91\u4e0e<code>(AND)</code> \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#onlyrefsexceptrefs","title":"<code>only:refs/except:refs</code>","text":"<ul> <li><code>refs</code> \u7b56\u7565\u53ef\u4ee5\u4f7f\u7528 <code>only</code> \u548c <code>except</code> \u57fa\u672c\u7528\u6cd5\u4e2d\u7684\u5173\u952e\u5b57\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cdeploy\u4f5c\u4e1a\u4ec5\u5f53\u6d41\u6c34\u7ebf\u662f\u8ba1\u5212\u4f5c\u4e1a\u6216\u8005\u5728master\u4e3b\u5e72\u8fd0\u884c:</p> <pre><code>deploy:\n  only:\n    refs:\n      - master\n      - schedules\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#onlykubernetesexceptkubernetes","title":"<code>only:kubernetes/except:kubernetes</code>","text":"<ul> <li><code>kubernetes</code> \u7b56\u7565\u4ec5\u652f\u6301 <code>active</code> \u5173\u952e\u5b57\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cdeploy\u4f5c\u4e1a\u4ec5\u5f53kubernetes\u670d\u52a1\u542f\u52a8\u540e\u624d\u4f1a\u8fd0\u884c:</p> <pre><code>deploy:\n  only:\n    kubernetes: active\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#onlyvariablesexceptvariables","title":"<code>only:variables/except:variables</code>","text":"<ul> <li><code>variables</code> \u5173\u952e\u5b57\u7528\u6765\u5b9a\u4e49\u53d8\u91cf\u8868\u8fbe\u5f0f\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u9884\u5b9a\u4e49\u53d8\u91cf\u3001\u9879\u76ee\u3001\u7ec4\u3001\u73af\u5883\u53d8\u91cf\u6765\u8bc4\u4f30\u4e00\u4e2a\u4f5c\u4e1a\u662f\u5426\u9700\u8981\u521b\u5efa\u6216\u8fd0\u884c\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4f7f\u7528\u4e86\u53d8\u91cf\u8868\u8fbe\u5f0f:</p> <pre><code>deploy:\n  script: cap staging deploy\n  only:\n    refs:\n      - branches\n    variables:\n      - $RELEASE == \"staging\"\n      - $STAGING\n</code></pre> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u4f1a\u6839\u636e\u63d0\u4ea4\u65e5\u5fd7\u4fe1\u606f\u6765\u6392\u9664\u67d0\u4e9b\u4f5c\u4e1a:</p> <pre><code>end-to-end:\n  script: rake test:end-to-end\n  except:\n    variables:\n      - $CI_COMMIT_MESSAGE =~ /skip-end-to-end-tests/\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#onlychangesexceptchanges","title":"<code>only:changes/except:changes</code>","text":"<ul> <li><code>changes</code> \u7b56\u7565\u8868\u660e\u4e00\u4e2a\u4f5c\u4e1a\u53ea\u6709\u5728\u4f7f\u7528 <code>git push</code> \u4e8b\u4ef6\u4f7f\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u65f6\u6267\u884c\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cdeploy\u4f5c\u4e1a\u4ec5\u5f53\u6d41\u6c34\u7ebf\u662f\u8ba1\u5212\u4f5c\u4e1a\u6216\u8005\u5728master\u4e3b\u5e72\u8fd0\u884c:</p> <pre><code>docker build:\n  script: docker build -t my-image:$CI_COMMIT_REF_SLUG .\n  only:\n    changes:\n      - Dockerfile\n      - docker/scripts/*\n      - dockerfiles/**/*\n      - more_scripts/*.{rb,py,sh}\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4e00\u65e6 <code>Dockerfile</code> \u6587\u4ef6\u53d1\u751f\u53d8\u5316\uff0c\u6216\u8005 <code>docker/scripts/</code> \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u53d1\u751f\u53d8\u5316\uff0c\u6216\u8005 <code>dockerfiles/</code> \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u53d1\u751f\u53d8\u5316\uff0c\u6216\u8005 <code>more_scripts/</code> \u76ee\u5f55\u4e0b <code>rb,py,sh</code> \u7b49\u811a\u672c\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u5c31\u4f1a\u89e6\u53d1Docker\u6784\u5efa\u3002</p> <ul> <li>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>glob\u6a21\u5f0f\u5339\u914d</code> \u6765\u5339\u914d\u6839\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff0c\u6216\u8005\u4efb\u4f55\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u3002</li> </ul> <p>\u5982\u4e0b\u793a\u4f8b:</p> <pre><code>test:\n  script: npm run test\n  only:\n    changes:\n      - \"*.json\"\n      - \"**/*.sql\"\n</code></pre> <p>\u6ce8\u610f\uff1a</p> <p>\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>glob\u6a21\u5f0f\u5339\u914d</code> \u7684\u5b57\u7b26\u4e32\u9700\u8981\u4f7f\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4 <code>.gitlab-ci.yml</code> \u89e3\u6790\u9519\u8bef\u3002</p> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5f53md\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u4f1a\u5ffd\u7565CI\u4f5c\u4e1a:</p> <pre><code>build:\n  script: npm run build\n  except:\n    changes:\n      - \"*.md\"\n</code></pre> <p>\u8bb0\u5f55\u4e00\u4e0b\u5b98\u7f51\u8bf4\u660e\u4e2d\u4f7f\u7528 <code>change</code> \u65f6\u9700\u8981\u6ce8\u610f\u7684\u4e24\u70b9\uff1a</p> <ul> <li>Using changes with new branches and tags\uff1aWhen pushing a new branch or a new tag to GitLab, the policy always evaluates to true and GitLab will create a job. This feature is not connected with merge requests yet and, because GitLab is creating pipelines before a user can create a merge request, it is unknown what the target branch is at this point.</li> <li>Using changes with merge_requests\uff1aWith pipelines for merge requests, it is possible to define a job to be created based on files modified in a merge request.</li> </ul> <p>\u5728\u5408\u5e76\u8bf7\u6c42\u4e2d\u4f7f\u7528 <code>change</code> \u7b56\u7565:</p> <pre><code>docker build service one:\n  script: docker build -t my-service-one-image:$CI_COMMIT_REF_SLUG .\n  only:\n    refs:\n      - merge_requests\n    changes:\n      - Dockerfile\n      - service-one/**/*\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4e00\u65e6\u5408\u5e76\u8bf7\u6c42\u4e2d\u4fee\u6539\u4e86 <code>Dockerfile</code> \u6587\u4ef6\u6216\u8005\u4fee\u6539\u4e86 <code>service</code> \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff0c\u90fd\u4f1a\u89e6\u53d1Docker\u6784\u5efa\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#only-except_2","title":"<code>only</code> \u548c <code>except</code> \u7efc\u5408\u793a\u4f8b","text":"<p>\u6211\u4eec\u5c06 <code>bluelog</code> \u9879\u76ee\u7684\u63cf\u8ff0\u548c\u4e3b\u9898\u8fdb\u884c\u4fee\u6539\uff1a</p> <p></p> <p>\u5e76\u521b\u5efa\u4e09\u4e2a\u5206\u652f <code>issue-pylint</code> \u3001<code>Issue-flake8</code> \u548c <code>severe-issues</code> \uff1a</p> <p></p> <p>\u521a\u65b0\u589e\u7684\u4e09\u4e2a\u5206\u652f\uff0c\u81ea\u52a8\u7ee7\u627f\u4e86master\u4e3b\u5e72\u7684CI RUNNER\uff0c\u56e0\u4e3aFlake8\u68c0\u67e5\u4ee3\u7801\u8d28\u91cf\u6ca1\u901a\u8fc7\uff0c\u6d41\u6c34\u7ebf\u90fd\u5931\u8d25\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u671d <code>.gitlab-ci.yml</code> \u6587\u4ef6\u4e2d\u589e\u52a0 <code>only</code> \u548c <code>except</code> \u7b56\u7565\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#issue-","title":"\u5339\u914d <code>issue-</code> \u5f00\u5934\u7684\u5206\u652f","text":"<p>\u521b\u5efa\u4ec5\u5339\u914d <code>issue-</code> \u5f00\u5934\u7684\u5206\u652f\uff1a</p> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0master\u4e3b\u5e72\u6ca1\u6709\u6267\u884c <code>find Bugs</code> \u4f5c\u4e1a\uff1a</p> <p></p> <p>\u4e3a\u4e86\u5feb\u901f\u6d4b\u8bd5\uff0c\u6211\u4eec\u5bf9\u5bf9\u4e2a\u4f5c\u4e1a\u90fd\u4f7f\u7528 <code>only</code> \u548c <code>except</code> \u7b56\u7565:</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n- echo \"Before script section\"\n- echo \"For example you might run an update here or install a build dependency\"\n- echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n- echo \"After script section\"\n- echo \"For example you might do some cleanup here\"\n\nstages:\n- build\n- code_check\n- test\n- deploy\n\nbuild1:\nstage: build\nbefore_script:\n  - echo \"Before script in build stage that overwrited the globally defined before_script\"\n  - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n  - yum install cloc -y\nafter_script:\n  - echo \"After script in build stage that overwrited the globally defined after_script\"\n  - cloc --version\n  # cloc .\nonly:\n  - /^issue-.*$/\nexcept:\n  - master\nscript:\n  - echo \"Do your build here\"\n  - cloc --version\n  # - cloc .\ntags:\n  - bluelog\n\nfind Bugs:\nstage: code_check\nonly:\n  - /^issue-.*$/\nexcept:\n  - branches\nscript:\n  - echo \"Use Flake8 to check python code\"\n  - pip install flake8\n  - flake8 --version\n  # - flake8 .\ntags:\n  - bluelog\n\ntest1:\nstage: test\nonly:\n  - /^issue-.*$/\nexcept:\n  - /issue-pylint/\nscript:\n  - echo \"Do a test here\"\n  - echo \"For example run a test suite\"\ntags:\n  - bluelog\n\ntest2:\nstage: test\nonly:\n  - /^issue-.*$/\nexcept:\n  - /Issue-flake8/\nscript:\n  - echo \"Do another parallel test here\"\n  - echo \"For example run a lint test\"\ntags:\n  - bluelog\n\ndeploy1:\nstage: deploy\nonly:\n  - /^issue-.*$/\nexcept:\n  - /severe-issues/\nscript:\n  - echo \"Do your deploy here\"\ntags:\n  - bluelog\n</code></pre> <p>\u63d0\u4ea4\u540e\uff0c\u76f4\u63a5\u5165\u5e93\uff0c\u68c0\u67e5 <code>master</code> \u4e3b\u5e72\uff0c\u5e76\u6ca1\u6709\u89e6\u53d1\u6d41\u6c34\u7ebf\u4f5c\u4e1a\u3002</p> <p>\u7edf\u8ba1\u4f5c\u4e1a\u6d41\u6c34\u7ebf\u4f5c\u4e1a\u60c5\u51b5\uff1a</p> <p></p> <p>\u89e3\u91ca\u4e0a\u9762\u7684\u6d41\u6c34\u4f5c\u4e1a\u7b56\u7565\uff1a</p> <p>\u4f5c\u4e1a\u89c4\u5219\u5b9a\u4e49\u89c4\u5219\u89e3\u91ca</p> \u4f5c\u4e1a \u89c4\u5219\u5b9a\u4e49 \u89c4\u5219\u89e3\u91ca build1 <code>only: - /^issue-.*$/ except: - master</code> \u53ea\u5728\u4ee5issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728master\u4e3b\u5e72\u6267\u884c find Bugs <code>only: - /^issue-.*$/ except: - branches</code> \u53ea\u5728\u4ee5issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728 <code>branches</code> \u5206\u652f\u6267\u884c\uff0c \u7531\u4e8eissue-pylint\u4e5f\u662f\u5206\u652f\uff0c\u6240\u4ee5\u5728issue-pylint\u4e2d\u4e5f\u4e0d\u4f1a\u6267\u884cfind Bugs\u4f5c\u4e1a test1 <code>only: - /^issue-.*$/ except: - /issue-pylint/</code> \u53ea\u5728\u4ee5issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728issue-pylint\u5206\u652f\u6267\u884c\uff0c \u5373\u4f1a\u5728\u9664\u4e86issue-pylint\u5206\u652f\u4ee5\u5916\u7684issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e5f\u5373\u6ca1\u6709\u5206\u652f\u6267\u884c test2 <code>only: - /^issue-.*$/ except: - /Issue-flake8/</code> \u53ea\u5728\u4ee5issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728Issue-flake8\u5206\u652f\u6267\u884c\uff0c \u56e0\u6b64\u53ef\u4ee5issue-pylint\u5206\u652f\u6267\u884c deploy1 <code>only: - /^issue-.*$/ except: - /severe-issues/</code> \u53ea\u5728\u4ee5issue-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728severe-issues\u5206\u652f\u6267\u884c \u56e0\u6b64\u53ef\u4ee5issue-pylint\u5206\u652f\u6267\u884c","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_2","title":"\u5927\u5c0f\u5199\u4e0d\u654f\u611f\u5339\u914d","text":"<p>\u597d\uff0c\u6211\u4eec\u518d\u5c06 <code>only</code> \u8bed\u6cd5\u4e2d\u52a0\u5165\u8bed\u6cd5\u5927\u5c0f\u5199\u4e0d\u654f\u611f\u7684 <code>i</code> \u6807\u5fd7\uff01\u518d\u6765\u505a\u4e00\u6b21\u5b9e\u9a8c\uff0c\u770b\u770b\u6700\u7ec8\u7684\u6548\u679c\u3002</p> <p>\u52a0\u5165\u8bed\u6cd5\u5927\u5c0f\u5199\u4e0d\u654f\u611f\u7684 <code>i</code> \u6807\u5fd7:</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    # cloc .\n  only:\n    - /^issue-.*$/i\n  except:\n    - master\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    # - cloc .\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  only:\n    - /^issue-.*$/i\n  except:\n    - branches\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    # - flake8 .\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  only:\n    - /^issue-.*$/i\n  except:\n    - /issue-pylint/\n  script:\n    - echo \"Do a test here\"\n    - echo \"For example run a test suite\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  only:\n    - /^issue-.*$/i\n  except:\n    - /Issue-flake8/\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  only:\n    - /^issue-.*$/i\n  except:\n    - /severe-issues/\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u9884\u671f\u6548\u679c\uff1a <code>issue-pylint</code> \u548c <code>Issue-flake8</code> \u5206\u652f\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff0c<code>master</code> \u4e3b\u5e72\u548c <code>severe-issues</code> \u5206\u652f\u4e0d\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\u3002</p> <p>\u7edf\u8ba1\u4f5c\u4e1a\u6d41\u6c34\u7ebf\u4f5c\u4e1a\u60c5\u51b5\uff1a</p> \u5206\u652f \u6d41\u6c34\u7ebf build1 find Bugs test1 test2 deploy1 master \u672a\u89e6\u53d1 issue-pylint <code>#23</code> Yes No No Yes Yes Issue-flake8 <code>#24</code> Yes No Yes No Yes severe-issues \u672a\u89e6\u53d1 <p>\u6b63\u5982\u6211\u4eec\u9884\u671f\u7684\u4e00\u6837\uff0c<code>issue-pylint</code> \u548c <code>Issue-flake8</code> \u5206\u652f\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff0c<code>master</code> \u4e3b\u5e72\u548c <code>severe-issues</code> \u5206\u652f\u4e0d\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff1a</p> <p> </p> <p>\u89e3\u91ca\u4e0a\u9762\u7684\u6d41\u6c34\u4f5c\u4e1a\u7b56\u7565\uff1a</p> \u4f5c\u4e1a \u89c4\u5219\u5b9a\u4e49 \u89c4\u5219\u89e3\u91ca build1 <code>only: - /^issue-.*$/i except: - master</code> \u53ea\u5728\u4ee5issue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728master\u4e3b\u5e72\u6267\u884c \u53ef\u4ee5\u5728issue-pylint\u548cIssue-flake8\u5206\u652f\u6267\u884c find Bugs <code>only: - /^issue-.*$/i except: - branches</code> \u53ea\u5728\u4ee5issue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728 <code>branches</code> \u5206\u652f\u6267\u884c\uff0c \u7531\u4e8eissue-pylint\u4e5f\u662f\u5206\u652f\uff0c\u6240\u4ee5\u5728issue-pylint\u4e2d\u4e5f\u4e0d\u4f1a\u6267\u884cfind Bugs\u4f5c\u4e1a test1 <code>only: - /^issue-.*$/i except: - /issue-pylint/</code> \u53ea\u5728\u4ee5issue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728issue-pylint\u5206\u652f\u6267\u884c\uff0c \u5373\u4f1a\u5728\u9664\u4e86issue-pylint\u5206\u652f\u4ee5\u5916\u7684issue-(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c \u53ef\u4ee5\u5728Issue-flake8\u5206\u652f\u6267\u884c test2 <code>only: - /^issue-.*$/i except: - /Issue-flake8/</code> \u53ea\u5728\u4ee5issue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728Issue-flake8\u5206\u652f\u6267\u884c\uff0c \u56e0\u6b64\u53ef\u4ee5issue-pylint\u5206\u652f\u6267\u884c deploy1 <code>only: - /^issue-.*$/i except: - /severe-issues/</code> \u53ea\u5728\u4ee5issue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)-\u5f00\u5934\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728severe-issues\u5206\u652f\u6267\u884c \u53ef\u4ee5\u5728issue-pylint\u548cIssue-flake8\u5206\u652f\u6267\u884c <p>\u6211\u4eec\u518d\u5c06 <code>only</code> \u8bed\u6cd5\u4e2d\u5c06 <code>/^issue-.*$/</code> \u6539\u4e3a <code>/issue/i</code> \uff01\u518d\u6765\u505a\u4e00\u6b21\u5b9e\u9a8c\uff0c\u770b\u770b\u6700\u7ec8\u7684\u6548\u679c\u3002</p> <p>\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u5339\u914dissue\u5b57\u7b26\uff1a</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    # cloc .\n  only:\n    - /issue/i\n  except:\n    - master\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    # - cloc .\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  only:\n    - /issue/i\n  except:\n    - branches\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    # - flake8 .\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  only:\n    - /issue/i\n  except:\n    - /issue-pylint/\n  script:\n    - echo \"Do a test here\"\n    - echo \"For example run a test suite\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  only:\n    - /issue/i\n  except:\n    - /Issue-flake8/\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  only:\n    - /issue/i\n  except:\n    - /severe-issues/\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u9884\u671f\u6548\u679c\uff1a\u4e0d\u533a\u5206\u5927\u5c0f\u5199\uff0c<code>issue-pylint</code> \u3001 <code>Issue-flake8</code> \u548c <code>severe-issues</code> \u5206\u652f\u5206\u652f\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff0c<code>master</code> \u4e3b\u5e72\u4e0d\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\u3002</p> <p>\u7edf\u8ba1\u4f5c\u4e1a\u6d41\u6c34\u7ebf\u4f5c\u4e1a\u60c5\u51b5\uff1a</p> <p>\u6b63\u5982\u6211\u4eec\u9884\u671f\u7684\u4e00\u6837\uff0c<code>issue-pylint</code> \u3001 <code>Issue-flake8</code> \u548c <code>severe-issues</code> \u5206\u652f\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff0c<code>master</code> \u4e3b\u5e72\u4e0d\u4f1a\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff1a</p> <p> </p> <p>\u89e3\u91ca\u4e0a\u9762\u7684\u6d41\u6c34\u4f5c\u4e1a\u7b56\u7565\uff1a</p> \u4f5c\u4e1a \u89c4\u5219\u5b9a\u4e49 \u89c4\u5219\u89e3\u91ca build1 <code>only: - /issue/i except: - master</code> \u53ea\u5728\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728master\u4e3b\u5e72\u6267\u884c \u56e0\u6b64\u5728issue-pylint\u3001Issue-flake8\u3001severe-issues\u5206\u652f\u6267\u884c find Bugs <code>only: - /issue/i except: - branches</code> \u53ea\u5728\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728 <code>branches</code> \u5206\u652f\u6267\u884c\uff0c \u6240\u4ee5find Bugs\u4f5c\u4e1a\u4e00\u76f4\u4e0d\u4f1a\u6267\u884c test1 <code>only: - /issue/i except: - /issue-pylint/</code> \u53ea\u5728\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728\u5305\u542bissue-pylint\u5b57\u7b26\u7684\u5206\u652f \u6267\u884c\uff0c\u5373\u4f1a\u5728\u9664\u4e86issue-pylint\u5206\u652f\u4ee5\u5916\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c \u6240\u4ee5\u53ef\u4ee5\u5728Issue-flake8\u548csevere-issues\u5206\u652f\u6267\u884c test2 <code>only: - /issue/i except: - /Issue-flake8/</code> \u53ea\u5728\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728\u5305\u542bissue-flake8\u5b57\u7b26\u7684\u5206\u652f \u6267\u884c\uff0c\u5373\u4f1a\u5728\u9664\u4e86issue-flake8\u5206\u652f\u4ee5\u5916\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c \u6240\u4ee5\u53ef\u4ee5\u5728issue-pylint\u548csevere-issues\u5206\u652f\u6267\u884c deploy1 <code>only: - /issue/i except: - /severe-issues/</code> \u53ea\u5728\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c\uff0c\u4e0d\u5728\u5305\u542bsevere-issues\u5b57\u7b26\u7684\u5206\u652f \u6267\u884c\uff0c\u5373\u4f1a\u5728\u9664\u4e86severe-issues\u5206\u652f\u4ee5\u5916\u5305\u542bissue(\u4e0d\u533a\u5206\u5927\u5c0f\u5199)\u5b57\u7b26\u7684\u5206\u652f\u6267\u884c, \u6240\u4ee5\u53ef\u4ee5\u5728issue-pylint\u548cIssue-flake8\u5206\u652f\u6267\u884c","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git-tag","title":"git tag\u6253\u6807\u7b7e\u7684\u4f7f\u7528","text":"<p>\u4f7f\u7528\u6807\u7b7e\uff0c\u53ef\u4ee5\u6807\u8bb0\u63d0\u4ea4\u5386\u53f2\u4e0a\u7684\u7279\u5b9a\u70b9\u4e3a\u91cd\u8981\u63d0\u4ea4\u3002</p> <ul> <li>\u65b0\u5efatag</li> </ul> <p><code>git tag -a v1.0 -m\"Release v1.0\"</code></p> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u6211\u4eec\u6210\u529f\u521b\u5efa\u4e86\u672c\u5730\u4e00\u4e2a\u7248\u672c V1.0 ,\u5e76\u4e14\u6dfb\u52a0\u4e86\u9644\u6ce8\u4fe1\u606f \u2018Release 1.0\u2019\u3002</p> <ul> <li>\u67e5\u770btag</li> </ul> <p><code>git tag</code></p> <ul> <li>\u663e\u793atag\u9644\u6ce8\u4fe1\u606f</li> </ul> <p><code>git show v1.0</code></p> <ul> <li>\u63d0\u4ea4\u672c\u5730tag\u5230\u8fdc\u7a0b\u4ed3\u5e93</li> </ul> <p><code>git push origin v1.0</code></p> <ul> <li>\u63d0\u4ea4\u672c\u5730\u6240\u6709tag\u5230\u8fdc\u7a0b\u4ed3\u5e93</li> </ul> <p><code>git push origin --tags</code></p> <ul> <li>\u5220\u9664\u672c\u5730tag</li> </ul> <p><code>git tag -d v1.0</code></p> <ul> <li>\u5220\u9664\u8fdc\u7a0btag</li> </ul> <p>`git tag push origin :refs/tags/v1.0``</p> <ul> <li>\u83b7\u53d6\u8fdc\u7a0b\u7248\u672c</li> </ul> <p><code>git fetch origin tag v1.0</code></p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#tag","title":"\u4ec5\u5f53tag\u6807\u7b7e\u63d0\u4ea4\u65f6\uff0c\u624d\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c","text":"<p>\u4f7f\u7528\u6807\u7b7e\uff0c\u53ef\u4ee5\u6807\u8bb0\u63d0\u4ea4\u5386\u53f2\u4e0a\u7684\u7279\u5b9a\u70b9\u4e3a\u91cd\u8981\u63d0\u4ea4\uff0c\u53ef\u4ee5\u6807\u8bb0\u91cd\u8981\u7248\u672c\uff0c\u5982\u4e0b\u56fe\uff0c\u662fGitLab\u5b98\u65b9\u7684Tag\u6807\u7b7e\u5217\u8868\uff1a</p> <p></p> <p>\u6211\u4eec\u5c06\u6d41\u6c34\u7ebf\u914d\u7f6e\u6587\u4ef6 <code>.gitlab-ci.yml</code> \u4fee\u6539\u4e3a\u4ee5\u4e0b\u5185\u5bb9:</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    # cloc .\n  only:\n    - tags\n  except:\n    - master\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    # - cloc .\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  only:\n    - tags\n  except:\n    - branches\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    # - flake8 .\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  only:\n    - tags\n  except:\n    - /issue-pylint/\n  script:\n    - echo \"Do a test here\"\n    - echo \"For example run a test suite\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  only:\n    - tags\n  except:\n    - /Issue-flake8/\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  only:\n    - tags\n  except:\n    - /severe-issues/\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u67e5\u770b\u5dee\u5f02:</p> <p><pre><code>$ git diff\ndiff --git a/.gitlab-ci.yml b/.gitlab-ci.yml\nindex 7f16137..8315eb0 100644\n--- a/.gitlab-ci.yml\n+++ b/.gitlab-ci.yml\n@@ -28,7 +28,7 @@ build1:\n      - cloc --version\n      # cloc .\n    only:\n-    - /^issue-.*$/\n+    - tags\n    except:\n      - master\n    script:\n@@ -41,7 +41,7 @@ build1:\n  find Bugs:\n    stage: code_check\n    only:\n-    - /^issue-.*$/\n+    - tags\n    except:\n      - branches\n    script:\n@@ -55,7 +55,7 @@ find Bugs:\n  test1:\n    stage: test\n    only:\n-    - /^issue-.*$/\n+    - tags\n    except:\n      - /issue-pylint/\n    script:\n@@ -67,7 +67,7 @@ test1:\n  test2:\n    stage: test\n    only:\n-    - /^issue-.*$/\n+    - tags\n    except:\n      - /Issue-flake8/\n    script:\n@@ -79,7 +79,7 @@ test2:\n  deploy1:\n    stage: deploy\n    only:\n-    - /^issue-.*$/\n+    - tags\n    except:\n      - /severe-issues/\n    script:\n</code></pre> \u63d0\u4ea4:</p> <pre><code>$ git add -A\n\n$ git commit -m\"\u6d4b\u8bd5tag\u6807\u7b7e\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\"\n[master eb9b468] \u6d4b\u8bd5tag\u6807\u7b7e\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\n  1 file changed, 7 insertions(+), 5 deletions(-)\n\n$ git push origin master:master\nEnumerating objects: 5, done.\nCounting objects: 100% (5/5), done.\nDelta compression using up to 12 threads\nCompressing objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 365 bytes | 365.00 KiB/s, done.\nTotal 3 (delta 2), reused 0 (delta 0)\nTo 192.168.56.14:higit/bluelog.git\n    1bd46f2..eb9b468  master -&gt; master\n</code></pre> <p>\u67e5\u770b\u662f\u5426\u89e6\u53d1\u6d41\u6c34\u7ebf\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\uff1a</p> <p></p> <p>\u6211\u4eec\u7ed9 <code>bluelog</code> \u6253\u4e2a <code>tag</code> \u6807\u7b7e\uff0c\u6807\u7b7e\u540d\u79f0 <code>V0.1</code>:</p> <pre><code>$ git tag v0.1 -m\"Release v0.1\"\n\n$ git tag\nv0.1\n\n$ git push origin v0.1\nEnumerating objects: 1, done.\nCounting objects: 100% (1/1), done.\nWriting objects: 100% (1/1), 165 bytes | 165.00 KiB/s, done.\nTotal 1 (delta 0), reused 0 (delta 0)\nTo 192.168.56.14:higit/bluelog.git\n  * [new tag]         v0.1 -&gt; v0.1\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0 <code>bluelog</code> \u5df2\u7ecf\u751f\u6210\u4e86\u4e00\u4e2atag\u7248\u672c\uff1a</p> <p></p> <p>\u5728\u6d41\u6c34\u7ebf\u5217\u8868\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u770b <code>#31</code> \u53f7\u6d41\u6c34\u7ebf\u88ab\u89e6\u53d1\u4e86\uff0c\u5e76\u4e14\u6807\u7b7e\u662f <code>v0.1</code>:</p> <p></p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_3","title":"\u4f7f\u7528\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c","text":"<p>\u6211\u4eec\u7ed9 <code>bluelog</code> \u9879\u76ee\u521b\u5efa\u4e00\u4e2a\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668( <code>Trigger</code> )\uff0c\u5728\u9879\u76ee\u7684 <code>\u8bbe\u7f6e \u2013&gt; CI/CD \u2013&gt; \u6d41\u6c34\u7ebf\u89e6\u53d1\u5668</code> \u5904\u589e\u52a0\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668\uff1a</p> <p></p> <p>\u5728\u201d\u89e6\u53d1\u5668\u63cf\u8ff0\u201d\u5904\u586b\u5199\u201dbluelog trigger\u201d\uff0c\u7136\u540e\u70b9\u51fb\u201d\u589e\u52a0\u89e6\u53d1\u5668\u201d\u6309\u94ae\uff0c\u5219\u4f1a\u65b0\u589e\u4e00\u4e2a\u89e6\u53d1\u5668:</p> <p></p> <p>\u6211\u4eec\u4fee\u6539 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u5c06 <code>build1</code> \u548c <code>find Bugs</code> \u4f5c\u4e1a\u8bbe\u7f6e\u4e3a\u4ec5 <code>triggers</code> \u89e6\u53d1\u5668\u80fd\u591f\u89e6\u53d1\u6267\u884c:</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nbefore_script:\n  - echo \"Before script section\"\n  - echo \"For example you might run an update here or install a build dependency\"\n  - echo \"Or perhaps you might print out some debugging details\"\n\nafter_script:\n  - echo \"After script section\"\n  - echo \"For example you might do some cleanup here\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  before_script:\n    - echo \"Before script in build stage that overwrited the globally defined before_script\"\n    - echo \"Install cloc:A tool to count lines of code in various languages from a given directory.\"\n    - yum install cloc -y\n  after_script:\n    - echo \"After script in build stage that overwrited the globally defined after_script\"\n    - cloc --version\n    # cloc .\n  only:\n    - triggers\n  script:\n    - echo \"Do your build here\"\n    - cloc --version\n    # - cloc .\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  only:\n    - triggers\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    # - flake8 .\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  only:\n    - tags\n  except:\n    - /issue-pylint/\n  script:\n    - echo \"Do a test here\"\n    - echo \"For example run a test suite\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  only:\n    - tags\n  except:\n    - /Issue-flake8/\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  only:\n    - tags\n  except:\n    - /severe-issues/\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u63d0\u4ea4\u4fee\u6539:</p> <pre><code>$ git diff\ndiff --git a/.gitlab-ci.yml b/.gitlab-ci.yml\nindex 657dc5e..921f93e 100644\n--- a/.gitlab-ci.yml\n+++ b/.gitlab-ci.yml\n@@ -28,9 +28,7 @@ build1:\n      - cloc --version\n      # cloc .\n    only:\n-    - tags\n-  except:\n-    - master\n+    - triggers\n    script:\n      - echo \"Do your build here\"\n      - cloc --version\n@@ -41,9 +39,7 @@ build1:\n  find Bugs:\n    stage: code_check\n    only:\n-    - tags\n-  except:\n-    - branches\n+    - triggers\n    script:\n      - echo \"Use Flake8 to check python code\"\n      - pip install flake8\n\n\n$ git add -A\n\n\n$ git commit -m\"\u4f7f\u7528\u89e6\u53d1\u5668trigger\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\"\n[master 57f64a3] \u4f7f\u7528\u89e6\u53d1\u5668trigger\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\n  1 file changed, 2 insertions(+), 6 deletions(-)\n\n\n$ git push origin master:master\nEnumerating objects: 5, done.\nCounting objects: 100% (5/5), done.\nDelta compression using up to 12 threads\nCompressing objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 361 bytes | 361.00 KiB/s, done.\nTotal 3 (delta 2), reused 0 (delta 0)\nTo 192.168.56.14:higit/bluelog.git\n    eb9b468..57f64a3  master -&gt; master\n</code></pre> <p>\u68c0\u67e5\u53d1\u73b0\u5e76\u6ca1\u6709\u89e6\u53d1\u6d41\u6c34\u7ebf\u7684\u6267\u884c\uff1a</p> <p></p> <p>\u6211\u4eec\u73b0\u5728\u4f7f\u7528 <code>curl</code> \u53d1\u9001\u8bf7\u6c42\uff0c\u89e6\u53d1\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668\u6267\u884c:</p> <pre><code>$ curl -X POST -F token=cf8a32f6f8a583263f6d042e6362d2 -F ref=master https://localhost/api/v4/projects/2/trigger/pipeline\n\n{\"id\":33,\"sha\":\"57f64a35cad6d069dc62ddc93f0747296383826e\",\"ref\":\"master\",\"status\":\"pending\",\"web_url\":\"https://localhost/higit/bluelog/pipelines/33\",\"before_sha\":\"0000000000000000000000000000000000000000\",\"tag\":false,\"yaml_errors\":null,\"user\":{\"id\":2,\"name\":\"wgzhao\",\"username\":\"wgzhao\",\"state\":\"active\",\"avatar_url\":\"https://localhost/uploads/-/system/user/avatar/2/avatar.png\",\"web_url\":\"https://localhost/wgzhao\"},\"created_at\":\"2019-07-06T22:08:52.761+08:00\",\"updated_at\":\"2019-07-06T22:08:53.026+08:00\",\"started_at\":null,\"finished_at\":null,\"committed_at\":null,\"duration\":null,\"coverage\":null,\"detailed_status\":{\"icon\":\"status_pending\",\"text\":\"\u7b49\u5f85\u4e2d\",\"label\":\"\u7b49\u5f85\u4e2d\",\"group\":\"pending\",\"tooltip\":\"\u7b49\u5f85\u4e2d\",\"has_details\":false,\"details_path\":\"/higit/bluelog/pipelines/33\",\"illustration\":null,\"favicon\":\"/assets/ci_favicons/favicon_status_pending-5bdf338420e5221ca24353b6bff1c9367189588750632e9a871b7af09ff6a2ae.png\"}}\n</code></pre> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0\u6d41\u6c34\u7ebf\u5df2\u7ecf\u88ab\u6267\u884c\uff0c<code>#33</code> \u53f7\u6d41\u6c34\u7ebf\u6267\u884c\u4e86 <code>build1</code> \u548c <code>find Bugs</code> \u4f5c\u4e1a\uff0c\u5176\u4ed6\u4f5c\u4e1a\u5e76\u672a\u6267\u884c\uff0c\u4e0e\u6211\u4eec\u9884\u671f\u7684\u76f8\u540c\uff1a</p> <p></p> <p>\u6839\u636e\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668( <code>Trigger</code> )\u521b\u5efa\u5904\u7684\u63d0\u793a\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u4f9d\u8d56\u9879\u76ee\u4e2d\u914d\u7f6e\u89e6\u53d1\u5668\uff0c\u4f9d\u8d56\u9879\u76ee\u6d41\u6c34\u7ebf\u7ed3\u675f\u65f6\u89e6\u53d1\u6b64\u9879\u76ee\u91cd\u65b0\u6784\u5efa\u3002</p> <p><code>only</code> \u548c <code>except</code> \u5176\u4ed6\u5173\u952e\u5b57\u7684\u4f7f\u7528\u53ef\u53c2\u624d\u5b98\u7f51\u6587\u6863 https://docs.gitlab.com/ce/ci/yaml/README.html#onlyexcept-basic \uff0c\u6b64\u5904\u6682\u65f6\u4e0d\u8868\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#tags","title":"<code>tags</code>","text":"<p><code>tags</code> \u5173\u952e\u5b57\u7528\u4e8e\u6307\u5b9a <code>GitLab Runner</code> \u8fd0\u884c\u5668\u4f7f\u7528\u54ea\u4e00\u4e2a\u8fd0\u884c\u5668\u6765\u6267\u884c\u4f5c\u4e1a\u3002</p> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u53ea\u6709\u8fd0\u884c\u5668\u6ce8\u518c\u65f6\u5b9a\u4e49\u4e86 <code>ruby</code> \u548c <code>postgres</code> \u4e24\u4e2a\u6807\u7b7e\u7684\u8fd0\u884c\u5668\u624d\u80fd\u6267\u884c\u4f5c\u4e1a:</p> <pre><code>job:\n tags:\n   - ruby\n   - postgres\n</code></pre> <p>\u800c\u6211\u4eec\u7684 <code>bluelog</code> \u9879\u76ee\u4e2d\uff0c\u6240\u6709\u7684\u4f5c\u4e1a\u90fd\u662f\u4f7f\u7528\u7684\u662f\u6807\u7b7e\u4e3a <code>bluelog</code> \u7684\u8fd0\u884c\u5668:</p> <pre><code>find Bugs:\n  stage: code_check\n  only:\n    - triggers\n  script:\n    - echo \"Use Flake8 to check python code\"\n    - pip install flake8\n    - flake8 --version\n    # - flake8 .\n  tags:\n    - bluelog\n</code></pre> <p>\u8fd0\u884c\u5668\u6807\u7b7e\u53ef\u7528\u4e8e\u5b9a\u4e49\u4e0d\u540c\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684\u4f5c\u4e1a\uff0c\u5982 <code>Mac OS X Runner</code> \u4f7f\u7528 <code>osx</code> \u6807\u7b7e\uff0c <code>Windows Runner</code> \u4f7f\u7528 <code>windows</code> \u6807\u7b7e\uff0c\u800c <code>Linux Runner</code> \u4f7f\u7528 <code>linux</code> \u6807\u7b7e:</p> <p>```yaml windows job:   stage:     - build   tags:     - windows   script:     - echo Hello, %USERNAME%!</p> <p>osx job:   stage:     - build   tags:     - osx   script:     - echo \"Hello, $USER!\"</p> <p>linux job:   stage:     - build   tags:     - linux   script:     - echo \"Hello, $USER!\"  ```</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#allow_failure","title":"<code>allow_failure</code>","text":"<ul> <li><code>allow_failure</code> \u53ef\u4ee5\u7528\u4e8e\u5f53\u4f60\u60f3\u8bbe\u7f6e\u4e00\u4e2a\u4f5c\u4e1a\u5931\u8d25\u7684\u4e4b\u540e\u5e76\u4e0d\u5f71\u54cd\u540e\u7eed\u7684CI\u7ec4\u4ef6\u7684\u65f6\u5019\u3002\u5931\u8d25\u7684\u4f5c\u4e1a\u4e0d\u4f1a\u5f71\u54cd\u5230commit\u63d0\u4ea4\u72b6\u6001\u3002</li> <li>\u5982\u679c\u5141\u8bb8\u5931\u8d25\u7684\u4f5c\u4e1a\u5931\u8d25\u4e86\uff0c\u5219\u76f8\u5e94\u7684\u4f5c\u4e1a\u4f1a\u663e\u793a\u4e00\u4e2a\u9ec4\u8272\u7684\u8b66\u544a\uff0c\u4f46\u5bf9\u6d41\u6c34\u7ebf\u6210\u529f\u4e0e\u5426\u4e0d\u4ea7\u751f\u5f71\u54cd\u3002</li> </ul> <p>\u4e0b\u9762\u7684\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cjob1\u548cjob2\u5c06\u4f1a\u5e76\u5217\u8fdb\u884c\uff0c\u5982\u679cjob1\u5931\u8d25\u4e86\uff0c\u5b83\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u8fdb\u884c\u4e2d\u7684\u4e0b\u4e00\u4e2a\u9636\u6bb5\uff0c\u56e0\u4e3a\u8fd9\u91cc\u6709\u8bbe\u7f6e\u4e86 <code>allow_failure: true</code> :</p> <pre><code>job1:\n  stage: test\n  script:\n  - execute_script_that_will_fail\n  allow_failure: true\n\njob2:\n  stage: test\n  script:\n  - execute_script_that_will_succeed\n\njob3:\n  stage: deploy\n  script:\n  - deploy_to_staging\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u4e0a\u9762\u7684job2\u6267\u884c\u5931\u8d25\uff0c\u90a3\u4e48job3\u5219\u4f1a\u53d7\u5230\u5f71\u54cd\u800c\u4e0d\u4f1a\u6267\u884c\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#when","title":"<code>when</code>","text":"<p><code>when</code> \u5173\u952e\u5b57\u7528\u4e8e\u5b9e\u73b0\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u6216\u53d1\u751f\u6545\u969c\u65f6\u8fd0\u884c\u7684\u4f5c\u4e1a (when is used to implement jobs that are run in case of failure or despite the failure.)\u3002</p> <p><code>when</code> \u53ef\u4ee5\u8bbe\u7f6e\u4ee5\u4e0b\u503c\uff1a</p> <ul> <li><code>on_success</code> \uff1a\u53ea\u6709\u524d\u9762\u7684\u9636\u6bb5\u7684\u6240\u6709\u4f5c\u4e1a\u90fd\u6210\u529f\u65f6\u624d\u6267\u884c\uff0c\u8fd9\u662f\u9ed8\u8ba4\u503c\u3002</li> <li><code>on_failure</code> \uff1a\u5f53\u524d\u9762\u9636\u6bb5\u7684\u4f5c\u4e1a\u81f3\u5c11\u6709\u4e00\u4e2a\u5931\u8d25\u65f6\u624d\u6267\u884c\u3002</li> <li><code>always</code> : \u65e0\u8bba\u524d\u9762\u7684\u4f5c\u4e1a\u662f\u5426\u6210\u529f\uff0c\u4e00\u76f4\u6267\u884c\u672c\u4f5c\u4e1a\u3002</li> <li><code>manual</code> \uff1a\u624b\u52a8\u6267\u884c\u4f5c\u4e1a\uff0c\u4f5c\u4e1a\u4e0d\u4f1a\u81ea\u52a8\u6267\u884c\uff0c\u9700\u8981\u4eba\u5de5\u624b\u52a8\u70b9\u51fb\u542f\u52a8\u4f5c\u4e1a\u3002</li> <li><code>delayed</code> : \u5ef6\u8fdf\u6267\u884c\u4f5c\u4e1a\uff0c\u914d\u5408 <code>start_in</code> \u5173\u952e\u5b57\u4e00\u8d77\u4f5c\u7528\uff0c <code>start_in</code> \u8bbe\u7f6e\u7684\u503c\u5fc5\u987b\u5c0f\u4e8e\u6216\u7b49\u4e8e1\u5c0f\u65f6\uff0c<code>start_in</code> \u8bbe\u7f6e\u7684\u503c\u793a\u4f8b\uff1a <code>10 seconds</code> \u3001 <code>30 minutes</code> \u3001 <code>1 hour</code> \uff0c\u524d\u9762\u7684\u4f5c\u4e1a\u7ed3\u675f\u65f6\u8ba1\u65f6\u5668\u9a6c\u4e0a\u5f00\u59cb\u8ba1\u65f6\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>stages:\n  - build\n  - cleanup_build\n  - test\n  - deploy\n  - cleanup\n\nbuild_job:\n  stage: build\n  script:\n    - make build\n\ncleanup_build_job:\n  stage: cleanup_build\n  script:\n    - cleanup build when failed\n  when: on_failure\n\ntest_job:\n  stage: test\n  script:\n    - make test\n\ndeploy_job:\n  stage: deploy\n  script:\n    - make deploy\n  when: manual\n\ncleanup_job:\n  stage: cleanup\n  script:\n    - cleanup after jobs\n  when: always\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>\u53ea\u6709\u5728 <code>build_job</code> \u6784\u5efa\u4f5c\u4e1a\u5931\u8d25\u65f6\uff0c\u624d\u4f1a\u6267\u884c <code>cleanup_build_job</code> \u4f5c\u4e1a\u3002</li> <li>\u9700\u8981\u5728GitLab Web\u754c\u9762\u624b\u52a8\u70b9\u51fb\uff0c\u624d\u80fd\u6267\u884c <code>deploy_job</code> \u90e8\u7f72\u4f5c\u4e1a\u3002</li> <li>\u65e0\u8bba\u4e4b\u524d\u7684\u4f5c\u4e1a\u662f\u5426\u6210\u529f\u8fd8\u662f\u5931\u8d25\uff0c<code>cleanup_job</code> \u6e05\u7406\u4f5c\u4e1a\u4e00\u76f4\u4f1a\u6267\u884c\u3002</li> </ul> <p>\u5ef6\u65f6\u5904\u7406\u7684\u793a\u4f8b:</p> <pre><code>timed rollout 10%:\n  stage: deploy\n  script: echo 'Rolling out 10% ...'\n  when: delayed\n  start_in: 30 minutes\n</code></pre> <p>\u4e0a\u9762\u7684\u4f8b\u5b50\u521b\u5efa\u4e86\u4e00\u4e2a <code>timed rollout 10%</code> \u4f5c\u4e1a\uff0c\u4f1a\u5728\u4e0a\u4e00\u4e2a\u4f5c\u4e1a\u5b8c\u6210\u540e30\u5206\u949f\u540e\u624d\u5f00\u59cb\u6267\u884c\u3002</p> <p>\u5982\u679c\u4f60\u70b9\u51fb <code>Unschedule</code> \u6309\u94ae\u53ef\u4ee5\u53d6\u6d88\u4e00\u4e2a\u6fc0\u6d3b\u7684\u8ba1\u65f6\u5668\uff0c\u4f60\u4e5f\u53ef\u4ee5\u70b9\u51fb\u201dPlay\u201d\u6309\u94ae\uff0c\u7acb\u5373\u6267\u884c\u5ef6\u65f6\u4f5c\u4e1a\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#environment","title":"<code>environment</code>","text":"<p><code>environment</code> \u7528\u4e8e\u5b9a\u4e49\u4f5c\u4e1a\u90e8\u7f72\u5230\u7279\u6b8a\u7684\u73af\u5883\u4e2d\u3002\u5982\u679c\u6307\u5b9a\u4e86 <code>environment</code> \uff0c\u5e76\u4e14\u5728 <code>\u8fd0\u7ef4 \u2013&gt;\u73af\u5883</code> \u754c\u9762\u7684\u73af\u5883\u5217\u8868\u4e2d\u6ca1\u6709\u8be5\u540d\u79f0\u4e0b\u7684\u73af\u5883\uff0c\u5219\u4f1a\u81ea\u52a8\u521b\u5efa\u65b0\u73af\u5883\u3002</p> <p>\u5728\u6700\u7b80\u5355\u7684\u683c\u5f0f\u4e2d\uff0c\u73af\u5883\u5173\u952e\u5b57\u53ef\u4ee5\u5b9a\u4e49\u4e3a\uff1a</p> <pre><code>deploy to production:\n  stage: deploy\n  script: git push production HEAD:master\n  environment:\n    name: production\n</code></pre> <p>\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>deploy to production</code> \u4f5c\u4e1a\u5c06\u4f1a\u90e8\u7f72\u4ee3\u7801\u5230 <code>production</code> \u751f\u4ea7\u73af\u5883\u4e2d\u53bb\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#environmentname","title":"<code>environment:name</code>","text":"<ul> <li>\u5728GitLab 8.11\u4e4b\u524d\uff0c\u73af\u5883\u7684\u540d\u79f0\u53ef\u4ee5\u4f7f\u7528 <code>environment: production</code> \u65b9\u5f0f\u5b9a\u4e49\uff0c\u73b0\u5728\u63a8\u8350\u4f7f\u7528 <code>name</code> \u5173\u952e\u5b57\u6765\u5b9a\u4e49\u73af\u5883\u7684\u540d\u79f0\uff0c\u5c31\u50cf\u4e0a\u9762\u7684\u793a\u4f8b\u4e00\u6837\u3002</li> <li><code>name</code> \u5173\u952e\u5b57\u7684\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5b9a\u4e49\u7684CI\u53d8\u91cf\uff0c\u5305\u62ec\u9884\u5b9a\u4e49\u7684\u53d8\u91cf\u3001\u5b89\u5168\u53d8\u91cf\u3001\u4ee5\u53ca <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u4f46\u4e0d\u80fd\u4f7f\u7528 <code>script</code> \u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf(\u56e0\u4e3a\u8fd9\u91cc\u9762\u7684\u53d8\u91cf\u662f\u5c40\u90e8\u53d8\u91cf)\u3002</li> <li><code>environment</code> \u73af\u5883\u7684\u540d\u79f0\u53ef\u4ee5\u5305\u542b\uff1a\u82f1\u6587\u5b57\u6bcd(letters)\u3001\u6570\u5b57(digits)\u3001\u7a7a\u683c(space)\u3001<code>_</code>\u3001<code>/</code>\u3001<code>$</code>\u3001<code>{</code>\u3001<code>}</code> \u7b49\u3002\u5e38\u7528\u7684\u540d\u79f0\u6709\uff1a <code>qa</code>\u3001 <code>staging</code> \u3001<code>production</code> \u3002</li> </ul> <p>\u6ce8\u610f\uff1a</p> <ul> <li>\u8f6f\u4ef6\u5e94\u7528\u5f00\u53d1\u7684\u7ecf\u5178\u6a21\u578b\u6709\u8fd9\u6837\u51e0\u4e2a\u73af\u5883\uff1a\u5f00\u53d1\u73af\u5883(development)\u3001\u96c6\u6210\u73af\u5883(integration)\u3001\u6d4b\u8bd5\u73af\u5883(testing)\u3001QA\u9a8c\u8bc1\uff0c\u6a21\u62df\u73af\u5883(staging)\u3001\u751f\u4ea7\u73af\u5883(production)\u3002</li> <li>\u901a\u5e38\u4e00\u4e2aweb\u9879\u76ee\u90fd\u9700\u8981\u4e00\u4e2astaging\u73af\u5883\uff0c\u4e00\u6765\u7ed9\u5ba2\u6237\u505a\u6f14\u793a\uff0c\u4e8c\u6765\u53ef\u4ee5\u4f5c\u4e3aproduction server\u7684\u4e00\u4e2a\u201d\u9884\u6f14\u201d\uff0c\u6b63\u5f0f\u53d1\u5e03\u65b0\u529f\u80fd\u524d\u80fd\u53ca\u65e9\u53d1\u73b0\u95ee\u9898\uff08\u7279\u522b\u662fgem\u7684\u4f9d\u8d56\u95ee\u9898\uff0c\u73af\u5883\u95ee\u9898\u7b49\uff09\u3002</li> <li>staging server\u53ef\u4ee5\u7406\u89e3\u4e3aproduction\u73af\u5883\u7684\u955c\u50cf\uff0cQA\u5728staging server\u4e0a\u5bf9\u65b0\u7248\u672c\u505a\u6700\u540e\u4e00\u8f6everification, \u901a\u8fc7\u540e\u624d\u80fddeploy\u5230\u4ea7\u54c1\u7ebf\u4e0a\u3002staging\u73af\u5883 \u5c3d\u6700\u5927\u53ef\u80fd\u6765\u6a21\u62df\u4ea7\u54c1\u7ebf\u4e0a\u7684\u73af\u5883(\u786c\u4ef6\uff0c\u7f51\u7edc\u62d3\u6251\u7ed3\u6784\uff0c\u6570\u636e\u5e93\u6570\u636e)\u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#environmenturl","title":"<code>environment:url</code>","text":"<ul> <li><code>environment:url</code> \u662f\u53ef\u9009\u7684\uff0c\u7528\u4e8e\u8bbe\u7f6e\u73af\u5883\u7684URL\u5730\u5740\u7684\u6309\u94ae\uff0c\u901a\u8fc7\u70b9\u51fb\u6309\u94ae\u53ef\u4ee5\u8bbf\u95ee\u73af\u5883\u76f8\u5e94\u7684URL\u5730\u5740\u3002</li> <li>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c\u4f5c\u4e1a\u90fd\u6210\u529f\u5b8c\u6210\uff0c\u90a3\u4e48\u4f1a\u5728 <code>\u8bc4\u5ba1\u8bf7\u6c42</code> \u548c <code>\u73af\u5883\u90e8\u7f72</code> \u9875\u9762\u521b\u5efa\u4e00\u4e2aButton\u6309\u94ae\uff0c\u4f60\u70b9\u51fb <code>\u6253\u5f00\u8fd0\u884c\u4e2d\u7684\u73af\u5883</code> \u6309\u94ae\u5c31\u53ef\u4ee5\u8bbf\u95ee\u73af\u5883\u5bf9\u5e94\u7684URL\u5730\u5740 <code>https://prod.example.com</code> \u3002</li> </ul> <p>\u793a\u4f8b:</p> <pre><code>deploy to production:\n  stage: deploy\n  script: git push production HEAD:master\n  environment:\n    name: production\n    url: https://prod.example.com\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#environmenton_stop-environmentaction","title":"<code>environment:on_stop</code> \u4e0e <code>environment:action</code>","text":"<ul> <li><code>environment:on_stop</code> \u4e0e <code>environment:action</code> \u914d\u5408\u4f7f\u7528\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7 <code>environment:on_stop</code> \u5173\u952e\u5b57\u5b9a\u4e49\u4e00\u4e2a\u5173\u95ed(\u505c\u6b62)\u73af\u5883\u7684\u4f5c\u4e1a\u3002</li> <li><code>action</code> \u5173\u952e\u5b57\u5728\u5173\u95ed\u73af\u5883\u7684\u4f5c\u4e1a\u4e2d\u5b9a\u4e49\u3002</li> </ul> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u8054\u5408\u4f7f\u7528 <code>environment:on_stop</code> \u4e0e <code>environment:action</code> \u6765\u5173\u95ed\u73af\u5883\uff1a</p> <pre><code>review_app:\n  stage: deploy\n  script: make deploy-app\n  environment:\n    name: review\n    on_stop: stop_review_app\n\nstop_review_app:\n  stage: deploy\n  script: make delete-app\n  when: manual\n  environment:\n    name: review\n    action: stop\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u8bbe\u7f6e <code>review_app</code> \u4f5c\u4e1a\u7528\u4e8e\u90e8\u7f72\u4ee3\u7801\u5230 <code>review</code> \u8bc4\u5ba1\u73af\u5883\u4e2d\uff0c\u540c\u65f6\u5728 <code>on_stop</code> \u4e2d\u6307\u5b9a\u4e86 <code>stop_review_app</code> \u4f5c\u4e1a\u3002\u4e00\u65e6 <code>review_app</code> \u4f5c\u4e1a\u6210\u529f\u6267\u884c\uff0c\u5c31\u4f1a\u89e6\u53d1 <code>when</code> \u5173\u952e\u5b57\u5b9a\u4e49\u7684 <code>stop_review_app</code> \u4f5c\u4e1a\u3002\u901a\u8fc7\u8bbe\u7f6e\u4e3a <code>manual</code> \u624b\u52a8\uff0c\u9700\u8981\u5728GitLab WEB\u754c\u9762\u70b9\u51fb\u6765\u5141\u8bb8 <code>manual action</code> \u3002</p> <p><code>stop_review_app</code> \u4f5c\u4e1a\u5fc5\u987b\u914d\u5408\u5b9a\u4e49\u4ee5\u4e0b\u5173\u952e\u5b57\uff1a</p> <ul> <li><code>when</code> \uff1a \u4f55\u65f6\u6267\u884c\u5220\u9664\u6216\u505c\u6b62\u73af\u5883\u4f5c\u4e1a</li> <li><code>environment:name</code> \uff1a \u73af\u5883\u540d\u79f0\u9700\u8981\u4e0e\u4e0a\u9762\u7684 <code>review_app</code> \u4f5c\u4e1a\u4fdd\u6301\u4e00\u81f4\uff0c\u5373 <code>review</code> \u8bc4\u5ba1\u73af\u5883</li> <li><code>environment:action</code> \uff1a\u6267\u884c\u4f55\u79cd\u6267\u884c\uff0c<code>stop</code> \u505c\u6b62\u73af\u5883</li> <li><code>stage</code> \uff1a\u4e0e <code>review_app</code> \u4f5c\u4e1a\u7684\u9636\u6bb5\u4fdd\u6301\u4e00\u81f4\uff0c\u90fd\u662f <code>deploy</code></li> </ul> <p>\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u5728 <code>stop_review_app</code> \u4f5c\u4e1a\u754c\u9762\u9700\u8981\u624b\u52a8\u70b9\u51fb <code>\u505c\u6b62\u5f53\u524d\u73af\u5883</code> \u624d\u80fd\u542f\u52a8 <code>stop_review_app</code> \u4f5c\u4e1a\u7684\u6267\u884c\u3002 <code>stop_review_app</code> \u4f5c\u4e1a\u6267\u884c\u5b8c\u6210\u540e\uff0c\u4f1a\u505c\u6b62 <code>review</code> \u8bc4\u5ba1\u73af\u5883\uff0c\u5728 <code>\u73af\u5883</code> \u2013&gt; <code>\u5df2\u505c\u6b62</code> \u5217\u8868\u4e2d\u53ef\u4ee5\u770b\u5230 <code>review</code> \u8bc4\u5ba1\u73af\u5883\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#dynamic-environments","title":"Dynamic environments \u52a8\u6001\u73af\u5883","text":"<p>\u6b63\u5982\u524d\u9762\u8bb2\u89e3\u7684\uff0c\u53ef\u4ee5\u5728\u73af\u5883\u7684\u540d\u79f0\u4e2d\u4f7f\u7528\u53d8\u91cf\uff0c\u5728 <code>environment:name</code> \u548c <code>environment:url</code> \u4e2d\u4f7f\u7528\u53d8\u91cf\uff0c\u5219\u53ef\u4ee5\u8fbe\u5230\u52a8\u6001\u73af\u5883\u7684\u76ee\u7684\uff0c\u52a8\u6001\u73af\u5883\u9700\u8981\u5e95\u5c42\u5e94\u7528\u7684\u652f\u6301\u3002</p> <p>\u6211\u4eec\u4e0d\u8be6\u7ec6\u5c55\u5f00\uff0c\u4e0b\u9762\u662f\u5b98\u65b9\u7684\u4e00\u4e2a\u793a\u4f8b\u7684\u6539\u7248:</p> <pre><code>deploy as review app:\n  stage: deploy\n  script: make deploy\n  environment:\n    name: review/${CI_COMMIT_REF_NAME}\n    url: https://${CI_ENVIRONMENT_SLUG}.example.com/\n</code></pre> <p>\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 <code>${CI_COMMIT_REF_NAME}</code> <code>${CI_ENVIRONMENT_SLUG}</code> \u5c31\u662f\u4e24\u4e2a\u53d8\u91cf\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#cache","title":"<code>cache</code>","text":"<ul> <li><code>GitLab Runner v0.7.0</code> \u5f15\u5165 <code>cache</code> \u7f13\u5b58\u673a\u5236\u3002</li> <li><code>cache</code> \u7f13\u5b58\u673a\u5236\uff0c\u53ef\u4ee5\u5728\u5168\u5c40\u8bbe\u7f6e\u6216\u8005\u6bcf\u4e2a\u4f5c\u4e1a\u4e2d\u8bbe\u7f6e\u3002</li> <li>\u4ece <code>GitLab 9.0</code> \u5f00\u59cb\uff0c <code>cache</code> \u7f13\u5b58\u673a\u5236\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u7684\u6d41\u6c34\u7ebf\u6216\u4f5c\u4e1a\u4e4b\u95f4\u5171\u4eab\u6570\u636e\u3002</li> <li>\u4ece <code>GitLab 9.2</code> \u5f00\u59cb\uff0c \u5728 <code>artifacts</code> \u5de5\u4ef6\u4e4b\u524d\u6062\u590d\u7f13\u5b58\u3002</li> <li><code>cache</code> \u7f13\u5b58\u673a\u5236\u7528\u4e8e\u6307\u5b9a\u4e00\u7cfb\u5217\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u5728\u4e0d\u540c\u7684\u6d41\u6c34\u7ebf\u6216\u4f5c\u4e1a\u4e4b\u95f4\u5171\u4eab\u6570\u636e\uff0c\u4ec5\u80fd\u4f7f\u7528\u9879\u76ee\u5de5\u4f5c\u7a7a\u95f4( <code>project workspace</code> )\u4e2d\u7684\u8def\u5f84\u4f5c\u4e3a\u7f13\u5b58\u7684\u8def\u5f84\u3002</li> <li><code>\u5982\u679c ``cache</code> \u914d\u7f6e\u7684\u8def\u5f84\u662f\u4f5c\u4e1a\u5de5\u4f5c\u7a7a\u95f4\u5916\u90e8\uff0c\u5219\u8bf4\u660e\u914d\u7f6e\u662f\u5168\u5c40\u7684\u7f13\u5b58\uff0c\u6240\u6709\u4f5c\u4e1a\u5171\u4eab\u3002</li> <li>\u8bbf\u95ee Cache dependencies in GitLab CI/CD \u6587\u6863\u6765\u83b7\u53d6\u7f13\u5b58\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u4ee5\u53ca\u597d\u7684\u5b9e\u8df5\u5b9e\u4f8b\u7684\u4f8b\u5b50\u3002</li> <li><code>cache</code> \u7f13\u5b58\u673a\u5236\u7684\u5176\u4ed6\u4ecb\u7ecd\u8bf7\u53c2\u8003 https://docs.gitlab.com/ce/ci/yaml/README.html#cache \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifacts","title":"<code>artifacts</code>","text":"<ul> <li><code>artifacts</code> \u7528\u4e8e\u6307\u5b9a\u5728\u4f5c\u4e1a\u6210\u529f\u3001\u5931\u8d25\u3001\u6216\u8005\u4e00\u76f4\u7b49\u72b6\u6001\u4e0b\u65f6\uff0c\u4e00\u7cfb\u5217\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u9644\u52a0\u5230\u4f5c\u4e1a\u4e2d\u3002<code>artifacts</code> \u53ef\u4ee5\u79f0\u4e3a <code>\u5de5\u4ef6``\u6216\u8005 ``\u5f52\u6863\u6587\u4ef6</code> \u3002</li> <li>\u4f5c\u4e1a\u5b8c\u6210\u540e\uff0c\u5de5\u4ef6\u88ab\u53d1\u9001\u5230GitLab\uff0c\u53ef\u4ee5\u5728GitLab Web\u754c\u9762\u4e0b\u8f7d\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u6210\u529f\u7684\u4f5c\u4e1a\u624d\u4f1a\u751f\u6210\u5de5\u4ef6\u3002</li> <li>\u5e76\u4e0d\u662f\u6240\u6709\u7684 <code>executor</code> \u6267\u884c\u5668\u90fd\u652f\u6301\u5de5\u4ef6\u3002</li> <li>\u5de5\u4ef6\u7684\u8be6\u7ec6\u4ecb\u7ecd\u53ef\u53c2\u8003 Introduction to job artifacts</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactspaths","title":"<code>artifacts:paths</code>","text":"<ul> <li><code>artifacts:paths</code> \u7528\u4e8e\u6307\u5b9a\u54ea\u4e9b\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u4f1a\u88ab\u6253\u5305\u6210\u5de5\u4ef6\uff0c\u4ec5\u4ec5\u9879\u76ee\u5de5\u4f5c\u7a7a\u95f4( <code>project workspace</code> )\u7684\u8def\u5f84\u53ef\u4ee5\u4f7f\u7528\u3002</li> <li>\u8981\u5728\u4e0d\u540c\u4f5c\u4e1a\u95f4\u4f20\u9012\u5de5\u4f5c\uff0c\u8bf7\u53c2\u6570 dependencies</li> </ul> <p>\u4e0b\u9762\u793a\u4f8b\uff0c\u5c06\u76ee\u5f55 <code>binaries/</code> \u548c\u6587\u4ef6 <code>.config</code> \u6253\u5305\u6210\u5de5\u4ef6\uff1a</p> <pre><code>artifacts:\n  paths:\n    - binaries/\n    - .config\n</code></pre> <p>\u8981\u7981\u7528\u5de5\u4ef6\u4f20\u9012\uff0c\u8bf7\u4f7f\u7528\u7a7a\u4f9d\u8d56\u5173\u7cfb\u5b9a\u4e49\u4f5c\u4e1a\uff1a</p> <pre><code>job:\n  stage: build\n  script: make build\n  dependencies: []\n</code></pre> <p>\u4f60\u53ef\u4ee5\u4ec5\u4e3a\u6253\u6807\u8bb0\u7684release\u53d1\u5e03\u7248\u672c\u521b\u5efa\u5de5\u4f5c\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u4e34\u65f6\u6784\u5efa\u4ea7\u751f\u5927\u91cf\u7684\u5b58\u50a8\u9700\u6c42\uff1a</p> <pre><code>default-job:\n  script:\n    - mvn test -U\n  except:\n    - tags\n\nrelease-job:\n  script:\n    - mvn package -U\n  artifacts:\n    paths:\n      - target/*.war\n  only:\n    - tags\n</code></pre> <p>\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>default-job</code> \u4f5c\u4e1a\u4e0d\u4f1a\u5728\u6253\u6807\u8bb0\u7684release\u53d1\u5e03\u7248\u672c\u4e2d\u6267\u884c\uff0c\u800c <code>release-job</code> \u53ea\u4f1a\u5728\u6253\u6807\u8bb0\u7684release\u53d1\u5e03\u7248\u672c\u6267\u884c\uff0c\u5e76\u4e14\u5c06 <code>target/*.war</code> \u6253\u5305\u6210\u5de5\u4ef6\u4ee5\u4f9b\u4e0b\u8f7d\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactsname","title":"<code>artifacts:name</code>","text":"<ul> <li>\u5de5\u4ef6\u7684\u9ed8\u8ba4\u540d\u79f0\u662f <code>artifacts</code> \uff0c\u5f53\u4e0b\u8f7d\u65f6\u540d\u79f0\u662f <code>artifacts.zip</code> \u3002</li> <li>\u901a\u8fc7 <code>artifacts:name</code> \u5173\u952e\u5b57\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5de5\u4ef6\u7684\u5f52\u6863\u540d\u79f0\uff0c\u8fd9\u6837\u4f60\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u5de5\u4ef6\u8bbe\u7f6e\u72ec\u4e00\u65e0\u4e8c\u7684\u540d\u79f0\uff0c\u5f52\u6863\u540d\u79f0\u53ef\u4ee5\u4f7f\u7528\u9884\u5b9a\u4e49\u7684\u53d8\u91cf\u3002</li> <li>\u5982\u679c\u5206\u652f\u540d\u79f0\u4e2d\u5305\u542b\u659c\u6760(\u6bd4\u5982 <code>feature/my-feature</code> )\uff0c\u63a8\u8350\u4f7f\u7528 <code>$CI_COMMIT_REF_SLUG</code> \u4ee3\u66ff <code>$CI_COMMIT_REF_NAME</code> \u4f5c\u4e3a\u5de5\u4ef6\u540d\u79f0\u3002</li> </ul> <p>\u4f7f\u7528\u4f5c\u4e1a\u540d\u79f0\u4f7f\u7528\u5de5\u4ef6\u540d\u79f0\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u4f7f\u7528\u5f53\u524d\u5206\u652f\u6216tag\u7248\u672c\u6807\u7b7e\u540d\u4f5c\u4e3a\u5de5\u4ef6\u540d\u79f0\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u540c\u65f6\u4f7f\u7528\u5f53\u524d\u4f5c\u4e1a\u540d\u79f0\u4ee5\u53ca\u5f53\u524d\u5206\u652f\u6216tag\u7248\u672c\u6807\u7b7e\u540d\u4f5c\u4e3a\u5de5\u4ef6\u540d\u79f0\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_NAME-$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u540c\u65f6\u4f7f\u7528\u5f53\u524d\u4f5c\u4e1a\u9636\u6bb5\u540d\u79f0\u4ee5\u53ca\u5f53\u524d\u5206\u652f\u540d\u79f0\u4f5c\u4e3a\u5de5\u4ef6\u540d\u79f0\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_STAGE-$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u5982\u679c\u4f60\u4f7f\u7528\u7684 Windows\u7cfb\u7edf\u7684Batch\u6279\u5904\u7406\u811a\u672c \uff0c\u5219\u9700\u8981\u628a <code>$</code> \u66ff\u6362\u6210 <code>%</code>\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"%CI_JOB_STAGE%-%CI_COMMIT_REF_NAME%\"\n    paths:\n      - binaries/\n</code></pre> <p>\u5982\u679c\u4f60\u4f7f\u7528\u7684 Windows\u7cfb\u7edf\u7684PowerShell\u811a\u672c \uff0c\u5219\u9700\u8981\u628a <code>$</code> \u66ff\u6362\u6210 <code>$env:</code>\uff1a</p> <pre><code>job:\n  artifacts:\n    name: \"$env:CI_JOB_STAGE-$env:CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactsuntracked","title":"<code>artifacts:untracked</code>","text":"<ul> <li><code>artifacts:untracked</code> \u7528\u4e8e\u5c06git\u672a\u52a0\u5165\u7248\u672c\u5e93\u7684\u6587\u4ef6\u4f5c\u4e3a\u5de5\u4ef6\u6587\u4ef6\u3002</li> <li><code>artifacts:untracked</code> \u5c06\u4f1a\u5ffd\u7565\u914d\u7f6e\u6587\u4ef6 <code>.gitignore</code>\u3002</li> </ul> <p>\u5c06\u6240\u6709\u7684\u672a\u8ddf\u8e2a\u6587\u4ef6\u6253\u5305\u6210\u5de5\u4ef6\uff1a</p> <pre><code>    artifacts:\n      untracked: true\n</code></pre> <p>\u5c06\u6240\u6709\u7684\u672a\u8ddf\u8e2a\u6587\u4ef6\u4ee5\u53ca\u76ee\u5f55 <code>binaries</code> \u4e2d\u6587\u4ef6\u6253\u5305\u6210\u5de5\u4ef6\uff1a</p> <pre><code>artifacts:\n  untracked: true\n  paths:\n    - binaries/\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactswhen","title":"<code>artifacts:when</code>","text":"<ul> <li><code>artifacts:when</code> \u7528\u4e8e\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u6216\u8005\u5ffd\u7565\u5931\u8d25\u65f6\u4e0a\u4f20\u5de5\u4ef6\u3002</li> </ul> <p><code>artifacts:when</code> \u53ef\u4ee5\u8bbe\u7f6e\u4ee5\u4e0b\u503c\uff1a</p> <ul> <li><code>on_success</code> \uff0c\u9ed8\u8ba4\u503c\uff0c\u5f53\u4f5c\u4e1a\u6210\u529f\u4e0a\u4f20\u5de5\u4ef6\u3002</li> <li><code>on_failure</code> \uff0c\u5f53\u4f5c\u4e1a\u5931\u8d25\u4e0a\u4f20\u5de5\u4ef6\u3002</li> <li><code>always</code> \uff0c\u65e0\u8bba\u4f5c\u4e1a\u662f\u5426\u6210\u529f\u4e00\u76f4\u4e0a\u4f20\u5de5\u4ef6\u3002</li> </ul> <p>\u5f53\u4f5c\u4e1a\u5931\u8d25\u65f6\uff0c\u4e0a\u4f20\u5de5\u4ef6\uff1a</p> <pre><code>job:\n  artifacts:\n    when: on_failure\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactsexpire_in","title":"<code>artifacts:expire_in</code>","text":"<ul> <li><code>artifacts:expire_in</code> \u7528\u4e8e\u8bbe\u7f6e\u5de5\u4ef6\u7684\u8fc7\u671f\u65f6\u95f4\u3002</li> <li>\u4f60\u53ef\u4ee5\u70b9\u51fb\u754c\u9762\u4e0a\u7684 <code>Keep</code> \u4fdd\u6301\u6309\u94ae\uff0c\u6c38\u4e45\u4fdd\u5b58\u5de5\u4ef6\u3002</li> <li>\u5de5\u4ef6\u5230\u671f\u540e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6bcf\u5c0f\u65f6\u5220\u9664\u4e00\u6b21\u5de5\u4ef6(\u901a\u8fc7cron\u4f5c\u4e1a)\uff0c\u5e76\u4e14\u540e\u7eed\u4e0d\u80fd\u518d\u8bbf\u95ee\u8be5\u5de5\u4ef6\u3002</li> <li>\u5de5\u4ef6\u9ed8\u8ba4\u6709\u6548\u671f\u662f30\u5929\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>Admin area</code> \u2013&gt; <code>Settings</code> \u2013&gt; <code>Continuous Integration and Deployment</code> \u8bbe\u7f6e\u9ed8\u8ba4\u7684\u6709\u6548\u6027\u65f6\u95f4\u3002</li> <li>\u5982\u679c\u4f60\u4e0d\u63d0\u4f9b\u65f6\u95f4\u5355\u4f4d\u7684\u8bdd\uff0c\u5de5\u4f5c\u6709\u6548\u6027\u7684\u65f6\u95f4\u662f\u4ee5\u79d2\u4e3a\u5355\u4f4d\u7684\u65f6\u95f4\uff0c\u4e0b\u9762\u662f\u4e00\u4e9b\u793a\u4f8b\uff1a</li> </ul> <ul> <li><code>42</code></li> <li><code>3 mins 4 sec</code></li> <li><code>2 hrs 20 min</code></li> <li><code>2h20min</code></li> <li><code>6 mos 1 day</code></li> <li><code>47 yrs 6 mos and 4d</code></li> <li><code>3 weeks and 2 days</code></li> </ul> <p>\u4e0b\u9762\u793a\u4f8b\u4e2d\u5de5\u4ef6\u6709\u6548\u671f\u4e3a\u4e00\u5468\uff1a</p> <pre><code>job:\n  artifacts:\n    expire_in: 1 week\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#artifactsreports","title":"<code>artifacts:reports</code>","text":"<ul> <li><code>artifacts:reports</code> \u7528\u4e8e\u6536\u96c6\u6d4b\u8bd5\u62a5\u544a(report)\uff0c\u5e76\u5728GitLab UI\u754c\u9762\u4e2d\u663e\u793a\u51fa\u6765\u3002</li> <li>\u65e0\u8bba\u4f5c\u4e1a\u662f\u5426\u6210\u529f\uff0c\u90fd\u4f1a\u6536\u96c6\u6d4b\u8bd5\u62a5\u544a\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u5de5\u4ef6\u7684\u6253\u5305\u8def\u5f84 <code>artifacts:paths</code> \u6dfb\u52a0\u6d4b\u8bd5\u7684\u62a5\u544a\u8f93\u51fa\u6587\u4ef6\u3002</li> <li><code>artifacts:reports:junit</code> \u53ef\u4ee5\u7528\u6765\u6536\u96c6\u5355\u5143\u6d4b\u8bd5\u7684\u62a5\u544a\uff0c\u67e5\u770b JUnit test reports \u83b7\u53d6\u66f4\u8be6\u7ec6\u7684\u4fe1\u606f\u548c\u793a\u4f8b\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4eceRuby\u7684RSpec\u6d4b\u8bd5\u5de5\u5177\u4e2d\u6536\u96c6JUnit XML\u6587\u4ef6\u7684\u793a\u4f8b\uff1a</p> <pre><code>rspec:\n  stage: test\n  script:\n  - bundle install\n  - rspec --format RspecJunitFormatter --out rspec.xml\n  artifacts:\n    reports:\n      junit: rspec.xml\n</code></pre> <p>\u5982\u679c\u4f60\u7684\u6d4b\u8bd5\u62a5\u544a\u662f\u591a\u4e2aXML\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u5728\u4e00\u4e2a\u4f5c\u4e1a\u4e2d\u6307\u5b9a\u591a\u4e2a\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\uff0cGitLab\u4f1a\u81ea\u52a8\u5c06\u4ed6\u4eec\u8f6c\u6362\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u53ef\u4ee5\u50cf\u4e0b\u9762\u8fd9\u6837\u8868\u793a\u62a5\u544a\u7684\u8def\u5f84\uff1a</p> <ul> <li>\u6587\u4ef6\u5339\u914d\u6a21\u5f0f: <code>junit: rspec-*.xml</code></li> <li>\u6587\u4ef6\u5217\u8868: <code>junit: [rspec-1.xml, rspec-2.xml, rspec-3.xml]</code></li> <li>\u6df7\u5408\u6a21\u5f0f\uff1a<code>junit: [rspec.xml, test-results/TEST-*.xml]</code></li> </ul> <p>\u4e0b\u9762\u662fGo\u8bed\u8a00\u6536\u96c6JUnit XML\u6587\u4ef6\u7684\u793a\u4f8b\uff1a</p> <pre><code>## Use https://github.com/jstemmer/go-junit-report to generate a JUnit report with go\ngolang:\n  stage: test\n  script:\n  - go get -u github.com/jstemmer/go-junit-report\n  - go test -v 2&gt;&amp;1 | go-junit-report &gt; report.xml\n  artifacts:\n    reports:\n      junit: report.xml\n</code></pre> <p>\u4e0b\u9762\u662fC/C++\u8bed\u8a00\u4f7f\u7528GoogleTest\u8fdb\u884c\u5355\u5143\u6d4b\u8bd5\uff0c\u6536\u96c6JUnit XML\u6587\u4ef6\u7684\u793a\u4f8b\uff1a</p> <pre><code>cpp:\n  stage: test\n  script:\n  - gtest.exe --gtest_output=\"xml:report.xml\"\n  artifacts:\n    reports:\n      junit: report.xml\n</code></pre> <p>\u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u62a5\u544a\u5173\u952e\u5b57\uff0c\u4f46\u793e\u533a\u7248\u4e0d\u53ef\u7528\uff0c\u5ffd\u7565\u4e0d\u63d0\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#dependencies","title":"<code>dependencies</code>","text":"<ul> <li><code>dependencies</code> \u4f9d\u8d56\u5173\u952e\u5b57\u5e94\u8be5\u4e0e <code>artifacts</code> \u5de5\u4ef6\u5173\u952e\u5b57\u8054\u5408\u4f7f\u7528\uff0c\u5141\u8bb8\u4f60\u5728\u4e0d\u540c\u4f5c\u4e1a\u95f4\u4f20\u9012\u5de5\u4ef6\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f1a\u4f20\u9012\u6240\u6709\u672c\u4f5c\u4e1a\u4e4b\u524d\u9636\u6bb5\u7684\u6240\u6709\u5de5\u4ef6\u3002</li> <li>\u9700\u8981\u5728\u4f5c\u4e1a\u4e0a\u4e0b\u6587\u4e2d\u5b9a\u4e49 <code>dependencies</code> \u4f9d\u8d56\u5173\u952e\u5b57\uff0c\u5e76\u6307\u51fa\u6240\u6709\u9700\u8981\u4f7f\u7528\u7684\u524d\u5e8f\u5de5\u4ef6\u7684\u4f5c\u4e1a\u540d\u79f0\u5217\u8868\u3002 \u4f5c\u4e1a\u5217\u8868\u4e2d\u4e0d\u80fd\u4f7f\u7528\u8be5\u4f5c\u4e1a\u540e\u7684\u4f5c\u4e1a\u540d\u79f0 \u3002</li> <li>\u5b9a\u4e49\u7a7a\u7684\u4f9d\u8d56\u9879\uff0c\u5c06\u4e0b\u4e0d\u4f1a\u4e0b\u8f7d\u4efb\u4f55\u5de5\u4ef6\u3002</li> <li>\u4f7f\u7528\u4f9d\u8d56\u9879\u4e0d\u4f1a\u8003\u8651\u524d\u9762\u4f5c\u4e1a\u7684\u8fd0\u884c\u72b6\u6001\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>build:osx:\n  stage: build\n  script: make build:osx\n  artifacts:\n    paths:\n      - binaries/\n\nbuild:linux:\n  stage: build\n  script: make build:linux\n  artifacts:\n    paths:\n      - binaries/\n\ntest:osx:\n  stage: test\n  script: make test:osx\n  dependencies:\n    - build:osx\n\ntest:linux:\n  stage: test\n  script: make test:linux\n  dependencies:\n    - build:linux\n\ndeploy:\n  stage: deploy\n  script: make deploy\n</code></pre> <p>\u4e0a\u9762\u793a\u4f8b\u4e2d\uff0c <code>build:osx</code> \u548c <code>build:linux</code> \u4e24\u4e2a\u4f5c\u4e1a\u5b9a\u4e49\u4e86\u5de5\u4ef6\uff0c <code>test:osx</code> \u4f5c\u4e1a\u6267\u884c\u65f6\uff0c\u5c06\u4f1a\u4e0b\u8f7d\u5e76\u89e3\u538b <code>build:osx</code> \u7684\u5de5\u4ef6\u5185\u5bb9\u3002\u76f8\u5e94\u7684\uff0c <code>test:linux</code> \u4e5f\u4f1a\u83b7\u53d6 <code>build:linux</code> \u7684\u5de5\u4ef6\u3002 <code>deploy</code> \u4f5c\u4e1a\u4f1a\u4e0b\u8f7d\u5168\u90e8\u5de5\u4ef6\u3002</p> <p>\u5982\u679c\u4f5c\u4e3a\u4f9d\u8d56\u7684\u4f5c\u4e1a\u7684\u5de5\u4ef6\u8fc7\u671f\u6216\u8005\u88ab\u5220\u9664\uff0c\u90a3\u4e48\u4f9d\u8d56\u8fd9\u4e2a\u4f5c\u4e1a\u7684\u4f5c\u4e1a\u5c06\u4f1a\u5931\u8d25\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#coverage","title":"<code>coverage</code>","text":"<ul> <li><code>coverage</code> \u53ef\u4ee5\u4ece\u4f5c\u4e1a\u7684\u8f93\u51falog\u4e2d\u63d0\u53d6\u4ee3\u7801\u8986\u76d6\u7387\u3002</li> <li>\u4ec5\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\u65b9\u5f0f\u83b7\u53d6\u8986\u76d6\u7387\u3002</li> <li>\u5b57\u7b26\u4e32\u7684\u524d\u540e\u5fc5\u987b\u4f7f\u7528/\u5305\u542b\u6765\u8868\u660e\u4e00\u4e2a\u6b63\u786e\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u89c4\u5219\u3002\u7279\u6b8a\u5b57\u7b26\u4e32\u9700\u8981\u8f6c\u4e49\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p> <pre><code>job1:\n  coverage: '/Code coverage:\\d+\\.\\d+%/'\n</code></pre> <p>\u5982\u5728\u4f5c\u4e1a\u65e5\u5fd7\u4e2d\u8f93\u51fa\u4e86 <code>Code coverage:80.2%</code>\uff0c\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u4ee3\u7801\u7684\u8986\u76d6\u7387\u3002\u7136\u540e\u5728\u4f5c\u4e1a\u7684\u53f3\u4e0a\u89d2\u5904\u5c31\u4f1a\u663e\u793a <code>Coverage:80.2%</code> \u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#retry","title":"<code>retry</code>","text":"<ul> <li><code>retry</code> \u91cd\u8bd5\u5173\u952e\u5b57\u7528\u4e8e\u914d\u7f6e\u5f53\u4f5c\u4e1a\u5931\u8d25\u65f6\u53ef\u4ee5\u91cd\u65b0\u6267\u884c\u7684\u6b21\u6570\u3002</li> <li>\u5f53\u4f5c\u4e1a\u5931\u8d25\u65f6\uff0c\u5982\u679c\u914d\u7f6e\u4e86 <code>retry</code> \uff0c\u90a3\u4e48\u8be5\u4f5c\u4e1a\u5c31\u4f1a\u91cd\u8bd5\uff0c\u76f4\u5230\u5141\u8bb8\u7684\u6700\u5927\u6b21\u6570\u3002</li> <li>\u5982\u679c <code>retry</code> \u8bbe\u7f6e\u503c\u4e3a2\uff0c\u5982\u679c\u7b2c\u4e00\u6b21\u91cd\u8bd5\u8fd0\u884c\u6210\u529f\u4e86\uff0c\u90a3\u4e48\u5c31\u4e0d\u4f1a\u8fdb\u884c\u7b2c\u4e8c\u6b21\u91cd\u8bd5\u3002</li> <li><code>retry</code> \u8bbe\u7f6e\u503c\u53ea\u80fd\u662f0\u30011\u30012\u4e09\u4e2a\u6574\u6570\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p> <pre><code>test:\n  script: rspec\n  retry: 2\n</code></pre> <ul> <li>\u4e3a\u4e86\u66f4\u597d\u7684\u63a7\u5236\u91cd\u8bd5\u6b21\u6570\uff0c<code>retry</code> \u53ef\u4ee5\u8bbe\u7f6e\u4ee5\u4e0b\u4e24\u4e2a\u5173\u952e\u5b57\uff1a</li> </ul> <ul> <li><code>max</code> : \u6700\u5927\u91cd\u8bd5\u6b21\u6570</li> <li><code>when</code> : \u4f55\u65f6\u91cd\u8bd5</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u53ea\u6709\u5f53\u8fd0\u884c\u5668\u7cfb\u7edf\u51fa\u73b0\u6545\u969c\u65f6\u624d\u80fd\u6700\u591a\u91cd\u8bd5\u4e24\u6b21\uff1a</p> <pre><code>test:\n  script: rspec\n  retry:\n    max: 2\n    when: runner_system_failure\n</code></pre> <p>\u5982\u679c\u4e0a\u9762\u4f8b\u5b50\u4e2d\u51fa\u73b0\u7684\u662f\u5176\u4ed6\u6545\u969c\uff0c\u90a3\u4e48\u4f5c\u4e1a\u4e0d\u4f1a\u91cd\u8bd5\u3002</p> <p>\u4e3a\u4e86\u9488\u5bf9\u591a\u79cd\u91cd\u8bd5\u60c5\u5f62\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u77e9\u9635\u5f62\u5f0f\u7f57\u5217\u51fa\u9519\u8bef\u60c5\u5f62\uff0c\u5982\u4e0b\u793a\u4f8b\uff1a</p> <pre><code>test:\n  script: rspec\n  retry:\n    max: 2\n    when:\n      - runner_system_failure\n      - stuck_or_timeout_failure\n</code></pre> <p><code>when</code> \u53ef\u4ee5\u662f\u4ee5\u4e0b\u503c\uff1a</p> <ul> <li><code>always</code> : \u4e00\u76f4\u91cd\u8bd5\uff0c\u9ed8\u8ba4\u503c\u3002</li> <li><code>unknown_failure</code> \uff1a\u5f53\u9519\u8bef\u672a\u77e5\u65f6\u91cd\u8bd5\u3002</li> <li><code>script_failure</code> \uff1a \u811a\u672c\u9519\u8bef\u65f6\u91cd\u8bd5\u3002</li> <li><code>api_failure</code> \uff1a API\u8c03\u7528\u9519\u8bef\u65f6\u91cd\u8bd5\u3002</li> <li><code>stuck_or_timeout_failure</code> \uff1a \u4f5c\u4e1a\u5361\u4fe1\u6216\u8d85\u65f6\u9519\u8bef\u65f6\u91cd\u8bd5\u3002</li> <li><code>runner_system_failure</code> \uff1a \u8fd0\u884c\u5668\u7cfb\u7edf\u9519\u8bef(\u5982\u8bbe\u7f6e\u5de5\u4f5c\u5931\u8d25)\u65f6\u91cd\u8bd5\u3002</li> <li><code>missing_dependency_failure</code> \uff1a \u4f9d\u8d56\u5de5\u4ef6\u4e22\u5931\u9519\u8bef\u65f6\u91cd\u8bd5\u3002</li> <li><code>runner_unsupported</code> \uff1a \u8fd0\u884c\u5668\u4e0d\u652f\u6301\u9519\u8bef\u65f6\u91cd\u8bd5\u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#trigger","title":"<code>trigger</code>","text":"<ul> <li><code>trigger</code> \u5173\u952e\u5b57\u7528\u4e8e\u591a\u9879\u76ee\u6d41\u6c34\u7ebf\u65f6\uff0c\u5b9a\u4e49\u4e0b\u6e38\u7684\u6d41\u6c34\u7ebf\u5de5\u7a0b\uff0c\u7531\u4e8e\u793e\u533a\u7248\u672c\u4e0d\u652f\u6301\u6b64\u529f\u80fd\uff0c\u4e0d\u8be6\u7ec6\u4ecb\u7ecd\u3002\u5177\u4f53\u53ef\u53c2\u8003 trigger</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#include","title":"<code>include</code>","text":"<ul> <li><code>include</code> \u5305\u542b\u5173\u952e\u5b57\u53ef\u4ee5\u5c06\u5176\u4ed6yaml\u6587\u4ef6\u8f7d\u5165\u5230\u5f53\u524d\u7684 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u8be6\u60c5\u8bf7\u67e5\u770b\u5b98\u7f51\u6307\u5bfc include</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#extends","title":"<code>extends</code>","text":"<ul> <li><code>extends</code> \u6269\u5c55\u7528\u4e8e\u5b9a\u4e49\u5f53\u524d\u4f5c\u4e1a\u4ece\u54ea\u91cc\u7ee7\u627f\u3002</li> <li>\u5b83\u662f\u4f7f\u7528YAML\u951a\u70b9\u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u66f4\u52a0\u7075\u6d3b\u3001\u53ef\u8bfb\u6027\u5f3a\u3002\u8be6\u60c5\u8bf7\u67e5\u770b\u5b98\u7f51\u6307\u5bfc extends</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#pages","title":"<code>pages</code>","text":"<ul> <li><code>pages</code> \u662f\u4e00\u9879\u7279\u6b8a\u5de5\u4f5c\uff0c\u7528\u4e8e\u5c06\u9759\u6001\u5185\u5bb9\u4e0a\u4f20\u5230GitLab\uff0c\u53ef\u7528\u4e8e\u4e3a\u60a8\u7684\u7f51\u7ad9\u63d0\u4f9b\u670d\u52a1\u3002\u8be6\u60c5\u8bf7\u67e5\u770b\u5b98\u7f51\u6307\u5bfc GitLab Pages</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#variables","title":"<code>variables</code>","text":"<ul> <li>\u5728 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u4ee5\u901a\u8fc7 <code>variables</code> \u5173\u952e\u5b57\u914d\u7f6e\u5168\u5c40\u53d8\u91cf\u6216\u8005\u4f5c\u4e1a\u7ea7\u7684\u5c40\u90e8\u53d8\u91cf\u3002</li> <li>\u5f53 <code>variables</code> \u5173\u952e\u5b57\u4f7f\u7528\u5728\u4f5c\u4e1a\u5c42\u7ea7\u65f6\uff0c\u5b83\u4f1a\u8986\u76d6\u5168\u5c40\u53d8\u91cf\u6216\u9884\u5b9a\u4e49\u53d8\u91cf\u3002</li> <li>\u53ef\u4ee5\u5728 <code>variables</code> \u5173\u952e\u5b57\u4e2d\u5b9a\u4e49\u975e\u654f\u611f\u6027\u914d\u7f6e\u3002</li> <li>\u5168\u5c40\u53d8\u91cf\u53ef\u4ee5\u5728\u5404\u4e2a\u4f5c\u4e1a\u4e2d\u4f5c\u4e1a\uff0c\u800c\u4f5c\u4e1a\u7ea7\u522b\u7684\u5c40\u90e8\u53d8\u91cf\u53ea\u80fd\u5728\u8be5\u4f5c\u4e1a\u4e2d\u4f7f\u7528\u3002</li> <li>\u53ef\u4ee5\u5728GitLab WEB\u754c\u9762\u5b9a\u4e49\u4e00\u4e9b\u654f\u611f\u6027\u914d\u7f6e\u53d8\u91cf\uff0c\u6216\u8005\u53ef\u80fd\u53d8\u52a8\u7684\u53d8\u91cf\u3002</li> <li>\u5728 <code>script</code> \u4e2d\u4f7f\u7528 <code>export</code> \u53ef\u4ee5\u5bfc\u51fa\u5f53\u524d\u53ef\u7528\u7684\u53d8\u91cf\u4fe1\u606f\u3002</li> <li>\u4f5c\u4e1a\u5185\u90e8\u4fee\u6539\u5168\u5c40\u53d8\u91cf\u53ea\u5bf9\u5f53\u524d\u4f5c\u7528\u751f\u6548\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u4f5c\u4e1a\u3002</li> <li>\u53ef\u4ee5\u4f7f\u7528\u8d4b\u503c\u8bed\u53e5\u5bf9\u5168\u5c40\u53d8\u91cf\u6216\u5c40\u90e8\u53d8\u91cf\u8fdb\u884c\u91cd\u65b0\u8d4b\u503c\u3002</li> </ul> <p>\u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\u5b9a\u4e49\u4e00\u4e2a\u5168\u5c40\u6570\u636e\u5e93\u7684URL\u5730\u5740\uff1a</p> <pre><code>variables:\n  DATABASE_URL: \"postgres://postgres@postgres/my_database\"\n</code></pre> <p>\u4e0b\u9762\u4fee\u6539 <code>bluelog</code> \u9879\u76ee\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\n# \u5b9a\u4e49\u5168\u5c40\u53d8\u91cf\nvariables:\n  # \u6570\u636e\u5e93\u4fe1\u606f\n  SQLALCHEMY_DATABASE_URI: 'mysql+pymysql://root:root@localhost:3306/bluelog?charset=utf8mb4'\n  # \u4e0d\u53d1\u9001\u8b66\u544a\u901a\u77e5\n  SQLALCHEMY_TRACK_MODIFICATIONS: \"False\"\n  # \u663e\u793a\u6267\u884cSQL\n  SQLALCHEMY_ECHO: \"True\"\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  variables:\n    # \u6570\u636e\u5e93\u4fe1\u606f\n    SQLALCHEMY_DATABASE_URI: 'mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4'\n    # \u4e0d\u663e\u793a\u6267\u884cSQL\n    SQLALCHEMY_ECHO: \"False\"\n  script:\n    - export\n    - echo \"Do your build here\"\n    - cloc --version\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  script:\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n    - SQLALCHEMY_ECHO=\"Nothing\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  variables:\n    # CKEditor\u5bcc\u6587\u672c\u8bbe\u7f6e\n    CKEDITOR_SERVE_LOCAL: \"True\"\n  script:\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n    - echo -e \"CKEDITOR_SERVE_LOCAL:${CKEDITOR_SERVE_LOCAL}\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u67e5\u770b\u5404\u9636\u6bb5\u7684\u8f93\u51fa\u5185\u5bb9\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230 <code>build1</code> \u4f5c\u4e1a\u4e2d:</p> <ul> <li><code>SQLALCHEMY_DATABASE_URI</code> \u5df2\u7ecf\u8986\u76d6\u4e86\u5168\u5c40\u5b9a\u4e49\u7684 <code>SQLALCHEMY_DATABASE_URI</code> \uff0c\u770b\u5dee\u5f02\u6570\u636e\u5e93URL\u4e2d\u5168\u5c40\u662f\u201droot:root\u201d\uff0c\u800c\u4f5c\u4e1a\u4e2d\u662f\u201droot:123456\u201d\u3002</li> <li>\u7531\u4e8e\u4f5c\u4e1a\u4e2d\u5e76\u6ca1\u6709\u5b9a\u4e49 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> \u53d8\u91cf\uff0c\u6240\u4ee5\u4f7f\u7528\u7684\u662f\u5168\u5c40\u7684 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> \u53d8\u91cf\uff0c\u8f93\u51fa\u7ed3\u679c\u662f\u201dFalse\u201d\u3002</li> <li>\u4f5c\u4e1a\u4e2d\u5b9a\u4e49\u7684 <code>SQLALCHEMY_ECHO: \"False\"</code> \u5c06\u5168\u5c40\u7684 <code>SQLALCHEMY_ECHO: \"True\"</code> \u8986\u76d6\uff0c\u6700\u540e\u663e\u793a\u7684\u662f\u201dFalse\u201d\u3002</li> </ul> <p>\u518d\u770b <code>find Bugs</code> \u4f5c\u4e1a\uff1a</p> <p></p> <ul> <li>\u56e0\u4e3a\u6ca1\u6709\u5b9a\u4e49 <code>variables</code> \u5173\u952e\u5b57\uff0c\u8fd9\u4e2a\u4f5c\u7528\u5c06\u4f7f\u7528\u5168\u5c40\u53d8\u91cf\u3002</li> <li>39\u300140\u300141\u4e09\u884c\u8f93\u51fa\u7684\u7ed3\u679c\u90fd\u662f\u5168\u5c40\u53d8\u91cf\u5b9a\u4e49\u7684\u503c\u3002</li> <li>42\u884c\u7684 <code>SQLALCHEMY_ECHO=\"Nothing\"</code> \u5bf9 <code>SQLALCHEMY_ECHO</code> \u5168\u5c40\u53d8\u91cf\u8fdb\u884c\u7684\u91cd\u65b0\u8d4b\u503c\uff0c43\u884c\u6253\u5370\u51fa\u4e86\u8d4b\u503c\u540e\u7684\u65b0\u503c\u662f\u201dNothing\u201d\u3002</li> <li>\u4e0a\u9762\u4e24\u4e2a\u4f5c\u4e1a\u8bf4\u660e\uff0c\u4f5c\u4e1a\u5185\u90e8\u4fee\u6539\u5168\u5c40\u53d8\u91cf\u53ea\u5bf9\u5f53\u524d\u4f5c\u7528\u751f\u6548\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u4f5c\u4e1a\u3002</li> <li>\u53ef\u4ee5\u4f7f\u7528\u8d4b\u503c\u8bed\u53e5\u5bf9\u5168\u5c40\u53d8\u91cf\u6216\u5c40\u90e8\u53d8\u91cf\u8fdb\u884c\u91cd\u65b0\u8d4b\u503c\u3002</li> </ul> <p>\u518d\u770b <code>test1</code> \u4f5c\u4e1a\uff1a</p> <p></p> <ul> <li>\u8be5\u4f5c\u4e1a\u5b9a\u4e49 <code>variables</code> \u5173\u952e\u5b57\uff0c\u589e\u52a0\u4e86\u4e00\u4e2a <code>CKEDITOR_SERVE_LOCAL</code> \u53d8\u91cf\u3002</li> <li>\u4e0a\u4e00\u4e2a\u4f5c\u4e1a\u7684\u4fee\u6539 <code>SQLALCHEMY_ECHO=\"Nothing\"</code> \u5bf9\u672c\u4f5c\u4e1a\u663e\u793a <code>SQLALCHEMY_ECHO</code> \u53d8\u91cf\u6ca1\u6709\u5f71\u54cd\uff0c\u4ecd\u7136\u4f1a\u663e\u793a\u5168\u5c40\u53d8\u91cf\u5b9a\u4e49\u7684\u503c\u201dTrue\u201d\u3002\u518d\u4e00\u6b21\u8bc1\u660e\u4e86\u4f5c\u4e1a\u5185\u90e8\u4fee\u6539\u5168\u5c40\u53d8\u91cf\u53ea\u5bf9\u5f53\u524d\u4f5c\u7528\u751f\u6548\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u4f5c\u4e1a\u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#variables_1","title":"<code>variables</code> \u53d8\u91cf\u7684\u4f18\u5148\u7ea7","text":"<p><code>variables</code> \u53d8\u91cf\u7684\u4f18\u5148\u7ea7\u53c2\u8003 Priority of environment variables</p> <p>\u539f\u6587:</p> <p>Variables of different types can take precedence over other variables, depending on where they are defined.</p> <p>The order of precedence for variables is (from highest to lowest):</p> <pre><code>   Trigger variables or scheduled pipeline variables.\n   Project-level variables or protected variables.\n   Group-level variables or protected variables.\n   YAML-defined job-level variables.\n   YAML-defined global variables.\n   Deployment variables.\n   Predefined environment variables.\n</code></pre> <p>\u7ffb\u8bd1\u8fc7\u6765\uff0c\u662f\u8fd9\u6837\u7684:</p> <p>\u4e0d\u540c\u7c7b\u578b\u7684\u53d8\u91cf\u53ef\u4ee5\u4f18\u5148\u4e8e\u5176\u4ed6\u53d8\u91cf\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5b83\u4eec\u7684\u5b9a\u4e49\u4f4d\u7f6e\u3002</p> <p>\u53d8\u91cf\u7684\u4f18\u5148\u987a\u5e8f\u662f\uff08\u4ece\u6700\u9ad8\u5230\u6700\u4f4e\uff09\uff1a</p> <ul> <li>\u89e6\u53d1\u53d8\u91cf\u6216\u9884\u5b9a\u7684\u6d41\u6c34\u7ebf\u53d8\u91cf\u3002</li> <li>\u9879\u76ee\u7ea7\u522b\u53d8\u91cf\u6216\u53d7\u4fdd\u62a4\u53d8\u91cf\u3002</li> <li>\u7ec4\u7ea7\u522b\u53d8\u91cf\u6216\u53d7\u4fdd\u62a4\u53d8\u91cf\u3002</li> <li>YAML\u5b9a\u4e49\u7684\u4f5c\u4e1a\u7ea7\u53d8\u91cf\u3002</li> <li>YAML\u5b9a\u4e49\u7684\u5168\u5c40\u53d8\u91cf\u3002</li> <li>\u90e8\u7f72\u73af\u5883\u53d8\u91cf\u3002</li> <li>\u9884\u5b9a\u4e49\u7684\u73af\u5883\u53d8\u91cf\u3002</li> </ul> <p>\u53d8\u91cf\u4e2d\u6709\u4e00\u4e9b\u5173\u4e8egit\u7b56\u7565\u7684\u7279\u6b8a\u53d8\u91cf\uff0c\u5982\u540e\u7eed\u51e0\u4e2a\u5c0f\u8282\uff0c\u5f53\u524d\u4ec5\u5217\u51fa\uff0c\u540e\u7eed\u8be6\u7ec6\u8865\u5145\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#export","title":"\u4f7f\u7528export\u5bfc\u51fa\u7684\u53d8\u91cf\u793a\u4f8b","text":"<p>export\u7684\u5bfc\u51fa\u793a\u4f8b:</p> <pre><code>$ export\ndeclare -x CI=\"true\"\ndeclare -x CI_API_V4_URL=\"https://localhost/api/v4\"\ndeclare -x CI_BUILDS_DIR=\"/root/gitlab-runner/builds\"\ndeclare -x CI_BUILD_BEFORE_SHA=\"84f1f0e417d7e340770a4bb05076bf74f3231991\"\ndeclare -x CI_BUILD_ID=\"128\"\ndeclare -x CI_BUILD_NAME=\"build1\"\ndeclare -x CI_BUILD_REF=\"a6554ffa0d2ae67c675fe9768f702f0b1bb65f5a\"\ndeclare -x CI_BUILD_REF_NAME=\"master\"\ndeclare -x CI_BUILD_REF_SLUG=\"master\"\ndeclare -x CI_BUILD_STAGE=\"build\"\ndeclare -x CI_BUILD_TOKEN=\"[MASKED]\"\ndeclare -x CI_COMMIT_BEFORE_SHA=\"84f1f0e417d7e340770a4bb05076bf74f3231991\"\ndeclare -x CI_COMMIT_DESCRIPTION=\"\"\ndeclare -x CI_COMMIT_MESSAGE=\"\u5168\u5c40\u53d8\u91cf\u4e0e\u5c40\u90e8\u53d8\u91cf\u7684\u4f7f\u7528\n\"\ndeclare -x CI_COMMIT_REF_NAME=\"master\"\ndeclare -x CI_COMMIT_REF_SLUG=\"master\"\ndeclare -x CI_COMMIT_SHA=\"a6554ffa0d2ae67c675fe9768f702f0b1bb65f5a\"\ndeclare -x CI_COMMIT_SHORT_SHA=\"a6554ffa\"\ndeclare -x CI_COMMIT_TITLE=\"\u5168\u5c40\u53d8\u91cf\u4e0e\u5c40\u90e8\u53d8\u91cf\u7684\u4f7f\u7528\"\ndeclare -x CI_CONCURRENT_ID=\"0\"\ndeclare -x CI_CONCURRENT_PROJECT_ID=\"0\"\ndeclare -x CI_CONFIG_PATH=\".gitlab-ci.yml\"\ndeclare -x CI_JOB_ID=\"128\"\ndeclare -x CI_JOB_NAME=\"build1\"\ndeclare -x CI_JOB_STAGE=\"build\"\ndeclare -x CI_JOB_TOKEN=\"[MASKED]\"\ndeclare -x CI_JOB_URL=\"https://localhost/higit/bluelog/-/jobs/128\"\ndeclare -x CI_NODE_TOTAL=\"1\"\ndeclare -x CI_PAGES_DOMAIN=\"example.com\"\ndeclare -x CI_PAGES_URL=\"https://localhost/bluelog\"\ndeclare -x CI_PIPELINE_ID=\"45\"\ndeclare -x CI_PIPELINE_IID=\"48\"\ndeclare -x CI_PIPELINE_SOURCE=\"push\"\ndeclare -x CI_PIPELINE_URL=\"https://localhost/higit/bluelog/pipelines/45\"\ndeclare -x CI_PROJECT_DIR=\"/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog\"\ndeclare -x CI_PROJECT_ID=\"2\"\ndeclare -x CI_PROJECT_NAME=\"bluelog\"\ndeclare -x CI_PROJECT_NAMESPACE=\"higit\"\ndeclare -x CI_PROJECT_PATH=\"higit/bluelog\"\ndeclare -x CI_PROJECT_PATH_SLUG=\"higit-bluelog\"\ndeclare -x CI_PROJECT_URL=\"https://localhost/higit/bluelog\"\ndeclare -x CI_PROJECT_VISIBILITY=\"private\"\ndeclare -x CI_REGISTRY_PASSWORD=\"[MASKED]\"\ndeclare -x CI_REGISTRY_USER=\"gitlab-ci-token\"\ndeclare -x CI_REPOSITORY_URL=\"https://gitlab-ci-token:[MASKED]@localhost/higit/bluelog.git\"\ndeclare -x CI_RUNNER_DESCRIPTION=\"bluelog runner\"\ndeclare -x CI_RUNNER_EXECUTABLE_ARCH=\"linux/amd64\"\ndeclare -x CI_RUNNER_ID=\"1\"\ndeclare -x CI_RUNNER_REVISION=\"3001a600\"\ndeclare -x CI_RUNNER_TAGS=\"bluelog\"\ndeclare -x CI_RUNNER_VERSION=\"11.10.0\"\ndeclare -x CI_SERVER=\"yes\"\ndeclare -x CI_SERVER_NAME=\"GitLab\"\ndeclare -x CI_SERVER_REVISION=\"8a802d1c6b7\"\ndeclare -x CI_SERVER_VERSION=\"11.10.6\"\ndeclare -x CI_SERVER_VERSION_MAJOR=\"11\"\ndeclare -x CI_SERVER_VERSION_MINOR=\"10\"\ndeclare -x CI_SERVER_VERSION_PATCH=\"6\"\ndeclare -x CI_SHARED_ENVIRONMENT=\"true\"\ndeclare -x CONFIG_FILE=\"/etc/gitlab-runner/config.toml\"\ndeclare -x FF_K8S_USE_ENTRYPOINT_OVER_COMMAND=\"true\"\ndeclare -x FF_USE_LEGACY_GIT_CLEAN_STRATEGY=\"false\"\ndeclare -x GITLAB_CI=\"true\"\ndeclare -x GITLAB_FEATURES=\"\"\ndeclare -x GITLAB_USER_EMAIL=\"wgzhao@gmail.com\"\ndeclare -x GITLAB_USER_ID=\"2\"\ndeclare -x GITLAB_USER_LOGIN=\"wgzhao\"\ndeclare -x GITLAB_USER_NAME=\"wgzhao\"\ndeclare -x HISTCONTROL=\"ignoredups\"\ndeclare -x HISTSIZE=\"1000\"\ndeclare -x HOME=\"/root\"\ndeclare -x HOSTNAME=\"server.hopewait\"\ndeclare -x LANG=\"en_US.utf8\"\ndeclare -x LC_ALL=\"en_US.utf8\"\ndeclare -x LESSOPEN=\"||/usr/bin/lesspipe.sh %s\"\ndeclare -x LOGNAME=\"root\"\ndeclare -x MAIL=\"/var/spool/mail/root\"\ndeclare -x OLDPWD=\"/root/gitlab-runner\"\ndeclare -x PATH=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin\"\ndeclare -x PIPENV_PYPI_MIRROR=\"https://mirrors.aliyun.com/pypi/simple\"\ndeclare -x PIPENV_VENV_IN_PROJECT=\"1\"\ndeclare -x PWD=\"/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog\"\ndeclare -x SHELL=\"/bin/bash\"\ndeclare -x SHLVL=\"3\"\ndeclare -x SQLALCHEMY_DATABASE_URI=\"mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4\"\ndeclare -x SQLALCHEMY_ECHO=\"False\"\ndeclare -x SQLALCHEMY_TRACK_MODIFICATIONS=\"False\"\ndeclare -x SSH_CLIENT=\"192.168.56.1 51472 22\"\ndeclare -x SSH_CONNECTION=\"192.168.56.1 51472 192.168.56.14 22\"\ndeclare -x SSH_TTY=\"/dev/pts/0\"\ndeclare -x TERM=\"linux\"\ndeclare -x USER=\"root\"\ndeclare -x XDG_RUNTIME_DIR=\"/run/user/0\"\ndeclare -x XDG_SESSION_ID=\"41\"\n</code></pre> <p>\u6ce8\u610f\uff1a</p> <ul> <li>\u4e0d\u8981\u5c06\u654f\u611f\u4fe1\u606f\uff0c\u5982\u7528\u6237\u5bc6\u7801\u3001Token\u7b49\u4fe1\u606f\u653e\u5728 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u53d8\u91cf\u3002</li> <li>\u654f\u611f\u4fe1\u606f\u53ef\u4ee5WEB\u914d\u7f6e\u754c\u9762\u6dfb\u52a0\u53d8\u91cf\uff0c\u5e76\u5c06\u53d8\u91cf\u8bbe\u7f6e\u4e3a <code>Protected</code> \u6216\u8005 <code>Masked</code> \uff0c\u8bbe\u7f6e\u4e3a <code>Masked</code> \u7684\u53d8\u91cf\u4e0d\u4f1a\u76f4\u63a5\u663e\u793a\u5728\u4f5c\u4e1a\u65e5\u5fd7\u4fe1\u606f\u4e2d\u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_4","title":"\u5173\u95ed\u5168\u5c40\u5c42\u7ea7\u5b9a\u4e49\u7684\u53d8\u91cf","text":"<ul> <li>\u5982\u679c\u4f60\u8981\u5728\u4f5c\u4e1a\u5c42\u7ea7\u5173\u95ed\u5168\u5c40\u5c42\u7ea7\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u7ed9 <code>variables</code> \u5173\u952e\u5b57\u5b9a\u4e49\u4e00\u4e2a\u7a7a\u7684 <code>hash</code> \u3002</li> </ul> <p>\u5982\u4e0b\u793a\u4f8b\uff1a</p> <pre><code>job_name:\n  variables: {}\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_5","title":"\u53d8\u91cf\u5b9a\u4e49\u65f6\u4f7f\u7528\u5176\u4ed6\u53d8\u91cf","text":"<ul> <li>\u53ef\u4ee5\u5728\u53d8\u91cf\u5b9a\u4e49\u65f6\uff0c\u4f7f\u7528\u5176\u4ed6\u7684\u53d8\u91cf\uff0c\u9700\u8981\u4f7f\u7528 <code>$$</code> \u8fdb\u884c\u8f6c\u4e49\u3002</li> </ul> <p>\u770b\u4e0b\u9762\u7684\u793a\u4f8b\uff1a</p> <pre><code>variables:\n  LS_CMD: 'ls $FLAGS $$TMP_DIR'\n  FLAGS: '-al'\nscript:\n  - 'eval $LS_CMD'  # will execute 'ls -al $TMP_DIR'\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git-strategy-git_strategy","title":"\u514b\u9686\u7b56\u7565Git strategy <code>GIT_STRATEGY</code>","text":"<ul> <li>\u4f60\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>GIT_STRATEGY</code> \u53d8\u91cf\u6765\u6307\u5b9aGitLab Runner\u8fd0\u884c\u4f5c\u4e1a\u65f6\u4f7f\u7528\u4ec0\u4e48\u6837\u7684\u65b9\u5f0f\u6765\u83b7\u53d6\u6700\u65b0\u7684\u4ee3\u7801\uff0c\u53ef\u4ee5\u5728\u5168\u5c40\u7ea7\u6216\u4f5c\u4e1a\u7ea7\u8fdb\u884c\u8bbe\u7f6e\u3002</li> <li><code>GIT_STRATEGY</code> \u53d8\u91cf\u53ef\u4ee5\u8bbe\u7f6e\u4e3a <code>fetch</code> \u3001<code>clone</code> \u3001<code>none</code> \u3002</li> <li><code>clone</code> \u662f\u6700\u6162\u7684\u65b9\u5f0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u4ece\u5934\u5f00\u59cb\u514b\u9686\u4ed3\u5e93\u3002</li> <li><code>fetch</code> \u76f8\u5bf9\u6765\u8bf4\u66f4\u5feb\u4e00\u70b9\uff0c\u5982\u679c\u672c\u5730\u9879\u76ee\u7a7a\u95f4\u4e2d\u5b58\u5728\u8fdc\u7a0b\u4ed3\u5e93\u7684\u514b\u9686\uff0c\u53ea\u7528\u4ece\u8fdc\u7a0b\u83b7\u53d6\u6700\u65b0\u5230\u672c\u5730\uff0c\u800c\u4e0d\u7528\u4ece\u5934\u5f00\u59cb\u514b\u9686\u6574\u4e2a\u4ed3\u5e93(\u5982\u679c\u672c\u5730\u9879\u76ee\u7a7a\u95f4\u4e0d\u5b58\u5728\u8fdc\u7a0b\u4ed3\u5e93\u7684\u514b\u9686\u7684\u8bdd\uff0c\u5219\u6b64\u65f6\u7b49\u540c\u4e8eclone\uff0c\u4ece\u5934\u5f00\u59cb\u514b\u9686\u8fdc\u7a0b\u4ed3\u5e93)\u3002</li> <li><code>none</code> \u4e5f\u662f\u5229\u7528\u672c\u5730\u9879\u76ee\u7a7a\u95f4\u4e2d\u7684\u6587\u4ef6\uff0c\u4f46\u4e0d\u4f1a\u4ece\u8fdc\u7a0b\u83b7\u53d6\u5230\u6700\u65b0\u7684\u4fee\u6539\u6570\u636e\uff0c\u672c\u5730\u6570\u636e\u4e0d\u662f\u6700\u65b0\u7684\u3002</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u901a\u8fc7\u4fee\u6539 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u6765\u67e5\u770b\u8fd9\u4e2a\u73b0\u8c61\uff1a</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  script:\n    - pwd\n    - export\n    - echo \"Do your build here\"\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  variables:\n    GIT_STRATEGY: \"fetch\"\n  script:\n    - pwd\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  variables:\n    GIT_STRATEGY: \"clone\"\n  script:\n    - pwd\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  variables:\n    GIT_STRATEGY: \"none\"\n  script:\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u63d0\u4ea4\u540e\uff0c\u6d41\u6c34\u7ebf\u89e6\u53d1\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u68c0\u67e5\u4e00\u4e0b\u6bcf\u4e2a\u4f5c\u4e1a\u7684log\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <p>\u5148\u770bbuild1\u4f5c\u4e1a\uff1a</p> <p> </p> <p>\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f1a\u4f7f\u7528 <code>git fetch</code> \u65b9\u5f0f\u6765\u83b7\u53d6\u6700\u65b0\u7684\u4fee\u6539\uff0c\u5e76\u4e14 <code>echo \"GIT_STRATEGY:${GIT_STRATEGY}\"</code> \u6253\u5370 <code>${GIT_STRATEGY}</code> \u53d8\u91cf\u4e3a\u7a7a\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u60c5\u51b5\u4e0bGitLab\u5e76\u4e0d\u4f1a\u8bbe\u7f6e <code>GIT_STRATEGY</code> \u53d8\u91cf\u3002</p> <p>\u518d\u770b\u4e00\u4e0bfind Bugs\u4f5c\u4e1a\uff1a</p> <p></p> <p>\u6b64\u5904\u4e5f\u662f\u76f4\u63a5\u4f7f\u7528\u73b0\u6709\u9879\u76ee\u7a7a\u95f4\u91cc\u9762\u7684\u672c\u5730\u4ed3\u5e93\uff0c\u4f7f\u7528 <code>git fetch</code> \u65b9\u5f0f\u6765\u83b7\u53d6\u6700\u65b0\u7684\u4fee\u6539\uff0c\u7531\u4e8e\u5728\u4f5c\u4e1a\u7ea7\u4e2d\u8bbe\u7f6e\u4e86 <code>GIT_STRATEGY</code> \u53d8\u91cf\uff0c\u6700\u540e\u6253\u5370\u51fa\u6253\u5370 <code>${GIT_STRATEGY}</code> \u53d8\u91cf\u7684\u503c\u4e3a <code>fetch</code> \u3002</p> <p>\u518d\u770b\u4e00\u4e0btest1\u4f5c\u4e1a\uff1a</p> <p></p> <p>\u56e0\u4e3a\u8bbe\u7f6e\u4e86 <code>GIT_STRATEGY: \"clone\"</code> \uff0c\u8fd9\u4e2a\u65f6\u5019GitLab Runner\u4f1a\u4ece\u5934\u5f00\u59cb\u514b\u9686\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u6700\u540e\u6253\u5370\u51fa\u6253\u5370 <code>${GIT_STRATEGY}</code> \u53d8\u91cf\u7684\u503c\u4e3a <code>clone</code> \u3002</p> <p>\u518d\u770b\u4e00\u4e0btest2\u4f5c\u4e1a\uff1a</p> <p></p> <p>\u56e0\u4e3a\u8bbe\u7f6e\u4e86 <code>GIT_STRATEGY: \"none\"</code> \uff0c\u8fd9\u4e2a\u65f6\u5019GitLab Runner\u4ec0\u4e48\u4e5f\u4e0d\u505a\uff0c\u4e0d\u4f1a\u83b7\u53d6\u6700\u65b0\u7684\u4fee\u6539\uff0c\u6700\u540e\u6253\u5370\u51fa\u6253\u5370 <code>${GIT_STRATEGY}</code> \u53d8\u91cf\u7684\u503c\u4e3a <code>none</code> \u3002</p> <p>\u6211\u4eec\u518d\u4fee\u6539\u4e00\u4e0b\u914d\u7f6e\u6587\u4ef6\u4e3a\u4e0b\u9762\u7684\u5185\u5bb9\uff1a</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  script:\n    - pwd\n    - export\n    - echo \"Do your build here\"\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n    - du -sh\n    - ls -lah README.md\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  variables:\n    GIT_STRATEGY: \"fetch\"\n  script:\n    - pwd\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n    - du -sh\n    - ls -lah README.md\n  when: manual\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  variables:\n    GIT_STRATEGY: \"clone\"\n  script:\n    - pwd\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n    - du -sh\n    - ls -lah README.md\n  when: manual\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  variables:\n    GIT_STRATEGY: \"none\"\n  script:\n    - echo \"GIT_STRATEGY:${GIT_STRATEGY}\"\n    - du -sh\n    - ls -lah README.md\n  when: manual\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  script:\n    - echo \"Do your deploy here\"\n    - du -sh\n    - ls -lah README.md\n  when: manual\n  tags:\n    - bluelog\n</code></pre> <p>\u63d0\u4ea4\u540e\uff0c\u6d41\u6c34\u7ebf\u89e6\u53d1\u4e86\uff0c\u4f46\u6709build1\u4f5c\u4e1a\u540e\u9762\u7684\u4f5c\u4e1a\u9700\u8981\u624b\u52a8\u6267\u884c\uff1a</p> <p></p> <p>\u6211\u4eec\u68c0\u67e5build1\u4f5c\u4e1a\uff1a</p> <p></p> <p>\u53ef\u4ee5\u83b7\u53d6\u5230\u6574\u4e2a\u4ed3\u5e93\u7684\u5927\u5c0f\uff0c\u4e5f\u53ef\u4ee5\u8bfb\u53d6\u5230\u4ed3\u5e93\u4e2d\u201dREADME.md\u201d\u6587\u4ef6\u3002</p> <p>\u5047\u8bbe\u6211\u4eec\u6b64\u65f6\u5728\u670d\u52a1\u5668\u7aef\u5c06 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog</code> \u548c <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog.tmp</code> \u76ee\u5f55\u5220\u9664\uff0c\u5e76\u89e6\u53d1find Bugs\u4f5c\u4e1a\u8fd0\u884c\uff1a</p> <p></p> <p>\u56e0\u4e3a\u8bbe\u7f6e\u4e86 <code>GIT_STRATEGY: \"fetch\"</code> \uff0c\u4f46\u56e0\u4e3a\u6211\u628a\u9879\u76ee\u7a7a\u95f4\u91cc\u9762\u7684\u672c\u5730\u4ed3\u5e93\u5185\u5bb9\u90fd\u5220\u9664\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019GitLab Runner\u53d1\u73b0\u672c\u5730\u5e76\u6ca1\u6709\u8fdc\u7a0b\u4ed3\u5e93\u7684\u6587\u4ef6\uff0c\u53ea\u80fd\u4ece\u5934\u5f00\u59cb\u514b\u9686\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u6700\u540e\u6253\u5370\u51fa\u6253\u5370 <code>${GIT_STRATEGY}</code> \u53d8\u91cf\u7684\u503c\u4e3a <code>fetch</code> \u3002</p> <p></p> <p>\u518d\u89e6\u53d1test1\u4f5c\u4e1a\u8fd0\u884c\uff0c\u8fd8\u662f\u4ece\u5934\u5f00\u59cb\u4e0b\u8f7d\u8fdc\u7a0b\u4ed3\u5e93\uff1a</p> <p></p> <p>\u5173\u952e\u4e00\u6b65\uff0c\u6211\u4eec\u518d\u6b21\u5220\u9664\u5de5\u4f5c\u7a7a\u95f4\u4e2d\u7684 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog</code> \u548c <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog.tmp</code> \u76ee\u5f55\uff1a</p> <p></p> <p>\u518d\u89e6\u53d1test2\u4f5c\u4e1a\u8fd0\u884c\uff1a</p> <p></p> <p>\u6b64\u65f6\u53d1\u73b0\uff0cGitLab Runner\u4ec5\u4ec5\u521b\u5efa\u4e86\u4e00\u4e2a\u76ee\u5f55 <code>bluelog</code> \uff0c\u4f46\u4e0d\u4ece\u8fdc\u7a0b\u83b7\u53d6\u6570\u636e\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u83b7\u53d6\u4ed3\u5e93\u76ee\u5f55\u6570\u636e\u5927\u5c0f\u4e3a0\uff0c\u4e5f\u67e5\u770b\u4e0d\u5230README.md\u6587\u4ef6\u7684\u8be6\u60c5\uff0c\u7531\u4e8e\u6ca1\u6709README.md\u6587\u4ef6\uff0c\u6267\u884c\u547d\u4ee4\u5c31\u62a5\u9519\u3002</p> <ul> <li>\u53ef\u4ee5\u770b\u51fa\u8bbe\u7f6e <code>GIT_STRATEGY: \"none\"</code> \u53ef\u80fd\u4f1a\u9047\u5230\u610f\u60f3\u4e0d\u5230\u7684\u60c5\u51b5\uff01</li> <li>\u4e3a\u4e86\u52a0\u5feb\u6d41\u6c34\u7ebf\u5de5\u7a0b\u7684\u6267\u884c\uff0c\u5efa\u8bae\u4f7f\u7528 <code>fetch</code> \u6a21\u5f0f\u3002</li> <li>\u6d41\u6c34\u7ebf\u7684Git\u7b56\u7565\u9ed8\u8ba4\u662f <code>git fetch</code> \u6a21\u5f0f\u3002</li> </ul> <p>\u6d41\u6c34\u7ebf\u7684\u9ed8\u8ba4Git\u7b56\u7565\uff0c\u53ef\u4ee5\u5728\u9879\u76ee\u7684\u6d41\u6c34\u7ebf\u901a\u7528\u8bbe\u7f6e\u4e2d\u67e5\u770b\uff1a</p> <p></p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git-submodule-strategy-git_submodule_strategy","title":"\u5b50\u6a21\u5757\u7b56\u7565Git submodule strategy <code>GIT_SUBMODULE_STRATEGY</code>","text":"<ul> <li><code>GIT_SUBMODULE_STRATEGY</code> \u7c7b\u4f3c\u4e8e <code>GIT_STRATEGY</code> \uff0c\u5f53\u4f60\u7684\u9879\u76ee\u9700\u8981\u5305\u542b\u522b\u7684\u9879\u76ee\u4ee3\u7801\u65f6\uff0c\u53ef\u4ee5\u5c06\u522b\u7684\u9879\u76ee\u4f5c\u4e3a\u4f60\u7684\u9879\u76ee\u7684\u5b50\u6a21\u5757\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>GIT_SUBMODULE_STRATEGY</code> \u3002</li> <li><code>GIT_SUBMODULE_STRATEGY</code> \u9ed8\u8ba4\u53d6\u503c <code>none</code> \uff0c\u5373\u62c9\u53d6\u4ee3\u7801\u65f6\uff0c\u5b50\u6a21\u5757\u4e0d\u4f1a\u88ab\u5f15\u5165\u3002</li> <li><code>GIT_SUBMODULE_STRATEGY</code> \u53ef\u53d6\u503c <code>normal</code> \uff0c\u610f\u5473\u7740\u5728\u53ea\u6709\u9876\u7ea7\u5b50\u6a21\u5757\u4f1a\u88ab\u5f15\u5165\u3002</li> <li><code>GIT_SUBMODULE_STRATEGY</code> \u53ef\u53d6\u503c <code>recursive</code> \uff0c\u9012\u5f52\u7684\u610f\u601d\uff0c\u610f\u5473\u7740\u6240\u6709\u7ea7\u5b50\u6a21\u5757\u4f1a\u88ab\u5f15\u5165\u3002</li> </ul> <p>\u5b50\u6a21\u5757\u9700\u8981\u914d\u7f6e\u5728 <code>.gitmodules</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u4e0b\u9762\u662f\u4e24\u4e2a\u793a\u4f8b\uff1a</p> <p>\u573a\u666f\uff1a</p> <ul> <li>\u4f60\u7684\u9879\u76ee\u5730\u5740\uff1a <code>https://gitlab.com/secret-group/my-project</code> \uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>git clone git@gitlab.com:secret-group/my-project.git</code> \u68c0\u51fa\u4ee3\u7801\u3002</li> <li>\u4f60\u7684\u9879\u76ee\u4f9d\u8d56 <code>https://gitlab.com/group/project</code> \uff0c\u4f60\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u6a21\u5757\u4f5c\u4e3a\u9879\u76ee\u7684\u5b50\u6a21\u5757\u3002</li> </ul> <p>\u5b50\u6a21\u5757\u4e0e\u672c\u9879\u76ee\u5728\u540c\u4e00\u4e2a\u670d\u52a1\u4e0a\uff0c\u53ef\u4ee5\u4f7f\u7528\u76f8\u5bf9\u5f15\u7528\uff1a</p> <pre><code>[submodule \"project\"]\n  path = project\n  url = ../../group/project.git\n</code></pre> <p>\u5b50\u6a21\u5757\u4e0e\u672c\u9879\u76ee\u4e0d\u5728\u540c\u4e00\u4e2a\u670d\u52a1\u4e0a\uff0c\u4f7f\u7528\u76f8\u5bf9\u7edd\u5bf9URL\uff1a</p> <pre><code>[submodule \"project-x\"]\n  path = project-x\n  url = https://gitserver.com/group/project-x.git\n</code></pre> <p>\u8be6\u7ec6\u53ef\u53c2\u8003 Using Git submodules with GitLab CI</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git-checkout-git_checkout","title":"\u68c0\u51fa\u5206\u652f\u8bbe\u7f6eGit checkout <code>GIT_CHECKOUT</code>","text":"<ul> <li>\u5f53 <code>GIT_STRATEGY</code> \u8bbe\u7f6e\u4e3a <code>fetch</code> \u6216\u8005 <code>clone</code> \u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>GIT_CHECKOUT</code> \u53d8\u91cf\u8bbe\u7f6e\u662f\u5426\u9700\u8981\u505a <code>git checkout</code> \u64cd\u4f5c\uff0c\u5982\u679c\u672a\u6307\u5b9a\u8be5\u53c2\u6570\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>true</code> \uff0c\u5373\u9700\u8981\u505a <code>git checkout</code> \u64cd\u4f5c\u3002</li> <li>\u53ef\u4ee5\u5728\u5168\u5c40\u7ea7\u6216\u4f5c\u4e1a\u7ea7\u8fdb\u884c\u8bbe\u7f6e\u3002</li> <li>\u5982\u679c <code>GIT_CHECKOUT</code> \u53d8\u91cf\u8bbe\u7f6e\u4e3a <code>true</code> \uff0cGitLab Runner\u90fd\u4f1a\u5c06\u672c\u5730\u5de5\u4f5c\u526f\u672c\u68c0\u51fa\u5e76\u5207\u6362\u5230\u5f53\u524d\u6d41\u6c34\u7ebf\u76f8\u5173\u7684\u4fee\u8ba2\u7248\u672c\u5206\u652f\u4e0a\u3002</li> <li>\u5982\u679c <code>GIT_CHECKOUT</code> \u53d8\u91cf\u8bbe\u7f6e\u4e3a <code>false</code> \uff0c\u90a3\u4e48\u8fd0\u884c\u5668\u64cd\u4f5c\u5982\u4e0b\uff1a</li> </ul> <ul> <li><code>fetch</code> \u64cd\u4f5c\u65f6\uff0c\u66f4\u65b0\u4ed3\u5e93\u5e76\u5728\u5f53\u524d\u7248\u672c\u4e0a\u4fdd\u7559\u5de5\u4f5c\u526f\u672c\u3002</li> <li><code>clone</code> \u64cd\u4f5c\u65f6\uff0c\u514b\u9686\u4ed3\u5e93\u5e76\u5728\u9ed8\u8ba4\u5206\u652f\u4e2d\u4fdd\u7559\u5de5\u4f5c\u526f\u672c\u3002</li> </ul> <p>\u4e0b\u9762\u793a\u4f8b\u4e0d\u8fdb\u884c\u81ea\u52a8\u5207\u6362\u5230\u5206\u652f\uff1a</p> <pre><code>    variables:\n      GIT_STRATEGY: clone\n      GIT_CHECKOUT: \"false\"\n    script:\n      - git checkout -B master origin/master\n      - git merge $CI_COMMIT_SHA\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git-clean-flags-git_clean_flags","title":"\u6e05\u7406\u5de5\u4f5cGit clean flags <code>GIT_CLEAN_FLAGS</code>","text":"<ul> <li>\u53ef\u4ee5\u4f7f\u7528 <code>GIT_CLEAN_FLAGS</code> \u53d8\u91cf\u6765\u63a7\u5236\u5728\u68c0\u51fa\u6e90\u7801\u540e <code>git clean</code> \u7684\u9ed8\u8ba4\u884c\u4e3a\uff0c\u53ef\u4ee5\u5728\u5168\u5c40\u7ea7\u6216\u4f5c\u4e1a\u7ea7\u8fdb\u884c\u8bbe\u7f6e\u3002</li> <li><code>GIT_CLEAN_FLAGS</code> \u53d8\u91cf\u63a5\u53d7 <code>git clean</code> \u547d\u4ee4\u7684\u6240\u6709\u53c2\u6570\u3002</li> <li>\u5982\u679c\u6307\u5b9a\u4e86 <code>GIT_CHECKOUT: \"false\"</code> \uff0c\u90a3\u4e48 <code>git clean</code> \u5c06\u4e0d\u53ef\u7528\u3002</li> <li><code>git-clean</code> : Remove untracked files from the working tree\uff0c\u5373\u5220\u9664\u672a\u8ddf\u8e2a\u7684\u6587\u4ef6\u3002</li> <li><code>git clean</code> \u547d\u4ee4\u7528\u6765\u4ece\u4f60\u7684\u5de5\u4f5c\u76ee\u5f55\u4e2d\u5220\u9664\u6240\u6709\u6ca1\u6709tracked\u8fc7\u7684\u6587\u4ef6\uff0c <code>git reset --hard</code> \u7528\u4e8e\u5220\u9664\u8ddf\u8e2a\u6587\u4ef6\u7684\u4fee\u6539\u8bb0\u5f55\u3002</li> <li><code>git clean -n</code> \u547d\u4ee4\u5217\u51fa\u5c06\u88ab\u5220\u9664\u7684\u6587\u4ef6\u3002</li> <li><code>git clean -f</code> \u547d\u4ee4\u5220\u9664\u5f53\u524d\u76ee\u5f55\u4e0b\u6240\u6709\u6ca1\u6709\u8ddf\u8e2a\u8fc7\u7684\u6587\u4ef6\u3002</li> <li><code>git clean -d</code> \u547d\u4ee4\u5220\u9664\u5f53\u524d\u76ee\u5f55\u4e0b\u6240\u6709\u6ca1\u6709\u8ddf\u8e2a\u8fc7\u7684\u76ee\u5f55\u3002</li> <li><code>git clean -e &lt;pattern&gt;</code> \u547d\u4ee4\u6392\u9664( <code>--exclude=&lt;pattern&gt;</code> ) \u67d0\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5373\u4e0d\u5220\u9664\u6a21\u5f0f\u5339\u914d\u7684\u6587\u4ef6\u3002</li> <li><code>git clean -ffxd</code> \u547d\u4ee4\u5220\u9664\u5f53\u524d\u76ee\u5f55(\u5305\u62ec\u7531\u5176\u4ed6git\u4ed3\u5e93\u7ba1\u7406\u7684\u5b50\u76ee\u5f55)\u4e0b\u6240\u6709\u6ca1\u6709\u8ddf\u8e2a\u8fc7\u7684\u76ee\u5f55\u548c\u6587\u4ef6\u3002</li> <li><code>GIT_CLEAN_FLAGS</code> \u53d8\u91cf\u672a\u6307\u5b9a\u65f6\uff0c <code>git clean</code> \u547d\u4ee4\u7684\u53c2\u6570\u662f <code>-ffxd</code> \u3002</li> <li><code>GIT_CLEAN_FLAGS</code> \u53d8\u91cf\u6307\u5b9a\u4e3a <code>none</code> \u65f6\uff0c <code>git clean</code> \u547d\u4ee4\u4e0d\u4f1a\u6267\u884c\u3002</li> </ul> <p>\u4e0b\u9762\u793a\u4f8b\u7528\u4e8e\u5220\u9664\u672a\u88ab\u8ddf\u8e2a\u6587\u4ef6\u548c\u76ee\u5f55\uff0c\u4f46\u6392\u9664cache\u76ee\u5f55\u53ca\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff1a</p> <pre><code>variables:\n  GIT_CLEAN_FLAGS: -ffdx -e cache/\nscript:\n  - ls -al cache/\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#job-stages-attempts","title":"\u4f5c\u4e1a\u91cd\u8bd5\u6b21\u6570 Job stages attempts","text":"<ul> <li>\u60a8\u53ef\u4ee5\u8bbe\u7f6e\u6b63\u5728\u8fd0\u884c\u7684\u4f5c\u4e1a\u5c1d\u8bd5\u6267\u884c\u4ee5\u4e0b\u6bcf\u4e2a\u9636\u6bb5\u7684\u5c1d\u8bd5\u6b21\u6570\u3002\u53ef\u4ee5\u5728\u5168\u5c40\u7ea7\u6216\u4f5c\u4e1a\u7ea7\u8fdb\u884c\u8bbe\u7f6e\u3002</li> <li>\u6d89\u53ca\u4e09\u4e2a\u53d8\u91cf <code>GET_SOURCES_ATTEMPTS</code> \u3001 <code>ARTIFACT_DOWNLOAD_ATTEMPTS</code> \u3001 <code>RESTORE_CACHE_ATTEMPTS</code> \u3002</li> <li><code>GET_SOURCES_ATTEMPTS</code> \u53d8\u91cf\u8bbe\u7f6e\u83b7\u53d6\u6e90\u7801\u7684\u5c1d\u8bd5\u6b21\u6570\u3002</li> <li><code>ARTIFACT_DOWNLOAD_ATTEMPTS</code> \u53d8\u91cf\u8bbe\u7f6e\u4e0b\u8f7d\u5f52\u6863\u6587\u4ef6\u7684\u5c1d\u8bd5\u6b21\u6570\u3002</li> <li><code>RESTORE_CACHE_ATTEMPTS</code> \u53d8\u91cf\u8bbe\u7f6e\u91cd\u5efa\u7f13\u5b58\u7684\u5c1d\u8bd5\u6b21\u6570\u3002</li> <li>\u9ed8\u8ba4\u662f1\u6b21\u5c1d\u8bd5\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>variables:\n  GET_SOURCES_ATTEMPTS: 3\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#shallow-cloning-git_depth","title":"\u6d45\u514b\u9686 Shallow cloning <code>GIT_DEPTH</code>","text":"<ul> <li>GitLab 8.9\u4e2d\u5f15\u5165\u4e86\u8bd5\u9a8c\u6027\u7684\u7279\u5f81 <code>\u6d45\u514b\u9686</code> \uff0c\u5728\u5c06\u6765\u7684\u7248\u672c\u4e2d\u6709\u53ef\u80fd\u6539\u53d8\u6216\u8005\u5b8c\u5168\u79fb\u9664\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>GIT_DEPTH</code> \u514b\u9686\u6df1\u5ea6\uff0c\u4e0d\u8be6\u7ec6\u4ecb\u7ecd\uff0c\u53ef\u53c2\u8003 Shallow cloning</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#types-type","title":"\u5e9f\u5f03\u7684\u5173\u952e\u5b57 <code>types</code> \u548c <code>type</code>","text":"<ul> <li>\u5173\u952e\u5b57 <code>types</code> \u548c <code>type</code> \u5df2\u7ecf\u5e9f\u5f03\u3002</li> <li>\u4f7f\u7528 <code>stages</code> \u9636\u6bb5\u5b9a\u4e49\u5173\u952e\u5b57\u4ee3\u66ff <code>types</code> \u3002</li> <li>\u4f7f\u7528 <code>stage</code> \u4f5c\u4e1a\u6240\u5904\u9636\u6bb5\u5173\u952e\u5b57\u4ee3\u66ff <code>type</code> \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#git_clone_path","title":"\u4f7f\u7528 <code>GIT_CLONE_PATH</code> \u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55","text":"<ul> <li>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u53ea\u6709\u5728GitLab Runner\u8fd0\u884c\u5668\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86 <code>custom_build_dir</code> \u4e3a <code>enabled</code> \u5f00\u542f\u72b6\u6001\u65f6\u624d\u53ef\u4f7f\u7528\u3002</li> <li><code>docker</code> \u3001 <code>kubernetes</code> \u8fd0\u884c\u5668\u9ed8\u8ba4\u5f00\u542f\u4e86\u6b64\u529f\u80fd\uff0c\u800c\u5176\u4ed6\u8fd0\u884c\u5668\u9ed8\u8ba4\u4e0d\u4f1a\u5f00\u542f\u6b64\u529f\u80fd\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGitLab Runner\u8fd0\u884c\u5668\u5c06\u4ed3\u5e93\u514b\u9686\u5230 <code>$CI_BUILDS_DIR</code> \u76ee\u5f55\u4e0b\u7684\u4e00\u4e2a\u540d\u79f0\u552f\u4e00\u7684\u5b50\u76ee\u5f55\u4e2d\uff0c\u4f46\u6709\u65f6\u5019\u4f60\u7684\u9879\u76ee\u53ef\u80fd\u9700\u8981\u6307\u5b9a\u4e00\u4e2a\u7279\u6b8a\u7684\u8def\u5f84\u7528\u6765\u4fdd\u5b58\u4e0b\u8f7d\u7684\u4ed3\u5e93\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>GIT_CLONE_PATH</code> \u53d8\u91cf\u6765\u6307\u5b9a\u514b\u9686\u6587\u4ef6\u7684\u5b58\u653e\u76ee\u5f55\u3002</li> <li><code>GIT_CLONE_PATH</code> \u5fc5\u987b\u662f <code>$CI_BUILDS_DIR</code> \u7684\u5b50\u76ee\u5f55\uff0c <code>$CI_BUILDS_DIR</code> \u76ee\u5f55\u5404\u4e2a\u8fd0\u884c\u5668\u53ef\u80fd\u4e0d\u540c\u3002</li> </ul> <p>\u6211\u4eec\u5c1d\u8bd5\u5728\u6211\u4eec\u7684SHELL\u8fd0\u884c\u5668\u4e0a\u53bb\u8bbe\u7f6e <code>GIT_CLONE_PATH</code> \u76ee\u5f55\u3002</p> <p>\u4e0b\u9762\u662f\u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e2a\u793a\u4f8b\uff1a</p> <pre><code>variables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/project-name\n\ntest:\n  script:\n    - pwd\n</code></pre> <p>\u6211\u4eec\u4eff\u7167\u8fd9\u4e2a\u793a\u4f8b\u4fee\u6539 <code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u8fdb\u884c\u63d0\u4ea4\uff0c\u4fee\u6539\u540e\u7684\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options\n\n# \u5b9a\u4e49\u5168\u5c40\u53d8\u91cf\nvariables:\n  # \u6570\u636e\u5e93\u4fe1\u606f\n  SQLALCHEMY_DATABASE_URI: 'mysql+pymysql://root:root@localhost:3306/bluelog?charset=utf8mb4'\n  # \u4e0d\u53d1\u9001\u8b66\u544a\u901a\u77e5\n  SQLALCHEMY_TRACK_MODIFICATIONS: \"False\"\n  # \u663e\u793a\u6267\u884cSQL\n  SQLALCHEMY_ECHO: \"True\"\n  # \u8bbe\u7f6e\u5168\u5c40\u6784\u5efa\u76ee\u5f55\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/global_folder\n\nstages:\n  - build\n  - code_check\n  - test\n  - deploy\n\nbuild1:\n  stage: build\n  variables:\n    # \u6570\u636e\u5e93\u4fe1\u606f\n    SQLALCHEMY_DATABASE_URI: 'mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4'\n    # \u4e0d\u663e\u793a\u6267\u884cSQL\n    SQLALCHEMY_ECHO: \"False\"\n    # \u8bbe\u7f6e\u5168\u5c40\u6784\u5efa\u76ee\u5f55\n    GIT_CLONE_PATH: $CI_BUILDS_DIR/sub_folder\n  script:\n    - pwd\n    - export\n    - echo \"Do your build here\"\n    - cloc --version\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n  tags:\n    - bluelog\n\nfind Bugs:\n  stage: code_check\n  script:\n    - pwd\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n    - SQLALCHEMY_ECHO=\"Nothing\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n  tags:\n    - bluelog\n\ntest1:\n  stage: test\n  variables:\n    # CKEditor\u5bcc\u6587\u672c\u8bbe\u7f6e\n    CKEDITOR_SERVE_LOCAL: \"True\"\n  script:\n    - pwd\n    - echo -e \"SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}\"\n    - echo -e \"SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}\"\n    - echo -e \"SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}\"\n    - echo -e \"CKEDITOR_SERVE_LOCAL:${CKEDITOR_SERVE_LOCAL}\"\n  tags:\n    - bluelog\n\ntest2:\n  stage: test\n  script:\n    - echo \"Do another parallel test here\"\n    - echo \"For example run a lint test\"\n  tags:\n    - bluelog\n\ndeploy1:\n  stage: deploy\n  script:\n    - echo \"Do your deploy here\"\n  tags:\n    - bluelog\n</code></pre> <p>\u63d0\u4ea4\u4fee\u6539\u6784\u5efa\u76ee\u5f55\u540e\uff0c\u6d41\u6c34\u7ebf\u6267\u884c\u5931\u8d25\uff1a</p> <p></p> <p>\u67e5\u770b\u4f5c\u4e1a\u8be6\u60c5\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u63d0\u793a <code>ERROR: Job failed: setting GIT_CLONE_PATH is not allowed, enable custom_build_dir feature</code></p> <p>\u610f\u601d\u662f\u8bf4\u4e0d\u5141\u8bb8\u8bbe\u7f6e <code>GIT_CLONE_PATH</code> \u53d8\u91cf\uff0c\u9700\u8981\u8bbe\u7f6e <code>custom_build_dir</code> \u5c5e\u6027\u3002</p> <p>\u6211\u4eec\u53c2\u8003 The [runners.custom_build_dir] section \u6765\u8bbe\u7f6e <code>custom_build_dir</code> \u5c5e\u6027\u3002</p> <p>\u6211\u4eec\u67e5\u770b\u4e00\u4e0bGitLab Runner\u7684\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9:</p> <pre><code>$ cat /etc/gitlab-runner/config.toml\nconcurrent = 1\ncheck_interval = 0\n\n[session_server]\n  session_timeout = 1800\n\n[[runners]]\n  name = \"bluelog runner\"\n  url = \"https://localhost/\"\n  token = \"1aXYZ5H9n2y8oauWkz7D\"\n  executor = \"shell\"\n  [runners.custom_build_dir]\n  [runners.cache]\n    [runners.cache.s3]\n    [runners.cache.gcs]\n</code></pre> <p>\u6211\u4eec\u53c2\u8003\u793a\u4f8b:</p> <p><pre><code>[runners.custom_build_dir]\n  enabled = true\n</code></pre> \u5f00\u542f <code>custom_build_dir</code> \u5c5e\u6027\uff0c\u4fee\u6539\u540e\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b:</p> <pre><code>$ cat /etc/gitlab-runner/config.toml\nconcurrent = 1\ncheck_interval = 0\n\n[session_server]\n  session_timeout = 1800\n\n[[runners]]\n  name = \"bluelog runner\"\n  url = \"https://localhost/\"\n  token = \"1aXYZ5H9n2y8oauWkz7D\"\n  executor = \"shell\"\n  [runners.custom_build_dir]\n    enabled = true\n  [runners.cache]\n    [runners.cache.s3]\n[runners.cache.gcs]\n</code></pre> <p>\u91cd\u65b0\u89e6\u53d1 <code>build1</code> \u4f5c\u4e1a\uff0c\u770b\u770b\u6548\u679c\u3002</p> <p>\u6b64\u65f6\u53ef\u4ee5\u770b\u5230\uff0c\u4f5c\u4e1a\u5f00\u59cb\u8fd0\u884c\u4e86\uff0c\u5e76\u4e14\u5728 <code>/root/gitlab-runner/builds</code> \u76ee\u5f55\u4e0b\u751f\u6210\u4e86\u56db\u4e2afolder\u76f8\u5173\u7684\u76ee\u5f55:</p> <pre><code> # pwd\n/root/gitlab-runner/builds\n# ls -ld *folder*\ndrwxr-xr-x 5 root root 193 Jul 12 23:08 global_folder\ndrwxr-xr-x 3 root root  26 Jul 12 23:08 global_folder.tmp\ndrwxr-xr-x 5 root root 193 Jul 12 23:08 sub_folder\ndrwxr-xr-x 3 root root  26 Jul 12 23:08 sub_folder.tmp\n</code></pre> <p>\u67e5\u770b\u201dbuild1\u201d\u548c\u201dfind Bugs\u201d\u4f5c\u4e1a\u7684\u8be6\u60c5\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u201dbuild1\u201d\u4f5c\u4e1a\u4f7f\u7528\u4f5c\u4e1a\u7ea7\u5b9a\u4e49\u7684 <code>GIT_CLONE_PATH: $CI_BUILDS_DIR/sub_folder</code> \uff0c\u4ed3\u5e93\u4f1a\u88ab\u4e0b\u8f7d\u5230 <code>/root/gitlab-runner/builds/sub_folder</code> \u76ee\u5f55\u4e0b\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u201dbuild1\u201d\u4f5c\u4e1a\u4f7f\u7528\u5168\u5c40\u7ea7\u5b9a\u4e49\u7684 <code>GIT_CLONE_PATH: $CI_BUILDS_DIR/global_folder</code> \uff0c\u4ed3\u5e93\u4f1a\u88ab\u4e0b\u8f7d\u5230 <code>/root/gitlab-runner/builds/global_folder</code> \u76ee\u5f55\u4e0b\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#handling-concurrency","title":"\u5904\u7406\u5e76\u53d1(Handling concurrency)","text":"<ul> <li>\u5f53\u6267\u884c\u5668\u914d\u7f6e\u5e76\u53d1\u6570 <code>concurrent</code> \u5927\u4e8e1\u65f6\uff0c\u6709\u53ef\u80fd\u5bfc\u81f4\u4f5c\u4e1a\u8fd0\u884c\u5931\u8d25\uff0c\u56e0\u4e3a\u6709\u53ef\u80fd\u591a\u4e2a\u4f5c\u4e1a\u90fd\u8fd0\u884c\u5728\u76f8\u540c\u7684\u76ee\u5f55\u4e0a\uff0cGitLab Runner\u8fd0\u884c\u5668\u5e76\u4e0d\u4f1a\u53bb\u963b\u6b62\u8fd9\u79cd\u60c5\u5f62\uff0c\u7ba1\u7406\u5458\u548c\u5f00\u53d1\u4eba\u5458\u5fc5\u987b\u9075\u5b88Runner\u914d\u7f6e\u7684\u8981\u6c42\u3002</li> <li>\u8981\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u60a8\u53ef\u4ee5\u5728 <code>$CI_BUILDS_DIR</code> \u4e2d\u4f7f\u7528\u552f\u4e00\u8def\u5f84\uff0c\u56e0\u4e3aRunner\u516c\u5f00\u4e86\u53e6\u5916\u4e24\u4e2a\u63d0\u4f9b\u552f\u4e00\u5e76\u53d1ID\u7684\u53d8\u91cf\uff1a</li> </ul> <ul> <li><code>$CI_CONCURRENT_ID</code> \uff1a\u7ed9\u5b9a\u6267\u884c\u7a0b\u5e8f\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u4f5c\u4e1a\u7684\u552f\u4e00ID\u3002</li> <li><code>$CI_CONCURRENT_PROJECT_ID</code> \uff1a\u5728\u7ed9\u5b9a\u6267\u884c\u7a0b\u5e8f\u548c\u9879\u76ee\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u4f5c\u4e1a\u7684\u552f\u4e00ID\u3002</li> <li>\u5728\u4efb\u4f55\u573a\u666f\u548c\u4efb\u4f55\u6267\u884c\u5668\u4e2d\u90fd\u5e94\u8be5\u8fd0\u884c\u826f\u597d\u7684\u6700\u7a33\u5b9a\u7684\u914d\u7f6e\u662f\u5728 <code>GIT_CLONE_PATH</code> \u4e2d\u4f7f\u7528 <code>$CI_CONCURRENT_ID</code> \u3002</li> </ul> <p>\u4f8b\u5982</p> <pre><code>variables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-name\n\ntest:\n  script:\n    - pwd\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#nested-paths","title":"\u5d4c\u5957\u8def\u5f84(Nested paths)","text":"<ul> <li><code>GIT_CLONE_PATH</code> \u53d8\u91cf\u6700\u591a\u53ea\u80fd\u6269\u5c55\u4e00\u6b21\uff0c\u4e0d\u652f\u6301\u5d4c\u5957\u7684\u53d8\u91cf\u8def\u5f84\u3002</li> </ul> <p>\u4e0b\u9762\u5b9a\u4e49\u4e86\u4e24\u4e2a\u53d8\u91cf\uff1a</p> <pre><code>variables:\n  GOPATH: $CI_BUILDS_DIR/go\n  GIT_CLONE_PATH: $GOPATH/src/namespace/project\n</code></pre> <p><code>GIT_CLONE_PATH</code> \u53d8\u91cf\u6269\u5c55\u4e00\u6b21\u540e\uff0c\u53d8\u91cf\u6210\u4e86 <code>$CI_BUILDS_DIR/go/src/namespace/project</code> \uff0c\u8fd9\u4e2a\u65f6\u5019\u5728\u8def\u5f84\u4e2d\u6709\u4e00\u4e2a\u53d8\u91cf\uff0c\u800c <code>GIT_CLONE_PATH</code> \u53d8\u91cf\u4e0d\u4f1a\u518d\u6b21\u6269\u5c55 <code>$CI_BUILDS_DIR</code> \u5bfc\u81f4\u4f5c\u4e1a\u8fd0\u884c\u5931\u8d25\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#yaml","title":"\u7279\u6b8a\u7684YAML\u529f\u80fd","text":"<p>\u53ef\u4ee5\u4f7f\u7528\u7279\u6b8a\u7684YAML\u529f\u80fd\uff0c\u5982\u951a\u70b9( <code>\uff06</code> )\uff0c\u522b\u540d( <code>*</code> )\u548c\u5408\u5e76( <code>&lt;&lt;</code> )\uff0c\u8fd9\u5c06\u4f7f\u60a8\u5927\u5927\u964d\u4f4e <code>.gitlab-ci.yml</code> \u7684\u590d\u6742\u6027\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#_6","title":"\u9690\u85cf\u5173\u952e\u5b57\u6216\u4f5c\u4e1a","text":"<p>\u5982\u679c\u6211\u4eec\u60f3\u6682\u65f6\u7981\u7528\u67d0\u4e2a\u4f5c\u4e1a\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8be5\u4f5c\u4e1a\u7684\u6240\u6709\u884c\u90fd\u6ce8\u91ca\u6389\uff0c\u5982\u4e0b\u793a\u4f8b\uff1a</p> <pre><code>#hidden_job:\n#  script:\n#    - run test\n</code></pre> <p>\u66f4\u597d\u7684\u65b9\u6cd5\u662f\uff0c\u6211\u4eec\u5728\u4f5c\u4e1a\u540d\u79f0\u524d\u9762\u589e\u52a0\u4e00\u4e2a\u70b9\u53f7( <code>.</code> )\uff0c \u8fd9\u6837GitLab CI\u6d41\u6c34\u7ebf\u5c31\u4f1a\u81ea\u52a8\u5904\u7406\u5ffd\u7565\u6389 <code>.hidden_job</code> \u4f5c\u4e1a\u3002</p> <p>\u6539\u6210\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>.hidden_job:\n  script:\n    - run test\n</code></pre>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#anchors","title":"\u951a\u70b9(Anchors)","text":"<ul> <li>\u951a\u70b9\u53ef\u4ee5\u8ba9\u4f60\u5bb9\u6613\u590d\u5236\u6587\u6863\u5185\u5bb9\uff0c\u951a\u70b9\u53ef\u4ee5\u7528\u6765\u590d\u5236\u6216\u7ee7\u627f\u67d0\u4e9b\u5c5e\u6027\uff0c\u951a\u70b9\u4e0e\u9690\u85cf\u4f5c\u4e1a\u4e00\u8d77\u4f7f\u7528\u53ef\u63d0\u4f9b\u4f5c\u4e1a\u6a21\u677f\u3002</li> </ul> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u4f7f\u7528\u951a\u70b9\u548c\u5408\u5e76\u521b\u5efa\u4e86\u4e24\u4e2a\u4f5c\u4e1a\uff0c<code>test1</code> \u548c <code>test2</code> \uff0c\u4e24\u4e2a\u4f5c\u4e1a\u90fd\u662f\u7ee7\u627f\u81ea\u9690\u85cf\u4f5c\u4e1a <code>.job_template</code> \uff0c\u5e76\u4e14\u90fd\u6709\u4ed6\u4eec\u81ea\u5df1\u72ec\u6709\u7684\u5de5\u4f5c\u811a\u672c\u5b9a\u4e49\uff1a</p> <pre><code>.job_template: &amp;job_definition  # Hidden key that defines an anchor named 'job_definition'\n  image: ruby:2.1\n  services:\n    - postgres\n    - redis\n\ntest1:\n  &lt;&lt;: *job_definition           # Merge the contents of the 'job_definition' alias\n  script:\n    - test1 project\n\ntest2:\n  &lt;&lt;: *job_definition           # Merge the contents of the 'job_definition' alias\n  script:\n    - test2 project\n</code></pre> <ul> <li><code>&amp;</code> \u7528\u4e8e\u8bbe\u7f6e\u951a\u70b9\u540d\u79f0\u4e3a <code>job_definition</code> \uff0c\u4e5f\u5c31\u662f\u7ed9\u9690\u85cf\u4f5c\u4e1a\u8bbe\u7f6e\u4e00\u4e2a\u951a\u70b9 <code>job_definition</code> \u3002</li> <li><code>&lt;&lt;</code> \u5408\u5e76\uff0c\u5c06\u951a\u70b9\u5b9a\u4e49\u7684\u6a21\u677f\u5185\u5bb9\u590d\u5236\u5230\u5f53\u524d\u4f5c\u4e1a\u7684\u5f53\u524d\u4f4d\u7f6e\u6765\u3002</li> <li><code>*</code> \u5305\u542b\u951a\u70b9\u7684\u540d\u79f0 <code>job_definition</code>\u3002</li> </ul> <p>\u6269\u5c55\u540e\u7684\u914d\u7f6e\u6587\u4ef6\u53d8\u6210\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>.job_template:\n  image: ruby:2.1\n  services:\n    - postgres\n    - redis\n\ntest1:\n  image: ruby:2.1\n  services:\n    - postgres\n    - redis\n  script:\n    - test1 project\n\ntest2:\n  image: ruby:2.1\n  services:\n    - postgres\n    - redis\n  script:\n    - test2 project\n</code></pre> <p>\u518d\u770b\u53e6\u5916\u4e00\u4e2a\u793a\u4f8b\uff1a</p> <pre><code>.job_template: &amp;job_definition\n  script:\n    - test project\n\n.postgres_services:\n  services: &amp;postgres_definition\n    - postgres\n    - ruby\n\n.mysql_services:\n  services: &amp;mysql_definition\n    - mysql\n    - ruby\n\ntest:postgres:\n  &lt;&lt;: *job_definition\n  services: *postgres_definition\n\ntest:mysql:\n  &lt;&lt;: *job_definition\n  services: *mysql_definition\n</code></pre> <p>\u6269\u5c55\u540e\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>.job_template:\n  script:\n    - test project\n\n.postgres_services:\n  services:\n    - postgres\n    - ruby\n\n.mysql_services:\n  services:\n    - mysql\n    - ruby\n\ntest:postgres:\n  script:\n    - test project\n  services:\n    - postgres\n    - ruby\n\ntest:mysql:\n  script:\n    - test project\n  services:\n    - mysql\n    - ruby\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u9690\u85cf\u7684\u5173\u952e\u5b57\u6216\u8005\u4f5c\u4e1a\u53ef\u4ee5\u65b9\u4fbf\u5730\u7528\u4f5c\u4e3a\u6a21\u677f\u3002</p>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#triggers","title":"Triggers\u89e6\u53d1\u5668","text":"<ul> <li>\u5f53\u4f7f\u7528\u89e6\u53d1\u5668\u4ee4\u724c\u89e6\u53d1\u6d41\u6c34\u7ebf\u8fd0\u884c\u65f6\uff0c\u89e6\u53d1\u5668\u53ef\u7528\u4e8e\u5f3a\u5236\u91cd\u5efa\u7279\u5b9a\u5206\u652f\uff0c\u6807\u8bb0\u6216\u63d0\u4ea4\uff0c\u5e76\u4f7f\u7528API\u8c03\u7528\u3002</li> <li>\u89e6\u53d1\u5668\u4f7f\u7528\u53ef\u53c2\u8003 \u4f7f\u7528\u6d41\u6c34\u7ebf\u89e6\u53d1\u5668\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c \u3002</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/gitlab-ci-configuration/#ci","title":"\u5ffd\u7565CI\u68c0\u67e5","text":"<ul> <li>\u5f53\u4f60\u63d0\u4ea4\u7684commit\u65e5\u5fd7\u4fe1\u606f\u4e2d\u5305\u542b <code>[ci skip]</code> \u6216\u8005 <code>[skip ci]</code> (\u5ffd\u7565\u5927\u5c0f\u5199)\uff0c\u63d0\u4ea4\u53ef\u4ee5\u6210\u529f\u4f46\u662f\u4f1a\u5ffd\u7565\u6d41\u6c34\u7ebf\u7684\u6267\u884c\u3002</li> <li>\u6216\u8005\uff0c\u5728 <code>git push</code> \u65f6\u6dfb\u52a0\u63a8\u9001\u9009\u9879\uff0c\u5982 <code>git push -o ci.skip</code> \u3002</li> </ul> <p>\u6211\u4eec\u7b2c\u4e00\u6b21\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0ccommit\u65e5\u5fd7\u4e3a\u201d\u79fb\u9664\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\uff0c\u6d4b\u8bd5\u5ffd\u7565ci\u6784\u5efa ci skip\u201d\uff0c\u5305\u542b\u6709 <code>ci skip</code> \u5173\u952e\u5b57\uff0c\u4f46\u662f\u6ca1\u6709\u5de6\u53f3\u4e2d\u62ec\u53f7\uff0c\u8fdb\u884c\u63d0\u4ea4\uff1a</p> <p></p> <p>\u4f46\u662f\u53d1\u73b0\u6d41\u6c34\u7ebf\u88ab\u89e6\u53d1\u4e86\uff0c\u6b63\u5e38\u8fd0\u884c\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u7b2c\u4e8c\u6b21\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0ccommit\u65e5\u5fd7\u4e3a\u201d\u79fb\u9664\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\uff0c\u6d4b\u8bd5\u5ffd\u7565ci\u6784\u5efa [CI Skip]\u201d\uff0c\u5305\u542b\u6709 <code>[CI Skip]</code> \u5173\u952e\u5b57\uff0c\u8fdb\u884c\u63d0\u4ea4\uff1a</p> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0\u6d41\u6c34\u7ebf\u6ca1\u6709\u88ab\u89e6\u53d1\uff0c\u4f46\u662f\u63d0\u4ea4\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff1a</p> <p> </p> <p>\u6211\u4eec\u7b2c\u4e09\u6b21\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0ccommit\u65e5\u5fd7\u4e3a \u201d\u6d4b\u8bd5\u4f7f\u7528git push\u6dfb\u52a0\u63a8\u9001\u9009\u9879\u201d\uff0c\u8fdb\u884c\u63d0\u4ea4\uff1a</p> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0\u6d41\u6c34\u7ebf\u6ca1\u6709\u88ab\u89e6\u53d1\uff0c\u4f46\u662f\u63d0\u4ea4\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff1a</p> <p></p> <p><code>.gitlab-ci.yml</code> \u914d\u7f6e\u6587\u4ef6\u5404\u4e2a\u5173\u952e\u5b57\u7684\u4f7f\u7528\u5c31\u4ecb\u7ecd\u5230\u8fd9\u91cc\u3002</p> <p>\u53c2\u8003\uff1a</p> <ul> <li>Getting started with GitLab CI/CD</li> <li>GitLab CI/CD Pipeline Configuration Reference</li> <li>Gitlab CI yaml\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6\u7ffb\u8bd1</li> <li>GitLab Runner Advanced configuration</li> <li>Why we\u2019re replacing GitLab CI jobs with .gitlab-ci.yml</li> <li>GitLab CI/CD Examples</li> <li>GitLab CI/CD Variables</li> <li>\u4f01\u4e1a\u7ea7.gitlab-ci.yml\u793a\u4f8b</li> <li>Gitlab CI \u4f7f\u7528\u9ad8\u7ea7\u6280\u5de7</li> <li>git tag\u7684\u7528\u6cd5</li> <li>Python\u9759\u6001\u4ee3\u7801\u68c0\u67e5\u5de5\u5177Flake8</li> <li>Python\u4ee3\u7801\u89c4\u8303\u5229\u5668Flake8</li> <li>Flake8: Your Tool For Style Guide Enforcement</li> <li>\u57fa\u4e8eGitLab CI\u642d\u5efaGolang\u81ea\u52a8\u6784\u5efa\u73af\u5883</li> <li>\u4ec0\u4e48\u662fstaging server</li> <li>Cache dependencies in GitLab CI/CD</li> <li>Introduction to job artifacts</li> <li>dependencies</li> <li>JUnit test reports</li> <li>include</li> <li>extends</li> <li>GitLab Pages</li> <li>Priority of environment variables</li> <li>The [runners.custom_build_dir] section</li> <li>trigger</li> <li>Using Git submodules with GitLab CI</li> <li>Shallow cloning</li> </ul>","tags":["gitlab","ci","gitlab-ci"]},{"location":"misc/osint-introduce/","title":"\u8d85\u7ea7\u60c5\u62a5\u624b\u673a\u5de5\u5177\u5e93\uff1a\u5f00\u6e90\u9a8c\u8bc1\u548c\u8c03\u67e5\u5de5\u5177\u53ca\u4f7f\u7528\u65b9\u6cd5","text":"<p>\u6b22\u8fce\u6765\u5230\u514d\u8d39\u63d0\u4f9b\u7684\u6570\u5b57\u5de5\u5177\u548c\u65b9\u6cd5\u5217\u8868\uff5e \u7528\u4e8e\u6211\u4eec\u7684\u4fe1\u606f\u9a8c\u8bc1\u548c\u5f00\u6e90\u60c5\u62a5\u7814\u7a76 #OSINT\u3002\u5de5\u5177\u5f88\u91cd\u8981\uff0c\u5b83\u4eec\u80fd\u8ba9\u60a8\u7684\u667a\u6167\u5f97\u5230\u66f4\u5145\u5206\u7684\u53d1\u6325\u3002\u6280\u672f\u662f\u5f3a\u5927\u7684\u5b9e\u529b\uff0c\u6b63\u4e49\u7684\u516c\u6c11\u529b\u91cf\u5b8c\u5168\u53ef\u4ee5\u53d6\u4ee3\u90a3\u4e9b\u4e0d\u4e13\u4e1a\u7684\u201c\u5a92\u4f53\u201d\u3002\u4e00\u8d77\u6765\uff0c\u6316\u6398\u771f\u76f8\uff01</p> <p>\u8be5\u5217\u8868\u5305\u62ec\u536b\u661f\u548c\u5730\u56fe\u670d\u52a1\u3001\u7528\u4e8e\u9a8c\u8bc1\u7167\u7247\u548c\u89c6\u9891\u7684\u5de5\u5177\u3001\u7528\u4e8e\u5b58\u6863\u8d85\u94fe\u63a5\u7684\u7f51\u7ad9\u7b49\u7b49\uff0c\u4ee5\u53ca\u5f88\u591a\u201c\u5c0f\u90aa\u6076\u201d\u7684\u6280\u672f\u3002\u540d\u5355\u6709\u70b9\u957f\uff0c\u4f46\u662f\uff0c\u540e\u9762\u66f4\u7cbe\u5f69\uff01\u9644\u6709\u4e00\u4e9b\u7b80\u77ed\u7684\u6307\u5357\uff0c\u66f4\u8be6\u7ec6\u5730\u7a81\u51fa\u4e86\u8fd9\u4e9b\u5de5\u5177\u7684\u7528\u6cd5\u3002\u5bf9\u4e8e\u4e00\u4e9b\u6bd4\u8f83\u590d\u6742\u7684\u5de5\u5177\uff0c\u6211\u4eec\u5c06\u5728\u540e\u9762\u7684\u6587\u7ae0\u4e2d\u8be6\u7ec6\u4ecb\u7ecd\u5176\u7528\u6cd5\u3002\u611f\u8c22 bellingcat \u7684\u4f1f\u5927\u53d1\u73b0\u3002</p> <p>\u5927\u591a\u6570\u5de5\u5177\u975e\u5e38\u5bb9\u6613\u8bb0\u4f4f\uff0c\u5b83\u4eec\u7684\u540d\u5b57\u5c31\u662f\u5b83\u4eec\u7684\u7528\u9014\u3002</p> <p>\u6211\u4eec\u5c06\u5c3d\u53ef\u80fd\u5c11\u7684\u63a8\u6d4b\u60a8\u53ef\u4ee5\u7528\u8fd9\u4e9b\u5de5\u5177\u6765\u505a\u4ec0\u4e48\uff0c\u4e3a\u907f\u514d\u9650\u5236\u60a8\u7684\u521b\u9020\u529b\u3002\u76f8\u4fe1\u60a8\u53ef\u4ee5\u627e\u5230\u5b83\u4eec\u6700\u4f73\u7684\u4f7f\u7528\u8ba1\u5212\u3002\u4e00\u5207\u4e3a\u4e86\u6b63\u4e49\u7684\u76ee\u7684\u54e6\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_2","title":"\u2014\u200a\u2014\u200a\u5730\u56fe\uff0c\u536b\u661f\u56fe\u50cf\u548c\u8857\u666f\u200a\u2014\u200a\u2014","text":"<p>\u9488\u5bf9 \u4eba\u4e3a\u6216\u81ea\u7136\u707e\u96be\u3001\u6218\u4e89\u3001\u6551\u63f4\u3001\u5927\u578b\u7fa4\u4f53\u4e8b\u4ef6\uff08\u5c24\u5176\u662f\u9020\u6210\u51b2\u7a81\u7684\u65f6\u5019\uff09\u3001\u6740\u622e\u3001\u79cd\u65cf\u6e05\u6d17\u8fd0\u52a8\u3001\u8fb9\u5883\u52a8\u6001\u2026\u2026\u7b49\u7b49\u72b6\u51b5\u7684\u8c03\u67e5\uff0c\u62ff\u5230\u8bc1\u636e\u4ee5\u4fbf\u8ffd\u7a76\u8d23\u4efb\uff0c\u8fd9\u4e9b\u5de5\u5177\u975e\u5e38\u6709\u7528\u3002</p> <p>Bing Maps\uff1aMicrosoft \u536b\u661f\u548c\u5730\u56fe\u670d\u52a1\u3002\u62e5\u6709\u6bd4\u8c37\u6b4c\u66f4\u65b0\u66f4\u5feb\u5206\u8fa8\u7387\u66f4\u9ad8\u7684\u56fe\u50cf\uff1b\u7f3a\u70b9\u662f\u68c0\u67e5\u56fe\u50cf\u7684\u65e5\u671f\u6bd4\u8f83\u96be\uff1b</p> <p>converting coordinates\uff1a\u8fd9\u662f\u4e00\u4e2a\u8f6c\u6362\u5730\u7406\u5750\u6807\u7684\u5de5\u5177\uff1b</p> <p>Copernicus\uff1a\u6b27\u6d32\u822a\u5929\u5c40\u7684\u7f51\u7ad9\u4ee5\u53ca\u54e5\u767d\u5c3c\u516d\u54e8\u5175\u536b\u661f\u7684\u56fe\u50cf\u3002\u6bd4 Landsat \u7684\u5206\u8fa8\u7387\u66f4\u9ad8\u3002\u8bf7\u53c2\u9605\u7f51\u7ad9 GISGeography \u4e0a\u6709\u5173\u5982\u4f55\u4e0b\u8f7d\u548c\u514d\u8d39\u56fe\u50cf\u7684\u8bf4\u660e\uff1b</p> <p>Descartes Labs\uff1a\u4e00\u79cd\u5546\u4e1a\u670d\u52a1\uff0c\u6bcf\u5929\u4ece\u516c\u5171\u548c\u5546\u4e1a\u56fe\u50cf\u63d0\u4f9b\u5546\u5904\u6536\u96c6\u6570\u636e\uff0c\u5bf9\u8bb0\u8005\u7684\u8c03\u67e5\u6765\u8bf4\u6709\u5f88\u597d\u7684\u5e2e\u52a9\uff1b</p> <p>DigitalGlobe\uff1a\u536b\u661f\u56fe\u50cf\u4f9b\u5e94\u5546\u3002\u901a\u8fc7 catalogus \u9884\u89c8\uff0c\u975e\u5e38\u5bb9\u6613\u4f7f\u7528\u7684\u641c\u7d22\u5de5\u5177\uff1b</p> <p>DualMaps\uff1a\u5c06 Google \u7684\u8def\u7ebf\u56fe\u3001\u9e1f\u77b0\u56fe\u548c\u8857\u666f\u89c6\u56fe\u7ed3\u5408\u5728\u4e00\u4e2a\u5d4c\u5165\u5f0f\u5de5\u5177\u4e2d\u3002\u63a2\u7167\u706f\u4e00\u822c\uff1b</p> <p>EarthExplorer\uff1a\u6765\u81ea\u7f8e\u56fd\u5730\u8d28\u5c40\u3002\u4e3b\u8981\u63d0\u4f9b\u7f8e\u56fd\u56fe\u50cf\u3002\u63d0\u4f9b\u5bf9 Landsat \u536b\u661f\u6570\u636e\u4ee5\u53ca NASA \u571f\u5730\u6570\u636e\u4ea7\u54c1\u548c\u670d\u52a1\u7684\u8bbf\u95ee\u3002 USGS \u5168\u7403\u53ef\u89c6\u5316\u67e5\u770b\u5668\uff08GloVis\uff09\u63d0\u4f9b\u9065\u611f\u6570\u636e\u3002USGS \u6863\u6848\u5305\u542b\u5b8c\u6574\u4e14\u7ef4\u62a4\u826f\u597d\u7684 NASA Landsat \u6570\u636e\u96c6\u3002</p> <p>EOS Landviewer\uff1aEOS Landviewer \u63d0\u4f9b\u6700\u591a 10 \u5f20\u56fe\u7247\u7684\u514d\u8d39\u670d\u52a1\u3002\u66f4\u591a\u56fe\u50cf\u548c\u5206\u6790\u4ee5\u6298\u6263\u4ef7\u63d0\u4f9b\u7ed9\u8bb0\u8005\u3002\u8054\u7cfb\u65b9\u5f0f\uff1aArtem Seredyuk artem.seredyuk@eosda.com\u3002 EOS \u6b63\u5728\u5f00\u53d1\u4e00\u9879\u6682\u65f6\u88ab\u79f0\u4e3a EOS Media \u7684\u670d\u52a1\uff0c\u8be5\u670d\u52a1\u5c06\u63d0\u4f9b\u514d\u8d39\u56fe\u50cf\u548c\u4e3b\u8981\u81ea\u7136\u707e\u5bb3\u5206\u6790\u3002</p> <p>ESA Earth Online\uff1a\u6574\u5408\u6b27\u6d32\u822a\u5929\u5c40\u5173\u4e8e\u6e29\u5ea6\u3001\u519c\u4e1a\u548c\u51b0\u76d6\u7b49\u4e3b\u9898\u7684\u5730\u7403\u89c2\u6d4b\u6570\u636e\u3002</p> <p>find2places\uff1a\u5141\u8bb8\u5728\u7ed9\u5b9a\u534a\u5f84\u5185\u4ee5\u7cbe\u786e\u7684\u8ddd\u79bb\u67e5\u8be2\u4e24\u4e2a\u7279\u5b9a\u4f4d\u7f6e\u7684 Google Maps API\u3002\u7528\u4e8e\u5730\u7406\u5b9a\u4f4d\u7167\u7247\u548c\u89c6\u9891\u3002\u8fd9\u662f\u4e2a\u811a\u672c\uff0c\u7528\u6237\u754c\u9762\u8fd8\u4e0d\u90a3\u4e48\u597d\u770b\u3002\u5173\u8054\u6211\u4eec\u7684\u6587\u7ae0\u300a\u7528\u4e8e\u4fe1\u606f\u9a8c\u8bc1\u7684\u57fa\u672c\u5730\u7406\u5b9a\u4f4d\u5de5\u5177\u300b</p> <p>Geograph\uff1a\u5730\u7406\u914d\u51c6\u56fe\u50cf\u3002</p> <p>GeoNames\uff1a\u4f4d\u7f6e\u540d\u79f0\u6570\u636e\u5e93\u3002\u591a\u8bed\u79cd\u7684\uff0c\u4ee5\u53ca\u5404\u79cd\u4e0d\u540c\u7684\u62fc\u5199\u3002</p> <p>GeoVisual Search\uff1a\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u7528\u6237\u76f4\u89c2\u5730\u67e5\u8be2\u56fe\u50cf\u4ee5\u83b7\u5f97\u7c7b\u4f3c\u7684\u5730\u7406\u7279\u5f81\u3002\u8fd9\u4e2a\u7b1b\u5361\u5c14\u5b9e\u9a8c\u5ba4\u7684\u5e73\u53f0\u5efa\u7acb\u5728 Landsat\u3001\u56fd\u5bb6\u519c\u4e1a\u56fe\u50cf\u8ba1\u5212\uff08NAIP\uff09\u548c PlanetScope \u7684\u536b\u661f\u56fe\u50cf\u57fa\u7840\u4e0a\u3002\u8fd9\u91cc\u8bfb\u5230\u5173\u4e8e\u5982\u4f55\u4f7f\u7528\u5b83\u7684\u8bf4\u660e\u3002</p> <p>Google Earth Pro\uff1a\u6dfb\u52a0 Bing \u5730\u56fe\u536b\u661f\u56fe\u50cf\u56fe\u5c42\u3002\u4f18\u70b9\u662f\u6709**\u5386\u53f2\u56fe\u50cf\u3002**</p> <p>Google Earth Engine\uff1a\u5f00\u653e\u5f0f\u536b\u661f\u56fe\u50cf\u548c\u5206\u6790\u6846\u67b6\u3002\u5b9e\u9645\u4e0a\uff0c\u4ece NASA\uff0cNOAA\uff0cUSGS \u7b49\u6536\u96c6\u7684\u4efb\u4f55\u536b\u661f\u56fe\u50cf\u90fd\u662f\u53ef\u7528\u7684\u3002\u53ef\u80fd\u7565\u6709\u4e9b\u7c97\u7cd9\uff0c\u4e0d\u662f\u9ad8\u5206\u8fa8\u7387\u7684\u5546\u4e1a\u56fe\u50cf\u3002\u7528 Javascript \u5b66\u4e60\u66f2\u7ebf\u3002</p> <p>Google Maps\uff1aStreetView\u3001\u7f8e\u56fd\u6b27\u6d32\u8bb8\u591a\u5927\u57ce\u5e02\u90fd\u53ef\u89c1\uff0c\u4ee5 3D \u4e3a\u84dd\u672c\u3002\u7f3a\u70b9\u662f\u6ca1\u6709\u5386\u53f2\u536b\u661f\u56fe\u50cf\uff0c\u4f46\u8bb8\u591a\u5730\u65b9\u90fd\u6709**\u5386\u53f2\u8857\u666f\u56fe\u50cf**\u3002</p> <p>HERE WeGo\uff1a\u5bf9\u4e8e\u4e2d\u4e1c\u4e8b\u4ef6\u8c03\u67e5\u6765\u8bf4\uff0c\u5b83\u6709\u6bd4\u8c37\u6b4c\u6700\u8fd1\u7684\u536b\u661f\u56fe\u50cf\u3002</p> <p>Mapchecking\uff1a\u8ba1\u7b97\u6240\u9009 Google \u5730\u56fe\u533a\u57df\u4e2d\u7684**\u4eba\u6570**\u3002\u5355\u51fb\u5730\u56fe\u4ee5\u6dfb\u52a0\u70b9\u5e76\u7ed8\u5236\u533a\u57df\u3002\u96c6\u4f1a\u3001\u7fa4\u4f53\u4e8b\u4ef6\u3001\u6216\u8005\u6551\u707e\u2026\u2026\u7b49\u7b49\uff0c\u90fd\u9002\u7528\u3002</p> <p>Mapillary\uff1a\u4f17\u5305\u8857\u9053\u7167\u7247\u3002\u662f\u5bf9 Google Streetview \u7684\u6709\u7528\u8865\u5145\u3002\u4e0d\u8fc7\u5bf9\u4e8e\u4e2d\u4e1c\u5730\u533a\u6765\u8bf4\u4e0d\u597d\u7528\uff0c\u5728\u53d9\u5229\u4e9a\u3001\u4f0a\u62c9\u514b\u7b49\u56fd\u5bb6\u51e0\u4e4e\u627e\u4e0d\u5230\u3002</p> <p>NASA EarthData\uff1aWorldView \u5141\u8bb8\u4ece NASA \u53ef\u89c6\u5316\u8fd1**\u5b9e\u65f6**\u7684\u56fe\u50cf\u3002\u4f18\u52bf\u5f88\u591a\uff0c\u5404\u79cd\u536b\u661f\u548c\u822a\u62cd\u56fe\u50cf; \u5e7f\u6cdb\u7684\u641c\u7d22\u6807\u51c6; \u4ee5\u53ca\u5176\u4ed6\u5730\u56fe\u548c\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u4f8b\u5982\u7528\u4e8e\u706b\u707e\u4e8b\u4ef6\u8c03\u67e5\u7684 FIRMS\uff0c\u7b49\u7b49\u3002\u53ef\u8bbf\u95ee\u5341\u51e0\u4e2a NASA \u6570\u636e\u4e2d\u5fc3\u548c\u76f8\u5173\u7684\u536b\u661f\u6570\u636e\u4ea7\u54c1\u3002\u7f8e\u56fd\u5b87\u822a\u5c40\u5730\u7403\u89c2\u6d4b\uff1a\u5927\u6c14\u3001\u9646\u5730\u3001\u6d77\u6d0b\u3001\u80fd\u6e90\u3001\u73af\u5883\u7b49 50 \u591a\u4e2a\u6570\u636e\u96c6\u3002</p> <p>Old Maps Online\uff1a\u901a\u8fc7\u4e16\u754c\u5404\u5730\u7684\u4f17\u591a\u6570\u636e\u5e93\u67e5\u627e\u65e7\u5730\u56fe\u3002\u6613\u4e8e\u4f7f\u7528\uff0c\u4e0e DigitalGlobe \u76ee\u5f55\u7c7b\u4f3c\u7684\u6d4f\u89c8\u3002</p> <p>OpenStreetCam\uff1a\u6b63\u5982\u5176\u540d\u3002</p> <p>OpenStreetMap\uff1a\u6b63\u5982\u5176\u540d\u3002</p> <p>Radiant Earth\uff1a\u975e\u8425\u5229\u7ec4\u7ec7\uff0c\u5e2e\u52a9\u5168\u7403\u53d1\u5c55\u793e\u533a\u53d1\u73b0\u3001\u63a2\u7d22\u548c\u5206\u6790**\u536b\u661f\u3001\u65e0\u4eba\u673a\u548c\u822a\u7a7a\u56fe\u50cf\u6863\u6848**\u3002</p> <p>Resource Watch\uff1a\u4e00\u4e2a\u4ecd\u5904\u4e8e\u6d4b\u8bd5\u9636\u6bb5\u7684\u975e\u8425\u5229\u5e73\u53f0\uff0c\u63d0\u4f9b\u6709\u5173\u5730\u7403\u8d44\u6e90\u548c\u516c\u6c11\u72b6\u6001\u7684\u6570\u767e\u4e2a\u6570\u636e\u96c6\u3002\u7531\u4e16\u754c\u8d44\u6e90\u7814\u7a76\u6240\u548c\u5176\u4ed6\u7ec4\u7ec7\u8d5e\u52a9\u3002\u8d44\u6e90\u76d1\u89c6\u6570\u636e\u662f\u514d\u8d39\u7684\uff0c\u7528\u6237\u53ef\u4ee5\u4e0b\u8f7d\u6570\u636e\u3002</p> <p>Sentinel Hub Playground\uff1aSentinel 2 / Landsat \u56fe\u50cf\u7684\u7528\u6237\u53cb\u597d\u5e73\u53f0\u3002\u6bcf 5\u201310 \u5929\u66f4\u65b0\u4e00\u6b21\u65b0\u56fe\u50cf\uff0c\u80fd\u591f\u63a2\u7d22\u5404\u79cd GIS \u53d8\u91cf\uff0c\u4f8b\u5982 NDVI \u6216 NDWO\u3002 EO \u6d4f\u89c8\u5668\u6709\u52a9\u4e8e\u5ef6\u65f6\u5ba1\u67e5\u3002\u7f3a\u70b9\u662f\u4e00\u822c\u5206\u8fa8\u7387\u4f4e\u81f310m / px\u3002</p> <p>TerraServer\uff1a\u536b\u661f\u56fe\u50cf\u4f9b\u5e94\u5546\u3002\u6700\u9ad8\u5206\u8fa8\u7387\uff080.3m\uff09\u3002\u9884\u89c8\u9ad8\u5206\u8fa8\u7387\u536b\u661f\u56fe\u50cf\u8981\u4ed8\u8d39\u3002</p> <p>Wikimapia\uff1a\u4e0e\u5730\u7406\u4f4d\u7f6e\u76f8\u5173\u7684\u4f17\u5305\u4fe1\u606f\u3002\u53ef\u4ee5\u5728 Google / Bing / OSM \u4e4b\u95f4\u5207\u6362\u3002\u5927\u91cf\u7684 UCG \u4fe1\u606f\u3002\u53ef\u80fd\u6709\u70b9\u6ede\u540e\uff0c\u9700\u8981\u5728\u89c6\u56fe\u641c\u7d22\u540e\u5237\u65b0\u9875\u9762\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_3","title":"\u2014\u200a\u2014\u200a\u57fa\u4e8e\u5730\u7406\u7684\u641c\u7d22\u200a\u2014\u200a\u2014","text":"<p>\u9a8c\u8bc1\u4fe1\u606f\u771f\u4f2a\u3001\u8ddf\u8e2a\u4e8b\u4ef6\u53d1\u5c55</p> <p>Animaps\uff1a\u521b\u5efa\u81ea\u5b9a\u4e49\u52a8\u753b\u5730\u56fe\u3002\u4f18\u70b9\u662f\u6709\u53ef\u7528\u4e8e\u8c03\u67e5\u7684\u65f6\u95f4\u7ebf\u8bb0\u5f55\uff0c\u4e0d\u8fc7\u7ef4\u62a4\u7684\u4e0d\u5927\u597d\u3002</p> <p>Echosec\uff1a\u57fa\u4e8e\u5730\u7406\u7684\u641c\u7d22\u3002\u6bd4\u5982**\u6765\u81ea\u793e\u4ea4\u5a92\u4f53\u7684\u4fe1\u606f** Twitter\uff0cVKontakte\uff0cFoursquare \u7684**\u67e5\u8bc1**\u3002\u7f3a\u70b9\u662f\u4e0d\u80fd\u67e5 Facebook\u3001\u6b63\u7248 Instagram\u3002</p> <p>Liveuamap\uff1a\u51b2\u7a81\u65b0\u95fb\u7684\u4e92\u52a8\u5b9e\u65f6\u5730\u56fe\u3002\u73b0\u6709\u5404\u79cd\u56fd\u5bb6\uff1a\u963f\u5bcc\u6c57\uff0c\u4f0a\u62c9\u514b\uff0c\u53d9\u5229\u4e9a\uff0c\u7f8e\u56fd\uff0c\u4e4c\u514b\u5170\uff0c\u59d4\u5185\u745e\u62c9\u7b49\uff0c\u522b\u7684\u5de5\u5177\u6316\u4e0d\u5230\u7684\u56fd\u5bb6\u8fd9\u91cc\u53ef\u4ee5\u3002</p> <p>Photo-Map.RU\uff1a\u53ef\u4ee5\u67e5\u8bc1\u5e26\u6709\u5730\u7406\u6807\u8bb0\u7684 VKontakte \u5e16\u5b50\u3002\u548c SnRadar \u4f5c\u7528\u4e00\u6837\u3002</p> <p>Twitter\uff1a\u5728\u641c\u7d22\u6846\u4e2d\u63d2\u5165 \u5730\u7406\u7f16\u7801\uff1a[coordinates]\uff0c[radius-km]\uff0c\u4f8b\u5982\uff1ageocode:36.222285,43.998233,2km (only works with km, so 500m = 0.5km) \u5927\u90e8\u5206\u65f6\u95f4\u80fd\u627e\u5230\u4f60\u60f3\u8981\u7684\u4e1c\u897f\u3002\u7f3a\u70b9\u662f\uff0c\u5b9a\u4f4d\u5bb9\u6613\u9020\u5047\uff0c\u9700\u8981\u7ed3\u5408\u5176\u4ed6\u4fe1\u606f\u4ee5\u9a8c\u8bc1\u3002</p> <p>WarWire\uff1a\u57fa\u4e8e\u5730\u7406\u5b9a\u4f4d\u7684\u641c\u7d22\u3002\u9a8c\u8bc1\u6765\u81ea\u793e\u4ea4\u5a92\u4f53\u5982 Twitter, VKontakte, Instagram \u7684\u5e16\u5b50</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_4","title":"\u2014\u200a\u2014\u200a\u56fe\u50cf\u3001\u89c6\u9891\u548c\u5143\u6570\u636e\u200a\u2014\u200a\u2014","text":"<p>\u773c\u89c1\u4e0d\u4e00\u5b9a\u4e3a\u5b9e\u3002\u4fe1\u606f\u88ab\u9020\u5047\u4e86\u5417\uff1f\u771f\u76f8\u662f\u4ec0\u4e48\uff1f</p> <p>Amnesty YouTube Dataviewer\uff1a\u53cd\u8f6c\u56fe\u50cf\uff08\u4ee5\u53ca\u89c6\u9891\uff09\u641c\u7d22\uff0c\u627e\u5230\u7cbe\u786e\u7684\u4e0a\u4f20\u65f6\u95f4\u3002\u7f3a\u70b9\u662f\u641c\u7d22\u5305\u542b\u591a\u4e2a\u9759\u6b62\u56fe\u50cf\uff0c\u800c\u4e0d\u662f\u6bcf\u4e2a\u5e27\uff08\u56e0\u6b64\u53ef\u80fd\u6709\u4e9b\u4e1c\u897f\u88ab\u7565\u6389\u4e86\uff09</p> <p>\u9644\uff1a\u300a\u9a8c\u8bc1\u56fe\u50cf\u548c\u89c6\u9891\u5185\u5bb9\u7684\u6307\u5357\u300b</p> <p>Exiftool\uff1a\u8bfb\u53d6\u548c\u64cd\u4f5c\u5927\u91cf\u6587\u4ef6\u7c7b\u578b\u7684**\u5143\u6570\u636e**\u3002\u6ce8\u610f\uff1a\u6ca1\u6709 GUI\u3002\u4f18\u70b9\u662f Floss\u3001Cross\u5e73\u53f0\uff0c\u975e\u5e38\u5bb9\u6613\u96c6\u6210\u5728\u811a\u672c\u4e2d\u3002\u76ee\u524d\u53ea\u80fd\u7528\u4e8eGNU / Linux\u3002</p> <p>Foca\uff1a\u63d0\u53d6\u5143\u6570\u636e\u7528\u7684\u3002\u57fa\u4e8e Windows\uff0c2017 \u5e74\u5f00\u6e90\u3002\u7f3a\u70b9\u662f\u6ca1\u6709\u672c\u673a linux \u652f\u6301\uff08\u9700\u8981\u5728 linux \u4e2d\u5b89\u88c5 wine\uff09</p> <p>FotoForensics\uff1a\u4e00\u4e2a**\u56fe\u50cf\u53d6\u8bc1**\u5de5\u5177\u3002\u57fa\u4e8e web, \u4f7f\u7528\u7b80\u5355\u3002\u7f3a\u70b9\u662f\u53ea\u80fd\u516c\u5171\u8bbf\u95ee\u3002</p> <p>GooFile\uff1a\u4e5f\u662f\u63d0\u53d6\u5143\u6570\u636e\u7684\u5de5\u5177\uff0c\u4e5f\u5f88\u65b9\u4fbf\u4f7f\u7528\u3002\u7f3a\u70b9\u662f\u5728 Kali \u4ee5\u5916\u4e0d\u80fd\u5f88\u597d\u5730\u5de5\u4f5c\u3002</p> <p>Image Forensics\uff1a\u57fa\u4e8e Web \u7684\u56fe\u50cf\u53d6\u8bc1\u5de5\u5177\u3002\u53ef\u4ee5\u8f7b\u677e**\u8bc6\u522b\u4f2a\u9020\u6216\u7be1\u6539\u7684\u56fe\u50cf**\u3002\u4e5f\u662f\u53ea\u80fd\u516c\u5171\u8bbf\u95ee\u3002</p> <p>InVID\uff1a\u8fd9\u662f\u4e00\u4e2a\u9a8c\u8bc1\u63d2\u4ef6\uff0c\u4ee5\u5e2e\u52a9\u8bb0\u8005\u9a8c\u8bc1\u56fe\u50cf\u548c\u89c6\u9891\u3002\u4e0a\u4e0b\u6587\u6570\u636e\u3001\u5143\u6570\u636e\u3001\u53cd\u5411\u641c\u7d22\uff08\u8c37\u6b4c\uff0cYandex\uff09\u3001\u56fe\u50cf\u53d6\u8bc1\u7b49\u3002</p> <p>Irfanview\uff1a\u63d0\u53d6\u5143\u6570\u636e\u7684\u5de5\u5177\u3002\u57fa\u4e8e Windows\u3002\u7f3a\u70b9\u662f\u4e0d\u652f\u6301 Linux\u3002</p> <p>Jeffrey\u2019s Image Metadata Viewer\uff1a\u5728\u7ebf\u63d0\u53d6\u5143\u6570\u636e\u7684\u5de5\u5177\u3002\u53ea\u9700\u8981 Web \u6d4f\u89c8\u5668\u5c31\u53ef\u4ee5\u3002\u4f46\u4e5f\u662f\u53ea\u80fd\u516c\u5171\u8bbf\u95ee\u3002</p> <p>Reveal Image Verification Assistant\uff1a\u63d0\u4f9b\u516b\u4e2a\u8fc7\u6ee4\u5668\u6765\u68c0\u6d4b\u9759\u6b62\u56fe\u50cf\u7684\u53d8\u5316\u3002\u57fa\u4e8e Web \u7684\u56fe\u50cf\u5de5\u5177\u3002\u4e5f\u53ef\u5728 InVID \u9a8c\u8bc1\u63d2\u4ef6\u4e2d\u4f7f\u7528\u3002</p> <p>reverse image search\uff1a\u5728\u4e92\u8054\u7f51\u4e0a\u627e\u5230\u7c7b\u4f3c\u7684\u56fe\u50cf\u3002\u975e\u5e38\u5bb9\u6613\u4f7f\u7528\u3002\u63a8\u8350\u63d2\u4ef6\uff1aRevEye</p> <p>SpiderPig\uff1a\u63d0\u53d6\u5143\u6570\u636e\u3002\u547d\u4ee4\u884c\u754c\u9762\u548c\u811a\u672c\u5f88\u68d2\u3002\u4f46\u662f\u4f7f\u7528**\u9700\u8981\u4e00\u70b9\u6280\u672f\u77e5\u8bc6**\u3002</p> <p>Splunk\uff1a\u4e5f\u662f\u63d0\u53d6\u5143\u6570\u636e\u3002\u53ef\u4ee5\u62a5\u544a\u7b49\u7ea7\u5206\u6790\u548c\u6f14\u793a\u3002\u7f3a\u70b9\u662f\u8bbe\u7f6e\u548c\u90e8\u7f72\u4e0d\u592a\u7b80\u5355\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_5","title":"\u2014\u200a\u2014\u200a\u793e\u4ea4\u5a92\u4f53\u200a\u2014\u200a\u2014","text":"<p>\u793e\u4ea4\u5a92\u4f53\u662f\u6316\u6398\u771f\u76f8\u7684\u91d1\u77ff\u3002\u5bf9\u4e8e\u4e0d\u540c\u5e73\u53f0\u6765\u8bf4\u5de5\u5177\u4e0d\u540c\uff0c\u8981\u627e\u5230\u8d81\u624b\u7684\u6316\u6398\u5de5\u5177\u9700\u8981\u70b9\u7814\u7a76\u3002</p> <p>1\u3001\u5bf9\u4e8e Facebook</p> <p>Graph.tips\uff1a\u81ea\u52a8\u9ad8\u7ea7\u641c\u7d22 Facebook \u4e2a\u4eba\u8d44\u6599\u3002</p> <p>Who posted what?\uff1a\u67e5\u627e Facebook \u5e16\u5b50\u3002</p> <p>IntelTechniques\uff1a\u7528\u4e8e\u5206\u6790 Facebook \u4e2a\u4eba\u8d44\u6599\u548c\u9875\u9762\u7684\u5404\u79cd\u5de5\u5177\u3002</p> <p>Facebook livemap\uff1a\u641c\u6765\u81ea\u5168\u4e16\u754c\u5404\u5730\u7684\u73b0\u573a**\u76f4\u64ad**\u3002</p> <p>Search Tool\uff1a\u6309\u540d\u79f0\u3001\u7535\u5b50\u90ae\u4ef6\u3001\u5c4f\u5e55\u540d\u79f0\u548c\u7535\u8bdd\u67e5\u627e\u5e10\u6237\u3002</p> <p>StalkScan\uff1a\u6bcf\u4e2a Facebook \u4e2a\u4eba\u8d44\u6599\u7684\u81ea\u52a8\u9ad8\u7ea7\u641c\u7d22\u3002</p> <p>Video Downloader Online\uff1a\u4e0b\u8f7d Facebook \u89c6\u9891\u3002</p> <p>Skopenow\uff1a\u793e\u4ea4\u5a92\u4f53\u8c03\u67e5\u200a\u2014\u200a\u59d3\u540d\u3001\u7535\u8bdd\u3001\u7535\u5b50\u90ae\u4ef6\u3001\u7528\u6237\u540d\u641c\u7d22\u3002</p> <p>2\u3001Instagram</p> <p>Websta\uff1a\u5728\u7279\u5b9a\u5730\u70b9\u9644\u8fd1\u7684 Instagram \u6570\u636e\u5e93\u4e2d\u67e5\u627e\u5176\u4ed6\u4f4d\u7f6e\u3002\u4f7f\u7528\u5e26\u6709\u4f4d\u7f6e ID \u7684\u76f4\u63a5 URL\uff0c\u4f8b\u5982 websta.me/location/116231</p> <p>StoriesIG\uff1a\u4e0b\u8f7d Instagram \u6d88\u606f\u7684\u5de5\u5177\u3002</p> <p>Save Instagram Stories\uff1a\u5141\u8bb8\u60a8\u5bf9\u5df2\u4fdd\u5b58\u7684\u62a5\u9053\u8fdb\u884c\u7528\u6237\u540d\u641c\u7d22\u3002</p> <p>3\u3001LinkedIn</p> <p>Socilab\uff1a\u53ef\u89c6\u5316\u548c\u5206\u6790\u60a8\u81ea\u5df1\u7684 LinkedIn \u7f51\u7edc\u3002</p> <p>4\u3001Reddit</p> <p>F5Bot\uff1a\u5f53 Reddit \u4e0a\u63d0\u5230\u67d0\u4e2a\u5173\u952e\u5b57\u65f6\uff0c\u5411\u60a8\u53d1\u9001\u7535\u5b50\u90ae\u4ef6\u3002</p> <p>5\u3001Snapchat</p> <p>Snap Map\uff1a\u53ef\u641c\u7d22\u7684\u5730\u7406\u6807\u8bb0 Snap \u5730\u56fe\u3002</p> <p>6\u3001Tumblr</p> <p>Tumblr Originals\uff1a\u67e5\u627e\u6bcf\u4e2a Tumblr \u7684**\u539f\u59cb**\u5e16\u5b50\uff0c\u4ece\u800c\u6392\u9664 reblogs\u3002</p> <p>7\u3001Twitter</p> <p>InVID verification plugin\uff1aInVID \u63d2\u4ef6\u6309\u65f6\u95f4\u95f4\u9694\u63d0\u4f9b Twitter \u9ad8\u7ea7\u641c\u7d22\u3002\u5141\u8bb8\u5728\u6ca1\u6709 API \u548c\u65f6\u95f4\u9650\u5236\u7684\u60c5\u51b5\u4e0b\u8bb0\u5f55\u8fc7\u53bb\u7684\u7528\u4f8b\u3002\u5141\u8bb8\u5728**\u7a81\u53d1\u65b0\u95fb\u540e\u641c\u7d22\u7528\u6237\u5b9a\u4e49\u7684\u65f6\u95f4\u8303\u56f4\u5185\u7684\u5185\u5bb9**\u3002\u5728Twitter\u9ad8\u7ea7\u641c\u7d22\u4e2d\u81ea\u52a8\u6267\u884c\u65e5\u5386\u65e5\u671f\u548c Unix \u65f6\u95f4\u6233\u4e4b\u95f4\u7684\u8f6c\u6362\u3002\u5728\u8fd9\u91cc\u770b\u5230\uff1ahttps://youtu.be/nmgbFODPiBY</p> <p>Fake video news debunker by InVID</p> <p>Onemilliontweetmap\uff1a\u63a8\u6587\u5730\u56fe\u6bcf\u4e2a\u5730\u70b9\u6700\u957f 6 \u4e2a\u5c0f\u65f6\uff0c\u5173\u952e\u5b57\u641c\u7d22\u9009\u9879\u3002</p> <p>Treeverse\uff1aChrome \u6269\u5c55\u7a0b\u5e8f\uff0c\u53ef\u89c6\u5316 Twitter \u5bf9\u8bdd\u3002</p> <p>Tweetreach\uff1a\u627e\u5230\u63a8\u6587\u7684\u8303\u56f4\u3002\u63d0\u4f9b\u9ad8\u7ea7\u641c\u7d22\u8fd0\u7b97\u7b26\uff0c\u4e0e Google \u9ad8\u7ea7\u641c\u7d22\u76f8\u540c\u3002\u5173\u4e8e\u8c37\u6b4c\u7684\u8fd0\u7b97\u7b26\u6211\u4eec\u5c06\u6765\u4f1a\u6709\u4e13\u95e8\u7684\u6587\u7ae0\u8be6\u7ec6\u4ecb\u7ecd\uff01</p> <p>Twitter advanced search\uff1a\u67e5\u627e\u65e5\u671f\u3001\u5173\u952e\u5b57\u7b49\u7b49\u3002</p> <p>Twitter geobased search\uff1a\u5730\u7406\u7f16\u7801\uff1a[coordinates]\uff0c[radius-km]\uff0c\u4f8b\u5982\uff1ageocode\uff1a36.222285,43.998233,2km</p> <p>Twlets\uff1a\u5728 Excel \u5de5\u4f5c\u8868\u4e2d\u4e0b\u8f7d\u4efb\u4f55\u4eba\u7684\u63a8\u6587\uff0c\u5173\u6ce8\u8005\u3001\u53ca\u70b9\u8d5e\u7684\u5185\u5bb9\u3002\u4f7f\u7528\u65b9\u4fbf\u5feb\u6377\uff0c\u8fd8\u6709\u4e00\u4e2a Chrome \u6269\u5c55\u7a0b\u5e8f\u3002\u6700\u591a\u53ef\u83b7\u5f97 3,200 \u6761\u63a8\u6587\uff0c\u5173\u6ce8\u8005\u548c\u70b9\u8d5e\u3002</p> <p>quarter tweets\uff1a\u57fa\u4e8e\u5730\u7406\u4f4d\u7f6e\u7684 Twitter \u641c\u7d22\u3002</p> <p>8\u3001YouTube</p> <p>Amnesty YouTube Dataviewer\uff1a\u53cd\u8f6c\u56fe\u50cf\uff08\u89c6\u9891\u9759\u6b62\uff09\u641c\u7d22\u4ee5\u53ca\u7cbe\u786e\u4e0a\u4f20\u65f6\u95f4\u3002\u641c\u7d22\u4e00\u4e9b\u9759\u6b62\u753b\u9762\u800c\u4e0d\u662f\u6bcf\u4e2a\u5e27\uff08\u56e0\u6b64\u53ef\u80fd\u7701\u7565\u4e86\u7ed3\u679c\uff09\u3002</p> <p>Geo Search Tool\uff1a\u6839\u636e\u4f4d\u7f6e\u641c\u7d22 YouTube \u89c6\u9891\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_6","title":"\u2014\u200a\u2014\u200a\u8fd0\u8f93\u4fe1\u606f\u200a\u2014\u200a\u2014","text":"<p>\u4f60\u77e5\u9053\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\u3002\u5b83\u4eec\u975e\u5e38\u6709\u7528\u3002\u5f53\u793e\u4ea4\u7f51\u7edc\u4e0a\u4eba\u4eec\u5c06\u540d\u4eba\u3001\u653f\u5ba2\u3001\u519b\u961f\u7b49\u76f8\u5173\u51fa\u884c\u548c\u8c03\u9063\u7684\u6d88\u606f\u53d1\u5e03\u5e76\u4f20\u64ad\u65f6\uff0c\u4f60\u53ef\u4ee5\u67e5\u8bc1\u90a3\u4e9b\u4e1c\u897f\u7a76\u7adf\u662f\u771f\u662f\u5047\uff0c\u5e76\u4e14\u80fd\u6bd4\u5176\u4ed6\u4eba\u66f4\u5207\u5b9e\u5730\u505a\u5230\u5bf9\u91cd\u8981\u4fe1\u606f\u7684\u8ddf\u8e2a</p> <p>1\u3001\u7a7a\u8fd0</p> <p>AirNav RadarBox\uff1a\u8ddf\u8e2a\u822a\u73ed\uff0c\u5305\u62ec\u79c1\u4eba\u7684\u548c\u519b\u7528\u7684\u55b7\u6c14\u5f0f\u98de\u673a\u3002\u4e00\u4e2a Windows PC \u8f6f\u4ef6\u548c\u786c\u4ef6\u5305\uff0c\u5141\u8bb8\u5728\u6a21\u62df\u96f7\u8fbe\u5c4f\u5e55\u4e0a\u770b\u5230\u9002\u5f53\u88c5\u5907\u7684\u98de\u673a\u3002\u5c0f\u578b\u63a5\u6536\u5668\u901a\u8fc7 USB \u8fde\u63a5\u5230 PC\uff0c\u4f7f\u7528\u63d0\u4f9b\u7684\u5c0f\u578b\u5929\u7ebf\u68c0\u6d4b\u98de\u673a\u3002\u901a\u8fc7\u89e3\u7801\u6765\u81ea\u98de\u673a\u7684 ADS-B \u4f20\u8f93\uff0c\u8fd9\u4e9b\u98de\u673a\u4ee5\u7c7b\u4f3c\u4e8e\u7a7a\u4e2d\u4ea4\u901a\u7ba1\u5236\u6240\u4f7f\u7528\u7684\u663e\u793a\u5668\u663e\u793a\u5728\u8ba1\u7b97\u673a\u4e0a\u3002\u822a\u73ed\u53f7\uff0c\u98de\u673a\u7c7b\u578b\uff0c\u9ad8\u5ea6\uff0c\u822a\u5411\uff0c\u901f\u5ea6\u6bcf\u79d2\u90fd\u53ef\u89c1\u5e76\u66f4\u65b0\u3002</p> <p>ADS-B Exchange Global Radar\uff1a\u8ddf\u8e2a\u822a\u73ed\uff0c\u5305\u62ec\u4e00\u4e9b**\u519b\u7528\u98de\u673a**\u3002\u4f60\u61c2\u7684\u3002</p> <p>FlightAware\uff1a\u4e16\u754c\u4e0a\u6700\u5927\u7684\u822a\u73ed\u8ddf\u8e2a\u7f51\u7ad9\u3002\u4e00\u5bb6\u603b\u90e8\u4f4d\u4e8e\u5fb7\u514b\u8428\u65af\u5dde\u4f11\u65af\u987f\u7684\u5168\u7403\u822a\u7a7a\u8f6f\u4ef6\u548c\u6570\u636e\u670d\u52a1\u516c\u53f8\u3002 \u8be5\u516c\u53f8\u8fd0\u8425\u7740\u4e00\u4e2a\u7f51\u7ad9\u548c\u79fb\u52a8\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u5728\u7f8e\u56fd\uff0c\u52a0\u62ff\u5927\uff0c\u6fb3\u5927\u5229\u4e9a\u548c\u65b0\u897f\u5170\u63d0\u4f9b\u79c1\u4eba\u548c\u5546\u7528\u98de\u673a\u7684\u514d\u8d39\u822a\u73ed\u8ddf\u8e2a\u3002</p> <p>FlightRadar24\uff1a\u8fd9\u4e2a\u662f\u6700\u5e38\u7528\u7684\u3002\u8ddf\u8e2a**\uff08\u6c11\u7528\uff09\u822a\u73ed**\u3002\u4ed8\u8d39\u7248\u53ef\u4ee5\u8fd4\u56de**12\u4e2a\u6708\u7684\u6863\u6848**\u3002</p> <p>PlaneFinder\uff1a\u57fa\u4e8e\u82f1\u56fd\u7684\u5b9e\u65f6\u822a\u73ed\u8ddf\u8e2a\u670d\u52a1\uff0c\u80fd\u591f\u663e\u793a\u6709\u5173\u822a\u73ed\u5f00\u9500\u4ee5\u53ca\u5168\u7403\u822a\u73ed\u7684\u6570\u636e\u3002\u7528\u6237\u53ef\u83b7\u5f97\u7684\u6570\u636e\u5305\u62ec\uff1a\u822a\u73ed\u53f7\uff0c\u98de\u673a\u79fb\u52a8\u901f\u5ea6\uff0c\u65c5\u884c\u9ad8\u5ea6\u548c\u76ee\u7684\u5730\u3002\u8be5\u670d\u52a1\u7684\u51e0\u79cd\u53d8\u4f53\u53ef\u7528\u4f5c\u79fb\u52a8\u5e94\u7528\u7a0b\u5e8f\uff0c\u5305\u62ec\u514d\u8d39\uff0c\u9ad8\u7ea7 3D \u548c\u589e\u5f3a\u73b0\u5b9e\u7248\u672c\u3002 Web \u6d4f\u89c8\u5668\u53ef\u4ee5\u8bbf\u95ee\u822a\u73ed\u8ddf\u8e2a**\u5730\u56fe\u548c\u6570\u636e\u5e93\u3002**</p> <p>2\u3001\u6d77\u8fd0</p> <p>MarineTraffic\uff1a\u4e00\u4e2a\u5f00\u653e\u7684\uff0c\u4ee5\u793e\u533a\u4e3a\u57fa\u7840\u7684\u9879\u76ee\uff0c\u63d0\u4f9b\u6709\u5173\u8239\u8236\u8fd0\u52a8\u7684\u5b9e\u65f6\u4fe1\u606f\u4ee5\u53ca\u8239\u8236\u5728\u6e2f\u53e3\u548c\u6e2f\u53e3\u7684\u5f53\u524d\u4f4d\u7f6e\u3002\u8239\u8236\u4fe1\u606f\u6570\u636e\u5e93\u5305\u62ec\uff0c\u4f8b\u5982\uff0c\u8239\u8236\u5efa\u9020\u5730\u70b9\u548c\u8239\u8236\u5c3a\u5bf8\uff0c\u603b\u5428\u4f4d\u548c\u56fd\u9645\u6d77\u4e8b\u7ec4\u7ec7\u7f16\u53f7\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u7528\u6237\u53ef\u4ee5\u63d0\u4ea4\u5176\u4ed6\u7528\u6237\u53ef\u4ee5\u8bc4\u4ef7\u7684\u8239\u53ea\u7167\u7247\u3002 \u57fa\u672c\u7684 MarineTraffic \u670d\u52a1\u53ef\u514d\u8d39\u4f7f\u7528;\u66f4\u591a\u9ad8\u7ea7\u529f\u80fd\u53ef\u4f9b\u652f\u4ed8\u3002</p> <p>3\u3001\u94c1\u8def</p> <p>Trains\uff1a\u6b27\u6d32\u5404\u56fd\u94c1\u8def\u7f51\u7edc\u7684\u5b8c\u6574\u4e92\u52a8\u5730\u56fe\u3002\u60f3\u60f3\u201c\u4e00\u5e26\u4e00\u8def\u201d\u2026\u2026</p> <p>4\u3001\u5176\u4ed6</p> <p>WikiRoutes\uff1a\u516c\u5171\u4ea4\u901a\u6570\u636e\u5e93\u3002wiki \u5e94\u7528\u200a\u2014\u200a\u2014 \u4e16\u754c\u516c\u5171\u4ea4\u901a\u6570\u636e\u5e93\u7531\u4eba\u4eec\u6839\u636e\u7ef4\u57fa\u5a92\u4f53\u7684\u539f\u5219\u7f16\u8f91\u3002\u6dfb\u52a0\u60a8\u6240\u5728\u57ce\u5e02\u7684\u8def\u7ebf\uff0c\u8be5\u8def\u7ebf\u4f1a\u7acb\u5373\u663e\u793a\u5728\u7f51\u7ad9\u548c\u79fb\u52a8\u5e94\u7528\u4e2d\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_7","title":"\u2014\u200a\u2014\u200a\u65e5\u671f\u548c\u65f6\u95f4\u200a\u2014\u200a\u2014","text":"<p>\u79d1\u5b66\u65b9\u6cd5\uff0c\u5224\u65ad\u4fe1\u606f\u771f\u4f2a</p> <p>SunCalc\uff1a\u5728\u7ed9\u5b9a\u7684\u4e00\u5929\u91cc\u5728\u7ed9\u5b9a\u7684\u4f4d\u7f6e\u663e\u793a\u9633\u5149\u7684\u79fb\u52a8\u3002\u7ec6\u6a59\u8272\u66f2\u7ebf\u662f\u5f53\u524d\u7684\u592a\u9633\u8f68\u8ff9\uff0c\u5468\u56f4\u7684\u9ec4\u8272\u533a\u57df\u662f\u4e00\u5e74\u4e2d\u592a\u9633\u8f68\u8ff9\u7684\u53d8\u5316\u3002\u70b9\u8d8a\u9760\u8fd1\u4e2d\u5fc3\uff0c\u5730\u5e73\u7ebf\u4e0a\u65b9\u7684\u592a\u9633\u8d8a\u9ad8\u3002\u4e0a\u9762\u65f6\u95f4\u6ed1\u5757\u4e0a\u7684\u989c\u8272\u663e\u793a\u767d\u5929\u7684\u9633\u5149\u8986\u76d6\u8303\u56f4\u3002\u6839\u636e\u4e00\u6bb5\u89c6\u9891\u6216\u591a\u5f20\u58f0\u79f0\u8fde\u7eed\u7684\u7167\u7247\uff0c\u63a8\u65ad\u53d1\u5e03\u8005\u7684\u58f0\u79f0\u662f\u5426\u771f\u5b9e\u3002</p> <p>Wolfram|Alpha\uff1a\u7531 Wolfram Research \u516c\u53f8\u63a8\u51fa\u7684\u4e00\u6b3e\u5728\u7ebf\u81ea\u52a8\u95ee\u7b54\u7cfb\u7edf\u3002\u5176\u7279\u8272\u662f\u53ef\u4ee5\u76f4\u63a5\u5411\u7528\u6237\u8fd4\u56de\u7b54\u6848\uff0c\u800c\u4e0d\u662f\u50cf\u4f20\u7edf\u641c\u7d22\u5f15\u64ce\u4e00\u6837\u63d0\u4f9b\u4e00\u7cfb\u5217\u53ef\u80fd\u542b\u6709\u7528\u6237\u6240\u9700\u7b54\u6848\u7684\u76f8\u5173\u7f51\u9875\u3002\u57fa\u4e8e Wolfram \u65e9\u671f\u65d7\u8230\u4ea7\u54c1 Mathematica\uff0c\u4e00\u6b3e\u56ca\u62ec\u4e86\u8ba1\u7b97\u673a\u4ee3\u6570\u3001\u7b26\u53f7\u548c\u6570\u503c\u8ba1\u7b97\u3001\u53ef\u89c6\u5316\u548c\u7edf\u8ba1\u529f\u80fd\u7684\u8ba1\u7b97\u5e73\u53f0\u548c\u5de5\u5177\u5305\u5f00\u53d1\u7684\u3002\u5176\u6570\u636e\u6765\u6e90\u5305\u62ec\u5b66\u672f\u7f51\u7ad9\u548c\u51fa\u7248\u7269\u3001\u5546\u4e1a\u7f51\u7ad9\u548c\u516c\u53f8\u3001\u79d1\u5b66\u673a\u6784\u7b49\u7b49\uff0c\u4f8b\u5982\u4e2d\u592e\u60c5\u62a5\u5c40\u51fa\u7248\u7269\u300a\u4e16\u754c\u6982\u51b5\u300b\u3001\u5eb7\u5948\u5c14\u5927\u5b66\u56fe\u4e66\u9986\u51fa\u7248\u7269\u300aAll About Birds\u300b\u3001\u300aChambers Biographical Dictionary\u300b\u3001\u9053\u743c\u65af\u516c\u53f8\u3001Catalogue of Life\u3001 CrunchBase\u3001\u767e\u601d\u4e70 \u3001\u7f8e\u56fd\u8054\u90a6\u822a\u7a7a\u7ba1\u7406\u5c40\u3001\u7f8e\u56fd\u5730\u8d28\u8c03\u67e5\u5c40\u7b49\u2026\u2026\u4f60\u77e5\u9053\u5b83\u6709\u591a\u5f3a\u5927\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#whoisips","title":"\u2014\u200a\u2014\u200a\u4e2a\u4eba\uff0cWhoIs\uff0cIPs\uff0c\u7f51\u7ad9\u5206\u6790\u200a\u2014\u200a\u2014","text":"<p>\u7f51\u7edc\u6218</p> <p>Passive DNS\uff1a\u662f DNS \u5386\u53f2\u4fe1\u606f\u7684\u4e00\u4e2a\u622a\u7247\uff0c\u662f DNS \u6570\u636e\u7684\u4e00\u79cd\u5e94\u7528\u65b9\u5f0f\uff0c\u7b80\u5355\u7684 Passive DNS \u7684\u4f8b\u5b50\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u662f\u57df\u540d\u548c IP \u7684\u6620\u5c04\u8868\u3002Passive DNS \u80fd\u591f\u56de\u7b54\u7684\u95ee\u9898\u5305\u62ec\uff0c\u57df\u540d\u6307\u5411\u54ea\u4e9b\u5730\u5740\uff0c\u57df\u540d\u670d\u52a1\u5668\u7ba1\u7406\u8fc7\u54ea\u4e9b\u57df\u540d\u7b49\u7b49\u3002</p> <p>**\u6076\u610f\u57df\u540d\u548c\u5408\u6cd5\u57df\u540d\u7684 DNS \u884c\u4e3a**\u6709\u7740\u5f88\u5927\u7684\u5dee\u5f02\uff0c\u800c\u8fd9\u79cd\u5dee\u5f02\u80fd\u901a\u8fc7 Passive DNS \u6570\u636e\u4f53\u73b0\u51fa\u6765\u3002\u6076\u610f\u57df\u540d\u7684\u7279\u70b9\u6709\u5f88\u591a\uff0c\u5982 DNS \u8bb0\u5f55 TTL \u503c\u504f\u5c0f\u3001IP \u6c60\u66f4\u65b0\u5feb\u3001IP \u7f51\u6bb5\u4e30\u5bcc\u7b49\u7b49\u3002 \u76ee\u524d\u7684\u4f7f\u7528 Passive DNS \u6bd4\u8f83\u4f18\u79c0\u7684\u5de5\u4f5c\u6709 EXPOSURE\u3001Notos \u548c FluxBuster \u7b49\u7b49\u3002</p> <p>Censys.io\uff1a\u5b8c\u6574\u7684\u4e92\u8054\u7f51\u8fde\u63a5\u8bbe\u5907\u77e5\u8bc6\uff01Censys \u4f1a**\u6301\u7eed\u76d1\u63a7 Internet \u4e0a\u6bcf\u4e2a\u53ef\u8bbf\u95ee\u7684\u670d\u52a1\u5668\u548c\u8bbe\u5907\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u5b9e\u65f6\u641c\u7d22\u548c\u5206\u6790\u5b83\u4eec\uff0c\u4e86\u89e3\u4f60\u7684\u7f51\u7edc\u653b\u51fb\u9762\uff0c\u53d1\u73b0\u65b0\u7684\u5a01\u80c1\u5e76\u8bc4\u4f30\u5176\u5168\u7403\u5f71\u54cd**\u3002\u901a\u8fc7\u6570\u636e\u9a71\u52a8\u5b89\u5168\u3002</p> <p>Censys \u8ddf Shodan \u548c\u4e2d\u56fd\u7684 ZoomEye \u7c7b\u4f3c\uff0c\u53ef\u4ee5\u641c\u7d22\u4e16\u754c\u8303\u56f4\u5185\u7684\u8054\u7f51\u8bbe\u5907\u3002Shodan \u548c ZoomEye \u662f\u4e2a\u4eba\u7528\u7684\u6bd4\u8f83\u591a\u7684\u4e24\u6b3e\u3002</p> <p>Censys \u4e0e Shodan \u76f8\u6bd4\u662f\u4e00\u6b3e\u514d\u8d39\u641c\u7d22\u5f15\u64ce\uff0c\u5f53\u7136\u4e5f\u6709\u4e00\u5b9a\u7684\u9650\u5236\uff08\u901f\u5ea6\u548c\u641c\u7d22\u7ed3\u679c\uff09\uff0c\u800c\u65b0\u6539\u7248\u540e\u7684 ZoomEye \u5bf9\u4e2d\u56fd\u7684\u641c\u7d22\u7ed3\u679c\u505a\u4e86\u201c\u5904\u7406\u201d\uff0c\u51e0\u4e4e\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\u4e86\u3002</p> <p>DNS History\uff1a\u5c31\u662f\u5b83\u7684\u540d\u5b57\uff0c\u6536\u96c6\u5386\u53f2 DNS \u4fe1\u606f\u3002\u514d\u8d39\uff0c\u7b80\u5355\u6613\u7528\u3002\u6709\u65f6\u53ef\u7528\u6027\u6709\u9650\u3002</p> <p>DNS cyrillic check\uff1a\u68c0\u67e5\u6076\u610f\u57df\u540d\u6216\u897f\u91cc\u5c14\u57df\u540d\u662f\u5426\u5df2\u6ce8\u518c\u3002\u514d\u8d39\uff0c\u7b80\u5355\u6613\u7528\u3002</p> <p>DNS Trails\uff1a\u4e16\u754c\u4e0a\u6700\u5927\u7684\u5386\u53f2 DNS \u6570\u636e\u5b58\u50a8\u5e93\u3002\u8be5\u7ad9\u70b9\u5305\u542b\u5bf9\u5927\u7ea63\u4e07\u4ebf\u6761 DNS \u8bb0\u5f55\uff0c30\u4ebf\u6761 WHOIS \u8bb0\u5f55\u548c 4.18 \u4ebf\u4e2a\u4e3b\u673a\u540d\u7684\u6570\u636e\u5e93\u7684\u8bbf\u95ee\u6743\u9650\u3002\u6240\u6709\u8fd9\u4e9b\u90fd\u662f\u81ea 2008 \u5e74\u4e2d\u671f\u4ee5\u6765\u6bcf\u5929\u6536\u96c6\u7684\u3002\u53ef\u80fd\u4f1a\u4e3a\u60a8\u8fd4\u56de\u6700\u591a\u7684\u6570\u636e\u3002\u514d\u8d39\uff0c\u7b80\u5355\u6613\u7528\u3002</p> <p>Geo IP Tool\uff1a\u8fd9\u662f\u7ed9\u4f60\u81ea\u5df1\u7684\u3002\u68c0\u67e5\u60a8\u81ea\u5df1\u7684 IP\uff0c\u65b9\u4fbf\u68c0\u67e5\u60a8\u7684 VPN \u662f\u5426\u6b63\u5e38\u5de5\u4f5c \ud83d\udd10\u3002</p> <p>Shodan\uff1a\u7269\u8054\u7f51\u641c\u7d22\u5f15\u64ce\uff01\u53ef\u4ee5\u627e\u5230\u5927\u91cf\u9519\u8bef\u914d\u7f6e\u7684\u7f51\u7edc\u8fde\u63a5\u8bbe\u5907\u3002\u6709\u4e9b\u4eba\u8fd8\u5c06\u5176\u63cf\u8ff0\u4e3a\u670d\u52a1\u6a2a\u5e45\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u670d\u52a1\u6a2a\u5e45\u662f\u670d\u52a1\u5668\u53d1\u9001\u56de\u5ba2\u6237\u7aef\u7684\u5143\u6570\u636e\u3002\u8fd9\u53ef\u4ee5\u662f\u5173\u4e8e\u670d\u52a1\u5668\u8f6f\u4ef6\u7684\u4fe1\u606f\uff0c\u8be5\u670d\u52a1\u652f\u6301\u7684\u9009\u9879\uff0c\u6b22\u8fce\u6d88\u606f\u6216\u5ba2\u6237\u7aef\u5728\u4e0e\u670d\u52a1\u5668\u4ea4\u4e92\u4e4b\u524d\u53ef\u4ee5\u627e\u5230\u7684\u5176\u4ed6\u5185\u5bb9\u3002</p> <p>SpyOnWeb\uff1a\u7528\u4e8e\u901a\u8fc7\u5176\u8ddf\u8e2a\u4ee3\u7801\u68c0\u7d22\u7f51\u7ad9\u3002\u4e00\u4e2a\u4e0d\u65ad\u6293\u53d6\u7f51\u7ad9\u8ffd\u8e2a\u4ee3\u7801\uff0c\u540d\u79f0\u670d\u52a1\u5668\u548c\u5176\u4ed6\u4fe1\u606f\u7684\u7f51\u7ad9\uff0c\u6240\u4ee5\u5b83\u80fd\u5e2e\u52a9\u663e\u793a\u7f51\u7ad9\u4e4b\u95f4\u7684\u8fde\u63a5\u3002\u4ed6\u4eec\u7684 API \u6709\u8bb8\u591a\u5b9a\u4ef7\u5c42\uff0c\u4ece\u514d\u8d39\u5f00\u59cb\u4e00\u76f4\u5230\u6bcf\u670869.95\u7f8e\u5143\u3002</p> <p>Whois\uff1a\u7528\u4e8e\u57df\u540d\u641c\u7d22\u548c\u4fe1\u606f\uff0cwhois.net \u6216 whois.icann.org</p> <p>\u6b64\u5916\u8fd8\u6709\uff1a\u4eba\u7269\u641c\u7d22\uff01</p> <ul> <li>Peekyou\uff0cpeekyou.com</li> <li>Pipl\uff0c\u4e16\u754c\u4e0a\u6700\u5f3a\u5927\u7684\u4eba\u7269\u641c\u7d22\u5f15\u64ce\uff0c\u627e\u5230\u7535\u5b50\u90ae\u4ef6\u5730\u5740\uff0c\u793e\u4ea4\u5a92\u4f53\u7528\u6237\u540d\u6216\u7535\u8bdd\u53f7\u7801\u80cc\u540e\u7684\u4eba\uff0cpipl.com</li> <li>Yasni\uff0cyasni.com</li> <li>Zaba Search\uff0c\u4ec5\u9650\u7f8e\u56fd\uff0czabasearch.com publicrecords.searchsystems.netcemetery.canadagenweb.org/search.html opencorporates.com</li> <li>IXMaps, IXMaps</li> <li>Network-Tools</li> <li>Open Site Explorer</li> <li>Robtex</li> <li>Search IRC</li> <li>Shodan Computer Search</li> <li>Utrace</li> <li>ViewDNS</li> </ul>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#internet","title":"\u2014\u200a\u2014\u200a\u5b58\u6863\uff0c\u4e0b\u8f7d\u548c Internet \u5b58\u50a8\u200a\u2014\u200a\u2014","text":"<p>\u4fdd\u7559\u8bc1\u636e\uff01</p> <p>Archive.is\uff1a\u5b58\u6863\u4efb\u4f55\u7f51\u9875\u3002\u4e00\u4e2a\u79c1\u4eba\u8d44\u52a9\u7684\u6570\u5b57\u65f6\u95f4\u80f6\u56ca\u7f51\u7ad9\u3002\u4f1a\u6839\u636e\u7248\u6743\u6240\u6709\u8005\u7684\u5408\u4e4e\u6570\u5b57\u5343\u5e74\u7248\u6743\u6cd5\u6848\uff08DMCA\uff09\u7684\u64a4\u9664\u8bf7\u6c42\u79fb\u9664\u5df2\u5f52\u6863\u7684\u9875\u9762\u3002\u6bcf\u6b21\u8bf7\u6c42\u90fd\u4f1a\u6355\u6349\u7f51\u9875\u7684\u6587\u5b57\u5185\u5bb9\uff0c\u52a0\u8f7d\u4e0d\u542b\u6d3b\u52a8\u5143\u7d20\u6216\u811a\u672c\u7684 Web 2.0 \u7f51\u7ad9\u6216\u7531 JavaScript \u4ea7\u751f\u7684\u56fe\u7247\u4e0e\u6846\u67b6\u5185\u5bb9\u3002 \u622a\u56fe\u662f 1024\u00d7768 \u50cf\u7d20\uff0c\u6ca1\u6709\u5f39\u51fa\u7a97\u53e3\u3002 archive.is \u8fd8\u652f\u6301\u4e86 Memento Project \u7684 API\uff0c\u5e76\u4e14\u5f00\u53d1\u4e86 Firefox \u6d4f\u89c8\u5668\u4e0e Chrome \u6d4f\u89c8\u5668\u7684\u63d2\u4ef6\u3002</p> <p>\u53c2\u89c1\u6211\u4eec\u4ee5\u524d\u7684\u6587\u7ae0\u300a\u7559\u4e0b\u8bc1\u636e\uff1a\u5982\u4f55\u5b58\u6863\u5f00\u6e90\u6750\u6599\uff1f#OSINT\u300b</p> <p>DMCA\uff1a\u641c\u7d22\u5220\u9664\u901a\u77e5\u3002</p> <p>Gruber\uff1aSlideshare\u4e0b\u8f7d\u5668\u3002\u592a\u591a\u4ecb\u7ecd\u4e86\u4e0d\u8d58\u8ff0\u3002</p> <p>Historic Breach Database List\uff1a\u770b\u4e00\u773c\u8fd9\u4e2a\u94fe\u63a5\u5c31\u660e\u767d\u4e86\u3002</p> <p>Wayback Machine\uff1a\u6863\u6848\u7f51\u7ad9\u3002\u4ece Wayback Machine \u4e0b\u8f7d\u6574\u4e2a\u7f51\u7ad9\u3002\u300c\u7f51\u9645\u7f51\u8def\u6863\u6848\u9986\u300d\uff08Internet Archive\uff09\u65d7\u4e0b\u7684\u4e00\u9879\u7f51\u9875\u4fdd\u5b58\u8ba1\u5212\uff0c\u4e8b\u5b9e\u4e0a\u5b83\u4e5f\u6b63\u5728\u7eaa\u5f55\u6bcf\u5206\u6bcf\u79d2\u4e0d\u65ad\u6539\u53d8\u7684\u7f51\u8def\u751f\u6001\u3002\u6bcf\u5468\u900f\u8fc7\u7f51\u8def\u722c\u866b\uff08Crawler\uff09\u6293\u53d6\u8d85\u8fc7\u5341\u4ebf\u4e2a\u7f51\u9875\u5185\u5bb9\uff01\u8fd0\u7528\u5927\u91cf\u4f3a\u670d\u5668\u3001\u9891\u5bbd\u6765\u63d0\u4f9b\u670d\u52a1\u5e76\u6781\u529b\u8282\u7701\u8d44\u6599\u5927\u5c0f\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728\u7f51\u7ad9\u4e0a\u627e\u5230\u975e\u5e38\u53e4\u8001\u7684\u7f51\u9875\u5907\u4efd\u3002</p> <p>Wayback Machine \u4ea6\u63d0\u4f9b\u7ebf\u4e0a\u300c\u7f51\u9875\u5907\u4efd\u300d\u529f\u80fd\uff0c\u53ea\u8981\u8f93\u5165\u8981\u5907\u4efd\u7684\u7f51\u9875\u7f51\u5740\uff0c\u5c31\u80fd\u5c06\u5b83\u64b7\u53d6\u4e0b\u6765\uff0c\u4ea7\u751f\u4e00\u4e2a\u72ec\u7acb\u4e14\u6c38\u4e45\u4fdd\u5b58\u7684\u7f51\u5740\uff0c\u672a\u6765\u8fd8\u80fd\u5728 Wayback Machine \u4ee5\u65f6\u5149\u673a\u529f\u80fd\u6765\u968f\u65f6\u56de\u987e\u4e0d\u540c\u65f6\u95f4\u70b9\u81ea\u52a8\u6293\u53d6\u5907\u4efd\u7684\u7f51\u9875\u5185\u5bb9\u3002</p> <p>Wayback Machine for Github\uff1a\u67e5\u627e\u548c\u641c\u7d22\u4f55\u65f6\u4ee5\u53ca\u8c01\u505a\u4e86\u4ec0\u4e48\uff01\u7b80\u5355\u6613\u7528\u3002</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_8","title":"\u2014\u200a\u2014\u200a\u201c\u6742\u6280\u201d\u200a\u2014\u200a\u2014","text":"<p>\u975e\u5e38\u91cd\u8981\uff01\uff01</p> <p>BlockExplore\uff1a\u8ddf\u8e2a\u6bd4\u7279\u5e01\u7ebf\u7d22\u6216\u8ddf\u968f\u6bd4\u7279\u5e01\u8d26\u6237\u3002</p> <p>Check\uff1a\u534f\u4f5c\u4e8b\u5b9e\u6838\u67e5\u3002\u6838\u67e5\u4efb\u4f55\u4e8b\u4ef6\u7684\u771f\u4f2a\uff01\u5728\u8fd9\u91cc\u770b\u5230\u66f4\u591a\u8d44\u6e90\u3002</p> <p>Document Redaction\uff1a\u7528\u4e8e\u5728\u67e5\u770b\u4e4b\u524d\u5220\u9664 Pdfs \u4e2d\u53ef\u80fd\u6709\u5bb3\u7684\u5185\u5bb9\uff0c\u4f8b\u5982\u8ffd\u6eaf\u3002</p> <p>Google Search Operators\uff1a\u4f8b\u5982\u641c\u7d22\u7279\u5b9a\u6587\u4ef6\u7c7b\u578b\uff08\u4f8b\u5982 PDF\uff09\u6216\u7279\u5b9a\u7f51\u7ad9\u3002\u6211\u4eec\u540e\u9762\u5c06\u6709\u6587\u7ae0\u8be6\u7ec6\u4ecb\u7ecd\u5177\u4f53\u7528\u6cd5\uff01</p> <p>Hunch.ly\uff1a\u81ea\u52a8\u6536\u96c6\u6240\u6709\u8bbf\u95ee\u8fc7\u7684\u7f51\u7ad9\uff01\u4e13\u4e3a\u5728\u7ebf\u8c03\u67e5\u800c\u8bbe\u8ba1\u7684**\u552f\u4e00\u7f51\u7edc\u6355\u83b7\u5de5\u5177**\u3002Hunchly \u81ea\u52a8\u6536\u96c6\u3001\u8bb0\u5f55\u548c\u6ce8\u91ca\u60a8\u8bbf\u95ee\u7684\u6bcf\u4e2a\u7f51\u9875\u3002\u975e\u5e38\u5f3a\u5927\u7684\u8c03\u67e5\u5de5\u5177\uff0c\u8981\u4ed8\u8d39\u54e6\u3002</p> <p>Insecam\uff1a\u7f51\u7edc\u76f4\u64ad IP \u6444\u50cf\u673a\u76ee\u5f55\uff01\u4f60\u61c2\u7684\u3002\u4e16\u754c\u4e0a\u6700\u5927\u7684\u5728\u7ebf\u76d1\u63a7\u5b89\u5168\u6444\u50cf\u673a\u76ee\u5f55\u3002\u9009\u62e9\u4e00\u4e2a\u56fd\u5bb6\u89c2\u770b\u5b9e\u65f6\u8857\u9053\uff0c\u4ea4\u901a\uff0c\u505c\u8f66\u573a\uff0c\u529e\u516c\u5ba4\uff0c\u516c\u8def\uff0c\u6d77\u6ee9\uff0c\u5730\u7403\u5728\u7ebf\u7f51\u7edc\u6444\u50cf\u5934\u3002\u73b0\u5728\uff0c\u60a8\u53ef\u4ee5\u641c\u7d22\u4e16\u754c\u5404\u5730\u7684\u5b9e\u65f6\u7f51\u7edc\u6444\u50cf\u5934\u3002\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u627e\u5230 Axis\uff0c\u677e\u4e0b\uff0cLinksys\uff0c\u7d22\u5c3c\uff0cTPLink\uff0cFoscam\u548c\u8bb8\u591a\u5176\u4ed6\u7f51\u7edc\u6444\u50cf\u673a\u5728\u7ebf\u6ca1\u6709\u5bc6\u7801\u3002\u5efa\u8bae\u4f7f\u7528 Mozilla Firefox \u6d4f\u89c8\u5668\u89c2\u770b\u7f51\u7edc\u6444\u50cf\u673a\u3002</p> <p>\u4e3a\u4e86\u4fdd\u62a4\u4e2a\u4eba\u9690\u79c1\uff0cInsecam \u91c7\u53d6\u4e86\u4ee5\u4e0b\u884c\u52a8\uff1a</p> <ul> <li>- \u53ea\u6709\u8fc7\u6ee4\u7684\u76f8\u673a\u73b0\u5728\u53ef\u7528\u3002\u8fd9\u6837 Insecam \u4e0a\u7684\u6444\u50cf\u673a\u90fd\u4e0d\u4f1a\u4fb5\u72af\u4efb\u4f55\u4eba\u7684\u79c1\u751f\u6d3b\u3002</li> <li>- \u4efb\u4f55\u79c1\u4eba\u6216\u4e0d\u9053\u5fb7\u7684\u76f8\u673a\u5c06\u88ab\u7acb\u5373\u5220\u9664\u7535\u5b50\u90ae\u4ef6\u6295\u8bc9\u3002\u6253\u5f00\u4e00\u4e2a\u76f4\u63a5\u94fe\u63a5\uff0c\u4ee5\u5e2e\u52a9\u4fc3\u8fdb\u8fc5\u901f\u5220\u9664\u76f8\u673a\u3002</li> <li>- \u5982\u679c\u60a8\u4e0d\u60f3\u901a\u8fc7\u7535\u5b50\u90ae\u4ef6\u4e0e\u6211\u4eec\u8054\u7cfb\uff0c\u60a8\u4ecd\u7136\u53ef\u4ee5\u4ece Insecam \u4e2d\u5220\u9664\u60a8\u7684\u76f8\u673a\u3002\u4f60\u552f\u4e00\u9700\u8981\u505a\u7684\u662f\u8bbe\u7f6e\u4f60\u7684\u76f8\u673a\u7684\u5bc6\u7801\u3002</li> <li>- \u60a8\u53ef\u4ee5\u6dfb\u52a0\u60a8\u7684\u76f8\u673a\u5230\u76ee\u5f55\u3002\u53ea\u6709\u5728\u7ba1\u7406\u5458\u6279\u51c6\u540e\u624d\u80fd\u4f7f\u7528\u3002\u6444\u50cf\u673a\u7684\u5750\u6807\u662f\u8fd1\u4f3c\u7684\u3002\u5b83\u4eec\u6307\u5411 ISP \u5730\u5740\uff0c\u800c\u4e0d\u662f\u6444\u50cf\u673a\u7684\u7269\u7406\u5730\u5740\u3002\u6b64\u4fe1\u606f\u4ec5\u7cbe\u786e\u5230\u51e0\u767e\u82f1\u91cc\u3002\u63d0\u4f9b\u7684\u5750\u6807\u4ec5\u7528\u4e8e\u5b9a\u4f4d\u76f8\u673a\u6240\u5728\u7684\u57ce\u5e02\uff0c\u4f46\u4e0d\u662f\u51c6\u786e\u7684\u4f4d\u7f6e\u6216\u5730\u5740\u3002</li> </ul> <p>LittleSis\uff1a\u4e00\u4e2a\u514d\u8d39\u7684\u6570\u636e\u5e93\uff0c\u4e86\u89e3\u5728\u5546\u4e1a\u548c\u653f\u5e9c\u5c42\u9762\u7684\u4eba\u9645\u5173\u7cfb\u3002\u4e00\u4e2a\u8349\u6839\u76d1\u7763\u7f51\u7edc\uff0c\u8fde\u63a5\u4e16\u754c\u4e0a\u6700\u5f3a\u5927\u7684\u4eba\u548c\u7ec4\u7ec7\u4e4b\u95f4\u7684\u70b9\u3002\u8c03\u67e5\u4efb\u4eba\u552f\u4eb2\uff0c\u5229\u76ca\u51b2\u7a81\u548c\u7cfb\u7edf\u8150\u8d25\u7684\u72ec\u7279\u8d44\u6e90\uff01</p> <p>\u901a\u8fc7\u8ddf\u8e2a\u653f\u6cbb\u5bb6\u3001\u5546\u4e1a\u9886\u8896\u3001\u6e38\u8bf4\u8005\u3001\u91d1\u878d\u5bb6\u53ca\u5176\u9644\u5c5e\u673a\u6784\u7684\u5173\u952e\u5173\u7cfb\uff0c\u4e3a\u6709\u5f71\u54cd\u529b\u7684\u793e\u4ea4\u7f51\u7edc\u5e26\u6765\u900f\u660e\u5ea6\u3002</p> <p>\u6240\u6709\u8fd9\u4e9b\u4fe1\u606f\u90fd\u662f\u516c\u5f00\u7684\uff0c\u4f46\u662f\u5f88\u5206\u6563\uff0c\u8c03\u67e5\u8005\u5f88\u96be\u627e\u5230\u3002\u8fd9\u4e2a\u7ad9\u70b9\u5c06\u5b83\u4eec\u96c6\u4e2d\u5728\u4e00\u4e2a\u5730\u65b9\u3002\u6570\u636e\u6765\u81ea\u653f\u5e9c\u6587\u4ef6\u3001\u65b0\u95fb\u6587\u7ae0\u548c\u5176\u4ed6\u4fe1\u8a89\u826f\u597d\u7684\u6765\u6e90\u3002\u4e00\u4e9b\u6570\u636e\u96c6\u4f1a\u81ea\u52a8\u66f4\u65b0; \u5176\u4f59\u90e8\u5206\u7531\u7528\u6237\u793e\u533a\u586b\u5199\u3002</p> <p>Lumen\uff1a\u6536\u96c6\u548c\u5206\u6790\u6cd5\u5f8b\u6295\u8bc9\u548c\u5220\u9664\u5728\u7ebf\u8d44\u6599\u7684\u8bf7\u6c42\uff0c\u5e2e\u52a9\u4e92\u8054\u7f51\u7528\u6237\u4e86\u89e3\u4ed6\u4eec\u7684\u6743\u5229\u5e76\u7406\u89e3\u6cd5\u5f8b\u3002\u8fd9\u4e9b\u6570\u636e\u4f7f\u7528\u6237\u80fd\u591f\u7814\u7a76\u6cd5\u5f8b\u5a01\u80c1\u7684\u666e\u904d\u6027\uff0c\u5e76\u8ba9\u4e92\u8054\u7f51\u7528\u6237\u770b\u5230\u5185\u5bb9\u5220\u9664\u7684\u6765\u6e90\u3002</p> <p>Maltego \uff1a\u4ea4\u4e92\u5f0f\u6570\u636e\u6316\u6398\u5de5\u5177\uff0c\u7528\u4e8e\u5448\u73b0\u94fe\u63a5\u5206\u6790\u7684\u6709\u5411\u56fe\u3002\u7528\u4e8e\u5728\u7ebf\u8c03\u67e5\uff0c\u4ee5\u67e5\u627e\u6765\u81ea\u4e92\u8054\u7f51\u4e0a\u5404\u79cd\u6765\u6e90\u7684\u4fe1\u606f\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u975e\u5e38\u5f3a\u5927\uff01</p> <p>\u6bd4\u8d77\u5176\u5b83\u7684\u60c5\u62a5\u6536\u96c6\u5de5\u5177\uff0cMaltego \u663e\u5f97\u683c\u5916\u4e0d\u540c\u5e76\u4e14\u529f\u80fd\u5f3a\u5927\uff0c\u56e0\u4e3a\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u81ea\u52a8\u6536\u96c6\u5230\u6240\u9700\u4fe1\u606f\uff0c\u800c\u4e14\u53ef\u4ee5**\u5c06\u6536\u96c6\u7684\u4fe1\u606f\u53ef\u89c6\u5316**\uff0c\u7528\u4e00\u79cd\u683c\u5916\u7f8e\u89c2\u7684\u65b9\u5f0f\u5c06\u7ed3\u679c\u5448\u73b0\u7ed9\u4f7f\u7528\u8005\u3002\u4f60\u53ef\u4ee5\u770b\u5230\u8bb8\u591a\u6709\u7528\u7684\u4fe1\u606f\uff0c\u6bd4\u5982 DNS \u4fe1\u606f\uff0c\u90ae\u4ef6\u670d\u52a1\u5668\uff0cIP\uff0c\u7528\u6237\uff0c\u7535\u5b50\u90ae\u7bb1ID\uff0c\u7f51\u7edc\u7b49\u3002</p> <p>Montage\uff1a\u7528\u4e8e\u534f\u540c\u5de5\u4f5c\u3002\u8ba9\u60a8\u80fd\u591f\u5c06\u6ce8\u610f\u529b\u96c6\u4e2d\u5728\u5206\u6790\u800c\u4e0d\u662f\u6570\u636e\u6536\u96c6\u4e0a\u3002</p> <p>Malicious URL Tester\uff1a\u6d4b\u8bd5\u672a\u77e5\u7684 URL\u3002\u4e3a\u4e86\u5b89\u5168\u3002</p> <p>OpenCorporates\uff1a\u4e16\u754c\u5404\u5730\u7684\u516c\u53f8\u6570\u636e\u5e93\u3002\u91cc\u9762\u5305\u542b\u4e86 1.38 \u4ebf\u5bb6\u4f01\u4e1a\u548c 1.76 \u4ebf\u5458\u5de5\u7684\u4fe1\u606f\uff0c\u800c\u4e14\u8fd8\u5728\u4e0d\u65ad\u66f4\u65b0\u3002</p> <p>Tor Site Searcher\uff1a\u901a\u8fc7 clearnet \u641c\u7d22\u9690\u85cf\u7684 tor \u7f51\u7ad9\u3002\u4f60\u61c2\u7684\u3002</p> <p>TimelineJS by Knight Lab\uff1a\u5236\u4f5c\u4e8b\u4ef6\u7684\u4e92\u52a8\u65f6\u95f4\u8868\u3002\u900f\u8fc7\u5de5\u4f5c\u8868 (google document spreadsheet)\uff0c\u76f4\u89c9\u7684\u680f\u4f4d\u8bbe\u8ba1\uff0c\u5728\u586b\u5b8c\u8d44\u6599\u540e\u5373\u53ef\u900f\u8fc7 TimelineJS \u7684\u7f51\u8def\u4ecb\u9762\u8f93\u51fa\u65f6\u95f4\u8868\u3002</p> <p>\u5177\u5907\u6574\u5408\u7f51\u8def\u8d44\u6e90\u53ca\u7f51\u8def\u591a\u5a92\u4f53\u53ca\u7684\u7279\u6027\uff0c\u975e\u5e38\u9002\u5408\u7f51\u7ad9\u63d0\u4f9b\u52a8\u6001\u7f51\u9875\u65f6\u95f4\u8868\u4e0e\u4f7f\u7528\u8005\u4e92\u52a8\uff0c\u867d\u7136\u5236\u4f5c\u8fc7\u7a0b\u4e2d\uff0c\u65f6\u95f4\u8868\u7f51\u7ad9\u7684\u64cd\u4f5c\u4ecb\u9762\u6ca1\u6709\u4e2d\u6587\uff0c\u4f46\u662f**\u65f6\u95f4\u8868\u7684\u76f8\u5173\u8baf\u606f\u652f\u63f4\u4e2d\u6587\u5185\u5bb9\uff0c\u800c\u8bbe\u5b9a\u4e2d\u6587\u8bed\u7cfb\u7684\u53c2\u6570\u540e\uff0c\u65f6\u95f4\u8868\u672c\u8eab\u4e5f\u4f1a\u5448\u73b0\u4e2d\u6587\u7684\u65e5\u671f**\u3002</p> <p>Visual timeline creator\uff1a\u70b9\u51fb\u94fe\u63a5\uff0c\u4e00\u770b\u5c31\u660e\u767d\uff01</p> <p>Unknown Hash ID\uff1a\u5728\u8c03\u67e5\u65f6\uff0c\u5982\u679c\u4f60\u9047\u5230\u54c8\u5e0c\u4f46\u4e0d\u77e5\u9053\u5b83\u662f\u4ec0\u4e48\uff08\u4e3a\u4fdd\u8bc1\u8fdb\u4e00\u6b65\u8c03\u67e5\uff09\u8fd9\u4e2a\u5de5\u5177\u5e2e\u4f60\u786e\u5b9a\u7c7b\u578b\u3002</p> <p>Zoopla\uff1a\u4f7f\u7528\u82f1\u56fd\u9886\u5148\u7684\u8d44\u6e90\u641c\u7d22\u623f\u4ea7\u3002\u6d4f\u89c8\u623f\u5c4b\u548c\u516c\u5bd3\u51fa\u552e\u548c\u51fa\u79df\u7684\u60c5\u51b5\uff0c\u5e76\u627e\u5230\u4efb\u4f55\u5730\u533a\u7684\u623f\u5730\u4ea7\u7ecf\u7eaa\u4eba\u3002\u4e2d\u56fd\u4eba\u6b63\u5728\u5168\u7403\u4e70\u623f\uff0c\u5c24\u5176\u662f\u5bcc\u4eba\uff08\u4f60\u77e5\u9053\u4e2d\u56fd\u5bcc\u4eba\u7684\u94b1\u662f\u600e\u4e48\u6765\u7684\uff09\u6240\u4ee5\u2026\u2026\u5b83\u975e\u5e38\u6709\u7528\u3002</p> <p>\u2014\u200a\u2014\u200a\u5173\u4e8e\u6218\u4e89\u200a\u2014\u200a\u2014</p> <p>\u51b2\u7a81\u6b66\u5668\u7814\u7a76\u6240\u5f00\u653e\u7684\u540d\u4e3a\u201cItrace\u201d\u7684\u6307\u5357\uff0c\u4ee5\u5730\u56fe\u683c\u5f0f\u56fe\u5f62\u5316\u5730\u5c55\u793a\u4e86\u5404\u79cd\u5f39\u836f\u548c\u6b66\u5668\u7684\u5927\u91cf\u4fe1\u606f\uff0c\u8fd9\u91cc\uff1aitrace.conflictarm.com</p> <p>\u5173\u8054\u6211\u4eec\u7684\u6587\u7ae0\u300a\u5982\u4f55\u4f7f\u7528\u6570\u5b57\u6280\u5de7\u5728\u7ebf\u9a8c\u8bc1\u4e2d\u4e1c\u51b2\u7a81\u4e2d\u7684\u6218\u6597\u4f19\u4f34\u5173\u7cfb\u300b</p> <p>\u2014\u200a\u2014\u200a\u6570\u636e\u53ef\u89c6\u5316\u200a\u2014\u200a\u2014</p> <p>DataBasic.io\uff1a\u9002\u7528\u4e8e\u521d\u5b66\u8005\u7684 Web \u5de5\u5177\uff0c\u4ecb\u7ecd\u4f7f\u7528\u6570\u636e\u7684\u6982\u5ff5\u3002\u8fd9\u4e9b\u7b80\u5355\u7684\u5de5\u5177\u4f7f\u60a8\u53ef\u4ee5\u8f7b\u677e\u5730\u4ee5\u6709\u8da3\u7684\u65b9\u5f0f\u5904\u7406\u6570\u636e\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u5b66\u4e60\u5982\u4f55\u627e\u5230\u8981\u8bb2\u8ff0\u7684\u7cbe\u5f69\u6545\u4e8b\u3002\u9875\u9762\u5f88\u840c\u54c8\u3002</p> <p>DataWrapper\uff1a\u6613\u4e8e\u4f7f\u7528\u7684\u56fe\u8868\u548c\u7ed8\u56fe\u5de5\u5177\u3002</p> <p>Google Fusion Tables\uff1a\u6570\u636e\u878d\u5408\u8868\u662f Google \u63d0\u4f9b\u7684\u7528\u4e8e\u6570\u636e\u7ba1\u7406\u7684\u7f51\u7edc\u670d\u52a1\u3002 Fusion \u8868\u683c\u53ef\u7528\u4e8e\u6536\u96c6\uff0c\u53ef\u89c6\u5316\u548c\u5171\u4eab\u6570\u636e\u8868\u683c\u3002\u6570\u636e\u5b58\u50a8\u5728\u591a\u4e2a\u4e92\u8054\u7f51\u7528\u6237\u53ef\u4ee5\u67e5\u770b\u548c\u4e0b\u8f7d\u7684\u8868\u683c\u4e2d\u3002</p> <p>RAWGraphs\uff1a\u514d\u8d39\u7684 webtool \u53ef\u4ee5\u5feb\u901f\u53ef\u89c6\u5316\u60a8\u7684\u6570\u636e\u3002\u57fa\u4e8e D3.js \u7684\u5f00\u6e90\u5de5\u5177\uff0c\u4e0d\u7528\u4ee3\u7801\uff0c\u53ea\u9700\u8981\u5bfc\u5165\u6570\u636e\uff0c\u8bbe\u7f6e\u4e00\u4e9b\u6761\u4ef6\u5c31\u53ef\u5feb\u901f\u751f\u6210\u3002\u800c\u4e14\u53ef\u4ee5\u5bfc\u51fa svg \u683c\u5f0f\u7684\u56fe\u7247\uff0c\u4e5f\u5c31\u662f\u8bf4\u7528 RAWGraphs \u751f\u6210\u7684\u56fe\u7247\u540e\u671f\u53ef\u4ee5\u8f7b\u677e\u5730\u7528 AI \u6216\u8005 PPT \u6765\u8fdb\u4e00\u6b65\u5bf9\u5176\u8fdb\u884c\u7f16\u8f91\u3002</p> <p>Open Desktop Semantic Search\uff1a\u80fd\u5f88\u597d\u5730\u641c\u7d22\u975e\u7ed3\u6784\u5316\u6570\u636e\u3002</p> <p>TrustServista\uff1a\u5728\u7ebf\u65b0\u95fb\u9a8c\u8bc1\u548c\u53ef\u89c6\u5316\u5de5\u5177\uff01</p>","tags":["opensource","osint"]},{"location":"misc/osint-introduce/#_9","title":"\u2014\u200a\u2014\u200a\u5b89\u5168\u5de5\u5177\uff01\u200a\u2014\u200a\u2014","text":"<p>\u8be6\u89c1\u6211\u4eec\u8fd9\u7bc7\u6587\u7ae0\u300a\u6700\u5168\u9762\u7684\u5b89\u5168\u5de5\u5177\u624b\u518c\uff0c\u51e0\u4e4e\u662f\u60a8\u6240\u9700\u8981\u7684\u4e00\u5207\u300b</p> <p>\u2014\u200a\u2014\u200a\u5176\u4ed6\u200a\u2014\u200a\u2014</p> <p>https://socialbearing.com/ \uff1a\u5f88\u591a Twitter \u7edf\u8ba1\u6570\u636e\uff0c\u975e\u5e38\u6709\u7528\uff1b</p> <p>Namechk.com\uff1a\u975e\u5e38\u9002\u5408\u4f7f\u7528\u7528\u6237\u540d\u8bc6\u522b\u5728\u7ebf\u5e10\u6237\u3002\u53ea\u9700\u63d2\u5165\u7528\u6237\u540d\uff0c\u6b64\u5de5\u5177\u5373\u53ef\u8bc6\u522b\u6240\u6709\u4f7f\u7528\u8be5\u540d\u79f0\u7684\u7528\u6237\u7684\u4f4d\u7f6e\u3002</p> <p>\u597d\u5566\uff0c\u4f60\u7684\u9526\u56ca\u5c31\u5728\u8fd9\u91cc\uff01\u5982\u679c\u4e00\u540d\u58f0\u79f0\u4e13\u4e1a\u7684\u8c03\u67e5\u8bb0\u8005\u3001\u8ffd\u6c42\u6b63\u4e49\u7684\u516c\u6c11\u3001\u793e\u4ea4\u5de5\u7a0b\u5e08\u3001\u634d\u536b\u771f\u76f8\u7684\u6c11\u95f4\u7ec4\u7ec7\uff0c\u4e0d\u80fd\u719f\u7ec3\u4f7f\u7528\u4e0a\u8ff0\u5de5\u5177\u4e2d\u7684 50%\uff0c\u8bf4\u660e\u4ed6\u4eec\u5b8c\u5168\u4e0d\u201c\u4e13\u4e1a\u201d\u3002</p> <p>\u7ed3\u675f\u88ab\u6b3a\u9a97\u8499\u853d\u7684\u5384\u8fd0\uff0c\u626d\u8f6c\u4fe1\u606f\u5c01\u9501\u9020\u6210\u7684\u65e0\u77e5\uff0c\u77e5\u60c5\u6743\u662f\u57fa\u672c\u516c\u6c11\u6743\uff0c\u5e0c\u671b\u66f4\u591a\u6709\u5fd7\u4e4b\u58eb\u52a0\u5165 #OSINT \u4e00\u8d77\u6765\u634d\u536b\u8fd9\u4e00\u6c11\u4e3b\u7684\u6839\u57fa\u3002</p> <p>\u5982\u679c\u60a8\u6709\u66f4\u591a\u7684\u5de5\u5177\u63a8\u8350\uff0c\u6b22\u8fce\u5728\u7559\u8a00\u4e2d\u4ea4\u6d41\uff01\u672c\u5217\u8868\u5c06\u4e0d\u65ad\u5f97\u5230\u8865\u5145\uff1b\u5982\u679c\u60a8\u662f\u5f00\u53d1\u8005\uff0c\u6b22\u8fce\u63f4\u5f15\u672c\u6307\u5357\u7684\u601d\u8def\uff0c\u5f00\u53d1\u51fa\u66f4\u591a\u66f4\u9002\u5408\u4e2d\u56fd\u516c\u6c11\u793e\u4f1a\u4f7f\u7528\u7684\u8c03\u67e5\u5de5\u5177\u3002\u6211\u4eec\u5c06\u5f88\u9ad8\u5174\u534f\u52a9\u60a8\u63a8\u8350\u8fd9\u4e9b\u4f5c\u54c1\u3002\u25fe\ufe0f</p> <p>\u611f\u8c22\u5e2e\u52a9 iYouPort\uff01</p> <p>PayPal \u6350\u8d60\u6e20\u9053\u5df2\u5f00\u901a https://paypal.me/iyouport</p>","tags":["opensource","osint"]},{"location":"programming/design-restful-api-with-python-and-flask/","title":"\u4f7f\u7528 Python \u548c Flask \u8bbe\u8ba1 RESTful API","text":"<p>\u8fd1\u4e9b\u5e74\u6765 REST (REpresentational State Transfer) \u5df2\u7ecf\u53d8\u6210\u4e86 web services \u548c web APIs \u7684\u6807\u914d\u3002</p> <p>\u5728\u672c\u6587\u4e2d\u6211\u5c06\u5411\u4f60\u5c55\u793a\u5982\u4f55\u7b80\u5355\u5730\u4f7f\u7528 Python \u548c Flask \u6846\u67b6\u6765\u521b\u5efa\u4e00\u4e2a RESTful \u7684 web service\u3002</p>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#rest","title":"\u4ec0\u4e48\u662f REST\uff1f","text":"<p>\u516d\u6761\u8bbe\u8ba1\u89c4\u8303\u5b9a\u4e49\u4e86\u4e00\u4e2a REST \u7cfb\u7edf\u7684\u7279\u70b9:</p> <ul> <li>\u5ba2\u6237\u7aef-\u670d\u52a1\u5668: \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\u9694\u79bb\uff0c\u670d\u52a1\u5668\u63d0\u4f9b\u670d\u52a1\uff0c\u5ba2\u6237\u7aef\u8fdb\u884c\u6d88\u8d39\u3002</li> <li>\u65e0\u72b6\u6001: \u4ece\u5ba2\u6237\u7aef\u5230\u670d\u52a1\u5668\u7684\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u5fc5\u987b\u5305\u542b\u7406\u89e3\u8bf7\u6c42\u6240\u5fc5\u9700\u7684\u4fe1\u606f\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c \u670d\u52a1\u5668\u4e0d\u4f1a\u5b58\u50a8\u5ba2\u6237\u7aef\u4e0a\u4e00\u6b21\u8bf7\u6c42\u7684\u4fe1\u606f\u7528\u6765\u7ed9\u4e0b\u4e00\u6b21\u4f7f\u7528\u3002</li> <li>\u53ef\u7f13\u5b58: \u670d\u52a1\u5668\u5fc5\u987b\u660e\u793a\u5ba2\u6237\u7aef\u8bf7\u6c42\u80fd\u5426\u7f13\u5b58\u3002</li> <li>\u5206\u5c42\u7cfb\u7edf: \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5e94\u8be5\u4ee5\u4e00\u79cd\u6807\u51c6\u7684\u65b9\u5f0f\uff0c\u5c31\u662f\u4e2d\u95f4\u5c42\u4ee3\u66ff\u670d\u52a1\u5668\u505a\u51fa\u54cd\u5e94\u7684\u65f6\u5019\uff0c\u5ba2\u6237\u7aef\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u53d8\u52a8\u3002</li> <li>\u7edf\u4e00\u7684\u63a5\u53e3: \u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u7684\u901a\u4fe1\u65b9\u6cd5\u5fc5\u987b\u662f\u7edf\u4e00\u7684\u3002</li> <li>\u6309\u9700\u7f16\u7801: \u670d\u52a1\u5668\u53ef\u4ee5\u63d0\u4f9b\u53ef\u6267\u884c\u4ee3\u7801\u6216\u811a\u672c\uff0c\u4e3a\u5ba2\u6237\u7aef\u5728\u5b83\u4eec\u7684\u73af\u5883\u4e2d\u6267\u884c\u3002\u8fd9\u4e2a\u7ea6\u675f\u662f\u552f\u4e00\u4e00\u4e2a\u662f\u53ef\u9009\u7684\u3002</li> </ul>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#restful-web-service","title":"\u4ec0\u4e48\u662f\u4e00\u4e2a RESTful \u7684 web service\uff1f","text":"<p>REST \u67b6\u6784\u7684\u6700\u521d\u76ee\u7684\u662f\u9002\u5e94\u4e07\u7ef4\u7f51\u7684 HTTP \u534f\u8bae\u3002</p> <p>RESTful web services \u6982\u5ff5\u7684\u6838\u5fc3\u5c31\u662f\u201c\u8d44\u6e90\u201d\u3002 \u8d44\u6e90\u53ef\u4ee5\u7528 <code>URI &lt;https://en.wikipedia.org/wiki/Uniform_resource_identifier&gt;</code>_ \u6765\u8868\u793a\u3002\u5ba2\u6237\u7aef\u4f7f\u7528 HTTP \u534f\u8bae\u5b9a\u4e49\u7684\u65b9\u6cd5\u6765\u53d1\u9001\u8bf7\u6c42\u5230\u8fd9\u4e9b URIs\uff0c\u5f53\u7136\u53ef\u80fd\u4f1a\u5bfc\u81f4\u8fd9\u4e9b\u88ab\u8bbf\u95ee\u7684\u201d\u8d44\u6e90\u201c\u72b6\u6001\u7684\u6539\u53d8\u3002</p> <p>HTTP \u6807\u51c6\u7684\u65b9\u6cd5\u6709\u5982\u4e0b::</p> <pre><code>==========  ===================== ==================================\nHTTP \u65b9\u6cd5   \u884c\u4e3a                   \u793a\u4f8b\n==========  ===================== ==================================\nGET         \u83b7\u53d6\u8d44\u6e90\u7684\u4fe1\u606f         http://example.com/api/orders\nGET         \u83b7\u53d6\u67d0\u4e2a\u7279\u5b9a\u8d44\u6e90\u7684\u4fe1\u606f http://example.com/api/orders/123\nPOST        \u521b\u5efa\u65b0\u8d44\u6e90             http://example.com/api/orders\nPUT         \u66f4\u65b0\u8d44\u6e90               http://example.com/api/orders/123\nDELETE      \u5220\u9664\u8d44\u6e90               http://example.com/api/orders/123\n==========  ====================== ===============================\n</code></pre> <p>REST \u8bbe\u8ba1\u4e0d\u9700\u8981\u7279\u5b9a\u7684\u6570\u636e\u683c\u5f0f\u3002\u5728\u8bf7\u6c42\u4e2d\u6570\u636e\u53ef\u4ee5\u4ee5 <code>JSON &lt;http://en.wikipedia.org/wiki/JSON&gt;</code>_ \u5f62\u5f0f, \u6216\u8005\u6709\u65f6\u5019\u4f5c\u4e3a url \u4e2d\u67e5\u8be2\u53c2\u6570\u9879\u3002</p>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#web-service","title":"\u8bbe\u8ba1\u4e00\u4e2a\u7b80\u5355\u7684 web service","text":"<p>\u575a\u6301 REST \u7684\u51c6\u5219\u8bbe\u8ba1\u4e00\u4e2a web service \u6216\u8005 API \u7684\u4efb\u52a1\u5c31\u53d8\u6210\u4e00\u4e2a\u6807\u8bc6\u8d44\u6e90\u88ab\u5c55\u793a\u51fa\u6765\u4ee5\u53ca\u5b83\u4eec\u662f\u600e\u6837\u53d7\u4e0d\u540c\u7684\u8bf7\u6c42\u65b9\u6cd5\u5f71\u54cd\u7684\u7ec3\u4e60\u3002</p> <p>\u6bd4\u5982\u8bf4\uff0c\u6211\u4eec\u8981\u7f16\u5199\u4e00\u4e2a\u5f85\u529e\u4e8b\u9879\u5e94\u7528\u7a0b\u5e8f\u800c\u4e14\u6211\u4eec\u60f3\u8981\u4e3a\u5b83\u8bbe\u8ba1\u4e00\u4e2a web service\u3002\u8981\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u60c5\u5c31\u662f\u51b3\u5b9a\u7528\u4ec0\u4e48\u6837\u7684\u6839 URL \u6765\u8bbf\u95ee\u8be5\u670d\u52a1\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u6765\u8bbf\u95ee::</p> <p>http://[hostname]/todo/api/v1.0/</p> <p>\u5728\u8fd9\u91cc\u6211\u5df2\u7ecf\u51b3\u5b9a\u5728 URL \u4e2d\u5305\u542b\u5e94\u7528\u7684\u540d\u79f0\u4ee5\u53ca API \u7684\u7248\u672c\u53f7\u3002\u5728 URL \u4e2d\u5305\u542b\u5e94\u7528\u540d\u79f0\u6709\u52a9\u4e8e\u63d0\u4f9b\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4ee5\u4fbf\u533a\u5206\u540c\u4e00\u7cfb\u7edf\u4e0a\u7684\u5176\u5b83\u670d\u52a1\u3002\u5728 URL \u4e2d\u5305\u542b\u7248\u672c\u53f7\u80fd\u591f\u5e2e\u52a9\u4ee5\u540e\u7684\u66f4\u65b0\uff0c\u5982\u679c\u65b0\u7248\u672c\u4e2d\u5b58\u5728\u65b0\u7684\u548c\u6f5c\u5728\u4e0d\u517c\u5bb9\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u4e0d\u5f71\u54cd\u4f9d\u8d56\u4e8e\u8f83\u65e7\u7684\u529f\u80fd\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u4e0b\u4e00\u6b65\u9aa4\u5c31\u662f\u9009\u62e9\u5c06\u7531\u8be5\u670d\u52a1\u66b4\u9732(\u5c55\u793a)\u7684\u8d44\u6e90\u3002\u8fd9\u662f\u4e00\u4e2a\u5341\u5206\u7b80\u5355\u5730\u5e94\u7528\uff0c\u6211\u4eec\u53ea\u6709\u4efb\u52a1\uff0c\u56e0\u6b64\u5728\u6211\u4eec\u5f85\u529e\u4e8b\u9879\u4e2d\u552f\u4e00\u7684\u8d44\u6e90\u5c31\u662f\u4efb\u52a1\u3002</p> <p>\u6211\u4eec\u7684\u4efb\u52a1\u8d44\u6e90\u5c06\u8981\u4f7f\u7528 HTTP \u65b9\u6cd5\u5982\u4e0b::</p> <pre><code>==========  =============================================== =============================\nHTTP \u65b9\u6cd5   URL                                              \u52a8\u4f5c\n==========  ===============================================  ==============================\nGET         http://[hostname]/todo/api/v1.0/tasks            \u68c0\u7d22\u4efb\u52a1\u5217\u8868\nGET         http://[hostname]/todo/api/v1.0/tasks/[task_id]  \u68c0\u7d22\u67d0\u4e2a\u4efb\u52a1\nPOST        http://[hostname]/todo/api/v1.0/tasks            \u521b\u5efa\u65b0\u4efb\u52a1\nPUT         http://[hostname]/todo/api/v1.0/tasks/[task_id]  \u66f4\u65b0\u4efb\u52a1\nDELETE      http://[hostname]/todo/api/v1.0/tasks/[task_id]  \u5220\u9664\u4efb\u52a1\n==========  ================================================ =============================\n</code></pre> <p>\u6211\u4eec\u5b9a\u4e49\u7684\u4efb\u52a1\u6709\u5982\u4e0b\u4e00\u4e9b\u5c5e\u6027:</p> <ul> <li>id: \u4efb\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u7b26\u3002\u6570\u5b57\u7c7b\u578b\u3002</li> <li>title: \u7b80\u77ed\u7684\u4efb\u52a1\u63cf\u8ff0\u3002\u5b57\u7b26\u4e32\u7c7b\u578b\u3002</li> <li>description: \u5177\u4f53\u7684\u4efb\u52a1\u63cf\u8ff0\u3002\u6587\u672c\u7c7b\u578b\u3002</li> <li>done: \u4efb\u52a1\u5b8c\u6210\u7684\u72b6\u6001\u3002\u5e03\u5c14\u503c\u3002</li> </ul> <p>\u76ee\u524d\u4e3a\u6b62\u5173\u4e8e\u6211\u4eec\u7684 web service \u7684\u8bbe\u8ba1\u57fa\u672c\u5b8c\u6210\u3002\u5269\u4e0b\u7684\u4e8b\u60c5\u5c31\u662f\u5b9e\u73b0\u5b83\uff01</p>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#flask","title":"Flask \u6846\u67b6\u7684\u7b80\u4ecb","text":"<p>\u5982\u679c\u4f60\u8bfb\u8fc7 <code>Flask Mega-Tutorial \u7cfb\u5217 &lt;http://www.pythondoc.com/flask-mega-tutorial/index.html&gt;</code>_\uff0c\u5c31\u4f1a\u77e5\u9053 Flask \u662f\u4e00\u4e2a\u7b80\u5355\u5374\u5341\u5206\u5f3a\u5927\u7684 Python web \u6846\u67b6\u3002</p> <p>\u5728\u6211\u4eec\u6df1\u5165\u7814\u7a76 web services \u7684\u7ec6\u8282\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u56de\u987e\u4e00\u4e0b\u4e00\u4e2a\u666e\u901a\u7684 Flask Web \u5e94\u7528\u7a0b\u5e8f\u7684\u7ed3\u6784\u3002</p> <p>\u6211\u4f1a\u9996\u5148\u5047\u8bbe\u4f60\u77e5\u9053 Python \u5728\u4f60\u7684\u5e73\u53f0\u4e0a\u5de5\u4f5c\u7684\u57fa\u672c\u77e5\u8bc6\u3002 \u6211\u5c06\u8bb2\u89e3\u7684\u4f8b\u5b50\u662f\u5de5\u4f5c\u5728\u4e00\u4e2a\u7c7b Unix \u64cd\u4f5c\u7cfb\u7edf\u3002\u7b80\u800c\u8a00\u4e4b\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u80fd\u5de5\u4f5c\u5728 Linux\uff0cMac OS X \u548c Windows(\u5982\u679c\u4f60\u4f7f\u7528Cygwin)\u3002 \u5982\u679c\u4f60\u4f7f\u7528 Windows \u4e0a\u539f\u751f\u7684 Python \u7248\u672c\u7684\u8bdd\uff0c\u547d\u4ee4\u4f1a\u6709\u6240\u4e0d\u540c\u3002 </p> <p>\u8ba9\u6211\u4eec\u5f00\u59cb\u5728\u4e00\u4e2a\u865a\u62df\u73af\u5883\u4e0a\u5b89\u88c5 Flask\u3002\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u4e0a\u6ca1\u6709 virtualenv\uff0c\u4f60\u53ef\u4ee5\u4ece https://pypi.python.org/pypi/virtualenv \u4e0a\u4e0b\u8f7d:</p> <p><pre><code>$ mkdir todo-api\n$ cd todo-api\n$ virtualenv flask\nNew python executable in flask/bin/python\nInstalling setuptools............................done.\nInstalling pip...................done.\n$ flask/bin/pip install flask\n</code></pre> \u65e2\u7136\u5df2\u7ecf\u5b89\u88c5\u4e86 Flask\uff0c\u73b0\u5728\u5f00\u59cb\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u5730\u7f51\u9875\u5e94\u7528\uff0c\u6211\u4eec\u628a\u5b83\u653e\u5728\u4e00\u4e2a\u53eb app.py \u7684\u6587\u4ef6\u4e2d:</p> <pre><code>#!flask/bin/python\nfrom flask import Flask\n\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    return \"Hello, World!\"\n\nif __name__ == '__main__':\n    app.run(debug=True)\n</code></pre> <p>\u4e3a\u4e86\u8fd0\u884c\u8fd9\u4e2a\u7a0b\u5e8f\u6211\u4eec\u5fc5\u987b\u6267\u884c <code>app.py</code>:</p> <p><pre><code>$ chmod a+x app.py\n$ ./app.py\n* Running on http://127.0.0.1:5000/\n* Restarting with reloader\n</code></pre> \u73b0\u5728\u4f60\u53ef\u4ee5\u542f\u52a8\u4f60\u7684\u7f51\u9875\u6d4f\u89c8\u5668\uff0c\u8f93\u5165 http://localhost:5000 \u770b\u770b\u8fd9\u4e2a\u5c0f\u5e94\u7528\u7a0b\u5e8f\u7684\u6548\u679c\u3002</p> <p>\u7b80\u5355\u5427\uff1f\u73b0\u5728\u6211\u4eec\u5c06\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8f6c\u6362\u6210\u6211\u4eec\u7684 RESTful service\uff01</p>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#python-flask-restful-services","title":"\u4f7f\u7528 Python \u548c Flask \u5b9e\u73b0 RESTful services","text":"<p>\u4f7f\u7528 Flask \u6784\u5efa web services \u662f\u5341\u5206\u7b80\u5355\u5730\uff0c\u6bd4\u6211\u5728 <code>Mega-Tutorial &lt;http://www.pythondoc.com/flask-mega-tutorial/index.html&gt;</code>_ \u4e2d\u6784\u5efa\u7684\u5b8c\u6574\u7684\u670d\u52a1\u7aef\u7684\u5e94\u7528\u7a0b\u5e8f\u8981\u7b80\u5355\u5730\u591a\u3002</p> <p>\u5728 Flask \u4e2d\u6709\u8bb8\u591a\u6269\u5c55\u6765\u5e2e\u52a9\u6211\u4eec\u6784\u5efa RESTful services\uff0c\u4f46\u662f\u5728\u6211\u770b\u6765\u8fd9\u4e2a\u4efb\u52a1\u5341\u5206\u7b80\u5355\uff0c\u6ca1\u6709\u5fc5\u8981\u4f7f\u7528 Flask \u6269\u5c55\u3002</p> <p>\u6211\u4eec web service \u7684\u5ba2\u6237\u7aef\u9700\u8981\u6dfb\u52a0\u3001\u5220\u9664\u4ee5\u53ca\u4fee\u6539\u4efb\u52a1\u7684\u670d\u52a1\uff0c\u56e0\u6b64\u663e\u7136\u6211\u4eec\u9700\u8981\u4e00\u79cd\u65b9\u5f0f\u6765\u5b58\u50a8\u4efb\u52a1\u3002\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\u5c31\u662f\u5efa\u7acb\u4e00\u4e2a\u5c0f\u578b\u7684\u6570\u636e\u5e93\uff0c\u4f46\u662f\u6570\u636e\u5e93\u5e76\u4e0d\u662f\u672c\u6587\u7684\u4e3b\u4f53\u3002\u5b66\u4e60\u5728 Flask \u4e2d\u4f7f\u7528\u5408\u9002\u7684\u6570\u636e\u5e93\uff0c\u6211\u5f3a\u70c8\u5efa\u8bae\u9605\u8bfb <code>Mega-Tutorial &lt;http://www.pythondoc.com/flask-mega-tutorial/index.html&gt;</code>_\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u628a\u4efb\u52a1\u5217\u8868\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u56e0\u6b64\u8fd9\u4e9b\u4efb\u52a1\u5217\u8868\u53ea\u4f1a\u5728 web \u670d\u52a1\u5668\u8fd0\u884c\u4e2d\u5de5\u4f5c\uff0c\u5728\u7ed3\u675f\u7684\u65f6\u5019\u5c31\u5931\u6548\u3002 \u8fd9\u79cd\u65b9\u5f0f\u53ea\u662f\u9002\u7528\u6211\u4eec\u81ea\u5df1\u5f00\u53d1\u7684 web \u670d\u52a1\u5668\uff0c\u4e0d\u9002\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u7684 web \u670d\u52a1\u5668\uff0c \u8fd9\u79cd\u60c5\u51b5\u4e00\u4e2a\u5408\u9002\u7684\u6570\u636e\u5e93\u7684\u642d\u5efa\u662f\u5fc5\u987b\u7684\u3002</p> <p>\u6211\u4eec\u73b0\u5728\u6765\u5b9e\u73b0 web service \u7684\u7b2c\u4e00\u4e2a\u5165\u53e3:</p> <pre><code>#!flask/bin/python\nfrom flask import Flask, jsonify\n\napp = Flask(__name__)\n\ntasks = [\n    {\n        'id': 1,\n        'title': u'Buy groceries',\n        'description': u'Milk, Cheese, Pizza, Fruit, Tylenol', \n        'done': False\n    },\n    {\n        'id': 2,\n        'title': u'Learn Python',\n        'description': u'Need to find a good Python tutorial on the web', \n        'done': False\n    }\n]\n\n@app.route('/todo/api/v1.0/tasks', methods=['GET'])\ndef get_tasks():\n    return jsonify({'tasks': tasks})\n\nif __name__ == '__main__':\n    app.run(debug=True)\n</code></pre> <p>\u6b63\u5982\u4f60\u6240\u89c1\uff0c\u6ca1\u6709\u591a\u5927\u7684\u53d8\u5316\u3002\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\u7684\u5185\u5b58\u6570\u636e\u5e93\uff0c\u8fd9\u91cc\u65e0\u975e\u5c31\u662f\u4e00\u4e2a\u5b57\u5178\u548c\u6570\u7ec4\u3002\u6570\u7ec4\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5143\u7d20\u90fd\u5177\u6709\u4e0a\u8ff0\u5b9a\u4e49\u7684\u4efb\u52a1\u7684\u5c5e\u6027\u3002</p> <p>\u53d6\u4ee3\u4e86\u9996\u9875\uff0c\u6211\u4eec\u73b0\u5728\u62e5\u6709\u4e00\u4e2a get_tasks \u7684\u51fd\u6570\uff0c\u8bbf\u95ee\u7684 URI \u4e3a /todo/api/v1.0/tasks\uff0c\u5e76\u4e14\u53ea\u5141\u8bb8 GET \u7684 HTTP \u65b9\u6cd5\u3002</p> <p>\u8fd9\u4e2a\u51fd\u6570\u7684\u54cd\u5e94\u4e0d\u662f\u6587\u672c\uff0c\u6211\u4eec\u4f7f\u7528 JSON \u6570\u636e\u683c\u5f0f\u6765\u54cd\u5e94\uff0cFlask \u7684 jsonify \u51fd\u6570\u4ece\u6211\u4eec\u7684\u6570\u636e\u7ed3\u6784\u4e2d\u751f\u6210\u3002</p> <p>\u4f7f\u7528\u7f51\u9875\u6d4f\u89c8\u5668\u6765\u6d4b\u8bd5\u6211\u4eec\u7684 web service \u4e0d\u662f\u4e00\u4e2a\u6700\u597d\u7684\u6ce8\u610f\uff0c\u56e0\u4e3a\u7f51\u9875\u6d4f\u89c8\u5668\u4e0a\u4e0d\u80fd\u8f7b\u6613\u5730\u6a21\u62df\u6240\u6709\u7684 HTTP \u8bf7\u6c42\u7684\u65b9\u6cd5\u3002\u76f8\u53cd\uff0c\u6211\u4eec\u4f1a\u4f7f\u7528 curl\u3002\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 curl \u7684\u8bdd\uff0c\u8bf7\u7acb\u5373\u5b89\u88c5\u5b83\u3002</p> <p>\u901a\u8fc7\u6267\u884c app.py\uff0c\u542f\u52a8 web service\u3002\u63a5\u7740\u6253\u5f00\u4e00\u4e2a\u65b0\u7684\u63a7\u5236\u53f0\u7a97\u53e3\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4:</p> <pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 294\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 04:53:53 GMT\n\n{\n\"tasks\": [\n    {\n    \"description\": \"Milk, Cheese, Pizza, Fruit, Tylenol\",\n    \"done\": false,\n    \"id\": 1,\n    \"title\": \"Buy groceries\"\n    },\n    {\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"done\": false,\n    \"id\": 2,\n    \"title\": \"Learn Python\"\n    }\n]\n}\n</code></pre> <p>\u6211\u4eec\u5df2\u7ecf\u6210\u529f\u5730\u8c03\u7528\u6211\u4eec\u7684 RESTful service \u7684\u4e00\u4e2a\u51fd\u6570\uff01</p> <p>\u73b0\u5728\u6211\u4eec\u5f00\u59cb\u7f16\u5199 GET \u65b9\u6cd5\u8bf7\u6c42\u6211\u4eec\u7684\u4efb\u52a1\u8d44\u6e90\u7684\u7b2c\u4e8c\u4e2a\u7248\u672c\u3002\u8fd9\u662f\u4e00\u4e2a\u7528\u6765\u8fd4\u56de\u5355\u72ec\u4e00\u4e2a\u4efb\u52a1\u7684\u51fd\u6570:</p> <pre><code>from flask import abort\n\n@app.route('/todo/api/v1.0/tasks/&lt;int:task_id&gt;', methods=['GET'])\ndef get_task(task_id):\n    task = filter(lambda t: t['id'] == task_id, tasks)\n    if len(task) == 0:\n        abort(404)\n    return jsonify({'task': task[0]})\n</code></pre> <p>\u7b2c\u4e8c\u4e2a\u51fd\u6570\u6709\u4e9b\u610f\u601d\u3002\u8fd9\u91cc\u6211\u4eec\u5f97\u5230\u4e86 URL \u4e2d\u4efb\u52a1\u7684 id\uff0c\u63a5\u7740 Flask \u628a\u5b83\u8f6c\u6362\u6210 \u51fd\u6570\u4e2d\u7684 task_id \u7684\u53c2\u6570\u3002</p> <p>\u6211\u4eec\u7528\u8fd9\u4e2a\u53c2\u6570\u6765\u641c\u7d22\u6211\u4eec\u7684\u4efb\u52a1\u6570\u7ec4\u3002\u5982\u679c\u6211\u4eec\u7684\u6570\u636e\u5e93\u4e2d\u4e0d\u5b58\u5728\u641c\u7d22\u7684 id\uff0c\u6211\u4eec\u5c06\u4f1a\u8fd4\u56de\u4e00\u4e2a\u7c7b\u4f3c 404 \u7684\u9519\u8bef\uff0c\u6839\u636e HTTP \u89c4\u8303\u7684\u610f\u601d\u662f \u201c\u8d44\u6e90\u672a\u627e\u5230\u201d\u3002</p> <p>\u5982\u679c\u6211\u4eec\u627e\u5230\u76f8\u5e94\u7684\u4efb\u52a1\uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u9700\u5c06\u5b83\u7528 jsonify \u6253\u5305\u6210 JSON \u683c\u5f0f\u5e76\u5c06\u5176\u53d1\u9001\u4f5c\u4e3a\u54cd\u5e94\uff0c\u5c31\u50cf\u6211\u4eec\u4ee5\u524d\u90a3\u6837\u5904\u7406\u6574\u4e2a\u4efb\u52a1\u96c6\u5408\u3002</p> <p>\u8c03\u7528 curl \u8bf7\u6c42\u7684\u7ed3\u679c\u5982\u4e0b:</p> <pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/2\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 151\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 05:21:50 GMT\n\n{\n\"task\": {\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"done\": false,\n    \"id\": 2,\n    \"title\": \"Learn Python\"\n}\n}\n$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3\nHTTP/1.0 404 NOT FOUND\nContent-Type: text/html\nContent-Length: 238\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 05:21:52 GMT\n\n&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\"&gt;\n&lt;title&gt;404 Not Found&lt;/title&gt;\n&lt;h1&gt;Not Found&lt;/h1&gt;\n&lt;p&gt;The requested URL was not found on the server.&lt;/p&gt;&lt;p&gt;If you     entered the URL manually please check your spelling and try again.&lt;/p&gt;\n</code></pre> <p>\u5f53\u6211\u4eec\u8bf7\u6c42 id #2 \u7684\u8d44\u6e90\u65f6\u5019\uff0c\u6211\u4eec\u83b7\u53d6\u5230\u4e86\uff0c\u4f46\u662f\u5f53\u6211\u4eec\u8bf7\u6c42 #3 \u7684\u65f6\u5019\u8fd4\u56de\u4e86 404 \u9519\u8bef\u3002\u6709\u5173\u9519\u8bef\u5947\u602a\u7684\u662f\u8fd4\u56de\u7684\u662f HTML \u4fe1\u606f\u800c\u4e0d\u662f JSON\uff0c\u8fd9\u662f\u56e0\u4e3a Flask \u6309\u7167\u9ed8\u8ba4\u65b9\u5f0f\u751f\u6210 404 \u54cd\u5e94\u3002\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a Web service \u5ba2\u6237\u7aef\u5e0c\u671b\u6211\u4eec\u603b\u662f\u4ee5 JSON \u683c\u5f0f\u56de\u5e94\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u6539\u5584\u6211\u4eec\u7684 404 \u9519\u8bef\u5904\u7406\u7a0b\u5e8f:</p> <pre><code>from flask import make_response\n\n@app.errorhandler(404)\ndef not_found(error):\n    return make_response(jsonify({'error': 'Not found'}), 404)\n</code></pre> <p>\u6211\u4eec\u4f1a\u5f97\u5230\u4e00\u4e2a\u53cb\u597d\u7684\u9519\u8bef\u63d0\u793a:</p> <pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3\nHTTP/1.0 404 NOT FOUND\nContent-Type: application/json\nContent-Length: 26\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 05:36:54 GMT\n\n{\n\"error\": \"Not found\"\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u662f POST \u65b9\u6cd5\uff0c\u6211\u4eec\u7528\u6765\u5728\u6211\u4eec\u7684\u4efb\u52a1\u6570\u636e\u5e93\u4e2d\u63d2\u5165\u4e00\u4e2a\u65b0\u7684\u4efb\u52a1:</p> <pre><code>from flask import request\n\n@app.route('/todo/api/v1.0/tasks', methods=['POST'])\ndef create_task():\n    if not request.json or not 'title' in request.json:\n        abort(400)\n    task = {\n        'id': tasks[-1]['id'] + 1,\n        'title': request.json['title'],\n        'description': request.json.get('description', \"\"),\n        'done': False\n    }\n    tasks.append(task)\n    return jsonify({'task': task}), 201\n</code></pre> <p>\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u4efb\u52a1\u4e5f\u662f\u76f8\u5f53\u5bb9\u6613\u5730\u3002\u53ea\u6709\u5f53\u8bf7\u6c42\u4ee5 JSON \u683c\u5f0f\u5f62\u5f0f\uff0crequest.json \u624d\u4f1a\u6709\u8bf7\u6c42\u7684\u6570\u636e\u3002\u5982\u679c\u6ca1\u6709\u6570\u636e\uff0c\u6216\u8005\u5b58\u5728\u6570\u636e\u4f46\u662f\u7f3a\u5c11 title \u9879\uff0c\u6211\u4eec\u5c06\u4f1a\u8fd4\u56de 400\uff0c\u8fd9\u662f\u8868\u793a\u8bf7\u6c42\u65e0\u6548\u3002</p> <p>\u63a5\u7740\u6211\u4eec\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u4efb\u52a1\u5b57\u5178\uff0c\u4f7f\u7528\u6700\u540e\u4e00\u4e2a\u4efb\u52a1\u7684 id + 1 \u4f5c\u4e3a\u8be5\u4efb\u52a1\u7684 id\u3002\u6211\u4eec\u5141\u8bb8 description \u5b57\u6bb5\u7f3a\u5931\uff0c\u5e76\u4e14\u5047\u8bbe done \u5b57\u6bb5\u8bbe\u7f6e\u6210 False\u3002</p> <p>\u6211\u4eec\u628a\u65b0\u7684\u4efb\u52a1\u6dfb\u52a0\u5230\u6211\u4eec\u7684\u4efb\u52a1\u6570\u7ec4\u4e2d\uff0c\u5e76\u4e14\u628a\u65b0\u6dfb\u52a0\u7684\u4efb\u52a1\u548c\u72b6\u6001 201 \u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\u3002</p> <p>\u4f7f\u7528\u5982\u4e0b\u7684 curl \u547d\u4ee4\u6765\u6d4b\u8bd5\u8fd9\u4e2a\u65b0\u7684\u51fd\u6570:</p> <pre><code>$ curl -i -H \"Content-Type: application/json\" -X POST -d '{\"title\":\"Read a book\"}' http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 201 Created\nContent-Type: application/json\nContent-Length: 104\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 05:56:21 GMT\n\n{\n\"task\": {\n    \"description\": \"\",\n    \"done\": false,\n    \"id\": 3,\n    \"title\": \"Read a book\"\n}\n}\n</code></pre> <p>\u6ce8\u610f\uff1a\u5982\u679c\u4f60\u5728 Windows \u4e0a\u5e76\u4e14\u8fd0\u884c Cygwin \u7248\u672c\u7684 curl\uff0c\u4e0a\u9762\u7684\u547d\u4ee4\u4e0d\u4f1a\u6709\u4efb\u4f55\u95ee\u9898\u3002\u7136\u800c\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u539f\u751f\u7684 curl\uff0c\u547d\u4ee4\u4f1a\u6709\u4e9b\u4e0d\u540c:</p> <pre><code>  curl -i -H \"Content-Type: application/json\" -X POST \\\n   -d \"{\"\"\"title\"\"\":\"\"\"Read a book\"\"\"}\" http://localhost:5000/todo/api/v1.0/tasks\n</code></pre> <p>\u5f53\u7136\u5728\u5b8c\u6210\u8fd9\u4e2a\u8bf7\u6c42\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4efb\u52a1\u7684\u66f4\u65b0\u5217\u8868:</p> <pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 423\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 05:57:44 GMT\n\n{\n\"tasks\": [\n    {\n    \"description\": \"Milk, Cheese, Pizza, Fruit, Tylenol\",\n    \"done\": false,\n    \"id\": 1,\n    \"title\": \"Buy groceries\"\n    },\n    {\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"done\": false,\n    \"id\": 2,\n    \"title\": \"Learn Python\"\n    },\n    {\n    \"description\": \"\",\n    \"done\": false,\n    \"id\": 3,\n    \"title\": \"Read a book\"\n    }\n    ]\n}\n</code></pre> <p>\u5269\u4e0b\u7684\u4e24\u4e2a\u51fd\u6570\u5982\u4e0b\u6240\u793a::</p> <pre><code>@app.route('/todo/api/v1.0/tasks/&lt;int:task_id&gt;', methods=['PUT'])\ndef update_task(task_id):\n    task = filter(lambda t: t['id'] == task_id, tasks)\n    if len(task) == 0:\n        abort(404)\n    if not request.json:\n        abort(400)\n    if 'title' in request.json and type(request.json['title']) != unicode:\n        abort(400)\n    if 'description' in request.json and type(request.json['description']) is not unicode:\n        abort(400)\n    if 'done' in request.json and type(request.json['done']) is not bool:\n        abort(400)\n    task[0]['title'] = request.json.get('title', task[0]['title'])\n    task[0]['description'] = request.json.get('description', task[0]['description'])\n    task[0]['done'] = request.json.get('done', task[0]['done'])\n    return jsonify({'task': task[0]})\n\n@app.route('/todo/api/v1.0/tasks/&lt;int:task_id&gt;', methods=['DELETE'])\ndef delete_task(task_id):\n    task = filter(lambda t: t['id'] == task_id, tasks)\n    if len(task) == 0:\n        abort(404)\n    tasks.remove(task[0])\n    return jsonify({'result': True})\n</code></pre> <p>delete_task \u51fd\u6570\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u7684\u3002\u5bf9\u4e8e update_task \u51fd\u6570\uff0c\u6211\u4eec\u9700\u8981\u4e25\u683c\u5730\u68c0\u67e5\u8f93\u5165\u7684\u53c2\u6570\u4ee5\u9632\u6b62\u53ef\u80fd\u7684\u95ee\u9898\u3002\u6211\u4eec\u9700\u8981\u786e\u4fdd\u5728\u6211\u4eec\u628a\u5b83\u66f4\u65b0\u5230\u6570\u636e\u5e93\u4e4b\u524d\uff0c\u4efb\u4f55\u5ba2\u6237\u7aef\u63d0\u4f9b\u6211\u4eec\u7684\u662f\u9884\u671f\u7684\u683c\u5f0f\u3002</p> <p>\u66f4\u65b0\u4efb\u52a1 <code>#2</code> \u7684\u51fd\u6570\u8c03\u7528\u5982\u4e0b\u6240\u793a:</p> <pre><code>$ curl -i -H \"Content-Type: application/json\" -X PUT \\\n  -d '{\"done\":true}' http://localhost:5000/todo/api/v1.0/tasks/2\n\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 170\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 07:10:16 GMT\n\n{\n\"task\": [\n    {\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"done\": true,\n    \"id\": 2,\n    \"title\": \"Learn Python\"\n    }\n]\n}\n</code></pre>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#web-service_1","title":"\u4f18\u5316 web service \u63a5\u53e3","text":"<p>\u76ee\u524d API \u7684\u8bbe\u8ba1\u7684\u95ee\u9898\u5c31\u662f\u8feb\u4f7f\u5ba2\u6237\u7aef\u5728\u4efb\u52a1\u6807\u8bc6\u8fd4\u56de\u540e\u53bb\u6784\u9020 URIs\u3002\u8fd9\u5bf9\u4e8e\u670d\u52a1\u5668\u662f\u5341\u5206\u7b80\u5355\u7684\uff0c\u4f46\u662f\u95f4\u63a5\u5730\u8feb\u4f7f\u5ba2\u6237\u7aef\u77e5\u9053\u8fd9\u4e9b URIs \u662f\u5982\u4f55\u6784\u9020\u7684\uff0c\u8fd9\u5c06\u4f1a\u963b\u788d\u6211\u4eec\u4ee5\u540e\u53d8\u66f4\u8fd9\u4e9b URIs\u3002 </p> <p>\u4e0d\u76f4\u63a5\u8fd4\u56de\u4efb\u52a1\u7684 ids\uff0c\u6211\u4eec\u76f4\u63a5\u8fd4\u56de\u63a7\u5236\u8fd9\u4e9b\u4efb\u52a1\u7684\u5b8c\u6574\u7684 URI\uff0c\u4ee5\u4fbf\u5ba2\u6237\u7aef\u53ef\u4ee5\u968f\u65f6\u4f7f\u7528\u8fd9\u4e9b URIs\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u5199\u4e00\u4e2a\u5c0f\u7684\u8f85\u52a9\u51fd\u6570\u751f\u6210\u4e00\u4e2a \u201c\u516c\u5171\u201d \u7248\u672c\u4efb\u52a1\u53d1\u9001\u5230\u5ba2\u6237\u7aef::</p> <pre><code>from flask import url_for\n\ndef make_public_task(task):\n    new_task = {}\n    for field in task:\n        if field == 'id':\n            new_task['uri'] = url_for('get_task', task_id=task['id'], _external=True)\n        else:\n            new_task[field] = task[field]\n    return new_task\n</code></pre> <p>\u8fd9\u91cc\u6240\u6709\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u4ece\u6211\u4eec\u6570\u636e\u5e93\u4e2d\u53d6\u51fa\u4efb\u52a1\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u4efb\u52a1\uff0c\u8fd9\u4e2a\u4efb\u52a1\u7684 id \u5b57\u6bb5\u88ab\u66ff\u6362\u6210\u901a\u8fc7 Flask \u7684  <code>url_for</code> \u751f\u6210\u7684 <code>uri</code> \u5b57\u6bb5\u3002</p> <p>\u5f53\u6211\u4eec\u8fd4\u56de\u6240\u6709\u7684\u4efb\u52a1\u5217\u8868\u7684\u65f6\u5019\uff0c\u5728\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e4b\u524d\u901a\u8fc7\u8fd9\u4e2a\u51fd\u6570\u8fdb\u884c\u5904\u7406:</p> <pre><code>  @app.route('/todo/api/v1.0/tasks', methods=['GET'])\n  def get_tasks():\n      return jsonify({'tasks': map(make_public_task, tasks)})\n</code></pre> <p>\u8fd9\u91cc\u5c31\u662f\u5ba2\u6237\u7aef\u83b7\u53d6\u4efb\u52a1\u5217\u8868\u7684\u65f6\u5019\u5f97\u5230\u7684\u6570\u636e:</p> <pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 406\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 18:16:28 GMT\n\n{\n\"tasks\": [\n    {\n    \"title\": \"Buy groceries\",\n    \"done\": false,\n    \"description\": \"Milk, Cheese, Pizza, Fruit, Tylenol\",\n    \"uri\": \"http://localhost:5000/todo/api/v1.0/tasks/1\"\n    },\n    {\n    \"title\": \"Learn Python\",\n    \"done\": false,\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"uri\": \"http://localhost:5000/todo/api/v1.0/tasks/2\"\n    }\n    ]\n}\n</code></pre> <p>\u6211\u4eec\u5c06\u4f1a\u628a\u4e0a\u8ff0\u7684\u65b9\u5f0f\u5e94\u7528\u5230\u5176\u5b83\u6240\u6709\u7684\u51fd\u6570\u4e0a\u4ee5\u786e\u4fdd\u5ba2\u6237\u7aef\u4e00\u76f4\u770b\u5230 URIs \u800c\u4e0d\u662f ids\u3002</p>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#restful-web-service_1","title":"\u52a0\u5f3a RESTful web service \u7684\u5b89\u5168\u6027","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\u6211\u4eec web service \u7684\u5927\u90e8\u5206\u529f\u80fd\uff0c\u4f46\u662f\u4ecd\u7136\u6709\u4e00\u4e2a\u95ee\u9898\u3002\u6211\u4eec\u7684 web service \u5bf9\u4efb\u4f55\u4eba\u90fd\u662f\u516c\u5f00\u7684\uff0c\u8fd9\u5e76\u4e0d\u662f\u4e00\u4e2a\u597d\u4e3b\u610f\u3002</p> <p>\u6211\u4eec\u6709\u4e00\u4e2a\u53ef\u4ee5\u7ba1\u7406\u6211\u4eec\u7684\u5f85\u529e\u4e8b\u9879\u5b8c\u6574\u7684 web service\uff0c\u4f46\u5728\u5f53\u524d\u72b6\u6001\u4e0b\u7684 web service \u662f\u5f00\u653e\u7ed9\u6240\u6709\u7684\u5ba2\u6237\u7aef\u3002 \u5982\u679c\u4e00\u4e2a\u964c\u751f\u4eba\u5f04\u6e05\u6211\u4eec\u7684 API \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ed6\u6216\u5979\u53ef\u4ee5\u7f16\u5199\u4e00\u4e2a\u5ba2\u6237\u7aef\u8bbf\u95ee\u6211\u4eec\u7684 web service \u5e76\u4e14\u6bc1\u574f\u6211\u4eec\u7684\u6570\u636e\u3002</p> <p>\u5927\u90e8\u5206\u521d\u7ea7\u7684\u6559\u7a0b\u4f1a\u5ffd\u7565\u8fd9\u4e2a\u95ee\u9898\u5e76\u4e14\u5230\u6b64\u4e3a\u6b62\u3002\u5728\u6211\u770b\u6765\u8fd9\u662f\u4e00\u4e2a\u5f88\u4e25\u91cd\u7684\u95ee\u9898\uff0c\u6211\u5fc5\u987b\u6307\u51fa\u3002</p> <p>\u786e\u4fdd\u6211\u4eec\u7684 web service \u5b89\u5168\u670d\u52a1\u7684\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u8981\u6c42\u5ba2\u6237\u7aef\u63d0\u4f9b\u4e00\u4e2a\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002\u5728\u5e38\u89c4\u7684 web \u5e94\u7528\u7a0b\u5e8f\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u767b\u5f55\u7684\u8868\u5355\u7528\u6765\u8ba4\u8bc1\uff0c\u5e76\u4e14\u670d\u52a1\u5668\u4f1a\u521b\u5efa\u4e00\u4e2a\u4f1a\u8bdd\u4e3a\u767b\u5f55\u7684\u7528\u6237\u4ee5\u540e\u7684\u64cd\u4f5c\u4f7f\u7528\uff0c\u4f1a\u8bdd\u7684 id \u4ee5 cookie \u5f62\u5f0f\u5b58\u50a8\u5728\u5ba2\u6237\u7aef\u6d4f\u89c8\u5668\u4e2d\u3002\u7136\u800c REST \u7684\u89c4\u5219\u4e4b\u4e00\u5c31\u662f \u201c\u65e0\u72b6\u6001\u201d\uff0c \u56e0\u6b64\u6211\u4eec\u5fc5\u987b\u8981\u6c42\u5ba2\u6237\u7aef\u5728\u6bcf\u4e00\u6b21\u8bf7\u6c42\u4e2d\u63d0\u4f9b\u8ba4\u8bc1\u7684\u4fe1\u606f\u3002</p> <p>\u6211\u4eec\u4e00\u76f4\u8bd5\u7740\u5c3d\u53ef\u80fd\u5730\u575a\u6301 HTTP \u6807\u51c6\u534f\u8bae\u3002\u65e2\u7136\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8ba4\u8bc1\u6211\u4eec\u9700\u8981\u5728 HTTP \u4e0a\u4e0b\u6587\u4e2d\u53bb\u5b8c\u6210\uff0c HTTP \u534f\u8bae\u63d0\u4f9b\u4e86\u4e24\u79cd\u8ba4\u8bc1\u673a\u5236: <code>Basic \u548c Digest &lt;http://www.ietf.org/rfc/rfc2617.txt&gt;</code>_\u3002</p> <p>\u6709\u4e00\u4e2a\u5c0f\u7684 Flask \u6269\u5c55\u80fd\u591f\u5e2e\u52a9\u6211\u4eec\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5b89\u88c5 Flask-HTTPAuth::</p> <p><code>$ flask/bin/pip install flask-httpauth</code></p> <p>\u6bd4\u65b9\u8bf4\uff0c\u6211\u4eec\u5e0c\u671b\u6211\u4eec\u7684 web service \u53ea\u8ba9\u8bbf\u95ee\u7528\u6237\u540d miguel \u548c\u5bc6\u7801 python \u7684\u5ba2\u6237\u7aef\u8bbf\u95ee\u3002 \u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a\u57fa\u672c\u7684 HTTP \u9a8c\u8bc1\u5982\u4e0b:</p> <pre><code>from flask.ext.httpauth import HTTPBasicAuth\nauth = HTTPBasicAuth()\n\n@auth.get_password\ndef get_password(username):\n    if username == 'miguel':\n        return 'python'\n    return None\n\n@auth.error_handler\ndef unauthorized():\n    return make_response(jsonify({'error': 'Unauthorized access'}), 401)\n</code></pre> <p><code>get_password</code> \u51fd\u6570\u662f\u4e00\u4e2a\u56de\u8c03\u51fd\u6570\uff0cFlask-HTTPAuth \u4f7f\u7528\u5b83\u6765\u83b7\u53d6\u7ed9\u5b9a\u7528\u6237\u7684\u5bc6\u7801\u3002\u5728\u4e00\u4e2a\u66f4\u590d\u6742\u7684\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u4e2a\u51fd\u6570\u662f\u9700\u8981\u68c0\u67e5\u4e00\u4e2a\u7528\u6237\u6570\u636e\u5e93\uff0c\u4f46\u662f\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u53ea\u6709\u5355\u4e00\u7684\u7528\u6237\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u3002</p> <p><code>error_handler</code> \u56de\u8c03\u51fd\u6570\u662f\u7528\u4e8e\u7ed9\u5ba2\u6237\u7aef\u53d1\u9001\u672a\u6388\u6743\u9519\u8bef\u4ee3\u7801\u3002\u50cf\u6211\u4eec\u5904\u7406\u5176\u5b83\u7684\u9519\u8bef\u4ee3\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9a\u5236\u4e00\u4e2a\u5305\u542b JSON \u6570\u636e\u683c\u5f0f\u800c\u4e0d\u662f HTML \u7684\u54cd\u5e94\u3002</p> <p>\u968f\u7740\u8ba4\u8bc1\u7cfb\u7edf\u7684\u5efa\u7acb\uff0c\u6240\u5269\u4e0b\u7684\u5c31\u662f\u628a\u9700\u8981\u8ba4\u8bc1\u7684\u51fd\u6570\u6dfb\u52a0 <code>@auth.login_required</code> \u88c5\u9970\u5668\u3002\u4f8b\u5982:</p> <pre><code>@app.route('/todo/api/v1.0/tasks', methods=['GET'])\n@auth.login_required\ndef get_tasks():\n    return jsonify({'tasks': tasks})\n</code></pre> <p>\u5982\u679c\u73b0\u5728\u8981\u5c1d\u8bd5\u4f7f\u7528 <code>curl</code> \u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u6211\u4eec\u4f1a\u5f97\u5230:</p> <p><pre><code>$ curl -i http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 401 UNAUTHORIZED\nContent-Type: application/json\nContent-Length: 36\nWWW-Authenticate: Basic realm=\"Authentication Required\"\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 06:41:14 GMT\n\n{\n\"error\": \"Unauthorized access\"\n}\n</code></pre> \u4e3a\u4e86\u80fd\u591f\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u6211\u4eec\u5fc5\u987b\u53d1\u9001\u6211\u4eec\u7684\u8ba4\u8bc1\u51ed\u636e:</p> <p><pre><code>$ curl -u miguel:python -i http://localhost:5000/todo/api/v1.0/tasks\nHTTP/1.0 200 OK\nContent-Type: application/json\nContent-Length: 316\nServer: Werkzeug/0.8.3 Python/2.7.3\nDate: Mon, 20 May 2013 06:46:45 GMT\n\n{\n\"tasks\": [\n    {\n    \"title\": \"Buy groceries\",\n    \"done\": false,\n    \"description\": \"Milk, Cheese, Pizza, Fruit, Tylenol\",\n    \"uri\": \"http://localhost:5000/todo/api/v1.0/tasks/1\"\n    },\n    {\n    \"title\": \"Learn Python\",\n    \"done\": false,\n    \"description\": \"Need to find a good Python tutorial on the web\",\n    \"uri\": \"http://localhost:5000/todo/api/v1.0/tasks/2\"\n    }\n]\n}\n</code></pre> \u8ba4\u8bc1\u6269\u5c55\u7ed9\u4e88\u6211\u4eec\u5f88\u5927\u7684\u81ea\u7531\u9009\u62e9\u54ea\u4e9b\u51fd\u6570\u9700\u8981\u4fdd\u62a4\uff0c\u54ea\u4e9b\u51fd\u6570\u9700\u8981\u516c\u5f00\u3002</p> <p>\u4e3a\u4e86\u786e\u4fdd\u767b\u5f55\u4fe1\u606f\u7684\u5b89\u5168\u5e94\u8be5\u4f7f\u7528 HTTP \u5b89\u5168\u670d\u52a1\u5668(\u4f8b\u5982:<code>https://...</code>)\uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u90fd\u662f\u52a0\u5bc6\u7684\uff0c\u4ee5\u9632\u6b62\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u7b2c\u4e09\u65b9\u770b\u5230\u8ba4\u8bc1\u7684\u51ed\u636e\u3002</p> <p>\u8ba9\u4eba\u4e0d\u8212\u670d\u7684\u662f\u5f53\u8bf7\u6c42\u6536\u5230\u4e00\u4e2a 401 \u7684\u9519\u8bef\uff0c\u7f51\u9875\u6d4f\u89c8\u90fd\u4f1a\u8df3\u51fa\u4e00\u4e2a\u4e11\u964b\u7684\u767b\u5f55\u6846\uff0c\u5373\u4f7f\u8bf7\u6c42\u662f\u5728\u540e\u53f0\u53d1\u751f\u7684\u3002\u56e0\u6b64\u5982\u679c\u6211\u4eec\u8981\u5b9e\u73b0\u4e00\u4e2a\u5b8c\u7f8e\u7684 web \u670d\u52a1\u5668\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7981\u6b62\u8df3\u8f6c\u5230\u6d4f\u89c8\u5668\u663e\u793a\u8eab\u4efd\u9a8c\u8bc1\u5bf9\u8bdd\u6846\uff0c\u8ba9\u6211\u4eec\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u7a0b\u5e8f\u81ea\u5df1\u5904\u7406\u767b\u5f55\u3002</p> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u4e0d\u8fd4\u56de 401 \u9519\u8bef\u3002403 \u9519\u8bef\u662f\u4e00\u4e2a\u4ee4\u4eba\u9752\u7750\u7684\u66ff\u4ee3\uff0c403 \u9519\u8bef\u8868\u793a \u201c\u7981\u6b62\u201d \u7684\u9519\u8bef:</p> <pre><code>@auth.error_handler\ndef unauthorized():\n    return make_response(jsonify({'error': 'Unauthorized access'}), 403)\n</code></pre>","tags":["restful","flask","api"]},{"location":"programming/design-restful-api-with-python-and-flask/#_1","title":"\u53ef\u80fd\u7684\u6539\u8fdb","text":"<p>\u6211\u4eec\u7f16\u5199\u7684\u5c0f\u578b\u7684 web service \u8fd8\u53ef\u4ee5\u5728\u4e0d\u5c11\u7684\u65b9\u9762\u8fdb\u884c\u6539\u8fdb\u3002</p> <p>\u5bf9\u4e8e\u521d\u5b66\u8005\u6765\u8bf4\uff0c\u4e00\u4e2a\u771f\u6b63\u7684 web service \u9700\u8981\u4e00\u4e2a\u771f\u5b9e\u7684\u6570\u636e\u5e93\u8fdb\u884c\u652f\u6491\u3002\u6211\u4eec\u73b0\u5728\u4f7f\u7528\u7684\u5185\u5b58\u6570\u636e\u7ed3\u6784\u4f1a\u6709\u5f88\u591a\u9650\u5236\u4e0d\u5e94\u8be5\u88ab\u7528\u4e8e\u771f\u6b63\u7684\u5e94\u7528\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u53ef\u4ee5\u63d0\u9ad8\u7684\u9886\u57df\u5c31\u662f\u5904\u7406\u591a\u7528\u6237\u3002\u5982\u679c\u7cfb\u7edf\u652f\u6301\u591a\u7528\u6237\u7684\u8bdd\uff0c\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\u53ef\u4ee5\u53d1\u9001\u4e0d\u540c\u7684\u8ba4\u8bc1\u51ed\u8bc1\u83b7\u53d6\u76f8\u5e94\u7528\u6237\u7684\u4efb\u52a1\u5217\u8868\u3002\u5728\u8fd9\u6837\u4e00\u4e2a\u7cfb\u7edf\u4e2d\u7684\u8bdd\uff0c\u6211\u4eec\u9700\u8981\u7b2c\u4e8c\u4e2a\u8d44\u6e90\u5c31\u662f\u7528\u6237\u3002\u5728\u7528\u6237\u8d44\u6e90\u4e0a\u7684 POST \u7684\u8bf7\u6c42\u4ee3\u8868\u6ce8\u518c\u6362\u4e00\u4e2a\u65b0\u7528\u6237\u3002\u4e00\u4e2a GET \u8bf7\u6c42\u8868\u793a\u5ba2\u6237\u7aef\u83b7\u53d6\u4e00\u4e2a\u7528\u6237\u7684\u4fe1\u606f\u3002\u4e00\u4e2a PUT \u8bf7\u6c42\u8868\u793a\u66f4\u65b0\u7528\u6237\u4fe1\u606f\uff0c\u6bd4\u5982\u53ef\u80fd\u662f\u66f4\u65b0\u90ae\u7bb1\u5730\u5740\u3002\u4e00\u4e2a DELETE \u8bf7\u6c42\u8868\u793a\u5220\u9664\u7528\u6237\u8d26\u53f7\u3002</p> <p>GET \u68c0\u7d22\u4efb\u52a1\u5217\u8868\u8bf7\u6c42\u53ef\u4ee5\u5728\u51e0\u4e2a\u65b9\u9762\u8fdb\u884c\u6269\u5c55\u3002\u9996\u5148\u53ef\u4ee5\u643a\u5e26\u4e00\u4e2a\u53ef\u9009\u7684\u9875\u7684\u53c2\u6570\uff0c\u4ee5\u4fbf\u5ba2\u6237\u7aef\u8bf7\u6c42\u4efb\u52a1\u7684\u4e00\u90e8\u5206\u3002\u53e6\u5916\uff0c\u8fd9\u79cd\u6269\u5c55\u66f4\u52a0\u6709\u7528\uff1a\u5141\u8bb8\u6309\u7167\u4e00\u5b9a\u7684\u6807\u51c6\u7b5b\u9009\u3002\u6bd4\u5982\uff0c\u7528\u6237\u53ea\u60f3\u8981\u770b\u5230\u5b8c\u6210\u7684\u4efb\u52a1\uff0c\u6216\u8005\u53ea\u60f3\u770b\u5230\u4efb\u52a1\u7684\u6807\u9898\u4ee5 A \u5b57\u6bcd\u5f00\u5934\u3002\u6240\u6709\u7684\u8fd9\u4e9b\u90fd\u53ef\u4ee5\u4f5c\u4e3a URL \u7684\u4e00\u4e2a\u53c2\u6570\u9879\u3002</p>","tags":["restful","flask","api"]},{"location":"programming/programming-with-vim/","title":"\u65e0\u63d2\u4ef6 Vim \u7f16\u7a0b\u6280\u5de7","text":"<p>\u76f8\u4fe1\u5927\u5bb6\u770b\u8fc7\u300a\u7b80\u660eVim\u6559\u7a0b\u300b\u4e5f\u73a9\u4e86\u300aVim\u5927\u5192\u9669\u300b\u7684\u6e38\u620f\u4e86\uff0c\u76f8\u4fe1\u5927\u5bb6\u5bf9Vim\u90fd\u6709\u4e00\u4e2a\u597d\u7684\u5165\u95e8\u4e86\u3002\u6211\u5728\u8fd9\u91cc\u628a\u6211\u65e5\u5e38\u7528Vim\u7f16\u7a0b\u7684\u4e00\u4e9b\u6280\u5de7\u5217\u51fa\u6765\u7ed9\u5927\u5bb6\u770b\u770b\uff0c\u5e0c\u671b\u5bf9\u5927\u5bb6\u6709\u7528\uff0c\u53e6\u5916\uff0c\u4e5f\u662f\u4e00\u4e2a\u629b\u7816\u5f15\u7389\u7684\u8fc7\u7a0b\uff0c\u4e5f\u5e0c\u671b\u5927\u5bb6\u628a\u4f60\u4eec\u7684\u6280\u5de7\u8ddf\u8d34\u4e00\u4e0b\uff0c\u6211\u4f1a\u66f4\u65b0\u5230\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u3002\u53e6\u5916\uff0c\u8fd9\u7bc7\u6587\u7ae0\u91cc\u7684\u8fd9\u4e9b\u6280\u5de7\u5168\u90fd\u662fvim\u539f\u751f\u6001\u7684\uff0c\u4e0d\u9700\u8981\u4f60\u5b89\u88c5\u4ec0\u4e48\u63d2\u4ef6\u3002\u6211\u7684Vim\u7684\u7248\u672c\u662f7.2\u3002</p>","tags":["vim"]},{"location":"programming/programming-with-vim/#_1","title":"\u6d4f\u89c8\u4ee3\u7801","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u5148\u4ece\u6d4f\u89c8\u4ee3\u7801\u5f00\u59cb\u3002\u6709\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u770b\u591a\u4e2a\u6587\u4ef6\uff0c\u6240\u4ee5\uff0c\u4f20\u7edf\u7684\u505a\u6cd5\u662f\uff0c\u6211\u4eec\u5f00\u591a\u4e2atty\u7ec8\u7aef\uff0c\u6bcf\u4e2atty\u91cc\u7528Vim\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u6765\u56de\u5207\u6362\u3002\u8fd9\u5f88\u6ca1\u6709\u4ec0\u4e48\u6548\u7387\u3002\u6211\u4eec\u5e0c\u671b\u5728\u4e00\u4e2aVim\u91cc\u6253\u5f00\u591a\u4e2a\u6587\u4ef6\uff0c\u751a\u81f3\u6d4f\u89c8\u7a0b\u5e8f\u76ee\u5f55\u3002</p> <p>\u6d4f\u89c8\u76ee\u5f55\u7684\u547d\u4ee4\u5f88\u7b80\u5355\uff1a\uff08\u4f60\u4e5f\u53ef\u4ee5\u76f4\u63a5vim\u4e00\u4e2a\u76ee\u5f55\uff09</p> <p><code>:E</code></p> <p>\u6ce8\u610f\uff0c\u662f\u5927\u5199\u3002\u4e8e\u662f\uff0c\u4f60\u4f1a\u770b\u5230\u4e0b\u9762\u8fd9\u6837\u7684\u754c\u9762\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u754c\u9762\u4e2d\uff0c\u4f60\u53ef\u4ee5\u7528 j, k \u952e\u4e0a\u4e0b\u79fb\u52a8\uff0c\u7136\u540e\u56de\u8f66\uff0c\u8fdb\u5165\u4e00\u4e2a\u76ee\u5f55\uff0c\u6216\u662f\u627e\u5f00\u4e00\u4e2a\u6587\u4ef6\u3002\u4f60\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6709\u4e00\u5806\u547d\u4ee4\uff1a</p> <ul> <li><code>\u2013</code> \u5230\u4e0a\u7ea7\u76ee\u5f55</li> <li><code>D</code> \u5220\u9664\u6587\u4ef6\uff08\u5927\u5199\uff09</li> <li><code>R</code> \u6539\u6587\u4ef6\u540d\uff08\u5927\u5199\uff09</li> <li><code>s</code> \u5bf9\u6587\u4ef6\u6392\u5e8f\uff08\u5c0f\u5199\uff09</li> <li><code>x</code> \u6267\u884c\u6587\u4ef6</li> </ul> <p>\u5f53\u7136\uff0c\u6253\u5f00\u7684\u6587\u4ef6\u4f1a\u628a\u73b0\u6709\u5df2\u6253\u5f00\u7684\u6587\u4ef6\u7ed9\u51b2\u6389\u2014\u2014\u4e5f\u5c31\u662f\u8bf4\u4f60\u53ea\u770b\u5230\u4e86\u4e00\u4e2a\u6587\u4ef6\u3002</p> <p>\u5982\u679c\u4f60\u8981\u6539\u53d8\u5f53\u524d\u6d4f\u89c8\u7684\u76ee\u5f55\uff0c\u6216\u662f\u67e5\u770b\u5f53\u524d\u6d4f\u89c8\u7684\u76ee\u5f55\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u548cshell\u4e00\u6837\u7684\u547d\u4ee4\uff1a</p> <pre><code>:cd &lt;dir&gt; \u2013 \u6539\u53d8\u5f53\u524d\u76ee\u5f55\n:pwd  \u2013 \u67e5\u770b\u5f53\u524d\u76ee\u5f55\n</code></pre>","tags":["vim"]},{"location":"programming/programming-with-vim/#_2","title":"\u7f13\u51b2\u533a","text":"<p>\u5176\u5b9e\uff0c\u4f60\u7528:E \u6d4f\u89c8\u6253\u5f00\u7684\u6587\u4ef6\u90fd\u6ca1\u6709\u88ab\u5173\u95ed\uff0c\u8fd9\u4e9b\u6587\u4ef6\u90fd\u5728\u7f13\u51b2\u533a\u4e2d\u3002\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u7f13\u51b2\u533a\uff1a</p> <p><code>:ls</code></p> <p>\u4e8e\u662f\uff0c\u5728\u4f60\u7684Vim\u4e0b\uff0c\u4f60\u4f1a\u770b\u5230\u5982\u4e0b\u754c\u9762\uff1a</p> <pre><code>:ls\n  1 %a   \"design-restful-api-with-python-and-flask.md\" line 1\n  2      \"pure-bash-bible.md\"           line 0\n  3      \"understanding-awk.md\"         line 0\n  4      \"programming-with-vim.md\"      line 0\n</code></pre> <p>\u4f60\u53ef\u4ee5\u770b\u5230Vim\u6253\u5f00\u4e86\u56db\u4e2a\u6587\u4ef6\uff0c\u7f16\u53f7\u662f4\uff0c5\uff0c6\uff0c7\uff0c\u5982\u679c\u4f60\u8981\u5207\u6362\u6253\u5f00\u7684\u6587\u4ef6\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u4f60\u4e0d\u8981\u6309\u56de\u8f66\uff08\u6309\u4e86\u4e5f\u6ca1\u4e8b\uff0c\u53ea\u4e0d\u8fc7\u6309\u4e86\u5c31\u770b\u4e0d\u5230:ls\u8f93\u51fa\u7684buffer\u5217\u8868\u4e86\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5207\u6362\u6587\u4ef6\uff08buffer\u540e\u9762\u76844\u8868\u793a\u5207\u52304\u53f7\u6587\u4ef6\u4e5f\u5c31\u662fsrc/http/ngx_http.c\uff09\uff1a</p> <p><code>:buffer 4</code></p> <p>\u6216\u662f\uff1a</p> <p><code>:buffer programming-with-vim.md</code></p> <p>\u6ce8\u610f\uff0c</p> <p>\u4f60\u53ef\u4ee5\u50cf\u5728Shell\u4e2d\u8f93\u5165\u547d\u4ee4\u6309Tab\u952e\u8865\u5168\u4e00\u6837\u8865\u5168Vim\u7684\u547d\u4ee4\u3002 \u4e5f\u53ef\u4ee5\u7528\u50cfgdb\u4e00\u6837\u7528\u6700\u524d\u9762\u7684\u51e0\u4e2a\u5b57\u7b26\uff0c\u53ea\u8981\u6ca1\u6709\u51b2\u7a81\u3002\u5982\uff1abuff \u4f60\u8fd8\u53ef\u4ee5\u52a8\u7528\u5982\u4e0b\u547d\u4ee4\uff0c\u5feb\u901f\u5207\u6362\uff1a</p> <ul> <li>:bnext      \u7f29\u5199 :bn</li> <li>:bprevious   \u7f29\u5199 :bp</li> <li>:blast  \u7f29\u5199 :bl</li> <li>:bfirst \u7f29\u5199 :bf</li> </ul> <p>\u4e0a\u56fe\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u770b\u52305\u6709\u4e00\u4e2a%a\uff0c\u8fd9\u8868\u793a\u5f53\u524d\u6587\u4ef6\uff0c\u76f8\u5173\u7684\u6807\u8bb0\u5982\u4e0b\uff1a</p> <ul> <li>- \uff08\u975e\u6d3b\u52a8\u7684\u7f13\u51b2\u533a\uff09</li> <li>a \uff08\u5f53\u524d\u88ab\u6fc0\u6d3b\u7f13\u51b2\u533a\uff09</li> <li>h \uff08\u9690\u85cf\u7684\u7f13\u51b2\u533a\uff09</li> <li>% \uff08\u5f53\u524d\u7684\u7f13\u51b2\u533a\uff09</li> <li># \uff08\u4ea4\u6362\u7f13\u51b2\u533a\uff09</li> <li>= \uff08\u53ea\u8bfb\u7f13\u51b2\u533a\uff09</li> <li>+ \uff08\u5df2\u7ecf\u66f4\u6539\u7684\u7f13\u51b2\u533a\uff09</li> </ul>","tags":["vim"]},{"location":"programming/programming-with-vim/#_3","title":"\u7a97\u53e3\u5206\u5c4f\u6d4f\u89c8","text":"<p>\u76f8\u4fe1\u4f60\u5728\u300aVim\u7684\u7a97\u53e3\u5206\u5c4f\u300b\u4e00\u6587\u4e2d\uff0c\u4f60\u5df2\u7ecf\u77e5\u9053\u4e86\u600e\u4e48\u62c6\u5206\u7a97\u53e3\u4e86\u3002\u5176\u5b9e\uff0c\u6211\u66f4\u591a\u7684\u4e0d\u662f\u7528\u62c6\u5206\u7a97\u53e3\u7684\u547d\u4ee4\uff0c\u800c\u662f\u7528\u6d4f\u89c8\u6587\u4ef6\u7684\u547d\u4ee4\u6765\u5206\u9694\u7a97\u53e3\u3002\u5982\uff1a</p> <p>\u628a\u5f53\u524d\u7a97\u53e3\u4e0a\u4e0b\u5206\u5c4f\uff0c\u5e76\u5728\u4e0b\u9762\u8fdb\u884c\u76ee\u5f55\u6d4f\u89c8\uff1a</p> <p>:He   \u5168\u79f0\u4e3a :Hexplore  \uff08\u5728\u4e0b\u8fb9\u5206\u5c4f\u6d4f\u89c8\u76ee\u5f55\uff09</p> <p>\u5982\u679c\u4f60\u8981\u5728\u4e0a\u9762\uff0c\u4f60\u5c31\u5728 <code>:He</code>\u540e\u9762\u52a0\u4e2a<code>!</code>\uff0c</p> <p>:He!  \uff08\u5728\u4e0a\u5206\u5c4f\u6d4f\u89c8\u76ee\u5f55\uff09</p> <p>\u5982\u679c\u4f60\u8981\u5de6\u53f3\u5206\u5c4f\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u8fd9\u6837\uff1a</p> <p>:Ve \u5168\u79f0\u4e3a :Vexplore \uff08\u5728\u5de6\u8fb9\u5206\u5c4f\u95f4\u6d4f\u89c8\u76ee\u5f55\uff0c\u8981\u5728\u53f3\u8fb9\u5219\u662f :Ve!\uff09</p> <p>\u4e0b\u56fe\u662f\u5206\u522b\u7528<code>:He</code> \u548c <code>:Ve</code>\u641e\u51fa\u6765\u7684\u540c\u65f6\u770b\u4e09\u4e2a\u6587\u4ef6\uff1a</p> <p>\u5728\u5206\u5c4f\u95f4\u7684\u8df3\u8f6c\u548c\u5207\u6362\u5728\u300aVim\u7684\u7a97\u53e3\u5206\u5c4f\u300b\u4e00\u6587\u4e2d\u63d0\u8fc7\u4e86\uff1a\u5148\u6309<code>Ctrl + W</code>\uff0c\u7136\u540e\u6309\u65b9\u5411\u952e\uff1a<code>h j k l</code></p>","tags":["vim"]},{"location":"programming/programming-with-vim/#_4","title":"\u5206\u5c4f\u540c\u6b65\u79fb\u52a8","text":"<p>\u8981\u8ba9\u4e24\u4e2a\u5206\u5c4f\u4e2d\u7684\u6587\u4ef6\u540c\u6b65\u79fb\u52a8\uff0c\u5f88\u7b80\u5355\uff0c\u4f60\u9700\u8981\u5230\u9700\u8981\u540c\u6b65\u79fb\u52a8\u7684\u4e24\u4e2a\u5c4f\u4e2d\u90fd\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff08\u76f8\u5f53\u4e8e\u4f7f\u7528\u201c\u94c1\u9501\u8fde\u73af\u201d\uff09\uff1a</p> <p><code>:set scb</code></p> <p>\u5982\u679c\u4f60\u9700\u8981\u89e3\u5f00\uff0c\u90a3\u4e48\u5c31\u8f93\u5165\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <p><code>:set scb!</code></p> <p>\u6ce8\uff1aset scb \u662f set scrollbind \u7684\u7b80\u5199\u3002</p>","tags":["vim"]},{"location":"programming/programming-with-vim/#tab","title":"Tab\u9875\u6d4f\u89c8\u76ee\u5f55","text":"<p>\u5206\u5c4f\u53ef\u80fd\u4f1a\u8ba9\u4f60\u4e0d\u723d\uff0c\u4f60\u53ef\u80fd\u66f4\u559c\u6b22\u50cfChrome\u8fd9\u6837\u7684\u5206\u9875\u5f0f\u7684\u6d4f\u89c8\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <p><code>:Te  \u5168\u79f0\u662f :Texplorer</code></p> <p>\u4e0b\u56fe\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6211\u7528Te\u547d\u4ee4\u6253\u5f00\u4e86\u4e09\u9875\uff0c\u5c31\u5728\u9876\u7aef\u6211\u4eec\u53ef\u4ee5\u53ef\u4ee5\u770b\u5230\u6709\u4e09\u9875\uff0c\u5176\u4e2d\u7b2c\u4e00\u9875Tab\u4e0a\u7684\u6570\u5b573\u8868\u793a\u90a3\u4e00\u9875\u67093\u4e2a\u6587\u4ef6\u3002</p> <p>\u6211\u4eec\u8981\u5728\u591a\u4e2aTabe\u9875\u4e2d\u5207\u6362\uff0c\u5728normal\u6a21\u5f0f\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u4e09\u4e2a\u6309\u952e\uff08\u6ce8\u610f\u6ca1\u6709\u5192\u53f7\uff09\uff1a</p> <ul> <li> <p>gt   \u2013 \u5230\u4e0b\u4e00\u4e2a\u9875</p> </li> <li> <p>gT  \u2013 \u5230\u524d\u4e00\u4e2a\u9875</p> </li> <li> <p>{i} gt   \u2013 i\u662f\u6570\u5b57\uff0c\u5230\u6307\u5b9a\u9875\uff0c\u6bd4\u5982\uff1a5 gt \u5c31\u662f\u5230\u7b2c5\u9875</p> </li> </ul> <p>\u4f60\u53ef\u4ee5\u4ee5\u4f7f\u7528 <code>:tabm {n}</code> \u6765\u5207\u6362Tab\u9875\u3002</p> <p>gvim\u5e94\u8be5\u662f\uff1a<code>Ctrl+PgDn</code> \u548c <code>Ctrl+PgUp</code> \u6765\u5728\u5404\u4e2a\u9875\u4e2d\u5207\u6362\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u770b\u770b\u4f60\u73b0\u5728\u6253\u5f00\u7684\u7a97\u53e3\u548cTab\u7684\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <p><code>:tabs</code></p> <p>\u4e8e\u662f\u4f60\u53ef\u4ee5\u770b\u5230\uff1a</p> <p>\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5173\u95edtab\uff1a\uff08\u5f53\u7136\uff0c\u6211\u66f4\u559c\u6b22\u4f7f\u7528\u4f20\u7edf\u7684<code>:q</code>, <code>:wq</code>\u6765\u5173\u95ed\uff09</p> <ul> <li>:tabclose [i] \u2013 \u5982\u679c\u540e\u9762\u6307\u5b9a\u4e86\u6570\u5b57\uff0c\u90a3\u5c31\u5173\u95ed\u6307\u5b9a\u9875\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u5173\u95ed\u5f53\u524d\u9875</li> </ul> <p>\u6700\u540e\u63d0\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u5728Shell\u547d\u4ee4\u884c\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 vim \u7684 -p \u53c2\u6570\u6765\u7528Tab\u9875\u7684\u65b9\u5f0f\u6253\u5f00\u591a\u4e2a\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>vim -p cool.cpp shell.cpp haoel.cpp\nvim -p *.cpp\n</code></pre> <p>\u6ce8\uff1a\u5982\u679c\u4f60\u60f3\u628abuffer\u4e2d\u7684\u6587\u4ef6\u5168\u8f6c\u6210tab\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4</p> <p><code>:bufdo tab split</code></p>","tags":["vim"]},{"location":"programming/programming-with-vim/#_5","title":"\u4fdd\u5b58\u4f1a\u8bdd","text":"<p>\u5982\u679c\u4f60\u7528Tab\u6216Window\u6253\u5f00\u4e86\u597d\u4e9b\u6587\u4ef6\u7684\u6587\u4ef6\uff0c\u8fd8\u8bbe\u7f6e\u4e86\u5404\u79cd\u6eda\u5c4f\u540c\u6b65\uff0c\u6216\u662f\u884c\u53f7\u2026\u2026\uff0c\u90a3\u4e48\uff0c\u4f60\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u4fdd\u5b58\u4f1a\u8bdd\uff1a\uff08\u4f60\u6709\u5174\u8da3\u4f60\u53ef\u4ee5\u770b\u770b\u4f60\u7684 mysession.vim\u6587\u4ef6\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a\u6279\u5904\u7406\u6587\u4ef6\uff09</p> <p><code>:mksession ~/.mysession.vim</code></p> <p>\u5982\u679c\u6587\u4ef6\u91cd\u590d\uff0cvim\u9ed8\u8ba4\u4f1a\u62a5\u9519\uff0c\u5982\u679c\u4f60\u60f3\u5f3a\u884c\u5199\u5165\u7684\u8bdd\uff0c\u4f60\u53ef\u4ee5\u5728mksession\u540e\u52a0! \uff1a</p> <p><code>:mksession! ~/.mysession.vim</code></p> <p>\u4e8e\u662f\u4e0b\u6b21\uff0c\u4f60\u53ef\u4ee5\u8fd9\u6837\u6253\u5f00\u8fd9\u4e2a\u4f1a\u8bdd\uff1a</p> <p><code>vim -S ~/.mysession.vim</code></p> <p>\u4fdd\u5b58\u5b8c\u4f1a\u8bdd\u540e\uff0c\u4f60\u4e5f\u6ca1\u6709\u5fc5\u8981\u4e00\u4e2a\u4e00\u4e2aTab/Windows\u7684\u53bbClose\u3002\u4f60\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528\uff1a</p> <ul> <li> <p>:qa   \u2013 \u9000\u51fa\u5168\u90e8 </p> </li> <li> <p>:wqa  -\u4fdd\u5b58\u5168\u90e8\u5e76\u9000\u51fa\u5168\u90e8</p> </li> </ul>","tags":["vim"]},{"location":"programming/programming-with-vim/#quickfix","title":"Quickfix","text":"<p>\u5047\u5982\u6211\u4eec\u6709\u4e00\u4e2a<code>hello.cpp</code>\u6587\u4ef6\u548c\u4e00\u4e2a<code>makefile</code>\uff0c\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728vim\u4e0b\u8f93\u5165 <code>:make</code> \uff0c \u4e8e\u662f\u5c31\u53ef\u4ee5make\u8fd9\u4e2a<code>hello.cpp</code>\u6587\u4ef6\uff0c\u5982\u679c\u51fa\u9519\u4e86\uff0c\u6211\u4eec\u9700\u8981\u6309\u56de\u8f66\u8fd4\u56de\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u628a\u51fa\u9519\u663e\u5230\u5728vim\u7684\u5206\u5c4f\u4e2d\uff1a</p> <ul> <li>:cw</li> </ul> <p>\u4e8e\u662f\uff0c\u5c31\u4f1a\u51fa\u73b0\u4e0b\u9762\u53f3\u8fb9\u7684\u90a3\u4e2a\u6837\u5b50\uff1a\uff08\u662f\u4e0d\u662f\u770b\u4e0a\u53bb\u548c\u6211\u4e00\u6837\u5f88\u5e05\uff1f\uff09</p> <p>\u4e0a\u56fe\u4e2d\u5de6\u8fb9\u662f\u6211\u7684makefile\uff0c\u53f3\u8fb9\u662f\u6211\u7684\u9519\u8bef\u767e\u51fa\u7684\u6e90\u4ee3\u7801\uff0c\u53f3\u8fb9\u4e0b\u9762\u662fquickfix\u7a97\u5c4f\u3002\u4f60\u53ef\u4ee5\u770b\u5230quickfix\u7a97\u5c4f\u6307\u5411\u7684\u7b2c\u4e00\u4e2a\u9519\u8bef\u5df2\u7ecf\u5b9a\u4f4d\u5230\u6211\u4eec\u76f8\u5c31\u9519\u8bef\u7684\u6587\u4ef6\u884c\u4e0a\u4e86\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528\u50cf\u6d4f\u89c8\u6587\u4ef6\u90a3\u6837\u7528j, k\u5728quckfix\u7a97\u5c4f\u4e2d\u4e0a\u4e0b\u79fb\u52a8\u5230\u76f8\u5e94\u7684\u9519\u8bef\u4e0a\u7136\u540e\u6309\u56de\u8f66\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5728\u4e0a\u9762\u7684\u7a97\u5c4f\u91cc\u5b9a\u4f4d\u5230\u76f8\u5e94\u7684\u6e90\u6587\u4ef6\u7684\u4ee3\u7801\u884c\u3002\u4f46\u662f\uff0c\u5982\u679c\u662f\u8fd9\u6837\u7684\u8bdd\uff0c \u4f60\u8981\u5b9a\u4f4d\u4e0b\u4e00\u6761\u9519\u8bef\u8fd8\u5f97\u7528Ctrl +W \u56de\u5230quickfix\u5c4f\u4e2d\u6765\u7136\u540e\u91cd\u590d\u6765\u8fc7\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u800c\u4e0d\u7528\u56de\u5230quickfix\u4e2d\u6765\uff1a</p> <ul> <li> <p>:cp \u8df3\u5230\u4e0a\u4e00\u4e2a\u9519\u8bef</p> </li> <li> <p>:cn \u8df3\u5230\u4e0b\u4e00\u4e2a\u9519\u8bef</p> </li> <li> <p>:cl \u5217\u51fa\u6240\u6709\u9519\u8bef</p> </li> <li> <p>:cc \u663e\u793a\u9519\u8bef\u8be6\u7ec6\u4fe1\u606f</p> </li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u6765\u770b\u53e6\u4e00\u4e2aquickfix\u7684\u529f\u80fd\u3002</p> <p>\u5982\u679c\u4f60\u7528\u8fc7vim\u7684cscope\u63d2\u4ef6\uff0c\u4f60\u5c31\u77e5\u9053cscope\u53ef\u4ee5\u7528\u6765\u67e5\u627e\u76f8\u5f53\u7684\u4ee3\u7801\uff0c\u4f46cscope\u9700\u8981\u4e8b\u5148\u751f\u6210\u4e00\u4e2a\u6570\u636e\u5e93\uff0c\u5bf9\u4e00\u4e9b\u7b80\u5355\u7684\u67e5\u627e\uff0c\u5176\u5b9e\uff0c\u6211\u4eec\u7528vim\u7684grep\u547d\u4ee4\u5c31\u53ef\u4ee5\u4e86\uff0c\u4e0d\u9700\u8981\u4e13\u95e8\u4e3a\u4e4b\u751f\u6210\u6570\u636e\u5e93\u3002vim\u7684grep\u547d\u4ee4\u548cshell\u7684\u51e0\u4e4e\u4e00\u6837\u3002</p> <p>\u6211\u4eec\u6765\u770b\u4e2a\u4f8b\u5b50\uff1a</p> <p>\u6bd4\u5982\u6211\u4eec\u6b63\u5728\u6d4f\u89c8nginx\u7684\u4ee3\u7801\uff0c\u8fd9\u65f6\uff0c\u6211\u60f3\u770b\u770b\u54ea\u91cc\u7528\u5230\u4e86nginx\u7684<code>NGX_HTTP_VAR_INDEXED</code>\u5b8f\u3002\u4e8e\u662f\uff0c\u6211\u53ef\u4ee5\u5728vim\u91cc\u8f93\u5165\u5982\u4e0b\u7684\u547d\u4ee4\uff1a</p> <p><code>:grep -r \u2013include=\u201d*.[ch]\u201d NGX_HTTP_VAR_INDEXED src/</code></p> <p>\u4e0a\u9762\u8fd9\u4e2a\u547d\u4ee4\u610f\u601d\u662f\u9012\u5f52\u67e5\u8be2src\u76ee\u5f55\u4e0b\u6240\u6709\u7684<code>.c</code>\u548c<code>.h</code>\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u62ec<code>NGX_HTTP_VAR_INDEXED</code>\u5b8f\u3002\u7136\u540e\uff0c\u4f60\u5c31\u4f1a\u770b\u5230vim\u5230shell\u91cc\u53bb\u6267\u884c\u5e76\u627e\u5230\u4e86\u76f8\u5173\u7684\u6587\u4ef6\uff0c\u6309\u56de\u8f66\u8fd4\u56devim\u540e\uff0c\u522b\u5fd8\u4e86\u7528<code>:cw</code>\u628agrep\u7684\u8f93\u51fa\u53d6\u56de\u6765\uff0c\u4e8e\u662f\u6211\u4eec\u5c31\u6709\u4e0b\u9762\u7684\u6837\u5b50\uff1a</p> <p>\u7136\u540e\u540c\u4e0a\u9762\u4e00\u6837\uff0c\u4f60\u53ef\u4ee5\u7528 j\uff0ck \u952e\u79fb\u52a8quickfix\u91cc\u7684\u5149\u6807\u5230\u76f8\u5e94\u7684\u884c\uff0c\u7136\u540e\u6309\u56de\u8f66\u5b9a\u4f4d\u6587\u4ef6\uff0c\u6216\u662f\u4f7f\u7528<code>:cn</code>\u6216<code>:cp</code>\u6765\u79fb\u52a8\u5230\u5b9a\u4f4d\u3002\uff08\u8fd9\u6837\uff0c\u4f60\u4f1a\u628a\u591a\u4e2a\u6587\u4ef6\u6253\u5f00\u5230\u7f13\u51b2\u533a\uff0c\u522b\u5fd8\u4e86<code>:ls</code>\u6765\u67e5\u770b\u7f13\u51b2\u533a\uff09</p> <p>\u4f60\u770b\uff0c\u5230\u8fd9\u91cc\uff0c\u4e00\u4e2a\u5c0f\u5c0f\u7684IDE\u5c31\u8fd9\u6837\u4ea7\u751f\u4e86\uff0c\u800c\u4e14\uff0c\u6700\u5e05\u7684\u65f6\uff0c\u6211\u4eec\u8fde\u4e00\u70b9\u63d2\u4ef6\u90fd\u6ca1\u6709\u88c5\uff0c\u4e5f\u6ca1\u6709\u5728<code>.vimrc</code>\u6587\u4ef6\u4e2d\u914d\u7f6e\u8fc7\u4ec0\u4e48\u3002</p>","tags":["vim"]},{"location":"programming/programming-with-vim/#_6","title":"\u5173\u952e\u5b57\u8865\u5168","text":"<p>\u6211\u4eec\u8fd8\u662f\u575a\u6301\u4e0d\u7528\u4efb\u4f55\u63d2\u4ef6\u3002\u6211\u4eec\u6765\u770b\u770b\u662f\u600e\u4e48\u4e2a\u81ea\u52a8\u8865\u5168\u7684\u3002</p> <p>\u5728insert\u6a21\u5f0f\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u6309\u5982\u4e0b\u5feb\u6377\u952e\uff1a</p> <p><code>Ctrl +N</code>  \u2013 \u5f53\u4f60\u6309\u4e0b\u8fd9\u5b83\u65f6\uff0c\u4f60\u4f1a\u53d1\u73b0Vim\u5c31\u5f00\u59cb\u641c\u7d22\u4f60\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u7684\u4ee3\u7801\uff0c\u641c\u7d22\u5b8c\u6210\u4e86\u5c31\u4f1a\u51fa\u73b0\u4e00\u4e2a\u4e0b\u62c9\u5217\u8868\uff08\u5c45\u7136\u662f\u7c89\u7d2b\u8272\u7684\uff0c\u771f\u662f\u4e11\u6b7b\u4e86\uff09</p> <p>\u4e0b\u56fe\u662f\u6211\u8f93\u5165\u4e86<code>ngx_http_</code>\u7136\u540e\u6309<code>ctrl+n</code>\u51fa\u73b0\u7684\u6837\u5b50\uff0c\u5b83\u5df2\u7ecf\u5e2e\u6211\u8865\u5168\u4e86\u4e00\u4e2a\uff0c\u4f46\u662f\u6211\u4e0d\u60f3\u8981\u8fd9\u4e2a\u3002\u7136\u540e\uff0c\u5728Vim\u7684\u4e0b\u65b9\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u72b6\u6001\u53d8\u6210\u4e86\u201c\u5173\u952e\u5b57\u8865\u5168\u201d\uff0c\u7136\u540e\u540e\u9762\u6709<code>^N^P</code>\u7684\u63d0\u793a\uff0c\u610f\u601d\u5c31\u662f\u544a\u8bc9\u4f60\u8fd8\u6709\u4e00\u4e2a<code>Ctrl+P</code>.</p> <p><code>Ctrl + P</code> \u2013 \u63a5\u4e0b\u6765\u4f60\u53ef\u4ee5\u6309\u8fd9\u4e2a\u952e\uff0c\u4e8e\u662f\u56de\u5230\u539f\u70b9\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u6309\u4e0a\u4e0b\u5149\u6807\u952e\u6765\u9009\u62e9\u76f8\u5e94\u7684Word\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u9762\u90a3\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u6309\u4e0b\u4e86Ctrl+P\u540e\u51fa\u73b0\u4e0b\u9762\u7684\u8fd9\u4e2a\u6837\u5b50\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5149\u6807\u56de\u5230\u4e86\u4e00\u5f00\u59cb\u6211\u8f93\u5165\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u5e72\u4e24\u4ef6\u4e8b\uff0c\u4e00\u4e2a\u662f\u7ee7\u7eed\u8f93\u5165\uff08\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u8fc7\u6ee4\u5173\u952e\u8bcd\uff09\uff0c\u53e6\u4e00\u4e2a\u662f\u7528\u201c\u5149\u6807\u952e\u201d\u4e0a\u79fb\u6216\u4e0b\u79fb\u6765\u9009\u62e9\u4e0b\u62c9\u5217\u8868\u4e2d\u7684\u5173\u952e\u5b57\uff0c\u9009\u597d\u540e\u56de\u8f66\uff0c\u5c31\u8865\u5168\u4e86\u3002 \u4e0e\u6b64\u7c7b\u4f3c\u7684\uff0c\u8fd8\u6709\u66f4\u591a\u7684\u8865\u9f50\uff0c\u90fd\u5728<code>Ctrl +X</code>\u4e0b\u9762\uff1a</p> <pre><code>Ctrl + X \u548c Ctrl + D \u5b8f\u5b9a\u4e49\u8865\u9f50\nCtrl + X \u548c Ctrl + ] \u662fTag \u8865\u9f50\nCtrl + X \u548c Ctrl + F \u662f\u6587\u4ef6\u540d \u8865\u9f50\nCtrl + X \u548c Ctrl + I \u4e5f\u662f\u5173\u952e\u8bcd\u8865\u9f50\uff0c\u4f46\u662f\u5173\u952e\u540e\u4f1a\u6709\u4e2a\u6587\u4ef6\u540d\uff0c\u544a\u8bc9\u4f60\u8fd9\u4e2a\u5173\u952e\u8bcd\u5728\u54ea\u4e2a\u6587\u4ef6\u4e2d\nCtrl + X \u548c Ctrl +V \u662f\u8868\u8fbe\u5f0f\u8865\u9f50\nCtrl + X \u548c Ctrl +L \u8fd9\u53ef\u4ee5\u5bf9\u6574\u4e2a\u884c\u8865\u9f50\uff0c\u53d8\u6001\u5427\u3002\n</code></pre>","tags":["vim"]},{"location":"programming/programming-with-vim/#_7","title":"\u5176\u5b83\u6280\u5de7","text":"","tags":["vim"]},{"location":"programming/programming-with-vim/#_8","title":"\u5b57\u7b26\u76f8\u5173","text":"<ul> <li> <p><code>guu</code> \u2013 \u628a\u4e00\u884c\u7684\u6587\u5b57\u53d8\u6210\u5168\u5c0f\u5199\u3002\u6216\u662f<code>Vu</code></p> </li> <li> <p><code>gUU</code> \u2013 \u628a\u4e00\u884c\u7684\u6587\u4ef6\u53d8\u6210\u5168\u5927\u5199\u3002\u6216\u662f<code>VU</code></p> </li> <li> <p>\u6309<code>v</code>\u952e\u8fdb\u5165\u9009\u62e9\u6a21\u5f0f\uff0c\u7136\u540e\u79fb\u52a8\u5149\u6807\u9009\u62e9\u4f60\u8981\u7684\u6587\u672c\uff0c\u6309<code>u</code>\u8f6c\u5c0f\u5199\uff0c\u6309<code>U</code>\u8f6c\u5927\u5199</p> </li> <li> <p><code>ga</code> \u2013  \u67e5\u770b\u5149\u6807\u5904\u5b57\u7b26\u7684ascii\u7801</p> </li> <li> <p><code>g8</code> \u2013 \u67e5\u770b\u5149\u6807\u5904\u5b57\u7b26\u7684utf-8\u7f16\u7801</p> </li> <li> <p><code>gf</code>  \u2013 \u6253\u5f00\u5149\u6807\u5904\u6240\u6307\u7684\u6587\u4ef6 \uff08\u8fd9\u4e2a\u547d\u4ee4\u5728\u6253\u5230#include\u5934\u6587\u4ef6\u65f6\u633a\u597d\u7528\u7684\uff0c\u5f53\u7136\uff0c\u4ec5\u9650\u4e8e\u6709\u8def\u5f84\u7684\uff09</p> </li> <li> <p><code>*</code>\u6216<code>#</code>\u5728\u5f53\u524d\u6587\u4ef6\u4e2d\u641c\u7d22\u5f53\u524d\u5149\u6807\u7684\u5355\u8bcd</p> </li> </ul>","tags":["vim"]},{"location":"programming/programming-with-vim/#_9","title":"\u7f29\u8fdb\u76f8\u5173","text":"<ul> <li> <p><code>&gt;&gt;</code> \u5411\u53f3\u7ed9\u5b83\u7f29\u8fdb\u5f53\u524d\u884c <code>&lt;&lt;</code>\u5411\u5de6\u7f29\u8fdb\u5f53\u524d\u884c</p> </li> <li> <p><code>=</code>  \u2013 \u7f29\u8fdb\u5f53\u524d\u884c \uff08\u548c\u4e0a\u9762\u4e0d\u4e00\u6837\u7684\u662f\uff0c\u5b83\u4f1a\u5bf9\u9f50\u7f29\u8fdb\uff09</p> </li> <li> <p><code>=%</code> \u2013 \u628a\u5149\u6807\u4f4d\u7f6e\u79fb\u5230\u8bed\u53e5\u5757\u7684\u62ec\u53f7\u4e0a\uff0c\u7136\u540e\u6309<code>=%</code>\uff0c\u7f29\u8fdb\u6574\u4e2a\u8bed\u53e5\u5757\uff08%\u662f\u62ec\u53f7\u5339\u914d\uff09</p> </li> <li> <p><code>G=gg</code> \u6216\u662f <code>gg=G</code>  \u2013 \u7f29\u8fdb\u6574\u4e2a\u6587\u4ef6\uff08G\u662f\u5230\u6587\u4ef6\u7ed3\u5c3e\uff0cgg\u662f\u5230\u6587\u4ef6\u5f00\u5934\uff09</p> </li> </ul>","tags":["vim"]},{"location":"programming/programming-with-vim/#_10","title":"\u590d\u5236\u7c98\u8d34\u76f8\u5173","text":"<ul> <li> <p>\u6309<code>v</code> \u952e\u8fdb\u5165\u9009\u62e9\u6a21\u5f0f\uff0c\u7136\u540e\u6309h,j,k,l\u79fb\u52a8\u5149\u6807\uff0c\u9009\u62e9\u6587\u672c\uff0c\u7136\u540e\u6309 <code>y</code> \u8fdb\u884c\u590d\u5236\uff0c\u6309 <code>p</code> \u8fdb\u884c\u7c98\u8d34\u3002</p> </li> <li> <p><code>dd</code>\u526a\u5207\u4e00\u884c\uff08\u524d\u9762\u52a0\u4e2a\u6570\u5b57\u53ef\u4ee5\u526a\u5207n\u884c\uff09\uff0c<code>p</code>\u7c98\u8d34</p> </li> <li> <p><code>yy</code>\u590d\u5236\u4e00\u884c\uff08\u524d\u9762\u52a0\u4e2a\u6570\u5b57\u53ef\u4ee5\u590d\u5236n\u884c\uff09\uff0c<code>p</code>\u7c98\u8d34</p> </li> </ul>","tags":["vim"]},{"location":"programming/programming-with-vim/#_11","title":"\u5149\u6807\u79fb\u52a8\u76f8\u5173","text":"<ul> <li> <p><code>Ctrl + O</code> \u5411\u540e\u56de\u9000\u4f60\u7684\u5149\u6807\u79fb\u52a8</p> </li> <li> <p><code>Ctrl + I</code>\u5411\u524d\u8ffd\u8d76\u4f60\u7684\u5149\u6807\u79fb\u52a8</p> </li> </ul> <p>\u8fd9\u4e24\u4e2a\u5feb\u6377\u952e\u5f88\u6709\u7528\uff0c\u53ef\u4ee5\u5728Tab\u9875\u548cWindows\u4e2d\u5411\u524d\u548c\u5411\u540etrace\u4f60\u7684\u5149\u6807\u952e\uff0c\u8fd9\u4e5f\u65b9\u4fbf\u4f60\u8df3\u8f6c\u5149\u6807\u3002</p>","tags":["vim"]},{"location":"programming/programming-with-vim/#shell","title":"\u8bfb\u53d6Shell\u547d\u4ee4\u76f8\u5173","text":"<ul> <li><code>:r!date</code> \u63d2\u5165\u65e5\u671f</li> </ul> <p>\u4e0a\u9762\u8fd9\u4e2a\u547d\u4ee4\uff0c<code>:r</code> \u662f<code>:read</code>\u7684\u7f29\u5199\uff0c<code>!</code>\u662f\u8868\u660e\u8981\u8fd0\u884c\u4e00\u4e2ashell\u547d\u4ee4\uff0c\u610f\u601d\u662f\u6211\u8981\u628ashell\u547d\u4ee4\u7684\u8f93\u51fa\u8bfb\u5230vim\u91cc\u6765\u3002</p>","tags":["vim"]},{"location":"programming/programming-with-vim/#vim_1","title":"vim\u7684\u7ec8\u7ea7\u63d2\u4ef6","text":"<p>CentOS\u4e0b\uff1a<code>yum erase emacs</code> Ubuntu\u4e0b\uff1a<code>apt-get remove emacs</code></p>","tags":["vim"]},{"location":"programming/pure-bash-bible/","title":"Pure Bash Bible","text":"<p>source</p>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#table-of-contents","title":"Table of Contents","text":"On this page<ul> <li>Pure Bash Bible</li> <li>Table of Contents</li> <li>FOREWORD</li> <li>STRINGS<ul> <li>Trim leading and trailing white-space from string</li> <li>Trim all white-space from string and truncate spaces</li> <li>Use regex on a string</li> <li>Split a string on a delimiter</li> <li>Change a string to lowercase</li> <li>Change a string to uppercase</li> <li>Reverse a string case</li> <li>Trim quotes from a string</li> <li>Strip all instances of pattern from string</li> <li>Strip first occurrence of pattern from string</li> <li>Strip pattern from start of string</li> <li>Strip pattern from end of string</li> <li>Percent-encode a string</li> <li>Decode a percent-encoded string</li> <li>Check if string contains a sub-string</li> <li>Check if string starts with sub-string</li> <li>Check if string ends with sub-string</li> </ul> </li> <li>ARRAYS<ul> <li>Reverse an array</li> <li>Remove duplicate array elements</li> <li>Random array element</li> <li>Cycle through an array</li> <li>Toggle between two values</li> </ul> </li> <li>LOOPS<ul> <li>Loop over a range of numbers</li> <li>Loop over a variable range of numbers</li> <li>Loop over an array</li> <li>Loop over an array with an index</li> <li>Loop over the contents of a file</li> <li>Loop over files and directories</li> </ul> </li> <li>FILE HANDLING<ul> <li>Read a file to a string</li> <li>Read a file to an array (by line)</li> <li>Get the first N lines of a file</li> <li>Get the last N lines of a file</li> <li>Get the number of lines in a file</li> <li>Count files or directories in directory</li> <li>Create an empty file</li> <li>Extract lines between two markers</li> </ul> </li> <li>FILE PATHS<ul> <li>Get the directory name of a file path</li> <li>Get the base-name of a file path</li> </ul> </li> <li>VARIABLES<ul> <li>Assign and access a variable using a variable</li> <li>Name a variable based on another variable</li> </ul> </li> <li>ESCAPE SEQUENCES<ul> <li>Text Colors</li> <li>Text Attributes</li> <li>Cursor Movement</li> <li>Erasing Text</li> </ul> </li> <li>PARAMETER EXPANSION<ul> <li>Indirection</li> <li>Replacement</li> <li>Length</li> <li>Expansion</li> <li>Case Modification</li> <li>Default Value</li> </ul> </li> <li>BRACE EXPANSION<ul> <li>Ranges</li> <li>String Lists</li> </ul> </li> <li>CONDITIONAL EXPRESSIONS<ul> <li>File Conditionals</li> <li>File Comparisons</li> <li>Variable Conditionals</li> <li>Variable Comparisons</li> </ul> </li> <li>ARITHMETIC OPERATORS<ul> <li>Assignment</li> <li>Arithmetic</li> <li>Bitwise</li> <li>Logical</li> <li>Miscellaneous</li> </ul> </li> <li>ARITHMETIC<ul> <li>Simpler syntax to set variables</li> <li>Ternary Tests</li> </ul> </li> <li>TRAPS<ul> <li>Do something on script exit</li> <li>Ignore terminal interrupt (CTRL+C, SIGINT)</li> <li>React to window resize</li> <li>Do something before every command</li> <li>Do something when a shell function or a sourced file finishes executing</li> </ul> </li> <li>PERFORMANCE<ul> <li>Disable Unicode</li> </ul> </li> <li>OBSOLETE SYNTAX<ul> <li>Shebang</li> <li>Command Substitution</li> <li>Function Declaration</li> </ul> </li> <li>INTERNAL VARIABLES<ul> <li>Get the location to the bash binary</li> <li>Get the version of the current running bash process</li> <li>Open the user's preferred text editor</li> <li>Get the name of the current function</li> <li>Get the host-name of the system</li> <li>Get the architecture of the Operating System</li> <li>Get the name of the Operating System / Kernel</li> <li>Get the current working directory</li> <li>Get the number of seconds the script has been running</li> <li>Get a pseudorandom integer</li> </ul> </li> <li>INFORMATION ABOUT THE TERMINAL<ul> <li>Get the terminal size in lines and columns (from a script)</li> <li>Get the terminal size in pixels</li> <li>Get the current cursor position</li> </ul> </li> <li>CONVERSION<ul> <li>Convert a hex color to RGB</li> <li>Convert an RGB color to hex</li> </ul> </li> <li>CODE GOLF<ul> <li>Shorter for loop syntax</li> <li>Shorter infinite loops</li> <li>Shorter function declaration</li> <li>Shorter if syntax</li> <li>Simpler case statement to set variable</li> </ul> </li> <li>OTHER<ul> <li>Use read as an alternative to the sleep command</li> <li>Check if a program is in the user's PATH</li> <li>Get the current date using strftime</li> <li>Get the username of the current user</li> <li>Generate a UUID V4</li> <li>Progress bars</li> <li>Get the list of functions in a script</li> <li>Bypass shell aliases</li> <li>Bypass shell functions</li> <li>Run a command in the background</li> </ul> </li> <li>AFTERWORD</li> </ul>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#foreword","title":"FOREWORD","text":"<p>A collection of pure <code>bash</code> alternatives to external processes and programs. The <code>bash</code> scripting language is more powerful than people realise and most tasks can be accomplished without depending on external programs.</p> <p>Calling an external process in <code>bash</code> is expensive and excessive use will cause a noticeable slowdown. Scripts and programs written using built-in methods (where applicable) will be faster, require fewer dependencies and afford a better understanding of the language itself.</p> <p>The contents of this book provide a reference for solving problems encountered when writing programs and scripts in <code>bash</code>. Examples are in function formats showcasing how to incorporate these solutions into code.</p>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#strings","title":"STRINGS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#trim-leading-and-trailing-white-space-from-string","title":"Trim leading and trailing white-space from string","text":"<p>This is an alternative to <code>sed</code>, <code>awk</code>, <code>perl</code> and other tools. The function below works by finding all leading and trailing white-space and removing it from the start and end of the string. The <code>:</code> built-in is used in place of a temporary variable.</p> <p>Example Function:</p> <pre><code>trim_string() {\n    # Usage: trim_string \"   example   string    \"\n    : \"${1#\"${1%%[![:space:]]*}\"}\"\n    : \"${_%\"${_##*[![:space:]]}\"}\"\n    printf '%s\\n' \"$_\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ trim_string \"    Hello,  World    \"\nHello,  World\n\n$ name=\"   John Black  \"\n$ trim_string \"$name\"\nJohn Black\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#trim-all-white-space-from-string-and-truncate-spaces","title":"Trim all white-space from string and truncate spaces","text":"<p>This is an alternative to <code>sed</code>, <code>awk</code>, <code>perl</code> and other tools. The function below works by abusing word splitting to create a new string without leading/trailing white-space and with truncated spaces.</p> <p>Example Function:</p> <pre><code># shellcheck disable=SC2086,SC2048\ntrim_all() {\n    # Usage: trim_all \"   example   string    \"\n    set -f\n    set -- $*\n    printf '%s\\n' \"$*\"\n    set +f\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ trim_all \"    Hello,    World    \"\nHello, World\n\n$ name=\"   John   Black  is     my    name.    \"\n$ trim_all \"$name\"\nJohn Black is my name.\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#use-regex-on-a-string","title":"Use regex on a string","text":"<p>The result of <code>bash</code>'s regex matching can be used to replace <code>sed</code> for a large number of use-cases.</p> <p>CAVEAT: This is one of the few platform dependent <code>bash</code> features. <code>bash</code> will use whatever regex engine is installed on the user's system. Stick to POSIX regex features if aiming for compatibility.</p> <p>CAVEAT: This example only prints the first matching group. When using multiple capture groups some modification is needed.</p> <p>Example Function:</p> <pre><code>regex() {\n    # Usage: regex \"string\" \"regex\"\n    [[ $1 =~ $2 ]] &amp;&amp; printf '%s\\n' \"${BASH_REMATCH[1]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ # Trim leading white-space.\n$ regex '    hello' '^\\s*(.*)'\nhello\n\n$ # Validate a hex color.\n$ regex \"#FFFFFF\" '^(#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3}))$'\n#FFFFFF\n\n$ # Validate a hex color (invalid).\n$ regex \"red\" '^(#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3}))$'\n# no output (invalid)\n</code></pre> <p>Example Usage in script:</p> <pre><code>is_hex_color() {\n    if [[ $1 =~ ^(#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3}))$ ]]; then\n        printf '%s\\n' \"${BASH_REMATCH[1]}\"\n    else\n        printf '%s\\n' \"error: $1 is an invalid color.\"\n        return 1\n    fi\n}\n\nread -r color\nis_hex_color \"$color\" || color=\"#FFFFFF\"\n\n# Do stuff.\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#split-a-string-on-a-delimiter","title":"Split a string on a delimiter","text":"<p>CAVEAT: Requires <code>bash</code> 4+</p> <p>This is an alternative to <code>cut</code>, <code>awk</code> and other tools.</p> <p>Example Function:</p> <pre><code>split() {\n   # Usage: split \"string\" \"delimiter\"\n   IFS=$'\\n' read -d \"\" -ra arr &lt;&lt;&lt; \"${1//$2/$'\\n'}\"\n   printf '%s\\n' \"${arr[@]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ split \"apples,oranges,pears,grapes\" \",\"\napples\noranges\npears\ngrapes\n\n$ split \"1, 2, 3, 4, 5\" \", \"\n1\n2\n3\n4\n5\n\n# Multi char delimiters work too!\n$ split \"hello---world---my---name---is---john\" \"---\"\nhello\nworld\nmy\nname\nis\njohn\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#change-a-string-to-lowercase","title":"Change a string to lowercase","text":"<p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>lower() {\n    # Usage: lower \"string\"\n    printf '%s\\n' \"${1,,}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ lower \"HELLO\"\nhello\n\n$ lower \"HeLlO\"\nhello\n\n$ lower \"hello\"\nhello\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#change-a-string-to-uppercase","title":"Change a string to uppercase","text":"<p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>upper() {\n    # Usage: upper \"string\"\n    printf '%s\\n' \"${1^^}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ upper \"hello\"\nHELLO\n\n$ upper \"HeLlO\"\nHELLO\n\n$ upper \"HELLO\"\nHELLO\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#reverse-a-string-case","title":"Reverse a string case","text":"<p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>reverse_case() {\n    # Usage: reverse_case \"string\"\n    printf '%s\\n' \"${1~~}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ reverse_case \"hello\"\nHELLO\n\n$ reverse_case \"HeLlO\"\nhElLo\n\n$ reverse_case \"HELLO\"\nhello\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#trim-quotes-from-a-string","title":"Trim quotes from a string","text":"<p>Example Function:</p> <pre><code>trim_quotes() {\n    # Usage: trim_quotes \"string\"\n    : \"${1//\\'}\"\n    printf '%s\\n' \"${_//\\\"}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ var=\"'Hello', \\\"World\\\"\"\n$ trim_quotes \"$var\"\nHello, World\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#strip-all-instances-of-pattern-from-string","title":"Strip all instances of pattern from string","text":"<p>Example Function:</p> <pre><code>strip_all() {\n    # Usage: strip_all \"string\" \"pattern\"\n    printf '%s\\n' \"${1//$2}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ strip_all \"The Quick Brown Fox\" \"[aeiou]\"\nTh Qck Brwn Fx\n\n$ strip_all \"The Quick Brown Fox\" \"[[:space:]]\"\nTheQuickBrownFox\n\n$ strip_all \"The Quick Brown Fox\" \"Quick \"\nThe Brown Fox\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#strip-first-occurrence-of-pattern-from-string","title":"Strip first occurrence of pattern from string","text":"<p>Example Function:</p> <pre><code>strip() {\n    # Usage: strip \"string\" \"pattern\"\n    printf '%s\\n' \"${1/$2}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ strip \"The Quick Brown Fox\" \"[aeiou]\"\nTh Quick Brown Fox\n\n$ strip \"The Quick Brown Fox\" \"[[:space:]]\"\nTheQuick Brown Fox\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#strip-pattern-from-start-of-string","title":"Strip pattern from start of string","text":"<p>Example Function:</p> <pre><code>lstrip() {\n    # Usage: lstrip \"string\" \"pattern\"\n    printf '%s\\n' \"${1##$2}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ lstrip \"The Quick Brown Fox\" \"The \"\nQuick Brown Fox\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#strip-pattern-from-end-of-string","title":"Strip pattern from end of string","text":"<p>Example Function:</p> <pre><code>rstrip() {\n    # Usage: rstrip \"string\" \"pattern\"\n    printf '%s\\n' \"${1%%$2}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ rstrip \"The Quick Brown Fox\" \" Fox\"\nThe Quick Brown\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#percent-encode-a-string","title":"Percent-encode a string","text":"<p>Example Function:</p> <pre><code>urlencode() {\n    # Usage: urlencode \"string\"\n    local LC_ALL=C\n    for (( i = 0; i &lt; ${#1}; i++ )); do\n        : \"${1:i:1}\"\n        case \"$_\" in\n            [a-zA-Z0-9.~_-])\n                printf '%s' \"$_\"\n            ;;\n\n            *)\n                printf '%%%02X' \"'$_\"\n            ;;\n        esac\n    done\n    printf '\\n'\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ urlencode \"https://github.com/dylanaraps/pure-bash-bible\"\nhttps%3A%2F%2Fgithub.com%2Fdylanaraps%2Fpure-bash-bible\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#decode-a-percent-encoded-string","title":"Decode a percent-encoded string","text":"<p>Example Function:</p> <pre><code>urldecode() {\n    # Usage: urldecode \"string\"\n    : \"${1//+/ }\"\n    printf '%b\\n' \"${_//%/\\\\x}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ urldecode \"https%3A%2F%2Fgithub.com%2Fdylanaraps%2Fpure-bash-bible\"\nhttps://github.com/dylanaraps/pure-bash-bible\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#check-if-string-contains-a-sub-string","title":"Check if string contains a sub-string","text":"<p>Using a test:</p> <pre><code>if [[ $var == *sub_string* ]]; then\n    printf '%s\\n' \"sub_string is in var.\"\nfi\n\n# Inverse (substring not in string).\nif [[ $var != *sub_string* ]]; then\n    printf '%s\\n' \"sub_string is not in var.\"\nfi\n\n# This works for arrays too!\nif [[ ${arr[*]} == *sub_string* ]]; then\n    printf '%s\\n' \"sub_string is in array.\"\nfi\n</code></pre> <p>Using a case statement:</p> <pre><code>case \"$var\" in\n    *sub_string*)\n        # Do stuff\n    ;;\n\n    *sub_string2*)\n        # Do more stuff\n    ;;\n\n    *)\n        # Else\n    ;;\nesac\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#check-if-string-starts-with-sub-string","title":"Check if string starts with sub-string","text":"<pre><code>if [[ $var == sub_string* ]]; then\n    printf '%s\\n' \"var starts with sub_string.\"\nfi\n\n# Inverse (var does not start with sub_string).\nif [[ $var != sub_string* ]]; then\n    printf '%s\\n' \"var does not start with sub_string.\"\nfi\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#check-if-string-ends-with-sub-string","title":"Check if string ends with sub-string","text":"<pre><code>if [[ $var == *sub_string ]]; then\n    printf '%s\\n' \"var ends with sub_string.\"\nfi\n\n# Inverse (var does not end with sub_string).\nif [[ $var != *sub_string ]]; then\n    printf '%s\\n' \"var does not end with sub_string.\"\nfi\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#arrays","title":"ARRAYS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#reverse-an-array","title":"Reverse an array","text":"<p>Enabling <code>extdebug</code> allows access to the <code>BASH_ARGV</code> array which stores the current function\u2019s arguments in reverse.</p> <p>CAVEAT: Requires <code>shopt -s compat44</code> in <code>bash</code> 5.0+.</p> <p>Example Function:</p> <pre><code>reverse_array() {\n    # Usage: reverse_array \"array\"\n    shopt -s extdebug\n    f()(printf '%s\\n' \"${BASH_ARGV[@]}\"); f \"$@\"\n    shopt -u extdebug\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ reverse_array 1 2 3 4 5\n5\n4\n3\n2\n1\n\n$ arr=(red blue green)\n$ reverse_array \"${arr[@]}\"\ngreen\nblue\nred\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#remove-duplicate-array-elements","title":"Remove duplicate array elements","text":"<p>Create a temporary associative array. When setting associative array values and a duplicate assignment occurs, bash overwrites the key. This allows us to effectively remove array duplicates.</p> <p>CAVEAT: Requires <code>bash</code> 4+</p> <p>CAVEAT: List order may not stay the same.</p> <p>Example Function:</p> <pre><code>remove_array_dups() {\n    # Usage: remove_array_dups \"array\"\n    declare -A tmp_array\n\n    for i in \"$@\"; do\n        [[ $i ]] &amp;&amp; IFS=\" \" tmp_array[\"${i:- }\"]=1\n    done\n\n    printf '%s\\n' \"${!tmp_array[@]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ remove_array_dups 1 1 2 2 3 3 3 3 3 4 4 4 4 4 5 5 5 5 5 5\n1\n2\n3\n4\n5\n\n$ arr=(red red green blue blue)\n$ remove_array_dups \"${arr[@]}\"\nred\ngreen\nblue\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#random-array-element","title":"Random array element","text":"<p>Example Function:</p> <pre><code>random_array_element() {\n    # Usage: random_array_element \"array\"\n    local arr=(\"$@\")\n    printf '%s\\n' \"${arr[RANDOM % $#]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ array=(red green blue yellow brown)\n$ random_array_element \"${array[@]}\"\nyellow\n\n# Multiple arguments can also be passed.\n$ random_array_element 1 2 3 4 5 6 7\n3\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#cycle-through-an-array","title":"Cycle through an array","text":"<p>Each time the <code>printf</code> is called, the next array element is printed. When the print hits the last array element it starts from the first element again.</p> <pre><code>arr=(a b c d)\n\ncycle() {\n    printf '%s ' \"${arr[${i:=0}]}\"\n    ((i=i&gt;=${#arr[@]}-1?0:++i))\n}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#toggle-between-two-values","title":"Toggle between two values","text":"<p>This works the same as above, this is just a different use case.</p> <pre><code>arr=(true false)\n\ncycle() {\n    printf '%s ' \"${arr[${i:=0}]}\"\n    ((i=i&gt;=${#arr[@]}-1?0:++i))\n}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loops","title":"LOOPS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-a-range-of-numbers","title":"Loop over a range of numbers","text":"<p>Alternative to <code>seq</code>.</p> <pre><code># Loop from 0-100 (no variable support).\nfor i in {0..100}; do\n    printf '%s\\n' \"$i\"\ndone\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-a-variable-range-of-numbers","title":"Loop over a variable range of numbers","text":"<p>Alternative to <code>seq</code>.</p> <pre><code># Loop from 0-VAR.\nVAR=50\nfor ((i=0;i&lt;=VAR;i++)); do\n    printf '%s\\n' \"$i\"\ndone\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-an-array","title":"Loop over an array","text":"<pre><code>arr=(apples oranges tomatoes)\n\n# Just elements.\nfor element in \"${arr[@]}\"; do\n    printf '%s\\n' \"$element\"\ndone\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-an-array-with-an-index","title":"Loop over an array with an index","text":"<pre><code>arr=(apples oranges tomatoes)\n\n# Elements and index.\nfor i in \"${!arr[@]}\"; do\n    printf '%s\\n' \"${arr[i]}\"\ndone\n\n# Alternative method.\nfor ((i=0;i&lt;${#arr[@]};i++)); do\n    printf '%s\\n' \"${arr[i]}\"\ndone\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-the-contents-of-a-file","title":"Loop over the contents of a file","text":"<pre><code>while read -r line; do\n    printf '%s\\n' \"$line\"\ndone &lt; \"file\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#loop-over-files-and-directories","title":"Loop over files and directories","text":"<p>Don\u2019t use <code>ls</code>.</p> <pre><code># Greedy example.\nfor file in *; do\n    printf '%s\\n' \"$file\"\ndone\n\n# PNG files in dir.\nfor file in ~/Pictures/*.png; do\n    printf '%s\\n' \"$file\"\ndone\n\n# Iterate over directories.\nfor dir in ~/Downloads/*/; do\n    printf '%s\\n' \"$dir\"\ndone\n\n# Brace Expansion.\nfor file in /path/to/parentdir/{file1,file2,subdir/file3}; do\n    printf '%s\\n' \"$file\"\ndone\n\n# Iterate recursively.\nshopt -s globstar\nfor file in ~/Pictures/**/*; do\n    printf '%s\\n' \"$file\"\ndone\nshopt -u globstar\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#file-handling","title":"FILE HANDLING","text":"<p>CAVEAT: <code>bash</code> does not handle binary data properly in versions <code>&lt; 4.4</code>.</p>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#read-a-file-to-a-string","title":"Read a file to a string","text":"<p>Alternative to the <code>cat</code> command.</p> <pre><code>file_data=\"$(&lt;\"file\")\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#read-a-file-to-an-array-by-line","title":"Read a file to an array (by line)","text":"<p>Alternative to the <code>cat</code> command.</p> <pre><code># Bash &lt;4 (discarding empty lines).\nIFS=$'\\n' read -d \"\" -ra file_data &lt; \"file\"\n\n# Bash &lt;4 (preserving empty lines).\nwhile read -r line; do\n    file_data+=(\"$line\")\ndone &lt; \"file\"\n\n# Bash 4+\nmapfile -t file_data &lt; \"file\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-first-n-lines-of-a-file","title":"Get the first N lines of a file","text":"<p>Alternative to the <code>head</code> command.</p> <p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>head() {\n    # Usage: head \"n\" \"file\"\n    mapfile -tn \"$1\" line &lt; \"$2\"\n    printf '%s\\n' \"${line[@]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ head 2 ~/.bashrc\n# Prompt\nPS1='\u279c '\n\n$ head 1 ~/.bashrc\n# Prompt\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-last-n-lines-of-a-file","title":"Get the last N lines of a file","text":"<p>Alternative to the <code>tail</code> command.</p> <p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>tail() {\n    # Usage: tail \"n\" \"file\"\n    mapfile -tn 0 line &lt; \"$2\"\n    printf '%s\\n' \"${line[@]: -$1}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ tail 2 ~/.bashrc\n# Enable tmux.\n# [[ -z \"$TMUX\"  ]] &amp;&amp; exec tmux\n\n$ tail 1 ~/.bashrc\n# [[ -z \"$TMUX\"  ]] &amp;&amp; exec tmux\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-number-of-lines-in-a-file","title":"Get the number of lines in a file","text":"<p>Alternative to <code>wc -l</code>.</p> <p>Example Function (bash 4):</p> <pre><code>lines() {\n    # Usage: lines \"file\"\n    mapfile -tn 0 lines &lt; \"$1\"\n    printf '%s\\n' \"${#lines[@]}\"\n}\n</code></pre> <p>Example Function (bash 3):</p> <p>This method uses less memory than the <code>mapfile</code> method and works in <code>bash</code> 3 but it is slower for bigger files.</p> <pre><code>lines_loop() {\n    # Usage: lines_loop \"file\"\n    count=0\n    while IFS= read -r _; do\n        ((count++))\n    done &lt; \"$1\"\n    printf '%s\\n' \"$count\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ lines ~/.bashrc\n48\n\n$ lines_loop ~/.bashrc\n48\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#count-files-or-directories-in-directory","title":"Count files or directories in directory","text":"<p>This works by passing the output of the glob to the function and then counting the number of arguments.</p> <p>Example Function:</p> <pre><code>count() {\n    # Usage: count /path/to/dir/*\n    #        count /path/to/dir/*/\n    printf '%s\\n' \"$#\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Count all files in dir.\n$ count ~/Downloads/*\n232\n\n# Count all dirs in dir.\n$ count ~/Downloads/*/\n45\n\n# Count all jpg files in dir.\n$ count ~/Pictures/*.jpg\n64\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#create-an-empty-file","title":"Create an empty file","text":"<p>Alternative to <code>touch</code>.</p> <pre><code># Shortest.\n&gt;file\n\n# Longer alternatives:\n:&gt;file\necho -n &gt;file\nprintf '' &gt;file\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#extract-lines-between-two-markers","title":"Extract lines between two markers","text":"<p>Example Function:</p> <pre><code>extract() {\n    # Usage: extract file \"opening marker\" \"closing marker\"\n    while IFS=$'\\n' read -r line; do\n        [[ $extract &amp;&amp; $line != \"$3\" ]] &amp;&amp;\n            printf '%s\\n' \"$line\"\n\n        [[ $line == \"$2\" ]] &amp;&amp; extract=1\n        [[ $line == \"$3\" ]] &amp;&amp; extract=\n    done &lt; \"$1\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Extract code blocks from MarkDown file.\n$ extract ~/projects/pure-bash/README.md '```sh' '```'\n# Output here...\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#file-paths","title":"FILE PATHS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-directory-name-of-a-file-path","title":"Get the directory name of a file path","text":"<p>Alternative to the <code>dirname</code> command.</p> <p>Example Function:</p> <pre><code>dirname() {\n    # Usage: dirname \"path\"\n    local tmp=${1:-.}\n\n    [[ $tmp != *[!/]* ]] &amp;&amp; {\n        printf '/\\n'\n        return\n    }\n\n    tmp=${tmp%%\"${tmp##*[!/]}\"}\n\n    [[ $tmp != */* ]] &amp;&amp; {\n        printf '.\\n'\n        return\n    }\n\n    tmp=${tmp%/*}\n    tmp=${tmp%%\"${tmp##*[!/]}\"}\n\n    printf '%s\\n' \"${tmp:-/}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ dirname ~/Pictures/Wallpapers/1.jpg\n/home/black/Pictures/Wallpapers\n\n$ dirname ~/Pictures/Downloads/\n/home/black/Pictures\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-base-name-of-a-file-path","title":"Get the base-name of a file path","text":"<p>Alternative to the <code>basename</code> command.</p> <p>Example Function:</p> <pre><code>basename() {\n    # Usage: basename \"path\" [\"suffix\"]\n    local tmp\n\n    tmp=${1%\"${1##*[!/]}\"}\n    tmp=${tmp##*/}\n    tmp=${tmp%\"${2/\"$tmp\"}\"}\n\n    printf '%s\\n' \"${tmp:-/}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ basename ~/Pictures/Wallpapers/1.jpg\n1.jpg\n\n$ basename ~/Pictures/Wallpapers/1.jpg .jpg\n1\n\n$ basename ~/Pictures/Downloads/\nDownloads\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#variables","title":"VARIABLES","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#assign-and-access-a-variable-using-a-variable","title":"Assign and access a variable using a variable","text":"<pre><code>$ hello_world=\"value\"\n\n# Create the variable name.\n$ var=\"world\"\n$ ref=\"hello_$var\"\n\n# Print the value of the variable name stored in 'hello_$var'.\n$ printf '%s\\n' \"${!ref}\"\nvalue\n</code></pre> <p>Alternatively, on <code>bash</code> 4.3+:</p> <pre><code>$ hello_world=\"value\"\n$ var=\"world\"\n\n# Declare a nameref.\n$ declare -n ref=hello_$var\n\n$ printf '%s\\n' \"$ref\"\nvalue\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#name-a-variable-based-on-another-variable","title":"Name a variable based on another variable","text":"<pre><code>$ var=\"world\"\n$ declare \"hello_$var=value\"\n$ printf '%s\\n' \"$hello_world\"\nvalue\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#escape-sequences","title":"ESCAPE SEQUENCES","text":"<p>Contrary to popular belief, there is no issue in utilizing raw escape sequences. Using <code>tput</code> abstracts the same ANSI sequences as if printed manually. Worse still, <code>tput</code> is not actually portable. There are a number of <code>tput</code> variants each with different commands and syntaxes (try <code>tput setaf 3</code> on a FreeBSD system). Raw sequences are fine.</p>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#text-colors","title":"Text Colors","text":"<p>NOTE: Sequences requiring RGB values only work in True-Color Terminal Emulators.</p> Sequence What does it do? Value <code>\\e[38;5;&lt;NUM&gt;m</code> Set text foreground color. <code>0-255</code> <code>\\e[48;5;&lt;NUM&gt;m</code> Set text background color. <code>0-255</code> <code>\\e[38;2;&lt;R&gt;;&lt;G&gt;;&lt;B&gt;m</code> Set text foreground color to RGB color. <code>R</code>, <code>G</code>, <code>B</code> <code>\\e[48;2;&lt;R&gt;;&lt;G&gt;;&lt;B&gt;m</code> Set text background color to RGB color. <code>R</code>, <code>G</code>, <code>B</code>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#text-attributes","title":"Text Attributes","text":"<p>NOTE: Prepend 2 to any code below to turn it's effect off (examples: 21=bold text off, 22=faint text off, 23=italic text off).</p> Sequence What does it do? <code>\\e[m</code> Reset text formatting and colors. <code>\\e[1m</code> Bold text. <code>\\e[2m</code> Faint text. <code>\\e[3m</code> Italic text. <code>\\e[4m</code> Underline text. <code>\\e[5m</code> Blinking text. <code>\\e[7m</code> Highlighted text. <code>\\e[8m</code> Hidden text. <code>\\e[9m</code> Strike-through text.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#cursor-movement","title":"Cursor Movement","text":"Sequence What does it do? Value <code>\\e[&lt;LINE&gt;;&lt;COLUMN&gt;H</code> Move cursor to absolute position. <code>line</code>, <code>column</code> <code>\\e[H</code> Move cursor to home position (<code>0,0</code>). <code>\\e[&lt;NUM&gt;A</code> Move cursor up N lines. <code>num</code> <code>\\e[&lt;NUM&gt;B</code> Move cursor down N lines. <code>num</code> <code>\\e[&lt;NUM&gt;C</code> Move cursor right N columns. <code>num</code> <code>\\e[&lt;NUM&gt;D</code> Move cursor left N columns. <code>num</code> <code>\\e[s</code> Save cursor position. <code>\\e[u</code> Restore cursor position.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#erasing-text","title":"Erasing Text","text":"Sequence What does it do? <code>\\e[K</code> Erase from cursor position to end of line. <code>\\e[1K</code> Erase from cursor position to start of line. <code>\\e[2K</code> Erase the entire current line. <code>\\e[J</code> Erase from the current line to the bottom of the screen. <code>\\e[1J</code> Erase from the current line to the top of the screen. <code>\\e[2J</code> Clear the screen. <code>\\e[2J\\e[H</code> Clear the screen and move cursor to <code>0,0</code>.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#parameter-expansion","title":"PARAMETER EXPANSION","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#indirection","title":"Indirection","text":"Parameter What does it do? <code>${!VAR}</code> Access a variable based on the value of <code>VAR</code>. <code>${!VAR*}</code> Expand to <code>IFS</code> separated list of variable names starting with <code>VAR</code>. <code>${!VAR@}</code> Expand to <code>IFS</code> separated list of variable names starting with <code>VAR</code>. If double-quoted, each variable name expands to a separate word.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#replacement","title":"Replacement","text":"Parameter What does it do? <code>${VAR#PATTERN}</code> Remove shortest match of pattern from start of string. <code>${VAR##PATTERN}</code> Remove longest match of pattern from start of string. <code>${VAR%PATTERN}</code> Remove shortest match of pattern from end of string. <code>${VAR%%PATTERN}</code> Remove longest match of pattern from end of string. <code>${VAR/PATTERN/REPLACE}</code> Replace first match with string. <code>${VAR//PATTERN/REPLACE}</code> Replace all matches with string. <code>${VAR/PATTERN}</code> Remove first match. <code>${VAR//PATTERN}</code> Remove all matches.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#length","title":"Length","text":"Parameter What does it do? <code>${#VAR}</code> Length of var in characters. <code>${#ARR[@]}</code> Length of array in elements.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#expansion","title":"Expansion","text":"Parameter What does it do? <code>${VAR:OFFSET}</code> Remove first <code>N</code> chars from variable. <code>${VAR:OFFSET:LENGTH}</code> Get substring from <code>N</code> character to <code>N</code> character.  (<code>${VAR:10:10}</code>: Get sub-string from char <code>10</code> to char <code>20</code>) <code>${VAR:: OFFSET}</code> Get first <code>N</code> chars from variable. <code>${VAR:: -OFFSET}</code> Remove last <code>N</code> chars from variable. <code>${VAR: -OFFSET}</code> Get last <code>N</code> chars from variable. <code>${VAR:OFFSET:-OFFSET}</code> Cut first <code>N</code> chars and last <code>N</code> chars.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#case-modification","title":"Case Modification","text":"Parameter What does it do? CAVEAT <code>${VAR^}</code> Uppercase first character. <code>bash 4+</code> <code>${VAR^^}</code> Uppercase all characters. <code>bash 4+</code> <code>${VAR,}</code> Lowercase first character. <code>bash 4+</code> <code>${VAR,,}</code> Lowercase all characters. <code>bash 4+</code> <code>${VAR~}</code> Reverse case of first character. <code>bash 4+</code> <code>${VAR~~}</code> Reverse case of all characters. <code>bash 4+</code>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#default-value","title":"Default Value","text":"Parameter What does it do? <code>${VAR:-STRING}</code> If <code>VAR</code> is empty or unset, use <code>STRING</code> as its value. <code>${VAR-STRING}</code> If <code>VAR</code> is unset, use <code>STRING</code> as its value. <code>${VAR:=STRING}</code> If <code>VAR</code> is empty or unset, set the value of <code>VAR</code> to <code>STRING</code>. <code>${VAR=STRING}</code> If <code>VAR</code> is unset, set the value of <code>VAR</code> to <code>STRING</code>. <code>${VAR:+STRING}</code> If <code>VAR</code> is not empty, use <code>STRING</code> as its value. <code>${VAR+STRING}</code> If <code>VAR</code> is set, use <code>STRING</code> as its value. <code>${VAR:?STRING}</code> Display an error if empty or unset. <code>${VAR?STRING}</code> Display an error if unset.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#brace-expansion","title":"BRACE EXPANSION","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#ranges","title":"Ranges","text":"<pre><code># Syntax: {&lt;START&gt;..&lt;END&gt;}\n\n# Print numbers 1-100.\necho {1..100}\n\n# Print range of floats.\necho 1.{1..9}\n\n# Print chars a-z.\necho {a..z}\necho {A..Z}\n\n# Nesting.\necho {A..Z}{0..9}\n\n# Print zero-padded numbers.\n# CAVEAT: bash 4+\necho {01..100}\n\n# Change increment amount.\n# Syntax: {&lt;START&gt;..&lt;END&gt;..&lt;INCREMENT&gt;}\n# CAVEAT: bash 4+\necho {1..10..2} # Increment by 2.\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#string-lists","title":"String Lists","text":"<pre><code>echo {apples,oranges,pears,grapes}\n\n# Example Usage:\n# Remove dirs Movies, Music and ISOS from ~/Downloads/.\nrm -rf ~/Downloads/{Movies,Music,ISOS}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#conditional-expressions","title":"CONDITIONAL EXPRESSIONS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#file-conditionals","title":"File Conditionals","text":"Expression Value What does it do? <code>-a</code> <code>file</code> If file exists. <code>-b</code> <code>file</code> If file exists and is a block special file. <code>-c</code> <code>file</code> If file exists and is a character special file. <code>-d</code> <code>file</code> If file exists and is a directory. <code>-e</code> <code>file</code> If file exists. <code>-f</code> <code>file</code> If file exists and is a regular file. <code>-g</code> <code>file</code> If file exists and its set-group-id bit is set. <code>-h</code> <code>file</code> If file exists and is a symbolic link. <code>-k</code> <code>file</code> If file exists and its sticky-bit is set <code>-p</code> <code>file</code> If file exists and is a named pipe (FIFO). <code>-r</code> <code>file</code> If file exists and is readable. <code>-s</code> <code>file</code> If file exists and its size is greater than zero. <code>-t</code> <code>fd</code> If file descriptor is open and refers to a terminal. <code>-u</code> <code>file</code> If file exists and its set-user-id bit is set. <code>-w</code> <code>file</code> If file exists and is writable. <code>-x</code> <code>file</code> If file exists and is executable. <code>-G</code> <code>file</code> If file exists and is owned by the effective group ID. <code>-L</code> <code>file</code> If file exists and is a symbolic link. <code>-N</code> <code>file</code> If file exists and has been modified since last read. <code>-O</code> <code>file</code> If file exists and is owned by the effective user ID. <code>-S</code> <code>file</code> If file exists and is a socket.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#file-comparisons","title":"File Comparisons","text":"Expression What does it do? <code>file -ef file2</code> If both files refer to the same inode and device numbers. <code>file -nt file2</code> If <code>file</code> is newer than <code>file2</code> (uses modification time) or <code>file</code> exists and <code>file2</code> does not. <code>file -ot file2</code> If <code>file</code> is older than <code>file2</code> (uses modification time) or <code>file2</code> exists and <code>file</code> does not.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#variable-conditionals","title":"Variable Conditionals","text":"Expression Value What does it do? <code>-o</code> <code>opt</code> If shell option is enabled. <code>-v</code> <code>var</code> If variable has a value assigned. <code>-R</code> <code>var</code> If variable is a name reference. <code>-z</code> <code>var</code> If the length of string is zero. <code>-n</code> <code>var</code> If the length of string is non-zero.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#variable-comparisons","title":"Variable Comparisons","text":"Expression What does it do? <code>var = var2</code> Equal to. <code>var == var2</code> Equal to (synonym for <code>=</code>). <code>var != var2</code> Not equal to. <code>var &lt; var2</code> Less than (in ASCII alphabetical order.) <code>var &gt; var2</code> Greater than (in ASCII alphabetical order.)","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#arithmetic-operators","title":"ARITHMETIC OPERATORS","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#assignment","title":"Assignment","text":"Operators What does it do? <code>=</code> Initialize or change the value of a variable.","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#arithmetic","title":"Arithmetic","text":"Operators What does it do? <code>+</code> Addition <code>-</code> Subtraction <code>*</code> Multiplication <code>/</code> Division <code>**</code> Exponentiation <code>%</code> Modulo <code>+=</code> Plus-Equal (Increment a variable.) <code>-=</code> Minus-Equal (Decrement a variable.) <code>*=</code> Times-Equal (Multiply a variable.) <code>/=</code> Slash-Equal (Divide a variable.) <code>%=</code> Mod-Equal (Remainder of dividing a variable.)","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#bitwise","title":"Bitwise","text":"Operators What does it do? <code>&lt;&lt;</code> Bitwise Left Shift <code>&lt;&lt;=</code> Left-Shift-Equal <code>&gt;&gt;</code> Bitwise Right Shift <code>&gt;&gt;=</code> Right-Shift-Equal <code>&amp;</code> Bitwise AND <code>&amp;=</code> Bitwise AND-Equal <code>\\|</code> Bitwise OR <code>\\|=</code> Bitwise OR-Equal <code>~</code> Bitwise NOT <code>^</code> Bitwise XOR <code>^=</code> Bitwise XOR-Equal","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#logical","title":"Logical","text":"Operators What does it do? <code>!</code> NOT <code>&amp;&amp;</code> AND <code>\\|\\|</code> OR","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#miscellaneous","title":"Miscellaneous","text":"Operators What does it do? Example <code>,</code> Comma Separator <code>((a=1,b=2,c=3))</code>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#arithmetic_1","title":"ARITHMETIC","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#simpler-syntax-to-set-variables","title":"Simpler syntax to set variables","text":"<pre><code># Simple math\n((var=1+2))\n\n# Decrement/Increment variable\n((var++))\n((var--))\n((var+=1))\n((var-=1))\n\n# Using variables\n((var=var2*arr[2]))\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#ternary-tests","title":"Ternary Tests","text":"<pre><code># Set the value of var to var2 if var2 is greater than var.\n# var: variable to set.\n# var2&gt;var: Condition to test.\n# ?var2: If the test succeeds.\n# :var: If the test fails.\n((var=var2&gt;var?var2:var))\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#traps","title":"TRAPS","text":"<p>Traps allow a script to execute code on various signals. In pxltrm (a pixel art editor written in bash)  traps are used to redraw the user interface on window resize. Another use case is cleaning up temporary files on script exit.</p> <p>Traps should be added near the start of scripts so any early errors are also caught.</p> <p>NOTE: For a full list of signals, see <code>trap -l</code>.</p>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#do-something-on-script-exit","title":"Do something on script exit","text":"<pre><code># Clear screen on script exit.\ntrap 'printf \\\\e[2J\\\\e[H\\\\e[m' EXIT\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#ignore-terminal-interrupt-ctrlc-sigint","title":"Ignore terminal interrupt (CTRL+C, SIGINT)","text":"<pre><code>trap '' INT\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#react-to-window-resize","title":"React to window resize","text":"<pre><code># Call a function on window resize.\ntrap 'code_here' SIGWINCH\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#do-something-before-every-command","title":"Do something before every command","text":"<pre><code>trap 'code_here' DEBUG\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#do-something-when-a-shell-function-or-a-sourced-file-finishes-executing","title":"Do something when a shell function or a sourced file finishes executing","text":"<pre><code>trap 'code_here' RETURN\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#performance","title":"PERFORMANCE","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#disable-unicode","title":"Disable Unicode","text":"<p>If unicode is not required, it can be disabled for a performance increase. Results may vary however there have been noticeable improvements in neofetch and other programs.</p> <pre><code># Disable unicode.\nLC_ALL=C\nLANG=C\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#obsolete-syntax","title":"OBSOLETE SYNTAX","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#shebang","title":"Shebang","text":"<p>Use <code>#!/usr/bin/env bash</code> instead of <code>#!/bin/bash</code>.</p> <ul> <li>The former searches the user's <code>PATH</code> to find the <code>bash</code> binary.</li> <li>The latter assumes it is always installed to <code>/bin/</code> which can cause issues.</li> </ul> <p>NOTE: There are times when one may have a good reason for using <code>#!/bin/bash</code> or another direct path to the binary.</p> <pre><code># Right:\n\n    #!/usr/bin/env bash\n\n# Less right:\n\n    #!/bin/bash\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#command-substitution","title":"Command Substitution","text":"<p>Use <code>$()</code> instead of <code>` `</code>.</p> <pre><code># Right.\nvar=\"$(command)\"\n\n# Wrong.\nvar=`command`\n\n# $() can easily be nested whereas `` cannot.\nvar=\"$(command \"$(command)\")\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#function-declaration","title":"Function Declaration","text":"<p>Do not use the <code>function</code> keyword, it reduces compatibility with older versions of <code>bash</code>.</p> <pre><code># Right.\ndo_something() {\n    # ...\n}\n\n# Wrong.\nfunction do_something() {\n    # ...\n}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#internal-variables","title":"INTERNAL VARIABLES","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-location-to-the-bash-binary","title":"Get the location to the <code>bash</code> binary","text":"<pre><code>\"$BASH\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-version-of-the-current-running-bash-process","title":"Get the version of the current running <code>bash</code> process","text":"<pre><code># As a string.\n\"$BASH_VERSION\"\n\n# As an array.\n\"${BASH_VERSINFO[@]}\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#open-the-users-preferred-text-editor","title":"Open the user's preferred text editor","text":"<pre><code>\"$EDITOR\" \"$file\"\n\n# NOTE: This variable may be empty, set a fallback value.\n\"${EDITOR:-vi}\" \"$file\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-name-of-the-current-function","title":"Get the name of the current function","text":"<pre><code># Current function.\n\"${FUNCNAME[0]}\"\n\n# Parent function.\n\"${FUNCNAME[1]}\"\n\n# So on and so forth.\n\"${FUNCNAME[2]}\"\n\"${FUNCNAME[3]}\"\n\n# All functions including parents.\n\"${FUNCNAME[@]}\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-host-name-of-the-system","title":"Get the host-name of the system","text":"<pre><code>\"$HOSTNAME\"\n\n# NOTE: This variable may be empty.\n# Optionally set a fallback to the hostname command.\n\"${HOSTNAME:-$(hostname)}\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-architecture-of-the-operating-system","title":"Get the architecture of the Operating System","text":"<pre><code>\"$HOSTTYPE\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-name-of-the-operating-system-kernel","title":"Get the name of the Operating System / Kernel","text":"<p>This can be used to add conditional support for different Operating Systems without needing to call <code>uname</code>.</p> <pre><code>\"$OSTYPE\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-current-working-directory","title":"Get the current working directory","text":"<p>This is an alternative to the <code>pwd</code> built-in.</p> <pre><code>\"$PWD\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-number-of-seconds-the-script-has-been-running","title":"Get the number of seconds the script has been running","text":"<pre><code>\"$SECONDS\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-a-pseudorandom-integer","title":"Get a pseudorandom integer","text":"<p>Each time <code>$RANDOM</code> is used, a different integer between <code>0</code> and <code>32767</code> is returned. This variable should not be used for anything related to security (this includes encryption keys etc).</p> <pre><code>\"$RANDOM\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#information-about-the-terminal","title":"INFORMATION ABOUT THE TERMINAL","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-terminal-size-in-lines-and-columns-from-a-script","title":"Get the terminal size in lines and columns (from a script)","text":"<p>This is handy when writing scripts in pure bash and <code>stty</code>/<code>tput</code> can\u2019t be called.</p> <p>Example Function:</p> <pre><code>get_term_size() {\n    # Usage: get_term_size\n\n    # (:;:) is a micro sleep to ensure the variables are\n    # exported immediately.\n    shopt -s checkwinsize; (:;:)\n    printf '%s\\n' \"$LINES $COLUMNS\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Output: LINES COLUMNS\n$ get_term_size\n15 55\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-terminal-size-in-pixels","title":"Get the terminal size in pixels","text":"<p>CAVEAT: This does not work in some terminal emulators.</p> <p>Example Function:</p> <pre><code>get_window_size() {\n    # Usage: get_window_size\n    printf '%b' \"${TMUX:+\\\\ePtmux;\\\\e}\\\\e[14t${TMUX:+\\\\e\\\\\\\\}\"\n    IFS=';t' read -d t -t 0.05 -sra term_size\n    printf '%s\\n' \"${term_size[1]}x${term_size[2]}\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Output: WIDTHxHEIGHT\n$ get_window_size\n1200x800\n\n# Output (fail):\n$ get_window_size\nx\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-current-cursor-position","title":"Get the current cursor position","text":"<p>This is useful when creating a TUI in pure bash.</p> <p>Example Function:</p> <pre><code>get_cursor_pos() {\n    # Usage: get_cursor_pos\n    IFS='[;' read -p $'\\e[6n' -d R -rs _ y x _\n    printf '%s\\n' \"$x $y\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Output: X Y\n$ get_cursor_pos\n1 8\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#conversion","title":"CONVERSION","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#convert-a-hex-color-to-rgb","title":"Convert a hex color to RGB","text":"<p>Example Function:</p> <pre><code>hex_to_rgb() {\n    # Usage: hex_to_rgb \"#FFFFFF\"\n    #        hex_to_rgb \"000000\"\n    : \"${1/\\#}\"\n    ((r=16#${_:0:2},g=16#${_:2:2},b=16#${_:4:2}))\n    printf '%s\\n' \"$r $g $b\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ hex_to_rgb \"#FFFFFF\"\n255 255 255\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#convert-an-rgb-color-to-hex","title":"Convert an RGB color to hex","text":"<p>Example Function:</p> <pre><code>rgb_to_hex() {\n    # Usage: rgb_to_hex \"r\" \"g\" \"b\"\n    printf '#%02x%02x%02x\\n' \"$1\" \"$2\" \"$3\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ rgb_to_hex \"255\" \"255\" \"255\"\n#FFFFFF\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#code-golf","title":"CODE GOLF","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#shorter-for-loop-syntax","title":"Shorter <code>for</code> loop syntax","text":"<pre><code># Tiny C Style.\nfor((;i++&lt;10;)){ echo \"$i\";}\n\n# Undocumented method.\nfor i in {1..10};{ echo \"$i\";}\n\n# Expansion.\nfor i in {1..10}; do echo \"$i\"; done\n\n# C Style.\nfor((i=0;i&lt;=10;i++)); do echo \"$i\"; done\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#shorter-infinite-loops","title":"Shorter infinite loops","text":"<pre><code># Normal method\nwhile :; do echo hi; done\n\n# Shorter\nfor((;;)){ echo hi;}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#shorter-function-declaration","title":"Shorter function declaration","text":"<pre><code># Normal method\nf(){ echo hi;}\n\n# Using a subshell\nf()(echo hi)\n\n# Using arithmetic\n# This can be used to assign integer values.\n# Example: f a=1\n#          f a++\nf()(($1))\n\n# Using tests, loops etc.\n# NOTE: \u2018while\u2019, \u2018until\u2019, \u2018case\u2019, \u2018(())\u2019, \u2018[[]]\u2019 can also be used.\nf()if true; then echo \"$1\"; fi\nf()for i in \"$@\"; do echo \"$i\"; done\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#shorter-if-syntax","title":"Shorter <code>if</code> syntax","text":"<pre><code># One line\n# Note: The 3rd statement may run when the 1st is true\n[[ $var == hello ]] &amp;&amp; echo hi || echo bye\n[[ $var == hello ]] &amp;&amp; { echo hi; echo there; } || echo bye\n\n# Multi line (no else, single statement)\n# Note: The exit status may not be the same as with an if statement\n[[ $var == hello ]] &amp;&amp;\n    echo hi\n\n# Multi line (no else)\n[[ $var == hello ]] &amp;&amp; {\n    echo hi\n    # ...\n}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#simpler-case-statement-to-set-variable","title":"Simpler <code>case</code> statement to set variable","text":"<p>The <code>:</code> built-in can be used to avoid repeating <code>variable=</code> in a case statement. The <code>$_</code> variable stores the last argument of the last command. <code>:</code> always succeeds so it can be used to store the variable value.</p> <pre><code># Modified snippet from Neofetch.\ncase \"$OSTYPE\" in\n    \"darwin\"*)\n        : \"MacOS\"\n    ;;\n\n    \"linux\"*)\n        : \"Linux\"\n    ;;\n\n    *\"bsd\"* | \"dragonfly\" | \"bitrig\")\n        : \"BSD\"\n    ;;\n\n    \"cygwin\" | \"msys\" | \"win32\")\n        : \"Windows\"\n    ;;\n\n    *)\n        printf '%s\\n' \"Unknown OS detected, aborting...\" &gt;&amp;2\n        exit 1\n    ;;\nesac\n\n# Finally, set the variable.\nos=\"$_\"\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#other","title":"OTHER","text":"","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#use-read-as-an-alternative-to-the-sleep-command","title":"Use <code>read</code> as an alternative to the <code>sleep</code> command","text":"<p>Surprisingly, <code>sleep</code> is an external command and not a <code>bash</code> built-in.</p> <p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>read_sleep() {\n    # Usage: read_sleep 1\n    #        read_sleep 0.2\n    read -rt \"$1\" &lt;&gt; &lt;(:) || :\n}\n</code></pre> <p>Example Usage:</p> <pre><code>read_sleep 1\nread_sleep 0.1\nread_sleep 30\n</code></pre> <p>For performance-critical situations, where it is not economic to open and close an excessive number of file descriptors, the allocation of a file descriptor may be done only once for all invocations of <code>read</code>:</p> <p>(See the generic original implementation at https://blog.dhampir.no/content/sleeping-without-a-subprocess-in-bash-and-how-to-sleep-forever)</p> <pre><code>exec {sleep_fd}&lt;&gt; &lt;(:)\nwhile some_quick_test; do\n    # equivalent of sleep 0.001\n    read -t 0.001 -u $sleep_fd\ndone\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#check-if-a-program-is-in-the-users-path","title":"Check if a program is in the user's PATH","text":"<pre><code># There are 3 ways to do this and either one can be used.\ntype -p executable_name &amp;&gt;/dev/null\nhash executable_name &amp;&gt;/dev/null\ncommand -v executable_name &amp;&gt;/dev/null\n\n# As a test.\nif type -p executable_name &amp;&gt;/dev/null; then\n    # Program is in PATH.\nfi\n\n# Inverse.\nif ! type -p executable_name &amp;&gt;/dev/null; then\n    # Program is not in PATH.\nfi\n\n# Example (Exit early if program is not installed).\nif ! type -p convert &amp;&gt;/dev/null; then\n    printf '%s\\n' \"error: convert is not installed, exiting...\"\n    exit 1\nfi\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-current-date-using-strftime","title":"Get the current date using <code>strftime</code>","text":"<p>Bash\u2019s <code>printf</code> has a built-in method of getting the date which can be used in place of the <code>date</code> command.</p> <p>CAVEAT: Requires <code>bash</code> 4+</p> <p>Example Function:</p> <pre><code>date() {\n    # Usage: date \"format\"\n    # See: 'man strftime' for format.\n    printf \"%($1)T\\\\n\" \"-1\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code># Using above function.\n$ date \"%a %d %b  - %l:%M %p\"\nFri 15 Jun  - 10:00 AM\n\n# Using printf directly.\n$ printf '%(%a %d %b  - %l:%M %p)T\\n' \"-1\"\nFri 15 Jun  - 10:00 AM\n\n# Assigning a variable using printf.\n$ printf -v date '%(%a %d %b  - %l:%M %p)T\\n' '-1'\n$ printf '%s\\n' \"$date\"\nFri 15 Jun  - 10:00 AM\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-username-of-the-current-user","title":"Get the username of the current user","text":"<p>CAVEAT: Requires <code>bash</code> 4.4+</p> <pre><code>$ : \\\\u\n# Expand the parameter as if it were a prompt string.\n$ printf '%s\\n' \"${_@P}\"\nblack\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#generate-a-uuid-v4","title":"Generate a UUID V4","text":"<p>CAVEAT: The generated value is not cryptographically secure.</p> <p>Example Function:</p> <pre><code>uuid() {\n    # Usage: uuid\n    C=\"89ab\"\n\n    for ((N=0;N&lt;16;++N)); do\n        B=\"$((RANDOM%256))\"\n\n        case \"$N\" in\n            6)  printf '4%x' \"$((B%16))\" ;;\n            8)  printf '%c%x' \"${C:$RANDOM%${#C}:1}\" \"$((B%16))\" ;;\n\n            3|5|7|9)\n                printf '%02x-' \"$B\"\n            ;;\n\n            *)\n                printf '%02x' \"$B\"\n            ;;\n        esac\n    done\n\n    printf '\\n'\n}\n</code></pre> <p>Example Usage:</p> <pre><code>$ uuid\nd5b6c731-1310-4c24-9fe3-55d556d44374\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#progress-bars","title":"Progress bars","text":"<p>This is a simple way of drawing progress bars without needing a for loop in the function itself.</p> <p>Example Function:</p> <pre><code>bar() {\n    # Usage: bar 1 10\n    #            ^----- Elapsed Percentage (0-100).\n    #               ^-- Total length in chars.\n    ((elapsed=$1*$2/100))\n\n    # Create the bar with spaces.\n    printf -v prog  \"%${elapsed}s\"\n    printf -v total \"%$(($2-elapsed))s\"\n\n    printf '%s\\r' \"[${prog// /-}${total}]\"\n}\n</code></pre> <p>Example Usage:</p> <pre><code>for ((i=0;i&lt;=100;i++)); do\n    # Pure bash micro sleeps (for the example).\n    (:;:) &amp;&amp; (:;:) &amp;&amp; (:;:) &amp;&amp; (:;:) &amp;&amp; (:;:)\n\n    # Print the bar.\n    bar \"$i\" \"10\"\ndone\n\nprintf '\\n'\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#get-the-list-of-functions-in-a-script","title":"Get the list of functions in a script","text":"<pre><code>get_functions() {\n    # Usage: get_functions\n    IFS=$'\\n' read -d \"\" -ra functions &lt; &lt;(declare -F)\n    printf '%s\\n' \"${functions[@]//declare -f }\"\n}\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#bypass-shell-aliases","title":"Bypass shell aliases","text":"<pre><code># alias\nls\n\n# command\n# shellcheck disable=SC1001\n\\ls\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#bypass-shell-functions","title":"Bypass shell functions","text":"<pre><code># function\nls\n\n# command\ncommand ls\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#run-a-command-in-the-background","title":"Run a command in the background","text":"<p>This will run the given command and keep it running, even after the terminal or SSH connection is terminated. All output is ignored.</p> <pre><code>bkr() {\n    (nohup \"$@\" &amp;&gt;/dev/null &amp;)\n}\n\nbkr ./some_script.sh # some_script.sh is now running in the background\n</code></pre>","tags":["bash","shell"]},{"location":"programming/pure-bash-bible/#afterword","title":"AFTERWORD","text":"<p>Thanks for reading! If this bible helped you in any way and you'd like to give back, consider donating. Donations give me the time to make this the best resource possible. Can't donate? That's OK, star the repo and share it with your friends!</p> <p></p> <p>Rock on. \ud83e\udd18</p>","tags":["bash","shell"]},{"location":"programming/understanding-awk/","title":"Understanding AWK","text":"","tags":["awk"]},{"location":"programming/understanding-awk/#understanding-awk","title":"Understanding AWK","text":"","tags":["awk"]},{"location":"programming/understanding-awk/#background","title":"Background","text":"<p>I have a confession to make: I don\u2019t know how to use Awk. Or at least I didn\u2019t know how to use it before I started writing this article. I would hear people mention Awk and how often they used it, and I was pretty certain I was missing out on some minor superpower.</p> <p>Like this little off hand comment by Bryan Cantrill:</p> <p>I write three or four Awk programs a day. And these are one-liners. These super quick programs.</p> <p>It turns out Awk is pretty simple. It has only a couple of conventions and only a small amount of syntax. As a result, it\u2019s straightforward to learn, and once you understand it, it will come in handy more often than you\u2019d think.</p> <p>So in this article, I will teach myself, and you, the basics of Awk. If you read through the article and maybe even try an example or two, you should have no problem writing Awk scripts by the end of it. And you probably don\u2019t even need to install anything because Awk is everywhere.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#the-plan","title":"The Plan","text":"<p>I will be using Awk to look at book reviews and pick my next book to read. I will start with short Awk one-liners and build towards a simple 33 line program that ranks books by the 19 million reviews on Amazon.com.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#what-is-awk","title":"What Is Awk","text":"<p>Awk is a record processing tool written by Aho, Kernighan, and Weinberger in 1977. Its name is an acronym of their names.</p> <p>They created it following the success of the line processing tools <code>sed</code> and <code>grep</code>. Awk was initially an experiment by the authors into whether text processing tools could be extended to deal with numbers. If grep lets you search for lines, and sed lets you do replacements in lines then awk was designed to let you do calculations on lines. It will be clear what that means once I take us through some examples.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#how-to-install-gawk","title":"How To Install <code>gawk</code>","text":"<p>The biggest reason to learn Awk is that it\u2019s on pretty much every single linux distribution. You might not have perl or Python. You will have Awk. Only the most minimal of minimal linux systems will exclude it. Even busybox includes awk. That\u2019s how essential it\u2019s viewed.</p> <p>cogman10</p> <p>Awk is part of the Portable Operating System Interface (POSIX). This means it\u2019s already on your MacBook and your Linux server. There are several versions of Awk, but for the basics, whatever Awk you have will do.</p> <p>If you can run this, you can do the rest of this tutorial:</p> <pre><code>&gt;_$ awk --version\n  GNU Awk 5.1.0, API: 3.0 (GNU MPFR 4.1.0, GNU MP 6.2.1)\n  Copyright (C) 1989, 1991-2020 Free Software Foundation.\n</code></pre> <p>If you are doing something more involved with Awk, take the time to install GNU Awk (<code>gawk</code>). I did this using Homebrew (<code>brew install gawk</code>). Windows users can get gawk using chocolatey (<code>choco install gawk</code>). If you are on Linux, you already have it.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-print","title":"Awk Print","text":"<p>By default, Awk expects to receive its input on standard in and output its results to standard out. Thus, the simplest thing you can do in Awk is print a line of input.</p> <pre><code>&gt;_$ echo \"one two three\" | awk '{ print }'\none two three\n</code></pre> <p>Note the braces. This syntax will start to make sense after you see a couple of examples.</p> <p>You can selectively choose columns (which Awk calls fields):</p> <pre><code>&gt;_$ echo \"one two three\" | awk '{ print $1 }'\none\n$ echo \"one two three\" | awk '{ print $2 }'\ntwo\n$ echo \"one two three\" | awk '{ print $3 }'\nthree\n</code></pre> <p>You may have been expecting the first column to be <code>$0</code> and not <code>$1</code>, but <code>$0</code> is something different:</p> <pre><code>&gt;_$ echo \"one two three\" | awk '{ print $0 }'\none two three\n</code></pre> <p>It is the entire line! Incidentally, Awk refers to each line as a record and each column as a field.</p> <p>I can do this across multiple lines:</p> <pre><code>&gt;_$ echo \"\n one two three\n four five six\" \\\n | awk '{ print $1 }'\none\nfour\n</code></pre> <p>And I can print more than one column:</p> <pre><code>&gt;_$ echo \"\n one two three\n four five six\" \\\n| awk '{ print $1, $2 }'\none two\nfour five\n</code></pre> <p>Awk also includes <code>$NF</code> for accessing the last column:</p> <pre><code>&gt;_$ echo \"\n one two three\n four five six\" \\\n| awk '{ print $NF }'\nthree\nsix\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awk-field-variables","title":"What I\u2019ve learned: Awk Field Variables","text":"<p>Awk creates a variable for each field (column) in a record (line) (<code>$1</code>, <code>$2</code> \u2026 <code>$NF</code>). <code>$0</code> refers to the whole record.</p> <p>You can print out fields like this:</p> <pre><code>&gt;_$ awk '{ print $1, $2, $7 }'\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-sample-data","title":"Awk Sample Data","text":"<p>To move beyond simple printing, I need some sample data. I will use the book portion of the amazon product reviews dataset for the rest of this tutorial.</p> <p>This dataset contains product reviews and metadata from Amazon, including 142.8 million reviews spanning May 1996 - July 2014.</p> <p>Amazon Review Data Set</p> <p>You can grab the book portion of it like this:</p> <pre><code>&gt;_$ curl https://s3.amazonaws.com/amazon-reviews-pds/tsv/ \u21a9\namazon_reviews_us_Books_v1_00.tsv.gz | /\n  gunzip -c &gt;&gt; / \n  bookreviews.tsv\n</code></pre> <p>If you want to follow along with the entire dataset, repeat this for each of the three book files (<code>v1_00</code>, <code>v1_01</code>, <code>v1_02</code>).</p>","tags":["awk"]},{"location":"programming/understanding-awk/#disk-space-warning","title":"\u2757 Disk Space Warning","text":"<p>The above file is over six gigs unzipped. If you grab all three, you will be up to fifteen gigs of disk space. If you don\u2019t have much space, you can play along by grabbing the first ten thousand rows of the first file:</p> <pre><code>&gt;_$ curl https://s3.amazonaws.com/amazon-reviews-pds/tsv/ \u21a9\namazon_reviews_us_Books_v1_00.tsv.gz \\\n  | gunzip -c \\\n  | head -n 10000 \\\n  &gt; bookreviews.tsv\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#the-book-data","title":"The Book Data","text":"<p>Once you\u2019ve grabbed that data, you should have Amazon book review data that looks like this:</p> <pre><code>marketplace customer_id review_id product_id product_parent product_title product_category star_rating helpful_votes total_votes vine verified_purchase review_headline review_body review_date\nUS 22480053 R28HBXXO1UEVJT 0843952016 34858117 The Rising Books 5 0 0 N N Great Twist on Zombie Mythos I've known about this one for a long time, but just finally got around to reading it for the first time. I enjoyed it a lot!  What I liked the most was how it took a tired premise and breathed new life into it by creating an entirely new twist on the zombie mythos. A definite must read! 2012-05-03\n</code></pre> <p>Each row in this file represents the record of one book review. Amazon lays out the fields like this:</p> <pre><code>Data FormatDATA COLUMNS:\n01  marketplace       - 2 letter country code of the marketplace where the \u21a9\n review was written.\n02  customer_id       - Random identifier that can be used to aggregate reviews\u21a9\n written by a single author.\n03  review_id         - The unique ID of the review.\n04  product_id        - The unique Product ID the review pertains to. \n05  product_parent    - Random identifier that can be used to aggregate \u21a9 \nreviews for the same product.\n06  product_title     - Title of the product.\n07  product_category  - Broad product category that can be used to group \u21a9\nreviews \n08  star_rating       - The 1-5 star rating of the review.\n09  helpful_votes     - Number of helpful votes.\n10  total_votes       - Number of total votes the review received.\n11  vine              - Review was written as part of the Vine program.\n12  verified_purchase - The review is on a verified purchase.\n13  review_headline   - The title of the review.\n14  review_body       - The review text.\n15  review_date       - The date the review was written.\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#printing-book-data","title":"Printing Book Data","text":"<p>I can now test out my field printing skills on a bigger file. I can start by printing fields that I care about, like the marketplace:</p> <pre><code>&gt;_$ awk '{ print $1 }' bookreviews.tsv | head \nmarketplace\nUS\nUS\nUS\nUS\nUS\nUS\nUS\nUS\nUS\n</code></pre> <p>Or the customer_id:</p> <pre><code>&gt;_$ awk '{ print $2 }' bookreviews.tsv | head \ncustomer_id\n22480053\n44244451\n20357422\n13235208\n26301786\n27780192\n13041546\n51692331\n23108524\n</code></pre> <p>However, when I try to print out the title, things do not go well:</p> <pre><code>&gt;_$ awk '{ print $6 }' bookreviews.tsv | head \nproduct_title\nThe\nSticky\nBlack\nDirection\nUntil\nUnfinished\nThe\nGood\nPatterns\n</code></pre> <p>To fix this, I need to configure my field separators.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#field-separators","title":"Field Separators","text":"<p>By default, Awk assumes that the fields in a record are whitespace delimited1. I can change the field separator to use tabs using the <code>awk -F</code> option:</p> <pre><code>&gt;_$ awk -F '\\t' '{ print $6 }' bookreviews.tsv | head \nproduct_title\nThe Rising\nSticky Faith Teen Curriculum with DVD: 10 Lessons to Nurture Faith Beyond High \nBlack Passenger Yellow Cabs: Of Exile And Excess In Japan\nDirection and Destiny in the Birth Chart\nUntil the Next Time\nUnfinished Business\nThe Republican Brain: The Science of Why They Deny Science- and Reality\nGood Food: 101 Cakes &amp; Bakes\nPatterns and Quilts (Mathzones)\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awk-field-separators","title":"What I\u2019ve learned: Awk Field Separators","text":"<p>Awk assumes that the fields in a record are whitespace delimited.</p> <p>You can change this using the <code>-F</code> option like this</p> <pre><code>&gt;_$ awk -F '\\t' '{ print $6 }'\n</code></pre> <p>I can also work backward from the last position forward by subtracting from <code>NF</code>.</p> <pre><code>&gt;_$ awk -F '\\t' '{ print $NF \"\\t\" $(NF-2)}' bookreviews.tsv | head \nreview_date     review_headline\n2012-05-03      Great Twist on Zombie Mythos\n2012-05-03      Helpful and Practical\n2012-05-03      Paul\n2012-05-03      Direction and Destiny in the Birth Chart\n2012-05-03      This was Okay\n2012-05-03      Excellent read!!!\n2012-05-03      A must read for science thinkers\n2012-05-03      Chocoholic heaven\n2012-05-03      Quilt Art Projects for Children\n</code></pre> <p>Side Note: NF and NR</p> <p><code>$NF</code> seems like an unusual name for printing the last column, right? But actually, <code>NF</code> is a variable holding the Number of Fields in a record. So I\u2019m just using its value as an index to refer to the last field.</p> <p>I can print the actual value like this:</p> <pre><code>&gt;_$ awk -F '\\t' '{ print NF }' bookreviews.tsv | head  \n15\n15\n15\n15\n15\n15\n15\n15\n15\n15\n</code></pre> <p>Another variable Awk offers up for use is <code>NR</code>, the number of records so far. <code>NR</code> is handy when I need to print line numbers:</p> <pre><code>&gt;_$ awk -F '\\t' '{ print NR \" \" $(NF-2) }' bookreviews.tsv | head  \n1 review_headline\n2 Great Twist on Zombie Mythos\n3 Helpful and Practical\n4 Paul\n5 Direction and Destiny in the Birth Chart\n6 This was Okay\n7 Excellent read!!!\n8 A must read for science thinkers\n9 Chocoholic heaven\n10 Quilt Art Projects for Children\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-pattern-match-with-regular-expressions","title":"Awk Pattern Match With Regular Expressions","text":"<p>Everything I\u2019ve done so far has applied to every line in our file, but the real power of Awk comes from pattern matching. And you can give Awk a pattern to match each line on like this:</p> <pre><code>&gt;_$ echo \"aa\n        bb\n        cc\" | awk '/bb/'\nbb\n</code></pre> <p>You could replace <code>grep</code> this way. You can also combine this with the field access and printing we\u2019ve done so far:</p> <pre><code>&gt;_$ echo \"aa 10\n        bb 20\n        cc 30\" | awk '/bb/ { print $2 }'\n20\n</code></pre> <p>Using this knowledge, I can easily grab reviews by book title and print the book title(<code>$6</code>) and review score(<code>$8</code>).</p> <p>The reviews I\u2019m going to focus on today are for the book \u2018The Hunger Games\u2019. I\u2019m choosing it because it\u2019s part of a series with many reviews and I recall liking the movie. So I\u2019m wondering if I should read it.</p> <pre><code>&gt;_$ awk -F '\\t' '/Hunger Games/ { print $6, $8  }' bookreviews.tsv | head\nThe Hunger Games (Book 1) 5\nThe Hunger Games Trilogy Boxed Set 5\nThe Hunger Games Trilogy: The Hunger Games / Catching Fire / Mockingjay 5\nCatching Fire |Hunger Games|2 4\nThe Hunger Games (Book 1) 5\nCatching Fire |Hunger Games|2 5\nThe Hunger Games Trilogy: The Hunger Games / Catching Fire / Mockingjay 5\nBlackout 3\nThe Hunger Games Trilogy: The Hunger Games / Catching Fire / Mockingjay 4\nTabula Rasa 3\n</code></pre> <p>I should be able to pull valuable data from these reviews, but first there is a problem. I\u2019m getting reviews from more than one book here. <code>/Hunger Games/</code>matches anywhere in the line and I\u2019m getting all kinds of \u2018Hunger Games\u2019 books returned. I\u2019m even getting books that mention \u201cHunger Games\u201d in the review text:</p> <pre><code>&gt;_$ awk -F '\\t' '/Hunger Games/ { print $6 }' bookreviews.tsv | sort | uniq    \nBirthmarked\nBlood Red Road\nCatching Fire (The Hunger Games)\nDivergent\nEnclave\nFire (Graceling Realm Books)\nFuturetrack 5\nGirl in the Arena\n...\n</code></pre> <p>I can fix this by using the <code>product_id</code> field to pattern match on:</p> <pre><code>&gt;_$ awk -F '\\t' '$4 == \"0439023483\" { print $6 }' bookreviews.tsv | sort |  uniq \nThe Hunger Games (The Hunger Games, Book 1)\n</code></pre> <p>I want to calculate the average review score for \u2018The Hunger Games\u2019, but first, let\u2019s take a look at the review_date (<code>$15</code>), the review_headline (<code>$13</code>), and the star_rating (<code>$8</code>) of our Hunger Games reviews, to get a feel for the data:</p> <pre><code>&gt;_$ awk -F '\\t' '$4 == \"0439023483\" { print $15 \"\\t\" $13 \"\\t\" $8}' \\\n    bookreviews.tsv | head \n2015-08-19      Five Stars      5\n2015-08-17      Five Stars      5\n2015-07-23      Great read      5\n2015-07-05      Awesome 5\n2015-06-28      Epic start to an epic series    5\n2015-06-21      Five Stars      5\n2015-04-19      Five Stars      5\n2015-04-12      i lile the book 3\n2015-03-28      What a Great Read, i could not out it down   5\n2015-03-28      Five Stars      5\n</code></pre> <p>Look at those star ratings. Yes, the book is getting many 5-star reviews, but more importantly, the layout of my text table looks horrible: the width of the review titles is breaking the layout.</p> <p>To fix this, I need to switch from using <code>print</code> to using <code>printf</code>.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awk-pattern-matching","title":"What I\u2019ve learned: Awk Pattern Matching","text":"<p>I\u2019ve learned that an awk action, like <code>{ print $4}</code>, can be preceded by a pattern, like <code>/regex/</code>. Without the pattern, the action runs on all lines.</p> <p>You can use a simple regular expression for the pattern. In which case it matches anywhere in the line, like <code>grep</code>:</p> <pre><code>&gt;_$ awk '/hello/ { print \"This line contains hello\", $0}'\n</code></pre> <p>Or you can match within a specific field:</p> <pre><code>&gt;_$ awk '$4~/hello/ { print \"This field contains hello\", $4}'\n</code></pre> <p>Or you can exact match a field:</p> <pre><code>&gt;_$ awk '$4 == \"hello\" { print \"This field is hello:\", $4}'\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-printf","title":"Awk <code>printf</code>","text":"<p><code>printf</code> works like it does in the C and uses a format string and a list of values. You can use <code>%s</code> to print the next string value.</p> <p>So my <code>print $15 \"\\t\" $13 \"\\t\" $8</code> becomes <code>printf \"%s \\t %s \\t %s\", $15, $13, $8</code>.</p> <p>From there I can add right padding and fix my layout by changing <code>%s</code> to <code>%-Ns</code>where <code>N</code> is my desired column width:</p> <pre><code>&gt;_$ awk -F '\\t' \\\n   '$4 == \"0439023483\" { printf \"%s \\t %-20s \\t %s \\n\", $15, $13, $8}'  \\\n   bookreviews.tsv | head \n2015-08-19       Five Stars              5 \n2015-08-17       Five Stars              5 \n2015-07-23       Great read              5 \n2015-07-05       Awesome                 5 \n2015-06-28       Epic start to an epic series    5 \n2015-06-21       Five Stars              5 \n2015-04-19       Five Stars              5 \n2015-04-12       i lile the book         3 \n2015-03-28       What a Great Read, i could not out it down   5 \n2015-03-28       Five Stars              5 \n</code></pre> <p>This table is pretty close to what I\u2019d want. However, some of the titles are just too long. I can shorten them to 20 characters with <code>substr($13,1,20)</code>.</p> <p>Putting it all together and I get:</p> <pre><code>&gt;_$ awk -F '\\t' \\\n '$4 == \"0439023483\" { \n    printf \"%s \\t %-20s \\t %s \\n\",$15,substr($13,1,20),$8\n  }' \\\n bookreviews.tsv | head\n2015-08-19       Five Stars              5 \n2015-08-17       Five Stars              5 \n2015-07-23       Great read              5 \n2015-07-05       Awesome                 5 \n2015-06-28       Epic start to an epi    5 \n2015-06-21       Five Stars              5 \n2015-04-19       Five Stars              5 \n2015-04-12       i lile the book         3 \n2015-03-28       What a Great Read, i    5 \n2015-03-28       Five Stars              5 \n</code></pre> <p>Alright, I think at this point, I\u2019m ready to move on to star calculations.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-printf-and-built-ins","title":"What I\u2019ve Learned: <code>printf</code> and Built-ins","text":"<p>If you need to print out a table, Awk lets you use <code>printf</code> and built-ins like <code>substr</code> to format your output.</p> <p>It ends up looking something like this:</p> <pre><code>&gt;_$ awk '{ printf \"%s \\t %-5s\", $1, substr($2,1,5) }'\n</code></pre> <p><code>printf</code> works much like C\u2019s <code>printf</code>. You can use <code>%s</code> to insert a string into the format string, and other flags let you the set width or precision. For more information on <code>printf</code> or other built-ins, you can consult an Awk reference document.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-begin-and-end-actions","title":"Awk <code>BEGIN</code> and <code>END</code> Actions","text":"<p>I want to calculate the average rating for book reviews in this data set. To do that, I need to use a variable. However, I don\u2019t need to declare the variable or its type. I can just use it:</p> <p>I can add up and print out a running total of review_stars (<code>$8</code>) like this:</p> <pre><code>&gt;_$ awk -F '\\t' '{ total = total + $8; print total }' bookreviews.tsv | head \n0\n5\n10\n...\n</code></pre> <p>And to turn this into an average, I can use <code>NR</code> to get the total amount of records and <code>END</code> to run an action at the end of the processing.</p> <pre><code>&gt;_$ awk -F '\\t' '\n    { total = total + $8 }\nEND { print \"Average book review:\", total/NR, \"stars\" }\n' bookreviews.tsv | head \nAverage book review is 4.24361 stars\n</code></pre> <p>I can also use <code>BEGIN</code> to run an action before Awk starts processing records.</p> <pre><code>&gt;_ $ awk -F '\\t' '\nBEGIN { print \"Calculating Average ...\" } \n      { total = total + $8 }\nEND   { print \"Average book review:\", total/NR, \"stars\" }\n' bookreviews.tsv \nCalculating Average ...\nAverage book review is 4.24361 stars\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awks-begin-end-and-variables","title":"What I\u2019ve learned: Awk\u2019s <code>BEGIN</code>, <code>END</code> and Variables","text":"<p>Awk provides two special patterns, <code>BEGIN</code> and <code>END</code>. You can use them to run actions before and after processing the records. For example, this is how you would initialize data, print headers and footer, or do any start-up or tear-down stuff in Awk.</p> <p>It ends up looking like this:</p> <pre><code>&gt;_$ awk '\nBEGIN { print \"start up\" }\n      { print \"line match\" }\nEND   { print \"tear down\" }'\n</code></pre> <p>You can also easily use variables in Awk. No declaration is needed.</p> <pre><code>&gt;_$ awk -F '{ total = total + $8 }'\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#fun-awk-one-liners","title":"Fun Awk One-Liners","text":"<p>Before we leave the world of one-liners behind, I reached out to my friends to ask when they use Awk day-to-day. Here are some of the examples I got back.</p> <p>Printing files with a human readable size:</p> <pre><code>&gt;_$ ls -lh | awk '{ print $5,\"\\t\", $9 }'  \n7.8M     The_AWK_Programming_Language.pdf\n6.2G     bookreviews.tsv\n</code></pre> <p>Getting the containerID of running docker containers:</p> <pre><code>&gt;_$ docker ps -a |  awk '{ print $1 }'\nCONTAINER\n08488f220f76\n3b7fc673649f\n</code></pre> <p>You can combine that last one with a regex to focus on a line you care about. Here I stop <code>postgres</code>, regardless of its tag name:</p> <pre><code>&gt;_$ docker stop \"$(docker ps -a |  awk '/postgres/{ print $1 }')\"\n</code></pre> <p>You get the idea. If you have a table of space-delimited text returned by some tool then Awk can easily slice and dice it.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-scripting-examples","title":"Awk Scripting Examples","text":"<p>If you pick your constraints you can make a particular envelope of uses easy and ones you don\u2019t care about hard. Awk\u2019s choice to be a per line processor, with optional sections for processing before all lines and after all lines is self-limiting but it defines a useful envelope of use.</p> <p>Michael Feathers</p> <p>In my mind, once an Awk program spans multiple lines, it\u2019s time to consider putting it into a file.</p> <p>Side Note: Why Awk Scripting</p> <p>Once we move beyond one-liners, a natural question is why. As in \u2018Why not use Python? Isn\u2019t it good at this type of thing?\u2019</p> <p>I have a couple of answers for that.</p> <p>First, Awk is great for writing programs that are, at their core, a glorified for loop over some input. If that is what you are doing, and the control flow is limited, using Awk will be more concise than Python.</p> <p>Second, if you need to rewrite your Awk program into Python at some point, so be it. It\u2019s not going to be more than 100 lines of code, and the translation process will be straightforward.</p> <p>Third, why not? Learning a new tool can be fun.</p> <p>We\u2019ve now crossed over from one-liners into Awk scripting. With Awk, the transition is smooth. I can now embed Awk into a bash script:</p> <pre><code>&gt;_$ cat average\nexec awk -F '\\t' '\n    { total = total + $8 }\nEND { print \"Average book review is\", total/NR, \"stars\" } \n' $1\n&gt;_$ average bookreviews.tsv\nAverage book review is 4.2862 stars\n</code></pre> <p>Or I can use a shebang (<code>#!</code>):</p> <pre><code>average.awk#!/usr/bin/env -S gawk -f\n\nBEGIN { FS = \"\\t\" }\n{ total = total + $8 }\nEND { print \"Average book $6 review is\", total/NR, \"stars\" } \n</code></pre> <p>And run it like this</p> <pre><code>&gt;_$ ./average.awk bookreviews.tsv\n</code></pre> <p>Or you can also pass it to awk directly using <code>-f</code>:</p> <pre><code>&gt;_$ awk -f average.awk bookreviews.tsv\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#side-note-begin-fs","title":"Side Note: BEGIN FS","text":"<p>If you use a shebang or pass to Awk directly, it\u2019s easiest to set the file separator using <code>FS = \"\\t\"</code> in the <code>BEGIN</code> action.</p> <pre><code>&gt;_BEGIN { FS = \"\\t\" }\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-average-example","title":"Awk Average Example","text":"<p>At this point, I should be ready to start calculating review scores for The Hunger Games:</p> <pre><code>exec awk -F '\\t' '\n$4 == \"0439023483\" { title=$6; count = count + 1; total = total + $8 }\nEND { \n      print \"The Average book review for\", title, \"is\", total/count, \"stars\" \n    }  \n' $1\n</code></pre> <p>Now that I\u2019m in a file, I can format this out a bit better so its easier to read:</p> <pre><code>average.awk$4 == \"0439023483\" { \n  title=$6\n  count = count + 1; \n  total = total + $8 \n}\nEND { \n  printf \"Book: %-5s\\n\", title\n  printf \"Average Rating: %.2f\\n\", total/count \n}  \n</code></pre> <p>Either way, I get this output:</p> <pre><code>Book: The Hunger Games (The Hunger Games, Book 1)\nAverage Rating: 4.67%       \n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-calling-awk-from-a-file","title":"What I\u2019ve learned: Calling Awk From a File","text":"<p>Once you are beyond a single line, it makes sense to put your Awk script into a file.</p> <p>You can then call you program using the <code>-f</code>option</p> <pre><code>&gt;_$ awk -f file.awk input\n</code></pre> <p>Using a shebang :</p> <pre><code>&gt;_#!/usr/bin/env -S gawk -f\n</code></pre> <p>or by using a bash <code>exec</code> command:</p> <pre><code>&gt;_exec awk -F '\\t' 'print $0' $1\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-arrays","title":"Awk Arrays","text":"<p>I\u2019d like to know if the series stays strong or if it\u2019s a single great book that the author stretched out into a trilogy. If the reviews decline quickly, then that is not a good sign. I should be able to see which book was rated the best and which was the worst. Let\u2019s find out.</p> <p>If I were going to calculate the averages in Python, I would loop over the list of reviews and use a dictionary to track the total stars and total reviews for each.</p> <p>In Awk I can do the same:</p> <pre><code>hungergames.awkBEGIN { FS = \"\\t\" }\n$6~/\\(The Hunger Games(, Book 1)?\\)$/ { \n  title[$6]=$6\n  count[$6]= count[$6] + 1\n  total[$6]= total[$6] + $8\n}\nEND { \n    for (i in count) {\n        printf \"---------------------------------------\\n\"\n        printf \"%s\\n\", title[i]\n        printf \"---------------------------------------\\n\"\n        printf \"Ave: %.2f\\t Count: %s \\n\\n\", total[i]/count[i], count[i]  \n    }\n}\n</code></pre> <p>Running:</p> <pre><code>&gt;_$ awk -f hungergames.awk bookreviews.tsv\n---------------------------------------\nThe Hunger Games (The Hunger Games, Book 1)\n---------------------------------------\nAve: 4.55        Count: 1497 \n\n---------------------------------------\nMockingjay (The Hunger Games)\n---------------------------------------\nAve: 3.77        Count: 3801 \n\n---------------------------------------\nCatching Fire (The Hunger Games)\n---------------------------------------\nAve: 4.52        Count: 2205 \n\n---------------------------------------\n</code></pre> <p>And look at that, the first book in the series was the most popular. And the last book, Mockingjay was much less popular. So that isn\u2019t a good sign.</p> <p>Let me look at another trilogy to see if this gradual decrease in rankings is common or The Hunger Games specific:</p> <pre><code>hungergames.awkBEGIN { FS = \"\\t\" }\n$6~/\\(The Lord of the Rings, Book .\\)$/ {  # &lt;-- changed this line\n  title[$6]=$6\n  count[$6]= count[$6] + 1\n  total[$6]= total[$6] + $8\n}\nEND { \n    for (i in title) {\n        printf \"---------------------------------------\\n\"\n        printf \"%s\\n\", title[i]\n        printf \"---------------------------------------\\n\"\n        printf \"Ave: %.2f\\t Count: %s \\n\\n\", total[i]/count[i], count[i]  \n    }\n}\n</code></pre> <p>Which results in:</p> <pre><code>---------------------------------------\nThe Return of the King (The Lord of the Rings, Book 3)\n---------------------------------------\nAve: 4.79        Count: 38 \n\n---------------------------------------\nThe Two Towers (The Lord of the Rings, Book 2)\n---------------------------------------\nAve: 4.64        Count: 56 \n\n---------------------------------------\nThe Fellowship of the Ring (The Lord of the Rings, Book 1)\n---------------------------------------\nAve: 4.60        Count: 93  \n</code></pre> <p>Lord of the Rings has a different pattern. The books are all in a pretty tight range. The number of reviews is also much smaller, so it\u2019s hard to say for sure that \u201cThe Return Of the King\u201d is the best book, but it certainly looks that way.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awk-associative-arrays","title":"What I\u2019ve learned: Awk Associative Arrays","text":"<p>Awk has associative arrays built it, and you can use them in much the same way you would use Python dictionaries.</p> <pre><code>arr[\"key1\"] = \"one\"\narr[\"key2\"] = \"two\"\narr[\"key3\"] = \"three\"\n</code></pre> <p>You can then use a for loop to iterate over them:</p> <pre><code>for (i in arr){\n    print i, arr[i]\n}\nkey1 one\nkey2 two\nkey3 three\n</code></pre> <p>Not bad for a language written in 1977!</p>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-if-else","title":"Awk <code>If</code> <code>Else</code>","text":"<p>I hate how every book on Amazon has a star rating between 3.0 and 4.5 stars. It makes it hard to judge purely based on numbers. So let\u2019s rescale things in terms of the average. Maybe if I normalize the reviews, it will be easier to determine how good or bad the 3.77 average for Mockingjay is.</p> <p>First, I need to calculate the global average but adding up the total and average for every row:</p> <pre><code>hungergames.awk{\n    # Global Average\n    g_count = g_count + 1\n    g_total = g_total + $8 \n}\n</code></pre> <p>Then I calculate the global average:</p> <pre><code>hungergames.awEND { \n    g_score = g_total/g_count \n    ...\n}    \n</code></pre> <p>Once I have this, I can score books based on how higher or lower they are than the average. All I need to do is add some if statements to my <code>END</code> pattern to accomplish this:</p> <pre><code>hungergames.awkEND { \n    g_score = g_total/g_count \n    for (i in count) {\n        score = total[i]/count[i]\n        printf \"%-30s\\t\", substr(title[i],1,30)\n        if (score - g_score &gt; .5)\n            printf \"\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; .25)\n            printf \"\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; 0)\n            printf \"\ud83d\udc4d\" \n        else if (g_score - score  &gt; 1)\n            printf \"\ud83d\udc4e\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; .5)\n            printf \"\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; 0)\n            printf \"\ud83d\udc4e\"\n        printf \"\\n\"\n    }\n}\n</code></pre> <p>The values for partitioning are just a guess, but it makes it easier for me to understand the rankings:</p> <pre><code>The Hunger Games (The Hunger G  \ud83d\udc4d\nCatching Fire: The Official Il  \ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\nMockingjay (The Hunger Games)   \ud83d\udc4e\ud83d\udc4e\n\nThe Two Towers (The Lord of th  \ud83d\udc4d\ud83d\udc4d\nThe Fellowship of the Ring (Th  \ud83d\udc4d\ud83d\udc4d\nThe Return of the King (The Lo  \ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\n</code></pre> <p>It looks like Mockingjay, at least on Amazon and in this dataset, was not well received.</p> <p>You can easily modify this script to query for books ad hoc:</p> <pre><code>averageexec gawk -F '\\t' '\n{\n    # Global Average\n    g_count = g_count + 1\n    g_total = g_total + $8 \n    PROCINFO[\"sorted_in\"] = \"@val_num_asc\"\n}\n$6~/^.*'+\"$1\"+'.*$/ { # &lt;-- Take match as input\n  title[$6]=$6\n  count[$6]= count[$6] + 1\n  total[$6]= total[$6] + $8\n}\nEND { \n    PROCINFO[\"sorted_in\"] = \"@val_num_desc\"\n    g_score = g_total/g_count \n    for (i in count) {\n        score = total[i]/count[i]\n        printf \"%-50s\\t\", substr(title[i],1,50)\n        if (score - g_score &gt; .4)\n            printf \"\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; .25)\n            printf \"\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; 0)\n            printf \"\ud83d\udc4d\" \n        else if (g_score - score  &gt; 1)\n            printf \"\ud83d\udc4e\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; .5)\n            printf \"\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; 0)\n            printf \"\ud83d\udc4e\"\n        printf \"\\n\"\n    }\n}\n' bookreviews.tsv | head -n 1\n</code></pre> <p>And then run it like this:</p> <pre><code>&gt;_$ ./average \"Left Hand of Darkness\"\nThe Left Hand of Darkness (Ace Science Fiction)         \ud83d\udc4e\n$ ./average \"Neuromancer\"          \nNeuromancer                                             \ud83d\udc4e\ud83d\udc4e\n$ ./average \"The Lifecycle of Software Objects\"\nThe Lifecycle of Software Objects                       \ud83d\udc4e\n</code></pre> <p>These are all great books, so I\u2019m starting to question the taste of Amazon reviewers.</p> <p>I want to test one more thing, though: how do the most popular books rate? Maybe popular books get lots of reviews, and that pushes them below the overall average?</p>","tags":["awk"]},{"location":"programming/understanding-awk/#what-ive-learned-awk-if-else","title":"What I\u2019ve Learned: Awk If Else","text":"<p>Awk has branching using <code>if</code> and <code>else</code> statements. It works exactly like you might expect it to:</p> <pre><code>&gt;_$ echo \"1\\n 2\\n 3\\n 4\\n 5\\n 6\" | awk '{\n        if (NR % 2) \n            print \"odd\"\n        else\n            print $0\n        }'\nodd\n2\nodd\n4\nodd\n6\n</code></pre>","tags":["awk"]},{"location":"programming/understanding-awk/#awk-sort-by-values","title":"Awk Sort by Values","text":"<p>Awk (specifically gawk) allows you easily configure your iteration order using a magic variable called <code>PROCINFO[\"sorted_in\"]</code>. This means that if I change our program to sort by value and drop the filtering, then I will be able to see the top reviewed books:</p> <pre><code>top_booksexec gawk -F '\\t' '\n{\n    # Global Average\n    g_count = g_count + 1\n    g_total = g_total + $8 \n    title[$6]=$6\n    count[$6]= count[$6] + 1\n    total[$6]= total[$6] + $8\n}\nEND { \n    PROCINFO[\"sorted_in\"] = \"@val_num_desc\" # &lt;-- Print in value order\n    g_score = g_total/g_count \n    for (i in count) {\n        score = total[i]/count[i]\n        printf \"%-50s\\t\", substr(title[i],1,50)\n        if (score - g_score &gt; .4)\n            printf \"\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; .25)\n            printf \"\ud83d\udc4d\ud83d\udc4d\" \n        else if (score - g_score &gt; 0)\n            printf \"\ud83d\udc4d\" \n        else if (g_score - score  &gt; 1)\n            printf \"\ud83d\udc4e\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; .5)\n            printf \"\ud83d\udc4e\ud83d\udc4e\" \n        else if (g_score - score  &gt; 0)\n            printf \"\ud83d\udc4e\"\n        printf \"\\n\"\n    }\n}\n' bookreviews.tsv \n</code></pre> <p>Running it:</p> <pre><code>&gt;_$ ./top_books | head\nHarry Potter And The Sorcerer's Stone                 \ud83d\udc4d\ud83d\udc4d\nFifty Shades of Grey                                  \ud83d\udc4e\ud83d\udc4e\nThe Hunger Games (The Hunger Games, Book 1)           \ud83d\udc4d\nThe Hobbit                                            \ud83d\udc4d\nTwilight                                              \ud83d\udc4e\nJesus Calling: Enjoying Peace in His Presence         \ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\nUnbroken: A World War II Story of Survival, Resili    \ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\nThe Shack: Where Tragedy Confronts Eternity           \ud83d\udc4e\nDivergent                                             \ud83d\udc4d\nGone Girl                                             \ud83d\udc4e\ud83d\udc4e\n</code></pre> <p>It looks like about half (6 /10) of the most reviewed books were more popular than average. So I can\u2019t blame Mockingjay\u2019s low score on its popularity. I think I\u2019ll have to take a pass on the series or at least that book.</p>","tags":["awk"]},{"location":"programming/understanding-awk/#conclusion","title":"Conclusion","text":"<p>A good programmer uses the most powerful tool to do a job. A great programmer uses the least powerful tool that does the job.</p> <p>vyuh</p> <p>Awk has more to it than this. There are more built-in variables and built-in functions. It has range patterns and substitution rules, and you can easily use it to modify content, not just add things up.</p> <p>If you want to learn more about Awk, The Awk Programming Language is the definitive book. It covers the language in depth. It also covers how to build a small programming language in Awk, how to build a database in Awk, and some other fun projects.</p> <p>Even Amazon thinks its great:</p> <pre><code>&gt;_$ ./average \"The AWK \"          \nThe AWK Programming Language                            \ud83d\udc4d\ud83d\udc4d\n</code></pre> <p>Also, if you\u2019re the type of person who\u2019s not afraid to do things on the command line then you might like Earthly:</p> <p>While you\u2019re here:</p> <p>Earthly is the effortless CI/CD framework.  Develop CI/CD pipelines locally and run them anywhere!</p>","tags":["awk"]},{"location":"programming/understanding-awk/#whats-your-awk-trick-or-book-pick","title":"What\u2019s your Awk Trick or Book Pick?","text":"<p>I hope this introduction gave you enough Awk for 90% of your use-cases though. If you come up with any clever Awk tricks yourself or if you have strong opinions on what I should read next, let me know Twitter <code>@AdamGordonBell</code>:</p> <p>AWK is a Swiss Army knife of text processing.</p> <p>I knew it was powerful but I'd never known how to use it.</p> <p>So I took some time to learn the basics. Here is what you need to know: \ud83e\uddf5</p> <p>\u2014 Adam Gordon Bell \ud83e\udd13 (</p> <p>@adamgordonbell</p> <p>)</p> <p>September 30, 2021</p> <ol> <li>Sundeep Agarwal pointed out on reddit that Awk does more than this: \u201cBy default, awk does more than split the input on spaces. It splits based on one or more sequence of space or tab or newline characters. In addition, any of these three characters at the start or end of input gets trimmed and won\u2019t be part of field contents. Newline characters come into play if the record separator results in newline within the record content.\u201d\u21a9\ufe0e</li> </ol>","tags":["awk"]},{"location":"tips/bash-tips/","title":"BASH \u7684\u4e00\u4e9b\u6280\u5de7","text":"<p>\u672c\u6587\u8bb0\u5f55\u9605\u8bfb Advanced Bash-Scripting Guide \u65f6\uff0c\u65b0\u83b7\u5f97\u7684\u4e00\u4e9b\u6280\u5de7\u3002</p>","tags":["bash","abs"]},{"location":"tips/bash-tips/#chapter-3-special-characters","title":"Chapter 3. Special Characters","text":"","tags":["bash","abs"]},{"location":"tips/bash-tips/#_1","title":"\u8fdb\u5236\u8f6c\u6362","text":"<pre><code># \u628a\u5236\u5b9a\u7684\u8fdb\u5236\u6570\u8f6c\u6210\u5341\u8fdb\u5236\u6570\n# 2#101011 # \u4e4b\u524d\u7684\u6570\u5b57\u662f\u8fdb\u5236\u6570\u7684\u57fa\u6570\uff0c 101011 \u662f\u8fdb\u5236\u6570\necho $(( 2#101011 ))    # 43\necho $(( 16#072f3 ))    # 29427\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#_2","title":"<code>:</code> \u7528\u4e8e\u5360\u4f4d\u7b26","text":"<pre><code># : \u7528\u4e8e\u5360\u4f4d\u7b26 \n: ${username=`whoami`}\n# ${username=`whoami`}   Gives an error without the leading :\n#                        unless \"username\" is a command or builtin...\n\n: ${1?\"Usage: $0 ARGUMENT\"}     # From \"usage-message.sh example script.\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#_3","title":"<code>:</code> \u7528\u4e8e\u8bc4\u4f30\u53d8\u91cf","text":"<pre><code>: ${HOSTNAME?} ${USER?} ${MAIL?}\n#  Prints error message\n#+ if one or more of essential environmental variables not set.\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#_4","title":"<code>{}</code> \u5c06\u4ee3\u7801\u5757\u7684\u8f93\u51fa\u4fdd\u5b58\u5230\u6587\u4ef6","text":"<p>\u8fd9\u79cd\u65b9\u5f0f\u8282\u7701\u4e86\u6bcf\u6b21\u8f93\u51fa\u90fd\u8981\u91cd\u5b9a\u5411\u7684\u9ebb\u70e6\uff0c\u540c\u65f6\u4e5f\u4e0d\u9700\u8981\u4f7f\u7528\u5168\u5c40\u91cd\u5b9a\u5411\u7684\u6a21\u5f0f\u3002\u65b9\u4fbf\u8bb0\u5f55\u65e5\u5fd7\u3002</p> <pre><code>{ # Begin code block.\n  echo\n  echo \"Archive Description:\"\n  rpm -qpi $1       # Query description.\n  echo\n  echo \"Archive Listing:\"\n  rpm -qpl $1       # Query listing.\n  echo\n  rpm -i --test $1  # Query whether rpm file can be installed.\n  if [ \"$?\" -eq $SUCCESS ]\n  then\n    echo \"$1 can be installed.\"\n  else\n    echo \"$1 cannot be installed.\"\n  fi  \n  echo              # End code block.\n} &gt; \"$1.test\"       # Redirects output of everything in block to file.\n\necho \"Results of rpm test in file $1.test\"\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#chapter-4-introduction-to-variables-and-parameters","title":"Chapter 4. Introduction to Variables and Parameters","text":"","tags":["bash","abs"]},{"location":"tips/bash-tips/#_5","title":"\u83b7\u53d6\u6700\u540e\u4e00\u4e2a\u547d\u4ee4\u53c2\u6570\u7684\u4e00\u4e9b\u6280\u5de7","text":"<pre><code>args=$#           # Number of args passed.\nlastarg=${!args}\n# Note: This is an *indirect reference* to $args ...\n\n\n# Or:       lastarg=${!#}             (Thanks, Chris Monson.)\n# This is an *indirect reference* to the $# variable.\n# Note that lastarg=${!$#} doesn't work.\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#chapter-10-manipulating-variables","title":"Chapter 10. Manipulating Variables","text":"","tags":["bash","abs"]},{"location":"tips/bash-tips/#_6","title":"\u5b57\u7b26\u4e32\u622a\u53d6","text":"<pre><code># ${string:position:length} \u4ece position \u5f00\u59cb\uff0c\u622a\u53d6 length \u957f\u5ea6\u7684\u5b57\u7b26\u4e32\nstringZ=abcABC123ABCabc\n#       0123456789.....\n#       0-based indexing.\n\necho ${stringZ:0}                            # abcABC123ABCabc\necho ${stringZ:1}                            # bcABC123ABCabc\necho ${stringZ:7}                            # 23ABCabc\n\necho ${stringZ:1:-2}                         # bcABC123ABCa\n\n# \u53cd\u5411\u622a\u53d6\u6709\u610f\u601d\u7684\u5730\u65b9\u6765\u4e86\n# Is it possible to index from the right end of the string?\n\necho ${stringZ:-4}                           # abcABC123ABCabc\n# Defaults to full string, as in ${parameter:-default}.\n# However . . .\n\necho ${stringZ:(-4)}                         # Cabc \necho ${stringZ: -4}                          # Cabc\n# Now, it works.\n# Parentheses or added space \"escape\" the position parameter.\n</code></pre>","tags":["bash","abs"]},{"location":"tips/bash-tips/#chapter-36-miscellany","title":"Chapter 36. Miscellany","text":"","tags":["bash","abs"]},{"location":"tips/bash-tips/#_7","title":"\u4f18\u5316","text":"<p>\u7981\u7528 Unicode \u652f\u6301</p> <p>\u5982\u679c\u4e0d\u9700\u8981 Unicode \u652f\u6301\uff0c\u53ef\u4ee5\u7981\u7528\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u4e00\u4e9b\u6027\u80fd\u3002</p> <pre><code>export LC_ALL=C\n</code></pre> <p>\u4f7f\u7528\u5185\u7f6e\u547d\u4ee4\u800c\u4e0d\u662f\u5916\u90e8\u547d\u4ee4</p> <p>\u4f7f\u7528\u5185\u7f6e\u7684\u547d\u4ee4\u6bd4\u4f7f\u7528\u5916\u90e8\u547d\u4ee4\u8981\u5feb\u5f88\u591a\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\u521b\u5efa\u65b0\u7684\u8fdb\u7a0b\u3002</p> <p>\u4ee5\u5b57\u7b26\u4e32\u5339\u914d\u4e3a\u4f8b\uff0c\u4f7f\u7528\u5185\u7f6e\u7684\u5b57\u7b26\u4e32\u5339\u914d\u6bd4\u4f7f\u7528 <code>grep</code> \u8981\u5feb\u5f88\u591a\u3002</p> <pre><code>v=\"Builtins execute faster and usually do not launch a subshell when invoked.\"\n\n# Using grep\nfor i in {1..1000}\ndo\n    echo $v | grep -q  'f*r'\ndone\n\n# Using BASH pattern matching\nfor i in {1..1000}\ndo\n    [[ $v == *f*r* ]]\ndone\nexit $?\n</code></pre> <p>\u4f7f\u7528 <code>grep</code> \u5339\u914d\u7684\u65b9\u5f0f\u6267\u884c\u9700\u8981 <code>3.7</code> \u79d2\uff0c\u800c\u540e\u8005\u53ea\u9700\u8981 <code>0.008</code> \u79d2\uff0c\u4e24\u8005\u76f8\u5dee <code>462.5</code> \u500d\u3002</p> <p>\u4f7f\u7528<code>(())</code> \u800c\u4e0d\u662f <code>expr</code> \u6267\u884c\u7b97\u6570\u8fd0\u7b97</p> <pre><code>#!/bin/bash\n#  test-execution-time.sh\n#  Example by Erik Brandsberg, for testing execution time\n#+ of certain operations.\n#  Referenced in the \"Optimizations\" section of \"Miscellany\" chapter.\n\ncount=50000\necho \"Math tests\"\necho \"Math via \\$(( ))\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  result=$(( $i%2 ))\ndone\n\necho \"Math via *expr*:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  result=`expr \"$i%2\"`\ndone\n\necho \"Math via *let*:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  let result=$i%2\ndone\n\necho\necho \"Conditional testing tests\"\n\necho \"Test via case:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  case $(( $i%2 )) in\n    0) : ;;\n    1) : ;;\n  esac\ndone\n\necho \"Test with if [], no quotes:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  if [ $(( $i%2 )) = 0 ]; then\n     :\n  else\n     :\n  fi\ndone\n\necho \"Test with if [], quotes:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  if [ \"$(( $i%2 ))\" = \"0\" ]; then\n     :\n  else\n     :\n  fi\ndone\n\necho \"Test with if [], using -eq:\"\ntime for (( i=0; i&lt; $count; i++))\ndo\n  if [ $(( $i%2 )) -eq 0 ]; then\n     :\n  else\n     :\n  fi\ndone\n\nexit $?\n</code></pre> <p>\u4e0a\u8ff0\u811a\u672c\u6267\u884c\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>Math tests\nMath via $(( ))\n\nreal    0m0.130s\nuser    0m0.130s\nsys 0m0.001s\nMath via *expr*:\n\nreal    2m41.665s\nuser    1m10.645s\nsys 1m36.772s\nMath via *let*:\n\nreal    0m0.180s\nuser    0m0.176s\nsys 0m0.004s\n\nConditional testing tests\nTest via case:\n\nreal    0m0.146s\nuser    0m0.142s\nsys 0m0.005s\nTest with if [], no quotes:\n\nreal    0m0.186s\nuser    0m0.184s\nsys 0m0.002s\nTest with if [], quotes:\n\nreal    0m0.201s\nuser    0m0.196s\nsys 0m0.005s\nTest with if [], using -eq:\n\nreal    0m0.195s\nuser    0m0.192s\nsys 0m0.003s\n</code></pre> <p>\u4ece\u7ed3\u679c\u6765\u770b\uff0c\u4f7f\u7528 <code>(( ))</code> \u8fdb\u884c\u7b97\u6570\u8fd0\u7b97\u6bd4\u4f7f\u7528 <code>expr</code> \u8981\u5feb\u5f88\u591a\uff0c\u4e24\u8005\u76f8\u5dee <code>12351.3</code> \u500d\u3002</p>","tags":["bash","abs"]},{"location":"tips/bash-tips/#_8","title":"\u5b89\u5168\u95ee\u9898","text":"<p>\u9690\u85cf shell \u811a\u672c\u6e90\u4ee3\u7801</p> <p>\u53ef\u4ee5\u4f7f\u7528 shc --generic shell script compiler \u6765\u7f16\u8bd1 shell \u811a\u672c\u4e3a\u4e8c\u8fdb\u5236\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8fd9\u6837\u53ef\u4ee5\u9690\u85cf\u811a\u672c\u7684\u6e90\u4ee3\u7801\u3002</p>","tags":["bash","abs"]},{"location":"tips/batch-convert-word-to-pdf/","title":"Windows \u4e0b\u6279\u91cf\u8f6c\u6362 word \u6587\u6863\u4e3a pdf \u7684\u65b9\u6cd5","text":"<p>\u65b9\u6cd5\u4e3a\u5229\u7528PowerShell\u7684\u63d2\u4ef6\u529f\u80fd</p> <p>\u9996\u5148\u4ece\u5b98\u65b9\u7f51\u7ad9\u4e0b\u8f7d <code>ConvertWordDocumentToPDS.psm1</code> \u6587\u4ef6\uff0c\u5047\u5b9a\u4e0b\u8f7d\u5230 <code>d:\\tool</code> \u4e0b\uff0c \u7136\u540e\u6253\u5f00powershell\uff0c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff0c\u5c06\u63d2\u4ef6\u5bfc\u5165</p> <pre><code>Import-Module D:\\tool\\ConvertPowerPointToWordDocument.psm1\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4e86</p> <pre><code>ConvertTo-OSCPDF \u2013Path D:\\Word\n</code></pre> <p>\u5176\u4e2d <code>D:\\word</code> \u5c31\u662f\u4f60\u8981\u8f6c\u6362word\u6587\u4ef6\u7684\u76ee\u5f55\uff0c\u811a\u672c\u4f1a\u628a\u6539\u76ee\u5f55\u4e0b\u7684\u6240\u6709word\u6587\u6863\u8f6c\u4e3a\u540c\u540d\u7684pdf\u6587\u4ef6\uff0c\u5e76\u5b58\u653e\u5728\u5f53\u524d\u76ee\u5f55\u4e0b</p>","tags":["word","pdf","powershell"]},{"location":"tips/change-keyboard-layout-in-ubuntu/","title":"Ubuntu \u4e0b\u4fee\u6539\u952e\u76d8\u6620\u5c04","text":"<p>\u4e60\u60ef\u4e86\u628a <code>Ctrl</code> \u952e \u548c <code>Caps Lock</code> \u952e\u4ea4\u6362\uff0c\u5728 Linux \u4e0b\u5982\u679c\u4e5f\u8981\u4fee\u6539\u8fd9\u4e2a\u6620\u5c04\u7684\u8bdd\u3002\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539 <code>/usr/share/X11/xkb/keycodes/evdev</code> \u8fd9\u4e2a\u952e\u76d8\u6620\u5c04\u6587\u4ef6\u3002</p> <p>\u4fee\u6539\u4e4b\u524d\uff0c\u8bb0\u5f97\u5907\u4efd\u3002</p> <p>\u6253\u5f00 <code>/usr/share/X11/xkb/keycodes/evdev</code> \u6587\u4ef6\uff0c\u627e\u5230 <code>&lt;CAPS&gt; = 66;</code> \u548c <code>&lt;LCTL&gt;=37;</code> \u8fd9\u4e24\u884c\uff08\u4f60\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\u7684\u503c\u53ef\u80fd\u4e0d\u4e00\u6837\uff09\u3002</p> <p>\u7136\u540e\u628a\u8fd9\u4e24\u4e2a\u503c\u5bf9\u6362\uff0c\u53d8\u6210  <code>&lt;CAPS&gt; = 37;</code> \u548c <code>&lt;LCTL&gt;=66;</code> \u3002\u7136\u540e\u6ce8\u9500\u91cd\u65b0\u767b\u5f55\u5c31\u751f\u6548\u4e86\u3002</p>","tags":["ubuntu","keybord","evdev","layout"]},{"location":"tips/git-internals-objects-branches-create-repo/","title":"Git \u5185\u90e8\u539f\u7406\u56fe\u89e3\u2014\u2014\u5bf9\u8c61\u3001\u5206\u652f\u4ee5\u53ca\u5982\u4f55\u4ece\u96f6\u5f00\u59cb\u5efa\u4ed3\u5e93","text":"<p>\u6587\u672c\u6765\u81ea \u8fd9\u91cc\uff0c\u82f1\u6587\u539f\u6587\u6765\u81ea \u8fd9\u91cc</p> <p>\u6211\u5728\u5b66\u4e60\u548c\u5b9e\u8df5\u7684\u8fc7\u7a0b\u4e2d\u5bf9\u539f\u6587\u7565\u6709\u4fee\u6539\u3002</p> <p>\u4ee5\u4e0b\u5b9e\u9a8c\u5747\u5728 MacOS 13.5 \u4ee5\u53ca  git <code>2.39.2</code> \u7248\u672c\u4e0b\u8fdb\u884c\u3002</p> <p>\u6211\u4eec\u4e2d\u7684\u8bb8\u591a\u4eba\u6bcf\u5929\u90fd\u5728\u4f7f\u7528 <code>git</code>\uff0c\u4f46\u662f\u6709\u591a\u5c11\u4eba\u77e5\u9053\u5b83\u7684\u5185\u90e8\u662f\u600e\u4e48\u8fd0\u4f5c\u7684\u5462\uff1f</p> <p>\u4f8b\u5982\u6211\u4eec\u4f7f\u7528 <code>git commit</code> \u65f6\u53d1\u751f\u4e86\u4ec0\u4e48\uff1f\u63d0\u4ea4\uff08commit\uff09\u4e0e\u63d0\u4ea4\u4e4b\u95f4\u4fdd\u5b58\u7684\u662f\u4ec0\u4e48\uff1f\u4e24\u6b21\u63d0\u4ea4\u4e4b\u95f4\u96be\u9053\u53ea\u662f\u6587\u4ef6\u7684\u5dee\u5f02\uff08diff\uff09\u5417\uff1f\u5982\u679c\u662f\uff0c\u8fd9\u4e2a\u5dee\u5f02\u662f\u5982\u4f55\u7f16\u7801\u7684\uff1f\u8fd8\u662f\u8bf4\u6bcf\u6b21\u63d0\u4ea4\u90fd\u4f1a\u4fdd\u5b58\u4e00\u4e2a\u5f53\u524d\u4ed3\u5e93\u7684\u5b8c\u6574\u5feb\u7167\uff08snapshot\uff09\u5462\uff1f\u6211\u4eec\u4f7f\u7528 <code>git init</code> \u65f6\u5230\u5e95\u53d1\u751f\u4e86\u4ec0\u4e48\uff1f</p> <p>\u5f88\u591a <code>git</code> \u7684\u4f7f\u7528\u8005\u90fd\u4e0d\u77e5\u9053\u8fd9\u51e0\u4e2a\u95ee\u9898\u7684\u7b54\u6848\uff0c\u4f46\u8fd9\u53c8\u6709\u4ec0\u4e48\u5173\u7cfb\u5462\uff1f</p> <p>\u9996\u5148\uff0c\u4f5c\u4e3a\u4e13\u4e1a\u4eba\u5458\uff0c\u6211\u4eec\u5e94\u5f53\u52aa\u529b\u5f04\u6e05\u695a\u624b\u4e2d\u4f7f\u7528\u7684\u5de5\u5177\uff0c\u5c24\u5176\u662f\u90a3\u4e9b\u6211\u4eec\u4e00\u76f4\u90fd\u5728\u4f7f\u7528\u7684\u2014\u2014\u6bd4\u5982 <code>git</code>\u3002</p> <p>\u4f46\u662f\u6211\u6df1\u523b\u5730\u610f\u8bc6\u5230\uff0c\u7406\u89e3 Git \u7684\u5de5\u4f5c\u539f\u7406\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\u90fd\u975e\u5e38\u6709\u7528\u2014\u2014\u4e0d\u7ba1\u662f\u89e3\u51b3\u5408\u5e76\u51b2\u7a81\u3001\u8fdb\u884c\u6709\u8da3\u7684\u53d8\u57fa\uff08rebase\uff09\u64cd\u4f5c\uff0c\u8fd8\u662f\u5728\u67d0\u4e9b\u4e1c\u897f\u53d8\u5f97\u6709\u70b9\u4e0d\u5bf9\u52b2\u7684\u65f6\u5019\u3002</p> <p>\u5982\u679c\u4f60\u6709\u8db3\u591f\u7684 <code>git</code> \u7ecf\u9a8c\uff0c\u5bf9 <code>git pull</code>\u3001<code>git push</code>\u3001<code>git add</code> \u6216 <code>git commit</code>\u8fd9\u4e9b\u547d\u4ee4\u5f97\u5fc3\u5e94\u624b\uff0c\u4f60\u4f1a\u4ece\u672c\u6587\u4e2d\u83b7\u76ca\u3002</p> <p>\u4e0d\u8fc7\uff0c\u4e3a\u4e86\u786e\u4fdd\u6211\u4eec\u5728 <code>git</code> \u7684\u539f\u7406\uff08\u5c24\u5176\u662f\u672c\u6587\u4e0a\u4e0b\u6240\u4f7f\u7528\u7684\u672f\u8bed\uff09\u4e0a\u6b65\u8c03\u4e00\u81f4\uff0c\u6211\u4eec\u5c06\u4ece\u6982\u89c8\u5f00\u59cb\u3002</p> <p>\u6211\u4e5f\u5728 YouTube \u4e0a\u4f20\u4e86\u4e00\u4e2a\u6db5\u76d6\u672c\u6587\u6240\u6709\u5185\u5bb9\u7684\u7cfb\u5217\u89c6\u9891\u2014\u2014\u6b22\u8fce\u5728\u6b64\u89c2\u770b\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_1","title":"\u672c\u6559\u7a0b\u7684\u5185\u5bb9","text":"<p>\u6211\u4eec\u5c06\u5bf9\u65e5\u5e38\u4f7f\u7528\u7684 <code>git</code> \u7684\u5185\u90e8\u8fd0\u884c\u539f\u7406\u6709\u4e00\u4e2a\u6bd4\u8f83\u6df1\u5165\u7684\u7406\u89e3\u3002</p> <p>\u6211\u4eec\u4f1a\u4ece\u5bf9\u8c61\uff08object\uff09\u2014\u2014blob\u3001\u6811\u5bf9\u8c61\uff08tree\uff09 \u548c \u63d0\u4ea4\u5bf9\u8c61\uff08commit\uff09 \u5f00\u59cb\uff0c\u7136\u540e\u7b80\u5355\u8ba8\u8bba\u4e00\u4e0b \u5206\u652f\uff08branch\uff09 \u53ca\u5176\u5b9e\u73b0\u65b9\u5f0f\uff0c\u4e4b\u540e\u4f1a\u6df1\u5165 \u5de5\u4f5c\u76ee\u5f55\uff08working directory\uff09\u3001\u6682\u5b58\u533a\uff08staging area\uff09 \u548c \u4ed3\u5e93\uff08repository\uff09\u3002</p> <p>\u6211\u4eec\u4f1a\u786e\u4fdd\u7406\u89e3\u4e86\u8fd9\u4e9b\u672f\u8bed\u662f\u4e0e\u6211\u4eec\u7528\u6765\u521b\u5efa\u65b0\u4ed3\u5e93\u7684\u90a3\u4e9b\u547d\u4ee4\u4e4b\u95f4\u662f\u5982\u4f55\u5173\u8054\u7684\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4f1a\u4ece\u96f6\u5f00\u59cb\u521b\u5efa\u4e00\u4e2a\u4ed3\u5e93\u2014\u2014\u4e0d\u4f7f\u7528 <code>git init</code>\u3001<code>git add</code> \u6216 <code>git commit</code>\u3002\u8fd9\u4f1a\u5728\u6211\u4eec\u4f7f\u7528 <code>git</code> \u7684\u8fc7\u7a0b\u4e2d\uff0c\u52a0\u6df1\u6211\u4eec\u5bf9\u5176\u5185\u90e8\u6b63\u5728\u53d1\u751f\u7684\u4e8b\u60c5\u7684\u7406\u89e3\u3002</p> <p>\u6211\u4eec\u4e5f\u4f1a\u521b\u5efa\u65b0\u7684\u5206\u652f\u3001\u5728\u5206\u652f\u95f4\u5207\u6362\uff0c\u518d\u8fdb\u884c\u4e00\u4e9b\u63d0\u4ea4\u2014\u2014\u5168\u7a0b\u4e0d\u4f7f\u7528 <code>git branch</code> \u6216 <code>git checkout</code>\u3002</p> <p>\u5728\u672c\u6587\u7ed3\u675f\u4e4b\u524d\uff0c\u4f60\u4f1a\u89c9\u5f97\u81ea\u5df1\u771f\u7684 *\u7406\u89e3\u4e86* <code>git</code>\u3002\u4f60\u51c6\u5907\u597d\u4e86\u5417\uff1f\ud83d\ude0e</p> <p>\u8bd1\u8005\u6ce8\uff1a\u5efa\u8bae\u8bfb\u8005\u914d\u5408 Git \u5185\u90e8\u539f\u7406\u9605\u8bfb\u672c\u6587\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git-blobtree-commit","title":"Git \u5bf9\u8c61\u2014\u2014blob\u3001tree \u548c commit","text":"<p>\u8bd1\u8005\u6ce8\uff1a\u8bd1\u6587\u4e2d\u7684 \u6570\u636e\u5bf9\u8c61\u3001\u6811\u5bf9\u8c61 \u548c \u63d0\u4ea4\u5bf9\u8c61 \u6307\u7684\u5c31\u662f blob\u3001tree \u548c commit \u8fd9\u4e09\u8005\u3002\u56e0\u4e3a Git \u5b98\u7f51\u7684\u6587\u6863Git \u5185\u90e8\u539f\u7406 - Git \u5bf9\u8c61\u5bf9\u4e09\u8005\u8fdb\u884c\u4e86\u8fd9\u6837\u7684\u7ffb\u8bd1\uff0c\u672c\u6587\u662f\u4e3a\u4e86\u4e0e\u5176\u4fdd\u6301\u4e00\u81f4\u3002\u4f46\u7531\u4e8e blob \u4e00\u8bcd\u7684\u7279\u6b8a\u6027\uff0c\u8bd1\u6587\u4f1a\u76f4\u63a5\u4fdd\u7559\u539f\u8bcd\uff0c\u800c\u4e0d\u662f\u5c06\u5176\u7ffb\u8bd1\u4e3a\u201c\u6570\u636e\u5bf9\u8c61\u201d\u3002</p> <p>\u5c06 <code>git</code> \u770b\u6210\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff08\u5c24\u5176\u662f\u8be5\u7cfb\u7edf\u7684\u5b9e\u65f6\u5feb\u7167\uff09\u662f\u5f88\u6709\u7528\u7684\u3002</p> <p>\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4ece \u6839\u76ee\u5f55\uff08root directory\uff09 \u5f00\u59cb\uff08\u5728\u57fa\u4e8e UNIX \u7684\u7cfb\u7edf\u4e2d\u662f <code>/</code>\uff09\uff0c\u901a\u5e38\u4e5f\u4f1a\u5305\u542b\u5176\u5b83\u7684\u76ee\u5f55\uff08\u4f8b\u5982 <code>/usr</code> \u6216 <code>/bin</code>\uff09\u3002\u8fd9\u4e9b\u76ee\u5f55\u4f1a\u5305\u542b\u5176\u5b83\u7684\u76ee\u5f55\u548c\uff08\u6216\uff09\u6587\u4ef6\uff08\u4f8b\u5982 <code>/usr/1.txt</code>\uff09\u3002</p> <p>\u5728 <code>git</code> \u4e2d\uff0c\u6587\u4ef6\u7684\u5185\u5bb9\u5b58\u50a8\u5728\u4e00\u4e9b\u88ab\u79f0\u4e3a blob \uff08\u4e8c\u8fdb\u5236\u5927\u5bf9\u8c61\uff09\u7684\u5bf9\u8c61\u4e2d\u3002</p> <p>blob \u4e0e\u6587\u4ef6\u7684\u4e0d\u540c\u5728\u4e8e\uff0c\u6587\u4ef6\u8fd8\u4f1a\u5305\u542b\u5143\u6570\u636e\uff08meta-data\uff09\u3002\u4f8b\u5982\u4e00\u4e2a\u6587\u4ef6\u4f1a\u201c\u8bb0\u4f4f\u201d\u5b83\u7684\u521b\u5efa\u65f6\u95f4\uff0c\u5982\u679c\u4f60\u628a\u5b83\u79fb\u52a8\u5230\u53e6\u4e00\u4e2a\u76ee\u5f55\uff0c\u5b83\u7684\u521b\u5efa\u65f6\u95f4\u662f\u4e0d\u4f1a\u6539\u53d8\u7684\u3002</p> <p>\u76f8\u53cd\uff0cblob \u53ea\u662f\u5185\u5bb9\u2014\u2014\u6570\u636e\u7684\u4e8c\u8fdb\u5236\u6d41\u3002\u9664\u4e86\u5185\u5bb9\u4ee5\u5916\uff0cblob \u4e0d\u4f1a\u8bb0\u5f55\u5b83\u7684\u521b\u5efa\u65f6\u95f4\u3001\u540d\u5b57\u6216\u4efb\u4f55\u5176\u5b83\u4e1c\u897f\u3002</p> <p><code>git</code> \u4e2d\u7684 blob \u901a\u8fc7 SHA-1 \u54c8\u5e0c\u503c \u552f\u4e00\u6807\u8bc6\u3002SHA-1 \u54c8\u5e0c\u503c\u7531 20 \u4e2a\u5b57\u8282\uff08byte\uff09\u7ec4\u6210\uff0c\u901a\u5e38\u8868\u793a\u6210 40 \u4e2a\u5341\u516d\u8fdb\u5236\u5f62\u5f0f\u7684\u5b57\u7b26\u3002\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u6709\u65f6\u53ea\u4f1a\u5c55\u793a\u8fd9\u4e2a\u54c8\u5e0c\u503c\u7684\u524d\u51e0\u4e2a\u5b57\u7b26\u3002</p> <p></p> <p>\u5728 <code>git</code> \u4e2d\uff0c\u6811\u5bf9\u8c61\uff08tree\uff09 \u76f8\u5f53\u4e8e\u76ee\u5f55\u3002\u4e00\u4e2a \u6811\u5bf9\u8c61 \u57fa\u672c\u4e0a\u5c31\u662f\u4e00\u4e2a\u76ee\u5f55\u5217\u8868\uff0c\u5b83\u5f15\u7528\u7740 blob \u548c\u5176\u5b83\u7684 \u6811\u5bf9\u8c61\u3002</p> <p>\u6811\u5bf9\u8c61 \u4e5f\u7528 SHA-1 \u54c8\u5e0c\u503c\u552f\u4e00\u6807\u8bc6\uff0c\u5b83\u901a\u8fc7\u5176\u5b83\u5bf9\u8c61\uff08blob \u6216 \u6811\u5bf9\u8c61\uff09\u7684 SHA-1 \u54c8\u5e0c\u503c\u5f15\u7528\u5b83\u4eec\u3002</p> <p></p> <p>\u6ce8\u610f CAFE7 \u8fd9\u4e2a \u6811\u5bf9\u8c61 \u6307\u5411\u4e86 blob F92A0\uff08pic.png\uff09\uff0c\u5728\u53e6\u4e00\u4e2a \u6811\u5bf9\u8c61 \u4e2d\uff0c\u540c\u4e00\u4e2a blob \u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u7684\u540d\u5b57\u3002</p> <p></p> <p>\u4e0a\u9762\u8fd9\u5f20\u56fe\u76f8\u5f53\u4e8e\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\u6709\u4e00\u4e2a\u6839\u76ee\u5f55\uff0c\u6839\u76ee\u5f55\u4e0b\u6709\u4e00\u4e2a\u4f4d\u4e8e <code>/test.js</code> \u7684\u6587\u4ef6\u548c\u4e00\u4e2a\u540d\u4e3a <code>/docs</code> \u7684\u76ee\u5f55\uff0c<code>/docs</code> \u76ee\u5f55\u4e0b\u6709\u4e24\u4e2a\u6587\u4ef6\uff1a<code>/docs/pic.png</code> \u548c <code>/docs/1.txt</code>\u3002</p> <p>\u73b0\u5728\u662f\u65f6\u5019\u6355\u83b7\u8be5\u6587\u4ef6\u7cfb\u7edf\u7684\u4e00\u4e2a\u5feb\u7167\u4e86\uff0c\u628a\u90a3\u4e2a\u65f6\u523b\u5b58\u5728\u7684\u6240\u6709\u6587\u4ef6\u8fde\u540c\u5b83\u4eec\u7684\u5185\u5bb9\u4fdd\u5b58\u4e0b\u6765\u3002</p> <p>\u5728 <code>git</code> \u4e2d\uff0c\u4e00\u4e2a\u5feb\u7167\u5c31\u662f\u4e00\u4e2a \u63d0\u4ea4\uff08commit\uff09\u3002\u4e00\u4e2a \u63d0\u4ea4 \u5bf9\u8c61\u5305\u62ec\u4e00\u4e2a\u6307\u5411\u4e3b\u8981 \u6811\u5bf9\u8c61\uff08\u6839\u76ee\u5f55\uff09\u7684\u6307\u9488\u548c\u4e00\u4e9b\u50cf \u63d0\u4ea4\u8005\u3001\u63d0\u4ea4\u4fe1\u606f \u548c \u63d0\u4ea4\u65f6\u95f4 \u8fd9\u6837\u7684\u5143\u6570\u636e\u3002</p> <p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a \u63d0\u4ea4 \u8fd8\u4f1a\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u7236 \u63d0\u4ea4\u2014\u2014\u4e4b\u524d\u7684\u5feb\u7167\u3002\u5f53\u7136\uff0c**\u63d0\u4ea4**\u5bf9\u8c61\u4e5f\u901a\u8fc7\u5b83\u4eec\u7684 SHA-1 \u54c8\u5e0c\u503c\u552f\u4e00\u6807\u8bc6\u3002\u8fd9\u4e9b\u54c8\u5e0c\u503c\u5c31\u662f\u6211\u4eec\u4f7f\u7528 <code>git log</code> \u547d\u4ee4\u65f6\u770b\u5230\u7684\u90a3\u4e9b\u54c8\u5e0c\u503c\u3002</p> <p></p> <p>\u6bcf\u4e2a \u63d0\u4ea4 \u90fd\u6301\u6709 \u5b8c\u6574\u7684\u5feb\u7167\uff0c\u5e76\u4e0d\u53ea\u662f\u4e0e\u4e4b\u524d \u63d0\u4ea4 \u4e4b\u524d\u7684\u5dee\u5f02\u3002</p> <p>\u90a3\u4e48\u5b83\u662f\u600e\u4e48\u5de5\u4f5c\u7684\u5462\uff1f\u96be\u9053\u5b83\u4e0d\u4ee3\u8868\u6211\u4eec\u6bcf\u6b21\u63d0\u4ea4\u90fd\u5fc5\u987b\u4fdd\u5b58\u5f88\u591a\u6570\u636e\u5417\uff1f</p> <p>\u8ba9\u6211\u4eec\u6765\u770b\u770b\u6539\u53d8\u4e00\u4e2a\u6587\u4ef6\u7684\u5185\u5bb9\u4f1a\u53d1\u751f\u4ec0\u4e48\u3002\u6211\u4eec\u7f16\u8f91 <code>1.txt</code>\uff0c\u52a0\u4e00\u4e2a\u611f\u53f9\u53f7\u2014\u2014\u4e5f\u5c31\u662f\u628a\u6587\u4ef6\u7684\u5185\u5bb9\u7531 <code>HELLO WORLD</code> \u53d8\u4e3a <code>HELLO WORLD!</code>\u3002</p> <p>\u8fd9\u4e2a\u6539\u53d8\u610f\u5473\u7740\u6211\u4eec\u4f1a\u6709\u4e00\u4e2a\u65b0\u7684 blob\uff0c\u5b83\u6709\u65b0\u7684 SHA-1 \u54c8\u5e0c\u503c\u3002\u8fd9\u662f\u6709\u610f\u4e49\u7684\uff0c\u56e0\u4e3a <code>sha1(\"HELLO WORLD\")</code> \u4e0e <code>sha1(\"HELLO WORLD!\")</code> \u5e76\u4e0d\u76f8\u540c\u3002</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a\u65b0\u7684\u54c8\u5e0c\u503c\uff0c\u6240\u4ee5\u5bf9\u5e94 \u6811\u5bf9\u8c61 \u7684\u76ee\u5f55\u4e5f\u4f1a\u6539\u53d8\u3002\u6bd5\u7adf\uff0c\u6211\u4eec\u7684 \u6811\u5bf9\u8c61 \u4e0d\u518d\u6307\u5411 blob 73D8A \u4e86\uff0c\u800c\u662f\u6307\u5411\u4e86 blob 62E7A\u3002\u5f53\u6211\u4eec\u6539\u53d8 \u6811\u5bf9\u8c61 \u7684\u5185\u5bb9\u65f6\uff0c\u6211\u4eec\u4e5f\u6539\u53d8\u4e86\u5b83\u7684\u54c8\u5e0c\u503c\u3002</p> <p>blob \u53d8\u4e86\uff0c\u6307\u5411\u5b83\u7684\u6811\u5bf9\u8c61\u4e5f\u9700\u8981\u53d8</p> <p>\u73b0\u5728\uff0c\u7531\u4e8e\u539f\u6765\u90a3\u4e2a \u6811\u5bf9\u8c61 \u7684\u54c8\u5e0c\u503c\u5df2\u7ecf\u4e0d\u540c\u4e86\uff0c\u6211\u4eec\u4e5f\u9700\u8981\u6539\u53d8\u5b83\u7684 \u7236\u6811\u5bf9\u8c61\u2014\u2014\u540e\u8005\u4e0d\u518d\u6307\u5411 tree CAFE7**\u4e86\uff0c\u800c\u662f\u6307\u5411\u4e86 **tree 246001\u3002\u6700\u7ec8\uff0c\u7236\u6811\u5bf9\u8c61 \u4e5f\u4f1a\u6709\u4e00\u4e2a\u65b0\u7684\u54c8\u5e0c\u503c\u3002</p> <p></p> <p>\u51e0\u4e4e\u505a\u597d\u521b\u5efa\u4e00\u4e2a\u65b0 \u63d0\u4ea4 \u5bf9\u8c61\u7684\u51c6\u5907\u4e86\uff0c\u6211\u4eec\u597d\u50cf\u4f1a\u518d\u4e00\u6b21\u4fdd\u5b58\u5f88\u591a\u7684\u6570\u636e\u2014\u2014\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u662f\u771f\u7684\u6709\u5fc5\u8981\u8fd9\u4e48\u505a\u5417\uff1f</p> <p>\u5b9e\u9645\u4e0a\uff0c\u4e00\u4e9b\u5bf9\u8c61\uff08\u5c24\u5176\u662f blob \u5bf9\u8c61\uff09\u76f8\u6bd4\u8d77\u4e4b\u524d\u7684\u63d0\u4ea4\u6765\u8bf4\u6ca1\u6709\u4efb\u4f55\u6539\u53d8\u2014\u2014blob F92A0**\u4ecd\u7136\u539f\u5c01\u4e0d\u52a8\uff0c**blob F00D1 \u4e5f\u4e00\u6837\u3002</p> <p>\u8fd9\u5c31\u662f\u5176\u4e2d\u7684\u79d8\u8bc0\u2014\u2014\u53ea\u6709\u5bf9\u8c61\u6539\u53d8\u4e86\uff0c\u6211\u4eec\u624d\u518d\u6b21\u4fdd\u5b58\u5b83\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u518d\u6b21\u4fdd\u5b58 blob F92A0 \u548c blob F00b1\u3002\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u5b83\u4eec\u7684\u54c8\u5e0c\u503c\u5f15\u7528\u5b83\u4eec\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u521b\u5efa \u63d0\u4ea4 \u5bf9\u8c61\u3002</p> <p>\u90a3\u4e9b\u6ca1\u6709\u4e1d\u6beb\u53d8\u5316\u7684 blob \u662f\u901a\u8fc7\u5b83\u4eec\u7684\u54c8\u5e0c\u503c\u88ab\u5f15\u7528\u7684</p> <p>\u7531\u4e8e\u8fd9\u6b21 \u63d0\u4ea4 \u4e0d\u662f\u7b2c\u4e00\u6b21 \u63d0\u4ea4\uff0c\u6240\u4ee5\u5b83\u6709\u4e00\u4e2a\u7236\u8282\u70b9\u2014\u2014commit A1337\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_1","title":"\u56de\u987e\u4e00\u4e0b\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86\u4e09\u79cd git \u5bf9\u8c61\uff1a","text":"<ul> <li>blob\u2014\u2014\u6587\u4ef6\u7684\u5185\u5bb9\u3002</li> <li>\u6811\u5bf9\u8c61\u2014\u2014\u4e00\u4e2a\uff08\u7531 blob \u548c \u6811\u5bf9\u8c61 \u7ec4\u6210\u7684\uff09\u76ee\u5f55\u5217\u8868\u3002</li> <li>\u63d0\u4ea4\u5bf9\u8c61\u2014\u2014\u5de5\u4f5c\u6811\u7684\u4e00\u4e2a\u5feb\u7167\u3002</li> </ul> <p>\u8ba9\u6211\u4eec\u601d\u8003\u4e00\u4e0b\u8fd9\u4e9b\u5bf9\u8c61\u7684\u54c8\u5e0c\u503c\u5427\u3002\u5982\u679c\u6211\u5199\u4e86 <code>git is awesome!</code> \u5e76\u4ece\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a blob\u3002\u4f60\u4e5f\u5728\u81ea\u5df1\u7684\u7cfb\u7edf\u4e0a\u8fd9\u4e48\u505a\uff0c\u6211\u4eec\u4f1a\u6709\u76f8\u540c\u7684\u54c8\u5e0c\u503c\u5417\uff1f</p> <p>\u7b54\u6848\u662f\u80af\u5b9a\u7684\u3002\u56e0\u4e3a\u8fd9\u4e24\u4e2a blob \u6709\u76f8\u540c\u7684\u5185\u5bb9\uff0c\u81ea\u7136\u4e5f\u4f1a\u6709\u76f8\u540c\u7684 SHA-1 \u54c8\u5e0c\u503c\u3002</p> <p>\u5982\u679c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a\u5f15\u7528 <code>git is awesome!</code> \u8fd9\u4e2a blob \u7684 \u6811\u5bf9\u8c61 \uff0c\u8d4b\u7ed9\u5b83\u4e00\u4e2a\u7279\u5b9a\u7684\u540d\u5b57\u548c\u5143\u6570\u636e\uff0c\u4f60\u4e5f\u5728\u81ea\u5df1\u7684\u7cfb\u7edf\u4e0a\u91cd\u590d\u6211\u7684\u64cd\u4f5c\u3002\u6211\u4eec\u4f1a\u6709\u76f8\u540c\u7684\u54c8\u5e0c\u503c\u5417\uff1f</p> <p>\u7b54\u6848\u8fd8\u662f\u80af\u5b9a\u7684\u3002\u56e0\u4e3a\u8fd9\u4e24\u4e2a \u6811\u5bf9\u8c61 \u662f\u76f8\u540c\u7684\uff0c\u5b83\u4eec\u4f1a\u6709\u540c\u6837\u7684\u54c8\u5e0c\u503c\u3002</p> <p>\u5982\u679c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a\u6307\u5411\u90a3\u4e2a \u6811\u5bf9\u8c61 \u7684 \u63d0\u4ea4\u5bf9\u8c61\uff0c\u63d0\u4ea4\u4fe1\u606f\u4e3a <code>Hello</code>\uff0c\u4f60\u4e5f\u5728\u81ea\u5df1\u7684\u7cfb\u7edf\u4e0a\u91cd\u590d\u4e86\u4e00\u904d\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u7ed3\u679c\u4f1a\u600e\u6837\u5462\uff1f\u6211\u4eec\u7684\u54c8\u5e0c\u503c\u8fd8\u4f1a\u76f8\u540c\u5417\uff1f</p> <p>\u8fd9\u4e2a\u65f6\u5019\u7684\u7b54\u6848\u662f\u5426\u5b9a\u7684\u3002\u5373\u4f7f\u6211\u4eec\u7684 \u63d0\u4ea4\u5bf9\u8c61 \u6307\u5411\u4e86\u76f8\u540c\u7684 \u6811\u5bf9\u8c61\uff0c\u5b83\u4eec\u4e5f\u4f1a\u6709\u4e0d\u540c\u7684 \u63d0\u4ea4\u8be6\u60c5\u2014\u2014\u65f6\u95f4\u3001\u63d0\u4ea4\u8005\uff0c\u7b49\u7b49\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_2","title":"Git \u4e2d\u7684\u5206\u652f","text":"<p>\u5206\u652f\uff08branch\uff09\u53ea\u4e0d\u8fc7\u662f\u63d0\u4ea4\u5bf9\u8c61\u7684\u547d\u540d\u5f15\u7528\u3002</p> <p>\u8bd1\u8005\u6ce8\uff1a\u5206\u652f\u5f15\u7528\u7684\u662f \u63d0\u4ea4\u5bf9\u8c61\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u4e0b\u6587\u5728\u8c08\u5206\u652f\u65f6\uff0c\u6709\u65f6\u5019\u4f1a\u5c06 \u63d0\u4ea4\u5bf9\u8c61 \u7b80\u79f0\u4e3a \u63d0\u4ea4\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4e00\u76f4\u7528 SHA-1 \u54c8\u5e0c\u503c\u5f15\u7528\u4e00\u4e2a \u63d0\u4ea4\uff0c\u4f46\u662f\u4eba\u4eec\u901a\u5e38\u559c\u6b22\u4ee5\u5176\u4ed6\u5f62\u5f0f\u547d\u540d\u5bf9\u8c61\u3002\u5206\u652f \u6070\u597d\u662f\u5f15\u7528 \u63d0\u4ea4 \u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u5b9e\u9645\u4e0a\u4e5f\u53ea\u662f\u8fd9\u6837\u3002</p> <p>\u5728\u5927\u591a\u6570\u4ed3\u5e93\u4e2d\uff0c\u4e3b\u7ebf\u5f00\u53d1\u90fd\u662f\u5728\u4e00\u4e2a\u53eb\u505a <code>master</code> \u7684\u5206\u652f\u4e0a\u5b8c\u6210\u7684\u3002<code>master</code> \u53ea\u662f\u4e00\u4e2a\u540d\u5b57\uff0c\u5b83\u662f\u5728\u6211\u4eec\u4f7f\u7528 <code>git init</code> \u547d\u4ee4\u7684\u65f6\u5019\u88ab\u521b\u5efa\u7684\u3002\u6b63\u56e0\u4e3a\u5982\u6b64\uff0c\u5b83\u88ab\u5e7f\u6cdb\u4f7f\u7528\u3002\u7136\u800c\uff0c\u5b83\u5e76\u4e0d\u7279\u522b\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4efb\u4f55\u6211\u4eec\u559c\u6b22\u7684\u540d\u5b57\u4ee3\u66ff\u5b83\u3002</p> <p>\u901a\u5e38\uff0c\u5206\u652f\u6307\u5411\u7684\u662f\u5f53\u524d\u5f00\u53d1\u7ebf\u4e0a\u7684\u6700\u8fd1\u4e00\u6b21 \u63d0\u4ea4\u3002</p> <p></p> <p>\u6211\u4eec\u901a\u5e38\u4f7f\u7528 <code>git branch</code> \u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u65b0\u5206\u652f\uff0c\u800c\u6211\u4eec\u5b9e\u9645\u521b\u5efa\u7684\u5374\u662f\u53e6\u4e00\u4e2a\u6307\u9488\uff08pointer\uff09\u3002\u5047\u8bbe\u6211\u4eec\u4f7f\u7528 <code>git branch test</code> \u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a <code>test</code> \u7684\u5206\u652f\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u521b\u5efa\u4e86\u53e6\u4e00\u4e2a\u6307\u9488\uff0c\u5b83\u6307\u5411\u5f53\u524d\u5206\u652f\u4e0a\u7684\u540c\u4e00 \u63d0\u4ea4\u3002</p> <p>\u4f7f\u7528 <code>git branch</code> \u521b\u5efa\u53e6\u4e00\u4e2a\u6307\u9488</p> <p><code>git</code> \u662f\u600e\u4e48\u77e5\u9053\u6211\u4eec\u5f53\u524d\u6240\u5728\u7684\u5206\u652f\u5462\uff1f\u7b54\u6848\u662f\u5b83\u7ef4\u62a4\u4e86\u4e00\u4e2a\u540d\u4e3a <code>HEAD</code> \u7684\u7279\u6b8a\u6307\u9488\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c<code>HEAD</code> \u4f1a\u6307\u5411\u4e00\u4e2a\u5206\u652f\uff0c\u8fd9\u4e2a\u5206\u652f\u6307\u5411\u4e00\u4e2a \u63d0\u4ea4\u3002\u6709\u65f6\u5019\uff0c<code>HEAD</code> \u4e5f\u80fd\u76f4\u63a5\u6307\u5411\u4e00\u4e2a \u63d0\u4ea4\uff0c\u4e0d\u8fc7\u8fd9\u4e0d\u662f\u6211\u4eec\u7684\u91cd\u70b9\u3002</p> <p>HEAD \u6307\u5411\u6211\u4eec\u5f53\u524d\u6240\u5728\u7684\u5206\u652f</p> <p>\u8bd1\u8005\u6ce8\uff1a\u6d3b\u52a8\u5206\u652f\uff08active branch\uff09\u6307\u7684\u662f\u6211\u4eec\u5f53\u524d\u6240\u5728\u7684\u5206\u652f\uff0c\u4e5f\u5c31\u662f <code>HEAD</code> \u6307\u5411\u7684\u5206\u652f\u3002</p> <p>\u8981\u5c06\u6d3b\u52a8\u5206\u652f\u5207\u6362\u5230 <code>test</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 <code>git checkout test</code>\u3002\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u80fd\u731c\u5230\u8fd9\u6761\u547d\u4ee4\u771f\u6b63\u505a\u7684\u4e8b\u60c5\u4e86\u2014\u2014\u5b83\u53ea\u4e0d\u8fc7\u662f\u628a <code>HEAD</code> \u6307\u5411\u7684\u5206\u652f\u6539\u6210\u4e86 <code>test</code>\u3002</p> <p><code>git checkout test</code> \u6539\u53d8 <code>HEAD</code> \u6307\u5411\u7684\u5206\u652f</p> <p>\u5728\u521b\u5efa <code>test</code> \u5206\u652f\u4e4b\u524d\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>git checkout -b test</code>\uff0c\u8fd9\u6761\u547d\u4ee4\u7b49\u4ef7\u4e8e\u5148\u8fd0\u884c <code>git branch test</code> \u521b\u5efa\u5206\u652f\uff0c\u518d\u8fd0\u884c <code>git checkout test</code> \u4f7f <code>HEAD</code> \u6307\u5411\u65b0\u7684\u5206\u652f\u3002</p> <p>\u5982\u679c\u6211\u4eec\u505a\u4e86\u4e00\u4e9b\u6539\u52a8\u5e76\u4f7f\u7528 <code>git commit</code> \u521b\u5efa\u4e86\u4e00\u4e2a\u65b0 \u63d0\u4ea4 \u5462\uff1f\u8fd9\u4e2a\u65b0 \u63d0\u4ea4 \u4f1a\u88ab\u6dfb\u52a0\u5230\u54ea\u4e2a\u5206\u652f\u4e0a\u5462\uff1f</p> <p>\u7b54\u6848\u662f <code>test</code> \u5206\u652f\uff0c\u56e0\u4e3a\u5b83\u662f\u5f53\u524d\u7684\u6d3b\u52a8\u5206\u652f\uff08\u56e0\u4e3a <code>HEAD</code> \u6307\u5411\u4e86\u5b83\uff09\u3002\u4e4b\u540e\uff0c<code>test</code>\u6307\u9488\u4f1a\u79fb\u52a8\u81f3\u65b0\u6dfb\u52a0\u7684 \u63d0\u4ea4 \u4e0a\u3002\u6ce8\u610f <code>HEAD</code> \u4ecd\u7136\u6307\u5411 <code>test</code>\u3002</p> <p>\u6bcf\u6b21\u6267\u884c <code>git commit</code> \u547d\u4ee4\u90fd\u4f1a\u8ba9\u5206\u652f\u7684\u6307\u9488\u79fb\u52a8\u5230\u65b0\u521b\u5efa\u7684\u63d0\u4ea4\u4e0a</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>git checkout master</code> \u56de\u5230 master \u5206\u652f\uff0c\u6211\u4eec\u5c31\u8ba9 <code>HEAD</code> \u7684\u518d\u6b21\u6307\u5411 <code>master</code> \u4e86\u3002</p> <p></p> <p>\u5982\u679c\u6211\u4eec\u73b0\u5728\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 \u63d0\u4ea4\uff0c\u5b83\u5c31\u4f1a\u88ab\u6dfb\u52a0\u5230 <code>master</code> \u5206\u652f\uff0ccommit B2424 \u4f1a\u6210\u4e3a\u65b0\u63d0\u4ea4\u7684\u7236\u8282\u70b9\u3002</p> <p></p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_3","title":"\u5982\u4f55\u5728 Git \u4e2d\u8bb0\u5f55\u53d8\u5316","text":"<p>\u901a\u5e38\uff0c\u6211\u4eec\u5728 \u5de5\u4f5c\u76ee\u5f55\uff08working dir\uff09 \u4e2d\u7f16\u5199\u6e90\u4ee3\u7801\u3002\u5de5\u4f5c\u76ee\u5f55 \uff08\u6216 \u5de5\u4f5c\u6811\uff08working tree\uff09\uff09\u53ef\u4ee5\u662f\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u4efb\u4f55\u4e00\u4e2a\u76ee\u5f55\uff0c\u5b83\u5173\u8054\u7740\u4e00\u4e2a \u4ed3\u5e93\uff08repository\uff09 \u3002\u76ee\u5f55\u5185\u4e0d\u4ec5\u5305\u542b\u5de5\u7a0b\u7684\u6587\u4ef6\u5939\u548c\u6587\u4ef6\uff0c\u8fd8\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>.git</code> \u7684\u76ee\u5f55\u3002\u7a0d\u540e\u6211\u4eec\u4f1a\u518d\u8ba8\u8bba <code>git</code> \u8fd9\u4e2a\u76ee\u5f55\u3002</p> <p>\u5728\u505a\u4e86\u4e00\u4e9b\u6539\u52a8\u4e4b\u540e\uff0c\u6211\u4eec\u60f3\u628a\u8fd9\u4e9b\u6539\u52a8\u8bb0\u5f55\u5230\u6211\u4eec\u7684 \u4ed3\u5e93 \u4e2d\u3002\u4e00\u4e2a \u4ed3\u5e93 \uff08\u7f29\u5199\uff1arepo\uff09\u5c31\u662f\u4e00\u7cfb\u5217 \u63d0\u4ea4 \u7684\u96c6\u5408\uff0c\u6bcf\u4e2a \u63d0\u4ea4 \u90fd\u662f\u5de5\u7a0b \u5de5\u4f5c\u6811 \u7684\u5f52\u6863\u3002\u9664\u4e86\u6211\u4eec\u81ea\u5df1\u673a\u5668\u4e0a\u7684\u63d0\u4ea4\u5916\uff0c\u4ed3\u5e93\u4e5f\u4f1a\u5305\u542b\u4ed6\u4eba\u673a\u5668\u4e0a\u7684\u63d0\u4ea4\u3002</p> <p>\u4ed3\u5e93 \u4e5f\u5305\u542b\u9664\u4ee3\u7801\u6587\u4ef6\u4ee5\u5916\u7684\u5176\u5b83\u4e1c\u897f\uff0c\u4f8b\u5982 <code>HEAD</code> \u6307\u9488\u3001\u5206\u652f\u7b49\u7b49\u3002</p> <p></p> <p>\u4f60\u53ef\u80fd\u4f7f\u7528\u8fc7\u7684\u5176\u5b83\u548c <code>git</code> \u7c7b\u4f3c\u5de5\u5177\uff0c\u4f46\u662f <code>git</code> \u5e76\u4e0d\u4f1a\u50cf\u5176\u5b83\u5de5\u5177\u90a3\u6837\u76f4\u63a5\u5c06\u53d8\u5316\u4ece \u5de5\u4f5c\u6811 \u63d0\u4ea4\u5230 \u4ed3\u5e93\u3002\u76f8\u53cd\uff0c\u5b83\u4f1a\u5148\u628a\u8fd9\u4e9b\u53d8\u5316\u6ce8\u518c\u5230\u4e00\u4e2a\u88ab\u79f0\u4e3a \u7d22\u5f15\uff08index\uff09 \u6216 \u6682\u5b58\u533a\uff08staging area\uff09 \u7684\u5730\u65b9\u3002</p> <p>\u8fd9\u4e24\u4e2a\u672f\u8bed\u6307\u7684\u90fd\u662f\u540c\u4e00\u4e2a\u4e1c\u897f\uff0c\u5b83\u4eec\u4e5f\u7ecf\u5e38\u88ab <code>git</code> \u7684\u6587\u6863\u4f7f\u7528\uff0c\u6211\u4eec\u5c06\u4f1a\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u4ea4\u66ff\u4f7f\u7528\u5b83\u4eec\u3002</p> <p>\u5f53\u6211\u4eec <code>checkout</code> \u5230\u4e00\u4e2a\u5206\u652f\u65f6\uff0c<code>git</code> \u4f1a\u5c06\u4e0a\u4e00\u6b21\u68c0\u51fa\u5230\u5de5\u4f5c\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u586b\u5145\u5230 \u7d22\u5f15\uff0c\u5b83\u4eec\u770b\u8d77\u6765\u5c31\u50cf\u6700\u521d\u88ab\u68c0\u51fa\u65f6\u7684\u6837\u5b50\u3002\u4e4b\u540e\u6267\u884c <code>git commit</code> \u65f6\uff0c \u63d0\u4ea4 \u4f1a\u5728\u5f53\u524d \u7d22\u5f15 \u7684\u57fa\u7840\u4e0a\u521b\u5efa\u3002</p> <p>\u7d22\u5f15 \u5141\u8bb8\u6211\u4eec\u7cbe\u5fc3\u51c6\u5907\u6bcf\u6b21 \u63d0\u4ea4\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u81ea\u4e0a\u4e00\u6b21 \u63d0\u4ea4 \u4ee5\u6765\uff0c\u6211\u4eec\u7684 \u5de5\u4f5c\u76ee\u5f55**\u4e2d\u53ef\u80fd\u6709\u4e24\u4e2a\u6587\u4ef6\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u80fd\u53ea\u60f3\u5c06\u5176\u4e2d\u7684\u4e00\u4e2a\u6dfb\u52a0\u5230 **\u7d22\u5f15\uff08\u4f7f\u7528 <code>git add</code>\uff09\uff0c\u7136\u540e\u4f7f\u7528 <code>git commit</code> \u8bb0\u5f55\u8fd9\u4e00\u4e2a\u6587\u4ef6\u7684\u53d8\u5316\u3002</p> <p></p> <p>\u5de5\u4f5c\u76ee\u5f55 \u4e0b\u6587\u4ef6\u7684\u72b6\u6001\u4e0d\u5916\u4e4e\u6709\u4e24\u79cd\uff1a\u5df2\u8ddf\u8e2a\uff08tracked\uff09 \u6216 \u672a\u8ddf\u8e2a\uff08untracked\uff09\u3002</p> <p>\u5df2\u8ddf\u8e2a\u6587\u4ef6 \u662f\u6307\u90a3\u4e9b <code>git</code> \u5df2\u7ecf\u77e5\u9053\u7684\u6587\u4ef6\u3002\u5b83\u4eec\u8981\u4e48\u5df2\u7ecf\u5728\u4e0a\u4e00\u6b21\u5feb\u7167\uff08\u63d0\u4ea4\uff09\u4e2d\uff0c\u8981\u4e48\u5df2\u7ecf\u88ab \u6682\u5b58\uff08staged\uff09\uff08\u6362\u53e5\u8bdd\u8bf4\uff0c\u5b83\u4eec\u5df2\u7ecf\u5728 \u6682\u5b58\u533a \u4e2d\uff09\u3002</p> <p>\u5de5\u4f5c\u76ee\u5f55 \u4e2d\u9664\u5df2\u8ddf\u8e2a\u6587\u4ef6\u4ee5\u5916\u7684\u6240\u6709\u5176\u5b83\u6587\u4ef6\u90fd\u5c5e\u4e8e \u672a\u8ddf\u8e2a\u6587\u4ef6\uff08untracked\uff09\uff0c\u5b83\u4eec\u65e2\u6ca1\u6709\u5728\u4e0a\u6b21\u5feb\u7167\uff08\u63d0\u4ea4\uff09\u4e2d\uff0c\u4e5f\u6ca1\u6709\u5728 \u6682\u5b58\u533a \u4e2d\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_2","title":"\u521b\u5efa\u4ed3\u5e93\u7684\u5e38\u89c4\u65b9\u5f0f","text":"<p>\u8ba9\u6211\u4eec\u786e\u8ba4\u4e0b\u6211\u4eec\u5df2\u7ecf\u7406\u89e3\u4e86\u201c\u521b\u5efa**\u4ed3\u5e93**\u201d\u65f6\u4ecb\u7ecd\u7684\u76f8\u5173\u672f\u8bed\u3002\u5728\u6211\u4eec\u66f4\u52a0\u6df1\u5165\u8fd9\u4e2a\u8fc7\u7a0b\u4e4b\u524d\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u975e\u5e38\u9ad8\u9636\u7684\u89c6\u89d2\u3002</p> <p>\u6211\u4eec\u7528 <code>git init repo_1</code> \u521d\u59cb\u5316\u4e00\u4e2a\u65b0\u7684 \u4ed3\u5e93\uff0c\u7136\u540e\u7528 <code>cd repo_1</code> \u5207\u6362\u5230\u4ed3\u5e93\u6240\u5728\u76ee\u5f55\u3002\u501f\u52a9 <code>tree .git</code> \u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd0\u884c <code>git init</code> \u4e4b\u540e <code>.git</code> \u76ee\u5f55\u4e0b\u9762\u51fa\u73b0\u4e86\u5f88\u591a\u5b50\u76ee\u5f55\uff08<code>/f</code> \u8868\u793a\u5728 <code>tree</code> \u7684\u8f93\u51fa\u4e2d\u5305\u542b\u6587\u4ef6\uff09\u3002</p> <pre><code>$ tree .git\n\u251c\u2500\u2500 HEAD\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 description\n\u251c\u2500\u2500 hooks\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 applypatch-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 commit-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 fsmonitor-watchman.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 post-update.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-applypatch.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-commit.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-merge-commit.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-push.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-rebase.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-receive.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 prepare-commit-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 push-to-checkout.sample\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 update.sample\n\u251c\u2500\u2500 info\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 exclude\n\u251c\u2500\u2500 objects\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 info\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 pack\n\u2514\u2500\u2500 refs\n    \u251c\u2500\u2500 heads\n    \u2514\u2500\u2500 tags\n\n9 directories, 17 files\n</code></pre> <p>\u8ba9\u6211\u4eec\u5728 <code>repo_1</code> \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u5427\uff1a</p> <pre><code>echo \"hello\" &gt; new_file.txt\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5df2\u7ecf\u5728\u6211\u4eec\u7684 \u5de5\u4f5c\u76ee\u5f55 \u4e2d\u4e86\u3002\u76ee\u524d\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u5c06\u5b83\u6dfb\u52a0\u5230 \u6682\u5b58\u533a\uff0c\u6240\u4ee5\u5b83\u662f \u672a\u8ddf\u8e2a \u72b6\u6001\u3002\u8ba9\u6211\u4eec\u7528 <code>git status</code> \u9a8c\u8bc1\u4e00\u4e0b\uff1a</p> <pre><code>$ git status\nOn branch master\n\nNo commits yet\n\nUntracked files:\n  (use \"git add &lt;file&gt;...\" to include in what will be committed)\n    new_file.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u5c06\u65b0\u7684\u6587\u4ef6\u6dfb\u52a0\u5230\u6682\u5b58\u533a\uff0c\u6240\u4ee5\u5b83\u8fd8\u662f\u672a\u8ddf\u8e2a\u72b6\u6001\uff0c\u5b83\u4e5f\u6ca1\u6709\u5728\u4e4b\u524d\u7684\u63d0\u4ea4\u4e2d</p> <p>\u6211\u4eec\u73b0\u5728\u7528 <code>git add new_file.txt</code> \u5c06\u8fd9\u4e2a\u6587\u4ef6\u6dfb\u52a0\u5230 \u6682\u5b58\u533a\uff0c\u518d\u7528 <code>git status</code> \u9a8c\u8bc1\u4e00\u4e0b\u5b83\u662f\u5426\u5df2\u7ecf\u88ab\u6682\u5b58\u4e86\uff1a</p> <pre><code>$ git add new_file.txt\n$ git status\nOn branch master\n\nNo commits yet\n\nChanges to be committed:\n  (use \"git rm --cached &lt;file&gt;...\" to unstage)\n    new file:   new_file.txt\n</code></pre> <p>\u6dfb\u52a0\u65b0\u7684\u6587\u4ef6\u5230\u6682\u5b58\u533a</p> <p>\u6211\u4eec\u53ef\u73b0\u5728\u53ef\u4ee5\u7528 <code>git commit</code> \u521b\u5efa\u4e00\u4e2a \u63d0\u4ea4\uff1a</p> <pre><code>$ git commit -m \"First commit\"\n[master (root-commit) 52ad6ff] First commit\n 1 file changed, 1 insertion(+)\n create mode 100644 new_file.txt\n</code></pre> <p><code>.git</code> \u76ee\u5f55\u6709\u53d8\u5316\u5417\uff1f\u6211\u4eec\u7528 <code>tree .git</code> \u68c0\u67e5\u4e00\u4e0b\uff1a</p> <pre><code>$ tree .git\n.git\n\u251c\u2500\u2500 COMMIT_EDITMSG\n\u251c\u2500\u2500 HEAD\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 description\n\u251c\u2500\u2500 hooks\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 applypatch-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 commit-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 fsmonitor-watchman.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 post-update.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-applypatch.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-commit.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-merge-commit.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-push.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-rebase.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pre-receive.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 prepare-commit-msg.sample\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 push-to-checkout.sample\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 update.sample\n\u251c\u2500\u2500 index\n\u251c\u2500\u2500 info\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 exclude\n\u251c\u2500\u2500 logs\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 HEAD\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 refs\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 heads\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 master\n\u251c\u2500\u2500 objects\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 52\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ad6ffd4cd89c9faac6a8ac441fb77334dc5e32\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ce\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 013625030ba8dba906f756967f9e9ca394464a\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ef\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 313b9746f3ce70818bd76a627e61bb43053e0e\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 info\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 pack\n\u2514\u2500\u2500 refs\n    \u251c\u2500\u2500 heads\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 master\n    \u2514\u2500\u2500 tags\n\n15 directories, 25 files\n</code></pre> <p><code>git</code> \u76ee\u5f55\u4e2d\u7684\u5f88\u591a\u4e1c\u897f\u5df2\u7ecf\u53d8\u4e86</p> <p>\u5f88\u660e\u663e\uff0c\u5f88\u591a\u4e1c\u897f\u90fd\u53d8\u4e86\u3002\u662f\u65f6\u5019\u6df1\u5165 <code>.git</code> \u7684\u7ed3\u6784\uff0c\u7406\u89e3\u6267\u884c <code>git init</code>\u3001<code>git add</code> \u6216 <code>git commit</code> \u4e4b\u540e\u53d1\u751f\u7684\u4ec0\u4e48\u4e8b\u60c5\u4e86\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_3","title":"\u662f\u65f6\u5019\u4e0a\u5e72\u8d27\u4e86","text":"<p>\u76ee\u524d\u6211\u4eec\u5df2\u7ecf\u8bb2\u4e86\u4e00\u4e9b Git \u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u73b0\u5728\u5df2\u7ecf\u505a\u597d Git \u4e0a\u8def \u7684\u51c6\u5907\u4e86\u3002</p> <p>\u4e3a\u4e86\u6df1\u5165\u7406\u89e3 <code>git</code> \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u6211\u4eec\u5c06\u4ece\u96f6\u5f00\u59cb\u521b\u5efa\u4e00\u4e2a \u4ed3\u5e93\u3002</p> <p>\u6211\u4eec\u4e0d\u4f1a\u4f7f\u7528 <code>git init</code>\u3001<code>git add</code> \u6216 <code>git commit</code>\uff0c\u8fd9\u4f1a\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u7406\u89e3\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_4","title":"\u5982\u4f55\u8bbe\u7f6e <code>.git</code>","text":"<p>\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u76ee\u5f55\uff0c\u7136\u540e\u5728\u91cc\u9762\u8fd0\u884c <code>git status</code>\uff1a</p> <pre><code>$ mkdir repo_2\n$ cd repo_2\n$ git status\nfatal: not a git repository (or any of the parent directories): .git\n</code></pre> <p>\u597d\u5427\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709 <code>.git</code> \u6587\u4ef6\u5939\uff0c<code>git</code> \u597d\u50cf\u4e0d\u600e\u4e48\u9ad8\u5174\u3002\u6211\u4eec\u5148\u628a\u8fd9\u4e2a\u76ee\u5f55\u521b\u5efa\u51fa\u6765\uff1a</p> <pre><code>$ mkdir .git\n$ git status\nfatal: not a git repository (or any of the parent directories): .git\n</code></pre> <p>\u5f88\u660e\u663e\uff0c\u53ea\u521b\u5efa\u4e00\u4e2a <code>.git</code> \u76ee\u5f55\u8fd8\u4e0d\u591f\u3002\u6211\u4eec\u9700\u8981\u5f80\u8fd9\u4e2a\u76ee\u5f55\u6dfb\u52a0\u4e00\u4e9b\u4e1c\u897f\u3002</p> <p>\u4e00\u4e2a git \u4ed3\u5e93\u6709\u4e24\u4e2a\u4e3b\u8981\u7ec4\u6210\u90e8\u5206\uff1a</p> <ol> <li>\u4e00\u7ec4\u5bf9\u8c61\u2014\u2014blob\u3001\u6811\u5bf9\u8c61 \u548c \u63d0\u4ea4\u5bf9\u8c61\u3002</li> <li>\u4e00\u4e2a\u547d\u540d\u8fd9\u4e9b\u5bf9\u8c61\u7684\u65b9\u5f0f\u2014\u2014\u79f0\u4e3a \u5f15\u7528\u3002</li> </ol> <p>\u8bd1\u8005\u6ce8\uff1a\u5f15\u7528\u662f Git \u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\uff0c\u8bfb\u8005\u53ef\u4ee5\u8fdb\u4e00\u6b65\u9605\u8bfb Git \u5f15\u7528\u3002</p> <p>\u4e00\u4e2a \u4ed3\u5e93 \u53ef\u80fd\u8fd8\u5305\u542b\u4e00\u4e9b\u5176\u5b83\u7684\u4e1c\u897f\uff0c\u6bd4\u5982 git \u94a9\u5b50\uff08hooks\uff09\u3002\u4e0d\u8fc7\uff0c\u4ed3\u5e93\u81f3\u5c11\u5fc5\u987b\u8981\u6709\u5bf9\u8c61\u548c\u5f15\u7528\u3002</p> <p>\u8ba9\u6211\u4eec\u5206\u522b\u4e3a\u5bf9\u8c61\u548c\u5f15\u7528\uff08\u7b80\u79f0\uff1arefs\uff09\u5404\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\uff0c\u5206\u522b\u4e3a <code>.git/objects</code> \u548c <code>.git/refs</code>\u3002</p> <pre><code>$ mkdir .git/{objects,refs}\n$ tree .git\n.git\n\u251c\u2500\u2500 objects\n\u2514\u2500\u2500 refs\n\n3 directories, 0 files\n</code></pre> <p>\u5206\u652f \u662f\u5f15\u7528\u7684\u4e00\u79cd\uff0c<code>git</code> \u5185\u90e8\u5c06 \u5206\u652f \u79f0\u4e3a heads\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u4e3a\u5b83\u4eec\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55 <code>git/refs/heads</code>\u3002</p> <pre><code>$ mkdir .git/refs/heads\n$ tree .git\n.git\n\u251c\u2500\u2500 objects\n\u2514\u2500\u2500 refs\n    \u2514\u2500\u2500 heads\n\n4 directories, 0 files\n</code></pre> <p>\u7136\u800c <code>git status</code> \u7684\u8f93\u51fa\u8fd8\u662f\u7eb9\u4e1d\u4e0d\u52a8\uff1a</p> <pre><code>$ git status\nfatal: not a git repository (or any of the parent directories): .git\n</code></pre> <p>\u5728\u5bfb\u627e \u4ed3\u5e93 \u4e2d\u7684 \u63d0\u4ea4 \u65f6\uff0c<code>git</code> \u600e\u4e48\u77e5\u9053\u8be5\u4ece\u4f55\u5f00\u59cb\u5462\uff1f\u6211\u4e4b\u524d\u89e3\u91ca\u8fc7\uff0c\u5b83\u4f1a\u5bfb\u627e <code>HEAD</code>\uff0c\u800c <code>HEAD</code> \u6307\u5411\u7740\u6d3b\u52a8\u5206\u652f\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u521b\u5efa <code>HEAD</code>\uff0c\u5b83\u662f\u4e00\u4e2a\u4f4d\u4e8e <code>.git/HEAD</code> \u7684\u6587\u4ef6\uff1a<code>$ echo \"ref: refs/heads/master\" &gt; .git/HEAD</code></p> <p>\u2b50 \u6240\u4ee5\u6211\u4eec\u73b0\u5728\u77e5\u9053 <code>HEAD</code> \u662f\u5982\u4f55\u5b9e\u73b0\u7684\u4e86\u2014\u2014\u5b83\u53ea\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u63cf\u8ff0\u4e86\u5b83\u6240\u6307\u5411\u7684\u5206\u652f\u3002</p> <p>\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u4ee5\u540e\uff0c<code>git status</code> \u4f3c\u4e4e\u6539\u53d8\u5b83\u7684\u4e3b\u610f\u4e86\uff1a</p> <pre><code>$ echo \"ref: refs/heads/master\" &gt; .git/HEAD\n$ git status\nOn branch master\n\nNo commits yet\n\nnothing to commit (create/copy files and use \"git add\" to track)\n</code></pre> <p>HEAD \u53ea\u4e0d\u8fc7\u662f\u4e00\u4e2a\u6587\u4ef6</p> <p>\u6ce8\u610f\uff1a\u867d\u7136\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa <code>master</code> \u5206\u652f\uff0c\u4f46\u662f <code>git</code> \u76f8\u4fe1\u6211\u4eec\u5c31\u5728\u8fd9\u4e2a\u5206\u652f\u4e0a\u3002\u4e4b\u524d\u6709\u8bb2\u8fc7\uff0c<code>master</code>\u53ea\u662f\u4e00\u4e2a\u540d\u5b57\u3002\u5982\u679c\u6211\u4eec\u60f3\u7684\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u8ba9 <code>git</code> \u8ba4\u4e3a\u6211\u4eec\u5728 <code>banana</code> \u5206\u652f\u4e0a\uff1a</p> <pre><code>$ echo 'ref: refs/heads/banana' &gt; .git/HEAD\n$ git status\nOn branch banana\n\nNo commits yet\n\nnothing to commit (create/copy files and use \"git add\" to track)\n</code></pre> <p>\u6309\u7167\u60ef\u4f8b\uff0c\u6211\u4eec\u5c06\u5728\u672c\u6587\u7684\u5269\u4f59\u90e8\u5206\u4e2d\u5207\u56de <code>master</code> \u5206\u652f\u3002</p> <p>\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u4e86 <code>git</code> \u76ee\u5f55\uff0c\u73b0\u5728\u7ee7\u7eed\u5f80\u4e0b\uff0c\u6765\u4e00\u6b21 \u63d0\u4ea4\uff08\u540c\u6837\u5730\uff0c\u4e0d\u4f7f\u7528 <code>git add</code> \u6216 <code>git commit</code>\uff09\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_5","title":"Git \u4e2d\u7684\u5e95\u5c42\u547d\u4ee4\u4e0e\u4e0a\u5c42\u547d\u4ee4","text":"<p>\u8fd9\u4e2a\u65f6\u5019\uff0c\u533a\u5206 \u5e95\u5c42\uff08plumbing\uff09 \u548c \u4e0a\u5c42\uff08poreclain\uff09 \u4e24\u7c7b <code>git</code> \u547d\u4ee4\u4f1a\u5bf9\u4f60\u5f88\u6709\u5e2e\u52a9\u3002\u8fd9\u4e24\u4e2a\u672f\u8bed\u7684\u5e94\u7528\u5947\u602a\u5730\u6765\u81ea\u4e8e\u9a6c\u6876\uff08\u6ca1\u9519\uff0c\u5c31\u662f\ud83d\udebd\uff09\u3002\u9a6c\u6876\u901a\u5e38\u662f\u7528\u9676\u74f7\uff08porcelain\uff09\u505a\u7684\uff0c\u5b83\u7684\u57fa\u672c\u7ed3\u6784\u662f\u7ba1\u9053\uff08plumbing\uff0c\u4e0a\u6c34\u9053\u548c\u4e0b\u6c34\u9053\uff09\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8bf4\u4e0a\u5c42\u547d\u4ee4\u4e3a\u5e95\u5c42\u547d\u4ee4\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u6237\u53cb\u597d\u7684\u63a5\u53e3\u3002\u5927\u591a\u6570\u4eba\u53ea\u4f1a\u6d89\u53ca\u5230\u4e0a\u5c42\u547d\u4ee4\u3002\u7136\u800c\uff0c\u5f53\u4e8b\u60c5\u53d8\u5f97\uff08\u975e\u5e38\uff09\u7cdf\u7cd5\u65f6\uff0c\u6709\u4eba\u53ef\u80fd\u5c31\u4f1a\u60f3\u77e5\u9053\u4e3a\u4ec0\u4e48\uff0c\u4ed6\u4eec\u4f1a\u5377\u8d77\u8896\u5b50\u53bb\u68c0\u67e5\u5e95\u5c42\u547d\u4ee4\u3002\uff08\u6ce8\u610f\uff1a\u8fd9\u4e9b\u672f\u8bed\u5e76\u4e0d\u662f\u6211\u53d1\u660e\u7684\uff0c\u5b83\u4eec\u5728 <code>git</code> \u4e2d\u7684\u4f7f\u7528\u975e\u5e38\u5e7f\u6cdb\uff09\u3002</p> <p>\u8bd1\u8005\u6ce8\uff1a\u8bfb\u8005\u82e5\u60f3\u66f4\u597d\u7684\u7406\u89e3\u8fd9\u4e24\u4e2a\u672f\u8bed\uff0c\u5efa\u8bae\u9605\u8bfb Git \u5185\u90e8\u539f\u7406 - \u5e95\u5c42\u547d\u4ee4\u4e0e\u4e0a\u5c42\u547d\u4ee4\u3002</p> <p><code>git</code> \u4f7f\u7528\u8fd9\u4e9b\u672f\u8bed\u8fdb\u884c\u7c7b\u6bd4\uff0c\u4ece\u800c\u5c06\u7528\u6237\u4e0d\u5e38\u4f7f\u7528\u7684\u5e95\u5c42\u547d\u4ee4\uff08plumbing\uff09\u548c\u90a3\u4e9b\u66f4\u53cb\u597d\u7684\u9ad8\u5c42\uff08porcelain\uff09\u547d\u4ee4\u533a\u5206\u5f00\u3002</p> <p>\u76ee\u524d\uff0c\u6211\u4eec\u5df2\u7ecf\u63a5\u89e6\u8fc7\u4e0a\u5c42\u547d\u4ee4\u2014\u2014<code>git init</code>\u3001<code>git add</code> \u548c <code>git commit</code>\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u8f6c\u5230\u5e95\u5c42\u547d\u4ee4\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_4","title":"\u5982\u4f55\u521b\u5efa\u5bf9\u8c61","text":"<p>\u8ba9\u6211\u4eec\u4ece\u521b\u5efa\u5bf9\u8c61\u5e76\u5c06\u5176\u5199\u5165 <code>git</code> \u7684\u5bf9\u8c61\u6570\u636e\u5e93\u5f00\u59cb\u5427\uff0c<code>git</code> \u7684\u5bf9\u8c61\u6570\u636e\u5e93\u4f4d\u4e8e <code>.git/objects</code> \u4e2d\u3002\u7b2c\u4e00\u6761\u5e95\u5c42\u547d\u4ee4 <code>git hash-object</code> \u4f1a\u8ba9\u6211\u4eec\u5c06\u627e\u5230 **blob \u5bf9\u8c61**\u7684 SHA-1 \u54c8\u5e0c\u503c\u3002\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>$ echo \"git is awesome\" | git hash-object --stdin\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528 <code>--stdin</code> \u544a\u77e5 <code>git hash-object</code> \u4ece\u6807\u51c6\u8f93\u5165\uff08standard input\uff09\u83b7\u53d6\u8f93\u5165\u5185\u5bb9\uff0c\u8fd9\u5c06\u7ed9\u6211\u4eec\u63d0\u4f9b\u76f8\u5e94\u7684\u54c8\u5e0c\u503c\u3002</p> <p>\u4e3a\u4e86\u771f\u7684\u5c06\u8be5 blob \u5bf9\u8c61 \u5199\u5165 <code>git</code> \u7684\u5bf9\u8c61\u6570\u636e\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u7ed9 <code>git hash-object</code> \u52a0\u4e00\u4e2a <code>-w</code> \u5f00\u5173\u3002\u7136\u540e\uff0c\u68c0\u67e5 <code>.git</code> \u76ee\u5f55\u4e2d\u7684\u5185\u5bb9\uff0c\u770b\u770b\u5b83\u4eec\u6709\u6ca1\u6709\u6539\u53d8\u3002</p> <pre><code>$ echo \"git is awesome\" | git hash-object --stdin\n118f108d76b16a058db9fcb385a5fd640b54e47a\n$ echo \"git is awesome\" | git hash-object --stdin -w\n118f108d76b16a058db9fcb385a5fd640b54e47a\n$ tree .git\n.git\n\u251c\u2500\u2500 HEAD\n\u251c\u2500\u2500 objects\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 11\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 8f108d76b16a058db9fcb385a5fd640b54e47a\n\u2514\u2500\u2500 refs\n    \u2514\u2500\u2500 heads\n\n5 directories, 2 files\n</code></pre> <p>\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a blob \u7684\u54c8\u5e0c\u503c\u4e3a <code>118f...7a</code>\uff0c <code>.git/objects</code> \u4e0b\u4e5f\u591a\u51fa\u6765\u4e86\u4e00\u4e2a\u540d\u4e3a <code>11</code> \u7684\u76ee\u5f55\uff0c\u76ee\u5f55\u5185\u6709\u4e00\u4e2a\u540d\u4e3a <code>8f..7a</code> \u7684\u6587\u4ef6\u3002</p> <p>\u6240\u4ee5\uff0c<code>git</code> \u5b9e\u9645\u4e0a\u662f\u4f7f\u7528 SHA-1 \u54c8\u5e0c\u503c\u7684\u524d\u4e24\u4e2a\u5b57\u7b26\u4f5c\u4e3a\u76ee\u5f55\u7684\u540d\u5b57\uff0c\u5269\u4f59\u5b57\u7b26\u7528\u4f5c blob \u6240\u5728\u6587\u4ef6\u7684\u6587\u4ef6\u540d\u3002</p> <p>\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u5462\uff1f\u8003\u8651\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u4ed3\u5e93\uff0c\u4ed3\u5e93\u7684\u6570\u636e\u5e93\u5185\u5b58\u6709\u4e09\u5341\u4e07\u4e2a\u5bf9\u8c61\uff08blob \u5bf9\u8c61\u3001\u6811\u5bf9\u8c61 \u548c \u63d0\u4ea4\u5bf9\u8c61\uff09\u3002\u4ece\u8fd9\u4e09\u5341\u4e07\u4e2a\u54c8\u5e0c\u503c\u4e2d\u627e\u51fa\u4e00\u4e2a\u503c\u4f1a\u82b1\u4e9b\u65f6\u95f4\uff0c\u56e0\u6b64\uff0c<code>git</code> \u5c06\u8fd9\u4e2a\u95ee\u9898\u5212\u5206\u6210\u4e86 256 \u4efd\u3002</p> <p>\u4e3a\u4e86\u67e5\u627e\u4e0a\u9762\u7684\u90a3\u4e2a\u54c8\u5e0c\u503c\uff0c<code>git</code> \u4f1a\u5148\u5bfb\u627e <code>.git/objects</code> \u76ee\u5f55\u4e0b\u540d\u4e3a <code>11</code> \u7684\u76ee\u5f55\uff0c\u7136\u540e\u641c\u7d22\u90a3\u4e2a\u76ee\u5f55\uff0c\u8fd9\u8fdb\u4e00\u6b65\u7f29\u5c0f\u4e86\u641c\u7d22\u8303\u56f4\u3002<code>.git/objects</code> \u76ee\u5f55\u4e0b\u6700\u591a\u53ef\u80fd\u4f1a\u6709 256 \u4e2a\u5b50\u76ee\u5f55\uff08\u4ece <code>00</code> \u5230 <code>FF</code>\uff09\u3002</p> <p>\u56de\u5230\u751f\u6210 \u63d0\u4ea4\u5bf9\u8c61 \u7684\u8fc7\u7a0b\u4e2d\u6765\uff0c\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u521b\u5efa\u4e86\u4e00\u4e2a\u5bf9\u8c61\uff0c\u5b83\u7684\u7c7b\u578b\u662f\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u53e6\u4e00\u4e2a\u5e95\u5c42\u547d\u4ee4 <code>git cat-file -t</code> \uff08<code>-t</code> \u4ee3\u8868 'type'\uff09\u77a7\u4e00\u77a7\uff1a</p> <pre><code>$ git cat-file -t 118f108d76b16a058db9fcb385a5fd640b54e47a\nblob\n</code></pre> <p>\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684 SHA-1 \u503c\u662f <code>118f108d76b16a058db9fcb385a5fd640b54e47a</code>\uff0c\u800c\u4e0d\u662f\u5728 <code>tree</code> \u547d\u4ee4\u770b\u5230\u7684 <code>8f108d76b16a058db9fcb385a5fd640b54e47a</code>\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u540e\u8005\uff0c\u4f1a\u5f97\u5230\u4e0b\u9762\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>$ git cat-file -t 8f108d76b16a058db9fcb385a5fd640b54e47a\nfatal: Not a valid object name 8f108d76b16a058db9fcb385a5fd640b54e47a\n</code></pre> <p>\u4e0d\u51fa\u6240\u6599\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u662f\u4e00\u4e2a blob\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>git cat-file -p</code> \uff08<code>-p</code> \u4ee3\u8868 'pretty-print'\uff09\u67e5\u770b\u5b83\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ git cat-file -p 118f108d76b16a058db9fcb385a5fd640b54e47a\ngit is awesome\n</code></pre> <p>\u521b\u5efa blob \u8fd9\u4e2a\u8fc7\u7a0b\u901a\u5e38\u53d1\u751f\u5728\u6211\u4eec\u5c06\u4e00\u4e9b\u4e1c\u897f\u6dfb\u52a0\u5230 \u6682\u5b58\u533a \u7684\u65f6\u5019\u2014\u2014\u4e5f\u5c31\u662f\u6211\u4eec\u4f7f\u7528 <code>git add</code> \u7684\u65f6\u5019\u3002</p> <p>\u8bb0\u4f4f\uff1a<code>git</code> \u662f\u4e3a \u6574\u4e2a \u6682\u5b58\u7684\u6587\u4ef6\u521b\u5efa blob\u3002\u5373\u4f7f\u6587\u4ef6\u4e2d\u53ea\u6709\u4fee\u6539\u6216\u6dfb\u52a0\u4e86\u4e00\u4e2a\u5b57\u7b26\uff08\u5982\u540c\u6211\u4eec\u5728\u4e4b\u524d\u7684\u4f8b\u5b50\u7ea2\u6dfb\u52a0 <code>!</code> \u4e00\u6837\uff09\uff0c\u8be5\u6587\u4ef6\u4e5f\u4f1a\u6709\u4e00\u4e2a\u65b0\u7684 blob\uff0c\u8fd9\u4e2a **blob**\u6709\u7740\u65b0\u7684\u54c8\u5e0c\u503c\u3002</p> <p><code>git status</code> \u4f1a\u6709\u4efb\u4f55\u6539\u53d8\u5417\uff1f</p> <pre><code>$ git status\nOn branch master\n\nNo commits yet\n\nnothing to commit (create/copy files and use \"git add\" to track)\n</code></pre> <p>\u663e\u7136\u6ca1\u6709\u3002\u5411 <code>git</code> \u7684\u5185\u90e8\u6570\u636e\u5e93\u4e2d\u6dfb\u52a0\u4e00\u4e2a blob \u5bf9\u8c61\u5e76\u4e0d\u4f1a\u6539\u53d8\u72b6\u6001\uff0c\u56e0\u4e3a <code>git</code> \u5728\u8fd9\u4e2a\u9636\u6bb5\u662f\u4e0d\u77e5\u9053\u4efb\u4f55\u5df2\u8ddf\u8e2a\u6216\u672a\u8ddf\u8e2a\u6587\u4ef6\u7684\u3002</p> <p>\u6211\u4eec\u9700\u8981\u8ddf\u8e2a\u8fd9\u4e2a\u6587\u4ef6\u2014\u2014\u628a\u5b83\u6dfb\u52a0\u5230 \u6682\u5b58\u533a\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5e95\u5c42\u547d\u4ee4 <code>git update-index</code>\uff0c\u4f8b\u5982\uff1a<code>git update-index --add --cacheinfo &lt;mode&gt;,&lt;sha1&gt; &lt;path&gt;</code>\u3002</p> <p>\u6ce8\u610f\uff1a<code>cacheinfo</code> \u662f\u4e00\u4e2agit \u5b58\u50a8\u7684\u5341\u516d\u4f4d\u7684\u6587\u4ef6\u6a21\u5f0f\uff0c\u8fd9\u4e2a\u6a21\u5f0f\u9075\u5faa POSIX \u7c7b\u578b\u548c\u6a21\u5f0f \u7684\u5e03\u5c40\u3002\u8fd9\u8d85\u51fa\u4e86\u672c\u6587\u8ba8\u8bba\u7684\u8303\u56f4\u3002</p> <p>\u8fd0\u884c\u4e0a\u8ff0\u547d\u4ee4\u4f1a\u6539\u53d8 <code>.git</code> \u76ee\u5f55\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ git update-index --add --cacheinfo 10064,118f108d76b16a058db9fcb385a5fd640b54e47a,my_file.txt\n$ tree .git\n.git\n\u251c\u2500\u2500 HEAD\n\u251c\u2500\u2500 index\n\u251c\u2500\u2500 objects\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 11\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 8f108d76b16a058db9fcb385a5fd640b54e47a\n\u2514\u2500\u2500 refs\n    \u2514\u2500\u2500 heads\n\n5 directories, 3 files\n</code></pre> <p>\u4f60\u80fd\u53d1\u73b0\u53d8\u5316\u5417\uff1f\u591a\u4e86\u4e00\u4e2a\u540d\u4e3a <code>index</code> \u7684\u65b0\u6587\u4ef6\u3002\u8fd9\u5c31\u662f\u8457\u540d\u7684 \u7d22\u5f15 \uff08\u6216 \u6682\u5b58\u533a\uff09\uff0c\u5b83\u57fa\u672c\u4e0a\u662f\u4e00\u4e2a\u4f4d\u4e8e <code>.git/index</code> \u4e2d\u7684\u6587\u4ef6\u3002</p> <p>\u65e2\u7136 blob \u5df2\u7ecf\u88ab\u6dfb\u52a0\u5230\u4e86 \u7d22\u5f15\uff0c\u6211\u4eec\u5e0c\u671b <code>git status</code> \u770b\u8d77\u6765\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u50cf\u8fd9\u6837\uff1a</p> <pre><code>$ git status\nOn branch master\n\nNo commits yet\n\nChanges to be committed:\n  (use \"git rm --cached &lt;file&gt;...\" to unstage)\n    new file:   my_file.txt\n\nChanges not staged for commit:\n  (use \"git add/rm &lt;file&gt;...\" to update what will be committed)\n  (use \"git restore &lt;file&gt;...\" to discard changes in working directory)\n    deleted:    my_file.txt\n</code></pre> <p>\u771f\u6709\u8da3\uff01\u8fd9\u91cc\u53d1\u751f\u4e86\u4e24\u4ef6\u4e8b\u3002</p> <p>\u7b2c\u4e00\u4ef6\u4e8b\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 <code>changes to be committed</code> \u4e2d\u770b\u5230\u7eff\u8272\u7684 <code>new_file.txt</code>\u3002\u8fd9\u662f\u56e0\u4e3a \u7d22\u5f15 \u4e2d\u6709\u4e86 <code>new_file.txt</code>\uff0c\u5b83\u6b63\u7b49\u7740\u88ab\u63d0\u4ea4\u3002</p> <p>\u7b2c\u4e8c\u4ef6\u4e8b\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u7ea2\u8272\u7684 <code>new_file.txt</code>\u2014\u2014\u56e0\u4e3a <code>git</code> \u76f8\u4fe1 <code>my_file.txt</code> \u8fd9\u4e2a \u6587\u4ef6 \u5df2\u7ecf\u88ab\u5220\u9664\u4e86\uff0c\u5e76\u4e14\u5b83\u6ca1\u6709\u88ab\u6682\u5b58\u3002</p> <p>\u8fd9\u53d1\u751f\u5728\u6211\u4eec\u5c06\u5185\u5bb9\u4e3a <code>git is awesome</code> \u7684 blob \u6dfb\u52a0\u5230\u5bf9\u8c61\u6570\u636e\u5e93\u4e2d\u7684\u65f6\u5019\uff0c\u6211\u4eec\u544a\u8bc9 \u7d22\u5f15 \uff0c\u90a3\u4e2a blob \u7684\u5185\u5bb9\u5728\u6587\u4ef6 <code>my_file.txt</code> \u4e2d\uff0c\u4f46\u662f\u6211\u4eec\u4ece\u672a\u521b\u5efa\u8fc7\u90a3\u4e2a\u6587\u4ef6\u3002</p> <p>\u901a\u8fc7\u5c06\u90a3\u4e2a blob \u7684\u5185\u5bb9\u5199\u5165\u6211\u4eec\u6587\u4ef6\u7cfb\u7edf\u4e2d\u540d\u4e3a <code>my_file.txt</code> \u7684\u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <pre><code>$ git cat-file -p 118f108d76b16a058db9fcb385a5fd640b54e47a &gt; my_file.txt\n$ ls -a\n.           ..          .git        my_file.txt\n</code></pre> <p></p> <p>\u6267\u884c <code>git status</code> \u540e\uff0c\u5b83\u5c06\u4e0d\u518d\u51fa\u73b0\u5728\u7ea2\u8272\u5185\u5bb9\u4e2d\uff1a</p> <pre><code>$ git status\nOn branch master\n\nNo commits yet\n\nChanges to be committed:\n  (use \"git rm --cached &lt;file&gt;...\" to unstage)\n    new file:   my_file.txt\n</code></pre> <p>\u73b0\u5728\u662f\u65f6\u5019\u4ece\u6211\u4eec\u7684 \u6682\u5b58\u533a \u521b\u5efa\u4e00\u4e2a \u63d0\u4ea4 \u5bf9\u8c61\u4e86\u3002\u5982\u4e0a\u6240\u8ff0\uff0c\u4e00\u4e2a \u63d0\u4ea4 \u5bf9\u8c61\u5f15\u7528\u7740\u4e00\u4e2a \u6811\u5bf9\u8c61\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a \u6811\u5bf9\u8c61\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u7528 <code>git write-tree</code> \u505a\u8fd9\u4ef6\u4e8b\uff0c\u5b83\u4f1a\u5728\u4e00\u4e2a \u6811\u5bf9\u8c61 \u4e2d\u8bb0\u5f55 \u7d22\u5f15 \u7684\u5185\u5bb9\u3002\u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>git cat-file -t</code> \u8fdb\u884c\u786e\u8ba4\uff1a</p> <pre><code>$ git write-tree\n50a4d98955701b83dc67e8c3ace63899f0a2b5d6\n$ git cat-file -t 50a4d98955701b83dc67e8c3ace63899f0a2b5d6\ntree\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528 <code>git cat-file -p</code> \u67e5\u770b\u5b83\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ git cat-file -p 50a4d98955701b83dc67e8c3ace63899f0a2b5d6\n100644 blob 118f108d76b16a058db9fcb385a5fd640b54e47a    my_file.txt\n</code></pre> <p>\u592a\u68d2\u4e86\uff01\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a \u6811\u5bf9\u8c61\uff0c\u73b0\u5728\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\u8fd9\u4e2a \u6811\u5bf9\u8c61 \u7684 \u63d0\u4ea4 \u5bf9\u8c61\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>git commit-tree &lt;tree-hash&gt; -m &lt;commit message&gt;</code>\uff1a</p> <pre><code>$ git commit-tree 50a4d98955701b83dc67e8c3ace63899f0a2b5d6 -m \"First message\"\n3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\n</code></pre> <p>\u4f60\u73b0\u5728\u5e94\u8be5\u5bf9\u67e5\u770b\u5bf9\u8c61\u7c7b\u578b\u548c\u6253\u5370\u5bf9\u8c61\u5185\u5bb9\u7684\u547d\u4ee4\u611f\u5230\u5f97\u5fc3\u5e94\u624b\u4e86\uff1a</p> <pre><code>$ git cat-file -t 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\ncommit\n$ git cat-file -p 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\ntree 50a4d98955701b83dc67e8c3ace63899f0a2b5d6\nauthor wgzhao &lt;wgzhao@gmail.com&gt; 1691152555 +0800\ncommitter wgzhao &lt;wgzhao@gmail.com&gt; 1691152555 +0800\n\nFirst message\n</code></pre> <p>\u6ce8\u610f\u8fd9\u4e2a \u63d0\u4ea4 \u5e76\u6ca1\u6709 \u7236\u8282\u70b9\uff0c\u56e0\u4e3a\u5b83\u662f\u7b2c\u4e00\u4e2a \u63d0\u4ea4\u3002\u5f53\u6211\u4eec\u6dfb\u52a0\u53e6\u4e00\u4e2a \u63d0\u4ea4 \u65f6\uff0c\u6211\u4eec\u5c31\u5f97\u58f0\u660e\u5b83\u7684 **\u7236\u8282\u70b9**\u4e86\u2014\u2014\u6211\u4eec\u7a0d\u540e\u4f1a\u505a\u8fd9\u4e2a\u3002</p> <p>\u6211\u4eec\u521a\u5f97\u5230\u7684\u54c8\u5e0c\u503c\uff08<code>3de...f3</code>\uff09\u662f\u4e00\u4e2a \u63d0\u4ea4\u5bf9\u8c61 \u7684\u54c8\u5e0c\u503c\u3002\u5b9e\u9645\u4e0a\u6211\u4eec\u975e\u5e38\u4e60\u60ef\u4f7f\u7528\u8fd9\u4e9b\u54c8\u5e0c\u503c\u2014\u2014\u6211\u4eec\u4e00\u76f4\u90fd\u5728\u770b\u5b83\u4eec\u3002\u6ce8\u610f\u8fd9\u4e2a \u63d0\u4ea4\u5bf9\u8c61 \u62e5\u6709\u4e00\u4e2a \u6811\u5bf9\u8c61\uff0c\u6811\u5bf9\u8c61\u6709\u81ea\u5df1\u7684\u54c8\u5e0c\u503c\uff0c\u4e0d\u8fc7\u6211\u4eec\u51e0\u4e4e\u4e0d\u4f1a\u663e\u5f0f\u5730\u6307\u5b9a\u8fd9\u4e2a\u54c8\u5e0c\u503c\u3002</p> <p><code>git status</code> \u4f1a\u6709\u6240\u53d8\u5316\u5417\uff1f</p> <pre><code>$ git status\nOn branch master\n\nNo commits yet\n\nChanges to be committed:\n  (use \"git rm --cached &lt;file&gt;...\" to unstage)\n    new file:   my_file.txt\n</code></pre> <p>\u5e76\u6ca1\u6709\u3002\ud83e\udd14</p> <p>\u4e3a\u4ec0\u4e48\u5462\uff1f<code>git</code> \u9700\u8981\u77e5\u9053\u6700\u8fd1\u4e00\u6b21 \u63d0\u4ea4\uff0c\u624d\u80fd\u77e5\u9053\u6587\u4ef6\u5df2\u7ecf\u88ab\u63d0\u4ea4\u3002\u90a3\u4e48 <code>git</code> \u662f\u600e\u4e48\u505a\u7684\u5462\uff1f\u5b83\u4f1a\u53bb\u627e <code>HEAD</code>\uff1a</p> <pre><code>$ cat .git/HEAD\nref: refs/heads/master\n</code></pre> <p><code>HEAD</code> \u6307\u5411 <code>master</code>\uff0c\u4f46\u662f <code>master</code> \u662f\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa\u5b83\u5462\u3002</p> <p>\u5982\u540c\u6211\u4eec\u5728\u524d\u9762\u89e3\u91ca\u7684\u90a3\u6837\uff0c\u5206\u652f\u53ea\u662f \u63d0\u4ea4\u5bf9\u8c61 \u7684\u547d\u540d\u5f15\u7528\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u60f3\u8981\u8ba9 <code>master</code> \u6307\u5411\u54c8\u5e0c\u503c\u4e3a <code>3de073b2f6814d111ec1fd96f5b75e9b10df2ef3</code> \u7684 \u63d0\u4ea4\u5bf9\u8c61\u3002</p> <p>\u8fd9\u5b9e\u73b0\u8d77\u6765\u5f88\u7b80\u5355\uff0c\u5728 <code>.git/refs/heads/master</code> \u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a\u8fd9\u4e2a\u54c8\u5e0c\u503c\u3002\u50cf\u8fd9\u6837\uff1a</p> <pre><code>$ echo 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 &gt;.git/refs/heads/master\n</code></pre> <p>\u2b50 \u603b\u800c\u8a00\u4e4b\uff0c\u5206\u652f \u53ea\u662f <code>.git/refs/heads</code> \u4e2d\u7684\u4e00\u4e2a\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a\u8be5\u5206\u652f\u6240\u6307\u5411\u7684 \u63d0\u4ea4\u5bf9\u8c61 \u7684\u54c8\u5e0c\u503c\u3002</p> <p>\u73b0\u5728\uff0c<code>git status</code> \u548c <code>git log</code> \u7ec8\u4e8e\u6b23\u8d4f\u6211\u4eec\u7684\u4ed8\u51fa\u4e86\uff1a</p> <pre><code>$ git status\nOn branch master\nnothing to commit, working tree clean\n\n$ git log\ncommit 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\nAuthor: wgzhao &lt;wgzhao@gmail.com&gt;\nDate:   Fri Aug 4 20:35:55 2023 +0800\n\n    First message\n</code></pre> <p>\u6211\u4eec\u5df2\u7ecf\u6210\u529f\u521b\u5efa\u51fa\u4e86\u4e00\u4e2a \u63d0\u4ea4\uff0c\u5168\u7a0b\u6ca1\u6709\u4f7f\u7528\u4e0a\u5c42\u547d\u4ee4\uff01\u662f\u4e0d\u662f\u5f88\u9177\uff1f\ud83c\udf89</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#git_6","title":"\u4e0e Git \u5206\u652f\u4e00\u8d77\u5de5\u4f5c\u2014\u2014\u80cc\u540e\u7684\u6545\u4e8b","text":"<p>\u5c31\u50cf\u6211\u4eec\u4e0d\u501f\u52a9 <code>git init</code>\u3001<code>git add</code> \u6216 <code>git commit</code> \u521b\u5efa \u4ed3\u5e93 \u548c \u63d0\u4ea4 \u4e00\u6837\uff0c\u6211\u4eec\u5c06\u8981\u521b\u5efa \u5206\u652f\uff0c\u5728\u4e0d\u540c \u5206\u652f \u95f4\u6765\u56de\u5207\u6362\uff0c\u6574\u4e2a\u8fc7\u7a0b\u4e5f\u4e0d\u4f7f\u7528\u4e0a\u5c42\u547d\u4ee4\uff08<code>git branch</code> \u6216 <code>git checkout</code>\uff09\u3002</p> <p>\u5982\u679c\u4f60\u5f88\u5174\u594b\uff0c\u8fd9\u662f\u5b8c\u5168\u53ef\u4ee5\u7406\u89e3\u7684\u3002\u6211\u4e5f\u5f88\u5174\u594b \ud83d\ude42</p> <p>\u54b1\u4eec\u5f00\u59cb\u5427\uff1a</p> <p>\u76ee\u524d\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a <code>master</code> \u7684\u5206\u652f\u3002\u8981\u521b\u5efa\u53e6\u4e00\u4e2a\u540d\u4e3a <code>test</code> \u7684\u5206\u652f\uff08\u7b49\u4ef7\u4e8e\u6267\u884c <code>git branch test</code>\uff09\uff0c\u6211\u9700\u8981\u5728 <code>.git/refs/heads</code> \u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>test</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u7684\u5185\u5bb9\u5e94\u8be5\u548c <code>master</code> \u5206\u652f\u6307\u5411\u7684\u90a3\u4e2a \u63d0\u4ea4 \u7684\u54c8\u5e0c\u503c\u4e00\u81f4\u3002</p> <pre><code>$ echo 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 &gt;.git/refs/heads/test\n\n$ tree .git\n.git\n\u251c\u2500\u2500 COMMIT_EDITMSG\n\u251c\u2500\u2500 HEAD\n\u251c\u2500\u2500 index\n\u251c\u2500\u2500 logs\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 HEAD\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 refs\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 heads\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 master\n\u251c\u2500\u2500 objects\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 01\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 27164ffb22c8326860a46485a29e46d60c9a00\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 11\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 8f108d76b16a058db9fcb385a5fd640b54e47a\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 3d\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 e073b2f6814d111ec1fd96f5b75e9b10df2ef3\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 50\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 a4d98955701b83dc67e8c3ace63899f0a2b5d6\n\u2514\u2500\u2500 refs\n    \u2514\u2500\u2500 heads\n        \u251c\u2500\u2500 master\n        \u2514\u2500\u2500 test\n\n11 directories, 11 files\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>git log</code>\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 <code>master</code> \u548c <code>test</code> \u786e\u5b9e\u662f\u6307\u5411\u540c\u4e00\u4e2a \u63d0\u4ea4\uff1a</p> <pre><code>$ git log\ncommit 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 (HEAD -&gt; master, test)\nAuthor: wgzhao &lt;wgzhao@gmail.com&gt;\nDate:   Fri Aug 4 20:35:55 2023 +0800\n\n    First message\n</code></pre> <p>\u6211\u4eec\u4e5f\u5207\u6362\u5230\u65b0\u521b\u5efa\u7684\u5206\u652f\u5427\uff08\u7b49\u4ef7\u4e8e\u6267\u884c <code>git branch test</code>\uff09\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u6539\u53d8 <code>HEAD</code> \u7684\u6307\u5411\uff0c\u8ba9\u5b83\u6307\u5411\u6211\u4eec\u7684\u65b0\u5206\u652f\uff1a</p> <pre><code>$ echo 'ref: refs/heads/test' &gt; .git/HEAD\n$ git status\nOn branch test\nnothing to commit, working tree clean\n$ git log\ncommit 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 (HEAD -&gt; test, master)\nAuthor: wgzhao &lt;wgzhao@gmail.com&gt;\nDate:   Fri Aug 4 20:35:55 2023 +0800\n\n    First message\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff1a<code>git status</code> \u548c <code>git log</code> \u90fd\u786e\u8ba4 <code>HEAD</code> \u73b0\u5728\u6307\u5411\u7684\u662f <code>test</code> \u5206\u652f\uff08\u6d3b\u52a8\u5206\u652f\uff09\u3002</p> <p>\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u547d\u4ee4\u53bb\u521b\u5efa\u53e6\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u5b83\u6dfb\u52a0\u5230\u7d22\u5f15\uff1a</p> <pre><code>$ echo \"Testing\" &gt; test.txt\n$ git hash-object -w ./test.txt\n73709ba6866a30a566a38ca40aa81d5f0928bce0\n$ git update-index --add --cacheinfo 10064,73709ba6866a30a566a38ca40aa81d5f0928bce0,test.txt\n$ git write-tree\n6db3a0b6f110f460d2646540c928be6294d94415\n</code></pre> <p>\u6211\u4eec\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a <code>test.txt</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a <code>Testing</code>\u3002\u6211\u4eec\u8fd8\u521b\u5efa\u4e86\u76f8\u5e94\u7684 blob\uff0c\u5c06\u5b83\u6dfb\u52a0\u4e86\u5230 \u7d22\u5f15\u3002\u6211\u4eec\u8fd8\u521b\u5efa\u4e86\u4ee3\u8868\u8fd9\u4e2a \u7d22\u5f15 \u7684 \u6811\u5bf9\u8c61\u3002</p> <p>\u73b0\u5728\u662f\u65f6\u5019\u521b\u5efa\u5f15\u7528\u8fd9\u4e2a \u6811\u5bf9\u8c61 \u7684 \u63d0\u4ea4 \u4e86\u3002\u8fd9\u4e00\u6b21\uff0c\u6211\u4eec\u8fd8\u5e94\u8be5\u58f0\u660e\u8fd9\u4e2a\u63d0\u4ea4\u7684 \u7236\u63d0\u4ea4\uff0c\u4e5f\u5c31\u662f\u4e4b\u524d\u7684\u90a3\u6b21 \u63d0\u4ea4\u3002\u6211\u4eec\u7528 <code>git commit-tree</code> \u547d\u4ee4\u7684 <code>-p</code> \u5f00\u5173\u58f0\u660e\u7236\u8282\u70b9\uff1a</p> <pre><code>$ git commit-tree 6db3a0b6f110f460d2646540c928be6294d94415 -m \"Testing\" -p 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\nd04bf31102f8260e4062e8bfc0571f59a6b8305a\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u521a\u521a\u521b\u5efa\u4e86\u4e00\u4e2a \u63d0\u4ea4\uff0c\u8fd8\u6709\u5b83\u7684 \u6811\u5bf9\u8c61 \u548c\u7236\u8282\u70b9\uff1a</p> <pre><code>$ git cat-file -p d04bf31102f8260e4062e8bfc0571f59a6b8305a\ntree 6db3a0b6f110f460d2646540c928be6294d94415\nparent 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3\nauthor wgzhao &lt;wgzhao.com&gt; 1691153298 +0800\ncommitter wgzhao &lt;wgzhao.com&gt; 1691153298 +0800\n\nTesting\n</code></pre> <p><code>git log</code> \u4f1a\u5c55\u793a\u6211\u4eec\u7684\u65b0 \u63d0\u4ea4 \u5417\uff1f</p> <pre><code>commit 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 (HEAD -&gt; test, master)\nAuthor: \u8d75\u536b\u56fd &lt;zhaoweiguo@lczq.com&gt;\nDate:   Fri Aug 4 20:35:55 2023 +0800\n\n    First message\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a<code>git log</code> \u5e76\u6ca1\u6709\u5c55\u793a\u4efb\u4f55\u65b0\u7684\u4e1c\u897f\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f\ud83e\udd14 \u8fd8\u8bb0\u5f97 <code>git log</code> \u4f1a\u8ddf\u8e2a \u5206\u652f \uff0c\u67e5\u627e\u8981\u5c55\u793a\u7684\u76f8\u5173\u63d0\u4ea4\u5417\uff1f\u5b83\u73b0\u5728\u7ed9\u6211\u4eec\u5c55\u793a\u4e86 <code>test</code> \u548c\u5b83\u6307\u5411\u7684\u90a3\u4e2a \u63d0\u4ea4\uff0c\u8fd8\u5c55\u793a\u4e86\u6307\u5411\u540c\u4e00\u4e2a\u63d0\u4ea4\u7684 <code>master</code>\u3002</p> <p>\u6ca1\u9519\uff0c\u6211\u4eec\u9700\u8981\u8ba9 <code>test</code> \u6307\u5411\u6211\u4eec\u7684\u65b0 \u63d0\u4ea4\u3002\u6211\u4eec\u53ea\u9700\u8981\u7a0d\u5fae\u6539\u53d8\u4e00\u4e0b <code>.git/refs/heads/test</code> \u7684\u5185\u5bb9\uff1a</p> <pre><code>$ echo d04bf31102f8260e4062e8bfc0571f59a6b8305a &gt; .git/refs/heads/test\n\n$ git log\ncommit d04bf31102f8260e4062e8bfc0571f59a6b8305a (HEAD -&gt; test)\nAuthor: wgzhao &lt;wgzhao.com&gt;\nDate:   Fri Aug 4 20:48:18 2023 +0800\n\n    Testing\n\ncommit 3de073b2f6814d111ec1fd96f5b75e9b10df2ef3 (master)\nAuthor: \u8d75\u536b\u56fd &lt;zhaoweiguo@lczq.com&gt;\nDate:   Fri Aug 4 20:35:55 2023 +0800\n\n    First message\n</code></pre> <p>\u6210\u529f\u4e86! \ud83c\udf89\ud83e\udd42</p> <p><code>git log</code> \u627e\u5230 <code>HEAD</code>\uff0c<code>HEAD</code> \u544a\u8bc9\u5b83\u53bb <code>test</code> \u5206\u652f\uff0c<code>test</code> \u5206\u652f\u6307\u5411\u7740 \u63d0\u4ea4<code>d04...05a</code>\uff0c\u8fd9\u4e2a\u63d0\u4ea4\u53c8\u94fe\u63a5\u5230\u5b83\u7684\u7236 \u63d0\u4ea4 <code>3de...ef3</code>\u3002</p> <p>\u5c3d\u60c5\u6b23\u8d4f\u7f8e\u5427\uff0cwe git you\u3002 \ud83d\ude0a</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_5","title":"\u603b\u7ed3","text":"<p>\u672c\u6587\u5411\u4f60\u4ecb\u7ecd\u4e86 <code>git</code> \u7684\u5185\u90e8\u539f\u7406\uff0c\u6211\u4eec\u4e00\u5f00\u59cb\u8bb2\u4e86\u57fa\u672c\u5bf9\u8c61\u2014\u2014blob\u3001\u6811\u5bf9\u8c61 \u548c \u63d0\u4ea4\u5bf9\u8c61 \u3002</p> <p>\u6211\u4eec\u4e86\u89e3\u5230 blob \u6301\u6709\u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u6811\u5bf9\u8c61 \u662f\u4e00\u4e2a\u5305\u542b blob \u5bf9\u8c61 \u548c \u5b50\u6811\u5bf9\u8c61 \u7684\u76ee\u5f55\u5217\u8868\uff0c\u63d0\u4ea4\u5bf9\u8c61 \u662f\u5de5\u4f5c\u76ee\u5f55\u7684\u4e00\u4e2a\u5feb\u7167\uff0c\u5305\u542b\u4e86\u4e00\u4e9b\u50cf\u65f6\u95f4\u6216\u63d0\u4ea4\u4fe1\u606f\u8fd9\u6837\u7684\u5143\u6570\u636e\u3002</p> <p>\u6211\u4eec\u63a5\u7740\u8ba8\u8bba\u4e86 \u5206\u652f\uff0c\u5b83\u4eec\u4e0d\u8fc7\u662f \u63d0\u4ea4\u5bf9\u8c61 \u7684\u547d\u540d\u5f15\u7528\u3002</p> <p>\u6211\u4eec\u7ee7\u7eed\u63cf\u8ff0\u4e86 \u5de5\u4f5c\u76ee\u5f55\uff0c\u5b83\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u6709\u7740\u76f8\u5e94\u7684\u4ed3\u5e93\u3002\u6682\u5b58\u533a\uff08\u7d22\u5f15\uff09 \u4e3a\u4e0b\u4e00\u4e2a \u63d0\u4ea4\u5bf9\u8c61 \u6301\u6709\u5bf9\u5e94\u7684 \u6811\u5bf9\u8c61\uff0c\u800c\u4ed3\u5e93\u5c31\u662f\u4e00\u4e2a \u63d0\u4ea4\u5bf9\u8c61 \u7684\u96c6\u5408\u3002</p> <p>\u6211\u4eec\u9610\u660e\u4e86\u8fd9\u4e9b\u672f\u8bed\u4e0e <code>git init</code>\u3001<code>git add</code> \u548c <code>git commit</code> \u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u6211\u4eec\u7528\u8fd9\u51e0\u6761\u8457\u540d\u7684\u547d\u4ee4\u521b\u5efa\u65b0\u4ed3\u5e93\u3001\u63d0\u4ea4\u6587\u4ef6\u3002</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u5927\u80c6\u5730\u6df1\u5165 <code>git</code> \u5185\u90e8\uff0c\u505c\u6b62\u4f7f\u7528\u4e0a\u5c42\u547d\u4ee4\uff0c\u8f6c\u800c\u4f7f\u7528\u5e95\u5c42\u547d\u4ee4\u3002</p> <p>\u501f\u52a9 <code>echo</code> \u548c <code>git bash-object</code> \u8fd9\u7c7b\u7684\u5e95\u5c42\u547d\u4ee4\uff0c\u6211\u4eec\u521b\u5efa\u4e86 blob\uff0c\u628a\u5b83\u6dfb\u52a0\u5230 \u7d22\u5f15\uff0c\u521b\u5efa\u4e86 \u7d22\u5f15 \u7684 \u6811\u5bf9\u8c61\uff0c\u4ee5\u53ca\u6307\u5411\u8fd9\u4e2a \u6811\u5bf9\u8c61 \u7684 \u63d0\u4ea4\u5bf9\u8c61\u3002</p> <p>\u6211\u4eec\u8fd8\u521b\u5efa\u4e86 \u5206\u652f\uff0c\u5728 \u5206\u652f \u95f4\u6765\u56de\u5207\u6362\u3002\u4e3a\u4f60\u4eec\u4e2d\u90a3\u4e9b\u4eb2\u8eab\u5c1d\u8bd5\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u4eba\u9f13\u4e2a\u638c\uff01\ud83d\udc4f</p> <p>\u5e0c\u671b\u4f60\u5728\u8ddf\u7740\u672c\u6587\u64cd\u4f5c\u4e00\u904d\u4e4b\u540e\uff0c\u5bf9\u4f7f\u7528 <code>git</code> \u8fc7\u7a0b\u4e2d\u80cc\u540e\u53d1\u751f\u7684\u4e8b\u60c5\u6709\u4e86\u66f4\u6df1\u5165\u7684\u7406\u89e3\u3002</p> <p>\u611f\u8c22\u9605\u8bfb\u672c\u6587\uff01 \u5982\u679c\u4f60\u559c\u6b22\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4f60\u53ef\u4ee5\u5728 swimm.io blog \u9605\u8bfb\u66f4\u591a\u8fd9\u4e2a\u4e3b\u9898\u7684\u5185\u5bb9\u3002</p> <p>Omer Rosenbaum \u662f Swimm \u7684\u9996\u5e2d\u6280\u672f\u5b98\u3001\u7f51\u7edc\u57f9\u8bad\u4e13\u5bb6\u3001Checkpoint \u5b89\u5168\u5b66\u9662\u7684\u521b\u59cb\u4eba\u548c\u8ba1\u7b97\u673a\u7f51\u7edc\uff08\u5e0c\u4f2f\u6765\u8bed\uff09\u7684\u4f5c\u8005\u3002</p> <p>\u8bbf\u95ee\u6211\u7684 YouTube \u9891\u9053\u3002</p>","tags":["git"]},{"location":"tips/git-internals-objects-branches-create-repo/#_6","title":"\u9644\u52a0\u8d44\u6e90","text":"<p><code>git</code> \u76f8\u5173\u7684\u8d44\u6e90\u5df2\u7ecf\u6709\u7684\u5f88\u591a\u4e86\uff0c\u6211\u53d1\u73b0\u4e0b\u9762\u8fd9\u4e9b\u53c2\u8003\u7279\u522b\u6709\u7528\uff1a</p> <ul> <li>Git Internals YouTube playlist\u200a\u2014\u200aby Brief</li> <li>Tim Berglund\u2019s lecture\u200a\u2014\u200a\u201cGit From the Bits Up\u201d</li> <li>Git from the Bottom Up\u200a\u2014\u200aby John Wiegley</li> <li>as promised, docs: git for the confused</li> <li>Git Internals\u200a\u2014\u200aGit Objects\u200a\u2014\u200afrom Pro Git book, by Scott Chacon and Ben Straub</li> </ul> <p>\u539f\u6587\uff1aA Visual Guide to Git Internals \u2014 Objects, Branches, and How to Create a Repo From Scratch\uff0c\u4f5c\u8005\uff1aOmer Rosenbaum</p>","tags":["git"]},{"location":"tips/git-tips/","title":"git \u4e0d\u5e38\u89c1\u7684\u64cd\u4f5c\u6280\u5de7","text":"<p>\u4ee5\u4e0b\u8bb0\u5f55\u4e00\u4e9b\u4e0d\u592a\u5e38\u89c1\u7684git\u64cd\u4f5c\u6280\u5de7</p>","tags":["git"]},{"location":"tips/git-tips/#tag","title":"\u5220\u9664\u8fdc\u7a0b\u5206\u652f\u6216tag","text":"<pre><code>git push --delete origin tagname|branch_name\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#tag_1","title":"\u6b63\u786e\u7684\u5207\u6362\u5230\u6307\u5b9a\u7684tag","text":"<pre><code>git checkout -b new_branch tagname\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_1","title":"\u8981\u4fee\u6539\u4e00\u7cfb\u5217\u63d0\u4ea4\u7684\u7528\u6237\u4fe1\u606f","text":"<p>\u5047\u5b9a\u4ece <code>a20220a</code> \u5f00\u59cb\u5230\u5f53\u524d\u6700\u65b0\u63d0\u4ea4\u7684\u6240\u6709\u7528\u6237\u4fe1\u606f\u9700\u8981\u4fee\u6539\uff0c\u53ef\u4ee5\u8fd9\u6837\u505a</p> <pre><code>git rebase --onto a20220a \\\n  --exec \"git commit --amend --author=\\\"wgzhao &lt;wgzhao@gmail.com&gt;\\\" \" a20220a\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u628a\u8fd9\u4e2a\u64cd\u4f5c\u4fdd\u5b58\u4e3a\u522b\u540d\uff0c\u65b9\u4fbf\u4ee5\u540e\u64cd\u4f5c\uff0c\u7f16\u8f91 <code>~/.gitconfig</code>\uff0c \u589e\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>[alias]\n    reauthor = !bash -c 'git rebase --onto $1 --exec \\\"git commit --amend --author=$2\\\" $1' --\n</code></pre> <p>\u4e0b\u6b21\u8fd0\u884c\u5c31\u662f\u8fd9\u6837</p> <pre><code>git reauthor a20220a \"wgzhao &lt;wgzhao@gmail.com&gt;\"\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#git_1","title":"git \u7edf\u8ba1\u547d\u4ee4","text":"","tags":["git"]},{"location":"tips/git-tips/#_2","title":"\u7edf\u8ba1\u67d0\u4eba\u4ee3\u7801\u63d0\u4ea4\u91cf","text":"<pre><code>git log --author=\"zhaowg\" --pretty=tformat: --numstat | \\\nawk '{ add += $1; subs += $2; loc += $1 - $2 }\n END { printf \"added lines: %s, removed lines: %s, total lines: %s\\n\", add, subs, loc }' -\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_3","title":"\u7edf\u8ba1\u6240\u6709\u4eba\u4ee3\u7801\u63d0\u4ea4\u91cf\uff08\u6307\u5b9a\u7edf\u8ba1\u63d0\u4ea4\u6587\u4ef6\u7c7b\u578b\uff09","text":"<pre><code>git log --format='%aN' | sort -u | \\\nwhile read name; do\necho -en \"$name\\t\";\ngit log --author=\"$name\" --pretty=tformat: --numstat | \\\ngrep \"\\(.html\\|.java\\|.xml\\|.properties\\|.css\\|.js\\|.txt\\)$\" | \\ \nawk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf \"added lines: %s, removed lines: %s, total lines: %s\\n\", add, subs, loc }' -; \ndone\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_4","title":"\u7edf\u8ba1\u67d0\u65f6\u95f4\u8303\u56f4\u5185\u7684\u4ee3\u7801\u63d0\u4ea4\u91cf","text":"<pre><code>git log --author=\"zhaowg\" --since='2019-01-01' --until='2021-02-01' --format='%aN' | sort -u | while read name; do echo -en \"$name\\t\"; git log --author=\"$name\" --pretty=tformat: --numstat | grep \"\\(.html\\|.java\\|.xml\\|.properties\\)$\" | awk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf \"added lines: %s, removed lines: %s, total lines: %s\\n\", add, subs, loc }' -; done\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#git5","title":"\u67e5\u770bgit\u63d0\u4ea4\u524d5\u540d","text":"<pre><code>git log --pretty='%aN' | sort | uniq -c | sort -k1 -n -r | head -n 5\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_5","title":"\u8d21\u732e\u503c\u7edf\u8ba1","text":"<pre><code>git log --pretty='%aN' | sort -u | wc -l\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_6","title":"\u63d0\u4ea4\u6570\u7edf\u8ba1","text":"<pre><code>git log --oneline | wc -l\n</code></pre>","tags":["git"]},{"location":"tips/git-tips/#_7","title":"\u7edf\u8ba1\u6216\u4fee\u6539\u7684\u884c\u6570","text":"<pre><code>git log --stat|perl -ne 'END { print $c } $c += $1 if /(\\d+) insertions/'\n</code></pre>","tags":["git"]},{"location":"tips/how-to-create-dummy-rpm-package/","title":"\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u865a\u5047 RPM \u5305","text":"<p>\u6709\u7684\u65f6\u5019\u6709\u4e00\u4e9b\u5305\u6709\u4f9d\u8d56\uff0c\u4f46\u662f\u4f9d\u8d56\u7684\u6587\u4ef6\u53ef\u80fd\u6c38\u8fdc\u7528\u4e0d\u5230\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u91c7\u53d6\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u865a\u62df RPM \u5305\u7684\u65b9\u5f0f\u201c\u9a97\u8fc7\u201d\u7cfb\u7edf\u7684\u4f9d\u8d56\u68c0\u67e5\uff0c\u4ee5\u4e0b\u662f\u5feb\u901f\u521b\u5efa RPM \u5305\u7684\u811a\u672c</p> <pre><code>#!/bin/sh\n# This scripts creates and build a simple RPM package\n#\n# Prerequisites:\n#  - rpm-build, make and gcc (as it's a c file) packages must be installed\n#\n\n# Holds the name of the root directory containing the necessary structure to\n# build RPM packages.\n[ $UID -eq 0 ] || exit 2\nRPM_ROOT_DIR=~/rpm_factory\nPKG_NAME=${1-\"dummy_package\"}\nPKG_TAR=/tmp/${PKG_NAME}.tar.gz\nBINARY_FILE=hello_world\n# Recreate the root directory and its structure if necessary\nmkdir -p ${RPM_ROOT_DIR}/{SOURCES,BUILD,RPMS,SPECS,SRPMS,tmp}\nPKG_DIR=/tmp/${PKG_NAME}\nmkdir -p ${PKG_DIR}\n\ncat &lt;&lt; __EOF__ &gt; ${PKG_DIR}/hello_world.c\n#include &lt;stdio.h&gt;\nint main(){\n  printf(\"Hello world!\\n\");\n  return 0;\n}\n__EOF__\n\npushd ${PKG_DIR}/..\ntar czvf ${PKG_NAME}.tar.gz ${PKG_NAME}\npopd\npushd  $RPM_ROOT_DIR\ncp ${PKG_TAR} ${RPM_ROOT_DIR}/SOURCES/\n\n# Creating a basic spec file\ncat &lt;&lt; __EOF__ &gt; ${RPM_ROOT_DIR}/SPECS/${PKG_NAME}.spec\nSummary: This package is a sample for quickly build dummy RPM package.\nName: $PKG_NAME\nVersion: ${2-:1.0}\nRelease: ${3-:0}\nLicense: GPL\nPackager: $USER\nGroup: Development/Tools\nSource: %{name}.tar.gz\nBuildRequires: coreutils\nBuildRoot: ${RPM_ROOT_DIR}/tmp/%{name}-%{version}\n\n%description\n%{summary}\n\n%prep\n%setup -n ${PKG_NAME}\n\n%build\nmake $BINARY_FILE\n\n%install\nmkdir -p \"%{buildroot}/opt/${PKG_NAME}\"\ncp $BINARY_FILE \"%{buildroot}/opt/${PKG_NAME}/\"\n\n%files\n/opt/${PKG_NAME}/hello_world\n\n%clean\n%if \"%{clean}\" != \"\"\n  rm -rf %{_topdir}/BUILD/%{name}\n  [ $(basename %{buildroot}) == \"%{name}-%{version}-%{release}.%{_target_cpu}\" ] &amp;&amp; rm -rf %{buildroot}\n%endif\n\n%post\nchmod 755 -R /opt/${PKG_NAME}\n__EOF__\n\nrpmbuild -v -bb --define \"_topdir ${RPM_ROOT_DIR}\" SPECS/${PKG_NAME}.spec\npopd\n</code></pre> <p>\u7528\u6cd5\u5982\u4e0b</p> <pre><code>$ create_dummy_rpm.sh &lt;package_name&gt; &lt;version&gt; &lt;release-version&gt;\n</code></pre> <p>\u6bd4\u5982</p> <pre><code>$ create_dummy_rpm.sh texinfo-tex 5.1 4.el7\n</code></pre> <p>\u5219\u751f\u6210\u7684 rpm \u6587\u4ef6\u4e3a <code>/root/rpm_factory/RPM/x86_64/texinfo-text-5.1-4.el7.x86_64.rpm</code></p>","tags":["rpm","rpmbuild","dummy"]},{"location":"tips/howto-change-git-author/","title":"How to change git author name and email","text":"<p>Source</p> <p>This answer uses git-filter-branch, for which the docs now give this warning:</p> <p>git filter-branch has a plethora of pitfalls that can produce non-obvious manglings of the intended history rewrite (and can leave you with little time to investigate such problems since it has such abysmal performance). These safety and performance issues cannot be backward compatibly fixed and as such, its use is not recommended. Please use an alternative history filtering tool such as git filter-repo. If you still need to use git filter-branch, please carefully read SAFETY (and PERFORMANCE) to learn about the land mines of filter-branch, and then vigilantly avoid as many of the hazards listed there as reasonably possible.</p> <p>Specifically, you can fix all the wrong author names and emails for all branches and tags with this command (source: GitHub help):</p> <pre><code>#!/bin/sh\n\ngit filter-branch --env-filter '\nOLD_EMAIL=\"your-old-email@example.com\"\nCORRECT_NAME=\"Your Correct Name\"\nCORRECT_EMAIL=\"your-correct-email@example.com\"\nif [ \"$GIT_COMMITTER_EMAIL\" = \"$OLD_EMAIL\" ]\nthen\n    export GIT_COMMITTER_NAME=\"$CORRECT_NAME\"\n    export GIT_COMMITTER_EMAIL=\"$CORRECT_EMAIL\"\nfi\nif [ \"$GIT_AUTHOR_EMAIL\" = \"$OLD_EMAIL\" ]\nthen\n    export GIT_AUTHOR_NAME=\"$CORRECT_NAME\"\n    export GIT_AUTHOR_EMAIL=\"$CORRECT_EMAIL\"\nfi\n' --tag-name-filter cat -- --branches --tags\n</code></pre> <p>For using alternative history filtering tool git filter-repo, you can first install it and construct a <code>git-mailmap</code> according to the format of gitmailmap.</p> <pre><code>Proper Name &lt;proper@email.xx&gt; Commit Name &lt;commit@email.xx&gt;\n</code></pre> <p>And then run filter-repo with the created mailmap:</p> <pre><code>git filter-repo --mailmap git-mailmap\n</code></pre>","tags":["git"]},{"location":"tips/howto-delete-old-images-from-nexus-registry/","title":"\u5982\u4f55\u5220\u9664 nexus \u79c1\u670d\u4e0a\u7684 Docker \u955c\u50cf","text":"<p>\u5f53 nexus \u7684 docker \u955c\u50cf\u8d8a\u6765\u8d8a\u591a\u65f6\uff0c\u8001\u7684\u955c\u50cf\u5c31\u9700\u8981\u5220\u9664\uff0c\u7528\u6765\u91ca\u653e\u7a7a\u95f4</p> <p>\u627e\u4e86\u4e00\u4e2a\u7b80\u6613\u7684\u529e\u6cd5\uff0c \u9996\u5148\u4e0b\u8f7d regclient \u4e0b\u7684 <code>regctl</code> \u547d\u4ee4 \u7136\u540e\u521b\u5efa\u4e00\u4e2a\u7c7b\u4f3c\u5982\u4e0b\u7684\u811a\u672c\u6765\u5220\u9664\u8001\u7684</p> <pre><code>#!/bin/sh\nexport PATH=/root/bin:$PATH\nregistry=\"nexus.yourdomain.com\"\ncutoff=\"$(date -d -30days '+%s')\"\nfor repo in $(regctl repo ls \"$registry\" | grep  -E '(staff-center|lczq-ias|ims|crm|income-voucher|wechat-work|grp-arch)'); do\n  # The \"head -n -5\" ignores the last 5 tags, but you may want to sort that list first.\n  for tag in $(regctl tag ls \"$registry/$repo\" |grep 'test-' | head -n -30); do\n    # This is the most likely command to fail since the created timestamp is optional, may be set to 0,\n    # and the string format might vary.\n    # The cut is to remove the \"+0000\" that breaks the \"date\" command.\n    created=\"$(regctl image config \"$registry/$repo:$tag\" --format '{{.Created}}' | cut -f1,2,4 -d' ')\"\n    createdSec=\"$(date -d \"$created\" '+%s')\"\n    # both timestamps are converted to seconds since epoc, allowing numeric comparison\n    if [ \"$createdSec\" -lt \"$cutoff\" ]; then\n      # next line is prefixed with echo for debugging, delete the echo to run the tag delete command\n      # get digest\n      digest=$(regctl image digest ${registry}/${repo}:${tag})\n      regctl image delete \"$registry/$repo:$tag@${digest}\"\n    fi\n  done\ndone\n</code></pre> <p>\u6211\u8fd9\u91cc\u505a\u4e86\u4e00\u4e9b\u8fc7\u6ee4\uff0c\u76f4\u628a\u81ea\u6709\u7684\u4e00\u4e9b\u955c\u50cf\u5220\u9664\uff0c\u516c\u5171\u7684\u955c\u50cf\u4e0d\u5220\u9664</p>","tags":["docker","registry","nexus"]},{"location":"tips/howto-save-tmux-session/","title":"How to save current tmux session","text":"<p>To preserve your <code>tmux</code> session across reboots, you can use a combination of <code>tmux</code> and a tool called <code>tmux-resurrect</code>. <code>tmux-resurrect</code> allows you to save and restore <code>tmux</code> sessions, including the state of each pane and window.</p> <p>Here are the steps to install and use <code>tmux-resurrect</code>:</p> <ol> <li> <p>Install <code>tmux-resurrect</code>:</p> <p>First, you need to install <code>tmux-resurrect</code>. You can do this by cloning the repository and adding it to your <code>tmux</code> configuration.</p> <pre><code>git clone https://github.com/tmux-plugins/tmux-resurrect ~/tmux-resurrect\n</code></pre> </li> <li> <p>Configure <code>tmux</code> to use <code>tmux-resurrect</code>:</p> <p>Add the following lines to your <code>~/.tmux.conf</code> file to enable <code>tmux-resurrect</code>:</p> <pre><code>set -g @plugin 'tmux-plugins/tmux-resurrect'\nrun-shell ~/tmux-resurrect/resurrect.tmux\n</code></pre> <p>If you don't have a <code>~/.tmux.conf</code> file, you can create one.</p> </li> <li> <p>Reload <code>tmux</code> configuration:</p> <p>After updating your <code>~/.tmux.conf</code>, reload the <code>tmux</code> configuration by running the following command inside a <code>tmux</code> session:</p> <pre><code>tmux source-file ~/.tmux.conf\n</code></pre> </li> <li> <p>Save the <code>tmux</code> session:</p> <p>Before rebooting, save your <code>tmux</code> session by pressing the following key combination inside a <code>tmux</code> session:</p> <pre><code>Prefix + Ctrl-s\n</code></pre> <p>The default <code>Prefix</code> key is <code>Ctrl-b</code>. So, you would press <code>Ctrl-b</code> followed by <code>Ctrl-s</code>.</p> </li> <li> <p>Reboot your system:</p> <p>You can now safely reboot your system.</p> <pre><code>sudo reboot\n</code></pre> </li> <li> <p>Restore the <code>tmux</code> session:</p> <p>After the system reboots, start a new <code>tmux</code> session and restore the saved session by pressing the following key combination inside the new <code>tmux</code> session:</p> <pre><code>Prefix + Ctrl-r\n</code></pre> <p>Again, the default <code>Prefix</code> key is <code>Ctrl-b</code>. So, you would press <code>Ctrl-b</code> followed by <code>Ctrl-r</code>.</p> </li> </ol> <p>By following these steps, you can save and restore your <code>tmux</code> sessions across reboots, ensuring that you don't lose your work.</p>","tags":["tmux"]},{"location":"tips/learn-seaborn-with-10min/","title":"\u5341\u5206\u949f\u638c\u63e1Seaborn\uff0c\u8fdb\u9636Python\u6570\u636e\u53ef\u89c6\u5316\u5206\u6790","text":"<p>Source</p> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#seaborn","title":"\u4e3a\u4ec0\u4e48\u7528 Seaborn","text":"<p>Seaborn \u662f\u57fa\u4e8e Python \u4e14\u975e\u5e38\u53d7\u6b22\u8fce\u7684\u56fe\u5f62\u53ef\u89c6\u5316\u5e93\uff0c\u5728 Matplotlib \u7684\u57fa\u7840\u4e0a\uff0c\u8fdb\u884c\u4e86\u66f4\u9ad8\u7ea7\u7684\u5c01\u88c5\uff0c\u4f7f\u5f97\u4f5c\u56fe\u66f4\u52a0\u65b9\u4fbf\u5feb\u6377\u3002\u5373\u4fbf\u662f\u6ca1\u6709\u4ec0\u4e48\u57fa\u7840\u7684\u4eba\uff0c\u4e5f\u80fd\u901a\u8fc7\u6781\u7b80\u7684\u4ee3\u7801\uff0c\u505a\u51fa\u5177\u6709\u5206\u6790\u4ef7\u503c\u800c\u53c8\u5341\u5206\u7f8e\u89c2\u7684\u56fe\u5f62\u3002</p> <p>Seaborn \u53ef\u4ee5\u5b9e\u73b0 Python \u73af\u5883\u4e0b\u7684\u7edd\u5927\u90e8\u5206\u63a2\u7d22\u6027\u5206\u6790\u7684\u4efb\u52a1\uff0c\u56fe\u5f62\u5316\u7684\u8868\u8fbe\u5e2e\u52a9\u4f60\u5bf9\u6570\u636e\u8fdb\u884c\u5206\u6790\uff0c\u800c\u4e14\u5bf9 Python \u7684\u5176\u4ed6\u5e93\uff08\u6bd4\u5982 Numpy/Pandas/Scipy\uff09\u6709\u5f88\u597d\u7684\u652f\u6301\u3002</p> <p>\u90a3\u4e48\u73b0\u5728\u5f00\u59cb\uff0c\u5341\u5206\u949f\u7684\u65f6\u95f4\uff0c\u4f60\u5c31\u53ef\u4ee5\u4e86\u89e3 Seaborn \u4e2d\u5e38\u7528\u56fe\u5f62\u7684\u7ed8\u5236\u65b9\u6cd5\uff0c\u4ee5\u53ca\u8fdb\u9636\u7684\u53ef\u89c6\u5316\u5206\u6790\u6280\u5de7\u3002</p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#seaborn_1","title":"Seaborn \u7ed8\u56fe\u4e0a\u624b","text":"<p>\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 Python \u73af\u5883\uff0c\u90a3\u4e48\u63a8\u8350\u4f60\u5b89\u88c5 Anaconda\uff0c\u5bf9\u4e8e\u4e0a\u624b Python \u6765\u8bf4\u66f4\u52a0\u7b80\u5355\uff0c\u4e0d\u5bb9\u6613\u51fa\u5dee\u9519\u3002Anaconda \u7684\u5b89\u88c5\u6559\u7a0b\u7f51\u4e0a\u5f88\u591a\uff0c\u627e\u5230\u5bf9\u5e94\u7248\u672c\u5ba2\u6237\u7aef\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u5b89\u88c5\u597d\u540e\uff0c\u5373\u53ef\u5728\u7ec8\u7aef\uff08cmd\uff09\u5b89\u88c5\u6838\u5fc3\u5e93 Seaborn \u548c Matplotlib\u3002</p> <p>\u5b89\u88c5 Matplotlib</p> <pre><code>python -m pip install matplotlib\n</code></pre> <p>\u5b89\u88c5 Seaborn</p> <pre><code>pip install seaborn\n</code></pre> <p>\u7136\u540e\u6253\u5f00 Jupyter Notebook\uff08\u5b89\u88c5\u597d Anaconda \u540e\uff0cJupyter \u4e5f\u5df2\u88c5\u597d\uff0c\u5728\u5e94\u7528\u7a97\u53e3\u4e2d\u53ef\u4ee5\u627e\u5230\uff09\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4e0a\u624b\u4e86\u3002</p> <p>\u5148\u6765\u4e00\u6bb5\u57fa\u672c\u7684\u4ee3\u7801\uff1a</p> <pre><code>import seaborn as sns\nimport matplotlib.pyplot as plt\n%matplotlib inline\nsns.set(style=\"darkgrid\")\nsns.set(rc={'figure.figsize':(11.7,8.27)})\ntitanic=sns.load_dataset('titanic')\nsns.barplot(x='class',y='survived',data=titanic)\n</code></pre> <p></p> <p>\u901a\u8fc7\u4ee5\u4e0a\u4ee3\u7801\uff0c\u6211\u4eec\u5c31\u7ed8\u5236\u51fa\u4e86\u57fa\u672c\u7684\u6761\u5f62\u56fe\uff0c\u662f\u4e0d\u662f\u8d85\u7ea7\u7b80\u5355\u3002\u8fd9\u4e5f\u662f\u7528 Seaborn \u5b9e\u73b0\u4e00\u4e2a\u56fe\u5f62\u7684\u57fa\u672c\u6a21\u5f0f\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u628a\u4e0a\u9762\u7684\u4ee3\u7801\u62c6\u5f00\u6765\u770b\u3002</p> <p>1.\u5bfc\u5165\u7ed8\u56fe\u6a21\u5757</p> <pre><code>import seaborn as sns\nimport matplotlib.pyplot as plt\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5bfc\u5165 Seaborn \u548c Matplotlib.pyplot \u6a21\u5757\uff0c\u5206\u522b\u547d\u540d\u4e3a sns \u548c plt\uff0c\u539f\u5219\u4e0a\u8fd9\u4e2a\u7b80\u79f0\u662f\u53ef\u4ee5\u968f\u610f\u5199\u7684\uff0c\u4f46\u4e3a\u4e86\u89c4\u8303\uff0c\u5c3d\u91cf\u5199\u6210\u8fd9\u6837\u3002\u8fd9\u91cc\u5f15\u5165 Matplotlib.pyplot \uff0c\u662f\u4e3a\u4e86\u901a\u8fc7 Matplotlib \u7684\u53c2\u6570\u53bb\u8fdb\u884c\u66f4\u597d\u7684\u63a7\u5236\u3002</p> <p>2.\u63d0\u4f9b\u663e\u793a\u6761\u4ef6</p> <p><code>%matplotlib inline</code></p> <p>\u8fd9\u91cc\u7684 <code>%matplot inline</code> \u662f\u4e3a\u4e86\u5728 Jupyter \u4e2d\u6b63\u5e38\u663e\u793a\u56fe\u5f62\uff0c\u82e5\u6ca1\u6709\u8fd9\u884c\u4ee3\u7801\uff0c\u56fe\u5f62\u663e\u793a\u4e0d\u51fa\u6765\u7684\u3002</p> <p>3.\u5bfc\u5165\u6570\u636e</p> <p><code>titanic=sns.load_dataset('titanic')</code></p> <p>\u8fd9\u91cc\u6211\u4eec\u7528 Seaborn \u7684 <code>load_dataset()</code> \u65b9\u6cd5\u5bfc\u5165\u6570\u636e \u2018titanic\u2019\uff0c\u8fd9\u662f\u6cf0\u5766\u5c3c\u514b\u53f7\u7684\u76f8\u5173\u6570\u636e\uff0c\u5185\u7f6e\u4e8e Seaborn\uff08\u5185\u7f6e\u6570\u636e\u90fd\u53ef\u4ee5\u7528\u6b64\u65b9\u6cd5\u5bfc\u5165\uff09\u3002\u5f53\u7136 Seaborn \u8fd8\u63d0\u4f9b\u4e86\u5176\u4ed6\u7684\u5185\u7f6e\u6570\u636e\uff0c\u4ee5\u4e0b\u662f\u76ee\u524d\u5185\u7f6e\u7684\u6570\u636e\u96c6\uff1a</p> <ul> <li>anscombe</li> <li>attention</li> <li>brain_networks</li> <li>car_crashes</li> <li>diamonds</li> <li>dots</li> <li>exercise</li> <li>flights</li> <li>fmri</li> <li>gammas</li> <li>iris</li> <li>mpg</li> <li>planets</li> <li>tips</li> <li>titantic</li> </ul> <p>\u5730\u5740\uff1ahttps://github.com/mwaskom/seaborn-data</p> <p>4.\u8f93\u51fa\u56fe\u5f62</p> <p><code>sns.barplot(x='class',y='survived',data=titanic)</code></p> <p>\u8fd9\u662f\u56fe\u5f62\u8f93\u51fa\u7684\u76f4\u63a5\u4ee3\u7801\uff0cbarplot \u8868\u793a\u8f93\u51fa\u6761\u5f62\u56fe\uff0c\u5e38\u7528\u7684\u6709\uff1a</p> <ul> <li>countplot</li> <li>boxplot</li> <li>violinplot</li> <li>regplot</li> <li>lmplot</li> <li>heatmap </li> </ul> <p>\u540e\u9762\u8be6\u7ec6\u4ecb\u7ecd</p> <p><code>barplot()</code> \u62ec\u53f7\u91cc\u7684\u662f\u9700\u8981\u8bbe\u7f6e\u7684\u5177\u4f53\u53c2\u6570\uff0c\u6d89\u53ca\u5230\u6570\u636e\u3001\u989c\u8272\u3001\u5750\u6807\u8f74\u3001\u4ee5\u53ca\u5177\u4f53\u56fe\u5f62\u7684\u4e00\u4e9b\u63a7\u5236\u53d8\u91cf\uff0c\u4e00\u822c\u6bd4\u8f83\u56fa\u5b9a\u7684\u662f <code>x</code>\u3001<code>y</code>\u3001<code>data</code>\uff0c\u5206\u522b\u8868\u793ax\u8f74\uff0cy\u8f74\uff0c\u4ee5\u53ca\u9009\u62e9\u7684\u6570\u636e\u96c6\u3002</p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#seaborn_2","title":"Seaborn \u56fe\u5f62\u53ef\u89c6\u5316","text":"","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#distplot","title":"distplot \u76f4\u65b9\u56fe","text":"<p>\u901a\u5e38\u6211\u4eec\u5728\u5206\u6790\u4e00\u7ec4\u6570\u636e\u65f6\uff0c\u9996\u5148\u8981\u770b\u7684\u5c31\u662f\u53d8\u91cf\u7684\u5206\u5e03\u89c4\u5f8b\uff0c\u800c\u76f4\u65b9\u56fe\u5219\u63d0\u4f9b\u4e86\u7b80\u5355\u5feb\u901f\u7684\u65b9\u5f0f\uff0c\u5728 Seaborn \u4e2d\u53ef\u4ee5\u7528 <code>distplot()</code> \u5b9e\u73b0\u3002</p> <p>\u6211\u4eec\u9996\u5148\u5bfc\u5165\u6570\u636e\u96c6 'titanic'\uff0c\u5e76\u67e5\u770b\u968f\u673a\u768410\u884c\u6570\u636e\uff0c\u5bf9\u6570\u636e\u96c6\u6709\u4e00\u4e2a\u521d\u6b65\u7684\u5370\u8c61\uff1a</p> <pre><code>import matplotlib.pyplot as plt\nimport seaborn as sns\n%matplotlib inline\n\n#\u5bfc\u6570\u6570\u636e\u96c6'titanic'\ntitanic=sns.load_dataset('titanic')\n\n#\u67e5\u770b\u6570\u636e\u96c6\u7684\u968f\u673a10\u884c\u6570\u636e\uff0c\u7528sample\u65b9\u6cd5\ntitanic.sample(10)\n</code></pre> <p></p> <p>\u901a\u8fc7\u89c2\u5bdf\u6570\u636e\uff0c\u6211\u4eec\u5bf9'age'\u8fdb\u884c\u76f4\u65b9\u56fe\u5c55\u793a\u3002\u4f46\u5728\u7ed8\u56fe\u4e4b\u524d\uff0c\u6211\u4eec\u89c2\u6d4b\u5230'age'\u5b57\u6bb5\u4e2d\u5b58\u5728\u7f3a\u5931\u503c\uff0c\u9700\u8981\u5148\u7528 <code>dropna()</code> \u65b9\u6cd5\u5220\u6389\u5b58\u5728\u7f3a\u5931\u503c\u7684\u6570\u636e\uff0c\u5426\u5219\u65e0\u6cd5\u7ed8\u5236\u51fa\u56fe\u5f62\u3002</p> <pre><code>#\u53bb\u9664'age'\u4e2d\u7684\u7f3a\u5931\u503c\uff0cdistplot\u4e0d\u80fd\u5904\u7406\u7f3a\u5931\u6570\u636e\nage1=titanic['age'].dropna()\n\nsns.distplot(age1)\n</code></pre> <p></p> <p>\u5728\u4e0a\u56fe\u4e2d\uff0c\u77e9\u5f62\u8868\u793a\u5728\u4e0d\u540c\u5e74\u9f84\u6bb5\u7684\u6570\u91cf\u5206\u5e03\uff0c\u5e76\u4e14 <code>distplot()</code> \u9ed8\u8ba4\u62df\u5408\u51fa\u4e86\u5bc6\u5ea6\u66f2\u7ebf\uff0c\u53ef\u4ee5\u770b\u51fa\u5206\u5e03\u7684\u53d8\u5316\u89c4\u5f8b\u3002</p> <p>\u540c\u65f6\u6211\u4eec\u53ef\u4ee5\u8c03\u8282\u5176\u4e2d\u7684\u4e00\u4e9b\u53c2\u6570\uff0c\u6765\u63a7\u5236\u8f93\u51fa\u7684\u56fe\u5f62\u3002</p> <p><code>kde</code> \u662f\u63a7\u5236\u5bc6\u5ea6\u4f30\u8ba1\u66f2\u7ebf\u7684\u53c2\u6570\uff0c\u9ed8\u8ba4\u4e3a True\uff0c\u4e0d\u8bbe\u7f6e\u4f1a\u9ed8\u8ba4\u663e\u793a\uff0c\u5982\u679c\u6211\u4eec\u5c06\u5176\u8bbe\u4e3a False\uff0c\u5219\u4e0d\u663e\u793a\u5bc6\u5ea6\u66f2\u7ebf\u3002</p> <pre><code>#\u53bb\u6389\u62df\u5408\u7684\u5bc6\u5ea6\u4f30\u8ba1\u66f2\u7ebf\uff0ckde\u53c2\u6570\u8bbe\u4e3aFalse\nsns.distplot(age1,kde=False)\n</code></pre> <p></p> <p><code>bins</code> \u662f\u63a7\u5236\u5206\u5e03\u77e9\u5f62\u6570\u91cf\u7684\u53c2\u6570\uff0c\u901a\u5e38\u6211\u4eec\u53ef\u4ee5\u589e\u52a0\u5176\u6570\u91cf\uff0c\u6765\u770b\u5230\u66f4\u4e3a\u4e30\u5bcc\u7684\u4fe1\u606f\u3002</p> <p><code>rug</code> \u53c2\u6570\u7528\u4e8e\u63a7\u5236\u76f4\u65b9\u56fe\u4e2d\u7684\u8fb9\u9645\u6bdb\u6bef\uff0c\u901a\u8fc7\u63a7\u5236 <code>rug</code> \u662f\u5b9e\u73b0\u6bdb\u6bef\u662f\u5426\u663e\u793a\u3002</p> <pre><code>#\u521b\u5efa\u4e00\u4e2a\u4e00\u884c2\u5217\u7684\u753b\u5e03,\u4e3b\u8981\u65b9\u4fbf\u5bf9\u6bd4\nfig,axes=plt.subplots(1,2)\n\n#\u8bbe\u7f6e'rug'\u53c2\u6570\uff0c\u52a0\u4e0a\u89c2\u6d4b\u6570\u503c\u7684\u8fb9\u9645\u6bdb\u6bef\n#\u9700\u8981\u7528axes[]\u8868\u793a\u662f\u7b2c\u51e0\u5f20\u56fe\uff0c\u4ece0\u5f00\u59cb\nsns.distplot(age1,ax=axes[0]) #\u5de6\u56fe\nsns.distplot(age1,rug=True,ax=axes[1]) #\u53f3\u56fe\n</code></pre> <p></p> <p>\u5f53\u7136\uff0c\u9664\u4e86\u63a7\u5236\u77e9\u5f62\u5206\u5e03\u3001\u5bc6\u5ea6\u66f2\u7ebf\u53ca\u8fb9\u9645\u6bdb\u6bef\u662f\u5426\u663e\u793a\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u66f4\u4e30\u5bcc\u7684\u53c2\u6570\u63a7\u5236\u4ed6\u4eec\u5c55\u793a\u7684\u7ec6\u8282\uff0c\u8fd9\u4e9b\u901a\u8fc7\u53c2\u6570 <code>hist_kws</code> \u3001<code>kde_kws</code> \u3001<code>rug_kws</code> \u6765\u8fdb\u884c\u8bbe\u7f6e\uff0c\u56e0\u4e3a\u5176\u4e2d\u6d89\u53ca\u5230\u591a\u4e2a\u53c2\u6570\uff0c\u53c2\u6570\u95f4\u7528\u9017\u53f7\u9694\u5f00\uff0c\u53c2\u6570\u5916\u9762\u7528\u5927\u62ec\u53f7\u62ec\u4f4f\u3002</p> <pre><code>#\u53ef\u4ee5\u5206\u522b\u63a7\u5236\u76f4\u65b9\u56fe\u3001\u5bc6\u5ea6\u56fe\u7684\u5173\u952e\u53c2\u6570\nfig,axes=plt.subplots(1,2) \nsns.distplot(age1,rug=True,ax=axes[0])\nsns.distplot(age1,rug=True,\n                     hist_kws={'color':'green','label':'hist'},\n                     kde_kws={'color':'red','label':'KDE'},\n                     ax=axes[1])\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#barplot","title":"barplot \u6761\u5f62\u56fe","text":"<p><code>barplot()</code> \u5229\u7528\u77e9\u9635\u6761\u7684\u9ad8\u5ea6\u53cd\u6620\u6570\u503c\u53d8\u91cf\u7684\u96c6\u4e2d\u8d8b\u52bf\uff0c\u4ee5\u53ca\u4f7f\u7528 <code>errorbar</code> \u529f\u80fd\uff08\u5dee\u68d2\u56fe\uff09\u6765\u4f30\u8ba1\u53d8\u91cf\u4e4b\u95f4\u7684\u5dee\u503c\u7edf\u8ba1\uff08\u7f6e\u4fe1\u533a\u95f4\uff09\u3002 \u9700\u8981\u63d0\u9192\u7684\u662f <code>barplot()</code> \u9ed8\u8ba4\u5c55\u793a\u7684\u662f\u67d0\u79cd\u53d8\u91cf\u5206\u5e03\u7684\u5e73\u5747\u503c\uff08\u53ef\u901a\u8fc7\u53c2\u6570\u4fee\u6539\u4e3a max\u3001median \u7b49\uff09\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u4ecd\u7136\u4ee5'titanic'\u6570\u636e\u96c6\u4f5c\u4e3a\u5c55\u793a\uff0c\u5c06'class'\u8bbe\u4e3ax\u8f74\uff0c'survived'\u8bbe\u4e3ay\u8f74\u3002</p> <pre><code>#\u5c06'class'\u8bbe\u4e3ax\u8f74\uff0c'survived'\u4e3ay\u8f74\uff0c\u4f20\u5165'titanic'\u6570\u636e\nsns.barplot(x='class',y='survived',data=titanic)\n</code></pre> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e'hue'\u53c2\u6570\uff0c\u5bf9x\u8f74\u7684\u6570\u636e\u8fdb\u884c\u7ec6\u5206\uff0c\u7ec6\u5206\u7684\u6761\u4ef6\u5c31\u662f'hue'\u7684\u53c2\u6570\u503c\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u7684x\u8f74\u662f'class'\uff08\u4ed3\u4f4d\u7b49\u7ea7\uff09\uff0c\u6211\u4eec\u5c06\u5176\u6309'sex'\uff08\u6027\u522b\uff09\u518d\u8fdb\u884c\u7ec6\u5206\u3002</p> <p><code>python  sns.barplot(x='class',y='survived',hue='sex',data=titanic)</code></p> <p></p> <p>\u6362\u4e00\u7ec4\u6570\u636e\u8bd5\u8bd5\uff0c\u5c06x\u8f74\u8bbe\u4e3a'embarked'\uff0cy\u8f74\u8bbe\u4e3a'survived'\uff0c\u5e76\u7528'class'\u8fdb\u884c\u7ec6\u5206\u3002</p> <pre><code>sns.barplot(x='embarked',y='survived',\n                        hue='class',data=titanic)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#countplot","title":"countplot \u8ba1\u6570\u56fe","text":"<p><code>countplot</code> \u987e\u540d\u601d\u4e49\uff0c\u8ba1\u6570\u56fe\uff0c\u53ef\u5c06\u5b83\u8ba4\u4e3a\u4e00\u79cd\u5e94\u7528\u5230\u5206\u7c7b\u53d8\u91cf\u7684\u76f4\u65b9\u56fe\uff0c\u4e5f\u53ef\u8ba4\u4e3a\u5b83\u662f\u7528\u4ee5\u6bd4\u8f83\u7c7b\u522b\u95f4\u8ba1\u6570\u5dee\u3002\u5f53\u4f60\u60f3\u8981\u663e\u793a\u6bcf\u4e2a\u7c7b\u522b\u4e2d\u7684\u5177\u4f53\u89c2\u5bdf\u6570\u91cf\u65f6\uff0ccountplot \u5f88\u5bb9\u6613\u5b9e\u73b0\uff0c\u6bd4\u8f83\u7c7b\u4f3c\u6211\u4eec\u5728 Excel \u7b49\u8f6f\u4ef6\u4e2d\u5e94\u7528\u7684\u6761\u5f62\u56fe\u3002</p> <p>\u540c\u6837\uff0c\u6211\u4eec\u4ee5\u6570\u636e\u96c6'titanic'\u4e3a\u4f8b\u5b50\uff0c\u9996\u5148\u63a2\u7d22'deck'\u5b57\u6bb5\u4e0b\u7684\u7c7b\u522b\u8ba1\u6570\u3002</p> <p></p> <pre><code>sns.countplot(x='deck',data=titanic)\n</code></pre> <p></p> <p>\u7531\u6b64\u53ef\u89c1\uff0c\u6211\u4eec\u9009\u5b9a\u67d0\u4e2a\u5b57\u6bb5\uff0ccountplot() \u4f1a\u81ea\u52a8\u5e2e\u6211\u4eec\u7edf\u8ba1\u8be5\u5b57\u6bb5\u4e0b\u5404\u7c7b\u522b\u7684\u6570\u76ee\u3002\u5f53\u7136\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u518d\u4f20\u5165'hue'\u53c2\u6570\uff0c\u8fdb\u884c\u7ec6\u5206\uff0c\u8fd9\u91cc\u6211\u4eec\u52a0\u5165'sex'\u5206\u7c7b\u3002</p> <pre><code>sns.countplot(x='deck',hue='sex',data=titanic)\n</code></pre> <p></p> <p>\u5982\u679c\u6211\u4eec\u5e0c\u671b\u8c03\u6362\u6a2a\u7eb5\u5750\u6807\uff0c\u4e5f\u5c31\u662f\u7c7b\u522b\u653e\u4e8e\u7eb5\u5750\u6807\uff0c\u8ba1\u6570\u503c\u6a2a\u5750\u6807\u663e\u793a\uff0c\u5c06x\u8f74\u6362\u4e3ay\u8f74\u5373\u53ef\u3002</p> <pre><code>sns.countplot(y='deck',hue='who',data=titanic)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#stripplotswarmplot","title":"stripplot/swarmplot \u6563\u70b9\u56fe","text":"<p>\u5728seaborn\u4e2d\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u5206\u7c7b\u6563\u70b9\u56fe\u3002stripplot() \u4f7f\u7528\u7684\u65b9\u6cd5\u662f\u7528\u5c11\u91cf\u7684\u968f\u673a\u201c\u6296\u52a8\u201d\u8c03\u6574\u5206\u7c7b\u8f74\u4e0a\u7684\u70b9\u7684\u4f4d\u7f6e\uff0cswarmplot() \u8868\u793a\u7684\u662f\u5e26\u5206\u5e03\u5c5e\u6027\u7684\u6563\u70b9\u56fe\u3002</p> <pre><code>sns.stripplot(x='embarked',y='fare',data=titanic)\n</code></pre> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e'jitter'\u53c2\u6570\u63a7\u5236\u6296\u52a8\u7684\u5927\u5c0f\u3002</p> <pre><code>sns.stripplot(x='embarked',y='fare',data=titanic,jitter=1)\n</code></pre> <p></p> <p><code>swarmplot()</code> \u65b9\u6cd5\u4f7f\u7528\u9632\u6b62\u5b83\u4eec\u91cd\u53e0\u7684\u7b97\u6cd5\u6cbf\u7740\u5206\u7c7b\u8f74\u8c03\u6574\u70b9\u3002\u5b83\u53ef\u4ee5\u66f4\u597d\u5730\u8868\u793a\u89c2\u6d4b\u7684\u5206\u5e03\uff0c\u5b83\u9002\u7528\u4e8e\u76f8\u5bf9\u8f83\u5c0f\u7684\u6570\u636e\u96c6\u3002</p> <pre><code>sns.swarmplot(x='embarked',y='fare',data=titanic)\n</code></pre> <p></p> <p>\u53ef\u4ee5\u901a\u8fc7'hue'\u53c2\u6570\uff0c\u5bf9\u6563\u70b9\u56fe\u6dfb\u52a0\u66f4\u591a\u7ec6\u5206\u7684\u7ef4\u5ea6\uff0cSeaborn \u4e2d\u4f1a\u4ee5\u989c\u8272\u6765\u8fdb\u884c\u533a\u5206\u3002</p> <p><code>python  sns.stripplot(x='embarked',y='age',hue='who',jitter=1,data=titanic)</code></p> <p></p> <pre><code>sns.swarmplot(x='embarked',y='age',hue='who',data=titanic)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#boxplot","title":"boxplot \u7bb1\u7ebf\u56fe","text":"<p>boxplot\uff08\u7bb1\u7ebf\u56fe\uff09\u662f\u4e00\u79cd\u7528\u4f5c\u663e\u793a\u4e00\u7ec4\u6570\u636e\u5206\u6563\u60c5\u51b5\u7684\u7edf\u8ba1\u56fe\u3002\u5b83\u80fd\u663e\u793a\u51fa\u4e00\u7ec4\u6570\u636e\u7684\u6700\u5927\u503c\u3001\u6700\u5c0f\u503c\u3001\u4e2d\u4f4d\u6570\u53ca\u4e0a\u4e0b\u56db\u5206\u4f4d\u6570\u3002\u56e0\u5f62\u72b6\u5982\u7bb1\u5b50\u800c\u5f97\u540d\u3002\u8fd9\u610f\u5473\u7740\u7bb1\u7ebf\u56fe\u4e2d\u7684\u6bcf\u4e2a\u503c\u5bf9\u5e94\u4e8e\u6570\u636e\u4e2d\u7684\u5b9e\u9645\u89c2\u5bdf\u503c\u3002</p> <p></p> <p>\u4ee5'titanic'\u6570\u636e\u96c6\u4e3a\u4f8b\uff0c\u6211\u4eec\u9996\u5148\u6765\u63a2\u7d22\u4e0d\u540c\u7684'class'\uff08\u8239\u8231\uff09\u4e0b\u7684\u4e58\u5ba2\u7684'age'\uff08\u5e74\u9f84\uff09\u60c5\u51b5\u3002</p> <pre><code>sns.boxplot(x='class',y='age',data=titanic)\n</code></pre> <p></p> <p>\u540c\u6837\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f20\u5165'hue'\u7684\u53c2\u6570\uff0c\u6765\u5bf9x\u8f74\u7684\u5b57\u6bb5\u8fdb\u884c\u7ec6\u5206\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7'who'\u6765\u8fdb\u884c\u5206\u7c7b\u89c2\u5bdf\u3002</p> <pre><code>sns.boxplot(x='class',y='age',hue='who',data=titanic)\n</code></pre> <p></p> <p>\u4e0e\u4e0a\u8ff0\u7c7b\u4f3c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8c03\u6362x/y\u8f74\uff0c\u5b9e\u73b0\u7bb1\u7ebf\u56fe\u7684\u6a2a\u5411\u663e\u793a\u3002</p> <pre><code>sns.boxplot(x='age',y='class',hue='who',data=titanic)\n</code></pre> <p></p> <p>\u8c03\u8282'order' \u548c <code>hue_order</code> \u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236x\u8f74\u5c55\u793a\u7684\u987a\u5e8f\u3002</p> <pre><code>fig,axes=plt.subplots(1,2) \nsns.boxplot(x='class',y='age',hue='who',\n                    data=titanic,ax=axes[0])\nsns.boxplot(x='class',y='age',hue='who',data=titanic,\n                    order=['Third','Second','First'],\n                    hue_order=['child','woman','man'],ax=axes[1])\n</code></pre> <p></p> <p>\u53ef\u4ee5\u901a\u8fc7'linewidth'\u53c2\u6570\uff0c\u63a7\u5236\u7ebf\u6761\u7684\u7c97\u7ec6\u3002\u6211\u4eec\u628a'linewidth'\u53c2\u6570\u8bbe\u4e3a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u6574\u4f53\u56fe\u5f62\u7684\u7ebf\u6761\u53d8\u7ec6\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u8c03\u8282\u3002</p> <pre><code>sns.boxplot(x='class',y='age',hue='who', linewidth=1,data=titanic)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#violinplot","title":"violinplot \u5c0f\u63d0\u7434\u56fe","text":"<p>\u5c0f\u63d0\u7434\u56fe\u5176\u5b9e\u662f\u7bb1\u7ebf\u56fe\u4e0e\u6838\u5bc6\u5ea6\u56fe\u7684\u7ed3\u5408\uff0c\u7bb1\u7ebf\u56fe\u5c55\u793a\u4e86\u5206\u4f4d\u6570\u7684\u4f4d\u7f6e\uff0c\u5c0f\u63d0\u7434\u56fe\u5219\u5c55\u793a\u4e86\u4efb\u610f\u4f4d\u7f6e\u7684\u5bc6\u5ea6\uff0c\u901a\u8fc7\u5c0f\u63d0\u7434\u56fe\u53ef\u4ee5\u77e5\u9053\u54ea\u4e9b\u4f4d\u7f6e\u7684\u5bc6\u5ea6\u8f83\u9ad8\u3002 </p> <p>\u5728\u56fe\u4e2d\uff0c\u767d\u70b9\u662f\u4e2d\u4f4d\u6570\uff0c\u9ed1\u8272\u76d2\u578b\u7684\u8303\u56f4\u662f\u4e0b\u56db\u5206\u4f4d\u70b9\u5230\u4e0a\u56db\u5206\u4f4d\u70b9\uff0c\u7ec6\u9ed1\u7ebf\u8868\u793a\u987b\u3002\u5916\u90e8\u5f62\u72b6\u5373\u4e3a\u6838\u5bc6\u5ea6\u4f30\u8ba1\u3002</p> <p>\u4e0e\u7bb1\u7ebf\u56fe\u8fdb\u884c\u5bf9\u6bd4\uff0c\u540c\u6837\u4ee5'titanic'\u6570\u636e\u96c6\u4e3a\u4f8b\uff0c\u6211\u4eec\u6765\u63a2\u7d22\u4e0d\u540c\u7684'class'\uff08\u8239\u8231\uff09\u4e0b\u4e58\u5ba2\u7684'age'\uff08\u5e74\u9f84\uff09\u60c5\u51b5\u3002</p> <pre><code>sns.violinplot(x='class',y='age',data=titanic)\n</code></pre> <p></p> <p>\u540c\u6837\uff0c\u53ef\u4ee5\u8bbe\u7f6e'hue'\u53c2\u6570\uff0c\u5bf9\u5b57\u6bb5\u8fdb\u884c\u7ec6\u5206\u3002</p> <pre><code>sns.violinplot(x='class',y='age',hue='who',data=titanic)\n</code></pre> <p></p> <p>\u5f53hue\u53c2\u6570\u53ea\u6709\u4e24\u4e2a\u7ea7\u522b\u65f6\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e'split'\u53c2\u6570\u4e3aTrue\uff0c\u201c\u62c6\u5206\u201d\u5c0f\u63d0\u7434\uff0c\u63d0\u7434\u4e24\u8fb9\u5206\u522b\u8868\u793a\u4e24\u4e2a\u5206\u7c7b\u7684\u60c5\u51b5\uff0c\u8fd9\u6837\u53ef\u4ee5\u66f4\u6709\u6548\u5730\u5229\u7528\u7a7a\u95f4\u3002</p> <pre><code>sns.violinplot(x='class',y='age',hue='alive',data=titanic,split=True)\n</code></pre> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u5c0f\u63d0\u7434\u5185\u90e8\u6dfb\u52a0\u56fe\u5f62\u6765\u5e2e\u52a9\u6211\u4eec\u8fdb\u884c\u5206\u6790\uff0c\u8fd9\u91cc\u5c31\u9700\u8981\u63a7\u5236'inner'\u53c2\u6570\u3002</p> <pre><code>sns.violinplot(x='class',y='age',hue='alive',data=titanic,split=True,inner='stick')\n</code></pre> <p></p> <p>\u6211\u4eec\u751a\u81f3\u53ef\u4ee5\u628a\u4e0a\u9762\u63d0\u5230\u7684\u6563\u70b9\u56fe\u52a0\u5165\u5c0f\u63d0\u7434\u56fe\u4e2d\u3002</p> <pre><code>sns.violinplot(x='class',y='age',data=titanic,inner=None)\nsns.swarmplot(x='class',y='age',data=titanic,color='white')\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#regplotlmplot","title":"regplot/lmplot \u56de\u5f52\u56fe","text":"<p>Seaborn \u4e2d\u5229\u7528 <code>regplot()</code> \u548c <code>lmplot()</code> \u6765\u8fdb\u884c\u56de\u5f52\uff0c\u786e\u5b9a\u7ebf\u6027\u5173\u7cfb\uff0c\u5b83\u4eec\u5bc6\u5207\u76f8\u5173\uff0c\u5171\u4eab\u6838\u5fc3\u529f\u80fd\uff0c\u4f46\u4e5f\u6709\u660e\u663e\u7684\u4e0d\u540c\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 Seaborn \u81ea\u5e26\u7684\u6570\u636e\u96c6'iris'\u6765\u7ed8\u5236\u56de\u5f52\u76f8\u5173\u7684\u56fe\u5f62\u3002\u9996\u5148\u6211\u4eec\u5bfc\u5165\u6536\u636e\u6765\u770b\u770b\u6570\u636e\u96c6\u7684\u5927\u6982\u60c5\u51b5\uff1a</p> <pre><code>#\u5bfc\u5165\u6570\u636e\u96c6'iris'\niris=sns.load_dataset('iris')\n\n#\u968f\u673a\u67e5\u770b\u6570\u636e\u96c6\u768410\u884c\u6570\u636e\niris.sample(10)\n</code></pre> <p></p> <p>\u6570\u636e\u96c6\u975e\u5e38\u7b80\u5355\uff0c\u603b\u5171\u662f5\u4e2a\u5b57\u6bb5\uff0c\u6211\u4eec\u9996\u5148\u6765\u770b <code>sepal_length</code> \u548c <code>petal_length</code> \u4e4b\u95f4\u7684\u7ebf\u6027\u5173\u7cfb\u3002</p> <pre><code>sns.regplot(x='sepal_length',y='petal_length',data=iris)\n</code></pre> <p></p> <p>\u56fe\u4e2d\u7684\u70b9\u8868\u793a\u5b9e\u9645\u7684\u6570\u636e\u70b9\uff0cSeaborn \u6839\u636e\u8fd9\u4e9b\u6570\u636e\u62df\u5408\u51fa\u76f4\u7ebf\uff0c\u8868\u793ax\u8f74\u548cy\u8f74\u5bf9\u5e94\u5b57\u6bb5\u4e4b\u95f4\u7684\u7ebf\u6027\u5173\u7cfb\uff0c\u76f4\u7ebf\u5468\u56f4\u7684\u9634\u5f71\u8868\u793a\u7f6e\u4fe1\u533a\u95f4\u3002</p> <p>\u5173\u4e8e\u7f6e\u4fe1\u533a\u95f4\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e'ci'\u53c2\u6570\u63a7\u5236\u662f\u5426\u663e\u793a\u3002</p> <pre><code>sns.regplot(x='sepal_length',y='petal_length',data=iris,ci=None)\n</code></pre> <p></p> <p>\u53ef\u4ee5\u901a\u8fc7'color'\u548c'marker'\u53c2\u6570\u6765\u63a7\u5236\u56fe\u5f62\u7684\u989c\u8272\u4ee5\u53ca\u6570\u636e\u70b9\u7684\u5f62\u72b6\u3002</p> <pre><code>fig,axes=plt.subplots(1,2) \n\nsns.regplot(x='sepal_length',y='petal_length',data=iris,\n            color='r',marker='+',ax=axes[0])\n\nsns.regplot(x='sepal_length',y='petal_length',data=iris,\n            color='g',marker='*',ax=axes[1])\n</code></pre> <p></p> <p><code>lmplot()</code> \u53ef\u4ee5\u8bbe\u7f6ehue\uff0c\u8fdb\u884c\u591a\u4e2a\u7c7b\u522b\u7684\u663e\u793a\uff0c\u800c <code>regplot()</code> \u662f\u4e0d\u652f\u6301\u7684\u3002\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7\u8bbe\u7f6e <code>hue='species'</code>\uff0c\u6765\u8fdb\u884c\u5206\u7c7b\u522b\u5730\u5c55\u793a\u3002</p> <pre><code>sns.lmplot(x='sepal_length',y='petal_length', hue='species',data=iris)\n</code></pre> <p></p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u66f4\u6539\u6570\u636e\u70b9\u7684\u5f62\u72b6\uff0c\u6765\u8fdb\u884c\u533a\u5206\u3002</p> <pre><code>sns.lmplot(x='sepal_length',y='petal_length',hue='species', data=iris,markers=['*','o','+'])\n</code></pre> <p></p> <p>\u8bbe\u7f6e <code>fit_reg</code> \u53c2\u6570\uff0c\u53ef\u4ee5\u63a7\u5236\u662f\u5426\u663e\u793a\u62df\u5408\u7684\u76f4\u7ebf\u3002</p> <pre><code>sns.lmplot(x='sepal_length',y='petal_length',hue='species',\n                    data=iris,markers=['*','o','+'],fit_reg=False)\n</code></pre> <p></p> <p>\u5982\u679c\u8981\u5bf9\u4e0d\u540c\u7684\u7c7b\u522b\u5206\u5f00\u7ed8\u5236\uff0c\u7528'col'\u53c2\u6570\u4ee3\u66ff'hue'\u3002</p> <pre><code>sns.lmplot(x='sepal_length',y='petal_length',\n                    col='species',data=iris)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#heatmap","title":"heatmap \u70ed\u529b\u56fe","text":"<p>\u70ed\u529b\u56fe\u901a\u5e38\u7528\u6765\u8868\u793a\u7279\u5f81\u4e4b\u95f4\u7684\u76f8\u5173\u6027\uff0c\u4e00\u822c\u901a\u8fc7\u989c\u8272\u7684\u6df1\u6d45\u6765\u8868\u793a\u6570\u503c\u7684\u5927\u5c0f\u6216\u8005\u76f8\u5173\u6027\u7684\u9ad8\u4f4e\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5bfc\u5165 Seaborn \u81ea\u5e26\u7684\u53e6\u4e00\u4e2a\u6570\u636e\u96c6'flights'\uff0c\u6765\u7ed8\u5236\u70ed\u529b\u56fe\u3002\u5148\u67e5\u770b\u6570\u636e\u524d10\u884c\u7684\u60c5\u51b5\uff1a</p> <pre><code>flights = sns.load_dataset(\"flights\")\nflights.head(10)\n</code></pre> <p></p> <p>\u6211\u4eec\u4ee5'year'\u4e3a\u7eb5\u8f74\uff0c'month'\u4e3a\u6a2a\u8f74\uff0c'passengers'\u7684\u503c\u4e3a\u6807\u51c6\u7ed8\u5236\u70ed\u529b\u56fe\u3002</p> <pre><code>f=flights.pivot('year','month','passengers')\nsns.heatmap(f)\n</code></pre> <p></p> <p>\u5982\u679c\u8981\u663e\u793a\u5177\u4f53\u7684\u6570\u503c\uff0c\u53ef\u4ee5\u901a\u8fc7'annot'\u53c2\u6570\u6765\u63a7\u5236\u3002</p> <pre><code>sns.heatmap(f, annot=True,fmt=\"d\")\n</code></pre> <p></p> <p>\u901a\u8fc7 Seaborn \u7684\u8c03\u8272\u677f\u63a7\u5236\u70ed\u529b\u56fe\u663e\u793a\u7684\u989c\u8272\uff0c\u8c03\u8272\u677f\u5728\u540e\u7eed\u4f1a\u6709\u8be6\u7ec6\u7684\u8bf4\u660e\uff0c\u8fd9\u91cc\u53ea\u505a\u6f14\u793a\uff0c\u793a\u4f8b\u70ed\u529b\u56fe\u7684\u989c\u8272\u8c03\u8282\u673a\u5236\u3002</p> <pre><code>cmap = sns.diverging_palette(200,20,sep=20,as_cmap=True)\nsns.heatmap(f,cmap=cmap)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#_1","title":"\u56fe\u5f62\u63a7\u5236\u7684\u827a\u672f","text":"<p>\u524d\u9762\u6211\u4eec\u5229\u7528 Seaborn \u7ed8\u5236\u4e86\u5404\u79cd\u7c7b\u578b\u7684\u56fe\u5f62\uff0c\u5bf9\u4e8e\u57fa\u672c\u7684\u5feb\u901f\u5206\u6790\uff0c\u5176\u5b9e\u5df2\u7ecf\u8db3\u591f\uff0c\u4f46\u662f\u5728\u7ec6\u8282\u7684\u8c03\u8282\u3001\u989c\u8272\u3001\u7f8e\u89c2\u5ea6\u7b49\u65b9\u9762\u6211\u4eec\u8fd8\u53ef\u4ee5\u8fdb\u884c\u7cbe\u7ec6\u5316\u7684\u63a7\u5236\u3002</p> <p>\u9996\u5148\u6211\u4eec\u5229\u7528 Numpy \u521b\u5efa\u4e00\u7ec4\u6570\u636e\uff0820\u884c6\u5217\u7684\u968f\u673a\u6570\uff09\uff0c\u7136\u540e\u5229\u7528 Seaborn \u521b\u5efa\u4e00\u4e2a\u7bb1\u7ebf\u56fe\u6765\u8fdb\u884c\u5c55\u793a\u3002</p> <pre><code>#\u521b\u5efa\u4e00\u4e2a20\u884c6\u5217\u7684\u6570\u636e\ndata = np.random.normal(size=(20, 6)) + np.arange(6) / 2\n\nsns.boxplot(data=data)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#_2","title":"\u56fe\u5f62\u80cc\u666f","text":"<p>Seaborn \u4e2d\u6709 white / whitegrid / dark / darkgrid / ticks \u51e0\u79cd\u6837\u5f0f\uff0c\u7528 <code>set_style()</code> \u51fd\u6570\u63a7\u5236\uff0c\u5206\u522b\u5982\u4e0b\uff1a</p> <ul> <li> <p>whitegrid \u767d\u8272\u7f51\u683c\u80cc\u666f</p> </li> <li> <p>white \u767d\u8272\u80cc\u666f\uff08\u9ed8\u8ba4\uff09</p> </li> <li> <p>darkgrid \u9ed1\u8272\u7f51\u683c\u80cc\u666f</p> </li> <li> <p>dark \u9ed1\u8272\u80cc\u666f</p> </li> </ul> <p>ticks \u56db\u5468\u5e26\u6709\u523b\u5ea6\u7684\u767d\u8272\u80cc\u666f</p> <pre><code># \u8bbe\u4e3a\u767d\u8272\u7f51\u683c\u80cc\u666f\nsns.set_style(\"whitegrid\")\nsns.boxplot(data=data)\n</code></pre> <p></p> <pre><code># \u8bbe\u4e3a\u9ed1\u8272\u7f51\u683c\u80cc\u666f\nsns.set_style(\"darkgrid\")\nsns.boxplot(data=data)\n</code></pre> <p></p>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#_3","title":"\u8c03\u8272\u677f","text":"<p>seaborn \u4e2d\u7684\u5206\u7c7b\u8272\u677f\uff0c\u4e3b\u8981\u7528 <code>color_palette()</code> \u51fd\u6570\u63a7\u5236\uff0c<code>color_palette()</code> \u4e0d\u5199\u53c2\u6570\u5219\u663e\u793a\u4e3a Seaborn \u9ed8\u8ba4\u989c\u8272\u3002\u5982\u679c\u9700\u8981\u8bbe\u7f6e\u6240\u6709\u56fe\u5f62\u7684\u989c\u8272\uff0c\u5219\u7528 <code>set_palette()</code> \u51fd\u6570\u5b9a\u4e49\u3002</p> <p>Seaborn \u4e2d6\u4e2a\u9ed8\u8ba4\u7684\u989c\u8272\u5faa\u73af\u4e3b\u9898\u5206\u522b\u4e3a\uff1a deep, muted, pastel, bright, dark, colorblind\uff0c\u4e0b\u9762\u6211\u4eec\u5217\u4e3e\u6f14\u793a\u3002</p> <pre><code># \u8bbe\u7f6e\u989c\u8272\u6a21\u5f0f\u4e3a'deep'\nsns.boxplot(data=data,palette=sns.color_palette('deep'))\n</code></pre> <p></p> <pre><code># \u8bbe\u7f6e\u989c\u8272\u6a21\u5f0f\u4e3a'pastel'\nsns.boxplot(data=data,palette=sns.color_palette('pastel'))\n</code></pre> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u9664\u4e86\u9ed8\u8ba4\u7684\u989c\u8272\u6a21\u5f0f\u670910\u4e2d\u989c\u8272\u5916\uff0c\u5176\u4ed6\u7684\u989c\u8272\u6a21\u5f0f\u53ea\u67096\u79cd\u989c\u8272\uff0c\u5982\u679c\u9700\u8981\u66f4\u591a\u989c\u8272\uff0c\u90a3\u4e48\u5219\u9700\u8981\u91c7\u7528hls\u8272\u5f69\u7a7a\u95f4\u3002</p> <pre><code>#\u521b\u5efa\u4e00\u4e2a20\u884c10\u5217\u7684\u6570\u636e'data2'\ndata2 = np.random.normal(size=(20, 10)) + np.arange(10) / 2  \n\n#\u5229\u7528hls\u8272\u5f69\u7a7a\u95f4\u8fdb\u884c\u8c03\u8272\nsns.boxplot(data=data2, palette=sns.color_palette('hls', 10))  \n</code></pre> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684\u8bbe\u7f6e\uff0c\u5f97\u5230\u5355\u8272\u6e10\u53d8\u7684\u6548\u679c\uff0c\u9ed8\u8ba4\u989c\u8272\u7531\u6d45\u5230\u6df1\u3002</p> <pre><code>#\u53ef\u4ee5\u5c1d\u8bd5 Reds/Greens\uff0c\u9ed8\u8ba4\u989c\u8272\u7531\u6d45\u5230\u6df1\nsns.boxplot(data=data,palette=sns.color_palette('Blues'))  \n</code></pre>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#_4","title":"\u663e\u793a\u4e2d\u6587","text":"<p>Seaborn \u5bf9\u4e2d\u6587\u7684\u663e\u793a\u4e0d\u592a\u53cb\u597d\uff0c\u5982\u679c\u5728\u9047\u5230\u4e71\u7801\u95ee\u9898\u65f6\uff0c\u53ef\u4ee5\u52a0\u5165\u4e0b\u9762\u7684\u4ee3\u7801\u3002</p> <pre><code># \u6307\u5b9a\u9ed8\u8ba4\u5b57\u4f53\nmpl.rcParams['font.sans-serif'] = ['SimHei']  \n\n# \u89e3\u51b3\u4fdd\u5b58\u56fe\u50cf\u662f\u8d1f\u53f7'-'\u663e\u793a\u4e3a\u65b9\u5757\u7684\u95ee\u9898 \nmpl.rcParams['axes.unicode_minus'] = False  \n</code></pre>","tags":["python","seaborn","matplot"]},{"location":"tips/learn-seaborn-with-10min/#_5","title":"\u4fdd\u5b58\u56fe\u7247","text":"<p>\u753b\u51fa\u7684\u56fe\u5f62\u6211\u4eec\u9700\u8981\u4fdd\u5b58\uff0c\u53ef\u4ee5\u5148\u5efa\u7acb\u4e00\u4e2a\u753b\u5e03\uff0c\u8bbe\u7f6e\u6211\u4eec\u56fe\u50cf\u7684\u5927\u5c0f\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a\u753b\u5e03\u4fdd\u5b58\u4e0b\u6765\u3002</p> <pre><code>#\u8bbe\u7f6e\u4e00\u4e2a\uff0812\uff0c6\uff09\u7684\u753b\u5e03\nplt.figure(figsize=(12, 6))\n\n#\u56fe\u5f62\u7ed8\u5236\u4ee3\u7801\nsns.boxplot(data=data,palette=sns.color_palette('Blues')) \n\n#\u5c06\u753b\u5e03\u4fdd\u5b58\u4e3a'xiang.png'\uff0c\u8fd8\u53ef\u4ee5\u4fdd\u5b58\u4e3ajpg\u3001svg\u683c\u5f0f\u56fe\u7247\nplt.savefig('xiang.png')\n</code></pre>","tags":["python","seaborn","matplot"]},{"location":"tips/matplotlib-support-chinese/","title":"\u8ba9 Python \u4e2d matplotlib \u56fe\u652f\u6301\u4e2d\u6587","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c mtaplotlib \u4e0d\u652f\u6301\u4e2d\u6587\u663e\u793a\u6807\u9898\uff0c\u8f74\u6807\u7b49\u3002\u5982\u679c\u9700\u8981\u4e2d\u6587\u652f\u6301\uff0c\u5219\u9700\u8981\u663e\u5f0f\u7684\u5f15\u5165\u5b57\u4f53\u7ba1\u7406\uff0c\u5e76\u6307\u5b9a\u4f7f\u7528\u4f55\u79cd\u5b57\u4f53\u663e\u793a\uff0c\u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u4f8b\u5b50</p> <pre><code>from matplotlib import pyplot as plt\nfrom matplotlib.font_manager import FontProperties\n\nyears = [1950, 1960, 1970, 1980, 1990, 2000, 2010]\ngdp = [300.2, 543.3, 1075.9, 2862.5, 5979.6, 10289.7, 14958.3] \nfont = FontProperties(fname=r'/System/Library/Fonts/PingFang.ttc', size=12)\n# \u521b\u5efa\u4e00\u5e45\u7ebf\u56fe\uff0cx\u8f74\u662f\u5e74\u4efd\uff0cy\u8f74\u662fgdp\nplt.plot(years, gdp, color='green', marker='o', linestyle='solid') \n# \u6dfb\u52a0\u4e00\u4e2a\u6807\u9898\nplt.title(u\"\u540d\u4e49GDP\", fontproperties=font)\n# \u7ed9y\u8f74\u52a0\u6807\u8bb0 \nplt.ylabel(u\"\u5341\u4ebf\u7f8e\u5143\", fontproperties=font)\nplt.show()\n</code></pre> <p>\u663e\u793a\u7684\u56fe\u5982\u4e0b\uff1a</p> <p></p> <p>\u5982\u679c\u8bbe\u7f6e\u7684\u4e2d\u6587\u8f83\u591a\uff0c\u4e0a\u8ff0\u4ee3\u7801\u663e\u5f97\u5570\u55e6\uff0c\u53ef\u4ee5\u5148\u9884\u5148\u8bbe\u5b9a\u753b\u56fe\u65f6\u7684\u9ed8\u8ba4\u5b57\u4f53\u53ca\u76f8\u5173\u5c5e\u6027\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>from matplotlib import pyplot as plt\nfrom matplotlib import rcParams\nfrom matplotlib.font_manager import FontProperties\n\n\n# \u5982\u679c\u4f60\u60f3\u8981\u7684\u5b57\u4f53\u4e0d\u5728 matplotlib \u5e93\u91cc\uff0c\u5219\u9700\u8981\u5c06\u5b57\u4f53\uff08\u8f6c\u6362\uff09\uff0c\u7136\u540e\u62f7\u8d1d\u5230\u5b83\u53ef\u4ee5\u5bfb\u627e\u4ed6\u7684\u4f4d\u7f6e\uff0c\n#\u4e0b\u9762\u7684\u4ee3\u7801\u53ef\u4ee5\u6253\u5370\u5b83\u80fd\u83b7\u53d6\u7684\u6240\u6709\u5b57\u4f53\n#\u5426\u5219\u53ea\u9700\u8981\u6307\u5b9a\u5b57\u7b26\u96c6\u5c31\u597d\u4e86\n#from  matplotlib.font_manager import fontManager as ft\n#print([f.name for f in ft.ttflist])\n#\nrcParams['font.family'] = \"FZHei-B01, Input Mono\"\n\nyears = [1950, 1960, 1970, 1980, 1990, 2000, 2010]\ngdp = [300.2, 543.3, 1075.9, 2862.5, 5979.6, 10289.7, 14958.3] \n\nplt.plot(years, gdp, color='green', marker='o', linestyle='solid') \nplt.title(u\"\u540d\u4e49GDP\")\n\nplt.ylabel(u\"\u5341\u4ebf\u7f8e\u5143\")\nplt.show()\n</code></pre>","tags":["python","matplot","chinse"]},{"location":"tips/move-running-process-into-tmux/","title":"\u628a\u4e00\u4e2a\u8fd0\u884c\u7684\u8fdb\u7a0b\u653e\u5230 tmux \u4f1a\u8bdd\u4e2d","text":"<p>\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u542f\u52a8\u4e00\u4e2a\u9700\u8981\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u8fdb\u7a0b\u65f6\uff0c\u53ef\u80fd\u5fd8\u8bb0\u6253\u5f00 tmux \u3002</p> <p>\u4f46\u662f\u7a0b\u5e8f\u5df2\u7ecf\u5728\u8fd0\u884c\uff0c\u5982\u679c\u4e2d\u65ad\u7a0b\u5e8f\uff0c\u91cd\u65b0\u8fd0\u884c\uff0c\u53ef\u80fd\u9700\u8981\u505a\u4e00\u4e9b\u6570\u636e\u6e05\u7406\u7684\u5de5\u4f5c\u3002</p> <p>\u662f\u5426\u6709\u529e\u6cd5\u628a\u4e00\u4e2a\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\"\u632a\u8fdb\"\u5230 tmux \u4f1a\u8bdd\u91cc\u53bb\u5462\uff1f</p> <p>\u8fd8\u771f\u6709\u8fd9\u6837\u7684\u5de5\u5177\uff0creptry \u5c31\u53ef\u4ee5\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u800c\u4e14\u8be5\u5de5\u5177\u5df2\u7ecf\u5728\u5f88\u591a\u7cfb\u7edf\u7684\u4ed3\u5e93\u91cc\u4e86\uff0c\u6bd4\u5982 CentOS \u7cfb\u5217\uff0c\u5c31\u53ef\u4ee5\u4ece epel \u4ed3\u5e93\u4e2d\u83b7\u53d6</p> <p>\u64cd\u4f5c\u5f88\u7b80\u5355\uff0c\u5b98\u65b9\u6587\u6863\u4e5f\u6709\u8bf4\u660e\uff0c\u7b80\u5355\u63cf\u8ff0\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u5047\u5b9a\u4f60\u542f\u52a8\u4e86\u4e00\u4e2a\u8fd0\u884c\u5728\u524d\u53f0\u7684\u670d\u52a1\uff0c\u6bd4\u5982 <code>top</code> \u547d\u4ee4</p> </li> <li> <p>\u5728\u5f53\u524d\u8fd0\u884c\u8fdb\u7a0b\u4e0a\uff0c\u6309 <code>CTRL-Z</code> \u5c06\u5176\u8f6c\u5230\u540e\u53f0</p> </li> </ol> <p><code>[1]+  \u5df2\u505c\u6b62               top</code></p> <ol> <li>\u6267\u884c <code>bg</code> \u547d\u4ee4\uff0c\u8ba9\u5176\u5728\u540e\u53f0\u7ee7\u7eed\u8fd0\u884c</li> </ol> <pre><code>$ bg\n[1]+ top &amp;\n[1]+  \u5df2\u505c\u6b62               top\n</code></pre> <ol> <li>\u6267\u884c <code>disowner top</code> \u5c06\u8be5\u8fd0\u884c\u7684\u670d\u52a1\u4e0e\u76ee\u524d\u7684\u7ec8\u7aef\u65ad\u5f00\uff0c\u8fd9\u6837\u4f60\u6267\u884c <code>jobs</code> \u547d\u4ee4\u662f\u770b\u4e0d\u5230\u6709\u8f6c\u540e\u53f0\u7684\u8fdb\u7a0b\u4e86\uff0c\u4f46\u662f <code>ps -a</code> \u8fd8\u662f\u80fd\u627e\u5230 <code>top</code> \u8fd9\u4e2a\u8fdb\u7a0b\u7684</li> <li>\u53e6\u5f00\u4e00\u4e2a\u7ec8\u7aef\uff0c\u5f00\u542f tmux\uff0c\u7136\u540e\u5728 tmux \u4f1a\u8bdd\u91cc\uff0c\u6267\u884c <code>reptyr &lt;pid&gt;</code> \uff0c\u5176\u4e2d <code>&lt;pid&gt;</code> \u5c31\u662f <code>top</code>\u8fdb\u7a0b\u5f53\u524d\u7684\u8fdb\u7a0bID</li> <li>\u73b0\u5728\u4f60\u80fd\u770b\u5230 <code>top</code> \u547d\u4ee4\u5df2\u7ecf\u8fd0\u884c\u5728\u5f53\u524d tmux \u4f1a\u8bdd\u91cc\u4e86\u3002</li> </ol>","tags":["tmux","session"]},{"location":"tips/rpm-tutorial/","title":"rpm \u5305\u7ba1\u7406\u57fa\u672c\u6280\u80fd","text":"On this page<ul> <li>rpm \u5305\u7ba1\u7406\u57fa\u672c\u6280\u80fd<ul> <li>\u8ba8\u8bba\u70b9</li> <li>RPM \u5305\u7ba1\u7406\u57fa\u672c\u64cd\u4f5c<ul> <li>\u5e38\u7528 RPM \u547d\u4ee4</li> <li>RPM \u5305\u67e5\u8be2</li> <li>RPM \u5305\u6821\u9a8c</li> <li>\u7b7e\u540d\u6821\u9a8c</li> <li>\u89e3\u538bRPM\u5305</li> </ul> </li> <li>\u7f16\u8bd1\u81ea\u5df1\u7684 RPM \u5305<ul> <li>\u914d\u7f6e\u7f16\u8bd1\u73af\u5883</li> <li>\u521b\u5efa rpm \u5305</li> <li>RPM Spec \u6587\u4ef6</li> </ul> </li> <li>\u5b9e\u6218<ul> <li>\u6e90\u4ee3\u7801\u51c6\u5907</li> <li>\u7f16\u8bd1\u65e0 spec \u6587\u4ef6\u7684\u6e90\u4ee3\u7801\u4e3a rpm \u5305</li> <li>\u7f16\u8bd1\u81ea\u5e26 spec \u6587\u4ef6\u7684\u6e90\u4ee3\u7801\u4e3a RPM\u5305</li> <li>\u7f16\u8bd1 SRPM \u5305\u5230\u4e8c\u8fdb\u5236 RPM\u5305</li> </ul> </li> </ul> </li> </ul>"},{"location":"tips/rpm-tutorial/#_1","title":"\u8ba8\u8bba\u70b9","text":"<ul> <li>RPM \u5305\u7ba1\u7406\u57fa\u672c\u64cd\u4f5c</li> <li>\u7f16\u8bd1\u81ea\u5df1\u7684 RPM \u5305</li> <li>\u521b\u5efa\u53ef\u4e0b\u8f7d\u7684 RPM \u5305</li> <li>\u9ad8\u7ea7 RPM \u6253\u5305\u6280\u672f</li> </ul>"},{"location":"tips/rpm-tutorial/#rpm_1","title":"RPM \u5305\u7ba1\u7406\u57fa\u672c\u64cd\u4f5c","text":"<ul> <li>RPM means Redhat Package Management</li> <li>RedHat \u7cfb\u5217\uff0c Fedora \u7cfb\u5217\uff0cCentOS \u7cfb\u5217\u4ee5\u53ca\u5176\u4ed6\u90e8\u5206\u56fd\u4ea7Linux\u64cd\u4f5c\u7cfb\u7edf \u4f7f\u7528 RPM</li> <li>\u7531\u8f6f\u4ef6\u5305\u4ee5\u53ca\u4e00\u5957\u811a\u672c\u7ec4\u6210</li> </ul>"},{"location":"tips/rpm-tutorial/#rpm_2","title":"\u5e38\u7528 RPM \u547d\u4ee4","text":"<ul> <li>\u5b89\u88c5</li> <li><code>rpm -ivh &lt;package name&gt;</code></li> <li>\u66f4\u65b0</li> <li><code>rpm -Uvh &lt;package name&gt;</code></li> <li>\u5237\u65b0</li> <li><code>rpm -Fvh &lt;package name&gt;</code></li> <li>\u5220\u9664</li> <li>`rpm -e"},{"location":"tips/rpm-tutorial/#rpm_3","title":"RPM \u5305\u67e5\u8be2","text":"<ul> <li> <p><code>rpm -q[option] &lt;package name&gt;</code></p> </li> <li> <p><code>-qi</code>: \u67e5\u8be2\u5305\u57fa\u672c\u4fe1\u606f</p> </li> </ul> <pre><code>$ rpm -qi kernel\nName        : kernel\nVersion     : 3.10.0\nRelease     : 957.el7\nArchitecture: x86_64\nInstall Date: Wed 10 Jun 2020 06:01:23 PM CST\nGroup       : System Environment/Kernel\nSize        : 66205689\nLicense     : GPLv2\nSignature   : RSA/SHA256, Fri 05 Oct 2018 08:48:54 AM CST, Key ID 199e2f91fd431d51\nSource RPM  : kernel-3.10.0-957.el7.src.rpm\nBuild Date  : Fri 05 Oct 2018 05:13:25 AM CST\nBuild Host  : x86-040.build.eng.bos.redhat.com\nRelocations : (not relocatable)\nPackager    : Red Hat, Inc. &lt;http://bugzilla.redhat.com/bugzilla&gt;\nVendor      : Red Hat, Inc.\nURL         : http://www.kernel.org/\nSummary     : The Linux kernel\nDescription :\nThe kernel package contains the Linux kernel (vmlinuz), the core of any\nLinux operating system.  The kernel handles the basic functions\nof the operating system: memory allocation, process allocation, device\ninput and output, etc.\n</code></pre> <ul> <li><code>-ql</code>: \u5217\u51fa\u5305\u5305\u542b\u7684\u6587\u4ef6</li> </ul> <pre><code>$ rpm -ql bind-utils\n/etc/trusted-key.key\n/usr/bin/dig\n/usr/bin/host\n/usr/bin/nslookup\n/usr/bin/nsupdate\n/usr/share/man/man1/dig.1.gz\n/usr/share/man/man1/host.1.gz\n/usr/share/man/man1/nslookup.1.gz\n/usr/share/man/man1/nsupdate.1.gz\n</code></pre> <ul> <li><code>-qf</code>: \u67e5\u8be2\u6587\u4ef6\u5c5e\u4e8e\u54ea\u4e2a\u5305</li> </ul> <pre><code>$ rpm -qf /usr/bin/sudo\nsudo-1.9.5-3.el7.x86_64\n</code></pre> <ul> <li><code>--queryformat</code> \u6307\u5b9a\u67e5\u8be2\u7684\u8f93\u51fa\u683c\u5f0f</li> </ul> <pre><code>rpm -q --queryformat \"[%-50{FILENAMES} %10{FILESIZES}\\n]\" bind-utils\n/etc/trusted-key.key                                      750\n/usr/bin/dig                                           129472\n/usr/bin/host                                          117336\n/usr/bin/nslookup                                      117240\n/usr/bin/nsupdate                                       62304\n/usr/share/man/man1/dig.1.gz                             7339\n/usr/share/man/man1/host.1.gz                            3058\n/usr/share/man/man1/nslookup.1.gz                        2465\n/usr/share/man/man1/nsupdate.1.gz                        5229\n</code></pre> <ul> <li><code>--querytags</code> \u5217\u51fa\u6709\u6548\u7684\u6807\u7b7e\uff0c\u7528\u4e8e <code>queryformat</code></li> </ul> <pre><code>$ rpm -q --querytags bind-utils |head -n10\nARCH\nARCHIVESIZE\nBASENAMES\nBUGURL\nBUILDARCHS\nBUILDHOST\nBUILDTIME\nC\nCHANGELOGNAME\nCHANGELOGTEXT\n</code></pre> <ul> <li><code>-p</code> \uff1a\u67e5\u8be2\u6ca1\u6709\u5b89\u88c5\u7684\u5305\uff0c\u76f4\u63a5\u67e5\u8be2 RPM \u5305\u672c\u8eab</li> </ul> <pre><code>$ rpm -qpi nginx-1.23.1-1.el7.ngx.src.rpm\n\u8b66\u544a\uff1anginx-1.23.1-1.el7.ngx.src.rpm: \u5934V4 RSA/SHA256 Signature, \u5bc6\u94a5 ID 7bd9bf62: NOKEY\nName        : nginx\nEpoch       : 1\nVersion     : 1.23.1\nRelease     : 1.el7.ngx\nArchitecture: aarch64\nInstall Date: (not installed)\nGroup       : System Environment/Daemons\nSize        : 1132326\nLicense     : 2-clause BSD-like license\nSignature   : RSA/SHA256, 2022\u5e7407\u670819\u65e5 \u661f\u671f\u4e8c 23\u65f646\u520623\u79d2, Key ID abf5bd827bd9bf62\nSource RPM  : (none)\nBuild Date  : 2022\u5e7407\u670819\u65e5 \u661f\u671f\u4e8c 23\u65f621\u520632\u79d2\nBuild Host  : ip-10-1-17-54.eu-central-1.compute.internal\nRelocations : (not relocatable)\nVendor      : NGINX Packaging &lt;nginx-packaging@f5.com&gt;\nURL         : https://nginx.org/\nSummary     : High performance web server\nDescription :\nnginx [engine x] is an HTTP and reverse proxy server, as well as\na mail proxy server.\n</code></pre> <ul> <li><code>-a</code> : \u5217\u51fa\u6240\u6709\u5df2\u7ecf\u5b89\u88c5\u7684\u5305</li> </ul> <pre><code>$ rpm -qa |head -n10\niftop-1.0-0.21.pre4.el7.x86_64\nlibref_array-0.1.5-32.el7.x86_64\nlibpipeline-1.2.3-3.el7.x86_64\npython-magic-5.11-35.el7.noarch\nlibsane-hpaio-3.15.9-3.el7.x86_64\nliberation-fonts-common-1.07.2-16.el7.noarch\nlibblockdev-nvdimm-2.18-3.el7.x86_64\nsysvinit-tools-2.88-14.dsf.el7.x86_64\npython-blivet-0.61.15.72-1.el7.noarch\npython-chardet-2.2.1-1.el7_1.noarch\n\n$ rpm -qa --queryformat \"[%-50{NAME}\\n]\" |head -n10\niftop\nlibref_array\nlibpipeline\npython-magic\nlibsane-hpaio\nliberation-fonts-common\nlibblockdev-nvdimm\nsysvinit-tools\npython-blivet\npython-chardet\n</code></pre> <ul> <li><code>--scripts</code>:  \u67e5\u8be2\u5305\u6240\u5185\u7f6e\u7684\u811a\u672c</li> </ul> <pre><code>$  rpm -q --scripts nginx\npostinstall scriptlet (using /bin/sh):\n\nif [ $1 -eq 1 ] ; then\n        # Initial installation\n        systemctl preset nginx.service &gt;/dev/null 2&gt;&amp;1 || :\nfi\npreuninstall scriptlet (using /bin/sh):\n\nif [ $1 -eq 0 ] ; then\n        # Package removal, not upgrade\n        systemctl --no-reload disable nginx.service &gt; /dev/null 2&gt;&amp;1 || :\n        systemctl stop nginx.service &gt; /dev/null 2&gt;&amp;1 || :\nfi\npostuninstall scriptlet (using /bin/sh):\n\nsystemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :\n\nif [ $1 -ge 1 ]; then\n    /usr/bin/nginx-upgrade &gt;/dev/null 2&gt;&amp;1 || :\nfi\n</code></pre>"},{"location":"tips/rpm-tutorial/#rpm_4","title":"RPM \u5305\u6821\u9a8c","text":"<ul> <li> <p><code>rpm -V[option] &lt;package name&gt;</code></p> </li> <li> <p>\u901a\u8fc7\u6307\u5b9a\u7684\u7ef4\u5ea6\u6765\u6bd4\u8f83\u76ee\u524d\u8f6f\u4ef6\u5305\u7684\u6587\u4ef6\u72b6\u6001\u548c RPM \u6570\u636e\u5e93\u4e2d\u6587\u4ef6\u72b6\u6001\u7684\u5bf9\u6bd4</p> </li> <li> <p>\u53ef\u4ee5\u6bd4\u8f83\u6587\u4ef6\u5927\u5c0f\uff0cMD5 \u503c\uff0c\u6743\u9650\uff0c\u7c7b\u578b\uff0c\u5c5e\u7ec4\u7b49</p> </li> </ul> <pre><code>$ rpm -qV  nginx\nS.5....T.  c /etc/nginx/nginx.conf\n</code></pre> \u6807\u8bc6 \u542b\u4e49 <code>5</code> MD5\u6821\u9a8c\u548c <code>S</code> \u6587\u4ef6\u5927\u5c0f <code>L</code> \u7b26\u53f7\u8fde\u63a5 <code>T</code> \u4fee\u6539\u65f6\u95f4 <code>D</code> \u8bbe\u5907 <code>U</code> \u7528\u6237 <code>G</code> \u7ec4 <code>M</code> \u6a21\u5f0f(\u5305\u62ec\u8bb8\u53ef\u548c\u6587\u4ef6\u7c7b\u578b)"},{"location":"tips/rpm-tutorial/#_2","title":"\u7b7e\u540d\u6821\u9a8c","text":"<ul> <li> <p><code>rpm {-K|--checksig} &lt;package file&gt;</code></p> </li> <li> <p>\u7528\u6765\u68c0\u9a8c\u5305\u7684 <code>gpg/pgp</code> \u7b7e\u540d\u662f\u5426\u6b63\u786e</p> </li> </ul> <pre><code># rpm -K net-tools-2.0-0.25.20131004git.el7.x86_64.rpm\nnet-tools-2.0-0.25.20131004git.el7.x86_64.rpm: rsa sha1 (md5) pgp md5 \u786e\u5b9a\n\n# rpm -K zabbix-agent-5.0.25-1.el7.x86_64.rpm\nzabbix-agent-5.0.25-1.el7.x86_64.rpm: RSA sha1 (MD5) PGP md5 \u4e0d\u6b63\u786e\n</code></pre>"},{"location":"tips/rpm-tutorial/#rpm_5","title":"\u89e3\u538bRPM\u5305","text":"<ul> <li>\u901a\u8fc7\u628a RPM \u5305\u8f6c\u6210 cpio \u6d41\u7684\u65b9\u5f0f\u95f4\u63a5\u89e3\u538b</li> </ul> <pre><code># rpm2cpio net-tools-2.0-0.25.20131004git.el7.x86_64.rpm |cpio -id\n1849 \u5757\n# tree -L 2 .\n.\n\u251c\u2500\u2500 bin\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 netstat\n\u251c\u2500\u2500 sbin\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 arp\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ether-wake\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ifconfig\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ipmaddr\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 iptunnel\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 mii-diag\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 mii-tool\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nameif\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 plipconfig\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 route\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 slattach\n\u2514\u2500\u2500 usr\n    \u251c\u2500\u2500 lib\n    \u2514\u2500\u2500 share\n\n5 directories, 12 files\n</code></pre>"},{"location":"tips/rpm-tutorial/#rpm_6","title":"\u7f16\u8bd1\u81ea\u5df1\u7684 RPM \u5305","text":"<p>\u7b80\u5355\u8bb2\u8ff0\u5982\u4f55\u521b\u5efa\u4e00\u4e2a RPM \u5305</p>"},{"location":"tips/rpm-tutorial/#_3","title":"\u914d\u7f6e\u7f16\u8bd1\u73af\u5883","text":"<ul> <li> <p>\u4e0d\u8981\u4f7f\u7528 <code>root</code> \u5e10\u53f7\u6765\u505a rpm \u5305\u7f16\u8bd1\u64cd\u4f5c</p> </li> <li> <p><code>$HOME/.rpmmacros</code> \u914d\u7f6e\uff08\u53ef\u9009)</p> </li> <li> <p><code>%_topdir /path/to/rpm/build/env</code></p> </li> <li> <p>\u9ed8\u8ba4\u662f <code>$HOME/rpmbuild</code></p> </li> <li> <p>\u521b\u5efa\u9700\u8981\u7684\u76ee\u5f55</p> </li> <li> <p><code>~/rpmbuild/BUILD</code></p> </li> <li> <p><code>~/rpmbuild/RPMS/&lt;arch&gt;</code></p> </li> <li> <p><code>~/rpmbuild/RPMS/noarch</code></p> </li> <li> <p><code>~/rpmbuild/SOURCES</code></p> </li> <li> <p><code>~/rpmbuild/SPECS</code></p> </li> <li> <p><code>~/rpmbuild/SRPMS</code></p> </li> <li> <p><code>rpmdevtools</code> \u63d0\u5347\u6548\u7387</p> </li> <li> <p><code>rpmdev-setuptree</code></p> </li> </ul> \u76ee\u5f55 \u7528\u9014 BUILD \u7f16\u8bd1\u65f6\uff0c \u53d8\u91cf  <code>%buildroot</code> \u6307\u5411\u8be5\u76ee\u5f55\uff0c\u4ed6\u5305\u542b\u7f16\u8bd1\u662f\u7684\u4e2d\u95f4\u6587\u4ef6\u4ea7\u51fa\uff0c\u5305\u62ec\u7f16\u8bd1\u65e5\u5fd7\u7b49\u3002 RPMS \u4fdd\u5b58\u7f16\u8bd1\u51fa\u6765\u7684\u4e8c\u8fdb\u5236 RPM \u5305\u76ee\u5f55\u3002\u5b83\u5305\u542b CPU \u67b6\u6784\u6709\u5173\u7684\u5b50\u76ee\u5f55\uff0c\u6bd4\u5982 <code>x86_64</code> \u548c <code>noarch</code>. SOURCES \u6e90\u4ee3\u7801\u548c\u8865\u4e01\u6587\u4ef6\u6240\u5728\u76ee\u5f55 SPECS spec \u6587\u4ef6\u6240\u5728\u76ee\u5f55 SRPMS \u5f53\u7528 <code>rpmbuid</code> \u6765\u7f16\u8bd1\u4e00\u4e2a  SRPM \u5305\u800c\u4e0d\u662f\u4e8c\u8fdb\u5236 RPM \u5305\u65f6\uff0c\u4f1a\u653e\u5728\u6b64\u76ee\u5f55\u3002"},{"location":"tips/rpm-tutorial/#rpm_7","title":"\u521b\u5efa rpm \u5305","text":"<p><code>rpmbuild</code> \u662f\u7528\u6765\u521b\u5efa rpm \u5305\u7684\u547d\u4ee4\uff0c\u4ed6\u63d0\u4f9b\u4e86\u591a\u79cd\u9014\u5f84\u6765\u7f16\u8bd1 rpm \u5305\uff0c\u4e0b\u9762\u5217\u51fa\u6700\u5e38\u7528\u7684</p> \u53c2\u6570 \u542b\u4e49 <code>-bp</code> \u4f9d\u636e <code>&lt;specfile&gt;</code> \u4ece <code>%prep</code> (\u89e3\u538b\u7f29\u6e90\u4ee3\u7801\u5e76\u5e94\u7528\u8865\u4e01) \u5f00\u59cb\u6784\u5efa <code>-ba</code> \u4f9d\u636e <code>&lt;specfile&gt;</code> \u6784\u5efa\u6e90\u4ee3\u7801\u548c\u4e8c\u8fdb\u5236\u8f6f\u4ef6\u5305 <code>-bb</code> \u4f9d\u636e <code>&lt;specfile&gt;</code> \u6784\u5efa\u4e8c\u8fdb\u5236\u8f6f\u4ef6\u5305 <code>-bs</code> \u4f9d\u636e <code>&lt;specfile&gt;</code> \u6784\u5efa\u6e90\u4ee3\u7801\u8f6f\u4ef6\u5305 <code>-ta</code> \u4f9d\u636e <code>&lt;tarball&gt;</code> \u6784\u5efa\u6e90\u4ee3\u7801\u548c\u4e8c\u8fdb\u5236\u8f6f\u4ef6\u5305 <code>-tb</code> \u4f9d\u636e <code>&lt;tarball&gt;</code> \u6784\u5efa\u4e8c\u8fdb\u5236\u8f6f\u4ef6\u5305 <code>-ts</code> \u4f9d\u636e <code>&lt;tarball&gt;</code> \u6784\u5efa\u6e90\u4ee3\u7801\u8f6f\u4ef6\u5305 <code>--rebuild</code> \u4f9d\u636e <code>&lt;source package&gt;</code> \u6784\u5efa\u4e8c\u8fdb\u5236\u8f6f\u4ef6\u5305 <ul> <li>\u9700\u8981\u8f6f\u4ef6\u6e90\u4ee3\u7801\uff0c\u8865\u4e01\uff08\u5982\u6709\uff09\u4ee5\u53ca <code>spec</code> \u6587\u4ef6</li> </ul>"},{"location":"tips/rpm-tutorial/#rpm-spec","title":"RPM Spec \u6587\u4ef6","text":"<p><code>spec</code> \u6587\u4ef6\u5185\u5bb9\u5206\u6210\u4ee5\u4e0b\u5185\u5bb9</p> \u533a\u57df \u5b9a\u4e49 <code>%description</code> A full description of the software packaged in the RPM. This description can span multiple lines and can be broken into paragraphs. <code>%prep</code> Command or series of commands to prepare the software to be built, for example, unpacking the archive in <code>Source0</code>. This directive can contain a shell script. <code>%build</code> Command or series of commands for actually building the software into machine code (for compiled languages) or byte code (for some interpreted languages). <code>%install</code> Command or series of commands for copying the desired build artifacts from the <code>%builddir</code>(where the build happens) to the <code>%buildroot</code> directory (which contains the directory structure with the files to be packaged). This usually means copying files from <code>~/rpmbuild/BUILD</code> to <code>~/rpmbuild/BUILDROOT</code> and creating the necessary directories in <code>~/rpmbuild/BUILDROOT</code>. This is only run when creating a package, not when the end-user installs the package. See Working with SPEC files for details. <code>%check</code> Command or series of commands to test the software. This normally includes things such as unit tests. <code>%files</code> The list of files that will be installed in the end user\u2019s system. <code>%changelog</code> A record of changes that have happened to the package between different <code>Version</code> or <code>Release</code>builds. <p>\u6bcf\u4e2a\u533a\u57df\u90e8\u5206\u90fd\u53ef\u4ee5\u4f7f\u7528\u9884\u5148\u5b9a\u4e49\u7684\u6307\u4ee4\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a</p> SPEC \u6307\u5b9a \u5b9a\u4e49 <code>Name</code> The base name of the package, which should match the SPEC file name. <code>Version</code> The upstream version number of the software. <code>Release</code> The number of times this version of the software was released. Normally, set the initial value to 1%{?dist}, and increment it with each new release of the package. Reset to 1 when a new <code>Version</code> of the software is built. <code>Summary</code> A brief, one-line summary of the package. <code>License</code> The license of the software being packaged. For packages distributed in community distributions such as Fedora this must be an open source license abiding by the specific distribution\u2019s licensing guidelines. <code>URL</code> The full URL for more information about the program. Most often this is the upstream project website for the software being packaged. <code>Source0</code> Path or URL to the compressed archive of the upstream source code (unpatched, patches are handled elsewhere). This should point to an accessible and reliable storage of the archive, for example, the upstream page and not the packager\u2019s local storage. If needed, more SourceX directives can be added, incrementing the number each time, for example: Source1, Source2, Source3, and so on. <code>Patch0</code> The name of the first patch to apply to the source code if necessary. If needed, more PatchX directives can be added, incrementing the number each time, for example: Patch1, Patch2, Patch3, and so on. <code>BuildArch</code> If the package is not architecture dependent, for example, if written entirely in an interpreted programming language, set this to <code>BuildArch: noarch</code>. If not set, the package automatically inherits the Architecture of the machine on which it is built, for example <code>x86_64</code>. <code>BuildRequires</code> A comma- or whitespace-separated list of packages required for building the program written in a compiled language. There can be multiple entries of <code>BuildRequires</code>, each on its own line in the SPEC file. <code>Requires</code> A comma- or whitespace-separated list of packages required by the software to run once installed. There can be multiple entries of <code>Requires</code>, each on its own line in the SPEC file. <code>ExcludeArch</code> If a piece of software can not operate on a specific processor architecture, you can exclude that architecture here."},{"location":"tips/rpm-tutorial/#_4","title":"\u5b9e\u6218","text":"<p>\u4ece\u4e09\u79cd\u573a\u666f\u6765\u7f16\u8bd1 rpm \u4e8c\u8fdb\u5236\u5305\uff0c</p>"},{"location":"tips/rpm-tutorial/#_5","title":"\u6e90\u4ee3\u7801\u51c6\u5907","text":"<p>\u6211\u4eec\u5047\u5b9a\u6709\u4e00\u4e2a\u81ea\u521b\u7684\u9879\u76ee\uff0c\u6e90\u4ee3\u7801\u53ea\u5305\u542b\u4e00\u4e2a <code>cello.c</code></p> <p>\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>#include &lt;stdio.h&gt;\n\nint main(void) {\n    printf(\"Hello World\\n\");\n    return 0;\n}\n</code></pre> <p>\u6784\u5efa <code>Makefile</code> \u6587\u4ef6</p> <pre><code>cello:\n        gcc -g -o cello cello.c\n\nclean:\n        rm cello\n\ninstall:\n        mkdir -p $(DESTDIR)/usr/bin\n        install -m 0755 cello $(DESTDIR)/usr/bin/cello\n</code></pre> <p>\u63d0\u4f9b\u4e00\u4e2a LICENSE \u6587\u4ef6 </p> <pre><code>$ cat LICENSE\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.\n</code></pre> <p>\u628a\u6e90\u4ee3\u7801\u653e\u5230\u538b\u7f29\u5305\u91cc</p> <pre><code>$ ls  -w1 cello-0.1/\ncello.c\nLICENSE\nMakefile\n\n$ tar -cvzf cello-1.0.tar.gz cello-0.1/\ncello-0.1/\ncello-0.1/Makefile\ncello-0.1/cello.c\ncello-0.1/LICENSE\n</code></pre> <p>\u628a\u6e90\u4ee3\u7801\u653e\u5230 rpm \u7f16\u8bd1\u73af\u5883</p> <pre><code>mv cello-0.1.tar.gz ~/rpmbuild/SOURCES\n</code></pre>"},{"location":"tips/rpm-tutorial/#spec-rpm","title":"\u7f16\u8bd1\u65e0 spec \u6587\u4ef6\u7684\u6e90\u4ee3\u7801\u4e3a rpm \u5305","text":""},{"location":"tips/rpm-tutorial/#rpmdev-newspec-spec","title":"\u4f7f\u7528 <code>rpmdev-newspec</code> \u521b\u5efa <code>spec</code> \u6a21\u677f\u6587\u4ef6","text":"<pre><code>$ rpmdev-newspec -o rpmbuild/SPECS/cello.spec\nrpmbuild/SPECS/cello.spec created; type minimal, rpm version &gt;= 4.11.\n\n$ cat rpmbuild/SPECS/cello.spec\nName:           cello\nVersion:\nRelease:        1%{?dist}\nSummary:\n\nLicense:\nURL:\nSource0:\n\nBuildRequires:\nRequires:\n\n%description\n\n\n%prep\n%setup -q\n\n\n%build\n%configure\nmake %{?_smp_mflags}\n\n\n%install\nrm -rf $RPM_BUILD_ROOT\n%make_install\n\n\n%files\n%doc\n\n\n\n%changelog\n</code></pre>"},{"location":"tips/rpm-tutorial/#_6","title":"\u5b8c\u5584\u914d\u7f6e\u6587\u4ef6","text":"<p>\u81ea\u884c\u586b\u5145\u4e0a\u8ff0\u6a21\u677f\u6587\u4ef6\u7684\u7a7a\u767d\u5185\u5bb9\uff0c\u5982\u4e0b\uff1a</p> <pre><code>Name:           cello\nVersion:        0.1\nRelease:        1%{?dist}\nSummary:       Hello World example implemented in C programming language\n\nLicense:       GPLv3+\nURL:            https://example.com/%{name}\nSource0:       https://example.com/%{name}/release/%{name}-%{version}.tar.gz\n\nBuildRequires:  gcc, make\n\n%description\nThe long-tail description for our Hello World Example implemented in\nC programming language.\n\n%prep\n%setup -q\n\n\n%build\nmake %{?_smp_mflags}\n\n\n%install\nrm -rf $RPM_BUILD_ROOT\n%make_install\n\n\n%files\n%doc\n%license LICENSE\n%{_bindir}/%{name}\n\n\n%changelog\n* Thu Feb 23 2023 Steven Zhao &lt;zhaoweiguo@lczq.com&gt; - 0.1-1\n- First bello package\n- Example second item in the changelog for version-release 0.1-1\n</code></pre>"},{"location":"tips/rpm-tutorial/#_7","title":"\u5f00\u59cb\u7f16\u8bd1","text":"<pre><code>$ rpmbuild -bb rpmbuild/SPECS/cello.spec\n\u6267\u884c(%prep): /bin/sh -e /var/tmp/rpm-tmp.fbkOro\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ rm -rf cello-0.1\n+ /usr/bin/gzip -dc /home/gitlab-runner/rpmbuild/SOURCES/cello-0.1.tar.gz\n+ /usr/bin/tar -xf -\n+ STATUS=0\n+ '[' 0 -ne 0 ']'\n+ cd cello-0.1\n+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .\n+ exit 0\n\u6267\u884c(%build): /bin/sh -e /var/tmp/rpm-tmp.s3374A\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ make -j6\ngcc -g -o cello cello.c\n+ exit 0\n\u6267\u884c(%install): /bin/sh -e /var/tmp/rpm-tmp.j5LTBO\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ '[' /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64 '!=' / ']'\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n++ dirname /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT\n+ mkdir /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ cd cello-0.1\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ /usr/bin/make install DESTDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\nmkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin\ninstall -m 0755 cello /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\n+ /usr/lib/rpm/find-debuginfo.sh --strict-build-id -m --run-dwz --dwz-low-mem-die-limit 10000000 --dwz-max-die-limit 110000000 /home/gitlab-runner/rpmbuild/BUILD/cello-0.1\nextracting debug info from /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\ndwz: Too few files for multifile optimization\n/usr/lib/rpm/sepdebugcrcfix: Updated 1 CRC32s, 0 CRC32s did match.\n1 block\n+ /usr/lib/rpm/check-buildroot\n+ /usr/lib/rpm/redhat/brp-compress\n+ /usr/lib/rpm/redhat/brp-strip-static-archive /usr/bin/strip\n+ /usr/lib/rpm/brp-python-bytecompile /usr/bin/python 1\n+ /usr/lib/rpm/redhat/brp-python-hardlink\n+ /usr/lib/rpm/redhat/brp-java-repack-jars\n\u5904\u7406\u6587\u4ef6\uff1acello-0.1-1.el7.centos.x86_64\n\u6267\u884c(%license): /bin/sh -e /var/tmp/rpm-tmp.8tkaP3\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ LICENSEDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ export LICENSEDIR\n+ /usr/bin/mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ cp -pr LICENSE /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ exit 0\nProvides: cello = 0.1-1.el7.centos cello(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1\nRequires: libc.so.6()(64bit) libc.so.6(GLIBC_2.2.5)(64bit) rtld(GNU_HASH)\n\u5904\u7406\u6587\u4ef6\uff1acello-debuginfo-0.1-1.el7.centos.x86_64\nProvides: cello-debuginfo = 0.1-1.el7.centos cello-debuginfo(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1 rpmlib(CompressedFileNames) &lt;= 3.0.4-1\n\u68c0\u67e5\u672a\u6253\u5305\u6587\u4ef6\uff1a/usr/lib/rpm/check-files /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-debuginfo-0.1-1.el7.centos.x86_64.rpm\n\u6267\u884c(%clean): /bin/sh -e /var/tmp/rpm-tmp.17LUhO\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ /usr/bin/rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ exit 0\n</code></pre> <p>\u67e5\u770b\u6587\u4ef6 </p> <pre><code>$ ls  -w1 rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\nrpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\n\n$ rpm -qpi rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\nName        : cello\nVersion     : 0.1\nRelease     : 1.el7.centos\nArchitecture: x86_64\nInstall Date: (not installed)\nGroup       : Unspecified\nSize        : 7820\nLicense     : GPLv3+\nSignature   : (none)\nSource RPM  : cello-0.1-1.el7.centos.src.rpm\nBuild Date  : 2023\u5e7402\u670823\u65e5 \u661f\u671f\u56db 16\u65f640\u520615\u79d2\nBuild Host  : backend\nRelocations : (not relocatable)\nURL         : https://example.com/cello\nSummary     : Hello World example implemented in C programming language\nDescription :\nThe long-tail description for our Hello World Example implemented in\nC programming language.\n\n$ rpm -qpl rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\n/usr/bin/cello\n/usr/share/licenses/cello-0.1\n/usr/share/licenses/cello-0.1/LICENSE\n</code></pre>"},{"location":"tips/rpm-tutorial/#srpm","title":"\u751f\u6210 SRPM \u5305","text":"<pre><code>$ rpmbuild -bs rpmbuild/SPECS/cello.spec\n\u5199\u9053:/home/gitlab-runner/rpmbuild/SRPMS/cello-0.1-1.el7.centos.src.rpm\n</code></pre>"},{"location":"tips/rpm-tutorial/#spec","title":"\u751f\u6210\u5e26 spec \u6587\u4ef6\u7684\u6e90\u4ee3\u7801\u538b\u7f29\u5305","text":""},{"location":"tips/rpm-tutorial/#spec-rpm_1","title":"\u7f16\u8bd1\u81ea\u5e26 spec \u6587\u4ef6\u7684\u6e90\u4ee3\u7801\u4e3a RPM\u5305","text":"<p>\u5982\u679c\u4f60\u4e0b\u8f7d\u7684\u6e90\u4ee3\u7801\u91cc\u5305\u542b\u4e86 <code>spec</code> \u6587\u4ef6\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u6837</p> <pre><code>$ tar -tzf cello-0.1.tar.gz\ncello-0.1/\ncello-0.1/Makefile\ncello-0.1/cello.c\ncello-0.1/LICENSE\ncello-0.1/cello.spec\n</code></pre> <p>\u90a3\u4e48\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>rpmbuild</code> \u6765\u7f16\u8bd1</p> <pre><code>$ rpmbuild -tb cello-0.1.tar.gz\n\u6267\u884c(%prep): /bin/sh -e /var/tmp/rpm-tmp.5SLEw2\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ rm -rf cello-0.1\n+ /usr/bin/gzip -dc /var/tmp/cello-0.1.tar.gz\n+ /usr/bin/tar -xf -\n+ STATUS=0\n+ '[' 0 -ne 0 ']'\n+ cd cello-0.1\n+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .\n+ exit 0\n\u6267\u884c(%build): /bin/sh -e /var/tmp/rpm-tmp.tEJFy9\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ make -j6\ngcc -g -o cello cello.c\n+ exit 0\n\u6267\u884c(%install): /bin/sh -e /var/tmp/rpm-tmp.vCKRKg\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ '[' /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64 '!=' / ']'\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n++ dirname /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT\n+ mkdir /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ cd cello-0.1\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ /usr/bin/make install DESTDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\nmkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin\ninstall -m 0755 cello /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\n+ /usr/lib/rpm/find-debuginfo.sh --strict-build-id -m --run-dwz --dwz-low-mem-die-limit 10000000 --dwz-max-die-limit 110000000 /home/gitlab-runner/rpmbuild/BUILD/cello-0.1\nextracting debug info from /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\ndwz: Too few files for multifile optimization\n/usr/lib/rpm/sepdebugcrcfix: Updated 1 CRC32s, 0 CRC32s did match.\n1 block\n+ /usr/lib/rpm/check-buildroot\n+ /usr/lib/rpm/redhat/brp-compress\n+ /usr/lib/rpm/redhat/brp-strip-static-archive /usr/bin/strip\n+ /usr/lib/rpm/brp-python-bytecompile /usr/bin/python 1\n+ /usr/lib/rpm/redhat/brp-python-hardlink\n+ /usr/lib/rpm/redhat/brp-java-repack-jars\n\u5904\u7406\u6587\u4ef6\uff1acello-0.1-1.el7.centos.x86_64\n\u6267\u884c(%license): /bin/sh -e /var/tmp/rpm-tmp.bGZKPo\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ LICENSEDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ export LICENSEDIR\n+ /usr/bin/mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ cp -pr LICENSE /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ exit 0\nProvides: cello = 0.1-1.el7.centos cello(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1\nRequires: libc.so.6()(64bit) libc.so.6(GLIBC_2.2.5)(64bit) rtld(GNU_HASH)\n\u5904\u7406\u6587\u4ef6\uff1acello-debuginfo-0.1-1.el7.centos.x86_64\nProvides: cello-debuginfo = 0.1-1.el7.centos cello-debuginfo(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1 rpmlib(CompressedFileNames) &lt;= 3.0.4-1\n\u68c0\u67e5\u672a\u6253\u5305\u6587\u4ef6\uff1a/usr/lib/rpm/check-files /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-debuginfo-0.1-1.el7.centos.x86_64.rpm\n\u6267\u884c(%clean): /bin/sh -e /var/tmp/rpm-tmp.jWf8rN\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ /usr/bin/rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ exit 0\n</code></pre>"},{"location":"tips/rpm-tutorial/#srpm-rpm","title":"\u7f16\u8bd1 SRPM \u5305\u5230\u4e8c\u8fdb\u5236 RPM\u5305","text":"<pre><code>$ rpmbuild --rebuild rpmbuild/SRPMS/cello-0.1-1.el7.centos.src.rpm\n\u6b63\u5728\u5b89\u88c5 rpmbuild/SRPMS/cello-0.1-1.el7.centos.src.rpm\n\u6267\u884c(%prep): /bin/sh -e /var/tmp/rpm-tmp.lAlqPt\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ rm -rf cello-0.1\n+ /usr/bin/gzip -dc /home/gitlab-runner/rpmbuild/SOURCES/cello-0.1.tar.gz\n+ /usr/bin/tar -xf -\n+ STATUS=0\n+ '[' 0 -ne 0 ']'\n+ cd cello-0.1\n+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .\n+ exit 0\n\u6267\u884c(%build): /bin/sh -e /var/tmp/rpm-tmp.5iGy8W\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ make -j6\ngcc -g -o cello cello.c\n+ exit 0\n\u6267\u884c(%install): /bin/sh -e /var/tmp/rpm-tmp.dla0zq\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ '[' /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64 '!=' / ']'\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n++ dirname /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT\n+ mkdir /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ cd cello-0.1\n+ rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ /usr/bin/make install DESTDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\nmkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin\ninstall -m 0755 cello /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\n+ /usr/lib/rpm/find-debuginfo.sh --strict-build-id -m --run-dwz --dwz-low-mem-die-limit 10000000 --dwz-max-die-limit 110000000 /home/gitlab-runner/rpmbuild/BUILD/cello-0.1\nextracting debug info from /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/bin/cello\ndwz: Too few files for multifile optimization\n/usr/lib/rpm/sepdebugcrcfix: Updated 1 CRC32s, 0 CRC32s did match.\n1 block\n+ /usr/lib/rpm/check-buildroot\n+ /usr/lib/rpm/redhat/brp-compress\n+ /usr/lib/rpm/redhat/brp-strip-static-archive /usr/bin/strip\n+ /usr/lib/rpm/brp-python-bytecompile /usr/bin/python 1\n+ /usr/lib/rpm/redhat/brp-python-hardlink\n+ /usr/lib/rpm/redhat/brp-java-repack-jars\n\u5904\u7406\u6587\u4ef6\uff1acello-0.1-1.el7.centos.x86_64\n\u6267\u884c(%license): /bin/sh -e /var/tmp/rpm-tmp.xOCrFU\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ LICENSEDIR=/home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ export LICENSEDIR\n+ /usr/bin/mkdir -p /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ cp -pr LICENSE /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64/usr/share/licenses/cello-0.1\n+ exit 0\nProvides: cello = 0.1-1.el7.centos cello(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1\nRequires: libc.so.6()(64bit) libc.so.6(GLIBC_2.2.5)(64bit) rtld(GNU_HASH)\n\u5904\u7406\u6587\u4ef6\uff1acello-debuginfo-0.1-1.el7.centos.x86_64\nProvides: cello-debuginfo = 0.1-1.el7.centos cello-debuginfo(x86-64) = 0.1-1.el7.centos\nRequires(rpmlib): rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1 rpmlib(CompressedFileNames) &lt;= 3.0.4-1\n\u68c0\u67e5\u672a\u6253\u5305\u6587\u4ef6\uff1a/usr/lib/rpm/check-files /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-0.1-1.el7.centos.x86_64.rpm\n\u5199\u9053:/home/gitlab-runner/rpmbuild/RPMS/x86_64/cello-debuginfo-0.1-1.el7.centos.x86_64.rpm\n\u6267\u884c(%clean): /bin/sh -e /var/tmp/rpm-tmp.HpZMfn\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ cd cello-0.1\n+ /usr/bin/rm -rf /home/gitlab-runner/rpmbuild/BUILDROOT/cello-0.1-1.el7.centos.x86_64\n+ exit 0\n\u6267\u884c(--clean): /bin/sh -e /var/tmp/rpm-tmp.vhEPtR\n+ umask 022\n+ cd /home/gitlab-runner/rpmbuild/BUILD\n+ rm -rf cello-0.1\n+ exit 0\n</code></pre>"},{"location":"tips/sed-one-line-tips/","title":"SED \u5355\u884c\u811a\u672c\u5feb\u901f\u53c2\u8003","text":"<p>\u5728\u4ee5\u4e0b\u5730\u5740\u53ef\u627e\u5230\u672c\u6587\u6863\u7684\u6700\u65b0\uff08\u82f1\u6587\uff09\u7248\u672c\uff1a    http://sed.sourceforge.net/sed1line.txt http://www.pement.org/sed/sed1line.txt</p> <p>\u5176\u4ed6\u8bed\u8a00\u7248\u672c\uff1a</p> <ul> <li>\u4e2d\u6587  http://sed.sourceforge.net/sed1line_zh-CN.html</li> <li>\u6377\u514b\u8bed http://sed.sourceforge.net/sed1line_cz.html</li> <li>\u8377\u8bed   http://sed.sourceforge.net/sed1line_nl.html</li> <li>\u6cd5\u8bed   http://sed.sourceforge.net/sed1line_fr.html</li> <li>\u5fb7\u8bed   http://sed.sourceforge.net/sed1line_de.html</li> <li>\u8461\u8bed   http://sed.sourceforge.net/sed1line_pt-BR.html</li> </ul>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_1","title":"\u6587\u672c\u95f4\u9694\uff1a","text":"<p>\u5728\u6bcf\u4e00\u884c\u540e\u9762\u589e\u52a0\u4e00\u7a7a\u884c </p> <p><code>sed G</code></p> <p>\u5c06\u539f\u6765\u7684\u6240\u6709\u7a7a\u884c\u5220\u9664\u5e76\u5728\u6bcf\u4e00\u884c\u540e\u9762\u589e\u52a0\u4e00\u7a7a\u884c\u3002</p> <p><code>sed '/^$/d;G'</code> # \u8fd9\u6837\u5728\u8f93\u51fa\u7684\u6587\u672c\u4e2d\u6bcf\u4e00\u884c\u540e\u9762\u5c06\u6709\u4e14\u53ea\u6709\u4e00\u7a7a\u884c\u3002</p> <p>\u5728\u6bcf\u4e00\u884c\u540e\u9762\u589e\u52a0\u4e24\u884c\u7a7a\u884c</p> <p><code>sed 'G;G'</code></p> <p>\u5c06\u7b2c\u4e00\u4e2a\u811a\u672c\u6240\u4ea7\u751f\u7684\u6240\u6709\u7a7a\u884c\u5220\u9664\uff08\u5373\u5220\u9664\u6240\u6709\u5076\u6570\u884c\uff09</p> <p><code>sed 'n;d'</code></p> <p>\u5728\u5339\u914d\u5f0f\u6837\u201cregex\u201d\u7684\u884c\u4e4b\u524d\u63d2\u5165\u4e00\u7a7a\u884c</p> <p><code>sed '/regex/{x;p;x;}'</code></p> <p>\u5728\u5339\u914d\u5f0f\u6837\u201cregex\u201d\u7684\u884c\u4e4b\u540e\u63d2\u5165\u4e00\u7a7a\u884c</p> <p><code>sed '/regex/G'</code></p> <p>\u5728\u5339\u914d\u5f0f\u6837\u201cregex\u201d\u7684\u884c\u4e4b\u524d\u548c\u4e4b\u540e\u5404\u63d2\u5165\u4e00\u7a7a\u884c</p> <p><code>sed '/regex/{x;p;x;G;}'</code></p>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_2","title":"\u7f16\u53f7\uff1a","text":"<ol> <li> <p>\u4e3a\u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u8fdb\u884c\u7f16\u53f7\uff08\u7b80\u5355\u7684\u5de6\u5bf9\u9f50\u65b9\u5f0f\uff09\u3002\u8fd9\u91cc\u4f7f\u7528\u4e86\u201c\u5236\u8868\u7b26\u201d\uff08tab\uff0c\u89c1\u672c\u6587\u672b\u5c3e\u5173\u4e8e'\\t'\u7684\u7528\u6cd5\u7684\u63cf\u8ff0\uff09\u800c\u4e0d\u662f\u7a7a\u683c\u6765\u5bf9\u9f50\u8fb9\u7f18\u3002     <code>sed = filename | sed 'N;s/\\n/\\t/'</code></p> </li> <li> <p>\u5bf9\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u884c\u7f16\u53f7\uff08\u884c\u53f7\u5728\u5de6\uff0c\u6587\u5b57\u53f3\u7aef\u5bf9\u9f50\uff09\u3002</p> <p><code>sed = filename | sed 'N; s/^/     /; s/ *\\(.\\{6,\\}\\)\\n/\\1  /'</code></p> </li> <li> <p>\u5bf9\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u884c\u7f16\u53f7\uff0c\u4f46\u53ea\u663e\u793a\u975e\u7a7a\u767d\u884c\u7684\u884c\u53f7\u3002  <code>sed '/./=' filename | sed '/./N; s/\\n/ /'</code></p> </li> <li> <p>\u8ba1\u7b97\u884c\u6570 \uff08\u6a21\u62df \"wc -l\"\uff09  <code>sed -n '$='</code></p> </li> </ol>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_3","title":"\u6587\u672c\u8f6c\u6362\u548c\u66ff\u4ee3\uff1a","text":"<ol> <li> <p>Unix\u73af\u5883\uff1a\u8f6c\u6362DOS\u7684\u65b0\u884c\u7b26\uff08CR/LF\uff09\u4e3aUnix\u683c\u5f0f\u3002</p> <pre><code>sed 's/.$//' # \u5047\u8bbe\u6240\u6709\u884c\u4ee5CR/LF\u7ed3\u675f\nsed 's/^M$//'   # \u5728bash/tcsh\u4e2d\uff0c\u5c06\u6309Ctrl-M\u6539\u4e3a\u6309Ctrl-V\nsed 's/\\x0D$//' # ssed\u3001gsed 3.02.80\uff0c\u53ca\u66f4\u9ad8\u7248\u672c```  \n</code></pre> </li> <li> <p>Unix\u73af\u5883\uff1a\u8f6c\u6362Unix\u7684\u65b0\u884c\u7b26\uff08LF\uff09\u4e3aDOS\u683c\u5f0f\u3002</p> <pre><code>sed \"s/$/`echo -e \\\\\\r`/\" # \u5728ksh\u4e0b\u6240\u4f7f\u7528\u7684\u547d\u4ee4\nsed 's/$'\"/`echo \\\\\\r`/\"  # \u5728bash\u4e0b\u6240\u4f7f\u7528\u7684\u547d\u4ee4`  \nsed \"s/$/`echo \\\\\\r`/\"   # \u5728zsh\u4e0b\u6240\u4f7f\u7528\u7684\u547d\u4ee4\nsed 's/$/\\r/'        # gsed 3.02.80 \u53ca\u66f4\u9ad8\u7248\u672c```\n</code></pre> </li> <li> <p>DOS\u73af\u5883\uff1a\u8f6c\u6362Unix\u65b0\u884c\u7b26\uff08LF\uff09\u4e3aDOS\u683c\u5f0f\u3002</p> <pre><code>sed \"s/$//\"    # \u65b9\u6cd5 1\nsed -n p       # \u65b9\u6cd5 2\n</code></pre> </li> <li> <p>DOS\u73af\u5883\uff1a\u8f6c\u6362DOS\u65b0\u884c\u7b26\uff08CR/LF\uff09\u4e3aUnix\u683c\u5f0f\u3002</p> <p>\u4e0b\u9762\u7684\u811a\u672c\u53ea\u5bf9 <code>UnxUtils sed 4.0.7</code> \u53ca\u66f4\u9ad8\u7248\u672c\u6709\u6548\u3002\u8981\u8bc6\u522bUnxUtils\u7248\u672c\u7684 sed\u53ef\u4ee5\u901a\u8fc7\u5176\u7279\u6709\u7684 <code>--text</code> \u9009\u9879\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u5e2e\u52a9\u9009\u9879\uff08<code>--help</code>\uff09\u770b \u5176\u4e2d\u6709\u65e0\u4e00\u4e2a\u201c--text\u201d\u9879\u4ee5\u6b64\u6765\u5224\u65ad\u6240\u4f7f\u7528\u7684\u662f\u5426\u662fUnxUtils\u7248\u672c\u3002\u5176\u5b83DOS \u7248\u672c\u7684\u7684sed\u5219\u65e0\u6cd5\u8fdb\u884c\u8fd9\u4e00\u8f6c\u6362\u3002\u4f46\u53ef\u4ee5\u7528 <code>tr</code>\u6765\u5b9e\u73b0\u8fd9\u4e00\u8f6c\u6362\u3002</p> <pre><code>sed \"s/\\r//\" infile &gt;outfile  # UnxUtils sed &gt; 4.0.6\ntr -d \\r &lt;infile &gt;outfile    # GNU tr &gt;1.21\n</code></pre> </li> <li> <p>\u5c06\u6bcf\u4e00\u884c\u524d\u5bfc\u7684\u201c\u7a7a\u767d\u5b57\u7b26\u201d\uff08\u7a7a\u683c\uff0c\u5236\u8868\u7b26\uff09\u5220\u9664\u4f7f\u4e4b\u5de6\u5bf9\u9f50</p> <p><code>sed 's/^[ \\t]*//'  # \u89c1\u672c\u6587\u672b\u5c3e\u5173\u4e8e'\\t'\u7528\u6cd5\u7684\u63cf\u8ff0</code></p> </li> <li> <p>\u5c06\u6bcf\u4e00\u884c\u62d6\u5c3e\u7684\u201c\u7a7a\u767d\u5b57\u7b26\u201d\uff08\u7a7a\u683c\uff0c\u5236\u8868\u7b26\uff09\u5220\u9664</p> <p><code>sed 's/[ \\t]*$//'   # \u89c1\u672c\u6587\u672b\u5c3e\u5173\u4e8e'\\t'\u7528\u6cd5\u7684\u63cf\u8ff0</code></p> </li> <li> <p>\u5c06\u6bcf\u4e00\u884c\u4e2d\u7684\u524d\u5bfc\u548c\u62d6\u5c3e\u7684\u7a7a\u767d\u5b57\u7b26\u5220\u9664</p> <p><code>sed 's/^[ \\t]*//;s/[ \\t]*$//'</code></p> </li> <li> <p>\u5728\u6bcf\u4e00\u884c\u5f00\u5934\u5904\u63d2\u51655\u4e2a\u7a7a\u683c\uff08\u4f7f\u5168\u6587\u5411\u53f3\u79fb\u52a85\u4e2a\u5b57\u7b26\u7684\u4f4d\u7f6e\uff09</p> <p><code>sed 's/^/     /'</code></p> </li> <li> <p>\u4ee579\u4e2a\u5b57\u7b26\u4e3a\u5bbd\u5ea6\uff0c\u5c06\u6240\u6709\u6587\u672c\u53f3\u5bf9\u9f50</p> <p><code>sed -e :a -e 's/^.\\{1,78\\}$/ &amp;/;ta'  # 78\u4e2a\u5b57\u7b26\u5916\u52a0\u6700\u540e\u7684\u4e00\u4e2a\u7a7a\u683c</code></p> </li> <li> <p>\u4ee579\u4e2a\u5b57\u7b26\u4e3a\u5bbd\u5ea6\uff0c\u4f7f\u6240\u6709\u6587\u672c\u5c45\u4e2d\u3002\u5728\u65b9\u6cd51\u4e2d\uff0c\u4e3a\u4e86\u8ba9\u6587\u672c\u5c45\u4e2d\u6bcf\u4e00\u884c\u7684\u524d\u5934\u548c\u540e\u5934\u90fd\u586b\u5145\u4e86\u7a7a\u683c\u3002 \u5728\u65b9\u6cd52\u4e2d\uff0c\u5728\u5c45\u4e2d\u6587\u672c\u7684\u8fc7\u7a0b\u4e2d\u53ea\u5728\u6587\u672c\u7684\u524d\u9762\u586b\u5145\u7a7a\u683c\uff0c\u5e76\u4e14\u6700\u7ec8\u8fd9\u4e9b\u7a7a\u683c\u5c06\u6709\u4e00\u534a\u4f1a\u88ab\u5220\u9664\u3002\u6b64\u5916\u6bcf\u4e00\u884c\u7684\u540e\u5934\u5e76\u672a\u586b\u5145\u7a7a\u683c\u3002</p> <pre><code>sed  -e :a -e 's/^.\\{1,77\\}$/ &amp; /;ta'                     # \u65b9\u6cd51\nsed  -e :a -e 's/^.\\{1,77\\}$/ &amp;/;ta' -e 's/\\( *\\)\\1/\\1/'  # \u65b9\u6cd52\n</code></pre> </li> <li> <p>\u5728\u6bcf\u4e00\u884c\u4e2d\u67e5\u627e\u5b57\u4e32\u201cfoo\u201d\uff0c\u5e76\u5c06\u627e\u5230\u7684\u201cfoo\u201d\u66ff\u6362\u4e3a\u201cbar\u201d</p> <p><pre><code>sed 's/foo/bar/'   # \u53ea\u66ff\u6362\u6bcf\u4e00\u884c\u4e2d\u7684\u7b2c\u4e00\u4e2a\u201cfoo\u201d\u5b57\u4e32\nsed 's/foo/bar/4'  # \u53ea\u66ff\u6362\u6bcf\u4e00\u884c\u4e2d\u7684\u7b2c\u56db\u4e2a\u201cfoo\u201d\u5b57\u4e32\nsed 's/foo/bar/g'  # \u5c06\u6bcf\u4e00\u884c\u4e2d\u7684\u6240\u6709\u201cfoo\u201d\u90fd\u6362\u6210\u201cbar\u201d\nsed 's/\\(.*\\)foo\\(.*foo\\)/\\1bar\\2/' # \u66ff\u6362\u5012\u6570\u7b2c\u4e8c\u4e2a\u201cfoo\u201d\nsed 's/\\(.*\\)foo/\\1bar/' # \u66ff\u6362\u6700\u540e\u4e00\u4e2a\u201cfoo\u201d\n</code></pre>  12. \u53ea\u5728\u884c\u4e2d\u51fa\u73b0\u5b57\u4e32\u201cbaz\u201d\u7684\u60c5\u51b5\u4e0b\u5c06\u201cfoo\u201d\u66ff\u6362\u6210\u201cbar\u201d</p> <p><code>sed '/baz/s/foo/bar/g'</code></p> </li> <li> <p>\u5c06\u201cfoo\u201d\u66ff\u6362\u6210\u201cbar\u201d\uff0c\u5e76\u4e14\u53ea\u5728\u884c\u4e2d\u672a\u51fa\u73b0\u5b57\u4e32\u201cbaz\u201d\u7684\u60c5\u51b5\u4e0b\u66ff\u6362</p> <p><code>sed '/baz/!s/foo/bar/g'</code></p> </li> <li> <p>\u4e0d\u7ba1\u662f \"scarlet\", \"ruby\" \u8fd8\u662f \"puce\"\uff0c\u4e00\u5f8b\u6362\u6210 \"red\"</p> <p><pre><code>sed 's/scarlet/red/g;s/ruby/red/g;s/puce/red/g'  #\u5bf9\u591a\u6570\u7684sed\u90fd\u6709\u6548\ngsed 's/scarlet\\|ruby\\|puce/red/g'               # \u53ea\u5bf9GNU sed\u6709\u6548\n</code></pre>  15. \u5012\u7f6e\u6240\u6709\u884c\uff0c\u7b2c\u4e00\u884c\u6210\u4e3a\u6700\u540e\u4e00\u884c\uff0c\u4f9d\u6b21\u7c7b\u63a8\uff08\u6a21\u62df\u201ctac\u201d\uff09\u3002  \u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\uff0c\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u65f6HHsed v1.5\u4f1a\u5c06\u6587\u4ef6\u4e2d\u7684\u7a7a\u884c\u5220\u9664</p> <p><pre><code>sed '1!G;h;$!d'               # \u65b9\u6cd51`\nsed -n '1!G;h;$p'             # \u65b9\u6cd52`\n</code></pre>  16. \u5c06\u884c\u4e2d\u7684\u5b57\u7b26\u9006\u5e8f\u6392\u5217\uff0c\u7b2c\u4e00\u4e2a\u5b57\u6210\u4e3a\u6700\u540e\u4e00\u5b57\uff0c\u2026\u2026\uff08\u6a21\u62df\u201crev\u201d\uff09  <code>sed '/\\n/!G;s/\\(.\\)\\(.*\\n\\)/&amp;\\2\\1/;//D;s/.//'</code></p> </li> <li> <p>\u5c06\u6bcf\u4e24\u884c\u8fde\u63a5\u6210\u4e00\u884c\uff08\u7c7b\u4f3c\u201cpaste\u201d\uff09  <code>sed '$!N;s/\\n/ /'</code></p> </li> <li> <p>\u5982\u679c\u5f53\u524d\u884c\u4ee5\u53cd\u659c\u6760\u201c\\\u201d\u7ed3\u675f\uff0c\u5219\u5c06\u4e0b\u4e00\u884c\u5e76\u5230\u5f53\u524d\u884c\u672b\u5c3e  \u5e76\u53bb\u6389\u539f\u6765\u884c\u5c3e\u7684\u53cd\u659c\u6760     <code>sed -e :a -e '/\\\\$/N; s/\\\\\\n//; ta'</code></p> </li> <li> <p>\u5982\u679c\u5f53\u524d\u884c\u4ee5\u7b49\u53f7\u5f00\u5934\uff0c\u5c06\u5f53\u524d\u884c\u5e76\u5230\u4e0a\u4e00\u884c\u672b\u5c3e\u5e76\u4ee5\u5355\u4e2a\u7a7a\u683c\u4ee3\u66ff\u539f\u6765\u884c\u5934\u7684\u201c=\u201d  <code>sed -e :a -e '$!N;s/\\n=/ /;ta' -e 'P;D'</code></p> </li> <li> <p>\u4e3a\u6570\u5b57\u5b57\u4e32\u589e\u52a0\u9017\u53f7\u5206\u9694\u7b26\u53f7\uff0c\u5c06\u201c1234567\u201d\u6539\u4e3a\u201c1,234,567\u201d  <code>gsed ':a;s/\\B[0-9]\\{3\\}\\&gt;/,&amp;/;ta'                     # GNU sed</code> <code>sed -e :a -e 's/\\(.*[0-9]\\)\\([0-9]\\{3\\}\\)/\\1,\\2/;ta'  # \u5176\u4ed6sed</code></p> </li> <li> <p>\u4e3a\u5e26\u6709\u5c0f\u6570\u70b9\u548c\u8d1f\u53f7\u7684\u6570\u503c\u589e\u52a0\u9017\u53f7\u5206\u9694\u7b26\uff08GNU sed\uff09  <code>gsed -r ':a;s/(^|[^0-9.])([0-9]+)([0-9]{3})/\\1\\2,\\3/g;ta'</code></p> </li> <li> <p>\u5728\u6bcf5\u884c\u540e\u589e\u52a0\u4e00\u7a7a\u767d\u884c \uff08\u5728\u7b2c5\uff0c10\uff0c15\uff0c20\uff0c\u7b49\u884c\u540e\u589e\u52a0\u4e00\u7a7a\u767d\u884c\uff09  <code>gsed '0~5G'     # \u53ea\u5bf9GNU sed\u6709\u6548</code> <code>sed 'n;n;n;n;G;' # \u5176\u4ed6sed</code></p> </li> </ol>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_4","title":"\u9009\u62e9\u6027\u5730\u663e\u793a\u7279\u5b9a\u884c\uff1a","text":"<ol> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u524d10\u884c \uff08\u6a21\u62df\u201chead\u201d\u7684\u884c\u4e3a\uff09  sed 10q</p> </li> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u7b2c\u4e00\u884c \uff08\u6a21\u62df\u201chead -1\u201d\u547d\u4ee4\uff09  sed q</p> </li> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u6700\u540e10\u884c \uff08\u6a21\u62df\u201ctail\u201d\uff09  <code>sed -e :a -e '$q;N;11,$D;ba'</code></p> </li> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u6700\u540e2\u884c\uff08\u6a21\u62df\u201ctail -2\u201d\u547d\u4ee4\uff09  <code>sed '$!N;$!D</code>'</p> </li> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u6700\u540e\u4e00\u884c\uff08\u6a21\u62df\u201ctail -1\u201d\uff09  <code>sed '$!d'        # \u65b9\u6cd51</code> <code>sed -n '$p'      # \u65b9\u6cd52</code></p> </li> <li> <p>\u663e\u793a\u6587\u4ef6\u4e2d\u7684\u5012\u6570\u7b2c\u4e8c\u884c  <code>sed -e '$!{h;d;}' -e x              # \u5f53\u6587\u4ef6\u4e2d\u53ea\u6709\u4e00\u884c\u65f6\uff0c\u8f93\u5165\u7a7a\u884c</code> <code>sed -e '1{$q;}' -e '$!{h;d;}' -e x  # \u5f53\u6587\u4ef6\u4e2d\u53ea\u6709\u4e00\u884c\u65f6\uff0c\u663e\u793a\u8be5\u884c</code> <code>sed -e '1{$d;}' -e '$!{h;d;}' -e x  # \u5f53\u6587\u4ef6\u4e2d\u53ea\u6709\u4e00\u884c\u65f6\uff0c\u4e0d\u8f93\u51fa</code></p> </li> <li> <p>\u53ea\u663e\u793a\u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u884c\uff08\u6a21\u62df\u201cgrep\u201d\uff09  <code>sed -n '/regexp/p'               # \u65b9\u6cd51</code> <code>sed '/regexp/!d'                 # \u65b9\u6cd52</code></p> </li> <li> <p>\u53ea\u663e\u793a\u201c\u4e0d\u201d\u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u884c\uff08\u6a21\u62df\u201cgrep -v\u201d\uff09  <code>sed -n '/regexp/!p'   # \u65b9\u6cd51\uff0c\u4e0e\u524d\u9762\u7684\u547d\u4ee4\u76f8\u5bf9\u5e94</code> <code>sed '/regexp/d'       # \u65b9\u6cd52\uff0c\u7c7b\u4f3c\u7684\u8bed\u6cd5</code></p> </li> <li> <p>\u67e5\u627e\u201cregexp\u201d\u5e76\u5c06\u5339\u914d\u884c\u7684\u4e0a\u4e00\u884c\u663e\u793a\u51fa\u6765\uff0c\u4f46\u5e76\u4e0d\u663e\u793a\u5339\u914d\u884c  <code>sed -n '/regexp/{g;1!p;};h'</code></p> </li> <li> <p>\u67e5\u627e\u201cregexp\u201d\u5e76\u5c06\u5339\u914d\u884c\u7684\u4e0b\u4e00\u884c\u663e\u793a\u51fa\u6765\uff0c\u4f46\u5e76\u4e0d\u663e\u793a\u5339\u914d\u884c  <code>sed -n '/regexp/{n;p;}'</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cregexp\u201d\u7684\u884c\u53ca\u5176\u524d\u540e\u884c\uff0c\u5e76\u5728\u7b2c\u4e00\u884c\u4e4b\u524d\u52a0\u4e0a\u201cregexp\u201d\u6240\u5728\u884c\u7684\u884c\u53f7 \uff08\u7c7b\u4f3c\u201cgrep -A1 -B1\u201d\uff09  <code>sed -n -e '/regexp/{=;x;1!p;g;$!N;p;D;}' -e h</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u3001\u201cBBB\u201d\u6216\u201cCCC\u201d\u7684\u884c\uff08\u4efb\u610f\u6b21\u5e8f\uff09  <code>sed '/AAA/!d; /BBB/!d; /CCC/!d'  # \u5b57\u4e32\u7684\u6b21\u5e8f\u4e0d\u5f71\u54cd\u7ed3\u679c</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u3001\u201cBBB\u201d\u548c\u201cCCC\u201d\u7684\u884c\uff08\u56fa\u5b9a\u6b21\u5e8f\uff09  <code>sed '/AAA.*BBB.*CCC/!d'</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u201cBBB\u201d\u6216\u201cCCC\u201d\u7684\u884c \uff08\u6a21\u62df\u201cegrep\u201d\uff09 <code>sed -e '/AAA/b' -e '/BBB/b' -e '/CCC/b' -e d    # \u591a\u6570sed</code> <code>gsed '/AAA\\|BBB\\|CCC/!d'   # \u5bf9GNU sed\u6709\u6548</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u7684\u6bb5\u843d \uff08\u6bb5\u843d\u95f4\u4ee5\u7a7a\u884c\u5206\u9694\uff09   HHsed v1.5 \u5fc5\u987b\u5728\u201cx;\u201d\u540e\u52a0\u5165\u201cG;\u201d\uff0c\u63a5\u4e0b\u6765\u76843\u4e2a\u811a\u672c\u90fd\u662f\u8fd9\u6837    <code>sed -e '/./{H;$!d;}' -e 'x;/AAA/!d;'</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u201cBBB\u201d\u548c\u201cCCC\u201d\u4e09\u4e2a\u5b57\u4e32\u7684\u6bb5\u843d \uff08\u4efb\u610f\u6b21\u5e8f\uff09  <code>sed -e '/./{H;$!d;}' -e 'x;/AAA/!d;/BBB/!d;/CCC/!d'</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b\u201cAAA\u201d\u3001\u201cBBB\u201d\u3001\u201cCCC\u201d\u4e09\u8005\u4e2d\u4efb\u4e00\u5b57\u4e32\u7684\u6bb5\u843d \uff08\u4efb\u610f\u6b21\u5e8f\uff09  <code>sed -e '/./{H;$!d;}' -e 'x;/AAA/b' -e '/BBB/b' -e '/CCC/b' -e d</code> <code>gsed '/./{H;$!d;};x;/AAA\\|BBB\\|CCC/b;d'         # \u53ea\u5bf9GNU sed\u6709\u6548</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b65\u4e2a\u6216\u4ee5\u4e0a\u5b57\u7b26\u7684\u884c  <code>sed -n '/^.\\{65\\}/p'</code></p> </li> <li> <p>\u663e\u793a\u5305\u542b65\u4e2a\u4ee5\u4e0b\u5b57\u7b26\u7684\u884c  <code>sed -n '/^.\\{65\\}/!p'  # \u65b9\u6cd51\uff0c\u4e0e\u4e0a\u9762\u7684\u811a\u672c\u76f8\u5bf9\u5e94</code> <code>sed '/^.\\{65\\}/d'      # \u65b9\u6cd52\uff0c\u66f4\u7b80\u4fbf\u4e00\u70b9\u7684\u65b9\u6cd5</code></p> </li> <li> <p>\u663e\u793a\u90e8\u5206\u6587\u672c\u2014\u2014\u4ece\u5305\u542b\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u884c\u5f00\u59cb\u5230\u6700\u540e\u4e00\u884c\u7ed3\u675f  <code>sed -n '/regexp/,$p'</code></p> </li> <li> <p>\u663e\u793a\u90e8\u5206\u6587\u672c\u2014\u2014\u6307\u5b9a\u884c\u53f7\u8303\u56f4\uff08\u4ece\u7b2c8\u81f3\u7b2c12\u884c\uff0c\u542b8\u548c12\u884c\uff09       <pre><code>sed -n '8,12p'                   # \u65b9\u6cd51\nsed '8,12!d'                     # \u65b9\u6cd52\n</code></pre></p> </li> <li> <p>\u663e\u793a\u7b2c52\u884c</p> <p><pre><code>sed -n '52p'                     # \u65b9\u6cd51\nsed '52!d'                       # \u65b9\u6cd52\nsed '52q;d'                      # \u65b9\u6cd53, \u5904\u7406\u5927\u6587\u4ef6\u65f6\u66f4\u6709\u6548\u7387\n</code></pre> 1. \u4ece\u7b2c3\u884c\u5f00\u59cb\uff0c\u6bcf7\u884c\u663e\u793a\u4e00\u6b21    </p> <p><pre><code>gsed -n '3~7p'                   # \u53ea\u5bf9GNU sed\u6709\u6548\nsed -n '3,${p;n;n;n;n;n;n;}'     # \u5176\u4ed6sed\n</code></pre> 1. \u663e\u793a\u4e24\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f\u4e4b\u95f4\u7684\u6587\u672c\uff08\u5305\u542b\uff09</p> <p><code>sed -n '/Iowa/,/Montana/p'       # \u533a\u5206\u5927\u5c0f\u5199\u65b9\u5f0f</code></p> </li> </ol>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_5","title":"\u9009\u62e9\u6027\u5730\u5220\u9664\u7279\u5b9a\u884c\uff1a","text":"<ol> <li>\u663e\u793a\u901a\u7bc7\u6587\u6863\uff0c\u9664\u4e86\u4e24\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f\u4e4b\u95f4\u7684\u5185\u5bb9</li> </ol> <p><code>sed '/Iowa/,/Montana/d'</code></p> <ol> <li>\u5220\u9664\u6587\u4ef6\u4e2d\u76f8\u90bb\u7684\u91cd\u590d\u884c\uff08\u6a21\u62df\u201cuniq\u201d\uff09\u53ea\u4fdd\u7559\u91cd\u590d\u884c\u4e2d\u7684\u7b2c\u4e00\u884c\uff0c\u5176\u4ed6\u884c\u5220\u9664</li> </ol> <p><code>sed '$!N; /^\\(.*\\)\\n\\1$/!P; D'</code></p> <ol> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u7684\u91cd\u590d\u884c\uff0c\u4e0d\u7ba1\u6709\u65e0\u76f8\u90bb\u3002\u6ce8\u610fhold space\u6240\u80fd\u652f\u6301\u7684\u7f13\u5b58\u5927\u5c0f\uff0c\u6216\u8005\u4f7f\u7528GNU sed\u3002  sed -n 'G; s/\\n/&amp;&amp;/; /^\\([ -~]*\\n\\).*\\n\\1/d; s/\\n//; h; P'</p> </li> <li> <p>\u5220\u9664\u9664\u91cd\u590d\u884c\u5916\u7684\u6240\u6709\u884c\uff08\u6a21\u62df\u201cuniq -d\u201d\uff09  <code>sed '$!N; s/^\\(.*\\)\\n\\1$/\\1/; t; D'</code></p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u5f00\u5934\u768410\u884c  sed '1,10d'</p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u7684\u6700\u540e\u4e00\u884c  sed '$d'</p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u7684\u6700\u540e\u4e24\u884c  <code>sed 'N;$!P;$!D;$d'</code></p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u7684\u6700\u540e10\u884c  <code>sed -e :a -e '$d;N;2,10ba' -e 'P;D'   # \u65b9\u6cd51</code> <code>sed -n -e :a -e '1,10!{P;N;D;};N;ba'  # \u65b9\u6cd52</code></p> </li> <li> <p>\u5220\u96648\u7684\u500d\u6570\u884c  gsed '0~8d'        # \u53ea\u5bf9GNU sed\u6709\u6548     sed 'n;n;n;n;n;n;n;d;'  # \u5176\u4ed6sed</p> </li> <li> <p>\u5220\u9664\u5339\u914d\u5f0f\u6837\u7684\u884c  sed '/pattern/d'                      # \u5220\u9664\u542bpattern\u7684\u884c\u3002\u5f53\u7136pattern                                        # \u53ef\u4ee5\u6362\u6210\u4efb\u4f55\u6709\u6548\u7684\u6b63\u5219\u8868\u8fbe\u5f0f</p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u7a7a\u884c\uff08\u4e0e\u201cgrep '.' \u201d\u6548\u679c\u76f8\u540c\uff09  sed '/^$/d'                           # \u65b9\u6cd51     sed '/./!d'                           # \u65b9\u6cd52</p> </li> <li> <p>\u53ea\u4fdd\u7559\u591a\u4e2a\u76f8\u90bb\u7a7a\u884c\u7684\u7b2c\u4e00\u884c\u3002\u5e76\u4e14\u5220\u9664\u6587\u4ef6\u9876\u90e8\u548c\u5c3e\u90e8\u7684\u7a7a\u884c\u3002</p> </li> <li> <p>\uff08\u6a21\u62df\u201ccat -s\u201d\uff09  <code>sed '/./,/^$/!d'        #\u65b9\u6cd51\uff0c\u5220\u9664\u6587\u4ef6\u9876\u90e8\u7684\u7a7a\u884c\uff0c\u5141\u8bb8\u5c3e\u90e8\u4fdd\u7559\u4e00\u7a7a\u884c</code> <code>sed '/^$/N;/\\n$/D'      #\u65b9\u6cd52\uff0c\u5141\u8bb8\u9876\u90e8\u4fdd\u7559\u4e00\u7a7a\u884c\uff0c\u5c3e\u90e8\u4e0d\u7559\u7a7a\u884c</code></p> </li> <li> <p>\u53ea\u4fdd\u7559\u591a\u4e2a\u76f8\u90bb\u7a7a\u884c\u7684\u524d\u4e24\u884c\u3002  <code>sed '/^$/N;/\\n$/N;//D'</code></p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u9876\u90e8\u7684\u6240\u6709\u7a7a\u884c  sed '/./,$!d'</p> </li> <li> <p>\u5220\u9664\u6587\u4ef6\u5c3e\u90e8\u7684\u6240\u6709\u7a7a\u884c  <code>sed -e :a -e '/^\\n*$/{$d;N;ba' -e '}'  # \u5bf9\u6240\u6709sed\u6709\u6548</code> <code>sed -e :a -e '/^\\n*$/N;/\\n$/ba'        # \u540c\u4e0a\uff0c\u4f46\u53ea\u5bf9 gsed 3.02.*\u6709\u6548</code></p> </li> <li> <p>\u5220\u9664\u6bcf\u4e2a\u6bb5\u843d\u7684\u6700\u540e\u4e00\u884c  <code>sed -n '/^$/{p;h;};/./{x;/./p;}'</code></p> </li> </ol>","tags":["sed"]},{"location":"tips/sed-one-line-tips/#_6","title":"\u7279\u6b8a\u5e94\u7528\uff1a","text":"<ol> <li> <p>\u79fb\u9664\u624b\u518c\u9875\uff08man page\uff09\u4e2d\u7684nroff\u6807\u8bb0\u3002\u5728Unix System V\u6216bash shell\u4e0b\u4f7f\u7528'echo'\u547d\u4ee4\u65f6\u53ef\u80fd\u9700\u8981\u52a0\u4e0a -e \u9009\u9879\u3002  <code>sed \"s/.`echo \\\\\\b`//g\"    # \u5916\u5c42\u7684\u53cc\u62ec\u53f7\u662f\u5fc5\u987b\u7684\uff08Unix\u73af\u5883\uff09</code> <code>sed 's/.^H//g'             # \u5728bash\u6216tcsh\u4e2d, \u6309 Ctrl-V \u518d\u6309 Ctrl-H</code> <code>sed 's/.\\x08//g'    # sed 1.5\uff0cGNU sed\uff0cssed\u6240\u4f7f\u7528\u7684\u5341\u516d\u8fdb\u5236\u7684\u8868\u793a\u65b9\u6cd5</code></p> </li> <li> <p>\u63d0\u53d6\u65b0\u95fb\u7ec4\u6216 e-mail \u7684\u90ae\u4ef6\u5934  <code>sed '/^$/q' # \u5220\u9664\u7b2c\u4e00\u884c\u7a7a\u884c\u540e\u7684\u6240\u6709\u5185\u5bb9</code></p> </li> <li> <p>\u63d0\u53d6\u65b0\u95fb\u7ec4\u6216 e-mail \u7684\u6b63\u6587\u90e8\u5206  <code>sed '1,/^$/d'  # \u5220\u9664\u7b2c\u4e00\u884c\u7a7a\u884c\u4e4b\u524d\u7684\u6240\u6709\u5185\u5bb9</code></p> </li> <li> <p>\u4ece\u90ae\u4ef6\u5934\u63d0\u53d6\u201cSubject\u201d\uff08\u6807\u9898\u680f\u5b57\u6bb5\uff09\uff0c\u5e76\u79fb\u9664\u5f00\u5934\u7684\u201cSubject:\u201d\u5b57\u6837  <code>sed '/^Subject: */!d; s///;q'</code></p> </li> <li> <p>\u4ece\u90ae\u4ef6\u5934\u83b7\u5f97\u56de\u590d\u5730\u5740  <code>sed '/^Reply-To:/q; /^From:/h; /./d;g;q'</code></p> </li> <li> <p>\u83b7\u53d6\u90ae\u4ef6\u5730\u5740\u3002\u5728\u4e0a\u4e00\u4e2a\u811a\u672c\u6240\u4ea7\u751f\u7684\u90a3\u4e00\u884c\u90ae\u4ef6\u5934\u7684\u57fa\u7840\u4e0a\u8fdb\u4e00\u6b65\u7684\u5c06\u975e\u7535\u90ae\u5730\u5740\u7684\u90e8\u5206\u5243\u9664\u3002\uff08\u89c1\u4e0a\u4e00\u811a\u672c\uff09  <code>sed 's/ *(.*)//; s/&gt;.*//; s/.*[:&lt;] *//'</code></p> </li> <li> <p>\u5728\u6bcf\u4e00\u884c\u5f00\u5934\u52a0\u4e0a\u4e00\u4e2a\u5c16\u62ec\u53f7\u548c\u7a7a\u683c\uff08\u5f15\u7528\u4fe1\u606f\uff09  <code>sed 's/^/&gt; /'</code></p> </li> <li> <p>\u5c06\u6bcf\u4e00\u884c\u5f00\u5934\u5904\u7684\u5c16\u62ec\u53f7\u548c\u7a7a\u683c\u5220\u9664\uff08\u89e3\u9664\u5f15\u7528\uff09  <code>sed 's/^&gt; //'</code></p> </li> <li> <p>\u79fb\u9664\u5927\u90e8\u5206\u7684HTML\u6807\u7b7e\uff08\u5305\u62ec\u8de8\u884c\u6807\u7b7e\uff09  <code>sed -e :a -e 's/&lt;[^&gt;]*&gt;//g;/&lt;/N;//ba'</code></p> </li> <li> <p>\u5c06\u5206\u6210\u591a\u5377\u7684uuencode\u6587\u4ef6\u89e3\u7801\u3002\u79fb\u9664\u6587\u4ef6\u5934\u4fe1\u606f\uff0c\u53ea\u4fdd\u7559uuencode\u7f16\u7801\u90e8\u5206\u3002\u6587\u4ef6\u5fc5\u987b\u4ee5\u7279\u5b9a\u987a\u5e8f\u4f20\u7ed9sed\u3002\u4e0b\u9762\u7b2c\u4e00\u79cd\u7248\u672c\u7684\u811a\u672c\u53ef\u4ee5\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e0b\u8f93\u5165\uff1b\u7b2c\u4e8c\u79cd\u7248\u672c\u5219\u53ef\u4ee5\u653e\u5165\u4e00\u4e2a\u5e26\u6267\u884c\u6743\u9650\u7684shell\u811a\u672c\u4e2d\u3002\uff08\u7531Rahul Dhesi\u7684\u4e00\u4e2a\u811a\u672c\u4fee\u6539\u800c\u6765\u3002\uff09  <code>sed '/^end/,/^begin/d' file1 file2 ... fileX | uudecode   # vers. 1</code> <code>sed '/^end/,/^begin/d' \"$@\" | uudecode                    # vers. 2</code></p> </li> <li> <p>\u5c06\u6587\u4ef6\u4e2d\u7684\u6bb5\u843d\u4ee5\u5b57\u6bcd\u987a\u5e8f\u6392\u5e8f\u3002\u6bb5\u843d\u95f4\u4ee5\uff08\u4e00\u884c\u6216\u591a\u884c\uff09\u7a7a\u884c\u5206\u9694\u3002GNU sed\u4f7f\u7528\u5b57\u5143\u201c\\v\u201d\u6765\u8868\u793a\u5782\u76f4\u5236\u8868\u7b26\uff0c\u8fd9\u91cc\u7528\u5b83\u6765\u4f5c\u4e3a\u6362\u884c\u7b26\u7684\u5360\u4f4d\u7b26\u2014\u2014\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u7528\u5176\u4ed6\u672a\u5728\u6587\u4ef6\u4e2d\u4f7f\u7528\u7684\u5b57\u7b26\u6765\u4ee3\u66ff\u5b83\u3002</p> <pre><code>sed '/./{H;d;};x;s/\\n/={NL}=/g' file | sort | sed '1s/={NL}=//;s/={NL}=/\\n/g'\ngsed '/./{H;d};x;y/\\n/\\v/' file | sort | sed '1s/\\v//;y/\\v/\\n/'\n</code></pre> </li> </ol> <p>\u4f7f\u7528 <code>SED\uff1aSed</code> \u63a5\u53d7\u4e00\u4e2a\u6216\u591a\u4e2a\u7f16\u8f91\u547d\u4ee4\uff0c\u5e76\u4e14\u6bcf\u8bfb\u5165\u4e00\u884c\u540e\u5c31\u4f9d\u6b21\u5e94\u7528\u8fd9\u4e9b\u547d\u4ee4\u3002 \u5f53\u8bfb\u5165\u7b2c\u4e00\u884c\u8f93\u5165\u540e\uff0csed\u5bf9\u5176\u5e94\u7528\u6240\u6709\u7684\u547d\u4ee4\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u8f93\u51fa\u3002\u63a5\u7740\u518d\u8bfb\u5165\u7b2c\u4e8c\u884c\u8f93\u5165\uff0c\u5bf9\u5176\u5e94\u7528\u6240\u6709\u7684\u547d\u4ee4\u2026\u2026\u5e76\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u3002\u4e0a\u4e00\u4e2a\u4f8b\u5b50\u4e2dsed\u7531\u6807\u51c6\u8f93\u5165\u8bbe\u5907\uff08\u5373\u547d\u4ee4\u89e3\u91ca\u5668\uff0c\u901a\u5e38\u662f\u4ee5\u7ba1\u9053\u8f93\u5165\u7684\u5f62\u5f0f\uff09\u83b7\u5f97\u8f93\u5165\u3002\u5728\u547d\u4ee4\u884c\u7ed9\u51fa\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\u540d\u4f5c\u4e3a\u53c2\u6570\u65f6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u53d6\u4ee3\u6807\u51c6\u8f93\u5165\u8bbe\u5907\u6210\u4e3ased\u7684\u8f93\u5165\u3002sed\u7684\u8f93\u51fa\u5c06\u88ab\u9001\u5230\u6807\u51c6\u8f93\u51fa\uff08\u663e\u793a\u5668\uff09\u3002\u56e0\u6b64\uff1a</p> <pre><code> cat filename | sed '10q'         # \u4f7f\u7528\u7ba1\u9053\u8f93\u5165\n sed '10q' filename               # \u540c\u6837\u6548\u679c\uff0c\u4f46\u4e0d\u4f7f\u7528\u7ba1\u9053\u8f93\u5165\n sed '10q' filename &gt; newfile     # \u5c06\u8f93\u51fa\u8f6c\u79fb\uff08\u91cd\u5b9a\u5411\uff09\u5230\u78c1\u76d8\u4e0a\n</code></pre> <p>\u8981\u4e86\u89e3sed\u547d\u4ee4\u7684\u4f7f\u7528\u8bf4\u660e\uff0c\u5305\u62ec\u5982\u4f55\u901a\u8fc7\u811a\u672c\u6587\u4ef6\uff08\u800c\u975e\u4ece\u547d\u4ee4\u884c\uff09\u6765\u4f7f\u7528\u8fd9\u4e9b\u547d\u4ee4\uff0c\u8bf7\u53c2\u9605\u300ased &amp; awk\u300b\u7b2c\u4e8c\u7248\uff0c\u4f5c\u8005Dale Dougherty\u548cArnold Robbins\uff08O'Reilly\uff0c1997\uff1bhttp://www.ora.com\uff09\uff0c\u300aUNIX Text Processing\u300b\uff0c\u4f5c\u8005 Dale Dougherty \u548c Tim O'Reilly\uff08Hayden Books\uff0c1987\uff09\u6216\u8005\u662fMike Arst\u5199\u7684\u6559\u7a0b\u2014\u2014\u538b\u7f29\u5305\u7684\u540d\u79f0\u662f\u201c<code>U-SEDIT2.ZIP</code>\uff08\u5728\u8bb8\u591a\u7ad9\u70b9\u4e0a\u90fd\u627e\u5f97\u5230\uff09\u3002 </p> <p>\u8981\u53d1\u6398sed\u7684\u6f5c\u529b\uff0c\u5219\u5fc5\u987b\u5bf9 <code>\u6b63\u5219\u8868\u8fbe\u5f0f</code> \u6709\u8db3\u591f\u7684\u7406\u89e3\u3002\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u8d44\u6599\u53ef\u4ee5\u770b \u300aMastering Regular Expressions\u300b\u4f5c\u8005Jeffrey Friedl\uff08O'reilly 1997\uff09\u3002 Unix\u7cfb\u7edf\u6240\u63d0\u4f9b\u7684\u624b\u518c\u9875\uff08\u201cman\u201d\uff09\u4e5f\u4f1a\u6709\u6240\u5e2e\u52a9\uff08\u8bd5\u4e00\u4e0b\u8fd9\u4e9b\u547d\u4ee4 <code>man sed</code>\u3001<code>man regexp</code>\uff0c\u6216\u8005\u770b <code>man ed</code> \u4e2d\u5173\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u90e8\u5206\uff09\uff0c\u4f46\u624b\u518c\u63d0\u4f9b\u7684\u4fe1\u606f\u6bd4\u8f83\u201c\u62bd\u8c61\u201d\u2014\u2014\u8fd9\u4e5f\u662f\u5b83\u4e00\u76f4\u4e3a\u4eba\u6240\u8bdf\u75c5\u7684\u3002\u4e0d\u8fc7\uff0c\u5b83\u672c\u6765\u5c31\u4e0d\u662f\u7528\u6765\u6559\u521d\u5b66\u8005\u5982\u4f55\u4f7f\u7528sed\u6216\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u6559\u6750\uff0c\u800c\u53ea\u662f\u4e3a\u90a3\u4e9b\u719f\u6089\u8fd9\u4e9b\u5de5\u5177\u7684\u4eba\u63d0\u4f9b\u7684\u4e00\u4e9b\u6587\u672c\u53c2\u8003\u3002</p> <p>\u62ec\u53f7\u8bed\u6cd5\uff1a\u524d\u9762\u7684\u4f8b\u5b50\u5bf9sed\u547d\u4ee4\u57fa\u672c\u4e0a\u90fd\u4f7f\u7528\u5355\u5f15\u53f7\uff08<code>'...'</code>\uff09\u800c\u975e\u53cc\u5f15\u53f7\uff08<code>\"...\"</code>\uff09\u8fd9\u662f\u56e0\u4e3ased\u901a\u5e38\u662f\u5728Unix\u5e73\u53f0\u4e0a\u4f7f\u7528\u3002\u5355\u5f15\u53f7\u4e0b\uff0cUnix\u7684shell\uff08\u547d\u4ee4\u89e3\u91ca\u5668\uff09\u4e0d\u4f1a\u5bf9\u7f8e\u5143\u7b26\uff08 $\uff09\u548c\u540e\u5f15\u53f7\uff08<code>...</code>\uff09\u8fdb\u884c\u89e3\u91ca\u548c\u6267\u884c\u3002\u800c\u5728\u53cc\u5f15\u53f7\u4e0b\u7f8e\u5143\u7b26\u4f1a\u88ab\u5c55\u5f00\u4e3a\u53d8\u91cf\u6216\u53c2\u6570\u7684\u503c\uff0c\u540e\u5f15\u53f7\u4e2d\u7684\u547d\u4ee4\u88ab\u6267\u884c\u5e76\u4ee5\u8f93\u51fa\u7684\u7ed3\u679c\u4ee3\u66ff\u540e\u5f15\u53f7\u4e2d\u7684\u5185\u5bb9\u3002\u800c\u5728 <code>csh</code> \u53ca\u5176\u884d\u751f\u7684 shell \u4e2d\u4f7f\u7528\u611f\u53f9\u53f7\uff08 !\uff09\u65f6\u9700\u8981\u5728\u5176\u524d\u9762\u52a0\u4e0a\u8f6c\u4e49\u7528\u7684\u53cd\u659c\u6760\uff08\u5c31\u50cf\u8fd9\u6837\uff1a!\uff09\u4ee5\u4fdd\u8bc1\u4e0a\u9762\u6240\u4f7f\u7528\u7684\u4f8b\u5b50\u80fd\u6b63\u5e38\u8fd0\u884c\uff08\u5305\u62ec\u4f7f\u7528\u5355\u5f15\u53f7\u7684\u60c5\u51b5\u4e0b\uff09\u3002DOS\u7248\u672c\u7684Sed\u5219\u4e00\u5f8b\u4f7f\u7528\u53cc\u5f15\u53f7\uff08\"...\"\uff09\u800c\u4e0d\u662f\u5f15\u53f7\u6765\u5708\u8d77\u547d\u4ee4\u3002</p>","tags":["sed"]},{"location":"tips/setup-gitlab-ci-for-android/","title":"Setup Gitlab CI For Android","text":"<p>Source</p> <p>being an android developer, we don\u2019t get a chance to work on Continuous integration most of the time. So, I created this tutorial to learn the GitLab CI with simple steps. GitLab is a complete DevOps platform, delivered as a single application.</p> <p>Continuous integration is a way to avoid build failure and test failure before code changes are merged in.</p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#step-to-setup-gitlab-ci","title":"Step to setup Gitlab CI","text":"<ol> <li>Create Gitlab project and setup repository for the android project.</li> <li>Setup Continous Integration using the gitlab default CI android template.</li> <li>Automatically build android application and generate APK when pushing the code to the particular branch.</li> <li>Run the Link check and Test Cases</li> <li>Deploy the android APK to Firebase App Distrubution.</li> </ol>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#create-gitlab-project-and-setup-repository","title":"Create GitLab project and setup repository","text":"<p>You create a project in Gitlab, first, we need to sign up an account with GitLab. visit https://gitlab.com/ to sign up for the account.</p> <p>Once sign-in, the next step is to create a new project and repository.</p> <p>create a new project in GitLab</p> <p>Enter the Project Name and the description to create a new project. Also, I have initialized the readme file for the project details.</p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#setup-gitlab-project-in-android-studio","title":"Setup GitLab project in Android Studio","text":"<p>Before setup, the GitLab project in android studio, you first, need to install the git in your local machine. you can download git in Git \u2013 Downloads (git-scm.com) link. Now, you can create a new project in android studio and set up the GitLab project using the git commands.</p> <p>create a new android studio project</p> <p>Once the project got created, open the terminal in android studio and enter the git commands to add the project into the GitLab repository.</p> <pre><code>git init\ngit remote add origin git@gitlab.com:GITLABUSERNAME/YOURGITPROJECTNAME.git\ngit add .\ngit commit -m \"Initial commit\"\ngit push -u origin master\nCode language: JavaScript (javascript)\n</code></pre> <p>Note:</p> <p> git push command</p> <p>When you are entering git push it will ask for the username and password for your GitLab account. </p> <p>After the git push, you can able to see the initial android project code pushed to the git master branch of the GitLab project.</p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#setup-continuous-integration-on-gitlab","title":"Setup Continuous Integration on GitLab","text":"<p>Already we have completed the GitLab repository setup, Let\u2019s create a GitLab pipeline to automate test and deployment. To get started we need to create** .gitlab-ci.yml** in the root direct of the project.</p> <p></p> <p>Once created the .gitlab-ci.yml file, paste the below code in that file. I will explain the code in detail below,</p> <pre><code># To contribute improvements to CI/CD templates, please follow the Development guide at:\n# https://docs.gitlab.com/ee/development/cicd/templates.html\n# This specific template is located at:\n# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Android.gitlab-ci.yml\n\n# Read more about this script on this blog post https://about.gitlab.com/2018/10/24/setting-up-gitlab-ci-for-android-projects/, by Jason Lenny\n# If you are interested in using Android with FastLane for publishing take a look at the Android-Fastlane template.\n\nimage: openjdk:11-jdk\n\nvariables:\n\n  # ANDROID_COMPILE_SDK is the version of Android you're compiling with.\n  # It should match compileSdkVersion.\n  ANDROID_COMPILE_SDK: \"30\"\n\n  # ANDROID_BUILD_TOOLS is the version of the Android build tools you are using.\n  # It should match buildToolsVersion.\n  ANDROID_BUILD_TOOLS: \"30.0.3\"\n\n  # It's what version of the command line tools we're going to download from the official site.\n  # Official Site-&gt; https://developer.android.com/studio/index.html\n  # There, look down below at the cli tools only, sdk tools package is of format:\n  #        commandlinetools-os_type-ANDROID_SDK_TOOLS_latest.zip\n  # when the script was last modified for latest compileSdkVersion, it was which is written down below\n  ANDROID_SDK_TOOLS: \"7583922\"\n\n# Packages installation before running script\nbefore_script:\n  - apt-get --quiet update --yes\n  - apt-get --quiet install --yes wget tar unzip lib32stdc++6 lib32z1\n\n  # Setup path as ANDROID_SDK_ROOT for moving/exporting the downloaded sdk into it\n  - export ANDROID_SDK_ROOT=\"${PWD}/android-home\"\n  # Create a new directory at specified location\n  - install -d $ANDROID_SDK_ROOT\n  # Here we are installing androidSDK tools from official source,\n  # (the key thing here is the url from where you are downloading these sdk tool for command line, so please do note this url pattern there and here as well)\n  # after that unzipping those tools and\n  # then running a series of SDK manager commands to install necessary android SDK packages that'll allow the app to build\n  - wget --output-document=$ANDROID_SDK_ROOT/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip\n  # move to the archive at ANDROID_SDK_ROOT\n  - pushd $ANDROID_SDK_ROOT\n  - unzip -d cmdline-tools cmdline-tools.zip\n  - pushd cmdline-tools\n  # since commandline tools version 7583922 the root folder is named \"cmdline-tools\" so we rename it if necessary\n  - mv cmdline-tools tools || true\n  - popd\n  - popd\n  - export PATH=$PATH:${ANDROID_SDK_ROOT}/cmdline-tools/tools/bin/\n\n  # Nothing fancy here, just checking sdkManager version\n  - sdkmanager --version\n\n  # use yes to accept all licenses\n  - yes | sdkmanager --licenses || true\n  - sdkmanager \"platforms;android-${ANDROID_COMPILE_SDK}\"\n  - sdkmanager \"platform-tools\"\n  - sdkmanager \"build-tools;${ANDROID_BUILD_TOOLS}\"\n\n  # Not necessary, but just for surity\n  - chmod +x ./gradlew\n\n# Basic android and gradle stuff\n# Check linting\nlintDebug:\n  interruptible: true\n  stage: build\n  script:\n    - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint\n\n# Make Project\nassembleDebug:\n  interruptible: true\n  stage: build\n  script:\n    - ./gradlew assembleDebug\n  artifacts:\n    paths:\n      - app/build/outputs/\n\n# Run all tests, if any fails, interrupt the pipeline(fail it)\ndebugTests:\n  interruptible: true\n  stage: test\n  script:\n    - ./gradlew -Pci --console=plain :app:testDebug\n</code></pre>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#understanding-gitlab-ciyml","title":"Understanding .gitlab-ci.yml","text":"<p>first, we will see the important key terms in yml file.</p> <p>**Image: **This tag is used to specify a Docker image to be used for execution. Gitlab runners will use this Docker image to run the pipeline.</p> <p>Variables: This variable tag is used to set the variables used in the script execution.</p> <p>Before Script: This tag is used to execute the scripts before the main script execution. Mainly used to set up the environment.</p> <p>Script: We need to use a script tag to execute the main functions like building the APK or running the test cases.</p> <p>Stages: This tag is used to specify the globally defined level of the pipeline run. This stage will execute on the given order. Each stage can contain different jobs. Every stage has the following tags.</p> <ul> <li>Stage: used to define the which stage this running job belongs to.</li> <li>**only: **This only tag is used to define on which condition this particular stage should execute. we can use this tag to execute the stage only on master branch changes or etc.</li> <li>artifacts: Jobs can output an archive of files and directories. This output is known as a job artifact. You can download job artifacts by using the GitLab UI or the API.</li> </ul> <p>Now we know most of the tags used in the pipeline. below I have explained the pipeline yml file in detail.</p> <p>Defining the Docker Image</p> <pre><code>image: openjdk:11-jdk\nCode language: CSS (css)\n</code></pre> <p>Docker containers are very fast to create and destroy instances, also a good choice for setting up a temporary environment for building and testing.</p> <p>In this project, we are using Openjdk:11-jdk docker image.</p> <p>Defining the variables</p> <p>lets set up the variables needed to build the android applications.</p> <pre><code>ANDROID_COMPILE_SDK: \"30\"\nANDROID_SDK_TOOLS: \"7583922\"\nANDROID_BUILD_TOOLS: \"30.0.3\"\nCode language: JavaScript (javascript)\n</code></pre> <p>Setup android environment</p> <p>on the before_script, we need to set up the android environment by setting up ANDROID_SDK_ROOT and installing the android SDK manager.</p> <pre><code>- apt-get --quiet update --yes\n  - apt-get --quiet install --yes wget tar unzip lib32stdc++6 lib32z1\n\n  # Setup path as ANDROID_SDK_ROOT for moving/exporting the downloaded sdk into it\n  - export ANDROID_SDK_ROOT=\"${PWD}/android-home\"\n  # Create a new directory at specified location\n  - install -d $ANDROID_SDK_ROOT\n  # Here we are installing androidSDK tools from official source,\n  # (the key thing here is the url from where you are downloading these sdk tool for command line, so please do note this url pattern there and here as well)\n  # after that unzipping those tools and\n  # then running a series of SDK manager commands to install necessary android SDK packages that'll allow the app to build\n  - wget --output-document=$ANDROID_SDK_ROOT/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip\n  # move to the archive at ANDROID_SDK_ROOT\n  - pushd $ANDROID_SDK_ROOT\n  - unzip -d cmdline-tools cmdline-tools.zip\n  - pushd cmdline-tools\n  # since commandline tools version 7583922 the root folder is named \"cmdline-tools\" so we rename it if necessary\n  - mv cmdline-tools tools || true\n  - popd\n  - popd\n  - export PATH=$PATH:${ANDROID_SDK_ROOT}/cmdline-tools/tools/bin/\n\n  # Nothing fancy here, just checking sdkManager version\n  - sdkmanager --version\n\n  # use yes to accept all licenses\n  - yes | sdkmanager --licenses || true\n  - sdkmanager \"platforms;android-${ANDROID_COMPILE_SDK}\"\n  - sdkmanager \"platform-tools\"\n  - sdkmanager \"build-tools;${ANDROID_BUILD_TOOLS}\"\n\n  # Not necessary, but just for surity\n  - chmod +x ./gradlew\n</code></pre> <p>Building the app</p> <pre><code>assembleDebug:\n  interruptible: true\n  stage: build\n  script:\n    - ./gradlew assembleDebug\n  artifacts:\n    paths:\n      - app/build/outputs/\n</code></pre> <p>To start the build job, we need to define the job name and the stage. in the **script **tag we need to mention the Gradle script to build the android app. Also, In the **artifacts **tag, we need to define the output apk file location. So, that we can download the output of the build.</p> <p>Running tests</p> <pre><code>debugTests:\n  interruptible: true\n  stage: test\n  script:\n    - ./gradlew -Pci --console=plain :app:testDebug\nCode language: JavaScript (javascript)\n</code></pre> <p>same as building the app, first need to define the job name and the stage. Then, the script tag needs to provide the Gradle script to execute the test cases.</p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#how-to-run-the-gitlab-ci-setup","title":"How to run the gitlab CI setup","text":"<p>After you\u2019ve added your new .gitlab-ci.yml file to the root of your directory, just push your changes to the repository. Then the build will be triggered automatically, you can see the process in the Pipelines tab of your project. Also, you have an option to run the pipeline manually in the pipeline tab.</p> <p></p> <p>After your build is done, you can retrieve your build artifacts.</p> <p></p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/setup-gitlab-ci-for-android/#gitlab-cicd-editor","title":"Gitlab CI/CD Editor","text":"<p>GitLab provides the Editor for the **.gitlab-ci.yml **file. You can directly edit and commit the yml file in the web app itself. Also, GitLab providing the default template for the different environments.</p> <p>Check the gitlab ci templetes here.</p> <p></p> <p>Conclusion</p> <p>I hope now you learned about how to set up GitLab CI and pipeline configurations. In my next post i will explain about the GitLab CD.</p> <p>Thanks for reading. Please let me know your feedback in the comments.</p>","tags":["gitlab","ci","gitlab-ci","android"]},{"location":"tips/ssh-three-key-features/","title":"SSH \u7684\u4e09\u677f\u65a7","text":"<p>ssh\u7684\u529f\u80fd\u65e0\u6bd4\u5f3a\u608d\uff0c\u5bf9\u4e8e\u4e00\u4e2a**Unix/Linux**\u800c\u8a00\uff0c\u53ea\u8981\u5f00\u653e\u4e00\u4e2assh\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\uff0c\u968f\u610f\uff0c\u5feb\u6377\uff0c\u65b9\u4fbf\u7684\u5168\u76d8\u64cd\u63a7\u8fd9\u53f0\u673a\u5668\u3002\u76f8\u4fe1\u5f88\u591a\u529f\u80fd\u5927\u5bb6\u90fd\u5f88\u719f\u6089\u4e86\uff0c\u6211\u8fd9\u91cc\u53ea\u662f\u60f3\u628a\u5b83\u7684\u5176\u4e2d\u4e09\u4e2a\u5177\u6709\u6740\u624b\u7ea7\u7684\u529f\u80fd\u4f8b\u4e3e\u4e00\u4e0b\uff1a</p>","tags":["ssh"]},{"location":"tips/ssh-three-key-features/#_1","title":"\u7aef\u53e3\u8f6c\u53d1","text":"<p>\u7aef\u53e3\u8f6c\u53d1\uff0c\u4e5f\u5c31\u662f-L\u53c2\u6570\u7684\u8bbe\u7f6e\u3002\u4ee5\u6211\u7684\u5b9e\u9645\u4f8b\u5b50\u6765\u8bf4\u660e\u5427\uff0c\u6211\u5728\u5bb6\u91cc\u4e0a\u7f51\uff0c\u8bbe\u7f6e\u7684\u662f\u5c40\u57df\u7f51\uff0cIP\u5730\u5740\u662f<code>192.168.100.101</code>\u3002\u516c\u53f8\u603b\u90e8\u5462\uff0c\u4e5f\u662f\u7528\u7684\u662f\u5c40\u57df\u7f51\u5730\u5740\uff0c<code>172.16.0.0</code>\u7f51\u6bb5\u3002\u6211\u9700\u8981\u8bbf\u95ee\u516c\u53f8\u5185\u90e8\u7684\u4e00\u53f0\u5e94\u7528\u670d\u52a1\u5668\uff0c\u6bd4\u5982<code>172.16.81.111</code>\u3002\u6211\u8be5\u600e\u4e48\u529e\u5462\uff1f\u6070\u597d\uff0c\u516c\u53f8\u6709\u4e00\u53f0\u7f51\u5173\u670d\u52a1\u5668\uff0c\u6709\u4e24\u5757\u7f51\u5361\uff0c\u4e00\u5757\u662f\u8bbe\u7f6e\u7684\u516c\u7f51IP\u5730\u5740\uff0c\u6bd4\u5982<code>219.99.12.23</code>\u3002\u53e6\u5916\u4e00\u5757\u7f51\u5361\uff0c\u5219\u662f\u516c\u53f8\u7684\u5185\u7f51\u7684IP\u5730\u5740\uff0c\u6bd4\u5982<code>172.16.81.220</code>\u3002\u8fd9\u53f0\u670d\u52a1\u5668\u5f00\u542f\u4e86SSH\u670d\u52a1\u3002\u90a3\u4e48\u6211\u8981\u505a\u7684\u4fbf\u662f\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4:  </p> <p><code>ssh -f -N   -L 8080:172.16.81.111:80 wgzhao@219.99.12.23</code> </p> <p>\u4e00\u65e6\u767b\u9646\u6210\u529f\u540e\uff0c\u5728\u81ea\u5df1\u7684\u7535\u8111\u4e0a\uff0c\u6253\u5f00\u6d4f\u89c8\u5668\uff0c\u5728\u5730\u5740\u680f\uff0c\u8f93\u5165http://localhost:8080\uff0c\u4f60\u80fd\u770b\u5230\u4ec0\u4e48\u5462\uff1f\u5b83\u7b49\u4ef7\u4e8e\u8bbf\u95ee\u4e86http://172.16.81.111/\u3002\u5bf9\u5c31\u662f\u8bbf\u95ee\u4e86\u516c\u53f8\u603b\u90e8\u6307\u5b9a\u7684\u670d\u52a1\u5668\u7684WEB\u670d\u52a1\uff08\u5047\u5b9a80\u7aef\u53e3\u5bf9\u5e94\u7684\u662fWEB\u670d\u52a1\uff09\u3002 \u5f53\u7136\uff0c\u8fd9\u91cc\u4e5f\u8981\u6ce8\u610f\uff0c\u5982\u679c\u81ea\u5df1\u7684\u7535\u8111\u5df2\u7ecf\u4f7f\u7528\u4e868080\u7aef\u53e3\uff0c\u5219\u4e0a\u8ff0\u6307\u4ee4\u4e0d\u4f1a\u6210\u529f\uff0c\u6362\u4e00\u4e2a\u4e0d\u5e38\u7528\u7684\u9ad8\u7aef\u7aef\u53e3\u5427\u3002 \u8fd9\u6761\u6307\u4ee4\uff0c\u57fa\u672c\u4e0a\u53ef\u4ee5\u8ba9\u4f60\u65e0\u969c\u788d\u7684\u8bbf\u95ee\u516c\u53f8\u4efb\u4f55\u670d\u52a1\u5668\u7684\u4efb\u4f55\u670d\u52a1\uff0c\u751a\u81f3\u662fSSH\u670d\u52a1\uff08\u524d\u63d0\u662f\u5df2\u6388\u6743\u8bbf\u95ee\uff09\u3002\u55ef\uff0c\u60f3\u60f3\u770b\uff0c\u5982\u679c\u4e0a\u9762\u7684\u6307\u4ee4\u6539\u6210\u4e0b\u9762\u8fd9\u6837\uff1a</p> <p><code>ssh -f -N -L 8022:172.16.81.111:22 wgzhao@219.99.12.23</code> \u7136\u540e\u4f60\u518d\u6267\u884c</p> <p><code>ssh -p 8022  localhost</code>  \u4f1a\u662f\u4ec0\u4e48\u6837\u7684\u7ed3\u679c\u5462\uff1f \u6b64\u65f6\uff0c\u4f60\u5df2\u7ecf\u901a\u8fc7ssh\u8fdb\u5165\u5230\u4e86\u516c\u53f8\u670d\u52a1\u5668\u3002\u6211\u4eec\u518d\u8fdb\u4e00\u6b65\uff0c\u628a\u4e0a\u8ff0\u6307\u4ee4\u6539\u6210</p> <p><code>ssh -X -p 8022 localhost</code></p> <p>\u7136\u540e\u6267\u884cstartx\u6216\u8005gnome-session\u6216\u8005\u5176\u4ed6\u7684\uff0c\u7ed3\u679c\u53c8\u4f1a\u662f\u600e\u6837\u5462\uff1f</p>","tags":["ssh"]},{"location":"tips/ssh-three-key-features/#_2","title":"\u7aef\u53e3\u7ed1\u5b9a","text":"<p>\u7aef\u53e3\u7ed1\u5b9a\uff0c\u4e5f\u5373 ssh \u7684 <code>-R</code> \u53c2\u6570\u914d\u7f6e\u3002\u4f9d\u7136\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4e0d\u5728\u4e00\u8d77\u7684\u4e00\u4e2a\u670b\u53cb\uff0c\u4e00\u53f0\u673a\u5668\u6709\u4e9b\u6545\u969c\u9700\u8981\u89e3\u51b3\uff0c\u6211\u9700\u8981\u767b\u9646\u5230\u4ed6\u7684\u673a\u5668\uff0c\u7b2c\u4e00\u4e2a\u529e\u6cd5\u7528\u4e0d\u4e0a\uff0c\u56e0\u4e3a\u6ca1\u6709\u4e00\u53f0\u5177\u6709\u516c\u7f51IP\u5730\u5740\u7684\u7f51\u5173\u673a\u5668\u3002\u5176\u4ed6\u529e\u6cd5\u5462\uff1f\u663e\u7136Windows\u4e0b\u7684\u90a3\u5957QQ\u8fdc\u7a0b\uff0cMSN \u8fdc\u7a0b\u90fd\u6d3e\u4e0d\u4e0a\u7528\u573a\u4e86\u3002\u600e\u4e48\u529e\uff1fLinux \u53ea\u6709 Linux \u7684\u89e3\u51b3\u529e\u6cd5\u3002\u90a3\u5c31\u662f\u5229\u7528\u53ef\u4ee5\u901a\u8fc7 ssh \u8bbf\u95ee\u7684\u4e00\u53f0\u6709\u516c\u7f51IP\u5730\u5740\u7684\u673a\u5668\u3002\u5b83\u53ef\u4ee5\u662fVPS\uff0c\u53ef\u4ee5\u662f\u72ec\u7acb\u4e3b\u673a\uff0c\u603b\u4e4b\uff0c\u53ea\u8981\u80fd\u591f\u8ba9\u53cc\u65b9\u901a\u8fc7ssh\u8bbf\u95ee\u5f97\u5230\u5c31\u53ef\u4ee5\u3002 \u9996\u5148\uff0c\u8ba9\u6211\u7684\u670b\u53cb\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\uff1a</p> <p><code>ssh -qTfN -R 9922:localhost:22  account@222.222.233.212</code></p> <p>\u6267\u884c\u6210\u529f\u540e\u3002 \u6211\u5728\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\uff1a <code>ssh account@222.222.233.212</code> \u767b\u9646\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u6267\u884c</p> <p><code>netstat -lpnt |grep 9922</code> </p> <p>\u4f60\u5e94\u8be5\u53ef\u4ee5\u7c7b\u4f3c\u4e0b\u9762\u7684\u8f93\u51fa\uff1a</p> <pre><code>$ netstat -ln |grep 9922 \ntcp        0      0  \n127.0.0.1:9922              0.0.0.0:*                   \nLISTEN       tcp        0      0 ::\n1:9922                    :::*                        \nLISTEN\n</code></pre> <p>\u8fd9\u91cc\u7684<code>9922</code>\u7aef\u53e3\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u670b\u53cb\u7535\u8111\u4e0a\u7684ssh\u670d\u52a1\u3002\u7acb\u9a6c\u5728\u8fd9\u53f0\u670d\u52a1\u5668\u4e0a\u7ee7\u7eed\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\u5427\uff1a</p> <p><code>ssh -p 9922 puser@localhost</code></p> <p>puser\u662f\u6211\u670b\u53cb\u7535\u8111\u4e0a\u7684\u8d26\u53f7\u3002\u767b\u9646\u6210\u529f\u540e\uff0c\u6211\u5c31\u8fdb\u5165\u4e86\u6211\u670b\u53cb\u7684\u7535\u8111\u3002OK\uff0c\u60f3\u5e72\u4ec0\u4e48\u90fd\u53ef\u4ee5\u505a\u4e86\u3002 \u5b8c\u6210\u540e\uff0c\u6211\u670b\u53cb\u53ea\u9700\u8981\u628a\u90a3\u6761\u5305\u542b<code>9922</code>\u7684\u8fdb\u7a0b<code>kill</code>\u5c31\u53ef\u4ee5\u4e86\u3002 </p>","tags":["ssh"]},{"location":"tips/ssh-three-key-features/#_3","title":"\u52a8\u6001\u7aef\u53e3\u8f6c\u53d1","text":"<p>\u52a8\u6001\u7aef\u53e3\u8f6c\u53d1\uff0c\u4e5f\u5373 <code>-R</code>\u53c2\u6570\u7684\u914d\u7f6e\uff0c\u5b83\u7684\u76ee\u7684\u662f\u628a\u672c\u5730\u6307\u5b9a\u7684\u4e00\u4e2a\u7aef\u53e3\u901a\u8fc7socket\u6a21\u5f0f\u8f6c\u53d1\u5230\u6307\u5b9a\u7684\u8fdc\u7a0b\u670d\u52a1\u5668\u4e0a\u7684\u7279\u5b9a\u7aef\u53e3\u3002\u6bd4\u5982\u8bf4\uff0c\u6211\u5728\u7f8e\u56fd\u6709\u4e00\u4e2aVPS\uff0c\u6709\u7528SSH\u8bbf\u95ee\u529f\u80fd\uff0c\u5982\u679c\u6211\u5728\u672c\u5730\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\uff1a</p> <p><code>ssh -D8580 -qnTfN account@myserver.example.com</code></p> <p>\u7136\u540e\u5462\uff0c\u6bd4\u5982\uff0c\u6253\u5f00\u4f60\u7684\u6d4f\u89c8\u5668\uff0c\u8bbe\u7f6e\u4ee3\u7406ip\u5730\u5740\u4e3a<code>127.0.0.1</code>\uff0c\u7aef\u53e3\u662f<code>8580</code>\uff0c\u4ee3\u7406\u7c7b\u578b\u662f<code>SOCKET5</code>\uff0c\u6ce8\u610f\u662f5\uff0cSOCKET4\u4e0d\u884c\uff08\u81f3\u5c11\u6211\u6ca1\u6709\u6d4b\u8bd5\u6210\u529f\uff09\u3002\u8bbe\u7f6e\u5b8c\u6210\u540e\uff0c\u5373\u53ef\u8bbf\u95ee\u5404\u7c7b\u7f51\u7ad9\u3002</p>","tags":["ssh"]},{"location":"tips/ssh-tips/","title":"SSH examples, tips and tunnels","text":"<p>Source</p> <p>Practical SSH examples to take your remote system admin game to the next level. Commands and tips to not only use <code>SSH</code> but master ways to move around the network. </p> <p>Knowing a few <code>ssh</code> tricks will benefit any system administrator, network engineer or security professional.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#practical-ssh-examples","title":"Practical SSH examples","text":"<p>Even if you are an experienced *nix guru there are a couple of examples further down that are only available in later versions of OpenSSH. Take a look at Proxy Jump -J and reverse dynamic forwarding -R.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#first-the-basics","title":"First The Basics","text":"","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#breaking-down-the-ssh-command-line","title":"Breaking down the SSH Command Line","text":"<p>The following <code>ssh</code> example command uses common parameters often seen when connecting to a remote <code>SSH</code> server.</p> <pre><code>localhost:~$ ssh -v -p 22 -C neo@remoteserver\n</code></pre> <p>-v : Print debug information, particularly helpful when debugging an authentication problem. Can be used multiple times to print additional information. -p 22 : Specify which port to connect to on the remote SSH server. 22 is not required as this is the default, but if any other port is listening connect to it using the <code>-p</code> parameter. The listening port is configured in the <code>sshd_config</code> file using the <code>Port 2222</code> format. -C : Compression is enabled on the connection using this parameter. If you are using the terminal over a slow link or viewing lots of text this can speed up the connection as it will compress the data transferred on the fly. neo@ : The string before the @ symbol denotes the username to authenticate with against the remote server. Leaving out the user@ will default to using the username of the account you are currently logged in to (~$ whoami). User can also be specified with the <code>-l</code> parameter. remoteserver : The hostname that the <code>ssh</code> is connecting to, this can be a fully qualified domain name, an IP address or any host in your local machines hosts file. To connect to a host that resolves to both IPv4 and IPv6 you can specify add a parameter <code>-4</code> or <code>-6</code> to the command line so it resolves correctly.</p> <p>Each of the above a parameters are optional apart from the remoteserver.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#using-a-configuration-file","title":"Using a Configuration File","text":"<p>While many users are familiar with the <code>sshd_config</code> file, there is also a client configuration file for the <code>ssh</code> command. This defaults to <code>~/.ssh/config</code> but can also be specified as a parameter with the <code>-F</code> option.</p> <pre><code>Host remoteserver\n     HostName remoteserver.thematrix.io\n     User neo\n     Port 2112\n     IdentityFile /home/test/.ssh/remoteserver.private_key\n\nHost *\n     Port 2222\n</code></pre> <p>In the above example ssh configuration file you can see that there are two Host entries. The first is a specific host entry with Port 2112 configured, as well as a custom IdentifyFile and username. The second is a wildcard value of * that will match all hosts. Note that the first configuration option found will be used, so the most specific should be at the top of the configuration. More information is found in the man page (<code>man ssh_config</code>).</p> <p>The configuration file can save a lot of typing by including advanced configuration shortcuts any time a connection is made to particular hosts.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#copy-files-over-ssh-with-scp","title":"Copy Files over SSH with SCP","text":"<p>The <code>ssh</code> client comes with two other very handy tools for moving files around over an encrypted ssh connection. The commands are <code>scp</code> and <code>sftp</code>, see the examples below for basic usage. Note that many parameters for the <code>ssh</code> can be applied to these commands also.</p> <pre><code>localhost:~$ scp mypic.png neo@remoteserver:/media/data/mypic_2.png\n</code></pre> <p>In this example the file mypic.png was copied to the remoteserver to file system location /media/data and was renamed to mypic_2.png.</p> <p>Don't forget the difference in the port parameter. This is a gotcha that hits everyone using <code>scp</code> on the command line. The port parameter is <code>-P</code> not <code>-p</code> as it is in the <code>ssh</code> client.!. You will forget, but don't worry everyone does.</p> <p>For those familiar with command line <code>ftp</code>, many of the commands are similar when using <code>sftp</code>. You can push, put and ls to your hearts desire.</p> <pre><code>sftp neo@remoteserver\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#practical-examples","title":"Practical Examples","text":"<p>In many of these examples we could achieve the result using a number of methods. As in all our tutorials and example command sheets, the focus is practical examples that get the job done.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#1-proxy-traffic-over-ssh-using-socks","title":"1. Proxy Traffic over SSH using SOCKS","text":"<p>The SSH Proxy feature has been placed at number 1 for good reason. It is more powerful than many users realise giving you access to any system that the remote server can reach, using almost any application. The <code>ssh</code> client can tunnel traffic over the connection using a SOCKS proxy server with a quick one liner. A key thing to understand is that traffic to the remote systems will have a source of the remote server. For example in a web server log file.</p> <pre><code>localhost:~$ ssh -D 8888 user@remoteserver\n\nlocalhost:~$ netstat -pan | grep 8888\ntcp        0      0 127.0.0.1:8888       0.0.0.0:*               LISTEN      23880/ssh\n</code></pre> <p>Here we start the socks proxy server running on TCP port 8888, the second command checks that the port is now listening. The <code>127.0.0.1</code> indicates the service is running on localhost only. We can use a slightly different command to listen on all interfaces including ethernet or wifi, this will allow other applications (browsers or other) on our network to connect to the ssh socks proxy service.</p> <pre><code>localhost:~$ ssh -D 0.0.0.0:8888 user@remoteserver\n</code></pre> <p>Now we can configure our browser to connect to the socks proxy. In Firefox select preferences | general | network settings. Add the IP address and the port for the browser to connect to.</p> <p></p> <p>Note the option at the bottom of the form to force browser DNS requests to also go over the socks proxy. If you are using the proxy to encrypt your web traffic on the local network you will definitely want to select this option so the DNS requests are also tunnelled over the SSH connection.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#enable-socks-proxy-on-chrome","title":"Enable Socks Proxy on Chrome","text":"<p>Using a command line parameter when launching Chrome will use the socks proxy and also tunnel DNS requests from the browser over the socks5 proxy. Trust but verify, use tcpdump (tcpdump not port 22) to confirm the DNS requests are no longer visible.</p> <pre><code>localhost:~$ google-chrome --proxy-server=\"socks5://192.168.1.10:8888\"\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#using-other-applications-with-the-proxy","title":"Using other applications with the Proxy","text":"<p>Keep in mind that there are many other applications that can utilise a socks proxy. A web browser is simply the most popular. Some applications will have configuration options for use of the proxy. Others may need some help by using a helper program that talks the socks protocol. An example of this is proxychains. Using this tool we can for example use Microsoft RDP over the socks proxy.</p> <pre><code>localhost:~$ proxychains rdesktop $RemoteWindowsServer\n</code></pre> <p>The configuration options for the socks proxy are set in the proxychains configuration file.</p> <p>Hot Tip: Using remote desktop from Linux to Windows? Try the FreeRDP client. A more modern implementation than <code>rdesktop</code> with much smoother interaction.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#use-case-for-the-ssh-socks-proxy","title":"Use Case for the SSH Socks Proxy","text":"<p>You are in a cafe or hotel having to use the somewhat sketchy WIFI. From our Laptop we run the <code>ssh</code> proxy locally and establish an <code>ssh</code> tunnel into our home network using a our local Rasberry Pi. Using the browser or other applications configured for the SOCKS proxy we can access any network services on our home network or browse to the Internet via our Home Network Connection. Everything between our Laptop and the Home Server (across the WIFI and Internet to home) is encrypted in the SSH tunnel.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#2-ssh-tunnel-port-forward","title":"2. SSH Tunnel (port forward)","text":"<p>In its simplest form an SSH tunnel opens a port on your local system that connects through to another port at the other end of the tunnel. </p> <pre><code>localhost:~$ ssh  -L 9999:127.0.0.1:80 user@remoteserver\n</code></pre> <p>Lets break down the -L parameter. Think of -L as the Local listening side. So in our example above the port 9999 is listening on localhost and port forwards through to port 80 on remoteserver, note that the 127.0.0.1 refers to localhost on the remote server!</p> <p>Lets take it up a notch. In this following example the port that is listening can be connected to from other hosts on the local network.</p> <pre><code>localhost:~$ ssh  -L 0.0.0.0:9999:127.0.0.1:80 user@remoteserver\n</code></pre> <p>In these examples the port we are connecting is a listening web server. It could also be a proxy server or any other TCP service.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#3-ssh-tunnel-forward-to-secondary-remote-host","title":"3. SSH Tunnel Forward to Secondary Remote host","text":"<p>We can use the same options seen above to have the tunnel connect to another service running on a secondary system from the remote server.</p> <pre><code>localhost:~$ ssh  -L 0.0.0.0:9999:10.10.10.10:80 user@remoteserver\n</code></pre> <p>In this example we are forwarding the tunnel from remoteserver to the web server running on 10.10.10.10. The traffic from remoteserver -&gt; 10.10.10.10 is no longer within the ssh tunnel. The web server on 10.10.10.10 will see remoteserver as the source of the web requests.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#4-ssh-reverse-tunnel","title":"4. SSH Reverse Tunnel","text":"<p>In this scenario we want to setup a listening port on the remote server that will connect back to a local port on our localhost (or other system).</p> <pre><code>localhost:~$ ssh -v -R 0.0.0.0:1999:127.0.0.1:902 192.168.1.100 user@remoteserver\n</code></pre> <p>With this ssh session established a connection to the remoteserver port 1999 will be forwarded to port 902 on our local client.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#5-ssh-reverse-proxy","title":"5. SSH Reverse Proxy","text":"<p>In this case we are establishing a SOCKS proxy with our ssh connection, however the proxy is listening at the remote server end. With connections to that remote socks proxy now emerging from the tunnel as traffic originating from our localhost. Requires OpenSSH version 7.6+.</p> <pre><code>localhost:~$ ssh -v -R 0.0.0.0:1999 192.168.1.100 user@remoteserver\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#troubleshooting-remote-ssh-tunnels","title":"Troubleshooting Remote SSH Tunnels","text":"<p>If you are having trouble getting the remote SSH options to work, check with <code>netstat</code> which interface the listening port is attached too. Even though we have specified 0.0.0.0 in the above examples, if GatewayPorts is set to no in the sshd_config then the listener will only bind to localhost (127.0.0.1).</p> <p>Security Warning  Note that when you are opening tunnels and socks proxies you may be exposing internal network resources to untrusted networks (like the Internet!). This can be a serious security risk so ensure you understand what is listening and what it has access too.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#6-establish-a-vpn-over-ssh","title":"6. Establish a VPN over SSH","text":"<p>A common term amongst offensive security folks (pentesters / red teams / etc), is to pivot into a network. Once you have a connection established on one system that system becomes a gateway point for further access to the network. This is known as pivoting and enables lateral movement through the network.</p> <p>We can use the SSH proxy for this and proxychains, however there are some limitations. For example we cannot use raw sockets, so Nmap <code>SYN</code> scans cannot be used to port scan the Internal network.</p> <p>Using this more advanced VPN option we move the connectivity down to layer 3. We can then route traffic through the tunnel using standard network routing.</p> <p>This technique uses <code>ssh</code>, <code>iptables</code>, <code>tun interfaces</code> and routing.</p> <p>First we need these options set in the <code>sshd_config</code>. Since we are making interface changes on the remote system and the client system, we will need root privileges on both sides.</p> <pre><code>PermitRootLogin yes\nPermitTunnel yes\n</code></pre> <p>Then we will establish our <code>ssh</code> connection using the parameter that requests <code>tun</code> devices be initialised.</p> <pre><code>localhost:~# ssh -v -w any root@remoteserver\n</code></pre> <p>Now you should have a <code>tun</code> device when you show interfaces (<code># ip a</code>). Next step is to add IP addresses to the tunnel interfaces.</p> <p>SSH Client Side:</p> <pre><code>localhost:~# ip addr add 10.10.10.2/32 peer 10.10.10.10 dev tun0\nlocalhost:~# ip tun0 up\n</code></pre> <p>SSH Server Side:</p> <pre><code>remoteserver:~# ip addr add 10.10.10.10/32 peer 10.10.10.2 dev tun0\nremoteserver:~# ip tun0 up\n</code></pre> <p>Now we should have a direct route to the other host (<code>route -n</code> and <code>ping 10.10.10.10</code>).</p> <p>It is now possible to route any subnet through the other side host. </p> <pre><code>localhost:~# route add -net 10.10.10.0 netmask 255.255.255.0 dev tun0\n</code></pre> <p>On the remote side we need to enable <code>ip_forward</code> and <code>iptables</code>.</p> <pre><code>remoteserver:~# echo 1 &gt; /proc/sys/net/ipv4/ip_forward\nremoteserver:~# iptables -t nat -A POSTROUTING -s 10.10.10.2 -o enp7s0 -j MASQUERADE\n</code></pre> <p>Boom! Layer three VPN through an SSH tunnel. Now that's winning.</p> <p>Any trouble, try tcpdump and <code>ping</code> to see where its broken. Since we are playing at layer 3 our <code>icmp</code> packets should be jumping through that tunnel.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#7-copy-your-ssh-key-ssh-copy-id","title":"7. Copy your SSH key (ssh-copy-id)","text":"<p>There are multiple ways to achieve this however this command is a shortcut that saves time. What does it actually do? This command replicates what you can also do manually. Copying the <code>~/.ssh/id_rsa.pub</code> (or the default) key from your system and adds it to an <code>~/.ssh/authorized_keys</code> file on the remote server.</p> <pre><code>localhost:~$ ssh-copy-id user@remoteserver\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#8-run-command-remotely-non-interactive","title":"8. Run Command Remotely (non-interactive)","text":"<p>The <code>ssh</code> command can be chained to other commands for the usual piping fun. Add the command you want to run on the remote host as a final parameter in quotes.</p> <pre><code>localhost:~$ ssh remoteserver \"cat /var/log/nginx/access.log\" | grep badstuff.php\n</code></pre> <p>In this example the <code>grep</code> is being performed on the local system after the log file has been pushed across the <code>ssh</code> session. If the file is large it would be more efficient to run the <code>grep</code> on the remote side by enclosing the pipe and <code>grep</code> in the double quotes.</p> <p>Another example performs the same function as the <code>ssh-copy-id</code> short cut in Tip 7.</p> <pre><code>localhost:~$ cat ~/.ssh/id_rsa.pub | ssh remoteserver 'cat &gt;&gt; .ssh/authorized_keys'\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#9-remote-packet-capture-view-in-wireshark","title":"9. Remote Packet Capture &amp; View in Wireshark","text":"<p>I grabbed this one from our tcpdump examples. Use it for a remote packet capture with the results feeding directly into your local Wireshark GUI.</p> <pre><code>:~$ ssh root@remoteserver 'tcpdump -c 1000 -nn -w - not port 22' | wireshark -k -i -\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#10-ssh-copy-folder-from-local-to-remote","title":"10. SSH Copy Folder from Local to Remote","text":"<p>A neat trick that compresses a folder using <code>bzip2</code> (that's the -j in the <code>tar</code> command), then extracts the <code>bzip2</code> stream on the other side creating a duplicate of the folder on the remote server.</p> <pre><code>localhost:~$ tar -cvj /datafolder | ssh remoteserver \"tar -xj -C /datafolder\"\n</code></pre> <p>Copy remote folder to local tar archive</p> <p>To go the other way, copying a remote folder to a local archive. Handy for quick backups of remote resources.</p> <pre><code>localhost:~$ ssh user@remoteserver \"tar -jcf - /path/to/backup\" &gt; dir.tar.bz2\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#11-remote-gui-applications-with-ssh-x11-forwarding","title":"11. Remote GUI Applications with SSH x11 Forwarding","text":"<p>If the client and remote server both have X installed. It is possible to run a GUI command remotely, with the Window appearing on your local desktop. This feature has been around since the beginning of time, but can still be very useful. Run a remote web browser or even the VMWawre Workstation console as I do in this example.</p> <pre><code>localhost:~$ ssh -X remoteserver vmware\n</code></pre> <p>Requires <code>X11Forwarding yes</code> in the <code>sshd_config</code>.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#12-copy-files-remotely-with-rsync-and-ssh","title":"12. Copy files remotely with rsync and SSH","text":"<p>Using the <code>rsync</code> has many advantages over <code>scp</code>, if periodically need to backup a directory, large numbers of files or very large files it should be used. It has the ability to recover from failed transfers and only copy differences between two locations saving bandwidth and time.</p> <p>The example here uses <code>gzip</code> compression (-z) and archive mode (-a) that includes recursive copy.</p> <pre><code>:~$ rsync -az /home/testuser/data remoteserver:backup/\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#13-ssh-over-tor-network","title":"13. SSH over Tor Network","text":"<p>The anonymised Tor Network can tunnel SSH traffic by using the <code>torsocks</code> command. The following command will proxy the <code>ssh</code> connection through the Tor network. </p> <pre><code>localhost:~$ torsocks ssh myuntracableuser@remoteserver\n</code></pre> <p>Torsocks will use the localhost port 9050 to proxy traffic. As always when using <code>tor</code> serious consideration must be taken to understand what traffic is being tunnelled and other operational security (opsec) concerns. Where are your DNS requests going?</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#14-ssh-to-ec2-instance","title":"14. SSH to EC2 instance","text":"<p>When using SSH to connect to your EC2 instance within Amazon you will need to use a private key. Download the key (extension .pem) from your Amazon EC2 control panel and change the permissions (<code>chmod 400 my-ec2-ssh-key.pem</code>. Keep this key somewhere safe or put it in your <code>~/.ssh/</code> folder.</p> <pre><code>localhost:~$ ssh -i ~/.ssh/my-ec2-key.pem ubuntu@my-ec2-public\n</code></pre> <p>The -i parameter tells the <code>ssh</code> client to use this key. This would be an ideal example of where to use the <code>~/.ssh/config</code> to configure the use of the key automatically when connecting to the ec2 host.</p> <pre><code>Host my-ec2-public\n   Hostname ec2???.compute-1.amazonaws.com\n   User ubuntu\n   IdentityFile ~/.ssh/my-ec2-key.pem\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#15-edit-text-files-with-vim-over-sshscp","title":"15. Edit text files with VIM over ssh/scp","text":"<p>For all those <code>vim</code> users out there, this one can save some time. Using <code>vim</code> we can edit files over <code>scp</code> with one command. Using this method creates a file in <code>/tmp</code> on the local system and then copies it back once we write the file in <code>vim</code>.</p> <pre><code>localhost:~$ vim scp://user@remoteserver//etc/hosts\n</code></pre> <p>Note the format is slightly different to regular <code>scp</code>. After the host we have a double <code>//</code>. This references the absolute path. A single slash will have a path that is relative to the users home directory.</p> <pre><code>**warning** (netrw) cannot determine method (format: protocol://[user@]hostname[:port]/[path])\n</code></pre> <p>If you see this error, double check the format of your command. It usually means there is a syntax error.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#16-mount-remote-ssh-location-as-local-folder-with-sshfs","title":"16. Mount remote SSH location as local folder with SSHFS","text":"<p>Using <code>sshfs</code> - an <code>ssh</code> filesystem client, we can mount a local directory to a remote location with all file interaction taking place over the encrypted <code>ssh</code> session.</p> <pre><code>localhost:~$ apt install sshfs\n</code></pre> <p>On Ubuntu and Debian based system we install the <code>sshfs</code> package and then mount the remote location.</p> <pre><code>localhost:~$ sshfs user@remoteserver:/media/data ~/data/\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#17-ssh-multiplex-using-controlpath","title":"17. SSH Multiplex using ControlPath","text":"<p>By default when you have an existing connection to a remote server with <code>ssh</code>, a second connection using <code>ssh</code> or <code>scp</code> will establish a new session with the overhead of authentication. Using the <code>ControlPath</code> options we can have the existing session be used for all subsequent connections. This will speed things up significantly. It is noticeable even on a local network but even more so when connecting to remote resources.</p> <pre><code>Host remoteserver\n        HostName remoteserver.example.org\n        ControlMaster auto\n        ControlPath ~/.ssh/control/%r@%h:%p\n        ControlPersist 10m\n</code></pre> <p>ControlPath denotes a socket that is checked by new connections to see if there is an existing <code>ssh</code> session that can be used. The ControlPersist option above means even after you exit the terminal, the existing session will remain open for 10 minutes, so if you were to reconnect within that time you would use that existing socket. See the <code>ssh_config</code> <code>man</code> page for more information.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#18-stream-video-over-ssh-using-vlc-sftp","title":"18. Stream Video over SSH using VLC + SFTP","text":"<p>Long time users of <code>ssh</code> and <code>vlc</code> (Video Lan Client) are not always of aware of this handy option for when you need to watch video over the network. Using the <code>vlc</code> option to File | Open Network Stream one can enter the location as a an <code>sftp://</code> location. A prompt will appear for authentication details if password is required.</p> <pre><code>sftp://remoteserver//media/uploads/myvideo.mkv\n</code></pre>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#19-two-factor-authentication","title":"19. Two Factor Authentication","text":"<p>Most readers will understand the value in using Two Factor Authentication, the same benefits that apply to your banking or Google Account can be applied to your SSH service.</p> <p>Of course <code>ssh</code> comes with a form of Two Factor capability included, that being a passphrase and an SSH key. An advantage of using a hardware based token or the Google Authenticator App is the fact that they are generally coming from a second physical device.</p> <p>See our 8 minute guide to getting started with Google Authenticator and SSH.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#20-bouncing-through-jump-hosts-with-ssh-and-j","title":"20. Bouncing through jump hosts with ssh and -J","text":"<p>When network segmentation means you are jumping through multiple <code>ssh</code> hosts to get to a final destination network or host, this jump host shortcut might be just what you need. Requires OpenSSH version 7.3+.</p> <pre><code>localhost:~$ ssh -J host1,host2,host3 user@host4.internal\n</code></pre> <p>A key thing to understand here is that this is not the same as <code>ssh host1</code> then <code>user@host1:~$ ssh host2</code>, the <code>-J</code> jump parameter uses forwarding trickery so that the localhost is establishing the session with the next host in the chain. So our localhost is authenticating with host4 in the above example; meaning our localhost keys are used and the session from localhost to host4 is encrypted end to end.</p> <p>To use this ability in the <code>ssh_config</code> use the ProxyJump configuration option. If you regularly have to jump through multiple hosts; use the config file and your alias to <code>host4</code> will save you a lot of time.</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#21-block-ssh-brute-force-attempts-with-iptables","title":"21. Block SSH Brute Force Attempts with iptables","text":"<p>Anyone who has managed an SSH service on the Internet, and viewed the logs will be aware of the amount of SSH brute force attempts that take place every hour of every day. An immediate way to reduce the noise in your logs is to move SSH to a port other than 22. Make the change in the <code>sshd_config</code> file using the Port ## configuration option.</p> <p>Using <code>iptables</code> we can also block attempts to connect to the port from sources that reach a certain threshold. A way to do this is to use OSSEC, as this not only blocks SSH but will also perform a bunch of other host based intrusion detection functions (HIDS).</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#22-modify-port-forwarding-within-a-session-with-c","title":"22. Modify Port Forwarding within a session with ~C","text":"<p>And our final <code>ssh</code> example is for modifying port forwarding on the fly within an existing <code>ssh</code> session. Picture this example scenario. You are deep in a network; perhaps you have jumped through half a dozen jump hosts and need a local port on your workstation forwarded to Microsoft SMB on the old Windows 2003 system you spotted (ms08-67 anyone?).</p> <p>After hitting <code>enter</code> try typing <code>~C</code> in your terminal. This a control escape sequence within the session that allows to make changes to the existing connection.</p> <pre><code>localhost:~$ ~C\nssh&gt; -h\nCommands:\n      -L[bind_address:]port:host:hostport    Request local forward\n      -R[bind_address:]port:host:hostport    Request remote forward\n      -D[bind_address:]port                  Request dynamic forward\n      -KL[bind_address:]port                 Cancel local forward\n      -KR[bind_address:]port                 Cancel remote forward\n      -KD[bind_address:]port                 Cancel dynamic forward\nssh&gt; -L 1445:remote-win2k3:445\nForwarding port.\n</code></pre> <p>You can see here we have forwarded our local port 1445 to the Windows 2003 host we found on the internal network. Now launch <code>msfconsole</code> and we are good to go (assuming you were planning on exploiting that host).</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/ssh-tips/#wrapping-up","title":"Wrapping Up","text":"<p>These <code>ssh</code> examples, tips and commands are intended to give you a starting point; additional detail on each of the commands and capabilities is available using the <code>man</code> pages (<code>man ssh</code>, <code>man ssh_config</code>, <code>man sshd_config</code>).</p> <p>Being able to reach out and run commands on systems anywhere in the world has always fascinated me. By developing your skills with tools such as <code>ssh</code> you will become more productive and effective at whatever game you play.</p> <p>Thanks for reading and if you have any comments or suggestions please drop me a note using the contact form. Have fun!</p> <p>Know Your Attack Surface</p> <p>USE CASES &amp; MORE INFO</p>","tags":["ssh","forward","tunnel","proxy"]},{"location":"tips/wechat-contacts-backup/","title":"\u5fae\u4fe1\u901a\u8baf\u5f55\u5907\u4efd","text":"<p>Source</p> <p>\u8eab\u5904\u6570\u5b57\u65f6\u4ee3\uff0c\u6211\u4eec\u6bcf\u5929\u90fd\u5728\u793e\u4ea4\u5a92\u4f53\u4ea7\u751f\u5185\u5bb9\u3002\u7531\u4e8e\u7279\u6b8a\u7684\u56fd\u60c5\uff0c\u6211\u4eec\u7684\u6570\u5b57\u8d44\u4ea7\u5f88\u96be\u5f97\u5230\u5e94\u6709\u7684\u4fdd\u969c\uff0c\u6240\u4ee5\u53ca\u65f6\u5907\u4efd\u975e\u5e38\u91cd\u8981\u3002\u4e00\u4e2a\u6708\u524d\uff0c\u6211\u7684\u65b0\u6d6a\u5fae\u535a\u88ab\u5c01\uff0c\u5e86\u5e78\u4e4b\u524d\u8fdb\u884c\u8fc7 \u201c\u5907\u4efd\u201d\uff0c\u5fae\u535a\u5185\u5bb9\u5f97\u4ee5\u4fdd\u5b58\u3002</p> <p>\u5728\u4f17\u591a\u793e\u4ea4\u5e73\u53f0\u5f53\u4e2d\uff0c\u6211\u4eec\u6bcf\u5929\u4f7f\u7528\u6700\u591a\u7684\u6beb\u65e0\u7591\u95ee\u662f\u5fae\u4fe1\u4e86\u3002\u6df1\u5ea6\u4f7f\u7528\u8fc7 Telegram \u7684\u670b\u53cb\u5e94\u8be5\u90fd\u77e5\u9053\u5fae\u4fe1\u4e4b\u6076\uff0c\u6211\u751a\u81f3\u60f3\u8fc7\u50cf\u674e\u5982\u4e00\u90a3\u6837\u544a\u522b\u4f7f\u7528\u5fae\u4fe1\uff0c\u53ef\u662f\u8fd9\u5bf9\u4e8e\u6211\u548c\u5f88\u591a\u4eba\u6765\u8bf4\u90fd\u662f\u4e0d\u73b0\u5b9e\u7684\u3002\u56e0\u4e3a\u73b0\u5728\u624b\u673a\u901a\u8baf\u5f55\u5f62\u540c\u865a\u8bbe\uff0c\u6211\u4eec\u5927\u90e8\u5206\u65f6\u95f4\u90fd\u901a\u8fc7\u5fae\u4fe1\u548c\u670b\u53cb\u6c9f\u901a\uff0c\u5fae\u4fe1\u53f7\u5c31\u5982\u540c\u624b\u673a\u53f7\u3002</p> <p>\u8981\u5907\u4efd\u8fd9\u4e9b\u5fae\u4fe1\u8054\u7cfb\u4eba\u4e00\u70b9\u4e5f\u4e0d\u5bb9\u6613\uff0c\u5fae\u4fe1\u7528\u5c3d\u5168\u529b\u4fdd\u62a4\uff08\u7981\u6b62\u7528\u6237\u76f4\u63a5\u8bbf\u95ee\uff09\u4e2a\u4eba\u6570\u636e\uff1a\u5728\u5fae\u4fe1\u7f51\u9875\u7248\u770b\u4e0d\u5230\u597d\u53cb\u5fae\u4fe1\u53f7\u3001\u52a0\u5bc6\u4fdd\u5b58\u5fae\u4fe1\u5ba2\u6237\u7aef\u5907\u4efd\u540e\u7684\u6570\u636e\u5185\u5bb9\u7b49\u3002\u7f51\u4e0a\u6709\u7b2c\u4e09\u65b9\u5907\u4efd\u5fae\u4fe1\u901a\u8baf\u5f55\u7684\u5de5\u4f5c\u548c\u4ed8\u8d39\u5907\u4efd\u7684\u65b9\u6848\uff0c\u4f46\u57fa\u4e8e\u5fae\u4fe1\u901a\u8baf\u5f55\u9690\u79c1\u4fdd\u62a4\u7684\u8003\u8651\uff0c\u8fd8\u662f\u81ea\u5df1\u52a8\u624b\u5427\u3002</p> <p>\u4ee5\u4e0b\u65b9\u6cd5\u5728 macOS \u4e0b\u6d4b\u8bd5\u53ef\u7528</p> <p>\u5fae\u4fe1\u5728\u672c\u5730\u5b58\u50a8\u4e86\u4e00\u4e2a\u4ee5 Hash \u4e32\u547d\u540d\u7684\u6587\u4ef6\u5939\uff0c\u6bcf\u4e2a\u767b\u5f55\u8fc7\u7684\u7528\u6237\u90fd\u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u6587\u4ef6\u5939\uff0c\u5185\u6709\u5b50\u6587\u4ef6\u5939\u5bf9\u5e94\u4e0d\u540c\u7c7b\u522b\u7684 SQLite \u6570\u636e\u5e93\uff0c\u4e14\u901a\u8fc7 sqlcipher \u52a0\u5bc6\uff0c\u6211\u4eec\u9700\u8981\u5229\u7528 lldb \u8c03\u8bd5\u83b7\u5f97 <code>sqlite3_key</code>\uff0c\u7136\u540e\u5bf9\u901a\u8baf\u5f55 SQLite \u89e3\u5bc6\uff0c\u63d0\u53d6\u6570\u636e\u3002</p> <p>\u6587\u4ef6\u5939\u540d\u4f5c\u7528 Message \u804a\u5929\u8bb0\u5f55 Contact \u5fae\u4fe1\u901a\u8baf\u5f55 Group \u7fa4\u7ec4\u6570\u636e Favorites \u5fae\u4fe1\u6536\u85cf</p>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#1","title":"1. \u5148\u627e\u5230\u5fae\u4fe1\u901a\u8baf\u5f55\u8def\u5f84","text":"<pre><code>$ ls -l ~/Library/Containers/com.tencent.xinWeChat/Data/Library/Application\\ Support/com.tencent.xinWeChat/*/*/Contact/*.db\n</code></pre> <p>\u627e\u5230 <code>wccontact_new2.db</code> \u6587\u4ef6</p>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#2-wccontact_new2db","title":"2. \u5c06\u627e\u5230\u7684 wccontact_new2.db \u590d\u5236\u5230\u4e34\u65f6\u76ee\u5f55","text":"<pre><code>$ cp wccontact_new2.db ~/tmp\n</code></pre>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#3-lldb-wechat","title":"3. \u4f7f\u7528 lldb \u8c03\u8bd5 Wechat \u83b7\u5f97\u5bc6\u94a5","text":"<ul> <li>\u6ce8\u9500\u5f53\u524d mac OS \u5fae\u4fe1\u767b\u5f55</li> <li>\u6253\u5f00\u5fae\u4fe1\uff0c\u4e0d\u8981\u767b\u5f55</li> <li>Terminal \u6267\u884c <code>$ lldb -p $(pgrep WeChat)</code></li> <li>Terminal \u6267\u884c <code>br set -n sqlite3_key</code></li> <li>Terminal \u6267\u884c <code>continue</code></li> <li>\u767b\u5f55 mac OS \u5fae\u4fe1</li> <li> <p>Terminal \u6267\u884c <code>memory read --size 1 --format x --count 32 $rsi</code>\uff0c\u6b64\u65f6\u4f1a\u8f93\u51fa</p> <p>0x600002457b60: 0xb7 0x14 0x95 0xab 0xc5 0x69 0x41 0x35 0x600002457b68: 0x99 0x26 0x36 0xae 0xce 0x04 0x90 0xef 0x600002457b70: 0x5b 0x5c 0x66 0xde 0x1a 0x36 0x4a 0x0a 0x600002457b78: 0xba 0x71 0xf6 0xc5 0x8e 0xa7 0xc8 0x0d * Terminal \u6267\u884c <code>Exit</code> \u9000\u51fa\u8c03\u8bd5 * \u5c06\u4e0a\u9762\u8bfb\u5230\u7684\u5185\u5b58\u5185\u5bb9\u7c98\u8d34\u5230 Python \u89e3\u5bc6 [\u4ee3\u7801][\u5728\u7ebf\u8fd0\u884c]</p> <p>Key: <code>0xb71495abc5694135992636aece0490ef5b5c66de1a364a0aba71f6c58ea7c80d</code></p> </li> </ul>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#4-sqlite","title":"4. \u4f7f\u7528\u5bc6\u94a5\u6253\u5f00 SQLite","text":"<ul> <li>\u4e0b\u8f7d DB Browser for SQLite</li> <li>\u4f7f\u7528 DB Browser for SQLite \u6253\u5f00 <code>wccontact_new2.db</code>\uff0c\u9009\u62e9 SQLCipher 3 defaults / Raw key\uff0c\u7136\u540e\u8f93\u5165\u5bc6\u94a5</li> <li>\u5373\u53ef\u6253\u5f00 SQLite \u6587\u4ef6</li> </ul>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#5","title":"5. \u5bfc\u51fa\u6570\u636e","text":"<p>\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 DB Browser for SQLite \u5bfc\u51fa CSV\uff0c\u5f53\u7136\u4f60\u5728\u4e0a\u9762\u505a SQL Query \u4e5f\u884c\u3002</p> <p></p>","tags":["wechat","contact"]},{"location":"tips/wechat-contacts-backup/#6-wccontact","title":"6. WCContact \u6570\u636e\u8868\u5206\u6790","text":"<p>\u5728\u8fd9\u5f20\u540d\u4e3a WCContact \u7684\u6570\u636e\u8868\u4e2d\uff0c\u53ea\u6709 <code>m_nsUsrName</code> \u548c <code>m_nsAliasName</code> \u8fd9\u4e24\u4e2a\u5b57\u6bb5\u6709\u7528\u3002\u6211\u7684\u5fae\u4fe1\u53f7\u5bf9\u5e94\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u90fd\u53ef\u4ee5\u901a\u8fc7\u5fae\u4fe1\u641c\u7d22\u627e\u5230\u540c\u4e00\u4e2a\u5fae\u4fe1\u5e10\u53f7\uff0c\u6211\u731c\u6d4b\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u662f\u7528\u6765\u89e3\u51b3\u5fae\u4fe1\u65e9\u671f QQ \u767b\u5f55\u548c\u624b\u673a\u7ed1\u5b9a\u4e4b\u95f4\u7684\u5b57\u6bb5\u51b2\u7a81\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06 <code>m_nsUsrName</code> \u5b57\u6bb5\u4f5c\u4e3a\u5fae\u4fe1\u53f7\uff0c\u4e0a\u56fe\u53ef\u89c1\u6709\u4e9b\u7528\u6237\u4f1a\u4f7f\u7528 <code>wxid_</code> \u4ee3\u66ff\u5fae\u4fe1\u53f7\uff0c\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a\u7528\u6237\u524d\u671f\u6ca1\u6709\u6ce8\u518c\u5fae\u4fe1 ID\uff0c\u901a\u8fc7 wxid \u53ef\u4ee5\u8f6c\u6362\u6210\u4e8c\u7ef4\u7801\u6dfb\u52a0\u8be5\u597d\u53cb\u3002[mirror]</p> <p>\u7075\u9b42\u62f7\u95ee\uff1a\u54b1\u4eec\u5fae\u4fe1\u80fd\u4e0d\u80fd\u505a\u5f00\u653e\u70b9\uff1f @Allen Zhang</p> <p>Reference: [1] https://www.v2ex.com/t/466053</p>","tags":["wechat","contact"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/","title":"TCPDump Capture HTTP GET/POST requests","text":"<p>Source</p> <p>TCPDUMP is a swiss army knife for all the administrators and developers when it comes to troubleshooting. This post is written for the people who work in middleware technologies. Web servers such as Apache, NGINX, Oracle HTTP, IHS web servers and application servers such as Weblogic, Websphere, Tomcat, Jboss</p> <p>Consider yourself in any of the following scenarios</p> <ol> <li>You want to monitor the traffic inflow and outflow of Apache httpd server on any specific port like port 80 or 443</li> <li>You have to track the HTTP calls between web and application servers (or) to make sure that proxy is working fine.</li> <li> <p>When you want to examine the presence and values of specific headers like </p> <p><code>X-Forwarded-For X-Forwarded-Proto X-Forwarded-Port X-Forwarded-Host X-Frame-Options X-Forwarded-By ETag</code> 4. When you want to review the Cookies being placed in the request and response 5. when you want to review the data which is being posted to the server in the POST method like </p> <p><code>Content-type: multipart/form-data;   Content-Type: application/x-www-form-urlencoded  Content-Type: application/json  Content-Type: text/plain</code> 6. To track the incoming web service call, made using SOAP UI (or) any web service client.</p> </li> </ol>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#so-how-do-you-do-that","title":"So, How do you do that?","text":"<p>**The answer is TCPDUMP. ** TCPDUMP is mostly misconceived as a network engineer's subject and it displays some incomprehensible binary data that none of us could understand.</p> <p>With proper tools and little knowledge about protocols, anyone can easily make use of it and feel the magic lies within.</p> <p>Be informed that the industry standards have changed for good and the HTTPS is becoming a basic requirement for all webservices and websites. So it might make your troubleshooting little hard, since the packets are encrypted. There is a solution to decrypt HTTPS traffic</p> <p>Refer my another article on How to decrypt HTTPS traffic to see headers and request/response content</p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#the-objective","title":"The Objective","text":"<p>In this post, we are going to see how middleware administrators (or) developers could use tcpdump to accomplish their troubleshooting drama.</p> <p>We are going to discuss the following items , practically as much as possible.</p> <ul> <li>How to monitor/track HTTP and HTTPS calls with tcpdump in weblogic,WebSphere,tomcat application servers and web servers like Apache which runs on LINUX platform</li> <li>How to tamper and read the incoming and outgoing HTTP traffic to our applications deployed in weblogic</li> <li>How to dig into the incoming (or) outgoing HTTP traffic and take a look at the concrete elements of HTTP protocol such as** headers, cookies, request body** as they gets transmitted.</li> <li>How to intercept the HTTP traffic initiated from the browser (or) SOAP UI to application server and sneak a peek into the content like Request Body like** XML,JSON and **Username and Password etc.</li> <li> <p>How to monitor the incoming SOAP web service request body (or) request XML</p> </li> <li> <p>More practical examples on how to use TCPDUMP to analyze the HTTP traffic</p> </li> </ul>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#before-we-proceed","title":"Before we proceed","text":"<p>Some basics about how to run tcpdump in your server in the right way.</p> <p>Make sure tcpdump is installed and configured properly</p> <pre><code>[root@mwiws01 ~]# tcpdump \u2013 version\ntcpdump version 4.9.2\nlibpcap version 1.5.3\nOpenSSL 1.0.2k-fips 26 Jan 2017\n</code></pre> <p>Use the right interface name (or) use any in the interface name.</p> <p>To Get the interface name of your IP which you need to specify it in the tcpdump command. you can execut the command <code>ifconfig</code> (or) <code>ip a</code></p> <p>In my case, My web server IP is <code>192.168.31.76</code> so I should pick and use the interface name of the same <code>wlp0s20f3</code></p> <pre><code>$ ifconfig wlp0s20f3\nwlp0s20f3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500\n        inet 192.168.31.76  netmask 255.255.255.0  broadcast 192.168.31.255\n        inet6 2409:8a50:693:930:da38:cc7c:4d8f:8d93  prefixlen 64  scopeid 0x0&lt;global&gt;\n        inet6 2409:8a50:693:930::d02  prefixlen 128  scopeid 0x0&lt;global&gt;\n        inet6 fe80::cbf:9e72:4be8:6b73  prefixlen 64  scopeid 0x20&lt;link&gt;\n        inet6 2409:8a50:693:930:72db:3ee4:8539:332d  prefixlen 64  scopeid 0x0&lt;global&gt;\n        ether 6c:94:66:4b:c3:cd  txqueuelen 1000  \n        RX packets 18758580  bytes 3461986404 (3.4 GB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 2564530  bytes 960162238 (960.1 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n</code></pre> <p>Once you found your interface. In the requests you are going to track. you must mention the interface name</p> <pre><code>tcpdump -i wlp0s20f3\n</code></pre> <p>you can optionally monitor all the available interfaces by mentioning</p> <pre><code>tcpdump -i any\n</code></pre> <p>Now we are All ready to Play.</p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#tcpdump-examples","title":"tcpdump Examples","text":"<p>TCPDUMP does the same job irrespective to what technology (or) server you are using it for. In other words, if you would like capture HTTP calls for Apache. You mostly going to be using the port 80 or 443.</p> <p>If you would like to capture the traffic of weblogic (or) Websphere or any application servers. All you have to do is change the port number in which your application server is listening</p> <p>Though we have given examples for both web and application servers here. All you should be aware of is that. There is nothing specific to technology. We just change the port number (or) interface. That's all.</p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-all-incoming-http-get-traffic-or-requests","title":"How to capture All incoming HTTP GET traffic (or) requests","text":"<pre><code>sudo tcpdump -i wlp0s20f3 -s 0 -A 'tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420'\n</code></pre> <p>Explanation:-</p> <p><code>tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4]</code> first determines the location of the bytes we are interested in (after the TCP header) and then selects the 4 bytes we wish to match against.</p> <p>To know more about how this segment syntax has been derived. refer this link</p> <p>Here <code>0x47455420</code> depicts the ASCII value of characters <code>'G' 'E' 'T' ' '</code></p> Character ASCII Value G 47 E 45 T 54 Space 20 <p>Refer this ASCII map table for more reference</p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-all-incoming-http-post-requests","title":"How to capture All incoming HTTP POST requests","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354'\n</code></pre> <p>Here <code>0x504F5354</code> represents the ASCII value of <code>'P' 'O' 'S' 'T'</code></p> <p>Sample Output</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n\n13:48:21.019415 IP 192.168.31.205.54511 &gt; wgzhao-laptop.http: Flags [P.], seq 952980253:952980331, ack 3271140678, win 2058, options [nop,nop,TS val 2736792397 ecr 1034997687], length 78: HTTP: POST / HTTP/1.1\nE.....@.@.z........L...P8.S....F...\n&lt;......\n. #M=...POST / HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-only-http-get-requests-incoming-to-port-80-apachenginx","title":"How to capture only HTTP GET requests Incoming to port 80 ( Apache/NGINX)","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420'\n</code></pre> <p>Sample Output</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n13:52:30.348948 IP 192.168.31.205.57439 &gt; wgzhao-laptop.http: Flags [P.], seq 2517601825:2517601912, ack 3234167917, win 2058, options [nop,nop,TS val 3003354219 ecr 1035247016], length 87: HTTP: GET /index.html HTTP/1.1\nE.....@.@.z........L._.P...!..|m...\npx.....\n...k=...GET /index.html HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-only-http-post-requests-incoming-to-port-80-apachenginx","title":"How to capture only HTTP POST requests Incoming to port 80 ( Apache/NGINX)","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354'\n</code></pre> <p>Sample Output</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n\n13:54:03.126400 IP 192.168.31.205.58596 &gt; wgzhao-laptop.http: Flags [P.], seq 207644020:207644108, ack 3869953719, win 2058, options [nop,nop,TS val 1754598356 ecr 1035339794], length 88: HTTP: POST /index.html HTTP/1.1\nE.....@.@.z........L...P.`et.......\n.b.....\nh...=...POST /index.html HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-only-http-get-calls-incoming-to-port-443-apachenginx","title":"How to capture only HTTP GET calls Incoming to port 443 ( Apache/NGINX)","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 443 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420'\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-only-http-post-calls-incoming-to-port-443-apachenginx","title":"How to capture only HTTP POST calls Incoming to port 443 ( Apache/NGINX)","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 443 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354'\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-both-http-get-or-post-incoming-calls-to-port-80-or-443-apachenginx-originating-from-19216831205-host","title":"How to capture both HTTP GET (or) POST Incoming calls to port 80 (or) 443 ( Apache/NGINX) Originating from 192.168.31.205 Host**","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 or tcp dst port 443 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 and host 192.168.31.205'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n13:59:31.404400 IP 192.168.31.205.62507 &gt; wgzhao-laptop.http: Flags [P.], seq 3732089400:3732089488, ack 1222075730, win 2058, options [nop,nop,TS val 783516821 ecr 1035668072], length 88: HTTP: POST /index.html HTTP/1.1\nE.....@.@.z........L.+.P.s*8H.eR...\n.C.....\n....=.\nhPOST /index.html HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n\n\n13:59:36.729382 IP 192.168.31.205.62568 &gt; wgzhao-laptop.http: Flags [P.], seq 1815931667:1815931754, ack 1237652196, win 2058, options [nop,nop,TS val 3905580542 ecr 1035673396], length 87: HTTP: GET /index.html HTTP/1.1\nE.....@.@.z........L.h.Pl&lt;..I......\np......\n..m.=..4GET /index.html HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-a-complete-http-transmission-incoming-and-outgoing-get-and-post","title":"How to capture a Complete HTTP Transmission incoming and outgoing GET and POST","text":"<p>Let's suppose I access a page hosted in <code>192.168.31.76</code> web server from my base machine with ip address <code>192.168.31.205.</code> using both GET and POST methods. How do we track the HTTP request and response between the server and the client</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.205'\n</code></pre> <p>Here additionally, we are using two more ASCII values to capture the outgoing HTML files and HTTP calls they are as follows.</p> <p><code>0x3C21444F</code> represents the ASCII value of <code>'&lt;' 'D' 'O' 'C'</code> this is to capture the outgoing HTML file</p> <p><code>0x48545450</code> represents the ASCII value of <code>'H' 'T' 'T' 'P'</code> this is to capture the outgoing HTTP traffic (HTTP response)</p> <p>Trying with GET</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.205'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n\n\n14:06:37.059470 IP 192.168.31.205.51047 &gt; wgzhao-laptop.http: Flags [P.], seq 4216390795:4216390882, ack 769730052, win 2058, options [nop,nop,TS val 905239047 ecr 1036093728], length 87: HTTP: GET /index.html HTTP/1.1\nE.....@.@.z........L.g.P.Q..-.&amp;....\n.......\n5...=.. GET /index.html HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n\n\n14:06:37.059885 IP wgzhao-laptop.http &gt; 192.168.31.205.51047: Flags [P.], seq 1:863, ack 87, win 128, options [nop,nop,TS val 1036093732 ecr 905239047], length 862: HTTP: HTTP/1.1 200 OK\nE.....@.@._!...L.....P.g-.&amp;..Q.............\n=..$5...HTTP/1.1 200 OK\nServer: nginx/1.22.0 (Ubuntu)\nDate: Wed, 22 Mar 2023 06:06:37 GMT\nContent-Type: text/html\nContent-Length: 615\nLast-Modified: Wed, 22 Mar 2023 05:44:43 GMT\nConnection: keep-alive\nETag: \"641a95cb-267\"\nAccept-Ranges: bytes\n\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Trying with POST</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.205'\n\n14:09:16.523346 IP 192.168.31.205.52920 &gt; wgzhao-laptop.http: Flags [P.], seq 1264301850:1264301928, ack 2774851506, win 2058, options [nop,nop,TS val 1964671602 ecr 1036253191], length 78: HTTP: POST / HTTP/1.1\nE.....@.@.z........L...PK[...d.....\nU......\nu..r=...POST / HTTP/1.1\nHost: wgzhao-laptop\nUser-Agent: curl/7.86.0\nAccept: */*\n\n\n14:09:16.523609 IP wgzhao-laptop.http &gt; 192.168.31.205.52920: Flags [P.], seq 1:333, ack 78, win 128, options [nop,nop,TS val 1036253196 ecr 1964671602], length 332: HTTP: HTTP/1.1 405 Not Allowed\nE....K@.@......L.....P...d..K[.h...........\n=...u..rHTTP/1.1 405 Not Allowed\nServer: nginx/1.22.0 (Ubuntu)\nDate: Wed, 22 Mar 2023 06:09:16 GMT\nContent-Type: text/html\nContent-Length: 166\nConnection: keep-alive\n\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;405 Not Allowed&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;405 Not Allowed&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx/1.22.0 (Ubuntu)&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>In the preceding illustrations, you can see the output of tcpdump command  shows the REQUEST and RESPONSE data along with the HTML code. </p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-monitor-all-the-incoming-http-request-urls-post-or-get","title":"How to monitor all the incoming HTTP Request URL's (POST or GET)","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -v -n -l | egrep -i \"POST /|GET /|Host:\"\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-http-passwords-in-post-requests","title":"How to capture HTTP Passwords in POST Requests","text":"<pre><code>tcpdump -i wlp0s20f3 -s 0 -A -n -l | egrep -i \"POST /|pwd=|passwd=|password=|Host:\"\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-the-cookies-from-server-and-from-client-request-response","title":"How to capture the Cookies from Server and from Client ( Request &amp; Response)","text":"<pre><code>tcpdump -i wlp0s20f3 -nn -A -s0 -l | egrep -i 'Set-Cookie|Host:|Cookie:'\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-filter-http-user-agents","title":"How to Filter HTTP User Agents","text":"<p>Extract HTTP User Agent from HTTP request header.</p> <pre><code>tcpdump -vvAls0 | grep 'User-Agent:'\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-the-http-packets-being-transmitted-between-webserver-and-application-server-both-get-post","title":"How to capture the HTTP packets being transmitted between Webserver and Application server both GET &amp; POST?","text":"<p>In cases, where you have check the HTTP traffic between webserver and application server. you can use tcpdump to diagnose and troubleshoot the issue. It will be helpful for many middleware administrators.</p> <p>Let's suppose this is your environment</p> Backend Server IP 192.168.31.76 Nginx Server IP 192.168.31.205 Nginx Server Port 8080 <p>You can run the following command at the application server to accomplish your requirement</p> <pre><code>tcpdump -i any -s 0 -A 'tcp dst port 8080 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.76'\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-capture-a-complete-http-transmission-with-tcpdump-get-post-on-specific-port","title":"How to capture a Complete HTTP Transmission with TCPDUMP ( GET &amp; POST) on specific port","text":"<p>All the examples we have given above can be used for weblogic with just a little change in port number. However. we are giving an example here.</p> <p>Here we are going to make a call from the client with up <code>192.168.31.205</code> to our  Application using GET and POST methods and capture the HTTP traffic data at the server end</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 18001 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.76'\n</code></pre> <p>Sample Output</p> <p>**Request from **<code>192.168.31.205</code> **using **<code>curl -v</code></p> <pre><code> curl -v -XPOST -d \"hello\"  http://localhost:8080/server\n Unnecessary use of -X or --request, POST is already inferred.\n*   Trying 127.0.0.1:8080...\n* Connected to localhost (127.0.0.1) port 8080 (#0)\n&gt; POST /server HTTP/1.1\n&gt; Host: localhost:8080\n&gt; User-Agent: curl/7.86.0\n&gt; Accept: */*\n&gt; Content-Length: 5\n&gt; Content-Type: application/x-www-form-urlencoded\n&gt;\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 200 OK\n&lt; Server: nginx/1.23.3\n&lt; Date: Wed, 22 Mar 2023 06:34:08 GMT\n&lt; Transfer-Encoding: chunked\n&lt; Connection: keep-alive\n&lt;\n* Connection #0 to host localhost left intact\nReceived POST request with data: hello%\n</code></pre> <p>Response</p> <pre><code>tcpdump -i wlp0s20f3 -s 0 -A 'tcp dst port 18001 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x3C21444F and host 192.168.31.76'\n\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on wlp0s20f3, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n\n14:35:08.235142 IP 192.168.31.205.54678 &gt; wgzhao-laptop.8888: Flags [P.], seq 3387431051:3387431226, ack 2818253595, win 2058, options [nop,nop,TS val 1305195002 ecr 1037804904], length 175\nE.....@.@.y........L..\".......#....\n.......\nM...=..hPOST / HTTP/1.0\nHost: 192.168.31.76:8888\nConnection: close\nContent-Length: 5\nUser-Agent: curl/7.86.0\nAccept: */*\nContent-Type: application/x-www-form-urlencoded\n\nhello\n14:35:08.235550 IP wgzhao-laptop.8888 &gt; 192.168.31.205.54678: Flags [P.], seq 1:95, ack 175, win 131, options [nop,nop,TS val 1037804908 ecr 1305195002], length 94\nE...g.@.@..:...L....\".....#....:...........\n=..lM...HTTP/1.0 200 OK\nServer: SimpleHTTP/0.6 Python/3.10.7\nDate: Wed, 22 Mar 2023 06:35:08 GMT\n\n14:35:26.047089 IP blackcat.canonical.com.http &gt; wgzhao-laptop.24674: Flags [P.], seq 1899838163:1899838310, ack 531714235, win 453, options [nop,nop,TS val 302839182 ecr 3954227041], length 147: HTTP: HTTP/1.1 204 No Content\nE.....@.@..a[.[1...L.P`bq=:...P.....1......\n.......aHTTP/1.1 204 No Content\nserver: nginx/1.14.0 (Ubuntu)\ndate: Wed, 22 Mar 2023 06:35:25 GMT\nx-networkmanager-status: online\nconnection: close\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-record-a-tcpdump-session-or-capture-packets-with-tcpdump","title":"How to record a TCPDUMP Session (or) Capture packets with tcpdump","text":"<p>To record the tcpdump session, you can use the following command</p> <p>Note: here I have used any as an interface to capture all the packets across all the channels/interfaces available in my server</p> <pre><code>tcpdump -i any -s 0 -X -w /tmp/tcpdump.pcap\n</code></pre> <p><code>pcap</code> is a widely accepted extension for the tcpdump output.</p>","tags":["tcpdump"]},{"location":"troubleshooting/capture-http-requests-with-tcpdump/#how-to-read-the-tcpdump-recorded-session-or-packet-capture-pcap-file","title":"How to read the TCPDUMP recorded session (or) packet capture - pcap file","text":"<pre><code>tcpdump -A -r /tmp/tcpdump.pcap\n</code></pre> <p>This way. you would be able to read the recorded session and it will offer more information than the ASCII matching commands.</p> <p>You can also use commands like <code>less</code> for better readability and search.</p> <pre><code>tcpdump -A -r /tmp/tcpdump.pcap|less\n</code></pre>","tags":["tcpdump"]},{"location":"troubleshooting/deep-in-tcp-connect/","title":"\u8be6\u89e3 TCP \u534a\u8fde\u63a5\u961f\u5217\u4e0e\u5168\u8fde\u63a5\u961f\u5217","text":"<p>Source</p> <p>\u8fd9\u7bc7\u6587\u6863\u7684\u539f\u59cb\u6765\u6e90\u4e3a https://www.51cto.com/article/687595.html \uff0c\u6211\u6309\u7167\u6587\u6863\u7684\u601d\u8def\uff0c\u81ea\u5df1\u8fdb\u884c\u4e86\u5b9e\u73b0\u5e76\u6839\u636e\u5b9e\u9645\u7684\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4e86\u8c03\u6574\u3002</p> <p>\u4ee5\u4e0b\u5b9e\u9a8c\u7684\u914d\u7f6e\u73af\u5883\u4e3a\uff1a</p> <ul> <li>\u670d\u52a1\u7aef: </li> <li>CPU:  11<sup>th</sup> Gen Intel(R) Core(TM) i5-1135G7 @ 2.40GHz</li> <li>OS: Ubuntu 22.10 x86_64</li> <li>IP: 192.168.31.76</li> <li>\u5ba2\u6237\u7aef\uff1a</li> <li>CPU:  3.4 GHz \u56db\u6838Intel Core i5</li> <li>OS: macOS Ventura 13.2.1</li> <li>IP: 192.168.31.205</li> </ul>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_1","title":"\u524d\u8a00","text":"<p>\u67d0\u6b21\u5927\u4fc3\u503c\u73ed ing\uff0c\u5bf9\u7cfb\u7edf\u7a33\u5b9a\u6027\u6709\u7740\u5145\u5206\u4fe1\u5fc3\u3001\u5fc3\u6001\u7a33\u5982\u8001\u72d7\u7684\u7b14\u8005\u7a81\u7136\u6536\u5230\u4e0a\u6e38\u53cd\u9988\u6709\u4e07\u5206\u51e0\u7684\u6982\u7387\u8bf7\u6c42\u6211\u4eec endpoint \u4f1a\u51fa\u73b0 Connection timeout \u3002\u6b64\u65f6\u7cfb\u7edf\u4fa7\u7684 apiserver \u96c6\u7fa4\u6c34\u4f4d\u5728 40%\uff0c\u79bb\u6781\u9650\u6c34\u4f4d\u8fd8\u6709\u7740\u5f88\u5927\u7684\u8ddd\u79bb\uff0c\u5f53\u65f6\u901a\u8fc7\u7d27\u6025\u6269\u5bb9 apiserver \u96c6\u7fa4\u540e\u9519\u8bef\u7387\u964d\u4e3a\u4e86 0\u3002\u4e8b\u540e\u8fdb\u884c\u4e86\u8be6\u7ec6\u7684\u95ee\u9898\u6392\u67e5\uff0c\u5b9a\u4f4d\u5206\u6790\u5230\u95ee\u9898\u6839\u56e0\u51fa\u73b0\u5728\u7cfb\u7edf\u8fde\u63a5\u961f\u5217\u88ab\u6253\u6ee1\u5bfc\u81f4\uff0c\u4e4b\u524d\u7b14\u8005\u5bf9 TCP \u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u4e0d\u592a\u4e86\u89e3\uff0c\u53ea\u4f9d\u7a00\u8bb0\u5f97 \u300aTCP/IP \u8be6\u89e3\u300b\u4e2d\u597d\u50cf\u6709\u597d\u50cf\u63d0\u5230\u8fc7\u8fd9\u4e24\u4e2a\u540d\u8bcd\u3002</p> <p>\u672c\u7bc7\u6587\u7ae0\u5c06\u7ed3\u5408\u7406\u8bba\u77e5\u8bc6\u3001\u5185\u6838\u4ee3\u7801\u3001\u64cd\u4f5c\u5b9e\u9a8c\u4e3a\u4f60\u5448\u73b0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li>\u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u4ecb\u7ecd</li> <li>\u5e38\u7528\u547d\u4ee4\u4ecb\u7ecd</li> <li>\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u6218 \u2014\u2014 \u6700\u5927\u957f\u5ea6\u63a7\u5236\u3001\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c\u3001\u5b9e\u9a8c\u7ed3\u679c\u5206\u6790</li> <li>\u534a\u8fde\u63a5\u961f\u5217\u5b9e\u6218 \u2014\u2014 \u6700\u5927\u957f\u5ea6\u63a7\u5236\u3001\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c\u3001\u5b9e\u9a8c\u7ed3\u679c\u5206\u6790</li> </ul>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_2","title":"\u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217","text":"<pre><code>sequenceDiagram\n    participant \u5ba2\u6237\u7aef\n    participant \u670d\u52a1\u5668\n    \u5ba2\u6237\u7aef-&gt;&gt;\u670d\u52a1\u5668: SYN(seq=x)\n    \u670d\u52a1\u5668-&gt;&gt;\u5ba2\u6237\u7aef: SYN+ACK(seq=y, ack=x+1)\n    \u5ba2\u6237\u7aef-&gt;&gt;\u670d\u52a1\u5668: ACK(ack=y+1)\n    loop \u6570\u636e\u4f20\u8f93\n        \u5ba2\u6237\u7aef-&gt;&gt;\u670d\u52a1\u5668: DATA(seq=x+n, ack=y+m)\n        \u670d\u52a1\u5668-&gt;&gt;\u5ba2\u6237\u7aef: DATA(seq=y+m, ack=x+n+1)\n    end</code></pre> <p>\u5728 TCP \u4e09\u6b21\u63e1\u624b\u7684\u8fc7\u7a0b\u4e2d\uff0cLinux \u5185\u6838\u4f1a\u7ef4\u62a4\u4e24\u4e2a\u961f\u5217\uff0c\u5206\u522b\u662f\uff1a</p> <ul> <li>\u534a\u8fde\u63a5\u961f\u5217 (SYN Queue)</li> <li>\u5168\u8fde\u63a5\u961f\u5217 (Accept Queue)</li> </ul> <p>\u6b63\u5e38\u7684 TCP \u4e09\u6b21\u63e1\u624b\u8fc7\u7a0b\uff1a</p> <p>1\u3001Client \u7aef\u5411 Server \u7aef\u53d1\u9001 SYN \u53d1\u8d77\u63e1\u624b\uff0cClient \u7aef\u8fdb\u5165 SYN_SENT \u72b6\u6001</p> <p>2\u3001Server \u7aef\u6536\u5230 Client \u7aef\u7684 SYN \u8bf7\u6c42\u540e\uff0cServer \u7aef\u8fdb\u5165 SYN_RECV \u72b6\u6001\uff0c\u6b64\u65f6\u5185\u6838\u4f1a\u5c06\u8fde\u63a5\u5b58\u50a8\u5230\u534a\u8fde\u63a5\u961f\u5217(SYN Queue)\uff0c\u5e76\u5411 Client \u7aef\u56de\u590d SYN+ACK</p> <p>3\u3001Client \u7aef\u6536\u5230 Server \u7aef\u7684 SYN+ACK \u540e\uff0cClient \u7aef\u56de\u590d ACK \u5e76\u8fdb\u5165 ESTABLISHED \u72b6\u6001</p> <p>4\u3001Server \u7aef\u6536\u5230 Client \u7aef\u7684 ACK \u540e\uff0c\u5185\u6838\u5c06\u8fde\u63a5\u4ece\u534a\u8fde\u63a5\u961f\u5217(SYN Queue)\u4e2d\u53d6\u51fa\uff0c\u6dfb\u52a0\u5230\u5168\u8fde\u63a5\u961f\u5217(Accept Queue)\uff0cServer \u7aef\u8fdb\u5165 ESTABLISHED \u72b6\u6001</p> <p>5\u3001Server \u7aef\u5e94\u7528\u8fdb\u7a0b\u8c03\u7528 accept \u51fd\u6570\u65f6\uff0c\u5c06\u8fde\u63a5\u4ece\u5168\u8fde\u63a5\u961f\u5217(Accept Queue)\u4e2d\u53d6\u51fa</p> <p>\u534a\u8fde\u63a5\u961f\u5217\u548c\u5168\u8fde\u63a5\u961f\u5217\u90fd\u6709\u957f\u5ea6\u5927\u5c0f\u9650\u5236\uff0c\u8d85\u8fc7\u9650\u5236\u65f6\u5185\u6838\u4f1a\u5c06\u8fde\u63a5 Drop \u4e22\u5f03\u6216\u8005\u8fd4\u56de RST \u5305\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_3","title":"\u76f8\u5173\u6307\u6807\u67e5\u770b","text":"","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#ss","title":"ss \u547d\u4ee4","text":"<p>\u901a\u8fc7 ss \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5230\u5168\u8fde\u63a5\u961f\u5217\u7684\u4fe1\u606f</p> <p>\u590d\u5236</p> <pre><code># -n \u4e0d\u89e3\u6790\u670d\u52a1\u540d\u79f0 \n# -t \u53ea\u663e\u793a tcp sockets \n# -l \u663e\u793a\u6b63\u5728\u76d1\u542c(LISTEN)\u7684 sockets \n\n$ ss -lnt \nState      Recv-Q Send-Q    Local Address:Port         Peer Address:Port \nLISTEN     0      128       [::]:2380                  [::]:* \nLISTEN     0      128       [::]:80                    [::]:* \nLISTEN     0      128       [::]:8080                  [::]:* \nLISTEN     0      128       [::]:8090                  [::]:* \n\n$ ss -nt \nState      Recv-Q Send-Q    Local Address:Port         Peer Address:Port \nESTAB      0      0         [::ffff:33.9.95.134]:80                   [::ffff:33.51.103.59]:47452 \nESTAB      0      536       [::ffff:33.9.95.134]:80                  [::ffff:33.43.108.144]:37656 \nESTAB      0      0         [::ffff:33.9.95.134]:80                   [::ffff:33.51.103.59]:38130 \nESTAB      0      536       [::ffff:33.9.95.134]:80                   [::ffff:33.51.103.59]:38280 \nESTAB      0      0         [::ffff:33.9.95.134]:80                   [:: \n</code></pre>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#listen-socket","title":"\u5bf9\u4e8e LISTEN \u72b6\u6001\u7684 socket","text":"<ul> <li>Recv-Q\uff1a\u5f53\u524d\u5168\u8fde\u63a5\u961f\u5217\u7684\u5927\u5c0f\uff0c\u5373\u5df2\u5b8c\u6210\u4e09\u6b21\u63e1\u624b\u7b49\u5f85\u5e94\u7528\u7a0b\u5e8f accept() \u7684 TCP \u94fe\u63a5</li> <li>Send-Q\uff1a\u5168\u8fde\u63a5\u961f\u5217\u7684\u6700\u5927\u957f\u5ea6\uff0c\u5373\u5168\u8fde\u63a5\u961f\u5217\u7684\u5927\u5c0f</li> </ul>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#listen-socket_1","title":"\u5bf9\u4e8e\u975e LISTEN \u72b6\u6001\u7684 socket","text":"<ul> <li>Recv-Q\uff1a\u5df2\u6536\u5230\u4f46\u672a\u88ab\u5e94\u7528\u7a0b\u5e8f\u8bfb\u53d6\u7684\u5b57\u8282\u6570</li> <li>Send-Q\uff1a\u5df2\u53d1\u9001\u4f46\u672a\u6536\u5230\u786e\u8ba4\u7684\u5b57\u8282\u6570</li> </ul> <p>\u76f8\u5173\u5185\u6838\u4ee3\u7801\uff1a</p> <pre><code>// https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_diag.c \nstatic void tcp_diag_get_info(struct sock *sk, struct inet_diag_msg *r, \n            void *_info) \n{ \n  struct tcp_info *info = _info; \n\n  if (inet_sk_state_load(sk) == TCP_LISTEN) { // socket \u72b6\u6001\u662f LISTEN \u65f6 \n    r-&gt;idiag_rqueue = READ_ONCE(sk-&gt;sk_ack_backlog);  // \u5f53\u524d\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f \n    r-&gt;idiag_wqueue = READ_ONCE(sk-&gt;sk_max_ack_backlog); // \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6 \n  } else if (sk-&gt;sk_type == SOCK_STREAM) {    // socket \u72b6\u6001\u4e0d\u662f LISTEN \u65f6 \n    const struct tcp_sock *tp = tcp_sk(sk); \n    r-&gt;idiag_rqueue = max_t(int, READ_ONCE(tp-&gt;rcv_nxt) - \n               READ_ONCE(tp-&gt;copied_seq), 0);    // \u5df2\u6536\u5230\u4f46\u672a\u88ab\u5e94\u7528\u7a0b\u5e8f\u8bfb\u53d6\u7684\u5b57\u8282\u6570 \n    r-&gt;idiag_wqueue = READ_ONCE(tp-&gt;write_seq) - tp-&gt;snd_una;   // \u5df2\u53d1\u9001\u4f46\u672a\u6536\u5230\u786e\u8ba4\u7684\u5b57\u8282\u6570 \n  } \n  if (info) \n    tcp_get_info(sk, info); \n} \n</code></pre> <p>netstat \u547d\u4ee4</p> <p>\u901a\u8fc7 netstat -s \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b TCP \u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u7684\u6ea2\u51fa\u60c5\u51b5</p> <p>\u590d\u5236</p> <pre><code>$ netstat -s | grep -i \"listen\" \n    189088 times the listen queue of a socket overflowed \n    30140232 SYNs to LISTEN sockets dropped \n</code></pre> <p>\u4e0a\u9762\u8f93\u51fa\u7684\u6570\u503c\u662f\u7d2f\u8ba1\u503c\uff0c\u5206\u522b\u8868\u793a\u6709\u591a\u5c11 TCP socket \u94fe\u63a5\u56e0\u4e3a\u5168\u8fde\u63a5\u961f\u5217\u3001\u534a\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\u800c\u88ab\u4e22\u5f03</p> <ul> <li><code>189088 times the listen queue of a socket overflowed</code> \u4ee3\u8868\u6709 189088 \u6b21\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa</li> <li><code>30140232 SYNs to LISTEN sockets dropped</code> \u4ee3\u8868\u6709 30140232 \u6b21\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa</li> </ul> <p>\u5728\u6392\u67e5\u7ebf\u4e0a\u95ee\u9898\u65f6\uff0c\u5982\u679c\u4e00\u6bb5\u65f6\u95f4\u5185\u76f8\u5173\u6570\u503c\u4e00\u76f4\u5728\u4e0a\u5347\uff0c\u5219\u8868\u660e\u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u6709\u6ea2\u51fa\u60c5\u51b5</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_4","title":"\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u6218","text":"","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_5","title":"\u6700\u5927\u957f\u5ea6\u63a7\u5236","text":"<p>TCP \u5168\u8fde\u63a5\u961f\u5217\u7684\u6700\u5927\u957f\u5ea6\u7531 \\(min(somaxconn, backlog)\\) \u63a7\u5236\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>somaxconn \u662f Linux \u5185\u6838\u53c2\u6570\uff0c\u7531 <code>/proc/sys/net/core/somaxconn</code> \u6307\u5b9a</li> <li>backlog \u662f TCP \u534f\u8bae\u4e2d listen \u51fd\u6570\u7684\u53c2\u6570\u4e4b\u4e00\uff0c\u5373 <code>int listen(int sockfd, int backlog)</code> \u51fd\u6570\u4e2d\u7684 backlog \u5927\u5c0f\u3002\u5728 Golang \u4e2d\uff0clisten \u7684 backlog \u53c2\u6570\u4f7f\u7528\u7684\u662f <code>/proc/sys/net/core/somaxconn</code> \u6587\u4ef6\u4e2d\u7684\u503c\u3002</li> </ul> <p>\u76f8\u5173\u5185\u6838\u4ee3\u7801\uff1a</p> <pre><code>// https://github.com/torvalds/linux/blob/master/net/socket.c \n\n/* \n *  Perform a listen. Basically, we allow the protocol to do anything \n *  necessary for a listen, and if that works, we mark the socket as \n *  ready for listening. \n */ \nint __sys_listen(int fd, int backlog) \n{ \n  struct socket *sock; \n  int err, fput_needed; \n  int somaxconn; \n\n  sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed); \n  if (sock) { \n    somaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn;  // /proc/sys/net/core/somaxconn \n    if ((unsigned int)backlog &gt; somaxconn) \n      backlog = somaxconn;   // TCP \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6 min(somaxconn, backlog) \n\n    err = security_socket_listen(sock, backlog); \n    if (!err) \n      err = sock-&gt;ops-&gt;listen(sock, backlog); \n\n    fput_light(sock-&gt;file, fput_needed); \n  } \n  return err; \n} \n</code></pre>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_6","title":"\u5b9e\u9a8c","text":"<p>\u670d\u52a1\u7aef server \u4ee3\u7801</p> <pre><code>// server.go\n// go build server.go\n// ./server\npackage main \n\nimport ( \n  \"log\" \n  \"net\" \n  \"time\" \n) \n\nfunc main() { \n  l, err := net.Listen(\"tcp\", \":8888\") \n  if err != nil { \n    log.Printf(\"failed to listen due to %v\", err) \n  } \n  defer l.Close() \n  log.Println(\"listen :8888 success\") \n\n  for { \n    time.Sleep(time.Second * 100) \n  } \n} \n</code></pre> <p>\u5728\u6d4b\u8bd5\u73af\u5883\u67e5\u770b somaxconn \u7684\u503c\u4e3a 128</p> <pre><code>$ cat /proc/sys/net/core/somaxconn \n128 \n</code></pre> <p>\u542f\u52a8\u670d\u52a1\u7aef\uff0c\u901a\u8fc7 <code>ss -lnt | grep :8888</code> \u786e\u8ba4\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f</p> <pre><code>LISTEN     0      128       [::]:8888                  [::]:* \n</code></pre> <p>\u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u4e3a 128</p> <p>\u73b0\u5728\u66f4\u65b0 somaxconn \u503c\u4e3a 1024\uff0c\u518d\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u7aef\u3002</p> <ol> <li>\u66f4\u65b0 <code>/etc/sysctl.conf</code> \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u4e3a\u5185\u6838\u53c2\u6570\u914d\u7f6e\u6587\u4ef6</li> <li>\u65b0\u589e\u4e00\u884c <code>net.core.somaxconn=1024</code></li> <li> <p>\u6267\u884c <code>sysctl -p</code> \u4f7f\u914d\u7f6e\u751f\u6548   <pre><code>$ sudo sysctl -p \nnet.core.somaxconn = 1024 \n</code></pre></p> </li> <li> <p>\u68c0\u67e5 <code>/proc/sys/net/core/somaxconn</code> \u6587\u4ef6\uff0c\u786e\u8ba4 somaxconn \u4e3a\u66f4\u65b0\u540e\u7684 1024   <pre><code>$ cat /proc/sys/net/core/somaxconn \n1024 \n</code></pre></p> </li> </ol> <p>\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u7aef\uff0c \u901a\u8fc7 <code>ss -lnt | grep :8888</code> \u786e\u8ba4\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f</p> <pre><code>$ ss -lnt | grep 8888 \nLISTEN     0      1024      [::]:8888                  [::]:* \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u73b0\u5728\u5168\u94fe\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u4e3a 1024\uff0c\u6210\u529f\u66f4\u65b0\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_7","title":"\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa","text":"<p>\u4e0b\u9762\u6765\u9a8c\u8bc1\u4e0b\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u4f1a\u53d1\u751f\u4ec0\u4e48\u60c5\u51b5\uff0c\u53ef\u4ee5\u901a\u8fc7\u8ba9\u670d\u52a1\u7aef\u5e94\u7528\u53ea\u8d1f\u8d23 Listen \u5bf9\u5e94\u7aef\u53e3\u800c\u4e0d\u6267\u884c accept() TCP \u8fde\u63a5\uff0c\u4f7f TCP \u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u3002</p> <p>\u5b9e\u9a8c\u7269\u6599</p> <p>\u670d\u52a1\u7aef server \u4ee3\u7801</p> <pre><code>// server \u7aef\u76d1\u542c 8888 tcp \u7aef\u53e3 \n\npackage main \n\nimport ( \n  \"log\" \n  \"net\" \n  \"time\" \n) \n\nfunc main() { \n  l, err := net.Listen(\"tcp\", \":8888\") \n  if err != nil { \n    log.Printf(\"failed to listen due to %v\", err) \n  } \n  defer l.Close() \n  log.Println(\"listen :8888 success\") \n\n  for { \n    time.Sleep(time.Second * 100) \n  } \n} \n</code></pre> <p>\u5ba2\u6237\u7aef client \u4ee3\u7801</p> <pre><code>// client \u7aef\u5e76\u53d1\u8bf7\u6c42 10 \u6b21 server \u7aef\uff0c\u6210\u529f\u5efa\u7acb tcp \u8fde\u63a5\u540e\u5411 server \u7aef\u53d1\u9001\u6570\u636e \npackage main \n\nimport ( \n  \"context\" \n  \"log\" \n  \"net\" \n  \"os\" \n  \"os/signal\" \n  \"sync\" \n  \"syscall\" \n  \"time\" \n) \n\nvar wg sync.WaitGroup \n\nfunc establishConn(ctx context.Context, i int) { \n  defer wg.Done() \n  conn, err := net.DialTimeout(\"tcp\", \":8888\", time.Second*5) \n  if err != nil { \n    log.Printf(\"%d, dial error: %v\", i, err) \n    return \n  } \n  log.Printf(\"%d, dial success\", i) \n  _, err = conn.Write([]byte(\"hello world\")) \n  if err != nil { \n    log.Printf(\"%d, send error: %v\", i, err) \n    return \n  } \n  select { \n  case &lt;-ctx.Done(): \n    log.Printf(\"%d, dail close\", i) \n  } \n} \n\nfunc main() { \n  ctx, cancel := context.WithCancel(context.Background()) \n  for i := 0; i &lt; 10; i++ { \n    wg.Add(1) \n    go establishConn(ctx, i) \n  } \n\n  go func() { \n    sc := make(chan os.Signal, 1) \n    signal.Notify(sc, syscall.SIGINT) \n    select { \n    case &lt;-sc: \n      cancel() \n    } \n  }() \n\n  wg.Wait() \n  log.Printf(\"client exit\") \n} \n</code></pre> <p>\u4e3a\u4e86\u65b9\u4fbf\u5b9e\u9a8c\uff0c\u5c06 somaxconn \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u66f4\u65b0\u4e3a 5\uff1a</p> <ol> <li> <p>\u66f4\u65b0 <code>/etc/sysctl.conf</code>\u6587\u4ef6\uff0c\u5c06 <code>net.core.somaxconn</code> \u66f4\u65b0\u4e3a 5</p> </li> <li> <p>\u6267\u884c sysctl -p \u4f7f\u914d\u7f6e\u751f\u6548</p> </li> </ol> <pre><code>$ sudo sysctl -p \nnet.core.somaxconn = 5 \n</code></pre> <p>\u5b9e\u9a8c\u7ed3\u679c</p> <p>\u5ba2\u6237\u7aef\u65e5\u5fd7\u8f93\u51fa</p> <pre><code>2021/10/11 17:24:48 8, dial success \n2021/10/11 17:24:48 3, dial success \n2021/10/11 17:24:48 4, dial success \n2021/10/11 17:24:48 6, dial success \n2021/10/11 17:24:48 5, dial success \n2021/10/11 17:24:48 2, dial success \n2021/10/11 17:24:48 1, dial success \n2021/10/11 17:24:48 0, dial success \n2021/10/11 17:24:48 7, dial success \n2021/10/11 17:24:53 9, dial error: dial tcp 33.9.192.157:8888: i/o timeout \n</code></pre> <p>\u5ba2\u6237\u7aef socket \u60c5\u51b5</p> <pre><code>tcp        0      0 33.9.192.155:40372      33.9.192.157:8888       ESTABLISHED \ntcp        0      0 33.9.192.155:40376      33.9.192.157:8888       ESTABLISHED \ntcp        0      0 33.9.192.155:40370      33.9.192.157:8888       ESTABLISHED \ntcp        0      0 33.9.192.155:40366      33.9.192.157:8888       ESTABLISHED \ntcp        0      0 33.9.192.155:40374      33.9.192.157:8888       ESTABLISHED \ntcp        0      0 33.9.192.155:40368      33.9.192.157:8888       ESTABLISHED \n</code></pre> <p>\u670d\u52a1\u7aef socket \u60c5\u51b5</p> <pre><code>tcp6      11      0 33.9.192.157:8888       33.9.192.155:40376      ESTABLISHED \ntcp6      11      0 33.9.192.157:8888       33.9.192.155:40370      ESTABLISHED \ntcp6      11      0 33.9.192.157:8888       33.9.192.155:40368      ESTABLISHED \ntcp6      11      0 33.9.192.157:8888       33.9.192.155:40372      ESTABLISHED \ntcp6      11      0 33.9.192.157:8888       33.9.192.155:40374      ESTABLISHED \ntcp6      11      0 33.9.192.157:8888       33.9.192.155:40366      ESTABLISHED \n\ntcp    LISTEN     6      5      [::]:8888               [::]:*                   users:((\"main\",pid=84244,fd=3)) \n</code></pre> <p>\u6293\u5305\u7ed3\u679c</p> <p>\u5bf9\u5ba2\u6237\u7aef\u3001\u670d\u52a1\u7aef\u6293\u5305\u540e\uff0c\u53d1\u73b0\u51fa\u73b0\u4e86\u4e09\u79cd\u60c5\u51b5\uff0c\u5206\u522b\u662f\uff1a</p> <ul> <li>client \u6210\u529f\u4e0e server \u7aef\u5efa\u7acb tcp socket \u8fde\u63a5\uff0c\u53d1\u9001\u6570\u636e\u6210\u529f</li> <li>client \u8ba4\u4e3a\u6210\u529f\u4e0e server \u7aef\u5efa\u7acb tcp socket \u8fde\u63a5\uff0c\u53d1\u9001\u6570\u636e\u5931\u8d25\uff0c\u4e00\u76f4\u5728 RETRY;server \u7aef\u8ba4\u4e3a tcp \u8fde\u63a5\u672a\u5efa\u7acb\uff0c\u4e00\u76f4\u5728\u53d1\u9001 SYN+ACK</li> <li>client \u5411 server \u53d1\u9001 SYN \u672a\u5f97\u5230\u54cd\u5e94\uff0c\u4e00\u76f4\u5728 RETRY</li> </ul> <p>\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u9a8c\u7ed3\u679c\u5206\u6790</p> <p>\u4e0a\u8ff0\u5b9e\u9a8c\u7ed3\u679c\u51fa\u73b0\u4e86\u4e09\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u5206\u522b\u5bf9\u6293\u5305\u5185\u5bb9\u8fdb\u884c\u5206\u6790</p> <p>\u6293\u5305\u7a0b\u5e8f\u4f7f\u7528 tshark\uff0c\u6293\u5305\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ sudo  tshark -Eheader=y -l   -f \"tcp port 8888\" -i any\n</code></pre> <p>\u60c5\u51b5\u4e00\uff1aClient \u6210\u529f\u4e0e Server \u7aef\u5efa\u7acb tcp socket \u94fe\u63a5\uff0c\u53d1\u9001\u6570\u636e\u6210\u529f</p> No. Source Destination Protocol length info 1 192.168.31.205 192.168.31.76 TCP 80 61170 \u2192 8888 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=1184189553 TSecr=0 SACK_PERM=1 9 192.168.31.76 192.168.31.205 TCP 76 8888 \u2192 61170 [SYN, ACK] Seq=0 Ack=1 Win=65160 Len=0 MSS=1460 SACK_PERM=1 TSval=648136459 TSecr=1184189553 WS=128 29 192.168.31.205 192.168.31.76 TCP 68 61170 \u2192 8888 [ACK] Seq=1 Ack=1 Win=131712 Len=0 TSval=1184189706 TSecr=648136459 32 192.168.31.205 192.168.31.76 TCP 79 61170 \u2192 8888 [PSH, ACK] Seq=1 Ack=1 Win=131712 Len=11 TSval=1184189706 TSecr=648136459 38 192.168.31.76 192.168.31.205 TCP 68 8888 \u2192 61170 [ACK] Seq=1 Ack=12 Win=65152 Len=0 TSval=648136464 TSecr=1184189706 <p>\u4e0a\u9762\u7684\u8868\u683c\u662f\u901a\u8fc7\u6293\u5305\u6570\u636e\u540e\u8fdb\u884c\u4e86\u6574\u7406\uff0c<code>No.</code> \u5217\u662f\u6293\u5305\u4e2d\u5b9e\u9645\u7684\u5e8f\u53f7\uff0c\u6211\u8fd9\u91cc\u628a\u4e00\u4e2a\u8fde\u63a5\u6240\u6d89\u53ca\u7684\u5305\u6574\u7406\u5728\u4e00\u5757\uff0c\u65b9\u4fbf\u5206\u6790\u3002</p> <p>\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u8bf7\u6c42\uff1a</p> <ul> <li>Client \u7aef(192.168.31.205)  \u5411 Server \u7aef(192.168.31.76) \u53d1\u9001 SYN \u53d1\u8d77\u63e1\u624b</li> <li>Server \u7aef\u6536\u5230 Client \u7aef SYN \u540e\uff0c\u5411 Client \u7aef\u56de\u590d <code>SYN+ACK</code>\uff0csocket \u8fde\u63a5\u5b58\u50a8\u5230\u534a\u8fde\u63a5\u961f\u5217(SYN Queue)</li> <li>Client \u7aef\u6536\u5230 Server \u7aef <code>SYN+ACK</code> \u540e\uff0c\u5411 Server \u7aef\u56de\u590d ACK\uff0cClient \u7aef\u8fdb\u5165 ESTABLISHED \u72b6\u6001</li> <li>Server \u7aef\u6536\u5230 Client \u7aef ACK \u540e\uff0c\u8fdb\u5165 ESTABLISHED \u72b6\u6001\uff0csocket \u8fde\u63a5\u5b58\u50a8\u5230\u5168\u8fde\u63a5\u961f\u5217(Accept Queue)</li> <li>Client \u7aef\u5411 Server \u7aef\u53d1\u9001\u6570\u636e [PSH, ACK]\uff0cServer \u7aef\u786e\u8ba4\u63a5\u6536\u5230\u6570\u636e [ACK]</li> </ul> <p>\u8fd9\u79cd\u60c5\u51b5\u5c31\u662f\u6b63\u5e38\u7684\u8bf7\u6c42\uff0c\u5373\u5168\u8fde\u63a5\u961f\u5217\u3001\u534a\u8fde\u63a5\u961f\u5217\u672a\u6ee1\uff0cclient \u6210\u529f\u4e0e server \u5efa\u7acb\u4e86 tcp \u94fe\u63a5\uff0c\u5e76\u6210\u529f\u53d1\u9001\u6570\u636e\u3002</p> <p>\u60c5\u51b5\u4e8c\uff1aClient \u8ba4\u4e3a\u6210\u529f\u4e0e Server \u7aef\u5efa\u7acb tcp socket \u8fde\u63a5\uff0c\u540e\u7eed\u53d1\u9001\u6570\u636e\u5931\u8d25\uff0c\u6301\u7eed RETRY;Server \u7aef\u8ba4\u4e3a TCP \u8fde\u63a5\u672a\u5efa\u7acb\uff0c\u4e00\u76f4\u5728\u53d1\u9001SYN+ACK</p> No. Source Destination info 8 192.168.31.205 192.168.31.76 61177 \u2192 8888 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=4039865585 TSecr=0 SACK_PERM=1 11 192.168.31.76 192.168.31.205 8888 \u2192 61177 [SYN, ACK] Seq=0 Ack=1 Win=65160 Len=0 MSS=1460 SACK_PERM=1 TSval=648136459 TSecr=4039865585 WS=128 39 192.168.31.205 192.168.31.76 61177 \u2192 8888 [ACK] Seq=1 Ack=1 Win=131712 Len=0 TSval=4039865738 TSecr=648136459 40 192.168.31.205 192.168.31.76 61177 \u2192 8888 [PSH, ACK] Seq=1 Ack=1 Win=131712 Len=11 TSval=4039865738 TSecr=648136459 47 192.168.31.205 192.168.31.76 [TCP Retransmission] 61177 \u2192 8888 [PSH, ACK] Seq=1 Ack=1 Win=131712 Len=11 TSval=4039865969 TSecr=648136459 51 192.168.31.205 192.168.31.76 [TCP Retransmission] 61177 \u2192 8888 [PSH, ACK] Seq=1 Ack=1 Win=131712 Len=11 TSval=4039866438 TSecr=648136459 55 192.168.31.76 192.168.31.205 [TCP Retransmission] 8888 \u2192 61177 [SYN, ACK] Seq=0 Ack=1 Win=65160 Len=0 MSS=1460 SACK_PERM=1 TSval=648137479 TSecr=4039866438 WS=128 63 192.168.31.205 192.168.31.76 [TCP Retransmission] 61177 \u2192 8888 [PSH, ACK] Seq=1 Ack=1 Win=131712 Len=11 TSval=4039868453 TSecr=648136459 65 192.168.31.76 192.168.31.205 [TCP Retransmission] 8888 \u2192 61177 [SYN, ACK] Seq=0 Ack=1 Win=65160 Len=0 MSS=1460 SACK_PERM=1 TSval=648139495 TSecr=4039868453 WS=128 <p>\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u8bf7\u6c42\uff1a</p> <ul> <li>Client \u7aef\u5411 Server \u7aef\u53d1\u9001 SYN \u53d1\u8d77\u63e1\u624b</li> <li>Server \u7aef\u6536\u5230 Client \u7aef SYN \u540e\uff0c\u5411 Client \u7aef\u56de\u590d <code>SYN+ACK</code>\uff0csocket \u8fde\u63a5\u5b58\u50a8\u5230\u534a\u8fde\u63a5\u961f\u5217(SYN Queue)</li> <li>Client \u7aef\u6536\u5230 Server \u7aef <code>SYN+ACK</code> \u540e\uff0c\u5411 Server \u7aef\u56de\u590d ACK\uff0cClient \u7aef\u8fdb\u5165 ESTABLISHED\u72b6\u6001(\u91cd\u8981\uff1a\u6b64\u65f6\u4ec5\u4ec5\u662f Client \u7aef\u8ba4\u4e3a tcp \u8fde\u63a5\u5efa\u7acb\u6210\u529f)</li> <li>\u7531\u4e8e Client \u7aef\u8ba4\u4e3a TCP \u8fde\u63a5\u5df2\u7ecf\u5efa\u7acb\u5b8c\u6210\uff0c\u6240\u4ee5\u5411 Server \u7aef\u53d1\u9001\u6570\u636e <code>[PSH\uff0cACK]</code>\uff0c\u4f46\u662f\u4e00\u76f4\u672a\u6536\u5230 Server \u7aef\u7684\u786e\u8ba4 ACK\uff0c\u6240\u4ee5\u4e00\u76f4\u5728 RETRY</li> <li>Server \u7aef\u4e00\u76f4\u5728 RETRY \u53d1\u9001 <code>SYN+ACK</code></li> </ul> <p>\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u4e0a\u8ff0\u60c5\u51b5\uff1f</p> <p>Server \u7aef\u4e3a\u4ec0\u4e48\u4e00\u76f4\u5728 RETRY \u53d1\u9001 <code>SYN+ACK</code>?</p> <p>Server \u7aef\u4e0d\u662f\u5df2\u7ecf\u6536\u5230\u4e86 Client \u7aef\u7684 ACK \u786e\u8ba4\u4e86\u5417?</p> <p>\u4e0a\u8ff0\u60c5\u51b5\u662f\u7531\u4e8e Server \u7aef socket \u8fde\u63a5\u8fdb\u5165\u4e86\u534a\u8fde\u63a5\u961f\u5217\uff0c\u5728\u6536\u5230 Client \u7aef ACK \u540e\uff0c\u672c\u5e94\u5c06 socket \u8fde\u63a5\u5b58\u50a8\u5230\u5168\u8fde\u63a5\u961f\u5217\uff0c\u4f46\u662f\u5168\u8fde\u63a5\u961f\u5217\u5df2\u6ee1\uff0c\u6240\u4ee5 Server \u7aef DROP \u4e86\u8be5 ACK \u8bf7\u6c42\u3002</p> <p>\u4e4b\u6240\u4ee5 Server \u7aef\u4e00\u76f4\u5728 RETRY \u53d1\u9001 <code>SYN+ACK</code>\uff0c\u662f\u56e0\u4e3a DROP \u4e86 client \u7aef\u7684 ACK \u8bf7\u6c42\uff0c\u6240\u4ee5 socket \u8fde\u63a5\u4ecd\u65e7\u5728\u534a\u8fde\u63a5\u961f\u5217\u4e2d\uff0c\u7b49\u5f85 Client \u7aef\u56de\u590d ACK\u3002</p> <p>\u5168\u8fde\u63a5\u961f\u5217\u6ee1 DROP \u8bf7\u6c42\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>/proc/sys/net/ipv4/tcp_abort_on_overflow</code> \u4f7f Server \u7aef\u5728\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u65f6\uff0c\u5411 Client \u7aef\u53d1\u9001 RST \u62a5\u6587\u3002</p> <p><code>tcp_abort_on_overflow</code> \u6709\u4e24\u79cd\u53ef\u9009\u503c\uff1a</p> <ul> <li>0\uff1a\u5982\u679c\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\uff0cServer \u7aef DROP Client \u7aef\u56de\u590d\u7684 ACK</li> <li>1\uff1a\u5982\u679c\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\uff0cServer \u7aef\u5411 Client \u7aef\u53d1\u9001 RST \u62a5\u6587\uff0c\u7ec8\u6b62 TCP socket \u94fe\u63a5 </li> </ul> <p>\u4e3a\u4ec0\u4e48\u5b9e\u9a8c\u7ed3\u679c\u4e2d\u5f53\u524d\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f &gt; \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u914d\u7f6e?</p> <p>\u4e0a\u8ff0\u7ed3\u679c\u4e2d\u53ef\u4ee5\u770b\u5230 Listen \u72b6\u6001\u7684 socket \u94fe\u63a5\uff1a</p> <ul> <li>Recv-Q \u5f53\u524d\u5168\u8fde\u63a5\u961f\u5217\u7684\u5927\u5c0f\u662f 6</li> <li>Send-Q \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u662f 5</li> </ul> <pre><code>$ ss -ln | egrep '(State|:8888)'\nState      Recv-Q Send-Q    Local Address:Port         Peer Address:Port \nLISTEN     6      5         [::]:8888                  [::]:* \n</code></pre> <p>\u4e3a\u4ec0\u4e48\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f &gt; \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u914d\u7f6e\u5462?</p> <p>\u7ecf\u8fc7\u591a\u6b21\u5b9e\u9a8c\u53d1\u73b0\uff0c\u80fd\u591f\u8fdb\u5165\u5168\u8fde\u63a5\u961f\u5217\u7684 Socket \u6700\u5927\u6570\u91cf\u59cb\u7ec8\u6bd4\u914d\u7f6e\u7684\u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6 + 1\u3002</p> <p>\u7ed3\u5408\u5176\u4ed6\u6587\u7ae0\u4ee5\u53ca\u5185\u6838\u4ee3\u7801\uff0c\u53d1\u73b0\u5185\u6838\u5728\u5224\u65ad\u5168\u8fde\u63a5\u961f\u5217\u662f\u5426\u6ee1\u7684\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u7684\u662f <code>&gt;</code> \u800c\u975e <code>&gt;=</code> \u3002</p> <p>\u76f8\u5173\u5185\u6838\u4ee3\u7801\uff1a</p> <pre><code>/* Note: If you think the test should be: \n *  return READ_ONCE(sk-&gt;sk_ack_backlog) &gt;= READ_ONCE(sk-&gt;sk_max_ack_backlog); \n * Then please take a look at commit 64a146513f8f (\"[NET]: Revert incorrect accept queue backlog changes.\") \n */ \nstatic inline bool sk_acceptq_is_full(const struct sock *sk) \n{ \n  return READ_ONCE(sk-&gt;sk_ack_backlog) &gt; READ_ONCE(sk-&gt;sk_max_ack_backlog); \n} \n</code></pre> <p>\u60c5\u51b5\u4e09\uff1aClient \u5411 Server \u53d1\u9001 SYN \u672a\u5f97\u5230\u76f8\u5e94\uff0c\u4e00\u76f4\u5728 RETRY</p> <p>\u56fe\u7247\u4e0a\u56fe\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u8bf7\u6c42\uff1a</p> <ul> <li>Client \u7aef\u5411 Server \u7aef\u53d1\u9001 SYN \u53d1\u8d77\u63e1\u624b\uff0c\u672a\u5f97\u5230 Server \u56de\u5e94\uff0c\u4e00\u76f4\u5728 RETRY</li> </ul> <p>(\u8fd9\u79cd\u60c5\u51b5\u6d89\u53ca\u5230\u534a\u8fde\u63a5\u961f\u5217\uff0c\u8fd9\u91cc\u5148\u7ed9\u4e0a\u8ff0\u60c5\u51b5\u53d1\u751f\u7684\u539f\u56e0\u7ed3\u8bba\uff0c\u5177\u4f53\u5185\u5bb9\u5c06\u5728\u4e0b\u6587\u534a\u8fde\u63a5\u961f\u5217\u4e2d\u5c55\u5f00\u3002)</p> <p>\u53d1\u751f\u4e0a\u8ff0\u60c5\u51b5\u7684\u539f\u56e0\u7531\u4ee5\u4e0b\u4e24\u65b9\u9762\u5bfc\u81f4\uff1a</p> <p>1\u3001\u5f00\u542f\u4e86 <code>/proc/sys/net/ipv4/tcp_syncookies</code> \u529f\u80fd</p> <p>2\u3001\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_8","title":"\u534a\u8fde\u63a5\u961f\u5217\u5b9e\u6218","text":"","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_9","title":"\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u63a7\u5236","text":"<p>\u7ffb\u9605\u4e86\u5f88\u591a\u535a\u6587\uff0c\u67e5\u627e\u5173\u4e8e\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u63a7\u5236\u7684\u76f8\u5173\u5185\u5bb9\uff0c\u5927\u591a\u542b\u7cca\u5176\u8f9e\u6216\u4e0d\u51c6\u786e\uff0c\u7ecf\u8fc7\u4e0d\u61c8\u52aa\u529b\uff0c\u6700\u7ec8\u627e\u5230\u4e86\u6bd4\u8f83\u786e\u5207\u7684\u5185\u5bb9(\u76f8\u5173\u535a\u6587\u94fe\u63a5\u5728\u9644\u5f55\u4e2d)\u3002</p> <p>\u5f88\u591a\u535a\u6587\u4e2d\u8bf4\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u7531 <code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code> \u53c2\u6570\u6307\u5b9a\uff0c\u5b9e\u9645\u4e0a\u53ea\u6709\u5728 linux \u5185\u6838\u7248\u672c\u5c0f\u4e8e <code>2.6.20</code> \u65f6\uff0c\u534a\u8fde\u63a5\u961f\u5217\u624d\u7b49\u4e8e backlog \u7684\u5927\u5c0f\u3002</p> <p>\u8fd9\u5757\u7684\u6e90\u7801\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u91cc\u7ed9\u4e00\u4e0b\u5927\u4f53\u7684\u8ba1\u7b97\u65b9\u5f0f\uff0c\u8be6\u7ec6\u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003\u9644\u5f55\u4e2d\u7684\u76f8\u5173\u535a\u6587\u3002\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u7684\u8ba1\u7b97\u8fc7\u7a0b\uff1a</p> \\[ \\begin{align} qlen &amp;= max(min(somaxconn, backlog, sysctl\\_max\\_syn\\_backlog), 8)  \\\\  &amp;// roundup\\_pow\\_of\\_two: \u5c06\u53c2\u6570\u5411\u4e0a\u53d6\u6574\u5230\u6700\u5c0f\u7684 2^n\uff0c\u6ce8\u610f\u8fd9\u91cc\u5b58\u5728\u4e00\u4e2a +1  \\\\ qlen &amp;= roundup\\_pow\\_of\\_two(qlen + 1)  \\\\  max\\_qlen\\_log &amp;= max(3, log_2(qlen))  \\\\ max\\_queue\\_length &amp;= 2^{max\\_qlen\\_log} \\\\ \\end{align} \\] <p>\u53ef\u4ee5\u770b\u5230\uff0c\u534a\u8fde\u63a5\u961f\u5217\u7684\u957f\u5ea6\u7531\u4e09\u4e2a\u53c2\u6570\u6307\u5b9a\uff1a</p> <ul> <li>\u8c03\u7528 listen \u65f6\uff0c\u4f20\u5165\u7684 backlog</li> <li><code>/proc/sys/net/core/somaxconn</code> \u9ed8\u8ba4\u503c\u4e3a 128</li> <li><code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code> \u9ed8\u8ba4\u503c\u4e3a 1024</li> </ul> <p>\u6211\u4eec\u5047\u8bbe listen \u4f20\u5165\u7684 <code>backlog = 128</code> (Golang \u4e2d\u8c03\u7528 listen \u65f6\u4f20\u9012\u7684 backlog \u53c2\u6570\u4f7f\u7528\u7684\u662f <code>/proc/sys/net/core/somaxconn</code>)\uff0c\u5176\u4ed6\u914d\u7f6e\u91c7\u7528\u9ed8\u8ba4\u503c\uff0c\u6765\u8ba1\u7b97\u4e0b\u534a\u8fde\u63a5\u961f\u5217\u7684\u6700\u5927\u957f\u5ea6</p> \\[ \\begin{align} qlen &amp;= max(min(somaxconn, backlog, sysctl\\_max\\_syn\\_backlog), 8) \\\\          &amp;= max(min(128, 128, 1024), 8) \\\\          &amp;= 128 \\\\  qlen &amp;= roundup\\_pow\\_of\\_two(qlen + 1) \\\\             &amp;= roundup\\_pow\\_of\\_two(128 + 1) \\\\          &amp;= 256 \\\\  max\\_qlen\\_log &amp;= max(3, log_2{qlen}) \\\\   &amp;= max(3, 8) \\\\   &amp; = 8 \\\\  max\\_queue\\_length &amp;= 2^{max\\_qlen\\_log} \\\\    &amp;= 2^8 \\\\    &amp;= 256 \\\\  \\end{align} \\] <p>\u53ef\u4ee5\u5f97\u5230\u534a\u961f\u5217\u5927\u5c0f\u662f 256\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#drop-syn","title":"\u5224\u65ad\u662f\u5426 Drop SYN \u8bf7\u6c42","text":"<p>\u5f53 Client \u7aef\u5411 Server \u7aef\u53d1\u9001 SYN \u62a5\u6587\u540e\uff0cServer \u7aef\u4f1a\u5c06\u8be5 socket \u8fde\u63a5\u5b58\u50a8\u5230\u534a\u8fde\u63a5\u961f\u5217(SYN Queue)\uff0c\u5982\u679c Server \u7aef\u5224\u65ad\u534a\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\u5219\u4f1a\u5c06\u8fde\u63a5 Drop \u4e22\u5f03\u3002</p> <p>\u90a3\u4e48 Server \u7aef\u662f\u5982\u4f55\u5224\u65ad\u534a\u8fde\u63a5\u961f\u5217\u662f\u5426\u6ee1\u7684\u5462?\u9664\u4e86\u4e0a\u9762\u4e00\u5c0f\u8282\u63d0\u5230\u7684\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u63a7\u5236\u5916\uff0c\u8fd8\u548c <code>/proc/sys/net/ipv4/tcp_syncookies</code> \u53c2\u6570\u6709\u5173\u3002(<code>tcp_syncookies</code> \u7684\u4f5c\u7528\u662f\u4e3a\u4e86\u9632\u6b62 SYN Flood \u653b\u51fb\u7684\uff0c\u4e0b\u6587\u4f1a\u7ed9\u51fa\u76f8\u5173\u94fe\u63a5\u4ecb\u7ecd)</p> <p>\u6d41\u7a0b\u56fe</p> <p>\u5224\u65ad\u662f\u5426 Drop SYN \u8bf7\u6c42\u7684\u6d41\u7a0b\u56fe\uff1a</p> <pre><code>graph TD\n%%cur_qlen \u5f53\u524d\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6, max_qlen \u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6%%\nc1{\"cur_qlen &gt;= max_qlen\"}\nc2{\"\u662f\u5426\u5f00\u542f\u4e86&lt;br/&gt;tcp_syncookies\"}\nc3{\"\u5f53\u524d\u5168\u961f\u5217\u662f\u5426\u5df2\u6ee1\"}\nc4{\"\u534a\u8fde\u63a5\u961f\u5217\u6ca1\u6709\u91cd\u4f20&lt;br/&gt;SYN+ACK\u7684\u8fde\u63a5\u8bf7\u6c42&gt;1\"}\nc5{\"\u662f\u5426\u5f00\u542f\u4e86&lt;br/&gt;tcp_syncookies\"}\nc6{\"(tcp_max_syn_backlog - cur_qlen ) &lt;br/&gt;&lt; (tcp_max_sync_backlog)&gt;&gt;2\"}\ndrop(\"Drop SYN \u8bf7\u6c42\")\nack(\"\u54cd\u5e94 SYN+ACK\")\n\nc1 -- \u662f --&gt; c2\nc1 -- \u5426 --&gt; c3\nc3 -- \u662f --&gt; c4\nc3 -- \u5426 --&gt; c5\nc5 -- \u662f ---&gt;ack\nc5 -- \u5426 --&gt; c6\n\nc2 -- \u5426 --&gt; drop\nc4 -- \u662f --&gt; drop\nc6 -- \u662f --&gt; drop\n\nstyle drop fill:#fbcfcd,stroke-width:0px,color:white;\nstyle ack fill:#12e7d4,stroke-width:0px,color:white;</code></pre> <p>\u56fe\u5217\u8bf4\u660e\uff1a</p> <ul> <li><code>cur_qlen</code>: \u5f53\u524d\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6</li> <li><code>max_qlen</code>: \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6</li> <li></li> </ul> <p>\u4e0a\u56fe\u662f\u6574\u7406\u4e86\u591a\u4efd\u8d44\u6599\u540e\uff0c\u6574\u7406\u51fa\u6765\u7684\u5224\u65ad\u662f\u5426 Drop SYN \u8bf7\u6c42\u7684\u6d41\u7a0b\u56fe\u3002</p> <p>\u76f8\u5173\u5185\u6838\u4ee3\u7801\uff1a</p> <pre><code>// include/net/inet_connection_sock.h \n// line: 281\nstatic inline int inet_csk_reqsk_queue_is_full(const struct sock *sk) \n{ \n  return inet_csk_reqsk_queue_len(sk) &gt;= sk-&gt;sk_max_ack_backlog; \n} \n</code></pre> <p>\u5176\u4e2d <code>tcp(7)</code> \u624b\u518c\u4e0a\u662f\u8fd9\u6837\u63cf\u8ff0 <code>tcp_syn_cookies</code></p> <p>tcp_syncookies (integer; default: 1; since Linux 2.2)  Enable TCP syncookies.  The kernel must be compiled with CONFIG_SYN_COOKIES.   The  syn\u2010  cookies  feature  attempts  to protect a socket from a SYN flood attack.  This should be  used as a last resort, if at all.  This is a violation of the  TCP  protocol,  and  con\u2010  flicts  with  other  areas  of  TCP  such  as TCP extensions.  It can cause problems for  clients and relays.  It is not recommended as a  tuning  mechanism  for  heavily  loaded  servers  to  help with overloaded or misconfigured conditions.  For recommended alterna\u2010  tives see tcp_max_syn_backlog, tcp_synack_retries, and  tcp_abort_on_overflow.   Set  to  one of the following values:  0  Disable TCP syncookies  1  Send out syncookies when the syn backlog queue of a socket overflows    2  (since  Linux 3.12) Send out syncookies unconditionally.  This can be useful for net\u2010     work testing.  </p> <p>\u6211\u4eec\u5047\u8bbe\u5982\u4e0b\u53c2\u6570\uff0c\u6765\u8ba1\u7b97\u4e0b\u5f53 Client \u7aef\u53ea\u53d1\u9001 SYN \u5305\uff0c\u7406\u8bba\u4e0a Server \u7aef\u4f55\u65f6\u4f1a Drop SYN \u8bf7\u6c42\uff1a</p> backlog somaxconn <code>tcp_max_syn_backlog</code> <code>tcp_syncookies</code> \u534a\u961f\u5217\u6700\u5927\u957f\u5ea6 \u89e6\u53d1 Drop SYN \u4e34\u754c\u503c 1024 1024 128 0 256 96 1024 1024 128 1 256 512/1024<sup>1</sup> 1024 1024 128 2 256 \u6c38\u4e0d <p>\u56de\u987e\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u9a8c\u7ed3\u679c</p> <p>\u5728\u4e0a\u6587\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u9a8c\u4e2d\uff0c\u6709\u4e00\u7c7b\u5b9e\u9a8c\u7ed3\u679c\u662f\uff1aclient \u5411 Server \u53d1\u9001 SYN \u672a\u5f97\u5230\u54cd\u5e94\uff0c\u4e00\u76f4\u5728 RETRY\u3002</p> <p>\u53d1\u751f\u4e0a\u8ff0\u60c5\u51b5\u7684\u539f\u56e0\u7531\u4ee5\u4e0b\u4e24\u65b9\u9762\u5bfc\u81f4\uff1a</p> <ol> <li>\u5f00\u542f\u4e86 <code>/proc/sys/net/ipv4/tcp_syncookies</code> \u529f\u80fd</li> <li>\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86</li> </ol> <p>\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c</p> <p>\u4e0a\u6587\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u5982\u4f55\u8ba1\u7b97\u7406\u8bba\u4e0a\u534a\u8fde\u63a5\u961f\u5217\u4f55\u65f6\u4f1a\u6ea2\u51fa\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u5177\u4f53\u5b9e\u9a8c\u4e0b</p> <p>(Golang \u8c03\u7528 listen \u65f6\u4f20\u5165\u7684 backlog \u503c\u4e3a somaxconn)</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_10","title":"\u5b9e\u9a8c\u4e00","text":"<p>\u5c06\u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u66f4\u65b0</p> <pre><code>$ sudo sysctl -w net.core.somaxconn=1024 \n$ sudo sysctl -w net.ipv4.tcp_max_syn_backlog=128 \n$ sudo sysctl -w net.ipv4.tcp_syncookies=0 \n</code></pre> <p>\u7406\u8bba\u4e0a\uff1a</p> <ul> <li>\u8ba1\u7b97\u51fa\u7684\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u4e3a 256</li> <li>\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u589e\u957f\u81f3 96 \u540e\uff0c\u540e\u7eed SYN \u8bf7\u6c42\u5c31\u4f1a\u89e6\u53d1 Drop</li> </ul> <p>\u542f\u52a8\u670d\u52a1\u7aef Server \u76d1\u542c 8888 \u7aef\u53e3</p> <p>\u5ba2\u6237\u7aef Client \u53d1\u8d77 SYN Flood \u653b\u51fb\uff1a</p> <pre><code>$ sudo hping3 -S 192.168.31.76 -p 8888 --flood \nHPING 192.168.31.76 (wlp0s20f3 192.168.31.76): S set, 40 headers + 0 data bytes\nhping in flood mode, no replies will be shown \n</code></pre> <p>\u67e5\u770b\u670d\u52a1\u7aef Server 8888\u7aef\u53e3\u5904\u4e8e <code>SYN_RECV</code> \u72b6\u6001\u7684 socket \u6700\u5927\u4e2a\u6570\uff1a</p> <pre><code>$ sudo netstat -nat | grep :8888 | grep 'SYN_RECV'  | wc -l \n98\n$ sudo netstat -nat | grep :8888 | grep 'SYN_RECV'  | wc -l \n98\n</code></pre> <p>\u6211\u8fd9\u91cc\u5b9e\u9a8c\u7ed3\u679c\uff0898\uff09\u548c\u9884\u671f\uff0896\uff09\u6709\u76f8\u5dee\uff0c\u5177\u4f53\u539f\u56e0\u8fd8\u6ca1\u6709\u627e\u5230\uff0c\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u589e\u957f\u81f3 98 \u540e\uff0c\u540e\u7eed SYN \u8bf7\u6c42\u5c31\u4f1a\u89e6\u53d1 Drop\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_11","title":"\u5b9e\u9a8c\u4e8c","text":"<p>\u5c06\u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u66f4\u65b0</p> <pre><code>$ sudo sysctl -w net.core.somaxconn=128 \n$ sudo sysctl -w net.ipv4.tcp_max_syn_backlog=512 \n$ sudo sysctl -w net.ipv4.tcp_syncookies=0 \n</code></pre> <p>\u7406\u8bba\u4e0a\uff1a</p> <ul> <li>\u8ba1\u7b97\u51fa\u7684\u534a\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u4e3a 256\uff0c\u7531\u4e8e\u7b14\u8005\u5b9e\u9a8c\u673a\u5668\u4e0a\u7684\u5185\u6838\u7248\u672c\u662f 5.19.0\uff0c\u6240\u4ee5\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6 &gt;= \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u65f6\uff0c\u5185\u6838\u5c31\u8ba4\u4e3a\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u4e86</li> <li>\u6240\u4ee5\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u589e\u957f\u81f3 128 \u540e\uff0c\u540e\u7eed SYN \u8bf7\u6c42\u5c31\u4f1a\u89e6\u53d1 DROP</li> </ul> <p>\u542f\u52a8\u670d\u52a1\u7aef Server \u76d1\u542c 8888 \u7aef\u53e3(\u4ee3\u7801\u53c2\u8003\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u9a8c\u7269\u6599)</p> <p>\u5ba2\u6237\u7aef Client \u53d1\u8d77 SYN Flood \u653b\u51fb\uff1a</p> <pre><code>$ sudo hping3 -S 192.168.31.76 -p 8888 --flood \nHPING 192.168.31.76 (en1 192.168.31.76): S set, 40 headers + 0 data bytes\nhping in flood mode, no replies will be shown\n</code></pre> <p>\u67e5\u770b\u670d\u52a1\u7aef Server 8888 \u7aef\u53e3\u5904\u4e8e SYN_RECV \u72b6\u6001\u7684 socket \u6700\u5927\u4e2a\u6570\uff1a</p> <pre><code>$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n128 \n\n$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n128 \n</code></pre> <p>\u5b9e\u9a8c\u7ed3\u679c\u7b26\u5408\u9884\u671f\uff0c\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u589e\u957f\u81f3 128 \u540e\uff0c\u540e\u7eed SYN \u8bf7\u6c42\u5c31\u4f1a\u89e6\u53d1 Drop</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_12","title":"\u5b9e\u9a8c\u4e09","text":"<p>\u5c06\u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u66f4\u65b0</p> <pre><code>$ sudo sysctl -w net.core.somaxconn=128 \n$ sudo sysctl -w net.ipv4.tcp_max_syn_backlog=512 \n$ sudo sysctl -w net.ipv4.tcp_syncookies=1\n</code></pre> <p>\u7406\u8bba\u4e0a\uff1a</p> <ul> <li>\u5f53\u5168\u8fde\u63a5\u961f\u5217\u672a\u6ee1\uff0c<code>syncookies = 1</code>\uff0c\u7406\u8bba\u4e0a SYN \u8bf7\u6c42\u6c38\u8fdc\u4e0d\u4f1a\u88ab Drop</li> </ul> <p>\u542f\u52a8\u670d\u52a1\u7aef Server \u76d1\u542c 8888 \u7aef\u53e3</p> <p>\u5ba2\u6237\u7aef Client \u53d1\u8d77 SYN Flood \u653b\u51fb\uff1a</p> <pre><code>$ sudo hping3 -S 192.168.31.76 -p 8888 --flood\nHPING 192.168.31.76 (en1 192.168.31.76): S set, 40 headers + 0 data bytes\nhping in flood mode, no replies will be shown\n</code></pre> <p>\u67e5\u770b\u670d\u52a1\u7aef Server 8888\u7aef\u53e3\u5904\u4e8e <code>SYN_RECV</code> \u72b6\u6001\u7684 socket \u6700\u5927\u4e2a\u6570\uff1a</p> <pre><code>$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n128 \n\n$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n128 \n</code></pre> <p>\u5b9e\u9a8c\u53d1\u73b0\u5373\u4f7f <code>syncookies=1</code>\uff0c\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6 &gt; \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u65f6\uff0c\u5c31\u4f1a\u89e6\u53d1 DROP SYN \u8bf7\u6c42\u3002\u4e0e\u7406\u8bba\u4e0d\u7b26\u5408\uff0c\u9700\u8981\u7ee7\u7eed\u7814\u7a76\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_13","title":"\u5b9e\u9a8c\u56db","text":"<p>\u5c06\u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u66f4\u65b0</p> <pre><code>$ sudo sysctl -w net.core.somaxconn=5\n$ sudo sysctl -w net.ipv4.tcp_max_syn_backlog=512 \n$ sudo sysctl -w net.ipv4.tcp_syncookies=1\n</code></pre> <p>\u53d1\u8d77 SYN Flood \u653b\u51fb\u540e\uff0c\u67e5\u770b\u670d\u52a1\u7aef Server 8888\u7aef\u53e3\u5904\u4e8e <code>SYN_RECV</code> \u72b6\u6001\u7684 socket \u6700\u5927\u4e2a\u6570\uff1a</p> <pre><code>$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n5 \n\n$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n6 \n</code></pre> <p>\u786e\u5b9e \u5373\u4f7f <code>syncookies=1</code>\uff0c\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6 &gt; \u5168\u8fde\u63a5\u6700\u5927\u957f\u5ea6\u65f6\uff0c\u5c31\u4f1a\u89e6\u53d1 DROP SYN \u8bf7\u6c42\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_14","title":"\u5b9e\u9a8c\u4e94\uff1a","text":"<p>\u7406\u8bba\u4e0a\uff1a</p> <ul> <li>\u5f53\u534a\u8fde\u63a5\u961f\u5217\u5927\u5c0f\u5230 256 \u540e\uff0c\u540e\u89e6\u53d1 DROP SYN \u8bf7\u6c42</li> </ul> <p>\u5c06\u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u66f4\u65b0</p> <pre><code>$ sudo sysctl -w net.core.somaxconn=256\n$ sudo sysctl -w net.ipv4.tcp_max_syn_backlog=512 \n$ sudo sysctl -w net.ipv4.tcp_syncookies=1\n</code></pre> <p>\u542f\u52a8\u670d\u52a1\u7aef Server \u76d1\u542c 8888 \u7aef\u53e3\u3002</p> <p>\u5ba2\u6237\u7aef Client \u53d1\u8d77 SYN Flood \u653b\u51fb:</p> <pre><code>$ sudo hping3 -S 192.168.31.76 -p 8888 --flood\nHPING 192.168.31.76 (en1 192.168.31.76): S set, 40 headers + 0 data bytes\nhping in flood mode, no replies will be shown\n</code></pre> <p>\u67e5\u770b\u670d\u52a1\u7aef Server 8888 \u7aef\u53e3\u5904\u4e8e <code>SYN_RECV</code> \u72b6\u6001\u7684 socket \u6700\u5927\u4e2a\u6570\uff1a</p> <pre><code>$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n256 \n\n$ sudo netstat -nat | grep :8888 | grep SYN_RECV  | wc -l \n256 \n</code></pre> <p>\u5b9e\u9a8c\u7ed3\u679c\u7b26\u5408\u9884\u671f\uff0c\u5f53\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6\u589e\u957f\u81f3 256 \u540e\uff0c\u540e\u7eed SYN \u8bf7\u6c42\u5c31\u4f1a\u89e6\u53d1 Drop\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_15","title":"\u56de\u987e\u7ebf\u4e0a\u95ee\u9898","text":"<p>\u518d\u56de\u987e\u503c\u73ed\u65f6\u9047\u5230\u7684 Connection timeout \u95ee\u9898\uff0c\u5f53\u65f6\u76f8\u5173\u7cfb\u7edf\u53c2\u6570\u914d\u7f6e\u4e3a\uff1a</p> <ul> <li>net.core.somaxconn = 128</li> <li>net.ipv4.tcp_max_syn_backlog = 512</li> <li>net.ipv4.tcp_syncookies = 1</li> <li>net.ipv4.tcp_abort_on_overflow = 0</li> </ul> <p>\u6240\u4ee5\u51fa\u73b0 Connection timeout \u6709\u4e24\u79cd\u53ef\u80fd\u60c5\u51b5\uff1a</p> <p>1\u3001\u534a\u8fde\u63a5\u961f\u5217\u672a\u6ee1\uff0c\u5168\u8fde\u63a5\u961f\u5217\u6ee1\uff0cClient \u7aef\u5411 Server \u7aef\u53d1\u8d77 SYN \u88ab DROP (\u53c2\u8003\u5168\u8fde\u63a5\u961f\u5217\u5b9e\u9a8c\u7ed3\u679c\u60c5\u51b5\u4e09\u5206\u6790\u3001\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c\u60c5\u51b5\u4e09)</p> <p>2\u3001\u5168\u8fde\u63a5\u961f\u5217\u672a\u6ee1\uff0c\u534a\u8fde\u63a5\u961f\u5217\u5927\u5c0f\u8d85\u8fc7\u5168\u94fe\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6(\u53c2\u8003\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c\u60c5\u51b5\u4e09\u3001\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u5b9e\u9a8c\u60c5\u51b5\u56db)</p> <p>\u95ee\u9898\u7684\u6700\u5feb\u4fee\u590d\u65b9\u5f0f\u662f\u5c06 <code>net.core.somaxconn</code> \u8c03\u5927\uff0c\u4ee5\u53ca <code>net.ipv4.tcp_abort_on_overflow</code> \u8bbe\u7f6e\u4e3a 1\uff0c<code>net.ipv4.tcp_abort_on_overflow</code> \u8bbe\u7f6e\u4e3a 1 \u662f\u4e3a\u4e86\u8ba9 client fail fast\u3002</p>","tags":["tcp"]},{"location":"troubleshooting/deep-in-tcp-connect/#_16","title":"\u603b\u7ed3","text":"<p>\u534a\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u3001\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u8fd9\u7c7b\u95ee\u9898\u5f88\u5bb9\u6613\u88ab\u5ffd\u7565\uff0c\u540c\u65f6\u8fd9\u7c7b\u95ee\u9898\u53c8\u5f88\u81f4\u547d\u3002\u5f53\u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u6ea2\u51fa\u65f6 Server \u7aef\uff0c\u4ece\u76d1\u63a7\u4e0a\u6765\u770b\u7cfb\u7edf cpu \u6c34\u4f4d\u3001\u5185\u5b58\u6c34\u4f4d\u3001\u7f51\u7edc\u8fde\u63a5\u6570\u7b49\u4e00\u5207\u6b63\u5e38\uff0c\u7136\u800c\u5374\u4f1a\u6301\u7eed\u5f71\u54cd Client \u7aef\u4e1a\u52a1\u8bf7\u6c42\u3002\u5bf9\u4e8e\u9ad8\u8d1f\u8f7d\u4e0a\u6e38\u4f7f\u7528\u77ed\u8fde\u63a5\u7684\u60c5\u51b5\uff0c\u51fa\u73b0\u8fd9\u7c7b\u95ee\u9898\u7684\u53ef\u80fd\u6027\u66f4\u5927\u3002</p> <p>\u672c\u6587\u8be6\u7ec6\u68b3\u7406\u4e86 TCP \u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u7684\u7406\u8bba\u77e5\u8bc6\uff0c\u540c\u65f6\u7ed3\u5408 Linux \u76f8\u5173\u5185\u6838\u4ee3\u7801\u4ee5\u53ca\u8be6\u7ec6\u7684\u52a8\u624b\u5b9e\u9a8c\uff0c\u8bb2\u89e3\u4e86 TCP \u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u7684\u76f8\u5173\u539f\u7406\u3001\u6ea2\u51fa\u5224\u65ad\u3001\u95ee\u9898\u5206\u6790\u7b49\u5185\u5bb9\uff0c\u5e0c\u671b\u5927\u5bb6\u5728\u9605\u8bfb\u540e\u53ef\u4ee5\u5bf9 TCP \u534a\u8fde\u63a5\u961f\u5217\u3001\u5168\u8fde\u63a5\u961f\u5217\u6709\u66f4\u5145\u5206\u7684\u8ba4\u8bc6\u3002</p> <p>PS\uff1a\u53ef\u4ee5\u53bb\u7ebf\u4e0a\u68c0\u67e5\u4e0b\u670d\u52a1\u5668\u7684\u76f8\u5173\u53c2\u6570\u54df~</p> <p>\u9644\u5f55</p> <p>\u8fd9\u91cc\u7f57\u5217\u4e0b\u76f8\u5173\u53c2\u8003\u535a\u6587\u8d44\u6599\uff1a</p> <p>Linux \u6e90\u7801</p> <ul> <li>https://github.com/torvalds/linux</li> </ul> <p>Linux \u8be1\u5f02\u7684\u534a\u8fde\u63a5\u961f\u5217\u957f\u5ea6</p> <ul> <li>https://www.cnblogs.com/zengkefu/p/5606696.html</li> </ul> <p>TCP \u534a\u8fde\u63a5\u961f\u5217\u548c\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\u4f1a\u53d1\u751f\u4ec0\u4e48</p> <ul> <li>https://www.cnblogs.com/xiaolincoding/p/12995358.html</li> </ul> <p>\u4e00\u6b21 HTTP connect-timeout \u6392\u67e5</p> <ul> <li>https://www.jianshu.com/p/3b9c4216b822</li> </ul> <p>Connection Reset \u6392\u67e5</p> <ul> <li>https://cjting.me/2019/08/28/tcp-queue/</li> </ul> <p>\u6df1\u5165\u6d45\u51fa TCP \u4e2d\u7684 SYN-Cookies</p> <ul> <li>https://segmentfault.com/a/1190000019292140</li> </ul> <p>\u300aTCP/IP \u8be6\u89e3 \u5377\u4e00\uff1a\u534f\u8bae\u300b\u7b2c\u5341\u516b\u7ae0 - https://flylib.com/books/en/3.223.1.193/1/</p> <ol> <li> <p>\u7531\u4e8e\u5f00\u542f\u4e86 <code>tcp_syncookies</code>, \u5f53\u5168\u8fde\u63a5\u961f\u5217\u672a\u6ee1\u65f6\uff0c\u6c38\u8fdc\u4e0d\u4f1a Drop \u8bf7\u6c42 (\u6ce8\u610f\uff1a\u7ecf\u5b9e\u9a8c\u53d1\u73b0\u8fd9\u4e2a\u7406\u8bba\u662f\u9519\u8bef\u7684\uff0c\u5b9e\u9a8c\u53d1\u73b0\u53ea\u8981\u534a\u8fde\u63a5\u961f\u5217\u7684\u5927\u5c0f &gt; \u5168\u8fde\u63a5\u961f\u5217\u6700\u5927\u957f\u5ea6\u5c31\u4f1a\u89e6\u53d1 Drop SYN \u8bf7\u6c42);   \u5f53\u5168\u8fde\u63a5\u961f\u5217\u6ee1\u4e86\u540e\uff0c\u5373\u5168\u8fde\u63a5\u961f\u5217\u5927\u5c0f\u5230 1024 \u540e\uff0c\u5c31\u4f1a\u89e6\u53d1 Drop SYN \u8bf7\u6c42\u00a0\u21a9</p> </li> </ol>","tags":["tcp"]},{"location":"troubleshooting/docker-run-no-space-left/","title":"Docker \u8fd0\u884c\u5bb9\u5668\u62a5\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u7684\u9519\u8bef","text":"<p>Source</p>","tags":["docker"]},{"location":"troubleshooting/docker-run-no-space-left/#_1","title":"\u95ee\u9898","text":"<p>\u534a\u591c\u63a5\u5230\u7fa4\u53cb\u6c42\u52a9\uff0c\u8bf4\u81ea\u5df1\u7684\u6d4b\u8bd5\u73af\u5883\u9047\u5230\u4e86\u70b9\u95ee\u9898\uff0c\u6b63\u597d\u6211\u8fd8\u6ca1\u7761\uff0c\u90a3\u5c31\u6765\u770b\u4e00\u4e0b</p> <p>\u95ee\u9898\u7684\u60c5\u51b5\u5f88\u7b80\u5355\uff0c</p> <p>\u7528 <code>docker run -d --env-file .oss_env --mount type=bind,src=/data1,dst=/cache {image}</code> \u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668\uff0c\u7136\u540e\u53d1\u73b0\u5728\u542f\u52a8\u540e\u4e1a\u52a1\u4ee3\u7801\u62a5\u9519\uff0c\u629b\u51fa OSError: [Errno 28] No space left on device \u7684\u5f02\u5e38</p> <p>\u8fd9\u4e2a\u95ee\u9898\u5176\u5b9e\u5f88\u5178\u578b\uff0c\u4f46\u662f\u6700\u7ec8\u6392\u67e5\u51fa\u6765\u7684\u7ed3\u679c\u786e\u5b9e\u975e\u5178\u578b\u7684\u3002\u4e0d\u8fc7\u6392\u67e5\u601d\u8def\u5176\u5b9e\u5e94\u8be5\u662f\u5f88\u5178\u578b\u7684\u7ebf\u4e0a\u95ee\u9898\u7684\u4e00\u6b65\u6b65\u5206\u6790 root casue \u7684\u8fc7\u7a0b\u3002\u5e0c\u671b\u80fd\u5bf9\u770b\u5b98\u5c31\u5e2e\u52a9</p>","tags":["docker"]},{"location":"troubleshooting/docker-run-no-space-left/#_2","title":"\u6392\u67e5","text":"<p>\u9996\u5148\u7fa4\u53cb\u63d0\u4f9b\u4e86\u7b2c\u4e00\u4e2a\u5173\u952e\u4fe1\u606f\uff0c\u7a7a\u95f4\u6709\u4f59\u91cf\uff0c\u4f46\u662f\u5c31 OSError: [Errno 28] No space left on device \u3002\u90a3\u4e48\u719f\u6089 Linux \u7684\u540c\u5b66\u53ef\u80fd\u7b2c\u4e00\u6b65\u7684\u6392\u67e5\u5de5\u4f5c\u5c31\u662f\u6392\u67e5\u5bf9\u5e94\u7684 inode \u60c5\u51b5</p> <p>\u6267\u884c\u547d\u4ee4</p> <pre><code>df -ih\n</code></pre> <p></p> <p>\u6211\u4eec\u80fd\u770b\u5230 /data1 \u5b9e\u9645\u4e0a\u7684 inode \u548c\u6574\u673a\u7684 inode \u6570\u91cf\u90fd\u662f\u8db3\u591f\u7684\uff08\u5907\u6ce8\uff1a\u8fd9\u91cc\u662f\u6211\u81ea\u5df1\u5728\u6211\u81ea\u5df1\u7684\u673a\u5668\u4e0a\u590d\u73b0\u95ee\u9898\u7684\u622a\u56fe\uff0c\u7b2c\u4e00\u6b65\u7531\u7fa4\u53cb\u5b8c\u6210\uff0c\u7136\u540e\u7ed9\u6211\u63d0\u4f9b\u4e86\u4fe1\u606f\uff09</p> <p>\u90a3\u4e48\u6211\u4eec\u7ee7\u7eed\u6392\u67e5\uff0c\u6211\u4eec\u770b\u5230\u4e86\u6211\u4eec\u4f7f\u7528\u4e86 mount bind \u7684\u65b9\u5f0f\u5c06\u5bbf\u4e3b\u673a\u7684 /data1 \u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u5185\u90e8\u7684 /cache \u76ee\u5f55\u4e0b, mount bind \u53ef\u4ee5\u7528\u4e0b\u9762\u4e00\u5f20\u56fe\u6765\u8868\u793a\u548c volume \u7684\u533a\u522b</p> <p></p> <p>\u90fd\u5728\u4e0d\u540c\u7248\u672c\u7684\u5185\u6838\u4e0a\uff0cmount bind \u7684\u884c\u4e3a\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u786e\u8ba4\u4e0b mount bind \u7684\u60c5\u51b5\u662f\u5426\u6b63\u786e\uff0c\u6211\u4eec\u7528 fallocate2 \u6765\u521b\u5efa\u4e00\u4e2a 1G \u7684\u6587\u4ef6\uff0c\u7136\u540e\u5728\u5bb9\u5668\u5185\u90e8\u67e5\u770b\u6587\u4ef6\u7684\u5927\u5c0f</p> <pre><code>fallocate -l 10G /cache/test\n</code></pre> <p>\u6587\u4ef6\u521b\u5efa\u6ca1\u6709\u95ee\u9898\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u5c31\u53ef\u4ee5\u6392\u9664\u6389 mount bind \u7684\u7f3a\u9677\u4e86</p> <p>\u63a5\u7740\uff0c\u7fa4\u53cb\u63d0\u4f9b\u4e86\u8fd9\u4e2a\u76d8\u662f\u4e91\u5382\u5546\u7684\u4e91\u76d8\uff08\u7ecf\u8fc7\u6269\u5bb9\uff09\uff0c\u6211\u8ba9\u7fa4\u53cb\u786e\u8ba4\u4e0b\u662f\u5177\u4f53\u7684 ESSD \u8fd8\u662f NAS \u8fd9\u79cd\u8d70 NFS \u6302\u8f7d\u7684 Block Device\uff08\u8fd9\u5757\u4e5f\u6709\u5751\uff09\u3002\u786e\u8ba4\u662f\u6807\u51c6\u7684 ESSD \u540e\u8fdb\u5165\u4e0b\u4e00\u6b65\uff08\u9a71\u52a8\u7684\u95ee\u9898\u53ef\u4ee5\u5148\u6392\u9664\uff09</p> <p>\u63a5\u7740\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651 mount \u2013bind \u5728\u8de8\u6587\u4ef6\u7cfb\u7edf\u60c5\u51b5\u4e0b\u7684\u95ee\u9898\u3002\u867d\u7136\u524d\u9762\u4e00\u6b65\u6211\u4eec\u6210\u529f\u521b\u5efa\u4e86\u6587\u4ef6\u3002\u4f46\u662f\u4e3a\u4e86\u4fdd\u9669\u8d77\u89c1\uff0c\u6211\u4eec\u6267\u884c <code>fdisk -l</code> \u548c <code>tune2fs -l</code> \u4e24\u4e2a\u547d\u4ee4\uff0c\u6765\u786e\u8ba4\u5206\u533a\u548c\u6587\u4ef6\u7cfb\u7edf\u7684\u6b63\u786e\u6027\uff0c\u786e\u8ba4\u6587\u4ef6\u7cfb\u7edf\u7684\u7c7b\u578b\u90fd\u662f ext4\uff0c\u90a3\u4e48\u6ca1\u6709\u95ee\u9898\u3002\u5177\u4f53\u4e24\u4e2a\u547d\u4ee4\u7684\u4f7f\u7528\u65b9\u5f0f\u53c2\u89c1 fdisk3 \u548c tune2fs4</p> <p>\u7136\u540e\u518d\u56de\u987e\u6211\u4eec\u4e4b\u524d\u76f4\u63a5\u5728 <code>/cache</code> \u4e0b\u521b\u5efa\u95ee\u9898\u6ca1\u6709\u95ee\u9898\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5fc3\u91cc\u5e94\u8be5\u5927\u6982\u6709\u5e95\uff0c\u8fd9\u4e2a\u5e94\u8be5\u4e0d\u662f\u4ee3\u7801\u95ee\u9898\uff0c\u4e5f\u4e0d\u662f\u6743\u9650\u95ee\u9898\uff08\u8fd9\u4e00\u6b65\u6211\u989d\u5916\u6392\u9664\u955c\u50cf\u7684\u6784\u5efa\u91cc\u6ca1\u6709\u989d\u5916\u7684\u7528\u6237\u64cd\u4f5c\uff09\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u6392\u9664\u4e00\u4e0b\u6269\u5bb9\u7684\u95ee\u9898\u3002\u6211\u4eec\u5c06 /data1 unmount \u4e4b\u540e\uff0c\u91cd\u65b0 mount \u540e\uff0c\u518d\u6267\u884c\u5bb9\u5668\uff0c\u53d1\u73b0\u95ee\u9898\u4f9d\u65e7\u5b58\u5728\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u6392\u9664\u6269\u5bb9\u7684\u95ee\u9898\u4e86\u3002</p> <p>\u73b0\u5728\u4e00\u4e9b\u5e38\u89c1\u7684\u95ee\u9898\u5df2\u7ecf\u57fa\u672c\u6392\u9664\uff0c\u90a3\u4e48\u6211\u4eec\u6765\u8003\u8651\u6587\u4ef6\u7cfb\u7edf\u672c\u8eab\u7684\u95ee\u9898\u3002\u6211\u767b\u5f55\u5230\u673a\u5668\u4e0a\uff0c\u6267\u884c\u4e86\u4ee5\u4e0b\u4e24\u4e2a\u64cd\u4f5c</p> <ol> <li>\u5728\u51fa\u95ee\u9898\u7684\u76ee\u5f55 <code>/cache/xxx/</code> \u4e0b\uff0c\u6211\u7528 <code>fallocate -l</code> \u521b\u5efa\u4e00\u4e2a\u62a5\u9519\u7684\u6587\u4ef6\uff08\u957f\u6587\u4ef6\u540d\uff09\uff0c\u5931\u8d25</li> <li>\u5728\u51fa\u95ee\u9898\u7684\u76ee\u5f55 <code>/cache/xxx/</code> \u4e0b\uff0c\u6211\u7528 <code>fallocate -l</code> \u521b\u5efa\u4e00\u4e2a\u77ed\u6587\u4ef6\u540d\uff09\uff0c\u6210\u529f </li> </ol> <p>OK\uff0c\u6211\u4eec\u73b0\u5728\u6392\u67e5\u8def\u5f84\u5c31\u5f80\u6587\u4ef6\u7cfb\u7edf\u5f02\u5e38\u7684\u65b9\u5411\u4e0a\u9760\u4e86\uff0c\u6267\u884c\u547d\u4ee4 dmesg5 \u67e5\u770b\u5185\u6838\u65e5\u5fd7\uff0c\u53d1\u73b0\u4e86\u5982\u4e0b\u9519\u8bef</p> <pre><code>[13155344.231942] EXT4-fs warning (device sdd): ext4_dx_add_entry:2461: Directory (ino: 3145729) index full, reach max htree level :2\n[13155344.231944] EXT4-fs warning (device sdd): ext4_dx_add_entry:2465: Large directory feature is not enabled on this filesystem\n</code></pre> <p>OK\uff0c\u6211\u4eec\u671f\u5f85\u7684\u5f02\u5e38\u4fe1\u606f\u627e\u5230\u4e86\u3002\u539f\u56e0\u662f\uff0cext4 \u57fa\u4e8e\u7684 BTree \u7d22\u5f15\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u53ea\u5141\u8bb8\u6811\u7684\u5c42\u9ad8\u4e3a2\uff0c\u5b9e\u9645\u4e0a\u5c31\u5927\u6982\u9650\u5236\u4e86\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u6570\u91cf\u5927\u6982\u5728 2k-3kw \u4ee5\u5185\u3002\u7ecf\u8fc7\u786e\u8ba4\uff0c\u8fd9\u4e2a\u95ee\u9898\u76ee\u5f55\u4e0b\u7684\u786e\u6709\u5927\u91cf\u5c0f\u6587\u4ef6\u3002\u6211\u4eec\u518d\u7528 <code>tune2fs -l</code> \u786e\u8ba4\u4e0b\u662f\u5426\u662f\u5982\u6211\u4eec\u731c\u60f3\uff0c\u5f97\u5230\u7ed3\u679c</p> <pre><code>Filesystem revision #:    1 (dynamic)\nFilesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum\nFilesystem flags:         signed_directory_hash\n</code></pre> <p>bingo\uff0c\u7684\u786e\u6ca1\u6709\u5f00\u542f <code>large_dir</code> \u7684\u9009\u9879\u3002\u90a3\u4e48\u6211\u4eec\u6267\u884c <code>tune2fs -O large_dir /dev/sdd</code>\u5f00\u542f\u8fd9\u4e2a\u9009\u9879\uff0c\u7136\u540e\u518d\u6b21\u6267\u884c <code>tune2fs -l</code> \u786e\u8ba4\u4e0b\uff0c\u53d1\u73b0\u5df2\u7ecf\u5f00\u542f\u4e86\u3002\u7136\u540e\u6211\u4eec\u518d\u6b21\u6267\u884c\u5bb9\u5668\uff0c\u53d1\u73b0\u95ee\u9898\u5df2\u7ecf\u89e3\u51b3\u3002</p>","tags":["docker"]},{"location":"troubleshooting/docker-run-no-space-left/#_3","title":"\u9a8c\u8bc1","text":"<p>\u4e0a\u9762\u7684\u95ee\u9898\u6392\u67e5\u770b\u4f3c\u544a\u4e00\u6bb5\u843d\u3002\u4f46\u662f\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u95ed\u73af\u3002\u4e00\u4e2a\u95ee\u9898\u7684\u95ed\u73af\u6709\u4e24\u4e2a\u7279\u5f81</p> <ol> <li>\u5b9a\u4f4d\u5230\u5177\u4f53\u7684\u5f02\u5e38\u4ee3\u7801</li> <li>\u6709\u6700\u5c0f\u53ef\u590d\u73b0\u7248\u672c\u786e\u8ba4\u6211\u4eec\u627e\u5230 root cause \u662f\u7b26\u5408\u9884\u671f\u7684\u3002</li> </ol> <p>OK \u8fd9\u4e2a\u95ee\u9898\u5c31\u544a\u4e00\u6bb5\u843d</p>","tags":["docker"]},{"location":"troubleshooting/docker-run-no-space-left/#_4","title":"\u603b\u7ed3","text":"<p>\u5176\u5b9e\u8fd9\u4e2a\u95ee\u9898\u6bd4\u8f83\u51b7\u95e8\uff0c\u4f46\u662f\u6392\u67e5\u65b9\u5f0f\u5176\u5b9e\u662f\u633a\u5178\u578b\u7684\u7ebf\u4e0a\u95ee\u9898\u7684\u6392\u67e5\u65b9\u6cd5\u3002\u5bf9\u4e8e\u95ee\u9898\uff0c\u4e0d\u8981\u9884\u8bbe\u7ed3\u679c\uff0c\u4e00\u6b65\u6b65\u7684\u6839\u636e\u73b0\u8c61\u53bb\u903c\u8fd1\u6700\u7ec8\u7684\u7ed3\u8bba\u3002\u4ee5\u53ca eBPF \u771f\u7684\u597d\u4e1c\u897f\uff0c\u80fd\u5e2e\u52a9\u505a\u5f88\u591a\u5185\u6838\u7684\u4e8b\u3002\u6700\u540e\u6211\u7684 Linux \u6587\u4ef6\u7cfb\u7edf\u65b9\u9762\u7684\u5e95\u5b50\u8fd8\u662f\u592a\u8584\u5f31\u4e86\uff0c\u5e0c\u671b\u540e\u9762\u80fd\u91cd\u70b9\u52a0\u5f3a\u4e00\u4e0b</p> <p>\u5dee\u4e0d\u591a\u5c31\u8fd9\u6837</p>","tags":["docker"]},{"location":"troubleshooting/docker-run-no-space-left/#reference","title":"Reference","text":"<ul> <li>[1]. https://docs.docker.com/storage/bind-mounts/</li> <li>[2]. https://man7.org/linux/man-pages/man2/fallocate.2.html</li> <li>[3]. https://man7.org/linux/man-pages/man8/fdisk.8.html</li> <li>[4]. https://linux.die.net/man/8/tune2fs</li> <li>[5]. https://man7.org/linux/man-pages/man1/dmesg.1.html</li> <li>[6]. https://git.kernel.org/pub/scm/linux/kernel/git/tytso/ext4.git/commit/?h=dev&amp;id=88a399955a97fe58ddb2a46ca5d988caedac731b</li> </ul>","tags":["docker"]},{"location":"troubleshooting/fix-ora-00227/","title":"\u4fee\u590d Oracle ORA-00227 \u9519\u8bef","text":"<p>Source</p> <p>\u5177\u4f53\u62a5\u9519\u4fe1\u606f\u4e3a\uff1a</p> <pre><code> ORA-00227: corrupt block detected in control file: (block 16, # blocks 1)\n</code></pre> <p>\u89e3\u51b3\u7684\u529e\u6cd5\u4e3a\uff1a</p> <pre><code>[oracle@OCPLHR dbs]$ sas\nSQL*Plus: Release 11.2.0.3.0 Production on Mon Jul 29 14:57:47 2019\nCopyright (c) 1982, 2011, Oracle.  All rights reserved.\nConnected to:\nOracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nSYS@OCPLHR1&gt; startup force \nORACLE instance started.\nTotal System Global Area  626327552 bytes\nFixed Size                  2230952 bytes\nVariable Size             553649496 bytes\nDatabase Buffers           62914560 bytes\nRedo Buffers                7532544 bytes\nORA-00227: corrupt block detected in control file: (block 16, # blocks 1)\nORA-00202: control file: '/u01/app/oracle/oradata/OCPLHR1/control01.ctl'\n[oracle@OCPLHR dbs]$ \n[oracle@OCPLHR dbs]$ cp snapcf_OCPLHR1.f /u01/app/oracle/oradata/OCPLHR1/control01.ctl\n[oracle@OCPLHR dbs]$ sas\nSQL*Plus: Release 11.2.0.3.0 Production on Mon Jul 29 15:06:26 2019\nCopyright (c) 1982, 2011, Oracle.  All rights reserved.\nConnected to:\nOracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nSYS@OCPLHR1&gt; alter database backup controlfile to trace as '/home/oracle/ctl.txt';\nDatabase altered.\nSYS@OCPLHR1&gt; startup force nomount\nORACLE instance started.\nTotal System Global Area  626327552 bytes\nFixed Size                  2230952 bytes\nVariable Size             553649496 bytes\nDatabase Buffers           62914560 bytes\nRedo Buffers                7532544 bytes\nSYS@OCPLHR1&gt; CREATE CONTROLFILE REUSE DATABASE \"OCPLHR1\" NORESETLOGS  ARCHIVELOG\n      MAXLOGFILES 16\n      MAXLOGMEMBERS 3\n      MAXDATAFILES 100\n      MAXINSTANCES 8\n      MAXLOGHISTORY 292\n  LOGFILE\n    GROUP 1 '/u01/app/oracle/oradata/OCPLHR1/redo01.log'  --SIZE 50M BLOCKSIZE 512,\n    GROUP 2 '/u01/app/oracle/oradata/OCPLHR1/redo02.log'  --SIZE 50M BLOCKSIZE 512,\n     GROUP 3 '/u01/app/oracle/oradata/OCPLHR1/redo03.log'  --SIZE 50M BLOCKSIZE 512\n   -- STANDBY LOGFILE\n   DATAFILE\n     '/u01/app/oracle/oradata/OCPLHR1/system01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/sysaux01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/undotbs01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/users01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/example01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/a.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/ocplhr1_test01.dbf',\n     '/u01/app/oracle/oradata/OCPLHR1/trpdata.dbf'\n   CHARACTER SET ZHS16GBK\n   ;\nControl file created.\nSYS@OCPLHR1&gt; \nSYS@OCPLHR1&gt; startup force\nORACLE instance started.\nTotal System Global Area  626327552 bytes\nFixed Size                  2230952 bytes\nVariable Size             553649496 bytes\nDatabase Buffers           62914560 bytes\nRedo Buffers                7532544 bytes\nDatabase mounted.\nORA-01113: file 1 needs media recovery\nORA-01110: data file 1: '/u01/app/oracle/oradata/OCPLHR1/system01.dbf'\nSYS@OCPLHR1&gt; recover database;\nMedia recovery complete.\nSYS@OCPLHR1&gt; \nSYS@OCPLHR1&gt; alter database open;\nalter database open\n*\nERROR at line 1:\nORA-00603: ORACLE server session terminated by fatal error\nORA-00600: internal error code, arguments: [2662], [0], [3545903], [0], [3551857], [12583040], [], [], [], [], [], []\nORA-00600: internal error code, arguments: [2662], [0], [3545902], [0], [3551857], [12583040], [], [], [], [], [], []\nORA-01092: ORACLE instance terminated. Disconnection forced\nORA-00600: internal error code, arguments: [2662], [0], [3545900], [0], [3551857], [12583040], [], [], [], [], [], []\nProcess ID: 14562\nSession ID: 96 Serial number: 3\nSYS@OCPLHR1&gt; startup force\nORA-24324: service handle not initialized\nORA-01041: internal error. hostdef extension doesn't exist\nSYS@OCPLHR1&gt; exit\nDisconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\n[oracle@OCPLHR dbs]$ \n[oracle@OCPLHR dbs]$ \n[oracle@OCPLHR dbs]$ sas\nSQL*Plus: Release 11.2.0.3.0 Production on Mon Jul 29 15:10:44 2019\nCopyright (c) 1982, 2011, Oracle.  All rights reserved.\nConnected to an idle instance.\nSYS@OCPLHR1&gt; startup force\nORACLE instance started.\nTotal System Global Area  626327552 bytes\nFixed Size                  2230952 bytes\nVariable Size             553649496 bytes\nDatabase Buffers           62914560 bytes\nRedo Buffers                7532544 bytes\nDatabase mounted.\nORA-01113: file 1 needs media recovery\nORA-01110: data file 1: '/u01/app/oracle/oradata/OCPLHR1/system01.dbf'\nSYS@OCPLHR1&gt; recover database;\nMedia recovery complete.\nSYS@OCPLHR1&gt; alter database open;\nDatabase altered.\nSYS@OCPLHR1&gt; \nSYS@OCPLHR1&gt; alter system switch logfile;\nSystem altered.\nSYS@OCPLHR1&gt; alter system switch logfile;\nSystem altered.\nSYS@OCPLHR1&gt; startup force\nORACLE instance started.\nTotal System Global Area  626327552 bytes\nFixed Size                  2230952 bytes\nVariable Size             553649496 bytes\nDatabase Buffers           62914560 bytes\nRedo Buffers                7532544 bytes\nDatabase mounted.\nDatabase opened.\nSYS@OCPLHR1&gt; exit\nDisconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\n[oracle@OCPLHR dbs]$ rman target /\nRecovery Manager: Release 11.2.0.3.0 - Production on Mon Jul 29 15:11:55 2019\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\nconnected to target database: OCPLHR1 (DBID=2909198110)\nRMAN&gt; backup database;\nStarting backup at 2019-07-29 15:12:09\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=129 device type=DISK\nchannel ORA_DISK_1: starting full datafile backup set\nchannel ORA_DISK_1: specifying datafile(s) in backup set\ninput datafile file number=00001 name=/u01/app/oracle/oradata/OCPLHR1/system01.dbf\ninput datafile file number=00002 name=/u01/app/oracle/oradata/OCPLHR1/sysaux01.dbf\ninput datafile file number=00005 name=/u01/app/oracle/oradata/OCPLHR1/example01.dbf\ninput datafile file number=00003 name=/u01/app/oracle/oradata/OCPLHR1/undotbs01.dbf\ninput datafile file number=00004 name=/u01/app/oracle/oradata/OCPLHR1/users01.dbf\ninput datafile file number=00008 name=/u01/app/oracle/oradata/OCPLHR1/trpdata.dbf\ninput datafile file number=00006 name=/u01/app/oracle/oradata/OCPLHR1/a.dbf\ninput datafile file number=00007 name=/u01/app/oracle/oradata/OCPLHR1/ocplhr1_test01.dbf\nchannel ORA_DISK_1: starting piece 1 at 2019-07-29 15:12:11\nchannel ORA_DISK_1: finished piece 1 at 2019-07-29 15:13:46\npiece handle=/u01/app/oracle/fast_recovery_area/OCPLHR1/backupset/2019_07_29/o1_mf_nnndf_TAG20190729T151210_gmx72cd9_.bkp tag=TAG20190729T151210 comment=NONE\nchannel ORA_DISK_1: backup set complete, elapsed time: 00:01:35\nchannel ORA_DISK_1: starting full datafile backup set\nchannel ORA_DISK_1: specifying datafile(s) in backup set\nincluding current control file in backup set\nincluding current SPFILE in backup set\nchannel ORA_DISK_1: starting piece 1 at 2019-07-29 15:13:47\nchannel ORA_DISK_1: finished piece 1 at 2019-07-29 15:13:48\npiece handle=/u01/app/oracle/fast_recovery_area/OCPLHR1/backupset/2019_07_29/o1_mf_ncsnf_TAG20190729T151210_gmx75chn_.bkp tag=TAG20190729T151210 comment=NONE\nchannel ORA_DISK_1: backup set complete, elapsed time: 00:00:01\nFinished backup at 2019-07-29 15:13:48\nRMAN&gt; sql 'alter system switch logfile';\nsql statement: alter system switch logfile\nRMAN&gt; backup archivelog all ;\nStarting backup at 2019-07-29 15:15:18\ncurrent log archived\nusing channel ORA_DISK_1\nchannel ORA_DISK_1: starting archived log backup set\nchannel ORA_DISK_1: specifying archived log(s) in backup set\ninput archived log thread=1 sequence=1 RECID=1 STAMP=1014909024\ninput archived log thread=1 sequence=2 RECID=2 STAMP=1014909024\ninput archived log thread=1 sequence=3 RECID=3 STAMP=1014909024\ninput archived log thread=1 sequence=4 RECID=4 STAMP=1014909073\ninput archived log thread=1 sequence=5 RECID=5 STAMP=1014909090\ninput archived log thread=1 sequence=6 RECID=6 STAMP=1014909092\ninput archived log thread=1 sequence=7 RECID=7 STAMP=1014909108\ninput archived log thread=1 sequence=8 RECID=8 STAMP=1014909304\ninput archived log thread=1 sequence=9 RECID=9 STAMP=1014909318\nchannel ORA_DISK_1: starting piece 1 at 2019-07-29 15:15:18\nchannel ORA_DISK_1: finished piece 1 at 2019-07-29 15:15:19\npiece handle=/u01/app/oracle/fast_recovery_area/OCPLHR1/backupset/2019_07_29/o1_mf_annnn_TAG20190729T151518_gmx786b1_.bkp tag=TAG20190729T151518 comment=NONE\nchannel ORA_DISK_1: backup set complete, elapsed time: 00:00:01\nFinished backup at 2019-07-29 15:15:19\nRMAN&gt; backup current controlfile;\nStarting backup at 2019-07-29 15:15:36\nusing channel ORA_DISK_1\nchannel ORA_DISK_1: starting full datafile backup set\nchannel ORA_DISK_1: specifying datafile(s) in backup set\nincluding current control file in backup set\nchannel ORA_DISK_1: starting piece 1 at 2019-07-29 15:15:37\nchannel ORA_DISK_1: finished piece 1 at 2019-07-29 15:15:38\npiece handle=/u01/app/oracle/fast_recovery_area/OCPLHR1/backupset/2019_07_29/o1_mf_ncnnf_TAG20190729T151536_gmx78swd_.bkp tag=TAG20190729T151536 comment=NONE\nchannel ORA_DISK_1: backup set complete, elapsed time: 00:00:01\nFinished backup at 2019-07-29 15:15:38\nRMAN&gt; exit\nRecovery Manager complete.\n[oracle@OCPLHR dbs]$ sas\nSQL*Plus: Release 11.2.0.3.0 Production on Mon Jul 29 15:15:44 2019\nCopyright (c) 1982, 2011, Oracle.  All rights reserved.\nConnected to:\nOracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nSYS@OCPLHR1&gt; archive log list;\nDatabase log mode              Archive Mode\nAutomatic archival             Enabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     8\nNext log sequence to archive   10\nCurrent log sequence           10\nSYS@OCPLHR1&gt;\n</code></pre>","tags":["oracle","controlfile","ora-00227"]},{"location":"troubleshooting/jdk1.6-support-tlsv1.2/","title":"\u8ba9 Oracle JDK 1.6 TLSv1.2","text":"<p>Oracle JDK \u662f\u4ece 1.7 \u624d\u5f00\u59cb\u652f\u6301 <code>TLSv1.2</code> \u53ca\u4ee5\u4e0a\u7248\u672c\uff0c\u5982\u679c\u53c8\u4e0d\u60f3\u964d\u4f4e\u914d\u7f6e\u6765\u652f\u6301\u5305\u542b\u98ce\u9669\u7684 <code>TLSv1.1</code> \uff0c\u89e3\u51b3\u7248\u672c\u662f\u5229\u7528 <code>Bouncy Castle</code> \u5305\u6765\u66ff\u6362 JDK \u5185\u7f6e\u7684\u9ed8\u8ba4 <code>TLS</code> \u5904\u7406\u7a0b\u5e8f\u3002 \u89e3\u51b3\u529e\u6cd5\u5982\u4e0b\uff1a</p> <ol> <li>\u4ece Java Archive Oracle website \u4e0b\u8f7d JDK 1.6</li> <li>\u4e0b\u8f7d Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 6\uff0c\u5e76\u53bb\u76ee\u5f55\u65b9\u5f0f\u89e3\u538b\u5230 JDK 1.6 \u7684 <code>jre/lib/security</code> \u76ee\u5f55\u4e0b</li> <li>\u4e0b\u8f7d bcprov-jdk15to18-165.jar \u548c bctls-jdk15to18-165.jar \u4e24\u4e2a jar \u6587\u4ef6\u5e76\u62f7\u8d1d\u5230 <code>${JAVA_HOME}/jre/lib/ext</code> \u76ee\u5f55</li> <li> <p>\u4fee\u6539 <code>${JAVA_HOME}/jre/lib/security/java.security</code> \u6587\u4ef6\uff0c\u6ce8\u91ca<code>security.provider</code>\u7684\u82e5\u5e72\u884c\uff0c\u5e76\u589e\u52a0\u82e5\u5e72\u884c\uff0c\u5982\u4e0b\uff1a</p> <pre><code>#\n Original security providers (just comment it)\n# security.provider.1=sun.security.provider.Sun\n# security.provider.2=sun.security.rsa.SunRsaSign\n# security.provider.3=com.sun.net.ssl.internal.ssl.Provider\n# security.provider.4=com.sun.crypto.provider.SunJCE\n# security.provider.5=sun.security.jgss.SunProvider\n# security.provider.6=com.sun.security.sasl.Provider\n# security.provider.7=org.jcp.xml.dsig.internal.dom.XMLDSigRI\n# security.provider.8=sun.security.smartcardio.SunPCSC\n\n# Add the Bouncy Castle security providers with higher priority\nsecurity.provider.1=org.bouncycastle.jce.provider.BouncyCastleProvider\nsecurity.provider.2=org.bouncycastle.jsse.provider.BouncyCastleJsseProvider\n\n# Original security providers with different priorities\nsecurity.provider.3=sun.security.provider.Sun\nsecurity.provider.4=sun.security.rsa.SunRsaSign\nsecurity.provider.5=com.sun.net.ssl.internal.ssl.Provider\nsecurity.provider.6=com.sun.crypto.provider.SunJCE \nsecurity.provider.7=sun.security.jgss.SunProvider\nsecurity.provider.8=com.sun.security.sasl.Provider\nsecurity.provider.9=org.jcp.xml.dsig.internal.dom.XMLDSigRI\nsecurity.provider.10=sun.security.smartcardio.SunPCSC\n\n# Here we are changing the default SSLSocketFactory implementation\nssl.SocketFactory.provider=org.bouncycastle.jsse.provider.SSLSocketFactoryImpl\n</code></pre> </li> <li> <p>\u6d4b\u8bd5</p> </li> </ol>","tags":["jdk","tlsv1.2","bcprov","bctls"]}]}