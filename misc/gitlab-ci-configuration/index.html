
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="本文对 GitLab CI 流水线配置文件 .gitlab-ci.yml 进行详细的介绍。">
      
      
        <meta name="author" content="wgzhao">
      
      
        <link rel="canonical" href="https://wgzhao.github.io/notes/misc/gitlab-ci-configuration/">
      
      
        <link rel="prev" href="../git-from-zero-to-hero/">
      
      
        <link rel="next" href="../osint-introduce/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.1">
    
    
      
        <title>gitlab-ci.yml 详解 - 个人笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gitlab-ciyml" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="个人笔记" class="md-header__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            个人笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              gitlab-ci.yml 详解
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  Tags

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bigdata/ambari-cli/" class="md-tabs__link">
          
  
    
  
  Bigdata

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../courses/commands-in-sbin/" class="md-tabs__link">
          
  
    
  
  Courses

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../database/maridb-ax-setup/" class="md-tabs__link">
          
  
    
  
  Database

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../kubernetes/access-k8s-pod-from-outersider/" class="md-tabs__link">
          
  
    
  
  Kubernetes

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../Latex%20Math%20Symbols/" class="md-tabs__link">
          
  
    
  
  Misc

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../programming/design-restful-api-with-python-and-flask/" class="md-tabs__link">
          
  
    
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tips/bash-tips/" class="md-tabs__link">
          
  
    
  
  Tips

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-tabs__link">
          
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="个人笔记" class="md-nav__button md-logo" aria-label="个人笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    个人笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wgzhao/notes" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wgzhao/notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bigdata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Bigdata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/ambari-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Ambari API 来操作 Hadoop 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/flink-cdc-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flink SQL CDC 实践以及一致性分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/integrating-hive-with-spark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating Apache Hive with Apache Spark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/integrating-phoenix-with-kerberos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phoenix 集成 HBase 并支持 Kerberos 认证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/ipa-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free IPA setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/kerberos-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MIT Kerberos  安装及维护手册
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/mafengwo-warehouse-design-and-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    马蜂窝数据仓库设计与实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/presto-with-ssl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Presto SSL 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bigdata/zookeeper-optimize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zookeeper集群应对万级并发的调优
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Courses
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Courses
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/commands-in-sbin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 命令学习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/linux-cfs-scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux CFS 调度器：原理、设计与内核实现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/pg9_high_performance_notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《PostgreSQL 9 High Performance》读书笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mysql lecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Mysql lecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/mysql-lecture/mysql-practices-lecture-45-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第一部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/mysql-lecture/mysql-practices-lecture-45-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第二部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/mysql-lecture/mysql-practices-lecture-45-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第三部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/mysql-lecture/mysql-practices-lecture-45-4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第四部分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/mysql-lecture/mysql-practices-lecture-45-5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《MySQL 实战45讲》节选第五部分
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Time series analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Time series analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/time-series-analysis/01-basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/time-series-analysis/02-primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    初级篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/time-series-analysis/03-advance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进阶篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/time-series-analysis/04-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../courses/time-series-analysis/05-complete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    补完篇
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/maridb-ax-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MariaDB AX 安装测试简记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql-cluster-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MySQL Cluster 配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/oracle-11g-imp-and-exp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 11g 导入导出基本操作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/oracle-silent-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oracle 静默安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/percona-cluster-with-haproxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HAProxy + Percona XtraDB Cluster 部署
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/setup-a-clickhouse-cluster-on-one-node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在一个节点上部署 ClickHouse 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/why-mysql8-slower-than-mysql57/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    默认配置下，为什么 MySQL 8.0 比 MySQL 5.7 慢
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/access-k8s-pod-from-outersider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    外部机器如何直接直接访问 kubernetes 集群内服务
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/calico-node-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calico Node 无法启动的排查
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/collect-k8s-log-with-filebeat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基于 ELK 的 日志收集与自动索引创建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/coredns-support-hosts-file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CoreDNS 支持解析宿主机的 hosts 文件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/deep-dive-into-k8s-internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用奇怪的方式构建简单 k8s 集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/how-to-create-user-for-k8s-dashboard/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    在 Kubernetes Dashboard 创建基于 RBAC 的授权用户
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/kubernetes-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 kubeadm 安装 kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/take-flannel-to-calico/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate kubernetes cluster from Flannel to Calico
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Latex%20Math%20Symbols/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用于 LateX 的数学符号
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../git-from-zero-to-hero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git从入门到应付日常工作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    gitlab-ci.yml 详解
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    gitlab-ci.yml 详解
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gitlab-ci" class="md-nav__link">
    <span class="md-ellipsis">
      GitLab CI介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gitlab-ciyml_1" class="md-nav__link">
    <span class="md-ellipsis">
      .gitlab-ci.yml 配置参数
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      参数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="参数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#script" class="md-nav__link">
    <span class="md-ellipsis">
      script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image" class="md-nav__link">
    <span class="md-ellipsis">
      image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      services
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#before_script" class="md-nav__link">
    <span class="md-ellipsis">
      before_script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after_script" class="md-nav__link">
    <span class="md-ellipsis">
      after_script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    <span class="md-ellipsis">
      stages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stage" class="md-nav__link">
    <span class="md-ellipsis">
      stage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-except" class="md-nav__link">
    <span class="md-ellipsis">
      only 和 except
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-except_1" class="md-nav__link">
    <span class="md-ellipsis">
      only 和 except 高级用法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-except_2" class="md-nav__link">
    <span class="md-ellipsis">
      only 和 except 综合示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tags" class="md-nav__link">
    <span class="md-ellipsis">
      tags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allow_failure" class="md-nav__link">
    <span class="md-ellipsis">
      allow_failure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when" class="md-nav__link">
    <span class="md-ellipsis">
      when
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    <span class="md-ellipsis">
      environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      artifacts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coverage" class="md-nav__link">
    <span class="md-ellipsis">
      coverage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry" class="md-nav__link">
    <span class="md-ellipsis">
      retry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger" class="md-nav__link">
    <span class="md-ellipsis">
      trigger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#include" class="md-nav__link">
    <span class="md-ellipsis">
      include
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extends" class="md-nav__link">
    <span class="md-ellipsis">
      extends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pages" class="md-nav__link">
    <span class="md-ellipsis">
      pages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    <span class="md-ellipsis">
      variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#types-type" class="md-nav__link">
    <span class="md-ellipsis">
      废弃的关键字 types 和 type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#git_clone_path" class="md-nav__link">
    <span class="md-ellipsis">
      使用 GIT_CLONE_PATH 自定义构建目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#yaml" class="md-nav__link">
    <span class="md-ellipsis">
      特殊的YAML功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggers" class="md-nav__link">
    <span class="md-ellipsis">
      Triggers触发器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ci" class="md-nav__link">
    <span class="md-ellipsis">
      忽略CI检查
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../osint-introduce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    超级情报手机工具库：开源验证和调查工具及使用方法
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/design-restful-api-with-python-and-flask/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 Python 和 Flask 设计 RESTful API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/programming-with-vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无插件Vim编程技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/pure-bash-bible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pure Bash Bible
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/understanding-awk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding AWK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tips
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Tips
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/bash-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BASH 的一些技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/batch-convert-word-to-pdf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 下批量转换 word 文档为 pdf 的方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/change-keyboard-layout-in-ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ubuntu 下修改键盘映射
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/git-internals-objects-branches-create-repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git 内部原理图解 -- 对象、分支以及如何从零开始建仓库
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/git-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git 不常见的操作技巧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/how-to-create-dummy-rpm-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速创建一个虚假 RPM 包
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-change-git-author/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to change git author name and email
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-delete-old-images-from-nexus-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何删除 nexus 私服上的 Docker 镜像
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/howto-save-tmux-session/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to save tmux session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/learn-seaborn-with-10min/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十分钟掌握 Seaborn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/matplotlib-support-chinese/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Python 中 matplotlib 图支持中文
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/move-running-process-into-tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    把一个运行的进程放到 tmux 会话中
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/rpm-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rpm 包管理基本技能
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/sed-one-line-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SED 单行脚本快速参考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/setup-gitlab-ci-for-android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Gitlab CI For Android
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/ssh-three-key-features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ssh的三板斧
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/ssh-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH examples, tips and tunnels
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tips/wechat-contacts-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    微信通讯录备份
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/capture-http-requests-with-tcpdump/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCPDump Capture HTTP GET/POST requests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/deep-in-tcp-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    详解 TCP 半连接队列与全连接队列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/docker-run-no-space-left/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker 运行容器报磁盘空间不足的错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/fix-ora-00227/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    修复 Oracle ORA-00227 错误
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/jdk1.6-support-tlsv1.2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    让 Oracle JDK 1.6 TLSv1.2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags" >
    
      
      
      
        <a href="../../tags/#tag:ci" class="md-tag">ci</a>
      
    
      
      
      
        <a href="../../tags/#tag:gitlab" class="md-tag">gitlab</a>
      
    
      
      
      
        <a href="../../tags/#tag:gitlab-ci" class="md-tag">gitlab-ci</a>
      
    
  </nav>



<h1 id="gitlab-ciyml">gitlab-ci.yml 详解<a class="headerlink" href="#gitlab-ciyml" title="Permanent link">&para;</a></h1>
<p>本文对 GitLab CI 流水线配置文件 <code>.gitlab-ci.yml</code> 进行详细的介绍。</p>
<h2 id="gitlab-ci"><a href="#id37">GitLab CI介绍</a><a class="headerlink" href="#gitlab-ci" title="Permanent link">&para;</a></h2>
<ul>
<li>GitLab提交持续集成服务，当你在项目根目录中添加 <code>.gitlab-ci.yml</code> 文件，并配置项目的运行器( <code>GitLab Runner</code> )，那么后续的每次提交都会触发CI流水线( <code>pipeline</code> )的执行。</li>
<li><code>.gitlab-ci.yml</code> 文件告诉运行器需要做哪些事情，默认情况下，流水线有 <code>build</code> 、<code>test</code> 、<code>deploy</code> 三个阶段，即 <code>构建</code> 、<code>测试</code> 、<code>部署</code> ，未被使用的阶段将会被自动忽略。</li>
<li>如果一切运行正常（没有非零返回值），您将获得与提交相关联的漂亮绿色复选标记(如下图所示)。这样可以在查看代码之前轻松查看提交是否导致任何测试失败。</li>
</ul>
<p><img alt="green_checkmark.png" src="../../images/gitlab/gitlab_cicd_green_checkmark.png" /></p>
<ul>
<li>大多数项目使用GitLab的CI服务来运行测试套件，以便开发人员在破坏某些内容时可以立即获得反馈。使用持续交付和持续部署将测试代码自动部署到模拟环境和生产环境的趋势越来越明显。</li>
<li>由于将 <code>.gitlab-ci.yml</code> 文件存放在仓库中进行版本控制，使用单一的配置文件来控制流水线，具有读访问权限的每个人都可以查看内容，从而使其更有吸引力地改进和查看构建脚本。旧的版本也能构建成功，forks项目也容易使用CI，分支可以有不同的流水线和作业。</li>
<li><code>.gitlab-ci.yml</code> 定义每个项目的流水线的结构和顺序，由以下两个因素决定：</li>
</ul>
<blockquote>
<ul>
<li>Gitlab Runner 运行器使用的执行器( <code>executor</code> )，执行器常用的 <code>Shell</code> 、 <code>Docker</code> 、<code>Kubernets</code> ， 我们当前仅使用 <code>Shell</code> 执行器，后续再使用其他执行器。</li>
<li>遇到进程成功或失败时等条件时做出的决定。</li>
</ul>
</blockquote>
<ul>
<li>可以在 <a href="https://docs.gitlab.com/ce/ci/quick_start/README.html">Getting started with GitLab CI/CD</a> 查看到流水线的简单示例。</li>
<li>可以在 <a href="https://docs.gitlab.com/ce/ci/examples/README.html">GitLab CI/CD Examples</a> 查看更多的流水线示例。</li>
<li>在流水线脚本中可以使用预定义的全局变量，详细可查看 <a href="https://docs.gitlab.com/ce/ci/variables/README.html">GitLab CI/CD Variables</a> 。</li>
<li>企业级的 <code>.gitlab-ci.yml</code> 示例可查看 <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/.gitlab-ci.yml">https://gitlab.com/gitlab-org/gitlab-ce/blob/master/.gitlab-ci.yml</a> 。</li>
<li>Job作业是 <code>.gitlab-ci.yml</code> 文件的基本元素，每个作业至少有 <code>script</code> 子句，在流水线中可以定义任意多个作业。</li>
<li>每个作业必须具有唯一的名称，但有一些保留的关键字不能用作作业名称，保留关键字( <code>reserved keywords</code> )有 <code>image</code> 、 <code>services</code> 、 <code>stages</code> 、 <code>types</code> 、 <code>before_script</code> 、 <code>after_script</code> 、 <code>variables</code> 、 <code>cache</code> 。</li>
</ul>
<h2 id="gitlab-ciyml_1"><a href="#id38"><code>.gitlab-ci.yml</code> 配置参数</a><a class="headerlink" href="#gitlab-ciyml_1" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>script</td>
<td>必须参数，运行器需要执行的脚本</td>
</tr>
<tr>
<td>image</td>
<td>使用Docker image镜像</td>
</tr>
<tr>
<td>services</td>
<td>使用Docker services镜像</td>
</tr>
<tr>
<td>before_script</td>
<td>作业执行前需要执行的命令</td>
</tr>
<tr>
<td>after_script</td>
<td>作业执行后需要执行的命令</td>
</tr>
<tr>
<td>stages</td>
<td>定义流水线所有的阶段</td>
</tr>
<tr>
<td>stage</td>
<td>定义作业所处流水线的阶段(默认test阶段)</td>
</tr>
<tr>
<td>only</td>
<td>限制作业在什么时候创建</td>
</tr>
<tr>
<td>except</td>
<td>限制作业在什么时候不创建</td>
</tr>
<tr>
<td>tags</td>
<td>作用使用的Runner运行器的标签列表</td>
</tr>
<tr>
<td>allow_failure</td>
<td>允许作业失败，失败的作业不影响提交的状态</td>
</tr>
<tr>
<td>when</td>
<td>什么时候运行作业</td>
</tr>
<tr>
<td>environment</td>
<td>作用部署的环境名称</td>
</tr>
<tr>
<td>cache</td>
<td>指定需要在job之间缓存的文件或目录</td>
</tr>
<tr>
<td>artifacts</td>
<td>归档文件列表，指定成功后应附加到job的文件和目录的列表</td>
</tr>
<tr>
<td>dependencies</td>
<td>当前作业依赖的其他作业，你可以使用依赖作业的归档文件</td>
</tr>
<tr>
<td>coverage</td>
<td>作业的代码覆盖率</td>
</tr>
<tr>
<td>retry</td>
<td>作业失败时，可以自动执行多少次</td>
</tr>
<tr>
<td>parallel</td>
<td>指定并行运行的作业实例</td>
</tr>
<tr>
<td>trigger</td>
<td>定义下游流水线的触发器</td>
</tr>
<tr>
<td>include</td>
<td>作业加载其他YAML文件</td>
</tr>
<tr>
<td>extends</td>
<td>控制实体从哪里继承</td>
</tr>
<tr>
<td>pages</td>
<td>上传GitLab Pages的结果</td>
</tr>
<tr>
<td>retry</td>
<td>作业失败时，可以自动执行多少次</td>
</tr>
<tr>
<td>variables</td>
<td>定义环境变量</td>
</tr>
</tbody>
</table>
<h2 id="_1"><a href="#id39">参数详解</a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="script"><a href="#id40"><code>script</code></a><a class="headerlink" href="#script" title="Permanent link">&para;</a></h3>
<p><code>script</code> 是作业中唯一必须的关键字参数，是运行器需要执行的脚本，如:</p>
<div class="highlight"><pre><span></span><code><span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uname -a</span>
</code></pre></div>
<p>表示 <code>build1</code> 作业需要执行的命令是输出 <code>Do your build here</code>。</p>
<h3 id="image"><a href="#id41"><code>image</code></a><a class="headerlink" href="#image" title="Permanent link">&para;</a></h3>
<p><code>image</code> 指定使用Docker镜像。如 <code>image:name</code> ，暂时忽略。</p>
<h3 id="services"><a href="#id42"><code>services</code></a><a class="headerlink" href="#services" title="Permanent link">&para;</a></h3>
<p><code>services</code> 指定使用Docker镜像服务。如 <code>services:name</code> ，暂时忽略。</p>
<h3 id="before_script"><a href="#id43"><code>before_script</code></a><a class="headerlink" href="#before_script" title="Permanent link">&para;</a></h3>
<p><code>before_script</code> 用于定义在所有作业之前需要执行的命令，比如更新代码、安装依赖、打印调试信息之类的事情。</p>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>
</code></pre></div>
<h3 id="after_script"><a href="#id44"><code>after_script</code></a><a class="headerlink" href="#after_script" title="Permanent link">&para;</a></h3>
<p><code>after_script</code> 用于定义在所有作业(即使失败)之后需要执行的命令，比如清空工作空间。</p>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>
</code></pre></div>
<p>重要说明：</p>
<ul>
<li><code>before_script</code> 和 <code>script</code> 在一个上下文中是串行执行的，<code>after_script</code> 是独立执行的，即 <code>after_script</code> 与 <code>before_script/script</code> 的上下文环境不同。</li>
<li><code>after_script</code> 会将当前工作目录设置为默认值。</li>
<li>由于 <code>after_script</code> 是分离的上下文，在 <code>after_script</code> 中无法看到在 <code>before_script</code>和 <code>script</code> 中所做的修改:</li>
<li>在 <code>before_script</code> 和 <code>script</code> 中的命名别名、导出变量，对 <code>after_script</code> 不可见；</li>
<li><code>before_script</code>和 <code>script</code> 在工作树之外安装的软件，对 <code>after_script</code> 不可见。</li>
<li>你可以在作业中定义 <code>before_script</code>， <code>after_script</code> ，也可以将其定义为顶级元素，定义为顶级元素将为每一个任务都执行相应阶段的脚本或命令。作业级会覆盖全局级的定义。</li>
</ul>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc .</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>将修改上传提交，查看作业build1的控制台输出：</p>
<p><img alt="before_script.png" src="../../images/gitlab/job_before_script_overwrited_global_before_script.png" /></p>
<p><img alt=" after_script.png" src="../../images/gitlab/job_after_script_overwrited_global_after_script.png" /></p>
<p>可以发现 <code>build1</code> 作业的 <code>before_script</code> 和 <code>after_script</code> 将全局的 <code>before_script</code> 和 <code>after_script</code> 覆盖了。</p>
<h3 id="stages"><a href="#id45"><code>stages</code></a><a class="headerlink" href="#stages" title="Permanent link">&para;</a></h3>
<p><code>stages</code> 定义流水线全局可使用的阶段，阶段允许有灵活的多级管道，阶段元素的排序定义了作业执行的顺序。</p>
<ul>
<li>相同 <code>stage</code> 阶段的作业并行运行。</li>
<li>默认情况下，上一阶段的作业全部运行成功后才执行下一阶段的作业。</li>
<li>默认有三个阶段， <code>build</code> 、<code>test</code> 、<code>deploy</code> 三个阶段，即 <code>构建</code> 、<code>测试</code> 、<code>部署</code> 。</li>
<li>如果一个作业未定义 <code>stage</code> 阶段，则作业使用 <code>test</code> 测试阶段。</li>
<li>默认情况下，任何一个前置的作业失败了，commit提交会标记为failed并且下一个stages的作业都不会执行。</li>
</ul>
<h3 id="stage"><a href="#id46"><code>stage</code></a><a class="headerlink" href="#stage" title="Permanent link">&para;</a></h3>
<p><code>stage</code> 定义流水线中每个作业所处的阶段，处于相同阶段的作业并行执行。</p>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc .</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>我们增加一个 <code>code_check</code> 阶段，该阶段有一个作业 <code>find Bugs</code> ，该作业主要是先安装Flake8，然后使用Flake8对Python代码进行规范检查。</p>
<p><img alt="check_failed.png" src="../../images/gitlab/job_code_check_failed.png" /></p>
<p>由于Flake8检查到了Python代码中的缺陷，导致find Bugs作业失败！这样可以控制开发人员提交有坏味道的代码到仓库中。</p>
<p>另外，在上一个流水线中，Test阶段的作业test1和test2是并行执行的，如下图所示：</p>
<p><img alt="executed_in_parallel.png" src="../../images/gitlab/test_jobs_are_executed_in_parallel.png" /></p>
<p>本次(pipeline #7)流水线由于在作业 <code>find Bugs</code> 检查不通过，导致整个流水线运行失败，后续的作业不会执行：</p>
<p><img alt="further_stage_are_executed.png" src="../../images/gitlab/code_check_failed_no_jobs_of_further_stage_are_executed.png" /></p>
<p>Attention</p>
<p>默认情况下，GitLab Runner运行器每次只执行一个作业，只有当满足以下条件之一时，才会真正的并行执行:</p>
<blockquote>
<ul>
<li>作业运行在不同的运行器上；</li>
<li>你修改了运行器的 <code>concurrent</code> 设置，默认情况下 <code>concurrent = 1</code> 。</li>
</ul>
</blockquote>
<h3 id="only-except"><a href="#id47"><code>only</code> 和 <code>except</code></a><a class="headerlink" href="#only-except" title="Permanent link">&para;</a></h3>
<p><code>only</code> 和 <code>except</code> 用于在创建作业时对作业的限制策略。</p>
<ul>
<li><code>only</code> 定义了哪些分支或标签(branches and tags)的作业会运行</li>
<li><code>except</code> 定义了哪些分支或标签(branches and tags)的作业不会运行</li>
</ul>
<p>下面是策略规则：</p>
<ul>
<li><code>only</code> 和 <code>except</code> 可同时使用，如果在一个作业中同时定义了 <code>only</code> 和 <code>except</code> ，则同时 <code>only</code> <code>except</code> 进行过滤(注意，不是忽略 <code>except</code> 条件) 。</li>
<li><code>only</code> 和 <code>except</code> 可以使用正则表达式。</li>
<li><code>only</code> 和 <code>except</code> 允许指定用于过滤forks作业的存储库路径。</li>
<li><code>only</code> 和 <code>except</code> 中可以使用特殊的关键字，如 <code>branches</code> 、 <code>tags</code> 、 <code>api</code> 、 <code>external</code> 、 <code>pipelines</code> 、 <code>pushes</code> 、 <code>schedules</code> 、 <code>triggers</code> 、 <code>web</code> 、 <code>merge_requests</code> 、 <code>chats</code> 等。</li>
</ul>
<p><code>only</code> 和 <code>except</code> 中可以使用特殊的关键字：</p>
<p>关键字描述释义branches当一个分支被push上来tags当一个打了tag标记的Release被提交时api当一个pipline被第二个piplines api所触发调起(不是触发器API)external当使用了GitLab以外的外部CI服务，如Jenkinspipelines针对多项目触发器而言，当使用CI_JOB_TOKEN， 并使用gitlab所提供的api创建多个pipelines的时候pushes当pipeline被用户的git push操作所触发的时候schedules针对预定好的pipline计划而言（每日构建一类）triggers用触发器token创建piplines的时候web在GitLab WEB页面上Pipelines标签页下，按下run pipline的时候merge_requests当合并请求创建或更新的时候chats当使用GitLab ChatOps 创建作业的时候</p>
<p>在下面这个例子中，job将只会运行以 <code>issue-</code> 开始的refs(分支)，然而except中指定分支不能执行，所以这个job将不会执行:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># use regexp</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="w">  </span><span class="c1"># use special keyword</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
</code></pre></div>
<p>匹配模式默认是大小写敏感的(case-sensitive)，使用 <code>i</code> 标志，如 <code>/pattern/i</code> 可以使匹配模式大小写不敏感:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># use regexp</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="c1"># use special keyword</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
</code></pre></div>
<p>下面这个示例，仅当指定标记的tags的refs引用，或者通过API触发器的构建、或者流水线计划调度的构建才会运行:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># use special keywords</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">triggers</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">schedules</span>
</code></pre></div>
<p>仓库的路径(repository path)只能用于父级仓库执行作业，不能用于forks:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches@gitlab-org/gitlab-ce</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master@gitlab-org/gitlab-ce</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^release/.*$/@gitlab-org/gitlab-ce</span>
</code></pre></div>
<p>上面这个例子，将会在所有分支执行，但 <strong>不会在</strong> master主干以及以release/开头的分支上执行。</p>
<ul>
<li>当一个作业没有定义 <code>only</code> 规则时，其默认为 <code>only: ['branches', 'tags']</code> 。</li>
<li>如果一个作业没有定义 <code>except</code> 规则时，则默认 <code>except</code> 规则为空。</li>
</ul>
<p>下面这个两个例子是等价的:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;test&#39;</span>
</code></pre></div>
<p>转换后:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;test&#39;</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;branches&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;tags&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Attention</p>
<p>关于正则表达式使用的说明：</p>
<ul>
<li>因为 <code>@</code> 用于表示ref的存储库路径的开头，所以在正则表达式中匹配包含 <code>@</code> 字符的ref名称需要使用十六进制字符代码 <code>\x40</code> 。</li>
<li>仅标签和分支名称才能使用正则表达式匹配，仓库路径按字面意义匹配。</li>
<li>如果使用正则表达式匹配标签或分支名称，则匹配模式的整个引用部分都是正则表达式。</li>
<li>正则表达式必须以 <code>/</code> 开头和结尾，即 <code>/regular expressions/</code> ，因此， <code>issue-/.*/</code> 不会匹配以 <code>issue-</code> 开头的标签或分支。</li>
<li>可以在正则表达式中使用锚点 <code>^$</code> ，用来匹配开头或结尾，如 <code>/^issue-.*$/</code> 与 <code>/^issue-/</code> 等价， 但 <code>/issue/</code> 却可以匹配名称为 <code>severe-issues</code> 的分支，所以正则表达式的使用要谨慎！</li>
</ul>
<h3 id="only-except_1"><a href="#id48"><code>only</code> 和 <code>except</code> 高级用法</a><a class="headerlink" href="#only-except_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>only</code> 和 <code>except</code> 支持高级策略，<code>refs</code> 、 <code>variables</code> 、 <code>changes</code> 、 <code>kubernetes</code> 四个关键字可以使用。</li>
<li>如果同时使用多个关键字，中间的逻辑是逻辑与<code>(AND)</code> 。</li>
</ul>
<h4 id="onlyrefsexceptrefs"><a href="#id49"><code>only:refs/except:refs</code></a><a class="headerlink" href="#onlyrefsexceptrefs" title="Permanent link">&para;</a></h4>
<ul>
<li><code>refs</code> 策略可以使用 <code>only</code> 和 <code>except</code> 基本用法中的关键字。</li>
</ul>
<p>下面这个例子中，deploy作业仅当流水线是计划作业或者在master主干运行:</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">refs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">schedules</span>
</code></pre></div>
<h4 id="onlykubernetesexceptkubernetes"><a href="#id50"><code>only:kubernetes/except:kubernetes</code></a><a class="headerlink" href="#onlykubernetesexceptkubernetes" title="Permanent link">&para;</a></h4>
<ul>
<li><code>kubernetes</code> 策略仅支持 <code>active</code> 关键字。</li>
</ul>
<p>下面这个例子中，deploy作业仅当kubernetes服务启动后才会运行:</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">active</span>
</code></pre></div>
<h4 id="onlyvariablesexceptvariables"><a href="#id51"><code>only:variables/except:variables</code></a><a class="headerlink" href="#onlyvariablesexceptvariables" title="Permanent link">&para;</a></h4>
<ul>
<li><code>variables</code> 关键字用来定义变量表达式，你可以使用预定义变量、项目、组、环境变量来评估一个作业是否需要创建或运行。</li>
</ul>
<p>下面这个例子使用了变量表达式:</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cap staging deploy</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">refs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$RELEASE == &quot;staging&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$STAGING</span>
</code></pre></div>
<p>下面这个例子，会根据提交日志信息来排除某些作业:</p>
<div class="highlight"><pre><span></span><code><span class="nt">end-to-end</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rake test:end-to-end</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_MESSAGE =~ /skip-end-to-end-tests/</span>
</code></pre></div>
<h4 id="onlychangesexceptchanges"><a href="#id52"><code>only:changes/except:changes</code></a><a class="headerlink" href="#onlychangesexceptchanges" title="Permanent link">&para;</a></h4>
<ul>
<li><code>changes</code> 策略表明一个作业只有在使用 <code>git push</code> 事件使文件发生变化时执行。</li>
</ul>
<p>下面这个例子中，deploy作业仅当流水线是计划作业或者在master主干运行:</p>
<div class="highlight"><pre><span></span><code><span class="nt">docker build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker build -t my-image:$CI_COMMIT_REF_SLUG .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/scripts/*</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dockerfiles/**/*</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">more_scripts/*.{rb,py,sh}</span>
</code></pre></div>
<p>上面这个例子中，一旦 <code>Dockerfile</code> 文件发生变化，或者 <code>docker/scripts/</code> 目录下的文件发生变化，或者 <code>dockerfiles/</code> 目录下的文件或目录发生变化，或者 <code>more_scripts/</code> 目录下 <code>rb,py,sh</code> 等脚本文件发生变化时，就会触发Docker构建。</p>
<ul>
<li>也可以使用 <code>glob模式匹配</code> 来匹配根目录下的文件，或者任何目录下的文件。</li>
</ul>
<p>如下示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm run test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*.json&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;**/*.sql&quot;</span>
</code></pre></div>
<p>注意：</p>
<p>在上面的示例中，<code>glob模式匹配</code> 的字符串需要使用双引号包裹起来，否则会导致 <code>.gitlab-ci.yml</code> 解析错误。</p>
<p>下面这个例子，当md文件发生变化时，会忽略CI作业:</p>
<div class="highlight"><pre><span></span><code><span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm run build</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*.md&quot;</span>
</code></pre></div>
<p>记录一下官网说明中使用 <code>change</code> 时需要注意的两点：</p>
<blockquote>
<ul>
<li>Using changes with new branches and tags：When pushing a new branch or a new tag to GitLab, the policy always evaluates to true and GitLab will create a job. This feature is not connected with merge requests yet and, because GitLab is creating pipelines before a user can create a merge request, it is unknown what the target branch is at this point.</li>
<li>Using changes with merge_requests：With pipelines for merge requests, it is possible to define a job to be created based on files modified in a merge request.</li>
</ul>
</blockquote>
<p>在合并请求中使用 <code>change</code> 策略:</p>
<div class="highlight"><pre><span></span><code><span class="nt">docker build service one</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker build -t my-service-one-image:$CI_COMMIT_REF_SLUG .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="nt">refs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge_requests</span>
<span class="w">    </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service-one/**/*</span>
</code></pre></div>
<p>上面这个例子中，一旦合并请求中修改了 <code>Dockerfile</code> 文件或者修改了 <code>service</code> 目录下的文件，都会触发Docker构建。</p>
<h3 id="only-except_2"><a href="#id53"><code>only</code> 和 <code>except</code> 综合示例</a><a class="headerlink" href="#only-except_2" title="Permanent link">&para;</a></h3>
<p>我们将 <code>bluelog</code> 项目的描述和主题进行修改：</p>
<p><img alt="description_tags.png" src="../../images/gitlab/project_description_tags.png" /></p>
<p>并创建三个分支 <code>issue-pylint</code> 、<code>Issue-flake8</code> 和 <code>severe-issues</code> ：</p>
<p><img alt="three_branches.png" src="../../images/gitlab/project_three_branches.png" /></p>
<p>刚新增的三个分支，自动继承了master主干的CI RUNNER，因为Flake8检查代码质量没通过，流水线都失败了：</p>
<p><img alt="pipeline_failed.png" src="../../images/gitlab/project_three_branches_pipeline_failed.png" /></p>
<p>现在朝 <code>.gitlab-ci.yml</code> 文件中增加 <code>only</code> 和 <code>except</code> 策略。</p>
<h4 id="issue-"><a href="#id54">匹配 <code>issue-</code> 开头的分支</a><a class="headerlink" href="#issue-" title="Permanent link">&para;</a></h4>
<p>创建仅匹配 <code>issue-</code> 开头的分支：</p>
<p><img alt="match_startwith_issue.png" src="../../images/gitlab/only_match_startwith_issue.png" /></p>
<p>可以发现master主干没有执行 <code>find Bugs</code> 作业：</p>
<p><img alt="no_find_bugs.png" src="../../images/gitlab/master_no_find_bugs.png" /></p>
<p>为了快速测试，我们对对个作业都使用 <code>only</code> 和 <code>except</code> 策略:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">  </span><span class="c1"># cloc .</span>
<span class="nt">only</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="nt">except</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">  </span><span class="c1"># - cloc .</span>
<span class="nt">tags</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="nt">only</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="nt">except</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">  </span><span class="c1"># - flake8 .</span>
<span class="nt">tags</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="nt">only</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="nt">except</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue-pylint/</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="nt">tags</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="nt">only</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="nt">except</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/Issue-flake8/</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="nt">tags</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="nt">only</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/</span>
<span class="nt">except</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/severe-issues/</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="nt">tags</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>提交后，直接入库，检查 <code>master</code> 主干，并没有触发流水线作业。</p>
<p>统计作业流水线作业情况：</p>
<p><img alt="pipeline_22.png" src="../../images/gitlab/gitlab_only_except_pipeline_22.png" /></p>
<p>解释上面的流水作业策略：</p>
<p>作业规则定义规则解释</p>
<table>
<thead>
<tr>
<th>作业</th>
<th>规则定义</th>
<th>规则解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>build1</td>
<td><code>only: - /^issue-.*$/ except: - master</code></td>
<td>只在以issue-开头的分支执行，不在master主干执行</td>
</tr>
<tr>
<td>find Bugs</td>
<td><code>only: - /^issue-.*$/ except: - branches</code></td>
<td>只在以issue-开头的分支执行，不在 <code>branches</code> 分支执行， 由于issue-pylint也是分支，所以在issue-pylint中也不会执行find Bugs作业</td>
</tr>
<tr>
<td>test1</td>
<td><code>only: - /^issue-.*$/ except: - /issue-pylint/</code></td>
<td>只在以issue-开头的分支执行，不在issue-pylint分支执行， 即会在除了issue-pylint分支以外的issue-开头的分支执行，也即没有分支执行</td>
</tr>
<tr>
<td>test2</td>
<td><code>only: - /^issue-.*$/ except: - /Issue-flake8/</code></td>
<td>只在以issue-开头的分支执行，不在Issue-flake8分支执行， 因此可以issue-pylint分支执行</td>
</tr>
<tr>
<td>deploy1</td>
<td><code>only: - /^issue-.*$/ except: - /severe-issues/</code></td>
<td>只在以issue-开头的分支执行，不在severe-issues分支执行 因此可以issue-pylint分支执行</td>
</tr>
</tbody>
</table>
<h4 id="_2"><a href="#id55">大小写不敏感匹配</a><a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>好，我们再将 <code>only</code> 语法中加入语法大小写不敏感的 <code>i</code> 标志！再来做一次实验，看看最终的效果。</p>
<p>加入语法大小写不敏感的 <code>i</code> 标志:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># cloc .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># - cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="c1"># - flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue-pylint/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/Issue-flake8/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/^issue-.*$/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/severe-issues/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>预期效果： <code>issue-pylint</code> 和 <code>Issue-flake8</code> 分支会触发流水线执行，<code>master</code> 主干和 <code>severe-issues</code> 分支不会触发流水线执行。</p>
<p>统计作业流水线作业情况：</p>
<table>
<thead>
<tr>
<th>分支</th>
<th>流水线</th>
<th>build1</th>
<th>find Bugs</th>
<th>test1</th>
<th>test2</th>
<th>deploy1</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>未触发</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>issue-pylint</td>
<td><code>#23</code></td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Issue-flake8</td>
<td><code>#24</code></td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>severe-issues</td>
<td>未触发</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>正如我们预期的一样，<code>issue-pylint</code> 和 <code>Issue-flake8</code> 分支会触发流水线执行，<code>master</code> 主干和 <code>severe-issues</code> 分支不会触发流水线执行：</p>
<p><img alt="pipeline_23.png" src="../../images/gitlab/gitlab_only_except_pipeline_23.png" />
<img alt="pipeline_24.png" src="../../images/gitlab/gitlab_only_except_pipeline_24.png" /></p>
<p>解释上面的流水作业策略：</p>
<table>
<thead>
<tr>
<th>作业</th>
<th>规则定义</th>
<th>规则解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>build1</td>
<td><code>only: - /^issue-.*$/i except: - master</code></td>
<td>只在以issue(不区分大小写)-开头的分支执行，不在master主干执行 可以在issue-pylint和Issue-flake8分支执行</td>
</tr>
<tr>
<td>find Bugs</td>
<td><code>only: - /^issue-.*$/i except: - branches</code></td>
<td>只在以issue(不区分大小写)-开头的分支执行，不在 <code>branches</code> 分支执行， 由于issue-pylint也是分支，所以在issue-pylint中也不会执行find Bugs作业</td>
</tr>
<tr>
<td>test1</td>
<td><code>only: - /^issue-.*$/i except: - /issue-pylint/</code></td>
<td>只在以issue(不区分大小写)-开头的分支执行，不在issue-pylint分支执行， 即会在除了issue-pylint分支以外的issue-(不区分大小写)开头的分支执行， 可以在Issue-flake8分支执行</td>
</tr>
<tr>
<td>test2</td>
<td><code>only: - /^issue-.*$/i except: - /Issue-flake8/</code></td>
<td>只在以issue(不区分大小写)-开头的分支执行，不在Issue-flake8分支执行， 因此可以issue-pylint分支执行</td>
</tr>
<tr>
<td>deploy1</td>
<td><code>only: - /^issue-.*$/i except: - /severe-issues/</code></td>
<td>只在以issue(不区分大小写)-开头的分支执行，不在severe-issues分支执行 可以在issue-pylint和Issue-flake8分支执行</td>
</tr>
</tbody>
</table>
<p>我们再将 <code>only</code> 语法中将 <code>/^issue-.*$/</code> 改为 <code>/issue/i</code> ！再来做一次实验，看看最终的效果。</p>
<p>不区分大小写匹配issue字符：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># cloc .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># - cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="c1"># - flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue-pylint/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/Issue-flake8/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue/i</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/severe-issues/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>预期效果：不区分大小写，<code>issue-pylint</code> 、 <code>Issue-flake8</code> 和 <code>severe-issues</code> 分支分支会触发流水线执行，<code>master</code> 主干不会触发流水线执行。</p>
<p>统计作业流水线作业情况：</p>
<p>正如我们预期的一样，<code>issue-pylint</code> 、 <code>Issue-flake8</code> 和 <code>severe-issues</code> 分支会触发流水线执行，<code>master</code> 主干不会触发流水线执行：</p>
<p><img alt="pipeline_25.png" src="../../images/gitlab/gitlab_only_except_pipeline_25.png" />
<img alt="pipeline_26.png" src="../../images/gitlab/gitlab_only_except_pipeline_26.png" />
<img alt="pipeline_27.png" src="../../images/gitlab/gitlab_only_except_pipeline_27.png" /></p>
<p>解释上面的流水作业策略：</p>
<table>
<thead>
<tr>
<th>作业</th>
<th>规则定义</th>
<th>规则解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>build1</td>
<td><code>only: - /issue/i except: - master</code></td>
<td>只在包含issue(不区分大小写)字符的分支执行，不在master主干执行 因此在issue-pylint、Issue-flake8、severe-issues分支执行</td>
</tr>
<tr>
<td>find Bugs</td>
<td><code>only: - /issue/i except: - branches</code></td>
<td>只在包含issue(不区分大小写)字符的分支执行，不在 <code>branches</code> 分支执行， 所以find Bugs作业一直不会执行</td>
</tr>
<tr>
<td>test1</td>
<td><code>only: - /issue/i except: - /issue-pylint/</code></td>
<td>只在包含issue(不区分大小写)字符的分支执行，不在包含issue-pylint字符的分支 执行，即会在除了issue-pylint分支以外包含issue(不区分大小写)字符的分支执行， 所以可以在Issue-flake8和severe-issues分支执行</td>
</tr>
<tr>
<td>test2</td>
<td><code>only: - /issue/i except: - /Issue-flake8/</code></td>
<td>只在包含issue(不区分大小写)字符的分支执行，不在包含issue-flake8字符的分支 执行，即会在除了issue-flake8分支以外包含issue(不区分大小写)字符的分支执行， 所以可以在issue-pylint和severe-issues分支执行</td>
</tr>
<tr>
<td>deploy1</td>
<td><code>only: - /issue/i except: - /severe-issues/</code></td>
<td>只在包含issue(不区分大小写)字符的分支执行，不在包含severe-issues字符的分支 执行，即会在除了severe-issues分支以外包含issue(不区分大小写)字符的分支执行, 所以可以在issue-pylint和Issue-flake8分支执行</td>
</tr>
</tbody>
</table>
<h4 id="git-tag"><a href="#id56">git tag打标签的使用</a><a class="headerlink" href="#git-tag" title="Permanent link">&para;</a></h4>
<p><strong>使用标签，可以标记提交历史上的特定点为重要提交。</strong></p>
<ul>
<li>新建tag</li>
</ul>
<p><code>git tag -a v1.0 -m"Release v1.0"</code></p>
<p>上面的命令我们成功创建了本地一个版本 V1.0 ,并且添加了附注信息 ‘Release 1.0’。</p>
<ul>
<li>查看tag</li>
</ul>
<p><code>git tag</code></p>
<ul>
<li>显示tag附注信息</li>
</ul>
<p><code>git show v1.0</code></p>
<ul>
<li>提交本地tag到远程仓库</li>
</ul>
<p><code>git push origin v1.0</code></p>
<ul>
<li>提交本地所有tag到远程仓库</li>
</ul>
<p><code>git push origin --tags</code></p>
<ul>
<li>删除本地tag</li>
</ul>
<p><code>git tag -d v1.0</code></p>
<ul>
<li>删除远程tag</li>
</ul>
<p>`git tag push origin :refs/tags/v1.0``</p>
<ul>
<li>获取远程版本</li>
</ul>
<p><code>git fetch origin tag v1.0</code></p>
<h4 id="tag"><a href="#id57">仅当tag标签提交时，才触发流水线执行</a><a class="headerlink" href="#tag" title="Permanent link">&para;</a></h4>
<p>使用标签，可以标记提交历史上的特定点为重要提交，可以标记重要版本，如下图，是GitLab官方的Tag标签列表：</p>
<p><img alt="tags_list.png" src="../../images/gitlab/gitlab_office_tags_list.png" /></p>
<p>我们将流水线配置文件 <code>.gitlab-ci.yml</code> 修改为以下内容:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># cloc .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># - cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">branches</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="c1"># - flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue-pylint/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/Issue-flake8/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/severe-issues/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>查看差异:</p>
<p><div class="highlight"><pre><span></span><code>$ git diff
<span class="gh">diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml</span>
<span class="gh">index 7f16137..8315eb0 100644</span>
<span class="gd">--- a/.gitlab-ci.yml</span>
<span class="gi">+++ b/.gitlab-ci.yml</span>
<span class="gu">@@ -28,7 +28,7 @@ build1:</span>
<span class="w"> </span>     - cloc --version
<span class="w"> </span>     # cloc .
<span class="w"> </span>   only:
<span class="gd">-    - /^issue-.*$/</span>
<span class="gi">+    - tags</span>
<span class="w"> </span>   except:
<span class="w"> </span>     - master
<span class="w"> </span>   script:
<span class="gu">@@ -41,7 +41,7 @@ build1:</span>
<span class="w"> </span> find Bugs:
<span class="w"> </span>   stage: code_check
<span class="w"> </span>   only:
<span class="gd">-    - /^issue-.*$/</span>
<span class="gi">+    - tags</span>
<span class="w"> </span>   except:
<span class="w"> </span>     - branches
<span class="w"> </span>   script:
<span class="gu">@@ -55,7 +55,7 @@ find Bugs:</span>
<span class="w"> </span> test1:
<span class="w"> </span>   stage: test
<span class="w"> </span>   only:
<span class="gd">-    - /^issue-.*$/</span>
<span class="gi">+    - tags</span>
<span class="w"> </span>   except:
<span class="w"> </span>     - /issue-pylint/
<span class="w"> </span>   script:
<span class="gu">@@ -67,7 +67,7 @@ test1:</span>
<span class="w"> </span> test2:
<span class="w"> </span>   stage: test
<span class="w"> </span>   only:
<span class="gd">-    - /^issue-.*$/</span>
<span class="gi">+    - tags</span>
<span class="w"> </span>   except:
<span class="w"> </span>     - /Issue-flake8/
<span class="w"> </span>   script:
<span class="gu">@@ -79,7 +79,7 @@ test2:</span>
<span class="w"> </span> deploy1:
<span class="w"> </span>   stage: deploy
<span class="w"> </span>   only:
<span class="gd">-    - /^issue-.*$/</span>
<span class="gi">+    - tags</span>
<span class="w"> </span>   except:
<span class="w"> </span>     - /severe-issues/
<span class="w"> </span>   script:
</code></pre></div>
提交:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>-A

$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;测试tag标签触发流水线执行&quot;</span>
<span class="o">[</span>master<span class="w"> </span>eb9b468<span class="o">]</span><span class="w"> </span>测试tag标签触发流水线执行
<span class="w">  </span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span>changed,<span class="w"> </span><span class="m">7</span><span class="w"> </span>insertions<span class="o">(</span>+<span class="o">)</span>,<span class="w"> </span><span class="m">5</span><span class="w"> </span>deletions<span class="o">(</span>-<span class="o">)</span>

$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master:master
Enumerating<span class="w"> </span>objects:<span class="w"> </span><span class="m">5</span>,<span class="w"> </span><span class="k">done</span>.
Counting<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">5</span>/5<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
Delta<span class="w"> </span>compression<span class="w"> </span>using<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span><span class="m">12</span><span class="w"> </span>threads
Compressing<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">3</span>/3<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
Writing<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">3</span>/3<span class="o">)</span>,<span class="w"> </span><span class="m">365</span><span class="w"> </span>bytes<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">365</span>.00<span class="w"> </span>KiB/s,<span class="w"> </span><span class="k">done</span>.
Total<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>reused<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">0</span><span class="o">)</span>
To<span class="w"> </span><span class="m">192</span>.168.56.14:higit/bluelog.git
<span class="w">    </span>1bd46f2..eb9b468<span class="w">  </span>master<span class="w"> </span>-&gt;<span class="w"> </span>master
</code></pre></div>
<p>查看是否触发流水线，可以发现没有触发流水线执行：</p>
<p><img alt="tags_no_trigger_pipeline.png" src="../../images/gitlab/gitlab_submit_tags_no_trigger_pipeline.png" /></p>
<p>我们给 <code>bluelog</code> 打个 <code>tag</code> 标签，标签名称 <code>V0.1</code>:</p>
<div class="highlight"><pre><span></span><code>$ git tag v0.1 -m&quot;Release v0.1&quot;

$ git tag
v0.1

$ git push origin v0.1
Enumerating objects: 1, done.
Counting objects: 100% (1/1), done.
Writing objects: 100% (1/1), 165 bytes | 165.00 KiB/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To 192.168.56.14:higit/bluelog.git
  * [new tag]         v0.1 -&gt; v0.1
</code></pre></div>
<p>可以发现 <code>bluelog</code> 已经生成了一个tag版本：</p>
<p><img alt="bluelog_tag_v0.1.png" src="../../images/gitlab/gitlab_bluelog_tag_v0.1.png" /></p>
<p>在流水线列表中，也可以看 <code>#31</code> 号流水线被触发了，并且标签是 <code>v0.1</code>:</p>
<p><img alt="with_tag_v0.1.png" src="../../images/gitlab/gitlab_bluelog_pipeline_31_with_tag_v0.1.png" /></p>
<h4 id="_3"><a href="#id58">使用流水线触发器触发流水线执行</a><a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>我们给 <code>bluelog</code> 项目创建一个流水线触发器( <code>Trigger</code> )，在项目的 <code>设置 –&gt; CI/CD –&gt; 流水线触发器</code> 处增加流水线触发器：</p>
<p><img alt="pipeline_trigger_page.png" src="../../images/gitlab/gitlab_bluelog_add_pipeline_trigger_page.png" /></p>
<p>在”触发器描述”处填写”bluelog trigger”，然后点击”增加触发器”按钮，则会新增一个触发器:</p>
<p><img alt="bluelog_trigger.png" src="../../images/gitlab/gitlab_bluelog_trigger.png" /></p>
<p>我们修改 <code>.gitlab-ci.yml</code> 配置文件，将 <code>build1</code> 和 <code>find Bugs</code> 作业设置为仅 <code>triggers</code> 触发器能够触发执行:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might run an update here or install a build dependency&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Or perhaps you might print out some debugging details&quot;</span>

<span class="nt">after_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script section&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example you might do some cleanup here&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Before script in build stage that overwrited the globally defined before_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Install cloc:A tool to count lines of code in various languages from a given directory.&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install cloc -y</span>
<span class="w">  </span><span class="nt">after_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;After script in build stage that overwrited the globally defined after_script&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># cloc .</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">triggers</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="c1"># - cloc .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">triggers</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="c1"># - flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/issue-pylint/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do a test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a test suite&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/Issue-flake8/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/severe-issues/</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>提交修改:</p>
<div class="highlight"><pre><span></span><code>$ git diff
<span class="gh">diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml</span>
<span class="gh">index 657dc5e..921f93e 100644</span>
<span class="gd">--- a/.gitlab-ci.yml</span>
<span class="gi">+++ b/.gitlab-ci.yml</span>
<span class="gu">@@ -28,9 +28,7 @@ build1:</span>
<span class="w"> </span>     - cloc --version
<span class="w"> </span>     # cloc .
<span class="w"> </span>   only:
<span class="gd">-    - tags</span>
<span class="gd">-  except:</span>
<span class="gd">-    - master</span>
<span class="gi">+    - triggers</span>
<span class="w"> </span>   script:
<span class="w"> </span>     - echo &quot;Do your build here&quot;
<span class="w"> </span>     - cloc --version
<span class="gu">@@ -41,9 +39,7 @@ build1:</span>
<span class="w"> </span> find Bugs:
<span class="w"> </span>   stage: code_check
<span class="w"> </span>   only:
<span class="gd">-    - tags</span>
<span class="gd">-  except:</span>
<span class="gd">-    - branches</span>
<span class="gi">+    - triggers</span>
<span class="w"> </span>   script:
<span class="w"> </span>     - echo &quot;Use Flake8 to check python code&quot;
<span class="w"> </span>     - pip install flake8


$ git add -A


$ git commit -m&quot;使用触发器trigger触发流水线执行&quot;
[master 57f64a3] 使用触发器trigger触发流水线执行
<span class="w"> </span> 1 file changed, 2 insertions(+), 6 deletions(-)


$ git push origin master:master
Enumerating objects: 5, done.
Counting objects: 100% (5/5), done.
Delta compression using up to 12 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 361 bytes | 361.00 KiB/s, done.
Total 3 (delta 2), reused 0 (delta 0)
To 192.168.56.14:higit/bluelog.git
<span class="w"> </span>   eb9b468..57f64a3  master -&gt; master
</code></pre></div>
<p>检查发现并没有触发流水线的执行：</p>
<p><img alt="no_trigger_pipeline.png" src="../../images/gitlab/gitlab_submit_triggers_no_trigger_pipeline.png" /></p>
<p>我们现在使用 <code>curl</code> 发送请求，触发流水线触发器执行:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-F<span class="w"> </span><span class="nv">token</span><span class="o">=</span>cf8a32f6f8a583263f6d042e6362d2<span class="w"> </span>-F<span class="w"> </span><span class="nv">ref</span><span class="o">=</span>master<span class="w"> </span>https://localhost/api/v4/projects/2/trigger/pipeline

<span class="o">{</span><span class="s2">&quot;id&quot;</span>:33,<span class="s2">&quot;sha&quot;</span>:<span class="s2">&quot;57f64a35cad6d069dc62ddc93f0747296383826e&quot;</span>,<span class="s2">&quot;ref&quot;</span>:<span class="s2">&quot;master&quot;</span>,<span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;pending&quot;</span>,<span class="s2">&quot;web_url&quot;</span>:<span class="s2">&quot;https://localhost/higit/bluelog/pipelines/33&quot;</span>,<span class="s2">&quot;before_sha&quot;</span>:<span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span>,<span class="s2">&quot;tag&quot;</span>:false,<span class="s2">&quot;yaml_errors&quot;</span>:null,<span class="s2">&quot;user&quot;</span>:<span class="o">{</span><span class="s2">&quot;id&quot;</span>:2,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;wgzhao&quot;</span>,<span class="s2">&quot;username&quot;</span>:<span class="s2">&quot;wgzhao&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;active&quot;</span>,<span class="s2">&quot;avatar_url&quot;</span>:<span class="s2">&quot;https://localhost/uploads/-/system/user/avatar/2/avatar.png&quot;</span>,<span class="s2">&quot;web_url&quot;</span>:<span class="s2">&quot;https://localhost/wgzhao&quot;</span><span class="o">}</span>,<span class="s2">&quot;created_at&quot;</span>:<span class="s2">&quot;2019-07-06T22:08:52.761+08:00&quot;</span>,<span class="s2">&quot;updated_at&quot;</span>:<span class="s2">&quot;2019-07-06T22:08:53.026+08:00&quot;</span>,<span class="s2">&quot;started_at&quot;</span>:null,<span class="s2">&quot;finished_at&quot;</span>:null,<span class="s2">&quot;committed_at&quot;</span>:null,<span class="s2">&quot;duration&quot;</span>:null,<span class="s2">&quot;coverage&quot;</span>:null,<span class="s2">&quot;detailed_status&quot;</span>:<span class="o">{</span><span class="s2">&quot;icon&quot;</span>:<span class="s2">&quot;status_pending&quot;</span>,<span class="s2">&quot;text&quot;</span>:<span class="s2">&quot;等待中&quot;</span>,<span class="s2">&quot;label&quot;</span>:<span class="s2">&quot;等待中&quot;</span>,<span class="s2">&quot;group&quot;</span>:<span class="s2">&quot;pending&quot;</span>,<span class="s2">&quot;tooltip&quot;</span>:<span class="s2">&quot;等待中&quot;</span>,<span class="s2">&quot;has_details&quot;</span>:false,<span class="s2">&quot;details_path&quot;</span>:<span class="s2">&quot;/higit/bluelog/pipelines/33&quot;</span>,<span class="s2">&quot;illustration&quot;</span>:null,<span class="s2">&quot;favicon&quot;</span>:<span class="s2">&quot;/assets/ci_favicons/favicon_status_pending-5bdf338420e5221ca24353b6bff1c9367189588750632e9a871b7af09ff6a2ae.png&quot;</span><span class="o">}}</span>
</code></pre></div>
<p><img alt="pipeline_trigger.png" src="../../images/gitlab/use_curl_post_gitlab_pipeline_trigger.png" /></p>
<p>可以发现流水线已经被执行，<code>#33</code> 号流水线执行了 <code>build1</code> 和 <code>find Bugs</code> 作业，其他作业并未执行，与我们预期的相同：</p>
<p><img alt="trigger_33.png" src="../../images/gitlab/use_curl_post_gitlab_pipeline_trigger_33.png" /></p>
<p>根据流水线触发器( <code>Trigger</code> )创建处的提示，我们也可以在依赖项目中配置触发器，依赖项目流水线结束时触发此项目重新构建。</p>
<p><code>only</code> 和 <code>except</code> 其他关键字的使用可参才官网文档 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#onlyexcept-basic">https://docs.gitlab.com/ce/ci/yaml/README.html#onlyexcept-basic</a> ，此处暂时不表。</p>
<h3 id="tags"><a href="#id59"><code>tags</code></a><a class="headerlink" href="#tags" title="Permanent link">&para;</a></h3>
<p><code>tags</code> 关键字用于指定 <code>GitLab Runner</code> 运行器使用哪一个运行器来执行作业。</p>
<p>下面这个例子中，只有运行器注册时定义了 <code>ruby</code> 和 <code>postgres</code> 两个标签的运行器才能执行作业:</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w"> </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</code></pre></div>
<p>而我们的 <code>bluelog</code> 项目中，所有的作业都是使用的是标签为 <code>bluelog</code> 的运行器:</p>
<div class="highlight"><pre><span></span><code><span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">triggers</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Use Flake8 to check python code&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install flake8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 --version</span>
<span class="w">    </span><span class="c1"># - flake8 .</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>运行器标签可用于定义不同平台上运行的作业，如 <code>Mac OS X Runner</code> 使用 <code>osx</code> 标签， <code>Windows Runner</code> 使用 <code>windows</code> 标签，而 <code>Linux Runner</code> 使用 <code>linux</code> 标签:</p>
<p>```yaml
windows job:
  stage:
    - build
  tags:
    - windows
  script:
    - echo Hello, %USERNAME%!</p>
<p>osx job:
  stage:
    - build
  tags:
    - osx
  script:
    - echo "Hello, $USER!"</p>
<p>linux job:
  stage:
    - build
  tags:
    - linux
  script:
    - echo "Hello, $USER!"
 ```</p>
<h3 id="allow_failure"><a href="#id60"><code>allow_failure</code></a><a class="headerlink" href="#allow_failure" title="Permanent link">&para;</a></h3>
<ul>
<li><code>allow_failure</code> 可以用于当你想设置一个作业失败的之后并不影响后续的CI组件的时候。失败的作业不会影响到commit提交状态。</li>
<li>如果允许失败的作业失败了，则相应的作业会显示一个黄色的警告，但对流水线成功与否不产生影响。</li>
</ul>
<p>下面的这个例子中，job1和job2将会并列进行，如果job1失败了，它也不会影响进行中的下一个阶段，因为这里有设置了 <code>allow_failure: true</code> :</p>
<div class="highlight"><pre><span></span><code><span class="nt">job1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute_script_that_will_fail</span>
<span class="w">  </span><span class="nt">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">job2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute_script_that_will_succeed</span>

<span class="nt">job3</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy_to_staging</span>
</code></pre></div>
<p>但是如果上面的job2执行失败，那么job3则会受到影响而不会执行。</p>
<h3 id="when"><a href="#id61"><code>when</code></a><a class="headerlink" href="#when" title="Permanent link">&para;</a></h3>
<p><code>when</code> 关键字用于实现在作业失败时或发生故障时运行的作业 (when is used to implement jobs that are run in case of failure or despite the failure.)。</p>
<p><code>when</code> 可以设置以下值：</p>
<ul>
<li><code>on_success</code> ：只有前面的阶段的所有作业都成功时才执行，这是默认值。</li>
<li><code>on_failure</code> ：当前面阶段的作业至少有一个失败时才执行。</li>
<li><code>always</code> : 无论前面的作业是否成功，一直执行本作业。</li>
<li><code>manual</code> ：手动执行作业，作业不会自动执行，需要人工手动点击启动作业。</li>
<li><code>delayed</code> : 延迟执行作业，配合 <code>start_in</code> 关键字一起作用， <code>start_in</code> 设置的值必须小于或等于1小时，<code>start_in</code> 设置的值示例： <code>10 seconds</code> 、 <code>30 minutes</code> 、 <code>1 hour</code> ，前面的作业结束时计时器马上开始计时。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup_build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup</span>

<span class="nt">build_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make build</span>

<span class="nt">cleanup_build_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup_build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup build when failed</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on_failure</span>

<span class="nt">test_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make test</span>

<span class="nt">deploy_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make deploy</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>

<span class="nt">cleanup_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup after jobs</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</code></pre></div>
<p>说明：</p>
<ul>
<li>只有在 <code>build_job</code> 构建作业失败时，才会执行 <code>cleanup_build_job</code> 作业。</li>
<li>需要在GitLab Web界面手动点击，才能执行 <code>deploy_job</code> 部署作业。</li>
<li>无论之前的作业是否成功还是失败，<code>cleanup_job</code> 清理作业一直会执行。</li>
</ul>
<p>延时处理的示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">timed rollout 10%</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;Rolling out 10% ...&#39;</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">delayed</span>
<span class="w">  </span><span class="nt">start_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30 minutes</span>
</code></pre></div>
<p>上面的例子创建了一个 <code>timed rollout 10%</code> 作业，会在上一个作业完成后30分钟后才开始执行。</p>
<p>如果你点击 <code>Unschedule</code> 按钮可以取消一个激活的计时器，你也可以点击”Play”按钮，立即执行延时作业。</p>
<h3 id="environment"><a href="#id62"><code>environment</code></a><a class="headerlink" href="#environment" title="Permanent link">&para;</a></h3>
<p><code>environment</code> 用于定义作业部署到特殊的环境中。如果指定了 <code>environment</code> ，并且在 <code>运维 –&gt;环境</code> 界面的环境列表中没有该名称下的环境，则会自动创建新环境。</p>
<p>在最简单的格式中，环境关键字可以定义为：</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy to production</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git push production HEAD:master</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
</code></pre></div>
<p>上面的示例中，<code>deploy to production</code> 作业将会部署代码到 <code>production</code> 生产环境中去。</p>
<h4 id="environmentname"><a href="#id63"><code>environment:name</code></a><a class="headerlink" href="#environmentname" title="Permanent link">&para;</a></h4>
<ul>
<li>在GitLab 8.11之前，环境的名称可以使用 <code>environment: production</code> 方式定义，现在推荐使用 <code>name</code> 关键字来定义环境的名称，就像上面的示例一样。</li>
<li><code>name</code> 关键字的参数可以使用任何定义的CI变量，包括预定义的变量、安全变量、以及 <code>.gitlab-ci.yml</code> 配置文件中定义的变量，但不能使用 <code>script</code> 中定义的变量(因为这里面的变量是局部变量)。</li>
<li><code>environment</code> 环境的名称可以包含：英文字母(letters)、数字(digits)、空格(space)、<code>_</code>、<code>/</code>、<code>$</code>、<code>{</code>、<code>}</code> 等。常用的名称有： <code>qa</code>、 <code>staging</code> 、<code>production</code> 。</li>
</ul>
<p>注意：</p>
<ul>
<li>软件应用开发的经典模型有这样几个环境：开发环境(development)、集成环境(integration)、测试环境(testing)、QA验证，模拟环境(staging)、生产环境(production)。</li>
<li>通常一个web项目都需要一个staging环境，一来给客户做演示，二来可以作为production server的一个”预演”，正式发布新功能前能及早发现问题（特别是gem的依赖问题，环境问题等）。</li>
<li>staging server可以理解为production环境的镜像，QA在staging server上对新版本做最后一轮verification, 通过后才能deploy到产品线上。staging环境 尽最大可能来模拟产品线上的环境(硬件，网络拓扑结构，数据库数据)。</li>
</ul>
<h4 id="environmenturl"><a href="#id64"><code>environment:url</code></a><a class="headerlink" href="#environmenturl" title="Permanent link">&para;</a></h4>
<ul>
<li><code>environment:url</code> 是可选的，用于设置环境的URL地址的按钮，通过点击按钮可以访问环境相应的URL地址。</li>
<li>下面这个例子中，如果作业都成功完成，那么会在 <code>评审请求</code> 和 <code>环境部署</code> 页面创建一个Button按钮，你点击 <code>打开运行中的环境</code> 按钮就可以访问环境对应的URL地址 <code>https://prod.example.com</code> 。</li>
</ul>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy to production</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git push production HEAD:master</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://prod.example.com</span>
</code></pre></div>
<h4 id="environmenton_stop-environmentaction"><a href="#id65"><code>environment:on_stop</code> 与 <code>environment:action</code></a><a class="headerlink" href="#environmenton_stop-environmentaction" title="Permanent link">&para;</a></h4>
<ul>
<li><code>environment:on_stop</code> 与 <code>environment:action</code> 配合使用。</li>
<li>可以通过 <code>environment:on_stop</code> 关键字定义一个关闭(停止)环境的作业。</li>
<li><code>action</code> 关键字在关闭环境的作业中定义。</li>
</ul>
<p>下面的例子联合使用 <code>environment:on_stop</code> 与 <code>environment:action</code> 来关闭环境：</p>
<div class="highlight"><pre><span></span><code><span class="nt">review_app</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make deploy-app</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">review</span>
<span class="w">    </span><span class="nt">on_stop</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stop_review_app</span>

<span class="nt">stop_review_app</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make delete-app</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">review</span>
<span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stop</span>
</code></pre></div>
<p>在上面的示例中，设置 <code>review_app</code> 作业用于部署代码到 <code>review</code> 评审环境中，同时在 <code>on_stop</code> 中指定了 <code>stop_review_app</code> 作业。一旦 <code>review_app</code> 作业成功执行，就会触发 <code>when</code> 关键字定义的 <code>stop_review_app</code> 作业。通过设置为 <code>manual</code> 手动，需要在GitLab WEB界面点击来允许 <code>manual action</code> 。</p>
<p><code>stop_review_app</code> 作业必须配合定义以下关键字：</p>
<ul>
<li><code>when</code> ： 何时执行删除或停止环境作业</li>
<li><code>environment:name</code> ： 环境名称需要与上面的 <code>review_app</code> 作业保持一致，即 <code>review</code> 评审环境</li>
<li><code>environment:action</code> ：执行何种执行，<code>stop</code> 停止环境</li>
<li><code>stage</code> ：与 <code>review_app</code> 作业的阶段保持一致，都是 <code>deploy</code></li>
</ul>
<p>运行完成后，在 <code>stop_review_app</code> 作业界面需要手动点击 <code>停止当前环境</code> 才能启动 <code>stop_review_app</code> 作业的执行。 <code>stop_review_app</code> 作业执行完成后，会停止 <code>review</code> 评审环境，在 <code>环境</code> –&gt; <code>已停止</code> 列表中可以看到 <code>review</code> 评审环境。</p>
<h4 id="dynamic-environments"><a href="#id66">Dynamic environments 动态环境</a><a class="headerlink" href="#dynamic-environments" title="Permanent link">&para;</a></h4>
<p>正如前面讲解的，可以在环境的名称中使用变量，在 <code>environment:name</code> 和 <code>environment:url</code> 中使用变量，则可以达到动态环境的目的，动态环境需要底层应用的支持。</p>
<p>我们不详细展开，下面是官方的一个示例的改版:</p>
<div class="highlight"><pre><span></span><code><span class="nt">deploy as review app</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make deploy</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">review/${CI_COMMIT_REF_NAME}</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://${CI_ENVIRONMENT_SLUG}.example.com/</span>
</code></pre></div>
<p>上面示例中的 <code>${CI_COMMIT_REF_NAME}</code> <code>${CI_ENVIRONMENT_SLUG}</code> 就是两个变量。</p>
<h3 id="cache"><a href="#id67"><code>cache</code></a><a class="headerlink" href="#cache" title="Permanent link">&para;</a></h3>
<ul>
<li><code>GitLab Runner v0.7.0</code> 引入 <code>cache</code> 缓存机制。</li>
<li><code>cache</code> 缓存机制，可以在全局设置或者每个作业中设置。</li>
<li>从 <code>GitLab 9.0</code> 开始， <code>cache</code> 缓存机制，可以在不同的的流水线或作业之间共享数据。</li>
<li>从 <code>GitLab 9.2</code> 开始， 在 <code>artifacts</code> 工件之前恢复缓存。</li>
<li><code>cache</code> 缓存机制用于指定一系列的文件或文件夹在不同的流水线或作业之间共享数据，仅能使用项目工作空间( <code>project workspace</code> )中的路径作为缓存的路径。</li>
<li><code>如果 ``cache</code> 配置的路径是作业工作空间外部，则说明配置是全局的缓存，所有作业共享。</li>
<li>访问 <a href="https://docs.gitlab.com/ce/ci/caching/index.html">Cache dependencies in GitLab CI/CD</a> 文档来获取缓存是如何工作的以及好的实践实例的例子。</li>
<li><code>cache</code> 缓存机制的其他介绍请参考 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#cache">https://docs.gitlab.com/ce/ci/yaml/README.html#cache</a> 。</li>
</ul>
<h3 id="artifacts"><a href="#id68"><code>artifacts</code></a><a class="headerlink" href="#artifacts" title="Permanent link">&para;</a></h3>
<ul>
<li><code>artifacts</code> 用于指定在作业成功、失败、或者一直等状态下时，一系列的文件或文件夹附加到作业中。<code>artifacts</code> 可以称为 <code>工件``或者 ``归档文件</code> 。</li>
<li>作业完成后，工件被发送到GitLab，可以在GitLab Web界面下载。</li>
<li>默认情况下，只有成功的作业才会生成工件。</li>
<li>并不是所有的 <code>executor</code> 执行器都支持工件。</li>
<li>工件的详细介绍可参考 <a href="https://docs.gitlab.com/ce/user/project/pipelines/job_artifacts.html">Introduction to job artifacts</a></li>
</ul>
<h4 id="artifactspaths"><a href="#id69"><code>artifacts:paths</code></a><a class="headerlink" href="#artifactspaths" title="Permanent link">&para;</a></h4>
<ul>
<li><code>artifacts:paths</code> 用于指定哪些文件或文件夹会被打包成工件，仅仅项目工作空间( <code>project workspace</code> )的路径可以使用。</li>
<li>要在不同作业间传递工作，请参数 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#dependencies">dependencies</a></li>
</ul>
<p>下面示例，将目录 <code>binaries/</code> 和文件 <code>.config</code> 打包成工件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.config</span>
</code></pre></div>
<p>要禁用工件传递，请使用空依赖关系定义作业：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make build</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</code></pre></div>
<p>你可以仅为打标记的release发布版本创建工作，这样可以避免临时构建产生大量的存储需求：</p>
<div class="highlight"><pre><span></span><code><span class="nt">default-job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn test -U</span>
<span class="w">  </span><span class="nt">except</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>

<span class="nt">release-job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn package -U</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">target/*.war</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tags</span>
</code></pre></div>
<p>上面的示例中，<code>default-job</code> 作业不会在打标记的release发布版本中执行，而 <code>release-job</code> 只会在打标记的release发布版本执行，并且将 <code>target/*.war</code> 打包成工件以供下载。</p>
<h4 id="artifactsname"><a href="#id70"><code>artifacts:name</code></a><a class="headerlink" href="#artifactsname" title="Permanent link">&para;</a></h4>
<ul>
<li>工件的默认名称是 <code>artifacts</code> ，当下载时名称是 <code>artifacts.zip</code> 。</li>
<li>通过 <code>artifacts:name</code> 关键字可以自定义工件的归档名称，这样你可以为每个工件设置独一无二的名称，归档名称可以使用预定义的变量。</li>
<li>如果分支名称中包含斜杠(比如 <code>feature/my-feature</code> )，推荐使用 <code>$CI_COMMIT_REF_SLUG</code> 代替 <code>$CI_COMMIT_REF_NAME</code> 作为工件名称。</li>
</ul>
<p>使用作业名称使用工件名称：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$CI_JOB_NAME&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<p>使用当前分支或tag版本标签名作为工件名称：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$CI_COMMIT_REF_NAME&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<p>同时使用当前作业名称以及当前分支或tag版本标签名作为工件名称：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<p>同时使用当前作业阶段名称以及当前分支名称作为工件名称：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$CI_JOB_STAGE-$CI_COMMIT_REF_NAME&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<p>如果你使用的 <strong>Windows系统的Batch批处理脚本</strong> ，则需要把 <code>$</code> 替换成 <code>%</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;%CI_JOB_STAGE%-%CI_COMMIT_REF_NAME%&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<p>如果你使用的 <strong>Windows系统的PowerShell脚本</strong> ，则需要把 <code>$</code> 替换成 <code>$env:</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$env:CI_JOB_STAGE-$env:CI_COMMIT_REF_NAME&quot;</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<h4 id="artifactsuntracked"><a href="#id71"><code>artifacts:untracked</code></a><a class="headerlink" href="#artifactsuntracked" title="Permanent link">&para;</a></h4>
<ul>
<li><code>artifacts:untracked</code> 用于将git未加入版本库的文件作为工件文件。</li>
<li><code>artifacts:untracked</code> 将会忽略配置文件 <code>.gitignore</code>。</li>
</ul>
<p>将所有的未跟踪文件打包成工件：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">      </span><span class="nt">untracked</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p>将所有的未跟踪文件以及目录 <code>binaries</code> 中文件打包成工件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">untracked</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>
</code></pre></div>
<h4 id="artifactswhen"><a href="#id72"><code>artifacts:when</code></a><a class="headerlink" href="#artifactswhen" title="Permanent link">&para;</a></h4>
<ul>
<li><code>artifacts:when</code> 用于在作业失败时或者忽略失败时上传工件。</li>
</ul>
<p><code>artifacts:when</code> 可以设置以下值：</p>
<ul>
<li><code>on_success</code> ，默认值，当作业成功上传工件。</li>
<li><code>on_failure</code> ，当作业失败上传工件。</li>
<li><code>always</code> ，无论作业是否成功一直上传工件。</li>
</ul>
<p>当作业失败时，上传工件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on_failure</span>
</code></pre></div>
<h4 id="artifactsexpire_in"><a href="#id73"><code>artifacts:expire_in</code></a><a class="headerlink" href="#artifactsexpire_in" title="Permanent link">&para;</a></h4>
<ul>
<li><code>artifacts:expire_in</code> 用于设置工件的过期时间。</li>
<li>你可以点击界面上的 <code>Keep</code> 保持按钮，永久保存工件。</li>
<li>工件到期后，默认情况下每小时删除一次工件(通过cron作业)，并且后续不能再访问该工件。</li>
<li>工件默认有效期是30天，可以通过 <code>Admin area</code> –&gt; <code>Settings</code> –&gt; <code>Continuous Integration and Deployment</code> 设置默认的有效性时间。</li>
<li>如果你不提供时间单位的话，工作有效性的时间是以秒为单位的时间，下面是一些示例：</li>
</ul>
<blockquote>
<ul>
<li><code>42</code></li>
<li><code>3 mins 4 sec</code></li>
<li><code>2 hrs 20 min</code></li>
<li><code>2h20min</code></li>
<li><code>6 mos 1 day</code></li>
<li><code>47 yrs 6 mos and 4d</code></li>
<li><code>3 weeks and 2 days</code></li>
</ul>
</blockquote>
<p>下面示例中工件有效期为一周：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>
</code></pre></div>
<h4 id="artifactsreports"><a href="#id74"><code>artifacts:reports</code></a><a class="headerlink" href="#artifactsreports" title="Permanent link">&para;</a></h4>
<ul>
<li><code>artifacts:reports</code> 用于收集测试报告(report)，并在GitLab UI界面中显示出来。</li>
<li>无论作业是否成功，都会收集测试报告。</li>
<li>可以通过设置工件的打包路径 <code>artifacts:paths</code> 添加测试的报告输出文件。</li>
<li><code>artifacts:reports:junit</code> 可以用来收集单元测试的报告，查看 <a href="https://docs.gitlab.com/ce/ci/junit_test_reports.html">JUnit test reports</a> 获取更详细的信息和示例。</li>
</ul>
<p>下面是从Ruby的RSpec测试工具中收集JUnit XML文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">rspec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bundle install</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rspec --format RspecJunitFormatter --out rspec.xml</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">junit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rspec.xml</span>
</code></pre></div>
<p>如果你的测试报告是多个XML文件，你可以在一个作业中指定多个单元测试报告，GitLab会自动将他们转换成一个文件，可以像下面这样表示报告的路径：</p>
<ul>
<li>文件匹配模式: <code>junit: rspec-*.xml</code></li>
<li>文件列表: <code>junit: [rspec-1.xml, rspec-2.xml, rspec-3.xml]</code></li>
<li>混合模式：<code>junit: [rspec.xml, test-results/TEST-*.xml]</code></li>
</ul>
<p>下面是Go语言收集JUnit XML文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="c1">## Use https://github.com/jstemmer/go-junit-report to generate a JUnit report with go</span>
<span class="nt">golang</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go get -u github.com/jstemmer/go-junit-report</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go test -v 2&gt;&amp;1 | go-junit-report &gt; report.xml</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">junit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report.xml</span>
</code></pre></div>
<p>下面是C/C++语言使用GoogleTest进行单元测试，收集JUnit XML文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">cpp</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gtest.exe --gtest_output=&quot;xml:report.xml&quot;</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">junit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report.xml</span>
</code></pre></div>
<p>还有一些其他的报告关键字，但社区版不可用，忽略不提。</p>
<h3 id="dependencies"><a href="#id75"><code>dependencies</code></a><a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h3>
<ul>
<li><code>dependencies</code> 依赖关键字应该与 <code>artifacts</code> 工件关键字联合使用，允许你在不同作业间传递工件。</li>
<li>默认情况下，会传递所有本作业之前阶段的所有工件。</li>
<li>需要在作业上下文中定义 <code>dependencies</code> 依赖关键字，并指出所有需要使用的前序工件的作业名称列表。 <strong>作业列表中不能使用该作业后的作业名称</strong> 。</li>
<li>定义空的依赖项，将下不会下载任何工件。</li>
<li>使用依赖项不会考虑前面作业的运行状态。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">build:osx</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make build:osx</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>

<span class="nt">build:linux</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make build:linux</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">binaries/</span>

<span class="nt">test:osx</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make test:osx</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build:osx</span>

<span class="nt">test:linux</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make test:linux</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build:linux</span>

<span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make deploy</span>
</code></pre></div>
<p>上面示例中， <code>build:osx</code> 和 <code>build:linux</code> 两个作业定义了工件， <code>test:osx</code> 作业执行时，将会下载并解压 <code>build:osx</code> 的工件内容。相应的， <code>test:linux</code> 也会获取 <code>build:linux</code> 的工件。 <code>deploy</code> 作业会下载全部工件。</p>
<p>如果作为依赖的作业的工件过期或者被删除，那么依赖这个作业的作业将会失败。</p>
<h3 id="coverage"><a href="#id76"><code>coverage</code></a><a class="headerlink" href="#coverage" title="Permanent link">&para;</a></h3>
<ul>
<li><code>coverage</code> 可以从作业的输出log中提取代码覆盖率。</li>
<li>仅支持正则表达式方式获取覆盖率。</li>
<li>字符串的前后必须使用/包含来表明一个正确的正则表达式规则。特殊字符串需要转义。</li>
</ul>
<p>下面是一个简单的例子：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">coverage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/Code</span><span class="nv"> </span><span class="s">coverage:\d+\.\d+%/&#39;</span>
</code></pre></div>
<p>如在作业日志中输出了 <code>Code coverage:80.2%</code>，我们使用上面的正则表达式就可以获取到代码的覆盖率。然后在作业的右上角处就会显示 <code>Coverage:80.2%</code> 。</p>
<h3 id="retry"><a href="#id77"><code>retry</code></a><a class="headerlink" href="#retry" title="Permanent link">&para;</a></h3>
<ul>
<li><code>retry</code> 重试关键字用于配置当作业失败时可以重新执行的次数。</li>
<li>当作业失败时，如果配置了 <code>retry</code> ，那么该作业就会重试，直到允许的最大次数。</li>
<li>如果 <code>retry</code> 设置值为2，如果第一次重试运行成功了，那么就不会进行第二次重试。</li>
<li><code>retry</code> 设置值只能是0、1、2三个整数。</li>
</ul>
<p>下面是一个简单的例子：</p>
<div class="highlight"><pre><span></span><code><span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rspec</span>
<span class="w">  </span><span class="nt">retry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div>
<ul>
<li>为了更好的控制重试次数，<code>retry</code> 可以设置以下两个关键字：</li>
</ul>
<blockquote>
<ul>
<li><code>max</code> : 最大重试次数</li>
<li><code>when</code> : 何时重试</li>
</ul>
</blockquote>
<p>下面这个例子只有当运行器系统出现故障时才能最多重试两次：</p>
<div class="highlight"><pre><span></span><code><span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rspec</span>
<span class="w">  </span><span class="nt">retry</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runner_system_failure</span>
</code></pre></div>
<p>如果上面例子中出现的是其他故障，那么作业不会重试。</p>
<p>为了针对多种重试情形，我们可以使用矩阵形式罗列出错误情形，如下示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rspec</span>
<span class="w">  </span><span class="nt">retry</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">when</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runner_system_failure</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stuck_or_timeout_failure</span>
</code></pre></div>
<p><code>when</code> 可以是以下值：</p>
<ul>
<li><code>always</code> : 一直重试，默认值。</li>
<li><code>unknown_failure</code> ：当错误未知时重试。</li>
<li><code>script_failure</code> ： 脚本错误时重试。</li>
<li><code>api_failure</code> ： API调用错误时重试。</li>
<li><code>stuck_or_timeout_failure</code> ： 作业卡信或超时错误时重试。</li>
<li><code>runner_system_failure</code> ： 运行器系统错误(如设置工作失败)时重试。</li>
<li><code>missing_dependency_failure</code> ： 依赖工件丢失错误时重试。</li>
<li><code>runner_unsupported</code> ： 运行器不支持错误时重试。</li>
</ul>
<h3 id="trigger"><a href="#id78"><code>trigger</code></a><a class="headerlink" href="#trigger" title="Permanent link">&para;</a></h3>
<ul>
<li><code>trigger</code> 关键字用于多项目流水线时，定义下游的流水线工程，由于社区版本不支持此功能，不详细介绍。具体可参考 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#trigger-premium">trigger</a></li>
</ul>
<h3 id="include"><a href="#id79"><code>include</code></a><a class="headerlink" href="#include" title="Permanent link">&para;</a></h3>
<ul>
<li><code>include</code> 包含关键字可以将其他yaml文件载入到当前的 <code>.gitlab-ci.yml</code> 配置文件中，详情请查看官网指导 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#include">include</a></li>
</ul>
<h3 id="extends"><a href="#id80"><code>extends</code></a><a class="headerlink" href="#extends" title="Permanent link">&para;</a></h3>
<ul>
<li><code>extends</code> 扩展用于定义当前作业从哪里继承。</li>
<li>它是使用YAML锚点的替代方案，更加灵活、可读性强。详情请查看官网指导 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#extends">extends</a></li>
</ul>
<h3 id="pages"><a href="#id81"><code>pages</code></a><a class="headerlink" href="#pages" title="Permanent link">&para;</a></h3>
<ul>
<li><code>pages</code> 是一项特殊工作，用于将静态内容上传到GitLab，可用于为您的网站提供服务。详情请查看官网指导 <a href="https://docs.gitlab.com/ce/user/project/pages/index.html">GitLab Pages</a></li>
</ul>
<h3 id="variables"><a href="#id82"><code>variables</code></a><a class="headerlink" href="#variables" title="Permanent link">&para;</a></h3>
<ul>
<li>在 <code>.gitlab-ci.yml</code> 配置文件中可以通过 <code>variables</code> 关键字配置全局变量或者作业级的局部变量。</li>
<li>当 <code>variables</code> 关键字使用在作业层级时，它会覆盖全局变量或预定义变量。</li>
<li>可以在 <code>variables</code> 关键字中定义非敏感性配置。</li>
<li>全局变量可以在各个作业中作业，而作业级别的局部变量只能在该作业中使用。</li>
<li>可以在GitLab WEB界面定义一些敏感性配置变量，或者可能变动的变量。</li>
<li>在 <code>script</code> 中使用 <code>export</code> 可以导出当前可用的变量信息。</li>
<li>作业内部修改全局变量只对当前作用生效，不会影响其他作业。</li>
<li>可以使用赋值语句对全局变量或局部变量进行重新赋值。</li>
</ul>
<p>下面这个示例定义一个全局数据库的URL地址：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">DATABASE_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgres://postgres@postgres/my_database&quot;</span>
</code></pre></div>
<p>下面修改 <code>bluelog</code> 项目的配置文件为如下内容：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="c1"># 定义全局变量</span>
<span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 数据库信息</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;mysql+pymysql://root:root@localhost:3306/bluelog?charset=utf8mb4&#39;</span>
<span class="w">  </span><span class="c1"># 不发送警告通知</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">  </span><span class="c1"># 显示执行SQL</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_ECHO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 数据库信息</span>
<span class="w">    </span><span class="nt">SQLALCHEMY_DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4&#39;</span>
<span class="w">    </span><span class="c1"># 不显示执行SQL</span>
<span class="w">    </span><span class="nt">SQLALCHEMY_ECHO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_ECHO=&quot;Nothing&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># CKEditor富文本设置</span>
<span class="w">    </span><span class="nt">CKEDITOR_SERVE_LOCAL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;CKEDITOR_SERVE_LOCAL:${CKEDITOR_SERVE_LOCAL}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>查看各阶段的输出内容。</p>
<p><img alt="variables_job_build1.png" src="../../images/gitlab/gitlab_bluelog_variables_job_build1.png" /></p>
<p>可以看到 <code>build1</code> 作业中:</p>
<ul>
<li><code>SQLALCHEMY_DATABASE_URI</code> 已经覆盖了全局定义的 <code>SQLALCHEMY_DATABASE_URI</code> ，看差异数据库URL中全局是”root:root”，而作业中是”root:123456”。</li>
<li>由于作业中并没有定义 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> 变量，所以使用的是全局的 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> 变量，输出结果是”False”。</li>
<li>作业中定义的 <code>SQLALCHEMY_ECHO: "False"</code> 将全局的 <code>SQLALCHEMY_ECHO: "True"</code> 覆盖，最后显示的是”False”。</li>
</ul>
<p>再看 <code>find Bugs</code> 作业：</p>
<p><img alt="variables_job_find_Bugs.png" src="../../images/gitlab/gitlab_bluelog_variables_job_find_Bugs.png" /></p>
<ul>
<li>因为没有定义 <code>variables</code> 关键字，这个作用将使用全局变量。</li>
<li>39、40、41三行输出的结果都是全局变量定义的值。</li>
<li>42行的 <code>SQLALCHEMY_ECHO="Nothing"</code> 对 <code>SQLALCHEMY_ECHO</code> 全局变量进行的重新赋值，43行打印出了赋值后的新值是”Nothing”。</li>
<li>上面两个作业说明，作业内部修改全局变量只对当前作用生效，不会影响其他作业。</li>
<li>可以使用赋值语句对全局变量或局部变量进行重新赋值。</li>
</ul>
<p>再看 <code>test1</code> 作业：</p>
<p><img alt="variables_job_test1.png" src="../../images/gitlab/gitlab_bluelog_variables_job_test1.png" /></p>
<ul>
<li>该作业定义 <code>variables</code> 关键字，增加了一个 <code>CKEDITOR_SERVE_LOCAL</code> 变量。</li>
<li>上一个作业的修改 <code>SQLALCHEMY_ECHO="Nothing"</code> 对本作业显示 <code>SQLALCHEMY_ECHO</code> 变量没有影响，仍然会显示全局变量定义的值”True”。再一次证明了作业内部修改全局变量只对当前作用生效，不会影响其他作业。</li>
</ul>
<h4 id="variables_1"><a href="#id83"><code>variables</code> 变量的优先级</a><a class="headerlink" href="#variables_1" title="Permanent link">&para;</a></h4>
<p><code>variables</code> 变量的优先级参考 <a href="https://docs.gitlab.com/ce/ci/variables/README.html#priority-of-environment-variables">Priority of environment variables</a></p>
<p>原文:</p>
<blockquote>
<p>Variables of different types can take precedence over other variables, depending on where they are defined.</p>
<p>The order of precedence for variables is (from highest to lowest):</p>
<div class="highlight"><pre><span></span><code>   Trigger variables or scheduled pipeline variables.
   Project-level variables or protected variables.
   Group-level variables or protected variables.
   YAML-defined job-level variables.
   YAML-defined global variables.
   Deployment variables.
   Predefined environment variables.
</code></pre></div>
</blockquote>
<p>翻译过来，是这样的:</p>
<blockquote>
<p>不同类型的变量可以优先于其他变量，具体取决于它们的定义位置。</p>
<p>变量的优先顺序是（从最高到最低）：</p>
<ul>
<li>触发变量或预定的流水线变量。</li>
<li>项目级别变量或受保护变量。</li>
<li>组级别变量或受保护变量。</li>
<li>YAML定义的作业级变量。</li>
<li>YAML定义的全局变量。</li>
<li>部署环境变量。</li>
<li>预定义的环境变量。</li>
</ul>
</blockquote>
<p>变量中有一些关于git策略的特殊变量，如后续几个小节，当前仅列出，后续详细补充。</p>
<h4 id="export"><a href="#id84">使用export导出的变量示例</a><a class="headerlink" href="#export" title="Permanent link">&para;</a></h4>
<p>export的导出示例:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_API_V4_URL</span><span class="o">=</span><span class="s2">&quot;https://localhost/api/v4&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILDS_DIR</span><span class="o">=</span><span class="s2">&quot;/root/gitlab-runner/builds&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_BEFORE_SHA</span><span class="o">=</span><span class="s2">&quot;84f1f0e417d7e340770a4bb05076bf74f3231991&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_ID</span><span class="o">=</span><span class="s2">&quot;128&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_NAME</span><span class="o">=</span><span class="s2">&quot;build1&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_REF</span><span class="o">=</span><span class="s2">&quot;a6554ffa0d2ae67c675fe9768f702f0b1bb65f5a&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_REF_NAME</span><span class="o">=</span><span class="s2">&quot;master&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_REF_SLUG</span><span class="o">=</span><span class="s2">&quot;master&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_STAGE</span><span class="o">=</span><span class="s2">&quot;build&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_BUILD_TOKEN</span><span class="o">=</span><span class="s2">&quot;[MASKED]&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_BEFORE_SHA</span><span class="o">=</span><span class="s2">&quot;84f1f0e417d7e340770a4bb05076bf74f3231991&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_MESSAGE</span><span class="o">=</span><span class="s2">&quot;全局变量与局部变量的使用</span>
<span class="s2">&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_REF_NAME</span><span class="o">=</span><span class="s2">&quot;master&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_REF_SLUG</span><span class="o">=</span><span class="s2">&quot;master&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_SHA</span><span class="o">=</span><span class="s2">&quot;a6554ffa0d2ae67c675fe9768f702f0b1bb65f5a&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_SHORT_SHA</span><span class="o">=</span><span class="s2">&quot;a6554ffa&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_COMMIT_TITLE</span><span class="o">=</span><span class="s2">&quot;全局变量与局部变量的使用&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_CONCURRENT_ID</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_CONCURRENT_PROJECT_ID</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_CONFIG_PATH</span><span class="o">=</span><span class="s2">&quot;.gitlab-ci.yml&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_JOB_ID</span><span class="o">=</span><span class="s2">&quot;128&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_JOB_NAME</span><span class="o">=</span><span class="s2">&quot;build1&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_JOB_STAGE</span><span class="o">=</span><span class="s2">&quot;build&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_JOB_TOKEN</span><span class="o">=</span><span class="s2">&quot;[MASKED]&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_JOB_URL</span><span class="o">=</span><span class="s2">&quot;https://localhost/higit/bluelog/-/jobs/128&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_NODE_TOTAL</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PAGES_DOMAIN</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PAGES_URL</span><span class="o">=</span><span class="s2">&quot;https://localhost/bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PIPELINE_ID</span><span class="o">=</span><span class="s2">&quot;45&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PIPELINE_IID</span><span class="o">=</span><span class="s2">&quot;48&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PIPELINE_SOURCE</span><span class="o">=</span><span class="s2">&quot;push&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PIPELINE_URL</span><span class="o">=</span><span class="s2">&quot;https://localhost/higit/bluelog/pipelines/45&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_DIR</span><span class="o">=</span><span class="s2">&quot;/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_ID</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_NAME</span><span class="o">=</span><span class="s2">&quot;bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_NAMESPACE</span><span class="o">=</span><span class="s2">&quot;higit&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_PATH</span><span class="o">=</span><span class="s2">&quot;higit/bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_PATH_SLUG</span><span class="o">=</span><span class="s2">&quot;higit-bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_URL</span><span class="o">=</span><span class="s2">&quot;https://localhost/higit/bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_PROJECT_VISIBILITY</span><span class="o">=</span><span class="s2">&quot;private&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_REGISTRY_PASSWORD</span><span class="o">=</span><span class="s2">&quot;[MASKED]&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_REGISTRY_USER</span><span class="o">=</span><span class="s2">&quot;gitlab-ci-token&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_REPOSITORY_URL</span><span class="o">=</span><span class="s2">&quot;https://gitlab-ci-token:[MASKED]@localhost/higit/bluelog.git&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;bluelog runner&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_EXECUTABLE_ARCH</span><span class="o">=</span><span class="s2">&quot;linux/amd64&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_ID</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_REVISION</span><span class="o">=</span><span class="s2">&quot;3001a600&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_TAGS</span><span class="o">=</span><span class="s2">&quot;bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_RUNNER_VERSION</span><span class="o">=</span><span class="s2">&quot;11.10.0&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_NAME</span><span class="o">=</span><span class="s2">&quot;GitLab&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_REVISION</span><span class="o">=</span><span class="s2">&quot;8a802d1c6b7&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_VERSION</span><span class="o">=</span><span class="s2">&quot;11.10.6&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_VERSION_MAJOR</span><span class="o">=</span><span class="s2">&quot;11&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_VERSION_MINOR</span><span class="o">=</span><span class="s2">&quot;10&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SERVER_VERSION_PATCH</span><span class="o">=</span><span class="s2">&quot;6&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CI_SHARED_ENVIRONMENT</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">CONFIG_FILE</span><span class="o">=</span><span class="s2">&quot;/etc/gitlab-runner/config.toml&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">FF_K8S_USE_ENTRYPOINT_OVER_COMMAND</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">FF_USE_LEGACY_GIT_CLEAN_STRATEGY</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_CI</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_FEATURES</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_USER_EMAIL</span><span class="o">=</span><span class="s2">&quot;wgzhao@gmail.com&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_USER_ID</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_USER_LOGIN</span><span class="o">=</span><span class="s2">&quot;wgzhao&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">GITLAB_USER_NAME</span><span class="o">=</span><span class="s2">&quot;wgzhao&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">HISTCONTROL</span><span class="o">=</span><span class="s2">&quot;ignoredups&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">HISTSIZE</span><span class="o">=</span><span class="s2">&quot;1000&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">HOME</span><span class="o">=</span><span class="s2">&quot;/root&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">HOSTNAME</span><span class="o">=</span><span class="s2">&quot;server.hopewait&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;en_US.utf8&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">LC_ALL</span><span class="o">=</span><span class="s2">&quot;en_US.utf8&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">LESSOPEN</span><span class="o">=</span><span class="s2">&quot;||/usr/bin/lesspipe.sh %s&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">LOGNAME</span><span class="o">=</span><span class="s2">&quot;root&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">MAIL</span><span class="o">=</span><span class="s2">&quot;/var/spool/mail/root&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">OLDPWD</span><span class="o">=</span><span class="s2">&quot;/root/gitlab-runner&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PIPENV_PYPI_MIRROR</span><span class="o">=</span><span class="s2">&quot;https://mirrors.aliyun.com/pypi/simple&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PIPENV_VENV_IN_PROJECT</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PWD</span><span class="o">=</span><span class="s2">&quot;/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SHELL</span><span class="o">=</span><span class="s2">&quot;/bin/bash&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SHLVL</span><span class="o">=</span><span class="s2">&quot;3&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SQLALCHEMY_DATABASE_URI</span><span class="o">=</span><span class="s2">&quot;mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SQLALCHEMY_ECHO</span><span class="o">=</span><span class="s2">&quot;False&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="o">=</span><span class="s2">&quot;False&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SSH_CLIENT</span><span class="o">=</span><span class="s2">&quot;192.168.56.1 51472 22&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SSH_CONNECTION</span><span class="o">=</span><span class="s2">&quot;192.168.56.1 51472 192.168.56.14 22&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SSH_TTY</span><span class="o">=</span><span class="s2">&quot;/dev/pts/0&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">TERM</span><span class="o">=</span><span class="s2">&quot;linux&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">USER</span><span class="o">=</span><span class="s2">&quot;root&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">XDG_RUNTIME_DIR</span><span class="o">=</span><span class="s2">&quot;/run/user/0&quot;</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">XDG_SESSION_ID</span><span class="o">=</span><span class="s2">&quot;41&quot;</span>
</code></pre></div>
<p>注意：</p>
<ul>
<li>不要将敏感信息，如用户密码、Token等信息放在 <code>.gitlab-ci.yml</code> 配置文件中定义变量。</li>
<li>敏感信息可以WEB配置界面添加变量，并将变量设置为 <code>Protected</code> 或者 <code>Masked</code> ，设置为 <code>Masked</code> 的变量不会直接显示在作业日志信息中。</li>
</ul>
<h4 id="_4"><a href="#id85">关闭全局层级定义的变量</a><a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<ul>
<li>如果你要在作业层级关闭全局层级定义的变量，可以给 <code>variables</code> 关键字定义一个空的 <code>hash</code> 。</li>
</ul>
<p>如下示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">job_name</span><span class="p">:</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</code></pre></div>
<h4 id="_5"><a href="#id86">变量定义时使用其他变量</a><a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<ul>
<li>可以在变量定义时，使用其他的变量，需要使用 <code>$$</code> 进行转义。</li>
</ul>
<p>看下面的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">LS_CMD</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ls</span><span class="nv"> </span><span class="s">$FLAGS</span><span class="nv"> </span><span class="s">$$TMP_DIR&#39;</span>
<span class="w">  </span><span class="nt">FLAGS</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-al&#39;</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;eval</span><span class="nv"> </span><span class="s">$LS_CMD&#39;</span><span class="w">  </span><span class="c1"># will execute &#39;ls -al $TMP_DIR&#39;</span>
</code></pre></div>
<h4 id="git-strategy-git_strategy"><a href="#id87">克隆策略Git strategy <code>GIT_STRATEGY</code></a><a class="headerlink" href="#git-strategy-git_strategy" title="Permanent link">&para;</a></h4>
<ul>
<li>你可以通过设置 <code>GIT_STRATEGY</code> 变量来指定GitLab Runner运行作业时使用什么样的方式来获取最新的代码，可以在全局级或作业级进行设置。</li>
<li><code>GIT_STRATEGY</code> 变量可以设置为 <code>fetch</code> 、<code>clone</code> 、<code>none</code> 。</li>
<li><code>clone</code> 是最慢的方式，这种方式会从头开始克隆仓库。</li>
<li><code>fetch</code> 相对来说更快一点，如果本地项目空间中存在远程仓库的克隆，只用从远程获取最新到本地，而不用从头开始克隆整个仓库(如果本地项目空间不存在远程仓库的克隆的话，则此时等同于clone，从头开始克隆远程仓库)。</li>
<li><code>none</code> 也是利用本地项目空间中的文件，但不会从远程获取到最新的修改数据，本地数据不是最新的。</li>
</ul>
<p>下面我们通过修改 <code>.gitlab-ci.yml</code> 配置文件来查看这个现象：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fetch&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;clone&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;none&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>提交后，流水线触发了：</p>
<p><img alt="git_strategy_pipeline.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_pipeline.png" /></p>
<p>我们检查一下每个作业的log日志信息：</p>
<p>先看build1作业：</p>
<p><img alt="pipeline_build1_job_top.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_pipeline_build1_job_top.png" />
<img alt="pipeline_build1_job_bottom.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_pipeline_build1_job_bottom.png" /></p>
<p>可以看到默认情况下，会使用 <code>git fetch</code> 方式来获取最新的修改，并且 <code>echo "GIT_STRATEGY:${GIT_STRATEGY}"</code> 打印 <code>${GIT_STRATEGY}</code> 变量为空，也就是默认情况下GitLab并不会设置 <code>GIT_STRATEGY</code> 变量。</p>
<p>再看一下find Bugs作业：</p>
<p><img alt="git_strategy_find_Bugs.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_find_Bugs.png" /></p>
<p>此处也是直接使用现有项目空间里面的本地仓库，使用 <code>git fetch</code> 方式来获取最新的修改，由于在作业级中设置了 <code>GIT_STRATEGY</code> 变量，最后打印出打印 <code>${GIT_STRATEGY}</code> 变量的值为 <code>fetch</code> 。</p>
<p>再看一下test1作业：</p>
<p><img alt="git_strategy_test1.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_test1.png" /></p>
<p>因为设置了 <code>GIT_STRATEGY: "clone"</code> ，这个时候GitLab Runner会从头开始克隆远程仓库，最后打印出打印 <code>${GIT_STRATEGY}</code> 变量的值为 <code>clone</code> 。</p>
<p>再看一下test2作业：</p>
<p><img alt="git_strategy_test2.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_test2.png" /></p>
<p>因为设置了 <code>GIT_STRATEGY: "none"</code> ，这个时候GitLab Runner什么也不做，不会获取最新的修改，最后打印出打印 <code>${GIT_STRATEGY}</code> 变量的值为 <code>none</code> 。</p>
<p>我们再修改一下配置文件为下面的内容：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">du -sh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -lah README.md</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fetch&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">du -sh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -lah README.md</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;clone&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">du -sh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -lah README.md</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;none&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;GIT_STRATEGY:${GIT_STRATEGY}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">du -sh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -lah README.md</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">du -sh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -lah README.md</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>提交后，流水线触发了，但有build1作业后面的作业需要手动执行：</p>
<p><img alt="manual_pipeline.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline.png" /></p>
<p>我们检查build1作业：</p>
<p><img alt="job_bottom.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_build1_job_bottom.png" /></p>
<p>可以获取到整个仓库的大小，也可以读取到仓库中”README.md”文件。</p>
<p>假设我们此时在服务器端将 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog</code> 和 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog.tmp</code> 目录删除，并触发find Bugs作业运行：</p>
<p><img alt="delete_project_workspace.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_delete_project_workspace.png" /></p>
<p>因为设置了 <code>GIT_STRATEGY: "fetch"</code> ，但因为我把项目空间里面的本地仓库内容都删除了，这个时候GitLab Runner发现本地并没有远程仓库的文件，只能从头开始克隆远程仓库，最后打印出打印 <code>${GIT_STRATEGY}</code> 变量的值为 <code>fetch</code> 。</p>
<p><img alt="find_bugs_job.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_find_bugs_job.png" /></p>
<p>再触发test1作业运行，还是从头开始下载远程仓库：</p>
<p><img alt="test1_job.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_test1_job.png" /></p>
<p>关键一步，我们再次删除工作空间中的 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog</code> 和 <code>/root/gitlab-runner/builds/1aXYZ5H9/0/higit/bluelog.tmp</code> 目录：</p>
<p><img alt="delete_project_workspace_again.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_delete_project_workspace_again.png" /></p>
<p>再触发test2作业运行：</p>
<p><img alt="test2_job_failed.png" src="../../images/gitlab/gitlab_bluelog_git_strategy_manual_pipeline_test2_job_failed.png" /></p>
<p>此时发现，GitLab Runner仅仅创建了一个目录 <code>bluelog</code> ，但不从远程获取数据，这个时候我们获取仓库目录数据大小为0，也查看不到README.md文件的详情，由于没有README.md文件，执行命令就报错。</p>
<ul>
<li>可以看出设置 <code>GIT_STRATEGY: "none"</code> 可能会遇到意想不到的情况！</li>
<li>为了加快流水线工程的执行，建议使用 <code>fetch</code> 模式。</li>
<li>流水线的Git策略默认是 <code>git fetch</code> 模式。</li>
</ul>
<p>流水线的默认Git策略，可以在项目的流水线通用设置中查看：</p>
<p><img alt="git_strategy.png" src="../../images/gitlab/gitlab_bluelog_default_git_strategy.png" /></p>
<h4 id="git-submodule-strategy-git_submodule_strategy"><a href="#id88">子模块策略Git submodule strategy <code>GIT_SUBMODULE_STRATEGY</code></a><a class="headerlink" href="#git-submodule-strategy-git_submodule_strategy" title="Permanent link">&para;</a></h4>
<ul>
<li><code>GIT_SUBMODULE_STRATEGY</code> 类似于 <code>GIT_STRATEGY</code> ，当你的项目需要包含别的项目代码时，可以将别的项目作为你的项目的子模块，这个时候就可以使用 <code>GIT_SUBMODULE_STRATEGY</code> 。</li>
<li><code>GIT_SUBMODULE_STRATEGY</code> 默认取值 <code>none</code> ，即拉取代码时，子模块不会被引入。</li>
<li><code>GIT_SUBMODULE_STRATEGY</code> 可取值 <code>normal</code> ，意味着在只有顶级子模块会被引入。</li>
<li><code>GIT_SUBMODULE_STRATEGY</code> 可取值 <code>recursive</code> ，递归的意思，意味着所有级子模块会被引入。</li>
</ul>
<p>子模块需要配置在 <code>.gitmodules</code> 配置文件中，下面是两个示例：</p>
<p>场景：</p>
<ul>
<li>你的项目地址： <code>https://gitlab.com/secret-group/my-project</code> ，你可以使用 <code>git clone git@gitlab.com:secret-group/my-project.git</code> 检出代码。</li>
<li>你的项目依赖 <code>https://gitlab.com/group/project</code> ，你可以将这个模块作为项目的子模块。</li>
</ul>
<p>子模块与本项目在同一个服务上，可以使用相对引用：</p>
<div class="highlight"><pre><span></span><code><span class="k">[submodule &quot;project&quot;]</span>
<span class="w">  </span><span class="na">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">project</span>
<span class="w">  </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">../../group/project.git</span>
</code></pre></div>
<p>子模块与本项目不在同一个服务上，使用相对绝对URL：</p>
<div class="highlight"><pre><span></span><code><span class="k">[submodule &quot;project-x&quot;]</span>
<span class="w">  </span><span class="na">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">project-x</span>
<span class="w">  </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">https://gitserver.com/group/project-x.git</span>
</code></pre></div>
<p>详细可参考 <a href="https://docs.gitlab.com/ce/ci/git_submodules.html">Using Git submodules with GitLab CI</a></p>
<h4 id="git-checkout-git_checkout"><a href="#id89">检出分支设置Git checkout <code>GIT_CHECKOUT</code></a><a class="headerlink" href="#git-checkout-git_checkout" title="Permanent link">&para;</a></h4>
<ul>
<li>当 <code>GIT_STRATEGY</code> 设置为 <code>fetch</code> 或者 <code>clone</code> 时，可以通过 <code>GIT_CHECKOUT</code> 变量设置是否需要做 <code>git checkout</code> 操作，如果未指定该参数，默认值为 <code>true</code> ，即需要做 <code>git checkout</code> 操作。</li>
<li>可以在全局级或作业级进行设置。</li>
<li>如果 <code>GIT_CHECKOUT</code> 变量设置为 <code>true</code> ，GitLab Runner都会将本地工作副本检出并切换到当前流水线相关的修订版本分支上。</li>
<li>如果 <code>GIT_CHECKOUT</code> 变量设置为 <code>false</code> ，那么运行器操作如下：</li>
</ul>
<blockquote>
<ul>
<li><code>fetch</code> 操作时，更新仓库并在当前版本上保留工作副本。</li>
<li><code>clone</code> 操作时，克隆仓库并在默认分支中保留工作副本。</li>
</ul>
</blockquote>
<p>下面示例不进行自动切换到分支：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">      </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clone</span>
<span class="w">      </span><span class="nt">GIT_CHECKOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git checkout -B master origin/master</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git merge $CI_COMMIT_SHA</span>
</code></pre></div>
<h4 id="git-clean-flags-git_clean_flags"><a href="#id90">清理工作Git clean flags <code>GIT_CLEAN_FLAGS</code></a><a class="headerlink" href="#git-clean-flags-git_clean_flags" title="Permanent link">&para;</a></h4>
<ul>
<li>可以使用 <code>GIT_CLEAN_FLAGS</code> 变量来控制在检出源码后 <code>git clean</code> 的默认行为，可以在全局级或作业级进行设置。</li>
<li><code>GIT_CLEAN_FLAGS</code> 变量接受 <code>git clean</code> 命令的所有参数。</li>
<li>如果指定了 <code>GIT_CHECKOUT: "false"</code> ，那么 <code>git clean</code> 将不可用。</li>
<li><code>git-clean</code> : Remove untracked files from the working tree，即删除未跟踪的文件。</li>
<li><code>git clean</code> 命令用来从你的工作目录中删除所有没有tracked过的文件， <code>git reset --hard</code> 用于删除跟踪文件的修改记录。</li>
<li><code>git clean -n</code> 命令列出将被删除的文件。</li>
<li><code>git clean -f</code> 命令删除当前目录下所有没有跟踪过的文件。</li>
<li><code>git clean -d</code> 命令删除当前目录下所有没有跟踪过的目录。</li>
<li><code>git clean -e &lt;pattern&gt;</code> 命令排除( <code>--exclude=&lt;pattern&gt;</code> ) 某文件或目录，即不删除模式匹配的文件。</li>
<li><code>git clean -ffxd</code> 命令删除当前目录(包括由其他git仓库管理的子目录)下所有没有跟踪过的目录和文件。</li>
<li><code>GIT_CLEAN_FLAGS</code> 变量未指定时， <code>git clean</code> 命令的参数是 <code>-ffxd</code> 。</li>
<li><code>GIT_CLEAN_FLAGS</code> 变量指定为 <code>none</code> 时， <code>git clean</code> 命令不会执行。</li>
</ul>
<p>下面示例用于删除未被跟踪文件和目录，但排除cache目录及目录下的文件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">GIT_CLEAN_FLAGS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-ffdx -e cache/</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -al cache/</span>
</code></pre></div>
<h4 id="job-stages-attempts"><a href="#id91">作业重试次数 Job stages attempts</a><a class="headerlink" href="#job-stages-attempts" title="Permanent link">&para;</a></h4>
<ul>
<li>您可以设置正在运行的作业尝试执行以下每个阶段的尝试次数。可以在全局级或作业级进行设置。</li>
<li>涉及三个变量 <code>GET_SOURCES_ATTEMPTS</code> 、 <code>ARTIFACT_DOWNLOAD_ATTEMPTS</code> 、 <code>RESTORE_CACHE_ATTEMPTS</code> 。</li>
<li><code>GET_SOURCES_ATTEMPTS</code> 变量设置获取源码的尝试次数。</li>
<li><code>ARTIFACT_DOWNLOAD_ATTEMPTS</code> 变量设置下载归档文件的尝试次数。</li>
<li><code>RESTORE_CACHE_ATTEMPTS</code> 变量设置重建缓存的尝试次数。</li>
<li>默认是1次尝试。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">GET_SOURCES_ATTEMPTS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div>
<h4 id="shallow-cloning-git_depth"><a href="#id92">浅克隆 Shallow cloning <code>GIT_DEPTH</code></a><a class="headerlink" href="#shallow-cloning-git_depth" title="Permanent link">&para;</a></h4>
<ul>
<li>GitLab 8.9中引入了试验性的特征 <code>浅克隆</code> ，在将来的版本中有可能改变或者完全移除。</li>
<li>可以通过设置 <code>GIT_DEPTH</code> 克隆深度，不详细介绍，可参考 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#shallow-cloning">Shallow cloning</a></li>
</ul>
<h3 id="types-type"><a href="#id93">废弃的关键字 <code>types</code> 和 <code>type</code></a><a class="headerlink" href="#types-type" title="Permanent link">&para;</a></h3>
<ul>
<li>关键字 <code>types</code> 和 <code>type</code> 已经废弃。</li>
<li>使用 <code>stages</code> 阶段定义关键字代替 <code>types</code> 。</li>
<li>使用 <code>stage</code> 作业所处阶段关键字代替 <code>type</code> 。</li>
</ul>
<h3 id="git_clone_path"><a href="#id94">使用 <code>GIT_CLONE_PATH</code> 自定义构建目录</a><a class="headerlink" href="#git_clone_path" title="Permanent link">&para;</a></h3>
<ul>
<li>在默认情况下，自定义构建目录只有在GitLab Runner运行器配置文件中定义了 <code>custom_build_dir</code> 为 <code>enabled</code> 开启状态时才可使用。</li>
<li><code>docker</code> 、 <code>kubernetes</code> 运行器默认开启了此功能，而其他运行器默认不会开启此功能。</li>
<li>默认情况下，GitLab Runner运行器将仓库克隆到 <code>$CI_BUILDS_DIR</code> 目录下的一个名称唯一的子目录中，但有时候你的项目可能需要指定一个特殊的路径用来保存下载的仓库，这个时候就可以使用 <code>GIT_CLONE_PATH</code> 变量来指定克隆文件的存放目录。</li>
<li><code>GIT_CLONE_PATH</code> 必须是 <code>$CI_BUILDS_DIR</code> 的子目录， <code>$CI_BUILDS_DIR</code> 目录各个运行器可能不同。</li>
</ul>
<p>我们尝试在我们的SHELL运行器上去设置 <code>GIT_CLONE_PATH</code> 目录。</p>
<p>下面是官方给出的一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">GIT_CLONE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_BUILDS_DIR/project-name</span>

<span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
</code></pre></div>
<p>我们仿照这个示例修改 <code>.gitlab-ci.yml</code> 配置文件，并进行提交，修改后的内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is a template, and might need editing before it works on your project.</span>
<span class="c1"># see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options</span>

<span class="c1"># 定义全局变量</span>
<span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 数据库信息</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;mysql+pymysql://root:root@localhost:3306/bluelog?charset=utf8mb4&#39;</span>
<span class="w">  </span><span class="c1"># 不发送警告通知</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">  </span><span class="c1"># 显示执行SQL</span>
<span class="w">  </span><span class="nt">SQLALCHEMY_ECHO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">  </span><span class="c1"># 设置全局构建目录</span>
<span class="w">  </span><span class="nt">GIT_CLONE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_BUILDS_DIR/global_folder</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">build1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 数据库信息</span>
<span class="w">    </span><span class="nt">SQLALCHEMY_DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;mysql+pymysql://root:123456@localhost:3306/bluelog?charset=utf8mb4&#39;</span>
<span class="w">    </span><span class="c1"># 不显示执行SQL</span>
<span class="w">    </span><span class="nt">SQLALCHEMY_ECHO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="c1"># 设置全局构建目录</span>
<span class="w">    </span><span class="nt">GIT_CLONE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_BUILDS_DIR/sub_folder</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your build here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloc --version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">find Bugs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code_check</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SQLALCHEMY_ECHO=&quot;Nothing&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># CKEditor富文本设置</span>
<span class="w">    </span><span class="nt">CKEDITOR_SERVE_LOCAL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_DATABASE_URI:${SQLALCHEMY_DATABASE_URI}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_TRACK_MODIFICATIONS:${SQLALCHEMY_TRACK_MODIFICATIONS}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;SQLALCHEMY_ECHO:${SQLALCHEMY_ECHO}&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo -e &quot;CKEDITOR_SERVE_LOCAL:${CKEDITOR_SERVE_LOCAL}&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do another parallel test here&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;For example run a lint test&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>

<span class="nt">deploy1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Do your deploy here&quot;</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluelog</span>
</code></pre></div>
<p>提交修改构建目录后，流水线执行失败：</p>
<p><img alt="directory_failure.png" src="../../images/gitlab/gitlab_bluelog_custom_build_directory_failure.png" /></p>
<p>查看作业详情：</p>
<p><img alt="directory_failure_job_details.png" src="../../images/gitlab/gitlab_bluelog_custom_build_directory_failure_job_details.png" /></p>
<p>可以看到提示 <code>ERROR: Job failed: setting GIT_CLONE_PATH is not allowed, enable custom_build_dir feature</code></p>
<p>意思是说不允许设置 <code>GIT_CLONE_PATH</code> 变量，需要设置 <code>custom_build_dir</code> 属性。</p>
<p>我们参考 <a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section">The [runners.custom_build_dir] section</a> 来设置 <code>custom_build_dir</code> 属性。</p>
<p>我们查看一下GitLab Runner的配置文件内容:</p>
<div class="highlight"><pre><span></span><code><span class="na">$ cat /etc/gitlab-runner/config.toml</span>
<span class="na">concurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">check_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span>

<span class="k">[session_server]</span>
<span class="w">  </span><span class="na">session_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1800</span>

<span class="k">[[runners]]</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bluelog runner&quot;</span>
<span class="w">  </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://localhost/&quot;</span>
<span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1aXYZ5H9n2y8oauWkz7D&quot;</span>
<span class="w">  </span><span class="na">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shell&quot;</span>
<span class="w">  </span><span class="k">[runners.custom_build_dir]</span>
<span class="w">  </span><span class="k">[runners.cache]</span>
<span class="w">    </span><span class="k">[runners.cache.s3]</span>
<span class="w">    </span><span class="k">[runners.cache.gcs]</span>
</code></pre></div>
<p>我们参考示例:</p>
<p><div class="highlight"><pre><span></span><code><span class="k">[runners.custom_build_dir]</span>
<span class="w">  </span><span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>
开启 <code>custom_build_dir</code> 属性，修改后配置文件内容如下:</p>
<div class="highlight"><pre><span></span><code><span class="na">$ cat /etc/gitlab-runner/config.toml</span>
<span class="na">concurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">check_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span>

<span class="k">[session_server]</span>
<span class="w">  </span><span class="na">session_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1800</span>

<span class="k">[[runners]]</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bluelog runner&quot;</span>
<span class="w">  </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://localhost/&quot;</span>
<span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1aXYZ5H9n2y8oauWkz7D&quot;</span>
<span class="w">  </span><span class="na">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shell&quot;</span>
<span class="w">  </span><span class="k">[runners.custom_build_dir]</span>
<span class="w">    </span><span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="w">  </span><span class="k">[runners.cache]</span>
<span class="w">    </span><span class="k">[runners.cache.s3]</span>
<span class="k">[runners.cache.gcs]</span>
</code></pre></div>
<p>重新触发 <code>build1</code> 作业，看看效果。</p>
<p>此时可以看到，作业开始运行了，并且在 <code>/root/gitlab-runner/builds</code> 目录下生成了四个folder相关的目录:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="c1"># pwd</span>
<span class="na">/root/gitlab-runner/builds</span>
<span class="c1"># ls -ld *folder*</span>
<span class="na">drwxr-xr-x 5 root root 193 Jul 12 23</span><span class="o">:</span><span class="s">08 global_folder</span>
<span class="na">drwxr-xr-x 3 root root  26 Jul 12 23</span><span class="o">:</span><span class="s">08 global_folder.tmp</span>
<span class="na">drwxr-xr-x 5 root root 193 Jul 12 23</span><span class="o">:</span><span class="s">08 sub_folder</span>
<span class="na">drwxr-xr-x 3 root root  26 Jul 12 23</span><span class="o">:</span><span class="s">08 sub_folder.tmp</span>
</code></pre></div>
<p>查看”build1”和”find Bugs”作业的详情：</p>
<p><img alt="details.png" src="../../images/gitlab/gitlab_bluelog_custom_build_directory_success_build1_job_details.png" /></p>
<p>可以看到”build1”作业使用作业级定义的 <code>GIT_CLONE_PATH: $CI_BUILDS_DIR/sub_folder</code> ，仓库会被下载到 <code>/root/gitlab-runner/builds/sub_folder</code> 目录下。</p>
<p><img alt="job_details.png" src="../../images/gitlab/gitlab_bluelog_custom_build_directory_success_find_bugs_job_details.png" /></p>
<p>可以看到”build1”作业使用全局级定义的 <code>GIT_CLONE_PATH: $CI_BUILDS_DIR/global_folder</code> ，仓库会被下载到 <code>/root/gitlab-runner/builds/global_folder</code> 目录下。</p>
<h4 id="handling-concurrency"><a href="#id95">处理并发(Handling concurrency)</a><a class="headerlink" href="#handling-concurrency" title="Permanent link">&para;</a></h4>
<ul>
<li>当执行器配置并发数 <code>concurrent</code> 大于1时，有可能导致作业运行失败，因为有可能多个作业都运行在相同的目录上，GitLab Runner运行器并不会去阻止这种情形，管理员和开发人员必须遵守Runner配置的要求。</li>
<li>要避免这种情况，您可以在 <code>$CI_BUILDS_DIR</code> 中使用唯一路径，因为Runner公开了另外两个提供唯一并发ID的变量：</li>
</ul>
<blockquote>
<ul>
<li><code>$CI_CONCURRENT_ID</code> ：给定执行程序中运行的所有作业的唯一ID。</li>
<li><code>$CI_CONCURRENT_PROJECT_ID</code> ：在给定执行程序和项目中运行的所有作业的唯一ID。</li>
<li>在任何场景和任何执行器中都应该运行良好的最稳定的配置是在 <code>GIT_CLONE_PATH</code> 中使用 <code>$CI_CONCURRENT_ID</code> 。</li>
</ul>
</blockquote>
<p>例如</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">GIT_CLONE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-name</span>

<span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span>
</code></pre></div>
<h4 id="nested-paths"><a href="#id96">嵌套路径(Nested paths)</a><a class="headerlink" href="#nested-paths" title="Permanent link">&para;</a></h4>
<ul>
<li><code>GIT_CLONE_PATH</code> 变量最多只能扩展一次，不支持嵌套的变量路径。</li>
</ul>
<p>下面定义了两个变量：</p>
<div class="highlight"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">GOPATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_BUILDS_DIR/go</span>
<span class="w">  </span><span class="nt">GIT_CLONE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$GOPATH/src/namespace/project</span>
</code></pre></div>
<p><code>GIT_CLONE_PATH</code> 变量扩展一次后，变量成了 <code>$CI_BUILDS_DIR/go/src/namespace/project</code> ，这个时候在路径中有一个变量，而 <code>GIT_CLONE_PATH</code> 变量不会再次扩展 <code>$CI_BUILDS_DIR</code> 导致作业运行失败。</p>
<h3 id="yaml"><a href="#id97">特殊的YAML功能</a><a class="headerlink" href="#yaml" title="Permanent link">&para;</a></h3>
<p>可以使用特殊的YAML功能，如锚点( <code>＆</code> )，别名( <code>*</code> )和合并( <code>&lt;&lt;</code> )，这将使您大大降低 <code>.gitlab-ci.yml</code> 的复杂性。</p>
<h4 id="_6"><a href="#id98">隐藏关键字或作业</a><a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>如果我们想暂时禁用某个作业，我们可以将该作业的所有行都注释掉，如下示例：</p>
<div class="highlight"><pre><span></span><code><span class="c1">#hidden_job:</span>
<span class="c1">#  script:</span>
<span class="c1">#    - run test</span>
</code></pre></div>
<p>更好的方法是，我们在作业名称前面增加一个点号( <code>.</code> )， 这样GitLab CI流水线就会自动处理忽略掉 <code>.hidden_job</code> 作业。</p>
<p>改成下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="nt">.hidden_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run test</span>
</code></pre></div>
<h4 id="anchors"><a href="#id99">锚点(Anchors)</a><a class="headerlink" href="#anchors" title="Permanent link">&para;</a></h4>
<ul>
<li>锚点可以让你容易复制文档内容，锚点可以用来复制或继承某些属性，锚点与隐藏作业一起使用可提供作业模板。</li>
</ul>
<p>下面的例子使用锚点和合并创建了两个作业，<code>test1</code> 和 <code>test2</code> ，两个作业都是继承自隐藏作业 <code>.job_template</code> ，并且都有他们自己独有的工作脚本定义：</p>
<div class="highlight"><pre><span></span><code><span class="nt">.job_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;job_definition</span><span class="w">  </span><span class="c1"># Hidden key that defines an anchor named &#39;job_definition&#39;</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby:2.1</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*job_definition</span><span class="w">           </span><span class="c1"># Merge the contents of the &#39;job_definition&#39; alias</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1 project</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*job_definition</span><span class="w">           </span><span class="c1"># Merge the contents of the &#39;job_definition&#39; alias</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2 project</span>
</code></pre></div>
<ul>
<li><code>&amp;</code> 用于设置锚点名称为 <code>job_definition</code> ，也就是给隐藏作业设置一个锚点 <code>job_definition</code> 。</li>
<li><code>&lt;&lt;</code> 合并，将锚点定义的模板内容复制到当前作业的当前位置来。</li>
<li><code>*</code> 包含锚点的名称 <code>job_definition</code>。</li>
</ul>
<p>扩展后的配置文件变成下面这样：</p>
<div class="highlight"><pre><span></span><code><span class="nt">.job_template</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby:2.1</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>

<span class="nt">test1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby:2.1</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1 project</span>

<span class="nt">test2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby:2.1</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2 project</span>
</code></pre></div>
<p>再看另外一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">.job_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;job_definition</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test project</span>

<span class="nt">.postgres_services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;postgres_definition</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>

<span class="nt">.mysql_services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;mysql_definition</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>

<span class="nt">test:postgres</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*job_definition</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span><span class="w"> </span><span class="nv">*postgres_definition</span>

<span class="nt">test:mysql</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*job_definition</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span><span class="w"> </span><span class="nv">*mysql_definition</span>
</code></pre></div>
<p>扩展后是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="nt">.job_template</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test project</span>

<span class="nt">.postgres_services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>

<span class="nt">.mysql_services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>

<span class="nt">test:postgres</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test project</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>

<span class="nt">test:mysql</span><span class="p">:</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test project</span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby</span>
</code></pre></div>
<p>可以看到隐藏的关键字或者作业可以方便地用作为模板。</p>
<h3 id="triggers"><a href="#id100">Triggers触发器</a><a class="headerlink" href="#triggers" title="Permanent link">&para;</a></h3>
<ul>
<li>当使用触发器令牌触发流水线运行时，触发器可用于强制重建特定分支，标记或提交，并使用API调用。</li>
<li>触发器使用可参考 <a href="#trigger-pipeline-label">使用流水线触发器触发流水线执行</a> 。</li>
</ul>
<h3 id="ci"><a href="#id101">忽略CI检查</a><a class="headerlink" href="#ci" title="Permanent link">&para;</a></h3>
<ul>
<li>当你提交的commit日志信息中包含 <code>[ci skip]</code> 或者 <code>[skip ci]</code> (忽略大小写)，提交可以成功但是会忽略流水线的执行。</li>
<li>或者，在 <code>git push</code> 时添加推送选项，如 <code>git push -o ci.skip</code> 。</li>
</ul>
<p>我们第一次修改配置文件，commit日志为”移除自定义构建目录，测试忽略ci构建 ci skip”，包含有 <code>ci skip</code> 关键字，但是没有左右中括号，进行提交：</p>
<p><img alt="git_commit_with_ci_skip.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_ci_skip.png" /></p>
<p>但是发现流水线被触发了，正常运行了：</p>
<p><img alt="pipeline.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_ci_skip_trigger_success_pipeline.png" /></p>
<p>我们第二次修改配置文件，commit日志为”移除自定义构建目录，测试忽略ci构建 [CI Skip]”，包含有 <code>[CI Skip]</code> 关键字，进行提交：</p>
<p><img alt="Capitalization.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_CI_Skip_Capitalization.png" /></p>
<p>可以发现流水线没有被触发，但是提交已经创建成功了：</p>
<p><img alt="skipped_pipeline.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_ci_skip_trigger_skipped_pipeline.png" />
<img alt="pipeline1.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_ci_skip_trigger_skipped_pipeline1.png" /></p>
<p>我们第三次修改配置文件，commit日志为 ”测试使用git push添加推送选项”，进行提交：</p>
<p><img alt="push_ci_skip_option.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_git_push_ci_skip_option.png" /></p>
<p>可以发现流水线没有被触发，但是提交已经创建成功了：</p>
<p><img alt="option_trigger_skipped_pipeline.png" src="../../images/gitlab/gitlab_bluelog_git_commit_with_git_push_ci_skip_option_trigger_skipped_pipeline.png" /></p>
<p><code>.gitlab-ci.yml</code> 配置文件各个关键字的使用就介绍到这里。</p>
<p>参考：</p>
<ul>
<li><a href="https://docs.gitlab.com/ce/ci/quick_start/README.html">Getting started with GitLab CI/CD</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html">GitLab CI/CD Pipeline Configuration Reference</a></li>
<li><a href="https://segmentfault.com/a/1190000010442764">Gitlab CI yaml官方配置文件翻译</a></li>
<li><a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-shells">GitLab Runner Advanced configuration</a></li>
<li><a href="https://about.gitlab.com/2015/05/06/why-were-replacing-gitlab-ci-jobs-with-gitlab-ci-dot-yml/">Why we’re replacing GitLab CI jobs with .gitlab-ci.yml</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/examples/README.html">GitLab CI/CD Examples</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/variables/README.html">GitLab CI/CD Variables</a></li>
<li><a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/.gitlab-ci.yml">企业级.gitlab-ci.yml示例</a></li>
<li><a href="https://www.jianshu.com/p/3c0cbb6c2936">Gitlab CI 使用高级技巧</a></li>
<li><a href="https://www.cnblogs.com/senlinyang/p/8527764.html">git tag的用法</a></li>
<li><a href="https://www.cnblogs.com/zhangningyang/p/8692546.html">Python静态代码检查工具Flake8</a></li>
<li><a href="http://www.imooc.com/article/51227">Python代码规范利器Flake8</a></li>
<li><a href="https://flake8.readthedocs.io/en/latest/">Flake8: Your Tool For Style Guide Enforcement</a></li>
<li><a href="https://www.jqhtml.com/46077.html">基于GitLab CI搭建Golang自动构建环境</a></li>
<li><a href="https://www.cnblogs.com/beautiful-code/p/6265277.html">什么是staging server</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/caching/index.html">Cache dependencies in GitLab CI/CD</a></li>
<li><a href="https://docs.gitlab.com/ce/user/project/pipelines/job_artifacts.html">Introduction to job artifacts</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#dependencies">dependencies</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/junit_test_reports.html">JUnit test reports</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#include">include</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#extends">extends</a></li>
<li><a href="https://docs.gitlab.com/ce/user/project/pages/index.html">GitLab Pages</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/variables/README.html#priority-of-environment-variables">Priority of environment variables</a></li>
<li><a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section">The [runners.custom_build_dir] section</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#trigger-premium">trigger</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/git_submodules.html">Using Git submodules with GitLab CI</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#shallow-cloning">Shallow cloning</a></li>
</ul>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; wgzhao
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/01mlsx" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/wgzhao" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes", "navigation.expand", "content.code.annotate", "content.tabs.link", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "header.autohide", "announce.dismiss", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5090c770.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js"></script>
      
    
  </body>
</html>